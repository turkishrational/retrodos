<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>IDA - IBMBIO71COM.i64 (IBMBIO.COM) C:\pcdos_7_1\IBMBIO71COM.i64</title>
</head>
<body bgcolor="#ffffff">
<span style="white-space: pre; font-family: Consolas; color: blue; background: #ffffff">

<span style="color:maroon">MSLOAD:0000 </span>;
<span style="color:maroon">MSLOAD:0000 </span>; +-------------------------------------------------------------------------+
<span style="color:maroon">MSLOAD:0000 </span>; |   This file has been generated by The Interactive Disassembler (IDA)    |
<span style="color:maroon">MSLOAD:0000 </span>; |           Copyright (c) 2018 Hex-Rays, &lt;support@hex-rays.com&gt;           |
<span style="color:maroon">MSLOAD:0000 </span>; |                            Freeware version                             |
<span style="color:maroon">MSLOAD:0000 </span>; +-------------------------------------------------------------------------+
<span style="color:maroon">MSLOAD:0000 </span>;
<span style="color:maroon">MSLOAD:0000 </span>; Input SHA256 : D1C9E34AAFA2A65B8F74EEACE701B273E16D6B7FAE1368C1BA7A768B39EB4558
<span style="color:maroon">MSLOAD:0000 </span>; Input MD5    : D31B3F077E548791544DF2070469836E
<span style="color:maroon">MSLOAD:0000 </span>; Input CRC32  : 88D352C3
<span style="color:maroon">MSLOAD:0000
MSLOAD:0000 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">MSLOAD:0000 </span>; File Name   : C:\Yedek\pcdos_7_1\IBMBIO.COM
<span style="color:maroon">MSLOAD:0000 </span>; Format      : Binary file
<span style="color:maroon">MSLOAD:0000 </span>; Base Address: 0000h Range: 0000h - AE70h Loaded length: AE70h
<span style="color:maroon">MSLOAD:0000
MSLOAD:0000                 .</span>386
<span style="color:maroon">MSLOAD:0000                 </span>.model flat
<span style="color:maroon">MSLOAD:0000
MSLOAD:0000 </span><span style="color:gray">; ===========================================================================
</span><span style="color:maroon">MSLOAD:0000
MSLOAD:0000 </span><span style="color:gray">; Segment type: Pure code
</span><span style="color:maroon">MSLOAD:0000 </span>MSLOAD          segment byte public &#039;CODE&#039; use16
<span style="color:maroon">MSLOAD:0000                 </span>assume cs:MSLOAD
<span style="color:maroon">MSLOAD:0000                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:maroon">MSLOAD:0000
MSLOAD:0000 </span>START$<span style="color:navy">:
</span><span style="color:maroon">MSLOAD:0000                 </span><span style="color:navy">jmp     short </span>SaveInputValues
<span style="color:maroon">MSLOAD:0000 </span><span style="color:gray">; ---------------------------------------------------------------------------
MSLOAD:0002                 </span><span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">MSLOAD:0003 </span>SysVersionMajor <span style="color:navy">db </span><span style="color:#008040">7
</span><span style="color:gray">MSLOAD:0004 </span>SysVersionMinor <span style="color:navy">db </span><span style="color:#008040">10
</span><span style="color:gray">MSLOAD:0005 </span>NumHeads        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0007 </span>ClusterSize     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0009 </span>StartSecL       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:000B </span>StartSecH       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:000D </span>TempH           <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:000F </span>TempCluster     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0011 </span>LastFatSectorL  <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0013 </span>LastFatSectorH  <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0015 </span>SectorCount     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0017 </span>FATSectorsL     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0019 </span>FATSectorsH     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:001B </span>HiddenSectorsL  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:001D </span>HiddenSectorsH  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:001F </span>BytesPerSec     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0021 </span>ReservSectors   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0023 </span>CurrentClusterL <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0025 </span>CurrentClusterH <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0027 </span>NextBioLocation <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0029 </span>FirstSectorL    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:002B </span>FirstSectorH    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:002D </span>TotalSectorsL   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:002F </span>TotalSectorsH   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0031 </span>SecPerTrack     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0033 </span>BootDrive       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0034 </span>FatType         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0035 </span>MediaByte       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0036 </span>EndOfFile       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0037 </span>OrgDasdPtr      <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:003B </span>FatSegment      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:003D </span>SecPerCluster   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:003E </span>NumFats         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:003F </span>RootEntCnt      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0041 </span>RootClusterL    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0043 </span>RootClusterH    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:0045 </span>FirstCluster    <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">MSLOAD:0049 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">MSLOAD:0049
MSLOAD:0049 </span>SaveInputValues<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:0049                 </span><span style="color:navy">mov     cs:</span>FirstSectorL<span style="color:navy">, bx </span>; Start sector # of data
<span style="color:maroon">MSLOAD:0049                                         </span>; (high word in ax and also in es)
<span style="color:maroon">MSLOAD:004E                 </span><span style="color:navy">mov     cs:</span>MediaByte<span style="color:navy">, ch </span><span style="color:olive">; ...
</span><span style="color:maroon">MSLOAD:004E                                         </span>; BPB_Media
<span style="color:maroon">MSLOAD:0053                 </span><span style="color:navy">mov     cs:</span>BootDrive<span style="color:navy">, dl </span><span style="color:olive">; ...
</span><span style="color:maroon">MSLOAD:0053                                         </span>; BS_DrvNum
<span style="color:maroon">MSLOAD:0058
MSLOAD:0058 </span><span style="color:navy">loc_58:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">MSLOAD:0058                 </span><span style="color:navy">pop     si              </span>; from BS code..
<span style="color:maroon">MSLOAD:0058                                         </span>; ss:sp = 0:7BE4h, bp = 7BECh
<span style="color:maroon">MSLOAD:0058                                         </span>; Clear stack and load disk parameters table in ds:si
<span style="color:maroon">MSLOAD:0058                                         </span>;
<span style="color:maroon">MSLOAD:0058                                         </span>; pop.. Original INT 1Eh vector address
<span style="color:maroon">MSLOAD:0059                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">MSLOAD:005A                 </span><span style="color:navy">pop     si              </span>; pop.. Original INT 1Eh disk table address
<span style="color:maroon">MSLOAD:005B                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">MSLOAD:005C
MSLOAD:005C </span><span style="color:navy">loc_5C:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">MSLOAD:005C                 </span><span style="color:navy">mov     word ptr cs:</span>OrgDasdPtr<span style="color:navy">, si
</span><span style="color:maroon">MSLOAD:0061                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">MSLOAD:0062                 </span><span style="color:navy">pop     word ptr cs:</span>OrgDasdPtr<span style="color:navy">+</span><span style="color:green">2 </span><span style="color:olive">; ...
</span><span style="color:maroon">MSLOAD:0067                 </span><span style="color:navy">xor     cx, cx          </span><span style="color:olive">; ...
</span><span style="color:maroon">MSLOAD:0069                 </span><span style="color:navy">mov     ds, cx          </span>; 0
<span style="color:maroon">MSLOAD:006B                 </span><span style="color:navy">mov     es, cx          </span>; 0
<span style="color:maroon">MSLOAD:006D                 </span><span style="color:navy">mov     si, </span>word ptr ds:78h ; INT 1Eh disk parameters table address
<span style="color:maroon">MSLOAD:006D                                         </span>; (it is set by boot sector code)
<span style="color:maroon">MSLOAD:0071                 </span><span style="color:navy">mov     ds, </span>word ptr ds:78h+2
<span style="color:maroon">MSLOAD:0075
MSLOAD:0075 </span><span style="color:navy">loc_75:                                 </span>; Sec9 ; new location of DSK_PARMS
<span style="color:maroon">MSLOAD:0075                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">522h
</span><span style="color:maroon">MSLOAD:0078                 </span><span style="color:navy">mov     cx, </span><span style="color:green">14          </span>; (11+3 bytes for IBM rombios)
<span style="color:maroon">MSLOAD:007B                 </span><span style="color:navy">cld
</span><span style="color:maroon">MSLOAD:007C                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">MSLOAD:007E                 </span><span style="color:navy">push    es
</span><span style="color:maroon">MSLOAD:007F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">MSLOAD:0080                 </span><span style="color:navy">mov     </span>word ptr ds:78h<span style="color:navy">, </span><span style="color:green">522h </span><span style="color:olive">; ...
</span><span style="color:maroon">MSLOAD:0080                                         </span>; Offset Sec9
<span style="color:maroon">MSLOAD:0086                 </span><span style="color:navy">mov     </span>word ptr ds:78h+2<span style="color:navy">, ds
</span><span style="color:maroon">MSLOAD:008A                 </span><span style="color:navy">mov     cx, </span>word ptr ds:51Ah ; LW of IBMBIO.COM (IO.SYS) first cluster
<span style="color:maroon">MSLOAD:008E                 </span><span style="color:navy">mov     cs:</span>FirstCluster<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:0093                 </span><span style="color:navy">mov     cx, </span>word ptr ds:514h ; HW of IBMBIO.COM (IO.SYS) first cluster
<span style="color:maroon">MSLOAD:0097                 </span><span style="color:navy">mov     cs:</span>FirstCluster<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:009C                 </span><span style="color:navy">mov     cx, </span>ds:7C0Bh    ; BPB_BytsPerSec ; 512
<span style="color:maroon">MSLOAD:00A0                 </span><span style="color:navy">mov     cs:</span>BytesPerSec<span style="color:navy">, cx </span><span style="color:olive">; ...
</span><span style="color:maroon">MSLOAD:00A5                 </span><span style="color:navy">mov     cl, </span>ds:7C0Dh    ; BPB_SecPerClus
<span style="color:maroon">MSLOAD:00A9                 </span><span style="color:navy">mov     cs:</span>SecPerCluster<span style="color:navy">, cl
</span><span style="color:maroon">MSLOAD:00AE                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">7C18h    </span>; BPB_SecPerTrk
<span style="color:maroon">MSLOAD:00B2                 </span><span style="color:navy">mov     cs:</span>SecPerTrack<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:00B7                 </span><span style="color:navy">mov     cx, </span>ds:7C1Ah    ; BPB_NumHeads
<span style="color:maroon">MSLOAD:00BB                 </span><span style="color:navy">mov     cs:</span>NumHeads<span style="color:navy">, cx </span><span style="color:olive">; ...
</span><span style="color:maroon">MSLOAD:00C0                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">7C16h    </span>; BPB_FATSz16
<span style="color:maroon">MSLOAD:00C4                 </span><span style="color:navy">mov     cs:</span>FATSectorsL<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:00C9                 </span><span style="color:navy">mov     bl, </span>ds:7C26h    ; BS_BootSig ; (FAT12 and FAT16)
<span style="color:maroon">MSLOAD:00CD                 </span><span style="color:navy">or      cx, cx
</span><span style="color:maroon">MSLOAD:00CF                 </span><span style="color:navy">jnz     short </span>not_fat32
<span style="color:maroon">MSLOAD:00D1                 </span><span style="color:navy">mov     bl, ds:</span><span style="color:green">7C42h    </span>; BS_BootSig ; (FAT32)
<span style="color:maroon">MSLOAD:00D5
MSLOAD:00D5 </span>not_fat32<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:00D5                 </span><span style="color:navy">mov     cl, ds:</span><span style="color:green">7C10h    </span>; BPB_NumFATs
<span style="color:maroon">MSLOAD:00D9                 </span><span style="color:navy">mov     cs:</span>NumFats<span style="color:navy">, cl
</span><span style="color:maroon">MSLOAD:00DE                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">7C11h    </span>; BPB_RootEntCnt
<span style="color:maroon">MSLOAD:00E2                 </span><span style="color:navy">mov     cs:</span>RootEntCnt<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:00E7                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">7C0Eh    </span>; BPB_RsvdSecCnt
<span style="color:maroon">MSLOAD:00EB                 </span><span style="color:navy">mov     cs:</span>ReservSectors<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:00F0                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">7C1Ch    </span>; BPB_HiddSec
<span style="color:maroon">MSLOAD:00F4                 </span><span style="color:navy">mov     cs:</span>HiddenSectorsL<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:00F9                 </span><span style="color:navy">mov     cx, </span>ds:7C13h    ; BPB_TotSec16
<span style="color:maroon">MSLOAD:00FD                 </span><span style="color:navy">mov     cs:</span>TotalSectorsL<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:0102                 </span><span style="color:navy">cmp     bl, </span><span style="color:green">29h
</span><span style="color:maroon">MSLOAD:0105                 </span><span style="color:navy">jnz     short </span>Relocate  ; old boot sector,
<span style="color:maroon">MSLOAD:0105                                         </span>; no need to copy high words
<span style="color:maroon">MSLOAD:0107                 </span><span style="color:navy">mov     cs:</span>FirstSectorH<span style="color:navy">, ax </span>; Start sector # of data, high word
<span style="color:maroon">MSLOAD:010B                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">7C1Eh    </span>; BPB_HiddSec+2
<span style="color:maroon">MSLOAD:010E                 </span><span style="color:navy">mov     cs:</span>HiddenSectorsH<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:0112                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">MSLOAD:0115                 </span><span style="color:navy">jnz     short </span>not_big
<span style="color:maroon">MSLOAD:0117                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">7C20h    </span>; BPB_TotSec32
<span style="color:maroon">MSLOAD:011A                 </span><span style="color:navy">mov     cs:</span>TotalSectorsL<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:011E                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">7C22h    </span>; BPB_TotSec32+2
<span style="color:maroon">MSLOAD:0121                 </span><span style="color:navy">mov     cs:</span>TotalSectorsH<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:0125
MSLOAD:0125 </span>not_big<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:0125                 </span><span style="color:navy">cmp     cs:</span>FATSectorsL<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">MSLOAD:012B                 </span><span style="color:navy">jnz     short </span>Relocate  ; FAT12 or FAT16 fs
<span style="color:maroon">MSLOAD:012D                 </span><span style="color:navy">mov     cx, </span>ds:7C24h    ; BPB_FATSz32 ; FAT32 fs
<span style="color:maroon">MSLOAD:0131                 </span><span style="color:navy">mov     cs:</span>FATSectorsL<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:0136                 </span><span style="color:navy">mov     cx, </span>ds:7C26h    ; BPB_FATSz32+2
<span style="color:maroon">MSLOAD:013A                 </span><span style="color:navy">mov     cs:</span>FATSectorsH<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:013F                 </span><span style="color:navy">mov     cx, </span>ds:7C2Ch    ; BPB_RootClus
<span style="color:maroon">MSLOAD:0143                 </span><span style="color:navy">mov     cs:</span>RootClusterL<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:0148                 </span><span style="color:navy">mov     cx, </span>ds:7C2Eh    ; BPB_RootClus+2
<span style="color:maroon">MSLOAD:014C                 </span><span style="color:navy">mov     cs:</span>RootClusterH<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:0151
MSLOAD:0151 </span>Relocate<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:0151                 </span><span style="color:navy">cld                     </span>; copy code from start to top of memory
<span style="color:maroon">MSLOAD:0151                                         </span>; the length to copy is EndOfLoader
<span style="color:maroon">MSLOAD:0151                                         </span>; jump to relocated code
<span style="color:maroon">MSLOAD:0152                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">MSLOAD:0154                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">MSLOAD:0156                 </span><span style="color:navy">int     </span><span style="color:green">12h             </span>; MEMORY SIZE -
<span style="color:maroon">MSLOAD:0156                                         </span>; Return: AX = number of contiguous 1K blocks of memory
<span style="color:maroon">MSLOAD:0158                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">6
</span><span style="color:maroon">MSLOAD:015A                 </span><span style="color:navy">shl     ax, cl
</span><span style="color:maroon">MSLOAD:015C                 </span><span style="color:navy">xor     bx, bx          </span>; Check if an RPL program is present at TOM
<span style="color:maroon">MSLOAD:015C                                         </span>;  and do not tromp over it
<span style="color:maroon">MSLOAD:015E                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:maroon">MSLOAD:0160                 </span><span style="color:navy">mov     bx, </span>word ptr ds:0BCh ; 2Fh*4
<span style="color:maroon">MSLOAD:0164                 </span><span style="color:navy">mov     ds, </span>word ptr ds:0BEh ; 2Fh*4+2
<span style="color:maroon">MSLOAD:0168                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">5052h </span>; &#039;RP&#039; ; &#039;RPL&#039;
<span style="color:maroon">MSLOAD:016D                 </span><span style="color:navy">jnz     short </span>Skip_RPL
<span style="color:maroon">MSLOAD:016F                 </span><span style="color:navy">cmp     byte ptr [bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4Ch </span>; &#039;L&#039;
<span style="color:maroon">MSLOAD:0173                 </span><span style="color:navy">jnz     short </span>Skip_RPL
<span style="color:maroon">MSLOAD:0175                 </span><span style="color:navy">mov     dx, ax          </span>; get TOM into DX
<span style="color:maroon">MSLOAD:0177                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A06h
</span><span style="color:maroon">MSLOAD:017A                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Get new TOM from any RPL
<span style="color:maroon">MSLOAD:017C                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:maroon">MSLOAD:017E
MSLOAD:017E </span>Skip_RPL<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:017E                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">MSLOAD:0180                 </span><span style="color:navy">mov     dx, cs:</span>BytesPerSec
<span style="color:maroon">MSLOAD:0185                 </span><span style="color:navy">shr     dx, cl
</span><span style="color:maroon">MSLOAD:0187                 </span><span style="color:navy">inc     dx
</span><span style="color:maroon">MSLOAD:0188                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">MSLOAD:018A                 </span><span style="color:navy">mov     cs:</span>FatSegment<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:018E                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">5F0h        </span>; Offset EndOfLoader (1520)
<span style="color:maroon">MSLOAD:0191                 </span><span style="color:navy">shr     dx, cl
</span><span style="color:maroon">MSLOAD:0193                 </span><span style="color:navy">inc     dx
</span><span style="color:maroon">MSLOAD:0194                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">MSLOAD:0196                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">MSLOAD:0198                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">MSLOAD:0199                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">MSLOAD:019A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1520        </span>; Loader size = EndofLoader - 0
<span style="color:maroon">MSLOAD:019D                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">MSLOAD:019F                 </span><span style="color:navy">push    es              </span>; Far jump to relocated MSLOAD code
<span style="color:maroon">MSLOAD:019F                                         </span>; (via retf, far return)
<span style="color:maroon">MSLOAD:01A0                 </span><span style="color:navy">mov     ax, offset </span>SetupStack
<span style="color:maroon">MSLOAD:01A3                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">MSLOAD:01A4                 </span><span style="color:navy">retf
</span><span style="color:maroon">MSLOAD:01A5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">MSLOAD:01A5
MSLOAD:01A5 </span>SetupStack<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">MSLOAD:01A5                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:maroon">MSLOAD:01A7                 </span><span style="color:navy">sub     ax, </span><span style="color:green">40h         </span>; move ss to 400h backward for stack space
<span style="color:maroon">MSLOAD:01A7                                         </span>; then set sp to the end of this stack space
<span style="color:maroon">MSLOAD:01AA                 </span><span style="color:navy">mov     ss, ax
</span><span style="color:maroon">MSLOAD:01AC                 </span>assume ss:nothing
<span style="color:maroon">MSLOAD:01AC                 </span><span style="color:navy">mov     sp, </span><span style="color:green">400h
</span><span style="color:maroon">MSLOAD:01AF                 </span><span style="color:navy">add     ax, </span><span style="color:green">40h         </span>; ax = cs
<span style="color:maroon">MSLOAD:01B2                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">MSLOAD:01B4
MSLOAD:01B4 </span>FindClusterSize<span style="color:navy">:
</span><span style="color:maroon">MSLOAD:01B4                 </span><span style="color:navy">mov     ax, ds:</span>BytesPerSec
<span style="color:maroon">MSLOAD:01B7                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">MSLOAD:01B9                 </span><span style="color:navy">mov     bl, ds:</span>SecPerCluster
<span style="color:maroon">MSLOAD:01BD                 </span><span style="color:navy">mul     bx
</span><span style="color:maroon">MSLOAD:01BF                 </span><span style="color:navy">or      dx, dx
</span><span style="color:maroon">MSLOAD:01C1                 </span><span style="color:navy">jz      short </span>CalcFatSize
<span style="color:maroon">MSLOAD:01C3                 </span><span style="color:navy">jmp     </span>ErrorOut
<span style="color:maroon">MSLOAD:01C6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">MSLOAD:01C6
MSLOAD:01C6 </span>CalcFatSize<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:01C6                 </span><span style="color:navy">mov     ds:</span>ClusterSize<span style="color:navy">, ax </span>; cluster size in bytes
<span style="color:maroon">MSLOAD:01C9                 </span><span style="color:navy">mov     ds:</span>FatType<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; FAT12
<span style="color:maroon">MSLOAD:01CE                 </span><span style="color:navy">mov     dx, ds:</span>TotalSectorsH
<span style="color:maroon">MSLOAD:01D2                 </span><span style="color:navy">mov     ax, ds:</span>TotalSectorsL
<span style="color:maroon">MSLOAD:01D5                 </span><span style="color:navy">sub     ax, ds:</span>ReservSectors
<span style="color:maroon">MSLOAD:01D9                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = Total available sectors
<span style="color:maroon">MSLOAD:01DC                 </span><span style="color:navy">mov     bx, ds:</span>FATSectorsL
<span style="color:maroon">MSLOAD:01E0                 </span><span style="color:navy">mov     cx, ds:</span>FATSectorsH
<span style="color:maroon">MSLOAD:01E4                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">MSLOAD:01E5                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">MSLOAD:01E6                 </span><span style="color:navy">mov     al, ds:</span>NumFats  ; calculate total FAT sectors
<span style="color:maroon">MSLOAD:01E9                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">MSLOAD:01EB                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:maroon">MSLOAD:01EC                 </span><span style="color:navy">mul     cx
</span><span style="color:maroon">MSLOAD:01EE                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:maroon">MSLOAD:01EF                 </span><span style="color:navy">mul     bx
</span><span style="color:maroon">MSLOAD:01F1                 </span><span style="color:navy">add     cx, dx
</span><span style="color:maroon">MSLOAD:01F3                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">MSLOAD:01F5                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">MSLOAD:01F6                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">MSLOAD:01F7                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:maroon">MSLOAD:01F9                 </span><span style="color:navy">sbb     dx, cx          </span>; dx:ax = Total sectors - FAT sectors
<span style="color:maroon">MSLOAD:01FB                 </span><span style="color:navy">mov     bx, ds:</span>RootEntCnt
<span style="color:maroon">MSLOAD:01FF                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">MSLOAD:0201                 </span><span style="color:navy">shr     bx, cl          </span>; 16 directory entries per sector
<span style="color:maroon">MSLOAD:0203                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:maroon">MSLOAD:0205                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = data sectors
<span style="color:maroon">MSLOAD:0205                                         </span>; (Note: [RootEntCnt] is 0 for FAT32 fs)
<span style="color:maroon">MSLOAD:0208                 </span><span style="color:navy">xor     cx, cx          </span>;
<span style="color:maroon">MSLOAD:0208                                         </span>; 32 bit divide by sectors per
<span style="color:maroon">MSLOAD:0208                                         </span>;  cluster to find total number
<span style="color:maroon">MSLOAD:0208                                         </span>;  of clusters.
<span style="color:maroon">MSLOAD:020A                 </span><span style="color:navy">mov     cl, ds:</span>SecPerCluster
<span style="color:maroon">MSLOAD:020E                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">MSLOAD:020F                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:maroon">MSLOAD:0211                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">MSLOAD:0213                 </span><span style="color:navy">div     cx
</span><span style="color:maroon">MSLOAD:0215                 </span><span style="color:navy">mov     ds:</span>TempH<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:0218                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">MSLOAD:0219                 </span><span style="color:navy">div     cx
</span><span style="color:maroon">MSLOAD:021B                 </span><span style="color:navy">mov     dx, ds:</span>FirstCluster<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">MSLOAD:021F                 </span><span style="color:navy">mov     ds:</span>FatType<span style="color:navy">, </span><span style="color:#ff8000">0Bh </span>; set FAT type to FAT32 (CHS type disk R/W)
<span style="color:maroon">MSLOAD:0224                 </span><span style="color:navy">cmp     ds:</span>TempH<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; is cluster count &gt; 65535 ?
<span style="color:maroon">MSLOAD:0229                 </span><span style="color:navy">jnz     short </span>ReadInFirstCluster ; yes, it is (it must be) FAT32 fs
<span style="color:maroon">MSLOAD:022B                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFF6h      </span>; FAT16 limit (65536-10)
<span style="color:maroon">MSLOAD:022E                 </span><span style="color:navy">jnb     short </span>ReadInFirstCluster
<span style="color:maroon">MSLOAD:0230                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">MSLOAD:0232                 </span><span style="color:navy">mov     ds:</span>FirstCluster<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, dx </span>; clear HW of FirstCluster
<span style="color:maroon">MSLOAD:0236                 </span><span style="color:navy">mov     ds:</span>FatType<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; set FAT type fo FAT12
<span style="color:maroon">MSLOAD:023B                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FF6h       </span>; 4086 ; (4096-10)
<span style="color:maroon">MSLOAD:023E                 </span><span style="color:navy">jb      short </span>ReadInFirstCluster
<span style="color:maroon">MSLOAD:0240                 </span><span style="color:navy">mov     ds:</span>FatType<span style="color:navy">, </span><span style="color:#ff8000">4   </span>; set FAT type to FAT16
<span style="color:maroon">MSLOAD:0245
MSLOAD:0245 </span>ReadInFirstCluster<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:0245                 </span><span style="color:navy">mov     ax, ds:</span>FirstCluster ; dx:ax = BIOS starting cluster
<span style="color:maroon">MSLOAD:0248                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">2           </span>; First cluster is 2 so
<span style="color:maroon">MSLOAD:0248                                         </span>; decrement to make 0 based
<span style="color:maroon">MSLOAD:024B                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">MSLOAD:024E                 </span><span style="color:navy">mov     ds:</span>CurrentClusterH<span style="color:navy">, dx </span>; Initialize to this cluster
<span style="color:maroon">MSLOAD:0252                 </span><span style="color:navy">mov     ds:</span>CurrentClusterL<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:0255                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; (Note: PCDOS 7.1 bs loads 1st 4 sectors of IBMBIO.COM)
<span style="color:maroon">MSLOAD:0255                                         </span>; If cluster size &gt; 3, al = 0, ah &lt;&gt; 0
<span style="color:maroon">MSLOAD:0255                                         </span>; If cluster size = 2, al = 1, ah = 1
<span style="color:maroon">MSLOAD:0255                                         </span>; If cluster size = 1, al = 3, ah = 0
<span style="color:maroon">MSLOAD:0255                                         </span>; If ah = 0, nothing remaining in last cluster
<span style="color:maroon">MSLOAD:0258                 </span><span style="color:navy">div     ds:</span>SecPerCluster
<span style="color:maroon">MSLOAD:025C                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0
</span><span style="color:maroon">MSLOAD:025F                 </span><span style="color:navy">jz      short </span>SetNextClusterNum
<span style="color:maroon">MSLOAD:0261                 </span><span style="color:navy">xor     ah, ah          </span>; Calculate sector to start reading from
<span style="color:maroon">MSLOAD:0261                                         </span>; in StartSecH and StartSecL
<span style="color:maroon">MSLOAD:0263                 </span><span style="color:navy">push    ax              </span>; (*)
<span style="color:maroon">MSLOAD:0264                 </span><span style="color:navy">mov     cx, ds:</span>FirstSectorL
<span style="color:maroon">MSLOAD:0268                 </span><span style="color:navy">mov     ds:</span>StartSecL<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:026C                 </span><span style="color:navy">mov     cx, ds:</span>FirstSectorH
<span style="color:maroon">MSLOAD:0270                 </span><span style="color:navy">mov     ds:</span>StartSecH<span style="color:navy">, cx
</span><span style="color:maroon">MSLOAD:0274                 </span><span style="color:navy">mul     ds:</span>SecPerCluster
<span style="color:maroon">MSLOAD:0278                 </span><span style="color:navy">add     ds:</span>StartSecL<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:027C                 </span><span style="color:navy">adc     ds:</span>StartSecH<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Add number of sectors already loaded
<span style="color:maroon">MSLOAD:027C                                         </span>;    to start sector
<span style="color:maroon">MSLOAD:0281                 </span><span style="color:navy">mov     dx, ds:</span>FirstCluster<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">MSLOAD:0285                 </span><span style="color:navy">mov     ax, ds:</span>FirstCluster
<span style="color:maroon">MSLOAD:0288                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">2
</span><span style="color:maroon">MSLOAD:028B                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">MSLOAD:028E                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">MSLOAD:0290                 </span><span style="color:navy">mov     bl, ds:</span>SecPerCluster
<span style="color:maroon">MSLOAD:0294                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">MSLOAD:0295                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:maroon">MSLOAD:0297                 </span><span style="color:navy">mul     bx
</span><span style="color:maroon">MSLOAD:0299                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">MSLOAD:029A                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">MSLOAD:029B                 </span><span style="color:navy">mul     dx
</span><span style="color:maroon">MSLOAD:029D                 </span><span style="color:navy">add     dx, bx
</span><span style="color:maroon">MSLOAD:029F                 </span><span style="color:navy">add     ds:</span>StartSecL<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:02A3                 </span><span style="color:navy">adc     ds:</span>StartSecH<span style="color:navy">, dx
</span><span style="color:maroon">MSLOAD:02A7                 </span><span style="color:navy">pop     ax              </span>; (*) number of clusters already loaded
<span style="color:maroon">MSLOAD:02A7                                         </span>; (0 or 1)
<span style="color:maroon">MSLOAD:02A7                                         </span>; (Note: if al=0, the 1st 4 sectors of the 1st cluster
<span style="color:maroon">MSLOAD:02A7                                         </span>;  will be loaded again! -PCDOS 7.1-)
<span style="color:maroon">MSLOAD:02A8                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">MSLOAD:02A9                 </span><span style="color:navy">mul     ds:</span>ClusterSize
<span style="color:maroon">MSLOAD:02AD                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">700h        </span>; IBMBIO.COM (IO.SYS) loading address (segment = 0)
<span style="color:maroon">MSLOAD:02B0                 </span><span style="color:navy">add     di, ax
</span><span style="color:maroon">MSLOAD:02B2                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">MSLOAD:02B4                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">MSLOAD:02B6                 </span><span style="color:navy">mov     al, ds:</span>SecPerCluster ; read 1 cluster
<span style="color:maroon">MSLOAD:02B9                 </span><span style="color:navy">mov     ds:</span>SectorCount<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:02BC                 </span><span style="color:navy">call    </span>ReadSectors
<span style="color:maroon">MSLOAD:02BF                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">MSLOAD:02C0                 </span><span style="color:navy">inc     ax              </span>; +1 cluster loaded
<span style="color:maroon">MSLOAD:02C1
MSLOAD:02C1 </span>SetNextClusterNum<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:02C1                 </span><span style="color:navy">inc     ax              </span>; ax = total clusters read in based 2
<span style="color:maroon">MSLOAD:02C2                 </span><span style="color:navy">add     ds:</span>CurrentClusterL<span style="color:navy">, ax </span>; CurrentCluster = Last cluster read
<span style="color:maroon">MSLOAD:02C6                 </span><span style="color:navy">adc     ds:</span>CurrentClusterH<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">MSLOAD:02CB                 </span><span style="color:navy">dec     ax              </span>; ax = number of clusters loaded
<span style="color:maroon">MSLOAD:02CC
MSLOAD:02CC </span>SaveLoadedBios<span style="color:navy">:
</span><span style="color:maroon">MSLOAD:02CC                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">MSLOAD:02CD                 </span><span style="color:navy">mul     ds:</span>ClusterSize  ; Get total bytes loaded by this is always &lt; 64k,
<span style="color:maroon">MSLOAD:02CD                                         </span>; so lower 16 bits ok
<span style="color:maroon">MSLOAD:02D1                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">5F0h        </span>; get portion of iosys loaded
<span style="color:maroon">MSLOAD:02D1                                         </span>; EndOfLoader ; (Offset EndOfLoader)-(Offset Start)
<span style="color:maroon">MSLOAD:02D4                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">MSLOAD:02D6                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; Segment at 70h
<span style="color:maroon">MSLOAD:02D9                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">MSLOAD:02DB                 </span>assume ds:nothing
<span style="color:maroon">MSLOAD:02DB                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">MSLOAD:02DD                 </span>assume es:nothing
<span style="color:maroon">MSLOAD:02DD                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">5F0h        </span>; EndOfLoader
<span style="color:maroon">MSLOAD:02E0                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">MSLOAD:02E2                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">MSLOAD:02E4                 </span><span style="color:navy">mov     cs:</span>NextBioLocation<span style="color:navy">, di </span>; Save where location for next read
<span style="color:maroon">MSLOAD:02E9                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">MSLOAD:02EA                 </span>assume ds:nothing
<span style="color:maroon">MSLOAD:02EA
MSLOAD:02EA </span>GetContigClusters<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:02EA                 </span><span style="color:navy">xor     ah, ah          </span>; go find clusters as long as they are contiguous
<span style="color:maroon">MSLOAD:02EC                 </span><span style="color:navy">mov     al, ds:</span>SecPerCluster
<span style="color:maroon">MSLOAD:02EF                 </span><span style="color:navy">mov     ds:</span>SectorCount<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:02F2                 </span><span style="color:navy">push    ds:</span>SectorCount
<span style="color:maroon">MSLOAD:02F6                 </span><span style="color:navy">call    </span>GetNextFatEntry ; Returns next cluster to read in di:ax
<span style="color:maroon">MSLOAD:02F9                 </span><span style="color:navy">pop     ds:</span>SectorCount
<span style="color:maroon">MSLOAD:02FD                 </span><span style="color:navy">mov     ds:</span>CurrentClusterL<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:0300                 </span><span style="color:navy">mov     ds:</span>CurrentClusterH<span style="color:navy">, di
</span><span style="color:maroon">MSLOAD:0304                 </span><span style="color:navy">cmp     ds:</span>EndOfFile<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">MSLOAD:0309                 </span><span style="color:navy">jz      short </span>GoToBioInit
<span style="color:maroon">MSLOAD:030B                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">MSLOAD:030D                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">2           </span>; Zero base the cluster (32 bit as di:ax)
<span style="color:maroon">MSLOAD:0310                 </span><span style="color:navy">sbb     di, dx
</span><span style="color:maroon">MSLOAD:0312                 </span><span style="color:navy">xchg    ax, di          </span>; 32 bit multiplication
<span style="color:maroon">MSLOAD:0312                                         </span>; (dx:ax)*cx
<span style="color:maroon">MSLOAD:0313                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:maroon">MSLOAD:0315                 </span><span style="color:navy">mov     cl, ds:</span>SecPerCluster
<span style="color:maroon">MSLOAD:0319                 </span><span style="color:navy">mul     cx
</span><span style="color:maroon">MSLOAD:031B                 </span><span style="color:navy">xchg    ax, di
</span><span style="color:maroon">MSLOAD:031C                 </span><span style="color:navy">mul     cx
</span><span style="color:maroon">MSLOAD:031E                 </span><span style="color:navy">add     dx, di
</span><span style="color:maroon">MSLOAD:0320                 </span><span style="color:navy">add     ax, ds:</span>FirstSectorL
<span style="color:maroon">MSLOAD:0324                 </span><span style="color:navy">adc     dx, ds:</span>FirstSectorH
<span style="color:maroon">MSLOAD:0328                 </span><span style="color:navy">mov     ds:</span>StartSecL<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:032B                 </span><span style="color:navy">mov     ds:</span>StartSecH<span style="color:navy">, dx
</span><span style="color:maroon">MSLOAD:032F                 </span><span style="color:navy">mov     di, ds:</span>NextBioLocation
<span style="color:maroon">MSLOAD:0333                 </span><span style="color:navy">push    ds:</span>SectorCount
<span style="color:maroon">MSLOAD:0337                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h
</span><span style="color:maroon">MSLOAD:033A                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">MSLOAD:033C                 </span><span style="color:navy">call    </span>ReadSectors
<span style="color:maroon">MSLOAD:033F                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">MSLOAD:0340                 </span><span style="color:navy">mul     ds:</span>BytesPerSec
<span style="color:maroon">MSLOAD:0344                 </span><span style="color:navy">add     ds:</span>NextBioLocation<span style="color:navy">, ax
</span><span style="color:maroon">MSLOAD:0348                 </span><span style="color:navy">jmp     short </span>GetContigClusters
<span style="color:maroon">MSLOAD:034A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">MSLOAD:034A
MSLOAD:034A </span>GoToBioInit<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">MSLOAD:034A                 </span><span style="color:navy">mov     ch, ds:</span>MediaByte ; Set up required registers for iosys,
<span style="color:maroon">MSLOAD:034A                                         </span>;  then jump to it (70:0)
<span style="color:maroon">MSLOAD:034A                                         </span>;
<span style="color:maroon">MSLOAD:034A                                         </span>; Restore regs required for msint
<span style="color:maroon">MSLOAD:034E                 </span><span style="color:navy">mov     dl, ds:</span>BootDrive ; Physical drv number we booted from
<span style="color:maroon">MSLOAD:0352                 </span><span style="color:navy">mov     bx, ds:</span>FirstSectorL
<span style="color:maroon">MSLOAD:0356                 </span><span style="color:navy">mov     ax, ds:</span>FirstSectorH ; bx:ax = first data sector of disk
<span style="color:maroon">MSLOAD:0359                 </span><span style="color:navy">lds     si, ds:</span>OrgDasdPtr ; Set ds:si to Original INT 1Eh disk(ette) table address
<span style="color:maroon">MSLOAD:0359                                         </span>; and then push disk table address and INT 1Eh vector to stack
<span style="color:maroon">MSLOAD:0359                                         </span>; (set stack content just as at the start of MSLOAD)
<span style="color:maroon">MSLOAD:035D                 </span><span style="color:navy">push    ds              </span>; INT 1Eh original table segment
<span style="color:maroon">MSLOAD:035E                 </span><span style="color:navy">push    si              </span>; INT 1Eh original table offset
<span style="color:maroon">MSLOAD:035F                 </span><span style="color:navy">xor     di, di          </span>; 0  ; INT 1Eh vector segment
<span style="color:maroon">MSLOAD:0361                 </span><span style="color:navy">push    di
</span><span style="color:maroon">MSLOAD:0362                 </span><span style="color:navy">mov     di, </span><span style="color:green">78h         </span>; 1Eh*4 = 78h
<span style="color:maroon">MSLOAD:0365                 </span><span style="color:navy">push    di              </span>; INT 1Eh vector offset
<span style="color:maroon">MSLOAD:0366                 </span><span style="color:navy">jmp     </span>far ptr 70h:0   ; Far jump to IoSysAddr (DOSBIOS)
<span style="color:black">MSLOAD:036B
MSLOAD:036B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">MSLOAD:036B
MSLOAD:036B
MSLOAD:036B </span>check_int13h_extensions <span style="color:black">proc near       </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:036B                 </span><span style="color:navy">push    ax
</span><span style="color:black">MSLOAD:036C                 </span><span style="color:navy">push    dx
</span><span style="color:black">MSLOAD:036D                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">MSLOAD:036F                 </span><span style="color:navy">push    ax              </span>; zero (buffer offset 24)
<span style="color:black">MSLOAD:036F                                         </span>; (bytes per sector)
<span style="color:black">MSLOAD:0370                 </span><span style="color:navy">mov     bx, sp
</span><span style="color:black">MSLOAD:0372                 </span><span style="color:navy">sub     sp, </span><span style="color:green">20
</span><span style="color:black">MSLOAD:0375                 </span><span style="color:navy">push    ax              </span>; info flags
<span style="color:black">MSLOAD:0376                 </span><span style="color:navy">mov     ax, </span><span style="color:green">26          </span>; Result buffer size
<span style="color:black">MSLOAD:0379                 </span><span style="color:navy">push    ax
</span><span style="color:black">MSLOAD:037A                 </span><span style="color:navy">mov     si, sp
</span><span style="color:black">MSLOAD:037C                 </span><span style="color:navy">mov     dl, ds:</span>BootDrive
<span style="color:black">MSLOAD:0380                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">MSLOAD:0382                 </span><span style="color:navy">push    ds
</span><span style="color:black">MSLOAD:0383                 </span><span style="color:navy">push    ss
</span><span style="color:black">MSLOAD:0384                 </span><span style="color:navy">pop     ds
</span><span style="color:black">MSLOAD:0385                 </span>assume ds:nothing
<span style="color:black">MSLOAD:0385                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">0
</span><span style="color:black">MSLOAD:0388                 </span><span style="color:navy">jge     short </span><span style="color:gray">not_hard_disk
</span><span style="color:black">MSLOAD:038A                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension - GET DRIVE PARAMETERS
<span style="color:black">MSLOAD:038A                                         </span>; (DL - drive, DS:SI - buffer)
<span style="color:black">MSLOAD:038C
MSLOAD:038C </span><span style="color:gray">not_hard_disk</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:038C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">MSLOAD:038D                 </span>assume ds:nothing
<span style="color:black">MSLOAD:038D                 </span><span style="color:navy">mov     sp, bx
</span><span style="color:black">MSLOAD:038F                 </span><span style="color:navy">pop     ax              </span>; bytes per sector, buffer offset 24
<span style="color:black">MSLOAD:0390                 </span><span style="color:navy">jb      short </span><span style="color:gray">int13h_ext_err
</span><span style="color:black">MSLOAD:0392                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">512
</span><span style="color:black">MSLOAD:0395                 </span><span style="color:navy">jz      short </span><span style="color:gray">int13h_ext_err
</span><span style="color:black">MSLOAD:0397                 </span><span style="color:navy">stc
</span><span style="color:black">MSLOAD:0398
MSLOAD:0398 </span><span style="color:gray">int13h_ext_err</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:0398                 </span><span style="color:navy">pop     dx
</span><span style="color:black">MSLOAD:0399                 </span><span style="color:navy">pop     ax
</span><span style="color:black">MSLOAD:039A                 </span><span style="color:navy">retn
</span><span style="color:black">MSLOAD:039A </span>check_int13h_extensions <span style="color:black">endp
MSLOAD:039A
MSLOAD:039B
MSLOAD:039B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">MSLOAD:039B
MSLOAD:039B
MSLOAD:039B </span>ReadSectors     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:039B                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:black">MSLOAD:039E
MSLOAD:039E </span>TryRead<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:039E                 </span><span style="color:navy">push    cx              </span>; (*)
<span style="color:black">MSLOAD:039F                 </span><span style="color:navy">mov     ax, ds:</span>StartSecL
<span style="color:black">MSLOAD:03A2                 </span><span style="color:navy">mov     dx, ds:</span>StartSecH
<span style="color:black">MSLOAD:03A6                 </span><span style="color:navy">push    ax              </span>; (**)
<span style="color:black">MSLOAD:03A7                 </span><span style="color:navy">call    </span>check_int13h_extensions
<span style="color:black">MSLOAD:03AA                 </span><span style="color:navy">jb      short </span>chs_read
<span style="color:black">MSLOAD:03AC                 </span><span style="color:navy">xor     si, si          </span>; LBA read
<span style="color:black">MSLOAD:03AE                 </span><span style="color:navy">push    si              </span>; 0
<span style="color:black">MSLOAD:03AF                 </span><span style="color:navy">push    si              </span>; 0
<span style="color:black">MSLOAD:03B0                 </span><span style="color:navy">push    dx
</span><span style="color:black">MSLOAD:03B1                 </span><span style="color:navy">push    ax              </span>; 0:0:dx:ax = start sector (8 bytes)
<span style="color:black">MSLOAD:03B2                 </span><span style="color:navy">push    es
</span><span style="color:black">MSLOAD:03B3                 </span><span style="color:navy">push    di              </span>; memory buffer address (seg:off)
<span style="color:black">MSLOAD:03B4                 </span><span style="color:navy">push    ds:</span>SectorCount  ; number of sectors to read
<span style="color:black">MSLOAD:03B8                 </span><span style="color:navy">mov     bx, </span>16          ; size of DAP
<span style="color:black">MSLOAD:03BB                 </span><span style="color:navy">push    bx
</span><span style="color:black">MSLOAD:03BC                 </span><span style="color:navy">mov     si, sp
</span><span style="color:black">MSLOAD:03BE                 </span><span style="color:navy">mov     ah, </span><span style="color:green">42h
</span><span style="color:black">MSLOAD:03C0                 </span><span style="color:navy">push    dx
</span><span style="color:black">MSLOAD:03C1                 </span><span style="color:navy">mov     dl, ds:</span>BootDrive
<span style="color:black">MSLOAD:03C5                 </span><span style="color:navy">push    ds
</span><span style="color:black">MSLOAD:03C6                 </span><span style="color:navy">push    ss
</span><span style="color:black">MSLOAD:03C7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">MSLOAD:03C8                 </span>assume ds:nothing
<span style="color:black">MSLOAD:03C8                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension - EXTENDED READ
<span style="color:black">MSLOAD:03C8                                         </span>; (DL - drive, DS:SI - disk address packet)
<span style="color:black">MSLOAD:03CA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">MSLOAD:03CB                 </span>assume ds:nothing
<span style="color:black">MSLOAD:03CB                 </span><span style="color:navy">pop     dx              </span>; sector number, hw
<span style="color:black">MSLOAD:03CC                 </span><span style="color:navy">jb      short </span>lba_read_err
<span style="color:black">MSLOAD:03CE                 </span><span style="color:navy">pop     ax              </span>; size of DAP (disk address packet) = 16
<span style="color:black">MSLOAD:03CF                 </span><span style="color:navy">pop     ax              </span>; number of sectors to read
<span style="color:black">MSLOAD:03D0                 </span><span style="color:navy">push    ax              </span>; (**) discard ax on stack (StartSectorL)
<span style="color:black">MSLOAD:03D1                 </span><span style="color:navy">add     sp, bx          </span>; sp points to cx (*)
<span style="color:black">MSLOAD:03D3                 </span><span style="color:navy">pop     cx              </span>; remaining retry count value
<span style="color:black">MSLOAD:03D4                 </span><span style="color:navy">jmp     </span>ReadOk
<span style="color:black">MSLOAD:03D7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:03D7
MSLOAD:03D7 </span>lba_read_err<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:03D7                 </span><span style="color:navy">add     sp, bx
</span><span style="color:black">MSLOAD:03D9
MSLOAD:03D9 </span>chs_read<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:03D9                 </span><span style="color:navy">mov     ax, dx          </span>; start sector, hw
<span style="color:black">MSLOAD:03DB                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">MSLOAD:03DD                 </span><span style="color:navy">cmp     ds:</span>SecPerTrack<span style="color:navy">, ax </span>; hw of disk (LBA) address
<span style="color:black">MSLOAD:03DD                                         </span>; (must not be &gt; sectors per track)
<span style="color:black">MSLOAD:03E1                 </span><span style="color:navy">jnb     short </span>DoDivide
<span style="color:black">MSLOAD:03E3
MSLOAD:03E3 </span>ErrorOut<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:03E3                 </span><span style="color:navy">push    cs
</span><span style="color:black">MSLOAD:03E4                 </span><span style="color:navy">pop     ds
</span><span style="color:black">MSLOAD:03E5                 </span><span style="color:navy">mov     si, offset </span>NonSystemDiskMsg <span style="color:gray">; &quot;\r\nNon-System disk or disk error\r\nRe&quot;...
</span><span style="color:black">MSLOAD:03E8
MSLOAD:03E8 </span>WriteTTY<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:03E8                 </span><span style="color:navy">lodsb
</span><span style="color:black">MSLOAD:03E9                 </span><span style="color:navy">or      al, al
</span><span style="color:black">MSLOAD:03EB                 </span><span style="color:navy">jz      short </span>wait_key_reboot
<span style="color:black">MSLOAD:03ED                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:black">MSLOAD:03EF                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">7
</span><span style="color:black">MSLOAD:03F1                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO -
<span style="color:black">MSLOAD:03F3                 </span><span style="color:navy">jmp     short </span>WriteTTY
<span style="color:black">MSLOAD:03F5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:03F5
MSLOAD:03F5 </span>wait_key_reboot<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:03F5                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">MSLOAD:03F7                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD -
<span style="color:black">MSLOAD:03F9                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">MSLOAD:03FB                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">MSLOAD:03FD                 </span><span style="color:navy">les     bx, cs:</span>OrgDasdPtr
<span style="color:black">MSLOAD:0402                 </span>assume es:nothing
<span style="color:black">MSLOAD:0402                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">78h </span><span style="color:gray">; &#039;x&#039;
</span><span style="color:black">MSLOAD:0405                 </span><span style="color:navy">mov     [si], bx
</span><span style="color:black">MSLOAD:0407                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], es
</span><span style="color:black">MSLOAD:040A                 </span><span style="color:navy">int     </span><span style="color:green">19h             </span>; DISK BOOT
<span style="color:black">MSLOAD:040A                                         </span>; causes reboot of disk system
<span style="color:black">MSLOAD:040C
MSLOAD:040C </span>DoDivide<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:040C                 </span><span style="color:navy">div     ds:</span>SecPerTrack  ; 32 bit division
<span style="color:black">MSLOAD:0410                 </span><span style="color:navy">mov     ds:</span>TempH<span style="color:navy">, ax
</span><span style="color:black">MSLOAD:0413                 </span><span style="color:navy">pop     ax              </span>; start sector, lw
<span style="color:black">MSLOAD:0414                 </span><span style="color:navy">div     ds:</span>SecPerTrack
<span style="color:black">MSLOAD:0418                 </span><span style="color:navy">mov     bx, ds:</span>SecPerTrack
<span style="color:black">MSLOAD:041C                 </span><span style="color:navy">sub     bx, dx          </span>; dx = start sector on (same) track
<span style="color:black">MSLOAD:041E                 </span><span style="color:navy">mov     si, bx          </span>; sectors to read on (same) track (remain sectors)
<span style="color:black">MSLOAD:0420                 </span><span style="color:navy">cmp     ds:</span>SectorCount<span style="color:navy">, si
</span><span style="color:black">MSLOAD:0424                 </span><span style="color:navy">jnb     short </span>GotLength
<span style="color:black">MSLOAD:0426                 </span><span style="color:navy">mov     si, ds:</span>SectorCount
<span style="color:black">MSLOAD:042A
MSLOAD:042A </span>GotLength<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:042A                 </span><span style="color:navy">inc     dl              </span>; Sector numbers are 1-based
<span style="color:black">MSLOAD:042C                 </span><span style="color:navy">mov     bl, dl
</span><span style="color:black">MSLOAD:042E                 </span><span style="color:navy">mov     dx, ds:</span>TempH    ; dx:ax = Track
<span style="color:black">MSLOAD:0432                 </span><span style="color:navy">push    ax
</span><span style="color:black">MSLOAD:0433                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">MSLOAD:0435                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">MSLOAD:0437                 </span><span style="color:navy">div     ds:</span>NumHeads     ; Start cyl in ax, head in dl
<span style="color:black">MSLOAD:043B                 </span><span style="color:navy">mov     ds:</span>TempH<span style="color:navy">, ax
</span><span style="color:black">MSLOAD:043E                 </span><span style="color:navy">pop     ax
</span><span style="color:black">MSLOAD:043F                 </span><span style="color:navy">div     ds:</span>NumHeads     ; [TempH]:ax = Cylinder, dx = Head
<span style="color:black">MSLOAD:043F                                         </span>;
<span style="color:black">MSLOAD:043F                                         </span>; At this moment, we assume that TempH = 0,
<span style="color:black">MSLOAD:043F                                         </span>; ax &lt;= 1024, dx &lt;= 255
<span style="color:black">MSLOAD:0443                 </span><span style="color:navy">mov     dh, dl          </span>;
<span style="color:black">MSLOAD:0443                                         </span>; Issue one read request.
<span style="color:black">MSLOAD:0443                                         </span>; es:bx have the transfer address,
<span style="color:black">MSLOAD:0443                                         </span>; al is the number of sectors.
<span style="color:black">MSLOAD:0445                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">6
</span><span style="color:black">MSLOAD:0447                 </span><span style="color:navy">shl     ah, cl          </span>; Shift cyl high bits up
<span style="color:black">MSLOAD:0449                 </span><span style="color:navy">or      ah, bl          </span>; Mix in with sector bits
<span style="color:black">MSLOAD:044B                 </span><span style="color:navy">mov     ch, al          </span>; Setup cyl low
<span style="color:black">MSLOAD:044D                 </span><span style="color:navy">mov     cl, ah          </span>; Setup cyl/high - sector
<span style="color:black">MSLOAD:044F                 </span><span style="color:navy">mov     bx, di          </span>; Get back OFFSET
<span style="color:black">MSLOAD:0451                 </span><span style="color:navy">mov     dl, ds:</span>BootDrive ; Get drive
<span style="color:black">MSLOAD:0455                 </span><span style="color:navy">mov     ax, si          </span>; Get number of sectors to read (al)
<span style="color:black">MSLOAD:0457                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; Read
<span style="color:black">MSLOAD:0459                 </span><span style="color:navy">push    ax              </span>; Save read count
<span style="color:black">MSLOAD:045A                 </span><span style="color:navy">push    di
</span><span style="color:black">MSLOAD:045B                 </span><span style="color:navy">int     </span>13h             ; DISK - READ SECTORS INTO MEMORY
<span style="color:black">MSLOAD:045B                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:black">MSLOAD:045B                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:black">MSLOAD:045B                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:black">MSLOAD:045D                 </span><span style="color:navy">pop     di
</span><span style="color:black">MSLOAD:045E                 </span><span style="color:navy">pop     ax
</span><span style="color:black">MSLOAD:045F                 </span><span style="color:navy">pop     cx
</span><span style="color:black">MSLOAD:0460                 </span><span style="color:navy">jnb     short </span>ReadOk
<span style="color:black">MSLOAD:0462                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">MSLOAD:0464                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">MSLOAD:0466                 </span><span style="color:navy">push    cx
</span><span style="color:black">MSLOAD:0467                 </span><span style="color:navy">mov     dl, ds:</span>BootDrive
<span style="color:black">MSLOAD:046B                 </span><span style="color:navy">push    di
</span><span style="color:black">MSLOAD:046C                 </span><span style="color:navy">int     </span>13h             ; DISK - RESET DISK SYSTEM
<span style="color:black">MSLOAD:046C                                         </span>; DL = drive (if bit 7 is set both hard disks and floppy disks reset)
<span style="color:black">MSLOAD:046E                 </span><span style="color:navy">pop     di
</span><span style="color:black">MSLOAD:046F                 </span><span style="color:navy">pop     cx
</span><span style="color:black">MSLOAD:0470                 </span><span style="color:navy">dec     cx              </span>; Get retry count back
<span style="color:black">MSLOAD:0471                 </span><span style="color:navy">jz      short </span>ReadError
<span style="color:black">MSLOAD:0473                 </span><span style="color:navy">jmp     </span>TryRead         <span style="color:olive">; ...
</span><span style="color:black">MSLOAD:0476 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:0476
MSLOAD:0476 </span>ReadError<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:0476                 </span><span style="color:navy">jmp     </span>ErrorOut
<span style="color:black">MSLOAD:0479 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:0479                 </span><span style="color:navy">jmp     </span>TryRead
<span style="color:black">MSLOAD:047C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:047C
MSLOAD:047C </span>ReadOk<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:047C                 </span><span style="color:navy">xor     ah, ah          </span>;  Mask out read command, just get # read
<span style="color:black">MSLOAD:047E                 </span><span style="color:navy">sub     ds:</span>SectorCount<span style="color:navy">, ax </span>; Bump number down
<span style="color:black">MSLOAD:0482                 </span><span style="color:navy">jz      short </span>EndRead
<span style="color:black">MSLOAD:0484                 </span><span style="color:navy">add     ds:</span>StartSecL<span style="color:navy">, ax </span>; Where to start next time
<span style="color:black">MSLOAD:0488                 </span><span style="color:navy">adc     ds:</span>StartSecH<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">MSLOAD:048D                 </span><span style="color:navy">xor     bx, bx          </span>; Get number sectors read
<span style="color:black">MSLOAD:048F                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">MSLOAD:0491                 </span><span style="color:navy">mov     ax, ds:</span>BytesPerSec
<span style="color:black">MSLOAD:0494                 </span><span style="color:navy">mul     bx              </span>; Get total bytes read
<span style="color:black">MSLOAD:0496                 </span><span style="color:navy">add     di, ax          </span>; Add it to offset
<span style="color:black">MSLOAD:0498                 </span><span style="color:navy">jmp     </span>ReadSectors
<span style="color:black">MSLOAD:049B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:049B
MSLOAD:049B </span>EndRead<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:049B                 </span><span style="color:navy">retn
</span><span style="color:black">MSLOAD:049B </span><span style="background:red">ReadSectors     endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">MSLOAD:049B
MSLOAD:049C
MSLOAD:049C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">MSLOAD:049C
MSLOAD:049C
MSLOAD:049C </span>GetNextFatEntry <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:049C                 </span><span style="color:navy">push    es
</span><span style="color:black">MSLOAD:049D                 </span><span style="color:navy">mov     ax, ds:</span>FatSegment
<span style="color:black">MSLOAD:04A0                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">MSLOAD:04A2                 </span><span style="color:navy">mov     ds:</span>EndOfFile<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; END_OF_FILE ; Assume last cluster
<span style="color:black">MSLOAD:04A7                 </span><span style="color:navy">mov     ax, ds:</span>CurrentClusterL ; Get last cluster
<span style="color:black">MSLOAD:04AA                 </span><span style="color:navy">mov     di, ds:</span>CurrentClusterH
<span style="color:black">MSLOAD:04AE
MSLOAD:04AE </span>chk_fat32_type<span style="color:navy">:                         </span>; FAT32 (CHS) fs ?
<span style="color:black">MSLOAD:04AE                 </span><span style="color:navy">cmp     ds:</span>FatType<span style="color:navy">, </span><span style="color:#ff8000">0Bh
</span><span style="color:black">MSLOAD:04B3                 </span><span style="color:navy">jnz     short </span>chk_fat_type ; no
<span style="color:black">MSLOAD:04B5
MSLOAD:04B5 </span>Got32Bit<span style="color:navy">:                               </span>; Multiply cluster number by 4
<span style="color:black">MSLOAD:04B5                 </span><span style="color:navy">add     ax, ax
</span><span style="color:black">MSLOAD:04B7                 </span><span style="color:navy">adc     di, di
</span><span style="color:black">MSLOAD:04B9                 </span><span style="color:navy">add     ax, ax
</span><span style="color:black">MSLOAD:04BB                 </span><span style="color:navy">adc     di, di          </span>; Get the FAT offset (di:si)
<span style="color:black">MSLOAD:04BD                 </span><span style="color:navy">mov     si, ax
</span><span style="color:black">MSLOAD:04BF                 </span><span style="color:navy">call    </span>GetFatSector
<span style="color:black">MSLOAD:04C2                 </span><span style="color:navy">mov     ax, es:[bx]
</span><span style="color:black">MSLOAD:04C5                 </span><span style="color:navy">mov     di, es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">MSLOAD:04C9                 </span><span style="color:navy">cmp     di, </span><span style="color:#ff8000">0FFFh       </span>; FAT32 cluster numbers are 28 bit numbers
<span style="color:black">MSLOAD:04C9                                         </span>; (higher 4 bits are -must be- zero)
<span style="color:black">MSLOAD:04CD                 </span><span style="color:navy">jnz     short </span>GotFAT32ClusterDone
<span style="color:black">MSLOAD:04CF                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFF8h
</span><span style="color:black">MSLOAD:04D2
MSLOAD:04D2 </span>GotFAT32ClusterDone<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:04D2                 </span><span style="color:navy">jmp     short </span>GotClusterDoneJ
<span style="color:black">MSLOAD:04D4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:04D4
MSLOAD:04D4 </span>chk_fat_type<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:04D4                 </span><span style="color:navy">cmp     ds:</span>FatType<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">MSLOAD:04D9                 </span><span style="color:navy">jnz     short </span>Got16Bit
<span style="color:black">MSLOAD:04DB
MSLOAD:04DB </span>Got12Bit<span style="color:navy">:
</span><span style="color:black">MSLOAD:04DB                 </span><span style="color:navy">mov     si, ax
</span><span style="color:black">MSLOAD:04DD                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">MSLOAD:04DF                 </span><span style="color:navy">shr     dx, </span><span style="color:green">1
</span><span style="color:black">MSLOAD:04E1                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">MSLOAD:04E3                 </span><span style="color:navy">add     si, ax
</span><span style="color:black">MSLOAD:04E5                 </span><span style="color:navy">adc     di, dx          </span>; di:si = dx:ax * 1.5 = dx:ax + dx:ax/2
<span style="color:black">MSLOAD:04E7                 </span><span style="color:navy">push    dx
</span><span style="color:black">MSLOAD:04E8                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">MSLOAD:04EA                 </span><span style="color:navy">call    </span>GetFatSector
<span style="color:black">MSLOAD:04ED                 </span><span style="color:navy">pop     dx
</span><span style="color:black">MSLOAD:04EE                 </span><span style="color:navy">jnz     short </span>ClusterOk
<span style="color:black">MSLOAD:04F0                 </span><span style="color:navy">mov     al, es:[bx]     </span>; Spitted cluster number,
<span style="color:black">MSLOAD:04F0                                         </span>;  read next FAT sector
<span style="color:black">MSLOAD:04F3                 </span><span style="color:navy">mov     byte ptr ds:</span>TempCluster<span style="color:navy">, al
</span><span style="color:black">MSLOAD:04F6                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">1
</span><span style="color:black">MSLOAD:04F9                 </span><span style="color:navy">adc     di, </span><span style="color:#ff8000">0
</span><span style="color:black">MSLOAD:04FC                 </span><span style="color:navy">push    dx
</span><span style="color:black">MSLOAD:04FD                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">MSLOAD:04FF                 </span><span style="color:navy">call    </span>GetFatSector    ; Read next fat sector
<span style="color:black">MSLOAD:0502                 </span><span style="color:navy">pop     dx
</span><span style="color:black">MSLOAD:0503                 </span><span style="color:navy">mov     al, </span>byte ptr es:0
<span style="color:black">MSLOAD:0507                 </span><span style="color:navy">mov     byte ptr ds:</span>TempCluster<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, al
</span><span style="color:black">MSLOAD:050A                 </span><span style="color:navy">mov     ax, ds:</span>TempCluster
<span style="color:black">MSLOAD:050D                 </span><span style="color:navy">jmp     short </span>EvenOdd
<span style="color:black">MSLOAD:050F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:050F
MSLOAD:050F </span>ClusterOk<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:050F                 </span><span style="color:navy">mov     ax, es:[bx]
</span><span style="color:black">MSLOAD:0512
MSLOAD:0512 </span>EvenOdd<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:0512                 </span><span style="color:navy">test    cs:</span>CurrentClusterL<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">MSLOAD:0519                 </span><span style="color:navy">jnz     short </span>OddResult
<span style="color:black">MSLOAD:051B                 </span><span style="color:navy">and     ax, </span><span style="color:green">0FFFh
</span><span style="color:black">MSLOAD:051E                 </span><span style="color:navy">jmp     short </span>TestEOF
<span style="color:black">MSLOAD:0520 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:0520
MSLOAD:0520 </span>OddResult<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:0520                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">MSLOAD:0522                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:black">MSLOAD:0524
MSLOAD:0524 </span>TestEOF<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:0524                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">MSLOAD:0526                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FF8h
</span><span style="color:black">MSLOAD:0529                 </span><span style="color:navy">jnb     short </span>GotClusterDone
<span style="color:black">MSLOAD:052B                 </span><span style="color:navy">jmp     short </span>NotLastCluster
<span style="color:black">MSLOAD:052D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">MSLOAD:052D
MSLOAD:052D </span>Got16Bit<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:052D                 </span><span style="color:navy">push    dx
</span><span style="color:black">MSLOAD:052E                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">MSLOAD:0530                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1           </span>; Multiply cluster by 2
<span style="color:black">MSLOAD:0532                 </span><span style="color:navy">adc     di, di
</span><span style="color:black">MSLOAD:0534                 </span><span style="color:navy">mov     si, ax          </span>; Get the FAT offset (di:si)
<span style="color:black">MSLOAD:0536                 </span><span style="color:navy">call    </span>GetFatSector
<span style="color:black">MSLOAD:0539                 </span><span style="color:navy">pop     dx
</span><span style="color:black">MSLOAD:053A                 </span><span style="color:navy">xor     di, di          </span>; HW of cluster number is 0
<span style="color:black">MSLOAD:053C                 </span><span style="color:navy">mov     ax, es:[bx]
</span><span style="color:black">MSLOAD:053F                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFF8h
</span><span style="color:black">MSLOAD:0542
MSLOAD:0542 </span>GotClusterDoneJ<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:0542                 </span><span style="color:navy">jnb     short </span>GotClusterDone
<span style="color:black">MSLOAD:0544
MSLOAD:0544 </span>NotLastCluster<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:0544                 </span><span style="color:navy">mov     cs:</span>EndOfFile<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; NOT END_OF_FILE ; Assume not last cluster
<span style="color:black">MSLOAD:054A
MSLOAD:054A </span>GotClusterDone<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:054A                 </span><span style="color:navy">pop     es
</span><span style="color:black">MSLOAD:054B                 </span><span style="color:navy">retn
</span><span style="color:black">MSLOAD:054B </span>GetNextFatEntry <span style="color:black">endp
MSLOAD:054B
MSLOAD:054C
MSLOAD:054C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">MSLOAD:054C
MSLOAD:054C
MSLOAD:054C </span>GetFatSector    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:054C                 </span><span style="color:navy">push    ax              </span>; di:si = byte offset in (entire) FAT
<span style="color:black">MSLOAD:054D                 </span><span style="color:navy">push    si
</span><span style="color:black">MSLOAD:054E                 </span><span style="color:navy">push    di
</span><span style="color:black">MSLOAD:054F                 </span><span style="color:navy">mov     ax, di          </span>; 32 bit division (dx:ax/512)
<span style="color:black">MSLOAD:0551                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">MSLOAD:0553                 </span><span style="color:navy">mov     cx, ds:</span>BytesPerSec
<span style="color:black">MSLOAD:0557                 </span><span style="color:navy">div     cx
</span><span style="color:black">MSLOAD:0559                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">MSLOAD:055B                 </span><span style="color:navy">mov     ax, si
</span><span style="color:black">MSLOAD:055D                 </span><span style="color:navy">mov     cx, ds:</span>BytesPerSec
<span style="color:black">MSLOAD:0561                 </span><span style="color:navy">div     cx              </span>; dx = byte offset in the FAT sector
<span style="color:black">MSLOAD:0563                 </span><span style="color:navy">cmp     bx, ds:</span>LastFatSectorH ; FAT32 (32 bit cluster numbers)
<span style="color:black">MSLOAD:0567                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_same_fat_sector
</span><span style="color:black">MSLOAD:0569                 </span><span style="color:navy">cmp     ax, ds:</span>LastFatSectorL ; The same fat sector?
<span style="color:black">MSLOAD:056D
MSLOAD:056D </span><span style="color:gray">not_same_fat_sector</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:056D                 </span><span style="color:navy">jz      short </span><span style="color:gray">SplitChk  </span>; Don&#039;t need to read it again.
<span style="color:black">MSLOAD:056F                 </span><span style="color:navy">mov     ds:</span>LastFatSectorL<span style="color:navy">, ax
</span><span style="color:black">MSLOAD:0572                 </span><span style="color:navy">mov     ds:</span>LastFatSectorH<span style="color:navy">, bx
</span><span style="color:black">MSLOAD:0576                 </span><span style="color:navy">push    dx
</span><span style="color:black">MSLOAD:0577                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">MSLOAD:0579                 </span><span style="color:navy">add     ax, ds:</span>HiddenSectorsL
<span style="color:black">MSLOAD:057D                 </span><span style="color:navy">adc     dx, ds:</span>HiddenSectorsH
<span style="color:black">MSLOAD:0581                 </span><span style="color:navy">add     ax, ds:</span>ReservSectors
<span style="color:black">MSLOAD:0585                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">MSLOAD:0588                 </span><span style="color:navy">mov     ds:</span>StartSecL<span style="color:navy">, ax
</span><span style="color:black">MSLOAD:058B                 </span><span style="color:navy">mov     ds:</span>StartSecH<span style="color:navy">, dx
</span><span style="color:black">MSLOAD:058F                 </span><span style="color:navy">mov     ds:</span>SectorCount<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">MSLOAD:0595                 </span><span style="color:navy">xor     di, di          </span>; buffer address: es:0
<span style="color:black">MSLOAD:0597                 </span><span style="color:navy">call    </span>ReadSectors
<span style="color:black">MSLOAD:059A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">MSLOAD:059B                 </span><span style="color:navy">mov     cx, ds:</span>BytesPerSec
<span style="color:black">MSLOAD:059F
MSLOAD:059F </span><span style="color:gray">SplitChk</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">MSLOAD:059F                 </span><span style="color:navy">dec     cx              </span>; cx = sector size - 1  (= 511)
<span style="color:black">MSLOAD:05A0                 </span><span style="color:navy">cmp     dx, cx          </span>; If last byte of sector, splitted entry.
<span style="color:black">MSLOAD:05A2                 </span><span style="color:navy">mov     bx, dx          </span>; set bx to dx
<span style="color:black">MSLOAD:05A4                 </span><span style="color:navy">pop     di
</span><span style="color:black">MSLOAD:05A5                 </span><span style="color:navy">pop     si
</span><span style="color:black">MSLOAD:05A6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">MSLOAD:05A7                 </span><span style="color:navy">retn                    </span>; If zf = 1, it is splitted
<span style="color:black">MSLOAD:05A7 </span>GetFatSector    <span style="color:black">endp                    </span>;  (next FAT12 sector will be read)
<span style="color:black">MSLOAD:05A7
MSLOAD:05A7 </span><span style="color:gray">; ---------------------------------------------------------------------------
MSLOAD:05A8 </span>NonSystemDiskMsg <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">MSLOAD:05A8                 </span><span style="color:navy">db &#039;Non-System disk or disk error&#039;,0Dh,0Ah </span>; EndOfLoader (MSLOAD:05F0h)
<span style="color:gray">MSLOAD:05A8                 </span><span style="color:navy">db &#039;Replace and press any key when ready&#039;,0Dh,0Ah,0
</span><span style="color:gray">MSLOAD:05A8 </span>MSLOAD          ends
<span style="color:gray">MSLOAD:05A8
</span><span style="color:maroon">BIOSDATA:0000 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0000 </span><span style="color:gray">; ===========================================================================
</span><span style="color:maroon">BIOSDATA:0000
BIOSDATA:0000 </span><span style="color:gray">; Segment type: Regular
</span><span style="color:maroon">BIOSDATA:0000 </span>BIOSDATA        segment byte public &#039;BIOSDATA&#039; use16
<span style="color:maroon">BIOSDATA:0000                 </span>assume cs:BIOSDATA
<span style="color:maroon">BIOSDATA:0000                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:maroon">BIOSDATA:0000
BIOSDATA:0000 </span>hdrv_pat<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:0000                 </span><span style="color:navy">jmp     </span>init            ; BData_start
<span style="color:maroon">BIOSDATA:0000 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0003 </span>DosDataSg       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0005 </span>bios_i2f        <span style="color:navy">db </span><span style="color:#008040">0EAh                 </span>; far jump to int_2f
<span style="color:gray">BIOSDATA:0006                 </span><span style="color:navy">dw offset </span>i2f_handler
<span style="color:gray">BIOSDATA:0008 </span>bios_i2f_seg    <span style="color:navy">dw </span><span style="color:#008040">364h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0008                                         </span>; IOSYSCODESEG (IBMBIO.COM code segment)
<span style="color:gray">BIOSDATA:0008                                         </span>; BIOSCODE (2F4h+070h) segment
<span style="color:gray">BIOSDATA:000A </span>romstartaddr    <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:000C </span>altah           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:000D </span>inHMA           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:000E </span>xms             <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0012 </span>ptrsav          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0016 </span>auxbuf          <span style="color:navy">db </span><span style="color:#008040">4 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:001A </span>zeroseg         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:001C </span>i13_ds          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:001E </span>prevoper        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0020 </span>number_of_sec   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0021 </span>auxnum          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0023 </span>res_dev_list    <span style="color:navy">dw offset </span>auxdev2       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0023                                         </span>; CONHeader
<span style="color:gray">BIOSDATA:0023                                         </span>; HEADER FOR DEVICE &quot;CON&quot;
<span style="color:gray">BIOSDATA:0025                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:0027                 </span><span style="color:navy">dw </span><span style="color:#008040">8013h
</span><span style="color:gray">BIOSDATA:0029                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:002B                 </span><span style="color:navy">dw offset </span>con_entry
<span style="color:gray">BIOSDATA:002D                 </span><span style="color:navy">db &#039;CON     &#039;
</span><span style="color:gray">BIOSDATA:0035 </span>auxdev2         <span style="color:navy">dw offset </span>prndev2       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0035                                         </span>; HEADER FOR DEVICE &quot;AUX&quot;
<span style="color:gray">BIOSDATA:0037                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:0039                 </span><span style="color:navy">dw </span><span style="color:#008040">8000h
</span><span style="color:gray">BIOSDATA:003B </span><span style="color:navy">off_62B         dw offset </span>strategy
<span style="color:gray">BIOSDATA:003D                 </span><span style="color:navy">dw offset </span>aux0_entry
<span style="color:gray">BIOSDATA:003F </span><span style="color:navy">asc_62F         db &#039;AUX     &#039;
</span><span style="color:gray">BIOSDATA:0047 </span>prndev2         <span style="color:navy">dw offset </span>timdev        <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0047                                         </span>; HEADER FOR DEVICE &quot;PRN&quot;
<span style="color:gray">BIOSDATA:0049                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:004B                 </span><span style="color:navy">dw </span><span style="color:#008040">0A0C0h
</span><span style="color:gray">BIOSDATA:004D                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:004F                 </span><span style="color:navy">dw offset </span>prn0_entry
<span style="color:gray">BIOSDATA:0051                 </span><span style="color:navy">db &#039;PRN     &#039;
</span><span style="color:gray">BIOSDATA:0059 </span>timdev          <span style="color:navy">dw offset </span>dskdev        <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0059                                         </span>; HEADER FOR DEVICE &quot;CLOCK$&quot;
<span style="color:gray">BIOSDATA:005B                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:005D                 </span><span style="color:navy">dw </span><span style="color:#008040">8008h
</span><span style="color:gray">BIOSDATA:005F                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:0061                 </span><span style="color:navy">dw offset </span>tim_entry
<span style="color:gray">BIOSDATA:0063                 </span><span style="color:navy">db &#039;CLOCK$  &#039;
</span><span style="color:gray">BIOSDATA:006B </span>dskdev          <span style="color:navy">dw offset </span>com1dev       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:006B                                         </span>; HEADER FOR DISK DEVICES
<span style="color:gray">BIOSDATA:006D                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:006F                 </span><span style="color:navy">dw </span><span style="color:#008040">48C2h
</span><span style="color:gray">BIOSDATA:0071                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:0073                 </span><span style="color:navy">dw offset </span>dsk_entry
<span style="color:gray">BIOSDATA:0075 </span>drvmax          <span style="color:navy">db </span><span style="color:#008040">4                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0075                                         </span>; maximum number of drives
<span style="color:gray">BIOSDATA:0076 </span>step_drv        <span style="color:navy">db </span><span style="color:#008040">0FEh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0076                                         </span>; -2 ; last drive accessed
<span style="color:gray">BIOSDATA:0077 </span>fhave96         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0077                                         </span>; 96tpi support
<span style="color:gray">BIOSDATA:0078 </span>single          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0078                                         </span>; used to detect single drive systems
<span style="color:gray">BIOSDATA:0079 </span>fhavek09        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0079                                         </span>; indicates if this is a k09 or not
<span style="color:gray">BIOSDATA:0079                                         </span>; used by console driver.
<span style="color:gray">BIOSDATA:007A </span>fsetowner       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:007A                                         </span>; = 1 if we are setting the owner of a drive.
<span style="color:gray">BIOSDATA:007A                                         </span>; (examined by checksingle)
<span style="color:gray">BIOSDATA:007B </span>com1dev         <span style="color:navy">dw offset </span>lpt1dev       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:007B                                         </span>; Device Header for device &quot;COM1&quot;
<span style="color:gray">BIOSDATA:007D                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:007F                 </span><span style="color:navy">dw </span><span style="color:#008040">8000h
</span><span style="color:gray">BIOSDATA:0081                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:0083                 </span><span style="color:navy">dw offset </span>aux0_entry
<span style="color:gray">BIOSDATA:0085                 </span><span style="color:navy">db &#039;COM1    &#039;
</span><span style="color:gray">BIOSDATA:008D </span>lpt1dev         <span style="color:navy">dw offset </span>lpt2dev       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:008D                                         </span>; Device Header for device LPT1
<span style="color:gray">BIOSDATA:008F                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:0091                 </span><span style="color:navy">dw </span><span style="color:#008040">0A0C0h
</span><span style="color:gray">BIOSDATA:0093                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:0095                 </span><span style="color:navy">dw offset </span>prn1_entry
<span style="color:gray">BIOSDATA:0097                 </span><span style="color:navy">db &#039;LPT1    &#039;
</span><span style="color:gray">BIOSDATA:009F </span>lpt2dev         <span style="color:navy">dw offset </span>lpt3dev       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:009F                                         </span>; Device Header for device LPT2
<span style="color:gray">BIOSDATA:00A1                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:00A3                 </span><span style="color:navy">dw </span><span style="color:#008040">0A0C0h
</span><span style="color:gray">BIOSDATA:00A5                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:00A7                 </span><span style="color:navy">dw offset </span>prn2_entry
<span style="color:gray">BIOSDATA:00A9                 </span><span style="color:navy">db &#039;LPT2    &#039;
</span><span style="color:gray">BIOSDATA:00B1                 </span><span style="color:navy">db </span><span style="color:#008040">3 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:00B4 </span>Orig13          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:00B4                                         </span>; to make Orig13 offset 0B4h
<span style="color:gray">BIOSDATA:00B8 </span>lpt3dev         <span style="color:navy">dw offset </span>com2dev       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:00B8                                         </span>; Device Header for device LPT3
<span style="color:gray">BIOSDATA:00BA                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:00BC                 </span><span style="color:navy">dw </span><span style="color:#008040">0A0C0h
</span><span style="color:gray">BIOSDATA:00BE                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:00C0                 </span><span style="color:navy">dw offset </span>prn3_entry
<span style="color:gray">BIOSDATA:00C2                 </span><span style="color:navy">db &#039;LPT3    &#039;
</span><span style="color:gray">BIOSDATA:00CA </span>com2dev         <span style="color:navy">dw offset </span>com3dev       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:00CA                                         </span>; Device Header for device &quot;COM2&quot;
<span style="color:gray">BIOSDATA:00CC                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:00CE                 </span><span style="color:navy">dw </span><span style="color:#008040">8000h
</span><span style="color:gray">BIOSDATA:00D0                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:00D2                 </span><span style="color:navy">dw offset </span>aux1_entry
<span style="color:gray">BIOSDATA:00D4                 </span><span style="color:navy">db &#039;COM2    &#039;
</span><span style="color:gray">BIOSDATA:00DC </span>com3dev         <span style="color:navy">dw offset </span>com4dev       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:00DC                                         </span>; Device Header for device &quot;COM3&quot;
<span style="color:gray">BIOSDATA:00DE                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:00E0                 </span><span style="color:navy">dw </span><span style="color:#008040">8000h
</span><span style="color:gray">BIOSDATA:00E2                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:00E4                 </span><span style="color:navy">dw offset </span>aux2_entry
<span style="color:gray">BIOSDATA:00E6                 </span><span style="color:navy">db &#039;COM3    &#039;
</span><span style="color:gray">BIOSDATA:00EE </span>com4dev         <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:00EE                                         </span>; Device Header for device &quot;COM4&quot;
<span style="color:gray">BIOSDATA:00F0                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:00F2                 </span><span style="color:navy">dw </span><span style="color:#008040">8000h
</span><span style="color:gray">BIOSDATA:00F4                 </span><span style="color:navy">dw offset </span>strategy
<span style="color:gray">BIOSDATA:00F6                 </span><span style="color:navy">dw offset </span>aux3_entry
<span style="color:gray">BIOSDATA:00F8                 </span><span style="color:navy">db &#039;COM4    &#039;
</span><span style="color:gray">BIOSDATA:0100 </span>RomVectors      <span style="color:navy">db </span><span style="color:#008040">10h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0101 </span>Old10           <span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0105                 </span><span style="color:navy">db </span><span style="color:#008040">13h
</span><span style="color:gray">BIOSDATA:0106 </span>Old13           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:010A                 </span><span style="color:navy">db </span><span style="color:#008040">15h
</span><span style="color:gray">BIOSDATA:010B </span>Old15           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:010F                 </span><span style="color:navy">db </span><span style="color:#008040">19h
</span><span style="color:gray">BIOSDATA:0110 </span>Old19           <span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0114                 </span><span style="color:navy">db </span><span style="color:#008040">1Bh
</span><span style="color:gray">BIOSDATA:0115 </span>Old1B           <span style="color:navy">dd </span><span style="color:#008040">0                    </span>; ;
<span style="color:gray">BIOSDATA:0115                                         </span>; EndRomVectors equ $
<span style="color:gray">BIOSDATA:0115                                         </span>; NUMROMVECTORS equ ((EndRomVectors - RomVectors)/5)
<span style="color:gray">BIOSDATA:0115                                         </span>; ;
<span style="color:gray">BIOSDATA:0119 </span>start_bds       <span style="color:navy">dw offset </span>bds1          <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0119                                         </span>; Start of linked list of BDS&#039;s
<span style="color:gray">BIOSDATA:011B                 </span><span style="color:navy">dw </span><span style="color:#008040">70h                  </span>; BIOSDATA segment
<span style="color:gray">BIOSDATA:011D </span>accesscount     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:011E </span>tim_drv         <span style="color:navy">db </span><span style="color:#008040">0FFh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:011F </span>medbyt          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0120 </span>rflag           <span style="color:navy">db </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0120                                         </span>; 2 for read, 3 for write
<span style="color:gray">BIOSDATA:0121 </span>verify          <span style="color:navy">db </span><span style="color:#008040">0                    </span>; 1 if verify after write
<span style="color:gray">BIOSDATA:0122 </span>seccnt          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0124                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; -- pad where hardnum was
<span style="color:gray">BIOSDATA:0125 </span>dsktnum         <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0125                                         </span>; number of diskette drives
<span style="color:gray">BIOSDATA:0126 </span>motorstartup    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0126                                         </span>; value from table
<span style="color:gray">BIOSDATA:0127 </span>settlecurrent   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0127                                         </span>; value from table
<span style="color:gray">BIOSDATA:0128 </span>settleslow      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0128                                         </span>; slow settle value
<span style="color:gray">BIOSDATA:0129 </span>nextspeed       <span style="color:navy">db </span><span style="color:#008040">0                    </span>; value of speed to be used
<span style="color:gray">BIOSDATA:012A </span>save_head_sttl  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:012A                                         </span>; used by read_sector routine
<span style="color:gray">BIOSDATA:012B </span>save_eot        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:012B                                         </span>; saved eot from the default DPT
<span style="color:gray">BIOSDATA:012C </span>eot             <span style="color:navy">db </span><span style="color:#008040">9                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:012D </span>dpt             <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:012D                                         </span>; pointer to Disk Parameter Table
<span style="color:gray">BIOSDATA:0131 </span>cursec          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0131                                         </span>; current sector
<span style="color:gray">BIOSDATA:0132 </span>curhd           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0132                                         </span>; current head
<span style="color:gray">BIOSDATA:0133 </span>curtrk          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0133                                         </span>; current track
<span style="color:gray">BIOSDATA:0135 </span>spsav           <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0135                                         </span>; save the stack pointer
<span style="color:gray">BIOSDATA:0137 </span>formt_eot       <span style="color:navy">db </span><span style="color:#008040">8                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0137                                         </span>; eot used for format
<span style="color:gray">BIOSDATA:0138 </span>hdnum           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0138                                         </span>; head number
<span style="color:gray">BIOSDATA:0139 </span>trknum          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0139                                         </span>; track being manipulated
<span style="color:gray">BIOSDATA:013B </span>gap_patch       <span style="color:navy">db </span><span style="color:#008040">50h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:013B                                         </span>; format gap patched into dpt
<span style="color:gray">BIOSDATA:013C </span>errin           <span style="color:navy">db </span><span style="color:#008040">0CCh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:013C                                         </span>; write fault (hard disk)
<span style="color:gray">BIOSDATA:013D                 </span><span style="color:navy">db </span><span style="color:#008040">80h                  </span>; timeout (not ready)
<span style="color:gray">BIOSDATA:013E                 </span><span style="color:navy">db </span><span style="color:#008040">40h                  </span>; seek failed
<span style="color:gray">BIOSDATA:013F                 </span><span style="color:navy">db </span><span style="color:#008040">10h                  </span>; uncorrectable CRC or ECC error on read
<span style="color:gray">BIOSDATA:0140                 </span><span style="color:navy">db </span><span style="color:#008040">8                    </span>; DMA overrun
<span style="color:gray">BIOSDATA:0141                 </span><span style="color:navy">db </span><span style="color:#008040">6                    </span>; disk changed (floppy)
<span style="color:gray">BIOSDATA:0142                 </span><span style="color:navy">db </span><span style="color:#008040">4                    </span>; sector not found/read error
<span style="color:gray">BIOSDATA:0143                 </span><span style="color:navy">db </span><span style="color:#008040">3                    </span>; disk write-protected
<span style="color:gray">BIOSDATA:0144                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; invalid function in AH or invalid parameter
<span style="color:gray">BIOSDATA:0145                 </span><span style="color:navy">db </span><span style="color:#008040">0B2h                 </span>; volume not removable
<span style="color:gray">BIOSDATA:0146 </span>lsterr          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0147 </span>errout          <span style="color:navy">db </span><span style="color:#008040">10                   </span>; write fault error
<span style="color:gray">BIOSDATA:0148                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; no response (timeout)
<span style="color:gray">BIOSDATA:0149                 </span><span style="color:navy">db </span><span style="color:#008040">6                    </span>; seek failure
<span style="color:gray">BIOSDATA:014A                 </span><span style="color:navy">db </span><span style="color:#008040">4                    </span>; bad crc
<span style="color:gray">BIOSDATA:014B                 </span><span style="color:navy">db </span><span style="color:#008040">4                    </span>; dma overrun
<span style="color:gray">BIOSDATA:014C                 </span><span style="color:navy">db </span><span style="color:#008040">15                   </span>; invalid media change
<span style="color:gray">BIOSDATA:014D                 </span><span style="color:navy">db </span><span style="color:#008040">8                    </span>; sector not found
<span style="color:gray">BIOSDATA:014E                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; write attempt to write-protect disk
<span style="color:gray">BIOSDATA:014F                 </span><span style="color:navy">db </span><span style="color:#008040">3                    </span>; unknown command error
<span style="color:gray">BIOSDATA:0150                 </span><span style="color:navy">db </span><span style="color:#008040">3                    </span>; unknown command error
<span style="color:gray">BIOSDATA:0151                 </span><span style="color:navy">db </span><span style="color:#008040">12                   </span>; general error
<span style="color:gray">BIOSDATA:0152 </span>disksector      <span style="color:navy">db </span><span style="color:#008040">174 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0152                                         </span>; 512 byte buffer
<span style="color:maroon">BIOSDATA:0200 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0200
BIOSDATA:0200 </span>JB_sign<span style="color:navy">:                                </span>; &#039;BJ&#039; (nasm) ; dw 424Ah
<span style="color:maroon">BIOSDATA:0200                 </span><span style="color:navy">dec     dx
</span><span style="color:maroon">BIOSDATA:0201                 </span><span style="color:navy">inc     dx
</span><span style="color:maroon">BIOSDATA:0202                 </span><span style="color:navy">jmp     </span>hdrv_pat        ; jmp BData_start
<span style="color:maroon">BIOSDATA:0202 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0205 </span>IBMBIOCOM$      <span style="color:navy">db &#039;@#IBM:12.01.2003.build_1.32#@ IBMBIO.COM(USA)&#039;,0
</span><span style="color:gray">BIOSDATA:0233                 </span><span style="color:navy">db </span><span style="color:#008040">287 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:0352 </span>bds1            <span style="color:navy">dw offset </span>bds2          <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0352                                         </span>; dword link to next structure
<span style="color:gray">BIOSDATA:0354                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:0356                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; int 13h drive number
<span style="color:gray">BIOSDATA:0357                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; logical drive letter
<span style="color:gray">BIOSDATA:0358 </span>fdrive1         <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0358                                         </span>; physical sector size in bytes
<span style="color:gray">BIOSDATA:035A                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh                 </span>; sectors/allocation unit
<span style="color:gray">BIOSDATA:035B                 </span><span style="color:navy">dw </span><span style="color:#008040">1                    </span>; reserved sectors for dos
<span style="color:gray">BIOSDATA:035D                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; no of file allocation tables
<span style="color:gray">BIOSDATA:035E                 </span><span style="color:navy">dw </span><span style="color:#008040">64                   </span>; number of root directory entries
<span style="color:gray">BIOSDATA:0360                 </span><span style="color:navy">dw </span><span style="color:#008040">360                  </span>; number of sectors (at 512 bytes each)
<span style="color:gray">BIOSDATA:0362                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; media descriptor, initially 0
<span style="color:gray">BIOSDATA:0363                 </span><span style="color:navy">dw </span><span style="color:#008040">2                    </span>; number of fat sectors
<span style="color:gray">BIOSDATA:0365                 </span><span style="color:navy">dw </span><span style="color:#008040">9                    </span>; sector limit (sectors per track)
<span style="color:gray">BIOSDATA:0367                 </span><span style="color:navy">dw </span><span style="color:#008040">1                    </span>; head limit (number of heads - 1)
<span style="color:gray">BIOSDATA:0369                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; hidden sector count
<span style="color:gray">BIOSDATA:036D                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; number of sectors (32 bit)
<span style="color:gray">BIOSDATA:0371                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; BPB_FATSz32 ; FAT32 FAT size in sectors ; 4 bytes
<span style="color:gray">BIOSDATA:0371                                         </span>;   BS_DrvNum ; FAT INT 13h drive number ; 1 byte
<span style="color:gray">BIOSDATA:0371                                         </span>;   BS_Reserved1 ; FAT reserved byte = 0 ; 1 byte
<span style="color:gray">BIOSDATA:0371                                         </span>;   BS_BootSig ; FAT Extended boot signature = 29h ; 1 byte
<span style="color:gray">BIOSDATA:0371                                         </span>;   BS_VolID ; FAT Volume serial number ; 4 bytes
<span style="color:gray">BIOSDATA:0375                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; BPB_ExtFlags ; FAT32 Extended Flags
<span style="color:gray">BIOSDATA:0377                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; BPB_FSVer ; FAT32 fs/volume version
<span style="color:gray">BIOSDATA:0379                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; BPB_RootClus ; FAT32 root directory&#039;s first cluster number
<span style="color:gray">BIOSDATA:037D                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; BPB_FSInfo ; FAT32 FSINFO sector number = -1 (initial)
<span style="color:gray">BIOSDATA:037F                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; BPB_BkBootSec ; FAT32 backup boot sector number = -1 (initial)
<span style="color:gray">BIOSDATA:0381                 </span><span style="color:navy">db </span><span style="color:#008040">12 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span>; BPB_Reserved  ; FAT32 reserved field = 0, 12 bytes
<span style="color:gray">BIOSDATA:038D                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; true =&gt; large fats
<span style="color:gray">BIOSDATA:038E                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; open ref. count
<span style="color:gray">BIOSDATA:0390                 </span><span style="color:navy">db </span><span style="color:#008040">3                    </span>; form factor
<span style="color:gray">BIOSDATA:0391                 </span><span style="color:navy">dw </span><span style="color:#008040">20h                  </span>; various flags
<span style="color:gray">BIOSDATA:0393                 </span><span style="color:navy">dw </span><span style="color:#008040">40                   </span>; number of cylinders
<span style="color:gray">BIOSDATA:0395 </span>recommended_bps <span style="color:navy">dw </span><span style="color:#008040">512                  </span>; recommended bps for this drive
<span style="color:gray">BIOSDATA:0395                                         </span>; recbpb1
<span style="color:gray">BIOSDATA:0397                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:0398                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:039A                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:039B                 </span><span style="color:navy">dw </span><span style="color:#008040">224                  </span>; number of root directory entries
<span style="color:gray">BIOSDATA:039D                 </span><span style="color:navy">dw </span><span style="color:#008040">360
</span><span style="color:gray">BIOSDATA:039F                 </span><span style="color:navy">db </span><span style="color:#008040">0F0h                 </span>; media descriptor, initially 0F0h
<span style="color:gray">BIOSDATA:03A0                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:03A2                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">BIOSDATA:03A4                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:03A6                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03AA                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03AE                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03B2                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03B6                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03BA                 </span><span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh
</span><span style="color:gray">BIOSDATA:03BE                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03C2                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03C6                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:olive">BIOSDATA:03CA                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh                 </span>; last track accessed on this drive
<span style="color:gray">BIOSDATA:03CB                 </span><span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span>; keep these two contiguous (?)
<span style="color:gray">BIOSDATA:03CF                 </span><span style="color:navy">db &#039;NO NAME    &#039;,0      </span>; volume id for this disk
<span style="color:gray">BIOSDATA:03DB                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; current volume serial from boot record
<span style="color:gray">BIOSDATA:03DF                 </span><span style="color:navy">db &#039;FAT12   &#039;,0         </span>; current file system id from boot record
<span style="color:gray">BIOSDATA:03E8 </span>bds2            <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:03EA                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:03EC                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03ED                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03EE </span>fdrive2         <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:olive">BIOSDATA:03F0                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh
</span><span style="color:gray">BIOSDATA:03F1                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:03F3                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:03F4                 </span><span style="color:navy">dw </span><span style="color:#008040">64
</span><span style="color:gray">BIOSDATA:03F6                 </span><span style="color:navy">dw </span><span style="color:#008040">360
</span><span style="color:gray">BIOSDATA:03F8                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:03F9                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:03FB                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">BIOSDATA:03FD                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:03FF                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0403                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0407                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:040B                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:040F                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0413                 </span><span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh
</span><span style="color:gray">BIOSDATA:0417                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:041B                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:041F                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0423                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0424                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0426                 </span><span style="color:navy">db </span><span style="color:#008040">3
</span><span style="color:gray">BIOSDATA:0427                 </span><span style="color:navy">dw </span><span style="color:#008040">20h
</span><span style="color:gray">BIOSDATA:0429                 </span><span style="color:navy">dw </span><span style="color:#008040">40
</span><span style="color:gray">BIOSDATA:042B </span>recbpb2         <span style="color:navy">dw </span><span style="color:#008040">512
</span><span style="color:gray">BIOSDATA:042D                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:042E                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:0430                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:0431                 </span><span style="color:navy">dw </span><span style="color:#008040">224
</span><span style="color:gray">BIOSDATA:0433                 </span><span style="color:navy">dw </span><span style="color:#008040">360
</span><span style="color:gray">BIOSDATA:0435                 </span><span style="color:navy">db </span><span style="color:#008040">0F0h
</span><span style="color:gray">BIOSDATA:0436                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:0438                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">BIOSDATA:043A                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:043C                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0440                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0444                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0448                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:044C                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0450                 </span><span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh
</span><span style="color:gray">BIOSDATA:0454                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0458                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:045C                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0460                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh
</span><span style="color:gray">BIOSDATA:0461                 </span><span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh
</span><span style="color:gray">BIOSDATA:0465                 </span><span style="color:navy">db &#039;NO NAME    &#039;,0
</span><span style="color:gray">BIOSDATA:0471                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0475                 </span><span style="color:navy">db &#039;FAT12   &#039;,0
</span><span style="color:gray">BIOSDATA:047E </span>keyrd_func      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:047F </span>keysts_func     <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0480 </span>printdev        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0480                                         </span>; printer device index
<span style="color:gray">BIOSDATA:0481 </span>wait_count      <span style="color:navy">dw </span><span style="color:#008040">50h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0481                                         </span>; retry counts for printers
<span style="color:gray">BIOSDATA:0483                 </span><span style="color:navy">dw </span><span style="color:#008040">50h
</span><span style="color:gray">BIOSDATA:0485                 </span><span style="color:navy">dw </span><span style="color:#008040">50h
</span><span style="color:gray">BIOSDATA:0487                 </span><span style="color:navy">dw </span><span style="color:#008040">50h
</span><span style="color:gray">BIOSDATA:0489 </span>daycnt          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0489                                         </span>; flag for updating daycnt
<span style="color:gray">BIOSDATA:048B </span>t_switch        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:048C </span>havecmoscloc    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:048D </span>base_century    <span style="color:navy">db </span><span style="color:#008040">19                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:048E </span>base_year       <span style="color:navy">db </span><span style="color:#008040">80                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:048F </span>month_table     <span style="color:navy">db </span><span style="color:#008040">31                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0490 </span>february        <span style="color:navy">db </span><span style="color:#008040">28                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0491                 </span><span style="color:navy">db </span><span style="color:#008040">31
</span><span style="color:gray">BIOSDATA:0492                 </span><span style="color:navy">db </span><span style="color:#008040">30
</span><span style="color:gray">BIOSDATA:0493                 </span><span style="color:navy">db </span><span style="color:#008040">31
</span><span style="color:gray">BIOSDATA:0494                 </span><span style="color:navy">db </span><span style="color:#008040">30
</span><span style="color:gray">BIOSDATA:0495                 </span><span style="color:navy">db </span><span style="color:#008040">31
</span><span style="color:gray">BIOSDATA:0496                 </span><span style="color:navy">db </span><span style="color:#008040">31
</span><span style="color:gray">BIOSDATA:0497                 </span><span style="color:navy">db </span><span style="color:#008040">30
</span><span style="color:gray">BIOSDATA:0498                 </span><span style="color:navy">db </span><span style="color:#008040">31
</span><span style="color:gray">BIOSDATA:0499                 </span><span style="color:navy">db </span><span style="color:#008040">30
</span><span style="color:gray">BIOSDATA:049A                 </span><span style="color:navy">db </span><span style="color:#008040">31
</span><span style="color:gray">BIOSDATA:049B </span>set_id_flag     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:049B                                         </span>; flag for getbp routine
<span style="color:gray">BIOSDATA:049C </span>start_sec_h     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:049C                                         </span>; starting sector number high word
<span style="color:gray">BIOSDATA:049E </span>saved_word      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:049E                                         </span>; tempory saving place for a word
<span style="color:gray">BIOSDATA:04A0 </span>multrk_flag     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04A2 </span>ec35_flag       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04A2                                         </span>; flags for 3.5 inch disk drives
<span style="color:gray">BIOSDATA:04A3 </span>vretry_cnt      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04A5 </span>soft_ecc_cnt    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04A7 </span>multitrk_format_flag <span style="color:navy">db </span><span style="color:#008040">0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04A7                                         </span>; multi track format request flag
<span style="color:gray">BIOSDATA:04A8 </span>xfer_seg        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04A8                                         </span>; temp for transfer segment
<span style="color:gray">BIOSDATA:04AA </span>sectorspertrack <span style="color:navy">dw </span><span style="color:#008040">36                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04AC </span>tracktable      <span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">2           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">7</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">8</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">9</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">10</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">11</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">12</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">13</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">14</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">15</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">16</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">17</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">18</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">19</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">20</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">21</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">22</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">23</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">24</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">25</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">26</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">27</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">29</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">30</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">31</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">32</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">33</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">34</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">35</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:04AC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">36</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:053C </span>dskdrvs         <span style="color:navy">dw offset </span>fdrive1       <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:053E                 </span><span style="color:navy">dw offset </span>fdrive2
<span style="color:gray">BIOSDATA:0540                 </span><span style="color:navy">dw </span><span style="color:#008040">52 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span>; times (((4*63)-144)-4) db 0
<span style="color:gray">BIOSDATA:0540                                         </span>; 4*max_sectors_curr_sup-($-tracktable)-4 dup (0)
<span style="color:gray">BIOSDATA:05A8 </span>mediatype       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05A9 </span>media_set_for_format <span style="color:navy">db </span><span style="color:#008040">0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05A9                                         </span>; 1 if we have done an int 13h set media
<span style="color:gray">BIOSDATA:05A9                                         </span>; type for format call
<span style="color:gray">BIOSDATA:05AA </span>had_format_error <span style="color:navy">db </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05AA                                         </span>; 1 if the previous format operation failed.
<span style="color:gray">BIOSDATA:05AB </span>tempdpt         <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05AB                                         </span>; -1 ; temp disk base table
<span style="color:gray">BIOSDATA:05AF </span>model_byte      <span style="color:navy">db </span><span style="color:#008040">0FFh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05AF                                         </span>; model byte set at init time
<span style="color:gray">BIOSDATA:05B0 </span>secondary_model_byte <span style="color:navy">db </span><span style="color:#008040">0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05B1 </span>int19sem        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05B1                                         </span>; indicate that all int 19h initialization is complete
<span style="color:gray">BIOSDATA:05B1                                         </span>;
<span style="color:gray">BIOSDATA:05B1                                         </span>; irp    aa,&lt;02,08,09,0a,0b,0c,0d,0e,70,72,73,74,76,77&gt;
<span style="color:gray">BIOSDATA:05B1                                         </span>; public int19old&amp;aa
<span style="color:gray">BIOSDATA:05B1                                         </span>; db     aa&amp;h       ; store the number as a byte
<span style="color:gray">BIOSDATA:05B1                                         </span>; int19old&amp;aa dd -1 ; original hardware int. vectors for int 19h.
<span style="color:gray">BIOSDATA:05B1                                         </span>; endm
<span style="color:gray">BIOSDATA:05B2 </span>i19_lst         <span style="color:navy">db </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05B3 </span>int19old02      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05B3                                         </span>; Int19old&amp;aa
<span style="color:gray">BIOSDATA:05B3                                         </span>; db aa&amp;h
<span style="color:gray">BIOSDATA:05B3                                         </span>; dd -1 ; original hardware int. vectors for int 19h
<span style="color:gray">BIOSDATA:05B7                 </span><span style="color:navy">db </span><span style="color:#008040">8
</span><span style="color:gray">BIOSDATA:05B8 </span>int19old08      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05BC                 </span><span style="color:navy">db </span><span style="color:#008040">9
</span><span style="color:gray">BIOSDATA:05BD </span>int19old09      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05C1                 </span><span style="color:navy">db </span><span style="color:#008040">0Ah
</span><span style="color:gray">BIOSDATA:05C2 </span>int19old0A      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05C6                 </span><span style="color:navy">db </span><span style="color:#008040">0Bh
</span><span style="color:gray">BIOSDATA:05C7 </span>int19old0B      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05CB                 </span><span style="color:navy">db </span><span style="color:#008040">0Ch
</span><span style="color:gray">BIOSDATA:05CC </span>int19old0C      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05D0                 </span><span style="color:navy">db </span><span style="color:#008040">0Dh
</span><span style="color:gray">BIOSDATA:05D1 </span>int19old0D      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05D5                 </span><span style="color:navy">db </span><span style="color:#008040">0Eh
</span><span style="color:gray">BIOSDATA:05D6 </span>int19old0E      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05DA                 </span><span style="color:navy">db </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:05DB </span>int19old70      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05DF                 </span><span style="color:navy">db </span><span style="color:#008040">72h
</span><span style="color:gray">BIOSDATA:05E0 </span>int19old72      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05E4                 </span><span style="color:navy">db </span><span style="color:#008040">73h
</span><span style="color:gray">BIOSDATA:05E5 </span>int19old73      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05E9                 </span><span style="color:navy">db </span><span style="color:#008040">74h
</span><span style="color:gray">BIOSDATA:05EA </span>int19old74      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05EE                 </span><span style="color:navy">db </span><span style="color:#008040">76h
</span><span style="color:gray">BIOSDATA:05EF </span>int19old76      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05F3                 </span><span style="color:navy">db </span><span style="color:#008040">77h
</span><span style="color:gray">BIOSDATA:05F4 </span>int19old77      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05F8 </span>int6c_ret_addr  <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:05FC </span>bin_date_time   <span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0600 </span>daycnt2         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0602 </span>cdev            <span style="color:navy">dw offset </span>chardev_entry <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0604 </span>cdev_2          <span style="color:navy">dw </span><span style="color:#008040">364h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0604                                         </span>; BIOSCODE segment = 364h (for PCDOS 7.1 IBMBIO.COM)
<span style="color:gray">BIOSDATA:0606 </span>ttticks         <span style="color:navy">dw offset </span>time_to_ticks <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0608                 </span><span style="color:navy">dw </span><span style="color:#008040">364h                 </span>; BIOSCODE segment (70h+2F4h)
<span style="color:gray">BIOSDATA:060A </span>i13x            <span style="color:navy">dw offset </span>i13z          <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:060C                 </span><span style="color:navy">dw </span><span style="color:#008040">364h                 </span>; BIOSCODE segment
<span style="color:maroon">BIOSDATA:060E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:060E
BIOSDATA:060E </span>cbreak<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:060E                 </span><span style="color:navy">mov     cs:</span>altah<span style="color:navy">, </span><span style="color:#ff8000">3     </span>; indicate break key set
<span style="color:maroon">BIOSDATA:0614
BIOSDATA:0614 </span>intret<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0614                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSDATA:0615 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0615
BIOSDATA:0615 </span>strategy<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0615                 </span><span style="color:navy">mov     word ptr cs:</span>ptrsav<span style="color:navy">, bx </span>; store es:bx (device driver request packet)
<span style="color:maroon">BIOSDATA:0615                                         </span>;      away at [ptrsav] for next driver function call
<span style="color:maroon">BIOSDATA:061A                 </span><span style="color:navy">mov     word ptr cs:</span>ptrsav<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">BIOSDATA:061F                 </span><span style="color:navy">retf
</span><span style="color:maroon">BIOSDATA:0620 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0620
BIOSDATA:0620 </span>con_entry<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0620                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:0620 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0623                 </span><span style="color:navy">dw offset </span>con_table
<span style="color:maroon">BIOSDATA:0625 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0625
BIOSDATA:0625 </span>prn0_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0625                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:0625 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0628                 </span><span style="color:navy">dw offset </span>prn_table
<span style="color:gray">BIOSDATA:062A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:maroon">BIOSDATA:062C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:062C
BIOSDATA:062C </span>prn1_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:062C                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:062C </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:062F                 </span><span style="color:navy">dw offset </span>prn_table
<span style="color:gray">BIOSDATA:0631                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:maroon">BIOSDATA:0633 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0633
BIOSDATA:0633 </span>prn2_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0633                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:0633 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0636                 </span><span style="color:navy">dw offset </span>prn_table     ; 364h:0FBh = BIOSCODE:0FBh = 70h:303Bh
<span style="color:gray">BIOSDATA:0638                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:maroon">BIOSDATA:063A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:063A
BIOSDATA:063A </span>prn3_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:063A                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:063A </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:063D                 </span><span style="color:navy">dw offset </span>prn_table
<span style="color:gray">BIOSDATA:063F                 </span><span style="color:navy">db </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">3
</span><span style="color:maroon">BIOSDATA:0641 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0641
BIOSDATA:0641 </span>aux0_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0641                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:0641 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0644                 </span><span style="color:navy">dw offset </span>aux_table
<span style="color:gray">BIOSDATA:0646                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">BIOSDATA:0647 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0647
BIOSDATA:0647 </span>aux1_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0647                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:0647 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:064A                 </span><span style="color:navy">dw offset </span>aux_table     ; 364h:130h = BIOSCODE:130h = 70h:3070h
<span style="color:gray">BIOSDATA:064C                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:maroon">BIOSDATA:064D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:064D
BIOSDATA:064D </span>aux2_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:064D                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:064D </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0650                 </span><span style="color:navy">dw offset </span>aux_table
<span style="color:gray">BIOSDATA:0652                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:maroon">BIOSDATA:0653 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0653
BIOSDATA:0653 </span>aux3_entry<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0653                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:0653 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0656                 </span><span style="color:navy">dw offset </span>aux_table
<span style="color:gray">BIOSDATA:0658                 </span><span style="color:navy">db </span><span style="color:#008040">3
</span><span style="color:maroon">BIOSDATA:0659 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0659
BIOSDATA:0659 </span>tim_entry<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0659                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:0659 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:065C                 </span><span style="color:navy">dw offset </span>tim_table     ; 364h:147h ; BIOSCODE:147h ; 70h:3087h
<span style="color:maroon">BIOSDATA:065E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:065E
BIOSDATA:065E </span>dsk_entry<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:065E                 </span><span style="color:navy">call    </span>cdev_entry
<span style="color:maroon">BIOSDATA:065E </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0661                 </span><span style="color:navy">dw offset </span>DSKTBL        ; 364h:579h ; BIOSCODE:579h ; 70h:34B9h
<span style="color:black">BIOSDATA:0663
BIOSDATA:0663 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:0663
BIOSDATA:0663
BIOSDATA:0663 </span>cdev_entry      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:0663                 </span><span style="color:navy">cmp     cs:</span>inHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:0669                 </span><span style="color:navy">jz      short </span><span style="color:gray">ce_enter_codeseg </span>; optimized for DOS in HMA
<span style="color:black">BIOSDATA:066B                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:066C                 </span><span style="color:navy">mov     ax, cs:</span>DosDataSg
<span style="color:black">BIOSDATA:0670                 </span><span style="color:navy">cmp     word ptr cs:</span>ptrsav<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:0675                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:0676                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_from_dos </span>; jump is coded this way to fall thru
<span style="color:black">BIOSDATA:0676                                         </span>; in 99.99% of the cases
<span style="color:black">BIOSDATA:0678
BIOSDATA:0678 </span><span style="color:gray">ce_enter_codeseg</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:0678                 </span><span style="color:navy">jmp     dword ptr cs:</span>cdev ; jmp far [cs:cdev]
<span style="color:black">BIOSDATA:067D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:067D
BIOSDATA:067D </span><span style="color:gray">not_from_dos</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:067D                 </span><span style="color:navy">call    </span>EnsureA20On
<span style="color:black">BIOSDATA:0680                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ce_enter_codeseg
</span><span style="color:black">BIOSDATA:0680 </span>cdev_entry      <span style="color:black">endp
BIOSDATA:0680
BIOSDATA:0682
BIOSDATA:0682 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:0682
BIOSDATA:0682
BIOSDATA:0682 </span>outchr          <span style="color:black">proc far                </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:0682                 </span><span style="color:navy">push    ax              </span>; INT 29h handler
<span style="color:black">BIOSDATA:0683                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:0684                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:0685                 </span><span style="color:navy">push    bp
</span><span style="color:black">BIOSDATA:0686                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:0687                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:0688                 </span><span style="color:navy">xor     bx, bx          </span>; 0
<span style="color:black">BIOSDATA:068A                 </span><span style="color:navy">cmp     cs:</span>IsWin386<span style="color:navy">, bl </span>; (are we in) windows ?
<span style="color:black">BIOSDATA:068F                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">BIOSDATA:0691                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:0691                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:black">BIOSDATA:0693                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">7
</span><span style="color:black">BIOSDATA:0695                 </span><span style="color:navy">jnz     short </span>win_outchr ; Running on Windows
<span style="color:black">BIOSDATA:0697                 </span><span style="color:navy">pushf                   </span>; far call (simulate INT)
<span style="color:black">BIOSDATA:0698                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSDATA:0699                 </span><span style="color:navy">call    </span>dword ptr ds:40h ; far call to INT 10h vector
<span style="color:black">BIOSDATA:069D                 </span><span style="color:navy">jmp     short </span>outchr_ok
<span style="color:black">BIOSDATA:069F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:069F
BIOSDATA:069F </span>win_outchr<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:069F                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO -
<span style="color:black">BIOSDATA:06A1
BIOSDATA:06A1 </span>outchr_ok<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:06A1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:06A2                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:06A2                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:06A3                 </span><span style="color:navy">pop     bp
</span><span style="color:black">BIOSDATA:06A4                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:06A5                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:06A6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:06A7                 </span><span style="color:navy">iret
</span><span style="color:black">BIOSDATA:06A7 </span>outchr          <span style="color:black">endp
BIOSDATA:06A7
BIOSDATA:06A7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">BIOSDATA:06A8                 </span><span style="color:navy">db  </span><span style="color:#008040">50h </span><span style="color:gray">; P             </span>; &#039;PCI&#039; signature
<span style="color:olive">BIOSDATA:06A9                 </span><span style="color:navy">db  </span><span style="color:#008040">43h </span><span style="color:gray">; C
</span><span style="color:olive">BIOSDATA:06AA                 </span><span style="color:navy">db  </span><span style="color:#008040">49h </span><span style="color:gray">; I
BIOSDATA:06AB </span>Orig1A          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:06AF
BIOSDATA:06AF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:06AF
BIOSDATA:06AF
BIOSDATA:06AF </span>Int1A           <span style="color:black">proc far                </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:06AF                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4           </span>; (Y2K-fix)
<span style="color:black">BIOSDATA:06B2                 </span><span style="color:navy">jz      short </span>int1a_1   ; Reads the date from the computer&#039;s real-time clock
<span style="color:black">BIOSDATA:06B4                 </span><span style="color:navy">jmp     cs:</span>Orig1A       ; jmp far [cs:Orig1A]
<span style="color:black">BIOSDATA:06B9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:06B9
BIOSDATA:06B9 </span>int1a_1<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:06B9                 </span><span style="color:navy">push    bp
</span><span style="color:black">BIOSDATA:06BA
BIOSDATA:06BA </span>int1a_2<span style="color:navy">:
</span><span style="color:black">BIOSDATA:06BA                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">BIOSDATA:06BC                 </span><span style="color:navy">push    bp
</span><span style="color:black">BIOSDATA:06BD                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSDATA:06BE                 </span><span style="color:navy">call    cs:</span>Orig1A
<span style="color:black">BIOSDATA:06C3                 </span><span style="color:navy">jb      short </span>int1a_4
<span style="color:black">BIOSDATA:06C5                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">0           </span>; Year (BCD)
<span style="color:black">BIOSDATA:06C8                 </span><span style="color:navy">jnz     short </span>int1a_3
<span style="color:black">BIOSDATA:06CA                 </span><span style="color:navy">cmp     ch, </span><span style="color:#ff8000">19h         </span>; Century (BCD)
<span style="color:black">BIOSDATA:06CD                 </span><span style="color:navy">jnz     short </span>int1a_3
<span style="color:black">BIOSDATA:06CF                 </span><span style="color:navy">mov     ch, </span><span style="color:green">20h
</span><span style="color:black">BIOSDATA:06D1                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5           </span>; Sets the date on the computer&#039;s real-time clock
<span style="color:black">BIOSDATA:06D3                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:06D4                 </span><span style="color:navy">push    dx              </span>; dh = Month (BCD), dl = Day (BCD)
<span style="color:black">BIOSDATA:06D5                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSDATA:06D6                 </span><span style="color:navy">call    cs:</span>Orig1A       ; call far [cs:Orig1A]
<span style="color:black">BIOSDATA:06DB                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:06DC                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSDATA:06DD                 </span><span style="color:navy">jb      short </span>int1a_4
<span style="color:black">BIOSDATA:06DF
BIOSDATA:06DF </span>int1a_3<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:06DF                 </span><span style="color:navy">pop     bp
</span><span style="color:black">BIOSDATA:06E0                 </span><span style="color:navy">and     byte ptr [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">0FEh </span>; clear carry flag
<span style="color:black">BIOSDATA:06E4                 </span><span style="color:navy">jmp     short </span>int1a_5
<span style="color:black">BIOSDATA:06E6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:06E6
BIOSDATA:06E6 </span>int1a_4<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:06E6                 </span><span style="color:navy">pop     bp
</span><span style="color:black">BIOSDATA:06E7                 </span><span style="color:navy">or      byte ptr [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">1 </span>; set carry flag
<span style="color:black">BIOSDATA:06EB
BIOSDATA:06EB </span>int1a_5<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:06EB                 </span><span style="color:navy">pop     bp
</span><span style="color:black">BIOSDATA:06EC                 </span><span style="color:navy">iret
</span><span style="color:black">BIOSDATA:06EC </span>Int1A           <span style="color:black">endp
BIOSDATA:06EC
BIOSDATA:06ED
BIOSDATA:06ED </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:06ED
BIOSDATA:06ED
BIOSDATA:06ED </span>block13         <span style="color:black">proc far                </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:06ED                 </span><span style="color:navy">cmp     cs:</span>inHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:06F3                 </span><span style="color:navy">jz      short </span>skipa20
<span style="color:black">BIOSDATA:06F5                 </span><span style="color:navy">call    </span>EnsureA20On     ; assure a20 enabled
<span style="color:black">BIOSDATA:06F8
BIOSDATA:06F8 </span>skipa20<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:06F8                 </span><span style="color:navy">mov     cs:</span>i13_ds<span style="color:navy">, ds   </span>; save caller&#039;s ds for call-through
<span style="color:black">BIOSDATA:06FD                 </span><span style="color:navy">pushf                   </span>; fake interrupt
<span style="color:black">BIOSDATA:06FE                 </span><span style="color:navy">call    dword ptr cs:</span>i13x ; call through Bios_Code entry table
<span style="color:black">BIOSDATA:0703                 </span><span style="color:navy">mov     ds, cs:</span>i13_ds
<span style="color:black">BIOSDATA:0708                 </span><span style="color:navy">retf    </span><span style="color:green">2
</span><span style="color:black">BIOSDATA:0708 </span>block13         <span style="color:black">endp
BIOSDATA:0708
BIOSDATA:070B
BIOSDATA:070B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:070B
BIOSDATA:070B
BIOSDATA:070B </span>call_orig13     <span style="color:black">proc far
BIOSDATA:070B                 </span><span style="color:navy">mov     ds, ds:</span>i13_ds   ; get caller&#039;s ds register
<span style="color:black">BIOSDATA:070F                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSDATA:0710                 </span><span style="color:navy">call    cs:</span>Orig13
<span style="color:black">BIOSDATA:0715                 </span><span style="color:navy">mov     cs:</span>i13_ds<span style="color:navy">, ds
</span><span style="color:black">BIOSDATA:071A                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:071B                 </span><span style="color:navy">pop     ds              </span>; restore ds -&gt; Bios_Data before return
<span style="color:black">BIOSDATA:071C                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:071C                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSDATA:071D                 </span><span style="color:navy">cmp     cs:</span>inHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:0723                 </span><span style="color:navy">jz      short </span>corig13_popf_retf
<span style="color:black">BIOSDATA:0725                 </span><span style="color:navy">call    </span>EnsureA20On
<span style="color:black">BIOSDATA:0728
BIOSDATA:0728 </span>corig13_popf_retf<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:0728                 </span><span style="color:navy">popf
</span><span style="color:black">BIOSDATA:0729
BIOSDATA:0729 </span>re_init<span style="color:navy">:
</span><span style="color:black">BIOSDATA:0729                 </span><span style="color:navy">retf
</span><span style="color:black">BIOSDATA:0729 </span>call_orig13     <span style="color:black">endp
BIOSDATA:0729
BIOSDATA:072A
BIOSDATA:072A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:072A
BIOSDATA:072A
BIOSDATA:072A </span>EnsureA20On     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:072A                 </span><span style="color:navy">call    </span>IsA20Off
<span style="color:black">BIOSDATA:072D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">enable_A20_ok
</span><span style="color:black">BIOSDATA:072F
BIOSDATA:072F </span>EnableA20<span style="color:navy">:                              </span>; A20 line is OFF
<span style="color:black">BIOSDATA:072F                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:0730                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:0731                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5           </span>; local enable A20
<span style="color:black">BIOSDATA:0733                 </span><span style="color:navy">call    cs:</span>xms
<span style="color:black">BIOSDATA:0738                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:0739                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:073A
BIOSDATA:073A </span><span style="color:gray">enable_A20_ok</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:073A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:073A </span>EnsureA20On     <span style="color:black">endp
BIOSDATA:073A
BIOSDATA:073B
BIOSDATA:073B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:073B
BIOSDATA:073B
BIOSDATA:073B </span>IsA20Off        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:073B                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:073C                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:073D                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:073E                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:073F                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:0740                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">BIOSDATA:0742                 </span><span style="color:navy">mov     es, di
</span><span style="color:black">BIOSDATA:0744                 </span>assume es:nothing
<span style="color:black">BIOSDATA:0744                 </span><span style="color:navy">dec     di
</span><span style="color:black">BIOSDATA:0745                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">90h
</span><span style="color:black">BIOSDATA:0748                 </span><span style="color:navy">mov     ds, di          </span>; 0FFFFh:0090h ; HiMem
<span style="color:black">BIOSDATA:074A                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:074A                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">80h         </span>; 0000h:0080h ; LoMem
<span style="color:black">BIOSDATA:074D
BIOSDATA:074D </span>cpu386_cmpsd<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:074D                 </span><span style="color:navy">nop
</span><span style="color:black">BIOSDATA:074E                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:black">BIOSDATA:0751                 </span><span style="color:navy">repe cmpsw              </span>;
<span style="color:black">BIOSDATA:0751                                         </span>; zf = 0 -&gt; A20 line is ON
<span style="color:black">BIOSDATA:0751                                         </span>; zf = 1 -&gt; A20 line is OFF
<span style="color:black">BIOSDATA:0753                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:0754                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:0755                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSDATA:0756                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:0757                 </span>assume es:nothing
<span style="color:black">BIOSDATA:0757                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:0758                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:0758 </span>IsA20Off        <span style="color:black">endp
BIOSDATA:0758
</span><span style="color:maroon">BIOSDATA:0759 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0759
BIOSDATA:0759 </span>int19<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0759                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:075A                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:075B                 </span>assume ds:BIOSDATA
<span style="color:maroon">BIOSDATA:075B                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">BIOSDATA:075D                 </span><span style="color:navy">mov     es, cx
</span><span style="color:maroon">BIOSDATA:075F                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:075F                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">5
</span><span style="color:maroon">BIOSDATA:0761                 </span><span style="color:navy">mov     si, offset </span>RomVectors
<span style="color:maroon">BIOSDATA:0764
BIOSDATA:0764 </span>_next_int<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:0764                 </span><span style="color:navy">lodsb                   </span>; get int number
<span style="color:maroon">BIOSDATA:0765                 </span><span style="color:navy">cbw                     </span>; assume &lt; 128
<span style="color:maroon">BIOSDATA:0766                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:0768                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1           </span>; int * 4
<span style="color:maroon">BIOSDATA:076A                 </span><span style="color:navy">xchg    ax, di
</span><span style="color:maroon">BIOSDATA:076B                 </span><span style="color:navy">movsw
</span><span style="color:maroon">BIOSDATA:076C                 </span><span style="color:navy">movsw                   </span>; install the saved vector
<span style="color:maroon">BIOSDATA:076D                 </span><span style="color:navy">loop    </span>_next_int
<span style="color:maroon">BIOSDATA:076F                 </span><span style="color:navy">cmp     </span>int19sem<span style="color:navy">, cl    </span>; 0
<span style="color:maroon">BIOSDATA:0773                 </span><span style="color:navy">jz      short </span>doint19
<span style="color:maroon">BIOSDATA:0775                 </span><span style="color:navy">mov     si, offset </span>i19_lst ; stacks code has changed these hardware interrupt vectors
<span style="color:maroon">BIOSDATA:0775                                         </span>; stkinit in sysinit1 will initialize int19oldxx values
<span style="color:maroon">BIOSDATA:0778                 </span><span style="color:navy">mov     cl, </span><span style="color:green">14          </span>; num_i19
<span style="color:maroon">BIOSDATA:077A
BIOSDATA:077A </span>i19_restore_loop<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:077A                 </span><span style="color:navy">lodsb                   </span>; get interrupt number
<span style="color:maroon">BIOSDATA:077B                 </span><span style="color:navy">cbw                     </span>; assume &lt; 128
<span style="color:maroon">BIOSDATA:077C                 </span><span style="color:navy">xchg    ax, di
</span><span style="color:maroon">BIOSDATA:077D                 </span><span style="color:navy">lodsw                   </span>; get original vector offset
<span style="color:maroon">BIOSDATA:077E                 </span><span style="color:navy">xchg    ax, bx          </span>; save it
<span style="color:maroon">BIOSDATA:077F                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">BIOSDATA:0780                 </span><span style="color:navy">inc     bx              </span>; check for 0ffffh (unlikely segment)
<span style="color:maroon">BIOSDATA:0781                 </span><span style="color:navy">jz      short </span>i19_restor_1 ; opt no need to check selector too
<span style="color:maroon">BIOSDATA:0783                 </span><span style="color:navy">dec     bx
</span><span style="color:maroon">BIOSDATA:0784                 </span><span style="color:navy">add     di, di
</span><span style="color:maroon">BIOSDATA:0786                 </span><span style="color:navy">add     di, di
</span><span style="color:maroon">BIOSDATA:0788                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:0789                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:078A                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:078B                 </span><span style="color:navy">stosw                   </span>; put the vector back
<span style="color:maroon">BIOSDATA:078C
BIOSDATA:078C </span>i19_restor_1<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:078C                 </span><span style="color:navy">loop    </span>i19_restore_loop
<span style="color:maroon">BIOSDATA:078E
BIOSDATA:078E </span>doint19<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:078E                 </span><span style="color:navy">cmp     </span>inHMA<span style="color:navy">, cl       </span>; Is dos running from HMA ?
<span style="color:maroon">BIOSDATA:0792                 </span><span style="color:navy">jz      short </span>SkipVDisk ; no
<span style="color:maroon">BIOSDATA:0794                 </span><span style="color:navy">call    </span>EraseVDiskHead  ; Then erase our VDISK header at 1MB boundary
<span style="color:maroon">BIOSDATA:0794                                         </span>; Some m/c&#039;s (AST 386 &amp; HP QS/16 do not clear
<span style="color:maroon">BIOSDATA:0794                                         </span>; the memory above 1MB during a warm boot.
<span style="color:maroon">BIOSDATA:0797
BIOSDATA:0797 </span>SkipVDisk<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:0797                 </span><span style="color:navy">int     </span><span style="color:green">19h             </span>; DISK BOOT
<span style="color:maroon">BIOSDATA:0797                                         </span>; causes reboot of disk system
<span style="color:maroon">BIOSDATA:0799
BIOSDATA:0799 </span>Int15<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:0799                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4F53h       </span>; del keystroke ?  (4F00h+DELKEY)
<span style="color:maroon">BIOSDATA:079C                 </span><span style="color:navy">jz      short </span>int15_1
<span style="color:maroon">BIOSDATA:079E
BIOSDATA:079E </span>Old15_j<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:079E                 </span><span style="color:navy">jmp     cs:</span>Old15
<span style="color:maroon">BIOSDATA:07A3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:07A3
BIOSDATA:07A3 </span>int15_1<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:07A3                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:07A4                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:07A5                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:07A7                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:07A9                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:07A9                 </span><span style="color:navy">mov     al, </span>byte ptr ds:417h ; [KBFLAG]
<span style="color:maroon">BIOSDATA:07AC                 </span><span style="color:navy">and     al, </span><span style="color:green">0Ch         </span>; (CTRLSTATE | ALTSTATE)
<span style="color:maroon">BIOSDATA:07AE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ch         </span>; (CTRLSTATE | ALTSTATE)
<span style="color:maroon">BIOSDATA:07B0                 </span><span style="color:navy">jnz     short </span>int15_2
<span style="color:maroon">BIOSDATA:07B2                 </span><span style="color:navy">cmp     cs:</span>inHMA<span style="color:navy">, ah    </span>; is DOS running from HMA ?
<span style="color:maroon">BIOSDATA:07B7                 </span><span style="color:navy">jz      short </span>int15_2   ; no
<span style="color:maroon">BIOSDATA:07B9                 </span><span style="color:navy">call    </span>EraseVDiskHead
<span style="color:maroon">BIOSDATA:07BC
BIOSDATA:07BC </span>int15_2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:07BC                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:07BD                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:07BE                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:07BE                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSDATA:07BF                 </span><span style="color:navy">jmp     short </span>Old15_j
<span style="color:black">BIOSDATA:07C1
BIOSDATA:07C1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:07C1
BIOSDATA:07C1
BIOSDATA:07C1 </span>EraseVDiskHead  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:07C1                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:07C2                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:07C3                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:07C4                 </span><span style="color:navy">call    </span>EnsureA20On
<span style="color:black">BIOSDATA:07C7                 </span><span style="color:navy">push    </span><span style="color:green">0FFFFh          </span>; HMA seg
<span style="color:black">BIOSDATA:07C9                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:07CA                 </span>assume es:nothing
<span style="color:black">BIOSDATA:07CA                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">10h         </span>; point to VDISK header
<span style="color:black">BIOSDATA:07CD                 </span><span style="color:navy">mov     cx, di          </span>; size of vdisk header = 16
<span style="color:black">BIOSDATA:07CF                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">BIOSDATA:07D1                 </span><span style="color:navy">rep stosw               </span>; clear it
<span style="color:black">BIOSDATA:07D3                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:07D4                 </span>assume es:nothing
<span style="color:black">BIOSDATA:07D4                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:07D5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSDATA:07D6                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:07D6 </span>EraseVDiskHead  <span style="color:black">endp
BIOSDATA:07D6
BIOSDATA:07D6 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:07D7 </span>FreeHMAPtr      <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:07D9 </span>MoveDOSIntoHMA  <span style="color:navy">dw offset </span>FTRYTOMOVDOSHI <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:07D9                                         </span>; SYSINITSEG:FTRYTOMOVDOSHI
<span style="color:gray">BIOSDATA:07DB </span>MoveDOSIntoHMA_2 <span style="color:navy">dw </span><span style="color:#008040">544h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:07DB                                         </span>; SYSINITSEG
<span style="color:gray">BIOSDATA:07DD </span>SysinitPresent  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:07DE </span>Win386_SI       <span style="color:navy">db </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:07E0 </span>SI_Next         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:07E4                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:07E8                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:07EC                 </span><span style="color:navy">dw offset </span>Instance_Table
<span style="color:gray">BIOSDATA:07EE                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:07F0 </span>Instance_Table  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:07F0                                         </span>; print screen status
<span style="color:gray">BIOSDATA:07F2                 </span><span style="color:navy">dw </span><span style="color:#008040">50h
</span><span style="color:gray">BIOSDATA:07F4                 </span><span style="color:navy">dw </span><span style="color:#008040">2                    </span>; 2 bytes
<span style="color:gray">BIOSDATA:07F6                 </span><span style="color:navy">dw </span><span style="color:#008040">0Eh                  </span>; ROM Basic data
<span style="color:gray">BIOSDATA:07F8                 </span><span style="color:navy">dw </span><span style="color:#008040">50h
</span><span style="color:gray">BIOSDATA:07FA                 </span><span style="color:navy">dw </span><span style="color:#008040">14h                  </span>; 20 bytes
<span style="color:gray">BIOSDATA:07FC                 </span><span style="color:navy">dw offset </span>altah         ; a con device buffer
<span style="color:gray">BIOSDATA:07FE                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">BIOSDATA:0800                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:0802 </span>NextStack       <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0802                                         </span>; pointer to next stack to be used
<span style="color:gray">BIOSDATA:0806                 </span><span style="color:navy">dw </span><span style="color:#008040">2                    </span>; 2 bytes
<span style="color:gray">BIOSDATA:0808 </span>IT_StackLoc     <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0808                                         </span>; location of hardware stacks
<span style="color:gray">BIOSDATA:080C </span>IT_StackSize    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:080C                                         </span>; size of hardware stacks
<span style="color:gray">BIOSDATA:080E                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; terminate the instance table
<span style="color:gray">BIOSDATA:0812 </span>IsWin386        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0812                                         </span>; Flag to indicate whether
<span style="color:gray">BIOSDATA:0812                                         </span>; Win386 is running or not
<span style="color:maroon">BIOSDATA:0813 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0813
BIOSDATA:0813 </span>V86_Crit_SetFocus<span style="color:navy">:
</span><span style="color:maroon">BIOSDATA:0813                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:0814                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:0815                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:0816                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:0817                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">BIOSDATA:0819                 </span><span style="color:navy">mov     es, di
</span><span style="color:maroon">BIOSDATA:081B                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:081B
BIOSDATA:081B </span>offset_081Bh<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:081B                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">15h         </span>; Device ID of DOSMGR device
<span style="color:maroon">BIOSDATA:081E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1684h
</span><span style="color:maroon">BIOSDATA:0821                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - MS WINDOWS - GET DEVICE API ENTRY POINT
<span style="color:maroon">BIOSDATA:0821                                         </span>; BX = virtual device (VxD) ID, ES:DI = 0000h:0000h
<span style="color:maroon">BIOSDATA:0821                                         </span>; Return: ES:DI -&gt; VxD API entry point, or 0:0 if the VxD does not support an API
<span style="color:maroon">BIOSDATA:0823                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">BIOSDATA:0825                 </span><span style="color:navy">or      ax, di
</span><span style="color:maroon">BIOSDATA:0827                 </span><span style="color:navy">jz      short </span>Skip
<span style="color:maroon">BIOSDATA:0829                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:082A                 </span><span style="color:navy">push    offset </span>Skip
<span style="color:maroon">BIOSDATA:082D                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:082E                 </span><span style="color:navy">push    di              </span>; API far call address
<span style="color:maroon">BIOSDATA:082F                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1           </span>; SetFocus function number
<span style="color:maroon">BIOSDATA:0832                 </span><span style="color:navy">retf                    </span>; do the call
<span style="color:maroon">BIOSDATA:0833 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:0833
BIOSDATA:0833 </span>Skip<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:0833                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:0834                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:0835                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:0836                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:0836                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:0837                 </span><span style="color:navy">retf
</span><span style="color:maroon">BIOSDATA:0837 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:0838 </span>endfloppy       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:0839 </span>offset_0839h    <span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:green">; ...
</span><span style="color:gray">BIOSDATA:0840 </span>tmp_vid         <span style="color:navy">db &#039;NO NAME    &#039;        </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:084B </span>harddrv         <span style="color:navy">db </span><span style="color:#008040">80h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:084C </span>bdss            <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:084C                                         </span>; max_mini_dsk_num equ 23
<span style="color:gray">BIOSDATA:084C                                         </span>; BDS_STRUC (2+max_mini_dsk_num) dup (&lt;&gt;)
<span style="color:gray">BIOSDATA:084C                                         </span>; currently max. 25
<span style="color:gray">BIOSDATA:084C                                         </span>; (MSDOS 6 BDS structure size = 100 bytes)
<span style="color:gray">BIOSDATA:084C                                         </span>; (PCDOS 7.1 BDS structure size = 150 bytes)
<span style="color:gray">BIOSDATA:084C                                         </span>; BDS.link
<span style="color:gray">BIOSDATA:084E                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0850                 </span><span style="color:navy">db </span><span style="color:#008040">80                   </span>; BDS.drivenum
<span style="color:gray">BIOSDATA:0851                 </span><span style="color:navy">db </span><span style="color:#008040">3                    </span>; BDS.drivelet
<span style="color:gray">BIOSDATA:0852                 </span><span style="color:navy">dw </span><span style="color:#008040">512                  </span>; BDS.BPB (BDS offset 6)
<span style="color:gray">BIOSDATA:0852                                         </span>; 53 bytes BPB for FAT32 fs
<span style="color:gray">BIOSDATA:0852                                         </span>; 25 bytes BPB for FAT16 and FAT12 fs
<span style="color:gray">BIOSDATA:0852                                         </span>; .bytespersec
<span style="color:gray">BIOSDATA:0854                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; .secperclus
<span style="color:gray">BIOSDATA:0855                 </span><span style="color:navy">dw </span><span style="color:#008040">1                    </span>; .resectors
<span style="color:gray">BIOSDATA:0857                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; .fats
<span style="color:gray">BIOSDATA:0858                 </span><span style="color:navy">dw </span><span style="color:#008040">16                   </span>; .direntries
<span style="color:gray">BIOSDATA:085A                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; .totalsec16
<span style="color:olive">BIOSDATA:085C                 </span><span style="color:navy">db </span><span style="color:#008040">0F8h                 </span>; .media
<span style="color:gray">BIOSDATA:085D                 </span><span style="color:navy">dw </span><span style="color:#008040">1                    </span>; .fatsecs16
<span style="color:gray">BIOSDATA:085F                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; .secpertrack
<span style="color:gray">BIOSDATA:0861                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; .heads
<span style="color:gray">BIOSDATA:0863                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; .hiddensectors
<span style="color:gray">BIOSDATA:0867                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; .totalsecs32
<span style="color:gray">BIOSDATA:0867                                         </span>; (End of FAT12/FAT16 BPB)
<span style="color:gray">BIOSDATA:0867                                         </span>;
<span style="color:gray">BIOSDATA:0867                                         </span>; FAT32 extensions to BDS
<span style="color:gray">BIOSDATA:086B                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; .fatsecs32 ; BPB_FATSz32 (BDS offset 31)
<span style="color:gray">BIOSDATA:086F                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; .extflags ; BPB_ExtFlags
<span style="color:gray">BIOSDATA:0871                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; .fsver ; BPB_FSVer
<span style="color:gray">BIOSDATA:0873                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; .rootdirclust ; BPB_RootClus (BDS offset 39)
<span style="color:gray">BIOSDATA:0877                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; .fsinfo ; BPB_FSInfo ; initialized to -1
<span style="color:gray">BIOSDATA:0879                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; .bkbootsec ; BPB_BkBootSec ; initialized to -1
<span style="color:gray">BIOSDATA:087B                 </span><span style="color:navy">db </span><span style="color:#008040">12 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span>; .reserved ; BPB_Reserved (12 zero bytes)
<span style="color:gray">BIOSDATA:0887                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; BDS.fatsiz (BDS offset 59)
<span style="color:gray">BIOSDATA:0888                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; BDS.opcnt
<span style="color:gray">BIOSDATA:088A                 </span><span style="color:navy">db </span><span style="color:#008040">3
</span><span style="color:gray">BIOSDATA:088B                 </span><span style="color:navy">dw </span><span style="color:#008040">20h                  </span>; BDS.flags (BDS offset 63)
<span style="color:gray">BIOSDATA:088D                 </span><span style="color:navy">dw </span><span style="color:#008040">40
</span><span style="color:gray">BIOSDATA:088F                 </span><span style="color:navy">db </span><span style="color:#008040">37 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:08B4                 </span><span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh
</span><span style="color:gray">BIOSDATA:08B8                 </span><span style="color:navy">db </span><span style="color:#008040">12 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:08C4                 </span><span style="color:navy">db -</span><span style="color:#008040">1                   </span>; BDS.track (BDS offset 120)
<span style="color:gray">BIOSDATA:08C5                 </span><span style="color:navy">dw </span><span style="color:#008040">1                    </span>; BDS.tim_lo ; BDS.bdsm_ismini
<span style="color:gray">BIOSDATA:08C7                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; BDS.tim_hi
<span style="color:gray">BIOSDATA:08C9                 </span><span style="color:navy">db &#039;NO NAME    &#039;,0      </span>; BDS.volid
<span style="color:gray">BIOSDATA:08D5                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; BDS.vol_serial (BDS offset 137)
<span style="color:gray">BIOSDATA:08D9                 </span><span style="color:navy">db &#039;FAT12   &#039;,0         </span>; BDS.filesys_id
<span style="color:gray">BIOSDATA:08E2 </span>bds_1           <span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:08E4                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0978 </span>bds_2           <span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:097A                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0A0E </span>bds_3           <span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0A10                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0AA4 </span>bds_4           <span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0AA6                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0B3A                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0B3C                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0BD0                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0BD2                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0C66                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0C68                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0CFC                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0CFE                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0D92                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0D94                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0E28                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0E2A                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0EBE                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0EC0 </span><span style="color:navy">byte_14B0       db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0EC0                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0F54                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0F56                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0FEA                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:0FEC                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1080                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1082                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1116                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1118                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:11AC                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:11AE                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1242                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1244                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:12D8                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:12DA                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:136E                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1370                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1404                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1406                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:149A                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:149C                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1530                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:1532                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:15C6                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:15C8                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:165C </span>bds_24          <span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0F8h
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">41h
</span><span style="color:gray">BIOSDATA:165E                 </span><span style="color:navy">db </span><span style="color:#008040">54h</span><span style="color:navy">, </span><span style="color:#008040">31h</span><span style="color:navy">, </span><span style="color:#008040">32h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:maroon">BIOSDATA:16F2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:16F2
BIOSDATA:16F2 </span>ibm_disk_io<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:16F2                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">80h         </span>; main routine, fixes at rom bug
<span style="color:maroon">BIOSDATA:16F2                                         </span>; pass through floppy disk calls
<span style="color:maroon">BIOSDATA:16F5                 </span><span style="color:navy">jb      short </span>atd1
<span style="color:maroon">BIOSDATA:16F7                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2
</span><span style="color:maroon">BIOSDATA:16FA                 </span><span style="color:navy">jz      short </span>atd2      ; intercept call 02h (read sectors)
<span style="color:maroon">BIOSDATA:16FC                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0Ah         </span>; and call 0Ah (read long)
<span style="color:maroon">BIOSDATA:16FF                 </span><span style="color:navy">jz      short </span>atd2
<span style="color:maroon">BIOSDATA:1701
BIOSDATA:1701 </span>atd1<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1701                 </span><span style="color:navy">jmp     cs:</span>Old13        ; use rom int 13h handler
<span style="color:maroon">BIOSDATA:1706 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1706
BIOSDATA:1706 </span>atd2<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1706                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:1707                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:1708                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:1709                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:170A                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:170B                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:170C                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:170D                 </span><span style="color:navy">mov     ax, </span><span style="color:green">40h         </span>; rombios data segment
<span style="color:maroon">BIOSDATA:1710                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:1712                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1712                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">74h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [disk_status1]
<span style="color:maroon">BIOSDATA:1712                                         </span>; initially no error code
<span style="color:maroon">BIOSDATA:1717                 </span><span style="color:navy">and     dl, </span><span style="color:green">7Fh         </span>; mask to hard disk number
<span style="color:maroon">BIOSDATA:171A                 </span><span style="color:navy">cmp     dl, ds:</span><span style="color:green">75h      </span>; [hf_num] ; 40h:75h
<span style="color:maroon">BIOSDATA:171E                 </span><span style="color:navy">jb      short </span>atd3      ; disk number in range
<span style="color:maroon">BIOSDATA:1720                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">74h</span><span style="color:navy">, </span><span style="color:#ff8000">1 </span>; [disk_status1]
<span style="color:maroon">BIOSDATA:1725                 </span><span style="color:navy">jmp     short </span>atd4      ; disk number out of range error, return
<span style="color:maroon">BIOSDATA:1727 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1727
BIOSDATA:1727 </span>atd3<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1727                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:1728                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">BIOSDATA:172A                 </span><span style="color:navy">shr     bx, </span><span style="color:green">4           </span>; make es:bx to seg:000x form
<span style="color:maroon">BIOSDATA:172D                 </span><span style="color:navy">add     ax, bx
</span><span style="color:maroon">BIOSDATA:172F                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">BIOSDATA:1731                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:1732                 </span><span style="color:navy">and     bx, </span><span style="color:green">0Fh
</span><span style="color:maroon">BIOSDATA:1735                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1736                 </span><span style="color:navy">call    </span>check_dma
<span style="color:maroon">BIOSDATA:1739 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1739                 </span><span style="color:navy">jb      short </span>atd4      ; abort if dma across segment boundary
<span style="color:maroon">BIOSDATA:173B                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:173C                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:173D                 </span><span style="color:navy">call    </span>setcmd          ; set up command block for disk op
<span style="color:maroon">BIOSDATA:1740 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1740                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">3F6h        </span>; hf_reg_port
<span style="color:maroon">BIOSDATA:1743                 </span><span style="color:navy">out     dx, al          </span>; AT only. Fixed disk register
<span style="color:maroon">BIOSDATA:1744                 </span><span style="color:navy">call    </span>docmd           ; carry out command
<span style="color:maroon">BIOSDATA:1747 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1747
BIOSDATA:1747 </span>atd4<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1747                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:1748                 </span><span style="color:navy">mov     ah, ds:</span><span style="color:green">74h      </span>; [disk_status1]
<span style="color:maroon">BIOSDATA:174C                 </span><span style="color:navy">or      ah, ah
</span><span style="color:maroon">BIOSDATA:174E                 </span><span style="color:navy">jz      short </span>atd5
<span style="color:maroon">BIOSDATA:1750                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSDATA:1751
BIOSDATA:1751 </span>atd5<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1751                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:1752                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1753                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1753                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:1754                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:1755                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:1756                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:1757                 </span><span style="color:navy">retf    </span><span style="color:green">2
</span><span style="color:black">BIOSDATA:175A
BIOSDATA:175A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:175A
BIOSDATA:175A </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:175A
BIOSDATA:175A </span>setcmd          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:175A                 </span><span style="color:navy">mov     ds:</span><span style="color:green">43h</span><span style="color:navy">, al      </span>; [cmd_block+sec_cnt]
<span style="color:black">BIOSDATA:175D                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">48h</span><span style="color:navy">, </span><span style="color:green">20h
</span><span style="color:black">BIOSDATA:1762                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2           </span>; cmd_reg = 20h if function 02h (read)
<span style="color:black">BIOSDATA:1765                 </span><span style="color:navy">jz      short </span><span style="color:gray">setc1
</span><span style="color:black">BIOSDATA:1767                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">48h</span><span style="color:navy">, </span><span style="color:green">22h </span>; [cmd_block+cmd_reg]
<span style="color:black">BIOSDATA:1767                                         </span>; cmd_reg = 22h if function 0Ah (read long)
<span style="color:black">BIOSDATA:176C
BIOSDATA:176C </span><span style="color:gray">setc1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:176C                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">BIOSDATA:176E                 </span><span style="color:navy">and     al, </span><span style="color:green">3Fh         </span>; mask sector number
<span style="color:black">BIOSDATA:1770                 </span><span style="color:navy">mov     ds:</span><span style="color:green">44h</span><span style="color:navy">, al      </span>; [cmd_block+sec_num]
<span style="color:black">BIOSDATA:1773                 </span><span style="color:navy">mov     ds:</span><span style="color:green">45h</span><span style="color:navy">, ch      </span>; [cmd_block+cyl_low]
<span style="color:black">BIOSDATA:1777                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">BIOSDATA:1779                 </span><span style="color:navy">shr     al, </span><span style="color:green">6           </span>; get two high bits of cylinder number
<span style="color:black">BIOSDATA:177C                 </span><span style="color:navy">mov     ds:</span><span style="color:green">46h</span><span style="color:navy">, al      </span>; [cmd_block+cyl_high]
<span style="color:black">BIOSDATA:177F                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">BIOSDATA:1781                 </span><span style="color:navy">shl     al, </span><span style="color:green">4           </span>; drive number
<span style="color:black">BIOSDATA:1784                 </span><span style="color:navy">and     ah, </span><span style="color:green">0Fh
</span><span style="color:black">BIOSDATA:1787                 </span><span style="color:navy">or      al, ah          </span>; head number
<span style="color:black">BIOSDATA:1789                 </span><span style="color:navy">or      al, </span><span style="color:green">0A0h        </span>; set ecc and 512 bytes per sector
<span style="color:black">BIOSDATA:178B                 </span><span style="color:navy">mov     ds:</span><span style="color:green">47h</span><span style="color:navy">, al      </span>; [cmd_block+drv_head]
<span style="color:black">BIOSDATA:178E                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:178F                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:1790                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:1791                 </span><span style="color:navy">call    </span>get_vec
<span style="color:black">BIOSDATA:1794 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:1794                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:bx+fdp_precomp]
<span style="color:black">BIOSDATA:1794                                         </span>; write pre-comp from disk parameters
<span style="color:black">BIOSDATA:1798                 </span><span style="color:navy">shr     ax, </span><span style="color:green">2
</span><span style="color:black">BIOSDATA:179B                 </span><span style="color:navy">mov     ds:</span><span style="color:green">42h</span><span style="color:navy">, al      </span>; [cmd_block+pre_comp]
<span style="color:black">BIOSDATA:179E                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; [es:bx+fdp_control]
<span style="color:black">BIOSDATA:179E                                         </span>; control byte modifier
<span style="color:black">BIOSDATA:17A2                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:17A3                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:17A4                 </span><span style="color:navy">mov     ah, ds:</span><span style="color:green">76h      </span>; [control_byte]
<span style="color:black">BIOSDATA:17A8                 </span><span style="color:navy">and     ah, </span><span style="color:green">0C0h        </span>; keep disable retry bits
<span style="color:black">BIOSDATA:17AB                 </span><span style="color:navy">or      ah, al
</span><span style="color:black">BIOSDATA:17AD                 </span><span style="color:navy">mov     ds:</span><span style="color:green">76h</span><span style="color:navy">, ah
</span><span style="color:black">BIOSDATA:17B1                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:17B1 </span>setcmd          <span style="color:black">endp
BIOSDATA:17B1
BIOSDATA:17B2
BIOSDATA:17B2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:17B2
BIOSDATA:17B2 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:17B2
BIOSDATA:17B2 </span>docmd           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:17B2                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">BIOSDATA:17B4                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:17B5                 </span><span style="color:navy">call    </span>command
<span style="color:black">BIOSDATA:17B8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:17B8                 </span><span style="color:navy">jnz     short </span>doc3
<span style="color:black">BIOSDATA:17BA
BIOSDATA:17BA </span><span style="color:gray">doc1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:17BA                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:17BB                 </span><span style="color:navy">call    </span>waitt           ; wait for controller to complete read
<span style="color:black">BIOSDATA:17BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:17BE                 </span><span style="color:navy">jnz     short </span>doc3
<span style="color:black">BIOSDATA:17C0                 </span><span style="color:navy">mov     cx, </span><span style="color:green">256
</span><span style="color:black">BIOSDATA:17C3                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">1F0h        </span>; hf_port
<span style="color:black">BIOSDATA:17C6                 </span><span style="color:navy">cld
</span><span style="color:black">BIOSDATA:17C7                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSDATA:17C8
BIOSDATA:17C8 </span><span style="color:gray">rsct_loop</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:17C8                 </span><span style="color:navy">insw                    </span>; read in sector
<span style="color:black">BIOSDATA:17C9                 </span><span style="color:navy">loop    </span><span style="color:gray">rsct_loop
</span><span style="color:black">BIOSDATA:17CB                 </span><span style="color:navy">sti
</span><span style="color:black">BIOSDATA:17CC                 </span><span style="color:navy">test    byte ptr ds:</span><span style="color:green">48h</span><span style="color:navy">, </span><span style="color:green">2 </span>; [cmd_block+cmd_reg]
<span style="color:black">BIOSDATA:17D1                 </span><span style="color:navy">jz      short </span><span style="color:gray">doc2
</span><span style="color:black">BIOSDATA:17D3                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:17D4                 </span><span style="color:navy">call    </span>wait_drq
<span style="color:black">BIOSDATA:17D7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:17D7                 </span><span style="color:navy">jb      short </span>doc3
<span style="color:black">BIOSDATA:17D9                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4           </span>; 4 bytes of ecc
<span style="color:black">BIOSDATA:17DC                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">1F0h
</span><span style="color:black">BIOSDATA:17DF                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSDATA:17E0                 </span><span style="color:navy">rep insb                </span>; read in ecc
<span style="color:black">BIOSDATA:17E2                 </span><span style="color:navy">sti
</span><span style="color:black">BIOSDATA:17E3
BIOSDATA:17E3 </span><span style="color:gray">doc2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:17E3                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:17E4                 </span><span style="color:navy">call    </span>check_status
<span style="color:black">BIOSDATA:17E7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:17E7                 </span><span style="color:navy">jnz     short </span>doc3
<span style="color:black">BIOSDATA:17E9                 </span><span style="color:navy">dec     byte ptr ds:</span><span style="color:green">43h </span>; [cmd_block+sec_cnt]
<span style="color:black">BIOSDATA:17ED                 </span><span style="color:navy">jnz     short </span><span style="color:gray">doc1
</span><span style="color:black">BIOSDATA:17EF
BIOSDATA:17EF </span>doc3<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:17EF                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:17EF </span>docmd           <span style="color:black">endp
BIOSDATA:17EF
BIOSDATA:17F0
BIOSDATA:17F0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:17F0
BIOSDATA:17F0 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:17F0
BIOSDATA:17F0 </span>get_vec         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:17F0                 </span><span style="color:navy">push    </span><span style="color:green">0FF65h          </span>; get pointer to hard disk parameters
<span style="color:black">BIOSDATA:17F3                 </span><span style="color:navy">jmp     </span>far ptr 0F000h:2F8Eh
<span style="color:black">BIOSDATA:17F3 </span>get_vec         <span style="color:black">endp
BIOSDATA:17F3
BIOSDATA:17F8
BIOSDATA:17F8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:17F8
BIOSDATA:17F8 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:17F8
BIOSDATA:17F8 </span>command         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:17F8                 </span><span style="color:navy">push    </span><span style="color:green">0FF65h          </span>; send contents of cmd_block to disk controller
<span style="color:black">BIOSDATA:17FB                 </span><span style="color:navy">jmp     </span>far ptr 0F000h:2E1Eh
<span style="color:black">BIOSDATA:17FB </span>command         <span style="color:black">endp
BIOSDATA:17FB
BIOSDATA:1800
BIOSDATA:1800 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:1800
BIOSDATA:1800 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:1800
BIOSDATA:1800 </span>waitt           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1800                 </span><span style="color:navy">push    </span><span style="color:green">0FF65h          </span>; wait for disk interrupt
<span style="color:black">BIOSDATA:1803                 </span><span style="color:navy">jmp     </span>far ptr 0F000h:2E7Fh
<span style="color:black">BIOSDATA:1803 </span>waitt           <span style="color:black">endp
BIOSDATA:1803
BIOSDATA:1808
BIOSDATA:1808 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:1808
BIOSDATA:1808 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:1808
BIOSDATA:1808 </span>wait_drq        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1808                 </span><span style="color:navy">push    </span><span style="color:green">0FF65h          </span>; wait for data request
<span style="color:black">BIOSDATA:180B                 </span><span style="color:navy">jmp     </span>far ptr 0F000h:2EE2h
<span style="color:black">BIOSDATA:180B </span>wait_drq        <span style="color:black">endp
BIOSDATA:180B
BIOSDATA:1810
BIOSDATA:1810 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:1810
BIOSDATA:1810 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:1810
BIOSDATA:1810 </span>check_status    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1810                 </span><span style="color:navy">push    </span><span style="color:green">0FF65h          </span>; check hard disk status
<span style="color:black">BIOSDATA:1813                 </span><span style="color:navy">jmp     </span>far ptr 0F000h:2EF8h
<span style="color:black">BIOSDATA:1813 </span>check_status    <span style="color:black">endp
BIOSDATA:1813
BIOSDATA:1818
BIOSDATA:1818 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:1818
BIOSDATA:1818 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">BIOSDATA:1818
BIOSDATA:1818 </span>check_dma       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1818                 </span><span style="color:navy">push    </span><span style="color:green">0FF65h          </span>; check for dma overrun 64k segment
<span style="color:black">BIOSDATA:181B                 </span><span style="color:navy">jmp     </span>far ptr 0F000h:2F69h
<span style="color:black">BIOSDATA:181B </span>check_dma       <span style="color:black">endp
BIOSDATA:181B
</span><span style="color:maroon">BIOSDATA:1820 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1820
BIOSDATA:1820 </span>endatrom<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:1820                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">15h         </span>; compaq_disk_io
<span style="color:maroon">BIOSDATA:1823                 </span><span style="color:navy">ja      short </span>mebbe_hookit
<span style="color:maroon">BIOSDATA:1825
BIOSDATA:1825 </span>no_hookit<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1825                 </span><span style="color:navy">jmp     cs:</span>Old13
<span style="color:maroon">BIOSDATA:182A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:182A
BIOSDATA:182A </span>mebbe_hookit<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:182A                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">BIOSDATA:182D                 </span><span style="color:navy">jb      short </span>no_hookit
<span style="color:maroon">BIOSDATA:182F                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:1830                 </span><span style="color:navy">push    </span><span style="color:green">40h
</span><span style="color:maroon">BIOSDATA:1832                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1833                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1833                 </span><span style="color:navy">pushf
</span><span style="color:maroon">BIOSDATA:1834                 </span><span style="color:navy">call    cs:</span>Old13
<span style="color:maroon">BIOSDATA:1839                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:183A                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:183A                 </span><span style="color:navy">retf    </span><span style="color:green">2
</span><span style="color:maroon">BIOSDATA:183A </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:183D </span>end_compaq_i13hook <span style="color:navy">db </span><span style="color:#008040">0                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:183E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:183E
BIOSDATA:183E </span>int_6Ch<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:183E                 </span><span style="color:navy">cmp     cs:</span>inHMA<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; The K09 requires the routines for reading the clock
<span style="color:maroon">BIOSDATA:183E                                         </span>; because of the suspend/resume facility.
<span style="color:maroon">BIOSDATA:1844                 </span><span style="color:navy">jz      short </span>int6c
<span style="color:maroon">BIOSDATA:1846                 </span><span style="color:navy">mov     bx, offset </span>EnsureA20On
<span style="color:maroon">BIOSDATA:1849                 </span><span style="color:navy">call    bx </span><span style="color:gray">; </span>EnsureA20On
<span style="color:maroon">BIOSDATA:184B
BIOSDATA:184B </span>int6c<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:184B                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:184C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:184D                 </span>assume ds:BIOSDATA
<span style="color:maroon">BIOSDATA:184D                 </span><span style="color:navy">pop     word ptr </span>int6c_ret_addr
<span style="color:maroon">BIOSDATA:1851                 </span><span style="color:navy">pop     word ptr </span>int6c_ret_addr<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">BIOSDATA:1855                 </span><span style="color:navy">popf
</span><span style="color:maroon">BIOSDATA:1856                 </span><span style="color:navy">call    </span>read_real_date  ; get the date from the clock
<span style="color:maroon">BIOSDATA:1859                 </span><span style="color:navy">cli
</span><span style="color:maroon">BIOSDATA:185A                 </span><span style="color:navy">mov     </span>daycnt<span style="color:navy">, si      </span>; update dos copy of date
<span style="color:maroon">BIOSDATA:185E                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSDATA:185F                 </span><span style="color:navy">call    </span>read_real_time  ; get the time from the   rtc
<span style="color:maroon">BIOSDATA:1862                 </span><span style="color:navy">cli
</span><span style="color:maroon">BIOSDATA:1863                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1865                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - SET TIME OF DAY
<span style="color:maroon">BIOSDATA:1865                                         </span>; CX:DX = clock count
<span style="color:maroon">BIOSDATA:1865                                         </span>; Return: time of day set
<span style="color:maroon">BIOSDATA:1867                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSDATA:1868                 </span><span style="color:navy">jmp     </span>int6c_ret_addr  ; jmp far [int6c_ret_addr] ; long jump
<span style="color:black">BIOSDATA:186C
BIOSDATA:186C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:186C
BIOSDATA:186C
BIOSDATA:186C </span>read_real_date  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:186C                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:186D                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:186E                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:186F                 </span><span style="color:navy">xor     ah, ah          </span>; throw away clock roll over
<span style="color:black">BIOSDATA:1871                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - GET TIME OF DAY
<span style="color:black">BIOSDATA:1871                                         </span>; Return: CX:DX = clock count
<span style="color:black">BIOSDATA:1871                                         </span>; AL = 00h if clock was read or written (via AH=0,1) since the previous
<span style="color:black">BIOSDATA:1871                                         </span>; midnight
<span style="color:black">BIOSDATA:1871                                         </span>; Otherwise, AL &gt; 0
<span style="color:black">BIOSDATA:1873                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:1874                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSDATA:1875                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:1876                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:1877                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:1878                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:1879                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:187A                 </span><span style="color:navy">mov     </span>daycnt2<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:1880                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">4
</span><span style="color:black">BIOSDATA:1882                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - READ DATE FROM REAL TIME CLOCK (AT,XT286,CONV,PS)
<span style="color:black">BIOSDATA:1882                                         </span>; Return: DL = day in BCD
<span style="color:black">BIOSDATA:1882                                         </span>; DH = month in BCD
<span style="color:black">BIOSDATA:1882                                         </span>; CL = year in BCD
<span style="color:black">BIOSDATA:1882                                         </span>; CH = century (19h or 20h)
<span style="color:black">BIOSDATA:1884                 </span><span style="color:navy">jnb     short </span><span style="color:gray">read_ok
</span><span style="color:black">BIOSDATA:1886                 </span><span style="color:navy">jmp     </span><span style="color:gray">r_d_ret
</span><span style="color:black">BIOSDATA:1889 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:1889
BIOSDATA:1889 </span><span style="color:gray">read_ok</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1889                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">, ch
</span><span style="color:black">BIOSDATA:188D                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, cl
</span><span style="color:black">BIOSDATA:1891                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, dh
</span><span style="color:black">BIOSDATA:1895                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3</span><span style="color:navy">, dl
</span><span style="color:black">BIOSDATA:1899                 </span><span style="color:navy">mov     </span>daycnt2<span style="color:navy">, </span><span style="color:#ff8000">2      </span>; READ OF R-T CLOCK SUCCESSFUL
<span style="color:black">BIOSDATA:189F                 </span><span style="color:navy">call    </span>bcd_verify      ; verify bcd values in range
<span style="color:black">BIOSDATA:18A2                 </span><span style="color:navy">jb      short </span><span style="color:gray">r_d_ret   </span>; some value out of range
<span style="color:black">BIOSDATA:18A4                 </span><span style="color:navy">mov     </span>daycnt2<span style="color:navy">, </span><span style="color:#ff8000">3
</span><span style="color:black">BIOSDATA:18AA                 </span><span style="color:navy">call    </span>date_verify
<span style="color:black">BIOSDATA:18AD                 </span><span style="color:navy">jb      short </span><span style="color:gray">r_d_ret
</span><span style="color:black">BIOSDATA:18AF                 </span><span style="color:navy">mov     </span>daycnt2<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:18B5                 </span><span style="color:navy">call    </span>in_bin
<span style="color:black">BIOSDATA:18B8                 </span><span style="color:navy">mov     al, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1
</span><span style="color:black">BIOSDATA:18BB                 </span><span style="color:navy">cbw
</span><span style="color:black">BIOSDATA:18BC                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">, </span><span style="color:green">20 </span>; 20th century?
<span style="color:black">BIOSDATA:18C1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">century_19
</span><span style="color:black">BIOSDATA:18C3                 </span><span style="color:navy">add     ax, </span><span style="color:green">100         </span>; add in a century
<span style="color:black">BIOSDATA:18C6
BIOSDATA:18C6 </span><span style="color:gray">century_19</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:18C6                 </span><span style="color:navy">sub     ax, </span><span style="color:green">80          </span>; subtract off 1-1-80
<span style="color:black">BIOSDATA:18C9                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; leap year every 4
<span style="color:black">BIOSDATA:18CB                 </span><span style="color:navy">div     cl              </span>; al= # leap year blocks, ah= remainder
<span style="color:black">BIOSDATA:18CD                 </span><span style="color:navy">mov     bl, ah          </span>; save odd years
<span style="color:black">BIOSDATA:18CF                 </span><span style="color:navy">cbw                     </span>; zero ah
<span style="color:black">BIOSDATA:18D0                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1461        </span>; 366+(3*365)
<span style="color:black">BIOSDATA:18D0                                         </span>; # of days in leap year blocks
<span style="color:black">BIOSDATA:18D3                 </span><span style="color:navy">mul     cx
</span><span style="color:black">BIOSDATA:18D5                 </span><span style="color:navy">mov     </span>daycnt2<span style="color:navy">, ax     </span>; SAVE COUNT OF DAYS
<span style="color:black">BIOSDATA:18D8                 </span><span style="color:navy">mov     al, bl          </span>; get odd years count
<span style="color:black">BIOSDATA:18DA                 </span><span style="color:navy">cbw
</span><span style="color:black">BIOSDATA:18DB                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">BIOSDATA:18DD                 </span><span style="color:navy">jz      short </span><span style="color:gray">leap_year
</span><span style="color:black">BIOSDATA:18DF                 </span><span style="color:navy">mov     cx, </span><span style="color:green">365         </span>; days in year
<span style="color:black">BIOSDATA:18E2                 </span><span style="color:navy">mul     cx
</span><span style="color:black">BIOSDATA:18E4                 </span><span style="color:navy">add     </span>daycnt2<span style="color:navy">, ax     </span>; ADD ON DAYS IN ODD YEARS
<span style="color:black">BIOSDATA:18E8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">leap_adjustment </span>; account for leap year
<span style="color:black">BIOSDATA:18E8                                         </span>; possibly account for a leap day
<span style="color:black">BIOSDATA:18EA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:18EA
BIOSDATA:18EA </span><span style="color:gray">leap_year</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:18EA                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">2 </span>; is month february?
<span style="color:black">BIOSDATA:18EF                 </span><span style="color:navy">jbe     short </span><span style="color:gray">no_leap_adjustment </span>; jan or feb. no leap day yet
<span style="color:black">BIOSDATA:18F1
BIOSDATA:18F1 </span><span style="color:gray">leap_adjustment</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:18F1                 </span><span style="color:navy">inc     </span>daycnt2         ; account for leap day
<span style="color:black">BIOSDATA:18F5
BIOSDATA:18F5 </span><span style="color:gray">no_leap_adjustment</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:18F5                 </span><span style="color:navy">mov     cl, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3 </span>; get days of month
<span style="color:black">BIOSDATA:18F9                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">BIOSDATA:18FB                 </span><span style="color:navy">dec     cx              </span>; because of offset from day 1, not day 0
<span style="color:black">BIOSDATA:18FC                 </span><span style="color:navy">add     </span>daycnt2<span style="color:navy">, cx     </span>; GET DAYS IN MONTHS PRECEEDING
<span style="color:black">BIOSDATA:1900                 </span><span style="color:navy">mov     cl, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2 </span>; get month
<span style="color:black">BIOSDATA:1904                 </span><span style="color:navy">dec     cx              </span>; january starts at offset 0
<span style="color:black">BIOSDATA:1905                 </span><span style="color:navy">jz      short </span><span style="color:gray">r_d_ret
</span><span style="color:black">BIOSDATA:1907                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:1909                 </span><span style="color:navy">mov     si, offset </span>month_table
<span style="color:black">BIOSDATA:190C
BIOSDATA:190C </span><span style="color:gray">r_d_sum_loop</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:190C                 </span><span style="color:navy">lodsb
</span><span style="color:black">BIOSDATA:190D                 </span><span style="color:navy">add     </span>daycnt2<span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:1911                 </span><span style="color:navy">loop    </span><span style="color:gray">r_d_sum_loop
</span><span style="color:black">BIOSDATA:1913
BIOSDATA:1913 </span><span style="color:gray">r_d_ret</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1913                 </span><span style="color:navy">mov     si, </span>daycnt2
<span style="color:black">BIOSDATA:1917                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:1918                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSDATA:1919                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:191A                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:191B                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:191B </span>read_real_date  <span style="color:black">endp
BIOSDATA:191B
BIOSDATA:191C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:191C </span><span style="color:gray">; START OF FUNCTION CHUNK FOR read_real_time
</span><span style="color:black">BIOSDATA:191C
BIOSDATA:191C </span><span style="color:gray">r_t_retj</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:191C                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">BIOSDATA:191E                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:1920                 </span><span style="color:navy">jmp     short </span><span style="color:gray">r_t_ret
</span><span style="color:black">BIOSDATA:1920 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR read_real_time
</span><span style="color:black">BIOSDATA:1922
BIOSDATA:1922 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:1922
BIOSDATA:1922
BIOSDATA:1922 </span>read_real_time  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1922
BIOSDATA:1922 </span><span style="color:gray">; FUNCTION CHUNK AT BIOSDATA:191C SIZE 00000006 BYTES
</span><span style="color:black">BIOSDATA:1922
BIOSDATA:1922                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">BIOSDATA:1924                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - READ REAL TIME CLOCK (AT,XT286,CONV,PS)
<span style="color:black">BIOSDATA:1924                                         </span>; Return: CH = hours in BCD
<span style="color:black">BIOSDATA:1924                                         </span>; CL = minutes in BCD
<span style="color:black">BIOSDATA:1924                                         </span>; DH = seconds in BCD
<span style="color:black">BIOSDATA:1926                 </span><span style="color:navy">jb      short </span><span style="color:gray">r_t_retj
</span><span style="color:black">BIOSDATA:1928                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">, ch
</span><span style="color:black">BIOSDATA:192C                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, cl
</span><span style="color:black">BIOSDATA:1930                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, dh
</span><span style="color:black">BIOSDATA:1934                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; unused for time
<span style="color:black">BIOSDATA:1939                 </span><span style="color:navy">call    </span>bcd_verify
<span style="color:black">BIOSDATA:193C                 </span><span style="color:navy">jb      short </span><span style="color:gray">r_t_retj
</span><span style="color:black">BIOSDATA:193E                 </span><span style="color:navy">call    </span>time_verify
<span style="color:black">BIOSDATA:1941                 </span><span style="color:navy">jb      short </span><span style="color:gray">r_t_retj
</span><span style="color:black">BIOSDATA:1943                 </span><span style="color:navy">call    </span>in_bin          ; from bcd to bin
<span style="color:black">BIOSDATA:1946                 </span><span style="color:navy">mov     ch, </span>bin_date_time
<span style="color:black">BIOSDATA:194A                 </span><span style="color:navy">mov     cl, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1
</span><span style="color:black">BIOSDATA:194E                 </span><span style="color:navy">mov     dh, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">BIOSDATA:1952                 </span><span style="color:navy">mov     dl, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3
</span><span style="color:black">BIOSDATA:1956                 </span><span style="color:navy">call    dword ptr </span>ttticks ; call far [ttticks]
<span style="color:black">BIOSDATA:1956                                         </span>; note: indirect far call
<span style="color:black">BIOSDATA:1956                                         </span>; cx:dx = number of ticks
<span style="color:black">BIOSDATA:1956                                         </span>; (at 18.2 ticks per sec.)
<span style="color:black">BIOSDATA:195A
BIOSDATA:195A </span><span style="color:gray">r_t_ret</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:195A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:195A </span>read_real_time  <span style="color:black">endp
BIOSDATA:195A
BIOSDATA:195B
BIOSDATA:195B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:195B
BIOSDATA:195B
BIOSDATA:195B </span>in_bin          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:195B                 </span><span style="color:navy">mov     al, </span>bin_date_time ; century or hours
<span style="color:black">BIOSDATA:195E                 </span><span style="color:navy">call    </span>bcd_to_bin
<span style="color:black">BIOSDATA:1961                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">, al
</span><span style="color:black">BIOSDATA:1964                 </span><span style="color:navy">mov     al, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1 </span>; years or minutes
<span style="color:black">BIOSDATA:1967                 </span><span style="color:navy">call    </span>bcd_to_bin
<span style="color:black">BIOSDATA:196A                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, al
</span><span style="color:black">BIOSDATA:196D                 </span><span style="color:navy">mov     al, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2 </span>; months or seconds
<span style="color:black">BIOSDATA:1970                 </span><span style="color:navy">call    </span>bcd_to_bin
<span style="color:black">BIOSDATA:1973                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, al
</span><span style="color:black">BIOSDATA:1976                 </span><span style="color:navy">mov     al, </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3 </span>; days (not used for time)
<span style="color:black">BIOSDATA:1979                 </span><span style="color:navy">call    </span>bcd_to_bin
<span style="color:black">BIOSDATA:197C                 </span><span style="color:navy">mov     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3</span><span style="color:navy">, al
</span><span style="color:black">BIOSDATA:197F                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:197F </span>in_bin          <span style="color:black">endp
BIOSDATA:197F
BIOSDATA:1980
BIOSDATA:1980 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:1980
BIOSDATA:1980
BIOSDATA:1980 </span>bcd_to_bin      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1980                 </span><span style="color:navy">mov     ah, al          </span>; bcd_to_bin converts two bcd nibbles in al
<span style="color:black">BIOSDATA:1980                                         </span>; (value &lt;= 99.) to a binary representation in al
<span style="color:black">BIOSDATA:1982                 </span><span style="color:navy">and     al, </span><span style="color:green">0Fh
</span><span style="color:black">BIOSDATA:1984                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">BIOSDATA:1986                 </span><span style="color:navy">shr     ah, cl
</span><span style="color:black">BIOSDATA:1988                 </span><span style="color:navy">aad
</span><span style="color:black">BIOSDATA:198A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:198A </span>bcd_to_bin      <span style="color:black">endp
BIOSDATA:198A
BIOSDATA:198B
BIOSDATA:198B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:198B
BIOSDATA:198B
BIOSDATA:198B </span>date_verify     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:198B                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">, </span><span style="color:green">20h </span>; century check
<span style="color:black">BIOSDATA:1990                 </span><span style="color:navy">ja      short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:1992                 </span><span style="color:navy">jz      short </span><span style="color:gray">century_20 </span>; jmp in 21th century
<span style="color:black">BIOSDATA:1994                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">, </span><span style="color:green">19h </span>; century check
<span style="color:black">BIOSDATA:1999                 </span><span style="color:navy">jb      short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:199B                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">80h </span>; year check
<span style="color:black">BIOSDATA:19A0                 </span><span style="color:navy">jb      short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:19A2
BIOSDATA:19A2 </span><span style="color:gray">century_20</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:19A2                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">99h </span>; year check
<span style="color:black">BIOSDATA:19A7                 </span><span style="color:navy">ja      short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:19A9                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:green">12h </span>; month check
<span style="color:black">BIOSDATA:19AE                 </span><span style="color:navy">ja      short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:19B0                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:19B5                 </span><span style="color:navy">jbe     short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:19B7                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3</span><span style="color:navy">, </span><span style="color:green">31h </span>; day check
<span style="color:black">BIOSDATA:19BC                 </span><span style="color:navy">ja      short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:19BE                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">3</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:19C3                 </span><span style="color:navy">jbe     short </span><span style="color:gray">date_error
</span><span style="color:black">BIOSDATA:19C5                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSDATA:19C6                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:19C7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:19C7
BIOSDATA:19C7 </span><span style="color:gray">date_error</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:19C7                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSDATA:19C8                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:19C8 </span>date_verify     <span style="color:black">endp
BIOSDATA:19C8
BIOSDATA:19C9
BIOSDATA:19C9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:19C9
BIOSDATA:19C9
BIOSDATA:19C9 </span>time_verify     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:19C9                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">, </span><span style="color:green">24h </span>; hour check
<span style="color:black">BIOSDATA:19CE                 </span><span style="color:navy">ja      short </span><span style="color:gray">time_error
</span><span style="color:black">BIOSDATA:19D0                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">59h </span>; minute check
<span style="color:black">BIOSDATA:19D5                 </span><span style="color:navy">ja      short </span><span style="color:gray">time_error
</span><span style="color:black">BIOSDATA:19D7                 </span><span style="color:navy">cmp     </span>bin_date_time<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:green">59h </span>; second check
<span style="color:black">BIOSDATA:19DC                 </span><span style="color:navy">ja      short </span><span style="color:gray">time_error
</span><span style="color:black">BIOSDATA:19DE                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSDATA:19DF                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:19E0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:19E0
BIOSDATA:19E0 </span><span style="color:gray">time_error</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:19E0                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSDATA:19E1                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:19E1 </span>time_verify     <span style="color:black">endp
BIOSDATA:19E1
BIOSDATA:19E2
BIOSDATA:19E2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:19E2
BIOSDATA:19E2
BIOSDATA:19E2 </span>bcd_verify      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:19E2                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4           </span>; 4 bytes to check
<span style="color:black">BIOSDATA:19E5                 </span><span style="color:navy">mov     bx, offset </span>bin_date_time
<span style="color:black">BIOSDATA:19E8
BIOSDATA:19E8 </span><span style="color:gray">bv_loop</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:19E8                 </span><span style="color:navy">mov     al, [bx]        </span>; get a bcd number (0..99)
<span style="color:black">BIOSDATA:19EA                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">BIOSDATA:19EC                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F00Fh      </span>; 10&#039;s place in high ah, 1&#039;s in al
<span style="color:black">BIOSDATA:19EC                                         </span>; is 1&#039;s place in range?
<span style="color:black">BIOSDATA:19EF                 </span><span style="color:navy">cmp     al, </span><span style="color:green">10
</span><span style="color:black">BIOSDATA:19F1                 </span><span style="color:navy">ja      short </span><span style="color:gray">bv_error  </span>; jmp out of range
<span style="color:black">BIOSDATA:19F3                 </span><span style="color:navy">shr     ah, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:19F5                 </span><span style="color:navy">shr     ah, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:19F7                 </span><span style="color:navy">shr     ah, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:19F9                 </span><span style="color:navy">shr     ah, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:19FB                 </span><span style="color:navy">and     ah, </span><span style="color:green">0Fh         </span>; get rid of any erroneous bits
<span style="color:black">BIOSDATA:19FE                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">10          </span>; is 10&#039;s place in range
<span style="color:black">BIOSDATA:1A01                 </span><span style="color:navy">ja      short </span><span style="color:gray">bv_error  </span>; jmp out of range
<span style="color:black">BIOSDATA:1A03                 </span><span style="color:navy">inc     bx              </span>; next byte
<span style="color:black">BIOSDATA:1A04                 </span><span style="color:navy">dec     cx
</span><span style="color:black">BIOSDATA:1A05                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bv_loop
</span><span style="color:black">BIOSDATA:1A07                 </span><span style="color:navy">clc                     </span>; set success flag
<span style="color:black">BIOSDATA:1A08                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:1A09 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:1A09
BIOSDATA:1A09 </span><span style="color:gray">bv_error</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:1A09                 </span><span style="color:navy">stc                     </span>; set error flag
<span style="color:black">BIOSDATA:1A0A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:1A0A </span>bcd_verify      <span style="color:black">endp
BIOSDATA:1A0A
BIOSDATA:1A0A </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:1A0B </span>endk09          <span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">BIOSDATA:1A0C </span>drvfat          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A0E </span>First_Data_Sector <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A12 </span>doscnt          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A14 </span>fbigfat         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A15 </span>fatloc          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A17 </span>init_bootseg    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A19 </span>rom_drv_num     <span style="color:navy">db </span><span style="color:#008040">80h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A1A </span>md_sectorsize   <span style="color:navy">dw </span><span style="color:#008040">200h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A1C </span>temp_cluster    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A1E </span>last_fat_sec_num <span style="color:navy">dw </span><span style="color:#008040">0FFFFh              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A20 </span>num_heads       <span style="color:navy">dw </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A22 </span>sec_trk         <span style="color:navy">db </span><span style="color:#008040">9                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A23 </span>num_cyln        <span style="color:navy">dw </span><span style="color:#008040">40                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A25 </span>fakefloppydrv   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A26 </span>Orig_Int1Eh_Table <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A26                                         </span>;
<span style="color:gray">BIOSDATA:1A26                                         </span>; 08/08/2023
<span style="color:gray">BIOSDATA:1A26                                         </span>; ; disktable.totalsectors: resd 1
<span style="color:gray">BIOSDATA:1A26                                         </span>; ; disktable.shiftcount:   resb 1
<span style="color:gray">BIOSDATA:1A26                                         </span>; ; disktable.secperclus:   resb 1
<span style="color:gray">BIOSDATA:1A26                                         </span>; ; disktable.rdirentries:  resw 1
<span style="color:gray">BIOSDATA:1A26                                         </span>; ; disktable.bigflag:      resw 1
<span style="color:gray">BIOSDATA:1A2A </span>disktable2      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A2C                 </span><span style="color:navy">dw </span><span style="color:#008040">32680
</span><span style="color:gray">BIOSDATA:1A2E                 </span><span style="color:navy">dw </span><span style="color:#008040">803h
</span><span style="color:gray">BIOSDATA:1A30                 </span><span style="color:navy">dw </span><span style="color:#008040">512
</span><span style="color:gray">BIOSDATA:1A32                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; for compatibility. (32680 sectors, 16340 KB)
<span style="color:gray">BIOSDATA:1A34                 </span><span style="color:navy">dw </span><span style="color:#008040">4
</span><span style="color:gray">BIOSDATA:1A36                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A38                 </span><span style="color:navy">dw </span><span style="color:#008040">402h
</span><span style="color:gray">BIOSDATA:1A3A                 </span><span style="color:navy">dw </span><span style="color:#008040">512
</span><span style="color:gray">BIOSDATA:1A3C                 </span><span style="color:navy">dw </span><span style="color:#008040">40h                  </span>; covers upto 134 mb media. ; fbig = 40h
<span style="color:gray">BIOSDATA:1A3C                                         </span>; (40000h sectors = 128 MB)
<span style="color:gray">BIOSDATA:1A3E                 </span><span style="color:navy">dw </span><span style="color:#008040">8
</span><span style="color:gray">BIOSDATA:1A40                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A42                 </span><span style="color:navy">dw </span><span style="color:#008040">803h
</span><span style="color:gray">BIOSDATA:1A44                 </span><span style="color:navy">dw </span><span style="color:#008040">512
</span><span style="color:gray">BIOSDATA:1A46                 </span><span style="color:navy">dw </span><span style="color:#008040">40h                  </span>; upto 268 mb (80000h sectors = 256 MB)
<span style="color:gray">BIOSDATA:1A48                 </span><span style="color:navy">dw </span><span style="color:#008040">16
</span><span style="color:gray">BIOSDATA:1A4A                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A4C                 </span><span style="color:navy">dw </span><span style="color:#008040">1004h
</span><span style="color:gray">BIOSDATA:1A4E                 </span><span style="color:navy">dw </span><span style="color:#008040">512
</span><span style="color:gray">BIOSDATA:1A50                 </span><span style="color:navy">dw </span><span style="color:#008040">40h                  </span>; upto 536 mb (100000h sectors = 512 MB)
<span style="color:gray">BIOSDATA:1A52                 </span><span style="color:navy">dw </span><span style="color:#008040">32
</span><span style="color:gray">BIOSDATA:1A54                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A56                 </span><span style="color:navy">dw </span><span style="color:#008040">2005h
</span><span style="color:gray">BIOSDATA:1A58                 </span><span style="color:navy">dw </span><span style="color:#008040">512
</span><span style="color:gray">BIOSDATA:1A5A                 </span><span style="color:navy">dw </span><span style="color:#008040">40h                  </span>; upto 1072 mb (200000h sectors = 1024 MB)
<span style="color:gray">BIOSDATA:1A5C                 </span><span style="color:navy">dw </span><span style="color:#008040">64
</span><span style="color:gray">BIOSDATA:1A5E                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A60                 </span><span style="color:navy">dw </span><span style="color:#008040">4006h
</span><span style="color:gray">BIOSDATA:1A62                 </span><span style="color:navy">dw </span><span style="color:#008040">512
</span><span style="color:gray">BIOSDATA:1A64                 </span><span style="color:navy">dw </span><span style="color:#008040">40h                  </span>; upto 2144 mb (400000h sectors = 2048 MB)
<span style="color:gray">BIOSDATA:1A66                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; if fs size &gt; 2144 MB, it is FAT32 file system
<span style="color:gray">BIOSDATA:1A68                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">BIOSDATA:1A6A                 </span><span style="color:navy">dw </span><span style="color:#008040">803h                 </span>; cluster shift 3, sec per clust = 8
<span style="color:gray">BIOSDATA:1A6C                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A6E                 </span><span style="color:navy">dw </span><span style="color:#008040">60h                  </span>; &gt; 2144 MB ; FAT32 (fbigbig = 20h)
<span style="color:gray">BIOSDATA:1A6E                                         </span>; (fbig and fbigbig flags are set)
<span style="color:gray">BIOSDATA:1A6E                                         </span>; ;
<span style="color:gray">BIOSDATA:1A70 </span>rom_minidisk_num <span style="color:navy">db </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A71 </span>hnum            <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A72 </span>last_dskdrv_table <span style="color:navy">dw offset </span>dskdrvs     <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A74 </span>end_of_bdss     <span style="color:navy">dw offset </span>bdss          <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A76 </span>mini_hdlim      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A78 </span>mini_seclim     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A7A </span>ld_p_number     <span style="color:navy">dw </span><span style="color:#008040">2BADh                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A7C </span>bios_date       <span style="color:navy">db &#039;01/10/84&#039;,0         </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A85                 </span><span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">BIOSDATA:1A86 </span>bpb48t          <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1A88                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1A89                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:1A8B                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1A8C                 </span><span style="color:navy">dw </span><span style="color:#008040">112
</span><span style="color:gray">BIOSDATA:1A8E                 </span><span style="color:navy">dw </span><span style="color:#008040">720
</span><span style="color:olive">BIOSDATA:1A90                 </span><span style="color:navy">db </span><span style="color:#008040">0FDh
</span><span style="color:gray">BIOSDATA:1A91                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1A93                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">BIOSDATA:1A95                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1A97                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A99                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A9B                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A9D                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1A9F                 </span><span style="color:navy">db </span><span style="color:#008040">28 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span>; FAT32 extensions (to BDS)
<span style="color:gray">BIOSDATA:1ABB                 </span><span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">BIOSDATA:1ABC </span>bpb96t          <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1ABE                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:1ABF                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:1AC1                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1AC2                 </span><span style="color:navy">dw </span><span style="color:#008040">224
</span><span style="color:gray">BIOSDATA:1AC4                 </span><span style="color:navy">dw </span><span style="color:#008040">2400
</span><span style="color:gray">BIOSDATA:1AC6                 </span><span style="color:navy">db </span><span style="color:#008040">0F9h
</span><span style="color:gray">BIOSDATA:1AC7                 </span><span style="color:navy">dw </span><span style="color:#008040">7
</span><span style="color:gray">BIOSDATA:1AC9                 </span><span style="color:navy">dw </span><span style="color:#008040">15
</span><span style="color:gray">BIOSDATA:1ACB                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1ACD                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1ACF                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1AD1                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1AD2                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1AD3                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1AD4                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1AD5                 </span><span style="color:navy">db </span><span style="color:#008040">28 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:1AF1                 </span><span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">BIOSDATA:1AF2 </span>bpb35           <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1AF4                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1AF5                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:1AF7                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1AF8                 </span><span style="color:navy">dw </span><span style="color:#008040">112
</span><span style="color:gray">BIOSDATA:1AFA                 </span><span style="color:navy">dw </span><span style="color:#008040">1440
</span><span style="color:gray">BIOSDATA:1AFC                 </span><span style="color:navy">db </span><span style="color:#008040">0F9h
</span><span style="color:gray">BIOSDATA:1AFD                 </span><span style="color:navy">dw </span><span style="color:#008040">3
</span><span style="color:gray">BIOSDATA:1AFF                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">BIOSDATA:1B01                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1B03                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1B05                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1B07                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1B0B                 </span><span style="color:navy">db </span><span style="color:#008040">28 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:1B27                 </span><span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">BIOSDATA:1B28 </span>bpb288          <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1B2A                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1B2B                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">BIOSDATA:1B2D                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1B2E                 </span><span style="color:navy">dw </span><span style="color:#008040">240
</span><span style="color:gray">BIOSDATA:1B30                 </span><span style="color:navy">dw </span><span style="color:#008040">5760
</span><span style="color:gray">BIOSDATA:1B32                 </span><span style="color:navy">db </span><span style="color:#008040">0F0h
</span><span style="color:gray">BIOSDATA:1B33                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">BIOSDATA:1B35                 </span><span style="color:navy">dw </span><span style="color:#008040">36
</span><span style="color:gray">BIOSDATA:1B37                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">BIOSDATA:1B39                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1B3B                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1B3D                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">BIOSDATA:1B41                 </span><span style="color:navy">db </span><span style="color:#008040">28 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:1B5D                 </span><span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">BIOSDATA:1B5E </span>bpbtable        <span style="color:navy">dw offset </span>bpb48t        <span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1B60                 </span><span style="color:navy">dw offset </span>bpb96t
<span style="color:gray">BIOSDATA:1B62                 </span><span style="color:navy">dw offset </span>bpb35
<span style="color:gray">BIOSDATA:1B64                 </span><span style="color:navy">dw offset </span>bpb35
<span style="color:gray">BIOSDATA:1B66                 </span><span style="color:navy">dw offset </span>bpb35
<span style="color:gray">BIOSDATA:1B68                 </span><span style="color:navy">dw offset </span>bpb35
<span style="color:gray">BIOSDATA:1B6A                 </span><span style="color:navy">dw offset </span>bpb35
<span style="color:gray">BIOSDATA:1B6C                 </span><span style="color:navy">dw offset </span>bpb35
<span style="color:gray">BIOSDATA:1B6E                 </span><span style="color:navy">dw offset </span>bpb35
<span style="color:gray">BIOSDATA:1B70                 </span><span style="color:navy">dw offset </span>bpb288
<span style="color:gray">BIOSDATA:1B72 </span>addr_of_bcretf  <span style="color:navy">dw offset </span>bc_retf       <span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:1B74 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1B74
BIOSDATA:1B74 </span>call_bios_code<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1B74                 </span><span style="color:navy">push    cs:</span>addr_of_bcretf ; set up near return to far return
<span style="color:maroon">BIOSDATA:1B79                 </span><span style="color:navy">push    cs:</span>cdev_2       ; [cs:cdev+2] ; push Bios_Code segment
<span style="color:maroon">BIOSDATA:1B7E                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">BIOSDATA:1B7F                 </span><span style="color:navy">retf
</span><span style="color:maroon">BIOSDATA:1B7F </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:1B80 </span>flp_drvs        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1B81 </span>firstcluster_hw <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1B83 </span>Boot_Drv        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSDATA:1B84 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1B84
BIOSDATA:1B84 </span>cd_boot_option<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1B84                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:1B85                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:1B86                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:1B87                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:1B88
BIOSDATA:1B88 </span>cdbo_1<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1B88                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1B8A                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD -
<span style="color:maroon">BIOSDATA:1B8C                 </span><span style="color:navy">jz      short </span>cdbo_2
<span style="color:maroon">BIOSDATA:1B8E                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">BIOSDATA:1B90                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
<span style="color:maroon">BIOSDATA:1B90                                         </span>; Return: AH = scan code, AL = character
<span style="color:maroon">BIOSDATA:1B92                 </span><span style="color:navy">jmp     short </span>cdbo_1
<span style="color:maroon">BIOSDATA:1B94 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1B94
BIOSDATA:1B94 </span>cdbo_2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1B94                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1B95                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1B96                 </span><span style="color:navy">mov     si, offset </span>cd_boot_msg <span style="color:gray">; &quot;\r\nPress the ENTER key to boot from CD&quot;...
</span><span style="color:maroon">BIOSDATA:1B99                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">BIOSDATA:1B9A
BIOSDATA:1B9A </span>cdbo_3<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1B9A                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">7
</span><span style="color:maroon">BIOSDATA:1B9D                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:maroon">BIOSDATA:1B9F                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1B9F                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1B9F                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1BA1                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">BIOSDATA:1BA2                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">BIOSDATA:1BA4                 </span><span style="color:navy">jnz     short </span>cdbo_3
<span style="color:maroon">BIOSDATA:1BA6                 </span><span style="color:navy">mov     ax, </span><span style="color:green">40h
</span><span style="color:maroon">BIOSDATA:1BA9                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:1BAB                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1BAB                 </span><span style="color:navy">mov     bx, </span>ds:6Ch      ; 0:46Ch = Daily timer counter (4 bytes)
<span style="color:maroon">BIOSDATA:1BAF                 </span><span style="color:navy">mov     si, </span>ds:6Eh
<span style="color:maroon">BIOSDATA:1BB3
BIOSDATA:1BB3 </span>wait_for_key<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1BB3                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:1BB4                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">7
</span><span style="color:maroon">BIOSDATA:1BB7                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0E08h
</span><span style="color:maroon">BIOSDATA:1BBA                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1BBA                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1BBA                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1BBC                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0E20h
</span><span style="color:maroon">BIOSDATA:1BBF                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1BBF                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1BBF                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1BC1                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0E08h
</span><span style="color:maroon">BIOSDATA:1BC4                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1BC4                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1BC4                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1BC6                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:1BC7                 </span><span style="color:navy">add     bx, </span><span style="color:green">18          </span>; 18.2 ticks per second
<span style="color:maroon">BIOSDATA:1BCA                 </span><span style="color:navy">adc     si, </span><span style="color:#ff8000">0           </span>; next second (if carry flag is 1)
<span style="color:maroon">BIOSDATA:1BCD
BIOSDATA:1BCD </span>continue_to_wait<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1BCD                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1BCF                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD -
<span style="color:maroon">BIOSDATA:1BD1                 </span><span style="color:navy">jz      short </span>cdbo_5
<span style="color:maroon">BIOSDATA:1BD3                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:1BD5                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
<span style="color:maroon">BIOSDATA:1BD5                                         </span>; Return: AH = scan code, AL = character
<span style="color:maroon">BIOSDATA:1BD7                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">11Bh
</span><span style="color:maroon">BIOSDATA:1BDA                 </span><span style="color:navy">jz      short </span>cdb0_7
<span style="color:maroon">BIOSDATA:1BDC
BIOSDATA:1BDC </span>cdbo_4<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1BDC                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">7
</span><span style="color:maroon">BIOSDATA:1BDF                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0E0Dh
</span><span style="color:maroon">BIOSDATA:1BE2                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1BE2                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1BE2                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1BE4                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0E0Ah
</span><span style="color:maroon">BIOSDATA:1BE7                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1BE7                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1BE7                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1BE9                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:1BEA                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:1BEB                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1BEC                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1BEC                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:1BED                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSDATA:1BEE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1BEE
BIOSDATA:1BEE </span>cdbo_5<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1BEE                 </span><span style="color:navy">cmp     si, ds:</span><span style="color:green">6Eh
</span><span style="color:maroon">BIOSDATA:1BF2                 </span><span style="color:navy">jnz     short </span>cdb0_6
<span style="color:maroon">BIOSDATA:1BF4                 </span><span style="color:navy">cmp     bx, ds:</span><span style="color:green">6Ch
</span><span style="color:maroon">BIOSDATA:1BF8
BIOSDATA:1BF8 </span>cdb0_6<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1BF8                 </span><span style="color:navy">jnb     short </span>continue_to_wait
<span style="color:maroon">BIOSDATA:1BFA                 </span><span style="color:navy">dec     cs:</span>time_counter
<span style="color:maroon">BIOSDATA:1BFF                 </span><span style="color:navy">jnz     short </span>wait_for_key
<span style="color:maroon">BIOSDATA:1C01
BIOSDATA:1C01 </span>cdb0_7<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1C01                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">7
</span><span style="color:maroon">BIOSDATA:1C04                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0E0Dh
</span><span style="color:maroon">BIOSDATA:1C07                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1C07                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1C07                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1C09                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0E0Ah
</span><span style="color:maroon">BIOSDATA:1C0C                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1C0C                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1C0C                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1C0E                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1C0F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1C10                 </span>assume ds:BIOSDATA
<span style="color:maroon">BIOSDATA:1C10                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4B00h
</span><span style="color:maroon">BIOSDATA:1C13                 </span><span style="color:navy">xor     dl, dl          </span>; disk drive = 0 (fd)
<span style="color:maroon">BIOSDATA:1C15                 </span><span style="color:navy">mov     si, offset </span>empty_dap_buff
<span style="color:maroon">BIOSDATA:1C18                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - Bootable CD-ROM - AL = TERMINATE DISK EMULATION
<span style="color:maroon">BIOSDATA:1C1A                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">80h         </span>; DS:SI = Specification packet filled
<span style="color:maroon">BIOSDATA:1C1D                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:1C1F                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">13h
</span><span style="color:maroon">BIOSDATA:1C22                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1</span><span style="color:navy">], al
</span><span style="color:maroon">BIOSDATA:1C25                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], dx
</span><span style="color:maroon">BIOSDATA:1C28                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSDATA:1C2B                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSDATA:1C2E                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">8</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSDATA:1C31                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSDATA:1C34                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSDATA:1C37                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSDATA:1C3A                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">], al
</span><span style="color:maroon">BIOSDATA:1C3D                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">11h</span><span style="color:navy">], al
</span><span style="color:maroon">BIOSDATA:1C40                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">12h</span><span style="color:navy">], al
</span><span style="color:maroon">BIOSDATA:1C43                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4B00h       </span>; disk drive = 80h (hd)
<span style="color:maroon">BIOSDATA:1C46                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - Bootable CD-ROM - AL = TERMINATE DISK EMULATION
<span style="color:maroon">BIOSDATA:1C48                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:1C4A                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">BIOSDATA:1C4D                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - RESET DISK SYSTEM
<span style="color:maroon">BIOSDATA:1C4D                                         </span>; DL = drive (if bit 7 is set both hard disks and floppy disks reset)
<span style="color:maroon">BIOSDATA:1C4F                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1C50                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:1C51                 </span>assume es:BIOSDATA
<span style="color:maroon">BIOSDATA:1C51                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h
</span><span style="color:maroon">BIOSDATA:1C54                 </span><span style="color:navy">mov     bx, offset </span>disksector
<span style="color:maroon">BIOSDATA:1C57                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1C5A                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">BIOSDATA:1C5D                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - READ SECTORS INTO MEMORY
<span style="color:maroon">BIOSDATA:1C5D                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:maroon">BIOSDATA:1C5D                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:maroon">BIOSDATA:1C5D                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:maroon">BIOSDATA:1C5F                 </span><span style="color:navy">jb      short </span>cdbo_8
<span style="color:maroon">BIOSDATA:1C61                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:#ff8000">1FEh</span><span style="color:navy">], </span><span style="color:green">0AA55h
</span><span style="color:maroon">BIOSDATA:1C68                 </span><span style="color:navy">jz      short </span>cdbo_9
<span style="color:maroon">BIOSDATA:1C6A
BIOSDATA:1C6A </span>cdbo_8<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1C6A                 </span><span style="color:navy">jmp     </span>cdbo_4
<span style="color:maroon">BIOSDATA:1C6D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1C6D
BIOSDATA:1C6D </span>cdbo_9<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1C6D                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1C6E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1C6F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:1C71                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">7C00h
</span><span style="color:maroon">BIOSDATA:1C74                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">BIOSDATA:1C76                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:1C76                 </span><span style="color:navy">mov     si, bx
</span><span style="color:maroon">BIOSDATA:1C78                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:1C79                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:1C7A                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">100h        </span>; 256
<span style="color:maroon">BIOSDATA:1C7D                 </span><span style="color:navy">cld
</span><span style="color:maroon">BIOSDATA:1C7E                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">BIOSDATA:1C80                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:1C82                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1C82                 </span><span style="color:navy">mov     si, </span><span style="color:green">78h
</span><span style="color:maroon">BIOSDATA:1C85                 </span><span style="color:navy">mov     ax, cs:</span>Orig_Int1Eh_Table
<span style="color:maroon">BIOSDATA:1C89                 </span><span style="color:navy">mov     [si], ax
</span><span style="color:maroon">BIOSDATA:1C8B                 </span><span style="color:navy">mov     ax, cs:</span>Orig_Int1Eh_Table<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">BIOSDATA:1C8F                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSDATA:1C92                 </span><span style="color:navy">retf
</span><span style="color:maroon">BIOSDATA:1C92 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:1C93 </span>empty_dap_buff  <span style="color:navy">db </span><span style="color:#008040">19                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1C94                 </span><span style="color:navy">db </span><span style="color:#008040">18 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSDATA:1CA6 </span>time_counter    <span style="color:navy">db </span><span style="color:#008040">5                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1CA6                                         </span>; 5 seconds
<span style="color:gray">BIOSDATA:1CA7 </span>cd_boot_msg     <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:1CA7                 </span><span style="color:navy">db &#039;Press the ENTER key to boot from CD or DVD......&#039;,0
</span><span style="color:maroon">BIOSDATA:1CDA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1CDA
BIOSDATA:1CDA </span>init<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1CDA                 </span><span style="color:navy">cli
</span><span style="color:maroon">BIOSDATA:1CDB                 </span><span style="color:navy">mov     cs:</span>Orig_Int1Eh_Table<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds </span>; DS:SI from MSLOAD (not boot sector)
<span style="color:maroon">BIOSDATA:1CE0                 </span><span style="color:navy">mov     cs:</span>Orig_Int1Eh_Table<span style="color:navy">, si
</span><span style="color:maroon">BIOSDATA:1CE5                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:1CE6                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:1CE8                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:1CEA                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:1CEB                 </span><span style="color:navy">mov     cs:</span>First_Data_Sector<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax </span>; AX:BX from MSLOAD
<span style="color:maroon">BIOSDATA:1CEF                 </span><span style="color:navy">mov     cs:</span>First_Data_Sector<span style="color:navy">, bx
</span><span style="color:maroon">BIOSDATA:1CF4                 </span><span style="color:navy">mov     cs:</span>Boot_Drv<span style="color:navy">, dl </span>; Boot Drive from MSLOAD ;;; [BootDrive]
<span style="color:maroon">BIOSDATA:1CF9                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1CFA                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:1CFB                 </span>assume es:BIOSDATA
<span style="color:maroon">BIOSDATA:1CFB                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:1CFC                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:1CFD                 </span><span style="color:navy">cld
</span><span style="color:maroon">BIOSDATA:1CFE                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:1CFF                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">544h        </span>; SYSINIT segment
<span style="color:maroon">BIOSDATA:1CFF                                         </span>; SYSINITSEG (= IOSYSCODESEG+(SYSINITOFFSET&gt;&gt;4)
<span style="color:maroon">BIOSDATA:1D02                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">BIOSDATA:1D04                 </span><span style="color:navy">mov     ds, si          </span>; check (1st sector) of the root directory -of BOOT CD-
<span style="color:maroon">BIOSDATA:1D04                                         </span>; for special names (as boot option signature)
<span style="color:maroon">BIOSDATA:1D06                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">540h        </span>; ROOT DIRECTORY BUFFER offset 40h
<span style="color:maroon">BIOSDATA:1D06                                         </span>; (BOOT DRV&#039;s root directory the 3rd entry)
<span style="color:maroon">BIOSDATA:1D09
BIOSDATA:1D09 </span>chk_boot_hdnoz<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D09                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:1D0C                 </span><span style="color:navy">jz      short </span>chk_no_logo_noz
<span style="color:maroon">BIOSDATA:1D0E                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:green">425Fh </span>; &#039;_BOOT_HDNOZ&#039;
<span style="color:maroon">BIOSDATA:1D12                 </span><span style="color:navy">jnz     short </span>chk_next_1
<span style="color:maroon">BIOSDATA:1D14                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">4F4Fh </span>; &#039;OO&#039;
<span style="color:maroon">BIOSDATA:1D19                 </span><span style="color:navy">jnz     short </span>chk_next_1
<span style="color:maroon">BIOSDATA:1D1B                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">5F54h
</span><span style="color:maroon">BIOSDATA:1D20                 </span><span style="color:navy">jnz     short </span>chk_next_1
<span style="color:maroon">BIOSDATA:1D22                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">4448h </span>; &#039;HD&#039;
<span style="color:maroon">BIOSDATA:1D27                 </span><span style="color:navy">jnz     short </span>chk_next_1
<span style="color:maroon">BIOSDATA:1D29                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:green">4F4Eh
</span><span style="color:maroon">BIOSDATA:1D2E                 </span><span style="color:navy">jnz     short </span>chk_next_1
<span style="color:maroon">BIOSDATA:1D30                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], </span><span style="color:green">5Ah </span>; &#039;Z&#039;
<span style="color:maroon">BIOSDATA:1D34                 </span><span style="color:navy">jnz     short </span>chk_next_1
<span style="color:maroon">BIOSDATA:1D36                 </span><span style="color:navy">call    </span>cd_boot_option
<span style="color:maroon">BIOSDATA:1D39                 </span><span style="color:navy">jmp     short </span>chk_no_logo_noz
<span style="color:maroon">BIOSDATA:1D3B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1D3B
BIOSDATA:1D3B </span>chk_next_1<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D3B                 </span><span style="color:navy">add     si, </span><span style="color:green">32          </span>; (next entry)
<span style="color:maroon">BIOSDATA:1D3E                 </span><span style="color:navy">cmp     si, </span><span style="color:#ff8000">700h
</span><span style="color:maroon">BIOSDATA:1D42                 </span><span style="color:navy">jb      short </span>chk_boot_hdnoz
<span style="color:maroon">BIOSDATA:1D44
BIOSDATA:1D44 </span>chk_no_logo_noz<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D44                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">540h        </span>; (BOOT DRV&#039;s root directory the 3rd entry)
<span style="color:maroon">BIOSDATA:1D47
BIOSDATA:1D47 </span>chk_no_logo_noz2_nxt<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D47                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:1D4A                 </span><span style="color:navy">jz      short </span>write_start_msg
<span style="color:maroon">BIOSDATA:1D4C                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:green">4F4Eh </span>; &#039;NO_LOGO NOZ&#039;
<span style="color:maroon">BIOSDATA:1D50                 </span><span style="color:navy">jnz     short </span>chk_next_2
<span style="color:maroon">BIOSDATA:1D52                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">4C5Fh
</span><span style="color:maroon">BIOSDATA:1D57                 </span><span style="color:navy">jnz     short </span>chk_next_2
<span style="color:maroon">BIOSDATA:1D59                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">474Fh
</span><span style="color:maroon">BIOSDATA:1D5E                 </span><span style="color:navy">jnz     short </span>chk_next_2
<span style="color:maroon">BIOSDATA:1D60                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">204Fh
</span><span style="color:maroon">BIOSDATA:1D65                 </span><span style="color:navy">jnz     short </span>chk_next_2
<span style="color:maroon">BIOSDATA:1D67                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:green">4F4Eh
</span><span style="color:maroon">BIOSDATA:1D6C                 </span><span style="color:navy">jnz     short </span>chk_next_2
<span style="color:maroon">BIOSDATA:1D6E                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], </span><span style="color:green">5Ah
</span><span style="color:maroon">BIOSDATA:1D72                 </span><span style="color:navy">jz      short </span>startmsg_ok
<span style="color:maroon">BIOSDATA:1D74
BIOSDATA:1D74 </span>chk_next_2<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D74                 </span><span style="color:navy">add     si, </span><span style="color:green">32          </span>; (next entry)
<span style="color:maroon">BIOSDATA:1D77                 </span><span style="color:navy">cmp     si, </span><span style="color:#ff8000">700h
</span><span style="color:maroon">BIOSDATA:1D7B                 </span><span style="color:navy">jb      short </span>chk_no_logo_noz2_nxt
<span style="color:maroon">BIOSDATA:1D7D
BIOSDATA:1D7D </span>write_start_msg<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D7D                 </span><span style="color:navy">mov     ds, ax          </span>; SYSINIT segment
<span style="color:maroon">BIOSDATA:1D7F                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1D7F                 </span><span style="color:navy">mov     si, offset </span>StartMsg <span style="color:gray">; &quot;Starting PC DOS...\r\n\n&quot;
</span><span style="color:maroon">BIOSDATA:1D82
BIOSDATA:1D82 </span>startmsg_nxt_chr<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D82                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">BIOSDATA:1D83                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">BIOSDATA:1D85                 </span><span style="color:navy">jz      short </span>startmsg_ok
<span style="color:maroon">BIOSDATA:1D87                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:maroon">BIOSDATA:1D89                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">7
</span><span style="color:maroon">BIOSDATA:1D8C                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">BIOSDATA:1D8C                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">BIOSDATA:1D8C                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">BIOSDATA:1D8E                 </span><span style="color:navy">jmp     short </span>startmsg_nxt_chr
<span style="color:maroon">BIOSDATA:1D90 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1D90
BIOSDATA:1D90 </span>startmsg_ok<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D90                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1D91                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:maroon">BIOSDATA:1D94                 </span><span style="color:navy">mov     si, offset </span>RomVectors
<span style="color:maroon">BIOSDATA:1D97
BIOSDATA:1D97 </span>next_int<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1D97                 </span><span style="color:navy">lods    byte ptr cs:[si]
</span><span style="color:maroon">BIOSDATA:1D99                 </span><span style="color:navy">cbw
</span><span style="color:maroon">BIOSDATA:1D9A                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1D9C                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1D9E                 </span><span style="color:navy">mov     di, ax
</span><span style="color:maroon">BIOSDATA:1DA0                 </span><span style="color:navy">xchg    si, di
</span><span style="color:maroon">BIOSDATA:1DA2                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">BIOSDATA:1DA3                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:1DA4                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">BIOSDATA:1DA5                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:1DA6                 </span><span style="color:navy">xchg    si, di
</span><span style="color:maroon">BIOSDATA:1DA8                 </span><span style="color:navy">loop    </span>next_int
<span style="color:maroon">BIOSDATA:1DAA                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:1DAB                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:1DAC                 </span><span style="color:navy">mov     ax, word ptr cs:</span>Old13
<span style="color:maroon">BIOSDATA:1DB0                 </span><span style="color:navy">mov     word ptr cs:</span>Orig13<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1DB4                 </span><span style="color:navy">mov     ax, word ptr cs:</span>Old13<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">BIOSDATA:1DB8                 </span><span style="color:navy">mov     word ptr cs:</span>Orig13<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1DBC                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">4Ch</span><span style="color:navy">, offset </span>block13
<span style="color:maroon">BIOSDATA:1DC2                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">4Eh</span><span style="color:navy">, cs
</span><span style="color:maroon">BIOSDATA:1DC6                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">68h
</span><span style="color:maroon">BIOSDATA:1DC9                 </span><span style="color:navy">mov     word ptr cs:</span>Orig1A<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1DCD                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">6Ah
</span><span style="color:maroon">BIOSDATA:1DD0                 </span><span style="color:navy">mov     word ptr cs:</span>Orig1A<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1DD4                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">68h</span><span style="color:navy">, offset </span>Int1A
<span style="color:maroon">BIOSDATA:1DDA                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">6Ah</span><span style="color:navy">, cs
</span><span style="color:maroon">BIOSDATA:1DDE                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">54h</span><span style="color:navy">, offset </span>Int15
<span style="color:maroon">BIOSDATA:1DE4                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">56h</span><span style="color:navy">, cs
</span><span style="color:maroon">BIOSDATA:1DE8                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">64h</span><span style="color:navy">, offset </span>int19
<span style="color:maroon">BIOSDATA:1DEE                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">66h</span><span style="color:navy">, cs </span>; 19h*4+2
<span style="color:maroon">BIOSDATA:1DF2                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSDATA:1DF3                 </span><span style="color:navy">int     </span><span style="color:green">11h             </span>; EQUIPMENT DETERMINATION
<span style="color:maroon">BIOSDATA:1DF3                                         </span>; Return: AX = equipment flag bits
<span style="color:maroon">BIOSDATA:1DF5                 </span><span style="color:navy">jmp     short </span>chk_fd_count
<span style="color:maroon">BIOSDATA:1DF7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1DF7                 </span><span style="color:navy">push    dx              </span>; 52h ; &#039;R&#039;
<span style="color:maroon">BIOSDATA:1DF8                 </span><span style="color:navy">push    ax              </span>; 50h ; &#039;P&#039;
<span style="color:maroon">BIOSDATA:1DF9                 </span><span style="color:navy">push    bx              </span>; 53h ; &#039;S&#039;
<span style="color:maroon">BIOSDATA:1DFA
BIOSDATA:1DFA </span>chk_fd_count<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1DFA                 </span><span style="color:navy">or      ax, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1DFD                 </span><span style="color:navy">test    ax, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1E00                 </span><span style="color:navy">jnz     short </span>normalfloppydrv
<span style="color:maroon">BIOSDATA:1E02                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:1E03                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:1E04                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:1E05                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:1E06                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:1E07                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:1E08                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">8
</span><span style="color:maroon">BIOSDATA:1E0A                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:1E0C                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
<span style="color:maroon">BIOSDATA:1E0C                                         </span>; DL = drive number
<span style="color:maroon">BIOSDATA:1E0C                                         </span>; Return: CF set on error, AH = status code, BL = drive type
<span style="color:maroon">BIOSDATA:1E0C                                         </span>; DL = number of consecutive drives
<span style="color:maroon">BIOSDATA:1E0C                                         </span>; DH = maximum value for head number, ES:DI -&gt; drive parameter
<span style="color:maroon">BIOSDATA:1E0E                 </span><span style="color:navy">jb      short </span>_gdskp_error
<span style="color:maroon">BIOSDATA:1E10                 </span><span style="color:navy">mov     cs:</span>flp_drvs<span style="color:navy">, dl
</span><span style="color:maroon">BIOSDATA:1E15
BIOSDATA:1E15 </span>_gdskp_error<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E15                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:1E16                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:1E16                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:1E17                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:1E18                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:1E19                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:1E1A                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:1E1B                 </span><span style="color:navy">jb      short </span>normalfloppydrv
<span style="color:maroon">BIOSDATA:1E1D                 </span><span style="color:navy">cmp     cs:</span>flp_drvs<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:1E23                 </span><span style="color:navy">jz      short </span>_set_fake_flpdrv
<span style="color:maroon">BIOSDATA:1E25                 </span><span style="color:navy">mov     al, cs:</span>flp_drvs
<span style="color:maroon">BIOSDATA:1E29                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">BIOSDATA:1E2B                 </span><span style="color:navy">jmp     short </span>got_num_flp_drvs
<span style="color:maroon">BIOSDATA:1E2D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1E2D
BIOSDATA:1E2D </span>_set_fake_flpdrv<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E2D                 </span><span style="color:navy">mov     cs:</span>fakefloppydrv<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1E33                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1E36                 </span><span style="color:navy">jmp     short </span>settwodrive
<span style="color:maroon">BIOSDATA:1E38 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1E38
BIOSDATA:1E38 </span>normalfloppydrv<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E38                 </span><span style="color:navy">rol     al, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1E3A                 </span><span style="color:navy">rol     al, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1E3C
BIOSDATA:1E3C </span>got_num_flp_drvs<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E3C                 </span><span style="color:navy">and     ax, </span><span style="color:green">3
</span><span style="color:maroon">BIOSDATA:1E3F                 </span><span style="color:navy">jnz     short </span>notsingle
<span style="color:maroon">BIOSDATA:1E41                 </span><span style="color:navy">inc     ax
</span><span style="color:maroon">BIOSDATA:1E42
BIOSDATA:1E42 </span>settwodrive<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E42                 </span><span style="color:navy">inc     cs:</span>single
<span style="color:maroon">BIOSDATA:1E47
BIOSDATA:1E47 </span>notsingle<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E47                 </span><span style="color:navy">inc     ax
</span><span style="color:maroon">BIOSDATA:1E48                 </span><span style="color:navy">mov     cl, al
</span><span style="color:maroon">BIOSDATA:1E4A                 </span><span style="color:navy">test    dl, </span><span style="color:green">80h
</span><span style="color:maroon">BIOSDATA:1E4D                 </span><span style="color:navy">jnz     short </span>gothrd
<span style="color:maroon">BIOSDATA:1E4F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:1E51                 </span><span style="color:navy">mov     cs:</span>Boot_Drv<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:1E55
BIOSDATA:1E55 </span>gothrd<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E55                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">BIOSDATA:1E57                 </span><span style="color:navy">cli
</span><span style="color:maroon">BIOSDATA:1E58                 </span><span style="color:navy">mov     ss, dx
</span><span style="color:maroon">BIOSDATA:1E5A                 </span>assume ss:nothing
<span style="color:maroon">BIOSDATA:1E5A                 </span><span style="color:navy">mov     sp, </span><span style="color:#ff8000">700h
</span><span style="color:maroon">BIOSDATA:1E5D                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSDATA:1E5E                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:1E5F                 </span><span style="color:navy">mov     ah, ch          </span>; [MediaByte]
<span style="color:maroon">BIOSDATA:1E61                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:1E62                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0C0h
</span><span style="color:maroon">BIOSDATA:1E64                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; SYSTEM - GET CONFIGURATION (XT after 1/10/86,AT mdl 3x9,CONV,XT286,PS)
<span style="color:maroon">BIOSDATA:1E66                 </span><span style="color:navy">jb      short </span>no_rom_system_conf
<span style="color:maroon">BIOSDATA:1E68                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:1E6B                 </span><span style="color:navy">jnz     short </span>no_rom_system_conf
<span style="color:maroon">BIOSDATA:1E6D                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:1E71                 </span><span style="color:navy">mov     cs:</span>model_byte<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:1E75                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:1E79                 </span><span style="color:navy">mov     cs:</span>secondary_model_byte<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:1E7D                 </span><span style="color:navy">jmp     short </span>turn_timer_on
<span style="color:maroon">BIOSDATA:1E7F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:1E7F
BIOSDATA:1E7F </span>no_rom_system_conf<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E7F                 </span><span style="color:navy">mov     si, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">BIOSDATA:1E82                 </span><span style="color:navy">mov     es, si
</span><span style="color:maroon">BIOSDATA:1E84                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:1E84                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0Eh
</span><span style="color:maroon">BIOSDATA:1E88                 </span><span style="color:navy">mov     cs:</span>model_byte<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:1E8C
BIOSDATA:1E8C </span>turn_timer_on<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1E8C                 </span><span style="color:navy">mov     al, </span><span style="color:green">20h
</span><span style="color:maroon">BIOSDATA:1E8E                 </span><span style="color:navy">out     </span><span style="color:green">20h</span><span style="color:navy">, al         </span>; Interrupt controller, 8259A.
<span style="color:maroon">BIOSDATA:1E90                 </span><span style="color:navy">cmp     cs:</span>model_byte<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:1E96                 </span><span style="color:navy">jnz     short </span>not_olivetti_m24
<span style="color:maroon">BIOSDATA:1E98                 </span><span style="color:navy">in      al, </span><span style="color:green">66h
</span><span style="color:maroon">BIOSDATA:1E9A                 </span><span style="color:navy">test    al, </span><span style="color:green">20h
</span><span style="color:maroon">BIOSDATA:1E9C                 </span><span style="color:navy">jz      short </span>not_olivetti_m24
<span style="color:maroon">BIOSDATA:1E9E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">BIOSDATA:1EA0                 </span><span style="color:navy">out     </span><span style="color:green">50h</span><span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:1EA2                 </span><span style="color:navy">in      al, </span><span style="color:green">50h
</span><span style="color:maroon">BIOSDATA:1EA4                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1EA6                 </span><span style="color:navy">jz      short </span>skip_aux_port_init
<span style="color:maroon">BIOSDATA:1EA8
BIOSDATA:1EA8 </span>not_olivetti_m24<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1EA8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:maroon">BIOSDATA:1EAA                 </span><span style="color:navy">call    </span>aux_init
<span style="color:maroon">BIOSDATA:1EAD                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">BIOSDATA:1EAF                 </span><span style="color:navy">call    </span>aux_init
<span style="color:maroon">BIOSDATA:1EB2                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1EB4                 </span><span style="color:navy">call    </span>aux_init
<span style="color:maroon">BIOSDATA:1EB7                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">BIOSDATA:1EB9                 </span><span style="color:navy">call    </span>aux_init
<span style="color:maroon">BIOSDATA:1EBC
BIOSDATA:1EBC </span>skip_aux_port_init<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1EBC                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">BIOSDATA:1EBE                 </span><span style="color:navy">call    </span>print_init
<span style="color:maroon">BIOSDATA:1EC1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:1EC3                 </span><span style="color:navy">call    </span>print_init
<span style="color:maroon">BIOSDATA:1EC6                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">BIOSDATA:1EC8                 </span><span style="color:navy">call    </span>print_init
<span style="color:maroon">BIOSDATA:1ECB                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">BIOSDATA:1ECD                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">BIOSDATA:1ECF                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1ECF                 </span><span style="color:navy">mov     es, dx
</span><span style="color:maroon">BIOSDATA:1ED1                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:1ED1                 </span><span style="color:navy">mov     ax, </span>word ptr ds:534h ; initspot
<span style="color:maroon">BIOSDATA:1ED1                                         </span>; IBMDOS.COM&#039;s first cluster - high word
<span style="color:maroon">BIOSDATA:1ED1                                         </span>; 520h (the 2nd entry of root dir) + 14h
<span style="color:maroon">BIOSDATA:1ED4                 </span><span style="color:navy">mov     cs:</span>firstcluster_hw<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1ED8                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:maroon">BIOSDATA:1EDA                 </span><span style="color:navy">mov     di, </span><span style="color:green">534h        </span>; INITSPOT (0000h:0534h)
<span style="color:maroon">BIOSDATA:1EDA                                         </span>; IBM wants 4 zeros here
<span style="color:maroon">BIOSDATA:1EDD                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:1EDE                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:1EDF                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:maroon">BIOSDATA:1EE1                 </span><span style="color:navy">mov     </span>word ptr ds:6Ch<span style="color:navy">, offset </span>cbreak ; INT 1Bh vector
<span style="color:maroon">BIOSDATA:1EE7                 </span><span style="color:navy">mov     </span>word ptr ds:6Eh<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1EEA                 </span><span style="color:navy">mov     </span>word ptr ds:0A4h<span style="color:navy">, offset </span>outchr ; INT 29h vector
<span style="color:maroon">BIOSDATA:1EF0                 </span><span style="color:navy">mov     </span>word ptr ds:0A6h<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1EF3                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">4
</span><span style="color:maroon">BIOSDATA:1EF6                 </span><span style="color:navy">mov     bx, offset </span>intret
<span style="color:maroon">BIOSDATA:1EF9                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:1EFA                 </span><span style="color:navy">stosw                   </span>; int 1
<span style="color:maroon">BIOSDATA:1EFB                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:1EFC                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:1EFD                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4           </span>; skip int 2
<span style="color:maroon">BIOSDATA:1F00                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:1F01                 </span><span style="color:navy">stosw                   </span>; int 3
<span style="color:maroon">BIOSDATA:1F02                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:1F03                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:1F04                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:1F05                 </span><span style="color:navy">stosw                   </span>; int 4
<span style="color:maroon">BIOSDATA:1F06                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">BIOSDATA:1F07                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSDATA:1F08                 </span><span style="color:navy">mov     </span>word ptr ds:500h<span style="color:navy">, dx </span>; set print screen &amp; break = 0
<span style="color:maroon">BIOSDATA:1F0C                 </span><span style="color:navy">mov     </span>word ptr ds:504h<span style="color:navy">, dx </span>; clean out last drive spec
<span style="color:maroon">BIOSDATA:1F10                 </span><span style="color:navy">mov     al, </span>byte ptr ds:52Ch ; SEC9+DISK_PARMS.DISK_MOTOR_STRT
<span style="color:maroon">BIOSDATA:1F10                                         </span>; motor start time in 1/8 seconds
<span style="color:maroon">BIOSDATA:1F13                 </span><span style="color:navy">mov     cs:</span>motorstartup<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:1F17                 </span><span style="color:navy">cmp     cs:</span>model_byte<span style="color:navy">, </span><span style="color:#ff8000">0FDh </span>; is this an old rom?
<span style="color:maroon">BIOSDATA:1F1D                 </span><span style="color:navy">jb      short </span>no_diddle ; no
<span style="color:maroon">BIOSDATA:1F1F                 </span><span style="color:navy">mov     </span>word ptr ds:52Bh<span style="color:navy">, </span><span style="color:#ff8000">20Fh </span>; [SEC9+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:maroon">BIOSDATA:1F1F                                         </span>; head settle time in milliseconds
<span style="color:maroon">BIOSDATA:1F25                 </span><span style="color:navy">mov     </span>byte ptr ds:522h<span style="color:navy">, </span><span style="color:#ff8000">0DFh </span>; [SEC9+DISK_PARMS.DISK_SPECIFY_1]
<span style="color:maroon">BIOSDATA:1F25                                         </span>; set 1st specify byte on pc-1 pc-2 pc-xt hal0
<span style="color:maroon">BIOSDATA:1F2A
BIOSDATA:1F2A </span>no_diddle<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1F2A                 </span><span style="color:navy">int     </span><span style="color:green">12h             </span>; MEMORY SIZE -
<span style="color:maroon">BIOSDATA:1F2A                                         </span>; Return: AX = number of contiguous 1K blocks of memory
<span style="color:maroon">BIOSDATA:1F2C                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">6
</span><span style="color:maroon">BIOSDATA:1F2E                 </span><span style="color:navy">shl     ax, cl
</span><span style="color:maroon">BIOSDATA:1F30                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:1F31                 </span><span style="color:navy">mov     cs:</span>drvfat<span style="color:navy">, cx
</span><span style="color:maroon">BIOSDATA:1F36                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:1F37                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:1F38                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:1F39                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">BIOSDATA:1F3B                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:maroon">BIOSDATA:1F3D                 </span><span style="color:navy">mov     bx, </span>word ptr ds:0BCh ; INT 2Fh handler ; [2Fh*4]
<span style="color:maroon">BIOSDATA:1F41                 </span><span style="color:navy">mov     ds, </span>word ptr ds:0BEh ; [2Fh*4+2]
<span style="color:maroon">BIOSDATA:1F45                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1F45                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">5052h </span>; &#039;RP&#039; ; &#039;RPL&#039;
<span style="color:maroon">BIOSDATA:1F4A                 </span><span style="color:navy">jnz     short </span>SkipRPL
<span style="color:maroon">BIOSDATA:1F4C                 </span><span style="color:navy">cmp     byte ptr [bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4Ch </span>; &#039;L&#039;
<span style="color:maroon">BIOSDATA:1F50                 </span><span style="color:navy">jnz     short </span>SkipRPL
<span style="color:maroon">BIOSDATA:1F52                 </span><span style="color:navy">mov     dx, ax          </span>; get TOM into dx
<span style="color:maroon">BIOSDATA:1F54                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A06h       </span>; (multMULT shl 8) + multMULTRPLTOM
<span style="color:maroon">BIOSDATA:1F57                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Get new TOM from any RPL
<span style="color:maroon">BIOSDATA:1F59                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:maroon">BIOSDATA:1F5B
BIOSDATA:1F5B </span>SkipRPL<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1F5B                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:1F5C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1F5D                 </span><span style="color:navy">sub     ax, </span><span style="color:green">40h
</span><span style="color:maroon">BIOSDATA:1F60                 </span><span style="color:navy">mov     cs:</span>fatloc<span style="color:navy">, ax   </span>; location to read fat
<span style="color:maroon">BIOSDATA:1F64                 </span><span style="color:navy">sub     ax, </span><span style="color:green">40h
</span><span style="color:maroon">BIOSDATA:1F67                 </span><span style="color:navy">mov     cs:</span>init_bootseg<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1F6B                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:1F6C                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">544h        </span>; SYSINITSEG ; SYSINIT segment
<span style="color:maroon">BIOSDATA:1F6F                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">BIOSDATA:1F71                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1F71                 </span><span style="color:navy">mov     word ptr ds:</span>DEVICE_LIST<span style="color:navy">, offset </span>res_dev_list
<span style="color:maroon">BIOSDATA:1F77                 </span><span style="color:navy">mov     word ptr ds:</span>DEVICE_LIST<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cs
</span><span style="color:maroon">BIOSDATA:1F7B                 </span><span style="color:navy">mov     ds:</span>MEMORY_SIZE<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1F7E                 </span><span style="color:navy">inc     cl
</span><span style="color:maroon">BIOSDATA:1F80                 </span><span style="color:navy">mov     ds:</span>DEFAULT_DRIVE<span style="color:navy">, cl
</span><span style="color:maroon">BIOSDATA:1F84                 </span><span style="color:navy">mov     ds:</span>CURRENTDOSLOCATION<span style="color:navy">, </span><span style="color:#ff8000">0AF8h </span>; DOSLOADSEG
<span style="color:maroon">BIOSDATA:1F84                                         </span>; DOSLOADSEG  = SYSINITSEG+((SYSINITSIZE+15)/16)
<span style="color:maroon">BIOSDATA:1F8A                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">544h        </span>; SYSINITSEG
<span style="color:maroon">BIOSDATA:1F8D                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">BIOSDATA:1F8F                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:1F8F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:1F91                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:1F93                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1F93                 </span><span style="color:navy">mov     ax, </span>word ptr ds:3Eh ; INT 0Fh vector, segment
<span style="color:maroon">BIOSDATA:1F96                 </span><span style="color:navy">cmp     ax, es:</span>MEMORY_SIZE
<span style="color:maroon">BIOSDATA:1F9B                 </span><span style="color:navy">jbe     short </span>resetintf
<span style="color:maroon">BIOSDATA:1F9D                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">BIOSDATA:1FA0                 </span><span style="color:navy">jnz     short </span>keepintf
<span style="color:maroon">BIOSDATA:1FA2
BIOSDATA:1FA2 </span>resetintf<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1FA2                 </span><span style="color:navy">mov     </span>ds:3Ch<span style="color:navy">, offset </span>intret
<span style="color:maroon">BIOSDATA:1FA8                 </span><span style="color:navy">mov     </span>word ptr ds:3Eh<span style="color:navy">, cs
</span><span style="color:maroon">BIOSDATA:1FAC
BIOSDATA:1FAC </span>keepintf<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1FAC                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">BIOSDATA:1FAE                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:maroon">BIOSDATA:1FB0                 </span><span style="color:navy">mov     cl, </span>byte ptr ds:496h ; get keyboard flag
<span style="color:maroon">BIOSDATA:1FB4                 </span><span style="color:navy">test    cl, </span><span style="color:green">10h         </span>; extended keyboard ?
<span style="color:maroon">BIOSDATA:1FB7                 </span><span style="color:navy">jz      short </span>org_key   ; no
<span style="color:maroon">BIOSDATA:1FB9                 </span><span style="color:navy">mov     cs:</span>keyrd_func<span style="color:navy">, </span><span style="color:#ff8000">10h </span>; extended keyboard function
<span style="color:maroon">BIOSDATA:1FBF                 </span><span style="color:navy">mov     cs:</span>keysts_func<span style="color:navy">, </span><span style="color:#ff8000">11h </span>; extended keyboard function
<span style="color:maroon">BIOSDATA:1FC5
BIOSDATA:1FC5 </span>org_key<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:1FC5                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1FC6                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:1FC7                 </span>assume ds:BIOSDATA
<span style="color:maroon">BIOSDATA:1FC7                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:1FC8                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:1FC9                 </span>assume es:BIOSDATA
<span style="color:maroon">BIOSDATA:1FC9                 </span><span style="color:navy">call    </span>cmos_clock_read ; If cmos clock exists,
<span style="color:maroon">BIOSDATA:1FC9                                         </span>; then set the system time according to that.
<span style="color:maroon">BIOSDATA:1FC9                                         </span>; also, reset the cmos clock rate.
<span style="color:maroon">BIOSDATA:1FC9                                         </span>; ;
<span style="color:maroon">BIOSDATA:1FCC                 </span><span style="color:navy">mov     word ptr </span>hdrv_pat<span style="color:navy">, offset </span>harddrv ; BData_start
<span style="color:maroon">BIOSDATA:1FD2                 </span><span style="color:navy">pop     ax              </span>; number of floppies and FAT ID
<span style="color:maroon">BIOSDATA:1FD3                 </span><span style="color:navy">xor     ah, ah          </span>; chuck fat id byte
<span style="color:maroon">BIOSDATA:1FD5                 </span><span style="color:navy">mov     </span>drvmax<span style="color:navy">, al      </span>; remember which drive is hard disk
<span style="color:maroon">BIOSDATA:1FD8                 </span><span style="color:navy">mov     </span>dsktnum<span style="color:navy">, al     </span>; and set initial number of drives
<span style="color:maroon">BIOSDATA:1FDB                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:1FDD                 </span><span style="color:navy">add     </span>last_dskdrv_table<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:1FE1                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:1FE2                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">BIOSDATA:1FE5                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:1FE7                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:1FE7                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">0FFEAh</span><span style="color:navy">, &#039;</span><span style="color:green">OC&#039; </span>; &#039;COMPAQ&#039;
<span style="color:maroon">BIOSDATA:1FED                 </span><span style="color:navy">jnz     short </span>skip_mode2
<span style="color:maroon">BIOSDATA:1FEF                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">0FFECh</span><span style="color:navy">, &#039;</span><span style="color:green">PM&#039;
</span><span style="color:maroon">BIOSDATA:1FF5                 </span><span style="color:navy">jnz     short </span>skip_mode2
<span style="color:maroon">BIOSDATA:1FF7                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">0FFEEh</span><span style="color:navy">, &#039;</span><span style="color:green">QA&#039;
</span><span style="color:maroon">BIOSDATA:1FFD                 </span><span style="color:navy">jnz     short </span>skip_mode2
<span style="color:maroon">BIOSDATA:1FFF                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0E400h
</span><span style="color:maroon">BIOSDATA:2002                 </span><span style="color:navy">int     </span><span style="color:green">15h
</span><span style="color:maroon">BIOSDATA:2004                 </span><span style="color:navy">jb      short </span>skip_mode2
<span style="color:maroon">BIOSDATA:2006                 </span><span style="color:navy">or      bx, </span><span style="color:green">0           </span>; or bx,40h ; enable mode 2
<span style="color:maroon">BIOSDATA:2006                                         </span>; (MSDOS 6.0)
<span style="color:maroon">BIOSDATA:2009                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0E480h      </span>; set advanced system info
<span style="color:maroon">BIOSDATA:200C                 </span><span style="color:navy">int     </span><span style="color:green">15h
</span><span style="color:maroon">BIOSDATA:200E
BIOSDATA:200E </span>skip_mode2<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:200E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:200F                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:200F                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">BIOSDATA:2011                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">8
</span><span style="color:maroon">BIOSDATA:2013                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
<span style="color:maroon">BIOSDATA:2013                                         </span>; DL = drive number
<span style="color:maroon">BIOSDATA:2013                                         </span>; Return: CF set on error, AH = status code, BL = drive type
<span style="color:maroon">BIOSDATA:2013                                         </span>; DL = number of consecutive drives
<span style="color:maroon">BIOSDATA:2013                                         </span>; DH = maximum value for head number, ES:DI -&gt; drive parameter
<span style="color:maroon">BIOSDATA:2015                 </span><span style="color:navy">jb      short </span>enddrv
<span style="color:maroon">BIOSDATA:2017                 </span><span style="color:navy">mov     ds:</span>hnum<span style="color:navy">, dl     </span>; save number of hard drives
<span style="color:maroon">BIOSDATA:201B
BIOSDATA:201B </span>enddrv<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:201B                 </span><span style="color:navy">xor     dl, dl          </span>; drive number = 0
<span style="color:maroon">BIOSDATA:201D                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:201E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:201F                 </span>assume ds:BIOSDATA
<span style="color:maroon">BIOSDATA:201F                 </span><span style="color:navy">mov     </span>eot<span style="color:navy">, </span><span style="color:#ff8000">9
</span><span style="color:maroon">BIOSDATA:2024                 </span><span style="color:navy">mov     di, offset </span>start_bds
<span style="color:maroon">BIOSDATA:2027                 </span><span style="color:navy">cmp     </span>fakefloppydrv<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:202C                 </span><span style="color:navy">jnz     short </span>loop_drive
<span style="color:maroon">BIOSDATA:202E                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BDS.link]
<span style="color:maroon">BIOSDATA:2030                 </span><span style="color:navy">mov     di, [di]        </span>;  di &lt;- second bds link
<span style="color:maroon">BIOSDATA:2032                 </span><span style="color:navy">mov     word ptr [di], </span><span style="color:green">0FFFFh </span>; -1 ; set end of link
<span style="color:maroon">BIOSDATA:2036                 </span><span style="color:navy">jmp     </span>dohard          ; allocate/initialise bds for harddrives
<span style="color:maroon">BIOSDATA:2039 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2039
BIOSDATA:2039 </span>loop_drive<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2039                 </span><span style="color:navy">cmp     dl, </span>drvmax
<span style="color:maroon">BIOSDATA:203D                 </span><span style="color:navy">jb      short </span>got_more
<span style="color:maroon">BIOSDATA:203F                 </span><span style="color:navy">jmp     </span>done_drives
<span style="color:maroon">BIOSDATA:2042 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2042
BIOSDATA:2042 </span>got_more<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2042                 </span><span style="color:navy">xor     cx, cx          </span>; zero all flags
<span style="color:maroon">BIOSDATA:2044                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BDS.link] ; get next bds
<span style="color:maroon">BIOSDATA:2046                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; end of link ?
<span style="color:maroon">BIOSDATA:2049                 </span><span style="color:navy">jnz     short </span>not_last_bds
<span style="color:maroon">BIOSDATA:204B                 </span><span style="color:navy">mov     al, dl          </span>; drive number (0 based)
<span style="color:maroon">BIOSDATA:204D                 </span><span style="color:navy">cbw
</span><span style="color:maroon">BIOSDATA:204E                 </span><span style="color:navy">add     ax, ax
</span><span style="color:maroon">BIOSDATA:2050                 </span><span style="color:navy">add     ax, offset </span>dskdrvs
<span style="color:maroon">BIOSDATA:2053                 </span><span style="color:navy">mov     </span>last_dskdrv_table<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:2056                 </span><span style="color:navy">mov     di, </span>end_of_bdss
<span style="color:maroon">BIOSDATA:205A                 </span><span style="color:navy">call    </span>xinstall_bds
<span style="color:maroon">BIOSDATA:205D                 </span><span style="color:navy">dec     </span>drvmax
<span style="color:maroon">BIOSDATA:2061
BIOSDATA:2061 </span>not_last_bds<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2061                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">0           </span>; ff48tpi ; set form factor to 48 tpi
<span style="color:maroon">BIOSDATA:2063                 </span><span style="color:navy">mov     </span>num_cyln<span style="color:navy">, </span><span style="color:green">40    </span>; 40 tracks per side
<span style="color:maroon">BIOSDATA:2069                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:206A                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:206B                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:206C                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:206D                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:206E                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">BIOSDATA:2070                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">BIOSDATA:2072                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:2073                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">8
</span><span style="color:maroon">BIOSDATA:2075                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
<span style="color:maroon">BIOSDATA:2075                                         </span>; DL = drive number
<span style="color:maroon">BIOSDATA:2075                                         </span>; Return: CF set on error, AH = status code, BL = drive type
<span style="color:maroon">BIOSDATA:2075                                         </span>; DL = number of consecutive drives
<span style="color:maroon">BIOSDATA:2075                                         </span>; DH = maximum value for head number, ES:DI -&gt; drive parameter
<span style="color:maroon">BIOSDATA:2077                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:2078                 </span><span style="color:navy">jnb     short </span>chk_drv_type
<span style="color:maroon">BIOSDATA:207A                 </span><span style="color:navy">jmp     </span>noparmsfromrom
<span style="color:maroon">BIOSDATA:207D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:207D
BIOSDATA:207D </span>chk_drv_type<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:207D                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">10h         </span>; ATAPI Removable Media Device
<span style="color:maroon">BIOSDATA:2080                 </span><span style="color:navy">jnz     short </span>not_atapi_removable
<span style="color:maroon">BIOSDATA:2082                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:2083                 </span><span style="color:navy">push    si
</span><span style="color:maroon">BIOSDATA:2084                 </span><span style="color:navy">mov     dl, al
</span><span style="color:maroon">BIOSDATA:2086                 </span><span style="color:navy">sub     sp, </span><span style="color:green">26
</span><span style="color:maroon">BIOSDATA:2089                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:208B                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:208C                 </span><span style="color:navy">mov     ax, </span><span style="color:green">30
</span><span style="color:maroon">BIOSDATA:208F                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:2090                 </span><span style="color:navy">mov     si, sp          </span>; DS:SI = segment:offset pointer to Result Buffer
<span style="color:maroon">BIOSDATA:2092                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">BIOSDATA:2093                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:2094                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:2094                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:maroon">BIOSDATA:2096                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension
<span style="color:maroon">BIOSDATA:2096                                         </span>; GET DRIVE PARAMETERS (DL - drive, DS:SI - buffer)
<span style="color:maroon">BIOSDATA:2098                 </span><span style="color:navy">jb      short </span>ext_gdp_err
<span style="color:maroon">BIOSDATA:209A                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; physical number of heads
<span style="color:maroon">BIOSDATA:209D                 </span><span style="color:navy">mov     ds:</span>num_heads<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:20A0                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; physical number of cylinders
<span style="color:maroon">BIOSDATA:20A3                 </span><span style="color:navy">mov     ds:</span>num_cyln<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:20A6                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">]    </span>; physical number of sectors per track
<span style="color:maroon">BIOSDATA:20A9                 </span><span style="color:navy">mov     ds:</span>sec_trk<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:20AC                 </span><span style="color:navy">cmp     al, ds:</span>eot
<span style="color:maroon">BIOSDATA:20B0                 </span><span style="color:navy">jbe     short </span>_eotok
<span style="color:maroon">BIOSDATA:20B2                 </span><span style="color:navy">mov     ds:</span>eot<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:20B5
BIOSDATA:20B5 </span>_eotok<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:20B5                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">BIOSDATA:20B7                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">10h </span>; information flags
<span style="color:maroon">BIOSDATA:20B7                                         </span>; bit 4 = Device has change line support
<span style="color:maroon">BIOSDATA:20BB                 </span><span style="color:navy">jz      short </span>not_chgline_sup
<span style="color:maroon">BIOSDATA:20BD                 </span><span style="color:navy">or      al, </span><span style="color:green">2           </span>; change line support
<span style="color:maroon">BIOSDATA:20BF
BIOSDATA:20BF </span>not_chgline_sup<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:20BF                 </span><span style="color:navy">add     sp, </span><span style="color:green">30
</span><span style="color:maroon">BIOSDATA:20C2                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">BIOSDATA:20C3                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:20C4                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:20C4                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:20C5                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:20C5                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:20C6                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:20C7                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:20C8                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:20C9                 </span><span style="color:navy">test    al, </span><span style="color:green">2
</span><span style="color:maroon">BIOSDATA:20CB                 </span><span style="color:navy">jz      short </span>gotother_j
<span style="color:maroon">BIOSDATA:20CD                 </span><span style="color:navy">or      cl, al
</span><span style="color:maroon">BIOSDATA:20CF                 </span><span style="color:navy">mov     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; Device has change line support
<span style="color:maroon">BIOSDATA:20D4
BIOSDATA:20D4 </span>gotother_j<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:20D4                 </span><span style="color:navy">jmp     short </span>gotother
<span style="color:maroon">BIOSDATA:20D6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:20D6
BIOSDATA:20D6 </span>ext_gdp_err<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:20D6                 </span><span style="color:navy">add     sp, </span><span style="color:green">30
</span><span style="color:maroon">BIOSDATA:20D9                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">BIOSDATA:20DA                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:20DB
BIOSDATA:20DB </span>not_atapi_removable<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:20DB                 </span><span style="color:navy">cmp     ch, </span><span style="color:#ff8000">0           </span>; if ch=0, then cl,dh=0 too.
<span style="color:maroon">BIOSDATA:20DE                 </span><span style="color:navy">jnz     short </span>pfr_ok    ;
<span style="color:maroon">BIOSDATA:20DE                                         </span>; rom gave wrong info.
<span style="color:maroon">BIOSDATA:20DE                                         </span>; let&#039;s default to 360k.
<span style="color:maroon">BIOSDATA:20E0                 </span><span style="color:navy">mov     ch, </span><span style="color:green">39
</span><span style="color:maroon">BIOSDATA:20E2                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">9
</span><span style="color:maroon">BIOSDATA:20E4                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:20E6
BIOSDATA:20E6 </span>pfr_ok<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:20E6                 </span><span style="color:navy">xchg    dl, dh
</span><span style="color:maroon">BIOSDATA:20E8                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:maroon">BIOSDATA:20EA                 </span><span style="color:navy">inc     dx              </span>; make number of heads 1-based
<span style="color:maroon">BIOSDATA:20EB                 </span><span style="color:navy">mov     ds:</span>num_heads<span style="color:navy">, dx
</span><span style="color:maroon">BIOSDATA:20EF                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:20F0                 </span><span style="color:navy">and     cl, </span><span style="color:green">3Fh
</span><span style="color:maroon">BIOSDATA:20F3                 </span><span style="color:navy">mov     ds:</span>sec_trk<span style="color:navy">, cl
</span><span style="color:maroon">BIOSDATA:20F7                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:20F8                 </span><span style="color:navy">xchg    cl, ch
</span><span style="color:maroon">BIOSDATA:20FA                 </span><span style="color:navy">rol     ch, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:20FC                 </span><span style="color:navy">rol     ch, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:20FE                 </span><span style="color:navy">and     ch, </span><span style="color:green">3
</span><span style="color:maroon">BIOSDATA:2101                 </span><span style="color:navy">inc     cx              </span>; make number of cylinders 1-based
<span style="color:maroon">BIOSDATA:2102                 </span><span style="color:navy">mov     ds:</span>num_cyln<span style="color:navy">, cx
</span><span style="color:maroon">BIOSDATA:2106                 </span><span style="color:navy">mov     cl, ds:</span>sec_trk
<span style="color:maroon">BIOSDATA:210A                 </span><span style="color:navy">cmp     cl, ds:</span>eot
<span style="color:maroon">BIOSDATA:210E                 </span><span style="color:navy">jbe     short </span>eotok
<span style="color:maroon">BIOSDATA:2110                 </span><span style="color:navy">mov     ds:</span>eot<span style="color:navy">, cl
</span><span style="color:maroon">BIOSDATA:2114
BIOSDATA:2114 </span>eotok<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2114                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:2115                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:2116                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:2117                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:2118                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:2119                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:211A                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:211B                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">15h
</span><span style="color:maroon">BIOSDATA:211D                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET TYPE (AT,XT2,XT286,CONV,PS)
<span style="color:maroon">BIOSDATA:211D                                         </span>; DL = drive ID
<span style="color:maroon">BIOSDATA:211D                                         </span>; Return: CF set on error, AH = disk type (3 = hard drive)
<span style="color:maroon">BIOSDATA:211D                                         </span>; CX:DX = number of sectors on the media
<span style="color:maroon">BIOSDATA:211F                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:2120                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:2121                 </span><span style="color:navy">jb      short </span>changeline_done
<span style="color:maroon">BIOSDATA:2123                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2
</span><span style="color:maroon">BIOSDATA:2126                 </span><span style="color:navy">jnz     short </span>changeline_done
<span style="color:maroon">BIOSDATA:2128                 </span><span style="color:navy">or      cl, </span><span style="color:green">2           </span>; fchangeline ; change line support
<span style="color:maroon">BIOSDATA:212B                 </span><span style="color:navy">mov     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; remember that we have 96tpi disks
<span style="color:maroon">BIOSDATA:2130
BIOSDATA:2130 </span>changeline_done<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2130                 </span><span style="color:navy">cmp     ds:</span>num_cyln<span style="color:navy">, </span><span style="color:green">40
</span><span style="color:maroon">BIOSDATA:2135                 </span><span style="color:navy">jnz     short </span>try_80
<span style="color:maroon">BIOSDATA:2137                 </span><span style="color:navy">cmp     ds:</span>sec_trk<span style="color:navy">, </span><span style="color:#ff8000">9
</span><span style="color:maroon">BIOSDATA:213C                 </span><span style="color:navy">jbe     short </span>nextdrive
<span style="color:maroon">BIOSDATA:213E
BIOSDATA:213E </span>gotother<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:213E                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">7           </span>; ffOther ; we have a &quot;strange&quot; medium
<span style="color:maroon">BIOSDATA:2140                 </span><span style="color:navy">jmp     short </span>nextdrive
<span style="color:maroon">BIOSDATA:2142 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2142
BIOSDATA:2142 </span>try_80<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2142                 </span><span style="color:navy">cmp     ds:</span>num_cyln<span style="color:navy">, </span><span style="color:green">80
</span><span style="color:maroon">BIOSDATA:2147                 </span><span style="color:navy">jnz     short </span>gotother
<span style="color:maroon">BIOSDATA:2149                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">9           </span>; ff288 ; assume 2.88 MB drive
<span style="color:maroon">BIOSDATA:214B                 </span><span style="color:navy">cmp     ds:</span>sec_trk<span style="color:navy">, </span><span style="color:green">36  </span>; is it ?
<span style="color:maroon">BIOSDATA:2150                 </span><span style="color:navy">jz      short </span>nextdrive ; yes, go update
<span style="color:maroon">BIOSDATA:2152                 </span><span style="color:navy">cmp     ds:</span>sec_trk<span style="color:navy">, </span><span style="color:green">15
</span><span style="color:maroon">BIOSDATA:2157                 </span><span style="color:navy">jz      short </span>got96
<span style="color:maroon">BIOSDATA:2159                 </span><span style="color:navy">cmp     ds:</span>sec_trk<span style="color:navy">, </span><span style="color:#ff8000">9
</span><span style="color:maroon">BIOSDATA:215E                 </span><span style="color:navy">jnz     short </span>gotother
<span style="color:maroon">BIOSDATA:2160                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">2           </span>; ffSmall
<span style="color:maroon">BIOSDATA:2162                 </span><span style="color:navy">jmp     short </span>nextdrive
<span style="color:maroon">BIOSDATA:2164 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2164
BIOSDATA:2164 </span>got96<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2164                 </span><span style="color:navy">mov     dh, </span><span style="color:green">1           </span>; ff96tpi
<span style="color:maroon">BIOSDATA:2166                 </span><span style="color:navy">jmp     short </span>nextdrive
<span style="color:maroon">BIOSDATA:2168 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2168
BIOSDATA:2168 </span>noparmsfromrom<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2168                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:2169                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:216A                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:216B                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:216C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:216D                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:216E                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:216F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">15h
</span><span style="color:maroon">BIOSDATA:2171                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET TYPE (AT,XT2,XT286,CONV,PS)
<span style="color:maroon">BIOSDATA:2171                                         </span>; DL = drive ID
<span style="color:maroon">BIOSDATA:2171                                         </span>; Return: CF set on error, AH = disk type (3 = hard drive)
<span style="color:maroon">BIOSDATA:2171                                         </span>; CX:DX = number of sectors on the media
<span style="color:maroon">BIOSDATA:2173                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:2174                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:2175                 </span><span style="color:navy">jb      short </span>nextdrive
<span style="color:maroon">BIOSDATA:2177                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2           </span>; is there changeline?
<span style="color:maroon">BIOSDATA:217A                 </span><span style="color:navy">jnz     short </span>nextdrive
<span style="color:maroon">BIOSDATA:217C                 </span><span style="color:navy">or      cl, </span><span style="color:green">2           </span>; yes, this drive has change line supoort
<span style="color:maroon">BIOSDATA:217F                 </span><span style="color:navy">mov     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; remember that we have 96tpi drives
<span style="color:maroon">BIOSDATA:217F                                         </span>; (change line support)
<span style="color:maroon">BIOSDATA:2184                 </span><span style="color:navy">mov     ds:</span>num_cyln<span style="color:navy">, </span><span style="color:green">80
</span><span style="color:maroon">BIOSDATA:218A                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">1           </span>; ff96tpi
<span style="color:maroon">BIOSDATA:218C                 </span><span style="color:navy">mov     al, </span><span style="color:green">15
</span><span style="color:maroon">BIOSDATA:218E                 </span><span style="color:navy">cmp     al, ds:</span>eot
<span style="color:maroon">BIOSDATA:2192                 </span><span style="color:navy">jbe     short </span>nextdrive
<span style="color:maroon">BIOSDATA:2194                 </span><span style="color:navy">mov     ds:</span>eot<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:2197
BIOSDATA:2197 </span>nextdrive<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2197                 </span><span style="color:navy">or      cl, </span><span style="color:green">20h         </span>; fi_own_physical
<span style="color:maroon">BIOSDATA:2197                                         </span>; set this true for all drives
<span style="color:maroon">BIOSDATA:219A                 </span><span style="color:navy">mov     bh, dl          </span>; save int13 drive number
<span style="color:maroon">BIOSDATA:219C                 </span><span style="color:navy">cmp     ds:</span>single<span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:maroon">BIOSDATA:21A1                 </span><span style="color:navy">jb      short </span>not_special
<span style="color:maroon">BIOSDATA:21A3                 </span><span style="color:navy">dec     bh              </span>; int13 drive number same for logical drive
<span style="color:maroon">BIOSDATA:21A5                 </span><span style="color:navy">xor     cl, </span><span style="color:green">20h         </span>; fi_own_physical
<span style="color:maroon">BIOSDATA:21A5                                         </span>; reset ownership flag for logical drive
<span style="color:maroon">BIOSDATA:21A8
BIOSDATA:21A8 </span>not_special<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:21A8                 </span><span style="color:navy">mov     ax, ds:</span>num_heads
<span style="color:maroon">BIOSDATA:21AB                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">52h</span><span style="color:navy">], ax    </span>; [di+BDS.rheads]
<span style="color:maroon">BIOSDATA:21AE                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:21B0                 </span><span style="color:navy">mov     al, ds:</span>sec_trk
<span style="color:maroon">BIOSDATA:21B3                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">50h</span><span style="color:navy">], ax    </span>; [di+BDS.rsecpertrack]
<span style="color:maroon">BIOSDATA:21B6                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], cx    </span>; [di+BDS.flags]
<span style="color:maroon">BIOSDATA:21B9                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], dh    </span>; [di+BDS.formfactor]
<span style="color:maroon">BIOSDATA:21BC                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], dl      </span>; [di+BDS.drivelet]
<span style="color:maroon">BIOSDATA:21BF                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], bh      </span>; [di+BDS.drivenum]
<span style="color:maroon">BIOSDATA:21C2                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:21C3                 </span><span style="color:navy">mov     bx, ds:</span>num_cyln
<span style="color:maroon">BIOSDATA:21C7                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">41h</span><span style="color:navy">], bx    </span>; [di+BDS.cylinders]
<span style="color:maroon">BIOSDATA:21CA                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:21CB                 </span><span style="color:navy">cmp     ds:</span>single<span style="color:navy">, </span><span style="color:#ff8000">1    </span>; Special case for single drive system
<span style="color:maroon">BIOSDATA:21D0                 </span><span style="color:navy">jnz     short </span>no_single
<span style="color:maroon">BIOSDATA:21D2                 </span><span style="color:navy">mov     ds:</span>single<span style="color:navy">, </span><span style="color:#ff8000">2    </span>; Don&#039;t forget we have single drive system
<span style="color:maroon">BIOSDATA:21D7                 </span><span style="color:navy">or      cx, </span><span style="color:green">10h         </span>; fi_am_mult
<span style="color:maroon">BIOSDATA:21D7                                         </span>; set that this is one of several drives
<span style="color:maroon">BIOSDATA:21DA                 </span><span style="color:navy">or      [di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], cx    </span>; [di+BDS.flags] ; save flags
<span style="color:maroon">BIOSDATA:21DD                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BDS.link] ; move to next BDS in list
<span style="color:maroon">BIOSDATA:21DF                 </span><span style="color:navy">inc     dl              </span>; add a number
<span style="color:maroon">BIOSDATA:21E1                 </span><span style="color:navy">jmp     short </span>nextdrive ; Use same info for BDS as previous
<span style="color:maroon">BIOSDATA:21E3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:21E3
BIOSDATA:21E3 </span>no_single<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:21E3                 </span><span style="color:navy">inc     dl
</span><span style="color:maroon">BIOSDATA:21E5                 </span><span style="color:navy">jmp     </span>loop_drive
<span style="color:maroon">BIOSDATA:21E8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:21E8
BIOSDATA:21E8 </span>done_drives<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:21E8                 </span><span style="color:navy">mov     word ptr [di], </span><span style="color:green">0FFFFh </span>; -1
<span style="color:maroon">BIOSDATA:21EC
BIOSDATA:21EC </span>dohard<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:21EC                 </span><span style="color:navy">mov     dh, ds:</span>hnum
<span style="color:maroon">BIOSDATA:21F0                 </span><span style="color:navy">or      dh, dh
</span><span style="color:maroon">BIOSDATA:21F2                 </span><span style="color:navy">jz      short </span>static_configure
<span style="color:maroon">BIOSDATA:21F4                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">BIOSDATA:21F6
BIOSDATA:21F6 </span>dohard1<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:21F6                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:21F7                 </span><span style="color:navy">mov     di, ds:</span>end_of_bdss
<span style="color:maroon">BIOSDATA:21FB                 </span><span style="color:navy">mov     bl, ds:</span>drvmax
<span style="color:maroon">BIOSDATA:21FF                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:2201                 </span><span style="color:navy">call    </span>sethard
<span style="color:maroon">BIOSDATA:2204                 </span><span style="color:navy">jb      short </span>hardfile_err
<span style="color:maroon">BIOSDATA:2206                 </span><span style="color:navy">call    </span>dmax_check
<span style="color:maroon">BIOSDATA:2209                 </span><span style="color:navy">jnb     short </span>hardfile_err
<span style="color:maroon">BIOSDATA:220B                 </span><span style="color:navy">call    </span>xinstall_bds
<span style="color:maroon">BIOSDATA:220E
BIOSDATA:220E </span>hardfile_err<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:220E                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:220F                 </span><span style="color:navy">inc     dl
</span><span style="color:maroon">BIOSDATA:2211                 </span><span style="color:navy">dec     dh
</span><span style="color:maroon">BIOSDATA:2213                 </span><span style="color:navy">jnz     short </span>dohard1
<span style="color:maroon">BIOSDATA:2215                 </span><span style="color:navy">call    </span>domini
<span style="color:maroon">BIOSDATA:2218                 </span><span style="color:navy">mov     dh, ds:</span>hnum
<span style="color:maroon">BIOSDATA:221C                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">BIOSDATA:221E
BIOSDATA:221E </span>dohardx1<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:221E                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSDATA:2220
BIOSDATA:2220 </span>dohardx2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2220                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:2221                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSDATA:2222                 </span><span style="color:navy">mov     di, ds:</span>end_of_bdss
<span style="color:maroon">BIOSDATA:2226                 </span><span style="color:navy">mov     bl, ds:</span>drvmax
<span style="color:maroon">BIOSDATA:222A                 </span><span style="color:navy">call    </span>sethard
<span style="color:maroon">BIOSDATA:222D                 </span><span style="color:navy">jb      short </span>dohardx4
<span style="color:maroon">BIOSDATA:222F                 </span><span style="color:navy">call    </span>dmax_check
<span style="color:maroon">BIOSDATA:2232                 </span><span style="color:navy">jnb     short </span>dohardx4
<span style="color:maroon">BIOSDATA:2234                 </span><span style="color:navy">call    </span>xinstall_bds
<span style="color:maroon">BIOSDATA:2237                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:2238                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:2239                 </span><span style="color:navy">inc     bh
</span><span style="color:maroon">BIOSDATA:223B                 </span><span style="color:navy">jmp     short </span>dohardx2
<span style="color:maroon">BIOSDATA:223D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:223D
BIOSDATA:223D </span>dohardx4<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:223D                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:223E                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:223F                 </span><span style="color:navy">inc     dl
</span><span style="color:maroon">BIOSDATA:2241                 </span><span style="color:navy">dec     dh
</span><span style="color:maroon">BIOSDATA:2243                 </span><span style="color:navy">jnz     short </span>dohardx1
<span style="color:maroon">BIOSDATA:2245                 </span><span style="color:navy">cmp     ds:</span>dsktnum<span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:maroon">BIOSDATA:224A                 </span><span style="color:navy">jbe     short </span>static_configure
<span style="color:maroon">BIOSDATA:224C                 </span><span style="color:navy">call    </span>remap
<span style="color:maroon">BIOSDATA:224F
BIOSDATA:224F </span>static_configure<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:224F                 </span><span style="color:navy">mov     di, ds:</span>end_of_bdss
<span style="color:maroon">BIOSDATA:2253                 </span><span style="color:navy">cmp     di, offset </span>bdss
<span style="color:maroon">BIOSDATA:2257                 </span><span style="color:navy">jnz     short </span>dynamic_configure
<span style="color:maroon">BIOSDATA:2259                 </span><span style="color:navy">mov     di, offset </span>harddrv ; offset end96tpi
<span style="color:maroon">BIOSDATA:225C                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:2261                 </span><span style="color:navy">jnz     short </span>dynamic_configure
<span style="color:maroon">BIOSDATA:2263                 </span><span style="color:navy">mov     di, offset </span>endfloppy
<span style="color:maroon">BIOSDATA:2266
BIOSDATA:2266 </span>dynamic_configure<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2266                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:2267                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:2268                 </span>assume es:BIOSDATA
<span style="color:maroon">BIOSDATA:2268                 </span><span style="color:navy">cld
</span><span style="color:maroon">BIOSDATA:2269                 </span><span style="color:navy">cmp     ds:</span>model_byte<span style="color:navy">, </span><span style="color:#ff8000">0FCh </span>; AT?
<span style="color:maroon">BIOSDATA:226E                 </span><span style="color:navy">jnz     short </span>checkcompaqbug ; no
<span style="color:maroon">BIOSDATA:2270                 </span><span style="color:navy">cmp     ds:</span>hnum<span style="color:navy">, </span><span style="color:#ff8000">0      </span>; No hard file?
<span style="color:maroon">BIOSDATA:2275                 </span><span style="color:navy">jz      short </span>checkcompaqbug
<span style="color:maroon">BIOSDATA:2277                 </span><span style="color:navy">xchg    ax, di          </span>; save allocation pointer in ax
<span style="color:maroon">BIOSDATA:2278                 </span><span style="color:navy">mov     si, </span><span style="color:green">0F000h
</span><span style="color:maroon">BIOSDATA:227B                 </span><span style="color:navy">mov     es, si
</span><span style="color:maroon">BIOSDATA:227D                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:227D                 </span><span style="color:navy">mov     si, offset </span>bios_date <span style="color:gray">; &quot;01/10/84&quot;
</span><span style="color:maroon">BIOSDATA:2280                 </span><span style="color:navy">mov     di, </span><span style="color:green">0FFF5h      </span>; ROM BIOS string is at F000:FFF5
<span style="color:maroon">BIOSDATA:2283                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">9           </span>; Only patch ROM for bios 01/10/84
<span style="color:maroon">BIOSDATA:2286                 </span><span style="color:navy">repe cmpsb              </span>; check for date + zero on end
<span style="color:maroon">BIOSDATA:2288                 </span><span style="color:navy">xchg    ax, di          </span>; restore allocation pointer
<span style="color:maroon">BIOSDATA:2289                 </span><span style="color:navy">jnz     short </span>checkcompaqbug
<span style="color:maroon">BIOSDATA:228B                 </span><span style="color:navy">mov     cx, offset </span>endatrom
<span style="color:maroon">BIOSDATA:228E                 </span><span style="color:navy">mov     si, offset </span>ibm_disk_io
<span style="color:maroon">BIOSDATA:2291                 </span><span style="color:navy">jmp     short </span>install_int13_patch
<span style="color:maroon">BIOSDATA:2293 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2293
BIOSDATA:2293 </span>checkcompaqbug<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2293                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">BIOSDATA:2296                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">BIOSDATA:2298                 </span><span style="color:navy">cmp     word ptr es:</span><span style="color:green">0FFEAh</span><span style="color:navy">, </span><span style="color:#ff8000">4F43h </span>; &#039;CO&#039;
<span style="color:maroon">BIOSDATA:229F                 </span><span style="color:navy">jnz     short </span>checkcmosclock
<span style="color:maroon">BIOSDATA:22A1                 </span><span style="color:navy">cmp     word ptr es:</span><span style="color:green">0FFECh</span><span style="color:navy">, </span><span style="color:#ff8000">504Dh </span>; &#039;MP&#039;
<span style="color:maroon">BIOSDATA:22A8                 </span><span style="color:navy">jnz     short </span>checkcmosclock
<span style="color:maroon">BIOSDATA:22AA                 </span><span style="color:navy">cmp     word ptr es:</span><span style="color:green">0FFEEh</span><span style="color:navy">, </span><span style="color:#ff8000">5141h </span>; &#039;AQ&#039;
<span style="color:maroon">BIOSDATA:22B1                 </span><span style="color:navy">jnz     short </span>checkcmosclock
<span style="color:maroon">BIOSDATA:22B3                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0FFFBh
</span><span style="color:maroon">BIOSDATA:22B7                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:maroon">BIOSDATA:22B9                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">3836h       </span>; &#039;68&#039; (NASM syntax) ((&#039;86&#039; in MASM syntax))
<span style="color:maroon">BIOSDATA:22BC                 </span><span style="color:navy">ja      short </span>checkcmosclock
<span style="color:maroon">BIOSDATA:22BE                 </span><span style="color:navy">jz      short </span>chkcompaqbug1
<span style="color:maroon">BIOSDATA:22C0                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">3739h       </span>; &#039;97&#039;
<span style="color:maroon">BIOSDATA:22C3                 </span><span style="color:navy">jbe     short </span>checkcmosclock
<span style="color:maroon">BIOSDATA:22C5                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSDATA:22C6
BIOSDATA:22C6 </span>chkcompaqbug1<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:22C6                 </span><span style="color:navy">jb      short </span>do_compaq_patch
<span style="color:maroon">BIOSDATA:22C8                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0FFF5h
</span><span style="color:maroon">BIOSDATA:22CC                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:maroon">BIOSDATA:22CE                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">3038h       </span>; &#039;80&#039;
<span style="color:maroon">BIOSDATA:22D1                 </span><span style="color:navy">ja      short </span>checkcmosclock
<span style="color:maroon">BIOSDATA:22D3                 </span><span style="color:navy">jb      short </span>do_compaq_patch
<span style="color:maroon">BIOSDATA:22D5                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0FFF8h
</span><span style="color:maroon">BIOSDATA:22D9                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:maroon">BIOSDATA:22DB                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">3034h       </span>; &#039;40&#039;
<span style="color:maroon">BIOSDATA:22DE                 </span><span style="color:navy">jnb     short </span>checkcmosclock
<span style="color:maroon">BIOSDATA:22E0
BIOSDATA:22E0 </span>do_compaq_patch<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:22E0                 </span><span style="color:navy">mov     cx, offset </span>end_compaq_i13hook
<span style="color:maroon">BIOSDATA:22E3                 </span><span style="color:navy">mov     si, offset </span>endatrom
<span style="color:maroon">BIOSDATA:22E6
BIOSDATA:22E6 </span>install_int13_patch<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:22E6                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:22E7                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:22E8                 </span>assume es:BIOSDATA
<span style="color:maroon">BIOSDATA:22E8                 </span><span style="color:navy">mov     word ptr ds:</span>Orig13<span style="color:navy">, di
</span><span style="color:maroon">BIOSDATA:22EC                 </span><span style="color:navy">mov     word ptr ds:</span>Orig13<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cs
</span><span style="color:maroon">BIOSDATA:22F0                 </span><span style="color:navy">sub     cx, si
</span><span style="color:maroon">BIOSDATA:22F2                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">BIOSDATA:22F4
BIOSDATA:22F4 </span>checkcmosclock<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:22F4                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:22F5                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:22F6
BIOSDATA:22F6 </span>checkk09<span style="color:navy">:
</span><span style="color:maroon">BIOSDATA:22F6                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:22F7                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4100h       </span>; wait for any external event (al=0)
<span style="color:maroon">BIOSDATA:22FA                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">4           </span>; wait for 4 clock ticks
<span style="color:maroon">BIOSDATA:22FC                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSDATA:22FD                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; SYSTEM - WAIT ON EXTERNAL EVENT (CONVERTIBLE)
<span style="color:maroon">BIOSDATA:22FD                                         </span>; AL = condition type, BH = condition compare or mask value
<span style="color:maroon">BIOSDATA:22FD                                         </span>; BL = timeout value times 55 milliseconds, 00h means no timeout
<span style="color:maroon">BIOSDATA:22FD                                         </span>; DX = I/O port address if AL bit 4 set
<span style="color:maroon">BIOSDATA:22FF                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:2300                 </span><span style="color:navy">jb      short </span>configdone
<span style="color:maroon">BIOSDATA:2302                 </span><span style="color:navy">mov     ds:</span>fhavek09<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; remember we have a k09 type
<span style="color:maroon">BIOSDATA:2307                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:2308                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:230A                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">BIOSDATA:230C                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:230C                 </span><span style="color:navy">mov     </span>word ptr ds:1B0h<span style="color:navy">, di </span>; [6Ch*4]
<span style="color:maroon">BIOSDATA:230C                                         </span>; new int 6ch handler
<span style="color:maroon">BIOSDATA:2310                 </span><span style="color:navy">mov     </span>word ptr ds:1B2h<span style="color:navy">, cs
</span><span style="color:maroon">BIOSDATA:2314                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:2315                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:2315                 </span><span style="color:navy">mov     si, offset </span>int_6Ch
<span style="color:maroon">BIOSDATA:2318                 </span><span style="color:navy">mov     cx, </span><span style="color:green">461         </span>; endk09-int_6Ch (size of k09 routine)
<span style="color:maroon">BIOSDATA:231B                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">BIOSDATA:231D
BIOSDATA:231D </span>configdone<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:231D                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:231E                 </span><span style="color:navy">pop     ds              </span>; di is final ending address of msbio.
<span style="color:maroon">BIOSDATA:231F                 </span>assume ds:BIOSDATA
<span style="color:maroon">BIOSDATA:231F                 </span><span style="color:navy">add     di, </span><span style="color:green">15          </span>; round (up) to paragraph
<span style="color:maroon">BIOSDATA:2322                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:2324                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:2326                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:2328                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:maroon">BIOSDATA:232A                 </span><span style="color:navy">add     di, </span><span style="color:green">70h
</span><span style="color:maroon">BIOSDATA:232E                 </span><span style="color:navy">mov     </span>DosDataSg<span style="color:navy">, di   </span>; where the dos data segment will be
<span style="color:maroon">BIOSDATA:2332                 </span><span style="color:navy">mov     ax, </span>drvfat
<span style="color:maroon">BIOSDATA:2335                 </span><span style="color:navy">mov     bp, offset </span>SetDrive
<span style="color:maroon">BIOSDATA:2338                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:2339                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:maroon">BIOSDATA:233C                 </span><span style="color:navy">mov     bp, offset </span>GetBp
<span style="color:maroon">BIOSDATA:233F                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:2340                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:maroon">BIOSDATA:2343                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:2344                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:2345                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">BIOSDATA:2347                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:maroon">BIOSDATA:234A                 </span><span style="color:navy">mov     byte ptr es:</span>drvfat<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:234E                 </span><span style="color:navy">mov     ax, es:</span>drvfat
<span style="color:maroon">BIOSDATA:2352                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:2353                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:2354                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:2355                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:2356                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:2357                 </span><span style="color:navy">mov     bp, offset </span>SetDrive
<span style="color:maroon">BIOSDATA:235A                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">BIOSDATA:235B                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:maroon">BIOSDATA:235E                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSDATA:235F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:2360                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSDATA:2361                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:2361                 </span><span style="color:navy">mov     bx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:2364                 </span><span style="color:navy">mov     cs:</span>md_sectorsize<span style="color:navy">, bx
</span><span style="color:maroon">BIOSDATA:2369                 </span><span style="color:navy">mov     bl, [di+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:236C                 </span><span style="color:navy">mov     es:</span>fbigfat<span style="color:navy">, bl
</span><span style="color:maroon">BIOSDATA:2371                 </span><span style="color:navy">mov     cl, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:2374                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">17h</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:2377                 </span><span style="color:navy">sub     es:</span>First_Data_Sector<span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:237C                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">19h</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:237F                 </span><span style="color:navy">sbb     es:</span>First_Data_Sector<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">BIOSDATA:2384                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:maroon">BIOSDATA:2386                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSDATA:2387                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSDATA:2388                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">BIOSDATA:238A                 </span><span style="color:navy">mov     ds, di
</span><span style="color:maroon">BIOSDATA:238C                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:238C                 </span><span style="color:navy">mov     bx, </span>word ptr ds:53Ah ; clus=*53Ah
<span style="color:maroon">BIOSDATA:238C                                         </span>; (First cluster field of 2nd dir entry
<span style="color:maroon">BIOSDATA:238C                                         </span>; of root directory in the buffer at 500h)
<span style="color:maroon">BIOSDATA:2390                 </span><span style="color:navy">mov     si, cs:</span>firstcluster_hw
<span style="color:maroon">BIOSDATA:2395                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSDATA:2396                 </span>assume ds:nothing
<span style="color:maroon">BIOSDATA:2396                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSDATA:2397                 </span><span style="color:navy">mov     al, es:</span>fbigfat
<span style="color:maroon">BIOSDATA:239B                 </span><span style="color:navy">push    ax              </span>; (*) save fbigfat flags
<span style="color:maroon">BIOSDATA:239C                 </span><span style="color:navy">mov     al, byte ptr es:</span>drvfat
<span style="color:maroon">BIOSDATA:23A0                 </span><span style="color:navy">or      al, es:</span>Boot_Drv
<span style="color:maroon">BIOSDATA:23A5                 </span><span style="color:navy">jnz     short </span>boot_drv_fixed ; hard disk
<span style="color:maroon">BIOSDATA:23A7
BIOSDATA:23A7 </span>boot_drv_removable<span style="color:navy">:                     </span>; calculate cluster count and set fbig or fbigbig flag
<span style="color:maroon">BIOSDATA:23A7                 </span><span style="color:navy">push    bx              </span>; for removable drives
<span style="color:maroon">BIOSDATA:23A8                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSDATA:23A9                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:23AA                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">]    </span>; [di+BDS.totalsecs16]
<span style="color:maroon">BIOSDATA:23AD                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">BIOSDATA:23AF                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">BIOSDATA:23B1                 </span><span style="color:navy">jnz     short </span>prep_totalsecs_ok
<span style="color:maroon">BIOSDATA:23B3                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]    </span>; [di+BDS.totalsecs32]
<span style="color:maroon">BIOSDATA:23B6                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:23B9
BIOSDATA:23B9 </span>prep_totalsecs_ok<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:23B9                 </span><span style="color:navy">sub     ax, [di+</span><span style="color:#ff8000">9</span><span style="color:navy">]      </span>; [di+BDS.resectors]
<span style="color:maroon">BIOSDATA:23BC                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSDATA:23BF                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSDATA:23C0                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSDATA:23C1                 </span><span style="color:navy">mov     bx, [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">]    </span>; [di+BDS.fatsecs16]
<span style="color:maroon">BIOSDATA:23C4                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSDATA:23C6                 </span><span style="color:navy">or      bx, bx
</span><span style="color:maroon">BIOSDATA:23C8                 </span><span style="color:navy">jnz     short </span>prep_fatsecs_ok
<span style="color:maroon">BIOSDATA:23CA                 </span><span style="color:navy">mov     bx, [di+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">]    </span>; [di+BDS.fatsecs32]
<span style="color:maroon">BIOSDATA:23CD                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">21h</span><span style="color:navy">]
</span><span style="color:maroon">BIOSDATA:23D0
BIOSDATA:23D0 </span>prep_fatsecs_ok<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:23D0                 </span><span style="color:navy">mov     cl, [di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">]    </span>; ax:bx = 32 bit count of FAT sectors
<span style="color:maroon">BIOSDATA:23D0                                         </span>; [di+BDS.fats]
<span style="color:maroon">BIOSDATA:23D3                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:maroon">BIOSDATA:23D5                 </span><span style="color:navy">mul     cx
</span><span style="color:maroon">BIOSDATA:23D7                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:maroon">BIOSDATA:23D8                 </span><span style="color:navy">mul     bx
</span><span style="color:maroon">BIOSDATA:23DA                 </span><span style="color:navy">add     cx, dx
</span><span style="color:maroon">BIOSDATA:23DC                 </span><span style="color:navy">mov     bx, ax          </span>; cx:bx = total (2*) fat sectors
<span style="color:maroon">BIOSDATA:23DE                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:23DF                 </span><span style="color:navy">pop     ax              </span>; dx:ax = totals sectors - reserved sectors
<span style="color:maroon">BIOSDATA:23E0                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:maroon">BIOSDATA:23E2                 </span><span style="color:navy">sbb     dx, cx          </span>; dx:ax = data sectors (includes root dir sectors)
<span style="color:maroon">BIOSDATA:23E4                 </span><span style="color:navy">mov     bx, [di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">]    </span>; [di+BDS.direntries]
<span style="color:maroon">BIOSDATA:23E7                 </span><span style="color:navy">add     bx, </span><span style="color:green">15          </span>; 16 directory entries per sector
<span style="color:maroon">BIOSDATA:23E7                                         </span>; (round up sector count by adding 15)
<span style="color:maroon">BIOSDATA:23EA                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; (rounded) dir entries / 16
<span style="color:maroon">BIOSDATA:23EC                 </span><span style="color:navy">shr     bx, cl
</span><span style="color:maroon">BIOSDATA:23EE                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">BIOSDATA:23F0                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:maroon">BIOSDATA:23F2                 </span><span style="color:navy">sbb     dx, cx          </span>; dx:ax = data sectors (except root directory sectors)
<span style="color:maroon">BIOSDATA:23F2                                         </span>; (will be used for cluster count calculation)
<span style="color:maroon">BIOSDATA:23F4                 </span><span style="color:navy">mov     cl, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [di+BDS.secperclus]
<span style="color:maroon">BIOSDATA:23F7                 </span><span style="color:navy">push    ax              </span>; 32 bit division (data sectors / sector per cluster)
<span style="color:maroon">BIOSDATA:23F8                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:maroon">BIOSDATA:23FA                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">BIOSDATA:23FC                 </span><span style="color:navy">div     cx
</span><span style="color:maroon">BIOSDATA:23FE                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">BIOSDATA:2400                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSDATA:2401                 </span><span style="color:navy">div     cx
</span><span style="color:maroon">BIOSDATA:2403                 </span><span style="color:navy">or      bx, bx          </span>; 32 bit cluster count if bx &gt; 0
<span style="color:maroon">BIOSDATA:2405                 </span><span style="color:navy">jnz     short </span>set_fbigbig_flag ; too big cluster number
<span style="color:maroon">BIOSDATA:2407                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFF6h
</span><span style="color:maroon">BIOSDATA:240A                 </span><span style="color:navy">jb      short </span>set_fbig_flag
<span style="color:maroon">BIOSDATA:240C
BIOSDATA:240C </span>set_fbigbig_flag<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:240C                 </span><span style="color:navy">or      es:</span>fbigfat<span style="color:navy">, </span><span style="color:green">20h </span>; FAT32  ; fbigbig
<span style="color:maroon">BIOSDATA:2412                 </span><span style="color:navy">jmp     short </span>set_fbig_flag_ok
<span style="color:maroon">BIOSDATA:2414 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2414
BIOSDATA:2414 </span>set_fbig_flag<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2414                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FF6h       </span>; 4096-10
<span style="color:maroon">BIOSDATA:2414                                         </span>; is this 16-bit fat?
<span style="color:maroon">BIOSDATA:2417                 </span><span style="color:navy">jb      short </span>set_fbig_flag_ok ; no, small fat
<span style="color:maroon">BIOSDATA:2419                 </span><span style="color:navy">or      es:</span>fbigfat<span style="color:navy">, </span><span style="color:green">40h </span>; FAT16 ; fbig
<span style="color:maroon">BIOSDATA:241F
BIOSDATA:241F </span>set_fbig_flag_ok<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:241F                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSDATA:2420                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSDATA:2421                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSDATA:2422
BIOSDATA:2422 </span>boot_drv_fixed<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2422                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">BIOSDATA:2424
BIOSDATA:2424 </span>loadit<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2424                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">544h        </span>; Load DOS kernel (IBMDOS.COM)
<span style="color:maroon">BIOSDATA:2424                                         </span>; SYSINIT segment = 544h
<span style="color:maroon">BIOSDATA:2427                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">BIOSDATA:2429                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:2429                 </span><span style="color:navy">mov     es, es:</span>CURRENTDOSLOCATION
<span style="color:maroon">BIOSDATA:242E                 </span>assume es:nothing
<span style="color:maroon">BIOSDATA:242E                 </span><span style="color:navy">call    </span>getclus
<span style="color:maroon">BIOSDATA:2431                 </span><span style="color:navy">test    cs:</span>fbigfat<span style="color:navy">, </span><span style="color:green">20h </span>; fbigbig ; FAT32 fs flag
<span style="color:maroon">BIOSDATA:2437                 </span><span style="color:navy">jz      short </span>iseof
<span style="color:maroon">BIOSDATA:2439
BIOSDATA:2439 </span>eofbigbig<span style="color:navy">:                              </span>; si:bx = 32 bit cluster number
<span style="color:maroon">BIOSDATA:2439                 </span><span style="color:navy">cmp     si, </span><span style="color:#ff8000">0FFFh
</span><span style="color:maroon">BIOSDATA:243D                 </span><span style="color:navy">jnz     short </span>iseofx
<span style="color:maroon">BIOSDATA:243F                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFF7h
</span><span style="color:maroon">BIOSDATA:2442                 </span><span style="color:navy">jmp     short </span>iseofx
<span style="color:maroon">BIOSDATA:2444 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2444
BIOSDATA:2444 </span>iseof<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2444                 </span><span style="color:navy">test    cs:</span>fbigfat<span style="color:navy">, </span><span style="color:green">40h </span>; fbig ; FAT16 fs flag
<span style="color:maroon">BIOSDATA:244A                 </span><span style="color:navy">jnz     short </span>eofbig
<span style="color:maroon">BIOSDATA:244C                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">0FF7h
</span><span style="color:maroon">BIOSDATA:2450                 </span><span style="color:navy">jmp     short </span>iseofx
<span style="color:maroon">BIOSDATA:2452 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSDATA:2452
BIOSDATA:2452 </span>eofbig<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2452                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFF7h
</span><span style="color:maroon">BIOSDATA:2455
BIOSDATA:2455 </span>iseofx<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSDATA:2455                 </span><span style="color:navy">jb      short </span>loadit
<span style="color:maroon">BIOSDATA:2457                 </span><span style="color:navy">pop     ax              </span>; (*) restore fbigfat flags
<span style="color:maroon">BIOSDATA:2457                                         </span>; (after loading DOS kernel)
<span style="color:maroon">BIOSDATA:2458                 </span><span style="color:navy">mov     cs:</span>fbigfat<span style="color:navy">, al
</span><span style="color:maroon">BIOSDATA:245C                 </span><span style="color:navy">call    </span>setdrvparms
<span style="color:maroon">BIOSDATA:245F                 </span><span style="color:navy">jmp     </span>far ptr 544h:269h ; SYSNIT:_SYSINIT
<span style="color:black">BIOSDATA:2464
BIOSDATA:2464 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2464
BIOSDATA:2464
BIOSDATA:2464 </span>remap           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2464                 </span><span style="color:navy">mov     di, cs:</span>start_bds ; get first bds
<span style="color:black">BIOSDATA:2469
BIOSDATA:2469 </span><span style="color:gray">drive_loop</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2469                 </span><span style="color:navy">cmp     byte ptr [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">80h </span>; [di+BDS.drivenum] ; first hard disk??
<span style="color:black">BIOSDATA:246D                 </span><span style="color:navy">jz      short </span><span style="color:gray">fdrv_found </span>; yes, continue
<span style="color:black">BIOSDATA:246F                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BDS.link] ; get next bds, assume segment
<span style="color:black">BIOSDATA:2471                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; last bds?
<span style="color:black">BIOSDATA:2474                 </span><span style="color:navy">jnz     short </span><span style="color:gray">drive_loop
</span><span style="color:black">BIOSDATA:2476                 </span><span style="color:navy">jmp     short </span><span style="color:gray">rmap_exit </span>; yes, no hard drive on system
<span style="color:black">BIOSDATA:2478 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2478
BIOSDATA:2478 </span><span style="color:gray">fdrv_found</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2478                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; start with logical drv num=2
<span style="color:black">BIOSDATA:247A
BIOSDATA:247A </span><span style="color:gray">fdrv_loop</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:247A                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], al      </span>; [di+BDS.drivelet]
<span style="color:black">BIOSDATA:247D                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BDS.link] ; ds:di--&gt; next bds
<span style="color:black">BIOSDATA:247F                 </span><span style="color:navy">inc     al              </span>; set num for next drive
<span style="color:black">BIOSDATA:2481                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; last hard drive ?
<span style="color:black">BIOSDATA:2484                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fdrv_loop </span>; no - assign more disk drives
<span style="color:black">BIOSDATA:2486                 </span><span style="color:navy">mov     di, cs:</span>start_bds
<span style="color:black">BIOSDATA:248B                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BDS.link] ; ds:di--&gt;bds2
<span style="color:black">BIOSDATA:248D                 </span><span style="color:navy">mov     ah, cs:</span>dsktnum  ; get number of floppies to remap
<span style="color:black">BIOSDATA:2492                 </span><span style="color:navy">sub     ah, </span><span style="color:#ff8000">2           </span>; adjust for a: &amp; b:
<span style="color:black">BIOSDATA:2495
BIOSDATA:2495 </span><span style="color:gray">remap_loop1</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2495                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BDS.link] ; set new num to next floppy
<span style="color:black">BIOSDATA:2497                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], al      </span>; [di+BDS.drivelet]
<span style="color:black">BIOSDATA:249A                 </span><span style="color:navy">inc     al              </span>; new number for next floppy
<span style="color:black">BIOSDATA:249C                 </span><span style="color:navy">dec     ah              </span>; count down extra floppies
<span style="color:black">BIOSDATA:249E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">remap_loop1
</span><span style="color:black">BIOSDATA:24A0                 </span><span style="color:navy">mov     al, byte ptr cs:</span>drvfat ; boot drive
<span style="color:black">BIOSDATA:24A4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; is it a: or b: ?
<span style="color:black">BIOSDATA:24A6                 </span><span style="color:navy">jb      short </span><span style="color:gray">rmap_exit
</span><span style="color:black">BIOSDATA:24A8                 </span><span style="color:navy">sub     al, cs:</span>dsktnum  ; is it one of the other floppies?
<span style="color:black">BIOSDATA:24AD                 </span><span style="color:navy">jb      short </span><span style="color:gray">remap_boot_flop </span>; brif so
<span style="color:black">BIOSDATA:24AF                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">2           </span>; bootdrv -= (dsktnum-2)
<span style="color:black">BIOSDATA:24B1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">remap_change_boot_drv
</span><span style="color:black">BIOSDATA:24B3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:24B3
BIOSDATA:24B3 </span><span style="color:gray">remap_boot_flop</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:24B3                 </span><span style="color:navy">add     al, cs:</span>drvmax   ; bootdrv += (drvmax-dsktnum)
<span style="color:black">BIOSDATA:24B8
BIOSDATA:24B8 </span><span style="color:gray">remap_change_boot_drv</span><span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:24B8                 </span><span style="color:navy">mov     byte ptr cs:</span>drvfat<span style="color:navy">, al
</span><span style="color:black">BIOSDATA:24BC                 </span><span style="color:navy">inc     al
</span><span style="color:black">BIOSDATA:24BE                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:24BF                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">544h        </span>; SYSINIT segment
<span style="color:black">BIOSDATA:24C2                 </span><span style="color:navy">mov     ds, di
</span><span style="color:black">BIOSDATA:24C4                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:24C4                 </span><span style="color:navy">mov     ds:</span>DEFAULT_DRIVE<span style="color:navy">, al
</span><span style="color:black">BIOSDATA:24C7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:24C8                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:24C8
BIOSDATA:24C8 </span><span style="color:gray">rmap_exit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:24C8                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:24C8 </span>remap           <span style="color:black">endp
BIOSDATA:24C8
BIOSDATA:24C9
BIOSDATA:24C9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:24C9
BIOSDATA:24C9
BIOSDATA:24C9 </span>getboot         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:24C9                 </span><span style="color:navy">mov     ax, cs:</span>init_bootseg
<span style="color:black">BIOSDATA:24CD                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">BIOSDATA:24CF                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">200h        </span>; bootbias
<span style="color:black">BIOSDATA:24D2                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h
</span><span style="color:black">BIOSDATA:24D5                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:black">BIOSDATA:24D7                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:24DA                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - READ SECTORS INTO MEMORY
<span style="color:black">BIOSDATA:24DA                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:black">BIOSDATA:24DA                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:black">BIOSDATA:24DA                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:black">BIOSDATA:24DC                 </span><span style="color:navy">jb      short </span>erret
<span style="color:black">BIOSDATA:24DE                 </span><span style="color:navy">cmp     word ptr es:</span><span style="color:green">3FEh</span><span style="color:navy">, </span><span style="color:green">0AA55h </span>; [es:bootbias+1FEh]
<span style="color:black">BIOSDATA:24DE                                         </span>; Dave Litton magic word?
<span style="color:black">BIOSDATA:24E5                 </span><span style="color:navy">jz      short </span>norm_ret  ; yes
<span style="color:black">BIOSDATA:24E7
BIOSDATA:24E7 </span>erret<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:24E7                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSDATA:24E8
BIOSDATA:24E8 </span>norm_ret<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:24E8                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:24E8 </span>getboot         <span style="color:black">endp
BIOSDATA:24E8
BIOSDATA:24E9
BIOSDATA:24E9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:24E9
BIOSDATA:24E9
BIOSDATA:24E9 </span>sethard         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:24E9                 </span><span style="color:navy">push    di              </span>; inputs:
<span style="color:black">BIOSDATA:24E9                                         </span>;     dl is rom drive number (80h...)
<span style="color:black">BIOSDATA:24E9                                         </span>;     bh is partition number (0....)
<span style="color:black">BIOSDATA:24E9                                         </span>;     ds:di points to bds
<span style="color:black">BIOSDATA:24E9                                         </span>; outputs:
<span style="color:black">BIOSDATA:24E9                                         </span>;     carry clear -&gt; bpb is filled in
<span style="color:black">BIOSDATA:24E9                                         </span>;     carry set -&gt; bpb is left uninitialized due to error
<span style="color:black">BIOSDATA:24EA                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:24EB                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:24EC                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:24ED                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], bl      </span>; [di+BDS.drivelet]
<span style="color:black">BIOSDATA:24F0                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], dl      </span>; [di+BDS.drivenum]
<span style="color:black">BIOSDATA:24F3                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [di+BDS.flags], fnon_removable
<span style="color:black">BIOSDATA:24F7                 </span><span style="color:navy">mov     byte ptr [di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], </span><span style="color:#ff8000">5 </span>; [di+BDS.formfactor], ffHardFile
<span style="color:black">BIOSDATA:24FB                 </span><span style="color:navy">mov     ds:</span>fbigfat<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; assume 12 bit FAT
<span style="color:black">BIOSDATA:2500                 </span><span style="color:navy">mov     dh, bh
</span><span style="color:black">BIOSDATA:2502                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2503                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">8
</span><span style="color:black">BIOSDATA:2505                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
<span style="color:black">BIOSDATA:2505                                         </span>; DL = drive number
<span style="color:black">BIOSDATA:2505                                         </span>; Return: CF set on error, AH = status code, BL = drive type
<span style="color:black">BIOSDATA:2505                                         </span>; DL = number of consecutive drives
<span style="color:black">BIOSDATA:2505                                         </span>; DH = maximum value for head number, ES:DI -&gt; drive parameter
<span style="color:black">BIOSDATA:2507                 </span><span style="color:navy">mov     dl, dh
</span><span style="color:black">BIOSDATA:2509                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:250B                 </span><span style="color:navy">inc     dx
</span><span style="color:black">BIOSDATA:250C                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], dx    </span>; [di+BDS.heads]
<span style="color:black">BIOSDATA:250F                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2510                 </span><span style="color:navy">jb      short </span><span style="color:gray">setret_j  </span>; error if no hard disk
<span style="color:black">BIOSDATA:2512                 </span><span style="color:navy">and     cx, </span><span style="color:green">3Fh
</span><span style="color:black">BIOSDATA:2515                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], cx    </span>; [di+BDS.secpertrack]
<span style="color:black">BIOSDATA:2518                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2519                 </span><span style="color:navy">call    </span>getboot
<span style="color:black">BIOSDATA:251C                 </span><span style="color:navy">pop     dx              </span>; restore partition number
<span style="color:black">BIOSDATA:251D                 </span><span style="color:navy">jnb     short </span>chk_act_part
<span style="color:black">BIOSDATA:251F
BIOSDATA:251F </span><span style="color:gray">setret_j</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:251F                 </span><span style="color:navy">jmp     </span><span style="color:gray">setret
</span><span style="color:black">BIOSDATA:2522 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2522
BIOSDATA:2522 </span>chk_act_part<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2522                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">BIOSDATA:2524                 </span><span style="color:navy">mov     cs:</span>ep_start_sector<span style="color:navy">, bx
</span><span style="color:black">BIOSDATA:2529                 </span><span style="color:navy">mov     cs:</span>ep_start_sector<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, bx
</span><span style="color:black">BIOSDATA:252E                 </span><span style="color:navy">mov     cs:</span>ep_hidden_secs<span style="color:navy">, bx
</span><span style="color:black">BIOSDATA:2533                 </span><span style="color:navy">mov     cs:</span>ep_hidden_secs<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, bx
</span><span style="color:black">BIOSDATA:2538                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">3C2h        </span>; 1C2h+bootbias
<span style="color:black">BIOSDATA:253B
BIOSDATA:253B </span><span style="color:gray">act_part</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:253B                 </span><span style="color:navy">test    byte ptr es:[bx-</span><span style="color:green">4</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:black">BIOSDATA:2540                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_act
</span><span style="color:black">BIOSDATA:2542                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">1 </span>; FAT12
<span style="color:black">BIOSDATA:2546                 </span><span style="color:navy">jz      short </span>got_good_act
<span style="color:black">BIOSDATA:2548                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">4 </span>; FAT16 CHS (&lt;= 32MB)
<span style="color:black">BIOSDATA:254C                 </span><span style="color:navy">jz      short </span>got_good_act
<span style="color:black">BIOSDATA:254E                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Bh </span>; FAT32 CHS
<span style="color:black">BIOSDATA:2552                 </span><span style="color:navy">jz      short </span>got_good_act
<span style="color:black">BIOSDATA:2554                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Ch </span>; FAT32 LBA
<span style="color:black">BIOSDATA:2558                 </span><span style="color:navy">jz      short </span>got_good_act
<span style="color:black">BIOSDATA:255A                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Eh </span>; FAT16 LBA
<span style="color:black">BIOSDATA:255E                 </span><span style="color:navy">jz      short </span>got_good_act
<span style="color:black">BIOSDATA:2560                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">6 </span>; FAT16 BIG CHS (&gt; 32MB)
<span style="color:black">BIOSDATA:2564                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_act
</span><span style="color:black">BIOSDATA:2566
BIOSDATA:2566 </span>got_good_act<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2566                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">BIOSDATA:2568                 </span><span style="color:navy">jz      short </span>set2
<span style="color:black">BIOSDATA:256A                 </span><span style="color:navy">dec     dh
</span><span style="color:black">BIOSDATA:256C
BIOSDATA:256C </span><span style="color:gray">no_act</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:256C                 </span><span style="color:navy">add     bx, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:256F                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">402h        </span>; 202h+bootbias
<span style="color:black">BIOSDATA:256F                                         </span>; last entry done?
<span style="color:black">BIOSDATA:2573                 </span><span style="color:navy">jnz     short </span><span style="color:gray">act_part
</span><span style="color:black">BIOSDATA:2575                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">3C2h        </span>; 1C2h+bootbias
<span style="color:black">BIOSDATA:2575                                         </span>; restore original value of bx
<span style="color:black">BIOSDATA:2578
BIOSDATA:2578 </span>get_primary<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2578                 </span><span style="color:navy">test    byte ptr es:[bx-</span><span style="color:green">4</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:black">BIOSDATA:257D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_prim  </span>; we&#039;ve already scanned
<span style="color:black">BIOSDATA:257D                                         </span>; the ACTIVE ones
<span style="color:black">BIOSDATA:257F                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">1 </span>; FAT12 fs
<span style="color:black">BIOSDATA:2583                 </span><span style="color:navy">jz      short </span>got_prim
<span style="color:black">BIOSDATA:2585                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">4 </span>; FAT16 fs
<span style="color:black">BIOSDATA:2589                 </span><span style="color:navy">jz      short </span>got_prim
<span style="color:black">BIOSDATA:258B                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Bh </span>; FAT32 CHS file system
<span style="color:black">BIOSDATA:258F                 </span><span style="color:navy">jz      short </span>got_prim
<span style="color:black">BIOSDATA:2591                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Ch </span>; FAT32 LBA file system
<span style="color:black">BIOSDATA:2595                 </span><span style="color:navy">jz      short </span>got_prim
<span style="color:black">BIOSDATA:2597                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Eh </span>; FAT16 LBA file system
<span style="color:black">BIOSDATA:259B                 </span><span style="color:navy">jz      short </span>got_prim
<span style="color:black">BIOSDATA:259D                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">6 </span>; FAT16 big fs (&gt; 32 MB)
<span style="color:black">BIOSDATA:25A1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_prim
</span><span style="color:black">BIOSDATA:25A3
BIOSDATA:25A3 </span>got_prim<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:25A3                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">BIOSDATA:25A5                 </span><span style="color:navy">jz      short </span>set2
<span style="color:black">BIOSDATA:25A7                 </span><span style="color:navy">dec     dh
</span><span style="color:black">BIOSDATA:25A9
BIOSDATA:25A9 </span><span style="color:gray">not_prim</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:25A9                 </span><span style="color:navy">add     bx, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:25AC                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">402h        </span>; 202h+bootbias
<span style="color:black">BIOSDATA:25B0                 </span><span style="color:navy">jnz     short </span>get_primary ; loop till we&#039;ve gone through table
<span style="color:black">BIOSDATA:25B2
BIOSDATA:25B2 </span><span style="color:gray">setret</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:25B2                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSDATA:25B3                 </span><span style="color:navy">jmp     </span>ret_hard_err
<span style="color:black">BIOSDATA:25B3 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:25B6 </span>ep_start_sector <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:25BA </span>ep_hidden_secs  <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:25BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:25BE
BIOSDATA:25BE </span>set2<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:25BE                 </span><span style="color:navy">mov     cs:</span>rom_drv_num<span style="color:navy">, dl
</span><span style="color:black">BIOSDATA:25C3                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; start sector (LBA) of the partition
<span style="color:black">BIOSDATA:25C7                 </span><span style="color:navy">mov     dx, es:[bx+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:25CB                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:25CE                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; zero based sector count
<span style="color:black">BIOSDATA:25D1                 </span><span style="color:navy">add     ax, es:[bx+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; start LBA + partition size in sectors
<span style="color:black">BIOSDATA:25D5                 </span><span style="color:navy">adc     dx, es:[bx+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:25D9                 </span><span style="color:navy">jnb     short </span>okdrive
<span style="color:black">BIOSDATA:25DB                 </span><span style="color:navy">or      ds:</span>fbigfat<span style="color:navy">, </span><span style="color:green">80h </span>; ftoobig
<span style="color:black">BIOSDATA:25E0
BIOSDATA:25E0 </span>okdrive<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:25E0                 </span><span style="color:navy">add     ax, cs:</span>ep_hidden_secs
<span style="color:black">BIOSDATA:25E5                 </span><span style="color:navy">adc     dx, cs:</span>ep_hidden_secs<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">BIOSDATA:25EA                 </span><span style="color:navy">jnb     short </span><span style="color:gray">okdrive_1
</span><span style="color:black">BIOSDATA:25EC                 </span><span style="color:navy">or      ds:</span>fbigfat<span style="color:navy">, </span><span style="color:green">80h </span>; ftoobig
<span style="color:black">BIOSDATA:25F1
BIOSDATA:25F1 </span><span style="color:gray">okdrive_1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:25F1                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Ch </span>; FAT32 LBA partition ID
<span style="color:black">BIOSDATA:25F5                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_lba_flag
</span><span style="color:black">BIOSDATA:25F7                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Eh </span>; FAT16 LBA partition ID
<span style="color:black">BIOSDATA:25FB                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_lba_flag
</span><span style="color:black">BIOSDATA:25FD                 </span><span style="color:navy">cmp     dx, [di+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; if dx &gt; [di+BDS.secpertrack] then
<span style="color:black">BIOSDATA:2600                 </span><span style="color:navy">jnb     short </span><span style="color:gray">set_lba_flag </span>; set LBA r/w flag
<span style="color:black">BIOSDATA:2602                 </span><span style="color:navy">div     word ptr [di+</span><span style="color:#ff8000">13h</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:2605                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2607                 </span><span style="color:navy">div     word ptr [di+</span><span style="color:#ff8000">15h</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:260A                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">400h        </span>; if ax (cylinder number) &gt;= 1024
<span style="color:black">BIOSDATA:260A                                         </span>;  set LBA r/w flag
<span style="color:black">BIOSDATA:260D                 </span><span style="color:navy">jb      short </span><span style="color:gray">set3
</span><span style="color:black">BIOSDATA:260F
BIOSDATA:260F </span><span style="color:gray">set_lba_flag</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:260F                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">4 </span>; fLBArw ; LBA r/w flag
<span style="color:black">BIOSDATA:2613
BIOSDATA:2613 </span><span style="color:gray">set3</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2613                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; start sector (LBA) of the partition
<span style="color:black">BIOSDATA:2617                 </span><span style="color:navy">mov     dx, es:[bx+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:261B                 </span><span style="color:navy">add     ax, cs:</span>ep_hidden_secs ; + hidden secs of the extd dos partion
<span style="color:black">BIOSDATA:2620                 </span><span style="color:navy">adc     dx, cs:</span>ep_hidden_secs<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">BIOSDATA:2625                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">17h</span><span style="color:navy">], ax    </span>; [di+BDS.hiddensectors]
<span style="color:black">BIOSDATA:2628                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">19h</span><span style="color:navy">], dx
</span><span style="color:black">BIOSDATA:262B                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">BIOSDATA:262D                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">], ax    </span>; [di+BDS.bdsm_hidden_trks]
<span style="color:black">BIOSDATA:2630                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], ax    </span>; [di+BDS.totalsec16]
<span style="color:black">BIOSDATA:2633                 </span><span style="color:navy">mov     dx, es:[bx+</span><span style="color:green">10</span><span style="color:navy">]  </span>; totals sectors (size) of the partition
<span style="color:black">BIOSDATA:2637                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:263B                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], dx
</span><span style="color:black">BIOSDATA:263E                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], ax    </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:2641                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2644                 </span><span style="color:navy">ja      short </span><span style="color:gray">set3_read
</span><span style="color:black">BIOSDATA:2646                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">64
</span><span style="color:black">BIOSDATA:2649                 </span><span style="color:navy">jb      short </span>set3_err
<span style="color:black">BIOSDATA:264B
BIOSDATA:264B </span><span style="color:gray">set3_read</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:264B                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">19h</span><span style="color:navy">]    </span>; [di+BDS.hiddensectors+2]
<span style="color:black">BIOSDATA:264E                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">17h</span><span style="color:navy">]    </span>; [di+BDS.hiddensectors]
<span style="color:black">BIOSDATA:2651                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">BIOSDATA:2653                 </span><span style="color:navy">mov     bl, [di+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [di+BDS.secpertrack]
<span style="color:black">BIOSDATA:2656                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2657                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">BIOSDATA:2659                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:265B                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:265D                 </span><span style="color:navy">mov     cs:</span>saved_word<span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2661                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2662                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:2664                 </span><span style="color:navy">mov     cl, dl
</span><span style="color:black">BIOSDATA:2666                 </span><span style="color:navy">inc     cl
</span><span style="color:black">BIOSDATA:2668                 </span><span style="color:navy">mov     bx, [di+</span><span style="color:#ff8000">15h</span><span style="color:navy">]    </span>; [di+BDS.heads]
<span style="color:black">BIOSDATA:266B                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:266C                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:266E                 </span><span style="color:navy">mov     ax, cs:</span>saved_word
<span style="color:black">BIOSDATA:2672                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:2674                 </span><span style="color:navy">mov     cs:</span>saved_word<span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2678                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2679                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:267B                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">4 </span>; fLBArw ; LBA read/write flag
<span style="color:black">BIOSDATA:267F                 </span><span style="color:navy">jz      short </span>set3_chs_read
<span style="color:black">BIOSDATA:2681
BIOSDATA:2681 </span>set3_lba_read<span style="color:navy">:
</span><span style="color:black">BIOSDATA:2681                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:2682                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2683                 </span>assume es:BIOSDATA
<span style="color:black">BIOSDATA:2683                 </span><span style="color:navy">mov     bx, offset </span>disksector
<span style="color:black">BIOSDATA:2686                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2687                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:2688                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">BIOSDATA:268A                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:268B                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:268C                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">19h</span><span style="color:navy">]    </span>; [di+BDS.hiddensectors+2]
<span style="color:black">BIOSDATA:268F                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2690                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">17h</span><span style="color:navy">]    </span>; [di+BDS.hiddensectors]
<span style="color:black">BIOSDATA:2693                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2694                 </span><span style="color:navy">push    es              </span>; buffer address
<span style="color:black">BIOSDATA:2695                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:2696                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1           </span>; sector (read) count
<span style="color:black">BIOSDATA:2699                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:269A                 </span><span style="color:navy">mov     ax, </span><span style="color:green">16          </span>; DAP size
<span style="color:black">BIOSDATA:269D                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:269E                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">BIOSDATA:26A0                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">BIOSDATA:26A2                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:26A2                 </span><span style="color:navy">mov     si, sp
</span><span style="color:black">BIOSDATA:26A4                 </span><span style="color:navy">mov     dl, cs:</span>rom_drv_num
<span style="color:black">BIOSDATA:26A9                 </span><span style="color:navy">mov     ah, </span><span style="color:green">42h
</span><span style="color:black">BIOSDATA:26AB                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension
<span style="color:black">BIOSDATA:26AB                                         </span>; EXTENDED READ (DL - drive, DS:SI - disk address packet)
<span style="color:black">BIOSDATA:26AD                 </span><span style="color:navy">jnb     short </span><span style="color:gray">set3_lba_read_ok
</span><span style="color:black">BIOSDATA:26AF                 </span><span style="color:navy">add     sp, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:26B2                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:26B3                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:26B4                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:26B4
BIOSDATA:26B4 </span>set3_err<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:26B4                 </span><span style="color:navy">jmp     </span><span style="color:gray">setret
</span><span style="color:black">BIOSDATA:26B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:26B7
BIOSDATA:26B7 </span><span style="color:gray">set3_lba_read_ok</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:26B7                 </span><span style="color:navy">add     sp, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:26BA                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:26BB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:26BC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set3_read_ok
</span><span style="color:black">BIOSDATA:26BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:26BE
BIOSDATA:26BE </span>set3_chs_read<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:26BE                 </span><span style="color:navy">cmp     word ptr [di+</span><span style="color:#ff8000">79h</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [di+BDS.bdsm_ismini] ; check for mini disk
<span style="color:black">BIOSDATA:26C2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">oknotmini
</span><span style="color:black">BIOSDATA:26C4                 </span><span style="color:navy">add     ax, [di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">]    </span>; [di+BDS.bdsm_hidden_trks]
<span style="color:black">BIOSDATA:26C7
BIOSDATA:26C7 </span><span style="color:gray">oknotmini</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:26C7                 </span><span style="color:navy">ror     ah, </span><span style="color:green">1           </span>; move high two bits of cyl to high
<span style="color:black">BIOSDATA:26C9                 </span><span style="color:navy">ror     ah, </span><span style="color:green">1           </span>; two bits of upper byte
<span style="color:black">BIOSDATA:26CB                 </span><span style="color:navy">and     ah, </span><span style="color:green">0C0h        </span>; turn off remainder of bits
<span style="color:black">BIOSDATA:26CE                 </span><span style="color:navy">or      cl, ah          </span>; move two bits to correct spot
<span style="color:black">BIOSDATA:26D0                 </span><span style="color:navy">mov     ch, al          </span>; ch is cylinder (low 8 bits)
<span style="color:black">BIOSDATA:26D0                                         </span>; cl is sector + 2 high bits of cylinder
<span style="color:black">BIOSDATA:26D2                 </span><span style="color:navy">mov     dh, dl          </span>; dh is head
<span style="color:black">BIOSDATA:26D4                 </span><span style="color:navy">mov     dl, cs:</span>rom_drv_num ; dl is drive number
<span style="color:black">BIOSDATA:26D9                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:26DA                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:26DB                 </span><span style="color:navy">mov     bx, offset </span>disksector
<span style="color:black">BIOSDATA:26DE                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h
</span><span style="color:black">BIOSDATA:26E1                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - READ SECTORS INTO MEMORY
<span style="color:black">BIOSDATA:26E1                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:black">BIOSDATA:26E1                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:black">BIOSDATA:26E1                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:black">BIOSDATA:26E3                 </span><span style="color:navy">jb      short </span>set3_err
<span style="color:black">BIOSDATA:26E5
BIOSDATA:26E5 </span><span style="color:gray">set3_read_ok</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:26E5                 </span><span style="color:navy">mov     bx, offset </span>disksector
<span style="color:black">BIOSDATA:26E8                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:26E9                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:26EA                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:#ff8000">1FEh</span><span style="color:navy">], </span><span style="color:green">0AA55h
</span><span style="color:black">BIOSDATA:26F1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalid_boot_record
</span><span style="color:black">BIOSDATA:26F3                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:#ff8000">16h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [bx+BPB_FATSz16] ; 16 bit FAT size is 0 if it is FAT32 bs
<span style="color:black">BIOSDATA:26F8                 </span><span style="color:navy">jz      short </span><span style="color:gray">check_1   </span>; FAT32
<span style="color:black">BIOSDATA:26FA                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:26FB                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:26FC                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:26FD                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:26FE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:26FF                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:26FF                 </span><span style="color:navy">mov     cx, </span><span style="color:green">28
</span><span style="color:black">BIOSDATA:2702                 </span><span style="color:navy">lea     si, [bx+</span><span style="color:#ff8000">24h</span><span style="color:navy">]    </span>; move offset 36 to 63
<span style="color:black">BIOSDATA:2702                                         </span>;      to offset 64 (28 bytes)
<span style="color:black">BIOSDATA:2705                 </span><span style="color:navy">lea     di, [bx+</span><span style="color:#ff8000">40h</span><span style="color:navy">]    </span>; boot sector offset 64
<span style="color:black">BIOSDATA:2708                 </span><span style="color:navy">cld
</span><span style="color:black">BIOSDATA:2709                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSDATA:270B                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:270C                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:270D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:270E                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:270E
BIOSDATA:270E </span><span style="color:gray">check_1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:270E                 </span><span style="color:navy">cmp     byte ptr cs:[bx], </span><span style="color:#ff8000">0E9h </span>; is it a near jump?
<span style="color:black">BIOSDATA:2712                 </span><span style="color:navy">jz      short </span><span style="color:gray">check_2   </span>; yes
<span style="color:black">BIOSDATA:2714                 </span><span style="color:navy">cmp     byte ptr cs:[bx], </span><span style="color:#ff8000">0EBh </span>; is it a short jump?
<span style="color:black">BIOSDATA:2718                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalid_boot_record </span>; no
<span style="color:black">BIOSDATA:271A                 </span><span style="color:navy">cmp     byte ptr cs:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">90h </span>; yes, is the next one a nop?
<span style="color:black">BIOSDATA:271F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalid_boot_record </span>; no
<span style="color:black">BIOSDATA:2721
BIOSDATA:2721 </span><span style="color:gray">check_2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2721                 </span><span style="color:navy">mov     bx, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">0Bh</span><span style="color:navy">) </span>;  disksector+EXT_BOOT.BPB ; disksector+11
<span style="color:black">BIOSDATA:2724                 </span><span style="color:navy">mov     al, cs:[bx+</span><span style="color:green">10</span><span style="color:navy">]  </span>; [bx+EBPB.MEDIADESCRIPTOR]
<span style="color:black">BIOSDATA:2728                 </span><span style="color:navy">and     al, </span><span style="color:green">0F0h        </span>; mask off low nibble
<span style="color:black">BIOSDATA:272A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0F0h        </span>; is high nibble = 0Fh?
<span style="color:black">BIOSDATA:272C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalid_boot_record
</span><span style="color:black">BIOSDATA:272E                 </span><span style="color:navy">cmp     word ptr cs:[bx], </span><span style="color:green">512 </span>; [bx+EBPB.BYTESPERSECTOR]
<span style="color:black">BIOSDATA:2733                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalid_boot_record </span>; invalidate non 512 byte sectors
<span style="color:black">BIOSDATA:2735                 </span><span style="color:navy">mov     al, cs:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; now make sure that
<span style="color:black">BIOSDATA:2735                                         </span>; the sectorspercluster is a power of 2
<span style="color:black">BIOSDATA:2739                 </span><span style="color:navy">or      al, al          </span>; is it zero?
<span style="color:black">BIOSDATA:273B                 </span><span style="color:navy">jz      short </span><span style="color:gray">invalid_boot_record </span>; yes, invalid boot record
<span style="color:black">BIOSDATA:273D
BIOSDATA:273D </span><span style="color:gray">ck_power_of_two</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:273D                 </span><span style="color:navy">shr     al, </span><span style="color:green">1           </span>; shift until first bit emerges
<span style="color:black">BIOSDATA:273F                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ck_power_of_two
</span><span style="color:black">BIOSDATA:2741                 </span><span style="color:navy">jz      short </span><span style="color:gray">valid_boot_record
</span><span style="color:black">BIOSDATA:2743
BIOSDATA:2743 </span><span style="color:gray">invalid_boot_record</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2743                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2744                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:2745                 </span><span style="color:navy">jmp     </span>unknown         ; jump to invalid boot record
<span style="color:black">BIOSDATA:2745                                         </span>; unformatted or illegal media.
<span style="color:black">BIOSDATA:2748 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2748
BIOSDATA:2748 </span><span style="color:gray">valid_boot_record</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2748                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2749                 </span><span style="color:navy">pop     bx              </span>;
<span style="color:black">BIOSDATA:2749                                         </span>; Signature found. Now check version.
<span style="color:black">BIOSDATA:274A                 </span><span style="color:navy">cmp     word ptr cs:[bx+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">2E32h </span>; &#039;2.&#039; (NASM syntax)
<span style="color:black">BIOSDATA:2750                 </span><span style="color:navy">jnz     short </span><span style="color:gray">try5
</span><span style="color:black">BIOSDATA:2752                 </span><span style="color:navy">cmp     byte ptr cs:[bx+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;
</span><span style="color:black">BIOSDATA:2757                 </span><span style="color:navy">jnz     short </span><span style="color:gray">try5
</span><span style="color:black">BIOSDATA:2759                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copybpb
</span><span style="color:black">BIOSDATA:275B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:275B
BIOSDATA:275B </span><span style="color:gray">unknown3_0_j</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:275B                 </span><span style="color:navy">jmp     </span>unknown3_0
<span style="color:black">BIOSDATA:275E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:275E
BIOSDATA:275E </span><span style="color:gray">try5</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:275E                 </span><span style="color:navy">call    </span>cover_fdisk_bug
<span style="color:black">BIOSDATA:2761                 </span><span style="color:navy">cmp     word ptr cs:[bx+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">2E30h </span>; &#039;0.&#039; (NASM syntax)
<span style="color:black">BIOSDATA:2767                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_os2
</span><span style="color:black">BIOSDATA:2769                 </span><span style="color:navy">mov     al, cs:[bx+</span><span style="color:#ff8000">7</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:276D                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">31h </span><span style="color:gray">; &#039;1&#039;
</span><span style="color:black">BIOSDATA:276F                 </span><span style="color:navy">and     al, </span><span style="color:green">0FEh
</span><span style="color:black">BIOSDATA:2771                 </span><span style="color:navy">jz      short </span><span style="color:gray">copybpb   </span>; accept either &#039;1&#039; or &#039;2&#039;
<span style="color:black">BIOSDATA:2773                 </span><span style="color:navy">jmp     </span>unknown
<span style="color:black">BIOSDATA:2776 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2776
BIOSDATA:2776 </span><span style="color:gray">no_os2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2776                 </span><span style="color:navy">cmp     word ptr cs:[bx+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">2E33h </span>; &#039;3.&#039; (NASM syntax)
<span style="color:black">BIOSDATA:277C                 </span><span style="color:navy">jb      short </span><span style="color:gray">unknown3_0_j
</span><span style="color:black">BIOSDATA:277E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copybpb
</span><span style="color:black">BIOSDATA:2780                 </span><span style="color:navy">cmp     byte ptr cs:[bx+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], </span><span style="color:#ff8000">31h </span><span style="color:gray">; &#039;1&#039;
</span><span style="color:black">BIOSDATA:2785                 </span><span style="color:navy">jb      short </span><span style="color:gray">unknown3_0_j
</span><span style="color:black">BIOSDATA:2787
BIOSDATA:2787 </span><span style="color:gray">copybpb</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2787                 </span><span style="color:navy">cmp     word ptr cs:</span>disksector<span style="color:navy">+</span><span style="color:green">4Dh</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:278D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">check_3   </span>; NOTE: This check is not proper for FAT32 boot sector (standard spec)
<span style="color:black">BIOSDATA:278D                                         </span>; (after PCDOS 7.1). So, it is not existing in Windows ME IO.SYS
<span style="color:black">BIOSDATA:278D                                         </span>; Erdogan Tan - 01/09/2023
<span style="color:black">BIOSDATA:278F                 </span><span style="color:navy">cmp     cs:</span>disksector<span style="color:navy">+</span><span style="color:green">42h</span><span style="color:navy">, </span><span style="color:green">29h </span>; BS_BootSig (FAT32)
<span style="color:black">BIOSDATA:2795                 </span><span style="color:navy">jmp     short </span><span style="color:gray">check_4
</span><span style="color:black">BIOSDATA:2797 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2797
BIOSDATA:2797 </span><span style="color:gray">check_3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2797                 </span><span style="color:navy">cmp     cs:</span>disksector<span style="color:navy">+</span><span style="color:green">26h</span><span style="color:navy">, </span><span style="color:green">29h </span>; BS_BootSig (FAT16/FAT12)
<span style="color:black">BIOSDATA:279D
BIOSDATA:279D </span><span style="color:gray">check_4</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:279D                 </span><span style="color:navy">jnz     short </span>copybpb_fat
<span style="color:black">BIOSDATA:279F                 </span><span style="color:navy">cmp     cs:</span>disksector<span style="color:navy">+</span><span style="color:green">10h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB.fats
<span style="color:black">BIOSDATA:27A5                 </span><span style="color:navy">jnz     short </span>copybpb_fat
<span style="color:black">BIOSDATA:27A7                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:27A8                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:27A9                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:27AA                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:27AB                 </span>assume es:nothing
<span style="color:black">BIOSDATA:27AB                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:27AC                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:27AD                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:27AD                 </span><span style="color:navy">mov     si, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">0Bh</span><span style="color:navy">) </span>; BIOSDATA:015Dh
<span style="color:black">BIOSDATA:27B0                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">6           </span>; add di,BDS.BPB
<span style="color:black">BIOSDATA:27B3                 </span><span style="color:navy">cmp     word ptr cs:[si+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [BPB.totalsecs16]
<span style="color:black">BIOSDATA:27B8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">already_nonz
</span><span style="color:black">BIOSDATA:27BA                 </span><span style="color:navy">cmp     word ptr cs:[si+</span><span style="color:#ff8000">15h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [BPB.totalsecs32]
<span style="color:black">BIOSDATA:27BF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">already_nonz
</span><span style="color:black">BIOSDATA:27C1                 </span><span style="color:navy">cmp     word ptr cs:[si+</span><span style="color:#ff8000">17h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [BPB.totalsecs32+2]
<span style="color:black">BIOSDATA:27C6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">already_nonz
</span><span style="color:black">BIOSDATA:27C8                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; .. empty BPB (size) fields ..
<span style="color:black">BIOSDATA:27C8                                         </span>; fill boot sector&#039;s BPB fields
<span style="color:black">BIOSDATA:27C8                                         </span>;           with correct values
<span style="color:black">BIOSDATA:27CB                 </span><span style="color:navy">mov     cs:[si+</span><span style="color:#ff8000">8</span><span style="color:navy">], ax
</span><span style="color:black">BIOSDATA:27CF                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">15h</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:27D2                 </span><span style="color:navy">mov     cs:[si+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax
</span><span style="color:black">BIOSDATA:27D6                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">17h</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:27D9                 </span><span style="color:navy">mov     cs:[si+</span><span style="color:#ff8000">17h</span><span style="color:navy">], ax
</span><span style="color:black">BIOSDATA:27DD
BIOSDATA:27DD </span><span style="color:gray">already_nonz</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:27DD                 </span><span style="color:navy">mov     cx, </span><span style="color:green">53          </span>; copy contents of the bootsector&#039;s BPB
<span style="color:black">BIOSDATA:27DD                                         </span>;                      to the BDS&#039;s BPB
<span style="color:black">BIOSDATA:27E0                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSDATA:27E2                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:27E3                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:27E3                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:27E4                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:27E5                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:27E6                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:27E7                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:27E8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:27E9                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:27E9                 </span><span style="color:navy">mov     bp, offset </span>mov_media_ids
<span style="color:black">BIOSDATA:27EC                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:27ED                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:black">BIOSDATA:27F0                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:27F1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:27F2                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:27F2                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:27F3                 </span><span style="color:navy">jmp     </span>goodret
<span style="color:black">BIOSDATA:27F3 </span>sethard         <span style="color:black">endp
BIOSDATA:27F3
BIOSDATA:27F6
BIOSDATA:27F6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:27F6
BIOSDATA:27F6
BIOSDATA:27F6 </span>copybpb_fat     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:27F6                 </span><span style="color:navy">mov     si, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">0Bh</span><span style="color:navy">) </span>; BIOSDATA:015Dh
<span style="color:black">BIOSDATA:27F6                                         </span>; disksector+11
<span style="color:black">BIOSDATA:27F6                                         </span>; disksector+EXT_BOOT.BPB
<span style="color:black">BIOSDATA:27F9                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:27FB                 </span><span style="color:navy">mov     ax, cs:[si+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; BPB.totalsecs16
<span style="color:black">BIOSDATA:27FF                 </span><span style="color:navy">or      ax, ax          </span>; get totsec from boot sec
<span style="color:black">BIOSDATA:2801                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copy_totsec
</span><span style="color:black">BIOSDATA:2803                 </span><span style="color:navy">mov     ax, cs:[si+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; BPB.totalsecs32
<span style="color:black">BIOSDATA:2807                 </span><span style="color:navy">mov     dx, cs:[si+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; BPB.totalsecs32+2
<span style="color:black">BIOSDATA:280B                 </span><span style="color:navy">mov     cx, dx          </span>; get the big version
<span style="color:black">BIOSDATA:280D                 </span><span style="color:navy">or      cx, ax          </span>; see if it is a big zero
<span style="color:black">BIOSDATA:280F                 </span><span style="color:navy">jz      short </span><span style="color:gray">fat_big_small </span>; screw it. it was bogus.
<span style="color:black">BIOSDATA:2811
BIOSDATA:2811 </span><span style="color:gray">copy_totsec</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2811                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], ax    </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:2814                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], dx    </span>; [di+BDS.totalsecs32+2]
<span style="color:black">BIOSDATA:2817
BIOSDATA:2817 </span><span style="color:gray">fat_big_small</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2817                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:281A                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:281D                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; BPB.resectors
<span style="color:black">BIOSDATA:2821                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">9</span><span style="color:navy">], bx      </span>; [di+BDS.resectors]
<span style="color:black">BIOSDATA:2824                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:black">BIOSDATA:2826                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2829                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; BPB.fatsecs
<span style="color:black">BIOSDATA:282D                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], bx    </span>; [di+BDS.fatsecs]
<span style="color:black">BIOSDATA:2830                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:2831                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">BIOSDATA:2833                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fat_16bit
</span><span style="color:black">BIOSDATA:2835                 </span><span style="color:navy">sub     ax, cs:[si+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; FAT32 file system (BUG!)
<span style="color:black">BIOSDATA:2835                                         </span>; BPB.FATSz32
<span style="color:black">BIOSDATA:2839                 </span><span style="color:navy">sbb     dx, cs:[si+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">] </span>; BPB.FATSz32+2 (BUG!)
<span style="color:black">BIOSDATA:283D                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; BPB.FATSz32
<span style="color:black">BIOSDATA:2841                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], bx    </span>; [di+BDS.fatsecs32]
<span style="color:black">BIOSDATA:2844                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">] </span>; BPB.FATSz32+2
<span style="color:black">BIOSDATA:2848                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">21h</span><span style="color:navy">], bx    </span>; [di+BDS.fatsecs32+2]
<span style="color:black">BIOSDATA:284B                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">] </span>; BPB.BPB_ExtFlags
<span style="color:black">BIOSDATA:284F                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">23h</span><span style="color:navy">], bx    </span>; [di+BDS.extflags]
<span style="color:black">BIOSDATA:2852                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; BPB.FSVer
<span style="color:black">BIOSDATA:2856                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">25h</span><span style="color:navy">], bx    </span>; [di+BDS.fsver]
<span style="color:black">BIOSDATA:2859                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">21h</span><span style="color:navy">] </span>; BPB.RootClus
<span style="color:black">BIOSDATA:285D                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">27h</span><span style="color:navy">], bx    </span>; [di+BDS.rootdirclust]
<span style="color:black">BIOSDATA:2860                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">23h</span><span style="color:navy">] </span>; BPB.RootClus+2
<span style="color:black">BIOSDATA:2864                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">29h</span><span style="color:navy">], bx    </span>; [di+BDS.rootdirclust+2]
<span style="color:black">BIOSDATA:2867                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">25h</span><span style="color:navy">] </span>; BPB.FSInfo
<span style="color:black">BIOSDATA:286B                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">], bx    </span>; [di+BDS.fsinfo]
<span style="color:black">BIOSDATA:286E                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">27h</span><span style="color:navy">] </span>; BPB.FSInfo+2
<span style="color:black">BIOSDATA:2872                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">], bx    </span>; [di+BDS.fsinfo+2]
<span style="color:black">BIOSDATA:2875                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fat_32bit </span>; BUG! Erdogan Tan - 8/8/2023
<span style="color:black">BIOSDATA:2875                                         </span>; correct code (would be):
<span style="color:black">BIOSDATA:2875                                         </span>;   mov cl, [cs:si+05h] ; BPB_NumFATs
<span style="color:black">BIOSDATA:2875                                         </span>; sub_fat32_size:
<span style="color:black">BIOSDATA:2875                                         </span>;   sub ax, [cs:si+19h] ; BPB_FATSz32
<span style="color:black">BIOSDATA:2875                                         </span>;   sbb dx, [cs:si+1Bh] ; BPB_FATSz32+2
<span style="color:black">BIOSDATA:2875                                         </span>;   dec cl
<span style="color:black">BIOSDATA:2875                                         </span>;   jg short sub_fat32_size
<span style="color:black">BIOSDATA:2875                                         </span>;   jmp short fat_32bit
<span style="color:black">BIOSDATA:2877 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2877
BIOSDATA:2877 </span><span style="color:gray">fat_16bit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2877                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1           </span>; always 2 fats ! BUG!
<span style="color:black">BIOSDATA:2879                 </span><span style="color:navy">sub     ax, bx          </span>; sub # fat sectors
<span style="color:black">BIOSDATA:287B                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; BUG! Erdogan Tan - 8/8/2023
<span style="color:black">BIOSDATA:287B                                         </span>; correct code (would be):
<span style="color:black">BIOSDATA:287B                                         </span>;   mov cl, [cs:si+05h] ; BPB_NumFATs
<span style="color:black">BIOSDATA:287B                                         </span>; sub_fat_size:
<span style="color:black">BIOSDATA:287B                                         </span>;   sub ax, bx ; BPB.fatsecs
<span style="color:black">BIOSDATA:287B                                         </span>;   sbb dx, 0
<span style="color:black">BIOSDATA:287B                                         </span>;   dec cl
<span style="color:black">BIOSDATA:287B                                         </span>;   jg short sub_fat_size
<span style="color:black">BIOSDATA:287E
BIOSDATA:287E </span><span style="color:gray">fat_32bit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:287E                 </span><span style="color:navy">mov     bx, cs:[si+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; BPB.direntries
<span style="color:black">BIOSDATA:2882                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], bx    </span>; [di+BDS.direntries]
<span style="color:black">BIOSDATA:2885                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">BIOSDATA:2887                 </span><span style="color:navy">shr     bx, cl
</span><span style="color:black">BIOSDATA:2889                 </span><span style="color:navy">sub     ax, bx          </span>; - root dir sectors
<span style="color:black">BIOSDATA:288B                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = # of data sectors
<span style="color:black">BIOSDATA:288E                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">BIOSDATA:2890                 </span><span style="color:navy">mov     cl, cs:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; BPB.secperclus
<span style="color:black">BIOSDATA:2894                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">8</span><span style="color:navy">], cl      </span>; [di+BDS.secperclus]
<span style="color:black">BIOSDATA:2897                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2898                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">BIOSDATA:289A                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:289C                 </span><span style="color:navy">div     cx              </span>; 32 bit division
<span style="color:black">BIOSDATA:289E                 </span><span style="color:navy">mov     cs:</span>saved_word<span style="color:navy">, ax </span>; hw of cluster number
<span style="color:black">BIOSDATA:28A2                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:28A3                 </span><span style="color:navy">div     cx
</span><span style="color:black">BIOSDATA:28A5                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:28A6                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">BIOSDATA:28A8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chk_clnum_hw </span>; 16 bit fat sectors &gt; 0 ; FAT12 or FAT16 fs
<span style="color:black">BIOSDATA:28AA                 </span><span style="color:navy">cmp     cs:</span>saved_word<span style="color:navy">, </span><span style="color:#ff8000">0FFFh
</span><span style="color:black">BIOSDATA:28B1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fat32_clust_limit
</span><span style="color:black">BIOSDATA:28B3                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFF6h      </span>; FAT32 cluster number limit: 0FFFFFF6h
<span style="color:black">BIOSDATA:28B6
BIOSDATA:28B6 </span><span style="color:gray">fat32_clust_limit</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28B6                 </span><span style="color:navy">ja      short </span><span style="color:gray">toobig_ret
</span><span style="color:black">BIOSDATA:28B8                 </span><span style="color:navy">cmp     cs:</span>saved_word<span style="color:navy">, bx
</span><span style="color:black">BIOSDATA:28BD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fat16_clust_limit
</span><span style="color:black">BIOSDATA:28BF                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFF6h      </span>; FAT16 cluster number limit: 0FFF6h
<span style="color:black">BIOSDATA:28C2
BIOSDATA:28C2 </span><span style="color:gray">fat16_clust_limit</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28C2                 </span><span style="color:navy">jbe     short </span><span style="color:gray">fat12_clust_limit
</span><span style="color:black">BIOSDATA:28C4                 </span><span style="color:navy">or      ds:</span>fbigfat<span style="color:navy">, </span><span style="color:green">20h </span>; fbigbig ; FAT32 fs
<span style="color:black">BIOSDATA:28C9                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copymediaid
</span><span style="color:black">BIOSDATA:28CB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:28CB
BIOSDATA:28CB </span><span style="color:gray">chk_clnum_hw</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28CB                 </span><span style="color:navy">cmp     cs:</span>saved_word<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:28D1                 </span><span style="color:navy">ja      short </span><span style="color:gray">toobig_ret
</span><span style="color:black">BIOSDATA:28D3
BIOSDATA:28D3 </span><span style="color:gray">fat12_clust_limit</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28D3                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FF6h       </span>; FAT12 cluster number limit: 0FF6h
<span style="color:black">BIOSDATA:28D6                 </span><span style="color:navy">jb      short </span><span style="color:gray">copymediaid </span>; FAT12 fs
<span style="color:black">BIOSDATA:28D8                 </span><span style="color:navy">or      ds:</span>fbigfat<span style="color:navy">, </span><span style="color:green">40h </span>; fbig ; FAT16 fs
<span style="color:black">BIOSDATA:28DD
BIOSDATA:28DD </span><span style="color:gray">copymediaid</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28DD                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:28DE                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:28DF                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:28E0                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:28E1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:28E2                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:28E2                 </span><span style="color:navy">mov     bp, offset </span>mov_media_ids ;
<span style="color:black">BIOSDATA:28E2                                         </span>; MOVMEDIAIDS equ mov_media_ids - DOSBIOSEG
<span style="color:black">BIOSDATA:28E5                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:28E6                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:black">BIOSDATA:28E9                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:28EA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:28EB                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:28EB                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:28EC                 </span><span style="color:navy">jmp     </span>massage_bpb
<span style="color:black">BIOSDATA:28EF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:28EF
BIOSDATA:28EF </span><span style="color:gray">toobig_ret</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28EF                 </span><span style="color:navy">or      cs:</span>fbigfat<span style="color:navy">, </span><span style="color:green">80h </span>; ftoobig ; too big (32 bit cluster #) for FAT16
<span style="color:black">BIOSDATA:28F5                 </span><span style="color:navy">jmp     </span>goodret         ; still drive letter is assigned
<span style="color:black">BIOSDATA:28F5                                         </span>; but useless. to big for
<span style="color:black">BIOSDATA:28F5                                         </span>; current pc dos fat file system
<span style="color:black">BIOSDATA:28F8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:28F8
BIOSDATA:28F8 </span>unknown<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28F8                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">2 </span>; [di+BDS.flags+1] ; unformatted_media
<span style="color:black">BIOSDATA:28F8                                         </span>; Set unformatted media flag.
<span style="color:black">BIOSDATA:28FC
BIOSDATA:28FC </span>unknown3_0<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:28FC                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">]    </span>; skip setting unformatted_media bit
<span style="color:black">BIOSDATA:28FC                                         </span>; [di+BDS.totalsecs32+2]
<span style="color:black">BIOSDATA:28FF                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]    </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:2902                 </span><span style="color:navy">mov     si, offset </span>disktable2
<span style="color:black">BIOSDATA:2905
BIOSDATA:2905 </span><span style="color:gray">scan</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2905                 </span><span style="color:navy">cmp     dx, cs:[si]     </span>; total sectors hw
<span style="color:black">BIOSDATA:2908                 </span><span style="color:navy">jb      short </span><span style="color:gray">gotparm
</span><span style="color:black">BIOSDATA:290A                 </span><span style="color:navy">ja      short </span><span style="color:gray">scan_next
</span><span style="color:black">BIOSDATA:290C                 </span><span style="color:navy">cmp     ax, cs:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; total sectors lw
<span style="color:black">BIOSDATA:2910                 </span><span style="color:navy">jbe     short </span><span style="color:gray">gotparm
</span><span style="color:black">BIOSDATA:2912
BIOSDATA:2912 </span><span style="color:gray">scan_next</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2912                 </span><span style="color:navy">add     si, </span><span style="color:green">10
</span><span style="color:black">BIOSDATA:2915                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scan
</span><span style="color:black">BIOSDATA:2917 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2917
BIOSDATA:2917 </span><span style="color:gray">gotparm</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2917                 </span><span style="color:navy">mov     cl, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; bigfat flags
<span style="color:black">BIOSDATA:2917                                         </span>; (FAT16 fbig=40h, FAT32 fbigbig=20h)
<span style="color:black">BIOSDATA:291A                 </span><span style="color:navy">or      ds:</span>fbigfat<span style="color:navy">, cl
</span><span style="color:black">BIOSDATA:291E                 </span><span style="color:navy">mov     cx, cs:[si+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; shift count (cl) -log base 2 of ch-
<span style="color:black">BIOSDATA:291E                                         </span>; sector per cluster (ch)
<span style="color:black">BIOSDATA:2922                 </span><span style="color:navy">mov     dx, cs:[si+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; root directory entries
<span style="color:black">BIOSDATA:2926                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], dx    </span>; [di+BDS.direntries]
<span style="color:black">BIOSDATA:2929                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">]    </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:292C                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:292F                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">8</span><span style="color:navy">], ch      </span>; [di+BDS.secperclus]
<span style="color:black">BIOSDATA:2932                 </span><span style="color:navy">test    ds:</span>fbigfat<span style="color:navy">, </span><span style="color:green">60h </span>; fbig+fbigbig ; FAT16 or FAT32
<span style="color:black">BIOSDATA:2937                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dobig
</span><span style="color:black">BIOSDATA:2939                 </span><span style="color:navy">xor     bx, bx          </span>; 12 bit fat (FAT12 fs)
<span style="color:black">BIOSDATA:293B                 </span><span style="color:navy">mov     bl, ch
</span><span style="color:black">BIOSDATA:293D                 </span><span style="color:navy">dec     bx
</span><span style="color:black">BIOSDATA:293E                 </span><span style="color:navy">add     bx, ax
</span><span style="color:black">BIOSDATA:2940                 </span><span style="color:navy">shr     bx, cl
</span><span style="color:black">BIOSDATA:2942                 </span><span style="color:navy">inc     bx              </span>; bx = 1+(bpb-&gt;maxsec+BDS.secperclus-1)
<span style="color:black">BIOSDATA:2942                                         </span>;      / BDS.secperclus
<span style="color:black">BIOSDATA:2943                 </span><span style="color:navy">and     bl, </span><span style="color:green">0FEh        </span>; bx &amp;= ~1; (=number of clusters)
<span style="color:black">BIOSDATA:2946                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">BIOSDATA:2948                 </span><span style="color:navy">shr     bx, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:294A                 </span><span style="color:navy">add     bx, si          </span>; number of FAT bytes
<span style="color:black">BIOSDATA:294C                 </span><span style="color:navy">add     bx, </span><span style="color:green">511         </span>; bx += 511 + bx/2
<span style="color:black">BIOSDATA:2950                 </span><span style="color:navy">shr     bh, </span><span style="color:green">1           </span>; bh &gt;&gt;= 1; (=bx/512)
<span style="color:black">BIOSDATA:2952                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], bh    </span>; [di+BDS.fatsecs]
<span style="color:black">BIOSDATA:2952                                         </span>; save number of fat sectors
<span style="color:black">BIOSDATA:2955                 </span><span style="color:navy">jmp     short </span>massage_bpb
<span style="color:black">BIOSDATA:2957 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2957
BIOSDATA:2957 </span><span style="color:gray">dobig</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2957                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; 16 (2^4) directory entries per sector
<span style="color:black">BIOSDATA:2959                 </span><span style="color:navy">push    dx              </span>; save total sectors (high)
<span style="color:black">BIOSDATA:295A                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">]    </span>; [di+BDS.direntries]
<span style="color:black">BIOSDATA:295D                 </span><span style="color:navy">shr     dx, cl          </span>; root dir sectors = BDS.direntries / 16;
<span style="color:black">BIOSDATA:295F                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:black">BIOSDATA:2961                 </span><span style="color:navy">pop     dx              </span>; restore total sectors (high)
<span style="color:black">BIOSDATA:2962                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = total sectors - root dir sectors
<span style="color:black">BIOSDATA:2965                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">1           </span>; - reserved sectors (1 for FAT16 fs)
<span style="color:black">BIOSDATA:2968                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = t - r - d
<span style="color:black">BIOSDATA:2968                                         </span>; total secs - reserved secs - root dir secs
<span style="color:black">BIOSDATA:296B                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">2
</span><span style="color:black">BIOSDATA:296D                 </span><span style="color:navy">mov     bh, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [di+BDS.secperclus]
<span style="color:black">BIOSDATA:296D                                         </span>; bx = 256 * BDS.secperclus + 2
<span style="color:black">BIOSDATA:296D                                         </span>;
<span style="color:black">BIOSDATA:296D                                         </span>; ; 29/12/2018 - Erdogan Tan (Retro DOS v4.0)
<span style="color:black">BIOSDATA:296D                                         </span>; ; 27/09/2022
<span style="color:black">BIOSDATA:296D                                         </span>; ; (Microsoft FAT32 File System Specification,
<span style="color:black">BIOSDATA:296D                                         </span>; ; December 2000, Page 21)
<span style="color:black">BIOSDATA:296D                                         </span>; ; TmpVal1 = DskSize - (BPB_ResvdSecCnt+RootrDirSectors)
<span style="color:black">BIOSDATA:296D                                         </span>; ; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
<span style="color:black">BIOSDATA:296D                                         </span>; ; 8/8/2023 (Retro DOS v5.0)
<span style="color:black">BIOSDATA:296D                                         </span>; ; If(FATType == FAT32)
<span style="color:black">BIOSDATA:296D                                         </span>; ;   TmpVal2 = TmpVal2 / 2;
<span style="color:black">BIOSDATA:296D                                         </span>; ; FATsz = (TmpVal1+(TmpVal2-1))/TmpVal2
<span style="color:black">BIOSDATA:296D                                         </span>; ; 8/8/2023 (Retro DOS v5.0)
<span style="color:black">BIOSDATA:296D                                         </span>; ; If(FATType == FAT32) {
<span style="color:black">BIOSDATA:296D                                         </span>; ;   BPB_FATSz16 = 0;
<span style="color:black">BIOSDATA:296D                                         </span>; ;   BPB_FATSz32 = FATSz;
<span style="color:black">BIOSDATA:296D                                         </span>; ;} else {
<span style="color:black">BIOSDATA:296D                                         </span>; ;   BPB_FATSz16 = LOWORD(FATSz);
<span style="color:black">BIOSDATA:296D                                         </span>; ;/* there is no BPB_FATSz32 in a FAT16 BPB */
<span style="color:black">BIOSDATA:296D                                         </span>; ;}
<span style="color:black">BIOSDATA:296D                                         </span>;
<span style="color:black">BIOSDATA:296D                                         </span>; dx:ax = TmpVal1, bx = TmpVal2
<span style="color:black">BIOSDATA:2970                 </span><span style="color:navy">add     ax, bx
</span><span style="color:black">BIOSDATA:2972                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = TmpVal1+TmpVal2
<span style="color:black">BIOSDATA:2975                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:2978                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = TmpVal1+TmpVal2-1
<span style="color:black">BIOSDATA:297B                 </span><span style="color:navy">test    ds:</span>fbigfat<span style="color:navy">, </span><span style="color:green">20h </span>; fbigbig (FAT32) flag
<span style="color:black">BIOSDATA:2980                 </span><span style="color:navy">jz      short </span><span style="color:gray">dobig1
</span><span style="color:black">BIOSDATA:2982                 </span><span style="color:navy">shr     bx, </span><span style="color:green">1           </span>; TmpVal2 = TmpVal2 / 2
<span style="color:black">BIOSDATA:2982                                         </span>; dx:ax = TmpVal1+(2*TmpVal2)-1
<span style="color:black">BIOSDATA:2984                 </span><span style="color:navy">sub     ax, </span><span style="color:green">31          </span>; reserved sectors = 32 (for FAT32 fs) /// 1+31 = 32
<span style="color:black">BIOSDATA:2987                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:298A                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:black">BIOSDATA:298C                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0           </span>; dx:ax = TmpVal1+(2*TmpVal2)-TmpVal2-1
<span style="color:black">BIOSDATA:298C                                         </span>;       = TmpVal1+(TmpVal2-1)
<span style="color:black">BIOSDATA:298F
BIOSDATA:298F </span><span style="color:gray">dobig1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:298F                 </span><span style="color:navy">push    ax              </span>; save lw of dividend
<span style="color:black">BIOSDATA:2990                 </span><span style="color:navy">mov     ax, dx          </span>; divide hw of dx:ax at first (as 1st stage)
<span style="color:black">BIOSDATA:2992                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2994                 </span><span style="color:navy">div     bx              </span>; 32 bit division, dx:ax/bx
<span style="color:black">BIOSDATA:2994                                         </span>; remainder in dx is hw of 2nd stage dividend
<span style="color:black">BIOSDATA:2996                 </span><span style="color:navy">mov     bp, ax          </span>; hw of quotient
<span style="color:black">BIOSDATA:2998                 </span><span style="color:navy">pop     ax              </span>; restore lw of dividend (of 1st stage)
<span style="color:black">BIOSDATA:2999                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:299B                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], ax    </span>; [di+BDS.fatsecs] ; number of fat sectors
<span style="color:black">BIOSDATA:299B                                         </span>; lw of quotient
<span style="color:black">BIOSDATA:299E                 </span><span style="color:navy">mov     bl, ds:</span>fbigfat
<span style="color:black">BIOSDATA:29A2                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], bl    </span>; [di+BDS.fatsiz] ; fat size flag
<span style="color:black">BIOSDATA:29A5                 </span><span style="color:navy">test    bl, </span><span style="color:green">20h         </span>; fbigbig (FAT32) flag
<span style="color:black">BIOSDATA:29A8                 </span><span style="color:navy">jz      short </span><span style="color:gray">dobig2    </span>; not FAT32
<span style="color:black">BIOSDATA:29AA                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], ax    </span>; [di+BDS.fatsecs32]
<span style="color:black">BIOSDATA:29AD                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">21h</span><span style="color:navy">], bp    </span>; [di+BDS.fatsecs32+2]
<span style="color:black">BIOSDATA:29B0                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [di+BDS.fatsecs] = 0
<span style="color:black">BIOSDATA:29B0                                         </span>; clear 16 bit FAT size field
<span style="color:black">BIOSDATA:29B5                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">9</span><span style="color:navy">], </span><span style="color:green">32 </span>; [di+BDS.resectors]
<span style="color:black">BIOSDATA:29B5                                         </span>; set reserved sectors to 32 (FAT32 de facto)
<span style="color:black">BIOSDATA:29BA
BIOSDATA:29BA </span><span style="color:gray">dobig2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:29BA                 </span><span style="color:navy">push    ds              </span>; set the default filesys_id,
<span style="color:black">BIOSDATA:29BA                                         </span>;     volume label, serial number
<span style="color:black">BIOSDATA:29BB                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:29BC                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:29BD                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:29BE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:29BF                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:29BF                 </span><span style="color:navy">mov     bp, offset </span>clear_ids
<span style="color:black">BIOSDATA:29C2                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:29C3                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:black">BIOSDATA:29C6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:29C7                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:29C7
BIOSDATA:29C7 </span>massage_bpb<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:29C7                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">]    </span>; [di+BDS.totalsecs32+2]
<span style="color:black">BIOSDATA:29CA                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]    </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:29CD                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:29D0                 </span><span style="color:navy">ja      short </span>goodret
<span style="color:black">BIOSDATA:29D2                 </span><span style="color:navy">cmp     word ptr [di+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [di+BDS.hiddensecs+2]
<span style="color:black">BIOSDATA:29D6                 </span><span style="color:navy">ja      short </span>goodret
<span style="color:black">BIOSDATA:29D8                 </span><span style="color:navy">add     ax, [di+</span><span style="color:#ff8000">17h</span><span style="color:navy">]    </span>; [di+BDS.hiddensecs]
<span style="color:black">BIOSDATA:29DB                 </span><span style="color:navy">jb      short </span>goodret
<span style="color:black">BIOSDATA:29DD                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]    </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:29E0                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], ax    </span>; [di+BDS.totalsecs16]
<span style="color:black">BIOSDATA:29E3                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:29E8
BIOSDATA:29E8 </span>goodret<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:29E8                 </span><span style="color:navy">mov     bl, ds:</span>fbigfat
<span style="color:black">BIOSDATA:29EC                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], bl    </span>; [di+BDS.fatsiz]
<span style="color:black">BIOSDATA:29EC                                         </span>; set size of fat on media
<span style="color:black">BIOSDATA:29EF                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSDATA:29F0
BIOSDATA:29F0 </span>ret_hard_err<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:29F0                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:29F1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:29F2                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:29F3                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:29F4                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:29F4 </span><span style="background:red">copybpb_fat     endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">BIOSDATA:29F4
BIOSDATA:29F5
BIOSDATA:29F5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:29F5
BIOSDATA:29F5
BIOSDATA:29F5 </span>cover_fdisk_bug <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:29F5                 </span><span style="color:navy">push    ax              </span>; fdisk of pc dos 3.3 and below, os2 1.0 has a bug.
<span style="color:black">BIOSDATA:29F5                                         </span>; the maximum number of sector that can be handled by pc dos 3.3
<span style="color:black">BIOSDATA:29F5                                         </span>; ibmbio should be 0ffffh. instead, sometimes fdisk use 10000h to
<span style="color:black">BIOSDATA:29F5                                         </span>; calculate the maximum number. so, we are going to check that if
<span style="color:black">BIOSDATA:29F5                                         </span>; BPB_TOTALSECTORS + hidden sector = 10000h then subtract 1 from
<span style="color:black">BIOSDATA:29F5                                         </span>; BPB_TOTALSECTORS.
<span style="color:black">BIOSDATA:29F6                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:29F7                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:29F8                 </span><span style="color:navy">cmp     word ptr cs:</span>disksector<span style="color:navy">+</span><span style="color:green">16h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB_FATSz16
<span style="color:black">BIOSDATA:29FE                 </span><span style="color:navy">jz      short </span><span style="color:gray">cfb_retit </span>; FAT32 boot sector
<span style="color:black">BIOSDATA:2A00                 </span><span style="color:navy">cmp     cs:</span>disksector<span style="color:navy">+</span><span style="color:green">26h</span><span style="color:navy">, </span><span style="color:#ff8000">29h </span><span style="color:gray">; &#039;)&#039; </span>;
<span style="color:black">BIOSDATA:2A00                                         </span>; [disksector+EXT_BOOT.SIG], EXT_BOOT_SIGNATURE
<span style="color:black">BIOSDATA:2A06                 </span><span style="color:navy">jz      short </span><span style="color:gray">cfb_retit </span>; if extended bpb, then &gt;= pc dos 4.00
<span style="color:black">BIOSDATA:2A08                 </span><span style="color:navy">cmp     word ptr cs:[bx+</span><span style="color:#ff8000">7</span><span style="color:navy">], </span><span style="color:#ff8000">3031h </span>; &#039;10&#039; ; os2 1.0 = ibm 10.0
<span style="color:black">BIOSDATA:2A0E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cfb_chk_totalsecs
</span><span style="color:black">BIOSDATA:2A10                 </span><span style="color:navy">cmp     byte ptr cs:[bx+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;
</span><span style="color:black">BIOSDATA:2A15                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cfb_retit
</span><span style="color:black">BIOSDATA:2A17
BIOSDATA:2A17 </span><span style="color:gray">cfb_chk_totalsecs</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2A17                 </span><span style="color:navy">mov     si, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">0Bh</span><span style="color:navy">) </span>; 15Dh
<span style="color:black">BIOSDATA:2A17                                         </span>; disksector+EXT_BOOT.BPB
<span style="color:black">BIOSDATA:2A1A                 </span><span style="color:navy">cmp     word ptr cs:[si+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [cs:si+EBPB.TOTALSECTORS]
<span style="color:black">BIOSDATA:2A1F                 </span><span style="color:navy">jz      short </span><span style="color:gray">cfb_retit </span>; just to make sure.
<span style="color:black">BIOSDATA:2A21                 </span><span style="color:navy">mov     ax, cs:[si+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">BIOSDATA:2A25                 </span><span style="color:navy">add     ax, cs:[si+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [cs:si+EBPB.HIDDENSECTORS]
<span style="color:black">BIOSDATA:2A29                 </span><span style="color:navy">jnb     short </span><span style="color:gray">cfb_retit
</span><span style="color:black">BIOSDATA:2A2B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cfb_retit </span>;
<span style="color:black">BIOSDATA:2A2B                                         </span>; if carry set and ax=0
<span style="color:black">BIOSDATA:2A2D                 </span><span style="color:navy">dec     word ptr cs:[si+</span><span style="color:#ff8000">8</span><span style="color:navy">] </span>; then decrease BPB_TOTALSECTORS by 1
<span style="color:black">BIOSDATA:2A31                 </span><span style="color:navy">sub     word ptr [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:2A35                 </span><span style="color:navy">sbb     word ptr [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [di+BDS.totalsecs32+2]
<span style="color:black">BIOSDATA:2A39
BIOSDATA:2A39 </span><span style="color:gray">cfb_retit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2A39                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:2A3A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2A3B                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2A3C                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2A3C </span>cover_fdisk_bug <span style="color:black">endp
BIOSDATA:2A3C
BIOSDATA:2A3C </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:2A3D </span>word2           <span style="color:navy">dw </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:2A3F </span>word3           <span style="color:navy">dw </span><span style="color:#008040">3                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSDATA:2A41 </span>word512         <span style="color:navy">dw </span><span style="color:#008040">200h                 </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:2A43
BIOSDATA:2A43 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2A43
BIOSDATA:2A43
BIOSDATA:2A43 </span>setdrvparms     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2A43                 </span><span style="color:navy">xor     bx, bx          </span>; setdrvparms sets up the recommended bpb in each bds
<span style="color:black">BIOSDATA:2A43                                         </span>; in the system based on the form factor.
<span style="color:black">BIOSDATA:2A43                                         </span>; it is assumed that the bpbs for the various form factors
<span style="color:black">BIOSDATA:2A43                                         </span>; are present in the bpbtable. for hard files,
<span style="color:black">BIOSDATA:2A43                                         </span>; the recommended bpb is the same as the bpb on the drive.
<span style="color:black">BIOSDATA:2A45                 </span><span style="color:navy">les     di, dword ptr ds:</span>start_bds ; get first bds in list
<span style="color:black">BIOSDATA:2A49
BIOSDATA:2A49 </span><span style="color:gray">_next_bds</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2A49                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2A4A                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:2A4B                 </span><span style="color:navy">mov     bl, es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">] </span>; [es:di+BDS.formfactor]
<span style="color:black">BIOSDATA:2A4F                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">5           </span>; ffHardFile
<span style="color:black">BIOSDATA:2A52                 </span><span style="color:navy">jnz     short </span><span style="color:gray">nothardff
</span><span style="color:black">BIOSDATA:2A54                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2A56                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">] </span>; [es:di+BDS.totalsecs16]
<span style="color:black">BIOSDATA:2A5A                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">BIOSDATA:2A5C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">get_ccyl
</span><span style="color:black">BIOSDATA:2A5E                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">] </span>; [es:di+BDS.totalsecs32+2]
<span style="color:black">BIOSDATA:2A62                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">] </span>; [es:di+BDS.totalsecs32]
<span style="color:black">BIOSDATA:2A66
BIOSDATA:2A66 </span><span style="color:gray">get_ccyl</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2A66                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2A67                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2A68                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+BDS.heads]
<span style="color:black">BIOSDATA:2A6C                 </span><span style="color:navy">mul     word ptr es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSDATA:2A6C                                         </span>; assume sectors per cyl. &lt; 64k.
<span style="color:black">BIOSDATA:2A70                 </span><span style="color:navy">mov     cx, ax          </span>; cx has # sectors per cylinder
<span style="color:black">BIOSDATA:2A72                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2A73                 </span><span style="color:navy">pop     dx              </span>; dx:ax = total sectors
<span style="color:black">BIOSDATA:2A74                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2A75                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">BIOSDATA:2A77                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2A79                 </span><span style="color:navy">div     cx
</span><span style="color:black">BIOSDATA:2A7B                 </span><span style="color:navy">mov     cs:</span>saved_word<span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2A7F                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2A80                 </span><span style="color:navy">div     cx              </span>; div #sec by sec/cyl to get # cyl.
<span style="color:black">BIOSDATA:2A82                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">BIOSDATA:2A84                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_cyl_rnd
</span><span style="color:black">BIOSDATA:2A86                 </span><span style="color:navy">inc     ax              </span>; round up
<span style="color:black">BIOSDATA:2A87
BIOSDATA:2A87 </span><span style="color:gray">no_cyl_rnd</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2A87                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">41h</span><span style="color:navy">], ax </span>; [es:di+BDS.cylinders]
<span style="color:black">BIOSDATA:2A8B                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2A8C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2A8D                 </span><span style="color:navy">lea     si, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [di+BDS.bytespersec]
<span style="color:black">BIOSDATA:2A8D                                         </span>; ds:si -&gt; bpb for hard file
<span style="color:black">BIOSDATA:2A90                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set_recbpb
</span><span style="color:black">BIOSDATA:2A92 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2A92
BIOSDATA:2A92 </span><span style="color:gray">nothardff</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2A92                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:2A93                 </span><span style="color:navy">pop     ds              </span>; if fake floppy drive variable is set
<span style="color:black">BIOSDATA:2A93                                         </span>; then we don&#039;t have to handle this bds.
<span style="color:black">BIOSDATA:2A93                                         </span>; we can just go and deal with the next bds
<span style="color:black">BIOSDATA:2A93                                         </span>; at label go_to_next_bds.
<span style="color:black">BIOSDATA:2A94                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:2A94                 </span><span style="color:navy">cmp     cs:</span>fakefloppydrv<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:2A9A                 </span><span style="color:navy">jz      short </span><span style="color:gray">go_to_next_bds
</span><span style="color:black">BIOSDATA:2A9C                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">7           </span>; ffother
<span style="color:black">BIOSDATA:2A9C                                         </span>; special case &quot;other&quot; type of medium
<span style="color:black">BIOSDATA:2A9F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_process_other
</span><span style="color:black">BIOSDATA:2AA1                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2AA3                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">41h</span><span style="color:navy">]    </span>; [di+BDS.cylinders]
<span style="color:black">BIOSDATA:2AA6                 </span><span style="color:navy">mul     word ptr [di+</span><span style="color:#ff8000">52h</span><span style="color:navy">] </span>; [di+BDS.rheads]
<span style="color:black">BIOSDATA:2AA9                 </span><span style="color:navy">mul     word ptr [di+</span><span style="color:#ff8000">50h</span><span style="color:navy">] </span>; [di+BDS.rsecpertrack]
<span style="color:black">BIOSDATA:2AAC                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], ax    </span>; [di+BDS.rtotalsecs16]
<span style="color:black">BIOSDATA:2AAC                                         </span>; have the total number of sectors
<span style="color:black">BIOSDATA:2AAF                 </span><span style="color:navy">dec     ax
</span><span style="color:black">BIOSDATA:2AB0                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:2AB2
BIOSDATA:2AB2 </span><span style="color:gray">_again</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2AB2                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FF6h       </span>; 4096-10
<span style="color:black">BIOSDATA:2AB5                 </span><span style="color:navy">jb      short </span><span style="color:gray">_@@
</span><span style="color:black">BIOSDATA:2AB7                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2AB9                 </span><span style="color:navy">shl     dl, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2ABB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_again
</span><span style="color:black">BIOSDATA:2ABD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2ABD
BIOSDATA:2ABD </span><span style="color:gray">_@@</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2ABD                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">1           </span>; is it a small disk ?
<span style="color:black">BIOSDATA:2AC0                 </span><span style="color:navy">jz      short </span><span style="color:gray">__@@      </span>; yes, 224 root entries is enuf
<span style="color:black">BIOSDATA:2AC2                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], </span><span style="color:green">240 </span>; [di+BDS.rdirentries]
<span style="color:black">BIOSDATA:2AC7
BIOSDATA:2AC7 </span><span style="color:gray">__@@</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2AC7                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">45h</span><span style="color:navy">], dl    </span>; [di+BDS.rsecperclus]
<span style="color:black">BIOSDATA:2ACA                 </span><span style="color:navy">mul     cs:</span>word3        ; * 3
<span style="color:black">BIOSDATA:2ACF                 </span><span style="color:navy">div     cs:</span>word2        ; / 2
<span style="color:black">BIOSDATA:2AD4                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2AD6                 </span><span style="color:navy">div     cs:</span>word512      ; / 512
<span style="color:black">BIOSDATA:2ADB                 </span><span style="color:navy">inc     ax              </span>; + 1
<span style="color:black">BIOSDATA:2ADC                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">4Eh</span><span style="color:navy">], ax    </span>; [di+BDS.rfatsecs]
<span style="color:black">BIOSDATA:2ADF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">go_to_next_bds
</span><span style="color:black">BIOSDATA:2AE1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2AE1
BIOSDATA:2AE1 </span><span style="color:gray">not_process_other</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2AE1                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1           </span>; bx is word index into table of bpbs
<span style="color:black">BIOSDATA:2AE3                 </span><span style="color:navy">mov     si, offset </span>bpbtable
<span style="color:black">BIOSDATA:2AE6                 </span><span style="color:navy">mov     si, [bx+si]     </span>; get address of bpb
<span style="color:black">BIOSDATA:2AE8
BIOSDATA:2AE8 </span><span style="color:gray">set_recbpb</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2AE8                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">43h</span><span style="color:navy">]    </span>; [di+BDS.R_BPB]
<span style="color:black">BIOSDATA:2AE8                                         </span>; es:di -&gt; recbpb
<span style="color:black">BIOSDATA:2AEB                 </span><span style="color:navy">mov     cx, </span><span style="color:green">53          </span>; bpbx.size
<span style="color:black">BIOSDATA:2AEE                 </span><span style="color:navy">rep movsb               </span>; move (size bpbx) bytes
<span style="color:black">BIOSDATA:2AF0
BIOSDATA:2AF0 </span><span style="color:gray">go_to_next_bds</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2AF0                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:2AF1                 </span><span style="color:navy">pop     es              </span>; restore pointer to bds
<span style="color:black">BIOSDATA:2AF2                 </span><span style="color:navy">les     di, es:[di]     </span>; [es:di+BDS.link]
<span style="color:black">BIOSDATA:2AF5                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">BIOSDATA:2AF8                 </span><span style="color:navy">jz      short </span><span style="color:gray">got_end_of_bds_chain
</span><span style="color:black">BIOSDATA:2AFA                 </span><span style="color:navy">jmp     </span><span style="color:gray">_next_bds
</span><span style="color:black">BIOSDATA:2AFD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2AFD
BIOSDATA:2AFD </span><span style="color:gray">got_end_of_bds_chain</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2AFD                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2AFD </span>setdrvparms     <span style="color:black">endp
BIOSDATA:2AFD
BIOSDATA:2AFE
BIOSDATA:2AFE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2AFE
BIOSDATA:2AFE
BIOSDATA:2AFE </span>print_init      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2AFE                 </span><span style="color:navy">cbw
</span><span style="color:black">BIOSDATA:2AFF                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">BIOSDATA:2B01                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:2B03                 </span><span style="color:navy">int     </span><span style="color:green">17h             </span>; PRINTER - INITIALIZE
<span style="color:black">BIOSDATA:2B03                                         </span>; DX = printer port (0-3)
<span style="color:black">BIOSDATA:2B03                                         </span>; Return: AH = status
<span style="color:black">BIOSDATA:2B05                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2B05 </span>print_init      <span style="color:black">endp
BIOSDATA:2B05
BIOSDATA:2B06
BIOSDATA:2B06 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2B06
BIOSDATA:2B06
BIOSDATA:2B06 </span>aux_init        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B06                 </span><span style="color:navy">cbw
</span><span style="color:black">BIOSDATA:2B07                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">BIOSDATA:2B09                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0A3h        </span>; RSINIT ; 0A3h
<span style="color:black">BIOSDATA:2B09                                         </span>; 2400,n,1,8 (msequ.inc)
<span style="color:black">BIOSDATA:2B0B                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2B0D                 </span><span style="color:navy">int     </span><span style="color:green">14h             </span>; SERIAL I/O - INITIALIZE USART
<span style="color:black">BIOSDATA:2B0D                                         </span>; AL = initializing parameters, DX = port number (0-3)
<span style="color:black">BIOSDATA:2B0D                                         </span>; Return: AH = RS-232 status code bits, AL = modem status bits
<span style="color:black">BIOSDATA:2B0F                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2B0F </span>aux_init        <span style="color:black">endp
BIOSDATA:2B0F
BIOSDATA:2B10
BIOSDATA:2B10 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2B10
BIOSDATA:2B10
BIOSDATA:2B10 </span>domini          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B10                 </span><span style="color:navy">mov     dh, </span>hnum        ; mini disk initialization routine
<span style="color:black">BIOSDATA:2B10                                         </span>; get number of hardfiles
<span style="color:black">BIOSDATA:2B14                 </span><span style="color:navy">cmp     dh, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2B17                 </span><span style="color:navy">jz      short </span><span style="color:gray">dominiret </span>; no hard file? then exit.
<span style="color:black">BIOSDATA:2B19                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">80h         </span>; start with hardfile 80h
<span style="color:black">BIOSDATA:2B1B
BIOSDATA:2B1B </span><span style="color:gray">domini_loop</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B1B                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">BIOSDATA:2B1D                 </span><span style="color:navy">mov     cs:</span>ep_start_sector<span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2B21                 </span><span style="color:navy">mov     cs:</span>ep_start_sector<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2B25                 </span><span style="color:navy">mov     cs:</span>ep_hidden_secs<span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2B29                 </span><span style="color:navy">mov     cs:</span>ep_hidden_secs<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2B2D                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2B2E                 </span><span style="color:navy">mov     </span>rom_minidisk_num<span style="color:navy">, dl
</span><span style="color:black">BIOSDATA:2B32                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">8
</span><span style="color:black">BIOSDATA:2B34                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
<span style="color:black">BIOSDATA:2B34                                         </span>; DL = drive number
<span style="color:black">BIOSDATA:2B34                                         </span>; Return: CF set on error, AH = status code, BL = drive type
<span style="color:black">BIOSDATA:2B34                                         </span>; DL = number of consecutive drives
<span style="color:black">BIOSDATA:2B34                                         </span>; DH = maximum value for head number, ES:DI -&gt; drive parameter
<span style="color:black">BIOSDATA:2B36                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">BIOSDATA:2B38                 </span><span style="color:navy">mov     al, dh          </span>; &lt;= 255
<span style="color:black">BIOSDATA:2B3A                 </span><span style="color:navy">inc     ax              </span>; (0FFh -&gt; 100h)
<span style="color:black">BIOSDATA:2B3B                 </span><span style="color:navy">mov     </span>mini_hdlim<span style="color:navy">, ax  </span>; # of heads
<span style="color:black">BIOSDATA:2B3E                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">BIOSDATA:2B40                 </span><span style="color:navy">and     ax, </span><span style="color:green">3Fh
</span><span style="color:black">BIOSDATA:2B43                 </span><span style="color:navy">mov     </span>mini_seclim<span style="color:navy">, ax </span>; # of sectors/track
<span style="color:black">BIOSDATA:2B46                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2B47                 </span><span style="color:navy">mov     dl, </span>rom_minidisk_num
<span style="color:black">BIOSDATA:2B4B                 </span><span style="color:navy">call    </span>getboot         ; read master boot record into
<span style="color:black">BIOSDATA:2B4B                                         </span>; initbootsegment:bootbias
<span style="color:black">BIOSDATA:2B4E                 </span><span style="color:navy">jb      short </span><span style="color:gray">domininext
</span><span style="color:black">BIOSDATA:2B50                 </span><span style="color:navy">call    </span>find_mini_partition
<span style="color:black">BIOSDATA:2B53
BIOSDATA:2B53 </span><span style="color:gray">domininext</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B53                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2B54                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2B55                 </span><span style="color:navy">inc     dl              </span>; next hard file
<span style="color:black">BIOSDATA:2B57                 </span><span style="color:navy">dec     dh
</span><span style="color:black">BIOSDATA:2B59                 </span><span style="color:navy">jnz     short </span><span style="color:gray">domini_loop
</span><span style="color:black">BIOSDATA:2B5B
BIOSDATA:2B5B </span><span style="color:gray">dominiret</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B5B                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2B5B </span>domini          <span style="color:black">endp
BIOSDATA:2B5B
BIOSDATA:2B5C
BIOSDATA:2B5C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2B5C
BIOSDATA:2B5C
BIOSDATA:2B5C </span>find_mini_partition <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B5C                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">1C2h        </span>; tries to find every extended partition on a disk
<span style="color:black">BIOSDATA:2B5C                                         </span>; bx -&gt; file system id
<span style="color:black">BIOSDATA:2B60                 </span><span style="color:navy">mov     </span>ld_p_number<span style="color:navy">, </span><span style="color:green">26
</span><span style="color:black">BIOSDATA:2B66
BIOSDATA:2B66 </span><span style="color:gray">fmpnext</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B66                 </span><span style="color:navy">add     </span>ld_p_number<span style="color:navy">, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:2B6B                 </span><span style="color:navy">cmp     </span>ld_p_number<span style="color:navy">, </span><span style="color:green">4122 </span>; 64 logical disk partitions (64 EBRs)
<span style="color:black">BIOSDATA:2B6B                                         </span>; (64*4 = 256 pte&#039;s, 256*16 = 4096, + 26 = 4122)
<span style="color:black">BIOSDATA:2B71                 </span><span style="color:navy">jg      short </span><span style="color:gray">fmpnextfound
</span><span style="color:black">BIOSDATA:2B73                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">5 </span>; Extended DOS CHS
<span style="color:black">BIOSDATA:2B77                 </span><span style="color:navy">jz      short </span><span style="color:gray">fmpgot
</span><span style="color:black">BIOSDATA:2B79                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Fh </span>; Extended DOS LBA
<span style="color:black">BIOSDATA:2B7D                 </span><span style="color:navy">jz      short </span><span style="color:gray">fmpgot
</span><span style="color:black">BIOSDATA:2B7F                 </span><span style="color:navy">add     bx, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:2B82                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">402h        </span>; 202h+bootbias
<span style="color:black">BIOSDATA:2B86                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fmpnext
</span><span style="color:black">BIOSDATA:2B88
BIOSDATA:2B88 </span><span style="color:gray">fmpnextfound</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B88                 </span><span style="color:navy">jmp     </span><span style="color:gray">_fmpnextfound   </span>; extended partition not found
<span style="color:black">BIOSDATA:2B8B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2B8B
BIOSDATA:2B8B </span><span style="color:gray">fmpgot</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2B8B                 </span><span style="color:navy">call    </span>dmax_check      ; check for drvmax already 26
<span style="color:black">BIOSDATA:2B8E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">fmpnextfound </span>; done if too many
<span style="color:black">BIOSDATA:2B90                 </span><span style="color:navy">mov     di, </span>end_of_bdss ; get next free bds
<span style="color:black">BIOSDATA:2B94                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">79h</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [di+BDS.bdsm_ismini]
<span style="color:black">BIOSDATA:2B99                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [di+BDS.flags],fNon_Removable
<span style="color:black">BIOSDATA:2B9D                 </span><span style="color:navy">mov     byte ptr [di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], </span><span style="color:#ff8000">5 </span>; [di+BDS.formfactor],ffHardFile
<span style="color:black">BIOSDATA:2BA1                 </span><span style="color:navy">mov     </span>fbigfat<span style="color:navy">, </span><span style="color:#ff8000">0      </span>; assume 12 bit fat.
<span style="color:black">BIOSDATA:2BA6                 </span><span style="color:navy">mov     ax, </span>mini_hdlim
<span style="color:black">BIOSDATA:2BA9                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax    </span>; [di+BDS.heads]
<span style="color:black">BIOSDATA:2BAC                 </span><span style="color:navy">mov     ax, </span>mini_seclim
<span style="color:black">BIOSDATA:2BAF                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], ax    </span>; [di+BDS.secpertrack]
<span style="color:black">BIOSDATA:2BB2                 </span><span style="color:navy">mov     al, </span>rom_minidisk_num
<span style="color:black">BIOSDATA:2BB5                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al      </span>; [di+BDS.drivenum] ; set physical number
<span style="color:black">BIOSDATA:2BB8                 </span><span style="color:navy">mov     al, </span>drvmax
<span style="color:black">BIOSDATA:2BBB                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], al      </span>; [di+BDS.drivelet] ; set logical number
<span style="color:black">BIOSDATA:2BBE                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:green">10</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2BC3                 </span><span style="color:navy">ja      short </span><span style="color:gray">fmpgot1
</span><span style="color:black">BIOSDATA:2BC5                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:green">8</span><span style="color:navy">], </span><span style="color:green">64 </span>; minimum 64 sectors
<span style="color:black">BIOSDATA:2BCA                 </span><span style="color:navy">jb      short </span><span style="color:gray">fmpnextfound
</span><span style="color:black">BIOSDATA:2BCC
BIOSDATA:2BCC </span><span style="color:gray">fmpgot1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2BCC                 </span><span style="color:navy">sub     bx, </span><span style="color:#ff8000">4           </span>; let bx point to the start of the entry
<span style="color:black">BIOSDATA:2BCF                 </span><span style="color:navy">mov     dh, es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; cylinder
<span style="color:black">BIOSDATA:2BD3                 </span><span style="color:navy">and     dh, </span><span style="color:green">0C0h        </span>; get higher bits of cyl
<span style="color:black">BIOSDATA:2BD6                 </span><span style="color:navy">rol     dh, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2BD8                 </span><span style="color:navy">rol     dh, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2BDA                 </span><span style="color:navy">mov     dl, es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; cyl byte
<span style="color:black">BIOSDATA:2BDE                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">], dx    </span>; [di+BDS.bdsm_hidden_trks] ; set hidden trks
<span style="color:black">BIOSDATA:2BE1                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:2BE2                 </span><span style="color:navy">mov     cx, es:[bx+</span><span style="color:green">8</span><span style="color:navy">]   </span>; partition size, lw
<span style="color:black">BIOSDATA:2BE6                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:green">10</span><span style="color:navy">]  </span>; partition size, hw
<span style="color:black">BIOSDATA:2BEA                 </span><span style="color:navy">add     cx, </span>ep_start_sector
<span style="color:black">BIOSDATA:2BEE                 </span><span style="color:navy">adc     ax, </span>ep_start_sector<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">BIOSDATA:2BF2                 </span><span style="color:navy">cmp     </span>ep_start_sector<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2BF7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fmpgot2
</span><span style="color:black">BIOSDATA:2BF9                 </span><span style="color:navy">cmp     </span>ep_start_sector<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2BFE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fmpgot2
</span><span style="color:black">BIOSDATA:2C00                 </span><span style="color:navy">mov     </span>ep_start_sector<span style="color:navy">, cx
</span><span style="color:black">BIOSDATA:2C04                 </span><span style="color:navy">mov     </span>ep_start_sector<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">BIOSDATA:2C07
BIOSDATA:2C07 </span><span style="color:gray">fmpgot2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C07                 </span><span style="color:navy">mov     </span>ep_hidden_secs<span style="color:navy">, cx
</span><span style="color:black">BIOSDATA:2C0B                 </span><span style="color:navy">mov     </span>ep_hidden_secs<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax </span>;
<span style="color:black">BIOSDATA:2C0B                                         </span>; convert start sector address to CHS
<span style="color:black">BIOSDATA:2C0E                 </span><span style="color:navy">mov     bx, [di+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [di+BDS.secpertrack]
<span style="color:black">BIOSDATA:2C11                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2C13                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:2C15                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">BIOSDATA:2C16                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:2C18                 </span><span style="color:navy">mov     bx, [di+</span><span style="color:#ff8000">15h</span><span style="color:navy">]    </span>; [di+BDS.heads]
<span style="color:black">BIOSDATA:2C1B                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">BIOSDATA:2C1C                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2C1E                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:2C20                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">BIOSDATA:2C21                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSDATA:2C23                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:2C24                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">BIOSDATA:2C26                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fmpgot_lba_rd
</span><span style="color:black">BIOSDATA:2C28                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">1024        </span>; cylinder number &lt; 1024, CHS read is proper
<span style="color:black">BIOSDATA:2C2B                 </span><span style="color:navy">jb      short </span><span style="color:gray">fmpgot_chs_rd
</span><span style="color:black">BIOSDATA:2C2D
BIOSDATA:2C2D </span><span style="color:gray">fmpgot_lba_rd</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C2D                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">4 </span>; set fLBArw flag ; LBA read/write ok/ready
<span style="color:black">BIOSDATA:2C31                 </span><span style="color:navy">mov     dl, </span>rom_minidisk_num
<span style="color:black">BIOSDATA:2C35                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2C36                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:2C37                 </span><span style="color:navy">xor     ax, ax          </span>; push bp
<span style="color:black">BIOSDATA:2C37                                         </span>; mov bp, sp ; (*)
<span style="color:black">BIOSDATA:2C39                 </span><span style="color:navy">push    ax              </span>; 0
<span style="color:black">BIOSDATA:2C3A                 </span><span style="color:navy">push    ax              </span>; 0
<span style="color:black">BIOSDATA:2C3B                 </span><span style="color:navy">push    </span>ep_hidden_secs<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">BIOSDATA:2C3F                 </span><span style="color:navy">push    </span>ep_hidden_secs
<span style="color:black">BIOSDATA:2C43                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">200h        </span>; bootbias (buffer offset)
<span style="color:black">BIOSDATA:2C46                 </span><span style="color:navy">push    es              </span>; buffer segment
<span style="color:black">BIOSDATA:2C47                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2C48                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:2C4B                 </span><span style="color:navy">push    ax              </span>; read count
<span style="color:black">BIOSDATA:2C4C                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">10h         </span>; DAP size = 16
<span style="color:black">BIOSDATA:2C4F                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2C50                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">BIOSDATA:2C52                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">BIOSDATA:2C54                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:2C54                 </span><span style="color:navy">mov     si, sp          </span>; ds:si = Disk Address Packet
<span style="color:black">BIOSDATA:2C56                 </span><span style="color:navy">mov     ah, </span><span style="color:green">42h         </span>; LBA read
<span style="color:black">BIOSDATA:2C58                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension
<span style="color:black">BIOSDATA:2C58                                         </span>; EXTENDED READ (DL - drive, DS:SI - disk address packet)
<span style="color:black">BIOSDATA:2C5A                 </span><span style="color:navy">pushf                   </span>; BUG! Erdogan Tan - 08/08/2023
<span style="color:black">BIOSDATA:2C5B                 </span><span style="color:navy">add     sp, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:2C5E                 </span><span style="color:navy">popf                    </span>; BUG!
<span style="color:black">BIOSDATA:2C5E                                         </span>; mov sp, bp ; (*)
<span style="color:black">BIOSDATA:2C5E                                         </span>; pop bp
<span style="color:black">BIOSDATA:2C5F                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:2C60                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2C61                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:2C61                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fmpgot3
</span><span style="color:black">BIOSDATA:2C63 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2C63
BIOSDATA:2C63 </span><span style="color:gray">fmpgot_chs_rd</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C63                 </span><span style="color:navy">mov     cx, es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; cylinder,cylinder/sector
<span style="color:black">BIOSDATA:2C67                 </span><span style="color:navy">mov     dh, es:[bx+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; head
<span style="color:black">BIOSDATA:2C6B                 </span><span style="color:navy">mov     dl, ds:</span>rom_minidisk_num
<span style="color:black">BIOSDATA:2C6F                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">200h        </span>; bootbias
<span style="color:black">BIOSDATA:2C72                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h
</span><span style="color:black">BIOSDATA:2C75                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - READ SECTORS INTO MEMORY
<span style="color:black">BIOSDATA:2C75                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:black">BIOSDATA:2C75                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:black">BIOSDATA:2C75                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:black">BIOSDATA:2C77
BIOSDATA:2C77 </span><span style="color:gray">fmpgot3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C77                 </span><span style="color:navy">jb      short </span><span style="color:gray">_fmpnextfound
</span><span style="color:black">BIOSDATA:2C79                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">3C2h        </span>; 1C2h+bootbias
<span style="color:black">BIOSDATA:2C7C                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:#ff8000">3Ch</span><span style="color:navy">], </span><span style="color:green">0AA55h </span>; 03C2h+03Ch = 3FEh
<span style="color:black">BIOSDATA:2C82                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_fmpnextfound </span>; not a valid boot sector !
<span style="color:black">BIOSDATA:2C84                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2C85                 </span><span style="color:navy">call    </span>setmini         ; install a mini disk.
<span style="color:black">BIOSDATA:2C85                                         </span>; bx value saved.
<span style="color:black">BIOSDATA:2C88                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2C89                 </span><span style="color:navy">jb      short </span><span style="color:gray">fmpnextchain
</span><span style="color:black">BIOSDATA:2C8B                 </span><span style="color:navy">call    </span>xinstall_bds    ; -- install the bdsm into table
<span style="color:black">BIOSDATA:2C8E
BIOSDATA:2C8E </span><span style="color:gray">fmpnextchain</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C8E                 </span><span style="color:navy">jmp     </span><span style="color:gray">fmpnext
</span><span style="color:black">BIOSDATA:2C91 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2C91
BIOSDATA:2C91 </span><span style="color:gray">_fmpnextfound</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C91                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2C91 </span>find_mini_partition <span style="color:black">endp
BIOSDATA:2C91
BIOSDATA:2C92
BIOSDATA:2C92 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2C92
BIOSDATA:2C92
BIOSDATA:2C92 </span>setmini         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C92                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:2C93                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:2C94                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2C95                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2C96
BIOSDATA:2C96 </span><span style="color:gray">setmini_1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2C96                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">1 </span>; FAT12 partition
<span style="color:black">BIOSDATA:2C9A                 </span><span style="color:navy">jz      short </span><span style="color:gray">setmini_2
</span><span style="color:black">BIOSDATA:2C9C                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">4 </span>; FAT16 (CHS) partition
<span style="color:black">BIOSDATA:2CA0                 </span><span style="color:navy">jz      short </span><span style="color:gray">setmini_2
</span><span style="color:black">BIOSDATA:2CA2                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">6 </span>; FAT16 Big (CHS) partition
<span style="color:black">BIOSDATA:2CA6                 </span><span style="color:navy">jz      short </span><span style="color:gray">setmini_2
</span><span style="color:black">BIOSDATA:2CA8                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Bh </span>; FAT32 (CHS) partition
<span style="color:black">BIOSDATA:2CAC                 </span><span style="color:navy">jz      short </span><span style="color:gray">setmini_2
</span><span style="color:black">BIOSDATA:2CAE                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Ch </span>; FAT32 (LBA) partition
<span style="color:black">BIOSDATA:2CB2                 </span><span style="color:navy">jz      short </span><span style="color:gray">setmini_2
</span><span style="color:black">BIOSDATA:2CB4                 </span><span style="color:navy">cmp     byte ptr es:[bx], </span><span style="color:#ff8000">0Eh </span>; FAT16 (LBA) partition
<span style="color:black">BIOSDATA:2CB8                 </span><span style="color:navy">jz      short </span><span style="color:gray">setmini_2
</span><span style="color:black">BIOSDATA:2CBA                 </span><span style="color:navy">add     bx, </span><span style="color:green">16
</span><span style="color:black">BIOSDATA:2CBD                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">402h        </span>; 202h+bootbias
<span style="color:black">BIOSDATA:2CC1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setmini_1
</span><span style="color:black">BIOSDATA:2CC3                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSDATA:2CC4                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2CC5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2CC6                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:2CC7                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:2CC8                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2CC9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2CC9
BIOSDATA:2CC9 </span><span style="color:gray">setmini_2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2CC9                 </span><span style="color:navy">jmp     </span>set2            ; branch into middle of sethard
<span style="color:black">BIOSDATA:2CC9 </span>setmini         <span style="color:black">endp
BIOSDATA:2CC9
BIOSDATA:2CCC
BIOSDATA:2CCC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2CCC
BIOSDATA:2CCC
BIOSDATA:2CCC </span>dmax_check      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2CCC                 </span><span style="color:navy">cmp     ds:</span>drvmax<span style="color:navy">, </span><span style="color:green">26   </span>; checks for drvmax &lt; 26
<span style="color:black">BIOSDATA:2CD1                 </span><span style="color:navy">jb      short </span><span style="color:gray">dmax_ok   </span>; returns with carry if okay
<span style="color:black">BIOSDATA:2CD3                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2CD4                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">544h        </span>; SYSINIT segment
<span style="color:black">BIOSDATA:2CD7                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">BIOSDATA:2CD9                 </span>assume es:nothing
<span style="color:black">BIOSDATA:2CD9                 </span><span style="color:navy">mov     es:</span>toomanydrivesflag<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSDATA:2CDF                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2CE0                 </span>assume es:nothing
<span style="color:black">BIOSDATA:2CE0
BIOSDATA:2CE0 </span><span style="color:gray">dmax_ok</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2CE0                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2CE0 </span>dmax_check      <span style="color:black">endp
BIOSDATA:2CE0
BIOSDATA:2CE1
BIOSDATA:2CE1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2CE1
BIOSDATA:2CE1
BIOSDATA:2CE1 </span>xinstall_bds    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2CE1                 </span><span style="color:navy">push    si              </span>; link next bds (at ds:di) into the chain.
<span style="color:black">BIOSDATA:2CE1                                         </span>; assume that the chain is entirely within ds == datagrp.
<span style="color:black">BIOSDATA:2CE1                                         </span>; also update drvmax, dskdrv_table, and end_of_bdss.
<span style="color:black">BIOSDATA:2CE2                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:2CE3                 </span><span style="color:navy">mov     si, ds:</span>start_bds ; get first bds
<span style="color:black">BIOSDATA:2CE7
BIOSDATA:2CE7 </span><span style="color:gray">xinstall_bds_1</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2CE7                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:green">0FFFFh </span>; is this the last one?
<span style="color:black">BIOSDATA:2CEA                 </span><span style="color:navy">jz      short </span><span style="color:gray">xinstall_bds_2
</span><span style="color:black">BIOSDATA:2CEC                 </span><span style="color:navy">mov     si, [si]        </span>; [si+BDS.link] ; chain through list
<span style="color:black">BIOSDATA:2CEE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">xinstall_bds_1
</span><span style="color:black">BIOSDATA:2CF0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2CF0
BIOSDATA:2CF0 </span><span style="color:gray">xinstall_bds_2</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2CF0                 </span><span style="color:navy">mov     [si], di        </span>; [si+BDS.link]
<span style="color:black">BIOSDATA:2CF2                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], ds </span>; [si+BDS.link+2]
<span style="color:black">BIOSDATA:2CF5                 </span><span style="color:navy">mov     word ptr [di], </span><span style="color:green">0FFFFh </span>; -1 ; make sure it is a null ptr.
<span style="color:black">BIOSDATA:2CF9                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">2</span><span style="color:navy">], ds </span>; might as well plug segment
<span style="color:black">BIOSDATA:2CFC                 </span><span style="color:navy">lea     bx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [di+BDS.BPB]
<span style="color:black">BIOSDATA:2CFF                 </span><span style="color:navy">mov     si, ds:</span>last_dskdrv_table
<span style="color:black">BIOSDATA:2D03                 </span><span style="color:navy">mov     [si], bx
</span><span style="color:black">BIOSDATA:2D05                 </span><span style="color:navy">add     ds:</span>last_dskdrv_table<span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:black">BIOSDATA:2D0A                 </span><span style="color:navy">inc     ds:</span>drvmax
<span style="color:black">BIOSDATA:2D0E                 </span><span style="color:navy">add     ds:</span>end_of_bdss<span style="color:navy">, </span><span style="color:green">150 </span>; BDS.size = 150
<span style="color:black">BIOSDATA:2D14                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:2D15                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:2D16                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2D16 </span>xinstall_bds    <span style="color:black">endp
BIOSDATA:2D16
BIOSDATA:2D17
BIOSDATA:2D17 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2D17
BIOSDATA:2D17
BIOSDATA:2D17 </span>cmos_clock_read <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D17                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2D18                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:2D19                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2D1A                 </span><span style="color:navy">push    bp
</span><span style="color:black">BIOSDATA:2D1B                 </span><span style="color:navy">xor     bp, bp
</span><span style="color:black">BIOSDATA:2D1D
BIOSDATA:2D1D </span><span style="color:gray">loop_clock</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D1D                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">BIOSDATA:2D1F                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2D21                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">BIOSDATA:2D23                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - READ REAL TIME CLOCK (AT,XT286,CONV,PS)
<span style="color:black">BIOSDATA:2D23                                         </span>; Return: CH = hours in BCD
<span style="color:black">BIOSDATA:2D23                                         </span>; CL = minutes in BCD
<span style="color:black">BIOSDATA:2D23                                         </span>; DH = seconds in BCD
<span style="color:black">BIOSDATA:2D25                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2D28                 </span><span style="color:navy">jnz     short </span><span style="color:gray">clock_present
</span><span style="color:black">BIOSDATA:2D2A                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2D2D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">clock_present
</span><span style="color:black">BIOSDATA:2D2F                 </span><span style="color:navy">cmp     bp, </span><span style="color:#ff8000">1           </span>; read again after a slight delay, in case clock
<span style="color:black">BIOSDATA:2D32                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_readdate </span>; was at zero setting.
<span style="color:black">BIOSDATA:2D34                 </span><span style="color:navy">inc     bp              </span>; only perform delay once.
<span style="color:black">BIOSDATA:2D35                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4000h       </span>; 16384
<span style="color:black">BIOSDATA:2D38
BIOSDATA:2D38 </span><span style="color:gray">delay</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D38                 </span><span style="color:navy">loop    </span><span style="color:gray">delay
</span><span style="color:black">BIOSDATA:2D3A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">loop_clock
</span><span style="color:black">BIOSDATA:2D3C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2D3C
BIOSDATA:2D3C </span><span style="color:gray">clock_present</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D3C                 </span><span style="color:navy">mov     cs:</span>havecmoscloc<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; set the flag for cmos clock
<span style="color:black">BIOSDATA:2D42                 </span><span style="color:navy">call    </span>cmosck          ; reset cmos clock rate that may be
<span style="color:black">BIOSDATA:2D42                                         </span>; possibly destroyed by cp dos and
<span style="color:black">BIOSDATA:2D42                                         </span>; post routine did not restore that.
<span style="color:black">BIOSDATA:2D45                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:2D46                 </span><span style="color:navy">call    </span>read_real_date  ; read real-time clock for date
<span style="color:black">BIOSDATA:2D49                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSDATA:2D4A                 </span><span style="color:navy">mov     ds:</span>daycnt<span style="color:navy">, si   </span>; set system date
<span style="color:black">BIOSDATA:2D4E                 </span><span style="color:navy">sti
</span><span style="color:black">BIOSDATA:2D4F                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:2D50
BIOSDATA:2D50 </span><span style="color:gray">no_readdate</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D50                 </span><span style="color:navy">pop     bp
</span><span style="color:black">BIOSDATA:2D51                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2D52                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSDATA:2D53                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2D54                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2D54 </span>cmos_clock_read <span style="color:black">endp
BIOSDATA:2D54
BIOSDATA:2D55
BIOSDATA:2D55 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2D55
BIOSDATA:2D55
BIOSDATA:2D55 </span>cmosck          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D55                 </span><span style="color:navy">push    ax              </span>; check and reset rtc rate bits
<span style="color:black">BIOSDATA:2D55                                         </span>;
<span style="color:black">BIOSDATA:2D55                                         </span>; the following code is written by jack gulley in engineering group.
<span style="color:black">BIOSDATA:2D55                                         </span>; cp dos (CP/DOS, OS/2) is changing cmos clock rate for its own purposes
<span style="color:black">BIOSDATA:2D55                                         </span>; and if the use cold boot the system to use pc dos while running cp dos,
<span style="color:black">BIOSDATA:2D55                                         </span>; the cmos clock rate are still slow which slow down disk operations
<span style="color:black">BIOSDATA:2D55                                         </span>; of pc dos which uses cmos clock. pc dos is put this code in msinit
<span style="color:black">BIOSDATA:2D55                                         </span>; to fix this problem at the request of cp dos.
<span style="color:black">BIOSDATA:2D56                 </span><span style="color:navy">cmp     cs:</span>model_byte<span style="color:navy">, </span><span style="color:#ff8000">0FCh
</span><span style="color:black">BIOSDATA:2D5C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cmosck9   </span>; Exit if not an AT model
<span style="color:black">BIOSDATA:2D5E                 </span><span style="color:navy">cmp     cs:</span>secondary_model_byte<span style="color:navy">, </span><span style="color:#ff8000">6 </span>; Is it 06 for the industral AT ?
<span style="color:black">BIOSDATA:2D64                 </span><span style="color:navy">jz      short </span><span style="color:gray">cmosck4   </span>; Go reset CMOS periodic rate if 06
<span style="color:black">BIOSDATA:2D66                 </span><span style="color:navy">cmp     cs:</span>secondary_model_byte<span style="color:navy">, </span><span style="color:#ff8000">4 </span>; Is it 00, 01, 02, or 03 ?
<span style="color:black">BIOSDATA:2D6C                 </span><span style="color:navy">jnb     short </span><span style="color:gray">cmosck9   </span>; EXIT if problem fixed by POST
<span style="color:black">BIOSDATA:2D6C                                         </span>; Also,Secondary_model_byte = 0
<span style="color:black">BIOSDATA:2D6C                                         </span>; when AH=0C0h, int 15h failed.
<span style="color:black">BIOSDATA:2D6C                                         </span>; RESET THE CMOS PERIODIC RATE
<span style="color:black">BIOSDATA:2D6C                                         </span>; Model=FC submodel=00,01,02,03 or 06
<span style="color:black">BIOSDATA:2D6E
BIOSDATA:2D6E </span><span style="color:gray">cmosck4</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D6E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8Ah         </span>; cmos_reg_a|nmi
<span style="color:black">BIOSDATA:2D6E                                         </span>; NMI disabled on return
<span style="color:black">BIOSDATA:2D70                 </span><span style="color:navy">mov     ah, </span><span style="color:green">26h         </span>; 00100110b
<span style="color:black">BIOSDATA:2D70                                         </span>; Set divider &amp; rate selection
<span style="color:black">BIOSDATA:2D72                 </span><span style="color:navy">call    </span>cmos_write
<span style="color:black">BIOSDATA:2D75                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8Bh         </span>; cmos_reg_b|nmi
<span style="color:black">BIOSDATA:2D75                                         </span>; NMI disabled on return
<span style="color:black">BIOSDATA:2D77                 </span><span style="color:navy">call    </span>cmos_read
<span style="color:black">BIOSDATA:2D7A                 </span><span style="color:navy">and     al, </span><span style="color:green">7           </span>; 00000111b
<span style="color:black">BIOSDATA:2D7A                                         </span>; clear SET,PIE,AIE,UIE,SQWE
<span style="color:black">BIOSDATA:2D7C                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">BIOSDATA:2D7E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Bh         </span>; cmos_reg_b
<span style="color:black">BIOSDATA:2D7E                                         </span>; NMI enabled on return
<span style="color:black">BIOSDATA:2D80                 </span><span style="color:navy">call    </span>cmos_write
<span style="color:black">BIOSDATA:2D83
BIOSDATA:2D83 </span><span style="color:gray">cmosck9</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D83                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2D84                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2D84 </span>cmosck          <span style="color:black">endp
BIOSDATA:2D84
BIOSDATA:2D85
BIOSDATA:2D85 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2D85
BIOSDATA:2D85
BIOSDATA:2D85 </span>cmos_read       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2D85                 </span><span style="color:navy">pushf                   </span>; read location (al) into (al)
<span style="color:black">BIOSDATA:2D85                                         </span>; bit 7 = 0 for nmi enabled and 1 for nmi disabled on exit
<span style="color:black">BIOSDATA:2D86                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSDATA:2D87                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:2D88                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2D89                 </span><span style="color:navy">or      al, </span><span style="color:green">80h
</span><span style="color:black">BIOSDATA:2D8B                 </span><span style="color:navy">out     </span><span style="color:green">70h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Index Register:
<span style="color:black">BIOSDATA:2D8B                                         </span>; RTC Seconds
<span style="color:black">BIOSDATA:2D8D                 </span><span style="color:navy">nop
</span><span style="color:black">BIOSDATA:2D8E                 </span><span style="color:navy">in      al, </span><span style="color:green">71h         </span>; CMOS Memory/RTC Data Register
<span style="color:black">BIOSDATA:2D90                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">BIOSDATA:2D92                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2D93                 </span><span style="color:navy">and     al, </span><span style="color:green">80h
</span><span style="color:black">BIOSDATA:2D95                 </span><span style="color:navy">or      al, </span><span style="color:green">0Fh
</span><span style="color:black">BIOSDATA:2D97                 </span><span style="color:navy">out     </span><span style="color:green">70h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Index Register:
<span style="color:black">BIOSDATA:2D97                                         </span>; RTC Seconds
<span style="color:black">BIOSDATA:2D99                 </span><span style="color:navy">nop
</span><span style="color:black">BIOSDATA:2D9A                 </span><span style="color:navy">in      al, </span><span style="color:green">71h         </span>; CMOS Memory/RTC Data Register
<span style="color:black">BIOSDATA:2D9C                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">BIOSDATA:2D9E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:2D9F                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:2DA0                 </span><span style="color:navy">call    near ptr </span>cmos_popf
<span style="color:black">BIOSDATA:2DA3                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2DA3 </span>cmos_read       <span style="color:black">endp
BIOSDATA:2DA3
BIOSDATA:2DA4
BIOSDATA:2DA4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2DA4
BIOSDATA:2DA4
BIOSDATA:2DA4 </span>cmos_popf       <span style="color:black">proc far                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2DA4                 </span><span style="color:navy">iret                    </span>; popf for level b- parts
<span style="color:black">BIOSDATA:2DA4 </span>cmos_popf       <span style="color:black">endp                    </span>; return far and restore flags
<span style="color:black">BIOSDATA:2DA4
BIOSDATA:2DA5
BIOSDATA:2DA5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2DA5
BIOSDATA:2DA5
BIOSDATA:2DA5 </span>cmos_write      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2DA5                 </span><span style="color:navy">pushf                   </span>; write (ah) to location (al)
<span style="color:black">BIOSDATA:2DA5                                         </span>; bit 7 = 0 for nmi enabled and 1 for nmi disabled on exit
<span style="color:black">BIOSDATA:2DA6                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2DA7                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSDATA:2DA8                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2DA9                 </span><span style="color:navy">or      al, </span><span style="color:green">80h
</span><span style="color:black">BIOSDATA:2DAB                 </span><span style="color:navy">out     </span><span style="color:green">70h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Index Register:
<span style="color:black">BIOSDATA:2DAB                                         </span>; RTC Seconds
<span style="color:black">BIOSDATA:2DAD                 </span><span style="color:navy">nop
</span><span style="color:black">BIOSDATA:2DAE                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">BIOSDATA:2DB0                 </span><span style="color:navy">out     </span><span style="color:green">71h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Data Register
<span style="color:black">BIOSDATA:2DB2                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2DB3                 </span><span style="color:navy">and     al, </span><span style="color:green">80h
</span><span style="color:black">BIOSDATA:2DB5                 </span><span style="color:navy">or      al, </span><span style="color:green">0Fh
</span><span style="color:black">BIOSDATA:2DB7                 </span><span style="color:navy">out     </span><span style="color:green">70h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Index Register:
<span style="color:black">BIOSDATA:2DB7                                         </span>; RTC Seconds
<span style="color:black">BIOSDATA:2DB9                 </span><span style="color:navy">nop
</span><span style="color:black">BIOSDATA:2DBA                 </span><span style="color:navy">in      al, </span><span style="color:green">71h         </span>; CMOS Memory/RTC Data Register
<span style="color:black">BIOSDATA:2DBC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2DBD                 </span><span style="color:navy">push    cs              </span>; *place code segment in stack and
<span style="color:black">BIOSDATA:2DBE                 </span><span style="color:navy">call    near ptr </span>cmos_popf ; *handle popf for b- level 80286
<span style="color:black">BIOSDATA:2DC1                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2DC1 </span>cmos_write      <span style="color:black">endp
BIOSDATA:2DC1
BIOSDATA:2DC1 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSDATA:2DC2 </span>ClusterH        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSDATA:2DC4
BIOSDATA:2DC4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2DC4
BIOSDATA:2DC4
BIOSDATA:2DC4 </span>getclus         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2DC4                 </span><span style="color:navy">push    cx              </span>; 1*
<span style="color:black">BIOSDATA:2DC4                                         </span>; si:bx = (32 bit) cluster to read
<span style="color:black">BIOSDATA:2DC4                                         </span>; cx = sectors per cluster
<span style="color:black">BIOSDATA:2DC4                                         </span>; es:di = load location
<span style="color:black">BIOSDATA:2DC5                 </span><span style="color:navy">push    di              </span>; 2*
<span style="color:black">BIOSDATA:2DC6                 </span><span style="color:navy">mov     cs:</span>doscnt<span style="color:navy">, cx
</span><span style="color:black">BIOSDATA:2DCB                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">BIOSDATA:2DCD                 </span><span style="color:navy">mov     cs:</span>ClusterH<span style="color:navy">, si </span>; high word of cluster number
<span style="color:black">BIOSDATA:2DD2                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">2
</span><span style="color:black">BIOSDATA:2DD5                 </span><span style="color:navy">sbb     cs:</span>ClusterH<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2DDB                 </span><span style="color:navy">xchg    ax, cs:</span>ClusterH
<span style="color:black">BIOSDATA:2DE0                 </span><span style="color:navy">mul     cx
</span><span style="color:black">BIOSDATA:2DE2                 </span><span style="color:navy">xchg    ax, cs:</span>ClusterH
<span style="color:black">BIOSDATA:2DE7                 </span><span style="color:navy">mul     cx
</span><span style="color:black">BIOSDATA:2DE9                 </span><span style="color:navy">add     dx, cs:</span>ClusterH ; convert to logical sector
<span style="color:black">BIOSDATA:2DE9                                         </span>; dx:ax = matching logical sector number
<span style="color:black">BIOSDATA:2DE9                                         </span>; starting from the data sector
<span style="color:black">BIOSDATA:2DEE                 </span><span style="color:navy">add     ax, cs:</span>First_Data_Sector
<span style="color:black">BIOSDATA:2DF3                 </span><span style="color:navy">adc     dx, cs:</span>First_Data_Sector<span style="color:navy">+</span><span style="color:green">2 </span>;
<span style="color:black">BIOSDATA:2DF3                                         </span>; dx:ax = first logical sector to read
<span style="color:black">BIOSDATA:2DF8
BIOSDATA:2DF8 </span><span style="color:gray">unpack</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2DF8                 </span><span style="color:navy">push    ds              </span>; 3*
<span style="color:black">BIOSDATA:2DF9                 </span><span style="color:navy">push    ax              </span>; 4*
<span style="color:black">BIOSDATA:2DFA                 </span><span style="color:navy">push    si              </span>; 5*
<span style="color:black">BIOSDATA:2DFB                 </span><span style="color:navy">push    bx              </span>; 6*
<span style="color:black">BIOSDATA:2DFC                 </span><span style="color:navy">mov     ax, cs:</span>fatloc
<span style="color:black">BIOSDATA:2E00                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">BIOSDATA:2E02                 </span><span style="color:navy">test    cs:</span>fbigfat<span style="color:navy">, </span><span style="color:green">20h </span>; fbigbig
<span style="color:black">BIOSDATA:2E02                                         </span>; FAT32 ?
<span style="color:black">BIOSDATA:2E08                 </span><span style="color:navy">jz      short </span><span style="color:gray">not_32bit_cluster </span>; no
<span style="color:black">BIOSDATA:2E0A
BIOSDATA:2E0A </span>unpack32<span style="color:navy">:                               </span>; yes
<span style="color:black">BIOSDATA:2E0A                 </span><span style="color:navy">push    dx              </span>; 7*
<span style="color:black">BIOSDATA:2E0B                 </span><span style="color:navy">mov     dx, si
</span><span style="color:black">BIOSDATA:2E0D                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">BIOSDATA:2E0F                 </span><span style="color:navy">add     si, si
</span><span style="color:black">BIOSDATA:2E11                 </span><span style="color:navy">adc     dx, dx
</span><span style="color:black">BIOSDATA:2E13                 </span><span style="color:navy">add     si, si
</span><span style="color:black">BIOSDATA:2E15                 </span><span style="color:navy">adc     dx, dx          </span>; dx:si = 4*(si:bx)
<span style="color:black">BIOSDATA:2E17                 </span><span style="color:navy">call    </span>get_fat_sector
<span style="color:black">BIOSDATA:2E1A                 </span><span style="color:navy">mov     si, [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; byte 16-31 of the FAT32 cluster number
<span style="color:black">BIOSDATA:2E1D                 </span><span style="color:navy">mov     bx, [bx]        </span>; byte 0-15 of the FAT32 cluster number
<span style="color:black">BIOSDATA:2E1F                 </span><span style="color:navy">pop     dx              </span>; 7*
<span style="color:black">BIOSDATA:2E20                 </span><span style="color:navy">jmp     short </span><span style="color:gray">getcl1
</span><span style="color:black">BIOSDATA:2E22 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2E22
BIOSDATA:2E22 </span><span style="color:gray">not_32bit_cluster</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E22                 </span><span style="color:navy">mov     si, bx          </span>; next cluster
<span style="color:black">BIOSDATA:2E24                 </span><span style="color:navy">test    cs:</span>fbigfat<span style="color:navy">, </span><span style="color:green">40h </span>; fbig
<span style="color:black">BIOSDATA:2E24                                         </span>; FAT16 ?
<span style="color:black">BIOSDATA:2E2A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">unpack16  </span>; yes
<span style="color:black">BIOSDATA:2E2C
BIOSDATA:2E2C </span>unpack12<span style="color:navy">:
</span><span style="color:black">BIOSDATA:2E2C                 </span><span style="color:navy">shr     si, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2E2E                 </span><span style="color:navy">add     si, bx          </span>; 12 bit fat. si=si/2
<span style="color:black">BIOSDATA:2E2E                                         </span>; si = clus + clus/2
<span style="color:black">BIOSDATA:2E2E                                         </span>; (si = byte offset of the cluster in the FAT)
<span style="color:black">BIOSDATA:2E30                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2E31                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2E33                 </span><span style="color:navy">call    </span>get_fat_sector
<span style="color:black">BIOSDATA:2E36                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2E37                 </span><span style="color:navy">mov     ax, [bx]        </span>; save cluster number into ax
<span style="color:black">BIOSDATA:2E39                 </span><span style="color:navy">jnz     short </span><span style="color:gray">even_odd  </span>; if not a splitted fat, check even-odd
<span style="color:black">BIOSDATA:2E3B                 </span><span style="color:navy">mov     al, [bx]        </span>; (not needed!) Erdogan Tan - 2023
<span style="color:black">BIOSDATA:2E3D                 </span><span style="color:navy">mov     byte ptr cs:</span>temp_cluster<span style="color:navy">, al </span>; splitted fat
<span style="color:black">BIOSDATA:2E41                 </span><span style="color:navy">inc     si              </span>; (next byte)
<span style="color:black">BIOSDATA:2E42                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2E43                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSDATA:2E45                 </span><span style="color:navy">call    </span>get_fat_sector
<span style="color:black">BIOSDATA:2E48                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2E49                 </span><span style="color:navy">mov     al, ds:</span><span style="color:green">0        </span>; mov ah,[0]
<span style="color:black">BIOSDATA:2E4C                 </span><span style="color:navy">mov     byte ptr cs:</span>temp_cluster<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, al
</span><span style="color:black">BIOSDATA:2E50                 </span><span style="color:navy">mov     ax, cs:</span>temp_cluster ; mov al,[cs:temp_cluster]
<span style="color:black">BIOSDATA:2E54
BIOSDATA:2E54 </span><span style="color:gray">even_odd</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E54                 </span><span style="color:navy">pop     bx              </span>; restore old fat entry value
<span style="color:black">BIOSDATA:2E55                 </span><span style="color:navy">push    bx              </span>; 6*
<span style="color:black">BIOSDATA:2E56                 </span><span style="color:navy">shr     bx, </span><span style="color:green">1           </span>; was it even or odd?
<span style="color:black">BIOSDATA:2E58                 </span><span style="color:navy">jnb     short </span><span style="color:gray">havclus   </span>; it was even
<span style="color:black">BIOSDATA:2E5A                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1           </span>; odd. massage fat value and keep
<span style="color:black">BIOSDATA:2E5A                                         </span>; the highest 12 bits.
<span style="color:black">BIOSDATA:2E5C                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2E5E                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2E60                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">BIOSDATA:2E62
BIOSDATA:2E62 </span><span style="color:gray">havclus</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E62                 </span><span style="color:navy">mov     bx, ax          </span>; now bx = new fat entry
<span style="color:black">BIOSDATA:2E64                 </span><span style="color:navy">and     bx, </span><span style="color:green">0FFFh       </span>; keep low 12 bits
<span style="color:black">BIOSDATA:2E68                 </span><span style="color:navy">jmp     short </span><span style="color:gray">unpackx
</span><span style="color:black">BIOSDATA:2E6A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2E6A
BIOSDATA:2E6A </span><span style="color:gray">unpack16</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E6A                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2E6B                 </span><span style="color:navy">xor     dx, dx          </span>; extend to 32 bit offset
<span style="color:black">BIOSDATA:2E6D                 </span><span style="color:navy">shl     si, </span><span style="color:green">1           </span>; cluster number * 2
<span style="color:black">BIOSDATA:2E6F                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSDATA:2E72                 </span><span style="color:navy">call    </span>get_fat_sector
<span style="color:black">BIOSDATA:2E75                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2E76                 </span><span style="color:navy">mov     bx, [bx]        </span>; bx = new fat entry
<span style="color:black">BIOSDATA:2E78
BIOSDATA:2E78 </span><span style="color:gray">unpackx</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E78                 </span><span style="color:navy">xor     si, si          </span>; high word of cluster number = 0
<span style="color:black">BIOSDATA:2E78                                         </span>; (FAT12 or FAT16)
<span style="color:black">BIOSDATA:2E7A
BIOSDATA:2E7A </span><span style="color:gray">getcl1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E7A                 </span><span style="color:navy">pop     ax              </span>; 6* - cluster number lw
<span style="color:black">BIOSDATA:2E7B                 </span><span style="color:navy">pop     cs:</span>ClusterH     ; 5* - cluster number hw
<span style="color:black">BIOSDATA:2E80                 </span><span style="color:navy">sub     ax, bx          </span>; previous - current (or current - new)
<span style="color:black">BIOSDATA:2E82                 </span><span style="color:navy">sbb     cs:</span>ClusterH<span style="color:navy">, si
</span><span style="color:black">BIOSDATA:2E87                 </span><span style="color:navy">cmp     cs:</span>ClusterH<span style="color:navy">, -</span><span style="color:green">1 </span>; one apart? (current = previous+1)
<span style="color:black">BIOSDATA:2E8D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_consenquental
</span><span style="color:black">BIOSDATA:2E8F                 </span><span style="color:navy">cmp     ax, -</span><span style="color:green">1          </span>; 0FFFFh ; is [ClusterH]:ax = -1 ?
<span style="color:black">BIOSDATA:2E92
BIOSDATA:2E92 </span><span style="color:gray">not_consenquental</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E92                 </span><span style="color:navy">pop     ax              </span>; 4* - low word of first logical sector
<span style="color:black">BIOSDATA:2E93                 </span><span style="color:navy">pop     ds              </span>; 3*
<span style="color:black">BIOSDATA:2E94                 </span><span style="color:navy">jnz     short </span><span style="color:gray">getcl2
</span><span style="color:black">BIOSDATA:2E96                 </span><span style="color:navy">add     cs:</span>doscnt<span style="color:navy">, cx   </span>; consequental cluster read, +1 cluster sectors
<span style="color:black">BIOSDATA:2E96                                         </span>; (cx = sectors per cluster)
<span style="color:black">BIOSDATA:2E9B                 </span><span style="color:navy">jmp     </span><span style="color:gray">unpack
</span><span style="color:black">BIOSDATA:2E9E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSDATA:2E9E
BIOSDATA:2E9E </span><span style="color:gray">getcl2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2E9E                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSDATA:2E9F                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:2EA0                 </span><span style="color:navy">push    dx              </span>; sector to read (high)
<span style="color:black">BIOSDATA:2EA1                 </span><span style="color:navy">push    ax              </span>; sector to read (low)
<span style="color:black">BIOSDATA:2EA2                 </span><span style="color:navy">mov     ax, cs:</span>drvfat   ; get drive and fat spec
<span style="color:black">BIOSDATA:2EA6                 </span><span style="color:navy">mov     cx, di          </span>; dma and segment (64K boundary) overrun precaution
<span style="color:black">BIOSDATA:2EA6                                         </span>; (sector count will be decreased if it is required)
<span style="color:black">BIOSDATA:2EA8                 </span><span style="color:navy">not     cx              </span>; cx = 65535 - cx
<span style="color:black">BIOSDATA:2EAA                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1           </span>; cx = cx/2
<span style="color:black">BIOSDATA:2EAC                 </span><span style="color:navy">xor     cl, cl
</span><span style="color:black">BIOSDATA:2EAE                 </span><span style="color:navy">xchg    cl, ch          </span>; cx = cx/256
<span style="color:black">BIOSDATA:2EB0                 </span><span style="color:navy">cmp     cx, cs:</span>doscnt   ; if sector read count &gt; cx, decrease it to cx
<span style="color:black">BIOSDATA:2EB5                 </span><span style="color:navy">jbe     short </span><span style="color:gray">getcl3
</span><span style="color:black">BIOSDATA:2EB7                 </span><span style="color:navy">mov     cx, cs:</span>doscnt
<span style="color:black">BIOSDATA:2EBC
BIOSDATA:2EBC </span><span style="color:gray">getcl3</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2EBC                 </span><span style="color:navy">pop     dx              </span>; sector to read for diskrd (low)
<span style="color:black">BIOSDATA:2EBD                 </span><span style="color:navy">pop     cs:</span>start_sec_h  ; sector to read for diskrd (high)
<span style="color:black">BIOSDATA:2EC2                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:2EC3                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2EC4                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:2EC5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2EC6                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:2EC6                 </span><span style="color:navy">push    cs              </span>; simulate far call
<span style="color:black">BIOSDATA:2EC7                 </span><span style="color:navy">mov     bp, offset </span>DISKRD ; BIOSCODE:0A2Bh ; 364h:0A2Bh
<span style="color:black">BIOSDATA:2ECA                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:black">BIOSDATA:2ECD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2ECE                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:2ECE                 </span><span style="color:navy">pop     ax              </span>; sector count
<span style="color:black">BIOSDATA:2ECF                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:2ED0                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSDATA:2ED1                 </span><span style="color:navy">pop     di              </span>; 2* - load location (es:di)
<span style="color:black">BIOSDATA:2ED2                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:black">BIOSDATA:2ED4                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1           </span>; ax = ax * 512 ; byte count
<span style="color:black">BIOSDATA:2ED6                 </span><span style="color:navy">add     di, ax          </span>; update load location
<span style="color:black">BIOSDATA:2ED8                 </span><span style="color:navy">pop     cx              </span>; 1* - restore sectors/cluster
<span style="color:black">BIOSDATA:2ED9                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2ED9 </span>getclus         <span style="color:black">endp
BIOSDATA:2ED9
BIOSDATA:2EDA
BIOSDATA:2EDA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSDATA:2EDA
BIOSDATA:2EDA
BIOSDATA:2EDA </span>get_fat_sector  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2EDA                 </span><span style="color:navy">push    ax              </span>; dx:si = offset value (starting from fat entry 0)
<span style="color:black">BIOSDATA:2EDA                                         </span>;         of fat entry to find
<span style="color:black">BIOSDATA:2EDB                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSDATA:2EDC                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:2EDD                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSDATA:2EDE                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2EDF                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2EE0                 </span><span style="color:navy">mov     ax, si
</span><span style="color:black">BIOSDATA:2EE2                 </span><span style="color:navy">mov     cx, cs:</span>md_sectorsize ; 512
<span style="color:black">BIOSDATA:2EE7                 </span><span style="color:navy">div     cx
</span><span style="color:black">BIOSDATA:2EE9                 </span><span style="color:navy">nop                     </span>; ax = sector number, dx = offset
<span style="color:black">BIOSDATA:2EEA                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSDATA:2EEB                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2EEC                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSDATA:2EED                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSDATA:2EEE                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:2EEF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2EF0                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:2EF0                 </span><span style="color:navy">mov     ax, cs:</span>drvfat   ; get drive # and FAT id
<span style="color:black">BIOSDATA:2EF4                 </span><span style="color:navy">mov     bp, offset </span>SetDrive ; BIOSCODE:05AEh
<span style="color:black">BIOSDATA:2EF7                 </span><span style="color:navy">push    cs              </span>; simulate far call
<span style="color:black">BIOSDATA:2EF8                 </span><span style="color:navy">call    </span>call_bios_code  ; get bds for drive
<span style="color:black">BIOSDATA:2EFB                 </span><span style="color:navy">pop     ax              </span>; (sector number -without reserved and hidden sectors-)
<span style="color:black">BIOSDATA:2EFC                 </span><span style="color:navy">add     ax, es:[di+</span><span style="color:#ff8000">9</span><span style="color:navy">]   </span>; [es:di+BDS.resectors]
<span style="color:black">BIOSDATA:2EFC                                         </span>; add #reserved_sectors
<span style="color:black">BIOSDATA:2F00                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:2F01                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2F02                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:2F02                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2F03                 </span><span style="color:navy">cmp     ax, cs:</span>last_fat_sec_num
<span style="color:black">BIOSDATA:2F08                 </span><span style="color:navy">jz      short </span><span style="color:gray">gfs_split_chk </span>; don&#039;t need to read it again
<span style="color:black">BIOSDATA:2F0A                 </span><span style="color:navy">mov     cs:</span>last_fat_sec_num<span style="color:navy">, ax </span>; sector number
<span style="color:black">BIOSDATA:2F0A                                         </span>; (in the partition, without hidden sectors)
<span style="color:black">BIOSDATA:2F0E                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSDATA:2F0F                 </span><span style="color:navy">mov     cs:</span>start_sec_h<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; prepare to read the fat sector
<span style="color:black">BIOSDATA:2F0F                                         </span>; start_sec_h is always 0 for fat sector
<span style="color:black">BIOSDATA:2F16                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">BIOSDATA:2F18                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1           </span>; 1 sector read
<span style="color:black">BIOSDATA:2F1B                 </span><span style="color:navy">mov     ax, cs:</span>drvfat
<span style="color:black">BIOSDATA:2F1F                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2F20                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2F21                 </span><span style="color:navy">xor     di, di          </span>; es:di -&gt; fatloc segment:0
<span style="color:black">BIOSDATA:2F23                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSDATA:2F24                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSDATA:2F25                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2F26                 </span>assume ds:BIOSDATA
<span style="color:black">BIOSDATA:2F26                 </span><span style="color:navy">push    cs              </span>; simulate far call
<span style="color:black">BIOSDATA:2F27                 </span><span style="color:navy">mov     bp, offset </span>DISKRD ; BIOSCODE:0A2Bh ; 364h:0A2Bh
<span style="color:black">BIOSDATA:2F2A                 </span><span style="color:navy">call    </span>call_bios_code
<span style="color:black">BIOSDATA:2F2D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2F2E                 </span>assume ds:nothing
<span style="color:black">BIOSDATA:2F2E                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSDATA:2F2F                 </span><span style="color:navy">mov     cx, cs:</span>md_sectorsize ; 512
<span style="color:black">BIOSDATA:2F34
BIOSDATA:2F34 </span><span style="color:gray">gfs_split_chk</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSDATA:2F34                 </span><span style="color:navy">dec     cx              </span>; 511
<span style="color:black">BIOSDATA:2F35                 </span><span style="color:navy">cmp     dx, cx          </span>; if offset points to the last byte of this sector,
<span style="color:black">BIOSDATA:2F35                                         </span>; then splitted entry.
<span style="color:black">BIOSDATA:2F37                 </span><span style="color:navy">mov     bx, dx          </span>; offset value from fatloc segment
<span style="color:black">BIOSDATA:2F39                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSDATA:2F3A                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSDATA:2F3B                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSDATA:2F3C                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSDATA:2F3D                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSDATA:2F3E                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSDATA:2F3F                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSDATA:2F3F </span>get_fat_sector  <span style="color:black">endp
BIOSDATA:2F3F
BIOSDATA:2F3F </span>BIOSDATA        ends
<span style="color:black">BIOSDATA:2F3F
</span><span style="color:gray">BIOSCODE:0000 ; ===========================================================================
BIOSCODE:0000
BIOSCODE:0000 ; Segment type: Regular
BIOSCODE:0000 </span>BIOSCODE        segment byte public &#039;BIOSCODE&#039; use16
<span style="color:gray">BIOSCODE:0000                 </span>assume cs:BIOSCODE
<span style="color:gray">BIOSCODE:0000                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:gray">BIOSCODE:0000 </span>BCode_start     <span style="color:navy">db </span><span style="color:#008040">30h </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSCODE:0030 </span>Bios_Data_Word  <span style="color:navy">dw </span><span style="color:#008040">70h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0030                                         </span>; BIOSDATA segment
<span style="color:maroon">BIOSCODE:0032 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0032
BIOSCODE:0032 </span>_seg_reinit<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0032                 </span><span style="color:navy">mov     es, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:0037                 </span>assume es:nothing
<span style="color:maroon">BIOSCODE:0037                 </span><span style="color:navy">mov     di, offset </span>cdev_2 ; (offset cdev+2)
<span style="color:maroon">BIOSCODE:003A
BIOSCODE:003A </span><span style="color:navy">loc_356A:                               </span>; (it was 4 in MSDOS 6.21 IO.SYS)
<span style="color:maroon">BIOSCODE:003A                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">3           </span>; (&#039;bcode_i2f: dw i2f_handler, IOSYSCODESEG&#039; is removed)
<span style="color:maroon">BIOSCODE:003D
BIOSCODE:003D </span>_seg_reinit_1<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:003D                 </span><span style="color:navy">stosw                   </span>; ax = new code (BIOSCODE) segment value
<span style="color:maroon">BIOSCODE:003E                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">BIOSCODE:003F                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">BIOSCODE:0040                 </span><span style="color:navy">loop    </span>_seg_reinit_1
<span style="color:maroon">BIOSCODE:0042                 </span><span style="color:navy">mov     es:</span>bios_i2f_seg<span style="color:navy">, ax </span>; (direct jump to i2f_handler
<span style="color:maroon">BIOSCODE:0042                                         </span>;  from BIOSDATA:bios_i2f)
<span style="color:maroon">BIOSCODE:0042                                         </span>; (instead of &#039;bcode_i2f: dw i2f_handler, IOSYSCODESEG&#039;
<span style="color:maroon">BIOSCODE:0042                                         </span>;  in MSDOS 6.21 IO.SYS)
<span style="color:maroon">BIOSCODE:0046
BIOSCODE:0046 </span><span style="color:navy">locret_3576:
</span><span style="color:maroon">BIOSCODE:0046                 </span><span style="color:navy">retf
</span><span style="color:maroon">BIOSCODE:0047 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0047
BIOSCODE:0047 </span>chardev_entry<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0047                 </span><span style="color:navy">push    si
</span><span style="color:maroon">BIOSCODE:0048                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSCODE:0049                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:004A                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSCODE:004B                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:004C                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">BIOSCODE:004D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:004E                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:004F                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:0050                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">BIOSCODE:0052                 </span><span style="color:navy">mov     si, [bp+</span><span style="color:green">18</span><span style="color:navy">]     </span>; get return address (dispatch table)
<span style="color:maroon">BIOSCODE:0055                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word ; BIOSDATA segment
<span style="color:maroon">BIOSCODE:005A                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:005A                 </span><span style="color:navy">les     si, [si]        </span>; get the device number if present
<span style="color:maroon">BIOSCODE:005A                                         </span>; si points to the device dispatch table
<span style="color:maroon">BIOSCODE:005C                 </span>assume es:nothing
<span style="color:maroon">BIOSCODE:005C                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">BIOSCODE:005E                 </span><span style="color:navy">mov     byte ptr ds:</span>auxnum<span style="color:navy">, al
</span><span style="color:maroon">BIOSCODE:0061                 </span><span style="color:navy">mov     ds:</span>printdev<span style="color:navy">, ah
</span><span style="color:maroon">BIOSCODE:0065                 </span><span style="color:navy">les     bx, ds:</span>ptrsav   ; get pointer to i/o packet
<span style="color:maroon">BIOSCODE:0069                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:green">1</span><span style="color:navy">]   </span>; [es:bx+unit] ; al = unit code
<span style="color:maroon">BIOSCODE:006D                 </span><span style="color:navy">mov     ah, es:[bx+</span><span style="color:green">13</span><span style="color:navy">]  </span>; [es:bx+media] ; ah = media descrip
<span style="color:maroon">BIOSCODE:0071                 </span><span style="color:navy">mov     cx, es:[bx+</span><span style="color:green">18</span><span style="color:navy">]  </span>; [es:bx+count] ; cx = count
<span style="color:maroon">BIOSCODE:0075                 </span><span style="color:navy">mov     dx, es:[bx+</span><span style="color:green">20</span><span style="color:navy">]  </span>; [es:bx+start] ; dx = start sector
<span style="color:maroon">BIOSCODE:0079                 </span><span style="color:navy">cmp     si, offset </span>DSKTBL ; BIOSCODE:579h
<span style="color:maroon">BIOSCODE:007D                 </span><span style="color:navy">jnz     short </span>no_sector32_mapping
<span style="color:maroon">BIOSCODE:007F                 </span><span style="color:navy">mov     ds:</span>start_sec_h<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:0085                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">BIOSCODE:0088                 </span><span style="color:navy">jnz     short </span>no_sector32_mapping
<span style="color:maroon">BIOSCODE:008A                 </span><span style="color:navy">mov     dx, es:[bx+</span><span style="color:green">28</span><span style="color:navy">]  </span>; [es:bx+start_h]
<span style="color:maroon">BIOSCODE:008A                                         </span>; 32 bit dsk req
<span style="color:maroon">BIOSCODE:008E                 </span><span style="color:navy">mov     ds:</span>start_sec_h<span style="color:navy">, dx </span>; start_sec_h = packet.start_h
<span style="color:maroon">BIOSCODE:0092                 </span><span style="color:navy">mov     dx, es:[bx+</span><span style="color:green">26</span><span style="color:navy">]  </span>; [es:bx+start_l]
<span style="color:maroon">BIOSCODE:0092                                         </span>; dx = packet.start_l
<span style="color:maroon">BIOSCODE:0096
BIOSCODE:0096 </span>no_sector32_mapping<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0096                 </span><span style="color:navy">xchg    ax, di
</span><span style="color:maroon">BIOSCODE:0097                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [es:bx+cmd]
<span style="color:maroon">BIOSCODE:009B                 </span><span style="color:navy">cmp     al, cs:[si]
</span><span style="color:maroon">BIOSCODE:009E                 </span><span style="color:navy">jnb     short </span>command_error
<span style="color:maroon">BIOSCODE:00A0                 </span><span style="color:navy">cbw
</span><span style="color:maroon">BIOSCODE:00A1                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:00A3                 </span><span style="color:navy">add     si, ax
</span><span style="color:maroon">BIOSCODE:00A5                 </span><span style="color:navy">xchg    ax, di
</span><span style="color:maroon">BIOSCODE:00A6                 </span><span style="color:navy">les     di, es:[bx+</span><span style="color:green">14</span><span style="color:navy">]  </span>; [es:bx+trans]
<span style="color:maroon">BIOSCODE:00AA                 </span><span style="color:navy">cld
</span><span style="color:maroon">BIOSCODE:00AB                 </span><span style="color:navy">call    word ptr cs:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">]
</span><span style="color:maroon">BIOSCODE:00AF                 </span><span style="color:navy">jb      short </span>already_got_ah_status
<span style="color:maroon">BIOSCODE:00B1                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:00B3
BIOSCODE:00B3 </span>already_got_ah_status<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:00B3                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:00B8                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:00BC                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:00BC                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], ax      </span>; [bx+status]
<span style="color:maroon">BIOSCODE:00BC                                         </span>; mark operation complete
<span style="color:maroon">BIOSCODE:00BF                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:00C0                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:00C1                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:00C2                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">BIOSCODE:00C3                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSCODE:00C4                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSCODE:00C5                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:00C6                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSCODE:00C7                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">BIOSCODE:00C8                 </span><span style="color:navy">inc     sp              </span>; get rid of fake return address
<span style="color:maroon">BIOSCODE:00C9                 </span><span style="color:navy">inc     sp
</span><span style="color:maroon">BIOSCODE:00CA
BIOSCODE:00CA </span>bc_retf<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:00CA                 </span><span style="color:navy">retf
</span><span style="color:maroon">BIOSCODE:00CB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:00CB
BIOSCODE:00CB </span>command_error<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:00CB                 </span><span style="color:navy">call    </span>bc_cmderr
<span style="color:maroon">BIOSCODE:00CE                 </span><span style="color:navy">jmp     short </span>already_got_ah_status
<span style="color:maroon">BIOSCODE:00CE </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:00D0 </span>_offset_D0h     <span style="color:navy">db </span><span style="color:#008040">5 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span>; 5 bytes from 0:C0h will be copied onto here
<span style="color:gray">BIOSCODE:00D0                                         </span>; which is the CP/M call 5 entry point
<span style="color:black">BIOSCODE:00D5
BIOSCODE:00D5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:00D5
BIOSCODE:00D5
BIOSCODE:00D5 </span>bc_cmderr       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:00D5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; unknown command error
<span style="color:black">BIOSCODE:00D7
BIOSCODE:00D7 </span>bc_err_cnt<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:00D7                 </span><span style="color:navy">les     bx, ds:</span>ptrsav
<span style="color:black">BIOSCODE:00DB                 </span><span style="color:navy">mov     ah, </span><span style="color:green">81h         </span>; mark error return
<span style="color:black">BIOSCODE:00DD                 </span><span style="color:navy">sub     es:[bx+</span><span style="color:green">18</span><span style="color:navy">], cx  </span>; [es:bx+count]
<span style="color:black">BIOSCODE:00DD                                         </span>; # of successful i/o&#039;s
<span style="color:black">BIOSCODE:00E1                 </span><span style="color:navy">stc                     </span>; indicate abnormal end
<span style="color:black">BIOSCODE:00E2                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:00E2 </span>bc_cmderr       <span style="color:black">endp
BIOSCODE:00E2
BIOSCODE:00E2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">BIOSCODE:00E3                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:gray">BIOSCODE:00E4 </span>con_table       <span style="color:navy">db </span><span style="color:#008040">11                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:00E4                                         </span>; ((con_table_end - con_table)-1)/2 = 11
<span style="color:gray">BIOSCODE:00E5                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:00E7                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:00E9                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:00EB                 </span><span style="color:navy">dw offset </span>bc_cmderr
<span style="color:gray">BIOSCODE:00ED                 </span><span style="color:navy">dw offset </span>con_read
<span style="color:gray">BIOSCODE:00EF                 </span><span style="color:navy">dw offset </span>con_rdnd
<span style="color:gray">BIOSCODE:00F1                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:00F3                 </span><span style="color:navy">dw offset </span>con_flush
<span style="color:gray">BIOSCODE:00F5                 </span><span style="color:navy">dw offset </span>con_writ
<span style="color:gray">BIOSCODE:00F7                 </span><span style="color:navy">dw offset </span>con_writ
<span style="color:gray">BIOSCODE:00F9                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:00FB </span>prn_table       <span style="color:navy">db </span><span style="color:#008040">26                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:00FB                                         </span>; ((prn_table_end - prn_table)-1)/2 = 26
<span style="color:gray">BIOSCODE:00FC                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:00FE                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0100                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0102                 </span><span style="color:navy">dw offset </span>bc_cmderr
<span style="color:gray">BIOSCODE:0104                 </span><span style="color:navy">dw offset </span>prn_input
<span style="color:gray">BIOSCODE:0106                 </span><span style="color:navy">dw offset </span>z_bus_exit
<span style="color:gray">BIOSCODE:0108                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:010A                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:010C                 </span><span style="color:navy">dw offset </span>prn_writ
<span style="color:gray">BIOSCODE:010E                 </span><span style="color:navy">dw offset </span>prn_writ
<span style="color:gray">BIOSCODE:0110                 </span><span style="color:navy">dw offset </span>prn_stat
<span style="color:gray">BIOSCODE:0112                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0114                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0116                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0118                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:011A                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:011C                 </span><span style="color:navy">dw offset </span>prn_tilbusy
<span style="color:gray">BIOSCODE:011E                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0120                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0122                 </span><span style="color:navy">dw offset </span>prn_genioctl
<span style="color:gray">BIOSCODE:0124                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0126                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0128                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:012A                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:012C                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:012E                 </span><span style="color:navy">dw offset </span>prn_ioctl_query
<span style="color:gray">BIOSCODE:0130 </span>aux_table       <span style="color:navy">db </span><span style="color:#008040">11                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0130                                         </span>; ((aux_table_end - aux_table)-1)/2 = 11
<span style="color:gray">BIOSCODE:0131                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0133                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0135                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0137                 </span><span style="color:navy">dw offset </span>bc_cmderr
<span style="color:gray">BIOSCODE:0139                 </span><span style="color:navy">dw offset </span>aux_read
<span style="color:gray">BIOSCODE:013B                 </span><span style="color:navy">dw offset </span>aux_rdnd
<span style="color:gray">BIOSCODE:013D                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:013F                 </span><span style="color:navy">dw offset </span>aux_flsh
<span style="color:gray">BIOSCODE:0141                 </span><span style="color:navy">dw offset </span>aux_writ
<span style="color:gray">BIOSCODE:0143                 </span><span style="color:navy">dw offset </span>aux_writ
<span style="color:gray">BIOSCODE:0145                 </span><span style="color:navy">dw offset </span>aux_wrst
<span style="color:gray">BIOSCODE:0147 </span>tim_table       <span style="color:navy">db </span><span style="color:#008040">10                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0147                                         </span>; ((tim_table_end - tim_table)-1)/2 = 10
<span style="color:gray">BIOSCODE:0148                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:014A                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:014C                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:014E                 </span><span style="color:navy">dw offset </span>bc_cmderr
<span style="color:gray">BIOSCODE:0150                 </span><span style="color:navy">dw offset </span>tim_read
<span style="color:gray">BIOSCODE:0152                 </span><span style="color:navy">dw offset </span>z_bus_exit
<span style="color:gray">BIOSCODE:0154                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0156                 </span><span style="color:navy">dw offset </span>bc_exvec
<span style="color:gray">BIOSCODE:0158                 </span><span style="color:navy">dw offset </span>tim_writ
<span style="color:gray">BIOSCODE:015A                 </span><span style="color:navy">dw offset </span>tim_writ
<span style="color:black">BIOSCODE:015C
BIOSCODE:015C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:015C
BIOSCODE:015C
BIOSCODE:015C </span>con_read        <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:015C                 </span><span style="color:navy">jcxz    short </span>con_exit  ; read cx bytes from keyboard into buffer
<span style="color:black">BIOSCODE:015E
BIOSCODE:015E </span>con_loop<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:015E                 </span><span style="color:navy">call    </span>chrin           ; get char in al
<span style="color:black">BIOSCODE:0161                 </span><span style="color:navy">stosb                   </span>; store char at es:di
<span style="color:black">BIOSCODE:0162                 </span><span style="color:navy">loop    </span>con_loop
<span style="color:black">BIOSCODE:0164
BIOSCODE:0164 </span>con_exit<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0164                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:0165                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0165 </span>con_read        <span style="color:black">endp
BIOSCODE:0165
BIOSCODE:0166
BIOSCODE:0166 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0166
BIOSCODE:0166
BIOSCODE:0166 </span>chrin           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0166                 </span><span style="color:navy">mov     ah, ds:</span>keyrd_func ; set by msinit. 0 or 10h
<span style="color:black">BIOSCODE:016A                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">BIOSCODE:016C                 </span><span style="color:navy">xchg    al, ds:</span>altah    ; get character &amp; zero altah
<span style="color:black">BIOSCODE:0170                 </span><span style="color:navy">or      al, al
</span><span style="color:black">BIOSCODE:0172                 </span><span style="color:navy">jnz     short </span><span style="color:gray">keyret
</span><span style="color:black">BIOSCODE:0174                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD -
<span style="color:black">BIOSCODE:0176                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">BIOSCODE:0178                 </span><span style="color:navy">jz      short </span>chrin
<span style="color:black">BIOSCODE:017A                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">7200h       </span>; check for ctrl-prtsc
<span style="color:black">BIOSCODE:017D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">alt_ext_chk
</span><span style="color:black">BIOSCODE:017F                 </span><span style="color:navy">mov     al, </span><span style="color:green">10h
</span><span style="color:black">BIOSCODE:0181                 </span><span style="color:navy">jmp     short </span><span style="color:gray">keyret
</span><span style="color:black">BIOSCODE:0183 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0183
BIOSCODE:0183 </span><span style="color:gray">alt_ext_chk</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0183                 </span><span style="color:navy">cmp     ds:</span>keyrd_func<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:0188                 </span><span style="color:navy">jz      short </span><span style="color:gray">not_ext
</span><span style="color:black">BIOSCODE:018A                 </span><span style="color:navy">cmp     al, </span><span style="color:green">0E0h
</span><span style="color:black">BIOSCODE:018C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_ext
</span><span style="color:black">BIOSCODE:018E                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">BIOSCODE:0190                 </span><span style="color:navy">jz      short </span><span style="color:gray">keyret
</span><span style="color:black">BIOSCODE:0192                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">BIOSCODE:0194                 </span><span style="color:navy">jmp     short </span><span style="color:gray">alt_save
</span><span style="color:black">BIOSCODE:0196 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0196
BIOSCODE:0196 </span><span style="color:gray">not_ext</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0196                 </span><span style="color:navy">or      al, al          </span>; special case?
<span style="color:black">BIOSCODE:0198                 </span><span style="color:navy">jnz     short </span><span style="color:gray">keyret
</span><span style="color:black">BIOSCODE:019A
BIOSCODE:019A </span><span style="color:gray">alt_save</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:019A                 </span><span style="color:navy">mov     ds:</span>altah<span style="color:navy">, ah    </span>; store special key
<span style="color:black">BIOSCODE:019E
BIOSCODE:019E </span><span style="color:gray">keyret</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:019E                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:019E </span>chrin           <span style="color:black">endp
BIOSCODE:019E
BIOSCODE:019F
BIOSCODE:019F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:019F
BIOSCODE:019F
BIOSCODE:019F </span>con_rdnd        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:019F                 </span><span style="color:navy">mov     al, ds:</span>altah    ; keyboard non destructive read, no wait
<span style="color:black">BIOSCODE:01A2                 </span><span style="color:navy">or      al, al
</span><span style="color:black">BIOSCODE:01A4                 </span><span style="color:navy">jnz     short </span>rdexit
<span style="color:black">BIOSCODE:01A6                 </span><span style="color:navy">mov     ah, ds:</span>keysts_func
<span style="color:black">BIOSCODE:01AA                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD -
<span style="color:black">BIOSCODE:01AC                 </span><span style="color:navy">jnz     short </span>gotchr
<span style="color:black">BIOSCODE:01AE                 </span><span style="color:navy">cmp     ds:</span>fhavek09<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:01B3                 </span><span style="color:navy">jz      short </span>z_bus_exit
<span style="color:black">BIOSCODE:01B5                 </span><span style="color:navy">les     bx, ds:</span>ptrsav
<span style="color:black">BIOSCODE:01B9                 </span><span style="color:navy">test    word ptr es:[bx+</span><span style="color:green">3</span><span style="color:navy">], </span><span style="color:green">400h </span>; [es:bx+status]
<span style="color:black">BIOSCODE:01BF                 </span><span style="color:navy">jz      short </span>z_bus_exit
<span style="color:black">BIOSCODE:01C1                 </span><span style="color:navy">mov     ax, </span><span style="color:green">4100h
</span><span style="color:black">BIOSCODE:01C4                 </span><span style="color:navy">xor     bl, bl
</span><span style="color:black">BIOSCODE:01C6                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; SYSTEM - WAIT ON EXTERNAL EVENT (CONVERTIBLE)
<span style="color:black">BIOSCODE:01C6                                         </span>; AL = condition type, BH = condition compare or mask value
<span style="color:black">BIOSCODE:01C6                                         </span>; BL = timeout value times 55 milliseconds, 00h means no timeout
<span style="color:black">BIOSCODE:01C6                                         </span>; DX = I/O port address if AL bit 4 set
<span style="color:black">BIOSCODE:01C8
BIOSCODE:01C8 </span>z_bus_exit<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:01C8                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:01C9                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3           </span>; indicate busy status
<span style="color:black">BIOSCODE:01CB                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:01CC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:01CC
BIOSCODE:01CC </span>gotchr<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:01CC                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">BIOSCODE:01CE                 </span><span style="color:navy">jnz     short </span>notbrk    ; check for null after break
<span style="color:black">BIOSCODE:01D0                 </span><span style="color:navy">mov     ah, ds:</span>keyrd_func ; issue keyboard read function
<span style="color:black">BIOSCODE:01D4                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD -
<span style="color:black">BIOSCODE:01D6                 </span><span style="color:navy">jmp     short </span>con_rdnd  ; get a real status
<span style="color:black">BIOSCODE:01D8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:01D8
BIOSCODE:01D8 </span>notbrk<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:01D8                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">7200h       </span>; check for ctrl-prtsc
<span style="color:black">BIOSCODE:01DB                 </span><span style="color:navy">jnz     short </span>rd_ext_chk
<span style="color:black">BIOSCODE:01DD                 </span><span style="color:navy">mov     al, </span><span style="color:green">10h         </span>; (&#039;P&#039; &amp; 1Fh) ; return control p
<span style="color:black">BIOSCODE:01DF                 </span><span style="color:navy">jmp     short </span>rdexit
<span style="color:black">BIOSCODE:01E1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:01E1
BIOSCODE:01E1 </span>rd_ext_chk<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:01E1                 </span><span style="color:navy">cmp     ds:</span>keyrd_func<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; extended keyboard function?
<span style="color:black">BIOSCODE:01E6                 </span><span style="color:navy">jz      short </span>rdexit
<span style="color:black">BIOSCODE:01E8                 </span><span style="color:navy">cmp     al, </span><span style="color:green">0E0h        </span>; extended key value or greek alpha?
<span style="color:black">BIOSCODE:01EA                 </span><span style="color:navy">jnz     short </span>rdexit
<span style="color:black">BIOSCODE:01EC                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0           </span>; scan code exist?
<span style="color:black">BIOSCODE:01EF                 </span><span style="color:navy">jz      short </span>rdexit    ; yes. greek alpha char.
<span style="color:black">BIOSCODE:01F1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0           </span>; no. extended key stroke.
<span style="color:black">BIOSCODE:01F1                                         </span>; change it for compatibility
<span style="color:black">BIOSCODE:01F3
BIOSCODE:01F3 </span>rdexit<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:01F3                 </span><span style="color:navy">les     bx, ds:</span>ptrsav
<span style="color:black">BIOSCODE:01F7                 </span><span style="color:navy">mov     es:[bx+</span><span style="color:green">13</span><span style="color:navy">], al  </span>; [es:bx+media]
<span style="color:black">BIOSCODE:01F7                                         </span>; return keyboard character here
<span style="color:black">BIOSCODE:01FB
BIOSCODE:01FB </span>bc_exvec<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:01FB                 </span><span style="color:navy">clc                     </span>; indicate normal termination
<span style="color:black">BIOSCODE:01FC                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:01FC </span>con_rdnd        <span style="color:black">endp
BIOSCODE:01FC
BIOSCODE:01FD
BIOSCODE:01FD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:01FD
BIOSCODE:01FD
BIOSCODE:01FD </span>con_writ        <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:01FD                 </span><span style="color:navy">jcxz    short </span>bc_exvec  ; console write routine
<span style="color:black">BIOSCODE:01FF
BIOSCODE:01FF </span>con_lp<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:01FF                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">BIOSCODE:0202                 </span><span style="color:navy">inc     di
</span><span style="color:black">BIOSCODE:0203                 </span><span style="color:navy">int     </span><span style="color:green">29h             </span>; DOS 2+ internal - FAST PUTCHAR
<span style="color:black">BIOSCODE:0203                                         </span>; AL = character to display
<span style="color:black">BIOSCODE:0205                 </span><span style="color:navy">loop    </span>con_lp
<span style="color:black">BIOSCODE:0205 </span>con_writ        <span style="color:black">endp
BIOSCODE:0205
BIOSCODE:0207 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR con_flush
</span><span style="color:black">BIOSCODE:0207
BIOSCODE:0207 </span>cc_ret<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0207                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:0208                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0208 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR con_flush
</span><span style="color:black">BIOSCODE:0209
BIOSCODE:0209 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0209
BIOSCODE:0209
BIOSCODE:0209 </span>con_flush       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0209
BIOSCODE:0209 </span><span style="color:gray">; FUNCTION CHUNK AT BIOSCODE:0207 SIZE 00000002 BYTES
</span><span style="color:black">BIOSCODE:0209
BIOSCODE:0209                 </span><span style="color:navy">mov     ds:</span>altah<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; flush out keyboard queue
<span style="color:black">BIOSCODE:0209                                         </span>; clear out holding buffer
<span style="color:black">BIOSCODE:020E
BIOSCODE:020E </span>flloop<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:020E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1           </span>; while (charavail()) charread();
<span style="color:black">BIOSCODE:0210                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - CHECK BUFFER, DO NOT CLEAR
<span style="color:black">BIOSCODE:0210                                         </span>; Return: ZF clear if character in buffer
<span style="color:black">BIOSCODE:0210                                         </span>; AH = scan code, AL = character
<span style="color:black">BIOSCODE:0210                                         </span>; ZF set if no character in buffer
<span style="color:black">BIOSCODE:0212                 </span><span style="color:navy">jz      short </span>cc_ret
<span style="color:black">BIOSCODE:0214                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">BIOSCODE:0216                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
<span style="color:black">BIOSCODE:0216                                         </span>; Return: AH = scan code, AL = character
<span style="color:black">BIOSCODE:0218                 </span><span style="color:navy">jmp     short </span>flloop
<span style="color:black">BIOSCODE:0218 </span>con_flush       <span style="color:black">endp
BIOSCODE:0218
</span><span style="color:maroon">BIOSCODE:021A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:021A
BIOSCODE:021A </span>prn_input<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:021A                 </span><span style="color:navy">call    </span>bc_err_cnt      ; reset count to zero
<span style="color:maroon">BIOSCODE:021A                                         </span>; (sub reqpkt.count,cx)
<span style="color:maroon">BIOSCODE:021D                 </span><span style="color:navy">clc                     </span>; but return with carry   reset for no error
<span style="color:maroon">BIOSCODE:021E                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:021F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:021F
BIOSCODE:021F </span>prn_writ<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:021F                 </span><span style="color:navy">jcxz    short </span>prn_done  ; write cx bytes from es:di to printer device
<span style="color:maroon">BIOSCODE:0221
BIOSCODE:0221 </span>prn_loop<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0221                 </span><span style="color:navy">mov     bx, </span><span style="color:green">2           </span>; retry count
<span style="color:maroon">BIOSCODE:0224
BIOSCODE:0224 </span>prn_out<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0224                 </span><span style="color:navy">call    </span>prnstat         ; get status
<span style="color:maroon">BIOSCODE:0227                 </span><span style="color:navy">jnz     short </span>TestPrnError
<span style="color:maroon">BIOSCODE:0229                 </span><span style="color:navy">mov     al, es:[di]     </span>; get character to print
<span style="color:maroon">BIOSCODE:022C                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">BIOSCODE:022E                 </span><span style="color:navy">call    </span>prnop           ; print to printer
<span style="color:maroon">BIOSCODE:0231                 </span><span style="color:navy">jz      short </span>prn_con   ; no error - continue
<span style="color:maroon">BIOSCODE:0233                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">0FFh        </span>; MODE_CTRLBRK
<span style="color:maroon">BIOSCODE:0236                 </span><span style="color:navy">jnz     short </span>_prnwf
<span style="color:maroon">BIOSCODE:0238                 </span><span style="color:navy">mov     al, </span><span style="color:green">0Ch         </span>; error_I24_gen_failure
<span style="color:maroon">BIOSCODE:023A                 </span><span style="color:navy">mov     ds:</span>altah<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:023F                 </span><span style="color:navy">jmp     short </span>pmessg
<span style="color:maroon">BIOSCODE:0241 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0241
BIOSCODE:0241 </span>_prnwf<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0241                 </span><span style="color:navy">test    ah, </span><span style="color:green">1           </span>; timeoutstatus
<span style="color:maroon">BIOSCODE:0244                 </span><span style="color:navy">jz      short </span>prn_con
<span style="color:maroon">BIOSCODE:0246
BIOSCODE:0246 </span>TestPrnError<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0246                 </span><span style="color:navy">dec     bx              </span>; retry until count is exhausted
<span style="color:maroon">BIOSCODE:0247                 </span><span style="color:navy">jnz     short </span>prn_out
<span style="color:maroon">BIOSCODE:0249
BIOSCODE:0249 </span>pmessg<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0249                 </span><span style="color:navy">jmp     </span>bc_err_cnt
<span style="color:maroon">BIOSCODE:024C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:024C
BIOSCODE:024C </span>prn_con<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:024C                 </span><span style="color:navy">inc     di              </span>; point to next char and continue
<span style="color:maroon">BIOSCODE:024D                 </span><span style="color:navy">loop    </span>prn_loop
<span style="color:maroon">BIOSCODE:024F
BIOSCODE:024F </span>prn_done<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:024F                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:0250                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:0251 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0251
BIOSCODE:0251 </span>prn_stat<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0251                 </span><span style="color:navy">call    </span>prnstat         ; device in dx
<span style="color:maroon">BIOSCODE:0254                 </span><span style="color:navy">jnz     short </span>pmessg
<span style="color:maroon">BIOSCODE:0256                 </span><span style="color:navy">test    ah, </span><span style="color:green">80h         </span>; notbusystatus
<span style="color:maroon">BIOSCODE:0259                 </span><span style="color:navy">jnz     short </span>prn_done
<span style="color:maroon">BIOSCODE:025B                 </span><span style="color:navy">jmp     </span>z_bus_exit
<span style="color:black">BIOSCODE:025E
BIOSCODE:025E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:025E
BIOSCODE:025E
BIOSCODE:025E </span>prnstat         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:025E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; PRINTER - GET STATUS
<span style="color:black">BIOSCODE:025E </span>prnstat         <span style="color:black">endp                    </span>; set command for get status
<span style="color:black">BIOSCODE:025E                                         </span>; DX = printer port (0-3)
<span style="color:black">BIOSCODE:025E                                         </span>; Return: AH = status
<span style="color:black">BIOSCODE:0260
BIOSCODE:0260 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0260
BIOSCODE:0260
BIOSCODE:0260 </span>prnop           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0260                 </span><span style="color:navy">mov     dx, ds:</span>auxnum   ; get printer number
<span style="color:black">BIOSCODE:0264                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0265                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:0266                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">BIOSCODE:0268                 </span><span style="color:navy">mov     ds, di
</span><span style="color:black">BIOSCODE:026A                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:026A                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:026B                 </span><span style="color:navy">pushf                   </span>; simulate int 17h
<span style="color:black">BIOSCODE:026C                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSCODE:026D                 </span><span style="color:navy">call    </span>dword ptr ds:5Ch ; 0:5Ch = INT 17h vector
<span style="color:black">BIOSCODE:0271                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0272                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:0272                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0273                 </span><span style="color:navy">and     ah, </span><span style="color:green">30h
</span><span style="color:black">BIOSCODE:0276                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">30h         </span>; noprinter error
<span style="color:black">BIOSCODE:0279                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:027A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NextTest
</span><span style="color:black">BIOSCODE:027C                 </span><span style="color:navy">and     ah, </span><span style="color:green">0DFh        </span>; ~nopaperstatus
<span style="color:black">BIOSCODE:027F                 </span><span style="color:navy">or      ah, </span><span style="color:green">8           </span>; ioerrstatus
<span style="color:black">BIOSCODE:0282
BIOSCODE:0282 </span><span style="color:gray">NextTest</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0282                 </span><span style="color:navy">test    ah, </span><span style="color:green">28h         </span>; (ioerrstatus+nopaperstatus)
<span style="color:black">BIOSCODE:0282                                         </span>; i/o error?
<span style="color:black">BIOSCODE:0285                 </span><span style="color:navy">jz      short </span><span style="color:gray">checknotready </span>; no, try not ready
<span style="color:black">BIOSCODE:0287                 </span><span style="color:navy">mov     al, </span><span style="color:green">9           </span>; error_I24_out_of_paper
<span style="color:black">BIOSCODE:0287                                         </span>;  first, assume out of paper
<span style="color:black">BIOSCODE:0289                 </span><span style="color:navy">test    ah, </span><span style="color:green">20h         </span>; out of paper set?
<span style="color:black">BIOSCODE:028C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ret1      </span>; yes, error is set
<span style="color:black">BIOSCODE:028E                 </span><span style="color:navy">inc     al              </span>; return al=10 (i/o error)
<span style="color:black">BIOSCODE:0290
BIOSCODE:0290 </span><span style="color:gray">ret1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0290                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0291 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0291
BIOSCODE:0291 </span><span style="color:gray">checknotready</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0291                 </span><span style="color:navy">mov     al, </span><span style="color:green">2           </span>; assume not-ready
<span style="color:black">BIOSCODE:0293                 </span><span style="color:navy">test    ah, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:0296                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0296 </span>prnop           <span style="color:black">endp
BIOSCODE:0296
</span><span style="color:maroon">BIOSCODE:0297 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0297
BIOSCODE:0297 </span>prn_tilbusy<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0297                 </span><span style="color:navy">mov     si, di
</span><span style="color:maroon">BIOSCODE:0299
BIOSCODE:0299 </span>prn_tilbloop<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0299                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:029A                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:029B                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:maroon">BIOSCODE:029D                 </span><span style="color:navy">mov     bl, ds:</span>printdev
<span style="color:maroon">BIOSCODE:02A1                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:02A3                 </span><span style="color:navy">mov     cx, ds:</span>wait_count<span style="color:navy">[bx] </span>; wait count times to come ready
<span style="color:maroon">BIOSCODE:02A7                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:02A8
BIOSCODE:02A8 </span>prn_getstat<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:02A8                 </span><span style="color:navy">call    </span>prnstat         ; get status
<span style="color:maroon">BIOSCODE:02AB                 </span><span style="color:navy">jnz     short </span>prn_bperr ; error
<span style="color:maroon">BIOSCODE:02AD                 </span><span style="color:navy">test    ah, </span><span style="color:green">80h         </span>; ready yet?
<span style="color:maroon">BIOSCODE:02B0                 </span><span style="color:navy">loope   </span>prn_getstat     ; no, go for more
<span style="color:maroon">BIOSCODE:02B2                 </span><span style="color:navy">pop     cx              </span>; get original count
<span style="color:maroon">BIOSCODE:02B3                 </span><span style="color:navy">jz      short </span>prn_berr  ; still not ready =&gt; done
<span style="color:maroon">BIOSCODE:02B5                 </span><span style="color:navy">lods    byte ptr es:[si]
</span><span style="color:maroon">BIOSCODE:02B7                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">BIOSCODE:02B9                 </span><span style="color:navy">call    </span>prnop
<span style="color:maroon">BIOSCODE:02BC                 </span><span style="color:navy">jnz     short </span>prn_berr
<span style="color:maroon">BIOSCODE:02BE                 </span><span style="color:navy">loop    </span>prn_tilbloop
<span style="color:maroon">BIOSCODE:02C0                 </span><span style="color:navy">clc                     </span>; normal no-error return
<span style="color:maroon">BIOSCODE:02C1                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:02C2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:02C2
BIOSCODE:02C2 </span>prn_bperr<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:02C2                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:02C3
BIOSCODE:02C3 </span>prn_berr<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:02C3                 </span><span style="color:navy">jmp     </span>bc_err_cnt
<span style="color:maroon">BIOSCODE:02C6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:02C6
BIOSCODE:02C6 </span>prn_genioctl<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:02C6                 </span><span style="color:navy">les     di, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:02CA                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:green">13</span><span style="color:navy">], </span><span style="color:green">5 </span>; [es:di+IOCTL_REQ.MAJORFUNCTION]
<span style="color:maroon">BIOSCODE:02CA                                         </span>; ioc_pc
<span style="color:maroon">BIOSCODE:02CF                 </span><span style="color:navy">jnz     short </span>prnfuncerr
<span style="color:maroon">BIOSCODE:02D1                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:green">14</span><span style="color:navy">]  </span>; [es:di+IOCTL_REQ.MINORFUNCTION]
<span style="color:maroon">BIOSCODE:02D5                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:green">19</span><span style="color:navy">]  </span>; [es:di+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:02D9                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:maroon">BIOSCODE:02DB                 </span><span style="color:navy">mov     bl, ds:</span>printdev
<span style="color:maroon">BIOSCODE:02DF                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:02E1                 </span><span style="color:navy">mov     cx, ds:</span>wait_count<span style="color:navy">[bx] </span>; pull out retry count for device
<span style="color:maroon">BIOSCODE:02E5                 </span><span style="color:navy">cmp     al, </span><span style="color:green">65h         </span>; get_retry_count
<span style="color:maroon">BIOSCODE:02E7                 </span><span style="color:navy">jz      short </span>prngetcount
<span style="color:maroon">BIOSCODE:02E9                 </span><span style="color:navy">cmp     al, </span><span style="color:green">45h         </span>; set_retry_count
<span style="color:maroon">BIOSCODE:02EB                 </span><span style="color:navy">jnz     short </span>prnfuncerr
<span style="color:maroon">BIOSCODE:02ED                 </span><span style="color:navy">mov     cx, es:[di]
</span><span style="color:maroon">BIOSCODE:02F0
BIOSCODE:02F0 </span>prngetcount<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:02F0                 </span><span style="color:navy">mov     ds:</span>wait_count<span style="color:navy">[bx], cx
</span><span style="color:maroon">BIOSCODE:02F4                 </span><span style="color:navy">mov     es:[di], cx     </span>; [es:di+A_RETRYCOUNT.RC_COUNT]
<span style="color:maroon">BIOSCODE:02F4                                         </span>; return current retry count
<span style="color:maroon">BIOSCODE:02F7
BIOSCODE:02F7 </span>IOCtlSupported<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:02F7                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:02F8                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:02F9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:02F9
BIOSCODE:02F9 </span>prn_ioctl_query<span style="color:navy">:                        </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:02F9                 </span><span style="color:navy">les     di, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:02FD                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:green">13</span><span style="color:navy">], </span><span style="color:#ff8000">5 </span>; [es:di+IOCTL_REQ.MAJORFUNCTION]
<span style="color:maroon">BIOSCODE:02FD                                         </span>; ioc_pc
<span style="color:maroon">BIOSCODE:0302                 </span><span style="color:navy">jnz     short </span>prn_query_err
<span style="color:maroon">BIOSCODE:0304                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:green">14</span><span style="color:navy">]  </span>; [es:di+IOCTL_REQ.MINORFUNCTION]
<span style="color:maroon">BIOSCODE:0308                 </span><span style="color:navy">cmp     al, </span><span style="color:green">65h         </span>; GET_RETRY_COUNT
<span style="color:maroon">BIOSCODE:030A                 </span><span style="color:navy">jz      short </span>IOCtlSupported
<span style="color:maroon">BIOSCODE:030C                 </span><span style="color:navy">cmp     al, </span><span style="color:green">45h         </span>; SET_RETRY_COUNT
<span style="color:maroon">BIOSCODE:030E                 </span><span style="color:navy">jz      short </span>IOCtlSupported
<span style="color:maroon">BIOSCODE:0310
BIOSCODE:0310 </span>prn_query_err<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0310                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSCODE:0311
BIOSCODE:0311 </span>prnfuncerr<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0311                 </span><span style="color:navy">jmp     </span>bc_cmderr
<span style="color:maroon">BIOSCODE:0314 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0314
BIOSCODE:0314 </span>aux_read<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0314                 </span><span style="color:navy">jcxz    short </span>exvec2
<span style="color:maroon">BIOSCODE:0316                 </span><span style="color:navy">call    </span>getbx           ; put address of auxbuf   in bx
<span style="color:maroon">BIOSCODE:0319                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">BIOSCODE:031B                 </span><span style="color:navy">xchg    al, [bx]
</span><span style="color:maroon">BIOSCODE:031D                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">BIOSCODE:031F                 </span><span style="color:navy">jnz     short </span>aux2
<span style="color:maroon">BIOSCODE:0321
BIOSCODE:0321 </span>aux1<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0321                 </span><span style="color:navy">call    </span>auxin           ; get character from port
<span style="color:maroon">BIOSCODE:0321                                         </span>; won&#039;t return if error
<span style="color:maroon">BIOSCODE:0324
BIOSCODE:0324 </span>aux2<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0324                 </span><span style="color:navy">stosb
</span><span style="color:maroon">BIOSCODE:0325                 </span><span style="color:navy">loop    </span>aux1            ; if more characters, go around again
<span style="color:maroon">BIOSCODE:0327
BIOSCODE:0327 </span>exvec2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0327                 </span><span style="color:navy">clc                     </span>; all done, successful exit
<span style="color:maroon">BIOSCODE:0328
BIOSCODE:0328 </span><span style="color:gray">auxin_retn</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0328                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:0329 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0329
BIOSCODE:0329 </span>auxin<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0329                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:maroon">BIOSCODE:032B                 </span><span style="color:navy">call    </span>auxop
<span style="color:maroon">BIOSCODE:032E                 </span><span style="color:navy">test    ah, </span><span style="color:green">0Eh         </span>; flag_frame|flag_parity|flag_overrun
<span style="color:maroon">BIOSCODE:0331                 </span><span style="color:navy">jz      short </span><span style="color:gray">auxin_retn
</span><span style="color:maroon">BIOSCODE:0333
BIOSCODE:0333 </span>arbad<span style="color:navy">:
</span><span style="color:maroon">BIOSCODE:0333                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSCODE:0334                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0B0h        </span>; flag_rec_sig|flag_dsr|flag_cts
<span style="color:maroon">BIOSCODE:0336                 </span><span style="color:navy">jmp     short </span>bc_err_cnt_j
<span style="color:maroon">BIOSCODE:0338 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0338
BIOSCODE:0338 </span>aux_rdnd<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0338                 </span><span style="color:navy">call    </span>getbx           ; non-destructive aux port read
<span style="color:maroon">BIOSCODE:033B                 </span><span style="color:navy">mov     al, [bx]
</span><span style="color:maroon">BIOSCODE:033D                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">BIOSCODE:033F                 </span><span style="color:navy">jnz     short </span>auxrdx    ; if al is non-zero (char in buffer)
<span style="color:maroon">BIOSCODE:033F                                         </span>; then return character
<span style="color:maroon">BIOSCODE:0341                 </span><span style="color:navy">call    </span>auxstat         ; if not, get status of   aux device
<span style="color:maroon">BIOSCODE:0344                 </span><span style="color:navy">test    ah, </span><span style="color:green">1           </span>; flag_data_ready - test data ready
<span style="color:maroon">BIOSCODE:0347                 </span><span style="color:navy">jz      short </span>auxbus    ; then device is busy (not ready)
<span style="color:maroon">BIOSCODE:0349                 </span><span style="color:navy">test    al, </span><span style="color:green">20h         </span>; flag_dsr - test data set ready
<span style="color:maroon">BIOSCODE:034B                 </span><span style="color:navy">jz      short </span>auxbus    ; then device is busy (not ready)
<span style="color:maroon">BIOSCODE:034D                 </span><span style="color:navy">call    </span>auxin           ; else aux is ready, get character
<span style="color:maroon">BIOSCODE:0350                 </span><span style="color:navy">mov     [bx], al
</span><span style="color:maroon">BIOSCODE:0352
BIOSCODE:0352 </span>auxrdx<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0352                 </span><span style="color:navy">jmp     </span>rdexit          ; return busy status
<span style="color:maroon">BIOSCODE:0355 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0355
BIOSCODE:0355 </span>auxbus<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0355                 </span><span style="color:navy">jmp     </span>z_bus_exit
<span style="color:maroon">BIOSCODE:0358 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0358
BIOSCODE:0358 </span>aux_wrst<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0358                 </span><span style="color:navy">call    </span>auxstat         ; return aux port write status
<span style="color:maroon">BIOSCODE:035B                 </span><span style="color:navy">test    al, </span><span style="color:green">20h         </span>; test data set ready
<span style="color:maroon">BIOSCODE:035D                 </span><span style="color:navy">jz      short </span>auxbus    ; then device is busy (not ready)
<span style="color:maroon">BIOSCODE:035F                 </span><span style="color:navy">test    ah, </span><span style="color:green">20h         </span>; flag_tranhol_emp - test transmit hold reg
<span style="color:maroon">BIOSCODE:0362                 </span><span style="color:navy">jz      short </span>auxbus    ; then device is busy (not ready)
<span style="color:maroon">BIOSCODE:0364                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:0365                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0366
BIOSCODE:0366 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0366
BIOSCODE:0366
BIOSCODE:0366 </span>auxstat         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0366                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3           </span>; auxfunc_status
<span style="color:black">BIOSCODE:0366 </span>auxstat         <span style="color:black">endp
BIOSCODE:0366
BIOSCODE:0368
BIOSCODE:0368 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0368
BIOSCODE:0368
BIOSCODE:0368 </span>auxop           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0368                 </span><span style="color:navy">mov     dx, ds:</span>auxnum   ; ah=function code
<span style="color:black">BIOSCODE:0368                                         </span>; 0=init, 1=send, 2=receive, 3=status
<span style="color:black">BIOSCODE:0368                                         </span>; get port number
<span style="color:black">BIOSCODE:036C                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:036D                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:036E                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">BIOSCODE:0370                 </span><span style="color:navy">mov     ds, di
</span><span style="color:black">BIOSCODE:0372                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:0372                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:0373                 </span><span style="color:navy">pushf                   </span>; simulate INT 14h
<span style="color:black">BIOSCODE:0374                 </span><span style="color:navy">cli
</span><span style="color:black">BIOSCODE:0375                 </span><span style="color:navy">call    </span>dword ptr ds:50h ; INT 14h vector (14h*4 = 50h)
<span style="color:black">BIOSCODE:0375                                         </span>; SERIAL I/O - GET USART STATUS
<span style="color:black">BIOSCODE:0375                                         </span>; DX = port number (0-3)
<span style="color:black">BIOSCODE:0375                                         </span>; Return: AX = port status code
<span style="color:black">BIOSCODE:0379                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:037A                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:037A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:037A </span>auxop           <span style="color:black">endp
BIOSCODE:037A
</span><span style="color:maroon">BIOSCODE:037B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:037B
BIOSCODE:037B </span>aux_flsh<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:037B                 </span><span style="color:navy">call    </span>getbx           ; flush aux input buffer
<span style="color:maroon">BIOSCODE:037B                                         </span>; get bx to point to auxbuf
<span style="color:maroon">BIOSCODE:037B                                         </span>; zero out buffer
<span style="color:maroon">BIOSCODE:037B                                         </span>; all done, successful return
<span style="color:maroon">BIOSCODE:037E                 </span><span style="color:navy">mov     byte ptr [bx], </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:0381                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:0382                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:0383 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0383
BIOSCODE:0383 </span>aux_writ<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0383                 </span><span style="color:navy">jcxz    short </span>exvec2    ; write to aux device (if cx &gt; 0)
<span style="color:maroon">BIOSCODE:0385
BIOSCODE:0385 </span>aux_loop<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0385                 </span><span style="color:navy">mov     al, es:[di]     </span>; get character to be written
<span style="color:maroon">BIOSCODE:0388                 </span><span style="color:navy">inc     di              </span>; move di pointer to next character
<span style="color:maroon">BIOSCODE:0389                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1           </span>; auxfunc_send - indicates a write
<span style="color:maroon">BIOSCODE:038B                 </span><span style="color:navy">call    </span>auxop           ; send character over aux port
<span style="color:maroon">BIOSCODE:038E                 </span><span style="color:navy">test    ah, </span><span style="color:green">80h         </span>; check for error
<span style="color:maroon">BIOSCODE:0391                 </span><span style="color:navy">jz      short </span>awok      ; then no error
<span style="color:maroon">BIOSCODE:0393                 </span><span style="color:navy">mov     al, </span><span style="color:green">10          </span>; else indicate write fault
<span style="color:maroon">BIOSCODE:0395
BIOSCODE:0395 </span>bc_err_cnt_j<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0395                 </span><span style="color:navy">jmp     </span>bc_err_cnt      ; call error routines
<span style="color:maroon">BIOSCODE:0398 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0398
BIOSCODE:0398 </span>awok<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0398                 </span><span style="color:navy">loop    </span>aux_loop        <span style="color:gray">; move di pointer to next character
</span><span style="color:maroon">BIOSCODE:039A                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:039B                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:039C
BIOSCODE:039C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:039C
BIOSCODE:039C
BIOSCODE:039C </span>getbx           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:039C                 </span><span style="color:navy">mov     bx, ds:</span>auxnum   ; return bx -&gt; single byte input buffer
<span style="color:black">BIOSCODE:039C                                         </span>; for selected aux port ([auxnum])
<span style="color:black">BIOSCODE:03A0                 </span><span style="color:navy">add     bx, offset </span>auxbuf
<span style="color:black">BIOSCODE:03A4                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:03A4 </span>getbx           <span style="color:black">endp
BIOSCODE:03A4
</span><span style="color:maroon">BIOSCODE:03A5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:03A5
BIOSCODE:03A5 </span>time_to_ticks<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:03A5                 </span><span style="color:navy">mov     al, </span><span style="color:green">60          </span>; convert time to ticks
<span style="color:maroon">BIOSCODE:03A5                                         </span>; input : time in cx and dx
<span style="color:maroon">BIOSCODE:03A5                                         </span>; output: ticks returned in cx:dx
<span style="color:maroon">BIOSCODE:03A5                                         </span>;
<span style="color:maroon">BIOSCODE:03A5                                         </span>; the clock ticks at the rate of:
<span style="color:maroon">BIOSCODE:03A5                                         </span>; 1193180/65536 ticks/second
<span style="color:maroon">BIOSCODE:03A5                                         </span>; (about 18.2 ticks per second)
<span style="color:maroon">BIOSCODE:03A7                 </span><span style="color:navy">mul     ch              </span>; hours to minutes ///
<span style="color:maroon">BIOSCODE:03A7                                         </span>; first convert from hour,min,sec,hund. to
<span style="color:maroon">BIOSCODE:03A7                                         </span>; total number of 100th of seconds
<span style="color:maroon">BIOSCODE:03A9                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:03AB                 </span><span style="color:navy">add     ax, cx          </span>; total minutes
<span style="color:maroon">BIOSCODE:03AD                 </span><span style="color:navy">mov     cx, </span><span style="color:green">6000        </span>; 60*100
<span style="color:maroon">BIOSCODE:03B0                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:maroon">BIOSCODE:03B2                 </span><span style="color:navy">mul     cx              </span>; convert to 1/100 sec
<span style="color:maroon">BIOSCODE:03B4                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">BIOSCODE:03B6                 </span><span style="color:navy">mov     al, </span><span style="color:green">100
</span><span style="color:maroon">BIOSCODE:03B8                 </span><span style="color:navy">mul     bh              </span>; convert seconds to 1/100 sec
<span style="color:maroon">BIOSCODE:03BA                 </span><span style="color:navy">add     cx, ax          </span>; combine seconds with hours and min
<span style="color:maroon">BIOSCODE:03BC                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:03BF                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:03C1                 </span><span style="color:navy">add     cx, bx          </span>; combine 1/100 sec
<span style="color:maroon">BIOSCODE:03C3                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0           </span>; dx:cx is time in 1/100 sec
<span style="color:maroon">BIOSCODE:03C6                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:maroon">BIOSCODE:03C7                 </span><span style="color:navy">xchg    ax, cx          </span>; now time is in cx:ax
<span style="color:maroon">BIOSCODE:03C8                 </span><span style="color:navy">mov     bx, </span><span style="color:green">59659
</span><span style="color:maroon">BIOSCODE:03CB                 </span><span style="color:navy">mul     bx              </span>; multiply low half
<span style="color:maroon">BIOSCODE:03CD                 </span><span style="color:navy">xchg    dx, cx
</span><span style="color:maroon">BIOSCODE:03CF                 </span><span style="color:navy">xchg    ax, dx          </span>; cx-&gt;ax, ax-&gt;dx, dx-&gt;cx
<span style="color:maroon">BIOSCODE:03D0                 </span><span style="color:navy">mul     bx              </span>; multiply high half
<span style="color:maroon">BIOSCODE:03D2                 </span><span style="color:navy">add     ax, cx          </span>; combine overlapping products
<span style="color:maroon">BIOSCODE:03D4                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:03D7                 </span><span style="color:navy">xchg    ax, dx          </span>; ax:dx=time*59659
<span style="color:maroon">BIOSCODE:03D8                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">5
</span><span style="color:maroon">BIOSCODE:03DB                 </span><span style="color:navy">div     bl              </span>; divide high half by 5
<span style="color:maroon">BIOSCODE:03DD                 </span><span style="color:navy">mov     cl, al
</span><span style="color:maroon">BIOSCODE:03DF                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:03E1                 </span><span style="color:navy">mov     al, ah          </span>; remainder of divide-by-5
<span style="color:maroon">BIOSCODE:03E3                 </span><span style="color:navy">cbw
</span><span style="color:maroon">BIOSCODE:03E4                 </span><span style="color:navy">xchg    ax, dx          </span>; use it to extend low half
<span style="color:maroon">BIOSCODE:03E5                 </span><span style="color:navy">div     bx              </span>; divide low half by 5
<span style="color:maroon">BIOSCODE:03E7                 </span><span style="color:navy">mov     dx, ax          </span>; cx:dx is now number of ticks in time
<span style="color:maroon">BIOSCODE:03E9                 </span><span style="color:navy">retf
</span><span style="color:maroon">BIOSCODE:03EA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:03EA
BIOSCODE:03EA </span>tim_writ<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:03EA                 </span><span style="color:navy">mov     ax, es:[di]     </span>; sets the current time
<span style="color:maroon">BIOSCODE:03ED                 </span><span style="color:navy">push    ax              </span>; daycnt. we need to set this at the very
<span style="color:maroon">BIOSCODE:03ED                                         </span>; end to avoid tick windows
<span style="color:maroon">BIOSCODE:03EE                 </span><span style="color:navy">cmp     ds:</span>havecmoscloc<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:03F3                 </span><span style="color:navy">jz      short </span>no_cmos_1
<span style="color:maroon">BIOSCODE:03F5                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; get binary hours
<span style="color:maroon">BIOSCODE:03F5                                         </span>; convert to bcd
<span style="color:maroon">BIOSCODE:03F9                 </span><span style="color:navy">call    </span>bintobcd
<span style="color:maroon">BIOSCODE:03FC                 </span><span style="color:navy">mov     ch, al          </span>; ch = bcd hours
<span style="color:maroon">BIOSCODE:03FE                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; get binary minutes
<span style="color:maroon">BIOSCODE:0402                 </span><span style="color:navy">call    </span>bintobcd
<span style="color:maroon">BIOSCODE:0405                 </span><span style="color:navy">mov     cl, al          </span>; cl = bcd minutes
<span style="color:maroon">BIOSCODE:0407                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; get binary seconds
<span style="color:maroon">BIOSCODE:040B                 </span><span style="color:navy">call    </span>bintobcd
<span style="color:maroon">BIOSCODE:040E                 </span><span style="color:navy">mov     dh, al          </span>; dh = bcd seconds
<span style="color:maroon">BIOSCODE:0410                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0           </span>; dl = 0 (st) or 1 (dst)
<span style="color:maroon">BIOSCODE:0412                 </span><span style="color:navy">cli
</span><span style="color:maroon">BIOSCODE:0413                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3
</span><span style="color:maroon">BIOSCODE:0415                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - SET REAL TIME CLOCK (AT,XT286,CONV,PS)
<span style="color:maroon">BIOSCODE:0415                                         </span>; CH = hours in BCD, CL = minutes in BCD
<span style="color:maroon">BIOSCODE:0415                                         </span>;  DH = seconds in BCD,DL = 01h if daylight savings, 00h if standard time
<span style="color:maroon">BIOSCODE:0415                                         </span>; Return: CMOS clock set
<span style="color:maroon">BIOSCODE:0417                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSCODE:0418
BIOSCODE:0418 </span>no_cmos_1<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0418                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:0419                 </span><span style="color:navy">lds     cx, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">BIOSCODE:041D                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">BIOSCODE:041F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:0420                 </span><span style="color:navy">call    dword ptr ds:</span>ttticks ; convert time to ticks
<span style="color:maroon">BIOSCODE:0420                                         </span>; cx:dx now has time in ticks
<span style="color:maroon">BIOSCODE:0424                 </span><span style="color:navy">cli                     </span>; turn off timer
<span style="color:maroon">BIOSCODE:0425                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:0427                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - SET TIME OF DAY
<span style="color:maroon">BIOSCODE:0427                                         </span>; CX:DX = clock count
<span style="color:maroon">BIOSCODE:0427                                         </span>; Return: time of day set
<span style="color:maroon">BIOSCODE:0429                 </span><span style="color:navy">pop     ds:</span>daycnt
<span style="color:maroon">BIOSCODE:042D                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSCODE:042E                 </span><span style="color:navy">cmp     ds:</span>havecmoscloc<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:0433                 </span><span style="color:navy">jz      short </span>no_cmos_2
<span style="color:maroon">BIOSCODE:0435                 </span><span style="color:navy">call    </span>daycnttoday
<span style="color:maroon">BIOSCODE:0438                 </span><span style="color:navy">cli
</span><span style="color:maroon">BIOSCODE:0439                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5
</span><span style="color:maroon">BIOSCODE:043B                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - SET DATE IN REAL TIME CLOCK (AT,XT286,CONV,PS)
<span style="color:maroon">BIOSCODE:043B                                         </span>; DL = day in BCD, DH = month in BCD, CL = year in BCD
<span style="color:maroon">BIOSCODE:043B                                         </span>; CH = century (19h or 20h)
<span style="color:maroon">BIOSCODE:043B                                         </span>; Return: CMOS clock set
<span style="color:maroon">BIOSCODE:043D                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSCODE:043E
BIOSCODE:043E </span>no_cmos_2<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:043E                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:043F                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0440
BIOSCODE:0440 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0440
BIOSCODE:0440
BIOSCODE:0440 </span>daycnttoday     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0440                 </span><span style="color:navy">push    ds:</span>daycnt       ; entry: [daycnt] = number of days since 1-1-80
<span style="color:black">BIOSCODE:0440                                         </span>; return: ch - century in bcd
<span style="color:black">BIOSCODE:0440                                         </span>;         cl - year in bcd
<span style="color:black">BIOSCODE:0440                                         </span>;         dh - month in bcd
<span style="color:black">BIOSCODE:0440                                         </span>;         dl - day in bcd
<span style="color:black">BIOSCODE:0444                 </span><span style="color:navy">cmp     ds:</span>daycnt<span style="color:navy">, </span><span style="color:green">7305 </span>; (365*20+(20/4))
<span style="color:black">BIOSCODE:0444                                         </span>; # days from 1-1-1980 to 1-1-2000
<span style="color:black">BIOSCODE:044A                 </span><span style="color:navy">jnb     short </span><span style="color:gray">century20
</span><span style="color:black">BIOSCODE:044C                 </span><span style="color:navy">mov     word ptr ds:</span>base_century<span style="color:navy">, </span><span style="color:green">5013h </span>; base century = 19
<span style="color:black">BIOSCODE:044C                                         </span>; base year = 80
<span style="color:black">BIOSCODE:0452                 </span><span style="color:navy">jmp     short </span><span style="color:gray">years
</span><span style="color:black">BIOSCODE:0454 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0454
BIOSCODE:0454 </span><span style="color:gray">century20</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0454                 </span><span style="color:navy">mov     word ptr ds:</span>base_century<span style="color:navy">, </span><span style="color:green">20 </span>; base century = 20
<span style="color:black">BIOSCODE:0454                                         </span>; base year = 0
<span style="color:black">BIOSCODE:045A                 </span><span style="color:navy">sub     ds:</span>daycnt<span style="color:navy">, </span><span style="color:green">7305 </span>; 365*20+(20/4))
<span style="color:black">BIOSCODE:045A                                         </span>; adjust daycnt
<span style="color:black">BIOSCODE:0460
BIOSCODE:0460 </span><span style="color:gray">years</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0460                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSCODE:0462                 </span><span style="color:navy">mov     ax, ds:</span>daycnt
<span style="color:black">BIOSCODE:0465                 </span><span style="color:navy">mov     bx, </span><span style="color:green">1461        </span>; 366+365*3)
<span style="color:black">BIOSCODE:0465                                         </span>; # of days in a Leap year block
<span style="color:black">BIOSCODE:0468                 </span><span style="color:navy">div     bx              </span>; ax = # of leap block, dx = daycnt
<span style="color:black">BIOSCODE:046A                 </span><span style="color:navy">mov     ds:</span>daycnt<span style="color:navy">, dx   </span>; save daycnt left
<span style="color:black">BIOSCODE:046E                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">4
</span><span style="color:black">BIOSCODE:0470                 </span><span style="color:navy">mul     bl
</span><span style="color:black">BIOSCODE:0472                 </span><span style="color:navy">add     ds:</span>base_year<span style="color:navy">, al </span>; ax = # of years. Less than 100
<span style="color:black">BIOSCODE:0476                 </span><span style="color:navy">inc     ds:</span>daycnt
<span style="color:black">BIOSCODE:047A                 </span><span style="color:navy">cmp     ds:</span>daycnt<span style="color:navy">, </span><span style="color:green">366  </span>; daycnt = remainder of leap year block
<span style="color:black">BIOSCODE:047A                                         </span>; within 366+355+355+355 days
<span style="color:black">BIOSCODE:0480                 </span><span style="color:navy">jbe     short </span>leapyear
<span style="color:black">BIOSCODE:0482                 </span><span style="color:navy">inc     ds:</span>base_year    ; if daycnt &lt;= 366, then leap year
<span style="color:black">BIOSCODE:0482                                         </span>; else daycnt -= 366, base_year++
<span style="color:black">BIOSCODE:0486                 </span><span style="color:navy">sub     ds:</span>daycnt<span style="color:navy">, </span><span style="color:green">366
</span><span style="color:black">BIOSCODE:048C                 </span><span style="color:navy">mov     cx, </span><span style="color:green">3           </span>; And next three years are normal
<span style="color:black">BIOSCODE:048F
BIOSCODE:048F </span><span style="color:gray">regularyear</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:048F                 </span><span style="color:navy">cmp     ds:</span>daycnt<span style="color:navy">, </span><span style="color:green">365  </span>; for(i=1; i&gt;3 or daycnt &lt;=365; i++)
<span style="color:black">BIOSCODE:0495                 </span><span style="color:navy">jbe     short </span>yeardone  ; {if (daycnt &gt; 365)
<span style="color:black">BIOSCODE:0497                 </span><span style="color:navy">inc     ds:</span>base_year    ; { daycnt -= 365
<span style="color:black">BIOSCODE:049B                 </span><span style="color:navy">sub     ds:</span>daycnt<span style="color:navy">, </span><span style="color:green">365  </span>; }
<span style="color:black">BIOSCODE:04A1                 </span><span style="color:navy">loop    </span><span style="color:gray">regularyear     </span>; }
<span style="color:black">BIOSCODE:04A1                                         </span>; should never fall through loop
<span style="color:black">BIOSCODE:04A3
BIOSCODE:04A3 </span>leapyear<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:04A3                 </span><span style="color:navy">mov     ds:</span>february<span style="color:navy">, </span><span style="color:green">29 </span>; leap year.
<span style="color:black">BIOSCODE:04A3                                         </span>; change month table.
<span style="color:black">BIOSCODE:04A8
BIOSCODE:04A8 </span>yeardone<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:04A8                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">BIOSCODE:04AA                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSCODE:04AC                 </span><span style="color:navy">mov     ax, ds:</span>daycnt
<span style="color:black">BIOSCODE:04AF                 </span><span style="color:navy">mov     si, offset </span>month_table
<span style="color:black">BIOSCODE:04B2                 </span><span style="color:navy">mov     cx, </span><span style="color:green">12
</span><span style="color:black">BIOSCODE:04B5
BIOSCODE:04B5 </span><span style="color:gray">months</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:04B5                 </span><span style="color:navy">inc     bl
</span><span style="color:black">BIOSCODE:04B7                 </span><span style="color:navy">mov     dl, [si]
</span><span style="color:black">BIOSCODE:04B9                 </span><span style="color:navy">cmp     ax, dx          </span>; cmp daycnt for each month till fit
<span style="color:black">BIOSCODE:04B9                                         </span>; dh=0
<span style="color:black">BIOSCODE:04BB                 </span><span style="color:navy">jbe     short </span><span style="color:gray">month_done
</span><span style="color:black">BIOSCODE:04BD                 </span><span style="color:navy">inc     si              </span>; next month
<span style="color:black">BIOSCODE:04BE                 </span><span style="color:navy">sub     ax, dx          </span>; adjust daycnt
<span style="color:black">BIOSCODE:04C0                 </span><span style="color:navy">loop    </span><span style="color:gray">months          </span>;
<span style="color:black">BIOSCODE:04C0                                         </span>; should never fall through loop
<span style="color:black">BIOSCODE:04C2
BIOSCODE:04C2 </span><span style="color:gray">month_done</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:04C2                 </span><span style="color:navy">mov     ds:</span>february<span style="color:navy">, </span><span style="color:green">28 </span>; restore month table value
<span style="color:black">BIOSCODE:04C7                 </span><span style="color:navy">mov     dl, bl
</span><span style="color:black">BIOSCODE:04C9                 </span><span style="color:navy">mov     dh, ds:</span>base_year
<span style="color:black">BIOSCODE:04CD                 </span><span style="color:navy">mov     cl, ds:</span>base_century ; al=day,dl=month,dh=year,cl=cntry
<span style="color:black">BIOSCODE:04D1                 </span><span style="color:navy">call    </span>bintobcd        ; convert &quot;day&quot; to bcd
<span style="color:black">BIOSCODE:04D1                                         </span>; dl = bcd day, al = month
<span style="color:black">BIOSCODE:04D4                 </span><span style="color:navy">xchg    dl, al
</span><span style="color:black">BIOSCODE:04D6                 </span><span style="color:navy">call    </span>bintobcd        ; dh = bcd month, al = year
<span style="color:black">BIOSCODE:04D9                 </span><span style="color:navy">xchg    dh, al
</span><span style="color:black">BIOSCODE:04DB                 </span><span style="color:navy">call    </span>bintobcd        ; cl = bcd year, al = century
<span style="color:black">BIOSCODE:04DE                 </span><span style="color:navy">xchg    cl, al
</span><span style="color:black">BIOSCODE:04E0                 </span><span style="color:navy">call    </span>bintobcd        ; ch = bcd century
<span style="color:black">BIOSCODE:04E3                 </span><span style="color:navy">mov     ch, al
</span><span style="color:black">BIOSCODE:04E5                 </span><span style="color:navy">pop     ds:</span>daycnt       ; restore original value
<span style="color:black">BIOSCODE:04E9                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:04E9 </span>daycnttoday     <span style="color:black">endp
BIOSCODE:04E9
BIOSCODE:04EA
BIOSCODE:04EA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:04EA
BIOSCODE:04EA
BIOSCODE:04EA </span>bintobcd        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:04EA                 </span><span style="color:navy">aam                     </span>; convert a binary input in al
<span style="color:black">BIOSCODE:04EA                                         </span>; (less than 63h or 99 decimal)
<span style="color:black">BIOSCODE:04EA                                         </span>; into a bcd value in al. ah destroyed
<span style="color:black">BIOSCODE:04EA                                         </span>;
<span style="color:black">BIOSCODE:04EA                                         </span>; AH = AL/10, AL = AL MOD 10
<span style="color:black">BIOSCODE:04EC                 </span><span style="color:navy">aad     </span><span style="color:green">10h             </span>; db 0D5h,10h
<span style="color:black">BIOSCODE:04EC                                         </span>; AL = (AH*10H)+AL, AH = 0
<span style="color:black">BIOSCODE:04EE                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:04EE </span>bintobcd        <span style="color:black">endp
BIOSCODE:04EE
</span><span style="color:maroon">BIOSCODE:04EF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:04EF
BIOSCODE:04EF </span>tim_read<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:04EF                 </span><span style="color:navy">call    </span>GetTickCnt      ; gettime reads date and time
<span style="color:maroon">BIOSCODE:04EF                                         </span>;
<span style="color:maroon">BIOSCODE:04EF                                         </span>; 65,536 seconds = 1,193,180 ticks
<span style="color:maroon">BIOSCODE:04EF                                         </span>;
<span style="color:maroon">BIOSCODE:04EF                                         </span>; time in 100th of seconds
<span style="color:maroon">BIOSCODE:04EF                                         </span>;    = ticks from clock  * 65,536 * 100 / 1,193,180
<span style="color:maroon">BIOSCODE:04EF                                         </span>;    = ticks from clock * 5 * 65,536 / 59,659
<span style="color:maroon">BIOSCODE:04F2                 </span><span style="color:navy">mov     si, ds:</span>daycnt
<span style="color:maroon">BIOSCODE:04F6                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:maroon">BIOSCODE:04F8                 </span><span style="color:navy">mov     bx, dx          </span>; start with ticks in cx:dx
<span style="color:maroon">BIOSCODE:04F8                                         </span>; multiply by 5
<span style="color:maroon">BIOSCODE:04FA                 </span><span style="color:navy">shl     dx, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:04FC                 </span><span style="color:navy">rcl     cx, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:04FE                 </span><span style="color:navy">shl     dx, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:0500                 </span><span style="color:navy">rcl     cx, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:0502                 </span><span style="color:navy">add     dx, bx
</span><span style="color:maroon">BIOSCODE:0504                 </span><span style="color:navy">adc     ax, cx
</span><span style="color:maroon">BIOSCODE:0506                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:maroon">BIOSCODE:0507                 </span><span style="color:navy">mov     cx, </span><span style="color:green">59659       </span>; multiply by 65536 and divide by 59659
<span style="color:maroon">BIOSCODE:050A                 </span><span style="color:navy">div     cx              </span>; dx has remainder
<span style="color:maroon">BIOSCODE:050A                                         </span>; ax has high word of final quotient
<span style="color:maroon">BIOSCODE:050C                 </span><span style="color:navy">xchg    ax, bx          </span>; put high word in safe place
<span style="color:maroon">BIOSCODE:050D                 </span><span style="color:navy">xor     ax, ax          </span>; multiply by 65536
<span style="color:maroon">BIOSCODE:050F                 </span><span style="color:navy">div     cx              </span>; bx:ax has time in 100th of seconds
<span style="color:maroon">BIOSCODE:0511                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:maroon">BIOSCODE:0513                 </span><span style="color:navy">mov     cx, </span><span style="color:green">200         </span>; division by 200 is necessary
<span style="color:maroon">BIOSCODE:0513                                         </span>; to ensure no overflow--max result
<span style="color:maroon">BIOSCODE:0513                                         </span>; is number of seconds in a day/2 = 43200.
<span style="color:maroon">BIOSCODE:0516                 </span><span style="color:navy">div     cx
</span><span style="color:maroon">BIOSCODE:0518                 </span><span style="color:navy">cmp     dl, </span><span style="color:green">100         </span>; remainder over 100?
<span style="color:maroon">BIOSCODE:051B                 </span><span style="color:navy">jb      short </span>noadj
<span style="color:maroon">BIOSCODE:051D                 </span><span style="color:navy">sub     dl, </span><span style="color:green">100         </span>; keep 1/100&#039;s less than 100
<span style="color:maroon">BIOSCODE:0520
BIOSCODE:0520 </span>noadj<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0520                 </span><span style="color:navy">cmc                     </span>; if we subtracted 100, carry is now set
<span style="color:maroon">BIOSCODE:0521                 </span><span style="color:navy">mov     bl, dl          </span>; save 1/100&#039;s
<span style="color:maroon">BIOSCODE:0523                 </span><span style="color:navy">rcl     ax, </span><span style="color:green">1           </span>; multiply by two
<span style="color:maroon">BIOSCODE:0525                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:0527                 </span><span style="color:navy">rcl     dx, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:0529                 </span><span style="color:navy">mov     cl, </span><span style="color:green">60          </span>; divide out seconds
<span style="color:maroon">BIOSCODE:052B                 </span><span style="color:navy">div     cx
</span><span style="color:maroon">BIOSCODE:052D                 </span><span style="color:navy">mov     bh, dl          </span>; save the seconds
<span style="color:maroon">BIOSCODE:052F                 </span><span style="color:navy">div     cl              </span>; break into hours and minutes
<span style="color:maroon">BIOSCODE:0531                 </span><span style="color:navy">xchg    al, ah          </span>; time is now in ax:bx
<span style="color:maroon">BIOSCODE:0531                                         </span>; (hours, minutes, seconds, 1/100 sec)
<span style="color:maroon">BIOSCODE:0533                 </span><span style="color:navy">xchg    ax, si          </span>; daycnt
<span style="color:maroon">BIOSCODE:0534                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSCODE:0535                 </span><span style="color:navy">xchg    ax, si          </span>; al = hours, ah = minutes
<span style="color:maroon">BIOSCODE:0536                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSCODE:0537                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">BIOSCODE:0539                 </span><span style="color:navy">stosw
</span><span style="color:maroon">BIOSCODE:053A                 </span><span style="color:navy">clc                     </span>; [es:di] = count of days since 1-1-80
<span style="color:maroon">BIOSCODE:053A                                         </span>;    [es:di+2] = hours
<span style="color:maroon">BIOSCODE:053A                                         </span>;    [es:di+3] = minutes
<span style="color:maroon">BIOSCODE:053A                                         </span>;    [es:di+4] = seconds
<span style="color:maroon">BIOSCODE:053A                                         </span>;    [es:di+5] = hundredths of seconds
<span style="color:maroon">BIOSCODE:053B                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:053C
BIOSCODE:053C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:053C
BIOSCODE:053C
BIOSCODE:053C </span>GetTickCnt      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:053C                 </span><span style="color:navy">xor     ah, ah          </span>; Returns the tick count in cx:dx
<span style="color:black">BIOSCODE:053C                                         </span>; Takes care of DayCnt in case of rollover
<span style="color:black">BIOSCODE:053C                                         </span>; if ( rollover ) {
<span style="color:black">BIOSCODE:053C                                         </span>;     if ( t_switch )
<span style="color:black">BIOSCODE:053C                                         </span>;            daycnt++ ;
<span style="color:black">BIOSCODE:053C                                         </span>;     else
<span style="color:black">BIOSCODE:053C                                         </span>;            daycnt += rollover ;
<span style="color:black">BIOSCODE:053C                                         </span>;     }
<span style="color:black">BIOSCODE:053E                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; CLOCK - GET TIME OF DAY
<span style="color:black">BIOSCODE:053E                                         </span>; Return: CX:DX = clock count
<span style="color:black">BIOSCODE:053E                                         </span>; AL = 00h if clock was read or written (via AH=0,1) since the previous
<span style="color:black">BIOSCODE:053E                                         </span>; midnight
<span style="color:black">BIOSCODE:053E                                         </span>; Otherwise, AL &gt; 0
<span style="color:black">BIOSCODE:0540                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">BIOSCODE:0542                 </span><span style="color:navy">cmp     ds:</span>t_switch<span style="color:navy">, ah </span>; use old method ? (&gt;0 is yes)
<span style="color:black">BIOSCODE:0546                 </span><span style="color:navy">jnz     short </span><span style="color:gray">inc_case  </span>; old method assumes that Int 1Ah returns rollover flag
<span style="color:black">BIOSCODE:0548                 </span><span style="color:navy">add     ds:</span>daycnt<span style="color:navy">, ax   </span>; new method assumes that Int 1Ah returns roll over count
<span style="color:black">BIOSCODE:0548                                         </span>; and not flag
<span style="color:black">BIOSCODE:054C                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:054D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:054D
BIOSCODE:054D </span><span style="color:gray">inc_case</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:054D                 </span><span style="color:navy">or      al, al
</span><span style="color:black">BIOSCODE:054F                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_rollover
</span><span style="color:black">BIOSCODE:0551                 </span><span style="color:navy">inc     ds:</span>daycnt
<span style="color:black">BIOSCODE:0555
BIOSCODE:0555 </span><span style="color:gray">no_rollover</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0555                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0555 </span>GetTickCnt      <span style="color:black">endp
BIOSCODE:0555
BIOSCODE:0555 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:0556 </span>fat_12_id       <span style="color:navy">db &#039;FAT12   &#039;           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:055E </span>fat_16_id       <span style="color:navy">db &#039;FAT16   &#039;           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0566 </span>fat_32_id       <span style="color:navy">db &#039;FAT32   &#039;           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:056E </span>nul_vid         <span style="color:navy">db &#039;NO NAME    &#039;        </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0579 </span>DSKTBL          <span style="color:navy">db </span><span style="color:#008040">26                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:057A                 </span><span style="color:navy">dw offset </span>dsk_init
<span style="color:gray">BIOSCODE:057C                 </span><span style="color:navy">dw offset </span>media_chk
<span style="color:gray">BIOSCODE:057E                 </span><span style="color:navy">dw offset </span>get_bpb
<span style="color:gray">BIOSCODE:0580                 </span><span style="color:navy">dw offset </span>ioctl_input   ; PCDOS 7
<span style="color:gray">BIOSCODE:0582                 </span><span style="color:navy">dw offset </span>dsk_read
<span style="color:gray">BIOSCODE:0584                 </span><span style="color:navy">dw offset </span>x_bus_exit
<span style="color:gray">BIOSCODE:0586                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:0588                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:058A                 </span><span style="color:navy">dw offset </span>dsk_writ
<span style="color:gray">BIOSCODE:058C                 </span><span style="color:navy">dw offset </span>dsk_writv
<span style="color:gray">BIOSCODE:058E                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:0590                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:0592                 </span><span style="color:navy">dw offset </span>ioctl_output  ; PCDOS 7
<span style="color:gray">BIOSCODE:0594                 </span><span style="color:navy">dw offset </span>dsk_open
<span style="color:gray">BIOSCODE:0596                 </span><span style="color:navy">dw offset </span>dsk_close
<span style="color:gray">BIOSCODE:0598                 </span><span style="color:navy">dw offset </span>dsk_rem
<span style="color:gray">BIOSCODE:059A                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:059C                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:059E                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:05A0                 </span><span style="color:navy">dw offset </span>do_generic_ioctl
<span style="color:gray">BIOSCODE:05A2                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:05A4                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:05A6                 </span><span style="color:navy">dw offset </span>ret_carry_clear
<span style="color:gray">BIOSCODE:05A8                 </span><span style="color:navy">dw offset </span>ioctl_getown
<span style="color:gray">BIOSCODE:05AA                 </span><span style="color:navy">dw offset </span>ioctl_setown
<span style="color:gray">BIOSCODE:05AC                 </span><span style="color:navy">dw offset </span>ioctl_support_query
<span style="color:black">BIOSCODE:05AE
BIOSCODE:05AE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:05AE
BIOSCODE:05AE
BIOSCODE:05AE </span>SetDrive        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:05AE                 </span><span style="color:navy">les     di, dword ptr ds:</span>start_bds ; Point es:di to first bds
<span style="color:black">BIOSCODE:05B2
BIOSCODE:05B2 </span><span style="color:gray">X_Scan_Loop</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:05B2                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], al   </span>; logical drive number (BDS.drivelet)
<span style="color:black">BIOSCODE:05B6                 </span><span style="color:navy">jz      short </span><span style="color:gray">X_SetDrv
</span><span style="color:black">BIOSCODE:05B8                 </span><span style="color:navy">les     di, es:[di]     </span>; [es:di+BDS.link] ; Go to next bds
<span style="color:black">BIOSCODE:05BB                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">BIOSCODE:05BE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">X_Scan_Loop
</span><span style="color:black">BIOSCODE:05C0                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:05C1
BIOSCODE:05C1 </span><span style="color:gray">X_SetDrv</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:05C1                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:05C1 </span>SetDrive        <span style="color:black">endp
BIOSCODE:05C1
</span><span style="color:maroon">BIOSCODE:05C2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:05C2
BIOSCODE:05C2 </span>media_chk<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:05C2                 </span><span style="color:navy">call    </span>SetDrive
<span style="color:maroon">BIOSCODE:05C5                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:05C8                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags+1], fchanged_by_format
<span style="color:maroon">BIOSCODE:05CD                 </span><span style="color:navy">jz      short </span>WeAreNotFakingIt
<span style="color:maroon">BIOSCODE:05CF                 </span><span style="color:navy">and     byte ptr es:[di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">0FEh </span>; [es:di+BDS.flags+1],
<span style="color:maroon">BIOSCODE:05CF                                         </span>; ~fchanged_by_format ; reset flag
<span style="color:maroon">BIOSCODE:05D4                 </span><span style="color:navy">mov     ds:</span>tim_drv<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:maroon">BIOSCODE:05D4                                         </span>; Ensure that we ask the rom if media has changed
<span style="color:maroon">BIOSCODE:05D9                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:maroon">BIOSCODE:05DE                 </span><span style="color:navy">jz      short </span>wehaveafloppy
<span style="color:maroon">BIOSCODE:05E0                 </span><span style="color:navy">neg     si
</span><span style="color:maroon">BIOSCODE:05E2                 </span><span style="color:navy">jmp     short </span>Media_Done
<span style="color:maroon">BIOSCODE:05E4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:05E4
BIOSCODE:05E4 </span>WeAreNotFakingIt<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:05E4                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:maroon">BIOSCODE:05E9                 </span><span style="color:navy">jnz     short </span>Media_Done
<span style="color:maroon">BIOSCODE:05EB
BIOSCODE:05EB </span>wehaveafloppy<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:05EB                 </span><span style="color:navy">dec     si              </span>; 0 ; Presume &quot;I don&#039;t know&quot;
<span style="color:maroon">BIOSCODE:05EC                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; Do we have changeline support?
<span style="color:maroon">BIOSCODE:05F1                 </span><span style="color:navy">jz      short </span>mChk_NoChangeLine ; Brif not
<span style="color:maroon">BIOSCODE:05F3                 </span><span style="color:navy">call    </span>mediacheck      ; Call into removable routine
<span style="color:maroon">BIOSCODE:05F6                 </span><span style="color:navy">jb      short </span>err_exitj
<span style="color:maroon">BIOSCODE:05F8                 </span><span style="color:navy">call    </span>haschange
<span style="color:maroon">BIOSCODE:05FB                 </span><span style="color:navy">jnz     short </span>Media_Done
<span style="color:maroon">BIOSCODE:05FD
BIOSCODE:05FD </span>mChk_NoChangeLine<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:05FD                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1           </span>; Presume no change
<span style="color:maroon">BIOSCODE:0600                 </span><span style="color:navy">mov     al, ds:</span>tim_drv  ; Last drive accessed
<span style="color:maroon">BIOSCODE:0603                 </span><span style="color:navy">cmp     al, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:maroon">BIOSCODE:0603                                         </span>; Is drive of last access the same?
<span style="color:maroon">BIOSCODE:0607                 </span><span style="color:navy">jnz     short </span>Media_Unk ; No, then &quot;i don&#039;t know&quot;
<span style="color:maroon">BIOSCODE:0609                 </span><span style="color:navy">call    </span>Check_Time_Of_Access
<span style="color:maroon">BIOSCODE:060C                 </span><span style="color:navy">jmp     short </span>Media_Done
<span style="color:maroon">BIOSCODE:060E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:060E
BIOSCODE:060E </span>Media_Unk<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:060E                 </span><span style="color:navy">dec     si              </span>; 0 ; Return &quot;I don&#039;t know&quot;
<span style="color:maroon">BIOSCODE:060F
BIOSCODE:060F </span>Media_Done<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:060F                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:0610                 </span><span style="color:navy">les     bx, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:0614                 </span><span style="color:navy">mov     es:[bx+</span><span style="color:green">14</span><span style="color:navy">], si  </span>; [es:bx+trans]
<span style="color:maroon">BIOSCODE:0618                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:0619                 </span><span style="color:navy">or      si, si
</span><span style="color:maroon">BIOSCODE:061B                 </span><span style="color:navy">jns     short </span>ret_carry_clear ; volidok
<span style="color:maroon">BIOSCODE:061D                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:0622                 </span><span style="color:navy">jz      short </span>mChk1_NoChangeLine
<span style="color:maroon">BIOSCODE:0624                 </span><span style="color:navy">call    </span>media_set_vid
<span style="color:maroon">BIOSCODE:0627
BIOSCODE:0627 </span>mChk1_NoChangeLine<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0627                 </span><span style="color:navy">mov     ds:</span>tim_drv<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:maroon">BIOSCODE:0627                                         </span>; Make sure we ask rom for media check
<span style="color:maroon">BIOSCODE:062C
BIOSCODE:062C </span>ret_carry_clear<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:062C                 </span><span style="color:navy">clc                     </span>; volidok
<span style="color:maroon">BIOSCODE:062D                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:062E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:062E
BIOSCODE:062E </span>err_exitj<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:062E                 </span><span style="color:navy">call    </span>maperror        ; guaranteed to set carry
<span style="color:black">BIOSCODE:0631 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR get_bpb
</span><span style="color:black">BIOSCODE:0631
BIOSCODE:0631 </span>ret81<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0631                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">81h         </span>; return error status
<span style="color:black">BIOSCODE:0633                 </span><span style="color:navy">retn                    </span>; return with carry set
<span style="color:black">BIOSCODE:0633 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR get_bpb
</span><span style="color:black">BIOSCODE:0634
BIOSCODE:0634 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0634
BIOSCODE:0634
BIOSCODE:0634 </span>Check_Time_Of_Access <span style="color:black">proc near          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0634                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1           </span>; presume no change
<span style="color:black">BIOSCODE:0637                 </span><span style="color:navy">call    </span>GetTickCnt      ; cx:dx is the elapsed time
<span style="color:black">BIOSCODE:063A                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">79h</span><span style="color:navy">] </span>; [es:di+BDS.tim_lo]
<span style="color:black">BIOSCODE:063A                                         </span>; get stored time
<span style="color:black">BIOSCODE:063E                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:black">BIOSCODE:0640                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">] </span>; [es:di+BDS.tim_hi]
<span style="color:black">BIOSCODE:0644                 </span><span style="color:navy">sbb     cx, ax
</span><span style="color:black">BIOSCODE:0646                 </span><span style="color:navy">mov     al, ds:</span>accesscount
<span style="color:black">BIOSCODE:0649                 </span><span style="color:navy">jnz     short </span><span style="color:gray">timecheck_unk </span>; cx&lt;&gt;0 =&gt; &gt;1 hour
<span style="color:black">BIOSCODE:064B                 </span><span style="color:navy">or      dx, dx          </span>; time must pass
<span style="color:black">BIOSCODE:064D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">timepassed </span>; yes, examine max value
<span style="color:black">BIOSCODE:064F                 </span><span style="color:navy">inc     al
</span><span style="color:black">BIOSCODE:0651                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:black">BIOSCODE:0653                 </span><span style="color:navy">jb      short </span><span style="color:gray">timecheck_ret </span>; if count is less than threshold, ok
<span style="color:black">BIOSCODE:0655                 </span><span style="color:navy">dec     al
</span><span style="color:black">BIOSCODE:0657                 </span><span style="color:navy">jmp     short </span><span style="color:gray">timecheck_unk
</span><span style="color:black">BIOSCODE:0659 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0659
BIOSCODE:0659 </span><span style="color:gray">timepassed</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0659                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">36          </span>; 18*2 ; 18.2 tics per second.
<span style="color:black">BIOSCODE:0659                                         </span>; min elapsed time? (2 seconds)
<span style="color:black">BIOSCODE:065C                 </span><span style="color:navy">jbe     short </span><span style="color:gray">timecheck_ret
</span><span style="color:black">BIOSCODE:065E
BIOSCODE:065E </span><span style="color:gray">timecheck_unk</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:065E                 </span><span style="color:navy">dec     si              </span>; presume i don&#039;t know
<span style="color:black">BIOSCODE:065F
BIOSCODE:065F </span><span style="color:gray">timecheck_ret</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:065F                 </span><span style="color:navy">mov     ds:</span>accesscount<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:0662                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0662 </span>Check_Time_Of_Access <span style="color:black">endp
BIOSCODE:0662
</span><span style="color:maroon">BIOSCODE:0663 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0663                 </span><span style="color:navy">jmp     short </span>err_exitj
<span style="color:black">BIOSCODE:0665
BIOSCODE:0665 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0665
BIOSCODE:0665
BIOSCODE:0665 </span>get_bpb         <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:0665
BIOSCODE:0665 </span><span style="color:gray">; FUNCTION CHUNK AT BIOSCODE:0631 SIZE 00000003 BYTES
</span><span style="color:black">BIOSCODE:0665
BIOSCODE:0665                 </span><span style="color:navy">mov     ah, es:[di]     </span>; Build a valid bpb for the disk in the drive.
<span style="color:black">BIOSCODE:0665                                         </span>; get fat id byte read by dos
<span style="color:black">BIOSCODE:0668                 </span><span style="color:navy">call    </span>SetDrive        ; get the correct bds for the drive
<span style="color:black">BIOSCODE:066B                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0670                 </span><span style="color:navy">jnz     short </span>already_gotbpb ; no need to build for fixed disks
<span style="color:black">BIOSCODE:0672                 </span><span style="color:navy">call    </span>clear_ids
<span style="color:black">BIOSCODE:0675                 </span><span style="color:navy">mov     ds:</span>set_id_flag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; indicate to set system id in bds
<span style="color:black">BIOSCODE:067A                 </span><span style="color:navy">call    </span>GetBp           ; build a bpb if necessary
<span style="color:black">BIOSCODE:067D                 </span><span style="color:navy">jb      short </span>ret81
<span style="color:black">BIOSCODE:067F                 </span><span style="color:navy">cmp     ds:</span>set_id_flag<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; already, volume_label set from boot
<span style="color:black">BIOSCODE:0684                 </span><span style="color:navy">mov     ds:</span>set_id_flag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; record to bds table?
<span style="color:black">BIOSCODE:0689                 </span><span style="color:navy">jz      short </span>already_gotbpb ; do not set it again from root dir
<span style="color:black">BIOSCODE:0689                                         </span>; otherwise, conventional boot record
<span style="color:black">BIOSCODE:068B                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; do we have changeline support?
<span style="color:black">BIOSCODE:0690                 </span><span style="color:navy">jz      short </span>already_gotbpb ; brif not
<span style="color:black">BIOSCODE:0692                 </span><span style="color:navy">call    </span>set_volume_id
<span style="color:black">BIOSCODE:0695
BIOSCODE:0695 </span>already_gotbpb<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0695                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">6           </span>; BDS.BPB (BDS offset 6)
<span style="color:black">BIOSCODE:0698
BIOSCODE:0698 </span>SetPtrSav<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0698                 </span><span style="color:navy">push    ds              </span>; return point for dsk_init
<span style="color:black">BIOSCODE:0699                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav
<span style="color:black">BIOSCODE:069D                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], ah    </span>; [bx+media]
<span style="color:black">BIOSCODE:06A0                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">12h</span><span style="color:navy">], di    </span>; [bx+count]
<span style="color:black">BIOSCODE:06A3                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">14h</span><span style="color:navy">], es </span>; [bx+count+2]
<span style="color:black">BIOSCODE:06A6                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:06A7                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:06A8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:06A9                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:06AA                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:06AA </span>get_bpb         <span style="color:black">endp
BIOSCODE:06AA
BIOSCODE:06AB
BIOSCODE:06AB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:06AB
BIOSCODE:06AB
BIOSCODE:06AB </span>clear_ids       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:06AB                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:06AC                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">BIOSCODE:06AE                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">89h</span><span style="color:navy">], cx </span>; [es:di+BDS.vol_serial]
<span style="color:black">BIOSCODE:06B3                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">8Bh</span><span style="color:navy">], cx </span>; [es:di+BDS.vol_serial+2]
<span style="color:black">BIOSCODE:06B8                 </span><span style="color:navy">mov     cl, </span><span style="color:green">11
</span><span style="color:black">BIOSCODE:06BA                 </span><span style="color:navy">mov     si, offset </span>nul_vid <span style="color:gray">; &quot;NO NAME    &quot;
</span><span style="color:black">BIOSCODE:06BD                 </span><span style="color:navy">add     di, </span><span style="color:green">125         </span>; BDS.volid
<span style="color:black">BIOSCODE:06C0                 </span><span style="color:navy">rep movs byte ptr es:[di], byte ptr cs:[si] </span>; cs rep movsb
<span style="color:black">BIOSCODE:06C3                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:green">59</span><span style="color:navy">], </span><span style="color:green">20h </span>; (here, es:di points to the BDS offset +136)
<span style="color:black">BIOSCODE:06C3                                         </span>; [es:di+BDS.fatsiz], fbigbig
<span style="color:black">BIOSCODE:06C3                                         </span>;
<span style="color:black">BIOSCODE:06C3                                         </span>; ! NOTE - 26/06/2023 - Erdogan Tan
<span style="color:black">BIOSCODE:06C3                                         </span>; Microsoft/IBM code has a bug here because the BDS&#039;s
<span style="color:black">BIOSCODE:06C3                                         </span>; .volid and .filesys_id fields will be reset
<span style="color:black">BIOSCODE:06C3                                         </span>; (to their default text) according to &#039;BDS.fatsiz&#039; flags
<span style="color:black">BIOSCODE:06C3                                         </span>; at the BDS offset 59 but current (this) code checks flags
<span style="color:black">BIOSCODE:06C3                                         </span>; at ES:DI+59 while DI points the BDS offset 136!?
<span style="color:black">BIOSCODE:06C3                                         </span>;
<span style="color:black">BIOSCODE:06C3                                         </span>; Correct Code:
<span style="color:black">BIOSCODE:06C3                                         </span>; test byte [ES:DI+59-136],20h or
<span style="color:black">BIOSCODE:06C3                                         </span>; DI_POSITION equ BDS.volid + size_of_EXT_BOOT_VOL_LABEL
<span style="color:black">BIOSCODE:06C3                                         </span>; test byte [ES:DI:BDS.fatsiz-DI_POSITION],20h ; fbigbig
<span style="color:black">BIOSCODE:06C3                                         </span>;
<span style="color:black">BIOSCODE:06C3                                         </span>; (Why this bug did not affect MSDOS and PCDOS 7.x applications:
<span style="color:black">BIOSCODE:06C3                                         </span>; &#039;clear_ids&#039; is used for floppy disks only and the default
<span style="color:black">BIOSCODE:06C3                                         </span>; option of &#039;clear_ids&#039; is FAT12 volid and filesys_id text
<span style="color:black">BIOSCODE:06C3                                         </span>; when the flag bit has wrong value for FAT16/40h or FAT32/20h.)
<span style="color:black">BIOSCODE:06C8                 </span><span style="color:navy">mov     si, offset </span>fat_32_id <span style="color:gray">; &quot;FAT32   &quot;
</span><span style="color:black">BIOSCODE:06CB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ci_bigfat
</span><span style="color:black">BIOSCODE:06CD                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:green">59</span><span style="color:navy">], </span><span style="color:green">40h </span>; [es:di+BDS.fatsiz], fbig
<span style="color:black">BIOSCODE:06D2                 </span><span style="color:navy">mov     si, offset </span>fat_16_id <span style="color:gray">; &quot;FAT16   &quot;
</span><span style="color:black">BIOSCODE:06D5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ci_bigfat
</span><span style="color:black">BIOSCODE:06D7                 </span><span style="color:navy">mov     si, offset </span>fat_12_id <span style="color:gray">; &quot;FAT12   &quot;
</span><span style="color:black">BIOSCODE:06DA
BIOSCODE:06DA </span><span style="color:gray">ci_bigfat</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:06DA                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">8           </span>; size_of_EXT_SYSTEM_ID
<span style="color:black">BIOSCODE:06DC                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">5           </span>; (BDS.filesys_id-BDS.volid)-size_of_EXT_BOOT_VOL_LABEL
<span style="color:black">BIOSCODE:06DC                                         </span>; BDS.filesys_id (BDS offset 141)
<span style="color:black">BIOSCODE:06DF                 </span><span style="color:navy">rep movs byte ptr es:[di], byte ptr cs:[si] </span>; 0F3h,2Eh,0A4h
<span style="color:black">BIOSCODE:06DF                                         </span>; cs rep movsb
<span style="color:black">BIOSCODE:06E2                 </span><span style="color:navy">pop     di              </span>; restore bds pointer
<span style="color:black">BIOSCODE:06E3
BIOSCODE:06E3 </span>getret_exit<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:06E3                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:06E3 </span>clear_ids       <span style="color:black">endp
BIOSCODE:06E3
BIOSCODE:06E4
BIOSCODE:06E4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:06E4
BIOSCODE:06E4
BIOSCODE:06E4 </span>GetBp           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:06E4                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">5 </span>; [es:di+BDS.flags],
<span style="color:black">BIOSCODE:06E4                                         </span>; return_fake_bpb|fnon_removable
<span style="color:black">BIOSCODE:06E9                 </span><span style="color:navy">jnz     short </span>getret_exit
<span style="color:black">BIOSCODE:06EB                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:06EC                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:06ED                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:06EE                 </span><span style="color:navy">call    </span>readbootsec
<span style="color:black">BIOSCODE:06F1                 </span><span style="color:navy">jb      short </span><span style="color:gray">getbp_err_ret_brdg
</span><span style="color:black">BIOSCODE:06F3                 </span><span style="color:navy">or      bx, bx          </span>; bx is 0 if boot sector is valid
<span style="color:black">BIOSCODE:06F5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dofatbpb
</span><span style="color:black">BIOSCODE:06F7                 </span><span style="color:navy">call    </span>movbpb          ; move bpb into registers
<span style="color:black">BIOSCODE:06FA                 </span><span style="color:navy">jmp     </span><span style="color:gray">getret
</span><span style="color:black">BIOSCODE:06FD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:06FD
BIOSCODE:06FD </span><span style="color:gray">getbp_err_ret_brdg</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:06FD                 </span><span style="color:navy">jmp     </span><span style="color:gray">getbp_err_ret
</span><span style="color:black">BIOSCODE:0700 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0700
BIOSCODE:0700 </span><span style="color:gray">dofatbpb</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0700                 </span><span style="color:navy">call    </span>readfat         ; puts media descriptor byte in ah
<span style="color:black">BIOSCODE:0703                 </span><span style="color:navy">jb      short </span><span style="color:gray">getbp_err_ret_brdg
</span><span style="color:black">BIOSCODE:0705                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; changeline support available?
<span style="color:black">BIOSCODE:070A                 </span><span style="color:navy">jz      short </span><span style="color:gray">bpb_nochangeline </span>; brif not
<span style="color:black">BIOSCODE:070C                 </span><span style="color:navy">call    </span>hidensity
<span style="color:black">BIOSCODE:070F
BIOSCODE:070F </span><span style="color:gray">bpb_nochangeline</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:070F                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:di+BDS.formfactor], ffSmall
<span style="color:black">BIOSCODE:0714                 </span><span style="color:navy">jnz     short </span><span style="color:gray">is_floppy
</span><span style="color:black">BIOSCODE:0716                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0F9h        </span>; is it a valid fat id byte for 3.5&quot; ?
<span style="color:black">BIOSCODE:0719                 </span><span style="color:navy">jz      short </span>Has720K   ; yes
<span style="color:black">BIOSCODE:071B                 </span><span style="color:navy">jmp     </span><span style="color:gray">got_unknown_medium
</span><span style="color:black">BIOSCODE:071E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:071E
BIOSCODE:071E </span>Has720K<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:071E                 </span><span style="color:navy">mov     al, </span><span style="color:green">3           </span>; bpbtype.sbf = 3
<span style="color:black">BIOSCODE:0720                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1440        </span>; bpbtype.csec = 1440
<span style="color:black">BIOSCODE:0723                 </span><span style="color:navy">mov     dx, </span><span style="color:green">202h        </span>; dl = bpbtype.spau = 2
<span style="color:black">BIOSCODE:0723                                         </span>; dh = bpbtype.chead = 2
<span style="color:black">BIOSCODE:0726                 </span><span style="color:navy">mov     bx, </span><span style="color:green">7009h       </span>; bl = bpbtype.spt = 9
<span style="color:black">BIOSCODE:0726                                         </span>; bh = bpbtype.dire = 112
<span style="color:black">BIOSCODE:0729                 </span><span style="color:navy">jmp     short </span>Has1
<span style="color:black">BIOSCODE:072B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:072B
BIOSCODE:072B </span><span style="color:gray">is_floppy</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:072B                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0F8h
</span><span style="color:black">BIOSCODE:072E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">chk_160K
</span><span style="color:black">BIOSCODE:0730                 </span><span style="color:navy">jmp     </span><span style="color:gray">got_unknown_medium
</span><span style="color:black">BIOSCODE:0733 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0733
BIOSCODE:0733 </span><span style="color:gray">chk_160K</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0733                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; bpbtype.sbf = 1
<span style="color:black">BIOSCODE:0735                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">4008h       </span>; bl = bpbtype.spt = 8
<span style="color:black">BIOSCODE:0735                                         </span>; bh = bpbtype.dire = 64
<span style="color:black">BIOSCODE:0738                 </span><span style="color:navy">mov     cx, </span><span style="color:green">320         </span>; bpbtype.csec = 320
<span style="color:black">BIOSCODE:073B                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">101h        </span>; dl = bpbtype.spau = 1
<span style="color:black">BIOSCODE:073B                                         </span>; dh = bpbtype.chead = 1
<span style="color:black">BIOSCODE:073E                 </span><span style="color:navy">test    ah, </span><span style="color:green">2
</span><span style="color:black">BIOSCODE:0741                 </span><span style="color:navy">jnz     short </span><span style="color:gray">has8
</span><span style="color:black">BIOSCODE:0743                 </span><span style="color:navy">inc     ax              </span>; bpbtype.sbf = 2
<span style="color:black">BIOSCODE:0744                 </span><span style="color:navy">inc     bx              </span>; bpbtype.spt = 9
<span style="color:black">BIOSCODE:0745                 </span><span style="color:navy">add     cx, </span><span style="color:green">40          </span>; 180K (360 sectors)
<span style="color:black">BIOSCODE:0748
BIOSCODE:0748 </span><span style="color:gray">has8</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0748                 </span><span style="color:navy">test    ah, </span><span style="color:green">1           </span>; bpbtype.sbf = 1
<span style="color:black">BIOSCODE:074B                 </span><span style="color:navy">jz      short </span>Has1
<span style="color:black">BIOSCODE:074D                 </span><span style="color:navy">add     cx, cx
</span><span style="color:black">BIOSCODE:074F                 </span><span style="color:navy">mov     bh, </span><span style="color:green">112         </span>; bh = bpbtype.dire = 112
<span style="color:black">BIOSCODE:0751                 </span><span style="color:navy">inc     dh              </span>; bpbtype.chead = 2
<span style="color:black">BIOSCODE:0753                 </span><span style="color:navy">inc     dx              </span>; bpbtype.spau = 2
<span style="color:black">BIOSCODE:0754
BIOSCODE:0754 </span>Has1<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0754                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0755                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:0756                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0757                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">8</span><span style="color:navy">], dh      </span>; [di+BDS.secperclus]
<span style="color:black">BIOSCODE:075A                 </span><span style="color:navy">xor     dh, dh          </span>; 0
<span style="color:black">BIOSCODE:075C                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], dx    </span>; [di+BDS.heads]
<span style="color:black">BIOSCODE:075F                 </span><span style="color:navy">mov     dl, bh
</span><span style="color:black">BIOSCODE:0761                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], dx    </span>; [di+BDS.direntries]
<span style="color:black">BIOSCODE:0764                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], cx    </span>; [di+BDS.totalsecs16]
<span style="color:black">BIOSCODE:0767                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], cx    </span>; [di+BDS.totalsecs32]
<span style="color:black">BIOSCODE:076A                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">10h</span><span style="color:navy">], ah    </span>; [di+BDS.media]
<span style="color:black">BIOSCODE:076D                 </span><span style="color:navy">mov     dl, al
</span><span style="color:black">BIOSCODE:076F                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], dx    </span>; [di+BDS.fatsecs]
<span style="color:black">BIOSCODE:0772                 </span><span style="color:navy">mov     dl, bl
</span><span style="color:black">BIOSCODE:0774                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], dx    </span>; [di+BDS.secpertrack]
<span style="color:black">BIOSCODE:0777                 </span><span style="color:navy">xor     bx, bx          </span>; 0
<span style="color:black">BIOSCODE:0779                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">19h</span><span style="color:navy">], bx    </span>; [di+BDS.hiddensecs+2]
<span style="color:black">BIOSCODE:077C                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">17h</span><span style="color:navy">], bx    </span>; [di+BDS.hiddensecs]
<span style="color:black">BIOSCODE:077F                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], bx    </span>; [di+BDS.totalsecs32+2]
<span style="color:black">BIOSCODE:0782                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], bx    </span>; [di+BDS.fatsecs32] ; BPB_FATSz32
<span style="color:black">BIOSCODE:0785                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">21h</span><span style="color:navy">], bx    </span>; [di+BDS.fatsecs32+2]
<span style="color:black">BIOSCODE:0788                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">27h</span><span style="color:navy">], bx    </span>; [di+BDS.rootdirclust]
<span style="color:black">BIOSCODE:078B                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">29h</span><span style="color:navy">], bx    </span>; [di+BDS.rootdirclust+2]
<span style="color:black">BIOSCODE:078E                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">], bx    </span>; [di+BDS.reserved]
<span style="color:black">BIOSCODE:078E                                         </span>;     BPB_Reserved (12 zero bytes)
<span style="color:black">BIOSCODE:0791                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], bx
</span><span style="color:black">BIOSCODE:0794                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">33h</span><span style="color:navy">], bx
</span><span style="color:black">BIOSCODE:0797                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">35h</span><span style="color:navy">], bx
</span><span style="color:black">BIOSCODE:079A                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">37h</span><span style="color:navy">], bx
</span><span style="color:black">BIOSCODE:079D                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">39h</span><span style="color:navy">], bx
</span><span style="color:black">BIOSCODE:07A0                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">23h</span><span style="color:navy">], bx    </span>; [di+BDS.extflags] ; BPB_ExtFlags
<span style="color:black">BIOSCODE:07A3                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">25h</span><span style="color:navy">], bx    </span>; [di+BDS.fsver] ; BPB_FSVer
<span style="color:black">BIOSCODE:07A6                 </span><span style="color:navy">dec     bx              </span>; -1 ; 0FFFFFFFFh
<span style="color:black">BIOSCODE:07A7                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">], bx    </span>; [di+BDS.fsinfo] ; BPB_FSInfo
<span style="color:black">BIOSCODE:07AA                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">], bx    </span>; [di+BDS.bkbootsec] ; BPB_BkBootSec
<span style="color:black">BIOSCODE:07AD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:07AE
BIOSCODE:07AE </span><span style="color:gray">getret</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:07AE                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:07AF                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:07B0                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:07B1                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:07B2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:07B2
BIOSCODE:07B2 </span><span style="color:gray">getbp_err_ret</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:07B2                 </span><span style="color:navy">mov     ds:</span>set_id_flag<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:07B7                 </span><span style="color:navy">call    </span>maperror
<span style="color:black">BIOSCODE:07BA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">getret
</span><span style="color:black">BIOSCODE:07BC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:07BC
BIOSCODE:07BC </span><span style="color:gray">got_unknown_medium</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:07BC                 </span><span style="color:navy">mov     ds:</span>set_id_flag<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:07C1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7
</span><span style="color:black">BIOSCODE:07C3                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:07C4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">getret
</span><span style="color:black">BIOSCODE:07C4 </span>GetBp           <span style="color:black">endp
BIOSCODE:07C4
BIOSCODE:07C6
BIOSCODE:07C6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:07C6
BIOSCODE:07C6
BIOSCODE:07C6 </span>readbootsec     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:07C6                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">0           </span>; head 0
<span style="color:black">BIOSCODE:07C8                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1           </span>; cylinder 0, sector 1
<span style="color:black">BIOSCODE:07CB                 </span><span style="color:navy">call    </span>read_sector
<span style="color:black">BIOSCODE:07CE                 </span><span style="color:navy">jb      short </span><span style="color:gray">err_ret
</span><span style="color:black">BIOSCODE:07D0                 </span><span style="color:navy">xor     bx, bx          </span>; bx = 0
<span style="color:black">BIOSCODE:07D2                 </span><span style="color:navy">mov     al, ds:</span>disksector
<span style="color:black">BIOSCODE:07D5                 </span><span style="color:navy">cmp     al, </span><span style="color:green">69h         </span>; is it a direct jump?
<span style="color:black">BIOSCODE:07D7                 </span><span style="color:navy">jz      short </span><span style="color:gray">check_bpb_mediabyte </span>; don&#039;t need to find a nop
<span style="color:black">BIOSCODE:07D9                 </span><span style="color:navy">cmp     al, </span><span style="color:green">0E9h        </span>; dos 2.0 jump?
<span style="color:black">BIOSCODE:07DB                 </span><span style="color:navy">jz      short </span><span style="color:gray">check_bpb_mediabyte </span>; no need for nop
<span style="color:black">BIOSCODE:07DD                 </span><span style="color:navy">cmp     al, </span><span style="color:green">0EBh        </span>; how about a short jump?
<span style="color:black">BIOSCODE:07DF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalidbootsec
</span><span style="color:black">BIOSCODE:07E1                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:green">90h </span>; is next one a nop?
<span style="color:black">BIOSCODE:07E6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalidbootsec
</span><span style="color:black">BIOSCODE:07E8
BIOSCODE:07E8 </span><span style="color:gray">check_bpb_mediabyte</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:07E8                 </span><span style="color:navy">mov     al, ds:</span>disksector<span style="color:navy">+</span><span style="color:green">15h </span>;
<span style="color:black">BIOSCODE:07E8                                         </span>; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
<span style="color:black">BIOSCODE:07EB                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:07EC                 </span><span style="color:navy">and     al, </span><span style="color:green">0F0h
</span><span style="color:black">BIOSCODE:07EE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0F0h        </span>; allow for strange media
<span style="color:black">BIOSCODE:07F0                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:07F1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invalidbootsec
</span><span style="color:black">BIOSCODE:07F3                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0F0h
</span><span style="color:black">BIOSCODE:07F5                 </span><span style="color:navy">jz      short </span>gooddsk
<span style="color:black">BIOSCODE:07F7                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:07F9                 </span><span style="color:navy">jnz     short </span>gooddsk
<span style="color:black">BIOSCODE:07FB                 </span><span style="color:navy">cmp     word ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">2E33h </span>; &#039;3.&#039;
<span style="color:black">BIOSCODE:0801                 </span><span style="color:navy">jnz     short </span>mustbeearlier
<span style="color:black">BIOSCODE:0803                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">0Ah</span><span style="color:navy">, </span><span style="color:#ff8000">32h </span><span style="color:gray">; &#039;2&#039; </span>; 2
<span style="color:black">BIOSCODE:0808                 </span><span style="color:navy">jnb     short </span>gooddsk
<span style="color:black">BIOSCODE:080A
BIOSCODE:080A </span>mustbeearlier<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:080A                 </span><span style="color:navy">mov     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">0Dh</span><span style="color:navy">, </span><span style="color:#ff8000">1 </span>; we must have a pre-3.20 diskette.
<span style="color:black">BIOSCODE:080A                                         </span>; set the sec/clus field to 1
<span style="color:black">BIOSCODE:080A                                         </span>; [disksector+EXT_BOOT.BPB+EBPB.SECTORSPERCLUSTER]
<span style="color:black">BIOSCODE:080F                 </span><span style="color:navy">jmp     short </span>gooddsk
<span style="color:black">BIOSCODE:0811 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0811
BIOSCODE:0811 </span><span style="color:gray">invalidbootsec</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0811                 </span><span style="color:navy">inc     bx              </span>; indicate that boot sector invalid (bx = 1)
<span style="color:black">BIOSCODE:0812
BIOSCODE:0812 </span>gooddsk<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0812                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:0813
BIOSCODE:0813 </span><span style="color:gray">err_ret</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0813                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0813 </span>readbootsec     <span style="color:black">endp
BIOSCODE:0813
BIOSCODE:0814
BIOSCODE:0814 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0814
BIOSCODE:0814
BIOSCODE:0814 </span>movbpb          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0814                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:0815                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">6           </span>; BDS+6 = BDS.BPB
<span style="color:black">BIOSCODE:0818                 </span><span style="color:navy">lea     si, </span>disksector<span style="color:navy">+</span><span style="color:green">0Bh
</span><span style="color:black">BIOSCODE:081C                 </span><span style="color:navy">mov     cx, </span><span style="color:green">53          </span>; copy bios parameters block
<span style="color:black">BIOSCODE:081C                                         </span>; from BPB_BytsPerSec to (FAT32) BS_DrvNum (excluded)
<span style="color:black">BIOSCODE:081F                 </span><span style="color:navy">cld
</span><span style="color:black">BIOSCODE:0820                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSCODE:0822                 </span><span style="color:navy">mov     cx, [si-</span><span style="color:green">45</span><span style="color:navy">]     </span>; si = disksector+64 -&gt; 64-45 = 19
<span style="color:black">BIOSCODE:0822                                         </span>; disksektor+19 = BPB_TotSec16
<span style="color:black">BIOSCODE:0825                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">BIOSCODE:0827                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">movbpb_bigdisk
</span><span style="color:black">BIOSCODE:0829                 </span><span style="color:navy">mov     es:[di-</span><span style="color:green">32</span><span style="color:navy">], cx  </span>; write 16 bit total sectors
<span style="color:black">BIOSCODE:0829                                         </span>; to 32 bit total sectors field
<span style="color:black">BIOSCODE:082D                 </span><span style="color:navy">mov     es:[di-</span><span style="color:green">30</span><span style="color:navy">], ax  </span>; BPB_TotalSec32+2 (BDS offset 29, BPB offset 23)
<span style="color:black">BIOSCODE:0831
BIOSCODE:0831 </span><span style="color:gray">movbpb_bigdisk</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0831                 </span><span style="color:navy">cmp     [si-</span><span style="color:green">42</span><span style="color:navy">], ax     </span>; BPB_FATSz16 = disksector+22
<span style="color:black">BIOSCODE:0834                 </span><span style="color:navy">jz      short </span><span style="color:gray">movbpb_fat32
</span><span style="color:black">BIOSCODE:0836
BIOSCODE:0836 </span>movbpb_fat<span style="color:navy">:                             </span>;
<span style="color:black">BIOSCODE:0836                 </span><span style="color:navy">sub     di, </span><span style="color:green">28          </span>; di = BDS offset 31 (BPB offset 25)
<span style="color:black">BIOSCODE:0839                 </span><span style="color:navy">mov     cx, </span><span style="color:green">12          </span>; clear 12 byte extended BDS (FAT32) fields
<span style="color:black">BIOSCODE:0839                                         </span>; (which are used only for FAT32 disks)
<span style="color:black">BIOSCODE:083C                 </span><span style="color:navy">rep stosb
</span><span style="color:black">BIOSCODE:083E                 </span><span style="color:navy">dec     ax              </span>; -1 ; 0FFFFh
<span style="color:black">BIOSCODE:083F                 </span><span style="color:navy">stosw                   </span>; set BDS offset 43 (dword) to -1
<span style="color:black">BIOSCODE:083F                                         </span>; dword [BDS.BPB_FSInfo] = 0FFFFFFFFh
<span style="color:black">BIOSCODE:0840                 </span><span style="color:navy">stosw
</span><span style="color:black">BIOSCODE:0841                 </span><span style="color:navy">inc     ax              </span>; ax = 0
<span style="color:black">BIOSCODE:0842                 </span><span style="color:navy">mov     cx, </span><span style="color:green">12          </span>; clear BDS offset 47 to 59
<span style="color:black">BIOSCODE:0842                                         </span>; (BPB offset 41 to 53) (disksector offset 52 to 64)
<span style="color:black">BIOSCODE:0845                 </span><span style="color:navy">rep stosb
</span><span style="color:black">BIOSCODE:0847
BIOSCODE:0847 </span><span style="color:gray">movbpb_fat32</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0847                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:0848                 </span><span style="color:navy">cmp     ds:</span>set_id_flag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; called by get_bpb?
<span style="color:black">BIOSCODE:084D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">movbpb_ret
</span><span style="color:black">BIOSCODE:084F                 </span><span style="color:navy">call    </span>mov_media_ids
<span style="color:black">BIOSCODE:0852                 </span><span style="color:navy">jb      short </span><span style="color:gray">movbpb_conv </span>; conventional boot record?
<span style="color:black">BIOSCODE:0854                 </span><span style="color:navy">mov     ds:</span>set_id_flag<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; signals that volume id is set
<span style="color:black">BIOSCODE:0859
BIOSCODE:0859 </span><span style="color:gray">movbpb_conv</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0859                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:085E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">movbpb_ret
</span><span style="color:black">BIOSCODE:0860                 </span><span style="color:navy">call    </span>resetchanged    ; reset flags in bds to not fchanged
<span style="color:black">BIOSCODE:0863
BIOSCODE:0863 </span><span style="color:gray">movbpb_ret</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0863                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:0864                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0864 </span>movbpb          <span style="color:black">endp
BIOSCODE:0864
BIOSCODE:0865
BIOSCODE:0865 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0865
BIOSCODE:0865
BIOSCODE:0865 </span>mov_media_ids   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0865                 </span><span style="color:navy">cmp     word ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">16h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB.FATSz16
<span style="color:black">BIOSCODE:086A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">mmi_chk_fat
</span><span style="color:black">BIOSCODE:086C                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">42h</span><span style="color:navy">, </span><span style="color:green">29h </span>; [disksector+FAT32_EXT_BOOT.SIG],
<span style="color:black">BIOSCODE:086C                                         </span>;                     EXT_BOOT_SIGNATURE
<span style="color:black">BIOSCODE:0871                 </span><span style="color:navy">jmp     short </span><span style="color:gray">mmi_chk_fat32
</span><span style="color:black">BIOSCODE:0873 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0873
BIOSCODE:0873 </span><span style="color:gray">mmi_chk_fat</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0873                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">26h</span><span style="color:navy">, </span><span style="color:green">29h </span>; [disksector+EXT_BOOT.SIG],EXT_BOOT_SIGNATURE
<span style="color:black">BIOSCODE:0878
BIOSCODE:0878 </span><span style="color:gray">mmi_chk_fat32</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0878                 </span><span style="color:navy">jnz     short </span><span style="color:gray">mmi_not_ext
</span><span style="color:black">BIOSCODE:087A                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:087B                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:087C                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:087D                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSCODE:087E                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:087F                 </span><span style="color:navy">cmp     word ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">16h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB.FATSz16
<span style="color:black">BIOSCODE:0884                 </span><span style="color:navy">jnz     short </span><span style="color:gray">mmi_fat
</span><span style="color:black">BIOSCODE:0886
BIOSCODE:0886 </span>mmi_fat32<span style="color:navy">:                              </span>; FAT32 system
<span style="color:black">BIOSCODE:0886                 </span><span style="color:navy">lds     cx, dword ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">43h </span>; BS_FAT32_VolID
<span style="color:black">BIOSCODE:088A                 </span><span style="color:navy">mov     si, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">47h</span><span style="color:navy">) </span>; BS_FAT32_VolLab
<span style="color:black">BIOSCODE:088D                 </span><span style="color:navy">mov     ax, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">52h</span><span style="color:navy">) </span>; BS_FAT32_FilSysType
<span style="color:black">BIOSCODE:0890                 </span><span style="color:navy">jmp     short </span><span style="color:gray">mmi_do
</span><span style="color:black">BIOSCODE:0892 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0892
BIOSCODE:0892 </span><span style="color:gray">mmi_fat</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0892                 </span><span style="color:navy">lds     cx, dword ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">27h </span>; BS_VolID
<span style="color:black">BIOSCODE:0896                 </span><span style="color:navy">mov     si, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">2Bh</span><span style="color:navy">) </span>; BS_VolLab
<span style="color:black">BIOSCODE:0899                 </span><span style="color:navy">mov     ax, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">36h</span><span style="color:navy">) </span>; BS_FilSysType
<span style="color:black">BIOSCODE:089C
BIOSCODE:089C </span><span style="color:gray">mmi_do</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:089C                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">89h</span><span style="color:navy">], cx </span>; [es:di+BDS.vol_serial]
<span style="color:black">BIOSCODE:089C                                         </span>; (BDS offset 137)
<span style="color:black">BIOSCODE:08A1                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">8Bh</span><span style="color:navy">], ds </span>; [es:di+BDS.vol_serial+2]
<span style="color:black">BIOSCODE:08A6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:08A7                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">BIOSCODE:08AA                 </span><span style="color:navy">add     di, </span><span style="color:green">125         </span>; di = di+125 = BDS.volid
<span style="color:black">BIOSCODE:08AD                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSCODE:08AF                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">8           </span>; di = di+136
<span style="color:black">BIOSCODE:08B1                 </span><span style="color:navy">mov     si, ax          </span>; BS_FilSysType or BS_FAT32_FilSysType
<span style="color:black">BIOSCODE:08B3                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">5           </span>; di = di+141 = BDS.filesys_id
<span style="color:black">BIOSCODE:08B6                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSCODE:08B8                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSCODE:08B9                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:08BA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:08BB                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:08BC                 </span><span style="color:navy">clc                     </span>; this clc is not required (16/06/2019 - Erdogan Tan)
<span style="color:black">BIOSCODE:08BC                                         </span>; (20/09/2022 - 27/06/2023) MSDOS 6.21 .. PCDOS 7.1
<span style="color:black">BIOSCODE:08BD                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:08BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:08BE
BIOSCODE:08BE </span><span style="color:gray">mmi_not_ext</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:08BE                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:08BF                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:08BF </span>mov_media_ids   <span style="color:black">endp
BIOSCODE:08BF
BIOSCODE:08C0
BIOSCODE:08C0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:08C0
BIOSCODE:08C0
BIOSCODE:08C0 </span>readfat         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:08C0                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">0           </span>; head 0
<span style="color:black">BIOSCODE:08C2                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">2           </span>; cylinder 0, sector 2
<span style="color:black">BIOSCODE:08C5                 </span><span style="color:navy">call    </span>read_sector
<span style="color:black">BIOSCODE:08C8                 </span><span style="color:navy">jb      short </span><span style="color:gray">bad_fat_ret
</span><span style="color:black">BIOSCODE:08CA                 </span><span style="color:navy">mov     ah, [bx]        </span>; media byte
<span style="color:black">BIOSCODE:08CC
BIOSCODE:08CC </span><span style="color:gray">bad_fat_ret</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:08CC                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:08CC </span>readfat         <span style="color:black">endp
BIOSCODE:08CC
BIOSCODE:08CD
BIOSCODE:08CD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:08CD
BIOSCODE:08CD
BIOSCODE:08CD </span>read_sector     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:08CD                 </span><span style="color:navy">push    bp
</span><span style="color:black">BIOSCODE:08CE                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">3           </span>; make 3 attempts
<span style="color:black">BIOSCODE:08D1                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:08D5                 </span><span style="color:navy">mov     bx, offset </span>disksector ; BIOSDATA:0152h
<span style="color:black">BIOSCODE:08D8
BIOSCODE:08D8 </span><span style="color:gray">rd_ret</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:08D8                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:08D9                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:08DA                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:08DB                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h
</span><span style="color:black">BIOSCODE:08DE                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - READ SECTORS INTO MEMORY
<span style="color:black">BIOSCODE:08DE                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:black">BIOSCODE:08DE                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:black">BIOSCODE:08DE                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:black">BIOSCODE:08E0                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:08E1                 </span><span style="color:navy">jnb     short </span><span style="color:gray">okret2
</span><span style="color:black">BIOSCODE:08E3
BIOSCODE:08E3 </span><span style="color:gray">rd_rty</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:08E3                 </span><span style="color:navy">call    </span>again           ; reset disk, decrement bp
<span style="color:black">BIOSCODE:08E6                 </span><span style="color:navy">jz      short </span><span style="color:gray">err_rd_ret
</span><span style="color:black">BIOSCODE:08E8                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:08E8                                         </span>; (BDS offset 63)
<span style="color:black">BIOSCODE:08ED                 </span><span style="color:navy">jnz     short </span><span style="color:gray">rd_ret
</span><span style="color:black">BIOSCODE:08EF                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:08F4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">rd_skip1_dpt
</span><span style="color:black">BIOSCODE:08F6                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:08F7                 </span><span style="color:navy">push    ds              </span>; for retry, set the head settle time to 0Fh
<span style="color:black">BIOSCODE:08F8                 </span><span style="color:navy">lds     si, ds:</span>dpt
<span style="color:black">BIOSCODE:08FC                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">9</span><span style="color:navy">]      </span>; [si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:08FF                 </span><span style="color:navy">mov     byte ptr [si+</span><span style="color:#ff8000">9</span><span style="color:navy">], </span><span style="color:green">15 </span>; NORMSETTLE
<span style="color:black">BIOSCODE:0903                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0904                 </span><span style="color:navy">mov     ds:</span>save_head_sttl<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:0907                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0908
BIOSCODE:0908 </span><span style="color:gray">rd_skip1_dpt</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0908                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:0909                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:090A                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:090B                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h
</span><span style="color:black">BIOSCODE:090E                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - READ SECTORS INTO MEMORY
<span style="color:black">BIOSCODE:090E                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:black">BIOSCODE:090E                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:black">BIOSCODE:090E                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:black">BIOSCODE:0910                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:0911                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSCODE:0912                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:0917                 </span><span style="color:navy">jnz     short </span><span style="color:gray">rd_skip2_dpt
</span><span style="color:black">BIOSCODE:0919                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:091A                 </span><span style="color:navy">mov     al, ds:</span>save_head_sttl
<span style="color:black">BIOSCODE:091D                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:091E                 </span><span style="color:navy">lds     si, ds:</span>dpt
<span style="color:black">BIOSCODE:0922                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">9</span><span style="color:navy">], al      </span>; [si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:0925                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0926                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0927
BIOSCODE:0927 </span><span style="color:gray">rd_skip2_dpt</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0927                 </span><span style="color:navy">popf
</span><span style="color:black">BIOSCODE:0928                 </span><span style="color:navy">jnb     short </span><span style="color:gray">okret2
</span><span style="color:black">BIOSCODE:092A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">rd_rty
</span><span style="color:black">BIOSCODE:092C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:092C
BIOSCODE:092C </span><span style="color:gray">err_rd_ret</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:092C                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0FFh        </span>; make sure we ask rom if media has changed
<span style="color:black">BIOSCODE:092E                 </span><span style="color:navy">stc                     </span>; return error
<span style="color:black">BIOSCODE:092F
BIOSCODE:092F </span><span style="color:gray">okret2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:092F                 </span><span style="color:navy">mov     ds:</span>step_drv<span style="color:navy">, dl
</span><span style="color:black">BIOSCODE:0933                 </span><span style="color:navy">mov     ds:</span>tim_drv<span style="color:navy">, dl
</span><span style="color:black">BIOSCODE:0937                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">78h</span><span style="color:navy">], ch </span>; [es:di+BDS.track]
<span style="color:black">BIOSCODE:0937                                         </span>; (BDS offset 120)
<span style="color:black">BIOSCODE:0937                                         </span>; save last track accessed on this drive
<span style="color:black">BIOSCODE:093B                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSCODE:093C                 </span><span style="color:navy">call    </span>set_tim
<span style="color:black">BIOSCODE:093F                 </span><span style="color:navy">popf                    </span>; restore flags
<span style="color:black">BIOSCODE:0940                 </span><span style="color:navy">pop     bp
</span><span style="color:black">BIOSCODE:0941                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0941 </span>read_sector     <span style="color:black">endp
BIOSCODE:0941
BIOSCODE:0942
BIOSCODE:0942 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0942
BIOSCODE:0942
BIOSCODE:0942 </span>dsk_open        <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:0942                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:0947                 </span><span style="color:navy">jz      short </span>dsk_open_exit ; done if no changeline support
<span style="color:black">BIOSCODE:0949                 </span><span style="color:navy">call    </span>SetDrive        ; get bds for drive
<span style="color:black">BIOSCODE:094C                 </span><span style="color:navy">inc     word ptr es:[di+</span><span style="color:#ff8000">3Ch</span><span style="color:navy">] </span>; [es:di+BDS.opcnt]
<span style="color:black">BIOSCODE:094C                                         </span>; (BDS offset 60)
<span style="color:black">BIOSCODE:0950
BIOSCODE:0950 </span>dsk_open_exit<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0950                 </span><span style="color:navy">clc                     </span>; CF is already ZERO here - Erdogan Tan
<span style="color:black">BIOSCODE:0951                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0951 </span>dsk_open        <span style="color:black">endp
BIOSCODE:0951
BIOSCODE:0952
BIOSCODE:0952 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0952
BIOSCODE:0952
BIOSCODE:0952 </span>dsk_close       <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:0952                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:0957                 </span><span style="color:navy">jz      short </span>exitjx    ; done if no changeline support
<span style="color:black">BIOSCODE:0959                 </span><span style="color:navy">call    </span>SetDrive        ; get bds for drive
<span style="color:black">BIOSCODE:095C                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">3Ch</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+BDS.opcnt]
<span style="color:black">BIOSCODE:0961                 </span><span style="color:navy">jz      short </span>exitjx    ; watch out for wrap
<span style="color:black">BIOSCODE:0963                 </span><span style="color:navy">dec     word ptr es:[di+</span><span style="color:#ff8000">3Ch</span><span style="color:navy">]
</span><span style="color:black">BIOSCODE:0967
BIOSCODE:0967 </span>exitjx<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0967                 </span><span style="color:navy">clc                     </span>; CF is already ZERO here - Erdogan Tan
<span style="color:black">BIOSCODE:0968                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0968 </span>dsk_close       <span style="color:black">endp
BIOSCODE:0968
BIOSCODE:0969
BIOSCODE:0969 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0969
BIOSCODE:0969
BIOSCODE:0969 </span>dsk_rem         <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:0969                 </span><span style="color:navy">call    </span>SetDrive
<span style="color:black">BIOSCODE:096C                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0971                 </span><span style="color:navy">jz      short </span>exitjx
<span style="color:black">BIOSCODE:0973
BIOSCODE:0973 </span>x_bus_exit<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:0973                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3           </span>; non_rem
<span style="color:black">BIOSCODE:0973                                         </span>; return busy status
<span style="color:black">BIOSCODE:0975                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:0976
BIOSCODE:0976 </span>dsk_ret<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0976                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0976 </span>dsk_rem         <span style="color:black">endp
BIOSCODE:0976
</span><span style="color:maroon">BIOSCODE:0977 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0977
BIOSCODE:0977 </span>dsk_writv<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0977                 </span><span style="color:navy">mov     word ptr ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">103h </span>; write and verify
<span style="color:maroon">BIOSCODE:097D                 </span><span style="color:navy">jmp     short </span>dsk_cl
<span style="color:maroon">BIOSCODE:097F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:097F
BIOSCODE:097F </span>dsk_writ<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:097F                 </span><span style="color:navy">mov     word ptr ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">3 </span>; romwrite
<span style="color:maroon">BIOSCODE:0985
BIOSCODE:0985 </span>dsk_cl<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0985                 </span><span style="color:navy">call    </span>diskio          ; prepare for rombios read/write
<span style="color:maroon">BIOSCODE:0988
BIOSCODE:0988 </span>dsk_io<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0988                 </span><span style="color:navy">jnb     short </span>dsk_ret
<span style="color:maroon">BIOSCODE:098A                 </span><span style="color:navy">jmp     </span>bc_err_cnt
<span style="color:maroon">BIOSCODE:098D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:098D
BIOSCODE:098D </span>dsk_read<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:098D                 </span><span style="color:navy">call    </span>DISKRD
<span style="color:maroon">BIOSCODE:0990                 </span><span style="color:navy">jmp     short </span>dsk_io
<span style="color:black">BIOSCODE:0992
BIOSCODE:0992 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0992
BIOSCODE:0992
BIOSCODE:0992 </span>checksingle     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0992                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0993                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:0994                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">] </span>; [es:di+BDS.flags]
<span style="color:black">BIOSCODE:0998                 </span><span style="color:navy">test    bl, </span><span style="color:green">21h         </span>; fnon_removable|fi_own_physical
<span style="color:black">BIOSCODE:099B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">singleret
</span><span style="color:black">BIOSCODE:099D                 </span><span style="color:navy">test    bl, </span><span style="color:green">10h         </span>; fi_am_mult
<span style="color:black">BIOSCODE:099D                                         </span>; is there a drive sharing this physical drive?
<span style="color:black">BIOSCODE:09A0                 </span><span style="color:navy">jz      short </span><span style="color:gray">singleret
</span><span style="color:black">BIOSCODE:09A2                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:09A2                                         </span>; get physical drive number
<span style="color:black">BIOSCODE:09A6                 </span><span style="color:navy">push    es              </span>; preserve pointer to current bds
<span style="color:black">BIOSCODE:09A7                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:09A8                 </span><span style="color:navy">les     di, dword ptr ds:</span>start_bds ; get first bds
<span style="color:black">BIOSCODE:09AC
BIOSCODE:09AC </span><span style="color:gray">scan_list</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:09AC                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al
</span><span style="color:black">BIOSCODE:09B0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_skip </span>; Not our drive. Try next bds.
<span style="color:black">BIOSCODE:09B2                 </span><span style="color:navy">mov     bl, </span><span style="color:green">20h         </span>; fi_own_physical ; test ownership flag
<span style="color:black">BIOSCODE:09B4                 </span><span style="color:navy">test    es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], bl
</span><span style="color:black">BIOSCODE:09B8                 </span><span style="color:navy">jz      short </span><span style="color:gray">scan_skip </span>; he doesn&#039;t own it either. continue
<span style="color:black">BIOSCODE:09BA                 </span><span style="color:navy">xor     es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], bl </span>; reset ownership flag
<span style="color:black">BIOSCODE:09BE                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:09BF                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:09C0                 </span><span style="color:navy">or      es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], bl
</span><span style="color:black">BIOSCODE:09C4                 </span><span style="color:navy">cmp     ds:</span>fsetowner<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:09C9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_fsetowner
</span><span style="color:black">BIOSCODE:09CB                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; are we handling drive number 0 ?
<span style="color:black">BIOSCODE:09D0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">singleret
</span><span style="color:black">BIOSCODE:09D2                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:di+BDS.drivelet]
<span style="color:black">BIOSCODE:09D2                                         </span>; get the DOS drive letter
<span style="color:black">BIOSCODE:09D6                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:09D7                 </span><span style="color:navy">mov     es, ds:</span>zeroseg
<span style="color:black">BIOSCODE:09DB                 </span>assume es:nothing
<span style="color:black">BIOSCODE:09DB                 </span><span style="color:navy">mov     </span>byte ptr es:504h<span style="color:navy">, al </span>; [es:LSTDRV]
<span style="color:black">BIOSCODE:09DB                                         </span>; set up sdsb
<span style="color:black">BIOSCODE:09DF                 </span><span style="color:navy">pop     es              </span>; restore bds pointer
<span style="color:black">BIOSCODE:09E0                 </span>assume es:nothing
<span style="color:black">BIOSCODE:09E0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">singleret
</span><span style="color:black">BIOSCODE:09E2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:09E2
BIOSCODE:09E2 </span><span style="color:gray">not_fsetowner</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:09E2                 </span><span style="color:navy">cmp     ds:</span>single<span style="color:navy">, </span><span style="color:#ff8000">2    </span>; if (single_drive_system)
<span style="color:black">BIOSCODE:09E7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ignore_sdsb
</span><span style="color:black">BIOSCODE:09E9                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:09EA                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; if (curr_drv == req_drv)
<span style="color:black">BIOSCODE:09EE                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">BIOSCODE:09F0                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:09F1                 </span><span style="color:navy">mov     es, ds:</span>zeroseg
<span style="color:black">BIOSCODE:09F5                 </span>assume es:nothing
<span style="color:black">BIOSCODE:09F5                 </span><span style="color:navy">xchg    al, </span>byte ptr es:504h ; [es:LSTDRV]
<span style="color:black">BIOSCODE:09F5                                         </span>; then swap(curr_drv,req_drv)
<span style="color:black">BIOSCODE:09FA                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:09FB                 </span>assume es:nothing
<span style="color:black">BIOSCODE:09FB                 </span><span style="color:navy">cmp     ah, al          </span>; else
<span style="color:black">BIOSCODE:09FD                 </span><span style="color:navy">pop     ax              </span>; swap(curr_drv,req_drv)
<span style="color:black">BIOSCODE:09FE                 </span><span style="color:navy">jz      short </span><span style="color:gray">singleret </span>; issue swap_dsk_msg
<span style="color:black">BIOSCODE:0A00
BIOSCODE:0A00 </span><span style="color:gray">ignore_sdsb</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A00                 </span><span style="color:navy">call    </span>swpdsk
<span style="color:black">BIOSCODE:0A03                 </span><span style="color:navy">jmp     short </span><span style="color:gray">singleret
</span><span style="color:black">BIOSCODE:0A05 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0A05
BIOSCODE:0A05 </span><span style="color:gray">scan_skip</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A05                 </span><span style="color:navy">les     di, es:[di]
</span><span style="color:black">BIOSCODE:0A08                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; -1  ; end of list?
<span style="color:black">BIOSCODE:0A0B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_list </span>; continue until hit end of list
<span style="color:black">BIOSCODE:0A0D                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:0A0E                 </span><span style="color:navy">pop     di              </span>; restore current bds
<span style="color:black">BIOSCODE:0A0F                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:0A10
BIOSCODE:0A10 </span><span style="color:gray">singleret</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A10                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:0A11                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0A12                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0A12 </span>checksingle     <span style="color:black">endp
BIOSCODE:0A12
BIOSCODE:0A13 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0A13 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR diskio
</span><span style="color:black">BIOSCODE:0A13
BIOSCODE:0A13 </span><span style="color:gray">baddrive</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A13                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8           </span>; sector not found
<span style="color:black">BIOSCODE:0A15                 </span><span style="color:navy">jmp     short </span><span style="color:gray">baddrive_ret
</span><span style="color:black">BIOSCODE:0A17 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0A17
BIOSCODE:0A17 </span><span style="color:gray">unformatteddrive</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A17                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7           </span>; unknown media
<span style="color:black">BIOSCODE:0A19
BIOSCODE:0A19 </span><span style="color:gray">baddrive_ret</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A19                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:0A19 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR diskio
</span><span style="color:maroon">BIOSCODE:0A1A
BIOSCODE:0A1A </span>ioret<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0A1A                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:0A1A </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:0A1B </span>LBA_Packet      <span style="color:navy">db </span><span style="color:#008040">16                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0A1B                                         </span>; DAP buffer
<span style="color:gray">BIOSCODE:0A1C                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">BIOSCODE:0A1D </span>dap_block_cnt   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0A1F </span>dap_trans_buf   <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0A23 </span>dap_lba_value   <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0A27                 </span><span style="color:navy">db </span><span style="color:#008040">4 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:black">BIOSCODE:0A2B
BIOSCODE:0A2B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0A2B
BIOSCODE:0A2B
BIOSCODE:0A2B </span>DISKRD          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A2B                 </span><span style="color:navy">mov     ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">2     </span>; romread
<span style="color:black">BIOSCODE:0A2B </span>DISKRD          <span style="color:black">endp
BIOSCODE:0A2B
BIOSCODE:0A30
BIOSCODE:0A30 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0A30
BIOSCODE:0A30
BIOSCODE:0A30 </span>diskio          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A30
BIOSCODE:0A30 </span><span style="color:gray">; FUNCTION CHUNK AT BIOSCODE:0A13 SIZE 00000007 BYTES
</span><span style="color:black">BIOSCODE:0A30
BIOSCODE:0A30                 </span><span style="color:navy">mov     bx, di          </span>; al = drive number
<span style="color:black">BIOSCODE:0A30                                         </span>; cx = sector count
<span style="color:black">BIOSCODE:0A30                                         </span>; dx = first sector (low)
<span style="color:black">BIOSCODE:0A30                                         </span>; [start_sec_h] = first sector (high)
<span style="color:black">BIOSCODE:0A30                                         </span>;
<span style="color:black">BIOSCODE:0A30                                         </span>; es:bx = transfer address
<span style="color:black">BIOSCODE:0A32                 </span><span style="color:navy">mov     ds:</span>xfer_seg<span style="color:navy">, es </span>; save transfer segment
<span style="color:black">BIOSCODE:0A36                 </span><span style="color:navy">call    </span>SetDrive
<span style="color:black">BIOSCODE:0A39                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; [es:di+BDS.media]
<span style="color:black">BIOSCODE:0A3D                 </span><span style="color:navy">mov     ds:</span>medbyt<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:0A40                 </span><span style="color:navy">jcxz    short </span>ioret
<span style="color:black">BIOSCODE:0A42                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">2 </span>; [es:di+BDS.flags+1]
<span style="color:black">BIOSCODE:0A42                                         </span>;  unformatted_media
<span style="color:black">BIOSCODE:0A47                 </span><span style="color:navy">jnz     short </span><span style="color:gray">unformatteddrive
</span><span style="color:black">BIOSCODE:0A49                 </span><span style="color:navy">mov     ds:</span>seccnt<span style="color:navy">, cx   </span>; save sector count
<span style="color:black">BIOSCODE:0A4D                 </span><span style="color:navy">mov     ds:</span>spsav<span style="color:navy">, sp    </span>; save sp
<span style="color:black">BIOSCODE:0A51                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">BIOSCODE:0A53                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:0A55                 </span><span style="color:navy">add     dx, cx
</span><span style="color:black">BIOSCODE:0A57                 </span><span style="color:navy">rcl     si, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:0A59                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+BDS.totalsecs16]
<span style="color:black">BIOSCODE:0A59                                         </span>; &gt; 32 bit sector ?
<span style="color:black">BIOSCODE:0A5E                 </span><span style="color:navy">jz      short </span><span style="color:gray">sanity32
</span><span style="color:black">BIOSCODE:0A60                 </span><span style="color:navy">or      si, si
</span><span style="color:black">BIOSCODE:0A62                 </span><span style="color:navy">jnz     short </span><span style="color:gray">baddrive
</span><span style="color:black">BIOSCODE:0A64                 </span><span style="color:navy">cmp     dx, es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">] </span>; [es:di+BDS.totalsecs16]
<span style="color:black">BIOSCODE:0A68                 </span><span style="color:navy">ja      short </span><span style="color:gray">baddrive
</span><span style="color:black">BIOSCODE:0A6A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sanityok
</span><span style="color:black">BIOSCODE:0A6C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0A6C
BIOSCODE:0A6C </span><span style="color:gray">sanity32</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A6C                 </span><span style="color:navy">add     si, ds:</span>start_sec_h
<span style="color:black">BIOSCODE:0A70                 </span><span style="color:navy">cmp     si, es:[di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">] </span>; [es:di+BDS.totalsecs32+2]
<span style="color:black">BIOSCODE:0A74                 </span><span style="color:navy">jb      short </span><span style="color:gray">sanityok
</span><span style="color:black">BIOSCODE:0A76                 </span><span style="color:navy">ja      short </span><span style="color:gray">baddrive
</span><span style="color:black">BIOSCODE:0A78                 </span><span style="color:navy">cmp     dx, es:[di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">] </span>; [es:di+BDS.totalsecs32]
<span style="color:black">BIOSCODE:0A7C                 </span><span style="color:navy">ja      short </span><span style="color:gray">baddrive
</span><span style="color:black">BIOSCODE:0A7E
BIOSCODE:0A7E </span><span style="color:gray">sanityok</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0A7E                 </span><span style="color:navy">mov     dx, ds:</span>start_sec_h
<span style="color:black">BIOSCODE:0A82                 </span><span style="color:navy">add     ax, es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [es:di+BDS.hiddensecs]
<span style="color:black">BIOSCODE:0A86                 </span><span style="color:navy">adc     dx, es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; [es:di+BDS.hiddensecs+2]
<span style="color:black">BIOSCODE:0A8A                 </span><span style="color:navy">mov     ds:</span>saved_word<span style="color:navy">, ax </span>; save the sector number (low)
<span style="color:black">BIOSCODE:0A8D                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:0A8E                 </span><span style="color:navy">xor     si, si          </span>; 0
<span style="color:black">BIOSCODE:0A90                 </span><span style="color:navy">mov     es, si
</span><span style="color:black">BIOSCODE:0A92                 </span>assume es:nothing
<span style="color:black">BIOSCODE:0A92                 </span><span style="color:navy">les     si, </span>dword ptr es:78h ; INT 1Eh vector address
<span style="color:black">BIOSCODE:0A92                                         </span>; [es:DSKADR] - current disk parm table
<span style="color:black">BIOSCODE:0A97                 </span>assume es:nothing
<span style="color:black">BIOSCODE:0A97                 </span><span style="color:navy">mov     word ptr ds:</span>dpt<span style="color:navy">, si
</span><span style="color:black">BIOSCODE:0A9B                 </span><span style="color:navy">mov     word ptr ds:</span>dpt<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">BIOSCODE:0A9F                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:0AA0                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0AA5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chk_13h_ext_flag
</span><span style="color:black">BIOSCODE:0AA7                 </span><span style="color:navy">call    </span>checksingle
<span style="color:black">BIOSCODE:0AAA                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; do we have changeline support?
<span style="color:black">BIOSCODE:0AAF                 </span><span style="color:navy">jz      short </span><span style="color:gray">diskio_nochangeline </span>; brif not
<span style="color:black">BIOSCODE:0AB1                 </span><span style="color:navy">call    </span>checklatchio
<span style="color:black">BIOSCODE:0AB4
BIOSCODE:0AB4 </span><span style="color:gray">diskio_nochangeline</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0AB4                 </span><span style="color:navy">call    </span>iosetup
<span style="color:black">BIOSCODE:0AB7
BIOSCODE:0AB7 </span><span style="color:gray">chk_13h_ext_flag</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0AB7                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">40h</span><span style="color:navy">], </span><span style="color:green">4 </span>; [es:di+BDS.flags+1], fLBArw
<span style="color:black">BIOSCODE:0AB7                                         </span>; LBA read/write flag
<span style="color:black">BIOSCODE:0ABC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_1
</span><span style="color:black">BIOSCODE:0ABE                 </span><span style="color:navy">jmp     </span><span style="color:gray">skip_setup
</span><span style="color:black">BIOSCODE:0AC1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0AC1
BIOSCODE:0AC1 </span><span style="color:gray">set_lbarw_1</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0AC1                 </span><span style="color:navy">mov     ax, ds:</span>saved_word ; check for mini disk (logical dos drive/partition)
<span style="color:black">BIOSCODE:0AC4                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">79h</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [di+BDS.bdsm_ismini] ; logical dos partition
<span style="color:black">BIOSCODE:0AC9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_2 </span>; not a logical dos partition/drive
<span style="color:black">BIOSCODE:0ACB                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [di+BDS.bdsm_hidden_trks] (&gt; 0)
<span style="color:black">BIOSCODE:0AD0                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_lbarw_2
</span><span style="color:black">BIOSCODE:0AD2                 </span><span style="color:navy">add     ax, es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [es:di+BDS.hiddensecs]
<span style="color:black">BIOSCODE:0AD6                 </span><span style="color:navy">adc     dx, es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; [es:di+BDS.hiddensecs+2]
<span style="color:black">BIOSCODE:0ADA
BIOSCODE:0ADA </span><span style="color:gray">set_lbarw_2</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0ADA                 </span><span style="color:navy">mov     cs:</span>dap_lba_value<span style="color:navy">, ax
</span><span style="color:black">BIOSCODE:0ADE                 </span><span style="color:navy">mov     cs:</span>dap_lba_value<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, dx
</span><span style="color:black">BIOSCODE:0AE3                 </span><span style="color:navy">mov     cs:</span>dap_trans_buf<span style="color:navy">, bx
</span><span style="color:black">BIOSCODE:0AE8                 </span><span style="color:navy">mov     ax, ds:</span>xfer_seg
<span style="color:black">BIOSCODE:0AEB                 </span><span style="color:navy">mov     cs:</span>dap_trans_buf<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">BIOSCODE:0AEF                 </span><span style="color:navy">mov     ax, ds:</span>seccnt
<span style="color:black">BIOSCODE:0AF2                 </span><span style="color:navy">mov     cs:</span>dap_block_cnt<span style="color:navy">, ax
</span><span style="color:black">BIOSCODE:0AF6                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">5
</span><span style="color:black">BIOSCODE:0AF9                 </span><span style="color:navy">mov     ds:</span>vretry_cnt<span style="color:navy">, bp </span>; verify op. retry cnt for write-verify
<span style="color:black">BIOSCODE:0AFD                 </span><span style="color:navy">mov     ds:</span>soft_ecc_cnt<span style="color:navy">, bp </span>; soft ecc error retry count
<span style="color:black">BIOSCODE:0B01
BIOSCODE:0B01 </span><span style="color:gray">set_lbarw_3</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B01                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:0B05                 </span><span style="color:navy">mov     ah, ds:</span>rflag    ; get read/write indicator
<span style="color:black">BIOSCODE:0B09                 </span><span style="color:navy">add     ah, </span><span style="color:green">40h
</span><span style="color:black">BIOSCODE:0B0C                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">BIOSCODE:0B0E                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0B0F                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSCODE:0B10                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0B11                 </span>assume ds:BIOSCODE
<span style="color:black">BIOSCODE:0B11                 </span><span style="color:navy">mov     si, offset </span>LBA_Packet
<span style="color:black">BIOSCODE:0B14                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK -
<span style="color:black">BIOSCODE:0B16                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0B17                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:0B17                 </span><span style="color:navy">jnb     short </span><span style="color:gray">set_lbarw_7
</span><span style="color:black">BIOSCODE:0B19                 </span><span style="color:navy">call    </span>again
<span style="color:black">BIOSCODE:0B1C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_4
</span><span style="color:black">BIOSCODE:0B1E                 </span><span style="color:navy">jmp     </span>harderr
<span style="color:black">BIOSCODE:0B21 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0B21
BIOSCODE:0B21 </span><span style="color:gray">set_lbarw_4</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B21                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">0CCh        </span>; Write fault (hard disk)
<span style="color:black">BIOSCODE:0B24                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_5
</span><span style="color:black">BIOSCODE:0B26                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:0B29                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set_lbarw_6
</span><span style="color:black">BIOSCODE:0B2B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0B2B
BIOSCODE:0B2B </span><span style="color:gray">set_lbarw_5</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B2B                 </span><span style="color:navy">mov     ds:</span>soft_ecc_cnt<span style="color:navy">, </span><span style="color:#ff8000">5
</span><span style="color:black">BIOSCODE:0B31
BIOSCODE:0B31 </span><span style="color:gray">set_lbarw_6</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B31                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set_lbarw_3
</span><span style="color:black">BIOSCODE:0B33 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0B33
BIOSCODE:0B33 </span><span style="color:gray">set_lbarw_7</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B33                 </span><span style="color:navy">cmp     word ptr ds:</span>rflag<span style="color:navy">, </span><span style="color:green">103h
</span><span style="color:black">BIOSCODE:0B39                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_12
</span><span style="color:black">BIOSCODE:0B3B                 </span><span style="color:navy">mov     ah, </span><span style="color:green">44h
</span><span style="color:black">BIOSCODE:0B3D                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0B3E                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSCODE:0B3F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0B40                 </span>assume ds:BIOSCODE
<span style="color:black">BIOSCODE:0B40                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension - VERIFY SECTORS
<span style="color:black">BIOSCODE:0B40                                         </span>;  (DL - drive, DS:SI - disk address packet)
<span style="color:black">BIOSCODE:0B42                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0B43                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:0B43                 </span><span style="color:navy">jnb     short </span><span style="color:gray">set_lbarw_12
</span><span style="color:black">BIOSCODE:0B45                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">11h         </span>; ECC corrected data error (soft error - retried OK )
<span style="color:black">BIOSCODE:0B48                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_8
</span><span style="color:black">BIOSCODE:0B4A                 </span><span style="color:navy">dec     ds:</span>soft_ecc_cnt
<span style="color:black">BIOSCODE:0B4E
BIOSCODE:0B4E </span><span style="color:gray">set_lbarw_8</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B4E                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_lbarw_12
</span><span style="color:black">BIOSCODE:0B50                 </span><span style="color:navy">call    </span>ResetDisk
<span style="color:black">BIOSCODE:0B53                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">11h
</span><span style="color:black">BIOSCODE:0B56                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_lbarw_11
</span><span style="color:black">BIOSCODE:0B58                 </span><span style="color:navy">dec     ds:</span>vretry_cnt
<span style="color:black">BIOSCODE:0B5C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_9
</span><span style="color:black">BIOSCODE:0B5E                 </span><span style="color:navy">jmp     </span>harderr
<span style="color:black">BIOSCODE:0B61 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0B61
BIOSCODE:0B61 </span><span style="color:gray">set_lbarw_9</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B61                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">0CCh
</span><span style="color:black">BIOSCODE:0B64                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_lbarw_10
</span><span style="color:black">BIOSCODE:0B66                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:0B69                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set_lbarw_11
</span><span style="color:black">BIOSCODE:0B6B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0B6B
BIOSCODE:0B6B </span><span style="color:gray">set_lbarw_10</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B6B                 </span><span style="color:navy">mov     ds:</span>soft_ecc_cnt<span style="color:navy">, </span><span style="color:#ff8000">5 </span>; soft ecc error retry count
<span style="color:black">BIOSCODE:0B71
BIOSCODE:0B71 </span><span style="color:gray">set_lbarw_11</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B71                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set_lbarw_3
</span><span style="color:black">BIOSCODE:0B73 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0B73
BIOSCODE:0B73 </span><span style="color:gray">set_lbarw_12</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B73                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">BIOSCODE:0B75                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0B76 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0B76
BIOSCODE:0B76 </span><span style="color:gray">skip_setup</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0B76                 </span><span style="color:navy">push    bp
</span><span style="color:black">BIOSCODE:0B77                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">BIOSCODE:0B78                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSCODE:0B7A                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:0B7A                                         </span>; divide by sec per track
<span style="color:black">BIOSCODE:0B7E                 </span><span style="color:navy">div     cx
</span><span style="color:black">BIOSCODE:0B80                 </span><span style="color:navy">xchg    ax, bp
</span><span style="color:black">BIOSCODE:0B81                 </span><span style="color:navy">mov     ax, ds:</span>saved_word
<span style="color:black">BIOSCODE:0B84                 </span><span style="color:navy">div     cx              </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:0B84                                         </span>; now, bp:ax = track #, dx = sector
<span style="color:black">BIOSCODE:0B84                                         </span>; sector number is 1 based.
<span style="color:black">BIOSCODE:0B86                 </span><span style="color:navy">inc     dx
</span><span style="color:black">BIOSCODE:0B87                 </span><span style="color:navy">mov     ds:</span>cursec<span style="color:navy">, dl   </span>; save current sector
<span style="color:black">BIOSCODE:0B8B                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+BDS.heads]
<span style="color:black">BIOSCODE:0B8B                                         </span>; get number of heads
<span style="color:black">BIOSCODE:0B8F                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0B90                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSCODE:0B92                 </span><span style="color:navy">xchg    ax, bp          </span>; divide tracks by heads per cylinder
<span style="color:black">BIOSCODE:0B93                 </span><span style="color:navy">div     cx
</span><span style="color:black">BIOSCODE:0B95                 </span><span style="color:navy">xchg    ax, bp
</span><span style="color:black">BIOSCODE:0B96                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0B97                 </span><span style="color:navy">div     cx              </span>; now, bp:ax = cylinder #, dx = head
<span style="color:black">BIOSCODE:0B99                 </span><span style="color:navy">or      bp, bp
</span><span style="color:black">BIOSCODE:0B9B                 </span><span style="color:navy">pop     bp
</span><span style="color:black">BIOSCODE:0B9C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">baddrive_brdg
</span><span style="color:black">BIOSCODE:0B9E                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">1024        </span>; 2^10 currently maxium for track #.
<span style="color:black">BIOSCODE:0BA1                 </span><span style="color:navy">jnb     short </span><span style="color:gray">baddrive_brdg
</span><span style="color:black">BIOSCODE:0BA3                 </span><span style="color:navy">mov     ds:</span>curhd<span style="color:navy">, dl    </span>; save current head
<span style="color:black">BIOSCODE:0BA7                 </span><span style="color:navy">mov     ds:</span>curtrk<span style="color:navy">, ax   </span>; save current track
<span style="color:black">BIOSCODE:0BAA                 </span><span style="color:navy">mov     ax, ds:</span>seccnt
<span style="color:black">BIOSCODE:0BAD                 </span><span style="color:navy">call    </span>block
<span style="color:black">BIOSCODE:0BB0                 </span><span style="color:navy">call    </span>done
<span style="color:black">BIOSCODE:0BB3                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0BB4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0BB4
BIOSCODE:0BB4 </span><span style="color:gray">baddrive_brdg</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0BB4                 </span><span style="color:navy">jmp     </span><span style="color:gray">baddrive
</span><span style="color:black">BIOSCODE:0BB4 </span>diskio          <span style="color:black">endp
BIOSCODE:0BB4
BIOSCODE:0BB7
BIOSCODE:0BB7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0BB7
BIOSCODE:0BB7
BIOSCODE:0BB7 </span>iosetup         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0BB7                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:0BBB                 </span><span style="color:navy">mov     ds:</span>tim_drv<span style="color:navy">, al  </span>; save drive letter
<span style="color:black">BIOSCODE:0BBE                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:0BC3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">skip_dpt_setting
</span><span style="color:black">BIOSCODE:0BC5                 </span><span style="color:navy">mov     al, ds:</span>eot      ; fetch up eot before changing ds
<span style="color:black">BIOSCODE:0BC8                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0BC9                 </span><span style="color:navy">lds     si, ds:</span>dpt      ; get pointer to disk base table
<span style="color:black">BIOSCODE:0BCD                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], al
</span><span style="color:black">BIOSCODE:0BD0                 </span><span style="color:navy">mov     al, [si+</span><span style="color:green">10</span><span style="color:navy">]     </span>; [si+DISK_PARMS.DISK_MOTOR_STRT]
<span style="color:black">BIOSCODE:0BD3                 </span><span style="color:navy">mov     ah, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [si+DISK_PARMS.DISK_EOT]
<span style="color:black">BIOSCODE:0BD6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0BD7                 </span><span style="color:navy">mov     ds:</span>motorstartup<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:0BDA                 </span><span style="color:navy">mov     ds:</span>save_eot<span style="color:navy">, ah
</span><span style="color:black">BIOSCODE:0BDE                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0BDF                 </span><span style="color:navy">lds     si, ds:</span>dpt      ; get pointer to disk base table
<span style="color:black">BIOSCODE:0BE3                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:green">62</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:di+BDS.formfactor], ffSmall
<span style="color:black">BIOSCODE:0BE8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">motor_start_ok
</span><span style="color:black">BIOSCODE:0BEA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4
</span><span style="color:black">BIOSCODE:0BEC                 </span><span style="color:navy">xchg    al, [si+</span><span style="color:green">10</span><span style="color:navy">]     </span>; [si+DISK_PARMS.DISK_MOTOR_STRT]
<span style="color:black">BIOSCODE:0BEF
BIOSCODE:0BEF </span><span style="color:gray">motor_start_ok</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0BEF                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">BIOSCODE:0BF1                 </span><span style="color:navy">inc     al              </span>; ibm wants fast settle to be 1
<span style="color:black">BIOSCODE:0BF3                 </span><span style="color:navy">xchg    al, [si+</span><span style="color:#ff8000">9</span><span style="color:navy">]      </span>; [si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:0BF3                                         </span>; get settle and set up for fast
<span style="color:black">BIOSCODE:0BF6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0BF7                 </span><span style="color:navy">mov     ds:</span>settlecurrent<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:0BFA                 </span><span style="color:navy">mov     al, </span><span style="color:green">15          </span>; NORMSETTLE
<span style="color:black">BIOSCODE:0BFA                                         </span>; someone has diddled the settle
<span style="color:black">BIOSCODE:0BFC                 </span><span style="color:navy">mov     ds:</span>settleslow<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:0BFF
BIOSCODE:0BFF </span><span style="color:gray">skip_dpt_setting</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0BFF                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0BFF </span>iosetup         <span style="color:black">endp
BIOSCODE:0BFF
BIOSCODE:0C00
BIOSCODE:0C00 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0C00
BIOSCODE:0C00
BIOSCODE:0C00 </span>done            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C00                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0C05                 </span><span style="color:navy">jnz     short </span>ddbx      ; do not set for non-removable media
<span style="color:black">BIOSCODE:0C07                 </span><span style="color:navy">call    </span>set_tim
<span style="color:black">BIOSCODE:0C0A
BIOSCODE:0C0A </span>diddle_back<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C0A                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSCODE:0C0B                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:0C10                 </span><span style="color:navy">jnz     short </span><span style="color:gray">nodiddleback
</span><span style="color:black">BIOSCODE:0C12                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0C13                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:0C14                 </span><span style="color:navy">les     si, ds:</span>dpt
<span style="color:black">BIOSCODE:0C18                 </span><span style="color:navy">mov     al, ds:</span>save_eot
<span style="color:black">BIOSCODE:0C1B                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">4</span><span style="color:navy">], al   </span>; [es:si+DISK_PARMS.DISK_EOT]
<span style="color:black">BIOSCODE:0C1F                 </span><span style="color:navy">mov     al, ds:</span>settlecurrent
<span style="color:black">BIOSCODE:0C22                 </span><span style="color:navy">mov     ah, ds:</span>motorstartup
<span style="color:black">BIOSCODE:0C26                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">9</span><span style="color:navy">], al   </span>; [es:si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:0C2A                 </span><span style="color:navy">mov     byte ptr es:[si+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:si+DISK_PARMS.DISK_SECTOR_SIZ]
<span style="color:black">BIOSCODE:0C2F                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], ah </span>; [es:si+DISK_PARMS.DISK_MOTOR_STRT]
<span style="color:black">BIOSCODE:0C33                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:0C34                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0C35
BIOSCODE:0C35 </span><span style="color:gray">nodiddleback</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C35                 </span><span style="color:navy">popf
</span><span style="color:black">BIOSCODE:0C36
BIOSCODE:0C36 </span>ddbx<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C36                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0C36 </span>done            <span style="color:black">endp
BIOSCODE:0C36
BIOSCODE:0C37
BIOSCODE:0C37 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0C37
BIOSCODE:0C37
BIOSCODE:0C37 </span>block           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C37                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">BIOSCODE:0C39                 </span><span style="color:navy">jz      short </span>ddbx
<span style="color:black">BIOSCODE:0C3B                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0C40                 </span><span style="color:navy">jz      short </span><span style="color:gray">block_floppy
</span><span style="color:black">BIOSCODE:0C42                 </span><span style="color:navy">test    byte ptr ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:green">80h </span>; multrk_on
<span style="color:black">BIOSCODE:0C47                 </span><span style="color:navy">jz      short </span><span style="color:gray">block_floppy
</span><span style="color:black">BIOSCODE:0C49                 </span><span style="color:navy">call    </span>disk
<span style="color:black">BIOSCODE:0C4C                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">BIOSCODE:0C4E                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0C4F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0C4F
BIOSCODE:0C4F </span><span style="color:gray">block_floppy</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C4F                 </span><span style="color:navy">mov     cl, es:[di+</span><span style="color:green">19</span><span style="color:navy">]  </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:0C53                 </span><span style="color:navy">inc     cx
</span><span style="color:black">BIOSCODE:0C54                 </span><span style="color:navy">sub     cl, ds:</span>cursec
<span style="color:black">BIOSCODE:0C58                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">BIOSCODE:0C5A                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">BIOSCODE:0C5C                 </span><span style="color:navy">jnb     short </span><span style="color:gray">gotmin
</span><span style="color:black">BIOSCODE:0C5E                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">BIOSCODE:0C60
BIOSCODE:0C60 </span><span style="color:gray">gotmin</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C60                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0C61                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:0C62                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">BIOSCODE:0C64                 </span><span style="color:navy">call    </span>disk
<span style="color:black">BIOSCODE:0C67                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:0C68                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0C69                 </span><span style="color:navy">sub     ax, cx          </span>; reduce sectors-remaining by last i/o
<span style="color:black">BIOSCODE:0C6B                 </span><span style="color:navy">add     cl, cl
</span><span style="color:black">BIOSCODE:0C6D                 </span><span style="color:navy">add     bh, cl          </span>; adjust transfer address
<span style="color:black">BIOSCODE:0C6F                 </span><span style="color:navy">jmp     short </span>block
<span style="color:black">BIOSCODE:0C6F </span>block           <span style="color:black">endp
BIOSCODE:0C6F
BIOSCODE:0C71 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0C71 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR disk
</span><span style="color:black">BIOSCODE:0C71
BIOSCODE:0C71 </span><span style="color:gray">dskerr_brdg</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C71                 </span><span style="color:navy">jmp     </span><span style="color:gray">dskerr
</span><span style="color:black">BIOSCODE:0C71 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR disk
</span><span style="color:black">BIOSCODE:0C74
BIOSCODE:0C74 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0C74
BIOSCODE:0C74
BIOSCODE:0C74 </span>disk            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C74
BIOSCODE:0C74 </span><span style="color:gray">; FUNCTION CHUNK AT BIOSCODE:0C71 SIZE 00000003 BYTES
</span><span style="color:black">BIOSCODE:0C74
BIOSCODE:0C74                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">5           </span>; al = number of sectors (1-8, all on one track)
<span style="color:black">BIOSCODE:0C74                                         </span>; es:di point to drive parameters
<span style="color:black">BIOSCODE:0C74                                         </span>; xfer_seg:bx = transfer address
<span style="color:black">BIOSCODE:0C74                                         </span>;      (must not cross a 64k physical boundary)
<span style="color:black">BIOSCODE:0C74                                         </span>; [rflag] = 2 if read, 3 if write
<span style="color:black">BIOSCODE:0C74                                         </span>; [verify] = 0 for normal, 1 for verify after write
<span style="color:black">BIOSCODE:0C74                                         </span>;
<span style="color:black">BIOSCODE:0C74                                         </span>; bp = MAXERR
<span style="color:black">BIOSCODE:0C74                                         </span>;      retry_count
<span style="color:black">BIOSCODE:0C77                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0C7C                 </span><span style="color:navy">jz      short </span><span style="color:gray">GetRdWrInd
</span><span style="color:black">BIOSCODE:0C7E                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4           </span>; romverify ; Is this a track verify?
<span style="color:black">BIOSCODE:0C81                 </span><span style="color:navy">jz      short </span><span style="color:gray">GetRdWrInd
</span><span style="color:black">BIOSCODE:0C83                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">2           </span>; This is not verify so only 1 retry
<span style="color:black">BIOSCODE:0C86
BIOSCODE:0C86 </span><span style="color:gray">GetRdWrInd</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C86                 </span><span style="color:navy">mov     ds:</span>vretry_cnt<span style="color:navy">, bp </span>; verify op. retry cnt for write-verify
<span style="color:black">BIOSCODE:0C8A                 </span><span style="color:navy">mov     ds:</span>soft_ecc_cnt<span style="color:navy">, bp </span>; soft ecc error retry count
<span style="color:black">BIOSCODE:0C8E                 </span><span style="color:navy">mov     ah, ds:</span>rflag    ; get read/write indicator
<span style="color:black">BIOSCODE:0C92
BIOSCODE:0C92 </span><span style="color:gray">_retry</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0C92                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0C93                 </span><span style="color:navy">mov     dx, ds:</span>curtrk
<span style="color:black">BIOSCODE:0C97                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.bdsm_ismini]
<span style="color:black">BIOSCODE:0C97                                         </span>; is this a mini disk? ((logical dos partition))
<span style="color:black">BIOSCODE:0C9C                 </span><span style="color:navy">jz      short </span><span style="color:gray">disk_not_mini </span>; no. continue to next
<span style="color:black">BIOSCODE:0C9E                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">79h</span><span style="color:navy">], </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:0CA3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">disk_not_mini
</span><span style="color:black">BIOSCODE:0CA5                 </span><span style="color:navy">add     dx, es:[di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">] </span>; [es:di+BDS.bdsm_hidden_trks]
<span style="color:black">BIOSCODE:0CA5                                         </span>; add hidden tracks
<span style="color:black">BIOSCODE:0CA9
BIOSCODE:0CA9 </span><span style="color:gray">disk_not_mini</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0CA9                 </span><span style="color:navy">ror     dh, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:0CAB                 </span><span style="color:navy">ror     dh, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:0CAD                 </span><span style="color:navy">or      dh, ds:</span>cursec
<span style="color:black">BIOSCODE:0CB1                 </span><span style="color:navy">mov     cl, dh
</span><span style="color:black">BIOSCODE:0CB3                 </span><span style="color:navy">mov     ch, dl          </span>; cl = sector, ch = cylinder
<span style="color:black">BIOSCODE:0CB5                 </span><span style="color:navy">mov     dh, ds:</span>curhd    ; load current head number and
<span style="color:black">BIOSCODE:0CB9                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; physical drive number
<span style="color:black">BIOSCODE:0CB9                                         </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:0CBD                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], </span><span style="color:#ff8000">5 </span>; [es:di+BDS.formfactor], ffHardFile
<span style="color:black">BIOSCODE:0CC2                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_fast   </span>; hard files use fast speed
<span style="color:black">BIOSCODE:0CC4                 </span><span style="color:navy">cmp     ds:</span>step_drv<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:black">BIOSCODE:0CC9                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_write
</span><span style="color:black">BIOSCODE:0CCB                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2           </span>; romread
<span style="color:black">BIOSCODE:0CCE                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_fast
</span><span style="color:black">BIOSCODE:0CD0                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4           </span>; romverify
<span style="color:black">BIOSCODE:0CD3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">do_write
</span><span style="color:black">BIOSCODE:0CD5
BIOSCODE:0CD5 </span><span style="color:gray">do_fast</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0CD5                 </span><span style="color:navy">call    </span>fastspeed
<span style="color:black">BIOSCODE:0CD8
BIOSCODE:0CD8 </span><span style="color:gray">testerr</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0CD8                 </span><span style="color:navy">jb      short </span><span style="color:gray">dskerr_brdg
</span><span style="color:black">BIOSCODE:0CDA                 </span><span style="color:navy">cmp     bp, </span><span style="color:#ff8000">5           </span>; is there retry ?
<span style="color:black">BIOSCODE:0CDD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">testerror </span>; yes
<span style="color:black">BIOSCODE:0CDF                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">0BBh        </span>; Undefined error (hard disk)
<span style="color:black">BIOSCODE:0CE2                 </span><span style="color:navy">jz      short </span><span style="color:gray">dskerr_brdg
</span><span style="color:black">BIOSCODE:0CE4
BIOSCODE:0CE4 </span><span style="color:gray">testerror</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0CE4                 </span><span style="color:navy">mov     ds:</span>step_drv<span style="color:navy">, dl
</span><span style="color:black">BIOSCODE:0CE8                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">78h</span><span style="color:navy">], ch </span>; [es:di+BDS.track]
<span style="color:black">BIOSCODE:0CEC                 </span><span style="color:navy">cmp     word ptr ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">103h </span>; check for write and verify
<span style="color:black">BIOSCODE:0CF2                 </span><span style="color:navy">jz      short </span><span style="color:gray">doverify
</span><span style="color:black">BIOSCODE:0CF4
BIOSCODE:0CF4 </span><span style="color:gray">noverify</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0CF4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0CF5                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0CFA                 </span><span style="color:navy">jz      short </span><span style="color:gray">its_removable
</span><span style="color:black">BIOSCODE:0CFC                 </span><span style="color:navy">test    byte ptr ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:green">80h </span>; multrk_on
<span style="color:black">BIOSCODE:0D01                 </span><span style="color:navy">jnz     short </span><span style="color:gray">disk_ret
</span><span style="color:black">BIOSCODE:0D03
BIOSCODE:0D03 </span><span style="color:gray">its_removable</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D03                 </span><span style="color:navy">and     cl, </span><span style="color:green">3Fh         </span>; eliminate cylinder bits from sector
<span style="color:black">BIOSCODE:0D06                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">BIOSCODE:0D08                 </span><span style="color:navy">sub     ds:</span>seccnt<span style="color:navy">, ax   </span>; reduce count of sectors to go next sector
<span style="color:black">BIOSCODE:0D0C                 </span><span style="color:navy">add     cl, al
</span><span style="color:black">BIOSCODE:0D0E                 </span><span style="color:navy">mov     ds:</span>cursec<span style="color:navy">, cl
</span><span style="color:black">BIOSCODE:0D12                 </span><span style="color:navy">cmp     cl, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:0D12                                         </span>; see if sector/track limit reached
<span style="color:black">BIOSCODE:0D16                 </span><span style="color:navy">jbe     short </span><span style="color:gray">disk_ret
</span><span style="color:black">BIOSCODE:0D18                 </span><span style="color:navy">mov     ds:</span>cursec<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:0D1D                 </span><span style="color:navy">mov     dh, ds:</span>curhd
<span style="color:black">BIOSCODE:0D21                 </span><span style="color:navy">inc     dh
</span><span style="color:black">BIOSCODE:0D23                 </span><span style="color:navy">cmp     dh, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+BDS.heads]
<span style="color:black">BIOSCODE:0D23                                         </span>; see if head limit reached
<span style="color:black">BIOSCODE:0D27                 </span><span style="color:navy">jb      short </span><span style="color:gray">noxor
</span><span style="color:black">BIOSCODE:0D29                 </span><span style="color:navy">xor     dh, dh          </span>; head 0
<span style="color:black">BIOSCODE:0D2B                 </span><span style="color:navy">inc     ds:</span>curtrk       ; next track
<span style="color:black">BIOSCODE:0D2F
BIOSCODE:0D2F </span><span style="color:gray">noxor</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D2F                 </span><span style="color:navy">mov     ds:</span>curhd<span style="color:navy">, dh
</span><span style="color:black">BIOSCODE:0D33
BIOSCODE:0D33 </span><span style="color:gray">disk_ret</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D33                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:0D34                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0D35 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0D35
BIOSCODE:0D35 </span><span style="color:gray">do_write</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D35                 </span><span style="color:navy">cmp     dl, ds:</span>step_drv
<span style="color:black">BIOSCODE:0D39                 </span><span style="color:navy">jnz     short </span><span style="color:gray">do_norm   </span>; we have changed drives
<span style="color:black">BIOSCODE:0D3B                 </span><span style="color:navy">cmp     ch, es:[di+</span><span style="color:#ff8000">78h</span><span style="color:navy">] </span>; [es:di+BDS.track]
<span style="color:black">BIOSCODE:0D3F                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_fast   </span>; we are still on the same track
<span style="color:black">BIOSCODE:0D41
BIOSCODE:0D41 </span><span style="color:gray">do_norm</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D41                 </span><span style="color:navy">call    </span>normspeed
<span style="color:black">BIOSCODE:0D44                 </span><span style="color:navy">jmp     short </span><span style="color:gray">testerr
</span><span style="color:black">BIOSCODE:0D46 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0D46
BIOSCODE:0D46 </span><span style="color:gray">doverify</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D46                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0D47                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0D48                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">4
</span><span style="color:black">BIOSCODE:0D4A                 </span><span style="color:navy">call    </span>fastspeed
<span style="color:black">BIOSCODE:0D4D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">noverify
</span><span style="color:black">BIOSCODE:0D4F                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">11h         </span>; soft ecc error ?
<span style="color:black">BIOSCODE:0D52                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_softecc_err
</span><span style="color:black">BIOSCODE:0D54                 </span><span style="color:navy">dec     ds:</span>soft_ecc_cnt
<span style="color:black">BIOSCODE:0D58                 </span><span style="color:navy">jz      short </span><span style="color:gray">noverify  </span>; no more retry
<span style="color:black">BIOSCODE:0D5A                 </span><span style="color:navy">call    </span>ResetDisk
<span style="color:black">BIOSCODE:0D5D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">diskerr1  </span>; retry
<span style="color:black">BIOSCODE:0D5F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0D5F
BIOSCODE:0D5F </span><span style="color:gray">not_softecc_err</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D5F                 </span><span style="color:navy">call    </span>ResetDisk
<span style="color:black">BIOSCODE:0D62                 </span><span style="color:navy">dec     ds:</span>vretry_cnt
<span style="color:black">BIOSCODE:0D66                 </span><span style="color:navy">jmp     short </span><span style="color:gray">dskerr0
</span><span style="color:black">BIOSCODE:0D68 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0D68
BIOSCODE:0D68 </span><span style="color:gray">dskerr</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D68                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; do we have changeline support?
<span style="color:black">BIOSCODE:0D6D                 </span><span style="color:navy">jz      short </span><span style="color:gray">dskerr_nochangeline </span>; brif not
<span style="color:black">BIOSCODE:0D6F                 </span><span style="color:navy">call    </span>checkio
<span style="color:black">BIOSCODE:0D72
BIOSCODE:0D72 </span><span style="color:gray">dskerr_nochangeline</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D72                 </span><span style="color:navy">cmp     ds:</span>multitrk_format_flag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; multi trk format request?
<span style="color:black">BIOSCODE:0D77                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dochkagain </span>; no more retry
<span style="color:black">BIOSCODE:0D79                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:0D7C                 </span><span style="color:navy">mov     ds:</span>multitrk_format_flag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; clear the flag
<span style="color:black">BIOSCODE:0D81
BIOSCODE:0D81 </span><span style="color:gray">dochkagain</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D81                 </span><span style="color:navy">call    </span>again
<span style="color:black">BIOSCODE:0D84
BIOSCODE:0D84 </span><span style="color:gray">dskerr0</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D84                 </span><span style="color:navy">jz      short </span>harderr
<span style="color:black">BIOSCODE:0D86                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:0D8B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">skip_timeout_chk
</span><span style="color:black">BIOSCODE:0D8D                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">80h         </span>; timeout?
<span style="color:black">BIOSCODE:0D90                 </span><span style="color:navy">jz      short </span>harderr
<span style="color:black">BIOSCODE:0D92
BIOSCODE:0D92 </span><span style="color:gray">skip_timeout_chk</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D92                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0CCh        </span>; write fault error?
<span style="color:black">BIOSCODE:0D95                 </span><span style="color:navy">jz      short </span><span style="color:gray">write_fault_err </span>; then, don&#039;t retry.
<span style="color:black">BIOSCODE:0D97                 </span><span style="color:navy">mov     ds:</span>soft_ecc_cnt<span style="color:navy">, </span><span style="color:#ff8000">5 </span>; MAXERR
<span style="color:black">BIOSCODE:0D97                                         </span>; set soft_ecc_cnt back   to maxerr
<span style="color:black">BIOSCODE:0D9D
BIOSCODE:0D9D </span><span style="color:gray">diskerr1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0D9D                 </span><span style="color:navy">pop     ax              </span>; restore sector count
<span style="color:black">BIOSCODE:0D9E                 </span><span style="color:navy">jmp     </span><span style="color:gray">_retry
</span><span style="color:black">BIOSCODE:0DA1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0DA1
BIOSCODE:0DA1 </span><span style="color:gray">write_fault_err</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0DA1                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">1           </span>; just retry only once
<span style="color:black">BIOSCODE:0DA1                                         </span>; for write fault error
<span style="color:black">BIOSCODE:0DA4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">diskerr1
</span><span style="color:black">BIOSCODE:0DA6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0DA6
BIOSCODE:0DA6 </span>harderr<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0DA6                 </span><span style="color:navy">call    </span>maperror
<span style="color:black">BIOSCODE:0DA9
BIOSCODE:0DA9 </span>harderr2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0DA9                 </span><span style="color:navy">mov     ds:</span>tim_drv<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; force a media check through rom
<span style="color:black">BIOSCODE:0DAE                 </span><span style="color:navy">mov     cx, ds:</span>seccnt   ; get count of sectors to go
<span style="color:black">BIOSCODE:0DB2                 </span><span style="color:navy">mov     sp, ds:</span>spsav    ; recover entry stack pointer
<span style="color:black">BIOSCODE:0DB6                 </span><span style="color:navy">jmp     </span>diddle_back
<span style="color:black">BIOSCODE:0DB6 </span>disk            <span style="color:black">endp
BIOSCODE:0DB6
BIOSCODE:0DB9
BIOSCODE:0DB9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0DB9
BIOSCODE:0DB9
BIOSCODE:0DB9 </span>normspeed       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0DB9                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:0DBE                 </span><span style="color:navy">jnz     short </span>fastspeed
<span style="color:black">BIOSCODE:0DC0                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:0DC1                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:0DC2                 </span><span style="color:navy">mov     al, ds:</span>settleslow
<span style="color:black">BIOSCODE:0DC5                 </span><span style="color:navy">les     si, ds:</span>dpt      ; current disk parm table
<span style="color:black">BIOSCODE:0DC9                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">9</span><span style="color:navy">], al   </span>; [es:si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:0DCD                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0DCE                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:0DCF                 </span><span style="color:navy">call    </span>fastspeed
<span style="color:black">BIOSCODE:0DD2                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0DD3                 </span><span style="color:navy">lds     si, ds:</span>dpt
<span style="color:black">BIOSCODE:0DD7                 </span><span style="color:navy">mov     byte ptr [si+</span><span style="color:#ff8000">9</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [es:si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:0DD7                                         </span>; 1 is fast settle value
<span style="color:black">BIOSCODE:0DDB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:0DDC                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0DDC </span>normspeed       <span style="color:black">endp
BIOSCODE:0DDC
BIOSCODE:0DDD
BIOSCODE:0DDD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0DDD
BIOSCODE:0DDD
BIOSCODE:0DDD </span>fastspeed       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0DDD                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:0DDE                 </span><span style="color:navy">mov     es, ds:</span>xfer_seg
<span style="color:black">BIOSCODE:0DE2                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK -
<span style="color:black">BIOSCODE:0DE4                 </span><span style="color:navy">mov     ds:</span>xfer_seg<span style="color:navy">, es
</span><span style="color:black">BIOSCODE:0DE8                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:0DE9                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0DE9 </span>fastspeed       <span style="color:black">endp
BIOSCODE:0DE9
BIOSCODE:0DEA
BIOSCODE:0DEA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0DEA
BIOSCODE:0DEA
BIOSCODE:0DEA </span>maperror        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0DEA                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:0DEB                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:0DEC                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:0DED                 </span><span style="color:navy">pop     es              </span>; set es=Bios_Data
<span style="color:black">BIOSCODE:0DEE                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">BIOSCODE:0DF0                 </span><span style="color:navy">mov     ds:</span>lsterr<span style="color:navy">, al   </span>; terminate list with error code
<span style="color:black">BIOSCODE:0DF3                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11          </span>; numerr (= errout-errin)
<span style="color:black">BIOSCODE:0DF3                                         </span>; number of possible error conditions
<span style="color:black">BIOSCODE:0DF6                 </span><span style="color:navy">mov     di, offset </span>errin
<span style="color:black">BIOSCODE:0DF9                 </span><span style="color:navy">repne scasb
</span><span style="color:black">BIOSCODE:0DFB                 </span><span style="color:navy">mov     al, [di+</span><span style="color:green">10</span><span style="color:navy">]     </span>; [di+numerr-1]
<span style="color:black">BIOSCODE:0DFB                                         </span>; get translation
<span style="color:black">BIOSCODE:0DFF                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:0E00                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:0E01                 </span><span style="color:navy">stc                     </span>; flag error condition
<span style="color:black">BIOSCODE:0E02                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0E02 </span>maperror        <span style="color:black">endp
BIOSCODE:0E02
BIOSCODE:0E03
BIOSCODE:0E03 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0E03
BIOSCODE:0E03
BIOSCODE:0E03 </span>set_tim         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0E03                 </span><span style="color:navy">push    ax              </span>; set the time of last access for this drive.
<span style="color:black">BIOSCODE:0E03                                         </span>; this is done only for removable media.
<span style="color:black">BIOSCODE:0E03                                         </span>; es:di -&gt; bds
<span style="color:black">BIOSCODE:0E04                 </span><span style="color:navy">call    </span>GetTickCnt      ; Does INT 1A ah=0 &amp; updates daycnt
<span style="color:black">BIOSCODE:0E07                 </span><span style="color:navy">cmp     dx, es:[di+</span><span style="color:#ff8000">79h</span><span style="color:navy">] </span>; [es:di+BDS.tim_lo]
<span style="color:black">BIOSCODE:0E0B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setaccess
</span><span style="color:black">BIOSCODE:0E0D                 </span><span style="color:navy">cmp     cx, es:[di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">] </span>; [es:di+BDS.tim_hi]
<span style="color:black">BIOSCODE:0E11                 </span><span style="color:navy">jz      short </span><span style="color:gray">done_set
</span><span style="color:black">BIOSCODE:0E13
BIOSCODE:0E13 </span><span style="color:gray">setaccess</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0E13                 </span><span style="color:navy">mov     ds:</span>accesscount<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; the time has passed
<span style="color:black">BIOSCODE:0E13                                         </span>; reset the threshold counter
<span style="color:black">BIOSCODE:0E18                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">79h</span><span style="color:navy">], dx
</span><span style="color:black">BIOSCODE:0E1C                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">7Bh</span><span style="color:navy">], cx
</span><span style="color:black">BIOSCODE:0E20
BIOSCODE:0E20 </span><span style="color:gray">done_set</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0E20                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:0E21                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:0E22                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0E22 </span>set_tim         <span style="color:black">endp
BIOSCODE:0E22
BIOSCODE:0E23
BIOSCODE:0E23 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0E23
BIOSCODE:0E23
BIOSCODE:0E23 </span>again           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0E23                 </span><span style="color:navy">call    </span>ResetDisk
<span style="color:black">BIOSCODE:0E26                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">6           </span>; If it is a media change error
<span style="color:black">BIOSCODE:0E26                                         </span>; do not decrement retry count
<span style="color:black">BIOSCODE:0E29                 </span><span style="color:navy">jz      short </span><span style="color:gray">dont_dec_retry_count
</span><span style="color:black">BIOSCODE:0E2B                 </span><span style="color:navy">dec     bp              </span>; decrement retry count
<span style="color:black">BIOSCODE:0E2C                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0E2D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:0E2D
BIOSCODE:0E2D </span><span style="color:gray">dont_dec_retry_count</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0E2D                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">BIOSCODE:0E2F                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0E2F </span>again           <span style="color:black">endp
BIOSCODE:0E2F
BIOSCODE:0E2F </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:0E30 </span>ioctl_drvnum    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:0E31
BIOSCODE:0E31 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:0E31
BIOSCODE:0E31
BIOSCODE:0E31 </span>get_phy_drv_num <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:0E31                 </span><span style="color:navy">call    </span>SetDrive        ; get physcial drive number
<span style="color:black">BIOSCODE:0E31                                         </span>; INPUT: al = logical drive number (BDS.drivelet)
<span style="color:black">BIOSCODE:0E31                                         </span>; OUTPUT: physical drive number (BDS.drivenum
<span style="color:black">BIOSCODE:0E34                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:0E38                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:0E38 </span>get_phy_drv_num <span style="color:black">endp
BIOSCODE:0E38
</span><span style="color:maroon">BIOSCODE:0E39 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0E39
BIOSCODE:0E39 </span>ioctl_output<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0E39                 </span><span style="color:navy">call    </span>get_phy_drv_num
<span style="color:maroon">BIOSCODE:0E3C                 </span><span style="color:navy">mov     cs:</span>ioctl_drvnum<span style="color:navy">, dl
</span><span style="color:maroon">BIOSCODE:0E41                 </span><span style="color:navy">mov     ah, </span><span style="color:green">41h
</span><span style="color:maroon">BIOSCODE:0E43                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">55AAh
</span><span style="color:maroon">BIOSCODE:0E46                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - Check for INT 13h Extensions
<span style="color:maroon">BIOSCODE:0E46                                         </span>; BX = 55AAh, DL = drive number
<span style="color:maroon">BIOSCODE:0E46                                         </span>; Return: CF set if not supported
<span style="color:maroon">BIOSCODE:0E46                                         </span>; AH = extensions version
<span style="color:maroon">BIOSCODE:0E46                                         </span>; BX = AA55h
<span style="color:maroon">BIOSCODE:0E46                                         </span>; CX = Interface support bit map
<span style="color:maroon">BIOSCODE:0E48                 </span><span style="color:navy">jb      short </span>int13h_exts_err
<span style="color:maroon">BIOSCODE:0E4A
BIOSCODE:0E4A </span>ioctl_input_1<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0E4A                 </span><span style="color:navy">les     di, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:0E4E                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:green">14</span><span style="color:navy">]  </span>; [es:di+IOCTL_REQ.MINORFUNCTION]
<span style="color:maroon">BIOSCODE:0E52                 </span><span style="color:navy">jb      short </span>ioctl_input_2
<span style="color:maroon">BIOSCODE:0E54                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4600h       </span>; Eject removable media
<span style="color:maroon">BIOSCODE:0E57                 </span><span style="color:navy">cmp     es:[di], al     </span>; al = 0 ; disk ioctl function = 0
<span style="color:maroon">BIOSCODE:0E5A                 </span><span style="color:navy">jz      short </span>ioctl_output_1
<span style="color:maroon">BIOSCODE:0E5C                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">1 </span>; al = 1 ; disk ioctl function = 1
<span style="color:maroon">BIOSCODE:0E60                 </span><span style="color:navy">jnz     short </span>ioctl_output_2
<span style="color:maroon">BIOSCODE:0E62                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4501h       </span>; Lock/unlock media
<span style="color:maroon">BIOSCODE:0E62                                         </span>; (al, 0 = lock, 1 = unlock)
<span style="color:maroon">BIOSCODE:0E65                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; unlock (reverse of INT 13h ah=45h)
<span style="color:maroon">BIOSCODE:0E6A                 </span><span style="color:navy">jz      short </span>ioctl_output_1
<span style="color:maroon">BIOSCODE:0E6C                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">], al   </span>; lock (reverse of INT 13h ah=45h)
<span style="color:maroon">BIOSCODE:0E70                 </span><span style="color:navy">jnz     short </span>ioctl_output_2
<span style="color:maroon">BIOSCODE:0E72                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">BIOSCODE:0E73
BIOSCODE:0E73 </span>ioctl_output_1<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0E73                 </span><span style="color:navy">mov     dl, cs:</span>ioctl_drvnum
<span style="color:maroon">BIOSCODE:0E78                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE (DL - drive, DS:SI - disk address packet)
<span style="color:maroon">BIOSCODE:0E7A                 </span><span style="color:navy">jb      short </span>int13h_exts_err
<span style="color:maroon">BIOSCODE:0E7C
BIOSCODE:0E7C </span>ioctl_lock_err<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0E7C                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:0E7D                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:0E7E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0E7E
BIOSCODE:0E7E </span>ioctl_output_2<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0E7E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:0E80
BIOSCODE:0E80 </span>int13h_exts_err<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0E80                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0B0h        </span>; volume not locked in drive
<span style="color:maroon">BIOSCODE:0E83                 </span><span style="color:navy">jz      short </span>ioctl_lock_err
<span style="color:maroon">BIOSCODE:0E85                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0B4h        </span>; lock count exceeded
<span style="color:maroon">BIOSCODE:0E88                 </span><span style="color:navy">jz      short </span>ioctl_lock_err
<span style="color:maroon">BIOSCODE:0E8A                 </span><span style="color:navy">jmp     </span>err_exitj
<span style="color:maroon">BIOSCODE:0E8D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0E8D
BIOSCODE:0E8D </span>ioctl_input<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0E8D                 </span><span style="color:navy">call    </span>get_phy_drv_num
<span style="color:maroon">BIOSCODE:0E90                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSCODE:0E91                 </span><span style="color:navy">jmp     short </span>ioctl_input_1
<span style="color:maroon">BIOSCODE:0E93 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0E93
BIOSCODE:0E93 </span>ioctl_input_2<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0E93                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">6 </span>; disk ioctl function = 6
<span style="color:maroon">BIOSCODE:0E97                 </span><span style="color:navy">jnz     short </span>ioctl_output_2
<span style="color:maroon">BIOSCODE:0E99                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4502h       </span>; get lock status
<span style="color:maroon">BIOSCODE:0E9C                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE (DL - drive, DS:SI - disk address packet)
<span style="color:maroon">BIOSCODE:0E9E                 </span><span style="color:navy">jb      short </span>int13h_exts_err
<span style="color:maroon">BIOSCODE:0EA0                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">0Ch         </span>; bit 1 lock bit
<span style="color:maroon">BIOSCODE:0EA3                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; not locked
<span style="color:maroon">BIOSCODE:0EA5                 </span><span style="color:navy">jz      short </span>ioctl_input_3
<span style="color:maroon">BIOSCODE:0EA7                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">0Eh
</span><span style="color:maroon">BIOSCODE:0EA9
BIOSCODE:0EA9 </span>ioctl_input_3<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0EA9                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:0EAA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">4
</span><span style="color:maroon">BIOSCODE:0EAC                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">101h
</span><span style="color:maroon">BIOSCODE:0EAF                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:0EB1                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - VERIFY SECTORS
<span style="color:maroon">BIOSCODE:0EB1                                         </span>; AL = number of sectors to verify, CH = track, CL = sector
<span style="color:maroon">BIOSCODE:0EB1                                         </span>; DH = head, DL = drive
<span style="color:maroon">BIOSCODE:0EB1                                         </span>; Return: CF set on error, AH = status
<span style="color:maroon">BIOSCODE:0EB1                                         </span>; AL = number of sectors verified
<span style="color:maroon">BIOSCODE:0EB3                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:0EB4                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">31h         </span>; no media in drive (IBM/MS INT 13 extensions)
<span style="color:maroon">BIOSCODE:0EB7                 </span><span style="color:navy">jz      short </span>ioctl_input_5
<span style="color:maroon">BIOSCODE:0EB9                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">80h         </span>; timeout (not ready)
<span style="color:maroon">BIOSCODE:0EBC                 </span><span style="color:navy">jz      short </span>ioctl_input_5
<span style="color:maroon">BIOSCODE:0EBE
BIOSCODE:0EBE </span>ioctl_input_4<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0EBE                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">], bx
</span><span style="color:maroon">BIOSCODE:0EC2                 </span><span style="color:navy">jmp     short </span>ioctl_lock_err
<span style="color:maroon">BIOSCODE:0EC4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0EC4
BIOSCODE:0EC4 </span>ioctl_input_5<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0EC4                 </span><span style="color:navy">or      bx, </span><span style="color:green">801h        </span>; bit 0 error bit (1 = error, 31h or 80h)
<span style="color:maroon">BIOSCODE:0EC4                                         </span>; bit 11 (not ready -removable media error- bit)
<span style="color:maroon">BIOSCODE:0EC4                                         </span>; if bit 11 = 0, another error (except 31h and 80h)
<span style="color:maroon">BIOSCODE:0EC8                 </span><span style="color:navy">jmp     short </span>ioctl_input_4
<span style="color:maroon">BIOSCODE:0EC8 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:0ECA </span>IoReadJumpTable <span style="color:navy">db </span><span style="color:#008040">15                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0ECB                 </span><span style="color:navy">dw offset </span>GetDeviceParameters ; 60h
<span style="color:gray">BIOSCODE:0ECD                 </span><span style="color:navy">dw offset </span>ReadTrack     ; 61h
<span style="color:gray">BIOSCODE:0ECF                 </span><span style="color:navy">dw offset </span>VerifyTrack   ; 62h
<span style="color:gray">BIOSCODE:0ED1                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 63h
<span style="color:gray">BIOSCODE:0ED3                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 64h
<span style="color:gray">BIOSCODE:0ED5                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 65h
<span style="color:gray">BIOSCODE:0ED7                 </span><span style="color:navy">dw offset </span>GetMediaId    ; 66h
<span style="color:gray">BIOSCODE:0ED9                 </span><span style="color:navy">dw offset </span>GetAccessFlag ; 67h
<span style="color:gray">BIOSCODE:0EDB                 </span><span style="color:navy">dw offset </span>SenseMediaType ; 68h
<span style="color:gray">BIOSCODE:0EDD                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 69h
<span style="color:gray">BIOSCODE:0EDF                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 6Ah
<span style="color:gray">BIOSCODE:0EE1                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 6Bh
<span style="color:gray">BIOSCODE:0EE3                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 6Ch
<span style="color:gray">BIOSCODE:0EE5                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 6Dh
<span style="color:gray">BIOSCODE:0EE7                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 6Eh
<span style="color:gray">BIOSCODE:0EE9                 </span><span style="color:navy">dw offset </span>GetDrvMapInfo ; 6Fh
<span style="color:gray">BIOSCODE:0EEB </span>IoWriteJumpTable <span style="color:navy">db </span><span style="color:#008040">9                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0EEC                 </span><span style="color:navy">dw offset </span>SetDeviceParameters ; 40h
<span style="color:gray">BIOSCODE:0EEE                 </span><span style="color:navy">dw offset </span>WriteTrack    ; 41h
<span style="color:gray">BIOSCODE:0EF0                 </span><span style="color:navy">dw offset </span>FormatTrack   ; 42h
<span style="color:gray">BIOSCODE:0EF2                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 43h
<span style="color:gray">BIOSCODE:0EF4                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 44h
<span style="color:gray">BIOSCODE:0EF6                 </span><span style="color:navy">dw offset </span>Cmd_Error_Proc ; 45h
<span style="color:gray">BIOSCODE:0EF8                 </span><span style="color:navy">dw offset </span>SetMediaId    ; 46h
<span style="color:gray">BIOSCODE:0EFA                 </span><span style="color:navy">dw offset </span>SetAccessFlag ; 47h
<span style="color:gray">BIOSCODE:0EFC                 </span><span style="color:navy">dw offset </span>SetLockState  ; 48h
<span style="color:gray">BIOSCODE:0EFE                 </span><span style="color:navy">dw offset </span>EjectMedia    ; 49h
<span style="color:gray">BIOSCODE:0F00 </span>IOC_DC_Table    <span style="color:navy">db </span><span style="color:#008040">60h</span><span style="color:navy">, </span><span style="color:#008040">40h</span><span style="color:navy">, </span><span style="color:#008040">61h</span><span style="color:navy">, </span><span style="color:#008040">41h</span><span style="color:navy">, </span><span style="color:#008040">62h</span><span style="color:navy">, </span><span style="color:#008040">42h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">67h</span><span style="color:navy">, </span><span style="color:#008040">47h</span><span style="color:navy">, </span><span style="color:#008040">68h </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:0F00                 </span><span style="color:navy">db </span><span style="color:#008040">48h</span><span style="color:navy">, </span><span style="color:#008040">49h</span><span style="color:navy">, </span><span style="color:#008040">6Fh
</span><span style="color:gray">BIOSCODE:0F0E </span>new_genioctl    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0F0F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0F0F
BIOSCODE:0F0F </span>do_generic_ioctl<span style="color:navy">:                       </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0F0F                 </span><span style="color:navy">call    </span>SetDrive        ; es:di points to bds for drive
<span style="color:maroon">BIOSCODE:0F12                 </span><span style="color:navy">mov     cs:</span>new_genioctl<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; 0, old generic ioctl function
<span style="color:maroon">BIOSCODE:0F18                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:0F19                 </span><span style="color:navy">les     bx, ds:</span>ptrsav   ; es:bx points to request header
<span style="color:maroon">BIOSCODE:0F1D                 </span><span style="color:navy">cmp     byte ptr es:[bx+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:#ff8000">8 </span>; [es:bx+IOCTL_REQ.MAJORFUNCTION],
<span style="color:maroon">BIOSCODE:0F1D                                         </span>; RAWIO
<span style="color:maroon">BIOSCODE:0F22                 </span><span style="color:navy">jz      short </span>chk_genioctl_minor
<span style="color:maroon">BIOSCODE:0F24                 </span><span style="color:navy">inc     cs:</span>new_genioctl ; 1, new generic ioctl function (FAT32)
<span style="color:maroon">BIOSCODE:0F29                 </span><span style="color:navy">cmp     byte ptr es:[bx+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:green">48h </span>; Generic IOCtl Request support
<span style="color:maroon">BIOSCODE:0F29                                         </span>; (called only if bit 6 of attribute is set to 1)
<span style="color:maroon">BIOSCODE:0F2E
BIOSCODE:0F2E </span>chk_genioctl_minor<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0F2E                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">] </span>; [es:bx+IOCTL_REQ.MINORFUNCTION]
<span style="color:maroon">BIOSCODE:0F32                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:0F33                 </span><span style="color:navy">jnz     short </span>IoctlFuncErr
<span style="color:maroon">BIOSCODE:0F35                 </span><span style="color:navy">mov     si, offset </span>IoReadJumpTable
<span style="color:maroon">BIOSCODE:0F38                 </span><span style="color:navy">test    al, </span><span style="color:green">20h         </span>; GEN_IOCTL_FN_TST ; test of req. function
<span style="color:maroon">BIOSCODE:0F3A                 </span><span style="color:navy">jnz     short </span>NotGenericWrite
<span style="color:maroon">BIOSCODE:0F3C                 </span><span style="color:navy">mov     si, offset </span>IoWriteJumpTable
<span style="color:maroon">BIOSCODE:0F3F
BIOSCODE:0F3F </span>NotGenericWrite<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0F3F                 </span><span style="color:navy">and     al, </span><span style="color:green">0DFh        </span>; ~GEN_IOCTL_FN_TST ; get rid of read/write
<span style="color:maroon">BIOSCODE:0F41                 </span><span style="color:navy">sub     al, </span><span style="color:green">40h         </span>; offset for base function
<span style="color:maroon">BIOSCODE:0F43                 </span><span style="color:navy">cmp     al, cs:[si]
</span><span style="color:maroon">BIOSCODE:0F46                 </span><span style="color:navy">ja      short </span>IoctlFuncErr
<span style="color:maroon">BIOSCODE:0F48                 </span><span style="color:navy">cbw
</span><span style="color:maroon">BIOSCODE:0F49                 </span><span style="color:navy">add     ax, ax
</span><span style="color:maroon">BIOSCODE:0F4B                 </span><span style="color:navy">inc     si
</span><span style="color:maroon">BIOSCODE:0F4C                 </span><span style="color:navy">add     si, ax
</span><span style="color:maroon">BIOSCODE:0F4E                 </span><span style="color:navy">call    word ptr cs:[si]
</span><span style="color:maroon">BIOSCODE:0F51                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:0F56                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:0F56                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">81h         </span>; Return this status in case of carry
<span style="color:maroon">BIOSCODE:0F58                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:0F59 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0F59
BIOSCODE:0F59 </span>Cmd_Error_Proc<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0F59                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSCODE:0F5A
BIOSCODE:0F5A </span>IoctlFuncErr<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0F5A                 </span><span style="color:navy">jmp     </span>bc_cmderr
<span style="color:maroon">BIOSCODE:0F5D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0F5D
BIOSCODE:0F5D </span>GetDeviceParameters<span style="color:navy">:                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0F5D                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav   ; ds:bx points to request header
<span style="color:maroon">BIOSCODE:0F61                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:0F61                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:0F61                                         </span>; (ds:bx) = return buffer
<span style="color:maroon">BIOSCODE:0F64                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">] </span>; [es:di+BDS.formfactor]
<span style="color:maroon">BIOSCODE:0F68                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">], al      </span>; [bx+A_DEVICEPARAMETERS.DP_DEVICETYPE]
<span style="color:maroon">BIOSCODE:0F6B                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">] </span>; [es:di+BDS.flags]
<span style="color:maroon">BIOSCODE:0F6F                 </span><span style="color:navy">and     ax, </span><span style="color:green">3           </span>; fnon_removable+fchangeline
<span style="color:maroon">BIOSCODE:0F6F                                         </span>; Mask off other bits
<span style="color:maroon">BIOSCODE:0F72                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax      </span>; [bx+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES]
<span style="color:maroon">BIOSCODE:0F75                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">41h</span><span style="color:navy">] </span>; [es:di+BDS.cylinders]
<span style="color:maroon">BIOSCODE:0F79                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax      </span>; [bx+A_DEVICEPARAMETERS.DP_CYLINDERS]
<span style="color:maroon">BIOSCODE:0F7C                 </span><span style="color:navy">xor     al, al          </span>; Set media type to default
<span style="color:maroon">BIOSCODE:0F7E                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], al      </span>; [bx+A_DEVICEPARAMETERS.DP_MEDIATYPE]
<span style="color:maroon">BIOSCODE:0F81                 </span><span style="color:navy">lea     si, [di+</span><span style="color:#ff8000">43h</span><span style="color:navy">]    </span>; [di+BDS.rbytespersec] = [di+BDS.R_BPB]
<span style="color:maroon">BIOSCODE:0F81                                         </span>; (copy recommended bpb)
<span style="color:maroon">BIOSCODE:0F84                 </span><span style="color:navy">test    byte ptr [bx], </span><span style="color:green">1 </span>; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS],
<span style="color:maroon">BIOSCODE:0F84                                         </span>; BUILD_DEVICE_BPB
<span style="color:maroon">BIOSCODE:0F87                 </span><span style="color:navy">jz      short </span>UseBpbPresent
<span style="color:maroon">BIOSCODE:0F89                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:0F8A                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word ; Point back to BIOSDATA
<span style="color:maroon">BIOSCODE:0F8F                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:0F8F                 </span><span style="color:navy">call    </span>checksingle
<span style="color:maroon">BIOSCODE:0F92                 </span><span style="color:navy">call    </span>GetBp           ; Build the bpb from scratch
<span style="color:maroon">BIOSCODE:0F95                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:0F96                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:0F96                 </span><span style="color:navy">jb      short </span>GetParmRet
<span style="color:maroon">BIOSCODE:0F98                 </span><span style="color:navy">lea     si, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [di+BDS.bytespersec] = [di+BSD.DP_BPB]
<span style="color:maroon">BIOSCODE:0F98                                         </span>; Use this subfield of bds instead
<span style="color:maroon">BIOSCODE:0F9B
BIOSCODE:0F9B </span>UseBpbPresent<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0F9B                 </span><span style="color:navy">lea     di, [bx+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; [bx+A_DEVICEPARAMETERS.DP_BPB]
<span style="color:maroon">BIOSCODE:0F9B                                         </span>; This is where the result goes
<span style="color:maroon">BIOSCODE:0F9E                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">BIOSCODE:0FA0                 </span><span style="color:navy">mov     cx, </span><span style="color:green">31          </span>; A_BPB.size = 31
<span style="color:maroon">BIOSCODE:0FA3                 </span><span style="color:navy">cmp     cs:</span>new_genioctl<span style="color:navy">, dl
</span><span style="color:maroon">BIOSCODE:0FA8                 </span><span style="color:navy">jz      short </span>gdp_1     ; old type (FAT12 &amp; FAT16) structure
<span style="color:maroon">BIOSCODE:0FAA                 </span><span style="color:navy">mov     cx, </span><span style="color:green">53          </span>; FAT32 BPB size
<span style="color:maroon">BIOSCODE:0FAD                 </span><span style="color:navy">mov     dx, </span><span style="color:green">32          </span>; 53+32 = 85 bytes (A_BPB_FAT32.size)
<span style="color:maroon">BIOSCODE:0FB0
BIOSCODE:0FB0 </span>gdp_1<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0FB0                 </span><span style="color:navy">push    ds              </span>; reverse segments for copy
<span style="color:maroon">BIOSCODE:0FB1                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:0FB2                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:0FB3                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:0FB4                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">BIOSCODE:0FB6                 </span><span style="color:navy">mov     cx, dx          </span>; 0 or 32
<span style="color:maroon">BIOSCODE:0FB8                 </span><span style="color:navy">jcxz    short </span>gdp_2
<span style="color:maroon">BIOSCODE:0FBA                 </span><span style="color:navy">xor     al, al          </span>; 32 zeros
<span style="color:maroon">BIOSCODE:0FBC                 </span><span style="color:navy">rep stosb
</span><span style="color:maroon">BIOSCODE:0FBE
BIOSCODE:0FBE </span>gdp_2<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0FBE                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:0FBF
BIOSCODE:0FBF </span>GetParmRet<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0FBF                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:0FC0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0FC0
BIOSCODE:0FC0 </span>SetDeviceParameters<span style="color:navy">:                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:0FC0                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav   ; ds:bx points to request header
<span style="color:maroon">BIOSCODE:0FC4                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:0FC7                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">140h </span>; [es:di+BDS.flags],
<span style="color:maroon">BIOSCODE:0FC7                                         </span>;  fchanged_by_format|fchanged
<span style="color:maroon">BIOSCODE:0FCD                 </span><span style="color:navy">test    byte ptr [bx], </span><span style="color:green">2 </span>; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS],
<span style="color:maroon">BIOSCODE:0FCD                                         </span>;  ONLY_SET_TRACKLAYOUT
<span style="color:maroon">BIOSCODE:0FD0                 </span><span style="color:navy">jz      short </span>sdp_1
<span style="color:maroon">BIOSCODE:0FD2                 </span><span style="color:navy">jmp     </span>setTrackTable
<span style="color:maroon">BIOSCODE:0FD5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:0FD5
BIOSCODE:0FD5 </span>sdp_1<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0FD5                 </span><span style="color:navy">mov     al, [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">]      </span>; [bx+A_DEVICEPARAMETERS.DP_DEVICETYPE]
<span style="color:maroon">BIOSCODE:0FD8                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], al </span>; [es:di+BDS.formfactor]
<span style="color:maroon">BIOSCODE:0FDC                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [bx+A_DEVICEPARAMETERS.DP_CYLINDERS]
<span style="color:maroon">BIOSCODE:0FDF                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">41h</span><span style="color:navy">], ax </span>; [es:di+BDS.cylinders]
<span style="color:maroon">BIOSCODE:0FE3                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; [bx+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES]
<span style="color:maroon">BIOSCODE:0FE6                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:0FE7                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word ; BIOSDATA segment
<span style="color:maroon">BIOSCODE:0FEC                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:0FEC                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:0FF1                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:0FF2                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:0FF2                 </span><span style="color:navy">jnz     short </span>HaveChange ; we have changeline support
<span style="color:maroon">BIOSCODE:0FF4                 </span><span style="color:navy">and     ax, </span><span style="color:green">0FFFDh
</span><span style="color:maroon">BIOSCODE:0FF7
BIOSCODE:0FF7 </span>HaveChange<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:0FF7                 </span><span style="color:navy">and     ax, </span><span style="color:green">3           </span>; Ignore all bits except non_removable and changeline
<span style="color:maroon">BIOSCODE:0FF7                                         </span>; fnon_removable|fchangeline
<span style="color:maroon">BIOSCODE:0FFA                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">] </span>; [es:di+BDS.flags]
<span style="color:maroon">BIOSCODE:0FFE                 </span><span style="color:navy">and     cx, </span><span style="color:green">0FDF4h      </span>; ~(fnon_removable|fchangeline|good_tracklayout|unformatted_media)
<span style="color:maroon">BIOSCODE:1002                 </span><span style="color:navy">or      ax, cx
</span><span style="color:maroon">BIOSCODE:1004                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], ax </span>; [es:di+BDS.flags]
<span style="color:maroon">BIOSCODE:1008                 </span><span style="color:navy">mov     al, [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [bx+A_DEVICEPARAMETERS.DP_MEDIATYPE]
<span style="color:maroon">BIOSCODE:1008                                         </span>; Set media type
<span style="color:maroon">BIOSCODE:100B                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:100C                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:1011                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1011                 </span><span style="color:navy">mov     ds:</span>mediatype<span style="color:navy">, al
</span><span style="color:maroon">BIOSCODE:1014                 </span><span style="color:navy">mov     cx, </span><span style="color:green">53          </span>; FAT32 BPB size
<span style="color:maroon">BIOSCODE:1017                 </span><span style="color:navy">cmp     cs:</span>new_genioctl<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:101D                 </span><span style="color:navy">jnz     short </span>sdp_2     ; new type (FAT32) structure
<span style="color:maroon">BIOSCODE:101F                 </span><span style="color:navy">mov     cx, </span><span style="color:green">31          </span>; A_BPB.size = 31
<span style="color:maroon">BIOSCODE:1022
BIOSCODE:1022 </span>sdp_2<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1022                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1023                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1023                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">80h </span>; [es:di+BDS.flags],
<span style="color:maroon">BIOSCODE:1023                                         </span>; set_dasd_true (the next time we format a track)
<span style="color:maroon">BIOSCODE:1029                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:102A                 </span><span style="color:navy">test    byte ptr [bx], </span><span style="color:green">1 </span>; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS],
<span style="color:maroon">BIOSCODE:102A                                         </span>;  INSTALL_FAKE_BPB
<span style="color:maroon">BIOSCODE:102D                 </span><span style="color:navy">jnz     short </span>InstallFakeBpb
<span style="color:maroon">BIOSCODE:102F                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">4 </span>; [es:di+BDS.flags], return_fake_bpb
<span style="color:maroon">BIOSCODE:102F                                         </span>; were we returning a fake bpb when asked to build a bpb?
<span style="color:maroon">BIOSCODE:1035                 </span><span style="color:navy">jz      short </span>InstallRecommendedBpb
<span style="color:maroon">BIOSCODE:1037                 </span><span style="color:navy">and     word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">0FFFBh </span>; [es:di+BDS.flags], ~return_fake_bpb
<span style="color:maroon">BIOSCODE:1037                                         </span>; we were returning a fake bpb but we can stop now
<span style="color:maroon">BIOSCODE:103C
BIOSCODE:103C </span>InstallRecommendedBpb<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:103C                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">43h</span><span style="color:navy">]    </span>; [di+BDS.R_BPB] = [di+BDS.rbytespersec]
<span style="color:maroon">BIOSCODE:103F                 </span><span style="color:navy">jmp     short </span>CopyTheBpb
<span style="color:maroon">BIOSCODE:1041 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1041
BIOSCODE:1041 </span>InstallFakeBpb<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1041                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">4 </span>; byte [es:di+BDS.flags], return_fake_bpb
<span style="color:maroon">BIOSCODE:1046                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [es:di+BDS.BPB] = [es:di+BDS.bytespersec]
<span style="color:maroon">BIOSCODE:1049
BIOSCODE:1049 </span>CopyTheBpb<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1049                 </span><span style="color:navy">lea     si, [bx+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; [bx+A_DEVICEPARAMETERS.DP_BPB]
<span style="color:maroon">BIOSCODE:104C                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">BIOSCODE:104E                 </span><span style="color:navy">push    ds              </span>; Save packet segment
<span style="color:maroon">BIOSCODE:104F                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word ; BIOSDATA segment
<span style="color:maroon">BIOSCODE:1054                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1054                 </span><span style="color:navy">call    </span>RestoreOldDpt
<span style="color:maroon">BIOSCODE:1057                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1058                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1058                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSCODE:1059
BIOSCODE:1059 </span>setTrackTable<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1059                 </span><span style="color:navy">mov     cx, [bx+</span><span style="color:#ff8000">5Ch</span><span style="color:navy">]    </span>; [bx+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES]
<span style="color:maroon">BIOSCODE:1059                                         </span>; offset 85+7 (A_BPB.size+7) (FAT32)
<span style="color:maroon">BIOSCODE:105C                 </span><span style="color:navy">cmp     cs:</span>new_genioctl<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:1062                 </span><span style="color:navy">jnz     short </span>sdp_3     ; new type (FAT32) structure
<span style="color:maroon">BIOSCODE:1064                 </span><span style="color:navy">mov     cx, [bx+</span><span style="color:#ff8000">26h</span><span style="color:navy">]    </span>; [bx+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES]
<span style="color:maroon">BIOSCODE:1064                                         </span>; offset 31+7 (A_BPB.size+7)
<span style="color:maroon">BIOSCODE:1067
BIOSCODE:1067 </span>sdp_3<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1067                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1068                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:106D                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:106D                 </span><span style="color:navy">mov     ds:</span>sectorspertrack<span style="color:navy">, cx
</span><span style="color:maroon">BIOSCODE:1071                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1072                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1072                 </span><span style="color:navy">and     word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">0FFF7h </span>; [es:di+BDS.flags], ~good_tracklayout
<span style="color:maroon">BIOSCODE:1077                 </span><span style="color:navy">test    byte ptr [bx], </span><span style="color:green">4 </span>; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS],
<span style="color:maroon">BIOSCODE:1077                                         </span>;  TRACKLAYOUT_IS_GOOD
<span style="color:maroon">BIOSCODE:107A                 </span><span style="color:navy">jz      short </span>UglyTrackLayOut
<span style="color:maroon">BIOSCODE:107C                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">8 </span>; [es:di+BDS.flags], good_tracklayout
<span style="color:maroon">BIOSCODE:1081
BIOSCODE:1081 </span>UglyTrackLayOut<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1081                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">63          </span>; MAX_SECTORS_IN_TRACK
<span style="color:maroon">BIOSCODE:1084                 </span><span style="color:navy">ja      short </span>TooManyPerTrack
<span style="color:maroon">BIOSCODE:1086                 </span><span style="color:navy">jcxz    short </span>SectorInfoSaved
<span style="color:maroon">BIOSCODE:1088                 </span><span style="color:navy">mov     di, offset </span>tracktable
<span style="color:maroon">BIOSCODE:108B                 </span><span style="color:navy">lea     si, [bx+</span><span style="color:#ff8000">5Eh</span><span style="color:navy">]    </span>; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
<span style="color:maroon">BIOSCODE:108B                                         </span>; offset 85+9 (A_BPB.size+9) (FAT32)
<span style="color:maroon">BIOSCODE:108E                 </span><span style="color:navy">cmp     cs:</span>new_genioctl<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:1094                 </span><span style="color:navy">jnz     short </span>sdp_4     ; new type (FAT32) structure
<span style="color:maroon">BIOSCODE:1096                 </span><span style="color:navy">lea     si, [bx+</span><span style="color:#ff8000">28h</span><span style="color:navy">]    </span>; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
<span style="color:maroon">BIOSCODE:1096                                         </span>; offset 31+9 (A_BPB.size+9)
<span style="color:maroon">BIOSCODE:1099
BIOSCODE:1099 </span>sdp_4<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1099                 </span><span style="color:navy">mov     es, cs:</span>Bios_Data_Word ; BIOSDATA segment
<span style="color:maroon">BIOSCODE:1099                                         </span>; Trash our bds pointer
<span style="color:maroon">BIOSCODE:109E                 </span>assume es:nothing
<span style="color:maroon">BIOSCODE:109E
BIOSCODE:109E </span>StoreSectorInfo<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:109E                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">BIOSCODE:109F                 </span><span style="color:navy">inc     di              </span>; Skip over cylinder and head
<span style="color:maroon">BIOSCODE:10A0                 </span><span style="color:navy">lodsw                   </span>; Get sector id
<span style="color:maroon">BIOSCODE:10A1                 </span><span style="color:navy">stosb                   </span>; Copy it
<span style="color:maroon">BIOSCODE:10A2                 </span><span style="color:navy">lodsw                   </span>; Get sector size
<span style="color:maroon">BIOSCODE:10A2                                         </span>;
<span style="color:maroon">BIOSCODE:10A2                                         </span>; SectSizeToSectIndex:
<span style="color:maroon">BIOSCODE:10A2                                         </span>;     Input:  ax contains sector size in bytes
<span style="color:maroon">BIOSCODE:10A2                                         </span>;     Output: al contains index
<span style="color:maroon">BIOSCODE:10A3                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2           </span>; &gt; 512 bytes per sector ?
<span style="color:maroon">BIOSCODE:10A6                 </span><span style="color:navy">ja      short </span>OneK      ; yes
<span style="color:maroon">BIOSCODE:10A8                 </span><span style="color:navy">mov     al, ah          </span>; set index to 2 or 1 (256 bps) or 0 (128 bps)
<span style="color:maroon">BIOSCODE:10AA                 </span><span style="color:navy">jmp     short </span>sdp_5
<span style="color:maroon">BIOSCODE:10AC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:10AC
BIOSCODE:10AC </span>OneK<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:10AC                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; 1024 bytes per sector
<span style="color:maroon">BIOSCODE:10AC                                         </span>; set index to 3
<span style="color:maroon">BIOSCODE:10AE
BIOSCODE:10AE </span>sdp_5<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:10AE                 </span><span style="color:navy">stosb
</span><span style="color:maroon">BIOSCODE:10AF                 </span><span style="color:navy">loop    </span>StoreSectorInfo
<span style="color:maroon">BIOSCODE:10B1
BIOSCODE:10B1 </span>SectorInfoSaved<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:10B1                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:10B2                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:10B3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:10B3
BIOSCODE:10B3 </span>TooManyPerTrack<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:10B3                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Ch
</span><span style="color:maroon">BIOSCODE:10B5                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSCODE:10B6                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:10B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:10B7
BIOSCODE:10B7 </span>FormatTrack<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:10B7                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:10BB                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:10BE                 </span><span style="color:navy">test    byte ptr [bx], </span><span style="color:green">1 </span>; bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS],
<span style="color:maroon">BIOSCODE:10BE                                         </span>;  STATUS_FOR_FORMAT
<span style="color:maroon">BIOSCODE:10C1                 </span><span style="color:navy">jz      short </span>DoFormatTrack
<span style="color:maroon">BIOSCODE:10C3                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:10C4                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:10C9                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:10C9                 </span><span style="color:navy">call    </span>SetMediaForFormat ; Also moves current Dpt to TempDpt
<span style="color:maroon">BIOSCODE:10CC                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:10CD                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:10CD                 </span><span style="color:navy">mov     [bx], al        </span>; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
<span style="color:maroon">BIOSCODE:10CF                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:10D0                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:10D1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:10D1
BIOSCODE:10D1 </span>DoFormatTrack<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:10D1                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], </span><span style="color:#ff8000">5 </span>; [es:di+BDS.formfactor], DEV_HARDDISK
<span style="color:maroon">BIOSCODE:10D6                 </span><span style="color:navy">jnz     short </span>DoFormatDiskette
<span style="color:maroon">BIOSCODE:10D8                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:10DD                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:10DD                 </span><span style="color:navy">jmp     </span>VerifyTrack
<span style="color:maroon">BIOSCODE:10E0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:10E0
BIOSCODE:10E0 </span>DoFormatDiskette<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:10E0                 </span><span style="color:navy">mov     cx, [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">]      </span>; [bx+A_FORMATPACKET.FP_HEAD]
<span style="color:maroon">BIOSCODE:10E3                 </span><span style="color:navy">mov     dx, [bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]      </span>; [bx+A_FORMATPACKET.FP_CYLINDER]
<span style="color:maroon">BIOSCODE:10E6                 </span><span style="color:navy">test    byte ptr [bx], </span><span style="color:green">2 </span>; [bx+A_FORMATPACKET.FP_SPECIALFUNCTIONS]
<span style="color:maroon">BIOSCODE:10E6                                         </span>;     FP_TRACKCOUNT is only meaningful
<span style="color:maroon">BIOSCODE:10E6                                         </span>;     when FP_SPECIALFUNCTIONS bit 1 = 1
<span style="color:maroon">BIOSCODE:10E9                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:10EE                 </span><span style="color:navy">jz      short </span>DoFormatDiskette_1
<span style="color:maroon">BIOSCODE:10F0                 </span><span style="color:navy">jmp     </span>VerifyTrack_Err
<span style="color:maroon">BIOSCODE:10F3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:10F3
BIOSCODE:10F3 </span>DoFormatDiskette_1<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:10F3                 </span><span style="color:navy">call    </span>SetMediaForFormat ; Also moves current Dpt to TempDpt
<span style="color:maroon">BIOSCODE:10F6                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:10F8                 </span><span style="color:navy">jz      short </span>NeedToSetDasd ; Old rom
<span style="color:maroon">BIOSCODE:10FA                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; Time out error?
<span style="color:maroon">BIOSCODE:10FC                 </span><span style="color:navy">jnz     short </span>NoSetDasd ; No,fine. (at this point, don&#039;t care
<span style="color:maroon">BIOSCODE:10FC                                         </span>; about the illegal combination)
<span style="color:maroon">BIOSCODE:10FE                 </span><span style="color:navy">jmp     short </span>FormatFailed
<span style="color:maroon">BIOSCODE:1100 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1100
BIOSCODE:1100 </span>NeedToSetDasd<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1100                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSCODE:1101                 </span><span style="color:navy">call    </span>SetDasd         ; INT 13h, ah=17h
<span style="color:maroon">BIOSCODE:1104                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSCODE:1105
BIOSCODE:1105 </span>NoSetDasd<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1105                 </span><span style="color:navy">call    </span>checksingle     ; Do any needed diskette swapping
<span style="color:maroon">BIOSCODE:1108                 </span><span style="color:navy">mov     ax, dx          </span>; Get track from packet
<span style="color:maroon">BIOSCODE:110A                 </span><span style="color:navy">mov     ds:</span>trknum<span style="color:navy">, ax
</span><span style="color:maroon">BIOSCODE:110D                 </span><span style="color:navy">mov     ds:</span>hdnum<span style="color:navy">, cl
</span><span style="color:maroon">BIOSCODE:1111                 </span><span style="color:navy">mov     ah, cl
</span><span style="color:maroon">BIOSCODE:1113                 </span><span style="color:navy">mov     bx, offset </span>tracktable
<span style="color:maroon">BIOSCODE:1116                 </span><span style="color:navy">mov     cx, ds:</span>sectorspertrack
<span style="color:maroon">BIOSCODE:111A                 </span><span style="color:navy">jcxz    short </span>set_fmt_retry_count
<span style="color:maroon">BIOSCODE:111C
BIOSCODE:111C </span>StoreCylinderHead<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:111C                 </span><span style="color:navy">mov     [bx], ax        </span>; Store into TrackTable
<span style="color:maroon">BIOSCODE:111E                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">4           </span>; Skip to next sector field
<span style="color:maroon">BIOSCODE:1121                 </span><span style="color:navy">loop    </span>StoreCylinderHead
<span style="color:maroon">BIOSCODE:1123
BIOSCODE:1123 </span>set_fmt_retry_count<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1123                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">5           </span>; MAXERR - Set up retry count
<span style="color:maroon">BIOSCODE:1125
BIOSCODE:1125 </span>FormatRetry<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1125                 </span><span style="color:navy">push    cx              </span>; Now verify the sectors just formatted.
<span style="color:maroon">BIOSCODE:1125                                         </span>; NOTE: because of bug in some BIOSes
<span style="color:maroon">BIOSCODE:1125                                         </span>;       we have to set ES:BX to 00:00
<span style="color:maroon">BIOSCODE:1126                 </span><span style="color:navy">mov     bx, offset </span>tracktable
<span style="color:maroon">BIOSCODE:1129                 </span><span style="color:navy">mov     al, byte ptr ds:</span>sectorspertrack
<span style="color:maroon">BIOSCODE:112C                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5           </span>; romformat
<span style="color:maroon">BIOSCODE:112E                 </span><span style="color:navy">mov     ds:</span>xfer_seg<span style="color:navy">, ds
</span><span style="color:maroon">BIOSCODE:1132                 </span><span style="color:navy">call    </span>ToRom
<span style="color:maroon">BIOSCODE:1135                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:1136                 </span><span style="color:navy">jb      short </span>FormatError
<span style="color:maroon">BIOSCODE:1138                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:1139                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:113A                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">BIOSCODE:113C                 </span><span style="color:navy">mov     ds:</span>xfer_seg<span style="color:navy">, bx
</span><span style="color:maroon">BIOSCODE:1140                 </span><span style="color:navy">mov     al, byte ptr ds:</span>sectorspertrack
<span style="color:maroon">BIOSCODE:1143                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">4           </span>; romverify
<span style="color:maroon">BIOSCODE:1145                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:1147                 </span><span style="color:navy">call    </span>ToRom
<span style="color:maroon">BIOSCODE:114A                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:114B                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:114C                 </span><span style="color:navy">jnb     short </span>FormatOk
<span style="color:maroon">BIOSCODE:114E
BIOSCODE:114E </span>FormatError<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:114E                 </span><span style="color:navy">call    </span>ResetDisk
<span style="color:maroon">BIOSCODE:1151                 </span><span style="color:navy">mov     ds:</span>had_format_error<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:1156                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSCODE:1157                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:1158                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSCODE:1159                 </span><span style="color:navy">call    </span>SetMediaForFormat
<span style="color:maroon">BIOSCODE:115C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:115E                 </span><span style="color:navy">jnz     short </span>WhileErr
<span style="color:maroon">BIOSCODE:1160                 </span><span style="color:navy">call    </span>SetDasd
<span style="color:maroon">BIOSCODE:1163
BIOSCODE:1163 </span>WhileErr<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1163                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSCODE:1164                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:1165                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSCODE:1166                 </span><span style="color:navy">loop    </span>FormatRetry
<span style="color:maroon">BIOSCODE:1168
BIOSCODE:1168 </span>FormatFailed<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1168                 </span><span style="color:navy">mov     ds:</span>had_format_error<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; Set the format error flag
<span style="color:maroon">BIOSCODE:116D                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">6           </span>; DSK_CHANGELINE_ERR
<span style="color:maroon">BIOSCODE:116D                                         </span>; convert change line error to time out error
<span style="color:maroon">BIOSCODE:1170                 </span><span style="color:navy">jnz     short </span>DoMapIt
<span style="color:maroon">BIOSCODE:1172                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">80h         </span>; DSK_TIMEOUT_ERR
<span style="color:maroon">BIOSCODE:1174
BIOSCODE:1174 </span>DoMapIt<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1174                 </span><span style="color:navy">jmp     </span>maperror
<span style="color:maroon">BIOSCODE:1177 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1177
BIOSCODE:1177 </span>FormatOk<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1177                 </span><span style="color:navy">mov     ds:</span>had_format_error<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset the format error flag
<span style="color:maroon">BIOSCODE:117C                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:117D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:117D
BIOSCODE:117D </span>VerifyTrack<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:117D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:117E                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav   ; ds:bx points to request header.
<span style="color:maroon">BIOSCODE:1182                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1182                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:1185                 </span><span style="color:navy">mov     cx, [bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]      </span>; [bx+A_VERIFYPACKET.VP_CYLINDER]
<span style="color:maroon">BIOSCODE:1188                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">]      </span>; [bx+A_VERIFYPACKET.VP_HEAD]
<span style="color:maroon">BIOSCODE:118B                 </span><span style="color:navy">mov     dx, [bx+</span><span style="color:#ff8000">5</span><span style="color:navy">]      </span>; [bx+A_FORMATPACKET.FP_TRACKCOUNT]
<span style="color:maroon">BIOSCODE:118E                 </span><span style="color:navy">mov     bl, [bx]        </span>; [bx+A_FORMATPACKET.FP_SPECIALFUNCTIONS]
<span style="color:maroon">BIOSCODE:1190                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1191                 </span><span style="color:navy">mov     ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">4     </span>; romverify
<span style="color:maroon">BIOSCODE:1196                 </span><span style="color:navy">mov     ds:</span>curtrk<span style="color:navy">, cx
</span><span style="color:maroon">BIOSCODE:119A                 </span><span style="color:navy">mov     ds:</span>curhd<span style="color:navy">, al    </span>; assume heads &lt; 256
<span style="color:maroon">BIOSCODE:119D                 </span><span style="color:navy">mov     cx, ds:</span>sectorspertrack
<span style="color:maroon">BIOSCODE:11A1                 </span><span style="color:navy">test    bl, </span><span style="color:green">2           </span>; DO_FAST_FORMAT
<span style="color:maroon">BIOSCODE:11A4                 </span><span style="color:navy">jz      short </span>NormVerifyTrack
<span style="color:maroon">BIOSCODE:11A6                 </span><span style="color:navy">mov     ax, dx          </span>; Get ax = number of trks to verify
<span style="color:maroon">BIOSCODE:11A8                 </span><span style="color:navy">or      ah, ah
</span><span style="color:maroon">BIOSCODE:11AA                 </span><span style="color:navy">jnz     short </span>VerifyTrack_Err ; #tracks &gt; 255
<span style="color:maroon">BIOSCODE:11AC                 </span><span style="color:navy">mul     cl
</span><span style="color:maroon">BIOSCODE:11AE                 </span><span style="color:navy">or      ah, ah
</span><span style="color:maroon">BIOSCODE:11B0                 </span><span style="color:navy">jnz     short </span>VerifyTrack_Err
<span style="color:maroon">BIOSCODE:11B2                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">BIOSCODE:11B4                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:maroon">BIOSCODE:11BA                 </span><span style="color:navy">jz      short </span>NormVerifyTrack
<span style="color:maroon">BIOSCODE:11BC                 </span><span style="color:navy">test    ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:green">80h </span>; MULTI_TRK_ON
<span style="color:maroon">BIOSCODE:11C2                 </span><span style="color:navy">jz      short </span>NormVerifyTrack
<span style="color:maroon">BIOSCODE:11C4                 </span><span style="color:navy">mov     ds:</span>multitrk_format_flag<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:11C9
BIOSCODE:11C9 </span>NormVerifyTrack<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:11C9                 </span><span style="color:navy">xor     ax, ax          </span>; 1st sector
<span style="color:maroon">BIOSCODE:11CB                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">BIOSCODE:11CD                 </span><span style="color:navy">mov     ds:</span>xfer_seg<span style="color:navy">, bx </span>; Use 0:0 as the transfer address for verify
<span style="color:maroon">BIOSCODE:11D1                 </span><span style="color:navy">call    </span>TrackIo
<span style="color:maroon">BIOSCODE:11D4                 </span><span style="color:navy">mov     ds:</span>multitrk_format_flag<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:11D9                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:11DA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:11DA
BIOSCODE:11DA </span>VerifyTrack_Err<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:11DA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:11DC                 </span><span style="color:navy">jmp     </span>maperror
<span style="color:maroon">BIOSCODE:11DF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:11DF
BIOSCODE:11DF </span>ReadTrack<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:11DF                 </span><span style="color:navy">mov     ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">2     </span>; romread
<span style="color:maroon">BIOSCODE:11E4                 </span><span style="color:navy">jmp     short </span>ReadWriteTrack
<span style="color:maroon">BIOSCODE:11E6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:11E6
BIOSCODE:11E6 </span>WriteTrack<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:11E6                 </span><span style="color:navy">mov     ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">3
</span><span style="color:maroon">BIOSCODE:11EB
BIOSCODE:11EB </span>ReadWriteTrack<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:11EB                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:11EC                 </span><span style="color:navy">les     bx, ds:</span>ptrsav   ; es:bx -&gt; to request header
<span style="color:maroon">BIOSCODE:11F0                 </span>assume es:nothing
<span style="color:maroon">BIOSCODE:11F0                 </span><span style="color:navy">les     bx, es:[bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:11F4                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [es:bx+A_TRACKREADWRITEPACKET.TRWP_CYLINDER]
<span style="color:maroon">BIOSCODE:11F8                 </span><span style="color:navy">mov     ds:</span>curtrk<span style="color:navy">, ax
</span><span style="color:maroon">BIOSCODE:11FB                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [es:bx+A_TRACKREADWRITEPACKET.TRWP_HEAD]
<span style="color:maroon">BIOSCODE:11FF                 </span><span style="color:navy">mov     ds:</span>curhd<span style="color:navy">, al    </span>; Assume heads &lt; 256 !
<span style="color:maroon">BIOSCODE:1202                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:bx+A_TRACKREADWRITEPACKET.TRWP_FIRSTSECTOR]
<span style="color:maroon">BIOSCODE:1206                 </span><span style="color:navy">mov     cx, es:[bx+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [es:bx+A_TRACKREADWRITEPACKET.TRWP_SECTORSTOREADWRITE]
<span style="color:maroon">BIOSCODE:120A                 </span><span style="color:navy">les     bx, es:[bx+</span><span style="color:#ff8000">9</span><span style="color:navy">]   </span>; [es:bx+A_TRACKREADWRITEPACKET.TRWP_TRANSFERADDRESS]
<span style="color:maroon">BIOSCODE:120A                                         </span>; Get transfer address
<span style="color:maroon">BIOSCODE:120E                 </span><span style="color:navy">mov     ds:</span>xfer_seg<span style="color:navy">, es </span>; Pass transfer segment
<span style="color:maroon">BIOSCODE:1212                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1213
BIOSCODE:1213 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1213
BIOSCODE:1213
BIOSCODE:1213 </span>TrackIo         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1213                 </span><span style="color:navy">mov     ds:</span>spsav<span style="color:navy">, sp    </span>; performs track read/write/verify
<span style="color:black">BIOSCODE:1213                                         </span>;
<span style="color:black">BIOSCODE:1213                                         </span>;  input:
<span style="color:black">BIOSCODE:1213                                         </span>;   rFlag - 2 = read
<span style="color:black">BIOSCODE:1213                                         </span>;           3 = write
<span style="color:black">BIOSCODE:1213                                         </span>;           4 = verify
<span style="color:black">BIOSCODE:1213                                         </span>;   ax - Index into track table of first sector to io
<span style="color:black">BIOSCODE:1213                                         </span>;   cx - Number of sectors to io
<span style="color:black">BIOSCODE:1213                                         </span>;   Xfer_Seg:bx - Transfer address
<span style="color:black">BIOSCODE:1213                                         </span>;   es:di - Pointer to bds
<span style="color:black">BIOSCODE:1213                                         </span>;   CurTrk - Current cylinder
<span style="color:black">BIOSCODE:1213                                         </span>;   CurHd - Current head
<span style="color:black">BIOSCODE:1217                 </span><span style="color:navy">call    </span>checksingle
<span style="color:black">BIOSCODE:121A                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; See if we have already set disk
<span style="color:black">BIOSCODE:121F                 </span><span style="color:navy">jz      short </span><span style="color:gray">Dptalreadyset
</span><span style="color:black">BIOSCODE:1221                 </span><span style="color:navy">push    ax              </span>; set up tables and variables for i/o
<span style="color:black">BIOSCODE:1222                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:1223                 </span><span style="color:navy">call    </span>iosetup
<span style="color:black">BIOSCODE:1226                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:1227                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1228
BIOSCODE:1228 </span><span style="color:gray">Dptalreadyset</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1228                 </span><span style="color:navy">mov     si, offset </span>tracktable ; Point si at the table entry of the
<span style="color:black">BIOSCODE:1228                                         </span>; first sector to be io&#039;d
<span style="color:black">BIOSCODE:122B                 </span><span style="color:navy">add     ax, ax
</span><span style="color:black">BIOSCODE:122D                 </span><span style="color:navy">add     ax, ax
</span><span style="color:black">BIOSCODE:122F                 </span><span style="color:navy">add     si, ax
</span><span style="color:black">BIOSCODE:1231                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:1234                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">8 </span>; [es:di+BDS.flags], good_tracklayout
<span style="color:black">BIOSCODE:123A                 </span><span style="color:navy">jz      short </span><span style="color:gray">ionextsector
</span><span style="color:black">BIOSCODE:123C                 </span><span style="color:navy">xchg    dx, cx          </span>; We can read all secs in one blow
<span style="color:black">BIOSCODE:123E
BIOSCODE:123E </span><span style="color:gray">ionextsector</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:123E                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:123F                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:1240                 </span><span style="color:navy">inc     si
</span><span style="color:black">BIOSCODE:1241                 </span><span style="color:navy">inc     si              </span>; Skip over the cylinder and head in
<span style="color:black">BIOSCODE:1241                                         </span>; the track table
<span style="color:black">BIOSCODE:1242                 </span><span style="color:navy">lodsb                   </span>; Get sector ID from track table
<span style="color:black">BIOSCODE:1243                 </span><span style="color:navy">mov     ds:</span>cursec<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:1246                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:black">BIOSCODE:1246                                         </span>; Fixed disk?
<span style="color:black">BIOSCODE:124C                 </span><span style="color:navy">jz      short </span><span style="color:gray">IoRemovable </span>; No
<span style="color:black">BIOSCODE:124E                 </span><span style="color:navy">test    ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:green">80h </span>; MULTI_TRK_ON
<span style="color:black">BIOSCODE:1254                 </span><span style="color:navy">jz      short </span><span style="color:gray">IoRemovable </span>; No,don&#039;t do that.
<span style="color:black">BIOSCODE:1256                 </span><span style="color:navy">mov     ds:</span>seccnt<span style="color:navy">, dx
</span><span style="color:black">BIOSCODE:125A                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">BIOSCODE:125C                 </span><span style="color:navy">call    </span>disk
<span style="color:black">BIOSCODE:125F                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1260                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:1261                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:1262                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1263 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1263
BIOSCODE:1263 </span><span style="color:gray">IoRemovable</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1263                 </span><span style="color:navy">lodsb                   </span>; Get sector size index from track
<span style="color:black">BIOSCODE:1263                                         </span>; table and save it
<span style="color:black">BIOSCODE:1264                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1265                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSCODE:1266                 </span><span style="color:navy">push    ds              </span>; Save BIOSDATA
<span style="color:black">BIOSCODE:1267                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1268                 </span><span style="color:navy">mov     ah, ds:</span>eot      ; Preserve whatever might be in ah
<span style="color:black">BIOSCODE:1268                                         </span>; Fetch EOT while ds-&gt; BIOSDATA
<span style="color:black">BIOSCODE:126C                 </span><span style="color:navy">lds     si, ds:</span>dpt
<span style="color:black">BIOSCODE:1270                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">3</span><span style="color:navy">], al      </span>; [si+DISK_PARMS.DISK_SECTOR_SIZ]
<span style="color:black">BIOSCODE:1273                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ah      </span>; [si+DISK_PARMS.DISK_EOT]
<span style="color:black">BIOSCODE:1276                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1277                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:1278                 </span><span style="color:navy">mov     al, dl
</span><span style="color:black">BIOSCODE:127A                 </span><span style="color:navy">mov     ds:</span>seccnt<span style="color:navy">, ax
</span><span style="color:black">BIOSCODE:127D                 </span><span style="color:navy">call    </span>disk
<span style="color:black">BIOSCODE:1280                 </span><span style="color:navy">pop     si              </span>; Advance buffer pointer by adding
<span style="color:black">BIOSCODE:1280                                         </span>; sector size
<span style="color:black">BIOSCODE:1281                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1282                 </span><span style="color:navy">mov     cl, al          </span>; SectorSizeIndexToSectorSize
<span style="color:black">BIOSCODE:1284                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">80h
</span><span style="color:black">BIOSCODE:1287                 </span><span style="color:navy">shl     ax, cl
</span><span style="color:black">BIOSCODE:1289                 </span><span style="color:navy">add     bx, ax
</span><span style="color:black">BIOSCODE:128B                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:128C                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:128D                 </span><span style="color:navy">loop    </span><span style="color:gray">ionextsector
</span><span style="color:black">BIOSCODE:128F                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:1294                 </span><span style="color:navy">jz      short </span><span style="color:gray">NoNeedDone
</span><span style="color:black">BIOSCODE:1296                 </span><span style="color:navy">call    </span>done            ; set time of last access, and reset
<span style="color:black">BIOSCODE:1296                                         </span>; entries in Dpt.
<span style="color:black">BIOSCODE:1299
BIOSCODE:1299 </span><span style="color:gray">NoNeedDone</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1299                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:129A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:129A </span>TrackIo         <span style="color:black">endp
BIOSCODE:129A
BIOSCODE:129B
BIOSCODE:129B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:129B
BIOSCODE:129B
BIOSCODE:129B </span>SetDasd         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:129B                 </span><span style="color:navy">cmp     ds:</span>had_format_error<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; See if we&#039;ve previously set dasd type
<span style="color:black">BIOSCODE:12A0                 </span><span style="color:navy">jz      short </span><span style="color:gray">DoSetDasd
</span><span style="color:black">BIOSCODE:12A2                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">80h </span>; [es:di+BDS.flags], set_dasd_true
<span style="color:black">BIOSCODE:12A8                 </span><span style="color:navy">jz      short </span><span style="color:gray">DasdHasBeenSet
</span><span style="color:black">BIOSCODE:12AA                 </span><span style="color:navy">and     word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">0FF7Fh </span>; [es:di+BDS.flags], ~set_dasd_true
<span style="color:black">BIOSCODE:12B0
BIOSCODE:12B0 </span><span style="color:gray">DoSetDasd</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:12B0                 </span><span style="color:navy">mov     ds:</span>had_format_error<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Reset it
<span style="color:black">BIOSCODE:12B5                 </span><span style="color:navy">mov     ds:</span>gap_patch<span style="color:navy">, </span><span style="color:green">50h </span>; Format gap for 48tpi disks
<span style="color:black">BIOSCODE:12BA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4
</span><span style="color:black">BIOSCODE:12BC                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">] </span>; [es:di+BDS.formfactor]
<span style="color:black">BIOSCODE:12C0                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2           </span>; DEV_3INCH720KB
<span style="color:black">BIOSCODE:12C3                 </span><span style="color:navy">jz      short </span><span style="color:gray">DoSet
</span><span style="color:black">BIOSCODE:12C5                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">1           </span>; DEV_5INCH96TPI
<span style="color:black">BIOSCODE:12C8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:12CA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DoSet
</span><span style="color:black">BIOSCODE:12CC                 </span><span style="color:navy">inc     ax              </span>; mov al, 2
<span style="color:black">BIOSCODE:12CC                                         </span>; 160/320k in a 1.2 meg drive
<span style="color:black">BIOSCODE:12CD                 </span><span style="color:navy">cmp     ds:</span>mediatype<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:12D2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DoSet
</span><span style="color:black">BIOSCODE:12D4                 </span><span style="color:navy">inc     ax              </span>; mov al, 3
<span style="color:black">BIOSCODE:12D4                                         </span>; 1.2meg in a 1.2meg drive
<span style="color:black">BIOSCODE:12D5                 </span><span style="color:navy">mov     ds:</span>gap_patch<span style="color:navy">, </span><span style="color:green">54h </span>; Format gap for 96 tpi, 1.2MB diskette
<span style="color:black">BIOSCODE:12DA
BIOSCODE:12DA </span><span style="color:gray">DoSet</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:12DA                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:12DB                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSCODE:12DC                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:12DE                 </span><span style="color:navy">mov     ds, si          </span>; 0
<span style="color:black">BIOSCODE:12E0                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:12E0                 </span><span style="color:navy">lds     si, </span>dword ptr ds:78h ; [DSKADR] (Int 1Eh)
<span style="color:black">BIOSCODE:12E4                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:12E4                 </span><span style="color:navy">mov     byte ptr [si+</span><span style="color:#ff8000">9</span><span style="color:navy">], </span><span style="color:#ff8000">0Fh </span>; [si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:12E8                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSCODE:12E9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:12EA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">17h
</span><span style="color:black">BIOSCODE:12EC                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">BIOSCODE:12F0                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - SET TYPE (AT,XT2,XT286,CONV,PS
<span style="color:black">BIOSCODE:12F0                                         </span>; AL = disk type
<span style="color:black">BIOSCODE:12F2
BIOSCODE:12F2 </span><span style="color:gray">DasdHasBeenSet</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:12F2                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:12F6                 </span><span style="color:navy">mov     ds:</span>formt_eot<span style="color:navy">, ah
</span><span style="color:black">BIOSCODE:12FA                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:12FA </span>SetDasd         <span style="color:black">endp
BIOSCODE:12FA
BIOSCODE:12FB
BIOSCODE:12FB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:12FB
BIOSCODE:12FB
BIOSCODE:12FB </span>SetMediaForFormat <span style="color:black">proc near             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:12FB                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:12FC                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:12FD                 </span><span style="color:navy">cmp     ds:</span>had_format_error<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:1302                 </span><span style="color:navy">jz      short </span><span style="color:gray">SkipSaveDskAdr
</span><span style="color:black">BIOSCODE:1304                 </span><span style="color:navy">xor     al, al          </span>; If already done return 0
<span style="color:black">BIOSCODE:1306                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:130B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DoSetMediaForFormat
</span><span style="color:black">BIOSCODE:130D                 </span><span style="color:navy">jmp     </span><span style="color:gray">SetMediaRet     </span>; Media already set
<span style="color:black">BIOSCODE:1310 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1310
BIOSCODE:1310 </span><span style="color:gray">DoSetMediaForFormat</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1310                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:1311                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSCODE:1312                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:1314                 </span><span style="color:navy">mov     es, si          </span>; 0 ; Point to interrupt vectors
<span style="color:black">BIOSCODE:1316                 </span>assume es:nothing
<span style="color:black">BIOSCODE:1316                 </span><span style="color:navy">les     si, </span>dword ptr es:78h ; [es:DSKADR]
<span style="color:black">BIOSCODE:1316                                         </span>; Get pointer to disk base table
<span style="color:black">BIOSCODE:131B                 </span>assume es:nothing
<span style="color:black">BIOSCODE:131B                 </span><span style="color:navy">mov     word ptr ds:</span>dpt<span style="color:navy">, si
</span><span style="color:black">BIOSCODE:131F                 </span><span style="color:navy">mov     word ptr ds:</span>dpt<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">BIOSCODE:1323                 </span><span style="color:navy">mov     byte ptr es:[si+</span><span style="color:#ff8000">9</span><span style="color:navy">], </span><span style="color:#ff8000">0Fh </span>; [es:si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:1328                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSCODE:1329                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:132A
BIOSCODE:132A </span><span style="color:gray">SkipSaveDskAdr</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:132A                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">41h</span><span style="color:navy">] </span>; [es:di+BDS.cylinders]
<span style="color:black">BIOSCODE:132E                 </span><span style="color:navy">dec     cx
</span><span style="color:black">BIOSCODE:132F                 </span><span style="color:navy">and     ch, </span><span style="color:green">3
</span><span style="color:black">BIOSCODE:1332                 </span><span style="color:navy">ror     ch, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:1334                 </span><span style="color:navy">ror     ch, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:1336                 </span><span style="color:navy">xchg    ch, cl
</span><span style="color:black">BIOSCODE:1338                 </span><span style="color:navy">or      cl, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:133C                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1340                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:1341                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:1342                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSCODE:1343                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:1344                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">18h
</span><span style="color:black">BIOSCODE:1346                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - SET MEDIA TYPE FOR FORMAT (AT model 3x9,XT2,XT286,PS)
<span style="color:black">BIOSCODE:1346                                         </span>; DL = drive number, CH = lower 8 bits of number of tracks,
<span style="color:black">BIOSCODE:1346                                         </span>; CL = sectors per track
<span style="color:black">BIOSCODE:1348                 </span><span style="color:navy">jb      short </span><span style="color:gray">FormaStatErr
</span><span style="color:black">BIOSCODE:134A                 </span><span style="color:navy">cmp     ds:</span>had_format_error<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:134F                 </span><span style="color:navy">jz      short </span><span style="color:gray">skip_disk_base_setting
</span><span style="color:black">BIOSCODE:1351                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:1352                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:1354                 </span><span style="color:navy">mov     es, si
</span><span style="color:black">BIOSCODE:1356                 </span>assume es:nothing
<span style="color:black">BIOSCODE:1356                 </span><span style="color:navy">les     si, </span>dword ptr es:78h ; [es:DSKADR] (Int 1Eh)
<span style="color:black">BIOSCODE:1356                                         </span>; Get current disk base table
<span style="color:black">BIOSCODE:135B                 </span>assume es:nothing
<span style="color:black">BIOSCODE:135B                 </span><span style="color:navy">mov     word ptr ds:</span>tempdpt<span style="color:navy">, si
</span><span style="color:black">BIOSCODE:135F                 </span><span style="color:navy">mov     word ptr ds:</span>tempdpt<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es </span>; Save it
<span style="color:black">BIOSCODE:1363                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:1365                 </span><span style="color:navy">mov     es, si          </span>; 0
<span style="color:black">BIOSCODE:1367                 </span>assume es:nothing
<span style="color:black">BIOSCODE:1367                 </span><span style="color:navy">mov     </span>word ptr es:78h<span style="color:navy">, di </span>; replace with one returned by rom
<span style="color:black">BIOSCODE:136C                 </span><span style="color:navy">pop     </span>word ptr es:78h+2
<span style="color:black">BIOSCODE:1371                 </span><span style="color:navy">mov     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:1376
BIOSCODE:1376 </span><span style="color:gray">skip_disk_base_setting</span><span style="color:navy">:                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1376                 </span><span style="color:navy">xor     al, al          </span>; Legal combination + rom support code
<span style="color:black">BIOSCODE:1378                 </span><span style="color:navy">mov     ds:</span>had_format_error<span style="color:navy">, al </span>; Reset the flag
<span style="color:black">BIOSCODE:137B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">PopStatRet
</span><span style="color:black">BIOSCODE:137D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:137D
BIOSCODE:137D </span><span style="color:gray">FormaStatErr</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:137D                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0Ch         </span>; DSK_ILLEGAL_COMBINATION
<span style="color:black">BIOSCODE:137D                                         </span>; Illegal combination = 0Ch
<span style="color:black">BIOSCODE:1380                 </span><span style="color:navy">jz      short </span><span style="color:gray">FormatStatIllegalComb
</span><span style="color:black">BIOSCODE:1382                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">80h         </span>; DSK_TIMEOUT_ERR
<span style="color:black">BIOSCODE:1385                 </span><span style="color:navy">jz      short </span><span style="color:gray">FormatStatTimeOut
</span><span style="color:black">BIOSCODE:1387                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; Function not supported.
<span style="color:black">BIOSCODE:1389                 </span><span style="color:navy">jmp     short </span><span style="color:gray">PopStatRet
</span><span style="color:black">BIOSCODE:138B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:138B
BIOSCODE:138B </span><span style="color:gray">FormatStatIllegalComb</span><span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:138B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; Function supported, but
<span style="color:black">BIOSCODE:138B                                         </span>; Illegal sect/trk,trk combination.
<span style="color:black">BIOSCODE:138D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">PopStatRet
</span><span style="color:black">BIOSCODE:138F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:138F
BIOSCODE:138F </span><span style="color:gray">FormatStatTimeOut</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:138F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; Function supported, but
<span style="color:black">BIOSCODE:138F                                         </span>; Media not present
<span style="color:black">BIOSCODE:1391
BIOSCODE:1391 </span><span style="color:gray">PopStatRet</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1391                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:1392                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSCODE:1393                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:1394                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1395                 </span>assume es:nothing
<span style="color:black">BIOSCODE:1395
BIOSCODE:1395 </span><span style="color:gray">SetMediaRet</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1395                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1396                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:1397                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1397 </span>SetMediaForFormat <span style="color:black">endp
BIOSCODE:1397
BIOSCODE:1398
BIOSCODE:1398 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1398
BIOSCODE:1398
BIOSCODE:1398 </span>ResetDisk       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1398                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1399                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1           </span>; Reset while formatting?
<span style="color:black">BIOSCODE:139C                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:13A0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ResetDisk_cont
</span><span style="color:black">BIOSCODE:13A2                 </span><span style="color:navy">mov     ds:</span>had_format_error<span style="color:navy">, al </span>; Then verify operation in &quot;fmt &amp; vrfy&quot;
<span style="color:black">BIOSCODE:13A2                                         </span>; Might have failed.
<span style="color:black">BIOSCODE:13A2                                         </span>; So signals that we had a format error.
<span style="color:black">BIOSCODE:13A5
BIOSCODE:13A5 </span><span style="color:gray">ResetDisk_cont</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:13A5                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - RESET DISK SYSTEM
<span style="color:black">BIOSCODE:13A5                                         </span>; DL = drive (if bit 7 is set both hard disks and floppy disks reset)
<span style="color:black">BIOSCODE:13A7                 </span><span style="color:navy">mov     ds:</span>step_drv<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:black">BIOSCODE:13A7                                         </span>; Zap up the speed
<span style="color:black">BIOSCODE:13AC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:13AD                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:13AD </span>ResetDisk       <span style="color:black">endp
BIOSCODE:13AD
BIOSCODE:13AE
BIOSCODE:13AE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:13AE
BIOSCODE:13AE
BIOSCODE:13AE </span>ToRom           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:13AE                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:13AF                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSCODE:13B0                 </span><span style="color:navy">test    ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:13B5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GotValidDpt
</span><span style="color:black">BIOSCODE:13B7                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:13B8                 </span><span style="color:navy">push    es              </span>; Save bds segment
<span style="color:black">BIOSCODE:13B9                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:di+BDS.formfactor], ffSmall
<span style="color:black">BIOSCODE:13B9                                         </span>; is it a 3.5&quot; drive?
<span style="color:black">BIOSCODE:13BE                 </span><span style="color:navy">mov     es, ds:</span>zeroseg  ; 0
<span style="color:black">BIOSCODE:13C2                 </span>assume es:nothing
<span style="color:black">BIOSCODE:13C2                 </span><span style="color:navy">les     si, </span>dword ptr es:78h ; Get pointer to disk base table
<span style="color:black">BIOSCODE:13C7                 </span>assume es:nothing
<span style="color:black">BIOSCODE:13C7                 </span><span style="color:navy">mov     word ptr ds:</span>dpt<span style="color:navy">, si </span>; Save pointer to table
<span style="color:black">BIOSCODE:13CB                 </span><span style="color:navy">mov     word ptr ds:</span>dpt<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">BIOSCODE:13CF                 </span><span style="color:navy">mov     al, ds:</span>formt_eot
<span style="color:black">BIOSCODE:13D2                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">4</span><span style="color:navy">], al   </span>; [es:si+DISK_PARMS.DISK_EOT]
<span style="color:black">BIOSCODE:13D6                 </span><span style="color:navy">mov     al, ds:</span>gap_patch
<span style="color:black">BIOSCODE:13D9                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">7</span><span style="color:navy">], al   </span>; [es:si+DISK_PARMS.DISK_FORMT_GAP]
<span style="color:black">BIOSCODE:13D9                                         </span>; Important for format
<span style="color:black">BIOSCODE:13DD                 </span><span style="color:navy">mov     byte ptr es:[si+</span><span style="color:#ff8000">9</span><span style="color:navy">], </span><span style="color:green">0Fh </span>; [es:si+DISK_PARMS.DISK_HEAD_STTL]
<span style="color:black">BIOSCODE:13DD                                         </span>; Assume we are doing a seek operation
<span style="color:black">BIOSCODE:13DD                                         </span>; Setup motor start correctly for 3.5&quot; drives
<span style="color:black">BIOSCODE:13E2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">MotorStrtOK
</span><span style="color:black">BIOSCODE:13E4                 </span><span style="color:navy">mov     byte ptr es:[si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], </span><span style="color:#ff8000">4 </span>; [es:si+DISK_PARMS.DISK_MOTOR_STRT]
<span style="color:black">BIOSCODE:13E9
BIOSCODE:13E9 </span><span style="color:gray">MotorStrtOK</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:13E9                 </span><span style="color:navy">pop     es              </span>; Restore bds segment
<span style="color:black">BIOSCODE:13EA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:13EB
BIOSCODE:13EB </span><span style="color:gray">GotValidDpt</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:13EB                 </span><span style="color:navy">mov     dx, ds:</span>trknum   ; Set track number
<span style="color:black">BIOSCODE:13EF                 </span><span style="color:navy">mov     ch, dl          </span>; Set low 8 bits in ch
<span style="color:black">BIOSCODE:13F1                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; Set drive number
<span style="color:black">BIOSCODE:13F5                 </span><span style="color:navy">mov     dh, ds:</span>hdnum    ; Set head number
<span style="color:black">BIOSCODE:13F9                 </span><span style="color:navy">push    es              </span>; Save bds segment
<span style="color:black">BIOSCODE:13FA                 </span><span style="color:navy">mov     es, ds:</span>xfer_seg
<span style="color:black">BIOSCODE:13FE                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK -
<span style="color:black">BIOSCODE:1400                 </span><span style="color:navy">pop     es              </span>; Restore bds segment
<span style="color:black">BIOSCODE:1401                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSCODE:1402                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:1403                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1403 </span>ToRom           <span style="color:black">endp
BIOSCODE:1403
BIOSCODE:1404
BIOSCODE:1404 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1404
BIOSCODE:1404
BIOSCODE:1404 </span>ioctl_getown    <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:1404                 </span><span style="color:navy">call    </span>SetDrive
<span style="color:black">BIOSCODE:1407                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1407                                         </span>; Get physical drive number
<span style="color:black">BIOSCODE:140B                 </span><span style="color:navy">les     di, dword ptr ds:</span>start_bds ; Get start of bds chain
<span style="color:black">BIOSCODE:140F
BIOSCODE:140F </span>ownloop<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:140F                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1413                 </span><span style="color:navy">jnz     short </span>getnextBDS
<span style="color:black">BIOSCODE:1415                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">20h </span>; [es:di+BDS.flags], fi_own_physical
<span style="color:black">BIOSCODE:141B                 </span><span style="color:navy">jnz     short </span>exitown
<span style="color:black">BIOSCODE:141D
BIOSCODE:141D </span>getnextBDS<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:141D                 </span><span style="color:navy">les     di, es:[di]     </span>; [es:di+BDS.link]
<span style="color:black">BIOSCODE:1420                 </span><span style="color:navy">jmp     short </span>ownloop
<span style="color:black">BIOSCODE:1422 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1422
BIOSCODE:1422 </span>ioctl_setown<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:1422                 </span><span style="color:navy">call    </span>SetDrive
<span style="color:black">BIOSCODE:1425                 </span><span style="color:navy">mov     ds:</span>fsetowner<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; set flag for CheckSingle to look at.
<span style="color:black">BIOSCODE:142A                 </span><span style="color:navy">call    </span>checksingle
<span style="color:black">BIOSCODE:142D                 </span><span style="color:navy">dec     ds:</span>fsetowner    ; 0 ; set ownership of drive reset flag
<span style="color:black">BIOSCODE:1431
BIOSCODE:1431 </span>exitown<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1431                 </span><span style="color:navy">xor     cl, cl
</span><span style="color:black">BIOSCODE:1433                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">10h </span>; [es:di+BDS.flags], fi_am_mult
<span style="color:black">BIOSCODE:1439                 </span><span style="color:navy">jz      short </span><span style="color:gray">ExitNoMult
</span><span style="color:black">BIOSCODE:143B                 </span><span style="color:navy">mov     cl, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:di+BDS.drivelet]
<span style="color:black">BIOSCODE:143B                                         </span>; Get logical drive number
<span style="color:black">BIOSCODE:143F                 </span><span style="color:navy">inc     cx              </span>; Get it 1-based
<span style="color:black">BIOSCODE:1440
BIOSCODE:1440 </span><span style="color:gray">ExitNoMult</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1440                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav
<span style="color:black">BIOSCODE:1444                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">], cl      </span>; [bx+unit]
<span style="color:black">BIOSCODE:1444                                         </span>; Exit normal termination
<span style="color:black">BIOSCODE:1447                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:1448                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1448 </span>ioctl_getown    <span style="color:black">endp
BIOSCODE:1448
BIOSCODE:1449
BIOSCODE:1449 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1449
BIOSCODE:1449
BIOSCODE:1449 </span>RestoreOldDpt   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1449                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:144A                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">BIOSCODE:144C                 </span><span style="color:navy">mov     ds:</span>had_format_error<span style="color:navy">, al </span>; Reset flag and
<span style="color:black">BIOSCODE:144F                 </span><span style="color:navy">xchg    al, ds:</span>media_set_for_format ; get current flag setting
<span style="color:black">BIOSCODE:1453                 </span><span style="color:navy">or      al, al
</span><span style="color:black">BIOSCODE:1455                 </span><span style="color:navy">jz      short </span><span style="color:gray">DontRestore
</span><span style="color:black">BIOSCODE:1457                 </span><span style="color:navy">push    si
</span><span style="color:black">BIOSCODE:1458                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:1459                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:145A                 </span><span style="color:navy">lds     si, ds:</span>tempdpt
<span style="color:black">BIOSCODE:145E                 </span><span style="color:navy">mov     es, cs:</span>Bios_Data_Word
<span style="color:black">BIOSCODE:1463                 </span>assume es:nothing
<span style="color:black">BIOSCODE:1463                 </span><span style="color:navy">mov     es, es:</span>zeroseg  ; es = 0
<span style="color:black">BIOSCODE:1468                 </span>assume es:nothing
<span style="color:black">BIOSCODE:1468                 </span><span style="color:navy">mov     </span>word ptr es:78h<span style="color:navy">, si </span>; [es:DSKADR] (Int 1Eh)
<span style="color:black">BIOSCODE:146D                 </span><span style="color:navy">mov     </span>word ptr es:78h+2<span style="color:navy">, ds </span>; [es:DSKADR+2]
<span style="color:black">BIOSCODE:1472                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1473                 </span>assume es:nothing
<span style="color:black">BIOSCODE:1473                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:1474                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSCODE:1475
BIOSCODE:1475 </span><span style="color:gray">DontRestore</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1475                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1476                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:1477                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1477 </span>RestoreOldDpt   <span style="color:black">endp
BIOSCODE:1477
BIOSCODE:1478
BIOSCODE:1478 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1478
BIOSCODE:1478
BIOSCODE:1478 </span>GetMediaId      <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:1478                 </span><span style="color:navy">call    </span>ChangeLineChk   ; get volume serial number
<span style="color:black">BIOSCODE:147B                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:di+BDS.drivelet] ; Logical drive number
<span style="color:black">BIOSCODE:147F                 </span><span style="color:navy">mov     ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">2     </span>; Read operation
<span style="color:black">BIOSCODE:1484                 </span><span style="color:navy">call    </span>BootIo          ; Read boot sector into DiskSector
<span style="color:black">BIOSCODE:1487                 </span><span style="color:navy">jb      short </span>IOCtl_If1
<span style="color:black">BIOSCODE:1489                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">15h</span><span style="color:navy">, </span><span style="color:#ff8000">0F0h </span>; Valid? (0F0h-0FFh?)
<span style="color:black">BIOSCODE:148E                 </span><span style="color:navy">jb      short </span>IOCtl_If2 ; brif not valid (0F0h - 0FFh)
<span style="color:black">BIOSCODE:1490                 </span><span style="color:navy">mov     si, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">43h</span><span style="color:navy">) </span>; BS_FAT32_VolID
<span style="color:black">BIOSCODE:1493                 </span><span style="color:navy">cmp     word ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">16h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB.FATSz16
<span style="color:black">BIOSCODE:1498                 </span><span style="color:navy">jz      short </span>IOCtl_If3 ; FAT32 fs
<span style="color:black">BIOSCODE:149A                 </span><span style="color:navy">sub     si, </span><span style="color:green">1Ch         </span>; FAT (12-16) fs ; 43h-1Ch = 27h ; BS_VolID
<span style="color:black">BIOSCODE:149D
BIOSCODE:149D </span>IOCtl_If3<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:149D                 </span><span style="color:navy">cmp     byte ptr [si-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:green">29h </span>; si-1 = offset disksector+26h (FAT)
<span style="color:black">BIOSCODE:149D                                         </span>;       or  = offset disksector+42h (FAT32)
<span style="color:black">BIOSCODE:149D                                         </span>;             disksector+EXT_BOOT.SIG
<span style="color:black">BIOSCODE:149D                                         </span>; BS_BootSig
<span style="color:black">BIOSCODE:14A1                 </span><span style="color:navy">jnz     short </span>IOCtl_If2
<span style="color:black">BIOSCODE:14A3                 </span><span style="color:navy">les     di, ds:</span>ptrsav
<span style="color:black">BIOSCODE:14A7                 </span><span style="color:navy">les     di, es:[bx+</span><span style="color:green">19</span><span style="color:navy">]  </span>; [es:bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:black">BIOSCODE:14AB                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">2           </span>; A_MEDIA_ID_INFO.MI_SERIAL
<span style="color:black">BIOSCODE:14AE
BIOSCODE:14AE </span>IOCtl_If4<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:14AE                 </span><span style="color:navy">mov     cx, </span><span style="color:green">23          </span>; size_of_EXT_BOOT_SERIAL
<span style="color:black">BIOSCODE:14AE                                         </span>; + size_of_EXT_BOOT_VOL_LABEL
<span style="color:black">BIOSCODE:14AE                                         </span>; + size_of_EXT_SYSTEM_ID
<span style="color:black">BIOSCODE:14B1                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSCODE:14B3                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:14B4                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:14B5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:14B5
BIOSCODE:14B5 </span>IOCtl_If2<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:14B5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7
</span><span style="color:black">BIOSCODE:14B7                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:14B8
BIOSCODE:14B8 </span>IOCtl_If1<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:14B8                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:14B8 </span>GetMediaId      <span style="color:black">endp
BIOSCODE:14B8
</span><span style="color:maroon">BIOSCODE:14B9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:14B9
BIOSCODE:14B9 </span>SetMediaId<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:14B9                 </span><span style="color:navy">call    </span>ChangeLineChk
<span style="color:maroon">BIOSCODE:14BC                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:di+BDS.drivelet]
<span style="color:maroon">BIOSCODE:14BC                                         </span>; Logical drive number
<span style="color:maroon">BIOSCODE:14C0                 </span><span style="color:navy">mov     dl, al
</span><span style="color:maroon">BIOSCODE:14C2                 </span><span style="color:navy">mov     ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">2     </span>; romread
<span style="color:maroon">BIOSCODE:14C7                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSCODE:14C8                 </span><span style="color:navy">call    </span>BootIo          ; Read boot sector to BIOSDATA:DiskSector
<span style="color:maroon">BIOSCODE:14CB                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSCODE:14CC                 </span><span style="color:navy">jb      short </span>IOCtl_If6
<span style="color:maroon">BIOSCODE:14CE                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">15h</span><span style="color:navy">, </span><span style="color:#ff8000">0F0h </span>; Valid? (0F0h-0FFh?)
<span style="color:maroon">BIOSCODE:14CE                                         </span>; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
<span style="color:maroon">BIOSCODE:14D3                 </span><span style="color:navy">jb      short </span>IOCtl_If7 ; Brif not
<span style="color:maroon">BIOSCODE:14D5                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:14D6                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:14D7                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:14D8                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:14D9                 </span><span style="color:navy">mov     di, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">43h</span><span style="color:navy">) </span>; disksector+EXT_BOOT.SERIAL
<span style="color:maroon">BIOSCODE:14DC                 </span><span style="color:navy">cmp     word ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">16h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB.FATSz16
<span style="color:maroon">BIOSCODE:14E1                 </span><span style="color:navy">jz      short </span>IOCtl_If5 ; FAT32 fs
<span style="color:maroon">BIOSCODE:14E3                 </span><span style="color:navy">sub     di, </span><span style="color:green">1Ch         </span>; 67-28 ; offset disksektor+27h
<span style="color:maroon">BIOSCODE:14E6
BIOSCODE:14E6 </span>IOCtl_If5<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:14E6                 </span><span style="color:navy">cmp     byte ptr [di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:green">29h </span>; [disksector+EXT_BOOT.SIG], EXT_BOOT_SIGNATURE
<span style="color:maroon">BIOSCODE:14EA                 </span><span style="color:navy">jz      short </span>IOCtl_If8
<span style="color:maroon">BIOSCODE:14EC                 </span><span style="color:navy">pop     di              </span>; not extended boot record
<span style="color:maroon">BIOSCODE:14ED                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:14EE                 </span><span style="color:navy">jmp     short </span>IOCtl_If7
<span style="color:maroon">BIOSCODE:14F0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:14F0
BIOSCODE:14F0 </span>IOCtl_If8<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:14F0                 </span><span style="color:navy">lds     si, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:14F4                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [si+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:14F7                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">2           </span>; A_MEDIA_ID_INFO.MI_SERIAL
<span style="color:maroon">BIOSCODE:14FA                 </span><span style="color:navy">call    </span>IOCtl_If4       ; copy volume serial, label and system id
<span style="color:maroon">BIOSCODE:14FD                 </span><span style="color:navy">push    es              </span>; point ds back to BIOSDATA
<span style="color:maroon">BIOSCODE:14FE                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:14FF                 </span><span style="color:navy">pop     di              </span>; restore bds pointer
<span style="color:maroon">BIOSCODE:1500                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1501                 </span><span style="color:navy">call    </span>mov_media_ids   ; update the bds media id info.
<span style="color:maroon">BIOSCODE:1504                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">BIOSCODE:1506                 </span><span style="color:navy">mov     ds:</span>rflag<span style="color:navy">, </span><span style="color:#ff8000">3     </span>; romwrite
<span style="color:maroon">BIOSCODE:150B                 </span><span style="color:navy">call    </span>BootIo          ; write it back
<span style="color:maroon">BIOSCODE:150E                 </span><span style="color:navy">mov     ds:</span>tim_drv<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; make sure chk_media check the driver
<span style="color:maroon">BIOSCODE:150E                                         </span>; return with error code from BootIo
<span style="color:maroon">BIOSCODE:1513                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:1514 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1514
BIOSCODE:1514 </span>IOCtl_If7<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1514                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7           </span>; error_unknown_media
<span style="color:maroon">BIOSCODE:1516                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSCODE:1517
BIOSCODE:1517 </span>IOCtl_If6<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1517                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1518
BIOSCODE:1518 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1518
BIOSCODE:1518
BIOSCODE:1518 </span>BootIo          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1518                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:1519                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:151A                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:151B                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:151C                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:151D                 </span><span style="color:navy">mov     di, offset </span>disksector ; es:di -&gt; transfer address
<span style="color:black">BIOSCODE:1520                 </span><span style="color:navy">xor     dx, dx          </span>; First sector (h) -&gt; 0
<span style="color:black">BIOSCODE:1522                 </span><span style="color:navy">mov     ds:</span>start_sec_h<span style="color:navy">, dx </span>; Start sector (h) -&gt; 0
<span style="color:black">BIOSCODE:1526                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:1529                 </span><span style="color:navy">call    </span>diskio
<span style="color:black">BIOSCODE:152C                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:152D                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:152E                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:152F                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:152F </span>BootIo          <span style="color:black">endp
BIOSCODE:152F
BIOSCODE:1530
BIOSCODE:1530 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1530
BIOSCODE:1530
BIOSCODE:1530 </span>ChangeLineChk   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1530                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1534                 </span><span style="color:navy">or      dl, dl          </span>; Fixed disk?
<span style="color:black">BIOSCODE:1536                 </span><span style="color:navy">js      short </span><span style="color:gray">ChangeLnChkRet
</span><span style="color:black">BIOSCODE:1538                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">4 </span>; [es:di+BDS.flags], return_fake_bpb
<span style="color:black">BIOSCODE:153E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ChangeLnChkRet
</span><span style="color:black">BIOSCODE:1540                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; This rom support change line?
<span style="color:black">BIOSCODE:1545                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ChangeLnChkRet </span>; no
<span style="color:black">BIOSCODE:1547                 </span><span style="color:navy">call    </span>haschange
<span style="color:black">BIOSCODE:154A                 </span><span style="color:navy">jz      short </span><span style="color:gray">ChangeLnChkRet </span>; Do nothing
<span style="color:black">BIOSCODE:154C                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">16h
</span><span style="color:black">BIOSCODE:154E                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - FLOPPY DISK - CHANGE OF DISK STATUS (AT,XT2,XT286,CONV,PS)
<span style="color:black">BIOSCODE:154E                                         </span>; DL = drive to check
<span style="color:black">BIOSCODE:154E                                         </span>; Return: AH = disk change status
<span style="color:black">BIOSCODE:1550                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ChangeLnChkRet
</span><span style="color:black">BIOSCODE:1552                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:1553                 </span><span style="color:navy">mov     bx, </span><span style="color:green">40h         </span>; fchanged
<span style="color:black">BIOSCODE:1553                                         </span>; Update flag in BDS for this physical drive
<span style="color:black">BIOSCODE:1556                 </span><span style="color:navy">call    </span>Set_Changed_DL
<span style="color:black">BIOSCODE:1559                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:155A
BIOSCODE:155A </span><span style="color:gray">ChangeLnChkRet</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:155A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:155A </span>ChangeLineChk   <span style="color:black">endp
BIOSCODE:155A
BIOSCODE:155B
BIOSCODE:155B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:155B
BIOSCODE:155B
BIOSCODE:155B </span>GetAccessFlag   <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:155B                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav   ; ds:bx points to request header
<span style="color:black">BIOSCODE:155F                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:black">BIOSCODE:1562                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0           </span>; Assume result is unformatted
<span style="color:black">BIOSCODE:1564                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">200h </span>; [es:di+BDS.flags], unformatted_media
<span style="color:black">BIOSCODE:156A                 </span><span style="color:navy">jnz     short </span>GafDone   ; Done if unformatted
<span style="color:black">BIOSCODE:156C                 </span><span style="color:navy">inc     ax              </span>; Return true for formatted
<span style="color:black">BIOSCODE:156D
BIOSCODE:156D </span>GafDone<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:156D                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">], al      </span>; [bx+A_DISKACCESS_CONTROL.DAC_ACCESS_FLAG]
<span style="color:black">BIOSCODE:1570                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1570 </span>GetAccessFlag   <span style="color:black">endp
BIOSCODE:1570
BIOSCODE:1571
BIOSCODE:1571 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1571
BIOSCODE:1571
BIOSCODE:1571 </span>SetAccessFlag   <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:1571                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav   ; ds:bx points to request header
<span style="color:black">BIOSCODE:1575                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:black">BIOSCODE:1578                 </span><span style="color:navy">and     word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">0FDFFh </span>; [es:di+BDS.flags], ~unformatted_media
<span style="color:black">BIOSCODE:157E                 </span><span style="color:navy">cmp     byte ptr [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [bx+A_DISKACCESS_CONTROL.DAC_ACCESS_FLAG]
<span style="color:black">BIOSCODE:1582                 </span><span style="color:navy">jnz     short </span>saf_Done
<span style="color:black">BIOSCODE:1584                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">200h </span>; [es:di+BDS.flags], unformatted_media
<span style="color:black">BIOSCODE:158A
BIOSCODE:158A </span>saf_Done<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:158A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:158A </span>SetAccessFlag   <span style="color:black">endp
BIOSCODE:158A
BIOSCODE:158B
BIOSCODE:158B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:158B
BIOSCODE:158B
BIOSCODE:158B </span>ioctl_support_query <span style="color:black">proc near           </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:158B                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:158C                 </span><span style="color:navy">les     bx, ds:</span>ptrsav   ; es:bx points to request header.
<span style="color:black">BIOSCODE:1590                 </span><span style="color:navy">mov     ax, es:[bx+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [es:bx+IOCTL_REQ.MAJORFUNCTION]
<span style="color:black">BIOSCODE:1590                                         </span>; al == Major, ah == Minor
<span style="color:black">BIOSCODE:1594                 </span><span style="color:navy">cmp     al, </span><span style="color:green">48h         </span>; IOC_NEW_DC
<span style="color:black">BIOSCODE:1594                                         </span>; new generic ioctl function (FAT32)
<span style="color:black">BIOSCODE:1596                 </span><span style="color:navy">jz      short </span>ioctl_support
<span style="color:black">BIOSCODE:1598                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8           </span>; IOC_DC
<span style="color:black">BIOSCODE:1598                                         </span>; (old) generic ioctl function (FAT12-FAT16)
<span style="color:black">BIOSCODE:159A                 </span><span style="color:navy">jnz     short </span>nosupport
<span style="color:black">BIOSCODE:159C
BIOSCODE:159C </span>ioctl_support<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:159C                 </span><span style="color:navy">push    cs
</span><span style="color:black">BIOSCODE:159D                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:159E                 </span>assume es:BIOSCODE
<span style="color:black">BIOSCODE:159E                 </span><span style="color:navy">mov     cx, </span><span style="color:green">14          </span>; IOC_DC_TABLE_LEN
<span style="color:black">BIOSCODE:15A1                 </span><span style="color:navy">mov     di, offset </span>IOC_DC_Table
<span style="color:black">BIOSCODE:15A4                 </span><span style="color:navy">xchg    al, ah
</span><span style="color:black">BIOSCODE:15A6                 </span><span style="color:navy">repne scasb
</span><span style="color:black">BIOSCODE:15A8                 </span><span style="color:navy">jnz     short </span>nosupport
<span style="color:black">BIOSCODE:15AA                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">100h
</span><span style="color:black">BIOSCODE:15AD                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:15AE                 </span>assume es:nothing
<span style="color:black">BIOSCODE:15AE                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:15AF                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:15B0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:15B0
BIOSCODE:15B0 </span>nosupport<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:15B0                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:15B1                 </span><span style="color:navy">jmp     </span>bc_cmderr
<span style="color:black">BIOSCODE:15B1 </span>ioctl_support_query <span style="color:black">endp
BIOSCODE:15B1
</span><span style="color:maroon">BIOSCODE:15B4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:15B4
BIOSCODE:15B4 </span>SenseMediaType<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:15B4                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav   ; ds:bx points to request header.
<span style="color:maroon">BIOSCODE:15B8                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:15BB                 </span><span style="color:navy">xor     dx, dx          </span>; 0 ; Initialize the 2 packet bytes
<span style="color:maroon">BIOSCODE:15BD                 </span><span style="color:navy">mov     [bx], dx        </span>; invalidate drive type (byte 1)
<span style="color:maroon">BIOSCODE:15BD                                         </span>; and default type flag (byte 0)
<span style="color:maroon">BIOSCODE:15BF                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:maroon">BIOSCODE:15C3                 </span><span style="color:navy">mov     ah, </span><span style="color:green">20h
</span><span style="color:maroon">BIOSCODE:15C5                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; Compaq, ATAPI Removable Media Device
<span style="color:maroon">BIOSCODE:15C5                                         </span>; GET CURRENT MEDIA FORMAT
<span style="color:maroon">BIOSCODE:15C5                                         </span>;   AH = 20h
<span style="color:maroon">BIOSCODE:15C5                                         </span>;   DL = drive number (00h,01h)
<span style="color:maroon">BIOSCODE:15C5                                         </span>; Return: CF clear if successful
<span style="color:maroon">BIOSCODE:15C5                                         </span>;   AL = media type
<span style="color:maroon">BIOSCODE:15C5                                         </span>;   AH = 00h
<span style="color:maroon">BIOSCODE:15C5                                         </span>;   CF set on error
<span style="color:maroon">BIOSCODE:15C5                                         </span>;      AH = error code
<span style="color:maroon">BIOSCODE:15C5                                         </span>;
<span style="color:maroon">BIOSCODE:15C5                                         </span>; (Ref: Ralf Brown&#039;s Interrupt List, INTERRUP.B)
<span style="color:maroon">BIOSCODE:15C7                 </span><span style="color:navy">jb      short </span>MediaSenseErr
<span style="color:maroon">BIOSCODE:15C9                 </span><span style="color:navy">inc     byte ptr [bx]   </span>; [bx+A_MEDIA_SENSE.MS_ISDEFAULT]
<span style="color:maroon">BIOSCODE:15C9                                         </span>; 1 = default media type
<span style="color:maroon">BIOSCODE:15CB
BIOSCODE:15CB </span>DetermineMediaType<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:15CB                 </span><span style="color:navy">dec     al              </span>; 3 -&gt; 2, 4 -&gt; 3, 6 -&gt; 5
<span style="color:maroon">BIOSCODE:15CD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; 3.5 inch, 720 KB
<span style="color:maroon">BIOSCODE:15CF                 </span><span style="color:navy">jz      short </span>GotMediaType
<span style="color:maroon">BIOSCODE:15D1                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">4           </span>; 3 -&gt; 6, 4 -&gt; 7, 6 -&gt; 9
<span style="color:maroon">BIOSCODE:15D3                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7           </span>; 3.5 inch, 1.44 MB
<span style="color:maroon">BIOSCODE:15D5                 </span><span style="color:navy">jz      short </span>GotMediaType
<span style="color:maroon">BIOSCODE:15D7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; 3.5 inch, 2.88 MB
<span style="color:maroon">BIOSCODE:15D9                 </span><span style="color:navy">jnz     short </span>UnknownMediaType ; Just didn&#039;t recognize media type
<span style="color:maroon">BIOSCODE:15DB
BIOSCODE:15DB </span>GotMediaType<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:15DB                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">], al      </span>; [bx+A_MEDIA_SENSE.MS_DEVICETYPE]
<span style="color:maroon">BIOSCODE:15DE                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:15DF                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:15E0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:15E0
BIOSCODE:15E0 </span>MediaSenseErr<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:15E0                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">32h         </span>; non-default media /
<span style="color:maroon">BIOSCODE:15E0                                         </span>; drive does not support media type
<span style="color:maroon">BIOSCODE:15E3                 </span><span style="color:navy">jz      short </span>DetermineMediaType
<span style="color:maroon">BIOSCODE:15E5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; function supported but, drive not ready
<span style="color:maroon">BIOSCODE:15E7                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">31h         </span>; no such drive / media not present
<span style="color:maroon">BIOSCODE:15EA                 </span><span style="color:navy">jz      short </span>SenseErrExit
<span style="color:maroon">BIOSCODE:15EC
BIOSCODE:15EC </span>UnknownMediaType<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:15EC                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7           </span>; error_unknown_media
<span style="color:maroon">BIOSCODE:15EE
BIOSCODE:15EE </span>SenseErrExit<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:15EE                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">81h         </span>; Return this status in case of carry
<span style="color:maroon">BIOSCODE:15F0                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSCODE:15F1                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:15F2
BIOSCODE:15F2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:15F2
BIOSCODE:15F2
BIOSCODE:15F2 </span>SetLockState    <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:15F2                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav   ; set media lock state
<span style="color:black">BIOSCODE:15F6                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:black">BIOSCODE:15F9                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:15FD                 </span><span style="color:navy">call    </span>check_int13h_exts_present
<span style="color:black">BIOSCODE:1600                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; unknown command error
<span style="color:black">BIOSCODE:1602                 </span><span style="color:navy">jb      short </span><span style="color:gray">setlockst_ret
</span><span style="color:black">BIOSCODE:1604                 </span><span style="color:navy">mov     al, [bx]        </span>; [bx+A_LOCKSTATE_CONTROL.LOCKSTATE_FUNCTIONS]
<span style="color:black">BIOSCODE:1606                 </span><span style="color:navy">mov     ah, </span><span style="color:green">45h
</span><span style="color:black">BIOSCODE:1608                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE
<span style="color:black">BIOSCODE:1608                                         </span>; (DL - drive, DS:SI - disk address packet)
<span style="color:black">BIOSCODE:160A                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">], al      </span>; 1 = locked, 0 = not locked
<span style="color:black">BIOSCODE:160A                                         </span>; [bx+A_LOCKSTATE_CONTROL.LOCKSTATE_FLAG]
<span style="color:black">BIOSCODE:160D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">setlockst_ret
</span><span style="color:black">BIOSCODE:160F                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">BIOSCODE:1611                 </span><span style="color:navy">call    </span>maperror
<span style="color:black">BIOSCODE:1614
BIOSCODE:1614 </span><span style="color:gray">setlockst_ret</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1614                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">81h         </span>; Return this status in case of carry
<span style="color:black">BIOSCODE:1616                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1616 </span>SetLockState    <span style="color:black">endp
BIOSCODE:1616
BIOSCODE:1617
BIOSCODE:1617 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1617
BIOSCODE:1617
BIOSCODE:1617 </span>EjectMedia      <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:1617                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; eject media in drive
<span style="color:black">BIOSCODE:1617                                         </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:161B                 </span><span style="color:navy">call    </span>check_int13h_exts_present
<span style="color:black">BIOSCODE:161E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; unknown command error
<span style="color:black">BIOSCODE:1620                 </span><span style="color:navy">jb      short </span>ejectm_ret
<span style="color:black">BIOSCODE:1622                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4600h
</span><span style="color:black">BIOSCODE:1625                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - IBM/MS Extension - EJECT MEDIA
<span style="color:black">BIOSCODE:1625                                         </span>; (DL - drive)
<span style="color:black">BIOSCODE:1627                 </span><span style="color:navy">jnb     short </span>ejectm_ret
<span style="color:black">BIOSCODE:1629                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">BIOSCODE:162B                 </span><span style="color:navy">call    </span>maperror
<span style="color:black">BIOSCODE:162E
BIOSCODE:162E </span>ejectm_ret<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:162E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">81h         </span>; Return this status in case of carry
<span style="color:black">BIOSCODE:1630                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1630 </span>EjectMedia      <span style="color:black">endp
BIOSCODE:1630
BIOSCODE:1631
BIOSCODE:1631 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1631
BIOSCODE:1631
BIOSCODE:1631 </span>check_int13h_exts_present <span style="color:black">proc near     </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1631                 </span><span style="color:navy">mov     ah, </span><span style="color:green">41h
</span><span style="color:black">BIOSCODE:1633                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:1634                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">55AAh
</span><span style="color:black">BIOSCODE:1637                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - Check for INT 13h Extensions
<span style="color:black">BIOSCODE:1637                                         </span>; BX = 55AAh, DL = drive number
<span style="color:black">BIOSCODE:1637                                         </span>; Return: CF set if not supported
<span style="color:black">BIOSCODE:1637                                         </span>; AH = extensions version
<span style="color:black">BIOSCODE:1637                                         </span>; BX = AA55h
<span style="color:black">BIOSCODE:1637                                         </span>; CX = Interface support bit map
<span style="color:black">BIOSCODE:1639                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0AA55h
</span><span style="color:black">BIOSCODE:163D                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:163E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">exts_notsupported
</span><span style="color:black">BIOSCODE:1640                 </span><span style="color:navy">test    cl, </span><span style="color:green">2           </span>; bit 1 - drive locking and ejecting subset
<span style="color:black">BIOSCODE:1643                 </span><span style="color:navy">jnz     short </span><span style="color:gray">exts_supported
</span><span style="color:black">BIOSCODE:1645
BIOSCODE:1645 </span><span style="color:gray">exts_notsupported</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1645                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:1646
BIOSCODE:1646 </span><span style="color:gray">exts_supported</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1646                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1646 </span>check_int13h_exts_present <span style="color:black">endp
BIOSCODE:1646
</span><span style="color:maroon">BIOSCODE:1647 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1647
BIOSCODE:1647 </span>GetDrvMapInfo<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:1647                 </span><span style="color:navy">mov     cx, ds          </span>; get drive map information
<span style="color:maroon">BIOSCODE:1647                                         </span>;
<span style="color:maroon">BIOSCODE:1647                                         </span>; es:di points to BDS which belongs to
<span style="color:maroon">BIOSCODE:1647                                         </span>;       the requested logical/dos drive number
<span style="color:maroon">BIOSCODE:1647                                         </span>;
<span style="color:maroon">BIOSCODE:1647                                         </span>; Format of parameter block:
<span style="color:maroon">BIOSCODE:1647                                         </span>; Offset  Description (Table 01570)
<span style="color:maroon">BIOSCODE:1647                                         </span>;  00h    (call) length of this buffer (in bytes)
<span style="color:maroon">BIOSCODE:1647                                         </span>;  01h    (ret) number of bytes in parameter block
<span style="color:maroon">BIOSCODE:1647                                         </span>;         actually used
<span style="color:maroon">BIOSCODE:1647                                         </span>;  02h    (ret) drive flags
<span style="color:maroon">BIOSCODE:1647                                         </span>;  03h    (ret) physical drive number
<span style="color:maroon">BIOSCODE:1647                                         </span>;         00h-7Fh floppy
<span style="color:maroon">BIOSCODE:1647                                         </span>;         80h-FEh hard
<span style="color:maroon">BIOSCODE:1647                                         </span>;         FFh no physical drive
<span style="color:maroon">BIOSCODE:1647                                         </span>;  04h    (ret) bitmap of logical drives associated with
<span style="color:maroon">BIOSCODE:1647                                         </span>;         physical drive
<span style="color:maroon">BIOSCODE:1647                                         </span>;         bit 0 = drive A:, etc.
<span style="color:maroon">BIOSCODE:1647                                         </span>;  08h    (ret) relative block address of partition start
<span style="color:maroon">BIOSCODE:1647                                         </span>;         qword
<span style="color:maroon">BIOSCODE:1647                                         </span>;
<span style="color:maroon">BIOSCODE:1647                                         </span>; Ref: Ralf Brown&#039;s Interrupt List, INTERRUP.G
<span style="color:maroon">BIOSCODE:1649                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav
<span style="color:maroon">BIOSCODE:164D                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">13h</span><span style="color:navy">]    </span>; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:maroon">BIOSCODE:1650                 </span><span style="color:navy">mov     ax, </span><span style="color:green">8103h       </span>; ah = generic ioctl error code (81h)
<span style="color:maroon">BIOSCODE:1650                                         </span>; al = unknown command error (03h)
<span style="color:maroon">BIOSCODE:1653                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">10h </span>; parameter buffer length = 16 bytes
<span style="color:maroon">BIOSCODE:1656                 </span><span style="color:navy">jb      short </span>gdmi_4
<span style="color:maroon">BIOSCODE:1658                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:maroon">BIOSCODE:165C                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], dl      </span>; parameter block - offset 3 - physical drive number
<span style="color:maroon">BIOSCODE:165F                 </span><span style="color:navy">mov     byte ptr [bx+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">10h </span>; parameter block - actually used length
<span style="color:maroon">BIOSCODE:1663                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [es:di+BDS.hiddensectors]
<span style="color:maroon">BIOSCODE:1667                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">8</span><span style="color:navy">], ax      </span>; parameter block - offset 8 - partition start LBA
<span style="color:maroon">BIOSCODE:166A                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; [es:di+BDS.hiddensectors+2]
<span style="color:maroon">BIOSCODE:166E                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], ax    </span>; parameter block - offset 10
<span style="color:maroon">BIOSCODE:1671                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">BIOSCODE:1673                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], al      </span>; drive flags = 0 (protected mode flags etc.)
<span style="color:maroon">BIOSCODE:1676                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], ax    </span>; high dword of partition start address (LBA) is 0
<span style="color:maroon">BIOSCODE:1679                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSCODE:167C                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax      </span>; logical drive bitmap of same physical drive
<span style="color:maroon">BIOSCODE:167C                                         </span>; initialized as 0
<span style="color:maroon">BIOSCODE:167F                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSCODE:1682                 </span><span style="color:navy">mov     es, cx
</span><span style="color:maroon">BIOSCODE:1684                 </span><span style="color:navy">les     di, dword ptr es:</span>start_bds ; 1st BDS
<span style="color:maroon">BIOSCODE:1689                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1           </span>; bit 0 (drive A:)
<span style="color:maroon">BIOSCODE:168C
BIOSCODE:168C </span>gdmi_1<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:168C                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; last BDS ?
<span style="color:maroon">BIOSCODE:168F                 </span><span style="color:navy">jz      short </span>gdmi_3    ; yes
<span style="color:maroon">BIOSCODE:1691                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], dl   </span>; [es:di+BDS.drivenum], dl
<span style="color:maroon">BIOSCODE:1691                                         </span>; is it same physical drive ?
<span style="color:maroon">BIOSCODE:1695                 </span><span style="color:navy">jnz     short </span>gdmi_2    ; no
<span style="color:maroon">BIOSCODE:1697                 </span><span style="color:navy">or      [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx      </span>; set bit for logical drive index of this BDS
<span style="color:maroon">BIOSCODE:1697                                         </span>; (previously) shifted bit (which is 1/ON) is in ax:cx
<span style="color:maroon">BIOSCODE:169A                 </span><span style="color:navy">or      [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], ax
</span><span style="color:maroon">BIOSCODE:169D
BIOSCODE:169D </span>gdmi_2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:169D                 </span><span style="color:navy">shl     cx, </span><span style="color:green">1           </span>; shift one left for setting the next drive&#039;s bit
<span style="color:maroon">BIOSCODE:169F                 </span><span style="color:navy">rcl     ax, </span><span style="color:green">1           </span>; set high word of the bit select (set) value
<span style="color:maroon">BIOSCODE:16A1                 </span><span style="color:navy">les     di, es:[di]     </span>; next BDS
<span style="color:maroon">BIOSCODE:16A4                 </span><span style="color:navy">jmp     short </span>gdmi_1    ; loop until di = -1 (last BDS sign)
<span style="color:maroon">BIOSCODE:16A6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:16A6
BIOSCODE:16A6 </span>gdmi_3<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:16A6                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">100h        </span>; success
<span style="color:maroon">BIOSCODE:16A9
BIOSCODE:16A9 </span>gdmi_4<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:16A9                 </span><span style="color:navy">retn
</span><span style="color:maroon">BIOSCODE:16AA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:16AA
BIOSCODE:16AA </span>i2f_handler<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:16AA                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">13h
</span><span style="color:maroon">BIOSCODE:16AD                 </span><span style="color:navy">jz      short </span>int2f_replace_int13
<span style="color:maroon">BIOSCODE:16AF                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">8
</span><span style="color:maroon">BIOSCODE:16B2                 </span><span style="color:navy">jz      short </span>mine
<span style="color:maroon">BIOSCODE:16B4                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">16h         </span>; MultWin386
<span style="color:maroon">BIOSCODE:16B7                 </span><span style="color:navy">jz      short </span>win386call
<span style="color:maroon">BIOSCODE:16B9                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">4Ah         </span>; multMULT
<span style="color:maroon">BIOSCODE:16BC                 </span><span style="color:navy">jnz     short </span>i2f_handler_iret
<span style="color:maroon">BIOSCODE:16BE                 </span><span style="color:navy">jmp     </span>handle_multmult
<span style="color:maroon">BIOSCODE:16C1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:16C1
BIOSCODE:16C1 </span>i2f_handler_iret<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:16C1                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSCODE:16C2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:16C2
BIOSCODE:16C2 </span>int2f_replace_int13<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:16C2                 </span><span style="color:navy">cli
</span><span style="color:maroon">BIOSCODE:16C3                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSCODE:16C4                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">BIOSCODE:16C6                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:16CB                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:16CB                 </span><span style="color:navy">push    word ptr ds:</span>Orig13<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">BIOSCODE:16CF                 </span><span style="color:navy">push    word ptr ds:</span>Old13<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">BIOSCODE:16D3                 </span><span style="color:navy">xchg    dx, word ptr ds:</span>Orig13
<span style="color:maroon">BIOSCODE:16D7                 </span><span style="color:navy">mov     word ptr ds:</span>Orig13<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">BIOSCODE:16DA                 </span><span style="color:navy">xchg    bx, word ptr ds:</span>Old13
<span style="color:maroon">BIOSCODE:16DE                 </span><span style="color:navy">mov     word ptr ds:</span>Old13<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">BIOSCODE:16E2                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:16E3                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:16E4                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:16E4                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSCODE:16E5
BIOSCODE:16E5 </span>i2f_iret<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:16E5                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSCODE:16E6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:16E6
BIOSCODE:16E6 </span>mine<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:16E6                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0F8h        </span>; iret on reserved functions
<span style="color:maroon">BIOSCODE:16E8                 </span><span style="color:navy">jnb     short </span>i2f_iret
<span style="color:maroon">BIOSCODE:16EA                 </span><span style="color:navy">or      al, al          </span>; a get installed state request?
<span style="color:maroon">BIOSCODE:16EC                 </span><span style="color:navy">jnz     short </span>disp_func
<span style="color:maroon">BIOSCODE:16EE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">BIOSCODE:16F0                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSCODE:16F1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:16F1
BIOSCODE:16F1 </span>disp_func<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:16F1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; request for installing bds?
<span style="color:maroon">BIOSCODE:16F3                 </span><span style="color:navy">jz      short </span>do_subfun_01
<span style="color:maroon">BIOSCODE:16F5                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; get bds vector?
<span style="color:maroon">BIOSCODE:16F7                 </span><span style="color:navy">jz      short </span>do_get_bds_vector
<span style="color:maroon">BIOSCODE:16F9                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:16FA                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:16FF                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:16FF                 </span><span style="color:navy">mov     word ptr ds:</span>ptrsav<span style="color:navy">, bx
</span><span style="color:maroon">BIOSCODE:1703                 </span><span style="color:navy">mov     word ptr ds:</span>ptrsav<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">BIOSCODE:1707                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1708                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1708                 </span><span style="color:navy">jmp     </span>far ptr 70h:65Eh ; BIOSDATA:dsk_entry
<span style="color:maroon">BIOSCODE:1708                                         </span>;
<span style="color:maroon">BIOSCODE:1708                                         </span>; NOTE: jump to a FAR function, not an
<span style="color:maroon">BIOSCODE:1708                                         </span>; IRET type function. Callers of
<span style="color:maroon">BIOSCODE:1708                                         </span>; this int2f subfunction will have
<span style="color:maroon">BIOSCODE:1708                                         </span>; to be careful to do a popf
<span style="color:maroon">BIOSCODE:170D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:170D
BIOSCODE:170D </span>do_subfun_01<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:170D                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:170E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:170F                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1710                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1711                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word ; BIOSDATA segment
<span style="color:maroon">BIOSCODE:1716                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1716                 </span><span style="color:navy">call    </span>install_bds
<span style="color:maroon">BIOSCODE:1719                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:171A                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:171A                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:171B                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSCODE:171C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:171C
BIOSCODE:171C </span>do_get_bds_vector<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:171C                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:1721                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1721                 </span><span style="color:navy">lds     di, dword ptr ds:</span>start_bds
<span style="color:maroon">BIOSCODE:1725                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1725                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSCODE:1726 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1726
BIOSCODE:1726 </span>win386call<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1726                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1727                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word ; BIOSDATA segment
<span style="color:maroon">BIOSCODE:172C                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:172C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5           </span>; Win386_Init
<span style="color:maroon">BIOSCODE:172C                                         </span>; is it win386 initializing?
<span style="color:maroon">BIOSCODE:172E                 </span><span style="color:navy">jz      short </span>Win386Init
<span style="color:maroon">BIOSCODE:1730                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6           </span>; Win386_Exit
<span style="color:maroon">BIOSCODE:1730                                         </span>; is it win386 exiting?
<span style="color:maroon">BIOSCODE:1732                 </span><span style="color:navy">jnz     short </span>win_iret
<span style="color:maroon">BIOSCODE:1734                 </span><span style="color:navy">test    dx, </span><span style="color:green">1           </span>; is it win386 or win286 dos extender?
<span style="color:maroon">BIOSCODE:1738                 </span><span style="color:navy">jnz     short </span>win_iret  ; if not win386, then continue
<span style="color:maroon">BIOSCODE:173A                 </span><span style="color:navy">and     ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">0  </span>; indicate that win386 is not present
<span style="color:maroon">BIOSCODE:173F                 </span><span style="color:navy">jmp     short </span>win_iret
<span style="color:maroon">BIOSCODE:1741 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1741
BIOSCODE:1741 </span>Win386Init<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1741                 </span><span style="color:navy">test    dx, </span><span style="color:green">1           </span>; is it win386 or win286 dos extender?
<span style="color:maroon">BIOSCODE:1745                 </span><span style="color:navy">jnz     short </span>win_iret  ; if not win386, then continue
<span style="color:maroon">BIOSCODE:1747                 </span><span style="color:navy">or      ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">BIOSCODE:174C                 </span><span style="color:navy">mov     word ptr ds:</span>SI_Next<span style="color:navy">, bx
</span><span style="color:maroon">BIOSCODE:1750                 </span><span style="color:navy">mov     word ptr ds:</span>SI_Next<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es </span>; Hook our structure into chain
<span style="color:maroon">BIOSCODE:1754                 </span><span style="color:navy">mov     bx, offset </span>Win386_SI ; point es:bx to Win386_SI
<span style="color:maroon">BIOSCODE:1757                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1758                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1759                 </span>assume es:nothing
<span style="color:maroon">BIOSCODE:1759
BIOSCODE:1759 </span>win_iret<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1759                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:175A                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:175A                 </span><span style="color:navy">iret                    </span>; return back up the chain
<span style="color:maroon">BIOSCODE:175B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:175B
BIOSCODE:175B </span>handle_multmult<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:175B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:175D                 </span><span style="color:navy">jnz     short </span>try_2
<span style="color:maroon">BIOSCODE:175F                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1760                 </span><span style="color:navy">call    </span>HMAptr          ; get offset of free HMA
<span style="color:maroon">BIOSCODE:1763                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">BIOSCODE:1766                 </span><span style="color:navy">mov     es, bx          </span>; seg of HMA
<span style="color:maroon">BIOSCODE:1768                 </span>assume es:nothing
<span style="color:maroon">BIOSCODE:1768                 </span><span style="color:navy">mov     bx, di
</span><span style="color:maroon">BIOSCODE:176A                 </span><span style="color:navy">not     bx
</span><span style="color:maroon">BIOSCODE:176C                 </span><span style="color:navy">or      bx, bx
</span><span style="color:maroon">BIOSCODE:176E                 </span><span style="color:navy">jz      short </span>try_1
<span style="color:maroon">BIOSCODE:1770                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">BIOSCODE:1771
BIOSCODE:1771 </span>try_1<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1771                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1772                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSCODE:1773 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1773
BIOSCODE:1773 </span>try_2<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1773                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; multMULTALLOCHMA
<span style="color:maroon">BIOSCODE:1775                 </span><span style="color:navy">jnz     short </span>try_3
<span style="color:maroon">BIOSCODE:1777                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1778                 </span><span style="color:navy">mov     di, </span><span style="color:green">0FFFFh      </span>; assume not enough space
<span style="color:maroon">BIOSCODE:177B                 </span><span style="color:navy">mov     es, di
</span><span style="color:maroon">BIOSCODE:177D                 </span><span style="color:navy">call    </span>HMAptr          ; get offset of free HMA
<span style="color:maroon">BIOSCODE:1780                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">BIOSCODE:1783                 </span><span style="color:navy">jz      short </span>InsuffHMA
<span style="color:maroon">BIOSCODE:1785                 </span><span style="color:navy">neg     di              </span>; free space in HMA
<span style="color:maroon">BIOSCODE:1787                 </span><span style="color:navy">cmp     bx, di
</span><span style="color:maroon">BIOSCODE:1789                 </span><span style="color:navy">jbe     short </span>try_4
<span style="color:maroon">BIOSCODE:178B                 </span><span style="color:navy">mov     di, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">BIOSCODE:178E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:178F                 </span><span style="color:navy">iret
</span><span style="color:maroon">BIOSCODE:1790 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1790
BIOSCODE:1790 </span>try_4<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1790                 </span><span style="color:navy">call    </span>get_FreeHMAPtr
<span style="color:maroon">BIOSCODE:1793                 </span><span style="color:navy">add     bx, </span><span style="color:green">15
</span><span style="color:maroon">BIOSCODE:1796                 </span><span style="color:navy">and     bl, </span><span style="color:green">0F0h
</span><span style="color:maroon">BIOSCODE:1799                 </span><span style="color:navy">add     ds:</span>FreeHMAPtr<span style="color:navy">, bx </span>; update the free pointer
<span style="color:maroon">BIOSCODE:179D                 </span><span style="color:navy">jnz     short </span>InsuffHMA
<span style="color:maroon">BIOSCODE:179F                 </span><span style="color:navy">mov     ds:</span>FreeHMAPtr<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1
<span style="color:maroon">BIOSCODE:179F                                         </span>; no more HMA if we have wrapped
<span style="color:maroon">BIOSCODE:17A5
BIOSCODE:17A5 </span>InsuffHMA<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:17A5                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:17A6
BIOSCODE:17A6 </span>try_3<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:17A6                 </span><span style="color:navy">iret
</span><span style="color:black">BIOSCODE:17A7
BIOSCODE:17A7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:17A7
BIOSCODE:17A7
BIOSCODE:17A7 </span>HMAptr          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:17A7                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:black">BIOSCODE:17AC                 </span>assume ds:nothing
<span style="color:black">BIOSCODE:17AC                 </span><span style="color:navy">mov     di, ds:</span>FreeHMAPtr
<span style="color:black">BIOSCODE:17B0                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">BIOSCODE:17B3                 </span><span style="color:navy">jnz     short </span>HMAPtr_retn
<span style="color:black">BIOSCODE:17B5                 </span><span style="color:navy">cmp     ds:</span>SysinitPresent<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:17BA                 </span><span style="color:navy">jz      short </span>HMAPtr_retn
<span style="color:black">BIOSCODE:17BC                 </span><span style="color:navy">call    dword ptr ds:</span>MoveDOSIntoHMA ; call far [MoveDOSIntoHMA]
<span style="color:black">BIOSCODE:17BC </span>HMAptr          <span style="color:black">endp
BIOSCODE:17BC
BIOSCODE:17C0
BIOSCODE:17C0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:17C0
BIOSCODE:17C0
BIOSCODE:17C0 </span>get_FreeHMAPtr  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:17C0                 </span><span style="color:navy">mov     di, ds:</span>FreeHMAPtr
<span style="color:black">BIOSCODE:17C4
BIOSCODE:17C4 </span>HMAPtr_retn<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:17C4                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:17C4 </span>get_FreeHMAPtr  <span style="color:black">endp
BIOSCODE:17C4
BIOSCODE:17C5
BIOSCODE:17C5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:17C5
BIOSCODE:17C5
BIOSCODE:17C5 </span>move_sector     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:17C5                 </span><span style="color:navy">cld
</span><span style="color:black">BIOSCODE:17C6                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:17C7                 </span><span style="color:navy">mov     cx, </span><span style="color:green">256
</span><span style="color:black">BIOSCODE:17CA                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FE00h
</span><span style="color:black">BIOSCODE:17CE                 </span><span style="color:navy">ja      short </span><span style="color:gray">movsec_bytes
</span><span style="color:black">BIOSCODE:17D0                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FE00h
</span><span style="color:black">BIOSCODE:17D4                 </span><span style="color:navy">ja      short </span><span style="color:gray">movsec_bytes
</span><span style="color:black">BIOSCODE:17D6                 </span><span style="color:navy">rep movsw
</span><span style="color:black">BIOSCODE:17D8                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:17D9                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:17DA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:17DA
BIOSCODE:17DA </span><span style="color:gray">movsec_bytes</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:17DA                 </span><span style="color:navy">shl     cx, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:17DC                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSCODE:17DE                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:17DF                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:17DF </span>move_sector     <span style="color:black">endp
BIOSCODE:17DF
BIOSCODE:17E0
BIOSCODE:17E0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:17E0
BIOSCODE:17E0
BIOSCODE:17E0 </span>check_wrap      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:17E0                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:17E1                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:17E2                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:17E3                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:17E4                 </span><span style="color:navy">call    </span>find_bds        ; get pointer to bds for drive in dl
<span style="color:black">BIOSCODE:17E7                 </span><span style="color:navy">jb      short </span><span style="color:gray">no_wrap
</span><span style="color:black">BIOSCODE:17E9                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags],fnon_removable
<span style="color:black">BIOSCODE:17EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_wrap   </span>; no wrapping for removable media
<span style="color:black">BIOSCODE:17F1                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:17F5                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">BIOSCODE:17F7                 </span><span style="color:navy">and     ax, </span><span style="color:green">3Fh         </span>; extract sector number
<span style="color:black">BIOSCODE:17FA                 </span><span style="color:navy">cmp     ax, bx          </span>; are we going to wrap?
<span style="color:black">BIOSCODE:17FC                 </span><span style="color:navy">jbe     short </span><span style="color:gray">no_wrap
</span><span style="color:black">BIOSCODE:17FE                 </span><span style="color:navy">div     bl              </span>; ah=new sector #, al=# of head wraps
<span style="color:black">BIOSCODE:1800                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">BIOSCODE:1802                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_on_bound
</span><span style="color:black">BIOSCODE:1804                 </span><span style="color:navy">mov     ah, bl          </span>; set sector=BDS_BPB.BPB_SECTORSPERTRACK
<span style="color:black">BIOSCODE:1806                 </span><span style="color:navy">dec     al              </span>; if on boundary
<span style="color:black">BIOSCODE:1806                                         </span>; also decrement # of head wrap
<span style="color:black">BIOSCODE:1808
BIOSCODE:1808 </span><span style="color:gray">not_on_bound</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1808                 </span><span style="color:navy">and     cl, </span><span style="color:green">0C0h        </span>; zero out sector #
<span style="color:black">BIOSCODE:180B                 </span><span style="color:navy">or      cl, ah          </span>; or in new sector #
<span style="color:black">BIOSCODE:180D                 </span><span style="color:navy">xor     ah, ah          </span>; ax = # of head wraps
<span style="color:black">BIOSCODE:180F                 </span><span style="color:navy">inc     ax
</span><span style="color:black">BIOSCODE:1810                 </span><span style="color:navy">add     al, dh          </span>; add in starting head #
<span style="color:black">BIOSCODE:1812                 </span><span style="color:navy">adc     ah, </span><span style="color:#ff8000">0           </span>; catch any carry
<span style="color:black">BIOSCODE:1815                 </span><span style="color:navy">cmp     ax, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+BDS.heads]
<span style="color:black">BIOSCODE:1815                                         </span>; are we going to wrap around a head?
<span style="color:black">BIOSCODE:1819                 </span><span style="color:navy">jbe     short </span><span style="color:gray">no_wrap_head
</span><span style="color:black">BIOSCODE:181B                 </span><span style="color:navy">push    dx              </span>; preserve drive number and head number
<span style="color:black">BIOSCODE:181C                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSCODE:181E                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+BDS.heads]
<span style="color:black">BIOSCODE:181E                                         </span>; dx = new head #, ax = # of cylinder wraps
<span style="color:black">BIOSCODE:1822                 </span><span style="color:navy">div     bx
</span><span style="color:black">BIOSCODE:1824                 </span><span style="color:navy">or      dx, dx          </span>; if new head # is 0, then we are on the last head
<span style="color:black">BIOSCODE:1826                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_head_bound
</span><span style="color:black">BIOSCODE:1828                 </span><span style="color:navy">mov     dx, bx          </span>; on boundary. set to BDS_BPB.BPB_HEADS
<span style="color:black">BIOSCODE:182A                 </span><span style="color:navy">or      ax, ax          </span>; if we had some cylinder wraps,
<span style="color:black">BIOSCODE:182A                                         </span>; we need to reduce them by on
<span style="color:black">BIOSCODE:182C                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_head_bound
</span><span style="color:black">BIOSCODE:182E                 </span><span style="color:navy">dec     ax              </span>; reduce number of cylinder wraps
<span style="color:black">BIOSCODE:182F
BIOSCODE:182F </span><span style="color:gray">no_head_bound</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:182F                 </span><span style="color:navy">mov     bh, dl          </span>; bh has new head number
<span style="color:black">BIOSCODE:1831                 </span><span style="color:navy">pop     dx              </span>; restore drive number and head number
<span style="color:black">BIOSCODE:1832                 </span><span style="color:navy">dec     bh
</span><span style="color:black">BIOSCODE:1834                 </span><span style="color:navy">mov     dh, bh
</span><span style="color:black">BIOSCODE:1836                 </span><span style="color:navy">mov     bh, cl
</span><span style="color:black">BIOSCODE:1838                 </span><span style="color:navy">and     bh, </span><span style="color:green">3Fh         </span>; preserve sector number
<span style="color:black">BIOSCODE:183B                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">6
</span><span style="color:black">BIOSCODE:183D                 </span><span style="color:navy">xchg    cl, bl
</span><span style="color:black">BIOSCODE:183F                 </span><span style="color:navy">shr     bl, cl          </span>; get ms cylinder bits to ls end
<span style="color:black">BIOSCODE:1841                 </span><span style="color:navy">add     ch, al          </span>; add in cylinder wrap
<span style="color:black">BIOSCODE:1843                 </span><span style="color:navy">adc     bl, ah          </span>; add in high byte
<span style="color:black">BIOSCODE:1845                 </span><span style="color:navy">shl     bl, cl          </span>; move up to ms end
<span style="color:black">BIOSCODE:1847                 </span><span style="color:navy">xchg    bl, cl          </span>; restore cylinder bits into cl
<span style="color:black">BIOSCODE:1849                 </span><span style="color:navy">or      cl, bh          </span>; or in sector number
<span style="color:black">BIOSCODE:184B
BIOSCODE:184B </span><span style="color:gray">no_wrap</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:184B                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:184C                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:184D                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:184E                 </span>assume es:nothing
<span style="color:black">BIOSCODE:184E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:184F                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1850                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1851 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1851
BIOSCODE:1851 </span><span style="color:gray">no_wrap_head</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1851                 </span><span style="color:navy">mov     dh, al          </span>; do not lose new head number
<span style="color:black">BIOSCODE:1853                 </span><span style="color:navy">dec     dh              </span>; get it 0-based
<span style="color:black">BIOSCODE:1855                 </span><span style="color:navy">jmp     short </span><span style="color:gray">no_wrap
</span><span style="color:black">BIOSCODE:1855 </span>check_wrap      <span style="color:black">endp
BIOSCODE:1855
BIOSCODE:1857
BIOSCODE:1857 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1857
BIOSCODE:1857
BIOSCODE:1857 </span>find_bds        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1857                 </span><span style="color:navy">les     di, dword ptr ds:</span>start_bds ; point es:di to first bds
<span style="color:black">BIOSCODE:185B
BIOSCODE:185B </span><span style="color:gray">fbds_1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:185B                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], dl   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:185F                 </span><span style="color:navy">jz      short </span><span style="color:gray">fdbs_2
</span><span style="color:black">BIOSCODE:1861                 </span><span style="color:navy">les     di, es:[di]     </span>; [es:di+BDS.link]
<span style="color:black">BIOSCODE:1861                                         </span>; go to next bds
<span style="color:black">BIOSCODE:1864                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">BIOSCODE:1867                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fbds_1
</span><span style="color:black">BIOSCODE:1869                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:186A
BIOSCODE:186A </span><span style="color:gray">fdbs_2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:186A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:186A </span>find_bds        <span style="color:black">endp
BIOSCODE:186A
BIOSCODE:186B
BIOSCODE:186B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:186B
BIOSCODE:186B
BIOSCODE:186B </span>doint           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:186B                 </span><span style="color:navy">mov     dl, [bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [bp+INT13FRAME.olddx]
<span style="color:black">BIOSCODE:186B                                         </span>; get physical drive number
<span style="color:black">BIOSCODE:186F                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">BIOSCODE:1871                 </span><span style="color:navy">or      al, al
</span><span style="color:black">BIOSCODE:1873                 </span><span style="color:navy">jz      short </span><span style="color:gray">dointdone </span>; if zero sectors, return ax=0
<span style="color:black">BIOSCODE:1875                 </span><span style="color:navy">mov     ah, [bp+</span><span style="color:#ff8000">3</span><span style="color:navy">]      </span>; [bp+INT13FRAME.oldax+1]
<span style="color:black">BIOSCODE:1875                                         </span>; get request code
<span style="color:black">BIOSCODE:1879                 </span><span style="color:navy">push    word ptr [bp+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; [bp+INT13FRAME.oldf]
<span style="color:black">BIOSCODE:187D                 </span><span style="color:navy">popf
</span><span style="color:black">BIOSCODE:187E                 </span><span style="color:navy">call    </span>70h:70Bh        ; call BIOSDATA:call_orig13
<span style="color:black">BIOSCODE:187E                                         </span>; call DOSBIOSSEG:call_orig13
<span style="color:black">BIOSCODE:1883                 </span><span style="color:navy">pushf
</span><span style="color:black">BIOSCODE:1884                 </span><span style="color:navy">pop     word ptr [bp+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; [bp+INT13FRAME.oldf]
<span style="color:black">BIOSCODE:1888
BIOSCODE:1888 </span><span style="color:gray">dointdone</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1888                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1888 </span>doint           <span style="color:black">endp
BIOSCODE:1888
BIOSCODE:1888 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:1889 </span>dtype_array     <span style="color:navy">dd </span><span style="color:#008040">400090h              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:1889                                         </span>; 40h:90h is drive type array
<span style="color:maroon">BIOSCODE:188D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:188D
BIOSCODE:188D </span>format_special_stuff<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:188D                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; do we have changeline support?
<span style="color:maroon">BIOSCODE:1892                 </span><span style="color:navy">jz      short </span>format_special_stuff_done ; brif not
<span style="color:maroon">BIOSCODE:1894                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:1895                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">140h        </span>; fchanged_by_format+fchanged
<span style="color:maroon">BIOSCODE:1898                 </span><span style="color:navy">call    </span>Set_Changed_DL  ; indicate that media changed by format
<span style="color:maroon">BIOSCODE:189B                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:189C                 </span><span style="color:navy">jmp     short </span>format_special_stuff_done
<span style="color:maroon">BIOSCODE:189E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:189E
BIOSCODE:189E </span>ec35_special_stuff<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:189E                 </span><span style="color:navy">test    dl, dl          </span>; floppy or hard disk?
<span style="color:maroon">BIOSCODE:18A0                 </span><span style="color:navy">js      short </span>ec35_special_stuff_done ; if hard drive, we&#039;re done
<span style="color:maroon">BIOSCODE:18A2                 </span><span style="color:navy">push    ax              </span>; see if this PARTICULAR drive is ec35
<span style="color:maroon">BIOSCODE:18A3                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:18A4                 </span><span style="color:navy">mov     cl, dl          </span>; turn drive number into bit map
<span style="color:maroon">BIOSCODE:18A6                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; assume drive 0
<span style="color:maroon">BIOSCODE:18A8                 </span><span style="color:navy">shl     al, cl          </span>; shift over correct number of times
<span style="color:maroon">BIOSCODE:18AA                 </span><span style="color:navy">test    ds:</span>ec35_flag<span style="color:navy">, al </span>; electrically compatible 3.5 incher?
<span style="color:maroon">BIOSCODE:18AE                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:18AF                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSCODE:18B0                 </span><span style="color:navy">jz      short </span>ec35_special_stuff_done ; done if this floppy is not an ec35
<span style="color:maroon">BIOSCODE:18B2                 </span><span style="color:navy">push    bx              </span>; free up a far pointer (es:bx)
<span style="color:maroon">BIOSCODE:18B3                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:18B4                 </span><span style="color:navy">les     bx, cs:</span>dtype_array
<span style="color:maroon">BIOSCODE:18B9                 </span><span style="color:navy">add     bl, dl
</span><span style="color:maroon">BIOSCODE:18BB                 </span><span style="color:navy">adc     bh, </span><span style="color:#ff8000">0           </span>; find entry for this drive
<span style="color:maroon">BIOSCODE:18BE                 </span><span style="color:navy">mov     byte ptr es:[bx], </span><span style="color:#ff8000">93h </span>; establish drive type as:
<span style="color:maroon">BIOSCODE:18BE                                         </span>; (360k disk in 360k drive,
<span style="color:maroon">BIOSCODE:18BE                                         </span>; no double-stepping, 250 kbs transfer rate)
<span style="color:maroon">BIOSCODE:18C2                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:18C3                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:18C4                 </span><span style="color:navy">jmp     short </span>ec35_special_stuff_done
<span style="color:maroon">BIOSCODE:18C6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:18C6
BIOSCODE:18C6 </span>ps2_special_stuff<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:18C6                 </span><span style="color:navy">cmp     ds:</span>prevoper<span style="color:navy">, </span><span style="color:#ff8000">8  </span>; (ps2_30)
<span style="color:maroon">BIOSCODE:18C6                                         </span>; read driver parm?
<span style="color:maroon">BIOSCODE:18CB                 </span><span style="color:navy">jz      short </span>ps2_30_problem
<span style="color:maroon">BIOSCODE:18CD                 </span><span style="color:navy">cmp     ds:</span>prevoper<span style="color:navy">, </span><span style="color:#ff8000">15h </span>; apparently function 15h fails, too
<span style="color:maroon">BIOSCODE:18D2                 </span><span style="color:navy">jnz     short </span>ps2_special_stuff_done
<span style="color:maroon">BIOSCODE:18D4
BIOSCODE:18D4 </span>ps2_30_problem<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:18D4                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSCODE:18D5                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:18D7                 </span><span style="color:navy">call    </span>70h:70Bh        ; call BIOSDATA:call_orig13
<span style="color:maroon">BIOSCODE:18DC                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSCODE:18DD                 </span><span style="color:navy">jmp     short </span>ps2_special_stuff_done
<span style="color:maroon">BIOSCODE:18DF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:18DF
BIOSCODE:18DF </span>i13z<span style="color:navy">:                                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">BIOSCODE:18DF                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:18E0                 </span><span style="color:navy">mov     ds, cs:</span>Bios_Data_Word
<span style="color:maroon">BIOSCODE:18E5                 </span><span style="color:navy">mov     ds:</span>prevoper<span style="color:navy">, ax </span>; save request
<span style="color:maroon">BIOSCODE:18E8                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">5           </span>; romformat
<span style="color:maroon">BIOSCODE:18EB                 </span><span style="color:navy">jz      short </span>format_special_stuff
<span style="color:maroon">BIOSCODE:18ED
BIOSCODE:18ED </span>format_special_stuff_done<span style="color:navy">:              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:18ED                 </span><span style="color:navy">cmp     ds:</span>ec35_flag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; any electrically compat 3.5 inchers?
<span style="color:maroon">BIOSCODE:18F2                 </span><span style="color:navy">jnz     short </span>ec35_special_stuff ; go handle it out of line if so
<span style="color:maroon">BIOSCODE:18F4
BIOSCODE:18F4 </span>ec35_special_stuff_done<span style="color:navy">:                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:18F4                 </span><span style="color:navy">call    </span>70h:70Bh        ; call BIOSDATA:call_orig13
<span style="color:maroon">BIOSCODE:18F9                 </span><span style="color:navy">pushf
</span><span style="color:maroon">BIOSCODE:18FA                 </span><span style="color:navy">cmp     ds:</span>model_byte<span style="color:navy">, </span><span style="color:#ff8000">0FAh </span>; is this a ps2/30?
<span style="color:maroon">BIOSCODE:18FA                                         </span>; mdl_ps2_30
<span style="color:maroon">BIOSCODE:18FF                 </span><span style="color:navy">jz      short </span>ps2_special_stuff ; exit mainline to address special
<span style="color:maroon">BIOSCODE:1901
BIOSCODE:1901 </span>ps2_special_stuff_done<span style="color:navy">:                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1901                 </span><span style="color:navy">popf
</span><span style="color:maroon">BIOSCODE:1902                 </span><span style="color:navy">jb      short </span>goterr13  ; error on original orig13 call-thru?
<span style="color:maroon">BIOSCODE:1904
BIOSCODE:1904 </span>ret_from_i13<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1904                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1905                 </span>assume ds:nothing
<span style="color:maroon">BIOSCODE:1905                 </span><span style="color:navy">retf    </span><span style="color:green">2               </span>; restore ds &amp; iret w/flags
<span style="color:maroon">BIOSCODE:1908 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1908
BIOSCODE:1908 </span>i13ret_ck_chglinerr<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1908                 </span><span style="color:navy">jnb     short </span>ret_from_i13 ; done if not an error termination
<span style="color:maroon">BIOSCODE:190A
BIOSCODE:190A </span>i13_ret_error<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:190A                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">6           </span>; did i see a change event?
<span style="color:maroon">BIOSCODE:190D                 </span><span style="color:navy">jnz     short </span>int13b    ; skip if wrong error
<span style="color:maroon">BIOSCODE:190F                 </span><span style="color:navy">or      dl, dl          </span>; is this for the hard disk?
<span style="color:maroon">BIOSCODE:1911                 </span><span style="color:navy">js      short </span>int13b    ; yes, ignore
<span style="color:maroon">BIOSCODE:1913                 </span><span style="color:navy">cmp     ds:</span>fhave96<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">BIOSCODE:1918                 </span><span style="color:navy">jz      short </span>int13b    ; just in case ROM returned this
<span style="color:maroon">BIOSCODE:1918                                         </span>; error even though it told us it
<span style="color:maroon">BIOSCODE:1918                                         </span>; never would
<span style="color:maroon">BIOSCODE:191A                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:191B                 </span><span style="color:navy">mov     bx, </span><span style="color:green">40h         </span>; fchanged
<span style="color:maroon">BIOSCODE:191E                 </span><span style="color:navy">call    </span>Set_Changed_DL
<span style="color:maroon">BIOSCODE:1921                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:1922
BIOSCODE:1922 </span>int13b<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1922                 </span><span style="color:navy">stc                     </span>; now return the error
<span style="color:maroon">BIOSCODE:1923                 </span><span style="color:navy">jmp     short </span>ret_from_i13
<span style="color:maroon">BIOSCODE:1925 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1925
BIOSCODE:1925 </span>goterr13<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1925                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">9           </span>; dma error?
<span style="color:maroon">BIOSCODE:1928                 </span><span style="color:navy">jz      short </span>gotdmaerr
<span style="color:maroon">BIOSCODE:192A
BIOSCODE:192A </span>goterr13_xxxx<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:192A                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">11h         </span>; ecc error?
<span style="color:maroon">BIOSCODE:192D                 </span><span style="color:navy">jnz     short </span>i13_ret_error ; other error. just return back.
<span style="color:maroon">BIOSCODE:192F                 </span><span style="color:navy">cmp     ds:</span>media_set_for_format<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; formatting?
<span style="color:maroon">BIOSCODE:1934                 </span><span style="color:navy">jz      short </span>i13_ret_error
<span style="color:maroon">BIOSCODE:1936                 </span><span style="color:navy">cmp     byte ptr ds:</span>prevoper<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">2 </span>; ecc-corrected error
<span style="color:maroon">BIOSCODE:1936                                         </span>; (2 = romread)
<span style="color:maroon">BIOSCODE:1936                                         </span>; ECC correction only applies to reads
<span style="color:maroon">BIOSCODE:193B                 </span><span style="color:navy">jnz     short </span>i13_ret_error
<span style="color:maroon">BIOSCODE:193D                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">BIOSCODE:193F                 </span><span style="color:navy">call    </span>70h:70Bh        ; call BIOSDATA:call_orig13
<span style="color:maroon">BIOSCODE:193F                                         </span>; call DOSBIOSSEG:call_orig13
<span style="color:maroon">BIOSCODE:1944                 </span><span style="color:navy">mov     ax, ds:</span>prevoper
<span style="color:maroon">BIOSCODE:1947                 </span><span style="color:navy">xor     ah, ah          </span>; return code = no error
<span style="color:maroon">BIOSCODE:1949                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; if request for one sector, assume ok
<span style="color:maroon">BIOSCODE:194B                 </span><span style="color:navy">jz      short </span>ret_from_i13 ; return with carry clear
<span style="color:maroon">BIOSCODE:194D                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:194E                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:194F                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">BIOSCODE:1950                 </span><span style="color:navy">mov     ds:</span>number_of_sec<span style="color:navy">, al
</span><span style="color:maroon">BIOSCODE:1953
BIOSCODE:1953 </span>loop_ecc<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1953                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h        </span>; read one sector
<span style="color:maroon">BIOSCODE:1956                 </span><span style="color:navy">call    </span>check_wrap      ; get correct parameters for int 13
<span style="color:maroon">BIOSCODE:1959                 </span><span style="color:navy">call    </span>70h:70Bh        ; call BIOSDATA:call_orig13
<span style="color:maroon">BIOSCODE:1959                                         </span>; call DOSBIOSSEG:call_orig13
<span style="color:maroon">BIOSCODE:195E                 </span><span style="color:navy">jnb     short </span>ok11_op
<span style="color:maroon">BIOSCODE:1960                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">9           </span>; DMA error during ECC read?
<span style="color:maroon">BIOSCODE:1963                 </span><span style="color:navy">jz      short </span>handle_dma_during_ecc
<span style="color:maroon">BIOSCODE:1965                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">11h         </span>; only allow ecc errors
<span style="color:maroon">BIOSCODE:1968                 </span><span style="color:navy">jnz     short </span>ok11_exit_err
<span style="color:maroon">BIOSCODE:196A                 </span><span style="color:navy">xor     ax, ax          </span>; ecc error. reset the system again.
<span style="color:maroon">BIOSCODE:196A                                         </span>; clear the error code so that if this
<span style="color:maroon">BIOSCODE:196A                                         </span>; was the last sector, no error code
<span style="color:maroon">BIOSCODE:196A                                         </span>; will be returned for the corrected read.
<span style="color:maroon">BIOSCODE:196A                                         </span>; (clear carry too.)
<span style="color:maroon">BIOSCODE:196C
BIOSCODE:196C </span>ok11_op<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:196C                 </span><span style="color:navy">dec     ds:</span>number_of_sec
<span style="color:maroon">BIOSCODE:1970                 </span><span style="color:navy">jz      short </span>ok11_exit ; all done?
<span style="color:maroon">BIOSCODE:1972                 </span><span style="color:navy">inc     cl              </span>; advance sector number
<span style="color:maroon">BIOSCODE:1972                                         </span>; add 200h to address
<span style="color:maroon">BIOSCODE:1974                 </span><span style="color:navy">inc     bh
</span><span style="color:maroon">BIOSCODE:1976                 </span><span style="color:navy">inc     bh
</span><span style="color:maroon">BIOSCODE:1978                 </span><span style="color:navy">jmp     short </span>loop_ecc
<span style="color:maroon">BIOSCODE:197A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:197A
BIOSCODE:197A </span>ok11_exit_err<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:197A                 </span><span style="color:navy">stc                     </span>; set carry bit again.
<span style="color:maroon">BIOSCODE:197B
BIOSCODE:197B </span>ok11_exit<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:197B                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSCODE:197C                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:197D                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:197E                 </span><span style="color:navy">jmp     short </span>i13ret_ck_chglinerr
<span style="color:maroon">BIOSCODE:1980 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1980
BIOSCODE:1980 </span>handle_dma_during_ecc<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1980                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:1981                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:1982                 </span><span style="color:navy">mov     bx, offset </span>disksector ; BIOSDATA:0152h
<span style="color:maroon">BIOSCODE:1985                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1986                 </span><span style="color:navy">pop     es              </span>; point es:bx to buffer
<span style="color:maroon">BIOSCODE:1987                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">201h        </span>; read one sector
<span style="color:maroon">BIOSCODE:198A                 </span><span style="color:navy">call    </span>70h:70Bh        ; call BIOSDATA:call_orig13
<span style="color:maroon">BIOSCODE:198F                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:1990                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1991                 </span><span style="color:navy">jnb     short </span>handle_dma_during_ecc_noerr
<span style="color:maroon">BIOSCODE:1993                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">11h
</span><span style="color:maroon">BIOSCODE:1996                 </span><span style="color:navy">jnz     short </span>ok11_exit_err
<span style="color:maroon">BIOSCODE:1998
BIOSCODE:1998 </span>handle_dma_during_ecc_noerr<span style="color:navy">:            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1998                 </span><span style="color:navy">push    si
</span><span style="color:maroon">BIOSCODE:1999                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:199A                 </span><span style="color:navy">mov     di, bx
</span><span style="color:maroon">BIOSCODE:199C                 </span><span style="color:navy">mov     si, offset </span>disksector
<span style="color:maroon">BIOSCODE:199F                 </span><span style="color:navy">call    </span>move_sector
<span style="color:maroon">BIOSCODE:19A2                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSCODE:19A3                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">BIOSCODE:19A4                 </span><span style="color:navy">jmp     short </span>ok11_op
<span style="color:maroon">BIOSCODE:19A6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:19A6
BIOSCODE:19A6 </span>gotdmaerr<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:19A6                 </span><span style="color:navy">mov     ax, ds:</span>prevoper
<span style="color:maroon">BIOSCODE:19A9                 </span><span style="color:navy">sti
</span><span style="color:maroon">BIOSCODE:19AA                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">2           </span>; romread
<span style="color:maroon">BIOSCODE:19AD                 </span><span style="color:navy">jb      short </span>i13_done_dmaerr
<span style="color:maroon">BIOSCODE:19AF                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4           </span>; romverify
<span style="color:maroon">BIOSCODE:19B2                 </span><span style="color:navy">jz      short </span>intverify
<span style="color:maroon">BIOSCODE:19B4                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">5           </span>; romformat
<span style="color:maroon">BIOSCODE:19B7                 </span><span style="color:navy">jz      short </span>intformat
<span style="color:maroon">BIOSCODE:19B9                 </span><span style="color:navy">ja      short </span>i13_done_dmaerr
<span style="color:maroon">BIOSCODE:19BB                 </span><span style="color:navy">push    dx              </span>; set up stack frame here!
<span style="color:maroon">BIOSCODE:19BC                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:19BD                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:19BE                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSCODE:19BF                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">BIOSCODE:19C0                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">BIOSCODE:19C2                 </span><span style="color:navy">mov     dx, es          </span>; check for 64k boundary error
<span style="color:maroon">BIOSCODE:19C4                 </span><span style="color:navy">add     dx, dx
</span><span style="color:maroon">BIOSCODE:19C6                 </span><span style="color:navy">add     dx, dx
</span><span style="color:maroon">BIOSCODE:19C8                 </span><span style="color:navy">add     dx, dx
</span><span style="color:maroon">BIOSCODE:19CA                 </span><span style="color:navy">add     dx, dx          </span>; dx = dx*16
<span style="color:maroon">BIOSCODE:19CC                 </span><span style="color:navy">add     dx, bx
</span><span style="color:maroon">BIOSCODE:19CE                 </span><span style="color:navy">add     dx, </span><span style="color:green">511
</span><span style="color:maroon">BIOSCODE:19D2                 </span><span style="color:navy">jnb     short </span>no_skip_first
<span style="color:maroon">BIOSCODE:19D4                 </span><span style="color:navy">jmp     </span>bufferx         ; restore dh=head &amp; do buffer
<span style="color:maroon">BIOSCODE:19D7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:19D7
BIOSCODE:19D7 </span>no_skip_first<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:19D7                 </span><span style="color:navy">shr     dh, </span><span style="color:green">1           </span>; dh = number of sectors before address
<span style="color:maroon">BIOSCODE:19D9                 </span><span style="color:navy">mov     ah, </span><span style="color:green">128         </span>; ah = max number of sectors in segment
<span style="color:maroon">BIOSCODE:19DB                 </span><span style="color:navy">sub     ah, dh
</span><span style="color:maroon">BIOSCODE:19DD                 </span><span style="color:navy">cmp     ah, al          </span>; can we fit it in?
<span style="color:maroon">BIOSCODE:19DF                 </span><span style="color:navy">jb      short </span>doblock   ; no, perform blocking.
<span style="color:maroon">BIOSCODE:19DF                                         </span>; yes, the request fits. let it happen
<span style="color:maroon">BIOSCODE:19E1                 </span><span style="color:navy">mov     dh, [bp+</span><span style="color:#ff8000">9</span><span style="color:navy">]      </span>; [bp+INT13FRAME.olddx+1]
<span style="color:maroon">BIOSCODE:19E1                                         </span>; set up head number
<span style="color:maroon">BIOSCODE:19E4                 </span><span style="color:navy">call    </span>doint
<span style="color:maroon">BIOSCODE:19E7                 </span><span style="color:navy">jmp     </span>bad13           ; and return from this place
<span style="color:maroon">BIOSCODE:19EA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:19EA
BIOSCODE:19EA </span>i13_done_dmaerr<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:19EA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">9           </span>; pass dma error thru to caller
<span style="color:maroon">BIOSCODE:19EC                 </span><span style="color:navy">stc
</span><span style="color:maroon">BIOSCODE:19ED                 </span><span style="color:navy">jmp     </span>ret_from_i13    ; return with error,
<span style="color:maroon">BIOSCODE:19ED                                         </span>; we know it&#039;s not a changeline error
<span style="color:maroon">BIOSCODE:19F0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:19F0
BIOSCODE:19F0 </span>intverify<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:19F0                 </span><span style="color:navy">push    es              </span>; save caller&#039;s dma address
<span style="color:maroon">BIOSCODE:19F1                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:19F2                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:19F3                 </span><span style="color:navy">pop     es              </span>; es:bx -&gt; BIOSDATA:disksector
<span style="color:maroon">BIOSCODE:19F4
BIOSCODE:19F4 </span>dosimple<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:19F4                 </span><span style="color:navy">mov     bx, offset </span>disksector
<span style="color:maroon">BIOSCODE:19F7                 </span><span style="color:navy">call    </span>70h:70Bh        ; call DOSBIOSSEG:call_orig13
<span style="color:maroon">BIOSCODE:19F7                                         </span>; call BIOSDATA:call_orig13
<span style="color:maroon">BIOSCODE:19FC                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:19FD                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:19FE                 </span><span style="color:navy">jmp     </span>i13ret_ck_chglinerr
<span style="color:maroon">BIOSCODE:1A01 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1A01
BIOSCODE:1A01 </span>intformat<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A01                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:1A02                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:1A03                 </span><span style="color:navy">push    si
</span><span style="color:maroon">BIOSCODE:1A04                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:1A05                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1A06                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:1A07                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1A08                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1A09                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1A0A                 </span><span style="color:navy">mov     si, bx
</span><span style="color:maroon">BIOSCODE:1A0C                 </span><span style="color:navy">mov     di, offset </span>disksector
<span style="color:maroon">BIOSCODE:1A0F                 </span><span style="color:navy">call    </span>move_sector     ; user&#039;s data into BIOSDATA:disksector
<span style="color:maroon">BIOSCODE:1A12                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1A13                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSCODE:1A14                 </span><span style="color:navy">pop     si              </span>; do the i/o from
<span style="color:maroon">BIOSCODE:1A15                 </span><span style="color:navy">jmp     short </span>dosimple  ; BIOSDATA:disksector
<span style="color:maroon">BIOSCODE:1A17 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1A17
BIOSCODE:1A17 </span>doblock<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A17                 </span><span style="color:navy">mov     dx, [bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [bp+INT13FRAME.olddx]
<span style="color:maroon">BIOSCODE:1A17                                         </span>; get head #, drive #
<span style="color:maroon">BIOSCODE:1A1A                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:1A1B                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:1A1C                 </span><span style="color:navy">push    di              </span>; ah - # of sectors before dma boundary
<span style="color:maroon">BIOSCODE:1A1C                                         </span>; al - requested # of sectors for i/o.
<span style="color:maroon">BIOSCODE:1A1D                 </span><span style="color:navy">call    </span>find_bds
<span style="color:maroon">BIOSCODE:1A20                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:maroon">BIOSCODE:1A24                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:di+BDS.flags], fnon_removable
<span style="color:maroon">BIOSCODE:1A2A                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSCODE:1A2B                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1A2C                 </span><span style="color:navy">mov     al, ah          </span>; set al=ah for floppies
<span style="color:maroon">BIOSCODE:1A2E                 </span><span style="color:navy">jz      short </span>doblockflop ; they are track by track operation
<span style="color:maroon">BIOSCODE:1A30                 </span><span style="color:navy">mov     ah, </span><span style="color:green">63          </span>; ah = 63-secpt (# safe sectors??)
<span style="color:maroon">BIOSCODE:1A32                 </span><span style="color:navy">sub     ah, cl          </span>; al - # of sectors before dma boundary
<span style="color:maroon">BIOSCODE:1A34
BIOSCODE:1A34 </span>doblockflop<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A34                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:1A35
BIOSCODE:1A35 </span>doblockcontinue<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A35                 </span><span style="color:navy">cmp     ah, al          </span>; if safe_# &gt;= #_of_sectors_to_go_before dma,
<span style="color:maroon">BIOSCODE:1A37                 </span><span style="color:navy">jnb     short </span>doblocklast ; then #_of_sectors_to_go as it is for doint.
<span style="color:maroon">BIOSCODE:1A39                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSCODE:1A3A                 </span><span style="color:navy">mov     al, ah          </span>; otherwise, set al to ah to operate.
<span style="color:maroon">BIOSCODE:1A3C                 </span><span style="color:navy">jmp     short </span>doblockdoint
<span style="color:maroon">BIOSCODE:1A3E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1A3E
BIOSCODE:1A3E </span>doblocklast<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A3E                 </span><span style="color:navy">mov     ah, al
</span><span style="color:maroon">BIOSCODE:1A40                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">BIOSCODE:1A41
BIOSCODE:1A41 </span>doblockdoint<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A41                 </span><span style="color:navy">call    </span>doint           ; let ah = al = # of sectors for this shot
<span style="color:maroon">BIOSCODE:1A44                 </span><span style="color:navy">jb      short </span>bad13     ; something happened, bye!
<span style="color:maroon">BIOSCODE:1A46                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">BIOSCODE:1A47                 </span><span style="color:navy">sub     [bp+</span><span style="color:#ff8000">2</span><span style="color:navy">], ah      </span>; sub [bp+INT13FRAME.oldax], ah
<span style="color:maroon">BIOSCODE:1A47                                         </span>; decrement by the successful operation
<span style="color:maroon">BIOSCODE:1A4A                 </span><span style="color:navy">add     cl, ah          </span>; advance sector #. safety gauranteed.
<span style="color:maroon">BIOSCODE:1A4C                 </span><span style="color:navy">add     bh, ah          </span>; advance dma address
<span style="color:maroon">BIOSCODE:1A4E                 </span><span style="color:navy">add     bh, ah          </span>; twice for 512 byte sectors
<span style="color:maroon">BIOSCODE:1A50                 </span><span style="color:navy">cmp     ah, al          </span>; check the previous value
<span style="color:maroon">BIOSCODE:1A52                 </span><span style="color:navy">jz      short </span>buffer    ; if #_of_sectors_to_go &lt; safe_#,
<span style="color:maroon">BIOSCODE:1A52                                         </span>; then we are done already.
<span style="color:maroon">BIOSCODE:1A54                 </span><span style="color:navy">sub     al, ah          </span>; otherwise,
<span style="color:maroon">BIOSCODE:1A54                                         </span>; #_sector_to_go = #_of_sector_to_go - safe_#
<span style="color:maroon">BIOSCODE:1A56                 </span><span style="color:navy">call    </span>check_wrap      ; get new cx, dh for the next operation.
<span style="color:maroon">BIOSCODE:1A59                 </span><span style="color:navy">jmp     short </span>doblockcontinue ; handles next sectors left.
<span style="color:maroon">BIOSCODE:1A5B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1A5B
BIOSCODE:1A5B </span>bufferx<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A5B                 </span><span style="color:navy">mov     dh, [bp+</span><span style="color:#ff8000">9</span><span style="color:navy">]      </span>; [bp+INT13FRAME.olddx+1]
<span style="color:maroon">BIOSCODE:1A5B                                         </span>; set up head number
<span style="color:maroon">BIOSCODE:1A5E
BIOSCODE:1A5E </span>buffer<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A5E                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:1A5F                 </span><span style="color:navy">mov     ah, [bp+</span><span style="color:#ff8000">3</span><span style="color:navy">]      </span>; [bp+INT13FRAME.oldax+1]
<span style="color:maroon">BIOSCODE:1A62                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">3           </span>; romwrite
<span style="color:maroon">BIOSCODE:1A65                 </span><span style="color:navy">jnz     short </span>doread
<span style="color:maroon">BIOSCODE:1A67                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:1A68                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1A69                 </span><span style="color:navy">push    si
</span><span style="color:maroon">BIOSCODE:1A6A                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:1A6B                 </span><span style="color:navy">push    ds              </span>; exchange segment registers
<span style="color:maroon">BIOSCODE:1A6C                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:1A6D                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">BIOSCODE:1A6E                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1A6F                 </span><span style="color:navy">mov     di, offset </span>disksector ; where to move
<span style="color:maroon">BIOSCODE:1A72                 </span><span style="color:navy">push    di              </span>; save it
<span style="color:maroon">BIOSCODE:1A73                 </span><span style="color:navy">mov     si, bx          </span>; source
<span style="color:maroon">BIOSCODE:1A75                 </span><span style="color:navy">call    </span>move_sector     ; move sector into local buffer
<span style="color:maroon">BIOSCODE:1A78                 </span><span style="color:navy">pop     bx              </span>; new transfer address
<span style="color:maroon">BIOSCODE:1A78                                         </span>; (es:bx = BIOSDATA:disksector)
<span style="color:maroon">BIOSCODE:1A79                 </span><span style="color:navy">pop     di              </span>; restore caller&#039;s di &amp; si
<span style="color:maroon">BIOSCODE:1A7A                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">BIOSCODE:1A7B                 </span><span style="color:navy">pop     ds              </span>; restore BIOSDATA
<span style="color:maroon">BIOSCODE:1A7C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:1A7E                 </span><span style="color:navy">mov     dl, [bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [bp+INT13FRAME.olddx]
<span style="color:maroon">BIOSCODE:1A7E                                         </span>; get drive number
<span style="color:maroon">BIOSCODE:1A81                 </span><span style="color:navy">call    </span>check_wrap      ; sets up registers if wrap-around
<span style="color:maroon">BIOSCODE:1A81                                         </span>;
<span style="color:maroon">BIOSCODE:1A81                                         </span>; ah is function
<span style="color:maroon">BIOSCODE:1A81                                         </span>; al is 1 for single sector transfer
<span style="color:maroon">BIOSCODE:1A81                                         </span>; es:bx is local transfer addres
<span style="color:maroon">BIOSCODE:1A81                                         </span>; cx is track/sector number
<span style="color:maroon">BIOSCODE:1A81                                         </span>; dx is head/drive number
<span style="color:maroon">BIOSCODE:1A81                                         </span>; si, di unchanged
<span style="color:maroon">BIOSCODE:1A84                 </span><span style="color:navy">call    </span>doint
<span style="color:maroon">BIOSCODE:1A87                 </span><span style="color:navy">pop     es              </span>; restore caller&#039;s dma segment
<span style="color:maroon">BIOSCODE:1A88                 </span><span style="color:navy">jb      short </span>bad13     ; go clean up
<span style="color:maroon">BIOSCODE:1A8A                 </span><span style="color:navy">jmp     short </span>dotail
<span style="color:maroon">BIOSCODE:1A8C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1A8C
BIOSCODE:1A8C </span>doread<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1A8C                 </span><span style="color:navy">push    es
</span><span style="color:maroon">BIOSCODE:1A8D                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">BIOSCODE:1A8E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">BIOSCODE:1A8F                 </span><span style="color:navy">pop     es              </span>; es = BIOSCODE segment
<span style="color:maroon">BIOSCODE:1A90                 </span><span style="color:navy">mov     bx, offset </span>disksector
<span style="color:maroon">BIOSCODE:1A93                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">BIOSCODE:1A95                 </span><span style="color:navy">mov     dl, [bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [bp+INT13FRAME.olddx]
<span style="color:maroon">BIOSCODE:1A95                                         </span>; get drive number
<span style="color:maroon">BIOSCODE:1A98                 </span><span style="color:navy">call    </span>check_wrap      ; ah = function
<span style="color:maroon">BIOSCODE:1A98                                         </span>; al = 1 for single sector
<span style="color:maroon">BIOSCODE:1A98                                         </span>; es:bx points to local   buffer
<span style="color:maroon">BIOSCODE:1A98                                         </span>; cx, dx are track/sector, head/drive
<span style="color:maroon">BIOSCODE:1A9B                 </span><span style="color:navy">call    </span>doint
<span style="color:maroon">BIOSCODE:1A9E                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:1A9F                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">BIOSCODE:1AA0                 </span><span style="color:navy">jb      short </span>bad13
<span style="color:maroon">BIOSCODE:1AA2                 </span><span style="color:navy">push    si
</span><span style="color:maroon">BIOSCODE:1AA3                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:1AA4                 </span><span style="color:navy">mov     di, bx
</span><span style="color:maroon">BIOSCODE:1AA6                 </span><span style="color:navy">mov     si, offset </span>disksector
<span style="color:maroon">BIOSCODE:1AA9                 </span><span style="color:navy">call    </span>move_sector
<span style="color:maroon">BIOSCODE:1AAC                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">BIOSCODE:1AAD                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">BIOSCODE:1AAE
BIOSCODE:1AAE </span>dotail<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1AAE                 </span><span style="color:navy">pop     bx              </span>; retrieve new dma area
<span style="color:maroon">BIOSCODE:1AAF                 </span><span style="color:navy">add     bh, </span><span style="color:#ff8000">2           </span>; advance over sector
<span style="color:maroon">BIOSCODE:1AB2                 </span><span style="color:navy">inc     cx
</span><span style="color:maroon">BIOSCODE:1AB3                 </span><span style="color:navy">mov     al, [bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; [bp+INT13FRAME.oldax]
<span style="color:maroon">BIOSCODE:1AB6                 </span><span style="color:navy">clc
</span><span style="color:maroon">BIOSCODE:1AB7                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">BIOSCODE:1AB9                 </span><span style="color:navy">jz      short </span>bad13     ; no more i/o
<span style="color:maroon">BIOSCODE:1ABB                 </span><span style="color:navy">mov     dl, [bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [bp+INT13FRAME.olddx]
<span style="color:maroon">BIOSCODE:1ABE                 </span><span style="color:navy">call    </span>check_wrap
<span style="color:maroon">BIOSCODE:1AC1                 </span><span style="color:navy">call    </span>doint
<span style="color:maroon">BIOSCODE:1AC4
BIOSCODE:1AC4 </span>bad13<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1AC4                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:maroon">BIOSCODE:1AC6                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">BIOSCODE:1AC7                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:1AC8                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">BIOSCODE:1AC9                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">BIOSCODE:1ACA                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">BIOSCODE:1ACB                 </span><span style="color:navy">jb      short </span>xgoterr13_xxxx ; go handle ECC errors
<span style="color:maroon">BIOSCODE:1ACD                 </span><span style="color:navy">jmp     </span>ret_from_i13    ; non-error exit
<span style="color:maroon">BIOSCODE:1AD0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1AD0
BIOSCODE:1AD0 </span>xgoterr13_xxxx<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1AD0                 </span><span style="color:navy">jmp     </span>goterr13_xxxx
<span style="color:maroon">BIOSCODE:1AD0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">BIOSCODE:1AD3                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:black">BIOSCODE:1AD4
BIOSCODE:1AD4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1AD4
BIOSCODE:1AD4
BIOSCODE:1AD4 </span>dsk_init        <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">BIOSCODE:1AD4                 </span><span style="color:navy">mov     ah, ds:</span>drvmax
<span style="color:black">BIOSCODE:1AD8                 </span><span style="color:navy">mov     di, offset </span>dskdrvs ; pass result in es:di
<span style="color:black">BIOSCODE:1ADB                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:1ADC                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1ADD                 </span><span style="color:navy">jmp     </span>SetPtrSav
<span style="color:black">BIOSCODE:1ADD </span>dsk_init        <span style="color:black">endp
BIOSCODE:1ADD
BIOSCODE:1AE0
BIOSCODE:1AE0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1AE0
BIOSCODE:1AE0
BIOSCODE:1AE0 </span>install_bds     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1AE0                 </span><span style="color:navy">push    ds              </span>; save Bios_Data (BIOSDATA) segment
<span style="color:black">BIOSCODE:1AE1                 </span><span style="color:navy">mov     si, offset </span>start_bds ; beginning of chain
<span style="color:black">BIOSCODE:1AE4
BIOSCODE:1AE4 </span><span style="color:gray">loop_next_bds</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1AE4                 </span><span style="color:navy">lds     si, [si]        </span>; [si+BDS.link]
<span style="color:black">BIOSCODE:1AE4                                         </span>; fetch next bds
<span style="color:black">BIOSCODE:1AE6                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1AEA                 </span><span style="color:navy">cmp     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], al      </span>; does this one share a physical
<span style="color:black">BIOSCODE:1AEA                                         </span>; drive with new one?
<span style="color:black">BIOSCODE:1AED                 </span><span style="color:navy">jnz     short </span><span style="color:gray">next_bds
</span><span style="color:black">BIOSCODE:1AEF                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">10h         </span>; fi_am_mult
<span style="color:black">BIOSCODE:1AF1                 </span><span style="color:navy">or      es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], bl </span>; [es:di+BDS.flags]
<span style="color:black">BIOSCODE:1AF1                                         </span>; set both of them to i_am_mult if so
<span style="color:black">BIOSCODE:1AF5                 </span><span style="color:navy">or      [si+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], bl    </span>; [si+BDS.flags]
<span style="color:black">BIOSCODE:1AF8                 </span><span style="color:navy">and     byte ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">0DFh </span>; [es:di+BDS.flags],~fi_own_physical
<span style="color:black">BIOSCODE:1AF8                                         </span>; we don&#039;t own it
<span style="color:black">BIOSCODE:1AFD                 </span><span style="color:navy">mov     bl, [si+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">]    </span>; [si+BDS.flags]
<span style="color:black">BIOSCODE:1AFD                                         </span>; determine if changeline available
<span style="color:black">BIOSCODE:1B00                 </span><span style="color:navy">and     bl, </span><span style="color:green">2           </span>; fchangeline
<span style="color:black">BIOSCODE:1B03                 </span><span style="color:navy">or      es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], bl </span>; [es:di+BDS.flags]
<span style="color:black">BIOSCODE:1B07
BIOSCODE:1B07 </span><span style="color:gray">next_bds</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1B07                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">BIOSCODE:1B0A                 </span><span style="color:navy">cmp     [si], ax        </span>; [si+BDS.link],-1
<span style="color:black">BIOSCODE:1B0A                                         </span>; are we at end of list?
<span style="color:black">BIOSCODE:1B0C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">loop_next_bds
</span><span style="color:black">BIOSCODE:1B0E                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], es </span>; [si+BDS.link+2], es
<span style="color:black">BIOSCODE:1B0E                                         </span>; install bds
<span style="color:black">BIOSCODE:1B11                 </span><span style="color:navy">mov     [si], di
</span><span style="color:black">BIOSCODE:1B13                 </span><span style="color:navy">mov     es:[di], ax     </span>; [es:di+BDS.link],-1
<span style="color:black">BIOSCODE:1B13                                         </span>; set next pointer to null
<span style="color:black">BIOSCODE:1B16                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:1B17                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">50h</span><span style="color:navy">] </span>; [es:di+BDS.rsecpertrack]
<span style="color:black">BIOSCODE:1B1B                 </span><span style="color:navy">cmp     al, ds:</span>eot
<span style="color:black">BIOSCODE:1B1F                 </span><span style="color:navy">jbe     short </span><span style="color:gray">_eot_ok
</span><span style="color:black">BIOSCODE:1B21                 </span><span style="color:navy">mov     ds:</span>eot<span style="color:navy">, al
</span><span style="color:black">BIOSCODE:1B24
BIOSCODE:1B24 </span><span style="color:gray">_eot_ok</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1B24                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1B24 </span>install_bds     <span style="color:black">endp
BIOSCODE:1B24
BIOSCODE:1B25
BIOSCODE:1B25 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1B25
BIOSCODE:1B25
BIOSCODE:1B25 </span>swpdsk          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1B25                 </span><span style="color:navy">test    ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1  </span>; Is win386 present?
<span style="color:black">BIOSCODE:1B2A                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_win386 </span>; no, skip SetFocus
<span style="color:black">BIOSCODE:1B2C                 </span><span style="color:navy">call    </span>far ptr 70h:813h ; call DOSBIOSSEG:V86_Crit_SetFocus
<span style="color:black">BIOSCODE:1B2C                                         </span>; call BIOSDATA:V86_Crit_SetFocus
<span style="color:black">BIOSCODE:1B31
BIOSCODE:1B31 </span><span style="color:gray">no_win386</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1B31                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:1B32                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:1B33                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:di+BDS.drivelet]
<span style="color:black">BIOSCODE:1B33                                         </span>; get the drive letter
<span style="color:black">BIOSCODE:1B37                 </span><span style="color:navy">mov     dh, dl
</span><span style="color:black">BIOSCODE:1B39                 </span><span style="color:navy">xor     dh, </span><span style="color:green">1
</span><span style="color:black">BIOSCODE:1B3C                 </span><span style="color:navy">sub     cx, cx          </span>; nobody has handled swap disk
<span style="color:black">BIOSCODE:1B3E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A00h       </span>; multMULT&lt;&lt;8)|multMULTSWPDSK
<span style="color:black">BIOSCODE:1B3E                                         </span>; broadcast code for swap disk
<span style="color:black">BIOSCODE:1B3E                                         </span>; Broadcast it
<span style="color:black">BIOSCODE:1B41                 </span><span style="color:navy">int     </span><span style="color:green">2Fh
</span><span style="color:black">BIOSCODE:1B43                 </span><span style="color:navy">inc     cx
</span><span style="color:black">BIOSCODE:1B44                 </span><span style="color:navy">jz      short </span><span style="color:gray">swpdsk9
</span><span style="color:black">BIOSCODE:1B46                 </span><span style="color:navy">add     dl, &#039;</span><span style="color:green">A&#039;
</span><span style="color:black">BIOSCODE:1B49                 </span><span style="color:navy">mov     byte ptr cs:</span>drvlet<span style="color:navy">, dl </span><span style="color:gray">; &quot;A: and press any key when ready\r\n\n&quot;
</span><span style="color:black">BIOSCODE:1B4E                 </span><span style="color:navy">mov     si, offset </span>sngmsg <span style="color:gray">; &quot;\r\nInsert diskette for drive &quot;
</span><span style="color:black">BIOSCODE:1B51                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:1B52                 </span><span style="color:navy">lods    byte ptr cs:[si] </span>; get the next character of the message
<span style="color:black">BIOSCODE:1B54
BIOSCODE:1B54 </span><span style="color:gray">wrmsg_loop</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1B54                 </span><span style="color:navy">int     </span><span style="color:green">29h             </span>; DOS 2+ internal - FAST PUTCHAR
<span style="color:black">BIOSCODE:1B54                                         </span>; AL = character to display
<span style="color:black">BIOSCODE:1B56                 </span><span style="color:navy">lods    byte ptr cs:[si] </span>; cs lodsb
<span style="color:black">BIOSCODE:1B56                                         </span>; get the next character of the message
<span style="color:black">BIOSCODE:1B58                 </span><span style="color:navy">or      al, al
</span><span style="color:black">BIOSCODE:1B5A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">wrmsg_loop
</span><span style="color:black">BIOSCODE:1B5C                 </span><span style="color:navy">call    </span>con_flush       ; flush out keyboard queue
<span style="color:black">BIOSCODE:1B5C                                         </span>; call rom-bios
<span style="color:black">BIOSCODE:1B5F                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">BIOSCODE:1B61                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
<span style="color:black">BIOSCODE:1B61                                         </span>; Return: AH = scan code, AL = character
<span style="color:black">BIOSCODE:1B63                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:1B64
BIOSCODE:1B64 </span><span style="color:gray">swpdsk9</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1B64                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1B65                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:1B66                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1B66 </span>swpdsk          <span style="color:black">endp
BIOSCODE:1B66
BIOSCODE:1B66 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:1B67 </span>sngmsg          <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:1B67                 </span><span style="color:navy">db &#039;Insert diskette for drive &#039;
</span><span style="color:gray">BIOSCODE:1B83 </span>drvlet          <span style="color:navy">db &#039;A: and press any key when ready&#039;,0Dh,0Ah </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:1B83                 </span><span style="color:navy">db </span><span style="color:green">0Ah</span><span style="color:navy">,</span><span style="color:green">0
</span><span style="color:black">BIOSCODE:1BA6
BIOSCODE:1BA6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1BA6
BIOSCODE:1BA6
BIOSCODE:1BA6 </span>mediacheck      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1BA6                 </span><span style="color:navy">call    </span>checksingle     ; make sure correct disk is in place
<span style="color:black">BIOSCODE:1BA9                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:1BAB                 </span><span style="color:navy">call    </span>haschange
<span style="color:black">BIOSCODE:1BAE                 </span><span style="color:navy">jz      short </span><span style="color:gray">mediaret
</span><span style="color:black">BIOSCODE:1BB0                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">40h </span>; [es:di+BDS.flags], fchanged ; 40h
<span style="color:black">BIOSCODE:1BB0                                         </span>; (BDS offset 63)
<span style="color:black">BIOSCODE:1BB6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">mediadovolid </span>; media changed
<span style="color:black">BIOSCODE:1BB8                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1BB9                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:1BBA                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1BBE                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">16h
</span><span style="color:black">BIOSCODE:1BC0                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - FLOPPY DISK - CHANGE OF DISK STATUS (AT,XT2,XT286,CONV,PS)
<span style="color:black">BIOSCODE:1BC0                                         </span>; DL = drive to check
<span style="color:black">BIOSCODE:1BC0                                         </span>; Return: AH = disk change status
<span style="color:black">BIOSCODE:1BC2                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1BC3                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1BC4                 </span><span style="color:navy">jb      short </span><span style="color:gray">mediadovolid
</span><span style="color:black">BIOSCODE:1BC6                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1
</span><span style="color:black">BIOSCODE:1BC9                 </span><span style="color:navy">mov     bl, ds:</span>tim_drv  ; get last drive accessed
<span style="color:black">BIOSCODE:1BCD                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], bl   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1BCD                                         </span>; (If the last drive accessed is not current drive
<span style="color:black">BIOSCODE:1BCD                                         </span>; media change status may be incorrect. So,
<span style="color:black">BIOSCODE:1BCD                                         </span>; &quot;I don&#039;t now&quot; will be returned even if it is indicated
<span style="color:black">BIOSCODE:1BCD                                         </span>; as media is not changed.)
<span style="color:black">BIOSCODE:1BD1                 </span><span style="color:navy">jz      short </span><span style="color:gray">mediaret  </span>; (same drive, media changeline indication is reliable)
<span style="color:black">BIOSCODE:1BD3                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1BD4                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:1BD5                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:1BD6                 </span><span style="color:navy">call    </span>Check_Time_Of_Access
<span style="color:black">BIOSCODE:1BD9                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1BDA                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:1BDB                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1BDC                 </span><span style="color:navy">or      si, si
</span><span style="color:black">BIOSCODE:1BDE                 </span><span style="color:navy">jz      short </span><span style="color:gray">mediadovolid </span>; check_time says &quot;&gt;= 2 secs passed&quot;
<span style="color:black">BIOSCODE:1BDE                                         </span>; (volume id will be checked)
<span style="color:black">BIOSCODE:1BE0                 </span><span style="color:navy">xor     si, si          </span>; return &quot;i don&#039;t know&quot;
<span style="color:black">BIOSCODE:1BE2
BIOSCODE:1BE2 </span><span style="color:gray">mediaret</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1BE2                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1BE3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1BE3
BIOSCODE:1BE3 </span><span style="color:gray">mediadovolid</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1BE3                 </span><span style="color:navy">call    </span>GetBp           ; build a new bpb in current bds
<span style="color:black">BIOSCODE:1BE6                 </span><span style="color:navy">jb      short </span><span style="color:gray">mediaret
</span><span style="color:black">BIOSCODE:1BE8                 </span><span style="color:navy">call    </span>check_vid
<span style="color:black">BIOSCODE:1BEB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">mediaret
</span><span style="color:black">BIOSCODE:1BED                 </span><span style="color:navy">jmp     </span>maperror        ; fix up al for return to dos
<span style="color:black">BIOSCODE:1BED </span>mediacheck      <span style="color:black">endp
BIOSCODE:1BED
BIOSCODE:1BF0
BIOSCODE:1BF0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1BF0
BIOSCODE:1BF0
BIOSCODE:1BF0 </span>checklatchio    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1BF0                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">3Ch</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [di+BDS.opcnt]
<span style="color:black">BIOSCODE:1BF5                 </span><span style="color:navy">jz      short </span>checkret  ; done if zero
<span style="color:black">BIOSCODE:1BF7                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">40h </span>; test [es:di+BDS.flags], fchanged ; 40h
<span style="color:black">BIOSCODE:1BFD                 </span><span style="color:navy">jz      short </span>checkret  ; not changed
<span style="color:black">BIOSCODE:1BFF                 </span><span style="color:navy">call    </span>GetBp           ; build bpb in current bds
<span style="color:black">BIOSCODE:1C02                 </span><span style="color:navy">jb      short </span><span style="color:gray">ret_no_error_map </span>; disk error trying to read in
<span style="color:black">BIOSCODE:1C04                 </span><span style="color:navy">call    </span>check_vid
<span style="color:black">BIOSCODE:1C07                 </span><span style="color:navy">jb      short </span><span style="color:gray">checklatchret </span>; disk error trying to read in
<span style="color:black">BIOSCODE:1C09                 </span><span style="color:navy">or      si, si          </span>; is changed for sure?
<span style="color:black">BIOSCODE:1C0B                 </span><span style="color:navy">jns     short </span>checkret  ; no
<span style="color:black">BIOSCODE:1C0D                 </span><span style="color:navy">call    </span>returnvid       ; yes
<span style="color:black">BIOSCODE:1C10
BIOSCODE:1C10 </span><span style="color:gray">checklatchret</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C10                 </span><span style="color:navy">call    </span>maperror        ; fix up al for return to dos
<span style="color:black">BIOSCODE:1C13
BIOSCODE:1C13 </span><span style="color:gray">ret_no_error_map</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C13                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:1C14                 </span><span style="color:navy">pop     si              </span>; pop off return address
<span style="color:black">BIOSCODE:1C15
BIOSCODE:1C15 </span>checkret<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C15                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1C15 </span><span style="background:red">checklatchio    endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">BIOSCODE:1C15
BIOSCODE:1C16
BIOSCODE:1C16 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1C16
BIOSCODE:1C16
BIOSCODE:1C16 </span>checkfatvid     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C16                 </span><span style="color:navy">call    </span>fat_check       ; check the fat and the vid
<span style="color:black">BIOSCODE:1C19                 </span><span style="color:navy">or      si, si
</span><span style="color:black">BIOSCODE:1C1B                 </span><span style="color:navy">js      short </span>changed_drv ;
<span style="color:black">BIOSCODE:1C1B </span>checkfatvid     <span style="color:black">endp                    </span>; fall into check_vid
<span style="color:black">BIOSCODE:1C1B
BIOSCODE:1C1D
BIOSCODE:1C1D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1C1D
BIOSCODE:1C1D
BIOSCODE:1C1D </span>check_vid       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C1D                 </span><span style="color:navy">cmp     word ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">16h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB_FATSz16
<span style="color:black">BIOSCODE:1C22                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chk_vid_1
</span><span style="color:black">BIOSCODE:1C24                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">42h</span><span style="color:navy">, </span><span style="color:green">29h </span>; BS_FAT32_BootSig
<span style="color:black">BIOSCODE:1C24                                         </span>; [disksector+EXT_BOOT.SIG],EXT_BOOT_SIGNATURE
<span style="color:black">BIOSCODE:1C29                 </span><span style="color:navy">jmp     short </span><span style="color:gray">chk_vid_2
</span><span style="color:black">BIOSCODE:1C2B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1C2B
BIOSCODE:1C2B </span><span style="color:gray">chk_vid_1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C2B                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">26h</span><span style="color:navy">, </span><span style="color:green">29h </span>; BS_FAT_BootSig ; BS_BootSig
<span style="color:black">BIOSCODE:1C2B                                         </span>; [disksector+EXT_BOOT.SIG],EXT_BOOT_SIGNATURE
<span style="color:black">BIOSCODE:1C30
BIOSCODE:1C30 </span><span style="color:gray">chk_vid_2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C30                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_ext_check_id
</span><span style="color:black">BIOSCODE:1C32                 </span><span style="color:navy">call    </span>haschange
<span style="color:black">BIOSCODE:1C35                 </span><span style="color:navy">jz      short </span>checkret
<span style="color:black">BIOSCODE:1C37                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:1C39                 </span><span style="color:navy">cmp     ds:</span>disksector<span style="color:navy">+</span><span style="color:green">10h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB_NumFATs
<span style="color:black">BIOSCODE:1C39                                         </span>; [disksector+EXT_BOOT.BPB+EBPB.NUMBEROFFATS]
<span style="color:black">BIOSCODE:1C3E                 </span><span style="color:navy">jz      short </span>checkfatret ; don&#039;t read vol id if not fat system
<span style="color:black">BIOSCODE:1C40                 </span><span style="color:navy">call    </span>read_volume_id
<span style="color:black">BIOSCODE:1C43                 </span><span style="color:navy">jb      short </span>checkfatret
<span style="color:black">BIOSCODE:1C45                 </span><span style="color:navy">call    </span>check_volume_id
<span style="color:black">BIOSCODE:1C48                 </span><span style="color:navy">mov     si, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">BIOSCODE:1C48                                         </span>; definitely changed
<span style="color:black">BIOSCODE:1C4B                 </span><span style="color:navy">jnz     short </span>changed_drv
<span style="color:black">BIOSCODE:1C4D                 </span><span style="color:navy">inc     si
</span><span style="color:black">BIOSCODE:1C4E
BIOSCODE:1C4E </span><span style="color:gray">vid_no_changed</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C4E                 </span><span style="color:navy">call    </span>resetchanged
<span style="color:black">BIOSCODE:1C51                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:1C52
BIOSCODE:1C52 </span>checkfatret<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C52                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1C53 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1C53
BIOSCODE:1C53 </span>changed_drv<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C53                 </span><span style="color:navy">clc                     </span>; cas -- return no error
<span style="color:black">BIOSCODE:1C54                 </span><span style="color:navy">mov     ds:</span>tim_drv<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; ensure that we ask rom for media
<span style="color:black">BIOSCODE:1C54                                         </span>;   check next time round
<span style="color:black">BIOSCODE:1C59                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1C5A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1C5A
BIOSCODE:1C5A </span><span style="color:gray">do_ext_check_id</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C5A                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1C5B                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:1C5C                 </span><span style="color:navy">mov     si, (offset </span>disksector<span style="color:navy">+</span><span style="color:green">43h</span><span style="color:navy">) </span>; BS_FAT32_VolID
<span style="color:black">BIOSCODE:1C5C                                         </span>; [DiskSector+EXT_BOOT.SERIAL]
<span style="color:black">BIOSCODE:1C5F                 </span><span style="color:navy">cmp     word ptr ds:</span>disksector<span style="color:navy">+</span><span style="color:green">16h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BPB_FATSz16
<span style="color:black">BIOSCODE:1C64                 </span><span style="color:navy">jz      short </span><span style="color:gray">chk_vid_3
</span><span style="color:black">BIOSCODE:1C66                 </span><span style="color:navy">sub     si, </span><span style="color:green">28          </span>; offset disksector+27h ; BS_VolID
<span style="color:black">BIOSCODE:1C69
BIOSCODE:1C69 </span><span style="color:gray">chk_vid_3</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C69                 </span><span style="color:navy">add     di, </span><span style="color:green">137         </span>; BDS.vol_serial
<span style="color:black">BIOSCODE:1C6D                 </span><span style="color:navy">cmpsw                   </span>; [DiskSector+EXT_BOOT.SERIAL] = [di+BDS.vol_serial] ?
<span style="color:black">BIOSCODE:1C6E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chk_vid_4
</span><span style="color:black">BIOSCODE:1C70                 </span><span style="color:navy">cmpsw                   </span>; [DiskSector+EXT_BOOT.SERIAL+2] =
<span style="color:black">BIOSCODE:1C70                                         </span>;          [di+BDS.vol_serial+2] ?
<span style="color:black">BIOSCODE:1C71
BIOSCODE:1C71 </span><span style="color:gray">chk_vid_4</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C71                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:1C72                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1C73                 </span><span style="color:navy">jnz     short </span>ext_changed ; not equal/same
<span style="color:black">BIOSCODE:1C75                 </span><span style="color:navy">xor     si, si          </span>; 0 ; don&#039;t know
<span style="color:black">BIOSCODE:1C77                 </span><span style="color:navy">jmp     short </span><span style="color:gray">vid_no_changed </span>; reset the flag
<span style="color:black">BIOSCODE:1C79 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1C79
BIOSCODE:1C79 </span>ext_changed<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C79                 </span><span style="color:navy">mov     si, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">BIOSCODE:1C79                                         </span>; disk changed!
<span style="color:black">BIOSCODE:1C7C                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:1C7D                 </span><span style="color:navy">jmp     short </span>changed_drv
<span style="color:black">BIOSCODE:1C7D </span>check_vid       <span style="color:black">endp
BIOSCODE:1C7D
BIOSCODE:1C7F
BIOSCODE:1C7F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1C7F
BIOSCODE:1C7F
BIOSCODE:1C7F </span>checkio         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C7F                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">6
</span><span style="color:black">BIOSCODE:1C82                 </span><span style="color:navy">jnz     short </span>checkfatret
<span style="color:black">BIOSCODE:1C84                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">3Ch</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">BIOSCODE:1C89                 </span><span style="color:navy">jz      short </span>checkfatret
<span style="color:black">BIOSCODE:1C8B                 </span><span style="color:navy">call    </span>GetBp
<span style="color:black">BIOSCODE:1C8E                 </span><span style="color:navy">jb      short </span><span style="color:gray">no_error_map
</span><span style="color:black">BIOSCODE:1C90                 </span><span style="color:navy">call    </span>checkfatvid
<span style="color:black">BIOSCODE:1C93                 </span><span style="color:navy">jb      short </span><span style="color:gray">checkioret </span>; disk error trying to read in.
<span style="color:black">BIOSCODE:1C95                 </span><span style="color:navy">or      si, si          </span>; is changed for sure?
<span style="color:black">BIOSCODE:1C97                 </span><span style="color:navy">js      short </span><span style="color:gray">checkioerr </span>; yes changed
<span style="color:black">BIOSCODE:1C99                 </span><span style="color:navy">inc     bp              </span>; allow a retry
<span style="color:black">BIOSCODE:1C9A                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1C9B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1C9B
BIOSCODE:1C9B </span><span style="color:gray">checkioerr</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C9B                 </span><span style="color:navy">call    </span>returnvid
<span style="color:black">BIOSCODE:1C9E
BIOSCODE:1C9E </span><span style="color:gray">checkioret</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1C9E                 </span><span style="color:navy">stc                     </span>; make sure carry gets passed through
<span style="color:black">BIOSCODE:1C9F                 </span><span style="color:navy">jmp     </span>harderr
<span style="color:black">BIOSCODE:1CA2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1CA2
BIOSCODE:1CA2 </span><span style="color:gray">no_error_map</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CA2                 </span><span style="color:navy">jmp     </span>harderr2
<span style="color:black">BIOSCODE:1CA2 </span>checkio         <span style="color:black">endp
BIOSCODE:1CA2
BIOSCODE:1CA5
BIOSCODE:1CA5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1CA5
BIOSCODE:1CA5
BIOSCODE:1CA5 </span>returnvid       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CA5                 </span><span style="color:navy">mov     si, </span><span style="color:green">22          </span>; trans+8
<span style="color:black">BIOSCODE:1CA5                                         </span>; offset into pointer to return value
<span style="color:black">BIOSCODE:1CA8                 </span><span style="color:navy">call    </span>vid_into_packet
<span style="color:black">BIOSCODE:1CAB                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">6
</span><span style="color:black">BIOSCODE:1CAD                 </span><span style="color:navy">stc
</span><span style="color:black">BIOSCODE:1CAE                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1CAE </span>returnvid       <span style="color:black">endp
BIOSCODE:1CAE
BIOSCODE:1CAF
BIOSCODE:1CAF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1CAF
BIOSCODE:1CAF
BIOSCODE:1CAF </span>media_set_vid   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CAF                 </span><span style="color:navy">mov     si, </span><span style="color:green">15          </span>; trans+1
<span style="color:black">BIOSCODE:1CB2
BIOSCODE:1CB2 </span>vid_into_packet<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CB2                 </span><span style="color:navy">push    ds
</span><span style="color:black">BIOSCODE:1CB3                 </span><span style="color:navy">lds     bx, ds:</span>ptrsav
<span style="color:black">BIOSCODE:1CB7                 </span><span style="color:navy">add     di, </span><span style="color:green">125         </span>; BDS.volid (BDS offset 125)
<span style="color:black">BIOSCODE:1CBA                 </span><span style="color:navy">mov     [bx+si], di
</span><span style="color:black">BIOSCODE:1CBC                 </span><span style="color:navy">sub     di, </span><span style="color:green">125         </span>; BDS start (BDS offset 0)
<span style="color:black">BIOSCODE:1CBF                 </span><span style="color:navy">mov     word ptr [bx+si+</span><span style="color:#ff8000">2</span><span style="color:navy">], es
</span><span style="color:black">BIOSCODE:1CC2                 </span><span style="color:navy">pop     ds
</span><span style="color:black">BIOSCODE:1CC3
BIOSCODE:1CC3 </span>dofloppy<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CC3                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1CC3 </span>media_set_vid   <span style="color:black">endp
BIOSCODE:1CC3
BIOSCODE:1CC4
BIOSCODE:1CC4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1CC4
BIOSCODE:1CC4
BIOSCODE:1CC4 </span>hidensity       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CC4                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">2 </span>; check for correct drive
<span style="color:black">BIOSCODE:1CC4                                         </span>; is it special?
<span style="color:black">BIOSCODE:1CC4                                         </span>; [es:di+BDS.flags], fchangeline
<span style="color:black">BIOSCODE:1CCA                 </span><span style="color:navy">jz      short </span>dofloppy  ; no, do normal floppy test
<span style="color:black">BIOSCODE:1CCC                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; is it single-media?
<span style="color:black">BIOSCODE:1CD1                 </span><span style="color:navy">jz      short </span>dofloppy  ; [es:di+BDS.formfactor], ffSmall
<span style="color:black">BIOSCODE:1CD1                                         </span>; yes, use fatid.
<span style="color:black">BIOSCODE:1CD3                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0F9h
</span><span style="color:black">BIOSCODE:1CD6                 </span><span style="color:navy">jnz     short </span>dofloppy
<span style="color:black">BIOSCODE:1CD8                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">3Eh</span><span style="color:navy">] </span>; [es:di+BDS.formfactor]
<span style="color:black">BIOSCODE:1CDC                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7           </span>; ffOther ?
<span style="color:black">BIOSCODE:1CDE                 </span><span style="color:navy">jz      short </span><span style="color:gray">Is720K
</span><span style="color:black">BIOSCODE:1CE0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9
</span><span style="color:black">BIOSCODE:1CE2                 </span><span style="color:navy">jz      short </span><span style="color:gray">Is720K
</span><span style="color:black">BIOSCODE:1CE4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7           </span>; seven sectors / fat
<span style="color:black">BIOSCODE:1CE6                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0E00Fh      </span>; 224*256+0Fh (57359)
<span style="color:black">BIOSCODE:1CE6                                         </span>; 224 root dir entries &amp; 0Fh sector max
<span style="color:black">BIOSCODE:1CE9                 </span><span style="color:navy">mov     cx, </span><span style="color:green">2400        </span>; 80*15*2
<span style="color:black">BIOSCODE:1CE9                                         </span>; 80 tracks, 15 sectors/track, 2 sides
<span style="color:black">BIOSCODE:1CEC                 </span><span style="color:navy">pop     dx              </span>; pop off return address
<span style="color:black">BIOSCODE:1CED                 </span><span style="color:navy">mov     dx, </span><span style="color:green">258         </span>; 1*256+2
<span style="color:black">BIOSCODE:1CED                                         </span>; sectors/allocation unit &amp; head max
<span style="color:black">BIOSCODE:1CF0                 </span><span style="color:navy">jmp     </span>Has1            ; return to tail of getbp
<span style="color:black">BIOSCODE:1CF3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1CF3
BIOSCODE:1CF3 </span><span style="color:gray">Is720K</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CF3                 </span><span style="color:navy">pop     bx              </span>; pop off return address
<span style="color:black">BIOSCODE:1CF4                 </span><span style="color:navy">jmp     </span>Has720K         ; return to 720K code
<span style="color:black">BIOSCODE:1CF4 </span><span style="background:red">hidensity       endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">BIOSCODE:1CF4
BIOSCODE:1CF7
BIOSCODE:1CF7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1CF7
BIOSCODE:1CF7
BIOSCODE:1CF7 </span>Set_Changed_DL  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CF7                 </span><span style="color:navy">push    es
</span><span style="color:black">BIOSCODE:1CF8                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:1CF9                 </span><span style="color:navy">les     di, dword ptr ds:</span>start_bds
<span style="color:black">BIOSCODE:1CFD
BIOSCODE:1CFD </span>scan_bds<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1CFD                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], dl   </span>; [es:di+BDS.drivenum]
<span style="color:black">BIOSCODE:1D01                 </span><span style="color:navy">jnz     short </span><span style="color:gray">get_next_bds
</span><span style="color:black">BIOSCODE:1D03                 </span><span style="color:navy">or      es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], bx </span>; [es:di+BDS.flags]
<span style="color:black">BIOSCODE:1D03                                         </span>; signal change on other drive
<span style="color:black">BIOSCODE:1D07
BIOSCODE:1D07 </span><span style="color:gray">get_next_bds</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D07                 </span><span style="color:navy">les     di, es:[di]     </span>; [es:di+BDS.link]
<span style="color:black">BIOSCODE:1D07                                         </span>; go to next bds
<span style="color:black">BIOSCODE:1D0A                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">BIOSCODE:1D0D                 </span><span style="color:navy">jnz     short </span>scan_bds  ; loop unless end of chain
<span style="color:black">BIOSCODE:1D0F                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:1D10                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1D11                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1D11 </span>Set_Changed_DL  <span style="color:black">endp
BIOSCODE:1D11
BIOSCODE:1D12
BIOSCODE:1D12 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1D12
BIOSCODE:1D12
BIOSCODE:1D12 </span>resetchanged    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D12                 </span><span style="color:navy">and     word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">0FFBFh </span>; [es:di+BDS.flags], ~fchanged
<span style="color:black">BIOSCODE:1D17                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1D17 </span>resetchanged    <span style="color:black">endp
BIOSCODE:1D17
BIOSCODE:1D18
BIOSCODE:1D18 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1D18
BIOSCODE:1D18
BIOSCODE:1D18 </span>haschange       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D18                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], </span><span style="color:green">2 </span>; [es:di+BDS.flags], fchangeline
<span style="color:black">BIOSCODE:1D1E                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1D1E </span>haschange       <span style="color:black">endp
BIOSCODE:1D1E
BIOSCODE:1D1F
BIOSCODE:1D1F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1D1F
BIOSCODE:1D1F
BIOSCODE:1D1F </span>set_volume_id   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D1F                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:1D20                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1D21                 </span><span style="color:navy">call    </span>haschange       ; does drive have changeline support?
<span style="color:black">BIOSCODE:1D24                 </span><span style="color:navy">jz      short </span><span style="color:gray">setvret   </span>; no, get out
<span style="color:black">BIOSCODE:1D26                 </span><span style="color:navy">call    </span>read_volume_id
<span style="color:black">BIOSCODE:1D29                 </span><span style="color:navy">jb      short </span><span style="color:gray">seterr
</span><span style="color:black">BIOSCODE:1D2B                 </span><span style="color:navy">call    </span>transfer_volume_id ; copy the volume id to special drive
<span style="color:black">BIOSCODE:1D2E                 </span><span style="color:navy">call    </span>resetchanged    ; restore value of change line
<span style="color:black">BIOSCODE:1D31
BIOSCODE:1D31 </span><span style="color:gray">setvret</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D31                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:1D32                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1D33                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1D34                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1D35 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1D35
BIOSCODE:1D35 </span><span style="color:gray">seterr</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D35                 </span><span style="color:navy">pop     dx              </span>; pop stack but don&#039;t overwrite ax
<span style="color:black">BIOSCODE:1D36                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1D37                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1D37 </span>set_volume_id   <span style="color:black">endp
BIOSCODE:1D37
BIOSCODE:1D37 </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:1D38 </span>root_sec        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">BIOSCODE:1D38                                         </span>; root sector #
<span style="color:black">BIOSCODE:1D3A
BIOSCODE:1D3A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1D3A
BIOSCODE:1D3A
BIOSCODE:1D3A </span>read_volume_id  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D3A                 </span><span style="color:navy">push    dx
</span><span style="color:black">BIOSCODE:1D3B                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:1D3C                 </span><span style="color:navy">push    bx
</span><span style="color:black">BIOSCODE:1D3D                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1D3E                 </span><span style="color:navy">push    es              </span>; stack the bds last
<span style="color:black">BIOSCODE:1D3F                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:1D40                 </span><span style="color:navy">push    ds              </span>; point es to Bios_Data (BIOSDATA)
<span style="color:black">BIOSCODE:1D41                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1D42                 </span><span style="color:navy">mov     di, offset </span>tmp_vid <span style="color:gray">; &quot;NO NAME    &quot;
</span><span style="color:black">BIOSCODE:1D45                 </span><span style="color:navy">mov     si, offset </span>nul_vid <span style="color:gray">; &quot;NO NAME    &quot;
</span><span style="color:black">BIOSCODE:1D48                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11          </span>; (cx = 12 in MSDOS 6 IO:SYS)
<span style="color:black">BIOSCODE:1D48                                         </span>; initialize tmp_vid to null vi_id
<span style="color:black">BIOSCODE:1D4B                 </span><span style="color:navy">rep movs byte ptr es:[di], byte ptr cs:[si]
</span><span style="color:black">BIOSCODE:1D4E                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:1D4F                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1D50                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [es:di+BDS.fats]
<span style="color:black">BIOSCODE:1D50                                         </span>; # of fats
<span style="color:black">BIOSCODE:1D54                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [es:di+BDS.fatsecs]
<span style="color:black">BIOSCODE:1D54                                         </span>; sectors / fat
<span style="color:black">BIOSCODE:1D58                 </span><span style="color:navy">mul     cl
</span><span style="color:black">BIOSCODE:1D5A                 </span><span style="color:navy">add     ax, es:[di+</span><span style="color:#ff8000">9</span><span style="color:navy">]   </span>; [es:di+BDS.resectors]
<span style="color:black">BIOSCODE:1D5A                                         </span>; add on reserved sectors
<span style="color:black">BIOSCODE:1D5A                                         </span>; now, ax is sector # (0 based)
<span style="color:black">BIOSCODE:1D5E                 </span><span style="color:navy">mov     cs:</span>root_sec<span style="color:navy">, ax
</span><span style="color:black">BIOSCODE:1D62                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">] </span>; [es:di+BDS.direntries]
<span style="color:black">BIOSCODE:1D62                                         </span>; # root dir entries
<span style="color:black">BIOSCODE:1D66                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; 16 entries/sector
<span style="color:black">BIOSCODE:1D68                 </span><span style="color:navy">shr     ax, cl          </span>; divide by 16
<span style="color:black">BIOSCODE:1D6A                 </span><span style="color:navy">xchg    ax, cx          </span>; cx is # of sectors to scan
<span style="color:black">BIOSCODE:1D6B
BIOSCODE:1D6B </span><span style="color:gray">next_sec</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D6B                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:1D6C                 </span><span style="color:navy">mov     ax, cs:</span>root_sec ; get sector #
<span style="color:black">BIOSCODE:1D70                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [es:di+BDS.secpertrack]
<span style="color:black">BIOSCODE:1D70                                         </span>; sectors / track
<span style="color:black">BIOSCODE:1D74                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSCODE:1D76                 </span><span style="color:navy">div     cx
</span><span style="color:black">BIOSCODE:1D78                 </span><span style="color:navy">inc     dx              </span>; dx = sectors into track
<span style="color:black">BIOSCODE:1D78                                         </span>; ax = track count from 0
<span style="color:black">BIOSCODE:1D79                 </span><span style="color:navy">mov     cl, dl          </span>; sector to read
<span style="color:black">BIOSCODE:1D7B                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">BIOSCODE:1D7D                 </span><span style="color:navy">div     word ptr es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+BDS.heads]
<span style="color:black">BIOSCODE:1D7D                                         </span>; # heads on this disc
<span style="color:black">BIOSCODE:1D81                 </span><span style="color:navy">mov     dh, dl          </span>; head number
<span style="color:black">BIOSCODE:1D83                 </span><span style="color:navy">mov     ch, al          </span>; track #
<span style="color:black">BIOSCODE:1D85                 </span><span style="color:navy">call    </span>read_sector     ; get first sector of the root directory,
<span style="color:black">BIOSCODE:1D85                                         </span>; ds:bx -&gt; directory sector
<span style="color:black">BIOSCODE:1D88                 </span><span style="color:navy">jb      short </span><span style="color:gray">readviderr
</span><span style="color:black">BIOSCODE:1D8A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">16          </span>; # of dir entries in a block of root
<span style="color:black">BIOSCODE:1D8D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8           </span>; volume label bit
<span style="color:black">BIOSCODE:1D8F
BIOSCODE:1D8F </span><span style="color:gray">fvid_loop</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D8F                 </span><span style="color:navy">cmp     [bx], ch        </span>; 0 ; end of dir?
<span style="color:black">BIOSCODE:1D91                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_vid    </span>; yes, no vol id
<span style="color:black">BIOSCODE:1D93                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0E5h </span>; empty entry?
<span style="color:black">BIOSCODE:1D96                 </span><span style="color:navy">jz      short </span><span style="color:gray">ent_loop  </span>; yes, skip
<span style="color:black">BIOSCODE:1D98                 </span><span style="color:navy">test    [bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], al    </span>; is volume label bit set in fcb?
<span style="color:black">BIOSCODE:1D9B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">found_vid </span>; yes
<span style="color:black">BIOSCODE:1D9D
BIOSCODE:1D9D </span><span style="color:gray">ent_loop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1D9D                 </span><span style="color:navy">add     bx, </span><span style="color:green">32          </span>; add length of directory entry
<span style="color:black">BIOSCODE:1DA0                 </span><span style="color:navy">loop    </span><span style="color:gray">fvid_loop
</span><span style="color:black">BIOSCODE:1DA2                 </span><span style="color:navy">pop     cx              </span>; outer loop
<span style="color:black">BIOSCODE:1DA3                 </span><span style="color:navy">inc     cs:</span>root_sec     ; inc word [root_sec]
<span style="color:black">BIOSCODE:1DA3                                         </span>; next sector
<span style="color:black">BIOSCODE:1DA8                 </span><span style="color:navy">loop    </span><span style="color:gray">next_sec        </span>; continue
<span style="color:black">BIOSCODE:1DAA
BIOSCODE:1DAA </span><span style="color:gray">notfound</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DAA                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">BIOSCODE:1DAC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fvid_ret
</span><span style="color:black">BIOSCODE:1DAE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1DAE
BIOSCODE:1DAE </span><span style="color:gray">found_vid</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DAE                 </span><span style="color:navy">pop     cx              </span>; clean stack of outer loop counter
<span style="color:black">BIOSCODE:1DAF                 </span><span style="color:navy">mov     si, bx          </span>; point to volume_id
<span style="color:black">BIOSCODE:1DB1                 </span><span style="color:navy">push    es              </span>; preserve current bds
<span style="color:black">BIOSCODE:1DB2                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:1DB3                 </span><span style="color:navy">push    ds              </span>; point es to Bios_Data (BIOSDATA)
<span style="color:black">BIOSCODE:1DB4                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1DB5                 </span><span style="color:navy">mov     di, offset </span>tmp_vid <span style="color:gray">; &quot;NO NAME    &quot;
</span><span style="color:black">BIOSCODE:1DB8                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11          </span>; VOLID_SIZ-1
<span style="color:black">BIOSCODE:1DB8                                         </span>; length of string minus nul
<span style="color:black">BIOSCODE:1DBB                 </span><span style="color:navy">rep movsb
</span><span style="color:black">BIOSCODE:1DBD                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">BIOSCODE:1DBE                 </span><span style="color:navy">stosb                   </span>; null terminate
<span style="color:black">BIOSCODE:1DBF                 </span><span style="color:navy">xchg    ax, si
</span><span style="color:black">BIOSCODE:1DC0                 </span><span style="color:navy">pop     di              </span>; restore current bds
<span style="color:black">BIOSCODE:1DC1                 </span><span style="color:navy">pop     es
</span><span style="color:black">BIOSCODE:1DC2
BIOSCODE:1DC2 </span><span style="color:gray">fvid_ret</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DC2                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1DC3                 </span><span style="color:navy">clc
</span><span style="color:black">BIOSCODE:1DC4
BIOSCODE:1DC4 </span><span style="color:gray">rvidret</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DC4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">BIOSCODE:1DC5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:1DC6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">BIOSCODE:1DC7                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1DC8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1DC8
BIOSCODE:1DC8 </span><span style="color:gray">no_vid</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DC8                 </span><span style="color:navy">pop     cx              </span>; clean stack of outer loop counter
<span style="color:black">BIOSCODE:1DC9                 </span><span style="color:navy">jmp     short </span><span style="color:gray">notfound
</span><span style="color:black">BIOSCODE:1DCB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">BIOSCODE:1DCB
BIOSCODE:1DCB </span><span style="color:gray">readviderr</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DCB                 </span><span style="color:navy">pop     si              </span>; trash the outer loop counter
<span style="color:black">BIOSCODE:1DCC                 </span><span style="color:navy">pop     si              </span>; caller&#039;s ax, return error code instead
<span style="color:black">BIOSCODE:1DCD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">rvidret
</span><span style="color:black">BIOSCODE:1DCD </span>read_volume_id  <span style="color:black">endp
BIOSCODE:1DCD
BIOSCODE:1DCF
BIOSCODE:1DCF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1DCF
BIOSCODE:1DCF
BIOSCODE:1DCF </span>preset_volid_addr <span style="color:black">proc near             </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DCF                 </span><span style="color:navy">mov     si, offset </span>tmp_vid <span style="color:gray">; &quot;NO NAME    &quot;
</span><span style="color:black">BIOSCODE:1DD2                 </span><span style="color:navy">add     di, </span><span style="color:green">125         </span>; BDS.volid
<span style="color:black">BIOSCODE:1DD5                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11          </span>; VOLID_SIZ (12 for MSDOS 5.0-6.22 versions)
<span style="color:black">BIOSCODE:1DD8                 </span><span style="color:navy">cld
</span><span style="color:black">BIOSCODE:1DD9                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1DD9 </span>preset_volid_addr <span style="color:black">endp
BIOSCODE:1DD9
</span><span style="color:maroon">BIOSCODE:1DDA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">BIOSCODE:1DDA
BIOSCODE:1DDA </span>transfer_volume_id<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">BIOSCODE:1DDA                 </span><span style="color:navy">push    di
</span><span style="color:maroon">BIOSCODE:1DDB                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">BIOSCODE:1DDC                 </span><span style="color:navy">push    si
</span><span style="color:maroon">BIOSCODE:1DDD                 </span><span style="color:navy">call    </span>preset_volid_addr
<span style="color:maroon">BIOSCODE:1DE0                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">BIOSCODE:1DE2                 </span><span style="color:navy">pop     si
</span><span style="color:black">BIOSCODE:1DE3 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR check_volume_id
</span><span style="color:black">BIOSCODE:1DE3
BIOSCODE:1DE3 </span><span style="color:gray">chk_volid_ok</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DE3                 </span><span style="color:navy">pop     cx
</span><span style="color:black">BIOSCODE:1DE4                 </span><span style="color:navy">pop     di
</span><span style="color:black">BIOSCODE:1DE5                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1DE5 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR check_volume_id
</span><span style="color:black">BIOSCODE:1DE6
BIOSCODE:1DE6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1DE6
BIOSCODE:1DE6
BIOSCODE:1DE6 </span>check_volume_id <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DE6
BIOSCODE:1DE6 </span><span style="color:gray">; FUNCTION CHUNK AT BIOSCODE:1DE3 SIZE 00000003 BYTES
</span><span style="color:black">BIOSCODE:1DE6
BIOSCODE:1DE6                 </span><span style="color:navy">push    di
</span><span style="color:black">BIOSCODE:1DE7                 </span><span style="color:navy">push    cx
</span><span style="color:black">BIOSCODE:1DE8                 </span><span style="color:navy">call    </span>preset_volid_addr
<span style="color:black">BIOSCODE:1DEB                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">BIOSCODE:1DED                 </span><span style="color:navy">jmp     short </span><span style="color:gray">chk_volid_ok
</span><span style="color:black">BIOSCODE:1DED </span>check_volume_id <span style="color:black">endp
BIOSCODE:1DED
BIOSCODE:1DEF
BIOSCODE:1DEF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">BIOSCODE:1DEF
BIOSCODE:1DEF
BIOSCODE:1DEF </span>fat_check       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DEF                 </span><span style="color:navy">push    ax
</span><span style="color:black">BIOSCODE:1DF0                 </span><span style="color:navy">xor     si, si          </span>; say fat id&#039;s are same.
<span style="color:black">BIOSCODE:1DF2                 </span><span style="color:navy">mov     al, ds:</span>medbyt
<span style="color:black">BIOSCODE:1DF5                 </span><span style="color:navy">cmp     al, es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; [es:di+BDS.media]
<span style="color:black">BIOSCODE:1DF5                                         </span>; compare it with the bds medbyte
<span style="color:black">BIOSCODE:1DF9                 </span><span style="color:navy">jz      short </span><span style="color:gray">okret1
</span><span style="color:black">BIOSCODE:1DFB                 </span><span style="color:navy">dec     si
</span><span style="color:black">BIOSCODE:1DFC
BIOSCODE:1DFC </span><span style="color:gray">okret1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">BIOSCODE:1DFC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">BIOSCODE:1DFD                 </span><span style="color:navy">retn
</span><span style="color:black">BIOSCODE:1DFD </span>fat_check       <span style="color:black">endp
BIOSCODE:1DFD
BIOSCODE:1DFD </span><span style="color:gray">; ---------------------------------------------------------------------------
BIOSCODE:1DFE                 </span><span style="color:navy">db </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">BIOSCODE:1DFE </span>BIOSCODE        ends
<span style="color:gray">BIOSCODE:1DFE
SYSINIT:0000 ; ===========================================================================
SYSINIT:0000
SYSINIT:0000 ; Segment type: Regular
SYSINIT:0000 </span>SYSINIT         segment byte public &#039;SYSINIT&#039; use16
<span style="color:gray">SYSINIT:0000                 </span>assume cs:SYSINIT
<span style="color:gray">SYSINIT:0000                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:gray">SYSINIT:0000 </span>SYSINIT$        <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:0002 </span>stackcount      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0004 </span>stackat         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0006 </span>stacksize       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0008 </span>stacks          <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:000C </span>firstentry      <span style="color:navy">dw offset </span>stacks        <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:000E </span>lastentry       <span style="color:navy">dw </span><span style="color:#008040">48h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:000E                                         </span>; stacks+(defaultcount*entrysize)-entrysize
<span style="color:gray">SYSINIT:0010 </span>nextentry       <span style="color:navy">dw </span><span style="color:#008040">48h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0010                                         </span>; stacks+(defaultcount*entrysize)-entrysize
<span style="color:gray">SYSINIT:0012 </span>old02           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0016 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0016
SYSINIT:0016 </span>int02<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0016                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">SYSINIT:0017                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:0018                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">SYSINIT:001B                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">SYSINIT:001D                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:001D                 </span><span style="color:navy">cmp     byte ptr es:</span><span style="color:green">0FFFEh</span><span style="color:navy">, </span><span style="color:#ff8000">0F9h </span>; mdl_convert ; check if convertible
<span style="color:maroon">SYSINIT:0023                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:0024                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0024                 </span><span style="color:navy">jnz     short </span>normal02
<span style="color:maroon">SYSINIT:0026                 </span><span style="color:navy">in      al, </span><span style="color:green">62h         </span>; PC/XT PPI port C. Bits:
<span style="color:maroon">SYSINIT:0026                                         </span>; 0-3: values of DIP switches
<span style="color:maroon">SYSINIT:0026                                         </span>; 5: 1=Timer 2 channel out
<span style="color:maroon">SYSINIT:0026                                         </span>; 6: 1=I/O channel check
<span style="color:maroon">SYSINIT:0026                                         </span>; 7: 1=RAM parity check error occurred.
<span style="color:maroon">SYSINIT:0028                 </span><span style="color:navy">test    al, </span><span style="color:green">80h
</span><span style="color:maroon">SYSINIT:002A                 </span><span style="color:navy">jz      short </span>normal02
<span style="color:maroon">SYSINIT:002C                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">SYSINIT:002D                 </span><span style="color:navy">jmp     cs:</span>old02
<span style="color:maroon">SYSINIT:0032 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0032
SYSINIT:0032 </span>normal02<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0032                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">SYSINIT:0033                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0033 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0036                 </span><span style="color:navy">dw offset </span>old02
<span style="color:gray">SYSINIT:0038 </span>old08           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:003C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:003C
SYSINIT:003C </span>int08<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:003C                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:003C </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:003F                 </span><span style="color:navy">dw offset </span>old08
<span style="color:gray">SYSINIT:0041 </span>old09           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0045 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0045
SYSINIT:0045 </span>int09<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0045                 </span><span style="color:navy">jmp     short </span>keyboard_lbl
<span style="color:maroon">SYSINIT:0047 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0047                 </span><span style="color:navy">nop
</span><span style="color:maroon">SYSINIT:0047 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0048                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:0049 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0049
SYSINIT:0049 </span>keyboard_lbl<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0049                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0049 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:004C                 </span><span style="color:navy">dw offset </span>old09
<span style="color:gray">SYSINIT:004E </span>old70           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0052 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0052
SYSINIT:0052 </span>int70<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0052                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0052 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0055                 </span><span style="color:navy">dw offset </span>old70
<span style="color:maroon">SYSINIT:0057 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0057
SYSINIT:0057 </span>int0A<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0057                 </span><span style="color:navy">jmp     short </span>entry_int0A_stk
<span style="color:maroon">SYSINIT:0057 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0059 </span>old0A           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:005D                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:005F </span>firstflag0A     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:0060 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0060                 </span><span style="color:navy">jmp     short </span>intret_0A
<span style="color:maroon">SYSINIT:0060 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0062 </span><span style="color:navy">byte_5392       db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:0069 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0069
SYSINIT:0069 </span>entry_int0A_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0069                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0069 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:006C                 </span><span style="color:navy">dw offset </span>old0A
<span style="color:maroon">SYSINIT:006E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:006E
SYSINIT:006E </span>intret_0A<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:006E                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:006F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:006F
SYSINIT:006F </span>int0B<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:006F                 </span><span style="color:navy">jmp     short </span>entry_int0B_stk
<span style="color:maroon">SYSINIT:006F </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0071 </span>old0B           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0075                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:0077 </span>firstflag0B     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:0078 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0078                 </span><span style="color:navy">jmp     short </span>intret_0B
<span style="color:maroon">SYSINIT:0078 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:007A                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:0081 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0081
SYSINIT:0081 </span>entry_int0B_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0081                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0081 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0084                 </span><span style="color:navy">dw offset </span>old0B
<span style="color:maroon">SYSINIT:0086 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0086
SYSINIT:0086 </span>intret_0B<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0086                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:0087 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0087
SYSINIT:0087 </span>int0C<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0087                 </span><span style="color:navy">jmp     short </span>entry_int0C_stk
<span style="color:maroon">SYSINIT:0087 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0089 </span>old0C           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:008D                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:008F </span>firstflag0C     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:0090 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0090                 </span><span style="color:navy">jmp     short </span>intret_0C
<span style="color:maroon">SYSINIT:0090 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0092                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:0099 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0099
SYSINIT:0099 </span>entry_int0C_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0099                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0099 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:009C                 </span><span style="color:navy">dw offset </span>old0C
<span style="color:maroon">SYSINIT:009E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:009E
SYSINIT:009E </span>intret_0C<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:009E                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:009F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:009F
SYSINIT:009F </span>int0D<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:009F                 </span><span style="color:navy">jmp     short </span>int0D_stk
<span style="color:maroon">SYSINIT:009F </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00A1 </span>old0D           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:00A5                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:00A7 </span>firstflag0D     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:00A8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00A8                 </span><span style="color:navy">jmp     short </span>intret_0D
<span style="color:maroon">SYSINIT:00A8 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00AA                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:00B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00B1
SYSINIT:00B1 </span>int0D_stk<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00B1                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:00B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00B4                 </span><span style="color:navy">dw offset </span>old0D
<span style="color:maroon">SYSINIT:00B6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00B6
SYSINIT:00B6 </span>intret_0D<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00B6                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:00B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00B7
SYSINIT:00B7 </span>int0E<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:00B7                 </span><span style="color:navy">jmp     short </span>entry_int0E_stk
<span style="color:maroon">SYSINIT:00B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00B9 </span>old0E           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:00BD                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:00BF </span>firstflag0E     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:00C0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00C0                 </span><span style="color:navy">jmp     short </span>intret_0E
<span style="color:maroon">SYSINIT:00C0 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00C2                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:00C9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00C9
SYSINIT:00C9 </span>entry_int0E_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00C9                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:00C9 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00CC                 </span><span style="color:navy">dw offset </span>old0E
<span style="color:maroon">SYSINIT:00CE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00CE
SYSINIT:00CE </span>intret_0E<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00CE                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:00CF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00CF
SYSINIT:00CF </span>int72<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:00CF                 </span><span style="color:navy">jmp     short </span>entry_int72_stk
<span style="color:maroon">SYSINIT:00CF </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00D1 </span>old72           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:00D5                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:00D7 </span>firstflag72     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:00D8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00D8                 </span><span style="color:navy">jmp     short </span>intret_72
<span style="color:maroon">SYSINIT:00D8 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00DA                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:00E1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00E1
SYSINIT:00E1 </span>entry_int72_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00E1                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:00E1 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00E4                 </span><span style="color:navy">dw offset </span>old72
<span style="color:maroon">SYSINIT:00E6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00E6
SYSINIT:00E6 </span>intret_72<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00E6                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:00E7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00E7
SYSINIT:00E7 </span>int73<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:00E7                 </span><span style="color:navy">jmp     short </span>entry_int73_stk
<span style="color:maroon">SYSINIT:00E7 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00E9 </span>old73           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:00ED                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:00EF </span>firstflag73     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:00F0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00F0                 </span><span style="color:navy">jmp     short </span>intret_73
<span style="color:maroon">SYSINIT:00F0 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00F2                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:00F9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00F9
SYSINIT:00F9 </span>entry_int73_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00F9                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:00F9 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:00FC                 </span><span style="color:navy">dw offset </span>old73
<span style="color:maroon">SYSINIT:00FE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00FE
SYSINIT:00FE </span>intret_73<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:00FE                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:00FF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:00FF
SYSINIT:00FF </span>int74<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:00FF                 </span><span style="color:navy">jmp     short </span>entry_int74_stk
<span style="color:maroon">SYSINIT:00FF </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0101 </span>old74           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0105                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:0107 </span>firstflag74     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:0108 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0108                 </span><span style="color:navy">jmp     short </span>intret_74
<span style="color:maroon">SYSINIT:0108 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:010A                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:0111 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0111
SYSINIT:0111 </span>entry_int74_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0111                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0111 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0114                 </span><span style="color:navy">dw offset </span>old74
<span style="color:maroon">SYSINIT:0116 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0116
SYSINIT:0116 </span>intret_74<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0116                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:0117 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0117
SYSINIT:0117 </span>int76<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0117                 </span><span style="color:navy">jmp     short </span>entry_int76_stk
<span style="color:maroon">SYSINIT:0117 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0119 </span>old76           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:011D                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:011F </span>firstflag76     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:0120 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0120                 </span><span style="color:navy">jmp     short </span>intret_76
<span style="color:maroon">SYSINIT:0120 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0122                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:0129 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0129
SYSINIT:0129 </span>entry_int76_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0129                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0129 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:012C                 </span><span style="color:navy">dw offset </span>old76
<span style="color:maroon">SYSINIT:012E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:012E
SYSINIT:012E </span>intret_76<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:012E                 </span><span style="color:navy">iret
</span><span style="color:maroon">SYSINIT:012F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:012F
SYSINIT:012F </span>int77<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:012F                 </span><span style="color:navy">jmp     short </span>entry_int77_stk
<span style="color:maroon">SYSINIT:012F </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0131 </span>old77           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0135                 </span><span style="color:navy">dw </span><span style="color:#008040">424Bh
</span><span style="color:gray">SYSINIT:0137 </span>firstflag77     <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:maroon">SYSINIT:0138 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0138                 </span><span style="color:navy">jmp     short </span>intret_77
<span style="color:maroon">SYSINIT:0138 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:013A                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:0141 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0141
SYSINIT:0141 </span>entry_int77_stk<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0141                 </span><span style="color:navy">call    near ptr </span>do_int_stacks
<span style="color:maroon">SYSINIT:0141 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0144                 </span><span style="color:navy">dw offset </span>old77
<span style="color:maroon">SYSINIT:0146 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0146
SYSINIT:0146 </span>intret_77<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0146                 </span><span style="color:navy">iret
</span><span style="color:black">SYSINIT:0147
SYSINIT:0147 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0147
SYSINIT:0147
SYSINIT:0147 </span>do_int_stacks   <span style="color:black">proc far                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0147                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:0148                 </span><span style="color:navy">push    bp
</span><span style="color:black">SYSINIT:0149                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:014A                 </span><span style="color:navy">mov     es, cs:</span>stacks<span style="color:navy">+</span><span style="color:green">2 </span>; Get segment of stacks
<span style="color:black">SYSINIT:014F                 </span>assume es:nothing
<span style="color:black">SYSINIT:014F                 </span><span style="color:navy">mov     bp, cs:</span>nextentry ; get most likely candidate
<span style="color:black">SYSINIT:0154                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; allocated
<span style="color:black">SYSINIT:0156                 </span><span style="color:navy">xchg    al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; grab the entry
<span style="color:black">SYSINIT:015A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; free ; still avail?
<span style="color:black">SYSINIT:015C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">notfree02
</span><span style="color:black">SYSINIT:015E                 </span><span style="color:navy">sub     cs:</span>nextentry<span style="color:navy">, </span><span style="color:#ff8000">8 </span>; entrysize ; set for next interrupt
<span style="color:black">SYSINIT:0164
SYSINIT:0164 </span><span style="color:gray">found02</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0164                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">], sp   </span>; [es:bp+savedsp],sp ; save sp value
<span style="color:black">SYSINIT:0168                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">], ss </span>; [es:bp+savedss],ss ; save ss also
<span style="color:black">SYSINIT:016C                 </span><span style="color:navy">mov     ax, bp          </span>; temp save of table offset
<span style="color:black">SYSINIT:016E                 </span><span style="color:navy">mov     bp, es:[bp+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; [es:bp+newsp] ; get new SP value
<span style="color:black">SYSINIT:0172                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], ax   </span>; check for offset into table
<span style="color:black">SYSINIT:0176                 </span><span style="color:navy">jnz     short </span><span style="color:gray">foundbad02
</span><span style="color:black">SYSINIT:0178                 </span><span style="color:navy">mov     ax, es          </span>; point ss,sp to the new stack
<span style="color:black">SYSINIT:017A                 </span><span style="color:navy">mov     es, bp
</span><span style="color:black">SYSINIT:017C                 </span>assume es:nothing
<span style="color:black">SYSINIT:017C                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">SYSINIT:017E                 </span><span style="color:navy">mov     bp, [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:0181                 </span><span style="color:navy">mov     ss, ax
</span><span style="color:black">SYSINIT:0183                 </span>assume ss:nothing
<span style="color:black">SYSINIT:0183                 </span><span style="color:navy">mov     sp, es
</span><span style="color:black">SYSINIT:0185                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:0187                 </span>assume es:nothing
<span style="color:black">SYSINIT:0187                 </span><span style="color:navy">mov     bp, cs:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:018B                 </span><span style="color:navy">pushf                   </span>; go execute the real interrupt handler
<span style="color:black">SYSINIT:018C                 </span><span style="color:navy">call    dword ptr cs:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">] </span>; which will iret back to here
<span style="color:black">SYSINIT:018C                                         </span>; call far [cs:bp]
<span style="color:black">SYSINIT:0190                 </span><span style="color:navy">mov     bp, sp          </span>; retrieve the table offset for us
<span style="color:black">SYSINIT:0192                 </span><span style="color:navy">mov     bp, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; but leave it on the stack
<span style="color:black">SYSINIT:0196                 </span><span style="color:navy">mov     ss, word ptr es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">] </span>; [es:bp+savedss] ; get old stack back
<span style="color:black">SYSINIT:019A                 </span>assume ss:nothing
<span style="color:black">SYSINIT:019A                 </span><span style="color:navy">mov     sp, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [es:bp+savedsp]
<span style="color:black">SYSINIT:019E                 </span><span style="color:navy">mov     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+allocbyte],free ; free the entry
<span style="color:black">SYSINIT:01A3                 </span><span style="color:navy">mov     cs:</span>nextentry<span style="color:navy">, bp </span>; setup to use next time
<span style="color:black">SYSINIT:01A8                 </span><span style="color:navy">pop     es              </span>; saved on entry
<span style="color:black">SYSINIT:01A9                 </span>assume es:nothing
<span style="color:black">SYSINIT:01A9                 </span><span style="color:navy">pop     bp              </span>; saved on entry
<span style="color:black">SYSINIT:01AA                 </span><span style="color:navy">pop     ax              </span>; saved on entry
<span style="color:black">SYSINIT:01AB                 </span><span style="color:navy">add     sp, </span><span style="color:green">2           </span>; (skip near call return addr)
<span style="color:black">SYSINIT:01AE                 </span><span style="color:navy">iret                    </span>; done with this interrupt
<span style="color:black">SYSINIT:01AF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:01AF
SYSINIT:01AF </span><span style="color:gray">notfree02</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01AF                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; allocated ; error flag
<span style="color:black">SYSINIT:01B1                 </span><span style="color:navy">jz      short </span><span style="color:gray">findnext02 </span>; no, continue
<span style="color:black">SYSINIT:01B3                 </span><span style="color:navy">xchg    al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+allocbyte] ; yes, restore error value
<span style="color:black">SYSINIT:01B7
SYSINIT:01B7 </span><span style="color:gray">findnext02</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01B7                 </span><span style="color:navy">call    </span>longpath
<span style="color:black">SYSINIT:01BA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">found02
</span><span style="color:black">SYSINIT:01BC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:01BC
SYSINIT:01BC </span><span style="color:gray">foundbad02</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01BC                 </span><span style="color:navy">cmp     bp, cs:</span>firstentry
<span style="color:black">SYSINIT:01C1                 </span><span style="color:navy">jb      short </span><span style="color:gray">findnext02
</span><span style="color:black">SYSINIT:01C3                 </span><span style="color:navy">mov     bp, ax          </span>; flag this entry
<span style="color:black">SYSINIT:01C5                 </span><span style="color:navy">mov     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">3 </span>; clobbered
<span style="color:black">SYSINIT:01CA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">findnext02 </span>; keep looking
<span style="color:black">SYSINIT:01CA </span>do_int_stacks   <span style="color:black">endp
SYSINIT:01CA
SYSINIT:01CC
SYSINIT:01CC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:01CC
SYSINIT:01CC
SYSINIT:01CC </span>longpath        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01CC                 </span><span style="color:navy">mov     bp, cs:</span>lastentry ; start with last entry in table
<span style="color:black">SYSINIT:01D1
SYSINIT:01D1 </span><span style="color:gray">lploopp</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01D1                 </span><span style="color:navy">cmp     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; free ?
<span style="color:black">SYSINIT:01D6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">inuse     </span>; no, try next one
<span style="color:black">SYSINIT:01D8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:01DA                 </span><span style="color:navy">xchg    al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+allocbyte] ; allocate entry
<span style="color:black">SYSINIT:01DE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; is it still free?
<span style="color:black">SYSINIT:01E0                 </span><span style="color:navy">jz      short </span><span style="color:gray">found     </span>; yes, go use it
<span style="color:black">SYSINIT:01E2                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; allocated ?
<span style="color:black">SYSINIT:01E2                                         </span>; is it other than Allocated or Free?
<span style="color:black">SYSINIT:01E4                 </span><span style="color:navy">jz      short </span><span style="color:gray">inuse     </span>; no, check the next one
<span style="color:black">SYSINIT:01E6                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], al   </span>; yes, put back the error state
<span style="color:black">SYSINIT:01EA
SYSINIT:01EA </span><span style="color:gray">inuse</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01EA                 </span><span style="color:navy">cmp     bp, cs:</span>firstentry
<span style="color:black">SYSINIT:01EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">fatal
</span><span style="color:black">SYSINIT:01F1                 </span><span style="color:navy">sub     bp, </span><span style="color:#ff8000">8
</span><span style="color:black">SYSINIT:01F4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">lploopp
</span><span style="color:black">SYSINIT:01F6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:01F6
SYSINIT:01F6 </span><span style="color:gray">found</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01F6                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:01F7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:01F7
SYSINIT:01F7 </span><span style="color:gray">fatal</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:01F7                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:01F8                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h      </span>; look at the model byte
<span style="color:black">SYSINIT:01FB                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:01FD                 </span>assume ds:nothing
<span style="color:black">SYSINIT:01FD                 </span><span style="color:navy">cmp     byte ptr ds:</span><span style="color:green">0FFFEh</span><span style="color:navy">, </span><span style="color:#ff8000">0F9h </span>; mdl_convert ; convertible?
<span style="color:black">SYSINIT:0202                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0203                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0203                 </span><span style="color:navy">jnz     short </span>skip_nmis
<span style="color:black">SYSINIT:0205                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7           </span>; disable pc convertible nmis
<span style="color:black">SYSINIT:0207                 </span><span style="color:navy">out     </span><span style="color:green">72h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Index Register (Extended RAM)
<span style="color:black">SYSINIT:0209
SYSINIT:0209 </span>skip_nmis<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0209                 </span><span style="color:navy">cli                     </span>; disable and mask
<span style="color:black">SYSINIT:020A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; all other ints
<span style="color:black">SYSINIT:020C                 </span><span style="color:navy">out     </span><span style="color:green">21h</span><span style="color:navy">, al         </span>; Interrupt controller, 8259A.
<span style="color:black">SYSINIT:020E                 </span><span style="color:navy">out     </span><span style="color:green">0A1h</span><span style="color:navy">, al        </span>; Interrupt Controller #2, 8259A
<span style="color:black">SYSINIT:0210                 </span><span style="color:navy">mov     si, cs
</span><span style="color:black">SYSINIT:0212                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">SYSINIT:0214                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:0214                 </span><span style="color:navy">mov     si, offset </span>fatal_msg <span style="color:gray">; &quot;\r\n\a\r\nInternal stack overflow\r\nSy&quot;...
</span><span style="color:black">SYSINIT:0217                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:0218                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:0219                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG (BIOSDATA segment)
<span style="color:black">SYSINIT:021C                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:021E                 </span>assume ds:nothing
<span style="color:black">SYSINIT:021E                 </span><span style="color:navy">test    ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1  </span>; BIOSDATA:0812h
<span style="color:black">SYSINIT:0223                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0224                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0224                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:0225                 </span><span style="color:navy">jz      short </span><span style="color:gray">fatal_loop
</span><span style="color:black">SYSINIT:0227                 </span><span style="color:navy">call    </span>far ptr 70h:813h ; call DOSBIODATASEG:V86_Crit_SetFocus
<span style="color:black">SYSINIT:022C
SYSINIT:022C </span><span style="color:gray">fatal_loop</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:022C                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:022D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">24h </span><span style="color:gray">; &#039;$&#039;
</span><span style="color:black">SYSINIT:022F                 </span><span style="color:navy">jz      short </span>fatal_done
<span style="color:black">SYSINIT:0231                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">7
</span><span style="color:black">SYSINIT:0233                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:black">SYSINIT:0235                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; (whoops, this enables ints)
<span style="color:black">SYSINIT:0235                                         </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:black">SYSINIT:0235                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:black">SYSINIT:0235                                         </span>; BL = foreground color (graphics modes)
<span style="color:black">SYSINIT:0237                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fatal_loop
</span><span style="color:black">SYSINIT:0239 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:0239
SYSINIT:0239 </span>fatal_done<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0239                 </span><span style="color:navy">jmp     short </span>fatal_done
<span style="color:black">SYSINIT:0239 </span>longpath        <span style="color:black">endp
SYSINIT:0239
SYSINIT:0239 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:023B </span>fatal_msg       <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:023B                 </span><span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,</span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah
</span><span style="color:gray">SYSINIT:023B                 </span><span style="color:navy">db &#039;Internal stack overflow&#039;,0Dh,0Ah
</span><span style="color:gray">SYSINIT:023B                 </span><span style="color:navy">db &#039;System halted&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:maroon">SYSINIT:0269 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0269
SYSINIT:0269 </span>_SYSINIT<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0269                 </span><span style="color:navy">jmp     </span>goinit
<span style="color:maroon">SYSINIT:0269 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:026C </span>runhigh         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:026D </span>DOSINFO         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:026D                                         </span>; address of the DOS Sysini Variables
<span style="color:gray">SYSINIT:0271 </span>dosinit         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0273 </span>CURRENTDOSLOCATION <span style="color:navy">dw </span><span style="color:#008040">0                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0275 </span>DEVICE_LIST     <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0279 </span>sysi_country    <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0279                                         </span>; pointer to country table in dos
<span style="color:gray">SYSINIT:027D </span>dos_segreinit   <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:027D                                         </span>; room for dword
<span style="color:gray">SYSINIT:0281 </span>lo_doscod_size  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0281                                         </span>; dos code size when in low mem
<span style="color:gray">SYSINIT:0283 </span>hi_doscod_size  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0283                                         </span>; dos code size when in HMA
<span style="color:gray">SYSINIT:0285 </span>def_php         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0287 </span>_seg_reinit_ptr <span style="color:navy">dw offset </span>_seg_reinit   <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0287                                         </span>; BIOSCODE:0032h
<span style="color:gray">SYSINIT:0289 </span>temp_bcode_seg  <span style="color:navy">dw </span><span style="color:#008040">364h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0289                                         </span>; DOSBIOCODESEG (BIOSCODE)
<span style="color:gray">SYSINIT:028B </span>fake_floppy_drv <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:028B                                         </span>; set to 1 if this machine
<span style="color:gray">SYSINIT:028B                                         </span>; does not have any floppies!!!
<span style="color:gray">SYSINIT:028C </span>stack_count     <span style="color:navy">dw </span><span style="color:#008040">9                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:028C                                         </span>; defaultcount ; 9
<span style="color:gray">SYSINIT:028E </span>stack_size      <span style="color:navy">dw </span><span style="color:#008040">128                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:028E                                         </span>; defaultsize  ; 128
<span style="color:gray">SYSINIT:0290 </span>stack_addr      <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0294 </span>MEMORY_SIZE     <span style="color:navy">dw </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0296 </span>RPLMemTop       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0298 </span>DEFAULT_DRIVE   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0298                                         </span>; initialized by ibminit
<span style="color:gray">SYSINIT:0299 </span>buffers         <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0299                                         </span>; initialized during buffer allocation
<span style="color:gray">SYSINIT:029B </span>h_buffers       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:029B                                         </span>; # of the heuristic buffers. initially 0.
<span style="color:gray">SYSINIT:029D </span>singlebuffersize <span style="color:navy">dw </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:029D                                         </span>; maximum sector size + buffer head
<span style="color:gray">SYSINIT:029F </span>FILES           <span style="color:navy">db </span><span style="color:#008040">8                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:029F                                         </span>; enough files for pipe
<span style="color:gray">SYSINIT:02A0 </span>FCBS            <span style="color:navy">db </span><span style="color:#008040">4                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02A0                                         </span>; performance for recycling
<span style="color:gray">SYSINIT:02A1 </span>KEEP            <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02A1                                         </span>; keep original set
<span style="color:gray">SYSINIT:02A2 </span>NUM_CDS         <span style="color:navy">db </span><span style="color:#008040">5                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02A2                                         </span>; 5 net drives
<span style="color:gray">SYSINIT:02A3 </span>CONFBOT         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02A5 </span>ALLOCLIM        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02A7 </span>top_of_cdss     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02A9 </span>DirStrng        <span style="color:navy">db &#039;A:\&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02A9                                         </span>; string for the root directory of a drive
<span style="color:gray">SYSINIT:02AD </span>ZERO            <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02AE </span>sepchr          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02AF </span>linecount       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02AF                                         </span>; line count in config.sys
<span style="color:gray">SYSINIT:02B1 </span>showcount       <span style="color:navy">db &#039;     &#039;,0Dh,0Ah,&#039;$&#039;  </span><span style="color:olive">; ...
</span><span style="color:gray">SYSINIT:02B1                                         </span>; used to convert linecount to ascii.
<span style="color:gray">SYSINIT:02B9 </span>buffer_linenum  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02B9                                         </span>; line count for &quot;buffers=&quot; command if entered.
<span style="color:gray">SYSINIT:02BB </span>sys_model_byte  <span style="color:navy">db </span><span style="color:#008040">0FFh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02BB                                         </span>; model byte used in sysinit
<span style="color:gray">SYSINIT:02BC </span>sys_scnd_model_byte <span style="color:navy">db </span><span style="color:#008040">0                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02BC                                         </span>; secondary model byte used in sysinit
<span style="color:gray">SYSINIT:02BD </span>buf_prev_off    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02BF </span>EXEC0_ENVIRON   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02BF                                         </span>; COMEXE  ; seg addr of environment
<span style="color:gray">SYSINIT:02C1 </span>EXEC0_COM_LINE  <span style="color:navy">dw offset </span>command_line  ; pointer to asciz command line
<span style="color:gray">SYSINIT:02C3                 </span><span style="color:navy">dw </span><span style="color:#008040">544h                 </span>; SYSINIT segment
<span style="color:gray">SYSINIT:02C5 </span>EXEC0_5C_FCB    <span style="color:navy">dw offset </span>DEFAULT_DRIVE
<span style="color:gray">SYSINIT:02C7                 </span><span style="color:navy">dw </span><span style="color:#008040">544h                 </span>; SYSINIT segment
<span style="color:gray">SYSINIT:02C9 </span>EXEC0_6C_FCB    <span style="color:navy">dw offset </span>ZERO
<span style="color:gray">SYSINIT:02CB                 </span><span style="color:navy">dw </span><span style="color:#008040">544h                 </span>; SYSINIT segment
<span style="color:gray">SYSINIT:02CD </span>multi_pass_id   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02CD                                         </span>; parameter passed to multi_pass
<span style="color:gray">SYSINIT:02CD                                         </span>; indicating the pass number
<span style="color:gray">SYSINIT:02CD                                         </span>;  0 - do scan for DOS=HIGH/LOW
<span style="color:gray">SYSINIT:02CD                                         </span>;  1 - load device drivers
<span style="color:gray">SYSINIT:02CD                                         </span>;  2 - was to load IFS
<span style="color:gray">SYSINIT:02CD                                         </span>;      now it is unused
<span style="color:gray">SYSINIT:02CD                                         </span>;  3 - do install=
<span style="color:gray">SYSINIT:02CD                                         </span>; &gt;3 - nop
<span style="color:gray">SYSINIT:02CE </span>install_flag    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02CE                                         </span>; bit 0 - config.sys has install= commands
<span style="color:gray">SYSINIT:02CE                                         </span>; bit 1 - sysinit_base installed
<span style="color:gray">SYSINIT:02D0 </span>config_size     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02D0                                         </span>; size of config.sys file
<span style="color:gray">SYSINIT:02D2 </span>sysinit_base_ptr <span style="color:navy">dd </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02D2                                         </span>; pointer to sysinit_base
<span style="color:gray">SYSINIT:02D6 </span>sysinit_ptr     <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02D6                                         </span>; returning address from sysinit_base
<span style="color:gray">SYSINIT:02DA </span>checksum        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02DA                                         </span>; used by sum_up
<span style="color:gray">SYSINIT:02DC </span>ldexec_fcb      <span style="color:navy">db </span><span style="color:#008040">14h </span><span style="color:navy">dup(</span><span style="color:#008040">20h</span><span style="color:navy">)         </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02DC                                         </span>; db 20 dup (&#039; &#039;) ; big enough
<span style="color:gray">SYSINIT:02F0 </span>ldexec_line     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02F0                                         </span>; # of parm characters
<span style="color:gray">SYSINIT:02F1 </span>ldexec_start    <span style="color:navy">db &#039; &#039;                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02F2 </span>ldexec_parm     <span style="color:navy">db </span><span style="color:#008040">80 </span><span style="color:navy">dup(  </span><span style="color:#008040">0</span><span style="color:navy">)          </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:02F2                                         </span>; times 80 db 0
<span style="color:gray">SYSINIT:0342 </span>iexec_environ   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0342                                         </span>; instexe ; seg addr of environment
<span style="color:gray">SYSINIT:0344 </span>iexec_ldexec_line <span style="color:navy">dw offset </span>ldexec_line ; pointer to asciiz command line
<span style="color:gray">SYSINIT:0346 </span>iexec_ldexec_line_seg <span style="color:navy">dw </span><span style="color:#008040">544h           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0348 </span>iexec_ldexec_5c_fcb <span style="color:navy">dw offset </span>ldexec_fcb ; default fcb at 5Ch
<span style="color:gray">SYSINIT:034A </span>iexec_ldexec_5c_fcb_seg <span style="color:navy">dw </span><span style="color:#008040">544h         </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:034C </span>iexec_ldexec_6c_fcb <span style="color:navy">dw offset </span>ldexec_fcb ; default fcb at 6Ch
<span style="color:gray">SYSINIT:034E </span>iexec_ldexec_6c_fcb_seg <span style="color:navy">dw </span><span style="color:#008040">544h         </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0350 </span>com_level       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0350                                         </span>; level of &quot; &quot; in command line
<span style="color:gray">SYSINIT:0351 </span>cmmt            <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0351                                         </span>; length of comment string token
<span style="color:gray">SYSINIT:0352 </span>cmmt1           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0352                                         </span>; token
<span style="color:gray">SYSINIT:0353 </span>cmmt2           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0353                                         </span>; token
<span style="color:gray">SYSINIT:0354 </span>cmd_indicator   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0355 </span>donotshownum    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0356 </span>count           <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0358 </span>org_count       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:035A </span>chrptr          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:035C </span>cntryfilehandle <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:035E </span>old_area        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0360 </span>impossible_owner_size <span style="color:navy">dw </span><span style="color:#008040">0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0360                                         </span>; paragraph
<span style="color:gray">SYSINIT:0362 </span>memlo           <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0362                                         </span>; bufptr, bucketptr (dword)
<span style="color:gray">SYSINIT:0364 </span>memhi           <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0364                                         </span>; prmblk (word)
<span style="color:gray">SYSINIT:0366 </span>ldoff           <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:0368 </span>area            <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:036A </span>prev_memhi      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:036C </span>prev_alloclim   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:036E </span>dosdata_umb     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:036F </span>packet          <span style="color:navy">db </span><span style="color:#008040">25                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:036F                                         </span>; was 24 (in MSDOS 6.21)
<span style="color:gray">SYSINIT:0370                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:0371                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; initialize code
<span style="color:gray">SYSINIT:0372                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:0374                 </span><span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:037C </span>unitcount       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:037D </span>break_addr      <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0381 </span>bpb_addr        <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0385 </span>devdrivenum     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0386 </span>configmsgflag   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0386                                         </span>; used to control &quot;error in config.sys line #&quot; message
<span style="color:gray">SYSINIT:0386                                         </span>; (configmsgflag is the last word of the 25 byte packet)
<span style="color:gray">SYSINIT:0386                                         </span>; ((default value is 0, device driver init may change? it))
<span style="color:gray">SYSINIT:0387                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:0388 </span>drivenumber     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0389 </span>toomanydrivesflag <span style="color:navy">db </span><span style="color:#008040">0                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0389                                         </span>; &gt;24 fixed disk partitions flag
<span style="color:gray">SYSINIT:038A </span>BCodeSeg        <span style="color:navy">dw </span><span style="color:#008040">364h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:038A                                         </span>; DOSBIOCODESEG (BIOSCODE segment)
<span style="color:gray">SYSINIT:038C </span>_timer_lw_      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:038E </span>F5_key          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:038F </span>F8_key          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0390 </span>MagicBackdoor   <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0394 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0394
SYSINIT:0394 </span>NullBackdoor<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0394                 </span><span style="color:navy">retf
</span><span style="color:maroon">SYSINIT:0394 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0395 </span>BiosComBlock    <span style="color:navy">dw offset </span>SysinitPresent <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0395                                         </span>; BIOSDATA:07DDh
<span style="color:gray">SYSINIT:0397                 </span><span style="color:navy">dw </span><span style="color:#008040">70h                  </span>; BIOSDATA segment
<span style="color:gray">SYSINIT:0399 </span>tempstack       <span style="color:navy">db </span><span style="color:#008040">128 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:maroon">SYSINIT:0419 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0419
SYSINIT:0419 </span>goinit<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0419                 </span><span style="color:navy">mov     ah, </span><span style="color:green">0C0h
</span><span style="color:maroon">SYSINIT:041B                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; SYSTEM - GET CONFIGURATION
<span style="color:maroon">SYSINIT:041B                                         </span>; (XT after 1/10/86,AT mdl 3x9,CONV,XT286,PS)
<span style="color:maroon">SYSINIT:041D                 </span><span style="color:navy">jb      short </span>no_rom_config
<span style="color:maroon">SYSINIT:041F                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:0422                 </span><span style="color:navy">jnz     short </span>no_rom_config
<span style="color:maroon">SYSINIT:0424                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [es:bx+ROMBIOS_DESC.bios_sd_modelbyte]
<span style="color:maroon">SYSINIT:0428                 </span><span style="color:navy">mov     cs:</span>sys_model_byte<span style="color:navy">, al
</span><span style="color:maroon">SYSINIT:042C                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [es:bx+ROMBIOS_DESC.bios_sd_scnd_modelbyte]
<span style="color:maroon">SYSINIT:0430                 </span><span style="color:navy">mov     cs:</span>sys_scnd_model_byte<span style="color:navy">, al
</span><span style="color:maroon">SYSINIT:0434                 </span><span style="color:navy">jmp     short </span>move_myself
<span style="color:maroon">SYSINIT:0436 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0436
SYSINIT:0436 </span>no_rom_config<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0436                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">SYSINIT:0439                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">SYSINIT:043B                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:043B                 </span><span style="color:navy">mov     al, ds:</span><span style="color:green">0FFFEh
</span><span style="color:maroon">SYSINIT:043E                 </span><span style="color:navy">mov     cs:</span>sys_model_byte<span style="color:navy">, al
</span><span style="color:maroon">SYSINIT:0442                 </span><span style="color:navy">int     </span><span style="color:green">11h             </span>; EQUIPMENT DETERMINATION
<span style="color:maroon">SYSINIT:0442                                         </span>; Return: AX = equipment flag bits
<span style="color:maroon">SYSINIT:0444                 </span><span style="color:navy">jmp     short </span>check_for_fake_floppy
<span style="color:maroon">SYSINIT:0444 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">SYSINIT:0446                 </span><span style="color:navy">db  </span><span style="color:#008040">52h </span><span style="color:gray">; R             </span>; &#039;RPS&#039; sign
<span style="color:olive">SYSINIT:0447                 </span><span style="color:navy">db  </span><span style="color:#008040">50h </span><span style="color:gray">; P
</span><span style="color:olive">SYSINIT:0448                 </span><span style="color:navy">db  </span><span style="color:#008040">53h </span><span style="color:gray">; S
</span><span style="color:maroon">SYSINIT:0449 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0449
SYSINIT:0449 </span>check_for_fake_floppy<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0449                 </span><span style="color:navy">or      ax, </span><span style="color:green">1           </span>; (nonsense! this may be overwritten/disabled
<span style="color:maroon">SYSINIT:0449                                         </span>; by using &#039;RPS&#039; sign position) 03/07/2023 - Erdogan Tan
<span style="color:maroon">SYSINIT:044C                 </span><span style="color:navy">test    ax, </span><span style="color:green">1           </span>; have any floppies?
<span style="color:maroon">SYSINIT:044F                 </span><span style="color:navy">jnz     short </span>move_myself ; yes,normal system
<span style="color:maroon">SYSINIT:0451                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:0452                 </span><span style="color:navy">xor     cl, cl
</span><span style="color:maroon">SYSINIT:0454                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">8           </span>; get disk parameters
<span style="color:maroon">SYSINIT:0456                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:0458                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - DISK - GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
<span style="color:maroon">SYSINIT:0458                                         </span>; DL = drive number
<span style="color:maroon">SYSINIT:0458                                         </span>; Return: CF set on error, AH = status code, BL = drive type
<span style="color:maroon">SYSINIT:0458                                         </span>; DL = number of consecutive drives
<span style="color:maroon">SYSINIT:0458                                         </span>; DH = maximum value for head number, ES:DI -&gt; drive parameter
<span style="color:maroon">SYSINIT:045A                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:045B                 </span><span style="color:navy">jb      short </span>move_myself ; if error lets assume that the ROM BIOS lied
<span style="color:maroon">SYSINIT:045D                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">0           </span>; double check (max sec no cannot be 0)
<span style="color:maroon">SYSINIT:0460                 </span><span style="color:navy">jz      short </span>move_myself
<span style="color:maroon">SYSINIT:0462                 </span><span style="color:navy">or      dl, dl          </span>; number of flp drvs == 0?
<span style="color:maroon">SYSINIT:0464                 </span><span style="color:navy">jnz     short </span>move_myself
<span style="color:maroon">SYSINIT:0466                 </span><span style="color:navy">mov     cs:</span>fake_floppy_drv<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; set fake flag
<span style="color:maroon">SYSINIT:046C
SYSINIT:046C </span>move_myself<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:046C                 </span><span style="color:navy">cld                     </span>; set up move
<span style="color:maroon">SYSINIT:046D                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">SYSINIT:046F                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">SYSINIT:0471                 </span><span style="color:navy">mov     cx, cs:</span>MEMORY_SIZE
<span style="color:maroon">SYSINIT:0476                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:0477                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:0478                 </span>assume ds:SYSINIT
<span style="color:maroon">SYSINIT:0478                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">SYSINIT:0479                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">SYSINIT:047B                 </span><span style="color:navy">mov     es, bx          </span>; 0
<span style="color:maroon">SYSINIT:047D                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:047D                 </span><span style="color:navy">mov     bx, </span>word ptr es:0BCh ; Int 2Fh vector (4*2Fh)
<span style="color:maroon">SYSINIT:0482                 </span><span style="color:navy">mov     es, </span>word ptr es:0BEh
<span style="color:maroon">SYSINIT:0487                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0487                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">5052h </span>; &#039;RP&#039;
<span style="color:maroon">SYSINIT:048D                 </span><span style="color:navy">jnz     short </span>NoRPL
<span style="color:maroon">SYSINIT:048F                 </span><span style="color:navy">cmp     byte ptr es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4Ch </span>; &#039;L&#039;
<span style="color:maroon">SYSINIT:0494                 </span><span style="color:navy">jnz     short </span>NoRPL
<span style="color:maroon">SYSINIT:0496                 </span><span style="color:navy">mov     dx, cx          </span>; get TOM into DX
<span style="color:maroon">SYSINIT:0498                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">SYSINIT:0499                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A06h       </span>; (multMULT&lt;&lt;8)+multMULTRPLTOM
<span style="color:maroon">SYSINIT:049C
SYSINIT:049C </span><span style="color:navy">loc_57CC:                               </span>; Get new TOM from any RPL
<span style="color:maroon">SYSINIT:049C                 </span><span style="color:navy">int     </span><span style="color:green">2Fh
</span><span style="color:maroon">SYSINIT:049E                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">SYSINIT:049F                 </span><span style="color:navy">mov     cx, dx
</span><span style="color:maroon">SYSINIT:04A1                 </span><span style="color:navy">cmp     dx, ax
</span><span style="color:maroon">SYSINIT:04A3                 </span><span style="color:navy">jz      short </span>NoRPL
<span style="color:maroon">SYSINIT:04A5                 </span><span style="color:navy">mov     cs:</span>RPLMemTop<span style="color:navy">, dx
</span><span style="color:maroon">SYSINIT:04AA                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">SYSINIT:04AB
SYSINIT:04AB </span>NoRPL<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:04AB                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5B40h       </span>; SI_end ; need this much room for sysinit
<span style="color:maroon">SYSINIT:04AB                                         </span>; (SI_end == sysinit code size)
<span style="color:maroon">SYSINIT:04AE                 </span><span style="color:navy">call    </span>_off_to_para
<span style="color:maroon">SYSINIT:04B1                 </span><span style="color:navy">sub     cx, ax
</span><span style="color:maroon">SYSINIT:04B3                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">0B00h       </span>; DOSSIZE/16 (2816)
<span style="color:maroon">SYSINIT:04B3                                         </span>; leave this much room for DOS
<span style="color:maroon">SYSINIT:04B7                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1E00h       </span>; BCODE_END
<span style="color:maroon">SYSINIT:04BA                 </span><span style="color:navy">call    </span>_off_to_para    ; leave this much room for BIOS code
<span style="color:maroon">SYSINIT:04BD                 </span><span style="color:navy">sub     cx, ax
</span><span style="color:maroon">SYSINIT:04BF                 </span><span style="color:navy">mov     es, cx          </span>; offset where sysinit will be located
<span style="color:maroon">SYSINIT:04C1                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5B40h       </span>; SI_end ; (sysinit code size)
<span style="color:maroon">SYSINIT:04C4                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1           </span>; divide by 2 to get words
<span style="color:maroon">SYSINIT:04C6                 </span><span style="color:navy">rep movsw               </span>; relocate sysinit
<span style="color:maroon">SYSINIT:04C8                 </span><span style="color:navy">push    es              </span>; push relocated segment
<span style="color:maroon">SYSINIT:04C9                 </span><span style="color:navy">mov     ax, offset </span>SYSIN ; SYSINIT:04F3h
<span style="color:maroon">SYSINIT:04CC                 </span><span style="color:navy">push    ax              </span>; push relocated entry point
<span style="color:maroon">SYSINIT:04CD                 </span><span style="color:navy">retf                    </span>; far jump to relocated sysinit
<span style="color:black">SYSINIT:04CE
SYSINIT:04CE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:04CE
SYSINIT:04CE
SYSINIT:04CE </span>get_cpu_type    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:04CE                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:04CF                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:04D0                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">SYSINIT:04D2                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:04D4                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:04D5                 </span><span style="color:navy">popf
</span><span style="color:black">SYSINIT:04D6                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:04D7                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:04D8                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:04DB                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:04DE                 </span><span style="color:navy">jz      short </span><span style="color:gray">cpu_8086
</span><span style="color:black">SYSINIT:04E0                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:04E3                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:04E4                 </span><span style="color:navy">popf
</span><span style="color:black">SYSINIT:04E5                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:04E6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:04E7                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:04EA                 </span><span style="color:navy">jz      short </span><span style="color:gray">cpu_286
</span><span style="color:black">SYSINIT:04EC
SYSINIT:04EC </span>cpu_386<span style="color:navy">:
</span><span style="color:black">SYSINIT:04EC                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:04ED
SYSINIT:04ED </span><span style="color:gray">cpu_286</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:04ED                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:04EE
SYSINIT:04EE </span><span style="color:gray">cpu_8086</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:04EE                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">SYSINIT:04F0                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:04F1                 </span><span style="color:navy">popf
</span><span style="color:black">SYSINIT:04F2                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:04F2 </span>get_cpu_type    <span style="color:black">endp
SYSINIT:04F2
</span><span style="color:maroon">SYSINIT:04F3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:04F3
SYSINIT:04F3 </span>SYSIN<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:04F3                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h
</span><span style="color:maroon">SYSINIT:04F6                 </span><span style="color:navy">mov     ds, ax          </span>; DOSBIODATASEG
<span style="color:maroon">SYSINIT:04F8                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:04F8                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:04F9                 </span><span style="color:navy">push    ax              </span>; not needed (*) E.TAN - 03/07/2023
<span style="color:maroon">SYSINIT:04FA                 </span><span style="color:navy">push    di
</span><span style="color:maroon">SYSINIT:04FB                 </span><span style="color:navy">call    </span>get_cpu_type    ; determine if 386 system
<span style="color:maroon">SYSINIT:04FE                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">2           </span>; 0 = 8086, 1 = 286, 2 = 386
<span style="color:maroon">SYSINIT:0501                 </span><span style="color:navy">jnz     short </span>not_386_system
<span style="color:maroon">SYSINIT:0503                 </span><span style="color:navy">cld                     </span>; 80386
<span style="color:maroon">SYSINIT:0504                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:0505                 </span><span style="color:navy">pop     es              </span>; change A20 line on/off check code
<span style="color:maroon">SYSINIT:0506                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0506                 </span><span style="color:navy">mov     di, offset </span>cpu386_cmpsd
<span style="color:maroon">SYSINIT:0509                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4B9h        </span>; mov cx,4 ; B90400
<span style="color:maroon">SYSINIT:050C                 </span><span style="color:navy">stosw
</span><span style="color:maroon">SYSINIT:050D                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F300h      </span>; repz  ; F3
<span style="color:maroon">SYSINIT:0510                 </span><span style="color:navy">stosw
</span><span style="color:maroon">SYSINIT:0511                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0A766h      </span>; cmpsd ; 66A7
<span style="color:maroon">SYSINIT:0514                 </span><span style="color:navy">stosw
</span><span style="color:maroon">SYSINIT:0515
SYSINIT:0515 </span>not_386_system<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0515                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">SYSINIT:0516                 </span><span style="color:navy">pop     ax              </span>; not needed (*) E.TAN - 03/07/2023
<span style="color:maroon">SYSINIT:0517                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:0518                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0518                 </span><span style="color:navy">mov     ds:</span>MoveDOSIntoHMA_2<span style="color:navy">, cs </span>; set seg of routine to move DOS
<span style="color:maroon">SYSINIT:0518                                         </span>; update SYSINITSEG field
<span style="color:maroon">SYSINIT:0518                                         </span>; MoveDOSIntoHMA+2
<span style="color:maroon">SYSINIT:051C                 </span><span style="color:navy">mov     ds:</span>SysinitPresent<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; flag that MoveDOSIntoHMA can be called
<span style="color:maroon">SYSINIT:0521                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5B40h       </span>; SI_end ; how big is sysinitseg?
<span style="color:maroon">SYSINIT:0524                 </span><span style="color:navy">call    </span>_off_to_para
<span style="color:maroon">SYSINIT:0527                 </span><span style="color:navy">mov     cx, cs          </span>; pick a buffer for msdos above us
<span style="color:maroon">SYSINIT:0529                 </span><span style="color:navy">add     ax, cx
</span><span style="color:maroon">SYSINIT:052B                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">SYSINIT:052D                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">SYSINIT:052F                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">SYSINIT:0531                 </span><span style="color:navy">mov     ds, cs:</span>CURRENTDOSLOCATION ; where it is (set by msinit)
<span style="color:maroon">SYSINIT:0536                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:0536                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5800h       </span>; DOSSIZE/2 (22528)
<span style="color:maroon">SYSINIT:0539                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">SYSINIT:053B                 </span><span style="color:navy">mov     cs:</span>CURRENTDOSLOCATION<span style="color:navy">, es
</span><span style="color:maroon">SYSINIT:0540                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">3        </span>; get offset of dos
<span style="color:maroon">SYSINIT:0540                                         </span>; ax = 3F10h for IBMDOS 7.1 kernel
<span style="color:maroon">SYSINIT:0540                                         </span>;  (IBMDOS.SYS, offset 3)
<span style="color:maroon">SYSINIT:0543                 </span><span style="color:navy">mov     cs:</span>dosinit<span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:0547                 </span><span style="color:navy">call    </span>_off_to_para    ; subtract this much from segment
<span style="color:maroon">SYSINIT:054A                 </span><span style="color:navy">sub     cs:</span>CURRENTDOSLOCATION<span style="color:navy">, ax </span>; FINAL_DOS_LOCATION
<span style="color:maroon">SYSINIT:054F                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">SYSINIT:0551                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">0B00h       </span>; DOSSIZE/16 ; DOSSIZE = 0B000h = 45056
<span style="color:maroon">SYSINIT:0554                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">SYSINIT:0556                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0556                 </span><span style="color:navy">xchg    ax, cs:</span>temp_bcode_seg ; swap with original home of Bios_Code
<span style="color:maroon">SYSINIT:055B                 </span><span style="color:navy">mov     ds, ax          </span>; point to loaded image of Bios_Code
<span style="color:maroon">SYSINIT:055D                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:055D                 </span><span style="color:navy">mov     si, offset </span>Bios_Data_Word ; BCODESTART (= BiosDataWord)
<span style="color:maroon">SYSINIT:055D                                         </span>; BIOSCODE:BCODESTART (BIOSCODE:0030h)
<span style="color:maroon">SYSINIT:0560                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">SYSINIT:0562                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1E00h       </span>; BCODE_END = (SYSINITSEG-DOSBIOCODESEG)*16
<span style="color:maroon">SYSINIT:0562                                         </span>; (544h-364h)*10h = 1E00h (for PCDOS 7.1 IBMBIO.COM)
<span style="color:maroon">SYSINIT:0565                 </span><span style="color:navy">sub     cx, si
</span><span style="color:maroon">SYSINIT:0567                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:maroon">SYSINIT:0569                 </span><span style="color:navy">rep movsw               </span>; move Bios_Code into place
<span style="color:maroon">SYSINIT:056B                 </span><span style="color:navy">mov     ax, es          </span>; tell it what segment it&#039;s in
<span style="color:maroon">SYSINIT:056D                 </span><span style="color:navy">call    dword ptr cs:</span>_seg_reinit_ptr
<span style="color:maroon">SYSINIT:0572                 </span><span style="color:navy">les     di, dword ptr cs:</span>BiosComBlock
<span style="color:maroon">SYSINIT:0577                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0577                 </span><span style="color:navy">lds     si, cs:</span>DEVICE_LIST
<span style="color:maroon">SYSINIT:057C                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:057C                 </span><span style="color:navy">mov     dx, cs:</span>MEMORY_SIZE
<span style="color:maroon">SYSINIT:0581                 </span><span style="color:navy">cli
</span><span style="color:maroon">SYSINIT:0582                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:maroon">SYSINIT:0584                 </span><span style="color:navy">mov     ss, ax
</span><span style="color:maroon">SYSINIT:0586                 </span>assume ss:SYSINIT
<span style="color:maroon">SYSINIT:0586
SYSINIT:0586 </span>locstack<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0586                 </span><span style="color:navy">mov     sp, offset </span>locstack ; set stack
<span style="color:maroon">SYSINIT:0586                                         </span>; mov sp, 586h ; mov sp, locstack
<span style="color:maroon">SYSINIT:0586                                         </span>; %define locstack ($ - SYSINIT$) &amp; 0FFFEh
<span style="color:maroon">SYSINIT:0586                                         </span>; locstack = $ &amp; 0FFFEh (SYSINIT:SYSINITŞ=544h:0)
<span style="color:maroon">SYSINIT:0589                 </span><span style="color:navy">sti
</span><span style="color:maroon">SYSINIT:058A                 </span><span style="color:navy">call    dword ptr cs:</span>dosinit ; call dosinit
<span style="color:maroon">SYSINIT:058A                                         </span>; es:di -&gt; sysinitvars_ext
<span style="color:maroon">SYSINIT:058F                 </span><span style="color:navy">mov     cs:</span>def_php<span style="color:navy">, ds  </span>; save pointer to PSP
<span style="color:maroon">SYSINIT:0594                 </span><span style="color:navy">mov     cs:</span>hi_doscod_size<span style="color:navy">, ax </span>; size of doscode (including exepatch)
<span style="color:maroon">SYSINIT:0598                 </span><span style="color:navy">mov     cs:</span>lo_doscod_size<span style="color:navy">, cx </span>; (as exepatch excluded)
<span style="color:maroon">SYSINIT:059D                 </span><span style="color:navy">mov     word ptr cs:</span>dos_segreinit<span style="color:navy">, dx </span>; save offset of segreinit
<span style="color:maroon">SYSINIT:05A2                 </span><span style="color:navy">mov     ax, es:[di]     </span>; [es:di+SysInitVars_Ext.SYSI_InitVars]
<span style="color:maroon">SYSINIT:05A5                 </span><span style="color:navy">mov     word ptr cs:</span>DOSINFO<span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:05A9                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">SYSINIT:05AD                 </span><span style="color:navy">mov     word ptr cs:</span>DOSINFO<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:05B1                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+SysInitVars_Ext.SYSI_Country_Tab]
<span style="color:maroon">SYSINIT:05B5                 </span><span style="color:navy">mov     word ptr cs:</span>sysi_country<span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:05B9                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; [es:di+SysInitVars_Ext.SYSI_Country_Tab+2]
<span style="color:maroon">SYSINIT:05BD                 </span><span style="color:navy">mov     word ptr cs:</span>sysi_country<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:05C1                 </span><span style="color:navy">mov     es, cs:</span>CURRENTDOSLOCATION ; = [FINAL_DOS_LOCATION]
<span style="color:maroon">SYSINIT:05C6                 </span><span style="color:navy">mov     word ptr cs:</span>dos_segreinit<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">SYSINIT:05CB                 </span><span style="color:navy">cmp     cs:</span>RPLMemTop<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:05D1                 </span><span style="color:navy">jz      short </span>NoRPLArena
<span style="color:maroon">SYSINIT:05D3                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">SYSINIT:05D6                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:maroon">SYSINIT:05D8                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:maroon">SYSINIT:05D8                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:maroon">SYSINIT:05DA                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:maroon">SYSINIT:05DC                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:maroon">SYSINIT:05DC                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:maroon">SYSINIT:05DE                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">SYSINIT:05E0                 </span><span style="color:navy">push    es              </span>; resize upto RPL mem
<span style="color:maroon">SYSINIT:05E1                 </span><span style="color:navy">sub     ax, cs:</span>RPLMemTop
<span style="color:maroon">SYSINIT:05E6                 </span><span style="color:navy">neg     ax
</span><span style="color:maroon">SYSINIT:05E8                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">SYSINIT:05E9                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">SYSINIT:05EB                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4Ah
</span><span style="color:maroon">SYSINIT:05ED                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
<span style="color:maroon">SYSINIT:05ED                                         </span>; ES = segment address of block to change
<span style="color:maroon">SYSINIT:05ED                                         </span>; BX = new size in paragraphs
<span style="color:maroon">SYSINIT:05EF                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">SYSINIT:05F2                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:maroon">SYSINIT:05F4                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:maroon">SYSINIT:05F4                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:maroon">SYSINIT:05F6                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:maroon">SYSINIT:05F8                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:maroon">SYSINIT:05F8                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:maroon">SYSINIT:05FA                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">SYSINIT:05FB                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">SYSINIT:05FD                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:arena_owner]
<span style="color:maroon">SYSINIT:0604                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">5052h </span>; [es:arena_name],&#039;RP&#039;
<span style="color:maroon">SYSINIT:060B                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">10</span><span style="color:navy">, </span><span style="color:#ff8000">4Ch </span><span style="color:gray">; &#039;L&#039; </span>; [es:arena_name+2],&#039;L&#039;
<span style="color:maroon">SYSINIT:0612                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">12</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [es:arena_name+4]
<span style="color:maroon">SYSINIT:0619                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">14</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [es:arena_name+6]
<span style="color:maroon">SYSINIT:0620                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:0621                 </span><span style="color:navy">mov     ah, </span><span style="color:green">49h         </span>; Dealloc
<span style="color:maroon">SYSINIT:0623                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - FREE MEMORY
<span style="color:maroon">SYSINIT:0623                                         </span>; ES = segment address of area to be freed
<span style="color:maroon">SYSINIT:0625
SYSINIT:0625 </span>NoRPLArena<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0625                 </span><span style="color:navy">les     di, cs:</span>DOSINFO
<span style="color:maroon">SYSINIT:062A                 </span><span style="color:navy">clc
</span><span style="color:maroon">SYSINIT:062B                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">88h
</span><span style="color:maroon">SYSINIT:062D                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; Get Extended Memory Size
<span style="color:maroon">SYSINIT:062D                                         </span>; Return: CF clear on success
<span style="color:maroon">SYSINIT:062D                                         </span>; AX = size of memory above 1M in K
<span style="color:maroon">SYSINIT:062F                 </span><span style="color:navy">jb      short </span>no_ext_memory
<span style="color:maroon">SYSINIT:0631                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">45h</span><span style="color:navy">], ax </span>; [es:di+SYSI_EXT_MEM]
<span style="color:maroon">SYSINIT:0635                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">SYSINIT:0637                 </span><span style="color:navy">jz      short </span>no_ext_memory
<span style="color:maroon">SYSINIT:0639                 </span><span style="color:navy">call    </span>ClrVDISKHeader
<span style="color:maroon">SYSINIT:063C
SYSINIT:063C </span>no_ext_memory<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:063C                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; [es:di+SYSI_MAXSEC]
<span style="color:maroon">SYSINIT:0640                 </span><span style="color:navy">add     ax, </span><span style="color:green">24          </span>; bufinsiz
<span style="color:maroon">SYSINIT:0640                                         </span>; size of buffer header = 24 (PCDOS v7.1 IBMBIO.COM)
<span style="color:maroon">SYSINIT:0640                                         </span>; (it was 20 in MSDOS 6.21 IO:SYS)
<span style="color:maroon">SYSINIT:0643                 </span><span style="color:navy">mov     cs:</span>singlebuffersize<span style="color:navy">, ax </span>; total size for a buffer
<span style="color:maroon">SYSINIT:0647                 </span><span style="color:navy">mov     al, cs:</span>DEFAULT_DRIVE
<span style="color:maroon">SYSINIT:064B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">43h</span><span style="color:navy">], al </span>; [es:di+SYSI_BOOT_DRIVE]
<span style="color:maroon">SYSINIT:064F
SYSINIT:064F </span>_get_cpu_type<span style="color:navy">:
</span><span style="color:maroon">SYSINIT:064F                 </span><span style="color:navy">pushf
</span><span style="color:maroon">SYSINIT:0650                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">SYSINIT:0651                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">SYSINIT:0653                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">SYSINIT:0655                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">SYSINIT:0656                 </span><span style="color:navy">popf
</span><span style="color:maroon">SYSINIT:0657                 </span><span style="color:navy">pushf
</span><span style="color:maroon">SYSINIT:0658                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">SYSINIT:0659                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">SYSINIT:065C                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">SYSINIT:065F                 </span><span style="color:navy">jz      short </span>_cpu_8086
<span style="color:maroon">SYSINIT:0661                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">SYSINIT:0664                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">SYSINIT:0665                 </span><span style="color:navy">popf
</span><span style="color:maroon">SYSINIT:0666                 </span><span style="color:navy">pushf
</span><span style="color:maroon">SYSINIT:0667                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">SYSINIT:0668                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">SYSINIT:066B                 </span><span style="color:navy">jz      short </span>_cpu_286
<span style="color:maroon">SYSINIT:066D
SYSINIT:066D </span>_cpu_386<span style="color:navy">:
</span><span style="color:maroon">SYSINIT:066D                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">SYSINIT:066E
SYSINIT:066E </span>_cpu_286<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:066E                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">SYSINIT:066F
SYSINIT:066F </span>_cpu_8086<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:066F                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">SYSINIT:0671                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">SYSINIT:0672                 </span><span style="color:navy">popf
</span><span style="color:maroon">SYSINIT:0673                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">2
</span><span style="color:maroon">SYSINIT:0676                 </span><span style="color:navy">jnz     short </span>_not_386_cpu
<span style="color:maroon">SYSINIT:0678                 </span><span style="color:navy">mov     byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [es:di+SYSI_DWMOVE],1
<span style="color:maroon">SYSINIT:0678                                         </span>; set doubleword moving flag
<span style="color:maroon">SYSINIT:067D
SYSINIT:067D </span>_not_386_cpu<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:067D                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">] </span>; [es:di+SYSI_NUMIO]
<span style="color:maroon">SYSINIT:0681                 </span><span style="color:navy">mov     cs:</span>drivenumber<span style="color:navy">, al </span>; save start of installable block drvs
<span style="color:maroon">SYSINIT:0685                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:maroon">SYSINIT:0687                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">11h         </span>; room for PSP we will copy shortly
<span style="color:maroon">SYSINIT:068A                 </span><span style="color:navy">mov     cx, cs:</span>singlebuffersize ; temporary single buffer area
<span style="color:maroon">SYSINIT:068F                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:maroon">SYSINIT:0691                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:maroon">SYSINIT:0693                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:maroon">SYSINIT:0695                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1           </span>; divide size by 16..
<span style="color:maroon">SYSINIT:0695                                         </span>; ...to get paragraphs...
<span style="color:maroon">SYSINIT:0697                 </span><span style="color:navy">inc     cx              </span>; ... and round up
<span style="color:maroon">SYSINIT:0698                 </span><span style="color:navy">sub     ax, cx
</span><span style="color:maroon">SYSINIT:069A                 </span><span style="color:navy">mov     cs:</span>top_of_cdss<span style="color:navy">, ax </span>; temp &quot;unsafe&quot; location
<span style="color:maroon">SYSINIT:069E                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:069F                 </span><span style="color:navy">push    di
</span><span style="color:maroon">SYSINIT:06A0                 </span><span style="color:navy">mov     cx, ax          </span>; save pointer for buffer
<span style="color:maroon">SYSINIT:06A2                 </span><span style="color:navy">sub     ax, </span><span style="color:green">143         </span>; sub ax,((26 *(curdirlen))+15)/16
<span style="color:maroon">SYSINIT:06A2                                         </span>; (curdirlen=88)
<span style="color:maroon">SYSINIT:06A5                 </span><span style="color:navy">mov     cs:</span>ALLOCLIM<span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:06A9                 </span><span style="color:navy">mov     cs:</span>CONFBOT<span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:06AD                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">12h</span><span style="color:navy">] </span>; [es:di+SYSI_BUF]
<span style="color:maroon">SYSINIT:06B1                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+BUFFINF.Dirty_Buff_Count]
<span style="color:maroon">SYSINIT:06B7                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; [es:di+BUFFINF.Buff_Queue]
<span style="color:maroon">SYSINIT:06BC                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], cx   </span>; [es:di+BUFFINF.Buff_Queue+2]
<span style="color:maroon">SYSINIT:06BC                                         </span>; cx = [top_of_cdss]
<span style="color:maroon">SYSINIT:06C0                 </span><span style="color:navy">mov     es, cx
</span><span style="color:maroon">SYSINIT:06C2                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">SYSINIT:06C4                 </span><span style="color:navy">mov     di, ax
</span><span style="color:maroon">SYSINIT:06C6                 </span><span style="color:navy">mov     es:[di], ax     </span>; [es:di+buffinfo.buf_next],0
<span style="color:maroon">SYSINIT:06C9                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax   </span>; [es:di+buffinfo.buf_prev],0
<span style="color:maroon">SYSINIT:06CD                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; [es:di+buffinfo.buf_ID],00FFh
<span style="color:maroon">SYSINIT:06CD                                         </span>; free buffer,clear flag
<span style="color:maroon">SYSINIT:06D3                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+buffinfo.buf_sector]
<span style="color:maroon">SYSINIT:06D9                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+buffinfo.buf_sector+2]
<span style="color:maroon">SYSINIT:06DF                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">SYSINIT:06E0                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:06E1                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:06E2                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:06E3                 </span>assume ds:SYSINIT
<span style="color:maroon">SYSINIT:06E3                 </span><span style="color:navy">call    </span>TempCDS         ; set up cdss so re_init and sysinit
<span style="color:maroon">SYSINIT:06E3                                         </span>; can make disk system calls
<span style="color:maroon">SYSINIT:06E3                                         </span>; tempcds trashes ds
<span style="color:maroon">SYSINIT:06E6                 </span><span style="color:navy">mov     ds, cs:</span>def_php  ; retrieve pointer to PSP returned by DOSINIT
<span style="color:maroon">SYSINIT:06EB                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:06EB                 </span><span style="color:navy">call    </span>far ptr 70h:729h ; call DOSBIODATASEG:re_init
<span style="color:maroon">SYSINIT:06F0                 </span><span style="color:navy">sti
</span><span style="color:maroon">SYSINIT:06F1                 </span><span style="color:navy">cld
</span><span style="color:maroon">SYSINIT:06F2                 </span><span style="color:navy">mov     bx, cs
</span><span style="color:maroon">SYSINIT:06F4                 </span><span style="color:navy">sub     bx, </span><span style="color:green">10h
</span><span style="color:maroon">SYSINIT:06F7                 </span><span style="color:navy">mov     es, bx
</span><span style="color:maroon">SYSINIT:06F9                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:06F9                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">SYSINIT:06FB                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">SYSINIT:06FD                 </span><span style="color:navy">mov     cx, </span><span style="color:green">128
</span><span style="color:maroon">SYSINIT:0700                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">SYSINIT:0702                 </span><span style="color:navy">mov     </span>word ptr es:36h<span style="color:navy">, es </span>; [es:PDB.JFN_POINTER+2],es ; Relocate
<span style="color:maroon">SYSINIT:0707                 </span><span style="color:navy">mov     ah, </span><span style="color:green">50h
</span><span style="color:maroon">SYSINIT:0709                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - SET PSP SEGMENT
<span style="color:maroon">SYSINIT:0709                                         </span>; BX = segment address of new PSP
<span style="color:maroon">SYSINIT:070B                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:070C                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:070D                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:070E                 </span>assume ds:SYSINIT
<span style="color:maroon">SYSINIT:070E                 </span><span style="color:navy">mov     dx, offset </span>int24 ; set up int 24h handler
<span style="color:maroon">SYSINIT:0711                 </span><span style="color:navy">mov     ax, </span><span style="color:green">2524h
</span><span style="color:maroon">SYSINIT:0714                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - SET INTERRUPT VECTOR
<span style="color:maroon">SYSINIT:0714                                         </span>; AL = interrupt number
<span style="color:maroon">SYSINIT:0714                                         </span>; DS:DX = new vector to be used for specified interrupt
<span style="color:maroon">SYSINIT:0716                 </span><span style="color:navy">cmp     </span>toomanydrivesflag<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:071B                 </span><span style="color:navy">jz      short </span>no_err
<span style="color:maroon">SYSINIT:071D                 </span><span style="color:navy">mov     dx, offset </span>TooManyDrivesMsg <span style="color:gray">; &quot;WARNING! Logical drives past Z: exist a&quot;...
</span><span style="color:maroon">SYSINIT:0720                 </span><span style="color:navy">call    </span>print
<span style="color:maroon">SYSINIT:0723
SYSINIT:0723 </span>no_err<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0723                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:0724                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:0724                 </span><span style="color:navy">mov     dl, cs:</span>DEFAULT_DRIVE
<span style="color:maroon">SYSINIT:0729                 </span><span style="color:navy">or      dl, dl
</span><span style="color:maroon">SYSINIT:072B                 </span><span style="color:navy">jz      short </span>nodrvset
<span style="color:maroon">SYSINIT:072D                 </span><span style="color:navy">dec     dl
</span><span style="color:maroon">SYSINIT:072F                 </span><span style="color:navy">mov     ah, </span><span style="color:green">0Eh
</span><span style="color:maroon">SYSINIT:0731                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - SELECT DISK
<span style="color:maroon">SYSINIT:0731                                         </span>; DL = new default drive number (0 = A, 1 = B, etc.)
<span style="color:maroon">SYSINIT:0731                                         </span>; Return: AL = number of logical drives
<span style="color:maroon">SYSINIT:0733
SYSINIT:0733 </span>nodrvset<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0733                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:0734                 </span><span style="color:navy">sub     ax, ax
</span><span style="color:maroon">SYSINIT:0736                 </span><span style="color:navy">mov     ds, ax          </span>; 0  ; ROMBIOS data area
<span style="color:maroon">SYSINIT:0738                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:0738                 </span><span style="color:navy">mov     ax, </span>word ptr ds:46Ch ; Counter for Interrupt 1Ah
<span style="color:maroon">SYSINIT:0738                                         </span>; timer tick count (18.2 ticks per second)
<span style="color:maroon">SYSINIT:073B                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:073C                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:073C                 </span><span style="color:navy">mov     cs:</span>_timer_lw_<span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:0740                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:0741                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:0742                 </span>assume es:SYSINIT
<span style="color:maroon">SYSINIT:0742                 </span><span style="color:navy">mov     word ptr cs:</span>MagicBackdoor<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cs
</span><span style="color:maroon">SYSINIT:0747                 </span><span style="color:navy">mov     word ptr cs:</span>MagicBackdoor<span style="color:navy">, offset </span>NullBackdoor
<span style="color:maroon">SYSINIT:074E
SYSINIT:074E </span>set_drvspc_size<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:074E                 </span><span style="color:navy">mov     si, offset </span>MagicDDName <span style="color:gray">; &quot;\\DBLSPACE.BIN&quot;
</span><span style="color:maroon">SYSINIT:0751
SYSINIT:0751 </span>set_dblspc_size<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0751                 </span><span style="color:navy">call    </span>SizeDevice
<span style="color:maroon">SYSINIT:0754                 </span><span style="color:navy">jnb     short </span>wait_for_key_2s
<span style="color:maroon">SYSINIT:0756                 </span><span style="color:navy">cmp     byte ptr cs:[si], &#039;</span><span style="color:green">C&#039;
</span><span style="color:maroon">SYSINIT:075A                 </span><span style="color:navy">jz      short </span>set_drvspc_name
<span style="color:maroon">SYSINIT:075C                 </span><span style="color:navy">cmp     cs:</span>DEFAULT_DRIVE<span style="color:navy">, </span><span style="color:#ff8000">3
</span><span style="color:maroon">SYSINIT:0762                 </span><span style="color:navy">jz      short </span>set_drvspc_name
<span style="color:maroon">SYSINIT:0764                 </span><span style="color:navy">sub     si, </span><span style="color:#ff8000">2
</span><span style="color:maroon">SYSINIT:0767                 </span><span style="color:navy">jmp     short </span>set_dblspc_size
<span style="color:maroon">SYSINIT:0769 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0769
SYSINIT:0769 </span>set_drvspc_name<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0769                 </span><span style="color:navy">cmp     byte ptr cs:</span>MagicDDName<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, &#039;</span><span style="color:green">R&#039; </span><span style="color:gray">; &quot;BLSPACE.BIN&quot;
</span><span style="color:maroon">SYSINIT:076F                 </span><span style="color:navy">jz      short </span>set_stacker_name
<span style="color:maroon">SYSINIT:0771                 </span><span style="color:navy">mov     word ptr cs:</span>MagicDDName<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, &#039;</span><span style="color:green">VR&#039; </span>; &#039;RV&#039; ; DRVSPACE.BIN
<span style="color:maroon">SYSINIT:0778                 </span><span style="color:navy">jmp     short </span>set_drvspc_size
<span style="color:maroon">SYSINIT:077A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:077A
SYSINIT:077A </span>set_stacker_name<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:077A                 </span><span style="color:navy">cmp     si, offset </span>StackerName <span style="color:gray">; &quot;C:\\STACKER.BIN&quot;
</span><span style="color:maroon">SYSINIT:077E                 </span><span style="color:navy">jnb     short </span>wfk2s_4
<span style="color:maroon">SYSINIT:0780                 </span><span style="color:navy">mov     si, (offset </span>StackerName<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">) </span><span style="color:gray">; &quot;\\STACKER.BIN&quot;
</span><span style="color:maroon">SYSINIT:0783                 </span><span style="color:navy">jmp     short </span>set_dblspc_size
<span style="color:maroon">SYSINIT:0785 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0785
SYSINIT:0785 </span>wait_for_key_2s<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0785                 </span><span style="color:navy">mov     cs:</span>MagicDDNamePtr<span style="color:navy">, si
</span><span style="color:maroon">SYSINIT:078A                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:078B                 </span><span style="color:navy">sub     ax, ax
</span><span style="color:maroon">SYSINIT:078D                 </span><span style="color:navy">mov     ds, ax          </span>; 0 ; ROMBIOS data area
<span style="color:maroon">SYSINIT:078F                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:078F                 </span><span style="color:navy">mov     dx, </span>word ptr ds:46Ch ; Counter for Interrupt 1Ah
<span style="color:maroon">SYSINIT:0793
SYSINIT:0793 </span>wfk2s_1<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0793                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:0795                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - CHECK BUFFER, DO NOT CLEAR
<span style="color:maroon">SYSINIT:0795                                         </span>; Return: ZF clear if character in buffer
<span style="color:maroon">SYSINIT:0795                                         </span>; AH = scan code, AL = character
<span style="color:maroon">SYSINIT:0795                                         </span>; ZF set if no character in buffer
<span style="color:maroon">SYSINIT:0797                 </span><span style="color:navy">jnz     short </span>wfk2s_2
<span style="color:maroon">SYSINIT:0799                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:maroon">SYSINIT:079B                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - GET SHIFT STATUS
<span style="color:maroon">SYSINIT:079B                                         </span>; AL = shift status bits
<span style="color:maroon">SYSINIT:079D                 </span><span style="color:navy">test    al, </span><span style="color:green">3
</span><span style="color:maroon">SYSINIT:079F                 </span><span style="color:navy">jnz     short </span>wfk2s_2
<span style="color:maroon">SYSINIT:07A1                 </span><span style="color:navy">mov     ax, </span>word ptr ds:46Ch ; tick count
<span style="color:maroon">SYSINIT:07A4                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">SYSINIT:07A6                 </span><span style="color:navy">cmp     al, </span><span style="color:green">37          </span>; 2 seconds
<span style="color:maroon">SYSINIT:07A8                 </span><span style="color:navy">jb      short </span>wfk2s_1   ; wait for user&#039;s key press
<span style="color:maroon">SYSINIT:07AA
SYSINIT:07AA </span>wfk2s_2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:07AA                 </span><span style="color:navy">pop     ds              </span>; read/check the pressed key
<span style="color:maroon">SYSINIT:07AB                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:07AB                 </span><span style="color:navy">sub     bx, bx          </span>; bx = 0
<span style="color:maroon">SYSINIT:07AD                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:maroon">SYSINIT:07AF                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - GET SHIFT STATUS
<span style="color:maroon">SYSINIT:07AF                                         </span>; AL = shift status bits
<span style="color:maroon">SYSINIT:07B1                 </span><span style="color:navy">test    al, </span><span style="color:green">3           </span>; Left or Right SHIFT key pressed ?
<span style="color:maroon">SYSINIT:07B3                 </span><span style="color:navy">jz      short </span>wfk2s_3   ; no
<span style="color:maroon">SYSINIT:07B5                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">SYSINIT:07B6                 </span><span style="color:navy">inc     bx              </span>; bx = 2
<span style="color:maroon">SYSINIT:07B7
SYSINIT:07B7 </span>wfk2s_3<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:07B7                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:07B9                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - CHECK BUFFER, DO NOT CLEAR
<span style="color:maroon">SYSINIT:07B9                                         </span>; Return: ZF clear if character in buffer
<span style="color:maroon">SYSINIT:07B9                                         </span>; AH = scan code, AL = character
<span style="color:maroon">SYSINIT:07B9                                         </span>; ZF set if no character in buffer
<span style="color:maroon">SYSINIT:07BB                 </span><span style="color:navy">jz      short </span>wfk2s_6
<span style="color:maroon">SYSINIT:07BD                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">65h         </span>; F8 key pressed ?
<span style="color:maroon">SYSINIT:07C0                 </span><span style="color:navy">jz      short </span>wfk2s_5
<span style="color:maroon">SYSINIT:07C2                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">62h         </span>; F5 key pressed ?
<span style="color:maroon">SYSINIT:07C5                 </span><span style="color:navy">jnz     short </span>wfk2s_6
<span style="color:maroon">SYSINIT:07C7                 </span><span style="color:navy">mov     cs:</span>F5_key<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:07CD
SYSINIT:07CD </span>wfk2s_4<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:07CD                 </span><span style="color:navy">jmp     short </span>ProcessConfig ; continue (as normal/default state)
<span style="color:maroon">SYSINIT:07CF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:07CF
SYSINIT:07CF </span>wfk2s_5<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:07CF                 </span><span style="color:navy">mov     cs:</span>F8_key<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:07D5                 </span><span style="color:navy">jmp     short </span>ProcessConfig
<span style="color:maroon">SYSINIT:07D7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:07D7
SYSINIT:07D7 </span>wfk2s_6<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:07D7                 </span><span style="color:navy">call    </span>AllocFreeMem    ; get the largest free block from DOS
<span style="color:maroon">SYSINIT:07DA                 </span><span style="color:navy">call    </span>MagicPreload    ; **** PRE-LOAD MAGICDRV!!! ****
<span style="color:maroon">SYSINIT:07DD
SYSINIT:07DD </span>wfk2s_7<span style="color:navy">:                                </span>; error?
<span style="color:maroon">SYSINIT:07DD                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">SYSINIT:07DF                 </span><span style="color:navy">jz      short </span>wfk2s_8
<span style="color:maroon">SYSINIT:07E1
SYSINIT:07E1 </span>PreloadFailed<span style="color:navy">:                          </span>; Dealloc ; free the block if no load
<span style="color:maroon">SYSINIT:07E1                 </span><span style="color:navy">mov     ah, </span><span style="color:green">49h
</span><span style="color:maroon">SYSINIT:07E3                 </span><span style="color:navy">mov     es, cs:</span>area
<span style="color:maroon">SYSINIT:07E8                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:07E8                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - FREE MEMORY
<span style="color:maroon">SYSINIT:07E8                                         </span>; ES = segment address of area to be freed
<span style="color:maroon">SYSINIT:07EA                 </span><span style="color:navy">jmp     short </span>ProcessConfig
<span style="color:maroon">SYSINIT:07EC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:07EC
SYSINIT:07EC </span>wfk2s_8<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:07EC                 </span><span style="color:navy">mov     bx, cs:</span>memhi
<span style="color:maroon">SYSINIT:07F1                 </span><span style="color:navy">mov     es, cs:</span>area
<span style="color:maroon">SYSINIT:07F6                 </span><span style="color:navy">sub     bx, cs:</span>area     ; get desired block size in paras
<span style="color:maroon">SYSINIT:07FB                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4Ah
</span><span style="color:maroon">SYSINIT:07FD                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
<span style="color:maroon">SYSINIT:07FD                                         </span>; ES = segment address of block to change
<span style="color:maroon">SYSINIT:07FD                                         </span>; BX = new size in paragraphs
<span style="color:maroon">SYSINIT:07FF                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">SYSINIT:0801                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">SYSINIT:0802                 </span><span style="color:navy">mov     es, ax          </span>; get Magicdrv arena
<span style="color:maroon">SYSINIT:0804                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0804                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:arena_owner], 8 ; set impossible owner
<span style="color:maroon">SYSINIT:080B                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4453h </span>; [es:arena_name],&#039;SD&#039; ; System Data
<span style="color:maroon">SYSINIT:0812                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; get MCB length
<span style="color:maroon">SYSINIT:0817                 </span><span style="color:navy">lds     si, cs:</span>DOSINFO  ; get to arena header
<span style="color:maroon">SYSINIT:081C                 </span><span style="color:navy">inc     ax              </span>; get addr of next MCB
<span style="color:maroon">SYSINIT:081D                 </span><span style="color:navy">mov     [si-</span><span style="color:green">2</span><span style="color:navy">], ax      </span>; store that
<span style="color:maroon">SYSINIT:0820
SYSINIT:0820 </span>ProcessConfig<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0820                 </span><span style="color:navy">call    </span>doconf
<span style="color:maroon">SYSINIT:0823                 </span><span style="color:navy">cmp     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; Did user choose to run low ?
<span style="color:maroon">SYSINIT:0829                 </span><span style="color:navy">jz      short </span>dont_install_stub ; yes, don&#039;t install dos low mem stub
<span style="color:maroon">SYSINIT:082B                 </span><span style="color:navy">mov     es, cs:</span>CURRENTDOSLOCATION
<span style="color:maroon">SYSINIT:0830                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0830                 </span><span style="color:navy">xor     ax, ax          </span>; ax = 0 --&gt; install stub
<span style="color:maroon">SYSINIT:0832                 </span><span style="color:navy">call    cs:</span>dos_segreinit ; call far [dos_segreinit]
<span style="color:maroon">SYSINIT:0837                 </span><span style="color:navy">jmp     short </span>do_multi_pass
<span style="color:maroon">SYSINIT:0839 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0839
SYSINIT:0839 </span>dont_install_stub<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0839                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">SYSINIT:083B                 </span><span style="color:navy">call    </span>MovDOSLo
<span style="color:maroon">SYSINIT:083E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:0841                 </span><span style="color:navy">mov     es, cs:</span>CURRENTDOSLOCATION
<span style="color:maroon">SYSINIT:0846                 </span><span style="color:navy">call    cs:</span>dos_segreinit ; call far [cs:dos_segreinit]
<span style="color:maroon">SYSINIT:0846                                         </span>; inform dos about new seg
<span style="color:maroon">SYSINIT:084B
SYSINIT:084B </span>do_multi_pass<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:084B                 </span><span style="color:navy">call    </span>AllocFreeMem    ; allocate all the free mem &amp; update [memhi]
<span style="color:maroon">SYSINIT:084B                                         </span>; &amp; [area] start of free memory.
<span style="color:maroon">SYSINIT:084E                 </span><span style="color:navy">cmp     cs:</span>F5_key<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:0854                 </span><span style="color:navy">jz      short </span>skip_magicbackdoor
<span style="color:maroon">SYSINIT:0856                 </span><span style="color:navy">cmp     cs:</span>F8_key<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:085C                 </span><span style="color:navy">jz      short </span>skip_magicbackdoor
<span style="color:maroon">SYSINIT:085E                 </span><span style="color:navy">xor     bx, bx          </span>; bx=0 ; magic backdoor to place int hooks
<span style="color:maroon">SYSINIT:0860                 </span><span style="color:navy">call    cs:</span>MagicBackdoor
<span style="color:maroon">SYSINIT:0865
SYSINIT:0865 </span>skip_magicbackdoor<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0865                 </span><span style="color:navy">inc     cs:</span>multi_pass_id ; multi_pass_id = 1
<span style="color:maroon">SYSINIT:086A                 </span><span style="color:navy">call    </span>multi_pass      ; load device drivers
<span style="color:maroon">SYSINIT:086D                 </span><span style="color:navy">call    </span>ShrinkUMB
<span style="color:maroon">SYSINIT:0870                 </span><span style="color:navy">call    </span>UnlinkUMB       ; unlink all UMBs
<span style="color:maroon">SYSINIT:0873                 </span><span style="color:navy">inc     cs:</span>multi_pass_id ; multi_pass_id = 2
<span style="color:maroon">SYSINIT:0878                 </span><span style="color:navy">call    </span>multi_pass
<span style="color:maroon">SYSINIT:087B                 </span><span style="color:navy">cmp     cs:</span>F5_key<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:0881                 </span><span style="color:navy">jz      short </span>skip_magicpostload
<span style="color:maroon">SYSINIT:0883                 </span><span style="color:navy">cmp     cs:</span>F8_key<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:0889                 </span><span style="color:navy">jz      short </span>skip_magicpostload
<span style="color:maroon">SYSINIT:088B                 </span><span style="color:navy">call    </span>MagicPostload   ; make sure Magicdrv is final placed
<span style="color:maroon">SYSINIT:088E                 </span><span style="color:navy">call    </span>endfile         ; setup fcbs, files, buffers etc
<span style="color:maroon">SYSINIT:0891                 </span><span style="color:navy">call    </span>MagicSetCdss    ; disable CDSs of reserved drives
<span style="color:maroon">SYSINIT:0894                 </span><span style="color:navy">jmp     short </span>_@_
<span style="color:maroon">SYSINIT:0896 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0896
SYSINIT:0896 </span>skip_magicpostload<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0896                 </span><span style="color:navy">call    </span>endfile
<span style="color:maroon">SYSINIT:0899
SYSINIT:0899 </span>_@_<span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0899                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG
<span style="color:maroon">SYSINIT:089C                 </span><span style="color:navy">mov     es, ax          </span>; BIOSDATA segment
<span style="color:maroon">SYSINIT:089E                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:089E                 </span><span style="color:navy">mov     es:</span>SysinitPresent<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; clear SysinitPresent flag
<span style="color:maroon">SYSINIT:08A4                 </span><span style="color:navy">test    cs:</span>install_flag<span style="color:navy">, </span><span style="color:green">1 </span>; have_install_cmd
<span style="color:maroon">SYSINIT:08A4                                         </span>; are there install commands?
<span style="color:maroon">SYSINIT:08AB                 </span><span style="color:navy">jz      short </span>dolast
<span style="color:maroon">SYSINIT:08AD                 </span><span style="color:navy">inc     cs:</span>multi_pass_id
<span style="color:maroon">SYSINIT:08B2                 </span><span style="color:navy">call    </span>multi_pass
<span style="color:maroon">SYSINIT:08B5
SYSINIT:08B5 </span>dolast<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:08B5                 </span><span style="color:navy">cmp     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; are we still waiting to be moved?
<span style="color:maroon">SYSINIT:08BB                 </span><span style="color:navy">jnz     short </span>_@@_      ; no, our job is over
<span style="color:maroon">SYSINIT:08BD                 </span><span style="color:navy">call    </span>LoadDOSHiOrLo
<span style="color:maroon">SYSINIT:08C0
SYSINIT:08C0 </span>_@@_<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:08C0                 </span><span style="color:navy">cmp     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; are we running low
<span style="color:maroon">SYSINIT:08C6                 </span><span style="color:navy">jz      short </span>ConfigDone ; yes, no CPM hack needed
<span style="color:maroon">SYSINIT:08C8                 </span><span style="color:navy">call    </span>CPMHack         ; make ffff:d0 same as 0:c0
<span style="color:maroon">SYSINIT:08CB
SYSINIT:08CB </span>ConfigDone<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:08CB                 </span><span style="color:navy">mov     cs:</span>donotshownum<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:08D1                 </span><span style="color:navy">mov     es, cs:</span>area
<span style="color:maroon">SYSINIT:08D6                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:08D6                 </span><span style="color:navy">mov     ah, </span><span style="color:green">49h         </span>; DEALLOC ; free allocated memory for command.com
<span style="color:maroon">SYSINIT:08D8                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - FREE MEMORY
<span style="color:maroon">SYSINIT:08D8                                         </span>; ES = segment address of area to be freed
<span style="color:maroon">SYSINIT:08DA                 </span><span style="color:navy">test    cs:</span>install_flag<span style="color:navy">, </span><span style="color:green">2 </span>; has_installed
<span style="color:maroon">SYSINIT:08E1                 </span><span style="color:navy">jz      short </span>skip_free_sysinitbase ; no
<span style="color:maroon">SYSINIT:08E3                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:08E4                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">SYSINIT:08E5                 </span><span style="color:navy">mov     es, cs:</span>old_area
<span style="color:maroon">SYSINIT:08EA                 </span><span style="color:navy">mov     bx, cs:</span>impossible_owner_size
<span style="color:maroon">SYSINIT:08EF                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4Ah
</span><span style="color:maroon">SYSINIT:08F1                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
<span style="color:maroon">SYSINIT:08F1                                         </span>; ES = segment address of block to change
<span style="color:maroon">SYSINIT:08F1                                         </span>; BX = new size in paragraphs
<span style="color:maroon">SYSINIT:08F3                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">SYSINIT:08F5                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">SYSINIT:08F6                 </span><span style="color:navy">mov     es, ax          </span>; point to arena
<span style="color:maroon">SYSINIT:08F8                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:08F8                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER],8 ; set impossible owner
<span style="color:maroon">SYSINIT:08FF                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4453h </span>; [es:ARENA.NAME],&#039;SD&#039; ; System Data
<span style="color:maroon">SYSINIT:0906                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">SYSINIT:0907                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:0908                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0908
SYSINIT:0908 </span>skip_free_sysinitbase<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0908                 </span><span style="color:navy">cmp     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:090E                 </span><span style="color:navy">jz      short </span>_@@@_
<span style="color:maroon">SYSINIT:0910                 </span><span style="color:navy">call    </span>InstVDiskHeader ; Install VDISK header (allocates some mem from DOS)
<span style="color:maroon">SYSINIT:0913
SYSINIT:0913 </span>_@@@_<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0913                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:0914                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:0915                 </span>assume ds:SYSINIT
<span style="color:maroon">SYSINIT:0915                 </span><span style="color:navy">mov     </span>config_cmd<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; set special code for query_user
<span style="color:maroon">SYSINIT:091A                 </span><span style="color:navy">call    </span>query_user      ; to issue the AUTOEXEC prompt
<span style="color:maroon">SYSINIT:091D                 </span><span style="color:navy">pushf
</span><span style="color:maroon">SYSINIT:091E                 </span><span style="color:navy">test    </span>bDisableUI<span style="color:navy">, </span><span style="color:green">1   </span>; Note: This flag is useless because it is not set before
<span style="color:maroon">SYSINIT:091E                                         </span>; E.TAN 04/07/2023
<span style="color:maroon">SYSINIT:0923                 </span><span style="color:navy">jnz     short </span>_@@@@_    ; F5 clean/interactive boot option (has been) disabled
<span style="color:maroon">SYSINIT:0925                 </span><span style="color:navy">cmp     </span>F5_key<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:092A                 </span><span style="color:navy">jz      short </span>_@@@@@_   ; F5 key pressed, bypass AUTOEXEC.BAT (clean boot)
<span style="color:maroon">SYSINIT:092C
SYSINIT:092C </span>_@@@@_<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:092C                 </span><span style="color:navy">popf
</span><span style="color:maroon">SYSINIT:092D                 </span><span style="color:navy">jnb     short </span>process_autoexec ; we should process autoexec normally
<span style="color:maroon">SYSINIT:092F                 </span><span style="color:navy">jmp     short </span>bypass_autoexec
<span style="color:maroon">SYSINIT:0931 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0931
SYSINIT:0931 </span>_@@@@@_<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0931                 </span><span style="color:navy">popf                    </span>; cf status at the return from &#039;query_user&#039; call
<span style="color:maroon">SYSINIT:0932
SYSINIT:0932 </span>bypass_autoexec<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0932                 </span><span style="color:navy">or      </span>bQueryOpt<span style="color:navy">, </span><span style="color:green">4    </span>; set &quot;skip all&quot; flag
<span style="color:maroon">SYSINIT:0937                 </span><span style="color:navy">call    </span>disable_autoexec ; no, we should disable it
<span style="color:maroon">SYSINIT:093A
SYSINIT:093A </span>process_autoexec<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:093A                 </span><span style="color:navy">call    </span>CheckQueryOpt
<span style="color:maroon">SYSINIT:093D                 </span><span style="color:navy">mov     cl, byte ptr </span>command_line <span style="color:gray">; &quot;\x02/P&quot;
</span><span style="color:maroon">SYSINIT:0941                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:0943                 </span><span style="color:navy">inc     cx
</span><span style="color:maroon">SYSINIT:0944                 </span><span style="color:navy">mov     si, offset </span>command_line <span style="color:gray">; &quot;\x02/P&quot;
</span><span style="color:maroon">SYSINIT:0947                 </span><span style="color:navy">add     si, cx          </span>; retry-4
<span style="color:maroon">SYSINIT:0949                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">0Dh </span>; cr-terminate command line
<span style="color:maroon">SYSINIT:094C
SYSINIT:094C </span>retry<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:094C                 </span><span style="color:navy">mov     dx, offset </span>commnd <span style="color:gray">; &quot;\\COMMAND.COM&quot;
</span><span style="color:maroon">SYSINIT:094F                 </span><span style="color:navy">push    dx              </span>; save pointer to file name
<span style="color:maroon">SYSINIT:0950                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh      </span>; get biggest piece (second time gets it)
<span style="color:maroon">SYSINIT:0953                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:maroon">SYSINIT:0955                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:maroon">SYSINIT:0955                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:maroon">SYSINIT:0957                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:maroon">SYSINIT:0959                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:maroon">SYSINIT:0959                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:maroon">SYSINIT:095B                 </span><span style="color:navy">jb      short </span>memerrjx  ; oooops!
<span style="color:maroon">SYSINIT:095D                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">SYSINIT:095F                 </span><span style="color:navy">mov     ah, </span><span style="color:green">49h
</span><span style="color:maroon">SYSINIT:0961                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - FREE MEMORY
<span style="color:maroon">SYSINIT:0961                                         </span>; ES = segment address of area to be freed
<span style="color:maroon">SYSINIT:0963                 </span><span style="color:navy">mov     bp, bx
</span><span style="color:maroon">SYSINIT:0965                 </span><span style="color:navy">mov     bx, </span>MEMORY_SIZE ; get location of end of memory
<span style="color:maroon">SYSINIT:0969                 </span><span style="color:navy">mov     ax, cs          </span>; get location of beginning of sysinit
<span style="color:maroon">SYSINIT:096B                 </span><span style="color:navy">mov     cx, </span>config_envlen
<span style="color:maroon">SYSINIT:096F                 </span><span style="color:navy">jcxz    short </span>no_env    ; use config_wrkseg only if there&#039;s env data
<span style="color:maroon">SYSINIT:0971                 </span><span style="color:navy">mov     ax, </span>config_wrkseg
<span style="color:maroon">SYSINIT:0974
SYSINIT:0974 </span>no_env<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0974                 </span><span style="color:navy">sub     bx, ax
</span><span style="color:maroon">SYSINIT:0976                 </span><span style="color:navy">add     bx, </span><span style="color:green">11h         </span>; add the sysinit php
<span style="color:maroon">SYSINIT:0979                 </span><span style="color:navy">sub     bp, bx          </span>; sub sysinit size from amount of free memory
<span style="color:maroon">SYSINIT:097B                 </span><span style="color:navy">jb      short </span>memerrjx  ; if there isn&#039;t even this much memory, give up
<span style="color:maroon">SYSINIT:097D                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3D00h
</span><span style="color:maroon">SYSINIT:0980                 </span><span style="color:navy">stc
</span><span style="color:maroon">SYSINIT:0981                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - OPEN DISK FILE WITH HANDLE
<span style="color:maroon">SYSINIT:0981                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:maroon">SYSINIT:0981                                         </span>; AL = access mode
<span style="color:maroon">SYSINIT:0981                                         </span>; 0 - read
<span style="color:maroon">SYSINIT:0983                 </span><span style="color:navy">jb      short </span>comerr
<span style="color:maroon">SYSINIT:0985                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">SYSINIT:0987                 </span><span style="color:navy">cmp     </span>newcmd<span style="color:navy">, </span><span style="color:#ff8000">0       </span>; was a new shell selected?
<span style="color:maroon">SYSINIT:098C                 </span><span style="color:navy">jnz     short </span>skip_validation ; yes
<span style="color:maroon">SYSINIT:098E                 </span><span style="color:navy">mov     dx, </span>offset retry-4 ; SYSINIT:0948h
<span style="color:maroon">SYSINIT:0991                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:maroon">SYSINIT:0994                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Fh
</span><span style="color:maroon">SYSINIT:0996                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - READ FROM FILE WITH HANDLE
<span style="color:maroon">SYSINIT:0996                                         </span>; BX = file handle, CX = number of bytes to read
<span style="color:maroon">SYSINIT:0996                                         </span>; DS:DX -&gt; buffer
<span style="color:maroon">SYSINIT:0998                 </span><span style="color:navy">cmp     </span>byte ptr retry-4<span style="color:navy">, </span><span style="color:green">0E9h
</span><span style="color:maroon">SYSINIT:099D                 </span><span style="color:navy">jnz     short </span>comerr
<span style="color:maroon">SYSINIT:099F                 </span><span style="color:navy">cmp     </span>byte ptr retry-1<span style="color:navy">, </span><span style="color:green">7Ah </span>; COMMAND.COM Version 7.10
<span style="color:maroon">SYSINIT:099F                                         </span>; ((MAJOR_VERSION&amp;0Fh)&lt;&lt;4)|(MINOR_VERSION&amp;0Fh)
<span style="color:maroon">SYSINIT:09A4                 </span><span style="color:navy">jnz     short </span>comerr
<span style="color:maroon">SYSINIT:09A6
SYSINIT:09A6 </span>skip_validation<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:09A6                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">SYSINIT:09A8                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">SYSINIT:09AA                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4202h
</span><span style="color:maroon">SYSINIT:09AD                 </span><span style="color:navy">stc
</span><span style="color:maroon">SYSINIT:09AE                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
<span style="color:maroon">SYSINIT:09AE                                         </span>; AL = method: offset from end of file
<span style="color:maroon">SYSINIT:09B0                 </span><span style="color:navy">jb      short </span>comerr
<span style="color:maroon">SYSINIT:09B2                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">0Fh         </span>; convert size in dx:ax to para in ax
<span style="color:maroon">SYSINIT:09B5                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0           </span>; round up size for conversion to para
<span style="color:maroon">SYSINIT:09B8                 </span><span style="color:navy">call    </span>_off_to_para
<span style="color:maroon">SYSINIT:09BB                 </span><span style="color:navy">mov     cl, </span><span style="color:green">12
</span><span style="color:maroon">SYSINIT:09BD                 </span><span style="color:navy">shl     dx, cl          </span>; low nibble of dx to high nibble
<span style="color:maroon">SYSINIT:09BF                 </span><span style="color:navy">or      ax, dx          </span>; ax is now # of para for file
<span style="color:maroon">SYSINIT:09C1                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">10h         </span>; 100h byte php
<span style="color:maroon">SYSINIT:09C4                 </span><span style="color:navy">cmp     ax, bp          </span>; will command fit in available mem?
<span style="color:maroon">SYSINIT:09C6                 </span><span style="color:navy">jb      short </span>okld      ; jump if yes.
<span style="color:maroon">SYSINIT:09C8
SYSINIT:09C8 </span>memerrjx<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:09C8                 </span><span style="color:navy">mov     dx, offset </span>badmem <span style="color:gray">; &quot;\r\nConfiguration too large for memory&quot;...
</span><span style="color:maroon">SYSINIT:09CB                 </span><span style="color:navy">call    </span>print
<span style="color:maroon">SYSINIT:09CE                 </span><span style="color:navy">jmp     short </span>continue
<span style="color:maroon">SYSINIT:09D0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:09D0
SYSINIT:09D0 </span>okld<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:09D0                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:maroon">SYSINIT:09D2                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:maroon">SYSINIT:09D2                                         </span>; BX = file handle
<span style="color:maroon">SYSINIT:09D4                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:09D5                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:09D6                 </span>assume es:SYSINIT
<span style="color:maroon">SYSINIT:09D6                 </span><span style="color:navy">mov     bx, offset </span>EXEC0_ENVIRON ; offset COMEXE
<span style="color:maroon">SYSINIT:09D6                                         </span>; point to exec block
<span style="color:maroon">SYSINIT:09D9                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">SYSINIT:09DA                 </span><span style="color:navy">mov     cx, </span>config_envlen
<span style="color:maroon">SYSINIT:09DE                 </span><span style="color:navy">jcxz    short </span>no_envdata
<span style="color:maroon">SYSINIT:09E0                 </span><span style="color:navy">mov     cx, </span>config_wrkseg
<span style="color:maroon">SYSINIT:09E4
SYSINIT:09E4 </span>no_envdata<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:09E4                 </span><span style="color:navy">mov     [bx], cx        </span>; set segments
<span style="color:maroon">SYSINIT:09E4                                         </span>; [bx+EXEC0.ENVIRON],cx
<span style="color:maroon">SYSINIT:09E6                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">], cs </span>; [bx+EXEC0.COM_LINE+2],cs
<span style="color:maroon">SYSINIT:09E9                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">8</span><span style="color:navy">], cs </span>; [bx+EXEC0.5C_FCB+2],cs
<span style="color:maroon">SYSINIT:09EC                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], cs </span>; [bx+EXEC0.6C_FCB+2],cs
<span style="color:maroon">SYSINIT:09EF                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4B00h       </span>; (EXEC&lt;&lt;8)
<span style="color:maroon">SYSINIT:09F2                 </span><span style="color:navy">stc
</span><span style="color:maroon">SYSINIT:09F3                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - LOAD OR EXECUTE (EXEC)
<span style="color:maroon">SYSINIT:09F3                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:maroon">SYSINIT:09F3                                         </span>; ES:BX -&gt; parameter block
<span style="color:maroon">SYSINIT:09F3                                         </span>; AL = subfunc: load &amp; execute program
<span style="color:maroon">SYSINIT:09F5                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:09F6                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:09F7                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">SYSINIT:09F8
SYSINIT:09F8 </span>comerr<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:09F8                 </span><span style="color:navy">cmp     byte ptr </span>commnd4<span style="color:navy">, </span><span style="color:#ff8000">0 </span><span style="color:gray">; &quot;\\DOS\\COMMAND.COM&quot;
</span><span style="color:maroon">SYSINIT:09FD                 </span><span style="color:navy">jz      short </span>comerr2   ; all defaults exhausted, print err msg
<span style="color:maroon">SYSINIT:09FF                 </span><span style="color:navy">cmp     </span>newcmd<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:0A04                 </span><span style="color:navy">jz      short </span>continue  ; don&#039;t print err msg for defaults just yet
<span style="color:maroon">SYSINIT:0A06
SYSINIT:0A06 </span>comerr2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A06                 </span><span style="color:navy">mov     dx, offset </span>badcom <span style="color:gray">; &quot;Command Interpreter&quot;
</span><span style="color:maroon">SYSINIT:0A09                 </span><span style="color:navy">call    </span>badfil
<span style="color:maroon">SYSINIT:0A0C
SYSINIT:0A0C </span>continue<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A0C                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">SYSINIT:0A0D                 </span><span style="color:navy">mov     ah, </span><span style="color:green">19h
</span><span style="color:maroon">SYSINIT:0A0F                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - GET DEFAULT DISK NUMBER
<span style="color:maroon">SYSINIT:0A11                 </span><span style="color:navy">add     al, &#039;</span><span style="color:green">A&#039;
</span><span style="color:maroon">SYSINIT:0A13                 </span><span style="color:navy">mov     dl, al          </span>; dl == default drive letter
<span style="color:maroon">SYSINIT:0A15                 </span><span style="color:navy">mov     si, offset </span>commnd2 <span style="color:gray">; &quot;\\COMMAND.COM&quot;
</span><span style="color:maroon">SYSINIT:0A18                 </span><span style="color:navy">cmp     </span>newcmd<span style="color:navy">, </span><span style="color:#ff8000">0       </span>; if a SHELL= was given
<span style="color:maroon">SYSINIT:0A1D                 </span><span style="color:navy">jnz     short </span>do_def2   ; then try the 2nd alternate;
<span style="color:maroon">SYSINIT:0A1F                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">0 </span>; otherwise, the default SHELL= was tried,
<span style="color:maroon">SYSINIT:0A22                 </span><span style="color:navy">jmp     short </span>do_def3   ; which is the same as our 2nd alt, so skip it
<span style="color:maroon">SYSINIT:0A24 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0A24
SYSINIT:0A24 </span>do_def2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A24                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0 </span>; has 2nd alternate been tried?
<span style="color:maroon">SYSINIT:0A27                 </span><span style="color:navy">jnz     short </span>do_alt    ; no
<span style="color:maroon">SYSINIT:0A29
SYSINIT:0A29 </span>do_def3<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A29                 </span><span style="color:navy">mov     si, offset </span>commnd3 <span style="color:gray">; &quot;\\MSDOS\\COMMAND.COM&quot;
</span><span style="color:maroon">SYSINIT:0A2C                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0 </span>; has 3rd alternate been tried?
<span style="color:maroon">SYSINIT:0A2F                 </span><span style="color:navy">jnz     short </span>do_alt    ; no
<span style="color:maroon">SYSINIT:0A31                 </span><span style="color:navy">mov     si, offset </span>commnd4 <span style="color:gray">; &quot;\\DOS\\COMMAND.COM&quot;
</span><span style="color:maroon">SYSINIT:0A34                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0 </span>; has 4th alternate been tried?
<span style="color:maroon">SYSINIT:0A37                 </span><span style="color:navy">jnz     short </span>do_alt    ; no
<span style="color:maroon">SYSINIT:0A39                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">SYSINIT:0A3A                 </span><span style="color:navy">mov     dx, offset </span>badcomprmpt <span style="color:gray">; &quot;Enter correct name of Command Interpret&quot;...
</span><span style="color:maroon">SYSINIT:0A3D                 </span><span style="color:navy">call    </span>print
<span style="color:maroon">SYSINIT:0A40                 </span><span style="color:navy">pop     dx              </span>; recover default drive letter in dl
<span style="color:maroon">SYSINIT:0A41
SYSINIT:0A41 </span>request_input<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A41                 </span><span style="color:navy">mov     ah, </span><span style="color:green">2           </span>; STD_CON_OUTPUT
<span style="color:maroon">SYSINIT:0A43                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:maroon">SYSINIT:0A43                                         </span>; DL = character to send to standard output
<span style="color:maroon">SYSINIT:0A45                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">SYSINIT:0A46                 </span><span style="color:navy">mov     dl, &#039;&gt;&#039;         </span>; 3Eh
<span style="color:maroon">SYSINIT:0A48                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS -
<span style="color:maroon">SYSINIT:0A4A                 </span><span style="color:navy">mov     bl, </span>tmplate<span style="color:navy">+</span><span style="color:green">1   </span>; [tmplate] = max. chars buffer can hold = 64
<span style="color:maroon">SYSINIT:0A4E                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:0A50                 </span><span style="color:navy">mov     byte ptr </span>commnd<span style="color:navy">[bx], </span><span style="color:#ff8000">0Dh </span><span style="color:gray">; &quot;\\COMMAND.COM&quot;
</span><span style="color:maroon">SYSINIT:0A55                 </span><span style="color:navy">mov     dx, offset </span>tmplate
<span style="color:maroon">SYSINIT:0A58                 </span><span style="color:navy">mov     ah, </span><span style="color:green">0Ah         </span>; STD_CON_STRING_INPUT
<span style="color:maroon">SYSINIT:0A5A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - BUFFERED KEYBOARD INPUT
<span style="color:maroon">SYSINIT:0A5A                                         </span>; DS:DX -&gt; buffer
<span style="color:maroon">SYSINIT:0A5C                 </span><span style="color:navy">mov     dx, offset </span>crlfm <span style="color:gray">; &quot;\r\n$&quot;
</span><span style="color:maroon">SYSINIT:0A5F                 </span><span style="color:navy">call    </span>print
<span style="color:maroon">SYSINIT:0A62                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">SYSINIT:0A63                 </span><span style="color:navy">mov     bl, </span>tmplate<span style="color:navy">+</span><span style="color:green">1
</span><span style="color:maroon">SYSINIT:0A67                 </span><span style="color:navy">or      bl, bl          </span>; was anything typed?
<span style="color:maroon">SYSINIT:0A69                 </span><span style="color:navy">jz      short </span>request_input
<span style="color:maroon">SYSINIT:0A6B                 </span><span style="color:navy">mov     </span>newcmd<span style="color:navy">, </span><span style="color:#ff8000">1       </span>; disable validation for user-specified binaries
<span style="color:maroon">SYSINIT:0A70                 </span><span style="color:navy">mov     byte ptr </span>commnd<span style="color:navy">[bx], </span><span style="color:#ff8000">0 </span>; NULL-terminate it before execing it
<span style="color:maroon">SYSINIT:0A75                 </span><span style="color:navy">mov     word ptr </span>command_line<span style="color:navy">, </span><span style="color:#ff8000">0D00h </span><span style="color:gray">; &quot;\x02/P&quot;
</span><span style="color:maroon">SYSINIT:0A7B                 </span><span style="color:navy">jmp     short </span>do_exec
<span style="color:maroon">SYSINIT:0A7D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0A7D
SYSINIT:0A7D </span>do_alt<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A7D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:0A7E                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:0A7F                 </span><span style="color:navy">mov     </span>newcmd<span style="color:navy">, </span><span style="color:#ff8000">0       </span>; force validation for alternate binaries
<span style="color:maroon">SYSINIT:0A84                 </span><span style="color:navy">mov     di, offset </span>commnd <span style="color:gray">; &quot;\\COMMAND.COM&quot;
</span><span style="color:maroon">SYSINIT:0A87
SYSINIT:0A87 </span>do_alt1<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A87                 </span><span style="color:navy">lodsb                   </span>; copy the alternate, zapping it as we go
<span style="color:maroon">SYSINIT:0A88                 </span><span style="color:navy">mov     byte ptr [si-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; so that we know it&#039;s been tried
<span style="color:maroon">SYSINIT:0A8C                 </span><span style="color:navy">stosb
</span><span style="color:maroon">SYSINIT:0A8D                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">SYSINIT:0A8F                 </span><span style="color:navy">jnz     short </span>do_alt1
<span style="color:maroon">SYSINIT:0A91                 </span><span style="color:navy">mov     di, offset </span>command_line <span style="color:gray">; &quot;\x02/P&quot;
</span><span style="color:maroon">SYSINIT:0A94                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], &#039;</span><span style="color:green">:&#039;
</span><span style="color:maroon">SYSINIT:0A98                 </span><span style="color:navy">jnz     short </span>do_alt2
<span style="color:maroon">SYSINIT:0A9A                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1</span><span style="color:navy">], dl      </span>; stuff default drive into alt. command line
<span style="color:maroon">SYSINIT:0A9D
SYSINIT:0A9D </span>do_alt2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0A9D                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">SYSINIT:0A9E                 </span><span style="color:navy">stosb
</span><span style="color:maroon">SYSINIT:0A9F                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">SYSINIT:0AA1                 </span><span style="color:navy">jnz     short </span>do_alt2
<span style="color:maroon">SYSINIT:0AA3                 </span><span style="color:navy">mov     byte ptr [di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">0Dh </span>; cr
<span style="color:maroon">SYSINIT:0AA7                 </span><span style="color:navy">mov     </span>dae_flag<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">SYSINIT:0AAC                 </span><span style="color:navy">call    </span>disable_autoexec
<span style="color:maroon">SYSINIT:0AAF                 </span><span style="color:navy">call    </span>CheckQueryOpt
<span style="color:maroon">SYSINIT:0AB2
SYSINIT:0AB2 </span>do_exec<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0AB2                 </span><span style="color:navy">jmp     </span>retry
<span style="color:black">SYSINIT:0AB5
SYSINIT:0AB5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0AB5
SYSINIT:0AB5
SYSINIT:0AB5 </span>AllocFreeMem    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0AB5                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:0AB8                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">SYSINIT:0ABA                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:0ABA                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:0ABC                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">SYSINIT:0ABE                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:0ABE                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:0AC0                 </span><span style="color:navy">mov     cs:</span>area<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0AC4                 </span><span style="color:navy">mov     cs:</span>memhi<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0AC8                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0AC8 </span>AllocFreeMem    <span style="color:black">endp
SYSINIT:0AC8
SYSINIT:0AC8 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0AC9 </span>DOSLOMSG        <span style="color:navy">db &#039;HMA not available: Loading DOS low&#039;,0Dh,0Ah,&#039;$&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0AEE </span>FEmsg           <span style="color:navy">db &#039;Fatal Error: Cannot allocate Memory for DOS&#039;,0Dh,0Ah,&#039;$&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0B1C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0B1C
SYSINIT:0B1C </span>LoadDOSHiOrLo<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0B1C                 </span><span style="color:navy">call    </span>TryToMovDOSHi   ; Try moving it into HMA
<span style="color:maroon">SYSINIT:0B1F                 </span><span style="color:navy">jb      short </span>LdngLo    ; If that don&#039;t work...
<span style="color:maroon">SYSINIT:0B21                 </span><span style="color:navy">retn
</span><span style="color:maroon">SYSINIT:0B22 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0B22
SYSINIT:0B22 </span>LdngLo<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0B22                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:0B23                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:0B24                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">9
</span><span style="color:maroon">SYSINIT:0B26                 </span><span style="color:navy">mov     dx, offset </span>DOSLOMSG <span style="color:gray">; &quot;HMA not available: Loading DOS low\r\n$&quot;
</span><span style="color:maroon">SYSINIT:0B29                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - PRINT STRING
<span style="color:maroon">SYSINIT:0B29                                         </span>; DS:DX -&gt; string terminated by &quot;$&quot;
<span style="color:maroon">SYSINIT:0B2B                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1           </span>; use int 21 alloc for mem
<span style="color:maroon">SYSINIT:0B2E                 </span><span style="color:navy">call    </span>MovDOSLo
<span style="color:maroon">SYSINIT:0B31                 </span><span style="color:navy">mov     es, cs:</span>CURRENTDOSLOCATION ; give dos its temporary loc.
<span style="color:maroon">SYSINIT:0B36                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0B36                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">SYSINIT:0B38                 </span><span style="color:navy">call    cs:</span>dos_segreinit
<span style="color:maroon">SYSINIT:0B3D                 </span><span style="color:navy">mov     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; mark that we are running lo
<span style="color:maroon">SYSINIT:0B43                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0B44
SYSINIT:0B44 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0B44
SYSINIT:0B44
SYSINIT:0B44 </span>TryToMovDOSHi   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0B44                 </span><span style="color:navy">call    </span>MovDOSHi
<span style="color:black">SYSINIT:0B47                 </span><span style="color:navy">jb      short </span><span style="color:gray">ttldhx
</span><span style="color:black">SYSINIT:0B49                 </span><span style="color:navy">mov     es, cs:</span>CURRENTDOSLOCATION ; give dos its temporary loc.
<span style="color:black">SYSINIT:0B4E                 </span><span style="color:navy">xor     ax, ax          </span>; ax = 0 --&gt; install stub
<span style="color:black">SYSINIT:0B50                 </span><span style="color:navy">call    cs:</span>dos_segreinit
<span style="color:black">SYSINIT:0B55                 </span><span style="color:navy">mov     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:0B5B                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:0B5C
SYSINIT:0B5C </span><span style="color:gray">ttldhx</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0B5C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0B5C </span>TryToMovDOSHi   <span style="color:black">endp
SYSINIT:0B5C
SYSINIT:0B5D
SYSINIT:0B5D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0B5D
SYSINIT:0B5D
SYSINIT:0B5D </span>MovDOSHi        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0B5D
SYSINIT:0B5D </span><span style="color:green">arg_B86         </span><span style="color:navy">= word ptr  </span><span style="color:#008040">0B88h
</span><span style="color:black">SYSINIT:0B5D
SYSINIT:0B5D                 </span><span style="color:navy">call    </span>AllocHMA        ; did we get HMA?
<span style="color:black">SYSINIT:0B60                 </span><span style="color:navy">jb      short </span><span style="color:gray">mdhx      </span>; no
<span style="color:black">SYSINIT:0B62                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; yes, HMA seg = 0ffffh
<span style="color:black">SYSINIT:0B65                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:0B67                 </span>assume es:nothing
<span style="color:black">SYSINIT:0B67                 </span><span style="color:navy">call    </span>MovBIOS         ; First move BIOS into HMA
<span style="color:black">SYSINIT:0B6A                 </span><span style="color:navy">mov     cx, cs:</span>hi_doscod_size ; when it is in HMA
<span style="color:black">SYSINIT:0B6F                 </span><span style="color:navy">call    </span>MovDOS          ; and move it
<span style="color:black">SYSINIT:0B72                 </span><span style="color:navy">call    </span>SaveFreeHMAPtr
<span style="color:black">SYSINIT:0B75                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:0B76
SYSINIT:0B76 </span><span style="color:gray">mdhx</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0B76                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0B76 </span>MovDOSHi        <span style="color:black">endp
SYSINIT:0B76
SYSINIT:0B77
SYSINIT:0B77 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0B77
SYSINIT:0B77
SYSINIT:0B77 </span>MovDOSLo        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0B77                 </span><span style="color:navy">call    </span>AllocMemForDOS  ; incestuosly!
<span style="color:black">SYSINIT:0B7A                 </span><span style="color:navy">mov     es, ax          </span>; pass the segment to MovBIOS
<span style="color:black">SYSINIT:0B7C                 </span>assume es:nothing
<span style="color:black">SYSINIT:0B7C                 </span><span style="color:navy">call    </span>MovBIOS
<span style="color:black">SYSINIT:0B7F                 </span><span style="color:navy">mov     cx, cs:</span>lo_doscod_size ; DOS code size when loaded
<span style="color:black">SYSINIT:0B84                 </span><span style="color:navy">call    </span>MovDOS
<span style="color:black">SYSINIT:0B87                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0B87 </span>MovDOSLo        <span style="color:black">endp
SYSINIT:0B87
SYSINIT:0B88
SYSINIT:0B88 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0B88
SYSINIT:0B88
SYSINIT:0B88 </span>MovBIOS         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0B88                 </span><span style="color:navy">mov     ds, cs:</span>temp_bcode_seg
<span style="color:black">SYSINIT:0B8D                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0B8D                 </span><span style="color:navy">mov     si, </span><span style="color:green">30h         </span>; BCODE_START
<span style="color:black">SYSINIT:0B90                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">SYSINIT:0B92                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1E00h       </span>; BCODE_END
<span style="color:black">SYSINIT:0B95                 </span><span style="color:navy">sub     cx, si          </span>; size of BIOS
<span style="color:black">SYSINIT:0B97                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1           </span>; Both the labels are para aligned
<span style="color:black">SYSINIT:0B99                 </span><span style="color:navy">rep movsw
</span><span style="color:black">SYSINIT:0B9B                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:0B9C                 </span><span style="color:navy">push    di              </span>; save end of BIOS
<span style="color:black">SYSINIT:0B9D                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:0B9F                 </span><span style="color:navy">mov     cs:</span>BCodeSeg<span style="color:navy">, ax </span>; save it for later use
<span style="color:black">SYSINIT:0BA3                 </span><span style="color:navy">call    dword ptr cs:</span>_seg_reinit_ptr ; far call to seg_reinit
<span style="color:black">SYSINIT:0BA3                                         </span>; call far [cs:seg_reinit_ptr]
<span style="color:black">SYSINIT:0BA8                 </span><span style="color:navy">pop     di              </span>; get back end of BIOS
<span style="color:black">SYSINIT:0BA9                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:0BAA                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0BAA </span>MovBIOS         <span style="color:black">endp
SYSINIT:0BAA
SYSINIT:0BAB
SYSINIT:0BAB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0BAB
SYSINIT:0BAB
SYSINIT:0BAB </span>MovDOS          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0BAB                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:0BAC                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:0BAD                 </span><span style="color:navy">lds     si, dword ptr cs:</span>dosinit
<span style="color:black">SYSINIT:0BB2                 </span><span style="color:navy">rep movsb
</span><span style="color:black">SYSINIT:0BB4                 </span><span style="color:navy">pop     bx              </span>; get back offset into which DOS was moved
<span style="color:black">SYSINIT:0BB5                 </span><span style="color:navy">mov     ax, cs:</span>dosinit  ; get the offset at which DOS wants to run
<span style="color:black">SYSINIT:0BB9                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:black">SYSINIT:0BBB                 </span><span style="color:navy">call    </span>_off_to_para
<span style="color:black">SYSINIT:0BBE                 </span><span style="color:navy">pop     bx              </span>; get the segment at which we moved DOS into
<span style="color:black">SYSINIT:0BBF                 </span><span style="color:navy">sub     bx, ax          </span>; Adjust segment
<span style="color:black">SYSINIT:0BC1                 </span><span style="color:navy">mov     cs:</span>CURRENTDOSLOCATION<span style="color:navy">, bx </span>; and save it
<span style="color:black">SYSINIT:0BC6                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0BC6 </span>MovDOS          <span style="color:black">endp
SYSINIT:0BC6
SYSINIT:0BC7
SYSINIT:0BC7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0BC7
SYSINIT:0BC7
SYSINIT:0BC7 </span>AllocMemForDOS  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0BC7
SYSINIT:0BC7 </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:1468 SIZE 00000001 BYTES
</span><span style="color:black">SYSINIT:0BC7
SYSINIT:0BC7                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1E00h       </span>; BCODE_END
<span style="color:black">SYSINIT:0BCA                 </span><span style="color:navy">sub     ax, </span><span style="color:green">30h         </span>; BCODE_START
<span style="color:black">SYSINIT:0BCA                                         </span>; BCODE_END-BCODE_START = BIOS code size
<span style="color:black">SYSINIT:0BCD                 </span><span style="color:navy">add     ax, cs:</span>lo_doscod_size
<span style="color:black">SYSINIT:0BD2                 </span><span style="color:navy">add     ax, </span><span style="color:green">15
</span><span style="color:black">SYSINIT:0BD5                 </span><span style="color:navy">call    </span>_off_to_para    ; convert to para
<span style="color:black">SYSINIT:0BD8                 </span><span style="color:navy">or      bx, bx          </span>; can we use int 21h for alloc ?
<span style="color:black">SYSINIT:0BDA                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">SYSINIT:0BDC                 </span><span style="color:navy">jz      short </span><span style="color:gray">update_arena </span>; no
<span style="color:black">SYSINIT:0BDE                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">SYSINIT:0BE0                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:0BE0                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:0BE2                 </span><span style="color:navy">jb      short </span><span style="color:gray">FatalErr
</span><span style="color:black">SYSINIT:0BE4                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">3           </span>; Take care ORG 30h of BIOS code
<span style="color:black">SYSINIT:0BE7                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:0BE9                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">21h</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:20h+ARENA.OWNER],08h
<span style="color:black">SYSINIT:0BF0                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">28h</span><span style="color:navy">, </span><span style="color:#ff8000">4353h </span>; &#039;SC&#039; ; mark it as system code area
<span style="color:black">SYSINIT:0BF7                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0BF8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:0BF8
SYSINIT:0BF8 </span><span style="color:gray">update_arena</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0BF8                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:0BF9                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:0BFA                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:0BFB                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:0BFC                 </span><span style="color:navy">lds     di, cs:</span>DOSINFO  ; get ptr to DOS var
<span style="color:black">SYSINIT:0C01                 </span><span style="color:navy">dec     di
</span><span style="color:black">SYSINIT:0C02                 </span><span style="color:navy">dec     di              </span>; Arena head is immediately before sysvar
<span style="color:black">SYSINIT:0C03                 </span><span style="color:navy">mov     es, word ptr [di] </span>; es = arena head
<span style="color:black">SYSINIT:0C05                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE] ; total low mem size
<span style="color:black">SYSINIT:0C0A                 </span><span style="color:navy">cmp     cx, bx          </span>; is it sufficient ?
<span style="color:black">SYSINIT:0C0C                 </span><span style="color:navy">jb      short </span><span style="color:gray">FatalErr  </span>; no, fatal error
<span style="color:black">SYSINIT:0C0E                 </span><span style="color:navy">mov     dl, es:</span><span style="color:green">0        </span>; [es:ARENA.SIGNATURE]
<span style="color:black">SYSINIT:0C13                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:0C15                 </span><span style="color:navy">add     ax, bx          </span>; ax = new arena head
<span style="color:black">SYSINIT:0C17                 </span><span style="color:navy">mov     [di], ax        </span>; store it in DOS data area
<span style="color:black">SYSINIT:0C19                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:0C1B                 </span><span style="color:navy">mov     ds:</span><span style="color:green">0</span><span style="color:navy">, dl        </span>; [ARENA.SIGNATURE] ; type of arena
<span style="color:black">SYSINIT:0C1F                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [ARENA.OWNER],0 ; free
<span style="color:black">SYSINIT:0C25                 </span><span style="color:navy">sub     cx, bx          </span>; size of the new block
<span style="color:black">SYSINIT:0C27                 </span><span style="color:navy">mov     ds:</span><span style="color:green">3</span><span style="color:navy">, cx        </span>; [ARENA.SIZE],cx ; store it in the arena
<span style="color:black">SYSINIT:0C2B                 </span><span style="color:navy">mov     ax, es          </span>; return seg to the caller
<span style="color:black">SYSINIT:0C2D                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">3           </span>; Take care ORG 30h of BIOS code
<span style="color:black">SYSINIT:0C30                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:0C31                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:0C32                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:0C33                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0C34                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0C35 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:0C35
SYSINIT:0C35 </span><span style="color:gray">FatalErr</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0C35                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0C36                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0C37                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:0C37                 </span><span style="color:navy">mov     dx, offset </span>FEmsg <span style="color:gray">; &quot;Fatal Error: Cannot allocate Memory for&quot;...
</span><span style="color:black">SYSINIT:0C3A                 </span><span style="color:navy">mov     ah, </span><span style="color:green">9
</span><span style="color:black">SYSINIT:0C3C                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - PRINT STRING
<span style="color:black">SYSINIT:0C3C                                         </span>; DS:DX -&gt; string terminated by &quot;$&quot;
<span style="color:black">SYSINIT:0C3E                 </span><span style="color:navy">jmp     </span>stall
<span style="color:black">SYSINIT:0C3E </span><span style="background:red">AllocMemForDOS  endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">SYSINIT:0C3E
SYSINIT:0C41
SYSINIT:0C41 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0C41
SYSINIT:0C41
SYSINIT:0C41 </span>AllocHMA        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0C41                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:0C42                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG ; BIOSDATA segment
<span style="color:black">SYSINIT:0C45                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:0C47                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0C47                 </span><span style="color:navy">call    </span>IsXMSLoaded
<span style="color:black">SYSINIT:0C4A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">grabhma_error
</span><span style="color:black">SYSINIT:0C4C                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4310h
</span><span style="color:black">SYSINIT:0C4F                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - XMS - GET DRIVER ADDRESS
<span style="color:black">SYSINIT:0C4F                                         </span>; Return: ES:BX -&gt; driver entry point
<span style="color:black">SYSINIT:0C51                 </span><span style="color:navy">mov     word ptr ds:</span>xms<span style="color:navy">, bx
</span><span style="color:black">SYSINIT:0C55                 </span><span style="color:navy">mov     word ptr ds:</span>xms<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:0C59                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1           </span>; request HMA
<span style="color:black">SYSINIT:0C5B                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:0C5E                 </span><span style="color:navy">call    ds:</span>xms          ; call far [xms]
<span style="color:black">SYSINIT:0C62                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:0C63                 </span><span style="color:navy">jz      short </span><span style="color:gray">allocHMA_1 </span>; error if not able to allocate HMA
<span style="color:black">SYSINIT:0C65                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">88h
</span><span style="color:black">SYSINIT:0C67                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; Get Extended Memory Size
<span style="color:black">SYSINIT:0C67                                         </span>; Return: CF clear on success
<span style="color:black">SYSINIT:0C67                                         </span>; AX = size of memory above 1M in K
<span style="color:black">SYSINIT:0C69                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">64          </span>; less than 64 K of hma ?
<span style="color:black">SYSINIT:0C6C                 </span><span style="color:navy">jb      short </span><span style="color:gray">grabhma_error
</span><span style="color:black">SYSINIT:0C6E
SYSINIT:0C6E </span><span style="color:gray">allocHMA_1</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0C6E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5           </span>; localenableA20
<span style="color:black">SYSINIT:0C70                 </span><span style="color:navy">call    ds:</span>xms
<span style="color:black">SYSINIT:0C74                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:0C75                 </span><span style="color:navy">jnz     short </span><span style="color:gray">grabhma_error </span>; error if couldn&#039;t enable A20
<span style="color:black">SYSINIT:0C77                 </span><span style="color:navy">call    </span>IsVDiskInstalled
<span style="color:black">SYSINIT:0C7A                 </span><span style="color:navy">jz      short </span><span style="color:gray">grabhma_error </span>; yes, we cant use HMA
<span style="color:black">SYSINIT:0C7C                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:0C7F                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:0C81                 </span>assume es:nothing
<span style="color:black">SYSINIT:0C81                 </span><span style="color:navy">mov     </span>word ptr es:10h<span style="color:navy">, </span><span style="color:#ff8000">1234h </span>; see if we can really read/write there
<span style="color:black">SYSINIT:0C88                 </span><span style="color:navy">cmp     </span>word ptr es:10h<span style="color:navy">, </span><span style="color:#ff8000">1234h
</span><span style="color:black">SYSINIT:0C8F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">grabhma_error </span>; don&#039;t try to load there if XMS lied
<span style="color:black">SYSINIT:0C91                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:0C92                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0C93                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0C93                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0C94 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:0C94
SYSINIT:0C94 </span><span style="color:gray">grabhma_error</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0C94                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:0C95                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0C96                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0C96 </span>AllocHMA        <span style="color:black">endp
SYSINIT:0C96
SYSINIT:0C97
SYSINIT:0C97 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0C97
SYSINIT:0C97
SYSINIT:0C97 </span>IsXMSLoaded     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0C97                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4300h
</span><span style="color:black">SYSINIT:0C9A                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - XMS - INSTALLATION CHECK
<span style="color:black">SYSINIT:0C9A                                         </span>; Return: AL = 80h XMS driver installed
<span style="color:black">SYSINIT:0C9A                                         </span>; AL &lt;&gt; 80h no driver
<span style="color:black">SYSINIT:0C9C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">80h         </span>; XMS installed?
<span style="color:black">SYSINIT:0C9E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0C9E </span>IsXMSLoaded     <span style="color:black">endp
SYSINIT:0C9E
</span><span style="color:maroon">SYSINIT:0C9F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:0C9F
SYSINIT:0C9F </span>FTRYTOMOVDOSHI<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:0C9F                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">SYSINIT:0CA0                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">SYSINIT:0CA1                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">SYSINIT:0CA2                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">SYSINIT:0CA3                 </span><span style="color:navy">push    si
</span><span style="color:maroon">SYSINIT:0CA4                 </span><span style="color:navy">push    di
</span><span style="color:maroon">SYSINIT:0CA5                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:0CA6                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:0CA7                 </span><span style="color:navy">cmp     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">SYSINIT:0CAD                 </span><span style="color:navy">jnz     short </span>_ftymdh_1
<span style="color:maroon">SYSINIT:0CAF                 </span><span style="color:navy">call    </span>TryToMovDOSHi
<span style="color:maroon">SYSINIT:0CB2
SYSINIT:0CB2 </span>_ftymdh_1<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:0CB2                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:0CB3                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:0CB3                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:0CB4                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">SYSINIT:0CB5                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">SYSINIT:0CB6                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">SYSINIT:0CB7                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">SYSINIT:0CB8                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">SYSINIT:0CB9                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">SYSINIT:0CBA                 </span><span style="color:navy">retf
</span><span style="color:maroon">SYSINIT:0CBA </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0CBB                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:0CBC </span>StartVDHead     <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0CBC                                         </span>; link to next device driver
<span style="color:gray">SYSINIT:0CC0                 </span><span style="color:navy">dw </span><span style="color:#008040">8000h                </span>; device attribute
<span style="color:gray">SYSINIT:0CC2                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; strategy routine offset
<span style="color:gray">SYSINIT:0CC4                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; interrupt routine offset
<span style="color:gray">SYSINIT:0CC6                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:0CC7                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span>; reserved area
<span style="color:gray">SYSINIT:0CCE </span>VDiskSig1       <span style="color:navy">db &#039;VDISK&#039;              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0CD3                 </span><span style="color:navy">db &#039;  V3.3&#039;             </span>; vdisk label ; VLEN1 equ ($-VDiskSig1)
<span style="color:gray">SYSINIT:0CD9                 </span><span style="color:navy">db </span><span style="color:#008040">15 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span>; pad
<span style="color:gray">SYSINIT:0CE8                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; bits 0-15 of free HMA
<span style="color:gray">SYSINIT:0CEA                 </span><span style="color:navy">db </span><span style="color:#008040">11h                  </span>; bits 16-23 of free HMA (1M + 64K)
<span style="color:gray">SYSINIT:0CEB </span>VDInt19         <span style="color:navy">db </span><span style="color:#008040">0EAh                 </span>; jmp to old vector
<span style="color:gray">SYSINIT:0CEC </span>OldVDInt19      <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0CF0 </span>VDiskHMAHead    <span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0CF0                                         </span>; EndVDHead
<span style="color:gray">SYSINIT:0CF0                                         </span>; non-bootable disk
<span style="color:gray">SYSINIT:0CF3 </span>VDiskSig2       <span style="color:navy">db &#039;VDISK&#039;              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0CF8                 </span><span style="color:navy">db &#039;3.3&#039;                </span>; VLEN2 equ ($-VDiskSig2)
<span style="color:gray">SYSINIT:0CF8                                         </span>; OEM - signature
<span style="color:gray">SYSINIT:0CFB                 </span><span style="color:navy">dw </span><span style="color:#008040">128                  </span>; number of bytes/sector
<span style="color:gray">SYSINIT:0CFD                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; sectors/cluster
<span style="color:gray">SYSINIT:0CFE                 </span><span style="color:navy">dw </span><span style="color:#008040">1                    </span>; reserved sectors
<span style="color:gray">SYSINIT:0D00                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; number of FAT copies
<span style="color:gray">SYSINIT:0D01                 </span><span style="color:navy">dw </span><span style="color:#008040">64                   </span>; number of root dir entries
<span style="color:gray">SYSINIT:0D03                 </span><span style="color:navy">dw </span><span style="color:#008040">512                  </span>; number of sectors
<span style="color:gray">SYSINIT:0D05                 </span><span style="color:navy">db </span><span style="color:#008040">0FEh                 </span>; media descriptor
<span style="color:gray">SYSINIT:0D06                 </span><span style="color:navy">dw </span><span style="color:#008040">6                    </span>; number of sectors/FAT
<span style="color:gray">SYSINIT:0D08                 </span><span style="color:navy">dw </span><span style="color:#008040">8                    </span>; sectors per track
<span style="color:gray">SYSINIT:0D0A                 </span><span style="color:navy">dw </span><span style="color:#008040">1                    </span>; number of heads
<span style="color:gray">SYSINIT:0D0C                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; number of hidden sectors
<span style="color:gray">SYSINIT:0D0E                 </span><span style="color:navy">dw </span><span style="color:#008040">440h                 </span>; Start of free HMA in K (1M+64K)
<span style="color:black">SYSINIT:0D10
SYSINIT:0D10 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0D10
SYSINIT:0D10
SYSINIT:0D10 </span>InstVDiskHeader <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0D10                 </span><span style="color:navy">xor     ax, ax          </span>; EndVDiskHMAHead (SYSINIT:0D10h)
<span style="color:black">SYSINIT:0D12                 </span><span style="color:navy">mov     ds, ax          </span>; seg of int vect table
<span style="color:black">SYSINIT:0D12                                         </span>; save old int 19 vector
<span style="color:black">SYSINIT:0D14                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0D14                 </span><span style="color:navy">mov     ax, </span>word ptr ds:64h ; [19h*4]
<span style="color:black">SYSINIT:0D17                 </span><span style="color:navy">mov     cs:</span>OldVDInt19<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0D1B                 </span><span style="color:navy">mov     ax, </span>word ptr ds:66h ; [19h*4+2]
<span style="color:black">SYSINIT:0D1E                 </span><span style="color:navy">mov     cs:</span>OldVDInt19<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0D22                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">SYSINIT:0D24                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">4
</span><span style="color:black">SYSINIT:0D27                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:0D27                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:0D29                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:0D2A                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:0D2C                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER],8 ; owner = System
<span style="color:black">SYSINIT:0D33                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4353h </span>; [es:ARENA.NAME],&#039;SC&#039; ; System Code
<span style="color:black">SYSINIT:0D3A                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:0D3B                 </span><span style="color:navy">mov     es, ax          </span>; get back to allocated memory
<span style="color:black">SYSINIT:0D3D                 </span><span style="color:navy">cli                     </span>; no reboots at this time
<span style="color:black">SYSINIT:0D3D                                         </span>; install new int 19 vector
<span style="color:black">SYSINIT:0D3E                 </span><span style="color:navy">mov     </span>word ptr ds:64h<span style="color:navy">, </span><span style="color:green">47 </span>; (VDInt19-StartVDHead)
<span style="color:black">SYSINIT:0D3E                                         </span>; 0CEBh-0CBCh = 2Fh = 47
<span style="color:black">SYSINIT:0D44                 </span><span style="color:navy">mov     </span>word ptr ds:66h<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0D47                 </span><span style="color:navy">mov     cx, </span><span style="color:green">52          </span>; (EndVDHead-StartVDHead)
<span style="color:black">SYSINIT:0D4A                 </span><span style="color:navy">mov     si, offset </span>StartVDHead ; SYSINIT:0CBCh
<span style="color:black">SYSINIT:0D4D                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">SYSINIT:0D4F                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0D50                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0D51                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:0D51                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:0D52                 </span><span style="color:navy">rep movsb
</span><span style="color:black">SYSINIT:0D54                 </span><span style="color:navy">sti                     </span>; mov the HMA VDisk head into HMA
<span style="color:black">SYSINIT:0D55                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:0D56                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:0D57                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:0D5A                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:0D5C                 </span>assume es:nothing
<span style="color:black">SYSINIT:0D5C                 </span><span style="color:navy">mov     di, </span><span style="color:green">10h
</span><span style="color:black">SYSINIT:0D5F                 </span><span style="color:navy">mov     cx, </span><span style="color:green">32          </span>; (EndVDiskHMAHead-VDiskHMAHead)
<span style="color:black">SYSINIT:0D62                 </span><span style="color:navy">mov     si, offset </span>VDiskHMAHead ; SYSINIT:0CF0h
<span style="color:black">SYSINIT:0D65                 </span><span style="color:navy">rep movsb
</span><span style="color:black">SYSINIT:0D67                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:0D68                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:0D69                 </span>assume es:nothing
<span style="color:black">SYSINIT:0D69                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0D69 </span>InstVDiskHeader <span style="color:black">endp
SYSINIT:0D69
SYSINIT:0D69 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:0D6A </span>dummy           <span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0D6A                                         </span>; bmove
<span style="color:gray">SYSINIT:0D72 </span>gdt             <span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span>; times desc.size db 0
<span style="color:gray">SYSINIT:0D7A </span>src_desc        <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; des &lt;0ffffh,0,0,93h,0&gt;
<span style="color:gray">SYSINIT:0D7C </span>desc_lo_word    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0D7E </span>desc_hi_byte    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:0D7F                 </span><span style="color:navy">db </span><span style="color:#008040">93h
</span><span style="color:gray">SYSINIT:0D80                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:0D82 </span>tgt_desc        <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; desc &lt;0ffffh,0,10h,93h,0&gt;  ; 1MB
<span style="color:gray">SYSINIT:0D82                                         </span>; desc.seg_lim
<span style="color:gray">SYSINIT:0D84                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; desc.lo_word
<span style="color:gray">SYSINIT:0D86                 </span><span style="color:navy">db </span><span style="color:#008040">10h                  </span>; desc.hi_byte
<span style="color:gray">SYSINIT:0D87                 </span><span style="color:navy">db </span><span style="color:#008040">93h                  </span>; desc.acc_rights
<span style="color:gray">SYSINIT:0D88                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; desc.reserved
<span style="color:gray">SYSINIT:0D8A </span>rombios_code    <span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span>; times desc.size db 0
<span style="color:gray">SYSINIT:0D92 </span>temp_stack      <span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:0D9A </span>ClrdVDISKHead   <span style="color:navy">db </span><span style="color:#008040">32 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:black">SYSINIT:0DBA
SYSINIT:0DBA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0DBA
SYSINIT:0DBA
SYSINIT:0DBA </span>ClrVDISKHeader  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0DBA                 </span><span style="color:navy">in      al, </span><span style="color:green">64h         </span>; 8042 keyboard controller status register
<span style="color:black">SYSINIT:0DBA                                         </span>; 7:  PERR    1=parity error in data received from keyboard
<span style="color:black">SYSINIT:0DBA                                         </span>;    +----------- AT Mode ----------+------------ PS/2 Mode ------------+
<span style="color:black">SYSINIT:0DBA                                         </span>; 6: |RxTO    receive (Rx) timeout  | TO      general timeout (Rx or Tx)|
<span style="color:black">SYSINIT:0DBA                                         </span>; 5: |TxTO    transmit (Tx) timeout | MOBF    mouse output buffer full  |
<span style="color:black">SYSINIT:0DBA                                         </span>;    +------------------------------+-----------------------------------+
<span style="color:black">SYSINIT:0DBA                                         </span>; 4:  INH     0=keyboard communications inhibited
<span style="color:black">SYSINIT:0DBA                                         </span>; 3:  A2      0=60h was the port last written to, 1=64h was last
<span style="color:black">SYSINIT:0DBA                                         </span>; 2:  SYS     distinguishes reset types: 0=cold reboot, 1=warm reboot
<span style="color:black">SYSINIT:0DBA                                         </span>; 1:  IBF     1=input buffer full (keyboard can&#039;t accept data)
<span style="color:black">SYSINIT:0DBA                                         </span>; 0:  OBF     1=output buffer full (data from keyboard is available)
<span style="color:black">SYSINIT:0DBC                 </span><span style="color:navy">test    al, </span><span style="color:green">10h         </span>; test bit 4 - Is keyboard inhibited?
<span style="color:black">SYSINIT:0DBE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ClrVDISKok </span>; No, go do block move
<span style="color:black">SYSINIT:0DC0                 </span><span style="color:navy">cmp     word ptr cs:</span>sys_model_byte<span style="color:navy">, </span><span style="color:#ff8000">19F8h </span>; check for TORTUGA models
<span style="color:black">SYSINIT:0DC7                 </span><span style="color:navy">jz      short </span><span style="color:gray">ClrVDISKno </span>; do not use INT 15h block move code
<span style="color:black">SYSINIT:0DC7                                         </span>; (while 8042 is disabled)
<span style="color:black">SYSINIT:0DC9                 </span><span style="color:navy">cmp     word ptr cs:</span>sys_model_byte<span style="color:navy">, </span><span style="color:#ff8000">9FCh </span>; Check for PS/2 30-286 model
<span style="color:black">SYSINIT:0DD0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ClrVDISKok
</span><span style="color:black">SYSINIT:0DD2
SYSINIT:0DD2 </span><span style="color:gray">ClrVDISKno</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0DD2                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0DD3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:0DD3
SYSINIT:0DD3 </span><span style="color:gray">ClrVDISKok</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0DD3                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:0DD4                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:black">SYSINIT:0DD6                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">SYSINIT:0DD8                 </span><span style="color:navy">mov     cl, </span><span style="color:green">12
</span><span style="color:black">SYSINIT:0DDA                 </span><span style="color:navy">shr     dx, cl          </span>; dx = higher 4 bits of the segment number
<span style="color:black">SYSINIT:0DDA                                         </span>;    = segment number / 4096 (= byte address / 65536)
<span style="color:black">SYSINIT:0DDC                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">SYSINIT:0DDE                 </span><span style="color:navy">shl     ax, cl          </span>; ax = (lower 12 bits of the segment number)*16
<span style="color:black">SYSINIT:0DE0                 </span><span style="color:navy">add     ax, offset </span>ClrdVDISKHead
<span style="color:black">SYSINIT:0DE3                 </span><span style="color:navy">adc     dl, </span><span style="color:#ff8000">0           </span>; dl:ax = 24 bit linear address
<span style="color:black">SYSINIT:0DE6                 </span><span style="color:navy">mov     cs:</span>desc_lo_word<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0DEA                 </span><span style="color:navy">mov     cs:</span>desc_hi_byte<span style="color:navy">, dl
</span><span style="color:black">SYSINIT:0DEF                 </span><span style="color:navy">mov     cx, </span><span style="color:green">16          </span>; 16 words
<span style="color:black">SYSINIT:0DF2                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0DF3                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:0DF4                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:0DF4                 </span><span style="color:navy">mov     si, offset </span>dummy ; offset bmove
<span style="color:black">SYSINIT:0DF7                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">87h
</span><span style="color:black">SYSINIT:0DF9                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; EXTENDED MEMORY - BLOCK MOVE (AT,XT286,PS)
<span style="color:black">SYSINIT:0DF9                                         </span>; CX = number of words to move, ES:SI -&gt; global descriptor table
<span style="color:black">SYSINIT:0DF9                                         </span>; Return: CF set on error, AH = status
<span style="color:black">SYSINIT:0DFB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:0DFC                 </span>assume es:nothing
<span style="color:black">SYSINIT:0DFC                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0DFC </span>ClrVDISKHeader  <span style="color:black">endp
SYSINIT:0DFC
SYSINIT:0DFD
SYSINIT:0DFD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0DFD
SYSINIT:0DFD
SYSINIT:0DFD </span>SaveFreeHMAPtr  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0DFD                 </span><span style="color:navy">mov     bx, es
</span><span style="color:black">SYSINIT:0DFF                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; HMA segment
<span style="color:black">SYSINIT:0E02                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:black">SYSINIT:0E04                 </span><span style="color:navy">add     di, </span><span style="color:green">15          </span>; para round
<span style="color:black">SYSINIT:0E07                 </span><span style="color:navy">and     di, </span><span style="color:green">0FFF0h
</span><span style="color:black">SYSINIT:0E0A                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">SYSINIT:0E0C                 </span><span style="color:navy">shl     ax, cl
</span><span style="color:black">SYSINIT:0E0E                 </span><span style="color:navy">sub     di, ax
</span><span style="color:black">SYSINIT:0E10                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:0E11                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG ; BIOSDATA segment
<span style="color:black">SYSINIT:0E14                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:0E16                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0E16                 </span><span style="color:navy">mov     ds:</span>FreeHMAPtr<span style="color:navy">, di </span>; BIOSDATA:07D7h
<span style="color:black">SYSINIT:0E1A                 </span><span style="color:navy">mov     ds:</span>inHMA<span style="color:navy">, </span><span style="color:#ff8000">0FFh  </span>; BIOSDATA:000Dh
<span style="color:black">SYSINIT:0E1F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0E20                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0E20                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0E20 </span>SaveFreeHMAPtr  <span style="color:black">endp
SYSINIT:0E20
SYSINIT:0E21
SYSINIT:0E21 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0E21
SYSINIT:0E21
SYSINIT:0E21 </span>IsVDiskInstalled <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0E21                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:0E23                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:0E25                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0E25                 </span><span style="color:navy">mov     ds, </span>word ptr ds:4Eh ; [13h*4+2]
<span style="color:black">SYSINIT:0E29                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0E29                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">12h         </span>; VDiskSig1-StartVDHead
<span style="color:black">SYSINIT:0E2C                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5           </span>; VLEN1
<span style="color:black">SYSINIT:0E2F                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0E30                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:0E31                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:0E31                 </span><span style="color:navy">mov     di, offset </span>VDiskSig1 <span style="color:gray">; &quot;VDISK&quot;
</span><span style="color:black">SYSINIT:0E34                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">SYSINIT:0E36                 </span><span style="color:navy">jz      short </span><span style="color:gray">ivdins_retn
</span><span style="color:black">SYSINIT:0E38                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:0E3B                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:0E3D                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0E3D                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">13h         </span>; 10h+(VDiskSig2-VDiskHMAHead)
<span style="color:black">SYSINIT:0E40                 </span><span style="color:navy">mov     di, offset </span>VDiskSig2 <span style="color:gray">; &quot;VDISK&quot;
</span><span style="color:black">SYSINIT:0E43                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:black">SYSINIT:0E46                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">SYSINIT:0E48
SYSINIT:0E48 </span><span style="color:gray">ivdins_retn</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0E48                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0E48 </span>IsVDiskInstalled <span style="color:black">endp
SYSINIT:0E48
SYSINIT:0E49
SYSINIT:0E49 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0E49
SYSINIT:0E49
SYSINIT:0E49 </span>CPMHack         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0E49                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:0E4A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:0E4D                 </span><span style="color:navy">mov     es, cx
</span><span style="color:black">SYSINIT:0E4F                 </span>assume es:nothing
<span style="color:black">SYSINIT:0E4F                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:0E51                 </span><span style="color:navy">mov     ds, cx          </span>; 0
<span style="color:black">SYSINIT:0E53                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0E53                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">0C0h
</span><span style="color:black">SYSINIT:0E56                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0D0h
</span><span style="color:black">SYSINIT:0E59                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:black">SYSINIT:0E5C                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:0E5D                 </span><span style="color:navy">rep movsb               </span>; move 5 bytes from 0:C0h to FFFFh:D0h
<span style="color:black">SYSINIT:0E5F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0E60                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0E60                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0E60 </span>CPMHack         <span style="color:black">endp
SYSINIT:0E60
SYSINIT:0E61
SYSINIT:0E61 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0E61
SYSINIT:0E61
SYSINIT:0E61 </span>_off_to_para    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0E61                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:0E63                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:0E65                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:0E67                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:0E69                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0E69 </span>_off_to_para    <span style="color:black">endp
SYSINIT:0E69
SYSINIT:0E6A
SYSINIT:0E6A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0E6A
SYSINIT:0E6A
SYSINIT:0E6A </span>TempCDS         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0E6A                 </span><span style="color:navy">les     di, ds:</span>DOSINFO
<span style="color:black">SYSINIT:0E6E                 </span>assume es:nothing
<span style="color:black">SYSINIT:0E6E                 </span><span style="color:navy">mov     cl, es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">] </span>; [es:di+SYSI_NUMIO]
<span style="color:black">SYSINIT:0E72                 </span><span style="color:navy">xor     ch, ch          </span>; (cx) = # of block devices
<span style="color:black">SYSINIT:0E74                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">21h</span><span style="color:navy">], cl </span>; [es:di+SYSI_NCDS] ; one CDS per device
<span style="color:black">SYSINIT:0E78                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">SYSINIT:0E7A                 </span><span style="color:navy">mov     ah, </span><span style="color:green">88          </span>; curdirlen ; curdir_list.size
<span style="color:black">SYSINIT:0E7C                 </span><span style="color:navy">mul     ah
</span><span style="color:black">SYSINIT:0E7E                 </span><span style="color:navy">call    </span>ParaRound
<span style="color:black">SYSINIT:0E81                 </span><span style="color:navy">mov     si, ds:</span>top_of_cdss
<span style="color:black">SYSINIT:0E85                 </span><span style="color:navy">sub     si, ax
</span><span style="color:black">SYSINIT:0E87                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">18h</span><span style="color:navy">], si </span>; [es:di+SYSI_CDS+2]
<span style="color:black">SYSINIT:0E8B                 </span><span style="color:navy">mov     ax, si
</span><span style="color:black">SYSINIT:0E8D                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">16h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+SYSI_CDS]
<span style="color:black">SYSINIT:0E8D                                         </span>; set address of CDS list
<span style="color:black">SYSINIT:0E93                 </span><span style="color:navy">lds     si, es:[di]     </span>; lds si,[es:di+SYSI_DPB]
<span style="color:black">SYSINIT:0E93                                         </span>; (ds:si) = address of first DPB
<span style="color:black">SYSINIT:0E96                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:0E98                 </span><span style="color:navy">xor     di, di          </span>; (es:di) = address of 1st CDS
<span style="color:black">SYSINIT:0E98 </span>TempCDS         <span style="color:black">endp
SYSINIT:0E98
SYSINIT:0E9A
SYSINIT:0E9A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0E9A
SYSINIT:0E9A
SYSINIT:0E9A </span>fooset          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0E9A                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DirStrng ; &quot;A:\&quot;
<span style="color:black">SYSINIT:0E9E                 </span><span style="color:navy">stosw                   </span>; setup the root as the curdir
<span style="color:black">SYSINIT:0E9F                 </span><span style="color:navy">call    </span>get_dpb_for_drive_al ; get dpb for drive in dpb
<span style="color:black">SYSINIT:0E9F                                         </span>; (ds:si) = address of DPB
<span style="color:black">SYSINIT:0E9F                                         </span>;    (si) = -1 if no drive
<span style="color:black">SYSINIT:0EA2                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DirStrng<span style="color:navy">+</span><span style="color:green">2 </span>; &quot;\&quot;,0
<span style="color:black">SYSINIT:0EA6                 </span><span style="color:navy">stosw
</span><span style="color:black">SYSINIT:0EA7                 </span><span style="color:navy">inc     byte ptr cs:</span>DirStrng ; &quot;A:\&quot;
<span style="color:black">SYSINIT:0EAC                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">SYSINIT:0EAE                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:0EAF                 </span><span style="color:navy">mov     cx, </span><span style="color:green">63          </span>; curdir_list.cdir_flags - 4
<span style="color:black">SYSINIT:0EB2                 </span><span style="color:navy">rep stosb               </span>; zero out rest of CURDIR_TEXTs
<span style="color:black">SYSINIT:0EB2                                         </span>; (ax) = 0
<span style="color:black">SYSINIT:0EB2                                         </span>; (es:di) = CURDIR_FLAGS in the CDS records
<span style="color:black">SYSINIT:0EB2                                         </span>; (ds:si) = Next DPB (-1 if none)
<span style="color:black">SYSINIT:0EB4                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">SYSINIT:0EB7                 </span><span style="color:navy">jz      short </span><span style="color:gray">fooset_zero
</span><span style="color:black">SYSINIT:0EB9                 </span><span style="color:navy">cmp     cs:</span>fake_floppy_drv<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:0EBF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">normcds   </span>; machine has floppy drives
<span style="color:black">SYSINIT:0EC1                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">1 </span>; cmp [si+DPB.drive],1
<span style="color:black">SYSINIT:0EC1                                         </span>; if dpb_drive = 0 (A) or 1 (B).
<span style="color:black">SYSINIT:0EC4                 </span><span style="color:navy">ja      short </span><span style="color:gray">normcds
</span><span style="color:black">SYSINIT:0EC6                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">3           </span>; the next dbp pointer
<span style="color:black">SYSINIT:0EC8                 </span><span style="color:navy">rep stosw               </span>; ax should be zero here
<span style="color:black">SYSINIT:0ECA                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:0ECB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">get_next_dpb
</span><span style="color:black">SYSINIT:0ECD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:0ECD
SYSINIT:0ECD </span><span style="color:gray">fooset_zero</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0ECD                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">3
</span><span style="color:black">SYSINIT:0ECF                 </span><span style="color:navy">rep stosw
</span><span style="color:black">SYSINIT:0ED1                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:0ED2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">get_next_dpb </span>; jmp short fincds
<span style="color:black">SYSINIT:0ED4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:0ED4
SYSINIT:0ED4 </span><span style="color:gray">normcds</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0ED4                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:0ED5                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [si+DPB.FAT_COUNT] ; non fat system?
<span style="color:black">SYSINIT:0ED9                 </span><span style="color:navy">jz      short </span><span style="color:gray">setnormcds </span>; yes. set curdir_flags to 0. ax = 0 now.
<span style="color:black">SYSINIT:0EDB                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4000h       </span>; curdir_inuse ; else,fat system.
<span style="color:black">SYSINIT:0EDB                                         </span>; set the flag to curdir_inuse.
<span style="color:black">SYSINIT:0EDE
SYSINIT:0EDE </span><span style="color:gray">setnormcds</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0EDE                 </span><span style="color:navy">stosw                   </span>; curdir_flags
<span style="color:black">SYSINIT:0EDF                 </span><span style="color:navy">mov     ax, si
</span><span style="color:black">SYSINIT:0EE1                 </span><span style="color:navy">stosw                   </span>; curdir_devptr
<span style="color:black">SYSINIT:0EE2                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">SYSINIT:0EE4                 </span><span style="color:navy">stosw
</span><span style="color:black">SYSINIT:0EE5
SYSINIT:0EE5 </span><span style="color:gray">get_next_dpb</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0EE5                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; entry point for fake_fooset_zero
<span style="color:black">SYSINIT:0EE5                                         </span>; mov ax,-1
<span style="color:black">SYSINIT:0EE8                 </span><span style="color:navy">stosw                   </span>; curdir_id
<span style="color:black">SYSINIT:0EE9                 </span><span style="color:navy">stosw                   </span>; curdir_id
<span style="color:black">SYSINIT:0EEA                 </span><span style="color:navy">stosw                   </span>; curdir_user_word
<span style="color:black">SYSINIT:0EEB                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; curdir_end
<span style="color:black">SYSINIT:0EEE                 </span><span style="color:navy">stosw
</span><span style="color:black">SYSINIT:0EEF                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0           </span>; clear out 7 bytes (curdir_type,
<span style="color:black">SYSINIT:0EF1                 </span><span style="color:navy">stosb
</span><span style="color:black">SYSINIT:0EF2                 </span><span style="color:navy">stosw                   </span>; curdir_ifs_hdr,curdir_fsda)
<span style="color:black">SYSINIT:0EF3                 </span><span style="color:navy">stosw
</span><span style="color:black">SYSINIT:0EF4                 </span><span style="color:navy">stosw
</span><span style="color:black">SYSINIT:0EF5                 </span><span style="color:navy">loop    </span>fooset
<span style="color:black">SYSINIT:0EF7                 </span><span style="color:navy">mov     byte ptr cs:</span>DirStrng<span style="color:navy">, &#039;</span><span style="color:green">A&#039; </span>; &quot;A:\&quot;,0
<span style="color:black">SYSINIT:0EFD                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0EFD </span>fooset          <span style="color:black">endp
SYSINIT:0EFD
SYSINIT:0EFE
SYSINIT:0EFE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0EFE
SYSINIT:0EFE
SYSINIT:0EFE </span>get_dpb_for_drive_al <span style="color:black">proc near          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0EFE                 </span><span style="color:navy">lds     si, cs:</span>DOSINFO  ; point to first DPB
<span style="color:black">SYSINIT:0F03                 </span><span style="color:navy">lds     si, [si]        </span>; (ds:si) = address of first DPB
<span style="color:black">SYSINIT:0F05                 </span><span style="color:navy">sub     al, &#039;</span><span style="color:green">A&#039;
</span><span style="color:black">SYSINIT:0F07
SYSINIT:0F07 </span><span style="color:gray">get_dpb_for_drive_1</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0F07                 </span><span style="color:navy">cmp     al, [si]        </span>; cmp al,[si+DPB.DRIVE] ; match?
<span style="color:black">SYSINIT:0F09                 </span><span style="color:navy">jz      short </span><span style="color:gray">got_dpb_for_drive
</span><span style="color:black">SYSINIT:0F0B                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">19h</span><span style="color:navy">]    </span>; lds si,[si+DPB.NEXT_DPB]
<span style="color:black">SYSINIT:0F0E
SYSINIT:0F0E </span><span style="color:navy">loc_623E:
</span><span style="color:black">SYSINIT:0F0E                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:0F11                 </span><span style="color:navy">jnz     short </span><span style="color:gray">get_dpb_for_drive_1 </span>; loop until hit end of DPBs
<span style="color:black">SYSINIT:0F13
SYSINIT:0F13 </span><span style="color:gray">got_dpb_for_drive</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0F13                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:0F13 </span>get_dpb_for_drive_al <span style="color:black">endp
SYSINIT:0F13
SYSINIT:0F14
SYSINIT:0F14 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:0F14
SYSINIT:0F14
SYSINIT:0F14 </span>endfile         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0F14                 </span><span style="color:navy">push    ds              </span>; Build DOS structures
<span style="color:black">SYSINIT:0F15                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG
<span style="color:black">SYSINIT:0F18                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:0F1A                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0F1A                 </span><span style="color:navy">cmp     ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; multrk_off1
<span style="color:black">SYSINIT:0F1A                                         </span>; multrack= command entered?
<span style="color:black">SYSINIT:0F1F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">multrk_flag_done
</span><span style="color:black">SYSINIT:0F21                 </span><span style="color:navy">or      ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:green">80h </span>; or [multrk_flag],multrk_on
<span style="color:black">SYSINIT:0F27
SYSINIT:0F27 </span><span style="color:gray">multrk_flag_done</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0F27                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0F28                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0F28                 </span><span style="color:navy">mov     ax, cs:</span>CONFBOT
<span style="color:black">SYSINIT:0F2C                 </span><span style="color:navy">mov     cs:</span>ALLOCLIM<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0F30                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0F31                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0F32                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:0F32                 </span><span style="color:navy">mov     ax, cs:</span>memhi
<span style="color:black">SYSINIT:0F36                 </span><span style="color:navy">mov     cs:</span>prev_memhi<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0F3A                 </span><span style="color:navy">mov     ax, cs:</span>ALLOCLIM
<span style="color:black">SYSINIT:0F3E                 </span><span style="color:navy">mov     cs:</span>prev_alloclim<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:0F42
SYSINIT:0F42 </span><span style="color:gray">dosfts</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0F42                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:0F45                 </span><span style="color:navy">mov     al, cs:</span>FILES
<span style="color:black">SYSINIT:0F49                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">5
</span><span style="color:black">SYSINIT:0F4B                 </span><span style="color:navy">jbe     short </span><span style="color:gray">dofcbs
</span><span style="color:black">SYSINIT:0F4D                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:0F4E                 </span><span style="color:navy">mov     al, &#039;</span><span style="color:green">F&#039;         </span>; devmark_files
<span style="color:black">SYSINIT:0F50                 </span><span style="color:navy">call    </span>setdevmark      ; set devmark for sfts (files)
<span style="color:black">SYSINIT:0F53                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:0F54                 </span><span style="color:navy">xor     ah, ah          </span>; do not use cbw instruction!
<span style="color:black">SYSINIT:0F54                                         </span>; it does sign extend.
<span style="color:black">SYSINIT:0F56                 </span><span style="color:navy">mov     bx, cs:</span>memlo
<span style="color:black">SYSINIT:0F5B                 </span><span style="color:navy">mov     dx, cs:</span>memhi
<span style="color:black">SYSINIT:0F60                 </span><span style="color:navy">lds     di, cs:</span>DOSINFO  ; get pointer to dos data
<span style="color:black">SYSINIT:0F65                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0F65                 </span><span style="color:navy">lds     di, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; lds di,[di+SYSI_SFT] ; ds:di points to sft
<span style="color:black">SYSINIT:0F68                 </span><span style="color:navy">mov     [di], bx        </span>; [di+SF.SFLink],bx
<span style="color:black">SYSINIT:0F6A                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2</span><span style="color:navy">], dx      </span>; [di+SF.SFLink+2],dx ; set pointer to new sft
<span style="color:black">SYSINIT:0F6D                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0F6E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0F6F                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:0F6F                 </span><span style="color:navy">les     di, dword ptr cs:</span>memlo ; point to new sft
<span style="color:black">SYSINIT:0F74                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:green">0FFFFh </span>; mov word [es:di+SF.SFLink],-1
<span style="color:black">SYSINIT:0F79                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax   </span>; mov [es:di+SF.SFCount],ax
<span style="color:black">SYSINIT:0F7D                 </span><span style="color:navy">mov     bl, </span><span style="color:green">59          </span>; SF_ENTRY.size
<span style="color:black">SYSINIT:0F7F                 </span><span style="color:navy">mul     bl
</span><span style="color:black">SYSINIT:0F81                 </span><span style="color:navy">mov     cx, ax          </span>; ax = number of bytes to clear
<span style="color:black">SYSINIT:0F83                 </span><span style="color:navy">add     cs:</span>memlo<span style="color:navy">, ax    </span>; allocate memory
<span style="color:black">SYSINIT:0F88                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">6
</span><span style="color:black">SYSINIT:0F8B                 </span><span style="color:navy">add     cs:</span>memlo<span style="color:navy">, ax    </span>; remember the header too
<span style="color:black">SYSINIT:0F90                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:0F96                 </span><span style="color:navy">call    </span>round           ; check for mem error before the stosb
<span style="color:black">SYSINIT:0F99                 </span><span style="color:navy">add     di, ax          </span>; ax = 6
<span style="color:black">SYSINIT:0F9B                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:0F9D                 </span><span style="color:navy">rep stosb               </span>; clean out the stuff
<span style="color:black">SYSINIT:0F9F
SYSINIT:0F9F </span><span style="color:gray">dofcbs</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0F9F                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0FA0                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0FA1                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:0FA4                 </span><span style="color:navy">mov     al, &#039;</span><span style="color:green">X&#039;         </span>; devmark_fcbs
<span style="color:black">SYSINIT:0FA6                 </span><span style="color:navy">call    </span>setdevmark
<span style="color:black">SYSINIT:0FA9                 </span><span style="color:navy">mov     al, cs:</span>FCBS
<span style="color:black">SYSINIT:0FAD                 </span><span style="color:navy">xor     ah, ah          </span>; do not use cbw instruction!
<span style="color:black">SYSINIT:0FAD                                         </span>; it does sign extend.
<span style="color:black">SYSINIT:0FAF                 </span><span style="color:navy">mov     bx, cs:</span>memlo
<span style="color:black">SYSINIT:0FB4                 </span><span style="color:navy">mov     dx, cs:</span>memhi
<span style="color:black">SYSINIT:0FB9                 </span><span style="color:navy">lds     di, cs:</span>DOSINFO  ; get pointer to dos data
<span style="color:black">SYSINIT:0FBE                 </span>assume ds:nothing
<span style="color:black">SYSINIT:0FBE                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">], bx    </span>; [di+SYSI_FCB]
<span style="color:black">SYSINIT:0FC1                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">], dx    </span>; [di+SYSI_FCB+2] ; set pointer to new table
<span style="color:black">SYSINIT:0FC4                 </span><span style="color:navy">mov     bl, cs:</span>KEEP
<span style="color:black">SYSINIT:0FC9                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">SYSINIT:0FCB                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">1Eh</span><span style="color:navy">], bx    </span>; [di+SYSI_KEEP]
<span style="color:black">SYSINIT:0FCE                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:0FCF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:0FD0                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:0FD0                 </span><span style="color:navy">les     di, dword ptr </span>memlo ; point to new table
<span style="color:black">SYSINIT:0FD4                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:green">0FFFFh </span>; [es:di+SF.SFLink],-1
<span style="color:black">SYSINIT:0FD9                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax   </span>; [es:di+SF.SFCount]
<span style="color:black">SYSINIT:0FDD                 </span><span style="color:navy">mov     bl, </span><span style="color:green">59          </span>; SF_ENTRY.size
<span style="color:black">SYSINIT:0FDF                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:0FE1                 </span><span style="color:navy">mul     bl
</span><span style="color:black">SYSINIT:0FE3                 </span><span style="color:navy">add     </span>memlo<span style="color:navy">, ax       </span>; ax = number of bytes to clear
<span style="color:black">SYSINIT:0FE7                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">6           </span>; SF.size-2
<span style="color:black">SYSINIT:0FEA                 </span><span style="color:navy">add     </span>memlo<span style="color:navy">, ax       </span>; remember the header too
<span style="color:black">SYSINIT:0FEE                 </span><span style="color:navy">or      </span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:0FF3                 </span><span style="color:navy">call    </span>round           ; check for mem error before the stosb
<span style="color:black">SYSINIT:0FF6                 </span><span style="color:navy">add     di, ax          </span>; skip over header
<span style="color:black">SYSINIT:0FF8                 </span><span style="color:navy">mov     al, &#039;</span><span style="color:green">A&#039;
</span><span style="color:black">SYSINIT:0FFA
SYSINIT:0FFA </span><span style="color:gray">fillloop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:0FFA                 </span><span style="color:navy">push    cx              </span>; save count
<span style="color:black">SYSINIT:0FFB                 </span><span style="color:navy">mov     cx, </span><span style="color:green">59          </span>; number of bytes to fill
<span style="color:black">SYSINIT:0FFE                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:0FFF                 </span><span style="color:navy">rep stosb               </span>; filled
<span style="color:black">SYSINIT:1001                 </span><span style="color:navy">mov     word ptr es:[di-</span><span style="color:green">3Bh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_ref_count]
<span style="color:black">SYSINIT:1007                 </span><span style="color:navy">mov     word ptr es:[di-</span><span style="color:green">26h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position]
<span style="color:black">SYSINIT:100D                 </span><span style="color:navy">mov     word ptr es:[di-</span><span style="color:green">24h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position+2]
<span style="color:black">SYSINIT:1013                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:1014                 </span><span style="color:navy">loop    </span><span style="color:gray">fillloop
</span><span style="color:black">SYSINIT:1016                 </span><span style="color:navy">cmp     </span>buffers<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; has buffers been already set?
<span style="color:black">SYSINIT:101B                 </span><span style="color:navy">jz      short </span><span style="color:gray">dodefaultbuff
</span><span style="color:black">SYSINIT:101D                 </span><span style="color:navy">jmp     </span><span style="color:gray">dobuff          </span>; the user entered the buffers=.
<span style="color:black">SYSINIT:1020 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1020
SYSINIT:1020 </span><span style="color:gray">dodefaultbuff</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1020                 </span><span style="color:navy">mov     </span>h_buffers<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; default is no heuristic (secondary) buffers.
<span style="color:black">SYSINIT:1026                 </span><span style="color:navy">mov     </span>buffers<span style="color:navy">, </span><span style="color:#ff8000">2      </span>; default to 2 buffers
<span style="color:black">SYSINIT:102C                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:102D                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:102E                 </span><span style="color:navy">les     bp, cs:</span>DOSINFO  ; search through the dpb&#039;s
<span style="color:black">SYSINIT:1033                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+SYSI_DPB] ; get first dpb
<span style="color:black">SYSINIT:1037                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:1038                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1039
SYSINIT:1039 </span><span style="color:gray">nextdpb</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1039                 </span><span style="color:navy">mov     bl, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+DPB.drive]
<span style="color:black">SYSINIT:103D                 </span><span style="color:navy">inc     bl
</span><span style="color:black">SYSINIT:103F                 </span><span style="color:navy">mov     ax, </span><span style="color:green">4408h
</span><span style="color:black">SYSINIT:1042                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - IOCTL -
<span style="color:black">SYSINIT:1044                 </span><span style="color:navy">or      ax, ax          </span>; 0 = removable disk, 1 = fixed disk
<span style="color:black">SYSINIT:1046                 </span><span style="color:navy">jnz     short </span><span style="color:gray">nosetbuf  </span>; ax is nonzero if disk is nonremoveable
<span style="color:black">SYSINIT:1048                 </span><span style="color:navy">xor     bx, bx          </span>; get parameters of (removable) drive
<span style="color:black">SYSINIT:104A                 </span><span style="color:navy">mov     bl, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+DPB.drive]
<span style="color:black">SYSINIT:104E                 </span><span style="color:navy">inc     bl
</span><span style="color:black">SYSINIT:1050                 </span><span style="color:navy">mov     dx, offset </span>devp_specialfunc
<span style="color:black">SYSINIT:1053                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">440Dh       </span>; (IOCTL&lt;&lt;8)|GENERIC_IOCTL
<span style="color:black">SYSINIT:1056                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">860h        </span>; (RAWIO&lt;&lt;8)|GET_DEVICE_PARAMETERS
<span style="color:black">SYSINIT:1059                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - IOCTL -
<span style="color:black">SYSINIT:105B                 </span><span style="color:navy">jb      short </span><span style="color:gray">nosetbuf  </span>; get next dpb if driver doesn&#039;t support
<span style="color:black">SYSINIT:105B                                         </span>; generic ioctl
<span style="color:black">SYSINIT:105D                 </span><span style="color:navy">mov     bx, </span>devp_totalsecs ; [deviceparameters+15]
<span style="color:black">SYSINIT:105D                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS]
<span style="color:black">SYSINIT:1061                 </span><span style="color:navy">mov     ax, </span>devp_bps    ; [deviceparameters+7]
<span style="color:black">SYSINIT:1061                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_BYTESPERSECTOR]
<span style="color:black">SYSINIT:1064                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">SYSINIT:1066                 </span><span style="color:navy">mov     cx, </span><span style="color:green">512         </span>; scale sector size in factor of 512 bytes
<span style="color:black">SYSINIT:1069                 </span><span style="color:navy">div     cx
</span><span style="color:black">SYSINIT:106B                 </span><span style="color:navy">mul     bx              </span>; ax = #sectors * size factor
<span style="color:black">SYSINIT:106D                 </span><span style="color:navy">or      dx, dx          </span>; just in case of large floppies
<span style="color:black">SYSINIT:106F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setbuf
</span><span style="color:black">SYSINIT:1071                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">720         </span>; 720 sectors * size factor of 1
<span style="color:black">SYSINIT:1074                 </span><span style="color:navy">jbe     short </span><span style="color:gray">nosetbuf
</span><span style="color:black">SYSINIT:1076
SYSINIT:1076 </span><span style="color:gray">setbuf</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1076                 </span><span style="color:navy">mov     </span>buffers<span style="color:navy">, </span><span style="color:#ff8000">3
</span><span style="color:black">SYSINIT:107C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">chk_memsize_for_buffers </span>; now check the memory size
<span style="color:black">SYSINIT:107C                                         </span>; for default buffer count
<span style="color:black">SYSINIT:107E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:107E
SYSINIT:107E </span><span style="color:gray">nosetbuf</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:107E                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [es:bp+DPB.NEXT_DPB],-1
<span style="color:black">SYSINIT:1083                 </span><span style="color:navy">jz      short </span><span style="color:gray">chk_memsize_for_buffers
</span><span style="color:black">SYSINIT:1085                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; les bp,[es:bp+DPB.NEXT_DPB]
<span style="color:black">SYSINIT:1089                 </span><span style="color:navy">jmp     short </span><span style="color:gray">nextdpb
</span><span style="color:black">SYSINIT:108B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:108B
SYSINIT:108B </span><span style="color:gray">chk_memsize_for_buffers</span><span style="color:navy">:                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:108B                 </span><span style="color:navy">cmp     </span>MEMORY_SIZE<span style="color:navy">, </span><span style="color:#ff8000">2000h </span>; 128kb
<span style="color:black">SYSINIT:1091                 </span><span style="color:navy">jbe     short </span><span style="color:gray">bufset
</span><span style="color:black">SYSINIT:1093                 </span><span style="color:navy">mov     </span>buffers<span style="color:navy">, </span><span style="color:#ff8000">5
</span><span style="color:black">SYSINIT:1099                 </span><span style="color:navy">cmp     </span>MEMORY_SIZE<span style="color:navy">, </span><span style="color:#ff8000">4000h </span>; 256kb
<span style="color:black">SYSINIT:109F                 </span><span style="color:navy">jbe     short </span><span style="color:gray">bufset
</span><span style="color:black">SYSINIT:10A1                 </span><span style="color:navy">mov     </span>buffers<span style="color:navy">, </span><span style="color:green">10
</span><span style="color:black">SYSINIT:10A7                 </span><span style="color:navy">cmp     </span>MEMORY_SIZE<span style="color:navy">, </span><span style="color:green">8000h </span>; 512kb
<span style="color:black">SYSINIT:10AD                 </span><span style="color:navy">jbe     short </span><span style="color:gray">bufset
</span><span style="color:black">SYSINIT:10AF                 </span><span style="color:navy">mov     </span>buffers<span style="color:navy">, </span><span style="color:green">15
</span><span style="color:black">SYSINIT:10B5
SYSINIT:10B5 </span><span style="color:gray">bufset</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:10B5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:10B6                 </span>assume ds:nothing
<span style="color:black">SYSINIT:10B6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:10B7
SYSINIT:10B7 </span><span style="color:gray">dobuff</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:10B7                 </span><span style="color:navy">lds     bx, cs:</span>DOSINFO  ; ds:bx -&gt; sysinitvar
<span style="color:black">SYSINIT:10BC                 </span><span style="color:navy">mov     ax, cs:</span>buffers
<span style="color:black">SYSINIT:10C0                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">3Fh</span><span style="color:navy">], ax    </span>; [bx+SYSI_BUFFERS] ; set sysi_buffers
<span style="color:black">SYSINIT:10C3                 </span><span style="color:navy">mov     ax, cs:</span>h_buffers
<span style="color:black">SYSINIT:10C7                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">41h</span><span style="color:navy">], ax    </span>; [bx+SYSI_BUFFERS+2]
<span style="color:black">SYSINIT:10CA                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">12h</span><span style="color:navy">]    </span>; [bx+SYSI_BUF] ; now, ds:bx -&gt; buffinfo
<span style="color:black">SYSINIT:10CD                 </span><span style="color:navy">call    </span>round           ; get [memhi]:[memlo]
<span style="color:black">SYSINIT:10D0                 </span><span style="color:navy">mov     al, &#039;</span><span style="color:green">B&#039;         </span>; devmark_buf
<span style="color:black">SYSINIT:10D2                 </span><span style="color:navy">call    </span>setdevmark
<span style="color:black">SYSINIT:10D5                 </span><span style="color:navy">push    ds              </span>; save buffer info. ptr.
<span style="color:black">SYSINIT:10D6                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:10D7                 </span><span style="color:navy">call    </span>set_buffer
<span style="color:black">SYSINIT:10DA                 </span><span style="color:navy">pop     bx              </span>; restore buffer info. ptr.
<span style="color:black">SYSINIT:10DB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:10DC                 </span><span style="color:navy">cmp     cs:</span>h_buffers<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; set the secondary buffer if specified
<span style="color:black">SYSINIT:10E2                 </span><span style="color:navy">jz      short </span><span style="color:gray">xif16
</span><span style="color:black">SYSINIT:10E4                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:10E7                 </span><span style="color:navy">mov     cx, cs:</span>memlo
<span style="color:black">SYSINIT:10EC                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], cx      </span>; [bx+BUFFINF.Cache_ptr]
<span style="color:black">SYSINIT:10EF                 </span><span style="color:navy">mov     cx, cs:</span>memhi
<span style="color:black">SYSINIT:10F4                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">8</span><span style="color:navy">], cx      </span>; [bx+BUFFINF.Cache_ptr+2]
<span style="color:black">SYSINIT:10F7                 </span><span style="color:navy">mov     cx, cs:</span>h_buffers
<span style="color:black">SYSINIT:10FC                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], cx    </span>; [bx+BUFFINF.Cache_count]
<span style="color:black">SYSINIT:10FF                 </span><span style="color:navy">mov     ax, </span><span style="color:green">512         </span>; 512 bytes
<span style="color:black">SYSINIT:1102                 </span><span style="color:navy">mul     cx
</span><span style="color:black">SYSINIT:1104                 </span><span style="color:navy">mov     cs:</span>memlo<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:1108                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:110E                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:1111
SYSINIT:1111 </span><span style="color:gray">xif16</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1111                 </span><span style="color:navy">call    </span>round           ; buf1
<span style="color:black">SYSINIT:1114                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1115                 </span><span style="color:navy">mov     ax, &#039;</span><span style="color:green">L&#039;         </span>; devmark_cds
<span style="color:black">SYSINIT:1118                 </span><span style="color:navy">call    </span>setdevmark
<span style="color:black">SYSINIT:111B                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:111C                 </span><span style="color:navy">les     di, cs:</span>DOSINFO
<span style="color:black">SYSINIT:1121                 </span><span style="color:navy">mov     cl, es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">] </span>; [es:di+SYSI_NUMIO]
<span style="color:black">SYSINIT:1125                 </span><span style="color:navy">cmp     cl, cs:</span>NUM_CDS
<span style="color:black">SYSINIT:112A                 </span><span style="color:navy">jnb     short </span><span style="color:gray">gotncds   </span>; user setting must be at least numio
<span style="color:black">SYSINIT:112C                 </span><span style="color:navy">mov     cl, cs:</span>NUM_CDS
<span style="color:black">SYSINIT:1131
SYSINIT:1131 </span><span style="color:gray">gotncds</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1131                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">SYSINIT:1133                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">21h</span><span style="color:navy">], cl </span>; [es:di+SYSI_NCDS]
<span style="color:black">SYSINIT:1137                 </span><span style="color:navy">mov     ax, cs:</span>memhi
<span style="color:black">SYSINIT:113B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">18h</span><span style="color:navy">], ax </span>; [es:di+SYSI_CDS+2]
<span style="color:black">SYSINIT:113F                 </span><span style="color:navy">mov     ax, cs:</span>memlo
<span style="color:black">SYSINIT:1143                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">16h</span><span style="color:navy">], ax </span>; [es:di+SYSI_CDS]
<span style="color:black">SYSINIT:1147                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">SYSINIT:1149                 </span><span style="color:navy">mov     ah, </span><span style="color:green">88          </span>; curdirlen ; curdir_list.size
<span style="color:black">SYSINIT:114B                 </span><span style="color:navy">mul     ah
</span><span style="color:black">SYSINIT:114D                 </span><span style="color:navy">call    </span>ParaRound
<span style="color:black">SYSINIT:1150                 </span><span style="color:navy">add     cs:</span>memhi<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:1155                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:115B                 </span><span style="color:navy">call    </span>round           ; check for mem error before initializing
<span style="color:black">SYSINIT:115E                 </span><span style="color:navy">lds     si, es:[di]     </span>; lds si,[es:di+SYSI_DPB] ; [es:di+0]
<span style="color:black">SYSINIT:1161                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">16h</span><span style="color:navy">] </span>; les di,[es:di+SYSI_CDS] ; [es:di+22]
<span style="color:black">SYSINIT:1165                 </span><span style="color:navy">call    </span>fooset          ; Initialize temporary CDSs.
<span style="color:black">SYSINIT:1168                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:1169                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:116A                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:116A                 </span><span style="color:navy">cmp     </span>stack_addr<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; has the user entered &quot;stacks=&quot; command?
<span style="color:black">SYSINIT:116F                 </span><span style="color:navy">jz      short </span><span style="color:gray">doinstallstack </span>; then install as specified by the user
<span style="color:black">SYSINIT:1171                 </span><span style="color:navy">cmp     </span>sys_scnd_model_byte<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; pc1,xt has the secondary model byte = 0
<span style="color:black">SYSINIT:1176                 </span><span style="color:navy">jnz     short </span><span style="color:gray">doinstallstack </span>; other model should have default stack of 9,128
<span style="color:black">SYSINIT:1178                 </span><span style="color:navy">cmp     </span>sys_model_byte<span style="color:navy">, </span><span style="color:#ff8000">0FEh </span>; pc1, pc/xt or pc portable ?
<span style="color:black">SYSINIT:117D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">skipstack
</span><span style="color:black">SYSINIT:117F
SYSINIT:117F </span><span style="color:gray">doinstallstack</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:117F                 </span><span style="color:navy">mov     ax, </span>stack_count ; stack_count = 0?
<span style="color:black">SYSINIT:1182                 </span><span style="color:navy">or      ax, ax          </span>; then, stack size must be 0 too.
<span style="color:black">SYSINIT:1184                 </span><span style="color:navy">jz      short </span><span style="color:gray">skipstack </span>; don&#039;t install stack.
<span style="color:black">SYSINIT:1186                 </span><span style="color:navy">call    </span>round           ; dynamic relocation of stack code.
<span style="color:black">SYSINIT:1189                 </span><span style="color:navy">mov     al, &#039;</span><span style="color:green">S&#039;         </span>; devmark_stk
<span style="color:black">SYSINIT:118B                 </span><span style="color:navy">call    </span>setdevmark
<span style="color:black">SYSINIT:118E                 </span><span style="color:navy">mov     ax, </span>memhi
<span style="color:black">SYSINIT:1191                 </span><span style="color:navy">mov     es, ax          </span>; es -&gt; seg. the stack code is going to move.
<span style="color:black">SYSINIT:1193                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:1194                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1195                 </span><span style="color:navy">xor     si, si          </span>; ! we know that stack code is at the beginning of sysinit.
<span style="color:black">SYSINIT:1197                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">SYSINIT:1199                 </span><span style="color:navy">mov     cx, offset </span>_SYSINIT ; offset endstackcode = offset _SYSINIT
<span style="color:black">SYSINIT:1199                                         </span>; SYSINIT:0269h
<span style="color:black">SYSINIT:119C                 </span><span style="color:navy">mov     </span>memlo<span style="color:navy">, cx
</span><span style="color:black">SYSINIT:11A0                 </span><span style="color:navy">call    </span>round           ; have enough space for relocation?
<span style="color:black">SYSINIT:11A3                 </span><span style="color:navy">rep movsb
</span><span style="color:black">SYSINIT:11A5                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:11A6                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG
<span style="color:black">SYSINIT:11A9                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:11AB                 </span>assume ds:nothing
<span style="color:black">SYSINIT:11AB                 </span><span style="color:navy">mov     ds:</span>NextStack<span style="color:navy">, offset </span>nextentry ; [BIOSDATA:NextStack],
<span style="color:black">SYSINIT:11AB                                         </span>;  offset SYSINIT:nextentry (SYSINIT:0010h)
<span style="color:black">SYSINIT:11B1                 </span><span style="color:navy">mov     ds:</span>NextStack<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:11B5                 </span><span style="color:navy">mov     ax, cs:</span>memlo
<span style="color:black">SYSINIT:11B9                 </span><span style="color:navy">mov     cs:</span>stack_addr<span style="color:navy">, ax </span>; set for stack area initialization
<span style="color:black">SYSINIT:11BD                 </span><span style="color:navy">mov     word ptr ds:</span>IT_StackLoc<span style="color:navy">, ax </span>; pass it as Instance Data, too
<span style="color:black">SYSINIT:11C0                 </span><span style="color:navy">mov     ax, cs:</span>memhi    ; this will be used by stack_init routine.
<span style="color:black">SYSINIT:11C4                 </span><span style="color:navy">mov     cs:</span>stack_addr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:11C8                 </span><span style="color:navy">mov     word ptr ds:</span>IT_StackLoc<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:11CB                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">8           </span>; entrysize
<span style="color:black">SYSINIT:11CE                 </span><span style="color:navy">add     ax, cs:</span>stack_size
<span style="color:black">SYSINIT:11D3                 </span><span style="color:navy">mul     cs:</span>stack_count
<span style="color:black">SYSINIT:11D8                 </span><span style="color:navy">mov     ds:</span>IT_StackSize<span style="color:navy">, ax </span>; pass through to Instance Table
<span style="color:black">SYSINIT:11DB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:11DC                 </span>assume ds:nothing
<span style="color:black">SYSINIT:11DC                 </span><span style="color:navy">call    </span>ParaRound
<span style="color:black">SYSINIT:11DF                 </span><span style="color:navy">add     cs:</span>memhi<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:11E4                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:11E4                                         </span>; to set the devmark_size for stack by round routine.
<span style="color:black">SYSINIT:11EA                 </span><span style="color:navy">call    </span>round           ; check for memory error before continuing
<span style="color:black">SYSINIT:11ED                 </span><span style="color:navy">call    </span>stackinit       ; initialize hardware stack.
<span style="color:black">SYSINIT:11ED                                         </span>; cs=ds=sysinitseg,es=relocated stack code &amp; data
<span style="color:black">SYSINIT:11F0
SYSINIT:11F0 </span><span style="color:gray">skipstack</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:11F0                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:11F1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:11F2                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:11F2                 </span><span style="color:navy">cmp     </span>dosdata_umb<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; PCDOS 7 feature - DOSDATA=UMB/NOUMB configuration
<span style="color:black">SYSINIT:11F2                                         </span>; 1 = DOSDATA=UMB, 2 = (UMB) done, 0 = NOUMB
<span style="color:black">SYSINIT:11F7                 </span><span style="color:navy">ja      short </span><span style="color:gray">dosdata_umb_done </span>; 2 - done
<span style="color:black">SYSINIT:11F9                 </span><span style="color:navy">jb      short </span><span style="color:gray">dosdata_noumb </span>; 0 - DOSDATA=NOUMB
<span style="color:black">SYSINIT:11FB                 </span><span style="color:navy">cmp     byte ptr </span>setdevmark<span style="color:navy">, </span><span style="color:#ff8000">0EAh
</span><span style="color:black">SYSINIT:1200                 </span><span style="color:navy">jz      short </span><span style="color:gray">dosdata_noumb
</span><span style="color:black">SYSINIT:1202                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5802h
</span><span style="color:black">SYSINIT:1205                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:1205                                         </span>; AL = function code: (DOS 5beta) get UMB link state
<span style="color:black">SYSINIT:1207                 </span><span style="color:navy">cbw
</span><span style="color:black">SYSINIT:1208                 </span><span style="color:navy">mov     di, ax          </span>; al = 01h -&gt; UMBs in DOS memory chain
<span style="color:black">SYSINIT:1208                                         </span>; save current (previous) UMB link state
<span style="color:black">SYSINIT:120A                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1           </span>; bx = 01h -&gt; add UMBs to DOS memory chain
<span style="color:black">SYSINIT:120D                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5803h
</span><span style="color:black">SYSINIT:1210                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:1210                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:1212                 </span><span style="color:navy">jb      short </span><span style="color:gray">dosdata_noumb
</span><span style="color:black">SYSINIT:1214                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5800h
</span><span style="color:black">SYSINIT:1217                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:1217                                         </span>; AL = function code: get allocation strategy
<span style="color:black">SYSINIT:1219                 </span><span style="color:navy">mov     si, ax          </span>; ax = current strategy
<span style="color:black">SYSINIT:1219                                         </span>; save current (previous) allocation strategy
<span style="color:black">SYSINIT:121B                 </span><span style="color:navy">mov     bx, </span><span style="color:green">40h         </span>; bl = new strategy = 40h - high memory first fit
<span style="color:black">SYSINIT:121E                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5801h
</span><span style="color:black">SYSINIT:1221                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:1221                                         </span>; AL = function code: set allocation strategy
<span style="color:black">SYSINIT:1223                 </span><span style="color:navy">mov     bx, </span>memhi
<span style="color:black">SYSINIT:1227                 </span><span style="color:navy">sub     bx, </span>prev_memhi
<span style="color:black">SYSINIT:122B                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">SYSINIT:122D                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:122D                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:122F                 </span><span style="color:navy">mov     cx, ax          </span>; ax = segment of allocated block
<span style="color:black">SYSINIT:1231                 </span><span style="color:navy">mov     bx, di          </span>; restore previous UMB link state
<span style="color:black">SYSINIT:1233                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5803h
</span><span style="color:black">SYSINIT:1236                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:1236                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:1238                 </span><span style="color:navy">mov     bx, si          </span>; restore previous allocation strategy
<span style="color:black">SYSINIT:123A                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5801h
</span><span style="color:black">SYSINIT:123D                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:123D                                         </span>; AL = function code: set allocation strategy
<span style="color:black">SYSINIT:123F                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">0A000h      </span>; Is the allocated memory block (segment) a UMB?
<span style="color:black">SYSINIT:1243                 </span><span style="color:navy">jb      short </span><span style="color:gray">dosdata_noumb </span>; no
<span style="color:black">SYSINIT:1245                 </span><span style="color:navy">mov     </span>ALLOCLIM<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:124B                 </span><span style="color:navy">mov     </span>memlo<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:1251                 </span><span style="color:navy">mov     </span>memhi<span style="color:navy">, cx
</span><span style="color:black">SYSINIT:1255                 </span><span style="color:navy">dec     cx
</span><span style="color:black">SYSINIT:1256                 </span><span style="color:navy">mov     es, cx          </span>; point to arena/mcb
<span style="color:black">SYSINIT:1258                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:arena_owner], 8 ; set impossible owner
<span style="color:black">SYSINIT:125F                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4453h </span>; [es:arena_name],&#039;SD&#039; ; System Data
<span style="color:black">SYSINIT:1266                 </span><span style="color:navy">inc     </span>dosdata_umb     ; 1 -&gt; 2 ; DOSDATA=UMB done.
<span style="color:black">SYSINIT:126A                 </span><span style="color:navy">jmp     </span><span style="color:gray">dosfts
</span><span style="color:black">SYSINIT:126D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:126D
SYSINIT:126D </span><span style="color:gray">dosdata_umb_done</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:126D                 </span><span style="color:navy">mov     ax, </span>prev_memhi  ; (recent memory block/segment before UMBs)
<span style="color:black">SYSINIT:1270                 </span><span style="color:navy">mov     </span>memhi<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:1273                 </span><span style="color:navy">mov     ax, </span>prev_alloclim
<span style="color:black">SYSINIT:1276                 </span><span style="color:navy">mov     </span>ALLOCLIM<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:1279
SYSINIT:1279 </span><span style="color:gray">dosdata_noumb</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1279                 </span><span style="color:navy">mov     al, </span>FILES
<span style="color:black">SYSINIT:127C                 </span><span style="color:navy">xor     ah, ah          </span>; do not use cbw instruction!
<span style="color:black">SYSINIT:127C                                         </span>; it does sign extend.
<span style="color:black">SYSINIT:127E                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:1280                 </span><span style="color:navy">xor     bx, bx          </span>; close standard input
<span style="color:black">SYSINIT:1282                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:black">SYSINIT:1284                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:black">SYSINIT:1284                                         </span>; BX = file handle
<span style="color:black">SYSINIT:1286                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">2           </span>; close everybody but standard output
<span style="color:black">SYSINIT:1286                                         </span>; need output so we can print message
<span style="color:black">SYSINIT:1286                                         </span>;  in case we can&#039;t get new one open.
<span style="color:black">SYSINIT:1289
SYSINIT:1289 </span><span style="color:gray">rcclloop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1289                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:black">SYSINIT:128B                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:black">SYSINIT:128B                                         </span>; BX = file handle
<span style="color:black">SYSINIT:128D                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:128E                 </span><span style="color:navy">loop    </span><span style="color:gray">rcclloop
</span><span style="color:black">SYSINIT:1290                 </span><span style="color:navy">mov     dx, offset </span>condev <span style="color:gray">; &quot;CON&quot;
</span><span style="color:black">SYSINIT:1293                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:1295                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Dh         </span>; open con for read/write
<span style="color:black">SYSINIT:1297                 </span><span style="color:navy">stc                     </span>; set for possible int 24
<span style="color:black">SYSINIT:1298                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - OPEN DISK FILE WITH HANDLE
<span style="color:black">SYSINIT:1298                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:black">SYSINIT:1298                                         </span>; AL = access mode
<span style="color:black">SYSINIT:1298                                         </span>; 2 - read &amp; write
<span style="color:black">SYSINIT:129A                 </span><span style="color:navy">jnb     short </span><span style="color:gray">goaux
</span><span style="color:black">SYSINIT:129C                 </span><span style="color:navy">call    </span>badfil
<span style="color:black">SYSINIT:129F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">goaux2
</span><span style="color:black">SYSINIT:12A1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:12A1
SYSINIT:12A1 </span><span style="color:gray">goaux</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:12A1                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:12A2                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1           </span>; close standard output
<span style="color:black">SYSINIT:12A5                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:black">SYSINIT:12A7                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:black">SYSINIT:12A7                                         </span>; BX = file handle
<span style="color:black">SYSINIT:12A9                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:12AA                 </span><span style="color:navy">mov     bx, ax          </span>; new device handle
<span style="color:black">SYSINIT:12AC                 </span><span style="color:navy">mov     ah, </span><span style="color:green">45h         </span>; XDUP ; dup to 1, stdout
<span style="color:black">SYSINIT:12AE                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CREATE DUPLICATE HANDLE (DUP)
<span style="color:black">SYSINIT:12AE                                         </span>; BX = file handle to duplicate
<span style="color:black">SYSINIT:12B0                 </span><span style="color:navy">mov     ah, </span><span style="color:green">45h         </span>; XDUP ; dup to 2, stderr
<span style="color:black">SYSINIT:12B2                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CREATE DUPLICATE HANDLE (DUP)
<span style="color:black">SYSINIT:12B2                                         </span>; BX = file handle to duplicate
<span style="color:black">SYSINIT:12B4
SYSINIT:12B4 </span><span style="color:gray">goaux2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:12B4                 </span><span style="color:navy">mov     dx, offset </span>auxdev <span style="color:gray">; &quot;AUX&quot;
</span><span style="color:black">SYSINIT:12B7                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; read/write access
<span style="color:black">SYSINIT:12B9                 </span><span style="color:navy">call    </span>open_dev
<span style="color:black">SYSINIT:12BC                 </span><span style="color:navy">mov     dx, offset </span>prndev <span style="color:gray">; &quot;PRN&quot;
</span><span style="color:black">SYSINIT:12BF                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; write only
<span style="color:black">SYSINIT:12C1                 </span><span style="color:navy">call    </span>open_dev
<span style="color:black">SYSINIT:12C4                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:12C5                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:12C6                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:12C7                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:12C8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; reset h/w by writing to port
<span style="color:black">SYSINIT:12CA                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">2F2h        </span>; get starting address
<span style="color:black">SYSINIT:12CD                 </span><span style="color:navy">out     dx, al          </span>; out 02f2h,0ffh
<span style="color:black">SYSINIT:12CE                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12CF                 </span><span style="color:navy">out     dx, al
</span><span style="color:black">SYSINIT:12D0                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12D1                 </span><span style="color:navy">out     dx, al
</span><span style="color:black">SYSINIT:12D2                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12D3                 </span><span style="color:navy">out     dx, al
</span><span style="color:black">SYSINIT:12D4                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12D5                 </span><span style="color:navy">out     dx, al
</span><span style="color:black">SYSINIT:12D6                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12D7                 </span><span style="color:navy">out     dx, al          </span>; out 02f7h,0ffh
<span style="color:black">SYSINIT:12D8                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h      </span>; get machine type
<span style="color:black">SYSINIT:12DB                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:12DD                 </span>assume es:nothing
<span style="color:black">SYSINIT:12DD                 </span><span style="color:navy">cmp     byte ptr es:</span><span style="color:green">0FFFEh</span><span style="color:navy">, </span><span style="color:#ff8000">0FCh </span>; is it a AT type machine
<span style="color:black">SYSINIT:12E3                 </span><span style="color:navy">jz      short </span><span style="color:gray">startrearm </span>; *if AT no need to check
<span style="color:black">SYSINIT:12E5                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0C0h
</span><span style="color:black">SYSINIT:12E7                 </span><span style="color:navy">int     </span><span style="color:green">15h             </span>; SYSTEM - GET CONFIGURATION
<span style="color:black">SYSINIT:12E7                                         </span>; (XT after 1/10/86,AT mdl 3x9,CONV,XT286,PS)
<span style="color:black">SYSINIT:12E9                 </span><span style="color:navy">jb      short </span><span style="color:gray">finishrearm </span>; *jmp if old rom
<span style="color:black">SYSINIT:12EB                 </span><span style="color:navy">test    byte ptr es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [es:bx+ROMBIOS_DESC.bios_sd_featurebyte1],
<span style="color:black">SYSINIT:12EB                                         </span>; ScndIntController
<span style="color:black">SYSINIT:12F0                 </span><span style="color:navy">jz      short </span><span style="color:gray">finishrearm
</span><span style="color:black">SYSINIT:12F2
SYSINIT:12F2 </span><span style="color:gray">startrearm</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:12F2                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; write any pattern to port
<span style="color:black">SYSINIT:12F4                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">6F2h        </span>; get starting address
<span style="color:black">SYSINIT:12F7                 </span><span style="color:navy">out     dx, al
</span><span style="color:black">SYSINIT:12F8                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12F9                 </span><span style="color:navy">out     dx, al          </span>; out 06f3h,0ffh
<span style="color:black">SYSINIT:12FA                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12FB                 </span><span style="color:navy">out     dx, al          </span>; out 06f4h,0ffh
<span style="color:black">SYSINIT:12FC                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12FD                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:12FE                 </span><span style="color:navy">out     dx, al          </span>; out 06f6h,0ffh
<span style="color:black">SYSINIT:12FF                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:1300                 </span><span style="color:navy">out     dx, al          </span>; out 06f7h,0ffh
<span style="color:black">SYSINIT:1301
SYSINIT:1301 </span><span style="color:gray">finishrearm</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1301                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:1302                 </span>assume es:nothing
<span style="color:black">SYSINIT:1302                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1303                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1304                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1305
SYSINIT:1305 </span>set_sysinit_base<span style="color:navy">:                       </span>; sysinit_base will be established
<span style="color:black">SYSINIT:1305                 </span><span style="color:navy">push    ax              </span>; in the secure area of lower memory
<span style="color:black">SYSINIT:1305                                         </span>; when it handles the first install= command.
<span style="color:black">SYSINIT:1305                                         </span>; if sysinit module (in high memory) has been broken,
<span style="color:black">SYSINIT:1305                                         </span>; then &quot;memory error...&quot; message is displayed
<span style="color:black">SYSINIT:1305                                         </span>; by sysinit_base
<span style="color:black">SYSINIT:1306                 </span><span style="color:navy">mov     ax, </span>memhi
<span style="color:black">SYSINIT:1309                 </span><span style="color:navy">sub     ax, </span>area
<span style="color:black">SYSINIT:130D                 </span><span style="color:navy">mov     </span>impossible_owner_size<span style="color:navy">, ax </span>; remember the size in case.
<span style="color:black">SYSINIT:1310                 </span><span style="color:navy">mov     al, &#039;</span><span style="color:green">T&#039;         </span>; devmark_inst
<span style="color:black">SYSINIT:1312                 </span><span style="color:navy">call    </span>setdevmark
<span style="color:black">SYSINIT:1315                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1316                 </span><span style="color:navy">mov     di, </span>memhi
<span style="color:black">SYSINIT:131A                 </span><span style="color:navy">mov     es, di
</span><span style="color:black">SYSINIT:131C                 </span><span style="color:navy">mov     word ptr </span>sysinit_base_ptr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, di </span>; save this entry for the next use.
<span style="color:black">SYSINIT:1320                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">SYSINIT:1322                 </span><span style="color:navy">mov     word ptr </span>sysinit_base_ptr<span style="color:navy">, di </span>; es:di -&gt; destination.
<span style="color:black">SYSINIT:1326                 </span><span style="color:navy">mov     si, offset </span>sysinit_base ; ds:si -&gt; source code to be relocated.
<span style="color:black">SYSINIT:1329                 </span><span style="color:navy">mov     cx, </span><span style="color:green">129         </span>; end_sysinit_base-sysinit_base ; 129
<span style="color:black">SYSINIT:132C                 </span><span style="color:navy">add     </span>memlo<span style="color:navy">, cx
</span><span style="color:black">SYSINIT:1330                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:1336                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:1339                 </span><span style="color:navy">rep movsb
</span><span style="color:black">SYSINIT:133B                 </span><span style="color:navy">mov     </span>sysinit_ptr<span style="color:navy">, offset </span>sysinitptr ; returning address from
<span style="color:black">SYSINIT:133B                                         </span>; sysinit_base back to sysinit
<span style="color:black">SYSINIT:1341                 </span><span style="color:navy">mov     </span>sysinit_ptr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cs
</span><span style="color:black">SYSINIT:1345                 </span><span style="color:navy">or      </span>install_flag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:134A                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:134D                 </span><span style="color:navy">mov     bx, </span>memhi
<span style="color:black">SYSINIT:1351                 </span><span style="color:navy">mov     ax, </span>area
<span style="color:black">SYSINIT:1354                 </span><span style="color:navy">mov     </span>old_area<span style="color:navy">, ax    </span>; save [area]
<span style="color:black">SYSINIT:1357                 </span><span style="color:navy">mov     es, ax          </span>; calc what we needed
<span style="color:black">SYSINIT:1359                 </span><span style="color:navy">sub     bx, ax
</span><span style="color:black">SYSINIT:135B                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4Ah         </span>; SETBLOCK
<span style="color:black">SYSINIT:135D                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
<span style="color:black">SYSINIT:135D                                         </span>; ES = segment address of block to change
<span style="color:black">SYSINIT:135D                                         </span>; BX = new size in paragraphs
<span style="color:black">SYSINIT:135F                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:1360                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:1362                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:1363                 </span><span style="color:navy">mov     es, ax          </span>; point to arena
<span style="color:black">SYSINIT:1365                 </span>assume es:nothing
<span style="color:black">SYSINIT:1365                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER],8 ; set impossible owner
<span style="color:black">SYSINIT:136C                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4453h </span>; [es:ARENA.NAME],&#039;SD&#039; ; System Data
<span style="color:black">SYSINIT:1373                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:1374                 </span>assume es:nothing
<span style="color:black">SYSINIT:1374                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:1377                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">SYSINIT:1379                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:1379                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:137B                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h         </span>; allocate the rest of the memory
<span style="color:black">SYSINIT:137D                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:137D                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:137F                 </span><span style="color:navy">mov     </span>memhi<span style="color:navy">, ax       </span>; start of the allocated memory
<span style="color:black">SYSINIT:1382                 </span><span style="color:navy">mov     </span>memlo<span style="color:navy">, </span><span style="color:#ff8000">0        </span>; to be used next.
<span style="color:black">SYSINIT:1388                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:138A                 </span><span style="color:navy">mov     bx, </span>CONFBOT
<span style="color:black">SYSINIT:138E                 </span><span style="color:navy">sub     bx, ax          </span>; confbot - memhi
<span style="color:black">SYSINIT:1390                 </span><span style="color:navy">dec     bx              </span>; make a room for the memory block id.
<span style="color:black">SYSINIT:1391                 </span><span style="color:navy">dec     bx              </span>; make sure!
<span style="color:black">SYSINIT:1392                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4Ah         </span>; this will free (confbot to top of memory)
<span style="color:black">SYSINIT:1394                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
<span style="color:black">SYSINIT:1394                                         </span>; ES = segment address of block to change
<span style="color:black">SYSINIT:1394                                         </span>; BX = new size in paragraphs
<span style="color:black">SYSINIT:1396                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:1399                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h
</span><span style="color:black">SYSINIT:139B                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:139B                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:139D                 </span><span style="color:navy">mov     ah, </span><span style="color:green">48h         </span>; allocate (confbot to top of memory)
<span style="color:black">SYSINIT:139F                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:139F                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:13A1                 </span><span style="color:navy">mov     </span>area<span style="color:navy">, ax        </span>; save allocated memory segment.
<span style="color:black">SYSINIT:13A1                                         </span>; need this to free this area for command.com.
<span style="color:black">SYSINIT:13A4                 </span><span style="color:navy">mov     es, </span>memhi
<span style="color:black">SYSINIT:13A8                 </span><span style="color:navy">mov     ah, </span><span style="color:green">49h         </span>; free allocated memory
<span style="color:black">SYSINIT:13A8                                         </span>; free (memhi to confbot(=area))
<span style="color:black">SYSINIT:13AA                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - FREE MEMORY
<span style="color:black">SYSINIT:13AA                                         </span>; ES = segment address of area to be freed
<span style="color:black">SYSINIT:13AC                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:13AC </span>endfile         <span style="color:black">endp
SYSINIT:13AC
SYSINIT:13AD
SYSINIT:13AD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:13AD
SYSINIT:13AD
SYSINIT:13AD </span>do_install_exec <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:13AD                 </span><span style="color:navy">push    si              </span>; EXEC a program being loaded via the
<span style="color:black">SYSINIT:13AD                                         </span>; &quot;install=&quot; mechanism in config.sys
<span style="color:black">SYSINIT:13AE                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:13AF                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:13B0                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:13B1                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:13B1                 </span><span style="color:navy">pop     ds              </span>; es-&gt;sysinitseg,ds-&gt;confbot seg
<span style="color:black">SYSINIT:13B2                 </span>assume ds:nothing
<span style="color:black">SYSINIT:13B2                 </span><span style="color:navy">mov     dx, si          </span>; ds:dx-&gt;file name,0 in config.sys image.
<span style="color:black">SYSINIT:13B4                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:13B6                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:13B7                 </span><span style="color:navy">mov     cs:</span>ldexec_start<span style="color:navy">, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039; </span>; clear out the parm area
<span style="color:black">SYSINIT:13BD                 </span><span style="color:navy">mov     di, offset </span>ldexec_parm
<span style="color:black">SYSINIT:13C0
SYSINIT:13C0 </span><span style="color:gray">installfilename</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:13C0                 </span><span style="color:navy">lodsb                   </span>; skip the file name
<span style="color:black">SYSINIT:13C0                                         </span>; al = ds:si; si++
<span style="color:black">SYSINIT:13C1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:13C3                 </span><span style="color:navy">jz      short </span><span style="color:gray">got_installparm
</span><span style="color:black">SYSINIT:13C5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">installfilename
</span><span style="color:black">SYSINIT:13C7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:13C7
SYSINIT:13C7 </span><span style="color:gray">got_installparm</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:13C7                 </span><span style="color:navy">lodsb                   </span>; copy the parameters to ldexec_parm
<span style="color:black">SYSINIT:13C8                 </span><span style="color:navy">mov     es:[di], al
</span><span style="color:black">SYSINIT:13CB                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf ; line feed?
<span style="color:black">SYSINIT:13CD                 </span><span style="color:navy">jz      short </span><span style="color:gray">done_installparm
</span><span style="color:black">SYSINIT:13CF                 </span><span style="color:navy">inc     cl              </span>; # of char. in the parm.
<span style="color:black">SYSINIT:13D1                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:13D2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">got_installparm
</span><span style="color:black">SYSINIT:13D4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:13D4
SYSINIT:13D4 </span><span style="color:gray">done_installparm</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:13D4                 </span><span style="color:navy">mov     cs:</span>ldexec_line<span style="color:navy">, cl </span>; length of the parm.
<span style="color:black">SYSINIT:13D9                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">0           </span>; if no parm,then
<span style="color:black">SYSINIT:13DC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">install_seg_set </span>; let the parm area
<span style="color:black">SYSINIT:13DE                 </span><span style="color:navy">mov     cs:</span>ldexec_start<span style="color:navy">, </span><span style="color:#ff8000">0Dh </span>; cr ; starts with cr.
<span style="color:black">SYSINIT:13E4
SYSINIT:13E4 </span><span style="color:gray">install_seg_set</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:13E4                 </span><span style="color:navy">mov     </span>cs:0<span style="color:navy">, </span><span style="color:#ff8000">0         </span>; make a null environment segment
<span style="color:black">SYSINIT:13EB                 </span><span style="color:navy">mov     ax, cs          </span>; by overlap jmp instruction of sysinitseg.
<span style="color:black">SYSINIT:13ED                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:13EF                 </span><span style="color:navy">cmp     cs:</span>config_envlen<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:13F5                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_envdata2
</span><span style="color:black">SYSINIT:13F7                 </span><span style="color:navy">mov     cx, cs:</span>config_wrkseg
<span style="color:black">SYSINIT:13FC
SYSINIT:13FC </span><span style="color:gray">no_envdata2</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:13FC                 </span><span style="color:navy">mov     cs:</span>iexec_environ<span style="color:navy">, cx </span>; [cs:instexe.exec0_environ]
<span style="color:black">SYSINIT:13FC                                         </span>; set the environment seg.
<span style="color:black">SYSINIT:1401                 </span><span style="color:navy">mov     cs:</span>iexec_ldexec_line_seg<span style="color:navy">, ax </span>; [cs:instexe.exec0_com_line+2]
<span style="color:black">SYSINIT:1401                                         </span>; set the seg.
<span style="color:black">SYSINIT:1405                 </span><span style="color:navy">mov     cs:</span>iexec_ldexec_5c_fcb_seg<span style="color:navy">, ax </span>; [cs:instexe.exec0_5c_fcb+2
<span style="color:black">SYSINIT:1409                 </span><span style="color:navy">mov     cs:</span>iexec_ldexec_6c_fcb_seg<span style="color:navy">, ax </span>; [cs:instexe.exec0_6c_fcb+2]]
<span style="color:black">SYSINIT:140D                 </span><span style="color:navy">call    </span>sum_up
<span style="color:black">SYSINIT:1410                 </span><span style="color:navy">mov     es:</span>checksum<span style="color:navy">, ax </span>; save the value of the sum
<span style="color:black">SYSINIT:1414                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:1416                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4Bh         </span>; EXEC ; load/exec
<span style="color:black">SYSINIT:1418                 </span><span style="color:navy">mov     bx, offset </span>iexec_environ ; instexe ; es:bx -&gt; parm block.
<span style="color:black">SYSINIT:141B                 </span><span style="color:navy">push    es              </span>; save es,ds for load/exec
<span style="color:black">SYSINIT:141C                 </span><span style="color:navy">push    ds              </span>; these registers will be restored in sysinit_base.
<span style="color:black">SYSINIT:141D                 </span><span style="color:navy">jmp     cs:</span>sysinit_base_ptr ; jmp to sysinit_base to execute
<span style="color:black">SYSINIT:141D </span>do_install_exec <span style="color:black">endp                    </span>; load/exec function and check sum.
<span style="color:black">SYSINIT:141D
</span><span style="color:maroon">SYSINIT:1422 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:1422
SYSINIT:1422 </span>sysinitptr<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:1422                 </span><span style="color:navy">pop     si              </span>; returning far address from sysinit_base
<span style="color:maroon">SYSINIT:1422                                         </span>; restore si for config.sys file.
<span style="color:maroon">SYSINIT:1423                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:1424                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:1425                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:1426                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:1426                 </span><span style="color:navy">pop     ds              </span>; now ds - sysinitseg, es - confbot
<span style="color:maroon">SYSINIT:1427                 </span><span style="color:navy">jnb     short </span>install_exit_ret
<span style="color:maroon">SYSINIT:1429                 </span><span style="color:navy">push    si              </span>; error in loading the file for install=.
<span style="color:maroon">SYSINIT:142A                 </span><span style="color:navy">call    </span>badload         ; es:si-&gt; path,filename,0.
<span style="color:maroon">SYSINIT:142D                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">SYSINIT:142E
SYSINIT:142E </span>install_exit_ret<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:142E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:142F
SYSINIT:142F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:142F
SYSINIT:142F
SYSINIT:142F </span>ParaRound       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:142F                 </span><span style="color:navy">add     ax, </span><span style="color:green">15          </span>; round up length in paragraphs
<span style="color:black">SYSINIT:142F                                         </span>; 0Fh
<span style="color:black">SYSINIT:1432                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:1434                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:1436                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:1438                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:143A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:143A </span>ParaRound       <span style="color:black">endp
SYSINIT:143A
</span><span style="color:maroon">SYSINIT:143B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:143B
SYSINIT:143B </span>sysinit_base<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:143B                 </span><span style="color:navy">mov     </span>word ptr cs:sysinit_base_ss<span style="color:navy">, ss </span>; sysinit_base module
<span style="color:maroon">SYSINIT:1440                 </span><span style="color:navy">mov     </span>word ptr cs:sysinit_base_sp<span style="color:navy">, sp
</span><span style="color:maroon">SYSINIT:1445                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; load/exec dos call.
<span style="color:maroon">SYSINIT:1447                 </span><span style="color:navy">mov     ss, </span>word ptr cs:sysinit_base_ss ; restore stack
<span style="color:maroon">SYSINIT:144C                 </span>assume ss:nothing
<span style="color:maroon">SYSINIT:144C                 </span><span style="color:navy">mov     sp, </span>word ptr cs:sysinit_base_sp
<span style="color:maroon">SYSINIT:1451                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:1452                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:1453                 </span><span style="color:navy">jb      short </span>sysinit_base_end
<span style="color:maroon">SYSINIT:1455                 </span><span style="color:navy">call    </span>sum_up
<span style="color:maroon">SYSINIT:1458                 </span><span style="color:navy">cmp     es:</span>checksum<span style="color:navy">, ax
</span><span style="color:maroon">SYSINIT:145D                 </span><span style="color:navy">jz      short </span>sysinit_base_end
<span style="color:maroon">SYSINIT:145F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">9           </span>; memory broken.
<span style="color:maroon">SYSINIT:145F                                         </span>; show &quot;memory allocation error&quot; message and stall.
<span style="color:maroon">SYSINIT:1461                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:1462                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:1463                 </span>assume ds:SYSINIT
<span style="color:maroon">SYSINIT:1463                 </span><span style="color:navy">mov     dx, </span><span style="color:green">102         </span>; mem_alloc_err_msgx-sysinit_base ; 66h
<span style="color:maroon">SYSINIT:1466                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - PRINT STRING
<span style="color:maroon">SYSINIT:1466                                         </span>; DS:DX -&gt; string terminated by &quot;$&quot;
<span style="color:black">SYSINIT:1468 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR AllocMemForDOS
</span><span style="color:black">SYSINIT:1468 </span><span style="color:gray">;   ADDITIONAL PARENT FUNCTION round
</span><span style="color:black">SYSINIT:1468
SYSINIT:1468 </span>stall<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1468                 </span><span style="color:navy">hlt                     </span>; use HLT to minimize energy consumption
<span style="color:black">SYSINIT:1468 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR AllocMemForDOS
</span><span style="color:maroon">SYSINIT:1469 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:1469                 </span><span style="color:navy">jmp     short </span>stall
<span style="color:maroon">SYSINIT:146B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:146B
SYSINIT:146B </span>sysinit_base_end<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:146B                 </span><span style="color:navy">jmp     dword ptr es:</span>sysinit_ptr ; return back to sysinit module
<span style="color:black">SYSINIT:1470
SYSINIT:1470 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1470
SYSINIT:1470
SYSINIT:1470 </span>sum_up          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1470                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1471                 </span><span style="color:navy">mov     ax, es:</span>CONFBOT
<span style="color:black">SYSINIT:1475                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:1477                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1477                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">SYSINIT:1479                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:147B                 </span><span style="color:navy">mov     cx, es:</span>config_size ; if config_size has been broken, then this
<span style="color:black">SYSINIT:147B                                         </span>; whole test better fail.
<span style="color:black">SYSINIT:1480                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:1482                 </span><span style="color:navy">jz      short </span><span style="color:gray">sum_sys_code </span>; when config.sys file not exist.
<span style="color:black">SYSINIT:1484
SYSINIT:1484 </span><span style="color:gray">sum1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1484                 </span><span style="color:navy">add     ax, [si]
</span><span style="color:black">SYSINIT:1486                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:1487                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:1488                 </span><span style="color:navy">loop    </span><span style="color:gray">sum1
</span><span style="color:black">SYSINIT:148A
SYSINIT:148A </span><span style="color:gray">sum_sys_code</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:148A                 </span><span style="color:navy">mov     si, offset </span>locstack ; 586h
<span style="color:black">SYSINIT:148A                                         </span>; starting after the stack.
<span style="color:black">SYSINIT:148A                                         </span>; this does not cover the possible stack code!
<span style="color:black">SYSINIT:148D                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5B40h       </span>; SI_end (23360)
<span style="color:black">SYSINIT:148D                                         </span>; SI_end is the label at the end of sysinit
<span style="color:black">SYSINIT:148D                                         </span>; from after_checksum to SI_end
<span style="color:black">SYSINIT:1490                 </span><span style="color:navy">sub     cx, si
</span><span style="color:black">SYSINIT:1492                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:1494
SYSINIT:1494 </span><span style="color:gray">sum2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1494                 </span><span style="color:navy">add     ax, es:[si]
</span><span style="color:black">SYSINIT:1497                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:1498                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:1499                 </span><span style="color:navy">loop    </span><span style="color:gray">sum2
</span><span style="color:black">SYSINIT:149B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:149C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:149C </span>sum_up          <span style="color:black">endp
SYSINIT:149C
SYSINIT:149C </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:149D </span>sysinit_base_ssx <span style="color:navy">dw </span><span style="color:#008040">0                   </span>; sysinit_base_ss equ $-sysinit_base ; 62
<span style="color:gray">SYSINIT:149F </span>sysinit_base_spx <span style="color:navy">dw </span><span style="color:#008040">0                   </span>; sysinit_base_sp equ $-sysinit_base ; 64
<span style="color:gray">SYSINIT:14A1 </span>mem_alloc_err_msgx <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah
</span><span style="color:gray">SYSINIT:14A1                 </span><span style="color:navy">db &#039;Memory allocation error $&#039;
</span><span style="color:black">SYSINIT:14BC
SYSINIT:14BC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:14BC
SYSINIT:14BC
SYSINIT:14BC </span>set_buffer      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:14BC                 </span><span style="color:navy">xor     dl, dl          </span>; input:
<span style="color:black">SYSINIT:14BC                                         </span>;   ds:bx -&gt; buffinfo.
<span style="color:black">SYSINIT:14BC                                         </span>;   [memhi]:[memlo=0] = available space for the hash bucket.
<span style="color:black">SYSINIT:14BC                                         </span>;   singlebuffersize = buff header size + sector size
<span style="color:black">SYSINIT:14BC                                         </span>; output:
<span style="color:black">SYSINIT:14BC                                         </span>;   buffers Queue established.
<span style="color:black">SYSINIT:14BC                                         </span>;   [memhi]:[memlo] = addr of the next available free space.
<span style="color:black">SYSINIT:14BC                                         </span>;
<span style="color:black">SYSINIT:14BC                                         </span>; assume buffers not in HMA
<span style="color:black">SYSINIT:14BE                 </span><span style="color:navy">call    </span>GetBufferAddr
<span style="color:black">SYSINIT:14C1                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_buff_1
</span><span style="color:black">SYSINIT:14C3                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">1           </span>; buffers in HMA
<span style="color:black">SYSINIT:14C5
SYSINIT:14C5 </span><span style="color:gray">set_buff_1</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:14C5                 </span><span style="color:navy">mov     [bx], di        </span>; [bx+BUFFINF.Buff_Queue] ; head of Buff Q
<span style="color:black">SYSINIT:14C7                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], es </span>; [bx+BUFFINF.Buff_Queue+2]
<span style="color:black">SYSINIT:14CA                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [bx+BUFFINF.Dirty_Buff_Count] ; set dirty_count to 0.
<span style="color:black">SYSINIT:14CF                 </span><span style="color:navy">mov     ax, di
</span><span style="color:black">SYSINIT:14D1                 </span><span style="color:navy">mov     cx, cs:</span>buffers
<span style="color:black">SYSINIT:14D6                 </span><span style="color:navy">push    di              </span>; remember first buffer
<span style="color:black">SYSINIT:14D7
SYSINIT:14D7 </span><span style="color:gray">nxt_buff</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:14D7                 </span><span style="color:navy">call    </span>set_buffer_info ; set buf_link,buf_id...
<span style="color:black">SYSINIT:14DA                 </span><span style="color:navy">mov     di, ax
</span><span style="color:black">SYSINIT:14DC                 </span><span style="color:navy">loop    </span><span style="color:gray">nxt_buff
</span><span style="color:black">SYSINIT:14DE                 </span><span style="color:navy">sub     di, cs:</span>singlebuffersize ; point to last buffer
<span style="color:black">SYSINIT:14E3                 </span><span style="color:navy">pop     cx              </span>; get first buffer
<span style="color:black">SYSINIT:14E4                 </span><span style="color:navy">mov     es:[di], cx     </span>; [es:di+buffinfo.buf_next] ; last-&gt;next = first
<span style="color:black">SYSINIT:14E7                 </span><span style="color:navy">xchg    cx, di
</span><span style="color:black">SYSINIT:14E9                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], cx   </span>; [es:di+buffinfo.buf_prev] ; first-&gt;prev = last
<span style="color:black">SYSINIT:14ED                 </span><span style="color:navy">or      dl, dl          </span>; In HMa ?
<span style="color:black">SYSINIT:14EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_buff_2 </span>; no
<span style="color:black">SYSINIT:14F1                 </span><span style="color:navy">mov     byte ptr [bx+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; mov byte [bx+BUFFINF.Buff_In_HMA],1
<span style="color:black">SYSINIT:14F5                 </span><span style="color:navy">mov     ax, cs:</span>memhi    ; seg of scratch buff
<span style="color:black">SYSINIT:14F9                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [bx+BUFFINF.Lo_Mem_Buff] ; offset of scratch buff is 0
<span style="color:black">SYSINIT:14FE                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], ax    </span>; mov [bx+BUFFINF.Lo_Mem_Buff+2],ax
<span style="color:black">SYSINIT:1501                 </span><span style="color:navy">mov     ax, cs:</span>singlebuffersize ; size of scratch buff
<span style="color:black">SYSINIT:1505                 </span><span style="color:navy">sub     ax, </span><span style="color:green">24          </span>; bufinsiz ; 24 ; buffer head not required
<span style="color:black">SYSINIT:1505                                         </span>; (bufinsiz is 20 in MSDOS 6.21 IO.SYS)
<span style="color:black">SYSINIT:1508
SYSINIT:1508 </span><span style="color:gray">set_buff_2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1508                 </span><span style="color:navy">add     cs:</span>memlo<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:150D                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark = 2
<span style="color:black">SYSINIT:1513                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:1516                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1516 </span>set_buffer      <span style="color:black">endp
SYSINIT:1516
SYSINIT:1517
SYSINIT:1517 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1517
SYSINIT:1517
SYSINIT:1517 </span>GetBufferAddr   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1517                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:1518                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1519                 </span><span style="color:navy">cmp     cs:</span>dosdata_umb<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; is dosdata moved to UMB ? (DOSDATA=UMB done)
<span style="color:black">SYSINIT:151F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gba_1     </span>; no
<span style="color:black">SYSINIT:1521                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; is the buffer (already) in HMA ?
<span style="color:black">SYSINIT:1525                 </span><span style="color:navy">jz      short </span><span style="color:gray">gba_2     </span>; yes
<span style="color:black">SYSINIT:1527
SYSINIT:1527 </span><span style="color:gray">gba_1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1527                 </span><span style="color:navy">mov     ax, cs:</span>singlebuffersize
<span style="color:black">SYSINIT:152B                 </span><span style="color:navy">mul     cs:</span>buffers
<span style="color:black">SYSINIT:1530                 </span><span style="color:navy">add     ax, </span><span style="color:green">0Fh         </span>; 15
<span style="color:black">SYSINIT:1533                 </span><span style="color:navy">and     ax, </span><span style="color:green">0FFF0h      </span>; ~15 ; not 0Fh
<span style="color:black">SYSINIT:1536                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">SYSINIT:1538                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A02h       </span>; ((multMULT&lt;&lt;8)+multMULTALLOCHMA)
<span style="color:black">SYSINIT:153B                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; DOS 5+ - ALLOCATE HMA SPACE
<span style="color:black">SYSINIT:153B                                         </span>;     AX = 4A02h
<span style="color:black">SYSINIT:153B                                         </span>;     BX = number of bytes
<span style="color:black">SYSINIT:153B                                         </span>; Return:
<span style="color:black">SYSINIT:153B                                         </span>;     ES:DI -&gt; start of allocated HMA block or FFFFh:FFFFh
<span style="color:black">SYSINIT:153B                                         </span>;     BX = number of bytes actually allocated (rounded up to next
<span style="color:black">SYSINIT:153B                                         </span>;          paragraph for DOS 5.0 and 6.0)
<span style="color:black">SYSINIT:153B                                         </span>; Notes:
<span style="color:black">SYSINIT:153B                                         </span>;     this call is not valid unless DOS is loaded in the HMA (DOS=HIGH)
<span style="color:black">SYSINIT:153B                                         </span>;
<span style="color:black">SYSINIT:153B                                         </span>;     called by Windows 3.1 DOSX.EXE
<span style="color:black">SYSINIT:153B                                         </span>;     supported by Novell DOS 7
<span style="color:black">SYSINIT:153D                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:1540                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_hma
</span><span style="color:black">SYSINIT:1542                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0           </span>; dont xor di,di Z flag needed
<span style="color:black">SYSINIT:1542                                         </span>;
<span style="color:black">SYSINIT:1542                                         </span>; 05/09/2023 - Erdogan Tan
<span style="color:black">SYSINIT:1542                                         </span>; (above msdos source code comment is wrong
<span style="color:black">SYSINIT:1542                                         </span>; because ZF is already 1 here and
<span style="color:black">SYSINIT:1542                                         </span>; &#039;xor di,di&#039; sets ZF to 1 again;
<span style="color:black">SYSINIT:1542                                         </span>; &#039;inc di&#039; would be most proper instruction here)
<span style="color:black">SYSINIT:1545                 </span><span style="color:navy">mov     es, cs:</span>memhi
<span style="color:black">SYSINIT:154A
SYSINIT:154A </span><span style="color:gray">got_hma</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:154A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:154B                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:154C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:154D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:154D
SYSINIT:154D </span><span style="color:gray">gba_2</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:154D                 </span><span style="color:navy">les     di, [bx]
</span><span style="color:black">SYSINIT:154F                 </span><span style="color:navy">or      di, di
</span><span style="color:black">SYSINIT:1551                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1552                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1553                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1553 </span>GetBufferAddr   <span style="color:black">endp
SYSINIT:1553
SYSINIT:1554
SYSINIT:1554 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1554
SYSINIT:1554
SYSINIT:1554 </span>set_buffer_info <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1554                 </span><span style="color:navy">push    cs:</span>buf_prev_off ; es:di -&gt; buffer header to be set.
<span style="color:black">SYSINIT:1554                                         </span>; ax = di
<span style="color:black">SYSINIT:1559                 </span><span style="color:navy">pop     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; [es:di+buffinfo.buf_prev]
<span style="color:black">SYSINIT:155D                 </span><span style="color:navy">mov     cs:</span>buf_prev_off<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:1561                 </span><span style="color:navy">add     ax, cs:</span>singlebuffersize ; adjust ax
<span style="color:black">SYSINIT:1566                 </span><span style="color:navy">mov     es:[di], ax     </span>; [es:di+buffinfo.buf_next]
<span style="color:black">SYSINIT:1569                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; [es:di+buffinfo.buf_ID]
<span style="color:black">SYSINIT:1569                                         </span>; new buffer free
<span style="color:black">SYSINIT:156F                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+buffinfo.buf_sector]
<span style="color:black">SYSINIT:1575                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+buffinfo.buf_sector+2]
<span style="color:black">SYSINIT:157B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:157B </span>set_buffer_info <span style="color:black">endp
SYSINIT:157B
SYSINIT:157C
SYSINIT:157C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:157C
SYSINIT:157C
SYSINIT:157C </span>stackinit       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:157C                 </span><span style="color:navy">push    ax              </span>; ibmstack initialization routine
<span style="color:black">SYSINIT:157C                                         </span>; in - cs, ds -&gt; sysinitseg,
<span style="color:black">SYSINIT:157C                                         </span>;      es -&gt; relocated stack code &amp; data.
<span style="color:black">SYSINIT:157D                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:157E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:157F                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:1580                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:1581                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1582                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:1583                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:1584                 </span><span style="color:navy">push    bp
</span><span style="color:black">SYSINIT:1585                 </span><span style="color:navy">mov     ax, cs:</span>stack_count
<span style="color:black">SYSINIT:1589                 </span><span style="color:navy">mov     es:</span>stackcount<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:158D                 </span><span style="color:navy">mov     ax, ds:</span>stack_size
<span style="color:black">SYSINIT:1590                 </span><span style="color:navy">mov     es:</span>stacksize<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:1594                 </span><span style="color:navy">mov     ax, cs:</span>stack_addr ; offset
<span style="color:black">SYSINIT:1598                 </span><span style="color:navy">mov     es:</span>stacks<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:159C                 </span><span style="color:navy">mov     ax, cs:</span>stack_addr<span style="color:navy">+</span><span style="color:green">2 </span>; segment
<span style="color:black">SYSINIT:15A0                 </span><span style="color:navy">mov     es:</span>stacks<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:15A4                 </span><span style="color:navy">mov     bp, es:</span>stacks   ; &quot;firstentry&quot; will always be at stacks
<span style="color:black">SYSINIT:15A4                                         </span>; the stacks will always immediately follow the table entries
<span style="color:black">SYSINIT:15A9                 </span><span style="color:navy">mov     es:</span>firstentry<span style="color:navy">, bp
</span><span style="color:black">SYSINIT:15AE                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">8           </span>; entrysize
<span style="color:black">SYSINIT:15B1                 </span><span style="color:navy">mov     cx, es:</span>stackcount
<span style="color:black">SYSINIT:15B6                 </span><span style="color:navy">mul     cx
</span><span style="color:black">SYSINIT:15B8                 </span><span style="color:navy">add     ax, bp
</span><span style="color:black">SYSINIT:15BA                 </span><span style="color:navy">mov     es:</span>stackat<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:15BE                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">SYSINIT:15C0                 </span><span style="color:navy">sub     bx, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:15C3                 </span><span style="color:navy">mov     di, es:</span>stackat  ; zero the entire stack area to start with
<span style="color:black">SYSINIT:15C8                 </span><span style="color:navy">mov     ax, es:</span>stacksize
<span style="color:black">SYSINIT:15CC                 </span><span style="color:navy">mul     cx
</span><span style="color:black">SYSINIT:15CE                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:15D0                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:15D2                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:15D3                 </span><span style="color:navy">pop     ds              </span>; ds = relocated stack code seg.
<span style="color:black">SYSINIT:15D4                 </span><span style="color:navy">mov     es, ds:</span>stacks<span style="color:navy">+</span><span style="color:green">2 </span>; get segment of stack area.
<span style="color:black">SYSINIT:15D8                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:15D9                 </span><span style="color:navy">rep stosb               </span>; 0
<span style="color:black">SYSINIT:15DB                 </span><span style="color:navy">mov     cx, ds:</span>stackcount ; loop for &quot;count&quot; times, building a table entry
<span style="color:black">SYSINIT:15DB                                         </span>; cs = sysinitseg, ds = relocated stack code seg,
<span style="color:black">SYSINIT:15DB                                         </span>; es = segment of stack space
<span style="color:black">SYSINIT:15DB                                         </span>; cx = number of entries
<span style="color:black">SYSINIT:15DB                                         </span>; es:bp =&gt; base of stacks - 2
<span style="color:black">SYSINIT:15DB                                         </span>; es:bx =&gt; first table entry
<span style="color:black">SYSINIT:15DF
SYSINIT:15DF </span><span style="color:gray">buildloop</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:15DF                 </span><span style="color:navy">mov     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+allocbyte],free
<span style="color:black">SYSINIT:15E4                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">], al   </span>; [es:bp+intlevel]
<span style="color:black">SYSINIT:15E4                                         </span>; ax = 0
<span style="color:black">SYSINIT:15E8                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax   </span>; [es:bp+savedsp]
<span style="color:black">SYSINIT:15EC                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax   </span>; [es:bp+savedss]
<span style="color:black">SYSINIT:15F0                 </span><span style="color:navy">add     bx, ds:</span>stacksize
<span style="color:black">SYSINIT:15F4                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], bx   </span>; [es:bp+newsp]
<span style="color:black">SYSINIT:15F8                 </span><span style="color:navy">mov     es:[bx], bp
</span><span style="color:black">SYSINIT:15FB                 </span><span style="color:navy">add     bp, </span><span style="color:#ff8000">8           </span>; entrysize
<span style="color:black">SYSINIT:15FE                 </span><span style="color:navy">loop    </span><span style="color:gray">buildloop
</span><span style="color:black">SYSINIT:1600                 </span><span style="color:navy">sub     bp, </span><span style="color:#ff8000">8           </span>; entrysize
<span style="color:black">SYSINIT:1603                 </span><span style="color:navy">mov     ds:</span>lastentry<span style="color:navy">, bp
</span><span style="color:black">SYSINIT:1607                 </span><span style="color:navy">mov     ds:</span>nextentry<span style="color:navy">, bp
</span><span style="color:black">SYSINIT:160B                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:160C                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h      </span>; look at the model byte
<span style="color:black">SYSINIT:160F                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:1611                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1611                 </span><span style="color:navy">cmp     byte ptr ds:</span><span style="color:green">0FFFEh</span><span style="color:navy">, </span><span style="color:#ff8000">0F9h </span>; mdl_convert ; convertible?
<span style="color:black">SYSINIT:1616                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1617                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1617                 </span><span style="color:navy">jnz     short </span><span style="color:gray">skip_disablenmis
</span><span style="color:black">SYSINIT:1619                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7           </span>; disable convertible nmis
<span style="color:black">SYSINIT:161B                 </span><span style="color:navy">out     </span><span style="color:green">72h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Index Register (Extended RAM)
<span style="color:black">SYSINIT:161D
SYSINIT:161D </span><span style="color:gray">skip_disablenmis</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:161D                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:161F                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:1621                 </span>assume es:nothing
<span style="color:black">SYSINIT:1621                 </span><span style="color:navy">cli
</span><span style="color:black">SYSINIT:1622
SYSINIT:1622 </span>stkinit_02<span style="color:navy">:                             </span>; Int 02h vector table offset
<span style="color:black">SYSINIT:1622                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">8
</span><span style="color:black">SYSINIT:1625                 </span><span style="color:navy">mov     di, offset </span>int19old02
<span style="color:black">SYSINIT:1628                 </span><span style="color:navy">mov     bx, offset </span>old02
<span style="color:black">SYSINIT:162B                 </span><span style="color:navy">mov     dx, offset </span>int02
<span style="color:black">SYSINIT:162E                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:1631
SYSINIT:1631 </span>stkinit_08<span style="color:navy">:                             </span>; Int 08h vector table offset
<span style="color:black">SYSINIT:1631                 </span><span style="color:navy">mov     si, </span><span style="color:green">32
</span><span style="color:black">SYSINIT:1634                 </span><span style="color:navy">mov     di, offset </span>int19old08
<span style="color:black">SYSINIT:1637                 </span><span style="color:navy">mov     bx, offset </span>old08
<span style="color:black">SYSINIT:163A                 </span><span style="color:navy">mov     dx, offset </span>int08
<span style="color:black">SYSINIT:163D                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:1640
SYSINIT:1640 </span>stkinit_09<span style="color:navy">:                             </span>; Int 09h vector table offset
<span style="color:black">SYSINIT:1640                 </span><span style="color:navy">mov     si, </span><span style="color:green">36
</span><span style="color:black">SYSINIT:1643                 </span><span style="color:navy">mov     di, offset </span>int19old09
<span style="color:black">SYSINIT:1646                 </span><span style="color:navy">mov     bx, offset </span>old09
<span style="color:black">SYSINIT:1649                 </span><span style="color:navy">mov     dx, offset </span>int09
<span style="color:black">SYSINIT:164C                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:164F
SYSINIT:164F </span>stkinit_70<span style="color:navy">:                             </span>; Int 70h vector table offset
<span style="color:black">SYSINIT:164F                 </span><span style="color:navy">mov     si, </span><span style="color:green">448
</span><span style="color:black">SYSINIT:1652                 </span><span style="color:navy">mov     di, offset </span>int19old70
<span style="color:black">SYSINIT:1655                 </span><span style="color:navy">mov     bx, offset </span>old70
<span style="color:black">SYSINIT:1658                 </span><span style="color:navy">mov     dx, offset </span>int70
<span style="color:black">SYSINIT:165B                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:165E
SYSINIT:165E </span>stkinit_0A<span style="color:navy">:                             </span>; 0Ah*4 ; 40
<span style="color:black">SYSINIT:165E                 </span><span style="color:navy">mov     si, </span><span style="color:green">28h         </span>; Int 0Ah vector table offset
<span style="color:black">SYSINIT:1661                 </span><span style="color:navy">push    ds              </span>; save relocated stack code segment
<span style="color:black">SYSINIT:1662                 </span><span style="color:navy">lds     bx, es:[si]     </span>; ds:bx -&gt; original interrupt handler
<span style="color:black">SYSINIT:1665                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1666                 </span><span style="color:navy">pop     dx              </span>; dx = segment value
<span style="color:black">SYSINIT:1667                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:166A                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0A_first
</span><span style="color:black">SYSINIT:166C                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh </span>; does vector point to an iret?
<span style="color:black">SYSINIT:166F                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0A_first
</span><span style="color:black">SYSINIT:1671                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh </span>; magic offset (see int&amp;aa, msstack.inc)
<span style="color:black">SYSINIT:1676                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0A_not_first
</span><span style="color:black">SYSINIT:1678                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h      </span>; rom bios segment
<span style="color:black">SYSINIT:167C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_0A_not_first
</span><span style="color:black">SYSINIT:167E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:167F                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1680                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:1683                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:1685                 </span>assume es:nothing
<span style="color:black">SYSINIT:1685                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:168A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:168B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:168C                 </span>assume es:nothing
<span style="color:black">SYSINIT:168C                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0A_first
</span><span style="color:black">SYSINIT:168E
SYSINIT:168E </span><span style="color:gray">int_0A_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:168E                 </span><span style="color:navy">pop     ds              </span>; not the first. we are going to hook vector.
<span style="color:black">SYSINIT:168F                 </span><span style="color:navy">mov     di, offset </span>int19old0A ; we have to set old&amp;aa for int19 handler too.
<span style="color:black">SYSINIT:1692                 </span><span style="color:navy">mov     bx, offset </span>old0A ; pass where to save original owner pointer
<span style="color:black">SYSINIT:1695                 </span><span style="color:navy">mov     dx, offset </span>int0A ; pass where new handler is
<span style="color:black">SYSINIT:1698                 </span><span style="color:navy">call    </span>new_init_loop   ; adjust the vector to new handler,
<span style="color:black">SYSINIT:1698                                         </span>; saving pointer to original owner.
<span style="color:black">SYSINIT:169B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_0B
</span><span style="color:black">SYSINIT:169D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:169D
SYSINIT:169D </span><span style="color:gray">int_0A_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:169D                 </span><span style="color:navy">pop     ds              </span>; the first. don&#039;t have to hook stack code.
<span style="color:black">SYSINIT:169E
SYSINIT:169E </span><span style="color:gray">stkinit_0B</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:169E                 </span><span style="color:navy">mov     si, </span><span style="color:green">2Ch         </span>; Int 0Bh vector table offset
<span style="color:black">SYSINIT:16A1                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:16A2                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:16A5                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:16A6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:16A7                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:16AA                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0B_first
</span><span style="color:black">SYSINIT:16AC                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:16AF                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0B_first
</span><span style="color:black">SYSINIT:16B1                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:16B6                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0B_not_first
</span><span style="color:black">SYSINIT:16B8                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:16BC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_0B_not_first
</span><span style="color:black">SYSINIT:16BE                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:16BF                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:16C0                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:16C3                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:16C5                 </span>assume es:nothing
<span style="color:black">SYSINIT:16C5                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:16CA                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:16CB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:16CC                 </span>assume es:nothing
<span style="color:black">SYSINIT:16CC                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0B_first
</span><span style="color:black">SYSINIT:16CE
SYSINIT:16CE </span><span style="color:gray">int_0B_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:16CE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:16CF                 </span><span style="color:navy">mov     di, offset </span>int19old0B
<span style="color:black">SYSINIT:16D2                 </span><span style="color:navy">mov     bx, offset </span>old0B
<span style="color:black">SYSINIT:16D5                 </span><span style="color:navy">mov     dx, offset </span>int0B
<span style="color:black">SYSINIT:16D8                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:16DB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_0C
</span><span style="color:black">SYSINIT:16DD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:16DD
SYSINIT:16DD </span><span style="color:gray">int_0B_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:16DD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:16DE
SYSINIT:16DE </span><span style="color:gray">stkinit_0C</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:16DE                 </span><span style="color:navy">mov     si, </span><span style="color:green">30h         </span>; Int 0Ch vector table offset
<span style="color:black">SYSINIT:16E1                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:16E2                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:16E5                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:16E6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:16E7                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:16EA                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0C_first
</span><span style="color:black">SYSINIT:16EC                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:16EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0C_first
</span><span style="color:black">SYSINIT:16F1                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:16F6                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0C_not_first
</span><span style="color:black">SYSINIT:16F8                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:16FC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_0C_not_first
</span><span style="color:black">SYSINIT:16FE                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:16FF                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1700                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:1703                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:1705                 </span>assume es:nothing
<span style="color:black">SYSINIT:1705                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:170A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:170B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:170C                 </span>assume es:nothing
<span style="color:black">SYSINIT:170C                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0C_first
</span><span style="color:black">SYSINIT:170E
SYSINIT:170E </span><span style="color:gray">int_0C_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:170E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:170F                 </span><span style="color:navy">mov     di, offset </span>int19old0C
<span style="color:black">SYSINIT:1712                 </span><span style="color:navy">mov     bx, offset </span>old0C
<span style="color:black">SYSINIT:1715                 </span><span style="color:navy">mov     dx, offset </span>int0C
<span style="color:black">SYSINIT:1718                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:171B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_0D
</span><span style="color:black">SYSINIT:171D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:171D
SYSINIT:171D </span><span style="color:gray">int_0C_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:171D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:171E
SYSINIT:171E </span><span style="color:gray">stkinit_0D</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:171E                 </span><span style="color:navy">mov     si, </span><span style="color:green">34h         </span>; Int 0Dh vector table offset
<span style="color:black">SYSINIT:1721                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1722                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:1725                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1726                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1727                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:172A                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0D_first
</span><span style="color:black">SYSINIT:172C                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:172F                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0D_first
</span><span style="color:black">SYSINIT:1731                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:1736                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0D_not_first
</span><span style="color:black">SYSINIT:1738                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:173C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_0D_not_first
</span><span style="color:black">SYSINIT:173E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:173F                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1740                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:1743                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:1745                 </span>assume es:nothing
<span style="color:black">SYSINIT:1745                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:174A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:174B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:174C                 </span>assume es:nothing
<span style="color:black">SYSINIT:174C                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0D_first
</span><span style="color:black">SYSINIT:174E
SYSINIT:174E </span><span style="color:gray">int_0D_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:174E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:174F                 </span><span style="color:navy">mov     di, offset </span>int19old0D
<span style="color:black">SYSINIT:1752                 </span><span style="color:navy">mov     bx, offset </span>old0D
<span style="color:black">SYSINIT:1755                 </span><span style="color:navy">mov     dx, offset </span>int0D
<span style="color:black">SYSINIT:1758                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:175B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_0E
</span><span style="color:black">SYSINIT:175D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:175D
SYSINIT:175D </span><span style="color:gray">int_0D_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:175D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:175E
SYSINIT:175E </span><span style="color:gray">stkinit_0E</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:175E                 </span><span style="color:navy">mov     si, </span><span style="color:green">38h         </span>; 0Eh*4 ; Int 0Eh vector table offset
<span style="color:black">SYSINIT:1761                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1762                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:1765                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1766                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1767                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:176A                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0E_first
</span><span style="color:black">SYSINIT:176C                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:176F                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0E_first
</span><span style="color:black">SYSINIT:1771                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:1776                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0E_not_first
</span><span style="color:black">SYSINIT:1778                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:177C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_0E_not_first
</span><span style="color:black">SYSINIT:177E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:177F                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1780                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:1783                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:1785                 </span>assume es:nothing
<span style="color:black">SYSINIT:1785                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:178A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:178B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:178C                 </span>assume es:nothing
<span style="color:black">SYSINIT:178C                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_0E_first
</span><span style="color:black">SYSINIT:178E
SYSINIT:178E </span><span style="color:gray">int_0E_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:178E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:178F                 </span><span style="color:navy">mov     di, offset </span>int19old0E
<span style="color:black">SYSINIT:1792                 </span><span style="color:navy">mov     bx, offset </span>old0E
<span style="color:black">SYSINIT:1795                 </span><span style="color:navy">mov     dx, offset </span>int0E
<span style="color:black">SYSINIT:1798                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:179B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_72
</span><span style="color:black">SYSINIT:179D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:179D
SYSINIT:179D </span><span style="color:gray">int_0E_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:179D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:179E
SYSINIT:179E </span><span style="color:gray">stkinit_72</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:179E                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1C8h        </span>; 72h*4 ; 456
<span style="color:black">SYSINIT:179E                                         </span>; Int 72h vector table offset
<span style="color:black">SYSINIT:17A1                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:17A2                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:17A5                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:17A6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:17A7                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:17AA                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_72_first
</span><span style="color:black">SYSINIT:17AC                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:17AF                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_72_first
</span><span style="color:black">SYSINIT:17B1                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:17B6                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_72_not_first
</span><span style="color:black">SYSINIT:17B8                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:17BC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_72_not_first
</span><span style="color:black">SYSINIT:17BE                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:17BF                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:17C0                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:17C3                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:17C5                 </span>assume es:nothing
<span style="color:black">SYSINIT:17C5                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:17CA                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:17CB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:17CC                 </span>assume es:nothing
<span style="color:black">SYSINIT:17CC                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_72_first
</span><span style="color:black">SYSINIT:17CE
SYSINIT:17CE </span><span style="color:gray">int_72_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:17CE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:17CF                 </span><span style="color:navy">mov     di, offset </span>int19old72
<span style="color:black">SYSINIT:17D2                 </span><span style="color:navy">mov     bx, offset </span>old72
<span style="color:black">SYSINIT:17D5                 </span><span style="color:navy">mov     dx, offset </span>int72
<span style="color:black">SYSINIT:17D8                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:17DB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_73
</span><span style="color:black">SYSINIT:17DD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:17DD
SYSINIT:17DD </span><span style="color:gray">int_72_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:17DD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:17DE
SYSINIT:17DE </span><span style="color:gray">stkinit_73</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:17DE                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1CCh        </span>; 73h*4 ; 460
<span style="color:black">SYSINIT:17E1                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:17E2                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:17E5                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:17E6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:17E7                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:17EA                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_73_first
</span><span style="color:black">SYSINIT:17EC                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:17EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_73_first
</span><span style="color:black">SYSINIT:17F1                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:17F6                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_73_not_first
</span><span style="color:black">SYSINIT:17F8                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:17FC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_73_not_first
</span><span style="color:black">SYSINIT:17FE                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:17FF                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1800                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:1803                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:1805                 </span>assume es:nothing
<span style="color:black">SYSINIT:1805                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:180A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:180B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:180C                 </span>assume es:nothing
<span style="color:black">SYSINIT:180C                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_73_first
</span><span style="color:black">SYSINIT:180E
SYSINIT:180E </span><span style="color:gray">int_73_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:180E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:180F                 </span><span style="color:navy">mov     di, offset </span>int19old73
<span style="color:black">SYSINIT:1812                 </span><span style="color:navy">mov     bx, offset </span>old73
<span style="color:black">SYSINIT:1815                 </span><span style="color:navy">mov     dx, offset </span>int73
<span style="color:black">SYSINIT:1818                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:181B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_74
</span><span style="color:black">SYSINIT:181D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:181D
SYSINIT:181D </span><span style="color:gray">int_73_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:181D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:181E
SYSINIT:181E </span><span style="color:gray">stkinit_74</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:181E                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1D0h
</span><span style="color:black">SYSINIT:1821                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1822                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:1825                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1826                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1827                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:182A                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_74_first
</span><span style="color:black">SYSINIT:182C                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:182F                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_74_first
</span><span style="color:black">SYSINIT:1831                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:1836                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_74_not_first
</span><span style="color:black">SYSINIT:1838                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:183C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_74_not_first
</span><span style="color:black">SYSINIT:183E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:183F                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1840                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:1843                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:1845                 </span>assume es:nothing
<span style="color:black">SYSINIT:1845                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:184A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:184B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:184C                 </span>assume es:nothing
<span style="color:black">SYSINIT:184C                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_74_first
</span><span style="color:black">SYSINIT:184E
SYSINIT:184E </span><span style="color:gray">int_74_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:184E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:184F                 </span><span style="color:navy">mov     di, offset </span>int19old74
<span style="color:black">SYSINIT:1852                 </span><span style="color:navy">mov     bx, offset </span>old74
<span style="color:black">SYSINIT:1855                 </span><span style="color:navy">mov     dx, offset </span>int74
<span style="color:black">SYSINIT:1858                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:185B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_76
</span><span style="color:black">SYSINIT:185D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:185D
SYSINIT:185D </span><span style="color:gray">int_74_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:185D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:185E
SYSINIT:185E </span><span style="color:gray">stkinit_76</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:185E                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1D8h        </span>; 76h*4 ; 472
<span style="color:black">SYSINIT:1861                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1862                 </span><span style="color:navy">lds     bx, es:[si]
</span><span style="color:black">SYSINIT:1865                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1866                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1867                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:186A                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_76_first
</span><span style="color:black">SYSINIT:186C                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh
</span><span style="color:black">SYSINIT:186F                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_76_first
</span><span style="color:black">SYSINIT:1871                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh
</span><span style="color:black">SYSINIT:1876                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_76_not_first
</span><span style="color:black">SYSINIT:1878                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:187C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_76_not_first
</span><span style="color:black">SYSINIT:187E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:187F                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1880                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:1883                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:1885                 </span>assume es:nothing
<span style="color:black">SYSINIT:1885                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:188A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:188B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:188C                 </span>assume es:nothing
<span style="color:black">SYSINIT:188C                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_76_first
</span><span style="color:black">SYSINIT:188E
SYSINIT:188E </span><span style="color:gray">int_76_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:188E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:188F                 </span><span style="color:navy">mov     di, offset </span>int19old76
<span style="color:black">SYSINIT:1892                 </span><span style="color:navy">mov     bx, offset </span>old76
<span style="color:black">SYSINIT:1895                 </span><span style="color:navy">mov     dx, offset </span>int76
<span style="color:black">SYSINIT:1898                 </span><span style="color:navy">call    </span>new_init_loop
<span style="color:black">SYSINIT:189B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">stkinit_77
</span><span style="color:black">SYSINIT:189D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:189D
SYSINIT:189D </span><span style="color:gray">int_76_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:189D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:189E
SYSINIT:189E </span><span style="color:gray">stkinit_77</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:189E                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1DCh        </span>; mov si,77h*4 ; 476
<span style="color:black">SYSINIT:189E                                         </span>; Int 77h vector table offset
<span style="color:black">SYSINIT:18A1                 </span><span style="color:navy">push    ds              </span>; save relocated stack code segment
<span style="color:black">SYSINIT:18A2                 </span><span style="color:navy">lds     bx, es:[si]     </span>; ds:bx -&gt; original interrupt handler
<span style="color:black">SYSINIT:18A5                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:18A6                 </span><span style="color:navy">pop     dx              </span>; dx = segment value
<span style="color:black">SYSINIT:18A7                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:18AA                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_77_first
</span><span style="color:black">SYSINIT:18AC                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0CFh </span>; does vector point to an iret?
<span style="color:black">SYSINIT:18AF                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_77_first
</span><span style="color:black">SYSINIT:18B1                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">424Bh </span>; magic offset (see int&amp;aa, msstack.inc)
<span style="color:black">SYSINIT:18B6                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_77_not_first
</span><span style="color:black">SYSINIT:18B8                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0F000h      </span>; rom bios segment
<span style="color:black">SYSINIT:18BC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">int_77_not_first
</span><span style="color:black">SYSINIT:18BE                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:18BF                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:18C0                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:18C3                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:18C5                 </span>assume es:nothing
<span style="color:black">SYSINIT:18C5                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">0FF01h
</span><span style="color:black">SYSINIT:18CA                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:18CB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:18CC                 </span>assume es:nothing
<span style="color:black">SYSINIT:18CC                 </span><span style="color:navy">jz      short </span><span style="color:gray">int_77_first
</span><span style="color:black">SYSINIT:18CE
SYSINIT:18CE </span><span style="color:gray">int_77_not_first</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:18CE                 </span><span style="color:navy">pop     ds              </span>; not the first. we are going to hook vector.
<span style="color:black">SYSINIT:18CF                 </span><span style="color:navy">mov     di, offset </span>int19old77 ; we have to set old&amp;aa for int19 handler too.
<span style="color:black">SYSINIT:18D2                 </span><span style="color:navy">mov     bx, offset </span>old77 ; pass where to save original owner pointer
<span style="color:black">SYSINIT:18D5                 </span><span style="color:navy">mov     dx, offset </span>int77 ; pass where new handler is
<span style="color:black">SYSINIT:18D8                 </span><span style="color:navy">call    </span>new_init_loop   ; adjust the vector to new handler,
<span style="color:black">SYSINIT:18D8                                         </span>; saving pointer to original owner.
<span style="color:black">SYSINIT:18DB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">int_77_end
</span><span style="color:black">SYSINIT:18DD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:18DD
SYSINIT:18DD </span><span style="color:gray">int_77_first</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:18DD                 </span><span style="color:navy">pop     ds              </span>; the first. don&#039;t have to hook stack code.
<span style="color:black">SYSINIT:18DE
SYSINIT:18DE </span><span style="color:gray">int_77_end</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:18DE                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:18DF                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:black">SYSINIT:18E2                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:18E4                 </span>assume ds:nothing
<span style="color:black">SYSINIT:18E4                 </span><span style="color:navy">cmp     byte ptr ds:</span><span style="color:green">0FFFEh</span><span style="color:navy">, </span><span style="color:#ff8000">0F9h </span>; mdl_convert ; pc convertible?
<span style="color:black">SYSINIT:18E9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:18EA                 </span>assume ds:nothing
<span style="color:black">SYSINIT:18EA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">skip_enablenmis
</span><span style="color:black">SYSINIT:18EC                 </span><span style="color:navy">mov     al, </span><span style="color:green">27h         </span>; enable convertible nmis
<span style="color:black">SYSINIT:18EE                 </span><span style="color:navy">out     </span><span style="color:green">72h</span><span style="color:navy">, al         </span>; CMOS Memory/RTC Index Register (Extended RAM)
<span style="color:black">SYSINIT:18F0
SYSINIT:18F0 </span><span style="color:gray">skip_enablenmis</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:18F0                 </span><span style="color:navy">sti
</span><span style="color:black">SYSINIT:18F1                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG
<span style="color:black">SYSINIT:18F4                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:18F6                 </span>assume ds:nothing
<span style="color:black">SYSINIT:18F6                 </span><span style="color:navy">mov     ds:</span>int19sem<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; indicate that int 19h
<span style="color:black">SYSINIT:18F6                                         </span>; initialization is complete
<span style="color:black">SYSINIT:18FB                 </span><span style="color:navy">pop     bp
</span><span style="color:black">SYSINIT:18FC                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:18FD                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:18FE                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:18FF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:1900                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1901                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:1902                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1903                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1903                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1904                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1904 </span>stackinit       <span style="color:black">endp
SYSINIT:1904
SYSINIT:1905
SYSINIT:1905 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1905
SYSINIT:1905
SYSINIT:1905 </span>new_init_loop   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1905                 </span><span style="color:navy">cmp     cs:</span>dosdata_umb<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; is DOSDATA=UMB done ? (DOSDATA is in UMB)
<span style="color:black">SYSINIT:190B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">new_init_loop_1st
</span><span style="color:black">SYSINIT:190D                 </span><span style="color:navy">push    ds              </span>; restore original/previous interrupt handler
<span style="color:black">SYSINIT:190D                                         </span>; (from int19old?? field in BIOSDATA)
<span style="color:black">SYSINIT:190E                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h
</span><span style="color:black">SYSINIT:1911                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:1913                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1913                 </span><span style="color:navy">lds     ax, [di]        </span>; restore original Int ?? handler addr from int19old?? field
<span style="color:black">SYSINIT:1915                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1915                 </span><span style="color:navy">mov     es:[si], ax     </span>; copy the original int handler addr to its int vector addr
<span style="color:black">SYSINIT:1918                 </span><span style="color:navy">mov     word ptr es:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">], ds
</span><span style="color:black">SYSINIT:191C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:191D
SYSINIT:191D </span><span style="color:gray">new_init_loop_1st</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:191D                 </span><span style="color:navy">mov     ax, es:[si]     </span>; new stack initialization
<span style="color:black">SYSINIT:191D                                         </span>; (dx = new handler offset,
<span style="color:black">SYSINIT:191D                                         </span>;  bx = original handler saving addr,
<span style="color:black">SYSINIT:191D                                         </span>;  si = int vector table offset
<span style="color:black">SYSINIT:191D                                         </span>;  di = int19old?? field offset -in DOSBIOSDATASEG-
<span style="color:black">SYSINIT:191D                                         </span>;  es = zero, segid of vector table
<span style="color:black">SYSINIT:191D                                         </span>;  ds = relocated stack code segment)
<span style="color:black">SYSINIT:1920                 </span><span style="color:navy">mov     [bx], ax
</span><span style="color:black">SYSINIT:1922                 </span><span style="color:navy">mov     ax, es:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:1926                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax
</span><span style="color:black">SYSINIT:1929                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:192A                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG
<span style="color:black">SYSINIT:192D                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:192F                 </span>assume ds:nothing
<span style="color:black">SYSINIT:192F                 </span><span style="color:navy">mov     ax, es:[si]
</span><span style="color:black">SYSINIT:1932                 </span><span style="color:navy">mov     [di], ax
</span><span style="color:black">SYSINIT:1934                 </span><span style="color:navy">mov     ax, es:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:1938                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax
</span><span style="color:black">SYSINIT:193B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:193C                 </span>assume ds:nothing
<span style="color:black">SYSINIT:193C                 </span><span style="color:navy">mov     es:[si], dx
</span><span style="color:black">SYSINIT:193F                 </span><span style="color:navy">mov     word ptr es:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">], ds
</span><span style="color:black">SYSINIT:1943                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1943 </span>new_init_loop   <span style="color:black">endp
SYSINIT:1943
SYSINIT:1944
SYSINIT:1944 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1944
SYSINIT:1944
SYSINIT:1944 </span>setdevmark      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1944                 </span><span style="color:navy">push    es              </span>; set the devmark for mem command.
<span style="color:black">SYSINIT:1944                                         </span>; in:
<span style="color:black">SYSINIT:1944                                         </span>;   [memhi] - the address to place devmark
<span style="color:black">SYSINIT:1944                                         </span>;   [memlo] = 0
<span style="color:black">SYSINIT:1944                                         </span>;   al = id for devmark_id
<span style="color:black">SYSINIT:1944                                         </span>; out:
<span style="color:black">SYSINIT:1944                                         </span>;   devmark established.
<span style="color:black">SYSINIT:1944                                         </span>;   the address saved in cs:[devmark_addr]
<span style="color:black">SYSINIT:1944                                         </span>;   [memhi] increase by 1.
<span style="color:black">SYSINIT:1945                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:1946                 </span><span style="color:navy">mov     cx, cs:</span>memhi
<span style="color:black">SYSINIT:194B                 </span><span style="color:navy">mov     cs:</span>devmark_addr<span style="color:navy">, cx
</span><span style="color:black">SYSINIT:1950                 </span><span style="color:navy">mov     es, cx
</span><span style="color:black">SYSINIT:1952                 </span><span style="color:navy">mov     es:</span><span style="color:green">0</span><span style="color:navy">, al        </span>; [es:devmark.id]
<span style="color:black">SYSINIT:1956                 </span><span style="color:navy">inc     cx
</span><span style="color:black">SYSINIT:1957                 </span><span style="color:navy">mov     es:</span><span style="color:green">1</span><span style="color:navy">, cx        </span>; [es:devmark.seg]
<span style="color:black">SYSINIT:195C                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:195D                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:195E                 </span><span style="color:navy">inc     cs:</span>memhi
<span style="color:black">SYSINIT:1963                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1963 </span>setdevmark      <span style="color:black">endp
SYSINIT:1963
SYSINIT:1963 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:1964 </span>MagicDDNamePtr  <span style="color:navy">dw offset </span>MagicDDName   <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1964                                         ; &quot;\\DBLSPACE.BIN&quot;
SYSINIT:1966                 </span><span style="color:navy">db &#039;C:&#039;
</span><span style="color:gray">SYSINIT:1968 </span>MagicDDName     <span style="color:navy">db &#039;\DBLSPACE.BIN&#039;,0    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1976 </span>StackerName     <span style="color:navy">db &#039;C:\STACKER.BIN&#039;,0   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1985 </span>tiny_stub_start <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1985                                         </span>; phony device driver link
<span style="color:gray">SYSINIT:1987                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span>; dw -1, -1
<span style="color:gray">SYSINIT:1989                 </span><span style="color:navy">dw </span><span style="color:#008040">8000h                </span>; mark as character device for MEM display
<span style="color:gray">SYSINIT:198B                 </span><span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span>; strat and irpt
<span style="color:gray">SYSINIT:198F                 </span><span style="color:navy">db &#039;DBLSBIN$&#039;           </span>; magic default load
<span style="color:gray">SYSINIT:198F                                         </span>; (tiny_stub_end-tiny_stub_start = 18)
<span style="color:black">SYSINIT:1997
SYSINIT:1997 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1997
SYSINIT:1997
SYSINIT:1997 </span>MagicPreload    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1997                 </span><span style="color:navy">mov     cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; not for devmark
<span style="color:black">SYSINIT:199D                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:19A0                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:19A1                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:19A2                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:19A2                 </span><span style="color:navy">mov     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; not to be loaded in UMB
<span style="color:black">SYSINIT:19A8                 </span><span style="color:navy">call    </span>InitDevLoad
<span style="color:black">SYSINIT:19AB                 </span><span style="color:navy">mov     ax, cs:</span>DevLoadAddr
<span style="color:black">SYSINIT:19AF                 </span><span style="color:navy">add     ax, cs:</span>DevSize  ; calculate seg after DD load
<span style="color:black">SYSINIT:19B4                 </span><span style="color:navy">jb      short </span><span style="color:gray">pre_exit_err </span>; choke if overflows address space
<span style="color:black">SYSINIT:19B6                 </span><span style="color:navy">cmp     ax, cs:</span>DevLoadEnd ; does it overflow available space?
<span style="color:black">SYSINIT:19BB                 </span><span style="color:navy">ja      short </span><span style="color:gray">pre_exit_err
</span><span style="color:black">SYSINIT:19BD
SYSINIT:19BD </span>_LoadDev<span style="color:navy">:                               </span>; we&#039;re golden if not
<span style="color:black">SYSINIT:19BD                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:19BE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:19BF                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:19BF                 </span><span style="color:navy">mov     dx, cs:</span>MagicDDNamePtr
<span style="color:black">SYSINIT:19C4                 </span><span style="color:navy">call    </span>ExecDev         ; load device driver using exec call
<span style="color:black">SYSINIT:19C7                 </span><span style="color:navy">jb      short </span><span style="color:gray">pre_exit_err
</span><span style="color:black">SYSINIT:19C9                 </span><span style="color:navy">les     bx, cs:</span>DevEntry ; point to the Magic DD header
<span style="color:black">SYSINIT:19CE                 </span>assume es:nothing
<span style="color:black">SYSINIT:19CE                 </span><span style="color:navy">cmp     word ptr es:[bx+</span><span style="color:#ff8000">12h</span><span style="color:navy">], </span><span style="color:green">2E2Ch </span>; is it our stamp? ; &#039;,.&#039;
<span style="color:black">SYSINIT:19D4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">pre_exit_err
</span><span style="color:black">SYSINIT:19D6                 </span><span style="color:navy">mov     </span>word ptr cs:MagicBackdoor<span style="color:navy">, </span><span style="color:#ff8000">14h </span>; save the backdoor entry.
<span style="color:black">SYSINIT:19D6                                         </span>; (initial IP -EXE header offset 20-)
<span style="color:black">SYSINIT:19DD                 </span><span style="color:navy">mov     </span>word ptr cs:MagicBackdoor+2<span style="color:navy">, es
</span><span style="color:black">SYSINIT:19E2                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:19E3                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:19E4                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:19E4                 </span><span style="color:navy">mov     bx, offset </span>packet
<span style="color:black">SYSINIT:19E7                 </span><span style="color:navy">mov     cs:</span>break_addr<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:19EE                 </span><span style="color:navy">mov     ax, cs:</span>DevLoadEnd
<span style="color:black">SYSINIT:19F2                 </span><span style="color:navy">mov     cs:</span>break_addr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:19F6                 </span><span style="color:navy">mov     al, cs:</span>drivenumber ; pass drive number to DBLSPACE as if
<span style="color:black">SYSINIT:19FA                 </span><span style="color:navy">mov     cs:</span>devdrivenum<span style="color:navy">, al </span>; it is a normal block device driver
<span style="color:black">SYSINIT:19FE                 </span><span style="color:navy">mov     ax, </span><span style="color:green">10          </span>; DS_INTERNAL_REVISION
<span style="color:black">SYSINIT:19FE                                         </span>; tell it what revision we expect
<span style="color:black">SYSINIT:1A01                 </span><span style="color:navy">call    </span>cs:MagicBackdoor ; first time call is init entry point
<span style="color:black">SYSINIT:1A01                                         </span>; with a standard device driver
<span style="color:black">SYSINIT:1A01                                         </span>; init packet at es:bx
<span style="color:black">SYSINIT:1A06                 </span><span style="color:navy">jnb     short </span><span style="color:gray">no_driver_version_fail </span>; skip if not a version failure
<span style="color:black">SYSINIT:1A08                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">6           </span>; DS_INTERNAL_REVISION_6 ; (Stacker ?)
<span style="color:black">SYSINIT:1A08                                         </span>; tell it what revision we expect
<span style="color:black">SYSINIT:1A0B                 </span><span style="color:navy">call    </span>cs:MagicBackdoor
<span style="color:black">SYSINIT:1A10                 </span><span style="color:navy">jnb     short </span><span style="color:gray">no_driver_version_fail
</span><span style="color:black">SYSINIT:1A12                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:1A13                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1A14                 </span><span style="color:navy">mov     dx, offset </span>baddblspace <span style="color:gray">; &quot;Required system component is not instal&quot;...
</span><span style="color:black">SYSINIT:1A17                 </span><span style="color:navy">call    </span>print           ; display the message
<span style="color:black">SYSINIT:1A1A
SYSINIT:1A1A </span><span style="color:gray">fail_driver_load</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1A1A                 </span><span style="color:navy">mov     word ptr cs:</span>MagicBackdoor<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cs
</span><span style="color:black">SYSINIT:1A1F                 </span><span style="color:navy">mov     word ptr cs:</span>MagicBackdoor<span style="color:navy">, offset </span>NullBackdoor
<span style="color:black">SYSINIT:1A26
SYSINIT:1A26 </span><span style="color:gray">pre_exit_err</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1A26                 </span><span style="color:navy">mov     ax, </span><span style="color:green">40h         </span>; SYSPRE_BADFILE_ERROR
<span style="color:black">SYSINIT:1A26                                         </span>; (problem loading dblspace.bin)
<span style="color:black">SYSINIT:1A29                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1A2A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1A2A
SYSINIT:1A2A </span><span style="color:gray">no_driver_version_fail</span><span style="color:navy">:                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1A2A                 </span><span style="color:navy">or      ax, ax          </span>; error code returned?
<span style="color:black">SYSINIT:1A2C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fail_driver_load
</span><span style="color:black">SYSINIT:1A2E
SYSINIT:1A2E </span>magic_is_resident<span style="color:navy">:
</span><span style="color:black">SYSINIT:1A2E                 </span><span style="color:navy">mov     ax, cs:</span>break_addr
<span style="color:black">SYSINIT:1A32                 </span><span style="color:navy">call    </span>ParaRound       ; convert to paragraphs
<span style="color:black">SYSINIT:1A35                 </span><span style="color:navy">add     ax, cs:</span>break_addr<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">SYSINIT:1A3A                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:1A3E                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; store normalized end here
<span style="color:black">SYSINIT:1A45                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">4           </span>; inquire how many paragraphs it wants
<span style="color:black">SYSINIT:1A48                 </span><span style="color:navy">call    cs:</span>MagicBackdoor
<span style="color:black">SYSINIT:1A4D                 </span><span style="color:navy">mov     bx, cs:</span>ALLOCLIM ; get top of free memory
<span style="color:black">SYSINIT:1A52                 </span><span style="color:navy">sub     bx, ax          </span>; see how much we&#039;ll lower it
<span style="color:black">SYSINIT:1A54                 </span><span style="color:navy">cmp     bx, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2 </span>; is there that much room free?
<span style="color:black">SYSINIT:1A59                 </span><span style="color:navy">jb      short </span>cant_move_driver
<span style="color:black">SYSINIT:1A5B                 </span><span style="color:navy">sub     cs:</span>ALLOCLIM<span style="color:navy">, ax </span>; (mov [cs:ALLOCLIM],bx)
<span style="color:black">SYSINIT:1A60                 </span><span style="color:navy">mov     es, cs:</span>ALLOCLIM
<span style="color:black">SYSINIT:1A65                 </span>assume es:nothing
<span style="color:black">SYSINIT:1A65                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">6           </span>; tell the driver to move itself
<span style="color:black">SYSINIT:1A68                 </span><span style="color:navy">call    cs:</span>MagicBackdoor
<span style="color:black">SYSINIT:1A6D                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax </span>; save end of low stub
<span style="color:black">SYSINIT:1A71
SYSINIT:1A71 </span>cant_move_driver<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1A71                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2 </span>; get terminate segment
<span style="color:black">SYSINIT:1A75                 </span><span style="color:navy">cmp     ax, cs:</span>DevLoadEnd ; terminate size TOO big?
<span style="color:black">SYSINIT:1A7A                 </span><span style="color:navy">ja      short </span><span style="color:gray">pre_exit_err </span>; error out if so
<span style="color:black">SYSINIT:1A7C
SYSINIT:1A7C </span>_isblock<span style="color:navy">:                               </span>; if no units found, erase the device
<span style="color:black">SYSINIT:1A7C                 </span><span style="color:navy">mov     al, cs:</span>unitcount
<span style="color:black">SYSINIT:1A80                 </span><span style="color:navy">or      al, al
</span><span style="color:black">SYSINIT:1A82                 </span><span style="color:navy">jz      short </span><span style="color:gray">pre_exit_err
</span><span style="color:black">SYSINIT:1A84                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:1A86                 </span><span style="color:navy">lds     si, cs:</span>DevEntry ; set ds:si to header
<span style="color:black">SYSINIT:1A8B                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1A8B                 </span><span style="color:navy">mov     [si+</span><span style="color:green">10</span><span style="color:navy">], al     </span>; mov [si+SYSDEV.NAME],al
<span style="color:black">SYSINIT:1A8B                                         </span>; number of units in name field
<span style="color:black">SYSINIT:1A8B                                         </span>; device drivers are *supposed*
<span style="color:black">SYSINIT:1A8B                                         </span>; to do this for themselves.
<span style="color:black">SYSINIT:1A8E                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:1A90                 </span><span style="color:navy">les     di, cs:</span>DOSINFO  ; es:di point to dos info
<span style="color:black">SYSINIT:1A95                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">] </span>; [es:di+SYSI_NUMIO]
<span style="color:black">SYSINIT:1A95                                         </span>; get number of devices
<span style="color:black">SYSINIT:1A99                 </span><span style="color:navy">mov     dl, ah
</span><span style="color:black">SYSINIT:1A9B                 </span><span style="color:navy">add     ah, al          </span>; check for too many devices
<span style="color:black">SYSINIT:1A9D                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">26          </span>; &#039;A&#039; - &#039;Z&#039; is 26 devices
<span style="color:black">SYSINIT:1AA0                 </span><span style="color:navy">ja      short </span><span style="color:gray">pre_exit_err
</span><span style="color:black">SYSINIT:1AA2                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2
</span><span style="color:black">SYSINIT:1AA8                 </span><span style="color:navy">call    </span>DevSetBreak
<span style="color:black">SYSINIT:1AAB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_ok_block
</span><span style="color:black">SYSINIT:1AAD                 </span><span style="color:navy">jmp     </span><span style="color:gray">pre_exit_err
</span><span style="color:black">SYSINIT:1AB0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1AB0
SYSINIT:1AB0 </span><span style="color:gray">_ok_block</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1AB0                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">], ah </span>; [es:di+SYSI_NUMIO] ; update the amount
<span style="color:black">SYSINIT:1AB4                 </span><span style="color:navy">lds     bx, cs:</span>bpb_addr ; point to bpb array (*)
<span style="color:black">SYSINIT:1AB9                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:black">SYSINIT:1ABB
SYSINIT:1ABB </span>_perunit<span style="color:navy">:
</span><span style="color:black">SYSINIT:1ABB                 </span><span style="color:navy">les     bp, cs:</span>DOSINFO
<span style="color:black">SYSINIT:1AC0                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; es:[bp.sysi_dpb]
<span style="color:black">SYSINIT:1AC0                                         </span>; get first dpb
<span style="color:black">SYSINIT:1AC0                                         </span>; [es:bp+SysInitvars.SYSI_DPB] ; [es:bp+0]
<span style="color:black">SYSINIT:1AC4
SYSINIT:1AC4 </span><span style="color:gray">_scandpb</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1AC4                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; -1 ; es:[bp.dpb_next_dpb]
<span style="color:black">SYSINIT:1AC9                 </span><span style="color:navy">jz      short </span><span style="color:gray">_foundpb
</span><span style="color:black">SYSINIT:1ACB                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; les bp,es:[bp.dpb_next_dpb]
<span style="color:black">SYSINIT:1ACB                                         </span>; [es:bp+DPB.NEXT_DPB]
<span style="color:black">SYSINIT:1ACF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_scandpb
</span><span style="color:black">SYSINIT:1AD1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1AD1
SYSINIT:1AD1 </span><span style="color:gray">_foundpb</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1AD1                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr
<span style="color:black">SYSINIT:1AD5                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">], ax </span>; es:[bp.dpb_next_dpb] ; DPB.NEXT_DPB
<span style="color:black">SYSINIT:1AD9                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">SYSINIT:1ADD                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], ax </span>; es:[bp.dpb_next_dpb+2] ; DPB.NEXT_DPB+2
<span style="color:black">SYSINIT:1AE1                 </span><span style="color:navy">les     bp, cs:</span>DevBrkAddr
<span style="color:black">SYSINIT:1AE6                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; -1
<span style="color:black">SYSINIT:1AEC                 </span><span style="color:navy">mov     byte ptr es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; es:[bp.dpb_first_access],-1
<span style="color:black">SYSINIT:1AEC                                         </span>; DPB.FIRST_ACCESS
<span style="color:black">SYSINIT:1AF1                 </span><span style="color:navy">add     word ptr cs:</span>DevBrkAddr<span style="color:navy">, </span><span style="color:green">61 </span>; DPBSIZ ; 3Dh
<span style="color:black">SYSINIT:1AF7                 </span><span style="color:navy">call    </span>RoundBreakAddr
<span style="color:black">SYSINIT:1AFA                 </span><span style="color:navy">mov     si, [bx]        </span>; ds:si points to bpb (*)
<span style="color:black">SYSINIT:1AFA                                         </span>; (mov si,[bx] ..and then.. add bx,2)
<span style="color:black">SYSINIT:1AFA                                         </span>; Note: If unit count &gt; 1, bx points to a BPB in the BPB array,
<span style="color:black">SYSINIT:1AFA                                         </span>; the array address is in [bpb_addr] (*)
<span style="color:black">SYSINIT:1AFA                                         </span>; Erdogan Tan - 07/07/2023
<span style="color:black">SYSINIT:1AFC                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], dl   </span>; mov word ptr es:[bp.dpb_drive],dx
<span style="color:black">SYSINIT:1AFC                                         </span>; [es:bp+DPB.DRIVE],dl
<span style="color:black">SYSINIT:1B00                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">], dh   </span>; [es:bp+DPB.UNIT],dh
<span style="color:black">SYSINIT:1B04                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1B05                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:1B06                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">4152h       </span>; DX = signature 4152h (&#039;AR&#039;) for FAT32 extended BPB/DPB
<span style="color:black">SYSINIT:1B09                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">SYSINIT:1B0B                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], cx </span>; DPB.NEXT_FREE ; last allocated cluster #
<span style="color:black">SYSINIT:1B0F                 </span><span style="color:navy">cmp     [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], cx    </span>; BPB.fatsecs16 ; [si+A_BPB.BPB_SECTORSPERFAT]
<span style="color:black">SYSINIT:1B12                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_setdpb   </span>; FAT DPB (33 bytes)
<span style="color:black">SYSINIT:1B12                                         </span>; FAT32 DPB (61 bytes)
<span style="color:black">SYSINIT:1B14                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">], cx </span>; DPB.RESERVED = 0
<span style="color:black">SYSINIT:1B18                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], cx </span>; DPB.RESERVED+2 = 0
<span style="color:black">SYSINIT:1B1C                 </span><span style="color:navy">dec     cx              </span>; 0FFFFh ; -1
<span style="color:black">SYSINIT:1B1D                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], cx </span>; DPB.FREE_CNT (-1 = unknown)
<span style="color:black">SYSINIT:1B21                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], cx </span>; DPB.FREE_CNT+2 (-1 = unknown)
<span style="color:black">SYSINIT:1B25                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4558h       </span>; CX = signature 4558h (&#039;EX&#039;) for FAT32 extended BPB/DPB
<span style="color:black">SYSINIT:1B28
SYSINIT:1B28 </span><span style="color:gray">_setdpb</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1B28                 </span><span style="color:navy">mov     ah, </span><span style="color:green">53h         </span>; SETDPB ; hidden system call
<span style="color:black">SYSINIT:1B2A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - TRANSLATE BIOS PARAMETER BLOCK
<span style="color:black">SYSINIT:1B2A                                         </span>; DS:SI -&gt; BPB (BIOS Parameter Block)
<span style="color:black">SYSINIT:1B2A                                         </span>; ES:BP -&gt; buffer for DOS Drive Parameter Block
<span style="color:black">SYSINIT:1B2A                                         </span>; (if CX=4558h &amp; DX=4152h, FAT32 Extended DPB will be set)
<span style="color:black">SYSINIT:1B2C                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:1B2D                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1B2E                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; es:[bp.dpb_sector_size]  ; [es:bp+DPB.SECTOR_SIZE]
<span style="color:black">SYSINIT:1B32                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:1B33                 </span><span style="color:navy">les     di, cs:</span>DOSINFO
<span style="color:black">SYSINIT:1B38                 </span><span style="color:navy">cmp     ax, es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; es:[di.sysi_maxsec] ; [es:di+SysInitvars.SYSI_MAXSEC]
<span style="color:black">SYSINIT:1B3C                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:1B3D                 </span><span style="color:navy">jbe     short </span><span style="color:gray">_iblk_1
</span><span style="color:black">SYSINIT:1B3F                 </span><span style="color:navy">mov     ax, </span><span style="color:green">40h         </span>; SYSPRE_BADFILE_ERROR ; (pre_exit_err)
<span style="color:black">SYSINIT:1B3F                                         </span>; (problem loading dblspace.bin)
<span style="color:black">SYSINIT:1B42                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1B43 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1B43
SYSINIT:1B43 </span><span style="color:gray">_iblk_1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1B43                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1B44                 </span><span style="color:navy">lds     ax, cs:</span>DevEntry
<span style="color:black">SYSINIT:1B49                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">], ax </span>; [es:bp+DPB.DRIVER_ADDR]
<span style="color:black">SYSINIT:1B4D                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ds </span>; [es:bp+DPB.DRIVER_ADDR+2]
<span style="color:black">SYSINIT:1B51                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1B52                 </span><span style="color:navy">inc     dl              </span>; increment drive number
<span style="color:black">SYSINIT:1B54                 </span><span style="color:navy">inc     dh              </span>; increment unit number
<span style="color:black">SYSINIT:1B56                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:1B57                 </span><span style="color:navy">inc     bx              </span>; point to next BPB
<span style="color:black">SYSINIT:1B57                                         </span>; (in the BPB array) (*) -add bx,2-
<span style="color:black">SYSINIT:1B58                 </span><span style="color:navy">dec     cx              </span>; loop _foundpb
<span style="color:black">SYSINIT:1B59                 </span><span style="color:navy">jz      short </span><span style="color:gray">_linkit
</span><span style="color:black">SYSINIT:1B5B                 </span><span style="color:navy">jmp     </span><span style="color:gray">_foundpb
</span><span style="color:black">SYSINIT:1B5E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1B5E
SYSINIT:1B5E </span><span style="color:gray">_linkit</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1B5E                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:1B5F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1B60                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:1B60                 </span><span style="color:navy">call    </span>TempCDS         ; set cds for new drives
<span style="color:black">SYSINIT:1B63                 </span><span style="color:navy">les     di, cs:</span>DOSINFO  ; es:di = dos table (SysInitVars)
<span style="color:black">SYSINIT:1B68                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">22h</span><span style="color:navy">] </span>; [es:di+SYSI_DEV] ; dx:cx = head of list
<span style="color:black">SYSINIT:1B6C                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">24h</span><span style="color:navy">] </span>; [es:di+SYSI_DEV+2]
<span style="color:black">SYSINIT:1B70                 </span><span style="color:navy">lds     si, cs:</span>DevEntry ; ds:si = device location
<span style="color:black">SYSINIT:1B75                 </span>assume ds:nothing
<span style="color:black">SYSINIT:1B75                 </span><span style="color:navy">mov     [si], ax        </span>; link in the driver
<span style="color:black">SYSINIT:1B77                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], bx
</span><span style="color:black">SYSINIT:1B7A                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">22h</span><span style="color:navy">], si </span>; [es:di+SYSI_DEV] ; set head of list in dos
<span style="color:black">SYSINIT:1B7E                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">24h</span><span style="color:navy">], ds </span>; [es:di+SYSI_DEV+2]
<span style="color:black">SYSINIT:1B82                 </span><span style="color:navy">call    </span>DevBreak        ; mark successful install
<span style="color:black">SYSINIT:1B85                 </span><span style="color:navy">mov     cx, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2 </span>; pass it a work buffer
<span style="color:black">SYSINIT:1B8A                 </span><span style="color:navy">mov     dx, cs:</span>ALLOCLIM ; address in cx (segment)
<span style="color:black">SYSINIT:1B8F                 </span><span style="color:navy">sub     dx, cx          </span>; for len dx (paragraphs)
<span style="color:black">SYSINIT:1B91                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5500h       </span>; we&#039;re shuffle aware, but don&#039;t move
<span style="color:black">SYSINIT:1B91                                         </span>; any drives at this point.
<span style="color:black">SYSINIT:1B94                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">2           </span>; switch what we can now
<span style="color:black">SYSINIT:1B97                 </span><span style="color:navy">call    cs:</span>MagicBackdoor
<span style="color:black">SYSINIT:1B9C
SYSINIT:1B9C </span>pre_exit<span style="color:navy">:                               </span>; no errors!
<span style="color:black">SYSINIT:1B9C                 </span><span style="color:navy">xor     ax, ax          </span>; zf=1
<span style="color:black">SYSINIT:1B9E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1B9E </span>MagicPreload    <span style="color:black">endp
SYSINIT:1B9E
SYSINIT:1B9F
SYSINIT:1B9F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1B9F
SYSINIT:1B9F
SYSINIT:1B9F </span>MagicPostload   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1B9F                 </span><span style="color:navy">call    </span>get_dblspace_version ; is it there?
<span style="color:black">SYSINIT:1BA2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_magic  </span>; done if not
<span style="color:black">SYSINIT:1BA4                 </span><span style="color:navy">test    dx, </span><span style="color:green">8000h       </span>; is it already permanent?
<span style="color:black">SYSINIT:1BA8                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_magic  </span>; no, done if so (not in final position)
<span style="color:black">SYSINIT:1BAA                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh      </span>; -1 ; how much space does it want?
<span style="color:black">SYSINIT:1BAD                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A11h       </span>; multMagicdrv
<span style="color:black">SYSINIT:1BAD                                         </span>; DBLSPACE.BIN - GET RELOCATION SIZE
<span style="color:black">SYSINIT:1BB0                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; get paragraphs into ax
<span style="color:black">SYSINIT:1BB2                 </span><span style="color:navy">inc     ax              </span>; extra 2 paragraphs for the stub
<span style="color:black">SYSINIT:1BB3                 </span><span style="color:navy">inc     ax              </span>; ((tiny_stub_end-tiny_stub_start)+15)/16
<span style="color:black">SYSINIT:1BB3                                         </span>; (18+15)/16 = 2
<span style="color:black">SYSINIT:1BB4                 </span><span style="color:navy">mov     cs:</span>DevSize<span style="color:navy">, ax  </span>; store that (**)
<span style="color:black">SYSINIT:1BB8                 </span><span style="color:navy">mov     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; not to be loaded in UMB
<span style="color:black">SYSINIT:1BBE                 </span><span style="color:navy">mov     word ptr cs:</span>bpb_addr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cs </span>; pass name so that
<span style="color:black">SYSINIT:1BBE                                         </span>; arena header can be set
<span style="color:black">SYSINIT:1BC3                 </span><span style="color:navy">mov     word ptr cs:</span>bpb_addr<span style="color:navy">, offset </span>MagicDDName <span style="color:gray">; &quot;\\DBLSPACE.BIN&quot;
</span><span style="color:black">SYSINIT:1BCA                 </span><span style="color:navy">call    </span>round           ; normalize memhi:memlo
<span style="color:black">SYSINIT:1BCD                 </span><span style="color:navy">call    </span>InitDevLoad     ; set up sub-arena, DevLoadAddr,
<span style="color:black">SYSINIT:1BCD                                         </span>; DevLoadEnd, and DevEntry
<span style="color:black">SYSINIT:1BCD                                         </span>; gets arena name from bpb_addr
<span style="color:black">SYSINIT:1BD0                 </span><span style="color:navy">mov     es, cs:</span>DevLoadAddr ; (**) (InitDevload sets this)
<span style="color:black">SYSINIT:1BD5                 </span><span style="color:navy">xor     di, di          </span>; move a little header in place
<span style="color:black">SYSINIT:1BD5                                         </span>; so that this looks to the mem command
<span style="color:black">SYSINIT:1BD5                                         </span>; like a legitimate driver load
<span style="color:black">SYSINIT:1BD7                 </span><span style="color:navy">mov     si, offset </span>tiny_stub_start
<span style="color:black">SYSINIT:1BDA                 </span><span style="color:navy">mov     cx, </span><span style="color:green">18          </span>; (tiny_stub_end-tiny_stub_start)
<span style="color:black">SYSINIT:1BDD                 </span><span style="color:navy">rep movsb               </span>; move it!
<span style="color:black">SYSINIT:1BDF                 </span><span style="color:navy">mov     ax, es          </span>; advance es appropriately
<span style="color:black">SYSINIT:1BE1                 </span><span style="color:navy">inc     ax              </span>; add ax,((tiny_stub_end-tiny_stub_start)+15)/16
<span style="color:black">SYSINIT:1BE2                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:1BE3                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:1BE5                 </span>assume es:MSLOAD
<span style="color:black">SYSINIT:1BE5                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFEh      </span>; -2 ; final placement!
<span style="color:black">SYSINIT:1BE8                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A11h       </span>; multMagicdrv
<span style="color:black">SYSINIT:1BEB                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; DBLSPACE.BIN - RELOCATE
<span style="color:black">SYSINIT:1BEB                                         </span>; es = segment to which to relocate DBLSPACE.BIN
<span style="color:black">SYSINIT:1BED                 </span><span style="color:navy">mov     ax, cs:</span>DevLoadAddr ; (**)
<span style="color:black">SYSINIT:1BF1                 </span><span style="color:navy">add     ax, cs:</span>DevSize  ; calculate seg after DD load
<span style="color:black">SYSINIT:1BF6                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax </span>; save as ending address!
<span style="color:black">SYSINIT:1BFA                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:1C01                 </span><span style="color:navy">call    </span>DevSetBreak     ; go ahead and alloc mem for device
<span style="color:black">SYSINIT:1C04                 </span><span style="color:navy">call    </span>DevBreak
<span style="color:black">SYSINIT:1C07
SYSINIT:1C07 </span><span style="color:gray">no_magic</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1C07                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1C07 </span>MagicPostload   <span style="color:black">endp
SYSINIT:1C07
SYSINIT:1C08
SYSINIT:1C08 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1C08
SYSINIT:1C08
SYSINIT:1C08 </span>MagicSetCdss    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1C08                 </span><span style="color:navy">call    </span>get_dblspace_version ; is it there?
<span style="color:black">SYSINIT:1C0B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">magic_set_exit </span>; done if not
<span style="color:black">SYSINIT:1C0B                                         </span>; ...
<span style="color:black">SYSINIT:1C0B                                         </span>; cl = first DblSpace drive in ASCII
<span style="color:black">SYSINIT:1C0B                                         </span>; ch = number of DblSpace drive letters
<span style="color:black">SYSINIT:1C0D                 </span><span style="color:navy">lds     si, cs:</span>DOSINFO  ; point to DOS data area (SysInitVars)
<span style="color:black">SYSINIT:1C12                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">16h</span><span style="color:navy">]    </span>; lds si,[si+SYSI_CDS] ; fetch CDSs
<span style="color:black">SYSINIT:1C15                 </span><span style="color:navy">mov     ah, </span><span style="color:green">88          </span>; curdirLen
<span style="color:black">SYSINIT:1C17                 </span><span style="color:navy">sub     cl, &#039;</span><span style="color:green">A&#039;         </span>; make it zero based.
<span style="color:black">SYSINIT:1C1A                 </span><span style="color:navy">mov     al, cl          </span>; get first DblSpace drive letter
<span style="color:black">SYSINIT:1C1C                 </span><span style="color:navy">mul     ah              </span>; find first DblSpace CDS
<span style="color:black">SYSINIT:1C1E                 </span><span style="color:navy">add     si, ax          </span>; cds pointer
<span style="color:black">SYSINIT:1C20                 </span><span style="color:navy">mov     dl, cl          </span>; save for drive testing loop
<span style="color:black">SYSINIT:1C22                 </span><span style="color:navy">mov     cl, ch          </span>; get DblSpace drive count into cx
<span style="color:black">SYSINIT:1C24                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">SYSINIT:1C26
SYSINIT:1C26 </span><span style="color:gray">magic_set_cdss_1</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1C26                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:1C27                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1C28                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:1C29                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:1C2A                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A11h       </span>; multMagicdrv
<span style="color:black">SYSINIT:1C2D                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1           </span>; MD_DRIVE_MAP ; inquire drive map
<span style="color:black">SYSINIT:1C30                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; DBLSPACE.BIN - &quot;GetDriveMapping&quot;
<span style="color:black">SYSINIT:1C30                                         </span>; see if this is an unused DblSpace drive
<span style="color:black">SYSINIT:1C32                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:1C33                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:1C34                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1C35                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:1C36                 </span><span style="color:navy">cmp     dl, bl          </span>; if mapped to itself, it is vacant
<span style="color:black">SYSINIT:1C38                 </span><span style="color:navy">jnz     short </span><span style="color:gray">magic_set_cdss_2 </span>; skip if used
<span style="color:black">SYSINIT:1C3A                 </span><span style="color:navy">and     word ptr [si+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">0BFFFh </span>; reset the bit in flags (curdir_inuse bit)
<span style="color:black">SYSINIT:1C3A                                         </span>; [si+curdir_list.cdir_flags],~curdir_inuse ; word
<span style="color:black">SYSINIT:1C3A                                         </span>; (.. [si+1+curdir_list.cdir_flags],0BFh ; byte)
<span style="color:black">SYSINIT:1C3F
SYSINIT:1C3F </span><span style="color:gray">magic_set_cdss_2</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1C3F                 </span><span style="color:navy">add     si, </span><span style="color:green">88          </span>; curdirLen
<span style="color:black">SYSINIT:1C42                 </span><span style="color:navy">inc     dl              </span>; next drive
<span style="color:black">SYSINIT:1C44                 </span><span style="color:navy">loop    </span><span style="color:gray">magic_set_cdss_1
</span><span style="color:black">SYSINIT:1C46
SYSINIT:1C46 </span><span style="color:gray">magic_set_exit</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1C46                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1C46 </span>MagicSetCdss    <span style="color:black">endp
SYSINIT:1C46
SYSINIT:1C47
SYSINIT:1C47 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1C47
SYSINIT:1C47
SYSINIT:1C47 </span>get_dblspace_version <span style="color:black">proc near          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1C47                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4A11h       </span>; multMagicdrv
<span style="color:black">SYSINIT:1C47                                         </span>; DBLSPACE.BIN - &quot;GetVersion&quot; - INSTALLATION CHECK
<span style="color:black">SYSINIT:1C47                                         </span>; (BX = 0)
<span style="color:black">SYSINIT:1C4A                 </span><span style="color:navy">xor     bx, bx          </span>; MD_VERSION = 0
<span style="color:black">SYSINIT:1C4C                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Return:
<span style="color:black">SYSINIT:1C4C                                         </span>;  AX = 0000h (successful)
<span style="color:black">SYSINIT:1C4C                                         </span>;  BX = 444Dh (&quot;DM&quot;)
<span style="color:black">SYSINIT:1C4C                                         </span>;  CL = first drive letter used by DBLSPACE (41h = A:)
<span style="color:black">SYSINIT:1C4C                                         </span>;  CH = number of drive letters used by DBLSPACE
<span style="color:black">SYSINIT:1C4C                                         </span>;  DX = internal DBLSPACE.BIN version number (bits 14-0)
<span style="color:black">SYSINIT:1C4C                                         </span>;  bit 15 set if DBLSPACE.BIN has not yet been relocated
<span style="color:black">SYSINIT:1C4C                                         </span>;  to final position in memory (i.e. DBLSPACE.SYS /MOVE)
<span style="color:black">SYSINIT:1C4E                 </span><span style="color:navy">or      ax, ax          </span>; ax = 0 (successful, zf=1)
<span style="color:black">SYSINIT:1C50                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1C50 </span>get_dblspace_version <span style="color:black">endp
SYSINIT:1C50
SYSINIT:1C50 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:1C51                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:1C52 </span>config_envlen   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C52                                         </span>; when config_wrkseg is being used as
<span style="color:gray">SYSINIT:1C52                                         </span>; a scratch env, this is its length
<span style="color:gray">SYSINIT:1C54 </span>config_wrkseg   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C54                                         </span>; config work area (above confbot)
<span style="color:gray">SYSINIT:1C54                                         </span>; segment of work area
<span style="color:gray">SYSINIT:1C56 </span>config_cmd      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C56                                         </span>; current config cmd
<span style="color:gray">SYSINIT:1C56                                         </span>; (with CONFIG_OPTION_QUERY bit intact)
<span style="color:gray">SYSINIT:1C57 </span>config_multi    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C57                                         </span>; non-zero if multi-config config.sys
<span style="color:gray">SYSINIT:1C58 </span>multdeviceflag  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C59 </span>devmark_addr    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C59                                         </span>; segment address for devmark.
<span style="color:gray">SYSINIT:1C5B </span>setdevmarkflag  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C5B                                         </span>; flag used for devmark
<span style="color:gray">SYSINIT:1C5C </span>drivers_units   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C5C                                         </span>; total unitcount for driver
<span style="color:gray">SYSINIT:1C5D </span>ems_stub_installed <span style="color:navy">db </span><span style="color:#008040">0                 </span>; (not used)
<span style="color:gray">SYSINIT:1C5E </span>badparm_ptr     <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C5E                                         </span>; badparm_off equ badparm_ptr
<span style="color:gray">SYSINIT:1C5E                                         </span>; badparm_seg equ badparm_ptr+2
<span style="color:gray">SYSINIT:1C62 </span>_$P_ORDINAL     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C62                                         </span>; Operand ordinal save area
<span style="color:gray">SYSINIT:1C64 </span>_$P_RC          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C64                                         </span>; Return code from parser
<span style="color:gray">SYSINIT:1C66 </span>_$P_SI_Save     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C66                                         </span>; Pointer of command buffer
<span style="color:gray">SYSINIT:1C68 </span>_$P_DX          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C68                                         </span>; Return result buffer address
<span style="color:gray">SYSINIT:1C6A </span>_$P_Terminator  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C6A                                         </span>; Terminator code (ASCII)
<span style="color:gray">SYSINIT:1C6B </span>_$P_DBCSEV_OFF  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C6B                                         </span>; Offset of DBCS EV
<span style="color:gray">SYSINIT:1C6D </span>_$P_DBCSEV_SEG  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C6D                                         </span>; Segment of DBCS EV
<span style="color:gray">SYSINIT:1C6F </span>_$P_Flags       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C6F                                         </span>; Parser internal flags
<span style="color:gray">SYSINIT:1C6F                                         </span>; %define _$P_Flags1 _$P_Flags
<span style="color:gray">SYSINIT:1C6F                                         </span>;         to reference 1st byte flags
<span style="color:gray">SYSINIT:1C6F                                         </span>; %define _$P_Flags2 _$P_Flags+1
<span style="color:gray">SYSINIT:1C6F                                         </span>;         to reference 2nd byte flags only
<span style="color:gray">SYSINIT:1C70 </span>_$P_Flags2      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C71 </span>_$P_SaveSI_Cmpx <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C71                                         </span>; save si for later use by complex
<span style="color:gray">SYSINIT:1C73 </span>_$P_KEYorSW_Ptr <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C73                                         </span>; points next to &quot;=&quot; or &quot;:&quot; code
<span style="color:gray">SYSINIT:1C75 </span>_$P_Save_EOB    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C75                                         </span>; save pointer to EOB
<span style="color:gray">SYSINIT:1C77 </span>_$P_Found_SYNONYM <span style="color:navy">dw </span><span style="color:#008040">0                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C77                                         </span>; es:@ points to found synonym
<span style="color:gray">SYSINIT:1C79 </span>_$P_STRING_BUF  <span style="color:navy">db </span><span style="color:#008040">128 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1C79                                         </span>; Pick a operand from command line
<span style="color:gray">SYSINIT:1CF9 </span>_$P_Char_CAP_Ptr <span style="color:navy">db </span><span style="color:#008040">0FFh                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1CF9                                         </span>; info id
<span style="color:gray">SYSINIT:1CFA                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; offset of char case map table
<span style="color:gray">SYSINIT:1CFC                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; segment of char case map table
<span style="color:gray">SYSINIT:1CFE </span>_$P_FileSp_Char <span style="color:navy">db &#039;[]|&lt;&gt;+=;&quot;&#039;          </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1CFE                                         </span>; delimitters of file spec
<span style="color:gray">SYSINIT:1CFE                                         </span>; _$P_FileSp_Len equ $-_$P_FileSp_Char
<span style="color:gray">SYSINIT:1D07 </span>_$P_err_flag    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:1D07                                         </span>; flag set if filespec parsing error
<span style="color:gray">SYSINIT:1D07                                         </span>; was detected.
<span style="color:black">SYSINIT:1D08
SYSINIT:1D08 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1D08
SYSINIT:1D08
SYSINIT:1D08 </span>SysParse        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1D08
SYSINIT:1D08 </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:1E12 SIZE 00000069 BYTES
</span><span style="color:black">SYSINIT:1D08
SYSINIT:1D08                 </span><span style="color:navy">mov     word ptr cs:</span>_$P_Flags<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Clear all internal flags
<span style="color:black">SYSINIT:1D0F                 </span><span style="color:navy">cld                     </span>; confirm forward direction
<span style="color:black">SYSINIT:1D10                 </span><span style="color:navy">mov     cs:</span>_$P_ORDINAL<span style="color:navy">, cx </span>; save operand ordinal
<span style="color:black">SYSINIT:1D15                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; _$P_No_Error ; assume no error
<span style="color:black">SYSINIT:1D1C                 </span><span style="color:navy">mov     cs:</span>_$P_Found_SYNONYM<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; initalize synonym pointer
<span style="color:black">SYSINIT:1D23                 </span><span style="color:navy">mov     cs:</span>_$P_DX<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; The table of special chars _$P_FileSp_Char
<span style="color:black">SYSINIT:1D23                                         </span>; should be initialized on every entry to SysParse
<span style="color:black">SYSINIT:1D2A                 </span><span style="color:navy">mov     word ptr cs:</span>_$P_FileSp_Char<span style="color:navy">, </span><span style="color:#ff8000">5D5Bh </span><span style="color:gray">; &quot;[]|&lt;&gt;+=;\&quot;&quot;
</span><span style="color:black">SYSINIT:1D31                 </span><span style="color:navy">mov     word ptr cs:</span>_$P_FileSp_Char<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">3C7Ch </span><span style="color:gray">; &quot;|&lt;&gt;+=;\&quot;&quot;
</span><span style="color:black">SYSINIT:1D38                 </span><span style="color:navy">mov     word ptr cs:</span>_$P_FileSp_Char<span style="color:navy">+</span><span style="color:green">4</span><span style="color:navy">, </span><span style="color:#ff8000">2B3Eh </span><span style="color:gray">; &quot;&gt;+=;\&quot;&quot;
</span><span style="color:black">SYSINIT:1D3F                 </span><span style="color:navy">mov     word ptr cs:</span>_$P_FileSp_Char<span style="color:navy">+</span><span style="color:green">6</span><span style="color:navy">, </span><span style="color:#ff8000">3B3Dh </span><span style="color:gray">; &quot;=;\&quot;&quot;
</span><span style="color:black">SYSINIT:1D46                 </span><span style="color:navy">call    </span>_$P_Skip_Delim  ; Move si to 1st non white space
<span style="color:black">SYSINIT:1D49                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_Start </span>; If EOL is not encountered, do parse
<span style="color:black">SYSINIT:1D4B                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL  ; set exit code to -1
<span style="color:black">SYSINIT:1D4E                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:1D4F                 </span><span style="color:navy">mov     bx, es:[di]     </span>; [es:di+_$P_PARMS_Blk.PARMSX_Address]
<span style="color:black">SYSINIT:1D4F                                         </span>; Get the PARMSX address to
<span style="color:black">SYSINIT:1D52                 </span><span style="color:navy">cmp     cl, es:[bx]     </span>; [es:bx+_$P_PARMSX_Blk.MinP]
<span style="color:black">SYSINIT:1D52                                         </span>; check ORDINAL to see if the minimum
<span style="color:black">SYSINIT:1D55                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_Fin   </span>; positional found.
<span style="color:black">SYSINIT:1D57                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; $P_Op_Missing ; If no, set exit code to missing operand
<span style="color:black">SYSINIT:1D5A
SYSINIT:1D5A </span><span style="color:gray">_$P_Fin</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1D5A                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1D5B                 </span><span style="color:navy">jmp     </span><span style="color:gray">_$P_Single_Exit </span>; return to the caller
<span style="color:black">SYSINIT:1D5E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1D5E
SYSINIT:1D5E </span><span style="color:gray">_$P_Start</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1D5E                 </span><span style="color:navy">mov     cs:</span>_$P_SaveSI_Cmpx<span style="color:navy">, si </span>; save ptr to command line for later use
<span style="color:black">SYSINIT:1D5E                                         </span>; by complex quoted string or file spec.
<span style="color:black">SYSINIT:1D63                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:1D64                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:1D65                 </span><span style="color:navy">push    bp
</span><span style="color:black">SYSINIT:1D66                 </span><span style="color:navy">lea     bx, </span>_$P_STRING_BUF ; set buffer to copy from command string
<span style="color:black">SYSINIT:1D6A                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">20h </span>; _$P_Extra ; 3/9 extra delimiter encountered ?
<span style="color:black">SYSINIT:1D70                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Pack_End </span>; 3/9 if yes, no need to copy
<span style="color:black">SYSINIT:1D72
SYSINIT:1D72 </span><span style="color:gray">_$P_Pack_Loop</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1D72                 </span><span style="color:navy">lodsb                   </span>; Pick a operand from buffer
<span style="color:black">SYSINIT:1D73                 </span><span style="color:navy">call    </span>_$P_Chk_Switch  ; Check switch character
<span style="color:black">SYSINIT:1D76                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Pack_End_BY_EOL </span>; if carry set found delimiter type slash,
<span style="color:black">SYSINIT:1D76                                         </span>; need backup si, else continue
<span style="color:black">SYSINIT:1D78                 </span><span style="color:navy">call    </span>_$P_Chk_EOL     ; Check EOL character
<span style="color:black">SYSINIT:1D7B                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Pack_End_BY_EOL </span>; need backup si
<span style="color:black">SYSINIT:1D7D                 </span><span style="color:navy">call    </span>_$P_Chk_Delim   ; Check delimiter
<span style="color:black">SYSINIT:1D80                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_PL01  </span>; If no, process next byte
<span style="color:black">SYSINIT:1D82                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">20h </span>; _$P_Extra ; 3/9 If yes and white spec,
<span style="color:black">SYSINIT:1D88                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Pack_End_backup_si </span>; 3/9 then
<span style="color:black">SYSINIT:1D8A                 </span><span style="color:navy">call    </span>_$P_Skip_Delim  ; skip subsequent white space,too
<span style="color:black">SYSINIT:1D8D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Pack_End </span>; finish copy by placing NUL at end
<span style="color:black">SYSINIT:1D8F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1D8F
SYSINIT:1D8F </span><span style="color:gray">_$P_Pack_End_backup_si</span><span style="color:navy">:                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1D8F                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">41h </span>; _$P_SW+_$P_equ
<span style="color:black">SYSINIT:1D95                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Pack_End
</span><span style="color:black">SYSINIT:1D97                 </span><span style="color:navy">dec     si
</span><span style="color:black">SYSINIT:1D98                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Pack_End
</span><span style="color:black">SYSINIT:1D9A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1D9A
SYSINIT:1D9A </span><span style="color:gray">_$P_PL01</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1D9A                 </span><span style="color:navy">mov     cs:[bx], al     </span>; move byte to STRING_BUF
<span style="color:black">SYSINIT:1D9D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Dh </span><span style="color:gray">; &#039;=&#039;   </span>; _$P_Keyword ; if it is equal character,
<span style="color:black">SYSINIT:1D9F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_PL00  </span>; then
<span style="color:black">SYSINIT:1DA1                 </span><span style="color:navy">or      cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">1 </span>; _$P_equ ; remember it in flag
<span style="color:black">SYSINIT:1DA7
SYSINIT:1DA7 </span><span style="color:gray">_$P_PL00</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1DA7                 </span><span style="color:navy">inc     bx              </span>; ready to see next byte
<span style="color:black">SYSINIT:1DA8                 </span><span style="color:navy">call    </span>_$P_Chk_DBCS    ; was it 1st byte of DBCS ?
<span style="color:black">SYSINIT:1DAB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_Pack_Loop </span>; if no, process to next byte
<span style="color:black">SYSINIT:1DAD                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:1DAE                 </span><span style="color:navy">mov     cs:[bx], al     </span>; if yes, store 2nd byte of DBCS
<span style="color:black">SYSINIT:1DB1                 </span><span style="color:navy">inc     bx              </span>; update pointer
<span style="color:black">SYSINIT:1DB2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Pack_Loop </span>; process to next byte
<span style="color:black">SYSINIT:1DB4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1DB4
SYSINIT:1DB4 </span><span style="color:gray">_$P_Pack_End_BY_EOL</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1DB4                 </span><span style="color:navy">dec     si              </span>; backup si pointer
<span style="color:black">SYSINIT:1DB5
SYSINIT:1DB5 </span><span style="color:gray">_$P_Pack_End</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1DB5                 </span><span style="color:navy">mov     cs:</span>_$P_SI_Save<span style="color:navy">, si </span>; save next pointer, SI
<span style="color:black">SYSINIT:1DBA                 </span><span style="color:navy">mov     byte ptr cs:[bx], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; put NULL at the end
<span style="color:black">SYSINIT:1DBE                 </span><span style="color:navy">mov     cs:</span>_$P_Save_EOB<span style="color:navy">, bx </span>; keep the address for later use of complex
<span style="color:black">SYSINIT:1DC3                 </span><span style="color:navy">mov     bx, es:[di]     </span>; [es:di+_$P_PARMS_Blk.PARMSX_Address]
<span style="color:black">SYSINIT:1DC3                                         </span>; get PARMSX address
<span style="color:black">SYSINIT:1DC6                 </span><span style="color:navy">lea     si, </span>_$P_STRING_BUF
<span style="color:black">SYSINIT:1DCA                 </span><span style="color:navy">cmp     byte ptr cs:[si], </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039; </span>; the operand begins w/ switch char ?
<span style="color:black">SYSINIT:1DCA                                         </span>; _$P_Switch
<span style="color:black">SYSINIT:1DCE                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SW_Manager </span>; if yes, process as switch
<span style="color:black">SYSINIT:1DD0                 </span><span style="color:navy">cmp     byte ptr cs:[si], </span><span style="color:#ff8000">22h </span><span style="color:gray">; &#039;&quot;&#039; </span>; _$P_DQuote  ; is it a string?
<span style="color:black">SYSINIT:1DD4                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Positional_Manager </span>; if so, process as one!
<span style="color:black">SYSINIT:1DD6                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">1 </span>; $P_equ ; the operand includes equal
<span style="color:black">SYSINIT:1DDC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Key_Manager </span>; if yes, process as keyword
<span style="color:black">SYSINIT:1DDE
SYSINIT:1DDE </span><span style="color:gray">_$P_Positional_Manager</span><span style="color:navy">:                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1DDE                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; else process as positional
<span style="color:black">SYSINIT:1DDE                                         </span>; get maxp
<span style="color:black">SYSINIT:1DE2                 </span><span style="color:navy">xor     ah, ah          </span>; ax = maxp
<span style="color:black">SYSINIT:1DE4                 </span><span style="color:navy">cmp     cs:</span>_$P_ORDINAL<span style="color:navy">, ax </span>; too many positional ?
<span style="color:black">SYSINIT:1DE9                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_Too_Many_Error </span>; if yes, set exit code to too many
<span style="color:black">SYSINIT:1DEB                 </span><span style="color:navy">mov     ax, cs:</span>_$P_ORDINAL ; see what the current ordinal
<span style="color:black">SYSINIT:1DEF                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1           </span>; ax = ax*2
<span style="color:black">SYSINIT:1DF1                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:1DF2                 </span><span style="color:navy">inc     bx              </span>; add &#039;2&#039; to bx reg
<span style="color:black">SYSINIT:1DF2                                         </span>; now bx points to 1st CONTROL
<span style="color:black">SYSINIT:1DF3                 </span><span style="color:navy">add     bx, ax          </span>; now bx points to specified CONTROL address
<span style="color:black">SYSINIT:1DF5                 </span><span style="color:navy">mov     bx, es:[bx]     </span>; now bx points to specified CONTROL itself
<span style="color:black">SYSINIT:1DF8                 </span><span style="color:navy">call    </span>_$P_Chk_Pos_Control ; Do process for positional
<span style="color:black">SYSINIT:1DFB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Return_to_Caller </span>; and return to the caller
<span style="color:black">SYSINIT:1DFD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1DFD
SYSINIT:1DFD </span><span style="color:gray">_$P_Too_Many_Error</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1DFD                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">1    </span>; set exit code
<span style="color:black">SYSINIT:1E04                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Return_to_Caller </span>; and return to the caller
<span style="color:black">SYSINIT:1E04 </span>SysParse        <span style="color:black">endp
SYSINIT:1E04
SYSINIT:1E06
SYSINIT:1E06 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1E06
SYSINIT:1E06
SYSINIT:1E06 </span>get_maxp        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E06                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [es:bx+_$P_PARMSX_Blk.MaxP] ; get maxp
<span style="color:black">SYSINIT:1E0A                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:1E0C                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:1E0D                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:1E0F                 </span><span style="color:navy">add     bx, ax          </span>; now bx points to maxs
<span style="color:black">SYSINIT:1E11                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1E11 </span>get_maxp        <span style="color:black">endp
SYSINIT:1E11
SYSINIT:1E12 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1E12 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR SysParse
</span><span style="color:black">SYSINIT:1E12
SYSINIT:1E12 </span><span style="color:gray">_$P_SW_Manager</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E12                 </span><span style="color:navy">call    </span>get_maxp
<span style="color:black">SYSINIT:1E15                 </span><span style="color:navy">mov     cl, es:[bx]
</span><span style="color:black">SYSINIT:1E18                 </span><span style="color:navy">xor     ch, ch          </span>; cx = maxs
<span style="color:black">SYSINIT:1E18                                         </span>; at least one switch ?
<span style="color:black">SYSINIT:1E1A                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">_$P_SW_Not_Found </span>; no
<span style="color:black">SYSINIT:1E1C                 </span><span style="color:navy">inc     bx              </span>; now bx points to 1st CONTROL address
<span style="color:black">SYSINIT:1E1D
SYSINIT:1E1D </span><span style="color:gray">_$P_SW_Mgr_Loop</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E1D                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:1E1E                 </span><span style="color:navy">mov     bx, es:[bx]     </span>; bx points to Switch CONTROL itself
<span style="color:black">SYSINIT:1E21                 </span><span style="color:navy">call    </span>_$P_Chk_SW_Control
<span style="color:black">SYSINIT:1E24                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1E25                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_Return_to_Caller </span>;
<span style="color:black">SYSINIT:1E25                                         </span>; if the CONTROL is for the switch, exit
<span style="color:black">SYSINIT:1E27                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:1E28                 </span><span style="color:navy">inc     bx              </span>;    add &#039;2&#039; to bx reg
<span style="color:black">SYSINIT:1E28                                         </span>; else bx points to the next CONTROL
<span style="color:black">SYSINIT:1E29                 </span><span style="color:navy">loop    </span><span style="color:gray">_$P_SW_Mgr_Loop </span>; and loop
<span style="color:black">SYSINIT:1E2B
SYSINIT:1E2B </span><span style="color:gray">_$P_SW_Not_Found</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E2B                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">3    </span>; _$P_Not_In_SW
<span style="color:black">SYSINIT:1E2B                                         </span>; here no CONTROL for the switch has
<span style="color:black">SYSINIT:1E32                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Return_to_Caller
</span><span style="color:black">SYSINIT:1E34 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1E34
SYSINIT:1E34 </span><span style="color:gray">_$P_Key_Manager</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E34                 </span><span style="color:navy">call    </span>get_maxp
<span style="color:black">SYSINIT:1E37                 </span><span style="color:navy">mov     al, es:[bx]
</span><span style="color:black">SYSINIT:1E3A                 </span><span style="color:navy">xor     ah, ah          </span>; ax = maxs
<span style="color:black">SYSINIT:1E3C                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:1E3E                 </span><span style="color:navy">inc     ax              </span>; ax = ax*2+1
<span style="color:black">SYSINIT:1E3F                 </span><span style="color:navy">add     bx, ax          </span>; now bx points to maxk
<span style="color:black">SYSINIT:1E41                 </span><span style="color:navy">mov     cl, es:[bx]     </span>; cx = maxk
<span style="color:black">SYSINIT:1E44                 </span><span style="color:navy">xor     ch, ch          </span>; at least one keyword ?
<span style="color:black">SYSINIT:1E46                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">_$P_Key_Not_Found </span>; no
<span style="color:black">SYSINIT:1E48                 </span><span style="color:navy">inc     bx              </span>; now bx points to 1st CONTROL
<span style="color:black">SYSINIT:1E49
SYSINIT:1E49 </span><span style="color:gray">_$P_Key_Mgr_Loop</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E49                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:1E4A                 </span><span style="color:navy">mov     bx, es:[bx]     </span>; bx points to keyword CONTROL itself
<span style="color:black">SYSINIT:1E4D                 </span><span style="color:navy">call    </span>_$P_Chk_Key_Control ; do process for keyword
<span style="color:black">SYSINIT:1E50                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1E51                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_Return_to_Caller </span>;
<span style="color:black">SYSINIT:1E51                                         </span>; if the CONTROL is for the keyword, exit
<span style="color:black">SYSINIT:1E53                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:1E54                 </span><span style="color:navy">inc     bx              </span>;    add &#039;2&#039; to bx reg
<span style="color:black">SYSINIT:1E54                                         </span>; else bx points to the next CONTROL
<span style="color:black">SYSINIT:1E55                 </span><span style="color:navy">loop    </span><span style="color:gray">_$P_Key_Mgr_Loop </span>; and loop
<span style="color:black">SYSINIT:1E57
SYSINIT:1E57 </span><span style="color:gray">_$P_Key_Not_Found</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E57                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">4    </span>; _$P_Not_In_Key
<span style="color:black">SYSINIT:1E57                                         </span>; here no CONTROL for the keyword has
<span style="color:black">SYSINIT:1E5E
SYSINIT:1E5E </span><span style="color:gray">_$P_Return_to_Caller</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E5E                 </span><span style="color:navy">pop     bp
</span><span style="color:black">SYSINIT:1E5F                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:1E60                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1E61                 </span><span style="color:navy">mov     cx, cs:</span>_$P_ORDINAL ; return next ordinal
<span style="color:black">SYSINIT:1E66                 </span><span style="color:navy">mov     ax, cs:</span>_$P_RC   ; return exit code
<span style="color:black">SYSINIT:1E6A                 </span><span style="color:navy">mov     si, cs:</span>_$P_SI_Save ; return next operand pointer
<span style="color:black">SYSINIT:1E6F                 </span><span style="color:navy">mov     dx, cs:</span>_$P_DX   ; return result buffer address
<span style="color:black">SYSINIT:1E74                 </span><span style="color:navy">mov     bl, cs:</span>_$P_Terminator ; return delimiter code found
<span style="color:black">SYSINIT:1E79
SYSINIT:1E79 </span><span style="color:gray">_$P_Single_Exit</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E79                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:1E7A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1E7A </span><span style="color:gray">; END OF FUNCTION CHUNK FOR SysParse
</span><span style="color:black">SYSINIT:1E7B
SYSINIT:1E7B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1E7B
SYSINIT:1E7B
SYSINIT:1E7B </span>_$P_Chk_Pos_Control <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E7B                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1E7C                 </span><span style="color:navy">mov     ax, es:[bx]     </span>; [es:bx+_$P_Control_Blk.Match_Flag]
<span style="color:black">SYSINIT:1E7F                 </span><span style="color:navy">test    ax, </span><span style="color:green">2           </span>; $P_Repeat ; repeat allowed ?
<span style="color:black">SYSINIT:1E82                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_CPC00 </span>; then do not increment ORDINAL
<span style="color:black">SYSINIT:1E84                 </span><span style="color:navy">inc     cs:</span>_$P_ORDINAL  ; update the ordinal
<span style="color:black">SYSINIT:1E89
SYSINIT:1E89 </span><span style="color:gray">_$P_CPC00</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E89                 </span><span style="color:navy">cmp     byte ptr cs:[si], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; no data ?
<span style="color:black">SYSINIT:1E8D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_CPC01
</span><span style="color:black">SYSINIT:1E8F                 </span><span style="color:navy">test    ax, </span><span style="color:green">1           </span>; _$P_Optional ; yes, then is it optional ?
<span style="color:black">SYSINIT:1E92                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_CPC02
</span><span style="color:black">SYSINIT:1E94                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">2    </span>; _$P_Op_Missing ; no, then error
<span style="color:black">SYSINIT:1E9B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_CPC_Exit
</span><span style="color:black">SYSINIT:1E9D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1E9D
SYSINIT:1E9D </span><span style="color:gray">_$P_CPC02</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1E9D                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1E9E                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FF03h      </span>; (_$P_No_Tag&lt;&lt;8)|_$P_String
<span style="color:black">SYSINIT:1E9E                                         </span>; if it is optional return NULL
<span style="color:black">SYSINIT:1E9E                                         </span>; no item tag indication
<span style="color:black">SYSINIT:1EA1                 </span><span style="color:navy">call    </span>_$P_Fill_Result
<span style="color:black">SYSINIT:1EA4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1EA5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_CPC_Exit
</span><span style="color:black">SYSINIT:1EA7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1EA7
SYSINIT:1EA7 </span><span style="color:gray">_$P_CPC01</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EA7                 </span><span style="color:navy">call    </span>_$P_Check_Match_Flags
<span style="color:black">SYSINIT:1EAA
SYSINIT:1EAA </span><span style="color:gray">_$P_CPC_Exit</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EAA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1EAB                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1EAB </span>_$P_Chk_Pos_Control <span style="color:black">endp
SYSINIT:1EAB
SYSINIT:1EAC
SYSINIT:1EAC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1EAC
SYSINIT:1EAC
SYSINIT:1EAC </span>_$P_Chk_Key_Control <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EAC                 </span><span style="color:navy">stc                     </span>; this logic works
<span style="color:black">SYSINIT:1EAC                                         </span>; when the KeySW is reset.
<span style="color:black">SYSINIT:1EAD                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1EAD </span>_$P_Chk_Key_Control <span style="color:black">endp
SYSINIT:1EAD
SYSINIT:1EAE
SYSINIT:1EAE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1EAE
SYSINIT:1EAE
SYSINIT:1EAE </span>_$P_Search_KEYorSW <span style="color:black">proc near            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EAE                 </span><span style="color:navy">push    bp
</span><span style="color:black">SYSINIT:1EAF                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:1EB0                 </span><span style="color:navy">mov     cl, es:[bx+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; [es:bx+_$P_Control_Blk.nid] ; Get synonym count
<span style="color:black">SYSINIT:1EB4                 </span><span style="color:navy">xor     ch, ch          </span>; and set it to cx
<span style="color:black">SYSINIT:1EB6                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">_$P_KEYorSW_Not_Found </span>; No synonyms specified ?
<span style="color:black">SYSINIT:1EB6                                         </span>; then indicate not found by CY
<span style="color:black">SYSINIT:1EB8                 </span><span style="color:navy">lea     bp, [bx+</span><span style="color:#ff8000">9</span><span style="color:navy">]      </span>; [bx+_$P_Control_Blk.KEYorSW]
<span style="color:black">SYSINIT:1EBB
SYSINIT:1EBB </span><span style="color:gray">_$P_KEYorSW_Loop</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EBB                 </span><span style="color:navy">call    </span>_$P_String_Comp ; compare string in buffer w/ the synonym
<span style="color:black">SYSINIT:1EBE                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_KEYorSW_Found </span>; If match, set it to synonym pointer
<span style="color:black">SYSINIT:1EC0                 </span><span style="color:navy">call    </span>_$P_MoveBP_NUL  ; else, bp points to the next string
<span style="color:black">SYSINIT:1EC3                 </span><span style="color:navy">loop    </span><span style="color:gray">_$P_KEYorSW_Loop </span>; loop nid times
<span style="color:black">SYSINIT:1EC5
SYSINIT:1EC5 </span><span style="color:gray">_$P_KEYorSW_Not_Found</span><span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EC5                 </span><span style="color:navy">stc                     </span>; indicate not found in synonym list
<span style="color:black">SYSINIT:1EC6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_KEYorSW_Exit </span>; and exit
<span style="color:black">SYSINIT:1EC8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1EC8
SYSINIT:1EC8 </span><span style="color:gray">_$P_KEYorSW_Found</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EC8                 </span><span style="color:navy">mov     cs:</span>_$P_Found_SYNONYM<span style="color:navy">, bp </span>; set synonym pointer
<span style="color:black">SYSINIT:1ECD                 </span><span style="color:navy">clc                     </span>; indicate found
<span style="color:black">SYSINIT:1ECE
SYSINIT:1ECE </span><span style="color:gray">_$P_KEYorSW_Exit</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1ECE                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:1ECF                 </span><span style="color:navy">pop     bp
</span><span style="color:black">SYSINIT:1ED0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1ED0 </span>_$P_Search_KEYorSW <span style="color:black">endp
SYSINIT:1ED0
SYSINIT:1ED1
SYSINIT:1ED1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1ED1
SYSINIT:1ED1
SYSINIT:1ED1 </span>_$P_MoveBP_NUL  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1ED1                 </span><span style="color:navy">cmp     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; _$P_NULL
<span style="color:black">SYSINIT:1ED1                                         </span>; Increment BP that points
<span style="color:black">SYSINIT:1ED6                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_MBP_Exit </span>; to the synomym list
<span style="color:black">SYSINIT:1ED8                 </span><span style="color:navy">inc     bp              </span>; until
<span style="color:black">SYSINIT:1ED9                 </span><span style="color:navy">jmp     short </span>_$P_MoveBP_NUL ; NULL encountered.
<span style="color:black">SYSINIT:1ED9                                         </span>; _$P_MBP_Loop
<span style="color:black">SYSINIT:1EDB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1EDB
SYSINIT:1EDB </span><span style="color:gray">_$P_MBP_Exit</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EDB                 </span><span style="color:navy">inc     bp              </span>; bp points to next to NULL
<span style="color:black">SYSINIT:1EDC                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1EDC </span>_$P_MoveBP_NUL  <span style="color:black">endp
SYSINIT:1EDC
SYSINIT:1EDD
SYSINIT:1EDD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1EDD
SYSINIT:1EDD
SYSINIT:1EDD </span>_$P_Chk_SW_Control <span style="color:black">proc near            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1EDD                 </span><span style="color:navy">or      cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">10h </span>; (Check if switch is supported)
<span style="color:black">SYSINIT:1EDD                                         </span>; _$P_SW_Cmp
<span style="color:black">SYSINIT:1EDD                                         </span>; Indicate switch for later string comparison
<span style="color:black">SYSINIT:1EE3                 </span><span style="color:navy">call    </span>_$P_Search_KEYorSW ; Search the switch in the CONTROL block
<span style="color:black">SYSINIT:1EE6                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Chk_SW_Err0 </span>; not found, then try next CONTROL
<span style="color:black">SYSINIT:1EE8                 </span><span style="color:navy">and     cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">0EFh </span>; and byte [cs:_$P_Flags2],0FFh-_$P_SW_Cmp
<span style="color:black">SYSINIT:1EE8                                         </span>; reset the indicator previously set /switch
<span style="color:black">SYSINIT:1EEE                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1EEF                 </span><span style="color:navy">mov     ax, cs:</span>_$P_KEYorSW_Ptr
<span style="color:black">SYSINIT:1EF3                 </span><span style="color:navy">sub     ax, si          </span>; [si] = KEY or SW
<span style="color:black">SYSINIT:1EF5                 </span><span style="color:navy">add     cs:</span>_$P_SaveSI_Cmpx<span style="color:navy">, ax </span>; update for complex list
<span style="color:black">SYSINIT:1EFA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1EFB                 </span><span style="color:navy">mov     si, cs:</span>_$P_KEYorSW_Ptr ; set si at the end or colon
<span style="color:black">SYSINIT:1F00                 </span><span style="color:navy">cmp     byte ptr cs:[si], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; any data after colon ?
<span style="color:black">SYSINIT:1F04                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_CSW00 </span>; if yes, process match flags
<span style="color:black">SYSINIT:1F06                 </span><span style="color:navy">cmp     byte ptr cs:[si-</span><span style="color:green">1</span><span style="color:navy">], &#039;</span><span style="color:green">:&#039; </span>; _$P_Colon
<span style="color:black">SYSINIT:1F06                                         </span>; if no, the switch terminated by colon ?
<span style="color:black">SYSINIT:1F0B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Chk_if_data_required </span>;
<span style="color:black">SYSINIT:1F0B                                         </span>; if yes,
<span style="color:black">SYSINIT:1F0D                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax ; return syntax error
<span style="color:black">SYSINIT:1F14                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Chk_SW_Exit
</span><span style="color:black">SYSINIT:1F16 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F16
SYSINIT:1F16 </span><span style="color:gray">_$P_Chk_if_data_required</span><span style="color:navy">:               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F16                 </span><span style="color:navy">cmp     word ptr es:[bx], </span><span style="color:#ff8000">0 </span>; [es:bx+_$P_Control_Blk.Match_Flag]
<span style="color:black">SYSINIT:1F16                                         </span>; should have data?
<span style="color:black">SYSINIT:1F16                                         </span>; zero match flag means switch followed by nothing is OK
<span style="color:black">SYSINIT:1F1A                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_SW_Exit </span>; match flags not zero so
<span style="color:black">SYSINIT:1F1A                                         </span>; should have something if optional bit is not on
<span style="color:black">SYSINIT:1F1C                 </span><span style="color:navy">test    word ptr es:[bx], </span><span style="color:green">1 </span>; _$P_Optional ; see if no value is valid
<span style="color:black">SYSINIT:1F21                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Chk_SW_Exit </span>; if so, then leave, else yell
<span style="color:black">SYSINIT:1F23                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">2    </span>; _$P_Op_Missing
<span style="color:black">SYSINIT:1F23                                         </span>; return required operand missing
<span style="color:black">SYSINIT:1F2A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Chk_SW_Exit
</span><span style="color:black">SYSINIT:1F2C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F2C
SYSINIT:1F2C </span><span style="color:gray">_$P_CSW00</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F2C                 </span><span style="color:navy">call    </span>_$P_Check_Match_Flags ; process match flag
<span style="color:black">SYSINIT:1F2F                 </span><span style="color:navy">clc                     </span>; indicate match
<span style="color:black">SYSINIT:1F30                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Chk_SW_Single_Exit
</span><span style="color:black">SYSINIT:1F32 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F32
SYSINIT:1F32 </span><span style="color:gray">_$P_Chk_SW_Err0</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F32                 </span><span style="color:navy">stc                     </span>; not found in switch synonym list
<span style="color:black">SYSINIT:1F33                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1F34 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F34
SYSINIT:1F34 </span><span style="color:gray">_$P_Chk_SW_Exit</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F34                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1F35                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FF03h      </span>; (_$P_No_Tag&lt;&lt;8)|_$P_String
<span style="color:black">SYSINIT:1F38                 </span><span style="color:navy">call    </span>_$P_Fill_Result ; set result buffer
<span style="color:black">SYSINIT:1F3B                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1F3C                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:1F3D
SYSINIT:1F3D </span><span style="color:gray">_$P_Chk_SW_Single_Exit</span><span style="color:navy">:                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F3D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1F3D </span>_$P_Chk_SW_Control <span style="color:black">endp
SYSINIT:1F3D
SYSINIT:1F3E
SYSINIT:1F3E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1F3E
SYSINIT:1F3E
SYSINIT:1F3E </span>_$P_Fill_Result <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F3E                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:1F3F                 </span><span style="color:navy">mov     di, es:[bx+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:bx+_$P_Control_Blk.Result_Buf]
<span style="color:black">SYSINIT:1F3F                                         </span>; di points to result buffer
<span style="color:black">SYSINIT:1F43                 </span><span style="color:navy">mov     cs:</span>_$P_DX<span style="color:navy">, di   </span>; set returned result address
<span style="color:black">SYSINIT:1F48                 </span><span style="color:navy">mov     es:[di], al     </span>; [es:di+_$P_Result_Blk.Type] ; store type
<span style="color:black">SYSINIT:1F4B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">], ah   </span>; [es:di+_$P_Result_Blk.Item_Tag] ; store item tag
<span style="color:black">SYSINIT:1F4F                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1F50                 </span><span style="color:navy">mov     ax, cs:</span>_$P_Found_SYNONYM
<span style="color:black">SYSINIT:1F54                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax   </span>; [es:di+_$P_Result_Blk.SYNONYM_Ptr]
<span style="color:black">SYSINIT:1F58                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1F59
SYSINIT:1F59 </span>_$P_RLT04<span style="color:navy">:                              </span>;
<span style="color:black">SYSINIT:1F59                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; _$P_Number ; if number
<span style="color:black">SYSINIT:1F5B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_RLT00 </span>;
<span style="color:black">SYSINIT:1F5B                                         </span>; then store 32 bit
<span style="color:black">SYSINIT:1F5D
SYSINIT:1F5D </span><span style="color:gray">_$P_RLT02</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F5D                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], dx   </span>; [es:di+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:1F61                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], cx   </span>; [es:di+_$P_Result_Blk.Picked_Val+2]
<span style="color:black">SYSINIT:1F65                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_RLT_Exit
</span><span style="color:black">SYSINIT:1F67 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F67
SYSINIT:1F67 </span><span style="color:gray">_$P_RLT00</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F67                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; _$P_List_Idx ; if list index
<span style="color:black">SYSINIT:1F69                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_RLT01 </span>;
<span style="color:black">SYSINIT:1F69                                         </span>; then store list index
<span style="color:black">SYSINIT:1F6B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], dx   </span>; [es:di+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:1F6F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_RLT_Exit
</span><span style="color:black">SYSINIT:1F71 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F71
SYSINIT:1F71 </span><span style="color:gray">_$P_RLT01</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F71                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7           </span>; _$P_Date_F ; Date format ?
<span style="color:black">SYSINIT:1F73                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_RLT02
</span><span style="color:black">SYSINIT:1F75                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8           </span>; _$P_Time_F ; Time format ?
<span style="color:black">SYSINIT:1F77                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_RLT02
</span><span style="color:black">SYSINIT:1F79                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6           </span>; _$P_Drive ; drive format ?
<span style="color:black">SYSINIT:1F7B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_RLT03
</span><span style="color:black">SYSINIT:1F7D                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], dl   </span>; [es:di+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:1F7D                                         </span>; store drive number
<span style="color:black">SYSINIT:1F81                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_RLT_Exit
</span><span style="color:black">SYSINIT:1F83 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F83
SYSINIT:1F83 </span><span style="color:gray">_$P_RLT03</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F83                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4           </span>; _$P_Complex ; complex format ?
<span style="color:black">SYSINIT:1F85                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_RLT05
</span><span style="color:black">SYSINIT:1F87                 </span><span style="color:navy">mov     ax, cs:</span>_$P_SaveSI_Cmpx ;
<span style="color:black">SYSINIT:1F87                                         </span>; then get pointer in command buffer
<span style="color:black">SYSINIT:1F8B                 </span><span style="color:navy">inc     ax              </span>; skip left Parentheses
<span style="color:black">SYSINIT:1F8C                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax   </span>; [es:di+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:1F8C                                         </span>; store offset
<span style="color:black">SYSINIT:1F90                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], ds </span>; [es:di+_$P_Result_Blk.Picked_Val+2]
<span style="color:black">SYSINIT:1F90                                         </span>; store segment
<span style="color:black">SYSINIT:1F94                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_RLT_Exit
</span><span style="color:black">SYSINIT:1F96 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1F96
SYSINIT:1F96 </span><span style="color:gray">_$P_RLT05</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1F96                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], si   </span>; AL = 3, 5, or 9
<span style="color:black">SYSINIT:1F96                                         </span>; [es:di+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:1F96                                         </span>; store offset of STRING_BUF
<span style="color:black">SYSINIT:1F9A                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], cs </span>; [es:di+_$P_Result_Blk.Picked_Val+2]
<span style="color:black">SYSINIT:1F9A                                         </span>; store segment of STRING_BUF
<span style="color:black">SYSINIT:1F9E                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1F9F                 </span><span style="color:navy">test    byte ptr es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:bx+_$P_Control_Blk.Function_Flag],
<span style="color:black">SYSINIT:1F9F                                         </span>; _$P_CAP_File
<span style="color:black">SYSINIT:1F9F                                         </span>; need CAPS by file table?
<span style="color:black">SYSINIT:1FA4                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_RLT_CAP00
</span><span style="color:black">SYSINIT:1FA6                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4           </span>; _$P_DOSTBL_File ; use file upper case table
<span style="color:black">SYSINIT:1FA8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_RLT_CAP02
</span><span style="color:black">SYSINIT:1FAA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1FAA
SYSINIT:1FAA </span><span style="color:gray">_$P_RLT_CAP00</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FAA                 </span><span style="color:navy">test    byte ptr es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">2 </span>; [es:bx+_$P_Control_Blk.Function_Flag],
<span style="color:black">SYSINIT:1FAA                                         </span>; _$P_CAP_Char
<span style="color:black">SYSINIT:1FAA                                         </span>; need CAPS by char table
<span style="color:black">SYSINIT:1FAF                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_RLT_CAP01
</span><span style="color:black">SYSINIT:1FB1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; _$P_DOSTBL_Char
<span style="color:black">SYSINIT:1FB1                                         </span>; use character upper case table
<span style="color:black">SYSINIT:1FB3
SYSINIT:1FB3 </span><span style="color:gray">_$P_RLT_CAP02</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FB3                 </span><span style="color:navy">call    </span>_$P_Do_CAPS_String ; process CAPS along the table
<span style="color:black">SYSINIT:1FB6
SYSINIT:1FB6 </span><span style="color:gray">_$P_RLT_CAP01</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FB6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1FB7                 </span><span style="color:navy">test    byte ptr es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">10h </span>; [es:bx+_$P_Control_Blk.Function_Flag],
<span style="color:black">SYSINIT:1FB7                                         </span>; _$P_Rm_Colon
<span style="color:black">SYSINIT:1FB7                                         </span>; removing colon at end ?
<span style="color:black">SYSINIT:1FBC                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_RLT_Exit
</span><span style="color:black">SYSINIT:1FBE                 </span><span style="color:navy">call    </span>_$P_Remove_Colon ; then process it.
<span style="color:black">SYSINIT:1FC1
SYSINIT:1FC1 </span><span style="color:gray">_$P_RLT_Exit</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FC1                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:1FC2                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:1FC2 </span>_$P_Fill_Result <span style="color:black">endp
SYSINIT:1FC2
SYSINIT:1FC3
SYSINIT:1FC3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:1FC3
SYSINIT:1FC3
SYSINIT:1FC3 </span>_$P_Check_Match_Flags <span style="color:black">proc near         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FC3                 </span><span style="color:navy">mov     cs:</span>_$P_err_flag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; _$P_NULL ; clear filespec error flag.
<span style="color:black">SYSINIT:1FC9                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1FCA                 </span><span style="color:navy">mov     ax, es:[bx]     </span>; [es:bx+_$P_Control_Blk.Match_Flag]
<span style="color:black">SYSINIT:1FCA                                         </span>; load match flag (16bit) to ax
<span style="color:black">SYSINIT:1FCD                 </span><span style="color:navy">or      ax, ax          </span>; test ax for zero
<span style="color:black">SYSINIT:1FCF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Mat
</span><span style="color:black">SYSINIT:1FD1                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:1FD2                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:1FD3                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:1FD4                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:1FD5                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax
<span style="color:black">SYSINIT:1FDC                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FF03h
</span><span style="color:black">SYSINIT:1FDF                 </span><span style="color:navy">call    </span>_$P_Fill_Result
<span style="color:black">SYSINIT:1FE2                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:1FE3                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:1FE4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:1FE5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:1FE6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Bridge
</span><span style="color:black">SYSINIT:1FE8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1FE8
SYSINIT:1FE8 </span><span style="color:gray">_$P_Mat</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FE8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Match03
</span><span style="color:black">SYSINIT:1FEA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1FEA
SYSINIT:1FEA </span><span style="color:gray">_$P_Bridge</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FEA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Match_Exit
</span><span style="color:black">SYSINIT:1FEC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:1FEC                 </span><span style="color:navy">nop                     </span>; 90h
<span style="color:black">SYSINIT:1FED
SYSINIT:1FED </span><span style="color:gray">_$P_Match03</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:1FED                 </span><span style="color:navy">test    ax, </span><span style="color:green">8000h       </span>; _$P_Num_Val ; Numeric value
<span style="color:black">SYSINIT:1FF0                 </span><span style="color:navy">jz      short </span>_$P_Match04
<span style="color:black">SYSINIT:1FF2                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; _$P_No_Error ; assume no error
<span style="color:black">SYSINIT:1FF9                 </span><span style="color:navy">call    </span>_$P_Value       ; do process
<span style="color:black">SYSINIT:1FFC                 </span><span style="color:navy">cmp     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax ; if error, examine the next type
<span style="color:black">SYSINIT:2002                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Match_Exit
</span><span style="color:black">SYSINIT:2004
SYSINIT:2004 </span>_$P_Match04<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2004                 </span><span style="color:navy">test    ax, </span><span style="color:green">4000h       </span>; _$P_SNum_Val ; Signed numeric value
<span style="color:black">SYSINIT:2007                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Match05
</span><span style="color:black">SYSINIT:2009                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; _$P_No_Error ; assume no error
<span style="color:black">SYSINIT:2010                 </span><span style="color:navy">call    </span>_$P_SValue      ; do process
<span style="color:black">SYSINIT:2013                 </span><span style="color:navy">cmp     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax ; if error, examine the next type
<span style="color:black">SYSINIT:2019                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Match_Exit
</span><span style="color:black">SYSINIT:201B
SYSINIT:201B </span><span style="color:gray">_$P_Match05</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:201B                 </span><span style="color:navy">test    ax, </span><span style="color:green">100h        </span>; _$P_Drv_Only ; Drive only
<span style="color:black">SYSINIT:201E                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Match06
</span><span style="color:black">SYSINIT:2020                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; _$P_No_Error ; assume no error
<span style="color:black">SYSINIT:2027                 </span><span style="color:navy">call    </span>_$P_File_Format ; 1st, call file format
<span style="color:black">SYSINIT:202A                 </span><span style="color:navy">call    </span>_$P_Drive_Format ; check drive format, next
<span style="color:black">SYSINIT:202D                 </span><span style="color:navy">cmp     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax ; if error, examine the next type
<span style="color:black">SYSINIT:2033                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Match_Exit
</span><span style="color:black">SYSINIT:2035
SYSINIT:2035 </span><span style="color:gray">_$P_Match06</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2035                 </span><span style="color:navy">test    ax, </span><span style="color:green">200h        </span>; _$P_File_Spc ; File spec
<span style="color:black">SYSINIT:2038                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Match07
</span><span style="color:black">SYSINIT:203A                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; _$P_No_Error ; assume no error
<span style="color:black">SYSINIT:2041                 </span><span style="color:navy">call    </span>_$P_File_Format ; do process
<span style="color:black">SYSINIT:2044                 </span><span style="color:navy">cmp     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax ; if error, examine the next type
<span style="color:black">SYSINIT:204A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Match_Exit
</span><span style="color:black">SYSINIT:204C
SYSINIT:204C </span><span style="color:gray">_$P_Match07</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:204C                 </span><span style="color:navy">test    ax, </span><span style="color:green">2000h       </span>; _$P_Simple_S ; Simple string
<span style="color:black">SYSINIT:204F                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Match_Exit
</span><span style="color:black">SYSINIT:2051                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; _$P_No_Error ; assume no error
<span style="color:black">SYSINIT:2058                 </span><span style="color:navy">call    </span>_$P_Simple_String ; do process
<span style="color:black">SYSINIT:205B
SYSINIT:205B </span><span style="color:gray">_$P_Match_Exit</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:205B                 </span><span style="color:navy">cmp     cs:</span>_$P_err_flag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; _$P_error_filespec ; bad filespec ?
<span style="color:black">SYSINIT:2061                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Match2_Exit </span>; no, continue
<span style="color:black">SYSINIT:2063                 </span><span style="color:navy">cmp     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; _$P_No_Error ; check for other errors ?
<span style="color:black">SYSINIT:2069                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Match2_Exit </span>; no, continue
<span style="color:black">SYSINIT:206B                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax ; set error flag
<span style="color:black">SYSINIT:2072
SYSINIT:2072 </span><span style="color:gray">_$P_Match2_Exit</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2072                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:2073                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2073 </span>_$P_Check_Match_Flags <span style="color:black">endp
SYSINIT:2073
SYSINIT:2074
SYSINIT:2074 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:2074
SYSINIT:2074
SYSINIT:2074 </span>_$P_Remove_Colon <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2074                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:2075                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:2076
SYSINIT:2076 </span><span style="color:gray">_$P_RCOL_Loop</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2076                 </span><span style="color:navy">mov     al, cs:[si]     </span>; get character
<span style="color:black">SYSINIT:2079                 </span><span style="color:navy">or      al, al          </span>; end of string ?
<span style="color:black">SYSINIT:207B                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_RCOL_Exit </span>; if yes, just exit
<span style="color:black">SYSINIT:207D                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">:&#039;         </span>; _$P_Colon ; is it colon ?
<span style="color:black">SYSINIT:207F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_RCOL00
</span><span style="color:black">SYSINIT:2081                 </span><span style="color:navy">cmp     byte ptr cs:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; _$P_NULL
<span style="color:black">SYSINIT:2081                                         </span>; if so, next is NULL ?
<span style="color:black">SYSINIT:2086                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_RCOL00 </span>; no, then next char
<span style="color:black">SYSINIT:2088                 </span><span style="color:navy">mov     byte ptr cs:[si], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; yes, remove colon
<span style="color:black">SYSINIT:208C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_RCOL_Exit </span>; and exit.
<span style="color:black">SYSINIT:208E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:208E
SYSINIT:208E </span><span style="color:gray">_$P_RCOL00</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:208E                 </span><span style="color:navy">call    </span>_$P_Chk_DBCS    ; if not colon, then check if
<span style="color:black">SYSINIT:208E                                         </span>; DBCS leading byte.
<span style="color:black">SYSINIT:2091                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_RCOL01
</span><span style="color:black">SYSINIT:2093                 </span><span style="color:navy">inc     si              </span>; if yes, skip trailing byte
<span style="color:black">SYSINIT:2094
SYSINIT:2094 </span><span style="color:gray">_$P_RCOL01</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2094                 </span><span style="color:navy">inc     si              </span>; si points to next byte
<span style="color:black">SYSINIT:2095                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_RCOL_Loop </span>; loop until NULL encountered
<span style="color:black">SYSINIT:2097 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2097
SYSINIT:2097 </span><span style="color:gray">_$P_RCOL_Exit</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2097                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2098                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:2099                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2099 </span>_$P_Remove_Colon <span style="color:black">endp
SYSINIT:2099
SYSINIT:209A
SYSINIT:209A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:209A
SYSINIT:209A
SYSINIT:209A </span>_$P_Do_CAPS_String <span style="color:black">proc near            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:209A                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:209B                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:209C                 </span><span style="color:navy">mov     dl, al          </span>; save info id
<span style="color:black">SYSINIT:209E
SYSINIT:209E </span><span style="color:gray">_$P_DCS_Loop</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:209E                 </span><span style="color:navy">mov     al, cs:[si]     </span>; load charater and
<span style="color:black">SYSINIT:20A1                 </span><span style="color:navy">call    </span>_$P_Chk_DBCS    ; check if DBCS leading byte
<span style="color:black">SYSINIT:20A4                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_DCS00 </span>; if yes, do not need CAPS
<span style="color:black">SYSINIT:20A6                 </span><span style="color:navy">or      al, al          </span>; end of string ?
<span style="color:black">SYSINIT:20A8                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_DCS_Exit </span>; then exit.
<span style="color:black">SYSINIT:20AA                 </span><span style="color:navy">call    </span>_$P_Do_CAPS_Char ; Here a SBCS char need to be CAPS
<span style="color:black">SYSINIT:20AD                 </span><span style="color:navy">mov     cs:[si], al     </span>; stored upper case char to buffer
<span style="color:black">SYSINIT:20B0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_DCS01 </span>; process next
<span style="color:black">SYSINIT:20B2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:20B2
SYSINIT:20B2 </span><span style="color:gray">_$P_DCS00</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20B2                 </span><span style="color:navy">inc     si              </span>; skip DBCS leading and trailing byte
<span style="color:black">SYSINIT:20B3
SYSINIT:20B3 </span><span style="color:gray">_$P_DCS01</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20B3                 </span><span style="color:navy">inc     si              </span>; si points to next byte
<span style="color:black">SYSINIT:20B4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_DCS_Loop </span>; loop until NULL encountered
<span style="color:black">SYSINIT:20B6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:20B6
SYSINIT:20B6 </span><span style="color:gray">_$P_DCS_Exit</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20B6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:20B7                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:20B8                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:20B8 </span>_$P_Do_CAPS_String <span style="color:black">endp
SYSINIT:20B8
SYSINIT:20B9
SYSINIT:20B9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:20B9
SYSINIT:20B9
SYSINIT:20B9 </span>_$P_Do_CAPS_Char <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20B9                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">80h         </span>; _$P_ASCII80 ; need upper case table ?
<span style="color:black">SYSINIT:20BB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_DCC_Go </span>; no
<span style="color:black">SYSINIT:20BD                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">a&#039;         </span>; check if  &quot;a&quot; &lt;= AL &lt;= &quot;z&quot;
<span style="color:black">SYSINIT:20BF                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_CAPS_Ret
</span><span style="color:black">SYSINIT:20C1                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">z&#039;
</span><span style="color:black">SYSINIT:20C3                 </span><span style="color:navy">ja      short </span><span style="color:gray">_$P_CAPS_Ret
</span><span style="color:black">SYSINIT:20C5                 </span><span style="color:navy">and     al, </span><span style="color:green">0DFh        </span>; _$P_Make_Upper ; make CAPS
<span style="color:black">SYSINIT:20C7                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:20C8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:20C8
SYSINIT:20C8 </span><span style="color:gray">_$P_DCC_Go</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20C8                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:20C9                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:20CA                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:20CB                 </span><span style="color:navy">lea     di, </span>_$P_Char_CAP_Ptr ; or use char CAPS table ?
<span style="color:black">SYSINIT:20CF                 </span><span style="color:navy">cmp     cs:[di], dl     </span>; already got table address ?
<span style="color:black">SYSINIT:20D2                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_DCC01 </span>; no
<span style="color:black">SYSINIT:20D4                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:20D5                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:20D6                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:20D7                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:20D8                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:20D9                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:20D9                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">SYSINIT:20DA                 </span><span style="color:navy">mov     ah, </span><span style="color:green">65h         </span>; _$P_DOS_Get_TBL
<span style="color:black">SYSINIT:20DC                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh      </span>; _$P_DOSTBL_Def = -1
<span style="color:black">SYSINIT:20DF                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5           </span>; _$P_DOSTBL_BL
<span style="color:black">SYSINIT:20E2                 </span><span style="color:navy">mov     dx, bx          </span>; _$P_DOSTBL_Def
<span style="color:black">SYSINIT:20E4                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 4.x internal
<span style="color:black">SYSINIT:20E4                                         </span>; COUNTRY-DEPENDENT FILENAME CAPITALIZATION
<span style="color:black">SYSINIT:20E4                                         </span>; AL = function -
<span style="color:black">SYSINIT:20E4                                         </span>;
<span style="color:black">SYSINIT:20E4                                         </span>; DI already set to point to buffer
<span style="color:black">SYSINIT:20E6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:20E7                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:20E8                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:20E9
SYSINIT:20E9 </span><span style="color:gray">_$P_DCC01</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20E9                 </span><span style="color:navy">les     bx, cs:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; bx = [cs:di+_$P_DOS_TBL.Off] ; [cs:di+1]
<span style="color:black">SYSINIT:20E9                                         </span>; es = [cs:di+_$P_DOS_TBL.Seg] ; [cs:di+3]
<span style="color:black">SYSINIT:20ED                 </span>assume es:nothing
<span style="color:black">SYSINIT:20ED                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:20EE                 </span><span style="color:navy">inc     bx              </span>; add 2 to bx reg
<span style="color:black">SYSINIT:20EF                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">80h         </span>; _$P_ASCII80 ; make char to index
<span style="color:black">SYSINIT:20F1                 </span><span style="color:navy">xlat    byte ptr es:[bx] </span>; perform case map
<span style="color:black">SYSINIT:20F3                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:20F4                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:20F5                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:20F6
SYSINIT:20F6 </span><span style="color:gray">_$P_CAPS_Ret</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20F6                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:20F6 </span>_$P_Do_CAPS_Char <span style="color:black">endp
SYSINIT:20F6
SYSINIT:20F7
SYSINIT:20F7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:20F7
SYSINIT:20F7
SYSINIT:20F7 </span>_$P_SValue      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:20F7                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:20F8                 </span><span style="color:navy">or      cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">80h </span>; _$P_Signed ; indicate a signed numeric
<span style="color:black">SYSINIT:20FE                 </span><span style="color:navy">and     cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">0FDh </span>; 0FFh-_$P_Neg ; assume positive value
<span style="color:black">SYSINIT:20FE                                         </span>; and byte [cs:$_Flags2],~_$P_Neg ; ~2
<span style="color:black">SYSINIT:2104                 </span><span style="color:navy">mov     al, cs:[si]     </span>; get sign
<span style="color:black">SYSINIT:2107                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">+&#039;         </span>; _$P_Plus
<span style="color:black">SYSINIT:2109                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SVal00
</span><span style="color:black">SYSINIT:210B                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">-&#039;         </span>; _$P_Minus
<span style="color:black">SYSINIT:210D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Sval01
</span><span style="color:black">SYSINIT:210F                 </span><span style="color:navy">or      cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">2 </span>; _$P_Neg
<span style="color:black">SYSINIT:210F                                         </span>; set this is negative value
<span style="color:black">SYSINIT:2115
SYSINIT:2115 </span><span style="color:gray">_$P_SVal00</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2115                 </span><span style="color:navy">inc     si              </span>; skip sign char
<span style="color:black">SYSINIT:2116
SYSINIT:2116 </span><span style="color:gray">_$P_Sval01</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2116                 </span><span style="color:navy">call    </span>_$P_Value       ; and process value
<span style="color:black">SYSINIT:2119                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:211A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:211A </span>_$P_SValue      <span style="color:black">endp
SYSINIT:211A
SYSINIT:211B
SYSINIT:211B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:211B
SYSINIT:211B
SYSINIT:211B </span>_$P_Value       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:211B                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:211C                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:211D                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:211E                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:211F                 </span><span style="color:navy">xor     cx, cx          </span>; cx = higher 16 bits
<span style="color:black">SYSINIT:2121                 </span><span style="color:navy">xor     dx, dx          </span>; dx = lower 16 bits
<span style="color:black">SYSINIT:2123                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:2124
SYSINIT:2124 </span><span style="color:gray">_$P_Value_Loop</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2124                 </span><span style="color:navy">mov     al, cs:[si]     </span>; get character
<span style="color:black">SYSINIT:2127                 </span><span style="color:navy">or      al, al          </span>; end of line ?
<span style="color:black">SYSINIT:2129                 </span><span style="color:navy">jz      short </span>_$P_Value00
<span style="color:black">SYSINIT:212B                 </span><span style="color:navy">call    </span>_$P_0099        ; make asc(0..9) to bin(0..9)
<span style="color:black">SYSINIT:212E                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Value_Err0
</span><span style="color:black">SYSINIT:2130                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:2132                 </span><span style="color:navy">mov     bp, ax          </span>; save binary number
<span style="color:black">SYSINIT:2134                 </span><span style="color:navy">call    </span><span style="color:gray">_$P_Value_2x_OVF </span>; multiply cx:dx by 2 and then check overflow
<span style="color:black">SYSINIT:2137                 </span><span style="color:navy">mov     bx, dx          </span>; ax:bx = 2*(cx:dx)
<span style="color:black">SYSINIT:2139                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">SYSINIT:213B                 </span><span style="color:navy">call    </span><span style="color:gray">_$P_Value_2x_OVF </span>; multiply cx:dx by 2 and then check overflow
<span style="color:black">SYSINIT:213E                 </span><span style="color:navy">call    </span><span style="color:gray">_$P_Value_2x_OVF </span>; multiply cx:dx by 2 and then check overflow
<span style="color:black">SYSINIT:2141                 </span><span style="color:navy">add     dx, bx          </span>; 8*(cx:dx)+2*(cx:dx) = 10*(cx:dx)
<span style="color:black">SYSINIT:2143                 </span><span style="color:navy">adc     cx, ax
</span><span style="color:black">SYSINIT:2145                 </span><span style="color:navy">call    </span><span style="color:gray">_$P_Value_Chk_Add_OVF
</span><span style="color:black">SYSINIT:2148                 </span><span style="color:navy">add     dx, bp          </span>; Add the current one degree decimal
<span style="color:black">SYSINIT:2148                                         </span>; if carry, add 1 to high 16bit
<span style="color:black">SYSINIT:214A                 </span><span style="color:navy">adc     cx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:214D                 </span><span style="color:navy">call    </span><span style="color:gray">_$P_Value_Chk_Add_OVF </span>; Overflow occurred ?
<span style="color:black">SYSINIT:214D                                         </span>; then error, exit (without return here)
<span style="color:black">SYSINIT:2150                 </span><span style="color:navy">inc     si              </span>; update pointer
<span style="color:black">SYSINIT:2151                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Value_Loop
</span><span style="color:black">SYSINIT:2153 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2153
SYSINIT:2153 </span><span style="color:gray">_$P_Value_2x_OVF</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2153                 </span><span style="color:navy">shl     dx, </span><span style="color:green">1           </span>; to have 2*x
<span style="color:black">SYSINIT:2155                 </span><span style="color:navy">rcl     cx, </span><span style="color:green">1           </span>; shift left w/ carry
<span style="color:black">SYSINIT:2157
SYSINIT:2157 </span><span style="color:gray">_$P_Value_Chk_Add_OVF</span><span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2157                 </span><span style="color:navy">call    </span>_$P_Check_OVF   ; check overflow (for the last shift or add)
<span style="color:black">SYSINIT:215A                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Value_OVF
</span><span style="color:black">SYSINIT:215C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:215D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:215D
SYSINIT:215D </span><span style="color:gray">_$P_Value_OVF</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:215D                 </span><span style="color:navy">inc     sp              </span>; skip &quot;call&quot; return address to the caller
<span style="color:black">SYSINIT:215E                 </span><span style="color:navy">inc     sp
</span><span style="color:black">SYSINIT:215F
SYSINIT:215F </span><span style="color:gray">_$P_Value_Err0</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:215F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:2160                 </span><span style="color:navy">jmp     </span><span style="color:gray">_$P_Value_Err   </span>; bridge
<span style="color:black">SYSINIT:2163 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2163
SYSINIT:2163 </span>_$P_Value00<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2163                 </span><span style="color:navy">pop     bx              </span>; restore control pointer
<span style="color:black">SYSINIT:2163                                         </span>; here cx,dx = 32bit value
<span style="color:black">SYSINIT:2164                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">2 </span>; _$P_Neg ; was it negative ?
<span style="color:black">SYSINIT:216A                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Value01
</span><span style="color:black">SYSINIT:216C                 </span><span style="color:navy">not     cx              </span>; | Make 2&#039;s complement
<span style="color:black">SYSINIT:216E                 </span><span style="color:navy">not     dx              </span>; |
<span style="color:black">SYSINIT:2170                 </span><span style="color:navy">add     dx, </span><span style="color:#ff8000">1           </span>; |
<span style="color:black">SYSINIT:2173                 </span><span style="color:navy">adc     cx, </span><span style="color:#ff8000">0           </span>; |
<span style="color:black">SYSINIT:2176
SYSINIT:2176 </span><span style="color:gray">_$P_Value01</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2176                 </span><span style="color:navy">mov     si, es:[bx+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; [es:bx+_$P_Control_Blk.Value_List]
<span style="color:black">SYSINIT:2176                                         </span>; si points to value list
<span style="color:black">SYSINIT:217A                 </span><span style="color:navy">mov     al, es:[si]     </span>; get nval
<span style="color:black">SYSINIT:217D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; _$P_nval_None ; no value list ?
<span style="color:black">SYSINIT:217F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Value02
</span><span style="color:black">SYSINIT:2181                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FF01h      </span>; (_$P_No_Tag&lt;&lt;8)|_$P_Number
<span style="color:black">SYSINIT:2181                                         </span>; No ITEM_TAG set
<span style="color:black">SYSINIT:2184                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Value_Exit
</span><span style="color:black">SYSINIT:2186 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2186                 </span><span style="color:navy">nop
</span><span style="color:black">SYSINIT:2187
SYSINIT:2187 </span><span style="color:gray">_$P_Value02</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2187                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:2188                 </span><span style="color:navy">mov     al, es:[si]     </span>; al = number of range
<span style="color:black">SYSINIT:218B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; _$P_No_nrng
<span style="color:black">SYSINIT:218D                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Value_Err </span>; _$P_Value03
<span style="color:black">SYSINIT:218F                 </span><span style="color:navy">inc     si              </span>; si points to 1st item_tag
<span style="color:black">SYSINIT:2190
SYSINIT:2190 </span><span style="color:gray">_$P_Val02_Loop</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2190                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">80h </span>; _$P_Signed
<span style="color:black">SYSINIT:2196                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Val02_Sign
</span><span style="color:black">SYSINIT:2198                 </span><span style="color:navy">cmp     cx, es:[si+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_XH]
<span style="color:black">SYSINIT:2198                                         </span>; comp cx with XH
<span style="color:black">SYSINIT:219C                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:219E                 </span><span style="color:navy">ja      short </span><span style="color:gray">_$P_Val_In
</span><span style="color:black">SYSINIT:21A0                 </span><span style="color:navy">cmp     dx, es:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_XL]
<span style="color:black">SYSINIT:21A0                                         </span>; comp dx with XL
<span style="color:black">SYSINIT:21A4                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:21A6
SYSINIT:21A6 </span><span style="color:gray">_$P_Val_In</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:21A6                 </span><span style="color:navy">cmp     cx, es:[si+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_YH]
<span style="color:black">SYSINIT:21A6                                         </span>; comp cx with YH
<span style="color:black">SYSINIT:21AA                 </span><span style="color:navy">ja      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:21AC                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Val_Found
</span><span style="color:black">SYSINIT:21AE                 </span><span style="color:navy">cmp     dx, es:[si+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_YL]
<span style="color:black">SYSINIT:21AE                                         </span>; comp dx with YL
<span style="color:black">SYSINIT:21B2                 </span><span style="color:navy">ja      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:21B4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Val_Found
</span><span style="color:black">SYSINIT:21B6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:21B6
SYSINIT:21B6 </span><span style="color:gray">_$P_Val02_Sign</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:21B6                 </span><span style="color:navy">cmp     cx, es:[si+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_XH]
<span style="color:black">SYSINIT:21B6                                         </span>; comp cx with XH
<span style="color:black">SYSINIT:21BA                 </span><span style="color:navy">jl      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:21BC                 </span><span style="color:navy">jg      short </span><span style="color:gray">_$P_SVal_In
</span><span style="color:black">SYSINIT:21BE                 </span><span style="color:navy">cmp     dx, es:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_XL]
<span style="color:black">SYSINIT:21BE                                         </span>; comp dx with XL
<span style="color:black">SYSINIT:21C2                 </span><span style="color:navy">jl      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:21C4
SYSINIT:21C4 </span><span style="color:gray">_$P_SVal_In</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:21C4                 </span><span style="color:navy">cmp     cx, es:[si+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_YH]
<span style="color:black">SYSINIT:21C4                                         </span>; comp cx with YH
<span style="color:black">SYSINIT:21C8                 </span><span style="color:navy">jg      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:21CA                 </span><span style="color:navy">jl      short </span><span style="color:gray">_$P_Val_Found
</span><span style="color:black">SYSINIT:21CC                 </span><span style="color:navy">cmp     dx, es:[si+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [es:si+_$P_Val_List.Val_YL]
<span style="color:black">SYSINIT:21CC                                         </span>; comp dx with YL
<span style="color:black">SYSINIT:21D0                 </span><span style="color:navy">jg      short </span><span style="color:gray">_$P_Val02_Next
</span><span style="color:black">SYSINIT:21D2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Val_Found
</span><span style="color:black">SYSINIT:21D4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:21D4
SYSINIT:21D4 </span><span style="color:gray">_$P_Val02_Next</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:21D4                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">9           </span>; _$P_Len_Range
<span style="color:black">SYSINIT:21D7                 </span><span style="color:navy">dec     al              </span>; loop nrng times in AL
<span style="color:black">SYSINIT:21D9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Val02_Loop
</span><span style="color:black">SYSINIT:21DB                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">6    </span>; _$P_Out_Of_Range
<span style="color:black">SYSINIT:21E2                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FF01h      </span>; (_$P_No_Tag&lt;&lt;8)|_$P_Number
<span style="color:black">SYSINIT:21E5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Value_Exit
</span><span style="color:black">SYSINIT:21E7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:21E7
SYSINIT:21E7 </span><span style="color:gray">_$P_Val_Found</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:21E7                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; _$P_Number
<span style="color:black">SYSINIT:21E9                 </span><span style="color:navy">mov     ah, es:[si]     </span>; found ITEM_TAG set
<span style="color:black">SYSINIT:21EC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Value_Exit
</span><span style="color:black">SYSINIT:21EE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:21EE
SYSINIT:21EE </span><span style="color:gray">_$P_Value_Err</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:21EE                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax
<span style="color:black">SYSINIT:21F5                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FF03h      </span>; (_$P_No_Tag&lt;&lt;8)|_$P_String
<span style="color:black">SYSINIT:21F5                                         </span>; No ITEM_TAG set
<span style="color:black">SYSINIT:21F8
SYSINIT:21F8 </span><span style="color:gray">_$P_Value_Exit</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:21F8                 </span><span style="color:navy">call    </span>_$P_Fill_Result
<span style="color:black">SYSINIT:21FB                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:21FC                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:21FD                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:21FE                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:21FF                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:21FF </span>_$P_Value       <span style="color:black">endp
SYSINIT:21FF
SYSINIT:2200
SYSINIT:2200 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:2200
SYSINIT:2200
SYSINIT:2200 </span>_$P_Check_OVF   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2200                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:2201                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">2 </span>; _$P_Neg ; is it negative value ?
<span style="color:black">SYSINIT:2207                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_COVF
</span><span style="color:black">SYSINIT:2209                 </span><span style="color:navy">popf                    </span>; if no, check overflow by the CY bit
<span style="color:black">SYSINIT:220A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:220B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:220B
SYSINIT:220B </span><span style="color:gray">_$P_COVF</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:220B                 </span><span style="color:navy">popf                    </span>; else, check overflow by the OF
<span style="color:black">SYSINIT:220C                 </span><span style="color:navy">jo      short </span><span style="color:gray">_$P_COVF00
</span><span style="color:black">SYSINIT:220E                 </span><span style="color:navy">clc                     </span>; indicate it with CY bit
<span style="color:black">SYSINIT:220E                                         </span>; CY=0 means no overflow
<span style="color:black">SYSINIT:220F                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2210 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2210
SYSINIT:2210 </span><span style="color:gray">_$P_COVF00</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2210                 </span><span style="color:navy">stc                     </span>; and CY=1 means overflow
<span style="color:black">SYSINIT:2211                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2211 </span>_$P_Check_OVF   <span style="color:black">endp
SYSINIT:2211
SYSINIT:2212
SYSINIT:2212 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:2212
SYSINIT:2212
SYSINIT:2212 </span>_$P_0099        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2212                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">0&#039;         </span>; must be 0 =&lt; al =&lt; 9
<span style="color:black">SYSINIT:2214                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_0099Err
</span><span style="color:black">SYSINIT:2216                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">9&#039;
</span><span style="color:black">SYSINIT:2218                 </span><span style="color:navy">ja      short </span><span style="color:gray">_$P_0099Err
</span><span style="color:black">SYSINIT:221A                 </span><span style="color:navy">sub     al, &#039;</span><span style="color:green">0&#039;         </span>; sub al,30h ; make char -&gt; bin
<span style="color:black">SYSINIT:221C                 </span><span style="color:navy">clc                     </span>; indicate no error
<span style="color:black">SYSINIT:221C                                         </span>; (clc is not required here, cf=0)
<span style="color:black">SYSINIT:221D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:221E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:221E
SYSINIT:221E </span><span style="color:gray">_$P_0099Err</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:221E                 </span><span style="color:navy">stc                     </span>; indicate error (cf=1)
<span style="color:black">SYSINIT:221F                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:221F </span>_$P_0099        <span style="color:black">endp
SYSINIT:221F
SYSINIT:2220
SYSINIT:2220 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:2220
SYSINIT:2220
SYSINIT:2220 </span>_$P_Simple_String <span style="color:black">proc near             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2220                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:2221                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:2222                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:2223                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:2224                 </span><span style="color:navy">mov     di, es:[bx+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; [es:bx+_$P_Control_Blk.Value_List]
<span style="color:black">SYSINIT:2224                                         </span>; di points to value list
<span style="color:black">SYSINIT:2228                 </span><span style="color:navy">mov     al, es:[di]     </span>; get nval
<span style="color:black">SYSINIT:222B                 </span><span style="color:navy">or      al, al          </span>; no value list ?
<span style="color:black">SYSINIT:222D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Sim00
</span><span style="color:black">SYSINIT:222F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0FFh        </span>; _$P_No_Tag ; then, No ITEM_TAG set
<span style="color:black">SYSINIT:2231                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Sim_Exit </span>; and set result buffer
<span style="color:black">SYSINIT:2233 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2233
SYSINIT:2233 </span><span style="color:gray">_$P_Sim00</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2233                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; Check if keyword or value list id #3 is supported
<span style="color:black">SYSINIT:2233                                         </span>; _$P_nval_String ; String choice list provided ?
<span style="color:black">SYSINIT:2235                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Sim01 </span>; if no, syntax error
<span style="color:black">SYSINIT:2237                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:2238                 </span><span style="color:navy">mov     al, es:[di]     </span>; al = nrng
<span style="color:black">SYSINIT:223B                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">9           </span>; _$P_Len_Range
<span style="color:black">SYSINIT:223D                 </span><span style="color:navy">mul     ah              </span>; Skip nrng field
<span style="color:black">SYSINIT:223F                 </span><span style="color:navy">inc     ax              </span>; ax = (nrng*9)+1
<span style="color:black">SYSINIT:2240                 </span><span style="color:navy">add     di, ax          </span>; di points to nnval
<span style="color:black">SYSINIT:2242                 </span><span style="color:navy">mov     al, es:[di]     </span>; get nnval
<span style="color:black">SYSINIT:2245                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5           </span>; _$P_Len_Value
<span style="color:black">SYSINIT:2247                 </span><span style="color:navy">mul     ah              </span>; skip nnval field
<span style="color:black">SYSINIT:2249                 </span><span style="color:navy">inc     ax              </span>; ax = (nnval*5)+1
<span style="color:black">SYSINIT:224A                 </span><span style="color:navy">add     di, ax          </span>; di points to nstrval
<span style="color:black">SYSINIT:224C                 </span><span style="color:navy">mov     al, es:[di]     </span>; get nstrval c
<span style="color:black">SYSINIT:224F                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:2250                 </span><span style="color:navy">inc     di              </span>; add &#039;2&#039; to di reg
<span style="color:black">SYSINIT:2250                                         </span>; di points to 1st string in list
<span style="color:black">SYSINIT:2251
SYSINIT:2251 </span><span style="color:gray">_$P_Sim_Loop</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2251                 </span><span style="color:navy">mov     bp, es:[di]     </span>; get string pointer
<span style="color:black">SYSINIT:2254                 </span><span style="color:navy">call    </span>_$P_String_Comp ; compare it with operand
<span style="color:black">SYSINIT:2257                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_Sim_Found </span>; found on list
<span style="color:black">SYSINIT:2259                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">3           </span>; _$P_Len_String ; if no, point to next choice
<span style="color:black">SYSINIT:225C                 </span><span style="color:navy">dec     al              </span>; loop nstval times in AL
<span style="color:black">SYSINIT:225E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Sim_Loop
</span><span style="color:black">SYSINIT:2260                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">8    </span>; / Not found ; _$P_Not_In_Str
<span style="color:black">SYSINIT:2267                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0FFh        </span>; _$P_No_Tag  ; No ITEM_TAG set
<span style="color:black">SYSINIT:2269                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Sim_Exit
</span><span style="color:black">SYSINIT:226B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:226B
SYSINIT:226B </span><span style="color:gray">_$P_Sim_Found</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:226B                 </span><span style="color:navy">mov     ah, es:[di-</span><span style="color:green">1</span><span style="color:navy">]   </span>; set item_tag
<span style="color:black">SYSINIT:226F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; _$P_List_Idx
<span style="color:black">SYSINIT:2271                 </span><span style="color:navy">mov     dx, es:[di]     </span>; get address of STRING
<span style="color:black">SYSINIT:2274                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Sim_Exit0
</span><span style="color:black">SYSINIT:2276 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2276
SYSINIT:2276 </span><span style="color:gray">_$P_Sim01</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2276                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax
<span style="color:black">SYSINIT:227D                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0FFh        </span>; _$P_No_Tag
<span style="color:black">SYSINIT:227F
SYSINIT:227F </span><span style="color:gray">_$P_Sim_Exit</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:227F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; _$P_String ; Set type
<span style="color:black">SYSINIT:2281
SYSINIT:2281 </span><span style="color:gray">_$P_Sim_Exit0</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2281                 </span><span style="color:navy">call    </span>_$P_Fill_Result
<span style="color:black">SYSINIT:2284                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:2285                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:2286                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:2287                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:2288                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2288 </span>_$P_Simple_String <span style="color:black">endp
SYSINIT:2288
SYSINIT:2289
SYSINIT:2289 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:2289
SYSINIT:2289
SYSINIT:2289 </span>_$P_String_Comp <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2289                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:228A                 </span><span style="color:navy">push    bp
</span><span style="color:black">SYSINIT:228B                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:228C                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:228D                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">2           </span>; _$P_DOSTBL_Char ; use character case map table
<span style="color:black">SYSINIT:228F
SYSINIT:228F </span><span style="color:gray">_$P_SCOM_Loop</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:228F                 </span><span style="color:navy">mov     al, cs:[si]     </span>; get command character
<span style="color:black">SYSINIT:2292                 </span><span style="color:navy">call    </span>_$P_Chk_DBCS    ; DBCS ?
<span style="color:black">SYSINIT:2295                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_SCOM00 </span>; yes
<span style="color:black">SYSINIT:2297                 </span><span style="color:navy">call    </span>_$P_Do_CAPS_Char ; else, upper case map before comparison
<span style="color:black">SYSINIT:229A                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">8 </span>; Check if keyword or switch is supported
<span style="color:black">SYSINIT:229A                                         </span>; _$P_Key_Cmp ; keyword search ?
<span style="color:black">SYSINIT:22A0                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SCOM04
</span><span style="color:black">SYSINIT:22A2                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">=&#039;         </span>; _$P_Keyword  ; &quot;=&quot; is delimiter
<span style="color:black">SYSINIT:22A4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM03 </span>; IF &quot;=&quot; on command line AND
<span style="color:black">SYSINIT:22A4                                         </span>; (bp+1=&gt; char after the &quot;=&quot; in synonym list)
<span style="color:black">SYSINIT:22A6                 </span><span style="color:navy">cmp     byte ptr es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; at end of keyword string
<span style="color:black">SYSINIT:22A6                                         </span>;                  in the control block THEN
<span style="color:black">SYSINIT:22AB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM_Differ
</span><span style="color:black">SYSINIT:22AD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_SCOM05 </span>; keyword found in synonym list
<span style="color:black">SYSINIT:22AF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:22AF
SYSINIT:22AF </span><span style="color:gray">_$P_SCOM04</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:22AF                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">10h </span>; _$P_SW_Cmp ; switch search ?
<span style="color:black">SYSINIT:22B5                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SCOM03
</span><span style="color:black">SYSINIT:22B7                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">:&#039;         </span>; _$P_Colon ; &quot;:&quot; is delimiter,
<span style="color:black">SYSINIT:22B7                                         </span>;            at end of switch on command line
<span style="color:black">SYSINIT:22B9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM03
</span><span style="color:black">SYSINIT:22BB                 </span><span style="color:navy">cmp     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; _$P_NULL
<span style="color:black">SYSINIT:22BB                                         </span>; IF at end of switch on command AND
<span style="color:black">SYSINIT:22C0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM_Differ </span>;
<span style="color:black">SYSINIT:22C0                                         </span>; at end of switch string
<span style="color:black">SYSINIT:22C0                                         </span>; in the control block THEN
<span style="color:black">SYSINIT:22C2
SYSINIT:22C2 </span><span style="color:gray">_$P_SCOM05</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:22C2                 </span><span style="color:navy">inc     si              </span>; found a match
<span style="color:black">SYSINIT:22C2                                         </span>; si points to just after &quot;=&quot; or &quot;:&quot;
<span style="color:black">SYSINIT:22C3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_SCOM_Same </span>; exit
<span style="color:black">SYSINIT:22C5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:22C5
SYSINIT:22C5 </span><span style="color:gray">_$P_SCOM03</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:22C5                 </span><span style="color:navy">cmp     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; compare operand w/ a synonym
<span style="color:black">SYSINIT:22C9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM_Differ0 </span>; if different,
<span style="color:black">SYSINIT:22C9                                         </span>; check ignore colon option
<span style="color:black">SYSINIT:22CB                 </span><span style="color:navy">or      al, al          </span>; end of line ?
<span style="color:black">SYSINIT:22CD                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SCOM_Same </span>; if so, exit
<span style="color:black">SYSINIT:22CF                 </span><span style="color:navy">inc     si              </span>; update operand pointer
<span style="color:black">SYSINIT:22D0                 </span><span style="color:navy">inc     bp              </span>; and synonym pointer
<span style="color:black">SYSINIT:22D1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_SCOM01 </span>; loop until NULL or &quot;=&quot; or &quot;:&quot;
<span style="color:black">SYSINIT:22D1                                         </span>;  found in case
<span style="color:black">SYSINIT:22D3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:22D3
SYSINIT:22D3 </span><span style="color:gray">_$P_SCOM00</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:22D3                 </span><span style="color:navy">cmp     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; Here al is DBCS leading byte
<span style="color:black">SYSINIT:22D3                                         </span>; compare leading byte
<span style="color:black">SYSINIT:22D7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM_Differ </span>; if not match, say different
<span style="color:black">SYSINIT:22D9                 </span><span style="color:navy">inc     si              </span>; else, load next byte
<span style="color:black">SYSINIT:22DA                 </span><span style="color:navy">mov     al, cs:[si]
</span><span style="color:black">SYSINIT:22DD                 </span><span style="color:navy">inc     bp
</span><span style="color:black">SYSINIT:22DE                 </span><span style="color:navy">cmp     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; and compare 2nd byte
<span style="color:black">SYSINIT:22E2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM_Differ </span>; if not match, say different, too
<span style="color:black">SYSINIT:22E4                 </span><span style="color:navy">inc     si              </span>; else update operand pointer
<span style="color:black">SYSINIT:22E5                 </span><span style="color:navy">inc     bp              </span>; and synonym pointer
<span style="color:black">SYSINIT:22E6
SYSINIT:22E6 </span><span style="color:gray">_$P_SCOM01</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:22E6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_SCOM_Loop </span>; loop until NULL or &quot;=&quot;
<span style="color:black">SYSINIT:22E6                                         </span>; or &quot;/&quot; found in case
<span style="color:black">SYSINIT:22E8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:22E8
SYSINIT:22E8 </span><span style="color:gray">_$P_SCOM_Differ0</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:22E8                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">40h </span>; _$P_SW
<span style="color:black">SYSINIT:22EE                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_not_applicable
</span><span style="color:black">SYSINIT:22F0                 </span><span style="color:navy">test    word ptr es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">20h </span>; [es:bx+_$P_Control_Blk.Function_Flag],
<span style="color:black">SYSINIT:22F0                                         </span>; _$P_colon_is_not_necessary
<span style="color:black">SYSINIT:22F6                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_not_applicable
</span><span style="color:black">SYSINIT:22F8                 </span><span style="color:navy">cmp     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; _$P_NULL
<span style="color:black">SYSINIT:22FD                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SCOM_Same
</span><span style="color:black">SYSINIT:22FF
SYSINIT:22FF </span><span style="color:gray">_$P_not_applicable</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:22FF                 </span><span style="color:navy">test    word ptr es:[bx], </span><span style="color:green">10h </span>; [es:bx+_$P_Control_Blk.Match_Flag],
<span style="color:black">SYSINIT:22FF                                         </span>; _$P_Ig_Colon
<span style="color:black">SYSINIT:22FF                                         </span>; ignore colon option specified ?
<span style="color:black">SYSINIT:2304                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SCOM_Differ
</span><span style="color:black">SYSINIT:2306                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">:&#039;         </span>; _$P_Colon ; End up with &quot;:&quot; and subseqently
<span style="color:black">SYSINIT:2308                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM02
</span><span style="color:black">SYSINIT:230A                 </span><span style="color:navy">cmp     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; null ?
<span style="color:black">SYSINIT:230F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM_Differ </span>; if no, say different
<span style="color:black">SYSINIT:2311                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_SCOM_Same </span>; else, say same
<span style="color:black">SYSINIT:2313 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2313
SYSINIT:2313 </span><span style="color:gray">_$P_SCOM02</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2313                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; _$P_NULL ; end up NULL and :
<span style="color:black">SYSINIT:2315                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_SCOM_Differ
</span><span style="color:black">SYSINIT:2317                 </span><span style="color:navy">cmp     byte ptr es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], &#039;</span><span style="color:green">:&#039; </span>; _$P_Colon ; if no, say different
<span style="color:black">SYSINIT:231C                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_SCOM_Same </span>; else, say same
<span style="color:black">SYSINIT:231E
SYSINIT:231E </span><span style="color:gray">_$P_SCOM_Differ</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:231E                 </span><span style="color:navy">stc                     </span>; indicate not found
<span style="color:black">SYSINIT:231F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_SCOM_Exit
</span><span style="color:black">SYSINIT:2321 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2321
SYSINIT:2321 </span><span style="color:gray">_$P_SCOM_Same</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2321                 </span><span style="color:navy">mov     cs:</span>_$P_KEYorSW_Ptr<span style="color:navy">, si </span>; for later use by keyword or switch
<span style="color:black">SYSINIT:2326                 </span><span style="color:navy">clc                     </span>; indicate found
<span style="color:black">SYSINIT:2326                                         </span>; (cf is already 0 here.. clc is not needed)
<span style="color:black">SYSINIT:2327
SYSINIT:2327 </span><span style="color:gray">_$P_SCOM_Exit</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2327                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2328                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:2329                 </span><span style="color:navy">pop     bp
</span><span style="color:black">SYSINIT:232A                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:232B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:232B </span>_$P_String_Comp <span style="color:black">endp
SYSINIT:232B
SYSINIT:232C
SYSINIT:232C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:232C
SYSINIT:232C
SYSINIT:232C </span>_$P_File_Format <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:232C                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:232D                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:232E                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:232F                 </span><span style="color:navy">mov     di, cs:</span>_$P_SaveSI_Cmpx ; get user buffer address
<span style="color:black">SYSINIT:2334
SYSINIT:2334 </span>_$P_FileF_Loop0<span style="color:navy">:                        </span>; / skip special characters
<span style="color:black">SYSINIT:2334                 </span><span style="color:navy">mov     al, cs:[si]     </span>; load character
<span style="color:black">SYSINIT:2337                 </span><span style="color:navy">or      al, al          </span>; end of line ?
<span style="color:black">SYSINIT:2339                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_FileF_Err </span>; if yes, error exit
<span style="color:black">SYSINIT:233B                 </span><span style="color:navy">call    </span>_$P_FileSp_Chk  ; else, check if file special character
<span style="color:black">SYSINIT:233E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_FileF03
</span><span style="color:black">SYSINIT:2340                 </span><span style="color:navy">mov     cs:</span>_$P_err_flag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; $P_error_filespec
<span style="color:black">SYSINIT:2340                                         </span>; set error flag - bad char.
<span style="color:black">SYSINIT:2346                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2347                 </span><span style="color:navy">mov     byte ptr cs:[si], </span><span style="color:#ff8000">0 </span>; _$P_NULL
<span style="color:black">SYSINIT:234B                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:234C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_FileF02
</span><span style="color:black">SYSINIT:234E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:234E
SYSINIT:234E </span><span style="color:gray">_$P_FileF_Err</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:234E                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:234F                 </span><span style="color:navy">mov     byte ptr cs:[si], </span><span style="color:#ff8000">0 </span>; _$P_NULL
<span style="color:black">SYSINIT:2353                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:2354                 </span><span style="color:navy">test    word ptr es:[bx], </span><span style="color:green">1 </span>; [es:bx+_$P_Control_Blk.Match_Flag],
<span style="color:black">SYSINIT:2354                                         </span>; _$P_Optional
<span style="color:black">SYSINIT:2359                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_FileF02
</span><span style="color:black">SYSINIT:235B                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">2    </span>; _$P_Op_Missing
<span style="color:black">SYSINIT:2362                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_FileF02
</span><span style="color:black">SYSINIT:2364 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2364
SYSINIT:2364 </span><span style="color:gray">_$P_FileF03</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2364                 </span><span style="color:navy">pop     ax              </span>; discard si on top of stack
<span style="color:black">SYSINIT:2365                 </span><span style="color:navy">push    si              </span>; save new si
<span style="color:black">SYSINIT:2366
SYSINIT:2366 </span><span style="color:gray">_$P_FileF_Loop1</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2366                 </span><span style="color:navy">mov     al, cs:[si]     </span>; load character (not special char)
<span style="color:black">SYSINIT:2369                 </span><span style="color:navy">or      al, al          </span>; end of line ?
<span style="color:black">SYSINIT:236B                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_FileF_RLT
</span><span style="color:black">SYSINIT:236D                 </span><span style="color:navy">call    </span>_$P_FileSp_Chk  ; File special character ?
<span style="color:black">SYSINIT:2370                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_FileF00
</span><span style="color:black">SYSINIT:2372                 </span><span style="color:navy">call    </span>_$P_Chk_DBCS    ; no, then DBCS ?
<span style="color:black">SYSINIT:2375                 </span><span style="color:navy">jnb     short </span><span style="color:gray">_$P_FileF01
</span><span style="color:black">SYSINIT:2377                 </span><span style="color:navy">inc     di              </span>; if yes, skip next byte
<span style="color:black">SYSINIT:2378                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:2379
SYSINIT:2379 </span><span style="color:gray">_$P_FileF01</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2379                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:237A                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:237B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_FileF_Loop1
</span><span style="color:black">SYSINIT:237D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:237D
SYSINIT:237D </span><span style="color:gray">_$P_FileF00</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:237D                 </span><span style="color:navy">mov     cs:</span>_$P_Terminator<span style="color:navy">, al
</span><span style="color:black">SYSINIT:2381                 </span><span style="color:navy">mov     byte ptr cs:[si], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; update end of string
<span style="color:black">SYSINIT:2385                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:2386                 </span><span style="color:navy">mov     cs:</span>_$P_SI_Save<span style="color:navy">, di </span>; update next pointer in command line
<span style="color:black">SYSINIT:238B
SYSINIT:238B </span><span style="color:gray">_$P_FileF_RLT</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:238B                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:238C                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:238D
SYSINIT:238D </span><span style="color:gray">_$P_FileF02</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:238D                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:238E                 </span><span style="color:navy">test    ax, </span><span style="color:green">200h        </span>; _$P_File_Spc
<span style="color:black">SYSINIT:2391                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Drv_Only_Exit
</span><span style="color:black">SYSINIT:2393                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:2394                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FF05h      </span>; (_$P_No_Tag&lt;&lt;8)|_$P_File_Spec
<span style="color:black">SYSINIT:2394                                         </span>; set result buffer to file spec
<span style="color:black">SYSINIT:2397                 </span><span style="color:navy">call    </span>_$P_Fill_Result
<span style="color:black">SYSINIT:239A                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:239B
SYSINIT:239B </span><span style="color:gray">_$P_Drv_Only_Exit</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:239B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:239B </span>_$P_File_Format <span style="color:black">endp
SYSINIT:239B
SYSINIT:239C
SYSINIT:239C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:239C
SYSINIT:239C
SYSINIT:239C </span>_$P_FileSp_Chk  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:239C                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:239D                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:239E                 </span><span style="color:navy">lea     bx, </span>_$P_FileSp_Char <span style="color:gray">; &quot;[]|&lt;&gt;+=;\&quot;&quot;
</span><span style="color:black">SYSINIT:23A2                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">9           </span>; _$P_FileSp_Len
<span style="color:black">SYSINIT:23A2                                         </span>; load length of special character table
<span style="color:black">SYSINIT:23A2                                         </span>; at SYSINIT:1CFEh (for PCDOS 7.1 IBMBIO.COM)
<span style="color:black">SYSINIT:23A5
SYSINIT:23A5 </span><span style="color:gray">_$P_FileSp_Loop</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:23A5                 </span><span style="color:navy">cmp     al, cs:[bx]     </span>; is it one of special character ?
<span style="color:black">SYSINIT:23A8                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_FileSp_Exit
</span><span style="color:black">SYSINIT:23AA                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:23AB                 </span><span style="color:navy">loop    </span><span style="color:gray">_$P_FileSp_Loop
</span><span style="color:black">SYSINIT:23AD                 </span><span style="color:navy">inc     cx              </span>; reset ZF
<span style="color:black">SYSINIT:23AE
SYSINIT:23AE </span><span style="color:gray">_$P_FileSp_Exit</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:23AE                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:23AF                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:23B0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:23B0 </span>_$P_FileSp_Chk  <span style="color:black">endp
SYSINIT:23B0
SYSINIT:23B1
SYSINIT:23B1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:23B1
SYSINIT:23B1
SYSINIT:23B1 </span>_$P_Drive_Format <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:23B1                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:23B2                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:23B3                 </span><span style="color:navy">mov     al, cs:[si]
</span><span style="color:black">SYSINIT:23B6                 </span><span style="color:navy">or      al, al          </span>; if null string
<span style="color:black">SYSINIT:23B8                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Drv_Exit </span>; do nothing
<span style="color:black">SYSINIT:23BA                 </span><span style="color:navy">call    </span>_$P_Chk_DBCS    ; is it leading byte ?
<span style="color:black">SYSINIT:23BD                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Drv_Err </span>; yes, error
<span style="color:black">SYSINIT:23BF                 </span><span style="color:navy">cmp     word ptr cs:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039; </span>; _$P_Colon
<span style="color:black">SYSINIT:23BF                                         </span>; &quot;d&quot;, &quot;:&quot;, 0 ?
<span style="color:black">SYSINIT:23C4                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_DrvF00
</span><span style="color:black">SYSINIT:23C6                 </span><span style="color:navy">test    word ptr es:[bx], </span><span style="color:green">10h </span>; [es:bx+_$P_Control_Blk.Match_Flag],
<span style="color:black">SYSINIT:23C6                                         </span>; _$P_Ig_Colon
<span style="color:black">SYSINIT:23C6                                         </span>; colon can be ignored?
<span style="color:black">SYSINIT:23CB                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Drv_Err
</span><span style="color:black">SYSINIT:23CD                 </span><span style="color:navy">cmp     byte ptr cs:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; _$P_NULL ; &quot;d&quot;, 0 ?
<span style="color:black">SYSINIT:23D2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Drv_Err
</span><span style="color:black">SYSINIT:23D4
SYSINIT:23D4 </span><span style="color:gray">_$P_DrvF00</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:23D4                 </span><span style="color:navy">or      al, </span><span style="color:green">20h         </span>; _$P_Make_Lower ; lower case
<span style="color:black">SYSINIT:23D6                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">61h </span><span style="color:gray">; &#039;a&#039;   </span>; drive letter must
<span style="color:black">SYSINIT:23D8                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Drv_Err </span>; in range of
<span style="color:black">SYSINIT:23DA                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7Ah </span><span style="color:gray">; &#039;z&#039;   </span>; &quot;a&quot;-&quot;z&quot;
<span style="color:black">SYSINIT:23DC                 </span><span style="color:navy">ja      short </span><span style="color:gray">_$P_Drv_Err </span>; if no, error
<span style="color:black">SYSINIT:23DE                 </span><span style="color:navy">sub     al, </span><span style="color:green">60h         </span>; &quot;a&quot;-1 ; make text drive to binary drive
<span style="color:black">SYSINIT:23E0                 </span><span style="color:navy">mov     dl, al
</span><span style="color:black">SYSINIT:23E2                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0FFh        </span>; _$P_No_Tag
<span style="color:black">SYSINIT:23E4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6           </span>; _$P_Drive
<span style="color:black">SYSINIT:23E4                                         </span>; mov ax,(_$P_No_Tag&lt;&lt;8)|_$P_Drive ; 0FF06h
<span style="color:black">SYSINIT:23E6                 </span><span style="color:navy">call    </span>_$P_Fill_Result ; set result buffer to drive
<span style="color:black">SYSINIT:23E9                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Drv_Exit
</span><span style="color:black">SYSINIT:23EB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:23EB
SYSINIT:23EB </span><span style="color:gray">_$P_Drv_Err</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:23EB                 </span><span style="color:navy">mov     cs:</span>_$P_RC<span style="color:navy">, </span><span style="color:#ff8000">9    </span>; _$P_Syntax
<span style="color:black">SYSINIT:23F2
SYSINIT:23F2 </span><span style="color:gray">_$P_Drv_Exit</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:23F2                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:23F3                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:23F4                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:23F4 </span>_$P_Drive_Format <span style="color:black">endp
SYSINIT:23F4
SYSINIT:23F5
SYSINIT:23F5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:23F5
SYSINIT:23F5
SYSINIT:23F5 </span>_$P_Skip_Delim  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:23F5                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:23F6                 </span><span style="color:navy">call    </span>_$P_Chk_EOL     ; is it EOL character ?
<span style="color:black">SYSINIT:23F9                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Skip_Delim_CY </span>; if yes, exit w/ CY on
<span style="color:black">SYSINIT:23FB                 </span><span style="color:navy">call    </span>_$P_Chk_Delim   ; is it one of delimiters ?
<span style="color:black">SYSINIT:23FE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Skip_Delim_NCY </span>; if no, exit w/ CY off
<span style="color:black">SYSINIT:2400                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">20h </span>; _$P_Extra ; extra delim or comma found
<span style="color:black">SYSINIT:2406                 </span><span style="color:navy">jz      short </span>_$P_Skip_Delim ; _$P_Skip_Delim_Loop
<span style="color:black">SYSINIT:2406                                         </span>; if no, loop
<span style="color:black">SYSINIT:2408                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">41h </span>; _$P_SW+_$P_equ ; /x , or xxx=zzz ,
<span style="color:black">SYSINIT:240E                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Exit_At_Extra </span>; no switch, no keyword
<span style="color:black">SYSINIT:2410                 </span><span style="color:navy">dec     si
</span><span style="color:black">SYSINIT:2411                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Exit_At_Extra
</span><span style="color:black">SYSINIT:2413 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2413
SYSINIT:2413 </span><span style="color:gray">_$P_Skip_Delim_CY</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2413                 </span><span style="color:navy">stc                     </span>; indicate EOL
<span style="color:black">SYSINIT:2414                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Skip_Delim_Exit
</span><span style="color:black">SYSINIT:2416 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2416
SYSINIT:2416 </span><span style="color:gray">_$P_Skip_Delim_NCY</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2416                 </span><span style="color:navy">clc                     </span>; indicate non delim
<span style="color:black">SYSINIT:2417
SYSINIT:2417 </span><span style="color:gray">_$P_Skip_Delim_Exit</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2417                 </span><span style="color:navy">dec     si              </span>; in this case, need backup index pointer
<span style="color:black">SYSINIT:2418                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2419 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2419
SYSINIT:2419 </span><span style="color:gray">_$P_Exit_At_Extra</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2419                 </span><span style="color:navy">clc                     </span>; indicate extra delim
<span style="color:black">SYSINIT:241A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:241A </span>_$P_Skip_Delim  <span style="color:black">endp
SYSINIT:241A
SYSINIT:241B
SYSINIT:241B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:241B
SYSINIT:241B
SYSINIT:241B </span>_$P_Chk_EOL     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:241B                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:241C                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:241D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; _$P_CR ; Carriage return ?
<span style="color:black">SYSINIT:241F                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_EOL_Exit
</span><span style="color:black">SYSINIT:2421                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; _$P_NULL ; zero ?
<span style="color:black">SYSINIT:2423                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_EOL_Exit
</span><span style="color:black">SYSINIT:2425                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; _$P_LF ; Line feed ?
<span style="color:black">SYSINIT:2427                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_EOL_Exit
</span><span style="color:black">SYSINIT:2429                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:di+_$P_PARMS_Blk.Num_Extra],
<span style="color:black">SYSINIT:2429                                         </span>; _$P_I_Have_EOL
<span style="color:black">SYSINIT:242E                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Chk_EOL_Exit
</span><span style="color:black">SYSINIT:2430                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">SYSINIT:2432                 </span><span style="color:navy">mov     bl, es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [es:di+_$P_PARMS_Blk.Len_Extra_Delim]
<span style="color:black">SYSINIT:2432                                         </span>; get length of delimiter list
<span style="color:black">SYSINIT:2436                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">4           </span>; _$P_Len_PARMS ; skip it
<span style="color:black">SYSINIT:2439                 </span><span style="color:navy">cmp     byte ptr es:[bx+di], </span><span style="color:#ff8000">0 </span>; _$P_I_Use_Default
<span style="color:black">SYSINIT:2439                                         </span>; No extra EOL character ?
<span style="color:black">SYSINIT:243D                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_EOL_NZ
</span><span style="color:black">SYSINIT:243F                 </span><span style="color:navy">xor     cx, cx          </span>; Get number of extra character
<span style="color:black">SYSINIT:2441                 </span><span style="color:navy">mov     cl, es:[bx+di]
</span><span style="color:black">SYSINIT:2444
SYSINIT:2444 </span><span style="color:gray">_$P_Chk_EOL_Loop</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2444                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:2445                 </span><span style="color:navy">cmp     al, es:[bx+di]  </span>; Check extra EOL character
<span style="color:black">SYSINIT:2448                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_EOL_Exit
</span><span style="color:black">SYSINIT:244A                 </span><span style="color:navy">loop    </span><span style="color:gray">_$P_Chk_EOL_Loop
</span><span style="color:black">SYSINIT:244C
SYSINIT:244C </span><span style="color:gray">_$P_Chk_EOL_NZ</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:244C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; _$P_CR ; reset ZF
<span style="color:black">SYSINIT:244E
SYSINIT:244E </span><span style="color:gray">_$P_Chk_EOL_Exit</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:244E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:244F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:2450                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2450 </span>_$P_Chk_EOL     <span style="color:black">endp
SYSINIT:2450
SYSINIT:2451
SYSINIT:2451 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:2451
SYSINIT:2451
SYSINIT:2451 </span>_$P_Chk_Delim   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2451                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:2452                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:2453                 </span><span style="color:navy">mov     cs:</span>_$P_Terminator<span style="color:navy">, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039; </span>; _$P_Space
<span style="color:black">SYSINIT:2453                                         </span>; assume terminated by space
<span style="color:black">SYSINIT:2459                 </span><span style="color:navy">and     cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">0DFh </span>; 0FFh-_$P_Extra ; ~$P_Extra ; ~20h
<span style="color:black">SYSINIT:245F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; _$P_Space ; Space ?
<span style="color:black">SYSINIT:2461                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_Delim_Exit
</span><span style="color:black">SYSINIT:2463                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; _$P_TAB ; TAB ?
<span style="color:black">SYSINIT:2465                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_Delim_Exit
</span><span style="color:black">SYSINIT:2467                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Ch </span><span style="color:gray">; &#039;,&#039;   </span>; _$P_Comma ; Comma ?
<span style="color:black">SYSINIT:2469                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_Delim_Exit0
</span><span style="color:black">SYSINIT:246B
SYSINIT:246B </span>_$P_Chk_Delim00<span style="color:navy">:                        </span>; Note: _$P_Chk_Delim00 part of code is nonsense
<span style="color:black">SYSINIT:246B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>;       here because _$P_Space = _$P_DBSP1 = 20h
<span style="color:black">SYSINIT:246B                                         </span>;       Erdogan Tan - 08/07/2023
<span style="color:black">SYSINIT:246B                                         </span>;
<span style="color:black">SYSINIT:246B                                         </span>; _$P_DBSP1 ; 1st byte of DBCS Space ?
<span style="color:black">SYSINIT:246D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Chk_Delim01
</span><span style="color:black">SYSINIT:246F                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039; </span>; _$P_DBSP2 ; 2nd byte of DBCS Space ?
<span style="color:black">SYSINIT:2472                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_Chk_Delim01
</span><span style="color:black">SYSINIT:2474                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; _$P_Space
<span style="color:black">SYSINIT:2476                 </span><span style="color:navy">inc     si              </span>; make si point to next character
<span style="color:black">SYSINIT:2477                 </span><span style="color:navy">cmp     al, al          </span>; Set ZF
<span style="color:black">SYSINIT:2479                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Chk_Delim_Exit
</span><span style="color:black">SYSINIT:247B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:247B
SYSINIT:247B </span><span style="color:gray">_$P_Chk_Delim01</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:247B                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [es:di-_$P_PARMS_Blk.Num_Extra],
<span style="color:black">SYSINIT:247B                                         </span>; _$P_I_Have_Delim
<span style="color:black">SYSINIT:247B                                         </span>; delimiter character specified ?
<span style="color:black">SYSINIT:2480                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_Chk_Delim_Exit </span>; no
<span style="color:black">SYSINIT:2482                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:2484                 </span><span style="color:navy">mov     cl, es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [es:di+_$P_PARMS_Blk.Len_Extra_Delim]
<span style="color:black">SYSINIT:2484                                         </span>; get length of delimiter list
<span style="color:black">SYSINIT:2488                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">_$P_Chk_Delim_NZ </span>; no extra delim character
<span style="color:black">SYSINIT:248A                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">3           </span>; _$P_Len_PARMS-1
<span style="color:black">SYSINIT:248A                                         </span>; set bx to 1st extra delimiter
<span style="color:black">SYSINIT:248D
SYSINIT:248D </span><span style="color:gray">_$P_Chk_Delim_Loop</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:248D                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:248E                 </span><span style="color:navy">cmp     al, es:[bx+di]  </span>; check extra delim character
<span style="color:black">SYSINIT:2491                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_Chk_Delim_Exit0
</span><span style="color:black">SYSINIT:2493                 </span><span style="color:navy">loop    </span><span style="color:gray">_$P_Chk_Delim_Loop </span>; examine all extra delimiter
<span style="color:black">SYSINIT:2495
SYSINIT:2495 </span><span style="color:gray">_$P_Chk_Delim_NZ</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2495                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; _$P_Space ; reset ZF
<span style="color:black">SYSINIT:2497
SYSINIT:2497 </span><span style="color:gray">_$P_Chk_Delim_Exit</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2497                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:2498                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:2499                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:249A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:249A
SYSINIT:249A </span><span style="color:gray">_$P_Chk_Delim_Exit0</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:249A                 </span><span style="color:navy">mov     cs:</span>_$P_Terminator<span style="color:navy">, al </span>; keep terminated delimiter
<span style="color:black">SYSINIT:249E                 </span><span style="color:navy">test    cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">1 </span>; _$P_equ ; if terminating a key=
<span style="color:black">SYSINIT:24A4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_No_Set_Extra </span>; then do not set the EXTRA bit
<span style="color:black">SYSINIT:24A6                 </span><span style="color:navy">or      cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">20h </span>; _$P_Extra
<span style="color:black">SYSINIT:24A6                                         </span>; flag terminated extra delim or comma
<span style="color:black">SYSINIT:24AC
SYSINIT:24AC </span><span style="color:gray">_$P_No_Set_Extra</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:24AC                 </span><span style="color:navy">cmp     al, al          </span>; set ZF
<span style="color:black">SYSINIT:24AE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_Chk_Delim_Exit
</span><span style="color:black">SYSINIT:24AE </span>_$P_Chk_Delim   <span style="color:black">endp
SYSINIT:24AE
SYSINIT:24B0
SYSINIT:24B0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:24B0
SYSINIT:24B0
SYSINIT:24B0 </span>_$P_Chk_Switch  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:24B0                 </span><span style="color:navy">lea     bp, </span>_$P_STRING_BUF ; BP = Offset of _$P_String_Buf
<span style="color:black">SYSINIT:24B0                                         </span>; (mov bp, offset _$P_STRING_BUF)
<span style="color:black">SYSINIT:24B4                 </span><span style="color:navy">cmp     bx, bp          </span>; IF not first char THEN
<span style="color:black">SYSINIT:24B6                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_STRUC_L2
</span><span style="color:black">SYSINIT:24B8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; _$P_Switch ; see if a slash
<span style="color:black">SYSINIT:24BA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_STRUC_L5
</span><span style="color:black">SYSINIT:24BC                 </span><span style="color:navy">stc                     </span>; not in first position and is slash
<span style="color:black">SYSINIT:24BD                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:24BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:24BE
SYSINIT:24BE </span><span style="color:gray">_$P_STRUC_L5</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:24BE                 </span><span style="color:navy">clc                     </span>; not a slash
<span style="color:black">SYSINIT:24BF                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:24C0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:24C0
SYSINIT:24C0 </span><span style="color:gray">_$P_STRUC_L2</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:24C0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; _$P_Switch
<span style="color:black">SYSINIT:24C2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_STRUC_L12 </span>; not a slash
<span style="color:black">SYSINIT:24C4                 </span><span style="color:navy">or      cs:</span>_$P_Flags2<span style="color:navy">, </span><span style="color:green">40h </span>; _$P_SW
<span style="color:black">SYSINIT:24C4                                         </span>; could be valid switch,
<span style="color:black">SYSINIT:24C4                                         </span>; first char and is slash
<span style="color:black">SYSINIT:24CA
SYSINIT:24CA </span><span style="color:gray">_$P_STRUC_L12</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:24CA                 </span><span style="color:navy">clc                     </span>; is first char in the buffer, ZF=0
<span style="color:black">SYSINIT:24CA                                         </span>; (CF=0 indicating first char)
<span style="color:black">SYSINIT:24CB                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:24CB </span>_$P_Chk_Switch  <span style="color:black">endp
SYSINIT:24CB
SYSINIT:24CC
SYSINIT:24CC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:24CC
SYSINIT:24CC
SYSINIT:24CC </span>_$P_Chk_DBCS    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:24CC                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:24CD                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:24CE                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:24CF                 </span><span style="color:navy">cmp     cs:</span>_$P_DBCSEV_SEG<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; already set ?
<span style="color:black">SYSINIT:24D5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_$P_DBCS00 </span>; yes
<span style="color:black">SYSINIT:24D7                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:24D8                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:24D9                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:24DA                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:24DB                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:24DC                 </span><span style="color:navy">push    bp
</span><span style="color:black">SYSINIT:24DD                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:24DE                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">SYSINIT:24E0                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">SYSINIT:24E2                 </span>assume ds:nothing
<span style="color:black">SYSINIT:24E2                 </span><span style="color:navy">mov     ax, </span><span style="color:green">6300h       </span>; _$P_DOS_GetEV ; GET DBCS EV CALL
<span style="color:black">SYSINIT:24E5                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3.2+ only
<span style="color:black">SYSINIT:24E5                                         </span>; GET DOUBLE BYTE CHARACTER SET LEAD TABLE
<span style="color:black">SYSINIT:24E7                 </span><span style="color:navy">mov     bx, ds
</span><span style="color:black">SYSINIT:24E9                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">SYSINIT:24EB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:24EC                 </span><span style="color:navy">pop     bp
</span><span style="color:black">SYSINIT:24ED                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:24EE                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:24EF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:24F0                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:24F1                 </span>assume ds:nothing
<span style="color:black">SYSINIT:24F1                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:24F2                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_NON_DBCS
</span><span style="color:black">SYSINIT:24F4                 </span><span style="color:navy">mov     cs:</span>_$P_DBCSEV_OFF<span style="color:navy">, si </span>; save EV offset
<span style="color:black">SYSINIT:24F9                 </span><span style="color:navy">mov     cs:</span>_$P_DBCSEV_SEG<span style="color:navy">, bx </span>; save EV segment
<span style="color:black">SYSINIT:24FE
SYSINIT:24FE </span><span style="color:gray">_$P_DBCS00</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:24FE                 </span><span style="color:navy">lds     si, dword ptr cs:</span>_$P_DBCSEV_OFF ; load EV offset and segment
<span style="color:black">SYSINIT:2503
SYSINIT:2503 </span><span style="color:gray">_$P_DBCS_LOOP</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2503                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:#ff8000">0 </span>; zero vector ?
<span style="color:black">SYSINIT:2506                 </span><span style="color:navy">jz      short </span><span style="color:gray">_$P_NON_DBCS </span>; then exit
<span style="color:black">SYSINIT:2508                 </span><span style="color:navy">cmp     al, [si]        </span>; Check if AL is in range of the vector
<span style="color:black">SYSINIT:250A                 </span><span style="color:navy">jb      short </span><span style="color:gray">_$P_DBCS01
</span><span style="color:black">SYSINIT:250C                 </span><span style="color:navy">cmp     al, [si+</span><span style="color:#ff8000">1</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:250F                 </span><span style="color:navy">ja      short </span><span style="color:gray">_$P_DBCS01
</span><span style="color:black">SYSINIT:2511                 </span><span style="color:navy">stc                     </span>; if yes, indicate DBCS and exit
<span style="color:black">SYSINIT:2512                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_DBCS_EXIT
</span><span style="color:black">SYSINIT:2514 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2514
SYSINIT:2514 </span><span style="color:gray">_$P_DBCS01</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2514                 </span><span style="color:navy">inc     si              </span>; add 2 to si reg
<span style="color:black">SYSINIT:2515                 </span><span style="color:navy">inc     si              </span>; get next vector
<span style="color:black">SYSINIT:2516                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_$P_DBCS_LOOP </span>; loop until zero vector found
<span style="color:black">SYSINIT:2518 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2518
SYSINIT:2518 </span><span style="color:gray">_$P_NON_DBCS</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2518                 </span><span style="color:navy">clc                     </span>; indicate SBCS
<span style="color:black">SYSINIT:2518                                         </span>; (note: cf is already 0 here)
<span style="color:black">SYSINIT:2519
SYSINIT:2519 </span><span style="color:gray">_$P_DBCS_EXIT</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2519                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:251A                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:251B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:251C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:251C </span>_$P_Chk_DBCS    <span style="color:black">endp
SYSINIT:251C
SYSINIT:251C </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:251D </span>buf_parms       <span style="color:navy">dw offset </span>buf_parmsx    <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:251D                                         </span>; buffer = [n | n,m] {/e}
<span style="color:gray">SYSINIT:251F                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; an extra delimiter list
<span style="color:gray">SYSINIT:2520                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; length is 1
<span style="color:gray">SYSINIT:2521                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;                  </span>; delimiter
<span style="color:gray">SYSINIT:2522 </span>buf_parmsx      <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2523                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; min 1, max 2 positionals
<span style="color:gray">SYSINIT:2524                 </span><span style="color:navy">dw offset </span>buf_pos1
<span style="color:gray">SYSINIT:2526                 </span><span style="color:navy">dw offset </span>buf_pos2
<span style="color:gray">SYSINIT:2528                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; one switch
<span style="color:gray">SYSINIT:2529                 </span><span style="color:navy">dw offset </span>sw_x_ctrl
<span style="color:gray">SYSINIT:252B                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:252B                                         </span>;
<span style="color:gray">SYSINIT:252B                                         </span>; buf_pos1 p_pos &lt;8000h,0,result_val,buf_range_1&gt;
<span style="color:gray">SYSINIT:252B                                         </span>; numeric
<span style="color:gray">SYSINIT:252C </span>buf_pos1        <span style="color:navy">dw </span><span style="color:#008040">8000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:252C                                         </span>; match_flags - numeric value
<span style="color:gray">SYSINIT:252E                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; function flags
<span style="color:gray">SYSINIT:2530                 </span><span style="color:navy">dw offset </span>result_val    ; result value buffer
<span style="color:gray">SYSINIT:2532                 </span><span style="color:navy">dw offset </span>buf_range_1   ; value list
<span style="color:gray">SYSINIT:2534                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches/keywords
<span style="color:gray">SYSINIT:2535 </span>buf_range_1     <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2535                                         </span>; range definition
<span style="color:gray">SYSINIT:2536                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; 1 definition of range
<span style="color:gray">SYSINIT:2537                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; item tag for this range
<span style="color:gray">SYSINIT:2538                 </span><span style="color:navy">dd </span><span style="color:#008040">1                    </span>; numeric min
<span style="color:gray">SYSINIT:253C                 </span><span style="color:navy">dd </span><span style="color:#008040">99                   </span>; numeric max
<span style="color:gray">SYSINIT:253C                                         </span>;
<span style="color:gray">SYSINIT:253C                                         </span>; buf_pos2 p_pos &lt;8001h,0,result_val,buf_range_2&gt;
<span style="color:gray">SYSINIT:253C                                         </span>; optional num.
<span style="color:gray">SYSINIT:2540 </span>buf_pos2        <span style="color:navy">dw </span><span style="color:#008040">8001h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2542                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2544                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2546                 </span><span style="color:navy">dw offset </span>buf_range_2
<span style="color:gray">SYSINIT:2548                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>;
<span style="color:gray">SYSINIT:2548                                         </span>; buf_range_2 p_range &lt;,,,0,8&gt;
<span style="color:gray">SYSINIT:2549 </span>buf_range_2     <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:254A                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:254B                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:254C                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2550                 </span><span style="color:navy">dd </span><span style="color:#008040">8                    </span>;
<span style="color:gray">SYSINIT:2550                                         </span>; sw_x_ctrl p_pos &lt;0,0,result_val,noval,1&gt;
<span style="color:gray">SYSINIT:2550                                         </span>; followed by one switch
<span style="color:gray">SYSINIT:2554 </span>sw_x_ctrl       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2556                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2558                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:255A                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:255C                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; 1 switch
<span style="color:gray">SYSINIT:255D </span>switch_x        <span style="color:navy">db &#039;/X&#039;,0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2560 </span>p_buffers       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2562 </span>p_h_buffers     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2564 </span>p_buffer_slash_x <span style="color:navy">db </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2564                                         </span>;
<span style="color:gray">SYSINIT:2564                                         </span>; common definitions
<span style="color:gray">SYSINIT:2565 </span>noval           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2566 </span>result_val      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2566                                         </span>; type returned
<span style="color:gray">SYSINIT:2567 </span>result_val_itag <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2567                                         </span>; item tag returned
<span style="color:gray">SYSINIT:2568 </span>result_val_swoff <span style="color:navy">dw </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2568                                         </span>; es:offset of the switch defined
<span style="color:gray">SYSINIT:256A </span>rv_dword        <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:256A                                         </span>; rv_byte
<span style="color:gray">SYSINIT:256A                                         </span>; value if number, or seg:offset to string.
<span style="color:gray">SYSINIT:256A                                         </span>; ;;
<span style="color:gray">SYSINIT:256E </span>brk_parms       <span style="color:navy">dw offset </span>brk_parmsx    <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:256E                                         </span>; break = [ on | off ]
<span style="color:gray">SYSINIT:2570                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; an extra delimiter list
<span style="color:gray">SYSINIT:2571                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; length is 1
<span style="color:gray">SYSINIT:2572                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;                  </span>; delimiter
<span style="color:gray">SYSINIT:2573 </span>brk_parmsx      <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2573                                         </span>; min,max = 1 positional
<span style="color:gray">SYSINIT:2574                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2575                 </span><span style="color:navy">dw offset </span>brk_pos
<span style="color:gray">SYSINIT:2577                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:2578                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:2579 </span>brk_pos         <span style="color:navy">dw </span><span style="color:#008040">2000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:257B                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:257D                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:257F                 </span><span style="color:navy">dw offset </span>on_off_string
<span style="color:gray">SYSINIT:2581                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2582 </span>on_off_string   <span style="color:navy">db </span><span style="color:#008040">3                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2582                                         </span>; signals that there is a string choice
<span style="color:gray">SYSINIT:2583                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no range definition
<span style="color:gray">SYSINIT:2584                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no numeric values choice
<span style="color:gray">SYSINIT:2585                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; 2 strings for choice
<span style="color:gray">SYSINIT:2586                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; the 1st string tag
<span style="color:gray">SYSINIT:2587                 </span><span style="color:navy">dw offset </span>_on_string    <span style="color:gray">; &quot;ON&quot;
SYSINIT:2589                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; the 2nd string tag
<span style="color:gray">SYSINIT:258A                 </span><span style="color:navy">dw offset </span>_off_string   <span style="color:gray">; &quot;OFF&quot;
SYSINIT:258C </span>_on_string      <span style="color:navy">db &#039;ON&#039;,0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:258F </span>_off_string     <span style="color:navy">db &#039;OFF&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2593 </span>p_ctrl_break    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2593                                         </span>; local variable
<span style="color:gray">SYSINIT:2593                                         </span>; ;;
<span style="color:gray">SYSINIT:2594 </span>cntry_parms     <span style="color:navy">dw offset </span>cntry_parmsx  <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2594                                         </span>; country = n {m {path}}
<span style="color:gray">SYSINIT:2594                                         </span>; or country = n,,path
<span style="color:gray">SYSINIT:2596                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2597                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2598                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:2599 </span>cntry_parmsx    <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2599                                         </span>; min 1, max 3 pos.
<span style="color:gray">SYSINIT:259A                 </span><span style="color:navy">db </span><span style="color:#008040">3
</span><span style="color:gray">SYSINIT:259B                 </span><span style="color:navy">dw offset </span>cntry_pos1
<span style="color:gray">SYSINIT:259D                 </span><span style="color:navy">dw offset </span>cntry_pos2
<span style="color:gray">SYSINIT:259F                 </span><span style="color:navy">dw offset </span>cntry_pos3
<span style="color:gray">SYSINIT:25A1                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:25A2                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:25A3 </span>cntry_pos1      <span style="color:navy">dw </span><span style="color:#008040">8000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25A3                                         </span>; cntry_pos1 p_pos &lt;8000h,0,result_val,cc_range&gt;
<span style="color:gray">SYSINIT:25A3                                         </span>; numeric value
<span style="color:gray">SYSINIT:25A5                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25A7                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:25A9                 </span><span style="color:navy">dw offset </span>cc_range
<span style="color:gray">SYSINIT:25AB                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25AC </span>cc_range        <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25AC                                         </span>; cc_range p_range &lt;,,,1,999&gt;
<span style="color:gray">SYSINIT:25AD                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25AE                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25AF                 </span><span style="color:navy">dd </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25B3                 </span><span style="color:navy">dd </span><span style="color:#008040">999
</span><span style="color:gray">SYSINIT:25B7 </span>cntry_pos2      <span style="color:navy">dw </span><span style="color:#008040">8001h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25B7                                         </span>; cntry_pos2 p_pos &lt;8001h,0,result_val,cc_range&gt;
<span style="color:gray">SYSINIT:25B7                                         </span>; optional num.
<span style="color:gray">SYSINIT:25B9                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25BB                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:25BD                 </span><span style="color:navy">dw offset </span>cc_range
<span style="color:gray">SYSINIT:25BF                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25C0 </span>cntry_pos3      <span style="color:navy">dw </span><span style="color:#008040">201h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25C0                                         </span>; cntry_pos3 p_pos &lt;201h,0,result_val,noval&gt;
<span style="color:gray">SYSINIT:25C0                                         </span>; optional filespec
<span style="color:gray">SYSINIT:25C2                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25C4                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:25C6                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:25C8                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25C9 </span>p_cntry_code    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25C9                                         </span>; local variable
<span style="color:gray">SYSINIT:25CB </span>p_code_page     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25CB                                         </span>; local variable
<span style="color:gray">SYSINIT:25CB                                         </span>; ;;
<span style="color:gray">SYSINIT:25CD </span>files_parms     <span style="color:navy">dw offset </span>files_parmsx  <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25CD                                         </span>; files = n
<span style="color:gray">SYSINIT:25CF                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25D0                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25D1                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:25D2 </span>files_parmsx    <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25D3                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; min,max 1 positional
<span style="color:gray">SYSINIT:25D4                 </span><span style="color:navy">dw offset </span>files_pos
<span style="color:gray">SYSINIT:25D6                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:25D7                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:25D8 </span>files_pos       <span style="color:navy">dw </span><span style="color:#008040">8000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25D8                                         </span>; files_pos p_pos &lt;8000h,0,result_val,files_range,0&gt;
<span style="color:gray">SYSINIT:25D8                                         </span>; numeric value
<span style="color:gray">SYSINIT:25DA                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25DC                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:25DE                 </span><span style="color:navy">dw offset </span>files_range
<span style="color:gray">SYSINIT:25E0                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25E1 </span>files_range     <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25E1                                         </span>; files_range p_range &lt;,,,8,255&gt;
<span style="color:gray">SYSINIT:25E2                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25E3                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25E4                 </span><span style="color:navy">dd </span><span style="color:#008040">8
</span><span style="color:gray">SYSINIT:25E8                 </span><span style="color:navy">dd </span><span style="color:#008040">255
</span><span style="color:gray">SYSINIT:25EC </span>p_files         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25EC                                         </span>; local variable
<span style="color:gray">SYSINIT:25EC                                         </span>; ;;
<span style="color:gray">SYSINIT:25ED </span>fcbs_parms      <span style="color:navy">dw offset </span>fcbs_parmsx   <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25ED                                         </span>; fcbs = n,m
<span style="color:gray">SYSINIT:25EF                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25F0                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:25F1                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:25F2 </span>fcbs_parmsx     <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25F3                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:25F4                 </span><span style="color:navy">dw offset </span>fcbs_pos_1
<span style="color:gray">SYSINIT:25F6                 </span><span style="color:navy">dw offset </span>fcbs_pos_2
<span style="color:gray">SYSINIT:25F8                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:25F9                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:25FA </span>fcbs_pos_1      <span style="color:navy">dw </span><span style="color:#008040">8000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:25FA                                         </span>; fcbs_pos_1 p_pos &lt;8000h,0,result_val,fcbs_range&gt;
<span style="color:gray">SYSINIT:25FA                                         </span>; numeric value
<span style="color:gray">SYSINIT:25FC                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:25FE                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2600                 </span><span style="color:navy">dw offset </span>fcbs_range
<span style="color:gray">SYSINIT:2602                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2603 </span>fcbs_range      <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2603                                         </span>; fcbs_range p_range &lt;,,,1,255&gt;
<span style="color:gray">SYSINIT:2604                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2605                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2606                 </span><span style="color:navy">dd </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:260A                 </span><span style="color:navy">dd </span><span style="color:#008040">255
</span><span style="color:gray">SYSINIT:260E </span>fcbs_pos_2      <span style="color:navy">dw </span><span style="color:#008040">8000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:260E                                         </span>; fcbs_pos_2 p_pos &lt;8000h,0,result_val,fcbs_keep_range&gt;
<span style="color:gray">SYSINIT:260E                                         </span>; numeric value
<span style="color:gray">SYSINIT:2610                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2612                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2614                 </span><span style="color:navy">dw offset </span>fcbs_keep_range
<span style="color:gray">SYSINIT:2616                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2617 </span>fcbs_keep_range <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2617                                         </span>; fcbs_keep_range p_range &lt;,,,0,255&gt;
<span style="color:gray">SYSINIT:2618                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2619                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:261A                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:261E                 </span><span style="color:navy">dd </span><span style="color:#008040">255
</span><span style="color:gray">SYSINIT:2622 </span>p_fcbs          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2622                                         </span>; local variable
<span style="color:gray">SYSINIT:2623 </span>p_keep          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2623                                         </span>; local variable
<span style="color:gray">SYSINIT:2623                                         </span>; ;;
<span style="color:gray">SYSINIT:2624 </span>ldrv_parms      <span style="color:navy">dw offset </span>ldrv_parmsx   <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2624                                         </span>; lastdrive = x
<span style="color:gray">SYSINIT:2626                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2627                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2628                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:2629 </span>ldrv_parmsx     <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:262A                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; min,max = 1 positional
<span style="color:gray">SYSINIT:262B                 </span><span style="color:navy">dw offset </span>ldrv_pos
<span style="color:gray">SYSINIT:262D                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:262E                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:262F </span>ldrv_pos        <span style="color:navy">dw </span><span style="color:#008040">110h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:262F                                         </span>; ldrv_pos p_pos &lt;110h,10h,result_val,noval&gt;
<span style="color:gray">SYSINIT:262F                                         </span>; drive only, ignore colon at end
<span style="color:gray">SYSINIT:2631                 </span><span style="color:navy">dw </span><span style="color:#008040">10h
</span><span style="color:gray">SYSINIT:2633                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2635                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:2637                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2638 </span>p_ldrv          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2638                                         </span>; local variable
<span style="color:gray">SYSINIT:2638                                         </span>; ;;
<span style="color:gray">SYSINIT:2639 </span>stks_parms      <span style="color:navy">dw offset </span>stks_parmsx   <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2639                                         </span>; stacks = n,m
<span style="color:gray">SYSINIT:263B                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:263C                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:263D                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:263E </span>stks_parmsx     <span style="color:navy">db </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:263F                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; min,max = 2 positionals
<span style="color:gray">SYSINIT:2640                 </span><span style="color:navy">dw offset </span>stks_pos_1
<span style="color:gray">SYSINIT:2642                 </span><span style="color:navy">dw offset </span>stks_pos_2
<span style="color:gray">SYSINIT:2644                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:2645                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:2646 </span>stks_pos_1      <span style="color:navy">dw </span><span style="color:#008040">8000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2646                                         </span>; stks_pos_1 p_pos &lt;8000h,0,result_val,stks_range&gt;
<span style="color:gray">SYSINIT:2646                                         </span>; numeric value
<span style="color:gray">SYSINIT:2648                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:264A                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:264C                 </span><span style="color:navy">dw offset </span>stks_range
<span style="color:gray">SYSINIT:264E                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:264F </span>stks_range      <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:264F                                         </span>; stks_range p_range &lt;,,,0,64&gt;
<span style="color:gray">SYSINIT:2650                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2651                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2652                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2656                 </span><span style="color:navy">dd </span><span style="color:#008040">64
</span><span style="color:gray">SYSINIT:265A </span>stks_pos_2      <span style="color:navy">dw </span><span style="color:#008040">8000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:265A                                         </span>; stks_pos_2 p_pos &lt;8000h,0,result_val,stk_size_range&gt;
<span style="color:gray">SYSINIT:265A                                         </span>; numeric value
<span style="color:gray">SYSINIT:265C                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:265E                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2660                 </span><span style="color:navy">dw offset </span>stk_size_range
<span style="color:gray">SYSINIT:2662                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2663 </span>stk_size_range  <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2663                                         </span>; stk_size_range p_range &lt;,,,0,512&gt;
<span style="color:gray">SYSINIT:2664                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2665                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2666                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:266A                 </span><span style="color:navy">dd </span><span style="color:#008040">512
</span><span style="color:gray">SYSINIT:266E </span>p_stack_count   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:266E                                         </span>; local variable
<span style="color:gray">SYSINIT:2670 </span>p_stack_size    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2670                                         </span>; local variable
<span style="color:gray">SYSINIT:2670                                         </span>; ;;
<span style="color:gray">SYSINIT:2672 </span>mtrk_parms      <span style="color:navy">dw offset </span>mtrk_parmsx   <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2672                                         </span>; multitrack = [ on | off ]
<span style="color:gray">SYSINIT:2674                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2675                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2676                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:2677 </span>mtrk_parmsx     <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2677                                         </span>; min,max = 1 positional
<span style="color:gray">SYSINIT:2678                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2679                 </span><span style="color:navy">dw offset </span>mtrk_pos
<span style="color:gray">SYSINIT:267B                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:267C                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:267D </span>mtrk_pos        <span style="color:navy">dw </span><span style="color:#008040">2000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:267D                                         </span>; mtrk_pos p_pos &lt;2000h,0,result_val,on_off_string&gt;
<span style="color:gray">SYSINIT:267D                                         </span>; simple string
<span style="color:gray">SYSINIT:267F                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2681                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2683                 </span><span style="color:navy">dw offset </span>on_off_string
<span style="color:gray">SYSINIT:2685                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2686 </span>p_mtrk          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2686                                         </span>; local variable
<span style="color:gray">SYSINIT:2686                                         </span>; ;;
<span style="color:gray">SYSINIT:2687 </span>swit_parms      <span style="color:navy">dw offset </span>swit_parmsx   <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2687                                         </span>; switches=/k
<span style="color:gray">SYSINIT:2689                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:268A                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:268B                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:268C </span>swit_parmsx     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:268C                                         </span>; no positionals
<span style="color:gray">SYSINIT:268E                 </span><span style="color:navy">db </span><span style="color:#008040">6                    </span>; # of switches (6 for PCDOS 7.1 IBMBIO.COM)
<span style="color:gray">SYSINIT:268E                                         </span>;  (5 for MSDOS 6.21 IO.SYS)
<span style="color:gray">SYSINIT:268F                 </span><span style="color:navy">dw offset </span>swit_k_ctrl   ; /k control
<span style="color:gray">SYSINIT:2691                 </span><span style="color:navy">dw offset </span>swit_n_ctrl   ; /n control (for MULTI_CONFIG only)
<span style="color:gray">SYSINIT:2693                 </span><span style="color:navy">dw offset </span>swit_f_ctrl   ; /f control (for MULTI_CONFIG only)
<span style="color:gray">SYSINIT:2695                 </span><span style="color:navy">dw offset </span>swit_t_ctrl   ; /t control
<span style="color:gray">SYSINIT:2697                 </span><span style="color:navy">dw offset </span>swit_w_ctrl   ; /w control
<span style="color:gray">SYSINIT:2699                 </span><span style="color:navy">dw offset </span>swit_i_ctrl   ; /i control
<span style="color:gray">SYSINIT:2699                                         </span>; (6th switch for PCDOS 7.1 IBMBIO.COM)
<span style="color:gray">SYSINIT:269B                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:269C </span>swit_k_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:269C                                         </span>; swit_k_ctrl p_pos &lt;0,0,result_val,noval,1&gt;
<span style="color:gray">SYSINIT:269C                                         </span>; switch string follows
<span style="color:gray">SYSINIT:269E                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26A0                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26A2                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26A4                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26A5 </span>swit_k          <span style="color:navy">db &#039;/K&#039;,0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26A8 </span>swit_n_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26A8                                         </span>; swit_n_ctrl p_pos &lt;0,0,result_val,noval,1&gt;
<span style="color:gray">SYSINIT:26A8                                         </span>; switch string follows
<span style="color:gray">SYSINIT:26AA                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26AC                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26AE                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26B0                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26B1 </span>swit_n          <span style="color:navy">db &#039;/N&#039;,0               </span><span style="color:olive">; ...
</span><span style="color:gray">SYSINIT:26B4 </span>swit_f_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26B4                                         </span>; swit_f_ctrl p_pos &lt;0,0,result_val,noval,1&gt;
<span style="color:gray">SYSINIT:26B4                                         </span>; switch string follows
<span style="color:gray">SYSINIT:26B6                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26B8                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26BA                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26BC                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26BD </span>swit_f          <span style="color:navy">db &#039;/F&#039;,0               </span><span style="color:olive">; ...
</span><span style="color:gray">SYSINIT:26C0 </span>swit_t_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26C0                                         </span>; swit_t_ctrl p_pos &lt;0,0,result_val,noval,1&gt;
<span style="color:gray">SYSINIT:26C0                                         </span>; switch string follows
<span style="color:gray">SYSINIT:26C2                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26C4                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26C6                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26C8                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26C9 </span>swit_t          <span style="color:navy">db &#039;/T&#039;,0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26CC </span>swit_w_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26CC                                         </span>; swit_w_ctrl p_pos &lt;0,0,result_val,noval,1&gt;
<span style="color:gray">SYSINIT:26CC                                         </span>; switch string follows
<span style="color:gray">SYSINIT:26CE                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26D0                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26D2                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26D4                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26D5 </span>swit_w          <span style="color:navy">db &#039;/W&#039;,0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26D8 </span>swit_i_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26D8                                         </span>; swit_i_ctrl p_pos &lt;0,0,result_val,noval,1&gt;
<span style="color:gray">SYSINIT:26D8                                         </span>; switch string follows
<span style="color:gray">SYSINIT:26DA                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26DC                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26DE                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26E0                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26E1 </span>swit_i          <span style="color:navy">db &#039;/I&#039;,0               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:26E4 </span>swit_c_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0                    </span>; ! (/C, /D, /E switches are not used) !
<span style="color:gray">SYSINIT:26E4                                         </span>; Erdogan Tan - 09/07/2023
<span style="color:gray">SYSINIT:26E6                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26E8                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26EA                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26EC                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26ED </span>swit_c          <span style="color:navy">db &#039;/C&#039;,0
</span><span style="color:gray">SYSINIT:26F0 </span>swit_d_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26F2                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26F4                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:26F6                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:26F8                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:26F9 </span>swit_d          <span style="color:navy">db &#039;/D&#039;,0
</span><span style="color:gray">SYSINIT:26FC </span>swit_e_ctrl     <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:26FE                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2700                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2702                 </span><span style="color:navy">dw offset </span>noval
<span style="color:gray">SYSINIT:2704                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2705 </span>swit_e          <span style="color:navy">db &#039;/E&#039;,0
</span><span style="color:gray">SYSINIT:2708                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2709                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:270A                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:270B </span>p_swit_k        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:270B                                         </span>; local variable
<span style="color:gray">SYSINIT:270C </span>p_swit_t        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:270C                                         </span>; local variable
<span style="color:gray">SYSINIT:270D </span>p_swit_w        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:270D                                         </span>; local variable
<span style="color:gray">SYSINIT:270E </span>p_swit_i        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:270E                                         </span>; local variable
<span style="color:gray">SYSINIT:270E                                         </span>; ;;
<span style="color:gray">SYSINIT:270F </span>dos_parms       <span style="color:navy">dw offset </span>dos_parmsx    <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:270F                                         </span>; DOS = [ high | low ]
<span style="color:gray">SYSINIT:270F                                         </span>; DOS = HIGH|LOW[,UMB|,NOUMB]
<span style="color:gray">SYSINIT:2711                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2712                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2713                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:2714 </span>dos_parmsx      <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2714                                         </span>; min parameters
<span style="color:gray">SYSINIT:2715                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; max parameters
<span style="color:gray">SYSINIT:2716                 </span><span style="color:navy">dw offset </span>dos_pos
<span style="color:gray">SYSINIT:2718                 </span><span style="color:navy">dw offset </span>dos_pos
<span style="color:gray">SYSINIT:271A                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:271B                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:271C </span>dos_pos         <span style="color:navy">dw </span><span style="color:#008040">2000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:271E                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2720                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:2722                 </span><span style="color:navy">dw offset </span>dos_strings
<span style="color:gray">SYSINIT:2724                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2725 </span>dos_pos2        <span style="color:navy">dw </span><span style="color:#008040">2000h                </span>; dos_pos p_pos &lt;2000h,0,result_val,dos_strings&gt;
<span style="color:gray">SYSINIT:2725                                         </span>; simple string
<span style="color:gray">SYSINIT:2725                                         </span>; (this is not needed) - E.TAN - 08/07/2023
<span style="color:gray">SYSINIT:2727                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2729                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:272B                 </span><span style="color:navy">dw offset </span>dos_strings
<span style="color:gray">SYSINIT:272D                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:272E </span>dos_strings     <span style="color:navy">db </span><span style="color:#008040">3                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:272E                                         </span>; signals that there is a string choice
<span style="color:gray">SYSINIT:272F                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no range definition
<span style="color:gray">SYSINIT:2730                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no numeric values choice
<span style="color:gray">SYSINIT:2731                 </span><span style="color:navy">db </span><span style="color:#008040">4                    </span>; 4 strings for choice
<span style="color:gray">SYSINIT:2732                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; the 1st string tag
<span style="color:gray">SYSINIT:2733                 </span><span style="color:navy">dw offset </span>hi_string     <span style="color:gray">; &quot;HIGH&quot;
SYSINIT:2735                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; the 2nd string tag
<span style="color:gray">SYSINIT:2736                 </span><span style="color:navy">dw offset </span>lo_string     <span style="color:gray">; &quot;LOW&quot;
SYSINIT:2738                 </span><span style="color:navy">db </span><span style="color:#008040">3
</span><span style="color:gray">SYSINIT:2739                 </span><span style="color:navy">dw offset </span>umb_string    <span style="color:gray">; &quot;UMB&quot;
SYSINIT:273B                 </span><span style="color:navy">db </span><span style="color:#008040">4
</span><span style="color:gray">SYSINIT:273C                 </span><span style="color:navy">dw offset </span>noumb_string  <span style="color:gray">; &quot;NOUMB&quot;
SYSINIT:273E </span>dosdata_parms   <span style="color:navy">dw offset </span>dosdata_parmsx <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:273E                                         </span>; DOSDATA = UMB|NOUMB
<span style="color:gray">SYSINIT:2740                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2741                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:2742                 </span><span style="color:navy">db &#039;</span><span style="color:green">;&#039;
</span><span style="color:gray">SYSINIT:2743 </span>dosdata_parmsx  <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2744                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; min,max = 1 positional
<span style="color:gray">SYSINIT:2745                 </span><span style="color:navy">dw offset </span>dosdata_pos
<span style="color:gray">SYSINIT:2747                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no switches
<span style="color:gray">SYSINIT:2748                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no keywords
<span style="color:gray">SYSINIT:2749 </span>dosdata_pos     <span style="color:navy">dw </span><span style="color:#008040">2000h                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2749                                         </span>; dosdata_pos p_pos &lt;2000h,0,result_val,dosdata_strings&gt;
<span style="color:gray">SYSINIT:2749                                         </span>; simple string
<span style="color:gray">SYSINIT:274B                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:274D                 </span><span style="color:navy">dw offset </span>result_val
<span style="color:gray">SYSINIT:274F                 </span><span style="color:navy">dw offset </span>dosdata_strings
<span style="color:gray">SYSINIT:2751                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:2752 </span>dosdata_strings <span style="color:navy">db </span><span style="color:#008040">3                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2752                                         </span>; signals that there is a string choice
<span style="color:gray">SYSINIT:2753                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no range definition
<span style="color:gray">SYSINIT:2754                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; no numeric values choice
<span style="color:gray">SYSINIT:2755                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; 4 strings for choice
<span style="color:gray">SYSINIT:2756                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; the 1st string tag
<span style="color:gray">SYSINIT:2757                 </span><span style="color:navy">dw offset </span>umb_string    <span style="color:gray">; &quot;UMB&quot;
SYSINIT:2759                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; the 2nd string tag
<span style="color:gray">SYSINIT:275A                 </span><span style="color:navy">dw offset </span>noumb_string  <span style="color:gray">; &quot;NOUMB&quot;
SYSINIT:275C </span>hi_string       <span style="color:navy">db &#039;HIGH&#039;,0             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2761 </span>lo_string       <span style="color:navy">db &#039;LOW&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2765 </span>umb_string      <span style="color:navy">db &#039;UMB&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2769 </span>noumb_string    <span style="color:navy">db &#039;NOUMB&#039;,0            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:276F </span>p_dos_hi        <span style="color:navy">db </span><span style="color:#008040">0                    </span>; local variable (parser does not use this)
<span style="color:gray">SYSINIT:2770                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>;
<span style="color:gray">SYSINIT:2770                                         </span>; for LoadHigh and DeviceHigh:
<span style="color:gray">SYSINIT:2770                                         </span>;    fInHigh  - Is set to 1 during HideUMBs(), and back to zero in
<span style="color:gray">SYSINIT:2770                                         </span>;               UnHideUMBs().
<span style="color:gray">SYSINIT:2770                                         </span>;    fUmbTiny - Is set to 1 iff the user has specified /S on the
<span style="color:gray">SYSINIT:2770                                         </span>;               command line.
<span style="color:gray">SYSINIT:2770                                         </span>;    SegLoad  - Segment address for first UMB specified; set
<span style="color:gray">SYSINIT:2770                                         </span>;               automatically.
<span style="color:gray">SYSINIT:2770                                         </span>;    UmbLoad  - The load UMB number; for example, this is 3 if the
<span style="color:gray">SYSINIT:2770                                         </span>;               user has given a command-line like &quot;/L:3,500;4&quot;
<span style="color:gray">SYSINIT:2770                                         </span>;    fm_umb   - Set to the old UMB link-state (0x80 or 0x00)
<span style="color:gray">SYSINIT:2770                                         </span>;    fm_strat - Set to the old memory-allocation strategy (0$00000???)
<span style="color:gray">SYSINIT:2770                                         </span>;    fm_argc  - Number of arguments received by ParseVar()
<span style="color:gray">SYSINIT:2771 </span>fInHigh         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2772 </span>fUmbTiny        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2773 </span>SegLoad         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2775 </span>UmbLoad         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2775                                         </span>; UmbUsed - An array of characters, each of which is 1 if the UMB
<span style="color:gray">SYSINIT:2775                                         </span>;           matching its index number was specified on the
<span style="color:gray">SYSINIT:2775                                         </span>;           command line;
<span style="color:gray">SYSINIT:2775                                         </span>;        for example, after &quot;/L:3,500;4;7&quot;, UmbUsed[3],[4] &amp; [7]
<span style="color:gray">SYSINIT:2775                                         </span>;        will be set to 1. All others will be set to 0.
<span style="color:gray">SYSINIT:2775                                         </span>; UmbSize - An array of words, each of which is interpereted as a
<span style="color:gray">SYSINIT:2775                                         </span>;           size specified by the user for a UMB (in the above
<span style="color:gray">SYSINIT:2775                                         </span>;           example, all elements would be zero save UmbSize[3],
<span style="color:gray">SYSINIT:2775                                         </span>;           which would be 500.
<span style="color:gray">SYSINIT:2776 </span>UmbUsed         <span style="color:navy">db </span><span style="color:#008040">16 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2776                                         </span>; times MAXUMB db 0
<span style="color:gray">SYSINIT:2786 </span>UmbSize         <span style="color:navy">dw </span><span style="color:#008040">16 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:2786                                         </span>; times MAXUMB dw 0
<span style="color:gray">SYSINIT:27A6 </span>fm_umb          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27A7 </span>fm_strat        <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:27A8 </span>fm_argc         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27A9 </span>DevSize         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27A9                                         </span>; size of the device driver being loaded (paras)
<span style="color:gray">SYSINIT:27AB </span>DevLoadAddr     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27AB                                         </span>; Mem addr where the device driver is 2 b loaded
<span style="color:gray">SYSINIT:27AD </span>DevLoadEnd      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27AD                                         </span>; MaxAddr to which device can be loaded
<span style="color:gray">SYSINIT:27AF </span>DevEntry        <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27AF                                         </span>; Entry point to the device driver
<span style="color:gray">SYSINIT:27B3 </span>DevBrkAddr      <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27B3                                         </span>; Break address of the device driver
<span style="color:gray">SYSINIT:27B7 </span>ConvLoad        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27B7                                         </span>; Use conventional (dos 5 style) InitDevLoad?
<span style="color:gray">SYSINIT:27B8 </span>DevUMB          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27B8                                         </span>; byte indicating whether to load DDs in UMBs
<span style="color:gray">SYSINIT:27B9 </span>DevUMBAddr      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27B9                                         </span>; current UMB used for loading devices (paras)
<span style="color:gray">SYSINIT:27BB </span>DevUMBSize      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27BB                                         </span>; Size of the current UMB being used (paras)
<span style="color:gray">SYSINIT:27BD </span>DevUMBFree      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27BD                                         </span>; Start of free mem blk in the current UMB (paras)
<span style="color:gray">SYSINIT:27BF </span>DevXMSAddr      <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27C3 </span>DevExecAddr     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27C3                                         </span>; Device load address parameter to Exec call
<span style="color:gray">SYSINIT:27C5 </span>DevExecReloc    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27C5                                         </span>; Device load relocation factor
<span style="color:gray">SYSINIT:27C7 </span>DeviceHi        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27C7                                         </span>; Flag indicating whether the current device
<span style="color:gray">SYSINIT:27C7                                         </span>; is being loaded into UMB
<span style="color:gray">SYSINIT:27C8 </span>DevSizeOption   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27C8                                         </span>; SIZE= option
<span style="color:gray">SYSINIT:27CA </span>Int12Lied       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27CA                                         </span>; did we trap int 12h ?
<span style="color:gray">SYSINIT:27CB </span>OldInt12Mem     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27CB                                         </span>; value in 40:13h (int 12h ram)
<span style="color:gray">SYSINIT:27CD </span>ThreeComName    <span style="color:navy">db &#039;PROTMAN$&#039;           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27CD                                         </span>; 3Com Device name
<span style="color:gray">SYSINIT:27D5 </span>FirstUMBLinked  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27D6 </span>DevDOSData      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27D6                                         </span>; segment of DOS Data
<span style="color:gray">SYSINIT:27D8 </span>DevCmdLine      <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27D8                                         </span>; Current Command line
<span style="color:gray">SYSINIT:27DC </span>DevSavedDelim   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27DC                                         </span>; The delimiter which was replaced with null
<span style="color:gray">SYSINIT:27DC                                         </span>; to use the file name in the command line
<span style="color:gray">SYSINIT:27DD </span>MagicHomeFlag   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:27DD                                         </span>; set non-zero when MagicDrv is final placed
<span style="color:black">SYSINIT:27DE
SYSINIT:27DE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:27DE
SYSINIT:27DE
SYSINIT:27DE </span>doconf          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:27DE
SYSINIT:27DE </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:28A1 SIZE 0000003A BYTES
</span><span style="color:black">SYSINIT:27DE </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:28EF SIZE 0000001D BYTES
</span><span style="color:black">SYSINIT:27DE </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:290E SIZE 0000069F BYTES
</span><span style="color:black">SYSINIT:27DE </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:2FC1 SIZE 00000317 BYTES
</span><span style="color:black">SYSINIT:27DE </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:3326 SIZE 0000000C BYTES
</span><span style="color:black">SYSINIT:27DE
SYSINIT:27DE                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:27DF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:27E0                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:27E0                 </span><span style="color:navy">mov     ax, </span><span style="color:green">3700h       </span>; (CHAR_OPER&lt;&lt;8)
<span style="color:black">SYSINIT:27E3                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - GET SWITCHAR/AVAILDEV
<span style="color:black">SYSINIT:27E3                                         </span>; Return: AL = FFh unsupported subfunction
<span style="color:black">SYSINIT:27E3                                         </span>; DL = current switch character
<span style="color:black">SYSINIT:27E5                 </span><span style="color:navy">mov     byte ptr </span>command_line<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, dl </span><span style="color:gray">; &quot;/P&quot;
</span><span style="color:black">SYSINIT:27E9                 </span><span style="color:navy">mov     </span>def_swchr<span style="color:navy">, dl   </span>; save default switchchar
<span style="color:black">SYSINIT:27ED                 </span><span style="color:navy">mov     dx, offset </span>config <span style="color:gray">; &quot;\\CONFIG.SYS&quot;
</span><span style="color:black">SYSINIT:27F0                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3D00h       </span>; OPEN&lt;&lt;8
<span style="color:black">SYSINIT:27F3                 </span><span style="color:navy">stc                     </span>; (in case of int 24h)
<span style="color:black">SYSINIT:27F4                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - OPEN DISK FILE WITH HANDLE
<span style="color:black">SYSINIT:27F4                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:black">SYSINIT:27F4                                         </span>; AL = access mode
<span style="color:black">SYSINIT:27F4                                         </span>; 0 - read
<span style="color:black">SYSINIT:27F6                 </span><span style="color:navy">jnb     short </span><span style="color:gray">noprob    </span>; brif opened okay
<span style="color:black">SYSINIT:27F6                                         </span>;
<span style="color:black">SYSINIT:27F6                                         </span>; config.sys file open error
<span style="color:black">SYSINIT:27F8                 </span><span style="color:navy">call    </span>kbd_read        ; we still want to give the guy
<span style="color:black">SYSINIT:27F8                                         </span>; a chance to select clean boot!
<span style="color:black">SYSINIT:27F8                                         </span>; (ie, no autoexec.bat processing)
<span style="color:black">SYSINIT:27FB                 </span><span style="color:navy">mov     </span>multi_pass_id<span style="color:navy">, </span><span style="color:green">11 </span>; set it to unreasonable number
<span style="color:black">SYSINIT:2800                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2801 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2801
SYSINIT:2801 </span><span style="color:gray">noprob</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2801                 </span><span style="color:navy">mov     bx, ax          </span>; get file size (note &lt; 64k!!)
<span style="color:black">SYSINIT:2801                                         </span>; File handle
<span style="color:black">SYSINIT:2803                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:2805                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">SYSINIT:2807                 </span><span style="color:navy">mov     ax, </span><span style="color:green">4202h       </span>; (LSEEK&lt;&lt;8)|2
<span style="color:black">SYSINIT:280A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
<span style="color:black">SYSINIT:280A                                         </span>; AL = method: offset from end of file
<span style="color:black">SYSINIT:280C                 </span><span style="color:navy">mov     </span>count<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:280F                 </span><span style="color:navy">xor     dx, dx          </span>; reset pointer to beginning of file
<span style="color:black">SYSINIT:2811                 </span><span style="color:navy">mov     ax, </span><span style="color:green">4200h
</span><span style="color:black">SYSINIT:2814                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
<span style="color:black">SYSINIT:2814                                         </span>; AL = method: offset from beginning of file
<span style="color:black">SYSINIT:2816                 </span><span style="color:navy">mov     dx, </span>ALLOCLIM    ; use current alloclim value
<span style="color:black">SYSINIT:281A                 </span><span style="color:navy">mov     ax, </span>count
<span style="color:black">SYSINIT:281D                 </span><span style="color:navy">mov     </span>config_size<span style="color:navy">, ax </span>; save the size of config.sys file.
<span style="color:black">SYSINIT:2820                 </span><span style="color:navy">call    </span>ParaRound
<span style="color:black">SYSINIT:2823                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:black">SYSINIT:2825                 </span><span style="color:navy">dec     dx              </span>; reserve 1 additional paragraph
<span style="color:black">SYSINIT:2826                 </span><span style="color:navy">mov     </span>config_wrkseg<span style="color:navy">, dx </span>; this is the segment to be used for
<span style="color:black">SYSINIT:282A                 </span><span style="color:navy">sub     dx, ax          </span>; rebuilding the config.sys memory image
<span style="color:black">SYSINIT:282C                 </span><span style="color:navy">sub     dx, </span><span style="color:#ff8000">11h         </span>; room for header
<span style="color:black">SYSINIT:282F                 </span><span style="color:navy">mov     </span>ALLOCLIM<span style="color:navy">, dx    </span>; config starts here. new alloclim value.
<span style="color:black">SYSINIT:2833                 </span><span style="color:navy">mov     </span>CONFBOT<span style="color:navy">, dx
</span><span style="color:black">SYSINIT:2837                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:black">SYSINIT:2839                 </span>assume ds:nothing
<span style="color:black">SYSINIT:2839                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">SYSINIT:283B                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">SYSINIT:283D                 </span><span style="color:navy">mov     cx, cs:</span>count
<span style="color:black">SYSINIT:2842                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Fh
</span><span style="color:black">SYSINIT:2844                 </span><span style="color:navy">stc                     </span>; (in case of int 24h)
<span style="color:black">SYSINIT:2845                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - READ FROM FILE WITH HANDLE
<span style="color:black">SYSINIT:2845                                         </span>; BX = file handle, CX = number of bytes to read
<span style="color:black">SYSINIT:2845                                         </span>; DS:DX -&gt; buffer
<span style="color:black">SYSINIT:2847                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:2848                 </span><span style="color:navy">push    ax              </span>; find the eof mark in the file.
<span style="color:black">SYSINIT:2848                                         </span>; if present,then trim length.
<span style="color:black">SYSINIT:2849                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:284A                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:284B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1Ah         </span>; eof mark
<span style="color:black">SYSINIT:284D                 </span><span style="color:navy">mov     di, dx          </span>; point to buffer
<span style="color:black">SYSINIT:284F                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">puteol    </span>; no chars
<span style="color:black">SYSINIT:2851                 </span><span style="color:navy">repne scasb             </span>; find end
<span style="color:black">SYSINIT:2853                 </span><span style="color:navy">jnz     short </span><span style="color:gray">puteol    </span>; none found and count exhausted
<span style="color:black">SYSINIT:2855                 </span><span style="color:navy">dec     di              </span>; backup past 1Ah
<span style="color:black">SYSINIT:2856
SYSINIT:2856 </span><span style="color:gray">puteol</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2856                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; cr,lf
<span style="color:black">SYSINIT:2858                 </span><span style="color:navy">stosb
</span><span style="color:black">SYSINIT:2859                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">SYSINIT:285B                 </span><span style="color:navy">stosb
</span><span style="color:black">SYSINIT:285C                 </span><span style="color:navy">sub     di, dx          </span>; difference moved
<span style="color:black">SYSINIT:285E                 </span><span style="color:navy">mov     cs:</span>count<span style="color:navy">, di    </span>; new count
<span style="color:black">SYSINIT:2863                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:2864                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:2865                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:2866                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2867                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2868                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:2868                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:2869                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:black">SYSINIT:286B                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:black">SYSINIT:286B                                         </span>; BX = file handle
<span style="color:black">SYSINIT:286D                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:286E                 </span><span style="color:navy">popf
</span><span style="color:black">SYSINIT:286F                 </span><span style="color:navy">jb      short </span><span style="color:gray">conferr   </span>; we&#039;ve got a problem
<span style="color:black">SYSINIT:2871                 </span><span style="color:navy">cmp     cx, ax
</span><span style="color:black">SYSINIT:2873                 </span><span style="color:navy">jz      short </span><span style="color:gray">getcom    </span>; if ax &lt;(&gt;) cx
<span style="color:black">SYSINIT:2873                                         </span>; couldn&#039;t read the file
<span style="color:black">SYSINIT:2875
SYSINIT:2875 </span><span style="color:gray">conferr</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2875                 </span><span style="color:navy">mov     dx, offset </span>config <span style="color:gray">; &quot;\\CONFIG.SYS&quot;
</span><span style="color:black">SYSINIT:2878                 </span><span style="color:navy">call    </span>badfil          ; print config error
<span style="color:black">SYSINIT:287B
SYSINIT:287B </span>endconv<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:287B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:287B </span>doconf          <span style="color:black">endp
SYSINIT:287B
SYSINIT:287C
SYSINIT:287C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:287C
SYSINIT:287C
SYSINIT:287C </span>multi_pass      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:287C                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:287D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:287E                 </span><span style="color:navy">cmp     </span>multi_pass_id<span style="color:navy">, </span><span style="color:green">10 </span>; do nothing. just return.
<span style="color:black">SYSINIT:2883
SYSINIT:2883 </span>jae_endconv<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2883                 </span><span style="color:navy">jnb     short </span>endconv
<span style="color:black">SYSINIT:2885                 </span><span style="color:navy">push    </span>CONFBOT
<span style="color:black">SYSINIT:2889                 </span><span style="color:navy">pop     es              </span>; es = [confbot] (CONFIG.SYS image seg)
<span style="color:black">SYSINIT:288A                 </span><span style="color:navy">mov     si, </span>org_count
<span style="color:black">SYSINIT:288E                 </span><span style="color:navy">mov     </span>count<span style="color:navy">, si       </span>; set count
<span style="color:black">SYSINIT:2892                 </span><span style="color:navy">xor     si, si          </span>; 0
<span style="color:black">SYSINIT:2894                 </span><span style="color:navy">mov     </span>chrptr<span style="color:navy">, si      </span>; reset chrptr
<span style="color:black">SYSINIT:2898                 </span><span style="color:navy">mov     </span>linecount<span style="color:navy">, si   </span>; reset linecount
<span style="color:black">SYSINIT:289C                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:289F                 </span><span style="color:navy">jmp     short </span>conflp
<span style="color:black">SYSINIT:289F </span>multi_pass      <span style="color:black">endp
SYSINIT:289F
SYSINIT:28A1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:28A1 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:28A1
SYSINIT:28A1 </span><span style="color:gray">getcom</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:28A1                 </span><span style="color:navy">call    </span>organize        ; organize the file
<span style="color:black">SYSINIT:28A4                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:28A7
SYSINIT:28A7 </span>conflp<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:28A7                 </span><span style="color:navy">jb      short </span>endconv
<span style="color:black">SYSINIT:28A9                 </span><span style="color:navy">inc     </span>linecount       ; increase linecount
<span style="color:black">SYSINIT:28AD                 </span><span style="color:navy">mov     </span>multdeviceflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset multdeviceflag.
<span style="color:black">SYSINIT:28B2                 </span><span style="color:navy">mov     </span>setdevmarkflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset setdevmarkflag.
<span style="color:black">SYSINIT:28B7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf ; linefeed?
<span style="color:black">SYSINIT:28B9                 </span><span style="color:navy">jz      short </span><span style="color:gray">blank_line </span>; then ignore this line.
<span style="color:black">SYSINIT:28B9                                         </span>;
<span style="color:black">SYSINIT:28B9                                         </span>; If this is a genuine CONFIG.SYS command,
<span style="color:black">SYSINIT:28B9                                         </span>; then there should be a line number
<span style="color:black">SYSINIT:28B9                                         </span>; immediately following it
<span style="color:black">SYSINIT:28BB                 </span><span style="color:navy">mov     </span>config_cmd<span style="color:navy">, al  </span>; save original command code
<span style="color:black">SYSINIT:28BE                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; ~CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:28C0                 </span><span style="color:navy">cmp     </span>config_multi<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; is this a multi-config config.sys?
<span style="color:black">SYSINIT:28C5                 </span><span style="color:navy">jz      short </span>not_final ; no, line number is not embedded
<span style="color:black">SYSINIT:28C7                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:28C8                 </span><span style="color:navy">call    </span>getchr          ; ignore end-of-image errors
<span style="color:black">SYSINIT:28CB                 </span><span style="color:navy">mov     ah, al          </span>; because if there&#039;s an error
<span style="color:black">SYSINIT:28CD                 </span><span style="color:navy">call    </span>getchr          ; fetching the line number that&#039;s
<span style="color:black">SYSINIT:28D0                 </span><span style="color:navy">xchg    al, ah          </span>; supposed to be there, the next
<span style="color:black">SYSINIT:28D2                 </span><span style="color:navy">mov     </span>linecount<span style="color:navy">, ax   </span>; getchr call will get the same error
<span style="color:black">SYSINIT:28D5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:28D6                 </span><span style="color:navy">cmp     </span>multi_pass_id<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; final pass?
<span style="color:black">SYSINIT:28D6 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR doconf
</span><span style="color:maroon">SYSINIT:28DB                 </span><span style="color:navy">jb      short </span>not_final ; no
<span style="color:maroon">SYSINIT:28DD                 </span><span style="color:navy">test    </span>install_flag<span style="color:navy">, </span><span style="color:green">1 </span><span style="color:olive">; ...
</span><span style="color:maroon">SYSINIT:28DD                                         </span>; have_install_cmd
<span style="color:maroon">SYSINIT:28DD                                         </span>; are there install commands?
<span style="color:maroon">SYSINIT:28E3                 </span><span style="color:navy">jz      short </span>final     ; no install cmds, yes it is
<span style="color:maroon">SYSINIT:28E5                 </span><span style="color:navy">cmp     </span>multi_pass_id<span style="color:navy">, </span><span style="color:#ff8000">3 </span><span style="color:olive">; ...
</span><span style="color:maroon">SYSINIT:28E5                                         </span>; final pass?
<span style="color:maroon">SYSINIT:28EA                 </span><span style="color:navy">jb      short </span>not_final ; no
<span style="color:maroon">SYSINIT:28EC
SYSINIT:28EC </span>final<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:28EC                 </span><span style="color:navy">mov     es:[si], al     </span>; save backward-compatible command code
<span style="color:black">SYSINIT:28EF </span><span style="color:gray">; START OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:28EF
SYSINIT:28EF </span>not_final<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:28EF                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">SYSINIT:28F1                 </span><span style="color:navy">call    </span>getchr          <span style="color:olive">; ...
</span><span style="color:black">SYSINIT:28F4                 </span><span style="color:navy">jnb     short </span><span style="color:gray">tryi
</span><span style="color:black">SYSINIT:28F6                 </span><span style="color:navy">cmp     </span>multi_pass_id<span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:28FB                 </span><span style="color:navy">jnb     short </span>jae_endconv ; it would be &#039;jnb short endconv&#039;
<span style="color:black">SYSINIT:28FB                                         </span>; (E.TAN - 09/07/2023)
<span style="color:black">SYSINIT:28FB                                         </span>; do not show badop again for multi_pass.
<span style="color:black">SYSINIT:28FD                 </span><span style="color:navy">jmp     </span><span style="color:gray">badop
</span><span style="color:black">SYSINIT:2900 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2900
SYSINIT:2900 </span><span style="color:gray">coff</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2900                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2901                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2902                 </span><span style="color:navy">call    </span>newline
<span style="color:black">SYSINIT:2905                 </span><span style="color:navy">jmp     short </span>conflp
<span style="color:black">SYSINIT:2907 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2907
SYSINIT:2907 </span><span style="color:gray">blank_line</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2907                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:290A                 </span><span style="color:navy">jmp     short </span>conflp
<span style="color:black">SYSINIT:290A </span><span style="color:gray">; END OF FUNCTION CHUNK FOR doconf
</span><span style="color:maroon">SYSINIT:290C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:290C                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:290D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:290E </span><span style="color:gray">; START OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:290E
SYSINIT:290E </span><span style="color:gray">tryi</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:290E                 </span><span style="color:navy">cmp     </span>multi_pass_id<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; the initial pass for DOS=HI
<span style="color:black">SYSINIT:2913                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_init_pass
</span><span style="color:black">SYSINIT:2915                 </span><span style="color:navy">jmp     </span><span style="color:gray">multi_try_doshi
</span><span style="color:black">SYSINIT:2918 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2918
SYSINIT:2918 </span><span style="color:gray">not_init_pass</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2918                 </span><span style="color:navy">cmp     </span>multi_pass_id<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; the second pass was for ifs=
<span style="color:black">SYSINIT:291D                 </span><span style="color:navy">jz      short </span><span style="color:gray">multi_pass_coff2 </span>; now it is NOPs
<span style="color:black">SYSINIT:291D                                         </span>;
<span style="color:black">SYSINIT:291D                                         </span>; This pass can be made use of if
<span style="color:black">SYSINIT:291D                                         </span>; we want do some config.sys process
<span style="color:black">SYSINIT:291D                                         </span>; after device drivers are loaded and
<span style="color:black">SYSINIT:291D                                         </span>; before install= commands are processed
<span style="color:black">SYSINIT:291F                 </span><span style="color:navy">cmp     </span>multi_pass_id<span style="color:navy">, </span><span style="color:#ff8000">3 </span>; the third pass for install= ?
<span style="color:black">SYSINIT:2924                 </span><span style="color:navy">jz      short </span><span style="color:gray">multi_try_i
</span><span style="color:black">SYSINIT:2926                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">48h </span><span style="color:gray">; &#039;H&#039;   </span>; CONFIG_DOS
<span style="color:black">SYSINIT:2929                 </span><span style="color:navy">jz      short </span><span style="color:gray">multi_pass_coff2
</span><span style="color:black">SYSINIT:292B                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">49h </span><span style="color:gray">; &#039;I&#039;   </span>; CONFIG_INSTALL ; install= command?
<span style="color:black">SYSINIT:292E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">precheck_installhigh </span>;
<span style="color:black">SYSINIT:292E                                         </span>; the first pass is for normal operation.
<span style="color:black">SYSINIT:2930                 </span><span style="color:navy">or      </span>install_flag<span style="color:navy">, </span><span style="color:green">1 </span>; have_install_cmd ; set the flag
<span style="color:black">SYSINIT:2935
SYSINIT:2935 </span><span style="color:gray">multi_pass_coff2</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2935                 </span><span style="color:navy">jmp     short </span><span style="color:gray">coff      </span>; and handles the next command
<span style="color:black">SYSINIT:2937 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2937
SYSINIT:2937 </span><span style="color:gray">precheck_installhigh</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2937                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">57h </span><span style="color:gray">; &#039;W&#039;   </span>; CONFIG_INSTALLHIGH ; signifier for INSTALLHIGH
<span style="color:black">SYSINIT:293A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryb      </span>; carry on with normal processing
<span style="color:black">SYSINIT:293C                 </span><span style="color:navy">or      </span>install_flag<span style="color:navy">, </span><span style="color:green">1 </span>; have_install_cmd
<span style="color:black">SYSINIT:2941                 </span><span style="color:navy">jmp     short </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2943 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2943
SYSINIT:2943 </span><span style="color:gray">multi_try_i</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2943                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">49h </span><span style="color:gray">; &#039;I&#039;   </span>; CONFIG_INSTALL ; install= command?
<span style="color:black">SYSINIT:2946                 </span><span style="color:navy">jnz     short </span><span style="color:gray">multi_try_n </span>; no, check for installhigh
<span style="color:black">SYSINIT:2948                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:294B                 </span><span style="color:navy">jb      short </span><span style="color:gray">multi_pass_filter </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:294D                 </span><span style="color:navy">call    </span>do_install_exec ; install it.
<span style="color:black">SYSINIT:2950                 </span><span style="color:navy">jmp     short </span><span style="color:gray">coff      </span>; to handle next install= command.
<span style="color:black">SYSINIT:2952 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2952
SYSINIT:2952 </span><span style="color:gray">multi_try_n</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2952                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">57h </span><span style="color:gray">; &#039;W&#039;   </span>; CONFIG_INSTALLHIGH ; installhigh= command?
<span style="color:black">SYSINIT:2955                 </span><span style="color:navy">jnz     short </span><span style="color:gray">multi_pass_filter
</span><span style="color:black">SYSINIT:2957                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:295A                 </span><span style="color:navy">jb      short </span><span style="color:gray">multi_pass_filter </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:295C                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5800h
</span><span style="color:black">SYSINIT:295F                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:295F                                         </span>; AL = function code: get allocation strategy
<span style="color:black">SYSINIT:2961                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">SYSINIT:2963                 </span><span style="color:navy">push    bx              </span>; save for the return
<span style="color:black">SYSINIT:2964                 </span><span style="color:navy">or      bx, </span><span style="color:green">80h         </span>; HIGH_FIRST ; set alloc to HighFirst
<span style="color:black">SYSINIT:2968                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5801h       </span>; (ALLOCOPER&lt;&lt;8)|1
<span style="color:black">SYSINIT:296B                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:296B                                         </span>; AL = function code: set allocation strategy
<span style="color:black">SYSINIT:296D                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5802h
</span><span style="color:black">SYSINIT:2970                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:2970                                         </span>; AL = function code: (DOS 5beta) get UMB link state
<span style="color:black">SYSINIT:2972                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:2974                 </span><span style="color:navy">push    ax              </span>; save for the return
<span style="color:black">SYSINIT:2975                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5803h       </span>; (ALLOCOPER&lt;&lt;8)|3
<span style="color:black">SYSINIT:2978                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1           </span>; link in UMBs
<span style="color:black">SYSINIT:297B                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:297B                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:297D                 </span><span style="color:navy">call    </span>do_install_exec ; install it.
<span style="color:black">SYSINIT:2980                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5803h
</span><span style="color:black">SYSINIT:2983                 </span><span style="color:navy">pop     bx              </span>; recover original link state
<span style="color:black">SYSINIT:2984                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:2984                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:2986                 </span><span style="color:navy">pop     bx              </span>; recover original alloc strategy
<span style="color:black">SYSINIT:2987                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5801h
</span><span style="color:black">SYSINIT:298A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:298A                                         </span>; AL = function code: set allocation strategy
<span style="color:black">SYSINIT:298C                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff            </span>; to handle next install= commands.
<span style="color:black">SYSINIT:298F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:298F
SYSINIT:298F </span><span style="color:gray">multi_pass_filter</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:298F                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">59h </span><span style="color:gray">; &#039;Y&#039;   </span>; CONFIG_COMMENT ; comment?
<span style="color:black">SYSINIT:2992                 </span><span style="color:navy">jz      short </span><span style="color:gray">multi_pass_adjust
</span><span style="color:black">SYSINIT:2994                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; CONFIG_UNKNOWN ; bad command?
<span style="color:black">SYSINIT:2997                 </span><span style="color:navy">jz      short </span><span style="color:gray">multi_pass_adjust
</span><span style="color:black">SYSINIT:2999                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; CONFIG_REM ; rem?
<span style="color:black">SYSINIT:299C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">multi_pass_coff </span>; ignore the rest of the commands.
<span style="color:black">SYSINIT:299E
SYSINIT:299E </span><span style="color:gray">multi_pass_adjust</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:299E                 </span><span style="color:navy">dec     </span>chrptr          ; these commands need to
<span style="color:black">SYSINIT:299E                                         </span>; adjust chrptr,count
<span style="color:black">SYSINIT:29A2                 </span><span style="color:navy">inc     </span>count           ; for newline proc.
<span style="color:black">SYSINIT:29A6
SYSINIT:29A6 </span><span style="color:gray">multi_pass_coff</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29A6                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff            </span>; to handle next install= commands.
<span style="color:black">SYSINIT:29A9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:29A9
SYSINIT:29A9 </span><span style="color:gray">tryb</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29A9                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">42h </span><span style="color:gray">; &#039;B&#039;   </span>; CONFIG_BUFFERS
<span style="color:black">SYSINIT:29AC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryc
</span><span style="color:black">SYSINIT:29AE                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:29AE                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:29B1                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryc
</span><span style="color:black">SYSINIT:29B3                 </span><span style="color:navy">mov     </span>p_buffer_slash_x<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:29B8                 </span><span style="color:navy">mov     di, offset </span>buf_parms
<span style="color:black">SYSINIT:29BB                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:29BD                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:29BF
SYSINIT:29BF </span><span style="color:gray">do7</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29BF                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:29C2                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if7       </span>;
<span style="color:black">SYSINIT:29C2                                         </span>; parse error,
<span style="color:black">SYSINIT:29C2                                         </span>; and show messages and end the search
<span style="color:black">SYSINIT:29C4                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:29C7                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr7
</span><span style="color:black">SYSINIT:29C9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:29C9
SYSINIT:29C9 </span><span style="color:gray">if7</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29C9                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:29CC                 </span><span style="color:navy">jz      short </span><span style="color:gray">en7       </span>; then jmp to $endloop for semantic check
<span style="color:black">SYSINIT:29CE                 </span><span style="color:navy">cmp     </span>result_val_swoff<span style="color:navy">, offset </span>switch_x ; (/X switch)
<span style="color:black">SYSINIT:29CE                                         </span>; [result_val+_$P_Result_Blk.SYNONYM_Ptr]
<span style="color:black">SYSINIT:29D4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if11
</span><span style="color:black">SYSINIT:29D6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en11
</span><span style="color:black">SYSINIT:29D8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:29D8
SYSINIT:29D8 </span><span style="color:gray">if11</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29D8                 </span><span style="color:navy">mov     ax, word ptr </span>rv_dword ; [result_val+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:29DB                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:29DE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if13
</span><span style="color:black">SYSINIT:29E0                 </span><span style="color:navy">mov     </span>p_buffers<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:29E3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en11
</span><span style="color:black">SYSINIT:29E5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:29E5
SYSINIT:29E5 </span><span style="color:gray">if13</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29E5                 </span><span style="color:navy">mov     </span>p_h_buffers<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:29E8
SYSINIT:29E8 </span><span style="color:gray">en11</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29E8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do7
</span><span style="color:black">SYSINIT:29EA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:29EA
SYSINIT:29EA </span><span style="color:gray">en7</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29EA                 </span><span style="color:navy">cmp     </span>p_buffers<span style="color:navy">, </span><span style="color:green">99
</span><span style="color:black">SYSINIT:29EF                 </span><span style="color:navy">jbe     short </span><span style="color:gray">if18
</span><span style="color:black">SYSINIT:29F1                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:29F4                 </span><span style="color:navy">mov     </span>p_h_buffers<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:29FA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr7
</span><span style="color:black">SYSINIT:29FC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:29FC
SYSINIT:29FC </span><span style="color:gray">if18</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:29FC                 </span><span style="color:navy">mov     ax, </span>p_buffers   ; we don&#039;t have any problem.
<span style="color:black">SYSINIT:29FF                 </span><span style="color:navy">mov     </span>buffers<span style="color:navy">, ax     </span>; now,let&#039;s set it really.
<span style="color:black">SYSINIT:2A02                 </span><span style="color:navy">mov     ax, </span>p_h_buffers
<span style="color:black">SYSINIT:2A05                 </span><span style="color:navy">mov     </span>h_buffers<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:2A08                 </span><span style="color:navy">mov     ax, </span>linecount
<span style="color:black">SYSINIT:2A0B                 </span><span style="color:navy">mov     </span>buffer_linenum<span style="color:navy">, ax </span>; save the line number
<span style="color:black">SYSINIT:2A0B                                         </span>; for the future use
<span style="color:black">SYSINIT:2A0E
SYSINIT:2A0E </span><span style="color:gray">sr7</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A0E                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2A11 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A11
SYSINIT:2A11 </span><span style="color:gray">tryc</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A11                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">43h </span><span style="color:gray">; &#039;C&#039;   </span>; CONFIG_BREAK
<span style="color:black">SYSINIT:2A14                 </span><span style="color:navy">jnz     short </span><span style="color:gray">trym
</span><span style="color:black">SYSINIT:2A16                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2A16                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2A19                 </span><span style="color:navy">jb      short </span><span style="color:gray">trym
</span><span style="color:black">SYSINIT:2A1B                 </span><span style="color:navy">mov     di, offset </span>brk_parms
<span style="color:black">SYSINIT:2A1E                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:2A20                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:2A22
SYSINIT:2A22 </span><span style="color:gray">do22</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A22                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:2A25                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if22      </span>;
<span style="color:black">SYSINIT:2A25                                         </span>; parse error
<span style="color:black">SYSINIT:2A27                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:2A2A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr22
</span><span style="color:black">SYSINIT:2A2C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A2C
SYSINIT:2A2C </span><span style="color:gray">if22</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A2C                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:2A2F                 </span><span style="color:navy">jz      short </span><span style="color:gray">en22      </span>; then end the $endloop
<span style="color:black">SYSINIT:2A31                 </span><span style="color:navy">cmp     </span>result_val_itag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; [result_val+_$P_Result_Blk.Item_Tag]
<span style="color:black">SYSINIT:2A36                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if26
</span><span style="color:black">SYSINIT:2A38                 </span><span style="color:navy">mov     </span>p_ctrl_break<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; turn it on
<span style="color:black">SYSINIT:2A3D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en26
</span><span style="color:black">SYSINIT:2A3F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A3F
SYSINIT:2A3F </span><span style="color:gray">if26</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A3F                 </span><span style="color:navy">mov     </span>p_ctrl_break<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; turn it off
<span style="color:black">SYSINIT:2A44
SYSINIT:2A44 </span><span style="color:gray">en26</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A44                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do22      </span>; we actually set the ctrl break
<span style="color:black">SYSINIT:2A46 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A46
SYSINIT:2A46 </span><span style="color:gray">en22</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A46                 </span><span style="color:navy">mov     ah, </span><span style="color:green">33h         </span>; SET_CTRL_C_TRAPPING
<span style="color:black">SYSINIT:2A46                                         </span>; if we don&#039;t have any parse error.
<span style="color:black">SYSINIT:2A48                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:2A4A                 </span><span style="color:navy">mov     dl, </span>p_ctrl_break
<span style="color:black">SYSINIT:2A4E                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - EXTENDED CONTROL-BREAK CHECKING
<span style="color:black">SYSINIT:2A4E                                         </span>; AL = 00h get state / 01h set state / 02h set AND get
<span style="color:black">SYSINIT:2A4E                                         </span>; DL = 00h for OFF or 01h for ON
<span style="color:black">SYSINIT:2A50
SYSINIT:2A50 </span><span style="color:gray">sr22</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A50                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2A53 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A53
SYSINIT:2A53 </span><span style="color:gray">trym</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A53                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039;   </span>; CONFIG_MULTITRACK
<span style="color:black">SYSINIT:2A56                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryu
</span><span style="color:black">SYSINIT:2A58                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2A58                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2A5B                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryu
</span><span style="color:black">SYSINIT:2A5D                 </span><span style="color:navy">mov     di, offset </span>mtrk_parms
<span style="color:black">SYSINIT:2A60                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:2A62                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:2A64
SYSINIT:2A64 </span><span style="color:gray">do31</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A64                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:2A67                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if31      </span>;
<span style="color:black">SYSINIT:2A67                                         </span>; parse_error
<span style="color:black">SYSINIT:2A69                 </span><span style="color:navy">call    </span>badparm_p       ; show message and end the search loop.
<span style="color:black">SYSINIT:2A6C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr31
</span><span style="color:black">SYSINIT:2A6E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A6E
SYSINIT:2A6E </span><span style="color:gray">if31</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A6E                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:2A71                 </span><span style="color:navy">jz      short </span><span style="color:gray">en31
</span><span style="color:black">SYSINIT:2A73                 </span><span style="color:navy">cmp     </span>result_val_itag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; [result_val+_$P_Result_Blk.Item_Tag]
<span style="color:black">SYSINIT:2A78                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if35
</span><span style="color:black">SYSINIT:2A7A                 </span><span style="color:navy">mov     </span>p_mtrk<span style="color:navy">, </span><span style="color:#ff8000">1       </span>; turn it on temporarily.
<span style="color:black">SYSINIT:2A7F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en35
</span><span style="color:black">SYSINIT:2A81 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A81
SYSINIT:2A81 </span><span style="color:gray">if35</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A81                 </span><span style="color:navy">mov     </span>p_mtrk<span style="color:navy">, </span><span style="color:#ff8000">0       </span>; turn it off temporarily.
<span style="color:black">SYSINIT:2A86
SYSINIT:2A86 </span><span style="color:gray">en35</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A86                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do31      </span>; we actually set the multrk_flag here
<span style="color:black">SYSINIT:2A88 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A88
SYSINIT:2A88 </span><span style="color:gray">en31</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A88                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:2A89                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG ; BIOSDATA segment
<span style="color:black">SYSINIT:2A8C                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:2A8E                 </span>assume ds:nothing
<span style="color:black">SYSINIT:2A8E                 </span><span style="color:navy">cmp     cs:</span>p_mtrk<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:2A94                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if39
</span><span style="color:black">SYSINIT:2A96                 </span><span style="color:navy">mov     ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; multrk_off2
<span style="color:black">SYSINIT:2A9C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en39
</span><span style="color:black">SYSINIT:2A9E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2A9E
SYSINIT:2A9E </span><span style="color:gray">if39</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2A9E                 </span><span style="color:navy">mov     ds:</span>multrk_flag<span style="color:navy">, </span><span style="color:#ff8000">80h </span>; multrk_on
<span style="color:black">SYSINIT:2AA4
SYSINIT:2AA4 </span><span style="color:gray">en39</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AA4                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2AA5                 </span>assume ds:nothing
<span style="color:black">SYSINIT:2AA5
SYSINIT:2AA5 </span><span style="color:gray">sr31</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AA5                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2AA8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2AA8
SYSINIT:2AA8 </span><span style="color:gray">multi_try_doshi</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AA8                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">48h </span><span style="color:gray">; &#039;H&#039;   </span>; CONFIG_DOS
<span style="color:black">SYSINIT:2AAB                 </span><span style="color:navy">jz      short </span><span style="color:gray">it_is_h
</span><span style="color:black">SYSINIT:2AAD
SYSINIT:2AAD </span><span style="color:gray">skip_it</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AAD                 </span><span style="color:navy">jmp     </span><span style="color:gray">multi_pass_filter
</span><span style="color:black">SYSINIT:2AB0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2AB0
SYSINIT:2AB0 </span><span style="color:gray">it_is_h</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AB0                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2AB0                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2AB3                 </span><span style="color:navy">jb      short </span><span style="color:gray">skip_it
</span><span style="color:black">SYSINIT:2AB5                 </span><span style="color:navy">mov     di, offset </span>dos_parms
<span style="color:black">SYSINIT:2AB8                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:2ABA                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:2ABC
SYSINIT:2ABC </span><span style="color:gray">h_do_parse</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2ABC                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:2ABF                 </span><span style="color:navy">jnb     short </span><span style="color:gray">h_parse_ok
</span><span style="color:black">SYSINIT:2AC1
SYSINIT:2AC1 </span>h_badparm<span style="color:navy">:                              </span>; parse error
<span style="color:black">SYSINIT:2AC1                 </span><span style="color:navy">call    </span>badparm_p       ; show message and end the search loop.
<span style="color:black">SYSINIT:2AC4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">h_end
</span><span style="color:black">SYSINIT:2AC6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2AC6
SYSINIT:2AC6 </span><span style="color:gray">h_parse_ok</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AC6                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:2AC9                 </span><span style="color:navy">jz      short </span><span style="color:gray">h_end     </span>; then end the $endloop
<span style="color:black">SYSINIT:2ACB                 </span><span style="color:navy">call    </span>ProcDOS
<span style="color:black">SYSINIT:2ACE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">h_do_parse
</span><span style="color:black">SYSINIT:2AD0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2AD0
SYSINIT:2AD0 </span><span style="color:gray">h_end</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AD0                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2AD3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2AD3
SYSINIT:2AD3 </span><span style="color:gray">tryu</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AD3                 </span><span style="color:navy">cmp     ah, &#039;</span><span style="color:green">U&#039;         </span>; CONFIG_DEVICEHIGH
<span style="color:black">SYSINIT:2AD6                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryu_0
</span><span style="color:black">SYSINIT:2AD8                 </span><span style="color:navy">jmp     </span><span style="color:gray">tryd
</span><span style="color:black">SYSINIT:2ADB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2ADB
SYSINIT:2ADB </span><span style="color:gray">tryu_0</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2ADB                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2ADB                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2ADE                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryd
</span><span style="color:black">SYSINIT:2AE0                 </span><span style="color:navy">call    </span>InitVar
<span style="color:black">SYSINIT:2AE3                 </span><span style="color:navy">call    </span>ParseSize       ; process the size= option
<span style="color:black">SYSINIT:2AE6                 </span><span style="color:navy">jnb     short </span><span style="color:gray">tryu_1    </span>;
<span style="color:black">SYSINIT:2AE6                                         </span>; stash it there in case of an error
<span style="color:black">SYSINIT:2AE8                 </span><span style="color:navy">mov     word ptr cs:</span>badparm_ptr<span style="color:navy">, si
</span><span style="color:black">SYSINIT:2AED                 </span><span style="color:navy">mov     word ptr cs:</span>badparm_ptr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:2AF2                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:2AF5                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2AF8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2AF8
SYSINIT:2AF8 </span><span style="color:gray">tryu_1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2AF8                 </span><span style="color:navy">mov     ax, cs:</span>DevSizeOption
<span style="color:black">SYSINIT:2AFC                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">SYSINIT:2AFE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryu_2
</span><span style="color:black">SYSINIT:2B00                 </span><span style="color:navy">call    </span>ParseVar
<span style="color:black">SYSINIT:2B03                 </span><span style="color:navy">jnb     short </span><span style="color:gray">tryu_2
</span><span style="color:black">SYSINIT:2B05                 </span><span style="color:navy">mov     word ptr cs:</span>badparm_ptr<span style="color:navy">, si </span>;
<span style="color:black">SYSINIT:2B05                                         </span>; If ParseVar up there failed, then
<span style="color:black">SYSINIT:2B05                                         </span>; ES:SI points to its problem area..
<span style="color:black">SYSINIT:2B0A                 </span><span style="color:navy">mov     word ptr cs:</span>badparm_ptr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:2B0F                 </span><span style="color:navy">call    </span>badparm_p       ; so all we have to do is choke and
<span style="color:black">SYSINIT:2B0F                                         </span>; die, rather verbosely.
<span style="color:black">SYSINIT:2B12                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2B15 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2B15
SYSINIT:2B15 </span><span style="color:gray">tryu_2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B15                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:2B16                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:2B17
SYSINIT:2B17 </span><span style="color:gray">tryu_3</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B17                 </span><span style="color:navy">mov     al, es:[si]
</span><span style="color:black">SYSINIT:2B1A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:2B1C                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryu_4    </span>; (_tryu_4) (*)
<span style="color:black">SYSINIT:2B1E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:2B20                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryu_4    </span>; (*) this would be &#039;jz short tryu_5&#039;
<span style="color:black">SYSINIT:2B20                                         </span>; Erdogan Tan - 10/07/2023
<span style="color:black">SYSINIT:2B22                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:2B25                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryu_4    </span>; (*) al &lt;&gt; cr
<span style="color:black">SYSINIT:2B25                                         </span>;     this would be &#039;jz short tryu_5&#039;
<span style="color:black">SYSINIT:2B27                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:2B28                 </span><span style="color:navy">jmp     short </span><span style="color:gray">tryu_3
</span><span style="color:black">SYSINIT:2B2A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2B2A
SYSINIT:2B2A </span><span style="color:gray">tryu_4</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B2A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; (*) cr ? (this 2nd check woul not be
<span style="color:black">SYSINIT:2B2A                                         </span>; needed because al value would be 0Dh here)
<span style="color:black">SYSINIT:2B2C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryu_5
</span><span style="color:black">SYSINIT:2B2E
SYSINIT:2B2E </span>_tryu_4<span style="color:navy">:                                </span>;
<span style="color:black">SYSINIT:2B2E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; blank instead of cr
<span style="color:black">SYSINIT:2B30
SYSINIT:2B30 </span><span style="color:gray">tryu_5</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B30                 </span><span style="color:navy">mov     cs:</span>DevSavedDelim<span style="color:navy">, al </span>; Save the delimiter
<span style="color:black">SYSINIT:2B30                                         </span>; before replacing it with null
<span style="color:black">SYSINIT:2B34                 </span><span style="color:navy">mov     byte ptr es:[si], </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:2B38                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2B39                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2B3A                 </span><span style="color:navy">call    </span>UmbTest         ; See if UMBs are around...
<span style="color:black">SYSINIT:2B3D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">NrmTst    </span>; yep. So do that normal thang.
<span style="color:black">SYSINIT:2B3F                 </span><span style="color:navy">mov     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; nope... so load low.
<span style="color:black">SYSINIT:2B45                 </span><span style="color:navy">jmp     short </span><span style="color:gray">LoadDevice
</span><span style="color:black">SYSINIT:2B47 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2B47
SYSINIT:2B47 </span><span style="color:gray">NrmTst</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B47                 </span><span style="color:navy">mov     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:2B4D                 </span><span style="color:navy">cmp     cs:</span>DevUMB<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; do we support UMBs ?
<span style="color:black">SYSINIT:2B53                 </span><span style="color:navy">jz      short </span><span style="color:gray">LoadDevice </span>; no, we don&#039;t
<span style="color:black">SYSINIT:2B55                 </span><span style="color:navy">mov     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:2B5B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">LoadDevice
</span><span style="color:black">SYSINIT:2B5D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2B5D
SYSINIT:2B5D </span><span style="color:gray">tryd</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B5D                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">44h </span><span style="color:gray">; &#039;D&#039;   </span>; CONFIG_DEVICE
<span style="color:black">SYSINIT:2B60                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotd
</span><span style="color:black">SYSINIT:2B62
SYSINIT:2B62 </span><span style="color:gray">skip_it2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B62                 </span><span style="color:navy">jmp     </span><span style="color:gray">tryq
</span><span style="color:black">SYSINIT:2B65 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2B65
SYSINIT:2B65 </span><span style="color:gray">gotd</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B65                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2B65                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2B68                 </span><span style="color:navy">jb      short </span><span style="color:gray">skip_it2
</span><span style="color:black">SYSINIT:2B6A                 </span><span style="color:navy">mov     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; not to be loaded in UMB
<span style="color:black">SYSINIT:2B70                 </span><span style="color:navy">mov     cs:</span>DevSizeOption<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:2B77                 </span><span style="color:navy">mov     cs:</span>DevSavedDelim<span style="color:navy">, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039; </span>; In case of DEVICE=
<span style="color:black">SYSINIT:2B77                                         </span>; the null has to be replaced with a &#039; &#039;
<span style="color:black">SYSINIT:2B7D
SYSINIT:2B7D </span><span style="color:gray">LoadDevice</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2B7D                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2B7E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2B7F                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:2B7F                 </span><span style="color:navy">mov     word ptr </span>bpb_addr<span style="color:navy">, si </span>;
<span style="color:black">SYSINIT:2B7F                                         </span>; pass the command line to the device
<span style="color:black">SYSINIT:2B83                 </span><span style="color:navy">mov     word ptr </span>bpb_addr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:2B87                 </span><span style="color:navy">mov     </span>DevCmdLine<span style="color:navy">, si  </span>; save it for ourself
<span style="color:black">SYSINIT:2B8B                 </span><span style="color:navy">mov     </span>DevCmdLine<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:2B8F                 </span><span style="color:navy">mov     </span>drivers_units<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; clear total block units for driver
<span style="color:black">SYSINIT:2B94                 </span><span style="color:navy">call    </span>round
<span style="color:black">SYSINIT:2B97                 </span><span style="color:navy">call    </span>SizeDevice
<span style="color:black">SYSINIT:2B9A                 </span><span style="color:navy">jb      short </span><span style="color:gray">BadFile
</span><span style="color:black">SYSINIT:2B9C                 </span><span style="color:navy">mov     </span>ConvLoad<span style="color:navy">, </span><span style="color:#ff8000">1     </span>; Doesn&#039;t matter if DeviceHi==0
<span style="color:black">SYSINIT:2BA1                 </span><span style="color:navy">mov     al, </span>DeviceHi    ; If not using upper memory,
<span style="color:black">SYSINIT:2BA1                                         </span>; (&#039;mov al, [DeviceHi]&#039; is not needed here
<span style="color:black">SYSINIT:2BA1                                         </span>;  because al value is not used after here)
<span style="color:black">SYSINIT:2BA4                 </span><span style="color:navy">or      </span>DeviceHi<span style="color:navy">, </span><span style="color:green">0     </span>; (or al, al) - Erdogan Tan - 10/07/2023
<span style="color:black">SYSINIT:2BA9                 </span><span style="color:navy">jz      short </span><span style="color:gray">DevConvLoad </span>; Skip all this and go on
<span style="color:black">SYSINIT:2BA9                                         </span>; to the actual load.
<span style="color:black">SYSINIT:2BAB
SYSINIT:2BAB </span><span style="color:navy">loc_7EDB:                               </span>; (&#039;mov al, [UmbLoad]&#039; would be better here)
<span style="color:black">SYSINIT:2BAB                 </span><span style="color:navy">call    </span>GetLoadUMB
<span style="color:black">SYSINIT:2BAE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; -1 ; If umb0 not specified, it&#039;s old style
<span style="color:black">SYSINIT:2BB0                 </span><span style="color:navy">jz      short </span><span style="color:gray">DevConvLoad </span>; so load high even if SIZE= is smaller
<span style="color:black">SYSINIT:2BB2                 </span><span style="color:navy">dec     </span>ConvLoad        ; 0 ; They specified /L, so use new loader
<span style="color:black">SYSINIT:2BB6                 </span><span style="color:navy">call    </span>GetLoadSize     ; Returns size of first UMB specified
<span style="color:black">SYSINIT:2BB9                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">SYSINIT:2BBB                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryd_1    </span>; If size is not specified..
<span style="color:black">SYSINIT:2BBD                 </span><span style="color:navy">cmp     ax, </span>DevSize     ; /L:...,Size &lt; DevSize?
<span style="color:black">SYSINIT:2BC1                 </span><span style="color:navy">jge     short </span><span style="color:gray">DevConvLoad
</span><span style="color:black">SYSINIT:2BC3
SYSINIT:2BC3 </span><span style="color:gray">tryd_1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2BC3                 </span><span style="color:navy">mov     ax, </span>DevSize     ; Size &lt; DevSize, so write DevSize as
<span style="color:black">SYSINIT:2BC6                 </span><span style="color:navy">call    </span>StoLoadSize     ; minsize for load UMB.
<span style="color:black">SYSINIT:2BC9
SYSINIT:2BC9 </span><span style="color:gray">DevConvLoad</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2BC9                 </span><span style="color:navy">call    </span>InitDevLoad
<span style="color:black">SYSINIT:2BCC                 </span><span style="color:navy">mov     ax, </span>DevLoadAddr
<span style="color:black">SYSINIT:2BCF                 </span><span style="color:navy">add     ax, </span>DevSize
<span style="color:black">SYSINIT:2BD3                 </span><span style="color:navy">jb      short </span><span style="color:gray">NoMem
</span><span style="color:black">SYSINIT:2BD5                 </span><span style="color:navy">cmp     </span>DevLoadEnd<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:2BD9                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LoadDev
</span><span style="color:black">SYSINIT:2BDB
SYSINIT:2BDB </span><span style="color:gray">NoMem</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2BDB                 </span><span style="color:navy">jmp     </span>mem_err
<span style="color:black">SYSINIT:2BDE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2BDE
SYSINIT:2BDE </span><span style="color:gray">BadFile</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2BDE                 </span><span style="color:navy">call    </span>RetFromUM       ; Does nothing if didn&#039;t call HideUMBs
<span style="color:black">SYSINIT:2BE1                 </span><span style="color:navy">cmp     byte ptr es:[si], </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039; </span>; blank/space
<span style="color:black">SYSINIT:2BE5                 </span><span style="color:navy">jnb     short </span><span style="color:gray">tryd_2
</span><span style="color:black">SYSINIT:2BE7                 </span><span style="color:navy">jmp     </span><span style="color:gray">badop
</span><span style="color:black">SYSINIT:2BEA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2BEA
SYSINIT:2BEA </span><span style="color:gray">tryd_2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2BEA                 </span><span style="color:navy">call    </span>badload
<span style="color:black">SYSINIT:2BED                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2BF0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2BF0
SYSINIT:2BF0 </span><span style="color:gray">LoadDev</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2BF0                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:2BF1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2BF2                 </span>assume ds:nothing
<span style="color:black">SYSINIT:2BF2                 </span><span style="color:navy">mov     dx, si          </span>; ds:dx points to file name
<span style="color:black">SYSINIT:2BF4                 </span><span style="color:navy">call    </span>ExecDev         ; load device driver using exec call
<span style="color:black">SYSINIT:2BF7                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:2BF8                 </span><span style="color:navy">pop     es              </span>; es:si back to config.sys
<span style="color:black">SYSINIT:2BF9                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2BFA                 </span><span style="color:navy">pop     ds              </span>; ds back to sysinit
<span style="color:black">SYSINIT:2BFB                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:2BFB                 </span><span style="color:navy">jb      short </span><span style="color:gray">BadFile
</span><span style="color:black">SYSINIT:2BFD
SYSINIT:2BFD </span><span style="color:gray">goodld</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2BFD                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:2BFE                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:2BFF                 </span><span style="color:navy">call    </span>RemoveNull
<span style="color:black">SYSINIT:2C02                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:2C03                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:2C04                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2C05                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2C06                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:2C06                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:2C07                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:2C08                 </span><span style="color:navy">lds     si, cs:</span>DevEntry
<span style="color:black">SYSINIT:2C0D                 </span>assume ds:nothing
<span style="color:black">SYSINIT:2C0D                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [si+SYSDEV.ATT],DEVTYP
<span style="color:black">SYSINIT:2C0D                                         </span>; block device driver?
<span style="color:black">SYSINIT:2C12                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_device_com_cont </span>; no.
<span style="color:black">SYSINIT:2C14                 </span><span style="color:navy">lds     si, cs:</span>DOSINFO  ; ds:si -&gt; sys_var
<span style="color:black">SYSINIT:2C19                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">20h</span><span style="color:navy">], </span><span style="color:green">26 </span>; [si+SYSI_NUMIO]
<span style="color:black">SYSINIT:2C19                                         </span>; no more than 26 drive number
<span style="color:black">SYSINIT:2C1D                 </span><span style="color:navy">jb      short </span><span style="color:gray">got_device_com_cont
</span><span style="color:black">SYSINIT:2C1F                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2C20                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2C21                 </span><span style="color:navy">pop     si              </span>; clear the stack
<span style="color:black">SYSINIT:2C22                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2C23                 </span>assume es:nothing
<span style="color:black">SYSINIT:2C23                 </span><span style="color:navy">call    </span>RetFromUM       ; Do this before we leave
<span style="color:black">SYSINIT:2C26                 </span><span style="color:navy">jmp     </span><span style="color:gray">badnumblock
</span><span style="color:black">SYSINIT:2C29 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2C29
SYSINIT:2C29 </span><span style="color:gray">got_device_com_cont</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2C29                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2C2A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2C2B                 </span><span style="color:navy">call    </span>LieInt12Mem
<span style="color:black">SYSINIT:2C2E                 </span><span style="color:navy">call    </span>UpdatePDB       ; update the PSP:2 value
<span style="color:black">SYSINIT:2C31                 </span><span style="color:navy">cmp     cs:</span>multdeviceflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Pass limit only for
<span style="color:black">SYSINIT:2C31                                         </span>; the 1st device driver in the file
<span style="color:black">SYSINIT:2C37                 </span><span style="color:navy">jnz     short </span><span style="color:gray">skip_pass_limit
</span><span style="color:black">SYSINIT:2C39                 </span><span style="color:navy">mov     cs:</span>break_addr<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; pass the limit to the DD
<span style="color:black">SYSINIT:2C40                 </span><span style="color:navy">mov     bx, cs:</span>DevLoadEnd
<span style="color:black">SYSINIT:2C45                 </span><span style="color:navy">mov     cs:</span>break_addr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, bx
</span><span style="color:black">SYSINIT:2C4A
SYSINIT:2C4A </span><span style="color:gray">skip_pass_limit</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2C4A                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:2C4B                 </span><span style="color:navy">lds     bx, cs:</span>DOSINFO  ; ds:bx -&gt; sys_var
<span style="color:black">SYSINIT:2C50                 </span><span style="color:navy">mov     al, cs:</span>drivenumber ; temporarily use this next drv value
<span style="color:black">SYSINIT:2C54                 </span><span style="color:navy">mov     cs:</span>devdrivenum<span style="color:navy">, al </span>; pass drive number in packet to driver
<span style="color:black">SYSINIT:2C58                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">SYSINIT:2C5A                 </span><span style="color:navy">xchg    ax, [bx+</span><span style="color:#ff8000">20h</span><span style="color:navy">]    </span>; [bx+SYSI_NUMIO]
<span style="color:black">SYSINIT:2C5A                                         </span>; swap with existing values
<span style="color:black">SYSINIT:2C5D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2C5E                 </span><span style="color:navy">push    ax              </span>; save real sysi_numio/ncds in ax
<span style="color:black">SYSINIT:2C5F                 </span><span style="color:navy">mov     word ptr cs:</span>configmsgflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; disable (reset msg option)
<span style="color:black">SYSINIT:2C5F                                         </span>; &quot;error in config.sys line #&quot; msg
<span style="color:black">SYSINIT:2C5F                                         </span>; (before loading -next- device driver)
<span style="color:black">SYSINIT:2C66                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">6           </span>; SYSDEV.STRAT
<span style="color:black">SYSINIT:2C69                 </span><span style="color:navy">call    </span>calldev         ; calldev (sdevstrat);
<span style="color:black">SYSINIT:2C6C                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">8           </span>; SYSDEV.INT
<span style="color:black">SYSINIT:2C6F                 </span><span style="color:navy">call    </span>calldev         ; calldev (sdevint);
<span style="color:black">SYSINIT:2C72                 </span><span style="color:navy">pop     ax              </span>; get real sysi_numio value
<span style="color:black">SYSINIT:2C73                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:2C74                 </span><span style="color:navy">lds     bx, cs:</span>DOSINFO  ; ds:bx -&gt; sys_var
<span style="color:black">SYSINIT:2C79                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">20h</span><span style="color:navy">], ax    </span>; [bx+SYSI_NUMIO]
<span style="color:black">SYSINIT:2C79                                         </span>; restore previous/real value
<span style="color:black">SYSINIT:2C7C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2C7D                 </span><span style="color:navy">call    </span>TrueInt12Mem
<span style="color:black">SYSINIT:2C80                 </span><span style="color:navy">mov     ax, cs:</span>break_addr ; move break addr from the req packet
<span style="color:black">SYSINIT:2C84                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:2C88                 </span><span style="color:navy">mov     ax, cs:</span>break_addr<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">SYSINIT:2C8C                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:2C90                 </span><span style="color:navy">call    </span>RetFromUM       ; There we go... all done.
<span style="color:black">SYSINIT:2C93                 </span><span style="color:navy">cmp     cs:</span>DevUMB<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:2C99                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryd_3
</span><span style="color:black">SYSINIT:2C9B                 </span><span style="color:navy">call    </span>AllocUMB
<span style="color:black">SYSINIT:2C9E
SYSINIT:2C9E </span><span style="color:gray">tryd_3</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2C9E                 </span><span style="color:navy">cmp     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">SYSINIT:2CA4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryd_4
</span><span style="color:black">SYSINIT:2CA6                 </span><span style="color:navy">call    </span>TryToMovDOSHi   ; move DOS into HMA if requsted
<span style="color:black">SYSINIT:2CA9
SYSINIT:2CA9 </span><span style="color:gray">tryd_4</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2CA9                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2CAA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2CAB                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">0 </span>; *p = 0;
<span style="color:black">SYSINIT:2CAE                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2CAF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2CB0                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:2CB0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">was_device_com
</span><span style="color:black">SYSINIT:2CB2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2CB2
SYSINIT:2CB2 </span><span style="color:gray">badnumblock</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2CB2                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2CB3                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2CB4                 </span><span style="color:navy">mov     dx, offset </span>badblock <span style="color:gray">; &quot;\r\nToo many block devices\r\n$&quot;
</span><span style="color:black">SYSINIT:2CB7                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:2CBA
SYSINIT:2CBA </span><span style="color:gray">erase_dev_do</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2CBA                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2CBB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2CBC                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2CBD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2CBE                 </span><span style="color:navy">cmp     word ptr cs:</span>configmsgflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; is error_line msg disabled ?
<span style="color:black">SYSINIT:2CC4                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_error_line_msg </span>; yes
<span style="color:black">SYSINIT:2CC6                 </span><span style="color:navy">call    </span>error_line      ; show &quot;error in config.sys ...&quot; message.
<span style="color:black">SYSINIT:2CC9                 </span><span style="color:navy">mov     word ptr cs:</span>configmsgflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; set the default value again.
<span style="color:black">SYSINIT:2CD0
SYSINIT:2CD0 </span><span style="color:gray">no_error_line_msg</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2CD0                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2CD3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2CD3
SYSINIT:2CD3 </span><span style="color:gray">was_device_com</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2CD3                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">SYSINIT:2CD7                 </span><span style="color:navy">cmp     ax, cs:</span>DevLoadEnd
<span style="color:black">SYSINIT:2CDC                 </span><span style="color:navy">jbe     short </span><span style="color:gray">breakok
</span><span style="color:black">SYSINIT:2CDE                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2CDF                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2CE0                 </span><span style="color:navy">jmp     </span><span style="color:gray">BadFile
</span><span style="color:black">SYSINIT:2CE3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2CE3
SYSINIT:2CE3 </span><span style="color:gray">breakok</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2CE3                 </span><span style="color:navy">lds     dx, cs:</span>DevEntry ; set ds:dx to header
<span style="color:black">SYSINIT:2CE8                 </span>assume ds:nothing
<span style="color:black">SYSINIT:2CE8                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">SYSINIT:2CEA                 </span><span style="color:navy">les     di, cs:</span>DOSINFO  ; es:di point to dos info
<span style="color:black">SYSINIT:2CEF                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [si+SYSDEV.ATT] ; get attributes
<span style="color:black">SYSINIT:2CF2                 </span><span style="color:navy">test    ax, </span><span style="color:green">8000h       </span>; DEVTYP ; test if block dev
<span style="color:black">SYSINIT:2CF5                 </span><span style="color:navy">jz      short </span><span style="color:gray">isblock
</span><span style="color:black">SYSINIT:2CF7                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:2CFD                 </span><span style="color:navy">call    </span>DevSetBreak     ; go ahead and alloc mem for device
<span style="color:black">SYSINIT:2D00
SYSINIT:2D00 </span><span style="color:gray">jc_edd</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D00                 </span><span style="color:navy">jb      short </span><span style="color:gray">erase_dev_do </span>; device driver&#039;s init routine failed.
<span style="color:black">SYSINIT:2D02                 </span><span style="color:navy">test    ax, </span><span style="color:green">1           </span>; ISCIN ; is it a console in?
<span style="color:black">SYSINIT:2D05                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryclk
</span><span style="color:black">SYSINIT:2D07                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], dx </span>; [es:di+SYSI_CON]
<span style="color:black">SYSINIT:2D0B                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], ds </span>; [es:di+SYSI_CON+2]
<span style="color:black">SYSINIT:2D0F
SYSINIT:2D0F </span><span style="color:gray">tryclk</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D0F                 </span><span style="color:navy">test    ax, </span><span style="color:green">8           </span>; ISCLOCK ; is it a clock device?
<span style="color:black">SYSINIT:2D12                 </span><span style="color:navy">jz      short </span><span style="color:gray">golink
</span><span style="color:black">SYSINIT:2D14                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">], dx   </span>; [es:di+SYSI_CLOCK]
<span style="color:black">SYSINIT:2D18                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], ds </span>; [es:di+SYSI_CLOCK+2]
<span style="color:black">SYSINIT:2D1C
SYSINIT:2D1C </span><span style="color:gray">golink</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D1C                 </span><span style="color:navy">jmp     </span><span style="color:gray">linkit
</span><span style="color:black">SYSINIT:2D1F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2D1F
SYSINIT:2D1F </span><span style="color:gray">isblock</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D1F                 </span><span style="color:navy">mov     al, cs:</span>unitcount
<span style="color:black">SYSINIT:2D23                 </span><span style="color:navy">or      al, al          </span>; if no units found, erase the device
<span style="color:black">SYSINIT:2D25                 </span><span style="color:navy">jz      short </span><span style="color:gray">erase_dev_do
</span><span style="color:black">SYSINIT:2D27                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], al    </span>; [si+SYSDEV.NAME]
<span style="color:black">SYSINIT:2D27                                         </span>; number of units in name field
<span style="color:black">SYSINIT:2D2A                 </span><span style="color:navy">add     cs:</span>drivers_units<span style="color:navy">, al </span>; keep total for all drivers in file
<span style="color:black">SYSINIT:2D2F
SYSINIT:2D2F </span>perdrv<span style="color:navy">:                                 </span>; warning no device &gt; 127 units
<span style="color:black">SYSINIT:2D2F                 </span><span style="color:navy">cbw
</span><span style="color:black">SYSINIT:2D30                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:2D32                 </span><span style="color:navy">mov     dh, ah
</span><span style="color:black">SYSINIT:2D34                 </span><span style="color:navy">mov     dl, es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">] </span>; [es:di+SYSI_NUMIO]
<span style="color:black">SYSINIT:2D34                                         </span>; get number of devices
<span style="color:black">SYSINIT:2D38                 </span><span style="color:navy">mov     ah, dl
</span><span style="color:black">SYSINIT:2D3A                 </span><span style="color:navy">add     ah, al          </span>; check for too many devices
<span style="color:black">SYSINIT:2D3C                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">26          </span>; &#039;A&#039; - &#039;Z&#039; is 26 devices
<span style="color:black">SYSINIT:2D3F                 </span><span style="color:navy">jbe     short </span><span style="color:gray">ok_block
</span><span style="color:black">SYSINIT:2D41                 </span><span style="color:navy">jmp     </span><span style="color:gray">badnumblock
</span><span style="color:black">SYSINIT:2D44 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2D44
SYSINIT:2D44 </span><span style="color:gray">ok_block</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D44                 </span><span style="color:navy">or      cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:2D4A                 </span><span style="color:navy">call    </span>DevSetBreak     ; alloc the device
<span style="color:black">SYSINIT:2D4D                 </span><span style="color:navy">jb      short </span><span style="color:gray">jc_edd
</span><span style="color:black">SYSINIT:2D4F                 </span><span style="color:navy">add     es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">], al </span>; [es:di+SYSI_NUMIO]
<span style="color:black">SYSINIT:2D4F                                         </span>; update the amount
<span style="color:black">SYSINIT:2D53                 </span><span style="color:navy">add     cs:</span>drivenumber<span style="color:navy">, al </span>; remember amount for next device
<span style="color:black">SYSINIT:2D58                 </span><span style="color:navy">lds     bx, cs:</span>bpb_addr ; point to bpb array
<span style="color:black">SYSINIT:2D5D
SYSINIT:2D5D </span><span style="color:gray">perunit</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D5D                 </span><span style="color:navy">les     bp, cs:</span>DOSINFO
<span style="color:black">SYSINIT:2D62                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+SYSI_DPB] ; get first dpb
<span style="color:black">SYSINIT:2D66
SYSINIT:2D66 </span><span style="color:gray">scandpb</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D66                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [es:bp+DPB.NEXT_DPB],-1
<span style="color:black">SYSINIT:2D6B                 </span><span style="color:navy">jz      short </span><span style="color:gray">foundpb
</span><span style="color:black">SYSINIT:2D6D                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; [es:bp+DPB.NEXT_DPB] ; [es:bp+25]
<span style="color:black">SYSINIT:2D71                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scandpb
</span><span style="color:black">SYSINIT:2D73 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2D73
SYSINIT:2D73 </span><span style="color:gray">foundpb</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2D73                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr
<span style="color:black">SYSINIT:2D77                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">], ax </span>; [es:bp+DPB.NEXT_DPB]
<span style="color:black">SYSINIT:2D7B                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">SYSINIT:2D7F                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], ax </span>; [es:bp+DPB.NEXT_DPB+2]
<span style="color:black">SYSINIT:2D83                 </span><span style="color:navy">les     bp, cs:</span>DevBrkAddr
<span style="color:black">SYSINIT:2D88                 </span><span style="color:navy">add     word ptr cs:</span>DevBrkAddr<span style="color:navy">, </span><span style="color:green">61 </span>; DPBSIZ = 61
<span style="color:black">SYSINIT:2D88                                         </span>; (33 in MSDOS 6.21 IO.SYS)
<span style="color:black">SYSINIT:2D8E                 </span><span style="color:navy">call    </span>RoundBreakAddr
<span style="color:black">SYSINIT:2D91                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [es:bp+DPB.NEXT_DPB],-1
<span style="color:black">SYSINIT:2D97                 </span><span style="color:navy">mov     byte ptr es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; [es:bp+DPB.FIRST_ACCESS],-1 ; byte
<span style="color:black">SYSINIT:2D9C                 </span><span style="color:navy">mov     si, [bx]        </span>; ds:si points to bpb
<span style="color:black">SYSINIT:2D9E                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:2D9F                 </span><span style="color:navy">inc     bx              </span>; point to next bpb
<span style="color:black">SYSINIT:2DA0                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], dx   </span>; [es:bp+DPB.DRIVE]
<span style="color:black">SYSINIT:2DA4                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:2DA5                 </span><span style="color:navy">push    cx              </span>; initialize FAT32 extended DPB parameters/fields
<span style="color:black">SYSINIT:2DA6                 </span><span style="color:navy">mov     dx, </span><span style="color:green">4152h       </span>; &#039;AR&#039; signature for FAT32 extended DPB
<span style="color:black">SYSINIT:2DA9                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">SYSINIT:2DAB                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], cx </span>; DPB.NEXT_FREE ; last allocated cluster #
<span style="color:black">SYSINIT:2DAF                 </span><span style="color:navy">cmp     [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], cx    </span>; BPB.fatsecs16 ; [si+A_BPB.BPB_SECTORSPERFAT]
<span style="color:black">SYSINIT:2DB2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdpb    </span>; FAT DPB (33 bytes)   -jnz-
<span style="color:black">SYSINIT:2DB2                                         </span>; FAT32 DPB (61 bytes) -jz-
<span style="color:black">SYSINIT:2DB4                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">], cx </span>; DPB.RESERVED = 0
<span style="color:black">SYSINIT:2DB8                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], cx </span>; DPB.RESERVED+2 = 0
<span style="color:black">SYSINIT:2DBC                 </span><span style="color:navy">dec     cx              </span>; 0FFFFh ; -1
<span style="color:black">SYSINIT:2DBD                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], cx </span>; DPB.FREE_CNT (-1 = unknown)
<span style="color:black">SYSINIT:2DC1                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], cx </span>; DPB.FREE_CNT+2 (-1 = unknown)
<span style="color:black">SYSINIT:2DC5                 </span><span style="color:navy">mov     cx, </span><span style="color:green">4558h       </span>; &#039;EX&#039; signature for FAT32 extended DPB
<span style="color:black">SYSINIT:2DC8
SYSINIT:2DC8 </span><span style="color:gray">setdpb</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2DC8                 </span><span style="color:navy">mov     ah, </span><span style="color:green">53h         </span>; SETDPB ; hidden system call
<span style="color:black">SYSINIT:2DCA                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - TRANSLATE BIOS PARAMETER BLOCK
<span style="color:black">SYSINIT:2DCA                                         </span>; DS:SI -&gt; BPB (BIOS Parameter Block)
<span style="color:black">SYSINIT:2DCA                                         </span>; ES:BP -&gt; buffer for DOS Drive Parameter Block
<span style="color:black">SYSINIT:2DCA                                         </span>; (if CX=4558h &amp; DX=4152h, FAT32 Extd/PCDOS7.1 DPB will be set)
<span style="color:black">SYSINIT:2DCA                                         </span>; ((if DX=4152h but CX&lt;&gt;4558h, FAT Extd/PCDOS7.1 DPB will be set))
<span style="color:black">SYSINIT:2DCC                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:2DCD                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:2DCE                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [es:bp+DPB.SECTOR_SIZE]
<span style="color:black">SYSINIT:2DD2                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:2DD3                 </span><span style="color:navy">les     di, cs:</span>DOSINFO  ; es:di point to dos info
<span style="color:black">SYSINIT:2DD8                 </span><span style="color:navy">cmp     ax, es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; [es:di+SYSI_MAXSEC]
<span style="color:black">SYSINIT:2DDC                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2DDD                 </span><span style="color:navy">jbe     short </span><span style="color:gray">iblk_1
</span><span style="color:black">SYSINIT:2DDF                 </span><span style="color:navy">jmp     </span><span style="color:gray">bad_bpb_size_sector
</span><span style="color:black">SYSINIT:2DE2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2DE2
SYSINIT:2DE2 </span><span style="color:gray">iblk_1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2DE2                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:2DE3                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:2DE4                 </span><span style="color:navy">lds     dx, cs:</span>DevEntry
<span style="color:black">SYSINIT:2DE9                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">], dx </span>; [es:bp+DPB.DRIVER_ADDR]
<span style="color:black">SYSINIT:2DED                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ds </span>; [es:bp+DPB.DRIVER_ADDR+2]
<span style="color:black">SYSINIT:2DF1                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:2DF2                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2DF3                 </span><span style="color:navy">inc     dx
</span><span style="color:black">SYSINIT:2DF4                 </span><span style="color:navy">inc     dh
</span><span style="color:black">SYSINIT:2DF6                 </span><span style="color:navy">dec     cx              </span>; cx = cx - 1
<span style="color:black">SYSINIT:2DF6                                         </span>; cx = remain count from [cs:unitcount]
<span style="color:black">SYSINIT:2DF7                 </span><span style="color:navy">jz      short </span><span style="color:gray">iblk_2    </span>; cx = 0 -&gt; done
<span style="color:black">SYSINIT:2DF9                 </span><span style="color:navy">jmp     </span><span style="color:gray">perunit         </span>; loop until cx is 0
<span style="color:black">SYSINIT:2DFC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2DFC
SYSINIT:2DFC </span><span style="color:gray">iblk_2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2DFC                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2DFD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2DFE                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:2DFE                 </span><span style="color:navy">call    </span>TempCDS         ; set cds for new drives
<span style="color:black">SYSINIT:2E01
SYSINIT:2E01 </span><span style="color:gray">linkit</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E01                 </span><span style="color:navy">les     di, cs:</span>DOSINFO  ; es:di = dos table
<span style="color:black">SYSINIT:2E06                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">22h</span><span style="color:navy">] </span>; [es:di+SYSI_DEV] ; dx:cx = head of list
<span style="color:black">SYSINIT:2E0A                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">24h</span><span style="color:navy">] </span>; [es:di+SYSI_DEV+2]
<span style="color:black">SYSINIT:2E0E                 </span><span style="color:navy">lds     si, cs:</span>DevEntry ; ds:si = device location
<span style="color:black">SYSINIT:2E13                 </span>assume ds:nothing
<span style="color:black">SYSINIT:2E13                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">22h</span><span style="color:navy">], si </span>; set head of list in dos
<span style="color:black">SYSINIT:2E13                                         </span>; [es:di+SYSI_DEV]
<span style="color:black">SYSINIT:2E17                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">24h</span><span style="color:navy">], ds </span>; [es:di+SYSI_DEV+2]
<span style="color:black">SYSINIT:2E1B                 </span><span style="color:navy">mov     ax, [si]        </span>; get pointer to next device
<span style="color:black">SYSINIT:2E1D                 </span><span style="color:navy">mov     word ptr cs:</span>DevEntry<span style="color:navy">, ax </span>; and save it
<span style="color:black">SYSINIT:2E21                 </span><span style="color:navy">mov     [si], cx        </span>; link in the driver
<span style="color:black">SYSINIT:2E23                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], dx
</span><span style="color:black">SYSINIT:2E26                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2E27                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2E28                 </span><span style="color:navy">inc     ax              </span>; ax = 0FFFFh (no more devs if yes)?
<span style="color:black">SYSINIT:2E29                 </span><span style="color:navy">jz      short </span><span style="color:gray">coffj3
</span><span style="color:black">SYSINIT:2E2B                 </span><span style="color:navy">inc     cs:</span>multdeviceflag ; possibly multiple device driver.
<span style="color:black">SYSINIT:2E30                 </span><span style="color:navy">call    </span>DevBreak
<span style="color:black">SYSINIT:2E33                 </span><span style="color:navy">jmp     </span><span style="color:gray">goodld          </span>; otherwise pretend we loaded it in
<span style="color:black">SYSINIT:2E36 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2E36
SYSINIT:2E36 </span><span style="color:gray">coffj3</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E36                 </span><span style="color:navy">mov     cs:</span>multdeviceflag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset the flag
<span style="color:black">SYSINIT:2E3C                 </span><span style="color:navy">call    </span>DevBreak
<span style="color:black">SYSINIT:2E3F                 </span><span style="color:navy">call    </span>CheckProtmanArena
<span style="color:black">SYSINIT:2E42
SYSINIT:2E42 </span>CheckDoubleSpace<span style="color:navy">:                       </span>; inquire of MagicDrv whether it is present,
<span style="color:black">SYSINIT:2E42                 </span><span style="color:navy">test    cs:</span>MagicHomeFlag<span style="color:navy">, </span><span style="color:green">1 </span>; and final located
<span style="color:black">SYSINIT:2E48                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_more_magic_calls </span>; already home?
<span style="color:black">SYSINIT:2E48                                         </span>; nothing more to do if so
<span style="color:black">SYSINIT:2E4A                 </span><span style="color:navy">call    </span>get_dblspace_version ; is it there?
<span style="color:black">SYSINIT:2E4D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_magichomeflag </span>; done if not
<span style="color:black">SYSINIT:2E4F                 </span><span style="color:navy">test    dx, </span><span style="color:green">8000h       </span>; is it final placed?
<span style="color:black">SYSINIT:2E53                 </span><span style="color:navy">jnz     short </span><span style="color:gray">magic_not_yet_home
</span><span style="color:black">SYSINIT:2E55                 </span><span style="color:navy">add     cs:</span>drivenumber<span style="color:navy">, ch </span>; add number of MagicDrv volumes to
<span style="color:black">SYSINIT:2E55                                         </span>; the drive number we&#039;ll pass to the
<span style="color:black">SYSINIT:2E55                                         </span>; next loadable block device.
<span style="color:black">SYSINIT:2E5A
SYSINIT:2E5A </span><span style="color:gray">set_magichomeflag</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E5A                 </span><span style="color:navy">mov     cs:</span>MagicHomeFlag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; set the flag!
<span style="color:black">SYSINIT:2E60                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2E63 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2E63
SYSINIT:2E63 </span><span style="color:gray">magic_not_yet_home</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E63                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:2E64                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:2E65                 </span><span style="color:navy">mov     ax, cs:</span>memhi    ; pass it a work buffer
<span style="color:black">SYSINIT:2E69                 </span><span style="color:navy">mov     dx, cs:</span>ALLOCLIM ; address in cx (segment)
<span style="color:black">SYSINIT:2E6E                 </span><span style="color:navy">sub     dx, ax          </span>; for len dx (paragraphs)
<span style="color:black">SYSINIT:2E70                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:2E73                 </span><span style="color:navy">mov     al, cs:</span>drivers_units ; shuffle magicdrives and new drives
<span style="color:black">SYSINIT:2E73                                         </span>; by this many units
<span style="color:black">SYSINIT:2E77                 </span><span style="color:navy">mov     ah, </span><span style="color:green">55h         </span>; backdoor won&#039;t shuffle unless it
<span style="color:black">SYSINIT:2E77                                         </span>; sees this, to prevent bad things
<span style="color:black">SYSINIT:2E77                                         </span>; from happening if people run the
<span style="color:black">SYSINIT:2E77                                         </span>; new driver with an old (dos) BIOS
<span style="color:black">SYSINIT:2E79                 </span><span style="color:navy">call    cs:</span>MagicBackdoor
<span style="color:black">SYSINIT:2E7E                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2E7F                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2E80
SYSINIT:2E80 </span><span style="color:gray">no_more_magic_calls</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E80                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2E83 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2E83
SYSINIT:2E83 </span><span style="color:gray">bad_bpb_size_sector</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E83                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2E84                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2E85                 </span><span style="color:navy">mov     dx, offset </span>badsiz_pre <span style="color:gray">; &quot;\r\nSector size too large in file $&quot;
</span><span style="color:black">SYSINIT:2E88                 </span><span style="color:navy">mov     bx, offset </span>crlfm <span style="color:gray">; &quot;\r\n$&quot;
</span><span style="color:black">SYSINIT:2E8B                 </span><span style="color:navy">call    </span>prnerr
<span style="color:black">SYSINIT:2E8E                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2E91 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2E91
SYSINIT:2E91 </span><span style="color:gray">tryq</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E91                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">51h </span><span style="color:gray">; &#039;Q&#039;   </span>; CONFIG_COUNTRY
<span style="color:black">SYSINIT:2E94                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryq_cont
</span><span style="color:black">SYSINIT:2E96
SYSINIT:2E96 </span><span style="color:gray">skip_it3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E96                 </span><span style="color:navy">jmp     </span><span style="color:gray">tryf
</span><span style="color:black">SYSINIT:2E99 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2E99
SYSINIT:2E99 </span><span style="color:gray">tryq_cont</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2E99                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2E99                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2E9C                 </span><span style="color:navy">jb      short </span><span style="color:gray">skip_it3
</span><span style="color:black">SYSINIT:2E9E                 </span><span style="color:navy">mov     byte ptr cs:</span>cntry_drv<span style="color:navy">, </span><span style="color:#ff8000">0 </span>;
<span style="color:black">SYSINIT:2E9E                                         </span>; reset the drive,path to default value.
<span style="color:black">SYSINIT:2EA4                 </span><span style="color:navy">mov     cs:</span>p_code_page<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:2EAB                 </span><span style="color:navy">mov     di, offset </span>cntry_parms
<span style="color:black">SYSINIT:2EAE                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:2EB0                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:2EB2
SYSINIT:2EB2 </span><span style="color:gray">do52</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2EB2                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:2EB5                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if52      </span>; parse error,check error code and
<span style="color:black">SYSINIT:2EB7                 </span><span style="color:navy">call    </span>cntry_error     ; show message and end the search loop.
<span style="color:black">SYSINIT:2EBA                 </span><span style="color:navy">mov     cs:</span>p_cntry_code<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; signals that parse error.
<span style="color:black">SYSINIT:2EC1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr52
</span><span style="color:black">SYSINIT:2EC3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2EC3
SYSINIT:2EC3 </span><span style="color:gray">if52</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2EC3                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:2EC6                 </span><span style="color:navy">jz      short </span><span style="color:gray">sr52
</span><span style="color:black">SYSINIT:2EC8                 </span><span style="color:navy">cmp     cs:</span>result_val<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; _$P_Number
<span style="color:black">SYSINIT:2ECE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if56
</span><span style="color:black">SYSINIT:2ED0                 </span><span style="color:navy">mov     ax, word ptr cs:</span>rv_dword ;
<span style="color:black">SYSINIT:2ED0                                         </span>; [cs:result_val+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:2ED4                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:2ED7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if57
</span><span style="color:black">SYSINIT:2ED9                 </span><span style="color:navy">mov     cs:</span>p_cntry_code<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:2EDD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en57
</span><span style="color:black">SYSINIT:2EDF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2EDF
SYSINIT:2EDF </span><span style="color:gray">if57</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2EDF                 </span><span style="color:navy">mov     cs:</span>p_code_page<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:2EE3
SYSINIT:2EE3 </span><span style="color:gray">en57</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2EE3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en56      </span>; path entered
<span style="color:black">SYSINIT:2EE5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2EE5
SYSINIT:2EE5 </span><span style="color:gray">if56</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2EE5                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:2EE6                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:2EE7                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:2EE8                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:2EE9                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2EEA                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2EEB                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:2EEB                 </span><span style="color:navy">lds     si, cs:</span>rv_dword ; move the path to known place.
<span style="color:black">SYSINIT:2EF0                 </span><span style="color:navy">mov     di, offset </span>cntry_drv <span style="color:gray">; &quot;A:&quot;
</span><span style="color:black">SYSINIT:2EF3                 </span><span style="color:navy">call    </span>move_asciiz
<span style="color:black">SYSINIT:2EF6                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:2EF7                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:2EF8                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2EF9                 </span>assume es:nothing
<span style="color:black">SYSINIT:2EF9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:2EFA
SYSINIT:2EFA </span><span style="color:gray">en56</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2EFA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do52
</span><span style="color:black">SYSINIT:2EFC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2EFC
SYSINIT:2EFC </span><span style="color:gray">sr52</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2EFC                 </span><span style="color:navy">cmp     cs:</span>p_cntry_code<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; had a parse error?
<span style="color:black">SYSINIT:2F02                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryq_open
</span><span style="color:black">SYSINIT:2F04                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2F07 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2F07
SYSINIT:2F07 </span><span style="color:gray">tryqbad</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F07                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:2F08                 </span><span style="color:navy">mov     dx, offset </span>badcountry <span style="color:gray">; &quot;\r\nInvalid country code or code page\r&quot;...
</span><span style="color:black">SYSINIT:2F0B                 </span><span style="color:navy">jmp     </span><span style="color:gray">tryqchkerr
</span><span style="color:black">SYSINIT:2F0E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2F0E
SYSINIT:2F0E </span><span style="color:gray">tryq_open</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F0E                 </span><span style="color:navy">cmp     byte ptr cs:</span>cntry_drv<span style="color:navy">, </span><span style="color:#ff8000">0 </span><span style="color:gray">; &quot;A:&quot;
</span><span style="color:black">SYSINIT:2F14                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryq_def
</span><span style="color:black">SYSINIT:2F16                 </span><span style="color:navy">mov     dx, offset </span>cntry_drv <span style="color:gray">; &quot;A:&quot;
</span><span style="color:black">SYSINIT:2F19                 </span><span style="color:navy">jmp     short </span><span style="color:gray">tryq_openit
</span><span style="color:black">SYSINIT:2F1B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2F1B
SYSINIT:2F1B </span><span style="color:gray">tryq_def</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F1B                 </span><span style="color:navy">mov     dx, offset </span>cntry_root
<span style="color:black">SYSINIT:2F1E
SYSINIT:2F1E </span><span style="color:gray">tryq_openit</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F1E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3D00h       </span>; open a file
<span style="color:black">SYSINIT:2F21                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:2F22                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - OPEN DISK FILE WITH HANDLE
<span style="color:black">SYSINIT:2F22                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:black">SYSINIT:2F22                                         </span>; AL = access mode
<span style="color:black">SYSINIT:2F22                                         </span>; 0 - read
<span style="color:black">SYSINIT:2F24                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryqfilebad
</span><span style="color:black">SYSINIT:2F26                 </span><span style="color:navy">mov     cs:</span>cntryfilehandle<span style="color:navy">, ax </span>; save file handle
<span style="color:black">SYSINIT:2F2A                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">SYSINIT:2F2C                 </span><span style="color:navy">mov     ax, cs:</span>p_cntry_code
<span style="color:black">SYSINIT:2F30                 </span><span style="color:navy">mov     dx, cs:</span>p_code_page ; ax=country id, bx=filehandle
<span style="color:black">SYSINIT:2F35                 </span><span style="color:navy">mov     cx, cs:</span>memhi
<span style="color:black">SYSINIT:2F3A                 </span><span style="color:navy">add     cx, </span><span style="color:green">384         </span>; need 6k buffer to handle country.sys
<span style="color:black">SYSINIT:2F3A                                         </span>; (384*16 bytes)
<span style="color:black">SYSINIT:2F3E                 </span><span style="color:navy">cmp     cx, cs:</span>ALLOCLIM
<span style="color:black">SYSINIT:2F43                 </span><span style="color:navy">ja      short </span><span style="color:gray">tryqmemory </span>; cannot allocate the buffer for country.sys
<span style="color:black">SYSINIT:2F45                 </span><span style="color:navy">mov     si, offset </span>cntry_drv <span style="color:gray">; &quot;A:&quot;
</span><span style="color:black">SYSINIT:2F48                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0 </span>; default path?
<span style="color:black">SYSINIT:2F4B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryq_set_for_dos </span>; no
<span style="color:black">SYSINIT:2F4D                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:2F4E                 </span><span style="color:navy">inc     si              </span>; ds:si -&gt; cntry_root
<span style="color:black">SYSINIT:2F4F
SYSINIT:2F4F </span><span style="color:gray">tryq_set_for_dos</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F4F                 </span><span style="color:navy">les     di, cs:</span>sysi_country ; es:di -&gt; country info tab in dos
<span style="color:black">SYSINIT:2F54                 </span><span style="color:navy">push    di              </span>; save di
<span style="color:black">SYSINIT:2F55                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">8           </span>; country_cdpg_info.ccPath_CountrySys
<span style="color:black">SYSINIT:2F58                 </span><span style="color:navy">call    </span>move_asciiz     ; set the path to country.sys in dos.
<span style="color:black">SYSINIT:2F5B                 </span><span style="color:navy">pop     di              </span>; es:di -&gt; country info tab again.
<span style="color:black">SYSINIT:2F5C                 </span><span style="color:navy">mov     cx, cs:</span>memhi
<span style="color:black">SYSINIT:2F61                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">SYSINIT:2F63                 </span><span style="color:navy">xor     si, si          </span>; ds:si -&gt; 2k buffer to be used.
<span style="color:black">SYSINIT:2F65                 </span><span style="color:navy">call    </span>setdoscountryinfo ; now do the job!
<span style="color:black">SYSINIT:2F68                 </span><span style="color:navy">jnb     short </span><span style="color:gray">tryqchkerr </span>; read error or could not find country,
<span style="color:black">SYSINIT:2F68                                         </span>; code page combination
<span style="color:black">SYSINIT:2F6A                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">SYSINIT:2F6A                                         </span>; could not find matching country_id, code page?
<span style="color:black">SYSINIT:2F6D                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryqbad   </span>; then &quot;invalid country code or code page&quot;
<span style="color:black">SYSINIT:2F6F
SYSINIT:2F6F </span><span style="color:gray">tryqfilebad</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F6F                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2F70                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:2F71                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:2F71                 </span><span style="color:navy">cmp     byte ptr cs:</span>cntry_drv<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; is the default file used?
<span style="color:black">SYSINIT:2F77                 </span><span style="color:navy">jz      short </span><span style="color:gray">tryqdefbad
</span><span style="color:black">SYSINIT:2F79                 </span><span style="color:navy">mov     si, offset </span>cntry_drv <span style="color:gray">; &quot;A:&quot;
</span><span style="color:black">SYSINIT:2F7C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">tryqbadload
</span><span style="color:black">SYSINIT:2F7E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2F7E
SYSINIT:2F7E </span><span style="color:gray">tryqdefbad</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F7E                 </span><span style="color:navy">mov     si, offset </span>cntry_root ; default file has been used.
<span style="color:black">SYSINIT:2F7E                                         </span>; es:si -&gt; \country.sys in sysinit_seg
<span style="color:black">SYSINIT:2F81
SYSINIT:2F81 </span><span style="color:gray">tryqbadload</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F81                 </span><span style="color:navy">call    </span>badload
<span style="color:black">SYSINIT:2F84                 </span><span style="color:navy">mov     cx, cs:</span>CONFBOT
<span style="color:black">SYSINIT:2F89                 </span><span style="color:navy">mov     es, cx          </span>; restore es -&gt; confbot.
<span style="color:black">SYSINIT:2F8B                 </span>assume es:nothing
<span style="color:black">SYSINIT:2F8B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">coffj4
</span><span style="color:black">SYSINIT:2F8D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2F8D
SYSINIT:2F8D </span><span style="color:gray">tryqmemory</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F8D                 </span><span style="color:navy">mov     dx, offset </span>insufmemory <span style="color:gray">; &quot;\r\nInsufficient memory for COUNTRY.SYS&quot;...
</span><span style="color:black">SYSINIT:2F90
SYSINIT:2F90 </span><span style="color:gray">tryqchkerr</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2F90                 </span><span style="color:navy">mov     cx, cs:</span>CONFBOT
<span style="color:black">SYSINIT:2F95                 </span><span style="color:navy">mov     es, cx          </span>; restore es -&gt; confbot seg
<span style="color:black">SYSINIT:2F97                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:2F98                 </span><span style="color:navy">pop     ds              </span>; restore ds to sysinit_seg
<span style="color:black">SYSINIT:2F99                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:2F99                 </span><span style="color:navy">jnb     short </span><span style="color:gray">coffj4    </span>; if no error,then exit
<span style="color:black">SYSINIT:2F9B                 </span><span style="color:navy">call    </span>print           ; else show error message
<span style="color:black">SYSINIT:2F9E                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:2FA1
SYSINIT:2FA1 </span><span style="color:gray">coffj4</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FA1                 </span><span style="color:navy">mov     bx, cs:</span>cntryfilehandle ; close a file.
<span style="color:black">SYSINIT:2FA1                                         </span>; don&#039;t care even if it fails.
<span style="color:black">SYSINIT:2FA6                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:black">SYSINIT:2FA8                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:black">SYSINIT:2FA8                                         </span>; BX = file handle
<span style="color:black">SYSINIT:2FAA                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2FAA </span><span style="color:gray">; END OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:2FAD
SYSINIT:2FAD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:2FAD
SYSINIT:2FAD
SYSINIT:2FAD </span>cntry_error     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FAD                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">6           </span>; _$P_Out_Of_Range
<span style="color:black">SYSINIT:2FB0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if64
</span><span style="color:black">SYSINIT:2FB2                 </span><span style="color:navy">mov     dx, offset </span>badcountry <span style="color:gray">; &quot;\r\nInvalid country code or code page\r&quot;...
</span><span style="color:black">SYSINIT:2FB5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en64
</span><span style="color:black">SYSINIT:2FB7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2FB7
SYSINIT:2FB7 </span><span style="color:gray">if64</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FB7                 </span><span style="color:navy">mov     dx, offset </span>badcountrycom <span style="color:gray">; &quot;\r\nError in COUNTRY command\r\n$&quot;
</span><span style="color:black">SYSINIT:2FBA
SYSINIT:2FBA </span><span style="color:gray">en64</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FBA                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:2FBD                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:2FC0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:2FC0 </span>cntry_error     <span style="color:black">endp
SYSINIT:2FC0
SYSINIT:2FC1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2FC1 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:2FC1
SYSINIT:2FC1 </span><span style="color:gray">tryf</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FC1                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">46h </span><span style="color:gray">; &#039;F&#039;   </span>; CONFIG_FILES
<span style="color:black">SYSINIT:2FC4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryl
</span><span style="color:black">SYSINIT:2FC6                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2FC6                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2FC9                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryl
</span><span style="color:black">SYSINIT:2FCB                 </span><span style="color:navy">mov     di, offset </span>files_parms
<span style="color:black">SYSINIT:2FCE                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:2FD0                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:2FD2
SYSINIT:2FD2 </span><span style="color:gray">do67</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FD2                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:2FD5                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if67      </span>;
<span style="color:black">SYSINIT:2FD5                                         </span>; parse error
<span style="color:black">SYSINIT:2FD5                                         </span>; show messages and end the search loop.
<span style="color:black">SYSINIT:2FD7                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:2FDA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr67
</span><span style="color:black">SYSINIT:2FDC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2FDC
SYSINIT:2FDC </span><span style="color:gray">if67</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FDC                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:2FDF                 </span><span style="color:navy">jz      short </span><span style="color:gray">en67      </span>; then end the $endloop
<span style="color:black">SYSINIT:2FE1                 </span><span style="color:navy">mov     al, byte ptr cs:</span>rv_dword ;
<span style="color:black">SYSINIT:2FE1                                         </span>; [result_val+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:2FE5                 </span><span style="color:navy">mov     cs:</span>p_files<span style="color:navy">, al  </span>; save it temporarily
<span style="color:black">SYSINIT:2FE9                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do67
</span><span style="color:black">SYSINIT:2FEB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2FEB
SYSINIT:2FEB </span><span style="color:gray">en67</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FEB                 </span><span style="color:navy">mov     al, cs:</span>p_files
<span style="color:black">SYSINIT:2FEF                 </span><span style="color:navy">mov     cs:</span>FILES<span style="color:navy">, al    </span>; no error. really set the value now.
<span style="color:black">SYSINIT:2FF3
SYSINIT:2FF3 </span><span style="color:gray">sr67</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FF3                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:2FF6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:2FF6
SYSINIT:2FF6 </span><span style="color:gray">tryl</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:2FF6                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4Ch </span><span style="color:gray">; &#039;L&#039;   </span>; CONFIG_LASTDRIVE
<span style="color:black">SYSINIT:2FF9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryp
</span><span style="color:black">SYSINIT:2FFB                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:2FFB                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:2FFE                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryp
</span><span style="color:black">SYSINIT:3000                 </span><span style="color:navy">mov     di, offset </span>ldrv_parms
<span style="color:black">SYSINIT:3003                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:3005                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:3007
SYSINIT:3007 </span><span style="color:gray">do73</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3007                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:300A                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if73      </span>;
<span style="color:black">SYSINIT:300A                                         </span>; parse error
<span style="color:black">SYSINIT:300A                                         </span>; show messages and end the search loop.
<span style="color:black">SYSINIT:300C                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:300F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">badparm_p_coff
</span><span style="color:black">SYSINIT:3011 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3011
SYSINIT:3011 </span><span style="color:gray">if73</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3011                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:3014                 </span><span style="color:navy">jz      short </span><span style="color:gray">en73      </span>; then end the $endloop
<span style="color:black">SYSINIT:3016                 </span><span style="color:navy">mov     al, byte ptr cs:</span>rv_dword ; [rv_byte]
<span style="color:black">SYSINIT:3016                                         </span>; pick up the drive number
<span style="color:black">SYSINIT:301A                 </span><span style="color:navy">mov     cs:</span>p_ldrv<span style="color:navy">, al   </span>; save it temporarily
<span style="color:black">SYSINIT:301E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do73
</span><span style="color:black">SYSINIT:3020 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3020
SYSINIT:3020 </span><span style="color:gray">en73</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3020                 </span><span style="color:navy">mov     al, cs:</span>p_ldrv
<span style="color:black">SYSINIT:3024                 </span><span style="color:navy">mov     cs:</span>NUM_CDS<span style="color:navy">, al  </span>; no error.
<span style="color:black">SYSINIT:3024                                         </span>; really set the value now.
<span style="color:black">SYSINIT:3028
SYSINIT:3028 </span><span style="color:gray">badparm_p_coff</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3028                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:302B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:302B
SYSINIT:302B </span><span style="color:gray">tryp</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:302B                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">50h </span><span style="color:gray">; &#039;P&#039;   </span>; CONFIG_DRIVPARM
<span style="color:black">SYSINIT:302E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryk
</span><span style="color:black">SYSINIT:3030                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:3030                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:3033                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryk
</span><span style="color:black">SYSINIT:3035                 </span><span style="color:navy">call    </span>parseline
<span style="color:black">SYSINIT:3038                 </span><span style="color:navy">jb      short </span><span style="color:gray">trypbad
</span><span style="color:black">SYSINIT:303A                 </span><span style="color:navy">call    </span>setparms
<span style="color:black">SYSINIT:303D                 </span><span style="color:navy">call    </span>diddleback
<span style="color:black">SYSINIT:3040                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:3043 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3043
SYSINIT:3043 </span><span style="color:gray">trypbad</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3043                 </span><span style="color:navy">jmp     </span><span style="color:gray">badop
</span><span style="color:black">SYSINIT:3046 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3046
SYSINIT:3046 </span><span style="color:gray">tryk</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3046                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4Bh </span><span style="color:gray">; &#039;K&#039;   </span>; CONFIG_STACKS
<span style="color:black">SYSINIT:3049                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_tryk
</span><span style="color:black">SYSINIT:304B
SYSINIT:304B </span><span style="color:gray">skip_it4</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:304B                 </span><span style="color:navy">jmp     </span><span style="color:gray">trys
</span><span style="color:black">SYSINIT:304E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:304E
SYSINIT:304E </span><span style="color:gray">do_tryk</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:304E                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:304E                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:3051                 </span><span style="color:navy">jb      short </span><span style="color:gray">skip_it4
</span><span style="color:black">SYSINIT:3053                 </span><span style="color:navy">mov     di, offset </span>stks_parms
<span style="color:black">SYSINIT:3056                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:3058                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:305A
SYSINIT:305A </span><span style="color:gray">do79</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:305A                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:305D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if79      </span>; parse error
<span style="color:black">SYSINIT:305F                 </span><span style="color:navy">mov     dx, offset </span>badstack <span style="color:gray">; &quot;\r\nInvalid STACK parameters\r\n$&quot;
</span><span style="color:black">SYSINIT:3062                 </span><span style="color:navy">call    </span>print           ; show messages and end the search loop.
<span style="color:black">SYSINIT:3065                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:3068                 </span><span style="color:navy">jmp     </span><span style="color:gray">sr79            </span>; (jmp coff)
<span style="color:black">SYSINIT:306B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:306B
SYSINIT:306B </span><span style="color:gray">if79</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:306B                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:306E                 </span><span style="color:navy">jz      short </span><span style="color:gray">en79      </span>; then end the $endloop
<span style="color:black">SYSINIT:3070                 </span><span style="color:navy">mov     ax, word ptr cs:</span>rv_dword ;
<span style="color:black">SYSINIT:3070                                         </span>; [cs:result_val+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:3074                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:3077                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if83
</span><span style="color:black">SYSINIT:3079                 </span><span style="color:navy">mov     cs:</span>p_stack_count<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:307D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en83
</span><span style="color:black">SYSINIT:307F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:307F
SYSINIT:307F </span><span style="color:gray">if83</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:307F                 </span><span style="color:navy">mov     cs:</span>p_stack_size<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3083
SYSINIT:3083 </span><span style="color:gray">en83</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3083                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do79
</span><span style="color:black">SYSINIT:3085 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3085
SYSINIT:3085 </span><span style="color:gray">en79</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3085                 </span><span style="color:navy">cmp     cs:</span>p_stack_count<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:308B                 </span><span style="color:navy">jz      short </span><span style="color:gray">if87
</span><span style="color:black">SYSINIT:308D                 </span><span style="color:navy">cmp     cs:</span>p_stack_count<span style="color:navy">, </span><span style="color:green">8 </span>; mincount
<span style="color:black">SYSINIT:3093                 </span><span style="color:navy">jb      short </span><span style="color:gray">ll88
</span><span style="color:black">SYSINIT:3095                 </span><span style="color:navy">cmp     cs:</span>p_stack_size<span style="color:navy">, </span><span style="color:green">32 </span>; minsize
<span style="color:black">SYSINIT:309B                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if88
</span><span style="color:black">SYSINIT:309D
SYSINIT:309D </span><span style="color:gray">ll88</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:309D                 </span><span style="color:navy">mov     cs:</span>p_stack_count<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; invalid
<span style="color:black">SYSINIT:30A4
SYSINIT:30A4 </span><span style="color:gray">if88</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:30A4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en87
</span><span style="color:black">SYSINIT:30A6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:30A6
SYSINIT:30A6 </span><span style="color:gray">if87</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:30A6                 </span><span style="color:navy">cmp     cs:</span>p_stack_size<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:30AC                 </span><span style="color:navy">jz      short </span><span style="color:gray">en87
</span><span style="color:black">SYSINIT:30AE                 </span><span style="color:navy">mov     cs:</span>p_stack_count<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; invalid
<span style="color:black">SYSINIT:30B5
SYSINIT:30B5 </span><span style="color:gray">en87</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:30B5                 </span><span style="color:navy">cmp     cs:</span>p_stack_count<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; invalid?
<span style="color:black">SYSINIT:30BB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if94
</span><span style="color:black">SYSINIT:30BD                 </span><span style="color:navy">mov     cs:</span>stack_count<span style="color:navy">, </span><span style="color:#ff8000">9 </span>; defaultcount
<span style="color:black">SYSINIT:30BD                                         </span>; reset to default value.
<span style="color:black">SYSINIT:30C4                 </span><span style="color:navy">mov     cs:</span>stack_size<span style="color:navy">, </span><span style="color:green">128 </span>; defaultsize
<span style="color:black">SYSINIT:30CB                 </span><span style="color:navy">mov     cs:</span>stack_addr<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; stacks= been accepted.
<span style="color:black">SYSINIT:30D2                 </span><span style="color:navy">mov     dx, offset </span>badstack <span style="color:gray">; &quot;\r\nInvalid STACK parameters\r\n$&quot;
</span><span style="color:black">SYSINIT:30D5                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:30D8                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:30DB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr79
</span><span style="color:black">SYSINIT:30DD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:30DD
SYSINIT:30DD </span><span style="color:gray">if94</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:30DD                 </span><span style="color:navy">mov     ax, cs:</span>p_stack_count
<span style="color:black">SYSINIT:30E1                 </span><span style="color:navy">mov     cs:</span>stack_count<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:30E5                 </span><span style="color:navy">mov     ax, cs:</span>p_stack_size
<span style="color:black">SYSINIT:30E9                 </span><span style="color:navy">mov     cs:</span>stack_size<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:30ED                 </span><span style="color:navy">mov     cs:</span>stack_addr<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; stacks= been accepted.
<span style="color:black">SYSINIT:30F4
SYSINIT:30F4 </span><span style="color:gray">sr79</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:30F4                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:30F7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:30F7
SYSINIT:30F7 </span><span style="color:gray">trys</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:30F7                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">53h </span><span style="color:gray">; &#039;S&#039;   </span>; CONFIG_SHELL
<span style="color:black">SYSINIT:30FA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryx
</span><span style="color:black">SYSINIT:30FC                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:30FC                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:30FF                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryx
</span><span style="color:black">SYSINIT:3101                 </span><span style="color:navy">mov     cs:</span>newcmd<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:3107                 </span><span style="color:navy">mov     word ptr cs:</span>command_line<span style="color:navy">, </span><span style="color:#ff8000">0 </span>;
<span style="color:black">SYSINIT:3107                                         </span>; zap length, first byte of command-line
<span style="color:black">SYSINIT:310E                 </span><span style="color:navy">mov     di, (offset </span>commnd<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">) </span>; we already have the first char
<span style="color:black">SYSINIT:3111                 </span><span style="color:navy">mov     [di-</span><span style="color:green">1</span><span style="color:navy">], al      </span>; of the new shell in AL, save it now
<span style="color:black">SYSINIT:3114
SYSINIT:3114 </span><span style="color:gray">storeshell</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3114                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:3117                 </span><span style="color:navy">or      al, al          </span>; this is the normal case: &quot;organize&quot;
<span style="color:black">SYSINIT:3119                 </span><span style="color:navy">jz      short </span><span style="color:gray">getshparms </span>; put a ZERO right after the filename
<span style="color:black">SYSINIT:311B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; this may happen if there are no args
<span style="color:black">SYSINIT:311D                 </span><span style="color:navy">jb      short </span><span style="color:gray">endofshell </span>; I suppose...
<span style="color:black">SYSINIT:311F                 </span><span style="color:navy">mov     [di], al
</span><span style="color:black">SYSINIT:3121                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:3122                 </span><span style="color:navy">cmp     di, offset </span>commnd_63 ; commnd+63
<span style="color:black">SYSINIT:3122                                         </span>; this makes sure we don&#039;t overflow
<span style="color:black">SYSINIT:3122                                         </span>; commnd (the filename)
<span style="color:black">SYSINIT:3126                 </span><span style="color:navy">jb      short </span><span style="color:gray">storeshell
</span><span style="color:black">SYSINIT:3128                 </span><span style="color:navy">jmp     short </span><span style="color:gray">endofshell
</span><span style="color:black">SYSINIT:312A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:312A
SYSINIT:312A </span><span style="color:gray">getshparms</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:312A                 </span><span style="color:navy">mov     byte ptr [di], </span><span style="color:#ff8000">0 </span>; zero-terminate the filename
<span style="color:black">SYSINIT:312D                 </span><span style="color:navy">mov     di, (offset </span>command_line<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">) </span>;
<span style="color:black">SYSINIT:312D                                         </span>; prepare to process the command-line
<span style="color:black">SYSINIT:3130
SYSINIT:3130 </span><span style="color:gray">parmloop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3130                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:3133                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:3135                 </span><span style="color:navy">jb      short </span><span style="color:gray">endofparms
</span><span style="color:black">SYSINIT:3137                 </span><span style="color:navy">mov     [di], al
</span><span style="color:black">SYSINIT:3139                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:313A                 </span><span style="color:navy">cmp     di, offset </span>command_line_126 ; command_line+126
<span style="color:black">SYSINIT:313E                 </span><span style="color:navy">jb      short </span><span style="color:gray">parmloop
</span><span style="color:black">SYSINIT:3140
SYSINIT:3140 </span><span style="color:gray">endofparms</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3140                 </span><span style="color:navy">mov     cx, di
</span><span style="color:black">SYSINIT:3142                 </span><span style="color:navy">sub     cx, (offset </span>command_line<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">) </span><span style="color:gray">; &quot;/P&quot;
</span><span style="color:black">SYSINIT:3146                 </span><span style="color:navy">mov     byte ptr cs:</span>command_line<span style="color:navy">, cl </span><span style="color:gray">; &quot;\x02/P&quot;
</span><span style="color:black">SYSINIT:314B
SYSINIT:314B </span><span style="color:gray">endofshell</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:314B                 </span><span style="color:navy">mov     byte ptr [di], </span><span style="color:#ff8000">0 </span>; zero-terminate the filename
<span style="color:black">SYSINIT:314B                                         </span>; (or the command-line as the case may be)
<span style="color:black">SYSINIT:314E
SYSINIT:314E </span><span style="color:gray">skipline</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:314E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf ; the safest way to eat the rest of
<span style="color:black">SYSINIT:3150                 </span><span style="color:navy">jz      short </span><span style="color:gray">endofline </span>; the line: watch for ever-present LF
<span style="color:black">SYSINIT:3152                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:3155                 </span><span style="color:navy">jnb     short </span><span style="color:gray">skipline
</span><span style="color:black">SYSINIT:3157
SYSINIT:3157 </span><span style="color:gray">endofline</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3157                 </span><span style="color:navy">jmp     </span>conflp
<span style="color:black">SYSINIT:315A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:315A
SYSINIT:315A </span><span style="color:gray">tryx</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:315A                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">58h </span><span style="color:gray">; &#039;X&#039;   </span>; CONFIG_FCBS
<span style="color:black">SYSINIT:315D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">try1
</span><span style="color:black">SYSINIT:315F                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:315F                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:3162                 </span><span style="color:navy">jb      short </span><span style="color:gray">try1
</span><span style="color:black">SYSINIT:3164                 </span><span style="color:navy">mov     di, offset </span>fcbs_parms
<span style="color:black">SYSINIT:3167                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:3169                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:316B
SYSINIT:316B </span><span style="color:gray">do98</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:316B                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:316E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if98
</span><span style="color:black">SYSINIT:3170                 </span><span style="color:navy">call    </span>badparm_p       ; parse error
<span style="color:black">SYSINIT:3170                                         </span>; show messages and end the search loop.
<span style="color:black">SYSINIT:3173                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr98
</span><span style="color:black">SYSINIT:3175 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3175
SYSINIT:3175 </span><span style="color:gray">if98</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3175                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:3178                 </span><span style="color:navy">jz      short </span><span style="color:gray">en98      </span>; then end the $endloop
<span style="color:black">SYSINIT:317A                 </span><span style="color:navy">mov     al, byte ptr cs:</span>rv_dword ;
<span style="color:black">SYSINIT:317A                                         </span>; [cs:result_val+_$P_Result_Blk.Picked_Val]
<span style="color:black">SYSINIT:317E                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">1           </span>; the first positional?
<span style="color:black">SYSINIT:3181                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if102
</span><span style="color:black">SYSINIT:3183                 </span><span style="color:navy">mov     cs:</span>p_fcbs<span style="color:navy">, al
</span><span style="color:black">SYSINIT:3187                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en102
</span><span style="color:black">SYSINIT:3189 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3189
SYSINIT:3189 </span><span style="color:gray">if102</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3189                 </span><span style="color:navy">mov     cs:</span>p_keep<span style="color:navy">, al
</span><span style="color:black">SYSINIT:318D
SYSINIT:318D </span><span style="color:gray">en102</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:318D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do98
</span><span style="color:black">SYSINIT:318F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:318F
SYSINIT:318F </span><span style="color:gray">en98</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:318F                 </span><span style="color:navy">mov     al, cs:</span>p_fcbs
<span style="color:black">SYSINIT:3193                 </span><span style="color:navy">mov     cs:</span>FCBS<span style="color:navy">, al
</span><span style="color:black">SYSINIT:3197                 </span><span style="color:navy">mov     cs:</span>KEEP<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:319D
SYSINIT:319D </span><span style="color:gray">sr98</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:319D                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:31A0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:31A0
SYSINIT:31A0 </span><span style="color:gray">try1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31A0                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">31h </span><span style="color:gray">; &#039;1&#039;   </span>; CONFIG_SWITCHES
<span style="color:black">SYSINIT:31A0                                         </span>; switches= command entered?
<span style="color:black">SYSINIT:31A3                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_try1   </span>; yes
<span style="color:black">SYSINIT:31A5
SYSINIT:31A5 </span><span style="color:gray">skip_it5</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31A5                 </span><span style="color:navy">jmp     </span><span style="color:gray">tryv
</span><span style="color:black">SYSINIT:31A8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:31A8
SYSINIT:31A8 </span><span style="color:gray">do_try1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31A8                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:31A8                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:31AB                 </span><span style="color:navy">jb      short </span><span style="color:gray">skip_it5
</span><span style="color:black">SYSINIT:31AD                 </span><span style="color:navy">mov     di, offset </span>swit_parms
<span style="color:black">SYSINIT:31B0                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:31B2                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:31B4
SYSINIT:31B4 </span><span style="color:gray">do110</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31B4                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:31B7                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if110     </span>;
<span style="color:black">SYSINIT:31B7                                         </span>; parse error
<span style="color:black">SYSINIT:31B7                                         </span>; show messages and end the search loop.
<span style="color:black">SYSINIT:31B9                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:31BC                 </span><span style="color:navy">jmp     </span><span style="color:gray">sr110
</span><span style="color:black">SYSINIT:31BF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:31BF
SYSINIT:31BF </span><span style="color:gray">if110</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31BF                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:31C2                 </span><span style="color:navy">jz      short </span><span style="color:gray">en110     </span>; then jmp to $endloop for semantic check
<span style="color:black">SYSINIT:31C4                 </span><span style="color:navy">cmp     cs:</span>result_val_swoff<span style="color:navy">, offset </span>swit_k ; offset &quot;/K&quot;
<span style="color:black">SYSINIT:31C4                                         </span>; [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr]
<span style="color:black">SYSINIT:31CB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if115
</span><span style="color:black">SYSINIT:31CD                 </span><span style="color:navy">mov     cs:</span>p_swit_k<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; set the flag
<span style="color:black">SYSINIT:31D3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do110
</span><span style="color:black">SYSINIT:31D5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:31D5
SYSINIT:31D5 </span><span style="color:gray">if115</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31D5                 </span><span style="color:navy">cmp     cs:</span>result_val_swoff<span style="color:navy">, offset </span>swit_t ; offset &quot;/T&quot;
<span style="color:black">SYSINIT:31D5                                         </span>; [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr]
<span style="color:black">SYSINIT:31DC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if118
</span><span style="color:black">SYSINIT:31DE                 </span><span style="color:navy">mov     cs:</span>p_swit_t<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; set the flag
<span style="color:black">SYSINIT:31E4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do110
</span><span style="color:black">SYSINIT:31E6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:31E6
SYSINIT:31E6 </span><span style="color:gray">if118</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31E6                 </span><span style="color:navy">cmp     cs:</span>result_val_swoff<span style="color:navy">, offset </span>swit_i ; offset &quot;/I&quot;
<span style="color:black">SYSINIT:31E6                                         </span>; [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr]
<span style="color:black">SYSINIT:31ED                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if116
</span><span style="color:black">SYSINIT:31EF                 </span><span style="color:navy">mov     cs:</span>p_swit_i<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; set the flag
<span style="color:black">SYSINIT:31F5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do110
</span><span style="color:black">SYSINIT:31F7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:31F7
SYSINIT:31F7 </span><span style="color:gray">if116</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:31F7                 </span><span style="color:navy">cmp     cs:</span>result_val_swoff<span style="color:navy">, offset </span>swit_w ; offset &quot;/W&quot;
<span style="color:black">SYSINIT:31F7                                         </span>; [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr]
<span style="color:black">SYSINIT:31FE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">do110
</span><span style="color:black">SYSINIT:3200                 </span><span style="color:navy">mov     cs:</span>p_swit_w<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; set the flag
<span style="color:black">SYSINIT:3206                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do110
</span><span style="color:black">SYSINIT:3208 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3208
SYSINIT:3208 </span><span style="color:gray">en110</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3208                 </span><span style="color:navy">cmp     cs:</span>p_swit_k<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; if /k entered,
<span style="color:black">SYSINIT:320E                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:320F                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG ; BIOSDATA segment
<span style="color:black">SYSINIT:3212                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:3214                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3214                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if117
</span><span style="color:black">SYSINIT:3216                 </span><span style="color:navy">mov     ds:</span>keyrd_func<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; BIOSDATA:047Eh
<span style="color:black">SYSINIT:3216                                         </span>; use the conventional keyboard functions
<span style="color:black">SYSINIT:321B                 </span><span style="color:navy">mov     ds:</span>keysts_func<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; BIOSDATA:047Fh
<span style="color:black">SYSINIT:3220
SYSINIT:3220 </span><span style="color:gray">if117</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3220                 </span><span style="color:navy">mov     al, cs:</span>p_swit_t
<span style="color:black">SYSINIT:3224                 </span><span style="color:navy">mov     ds:</span>t_switch<span style="color:navy">, al
</span><span style="color:black">SYSINIT:3227                 </span><span style="color:navy">cmp     cs:</span>p_swit_w<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:322D                 </span><span style="color:navy">jz      short </span><span style="color:gray">if119
</span><span style="color:black">SYSINIT:322F                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3230                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:3231                 </span><span style="color:navy">mov     ah, </span><span style="color:green">52h         </span>; GET_IN_VARS
<span style="color:black">SYSINIT:3233                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - GET LIST OF LISTS
<span style="color:black">SYSINIT:3233                                         </span>; Return: ES:BX -&gt; DOS list of lists
<span style="color:black">SYSINIT:3235                 </span><span style="color:navy">or      byte ptr es:</span><span style="color:green">86h</span><span style="color:navy">, </span><span style="color:green">2 </span>; [es:DOS_FLAG_OFFSET], SUPPRESS_WINA20
<span style="color:black">SYSINIT:323B                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:323C                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:323D
SYSINIT:323D </span><span style="color:gray">if119</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:323D                 </span><span style="color:navy">cmp     cs:</span>p_swit_i<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; if /i entered ; new switch for PCDOS 7.1
<span style="color:black">SYSINIT:3243                 </span><span style="color:navy">jz      short </span><span style="color:gray">skip_dos_flag
</span><span style="color:black">SYSINIT:3245                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3246                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:3247                 </span><span style="color:navy">mov     ah, </span><span style="color:green">52h
</span><span style="color:black">SYSINIT:3249                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - GET LIST OF LISTS
<span style="color:black">SYSINIT:3249                                         </span>; Return: ES:BX -&gt; DOS list of lists
<span style="color:black">SYSINIT:324B                 </span><span style="color:navy">or      byte ptr es:</span><span style="color:green">86h</span><span style="color:navy">, </span><span style="color:green">40h </span>; set DOS_FLAG bit 6
<span style="color:black">SYSINIT:3251                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3252                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3253
SYSINIT:3253 </span><span style="color:gray">skip_dos_flag</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3253                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3254                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3254
SYSINIT:3254 </span><span style="color:gray">sr110</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3254                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:3257 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3257
SYSINIT:3257 </span><span style="color:gray">tryv</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3257                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">56h </span><span style="color:gray">; &#039;V&#039;   </span>; CONFIG_SET ; set var=value&lt;cr/lf&gt;
<span style="color:black">SYSINIT:325A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryn
</span><span style="color:black">SYSINIT:325C                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:325C                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:325F                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryn
</span><span style="color:black">SYSINIT:3261                 </span><span style="color:navy">call    </span>copy_envvar     ; copy var at ES:SI to &quot;config_wrkseg&quot;
<span style="color:black">SYSINIT:3264                 </span><span style="color:navy">jnb     short </span><span style="color:gray">sr110     </span>; no error
<span style="color:black">SYSINIT:3266
SYSINIT:3266 </span><span style="color:gray">err</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3266                 </span><span style="color:navy">call    </span>error_line      ; whoops, display error in line XXX
<span style="color:black">SYSINIT:3269                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr110     </span>; jump to coff (to skip to next line)
<span style="color:black">SYSINIT:326B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:326B
SYSINIT:326B </span><span style="color:gray">tryn</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:326B                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">4Eh </span><span style="color:gray">; &#039;N&#039;   </span>; CONFIG_NUMLOCK ; numlock=on|off
<span style="color:black">SYSINIT:326E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryt
</span><span style="color:black">SYSINIT:3270                 </span><span style="color:navy">call    </span>query_user      ; query the user if config_cmd
<span style="color:black">SYSINIT:3270                                         </span>; has the CONFIG_OPTION_QUERY bit set
<span style="color:black">SYSINIT:3273                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryt
</span><span style="color:black">SYSINIT:3275                 </span><span style="color:navy">call    </span>set_numlock
<span style="color:black">SYSINIT:3278                 </span><span style="color:navy">jb      short </span><span style="color:gray">err
</span><span style="color:black">SYSINIT:327A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr110     </span>; all done
<span style="color:black">SYSINIT:327C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:327C
SYSINIT:327C </span><span style="color:gray">tryt</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:327C                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">54h </span><span style="color:gray">; &#039;T&#039;   </span>; CONFIG_DOSDATA ; PCDOS 7 new config cmd
<span style="color:black">SYSINIT:327F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">tryy
</span><span style="color:black">SYSINIT:3281                 </span><span style="color:navy">call    </span>query_user
<span style="color:black">SYSINIT:3284                 </span><span style="color:navy">jb      short </span><span style="color:gray">tryy
</span><span style="color:black">SYSINIT:3286                 </span><span style="color:navy">mov     di, offset </span>dosdata_parms
<span style="color:black">SYSINIT:3289                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:328B                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:328D
SYSINIT:328D </span><span style="color:gray">do120</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:328D                 </span><span style="color:navy">call    </span>sysinit_parse
<span style="color:black">SYSINIT:3290                 </span><span style="color:navy">jnb     short </span><span style="color:gray">if120
</span><span style="color:black">SYSINIT:3292                 </span><span style="color:navy">call    </span>badparm_p
<span style="color:black">SYSINIT:3295                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en120
</span><span style="color:black">SYSINIT:3297 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3297
SYSINIT:3297 </span><span style="color:gray">if120</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3297                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:329A                 </span><span style="color:navy">jz      short </span><span style="color:gray">en120
</span><span style="color:black">SYSINIT:329C                 </span><span style="color:navy">cmp     ds:</span>result_val_itag<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; tag 1 (UMB)
<span style="color:black">SYSINIT:329C                                         </span>; [result_val+_$P_Result_Blk.Item_Tag]
<span style="color:black">SYSINIT:32A1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if121
</span><span style="color:black">SYSINIT:32A3                 </span><span style="color:navy">mov     ds:</span>dosdata_umb<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; DOSDATA=UMB (1) NOUMB (0)
<span style="color:black">SYSINIT:32A8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sr120
</span><span style="color:black">SYSINIT:32AA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:32AA
SYSINIT:32AA </span><span style="color:gray">if121</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32AA                 </span><span style="color:navy">mov     ds:</span>dosdata_umb<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; DOSDATA=UMB (1) NOUMB (0)
<span style="color:black">SYSINIT:32AF
SYSINIT:32AF </span><span style="color:gray">sr120</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32AF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do120
</span><span style="color:black">SYSINIT:32B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:32B1
SYSINIT:32B1 </span><span style="color:gray">en120</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32B1                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:32B4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:32B4
SYSINIT:32B4 </span><span style="color:gray">tryy</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32B4                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">59h </span><span style="color:gray">; &#039;Y&#039;   </span>; CONFIG_COMMENT
<span style="color:black">SYSINIT:32B4                                         </span>; (do nothing with this line.)
<span style="color:black">SYSINIT:32B7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">try0
</span><span style="color:black">SYSINIT:32B9
SYSINIT:32B9 </span><span style="color:gray">donothing</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32B9                 </span><span style="color:navy">dec     ds:</span>chrptr
<span style="color:black">SYSINIT:32BD                 </span><span style="color:navy">inc     ds:</span>count
<span style="color:black">SYSINIT:32C1                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:32C4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:32C4
SYSINIT:32C4 </span><span style="color:gray">try0</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32C4                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; CONFIG_REM
<span style="color:black">SYSINIT:32C4                                         </span>; (do nothing with this line.)
<span style="color:black">SYSINIT:32C7                 </span><span style="color:navy">jz      short </span><span style="color:gray">donothing
</span><span style="color:black">SYSINIT:32C9                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0FFh        </span>; null/bogus command?
<span style="color:black">SYSINIT:32CC                 </span><span style="color:navy">jz      short </span><span style="color:gray">donothing
</span><span style="color:black">SYSINIT:32CE                 </span><span style="color:navy">dec     ds:</span>chrptr
<span style="color:black">SYSINIT:32D2                 </span><span style="color:navy">inc     ds:</span>count
<span style="color:black">SYSINIT:32D6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">badop
</span><span style="color:black">SYSINIT:32D6 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:32D8
SYSINIT:32D8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:32D8
SYSINIT:32D8
SYSINIT:32D8 </span>CheckProtmanArena <span style="color:black">proc near             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32D8                 </span><span style="color:navy">push    es              </span>; adjusts alloclim if Protman$
<span style="color:black">SYSINIT:32D8                                         </span>; reduced our arena through a manual hack
<span style="color:black">SYSINIT:32D9                 </span><span style="color:navy">mov     ax, cs:</span>area     ; get our arena header
<span style="color:black">SYSINIT:32DD                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:32DE                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:32E0                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE] ; find end of arena
<span style="color:black">SYSINIT:32E5                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:32E6                 </span><span style="color:navy">cmp     ax, cs:</span>ALLOCLIM
<span style="color:black">SYSINIT:32EB                 </span><span style="color:navy">ja      short </span><span style="color:gray">CheckProtmanDone
</span><span style="color:black">SYSINIT:32ED                 </span><span style="color:navy">mov     cs:</span>ALLOCLIM<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:32F1
SYSINIT:32F1 </span><span style="color:gray">CheckProtmanDone</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32F1                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:32F2                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:32F2 </span>CheckProtmanArena <span style="color:black">endp
SYSINIT:32F2
SYSINIT:32F3
SYSINIT:32F3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:32F3
SYSINIT:32F3
SYSINIT:32F3 </span>sysinit_parse   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:32F3                 </span><span style="color:navy">push    es              </span>; set up registers for sysparse
<span style="color:black">SYSINIT:32F3                                         </span>; in:
<span style="color:black">SYSINIT:32F3                                         </span>;    es:si -&gt; command line in confbot
<span style="color:black">SYSINIT:32F3                                         </span>;       di -&gt; offset of the parse control definition.
<span style="color:black">SYSINIT:32F3                                         </span>; out:
<span style="color:black">SYSINIT:32F3                                         </span>;    calls sysparse.
<span style="color:black">SYSINIT:32F3                                         </span>;    carry will set if parse error.
<span style="color:black">SYSINIT:32F3                                         </span>;    *** the caller should check the eol condition by looking at ax
<span style="color:black">SYSINIT:32F3                                         </span>;    *** after each call.
<span style="color:black">SYSINIT:32F3                                         </span>;    *** if no parameters are found,then ax will contain a error code.
<span style="color:black">SYSINIT:32F3                                         </span>;    *** if the caller needs to look at the synomym@ of the result,
<span style="color:black">SYSINIT:32F3                                         </span>;    *** the caller should use cs:@ instead of es:@.
<span style="color:black">SYSINIT:32F3                                         </span>;    cx should be set to 0 at the 1st time the caller calls this proc.
<span style="color:black">SYSINIT:32F3                                         </span>;    ax - exit code
<span style="color:black">SYSINIT:32F3                                         </span>;    bl - terminated delimeter code
<span style="color:black">SYSINIT:32F3                                         </span>;    cx - new positional ordinal
<span style="color:black">SYSINIT:32F3                                         </span>;    si - set to pase scanned operand
<span style="color:black">SYSINIT:32F3                                         </span>;    dx - selected result buffer
<span style="color:black">SYSINIT:32F4                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:32F5                 </span><span style="color:navy">push    es              </span>; now ds:si -&gt; command line
<span style="color:black">SYSINIT:32F6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:32F7                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:32F8                 </span><span style="color:navy">pop     es              </span>; now es:di -&gt; control definition
<span style="color:black">SYSINIT:32F9                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:32F9                 </span><span style="color:navy">mov     word ptr cs:</span>badparm_ptr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds </span>; save the pointer to the parm
<span style="color:black">SYSINIT:32FE                 </span><span style="color:navy">mov     word ptr cs:</span>badparm_ptr<span style="color:navy">, si </span>; we are about to parse for badparm msg.
<span style="color:black">SYSINIT:3303                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3306                 </span><span style="color:navy">call    </span>SysParse
<span style="color:black">SYSINIT:3309                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0           </span>; _$P_No_Error ; no error
<span style="color:black">SYSINIT:330C                 </span><span style="color:navy">jz      short </span><span style="color:gray">ll4       </span>; cf=0
<span style="color:black">SYSINIT:330E                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; _$P_RC_EOL ; end of line?
<span style="color:black">SYSINIT:3311                 </span><span style="color:navy">jnz     short </span><span style="color:gray">if4       </span>; or the end of line?
<span style="color:black">SYSINIT:3313
SYSINIT:3313 </span><span style="color:gray">ll4</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3313                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3314                 </span><span style="color:navy">jmp     short </span><span style="color:gray">en4
</span><span style="color:black">SYSINIT:3316 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3316
SYSINIT:3316 </span><span style="color:gray">if4</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3316                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3317
SYSINIT:3317 </span><span style="color:gray">en4</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3317                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3318                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3319                 </span>assume es:nothing
<span style="color:black">SYSINIT:3319                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3319 </span>sysinit_parse   <span style="color:black">endp
SYSINIT:3319
</span><span style="color:maroon">SYSINIT:331A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:331A
SYSINIT:331A </span>badop_p<span style="color:navy">:                                </span>; &#039;badop_p&#039; is not used in
<span style="color:maroon">SYSINIT:331A                 </span><span style="color:navy">push    cs              </span>; MSDOS 6.21 IO.SYS and PCDOS 7.1 IBMBIO.COM
<span style="color:maroon">SYSINIT:331A                                         </span>; (but it was/is not removed)
<span style="color:maroon">SYSINIT:331A                                         </span>; Erdogan Tan - 11/07/2023
<span style="color:maroon">SYSINIT:331B                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:331C                 </span>assume ds:SYSINIT
<span style="color:maroon">SYSINIT:331C                 </span><span style="color:navy">mov     dx, offset </span>badopm <span style="color:gray">; &quot;\r\nUnrecognized command in CONFIG.SYS&quot;
</span><span style="color:maroon">SYSINIT:331F                 </span><span style="color:navy">call    </span>print
<span style="color:maroon">SYSINIT:3322                 </span><span style="color:navy">call    </span>error_line
<span style="color:maroon">SYSINIT:3325                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3326 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3326 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:3326
SYSINIT:3326 </span><span style="color:gray">badop</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3326                 </span><span style="color:navy">mov     dx, offset </span>badopm <span style="color:gray">; &quot;\r\nUnrecognized command in CONFIG.SYS&quot;
</span><span style="color:black">SYSINIT:3329                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:332C                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:332F                 </span><span style="color:navy">jmp     </span><span style="color:gray">coff
</span><span style="color:black">SYSINIT:332F </span><span style="color:gray">; END OF FUNCTION CHUNK FOR doconf
</span><span style="color:black">SYSINIT:3332
SYSINIT:3332 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3332
SYSINIT:3332
SYSINIT:3332 </span>badparm_p       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3332                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3333                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:3334                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:3335                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3336                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3337                 </span><span style="color:navy">mov     dx, offset </span>badparm <span style="color:gray">; &quot;\r\nBad command or parameters - $&quot;
</span><span style="color:black">SYSINIT:333A                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:333D                 </span><span style="color:navy">lds     si, </span>badparm_ptr
<span style="color:black">SYSINIT:3341                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3341
SYSINIT:3341 </span><span style="color:gray">do1</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3341                 </span><span style="color:navy">mov     dl, [si]        </span>; print &quot;xxxx&quot; until cr.
<span style="color:black">SYSINIT:3343                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">0Dh         </span>; cr ?
<span style="color:black">SYSINIT:3346                 </span><span style="color:navy">jz      short </span><span style="color:gray">en1       </span>; yes
<span style="color:black">SYSINIT:3348                 </span><span style="color:navy">mov     ah, </span><span style="color:green">2           </span>; display character
<span style="color:black">SYSINIT:334A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:black">SYSINIT:334A                                         </span>; DL = character to send to standard output
<span style="color:black">SYSINIT:334C                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:334D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do1
</span><span style="color:black">SYSINIT:334F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:334F
SYSINIT:334F </span><span style="color:gray">en1</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:334F                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3350                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3351                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3351                 </span><span style="color:navy">mov     dx, offset </span>crlfm <span style="color:gray">; &quot;\r\n$&quot;
</span><span style="color:black">SYSINIT:3354                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:3357                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:335A                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:335B                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:335C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:335D                 </span>assume ds:nothing
<span style="color:black">SYSINIT:335D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:335D </span>badparm_p       <span style="color:black">endp
SYSINIT:335D
SYSINIT:335E
SYSINIT:335E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:335E
SYSINIT:335E
SYSINIT:335E </span>getchr          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:335E                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:335F                 </span><span style="color:navy">mov     cx, ds:</span>count
<span style="color:black">SYSINIT:3363                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">nochar
</span><span style="color:black">SYSINIT:3365                 </span><span style="color:navy">mov     si, ds:</span>chrptr
<span style="color:black">SYSINIT:3369                 </span><span style="color:navy">mov     al, es:[si]
</span><span style="color:black">SYSINIT:336C                 </span><span style="color:navy">dec     ds:</span>count
<span style="color:black">SYSINIT:3370                 </span><span style="color:navy">inc     ds:</span>chrptr
<span style="color:black">SYSINIT:3374                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3375
SYSINIT:3375 </span><span style="color:gray">get_ret</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3375                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:3376                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3377 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3377
SYSINIT:3377 </span><span style="color:gray">nochar</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3377                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3378                 </span><span style="color:navy">jmp     short </span><span style="color:gray">get_ret
</span><span style="color:black">SYSINIT:3378 </span>getchr          <span style="color:black">endp
SYSINIT:3378
</span><span style="color:maroon">SYSINIT:337A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:337A
SYSINIT:337A </span>incorrect_order<span style="color:navy">:                        </span>; &#039;incorrect_order&#039; is not used in
<span style="color:maroon">SYSINIT:337A                 </span><span style="color:navy">mov     dx, offset </span>badorder ; MSDOS 6.21 IO.SYS and PCDOS 7.1 IBMBIO.COM
<span style="color:maroon">SYSINIT:337A                                         </span>; (but it was/is not removed)
<span style="color:maroon">SYSINIT:337A                                         </span>; Erdogan Tan - 11/07/2023
<span style="color:maroon">SYSINIT:337D                 </span><span style="color:navy">call    </span>print
<span style="color:maroon">SYSINIT:3380                 </span><span style="color:navy">call    </span>showlinenum
<span style="color:maroon">SYSINIT:3383                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3384
SYSINIT:3384 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3384
SYSINIT:3384
SYSINIT:3384 </span>error_line      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3384                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3385                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3386                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3386                 </span><span style="color:navy">mov     dx, offset </span>errorcmd <span style="color:gray">; &quot;Error in CONFIG.SYS line $&quot;
</span><span style="color:black">SYSINIT:3389                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:338C                 </span><span style="color:navy">call    </span>showlinenum
<span style="color:black">SYSINIT:338F                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:338F </span>error_line      <span style="color:black">endp
SYSINIT:338F
SYSINIT:3390
SYSINIT:3390 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3390
SYSINIT:3390
SYSINIT:3390 </span>showlinenum     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3390                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3391                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3392                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:3393                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3394                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3395                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:3395                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3396                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3397                 </span><span style="color:navy">mov     di, (offset </span>showcount<span style="color:navy">+</span><span style="color:green">4</span><span style="color:navy">) </span>;
<span style="color:black">SYSINIT:3397                                         </span>; di -&gt; the least significant decimal field.
<span style="color:black">SYSINIT:339A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10
</span><span style="color:black">SYSINIT:339D                 </span><span style="color:navy">mov     ax, cs:</span>linecount ; (ds = cs !)
<span style="color:black">SYSINIT:33A1
SYSINIT:33A1 </span><span style="color:gray">sln_loop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33A1                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">10          </span>; &lt; 10 ?
<span style="color:black">SYSINIT:33A4                 </span><span style="color:navy">jb      short </span><span style="color:gray">sln_last  </span>; yes
<span style="color:black">SYSINIT:33A6                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">SYSINIT:33A8                 </span><span style="color:navy">div     cx              </span>; cx = 10
<span style="color:black">SYSINIT:33AA                 </span><span style="color:navy">or      dl, </span><span style="color:green">30h         </span>; convert to ascii numeric char (&quot;0&quot; to &quot;9&quot;)
<span style="color:black">SYSINIT:33AD                 </span><span style="color:navy">mov     [di], dl
</span><span style="color:black">SYSINIT:33AF                 </span><span style="color:navy">dec     di
</span><span style="color:black">SYSINIT:33B0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sln_loop
</span><span style="color:black">SYSINIT:33B2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:33B2
SYSINIT:33B2 </span><span style="color:gray">sln_last</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33B2                 </span><span style="color:navy">or      al, </span><span style="color:green">30h         </span>; convert to ascii numeric char (&quot;0&quot; to &quot;9&quot;)
<span style="color:black">SYSINIT:33B4                 </span><span style="color:navy">mov     [di], al
</span><span style="color:black">SYSINIT:33B6                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">SYSINIT:33B8                 </span><span style="color:navy">call    </span>print           ; show it
<span style="color:black">SYSINIT:33BB                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:33BC                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:33BD                 </span>assume ds:nothing
<span style="color:black">SYSINIT:33BD                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:33BE                 </span>assume es:nothing
<span style="color:black">SYSINIT:33BE                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:33BE </span>showlinenum     <span style="color:black">endp
SYSINIT:33BE
SYSINIT:33BF
SYSINIT:33BF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:33BF
SYSINIT:33BF
SYSINIT:33BF </span>ProcDOS         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33BF                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:33C1                 </span><span style="color:navy">mov     al, cs:</span>result_val_itag ;
<span style="color:black">SYSINIT:33C1                                         </span>; [cs:result_val+_$P_Result_Blk.Item_Tag]
<span style="color:black">SYSINIT:33C1                                         </span>;
<span style="color:black">SYSINIT:33C1                                         </span>; result_val._$P_item_tag
<span style="color:black">SYSINIT:33C1                                         </span>;          = 1 for DOS=HIGH
<span style="color:black">SYSINIT:33C1                                         </span>;          = 2 for DOS=LOW
<span style="color:black">SYSINIT:33C1                                         </span>;          = 3 for DOS=UMB
<span style="color:black">SYSINIT:33C1                                         </span>;          = 4 for DOS=NOUMB
<span style="color:black">SYSINIT:33C5                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:33C6                 </span><span style="color:navy">jz      short </span><span style="color:gray">pd_hi
</span><span style="color:black">SYSINIT:33C8                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:33C9                 </span><span style="color:navy">jz      short </span><span style="color:gray">pd_lo
</span><span style="color:black">SYSINIT:33CB                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:33CC                 </span><span style="color:navy">jz      short </span><span style="color:gray">pd_umb
</span><span style="color:black">SYSINIT:33CE                 </span><span style="color:navy">mov     cs:</span>DevUMB<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:33D4                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:33D5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:33D5
SYSINIT:33D5 </span><span style="color:gray">pd_umb</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33D5                 </span><span style="color:navy">mov     cs:</span>DevUMB<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">SYSINIT:33DB                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:33DC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:33DC
SYSINIT:33DC </span><span style="color:gray">pd_lo</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33DC                 </span><span style="color:navy">mov     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:33E2                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:33E3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:33E3
SYSINIT:33E3 </span><span style="color:gray">pd_hi</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33E3                 </span><span style="color:navy">mov     cs:</span>runhigh<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">SYSINIT:33E9                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:33E9 </span>ProcDOS         <span style="color:black">endp
SYSINIT:33E9
SYSINIT:33EA
SYSINIT:33EA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:33EA
SYSINIT:33EA
SYSINIT:33EA </span>LieInt12Mem     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33EA                 </span><span style="color:navy">mov     ax, cs:</span>ALLOCLIM ; lie INT 12h as alloclim
<span style="color:black">SYSINIT:33EA                                         </span>; assuming that it is 3Com
<span style="color:black">SYSINIT:33EE                 </span><span style="color:navy">call    </span>IsIt3Com        ; Is it 3Com driver?
<span style="color:black">SYSINIT:33F1                 </span><span style="color:navy">jz      short </span><span style="color:gray">lim_set   </span>; yes, lie to him differently
<span style="color:black">SYSINIT:33F3                 </span><span style="color:navy">cmp     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; Is the DD being loaded in UMB
<span style="color:black">SYSINIT:33F9                 </span><span style="color:navy">jz      short </span><span style="color:gray">limx      </span>; no, don&#039;t lie
<span style="color:black">SYSINIT:33FB                 </span><span style="color:navy">mov     ax, cs:</span>DevLoadEnd ; lie INT 12h as end of UMB
<span style="color:black">SYSINIT:33FF
SYSINIT:33FF </span><span style="color:gray">lim_set</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:33FF                 </span><span style="color:navy">call    </span>SetInt12Mem
<span style="color:black">SYSINIT:3402
SYSINIT:3402 </span><span style="color:gray">limx</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3402                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3402 </span>LieInt12Mem     <span style="color:black">endp
SYSINIT:3402
SYSINIT:3403
SYSINIT:3403 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3403
SYSINIT:3403
SYSINIT:3403 </span>SetInt12Mem     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3403                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3404                 </span><span style="color:navy">mov     bx, </span><span style="color:green">40h         </span>; ROMBIOS data area segment
<span style="color:black">SYSINIT:3407                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">SYSINIT:3409                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3409                 </span><span style="color:navy">mov     bx, </span>ds:13h      ; memory size (KB)
<span style="color:black">SYSINIT:340D                 </span><span style="color:navy">mov     cs:</span>OldInt12Mem<span style="color:navy">, bx
</span><span style="color:black">SYSINIT:3412                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">6           </span>; 16*64 = 1024
<span style="color:black">SYSINIT:3414                 </span><span style="color:navy">shr     ax, cl          </span>; convert paragraphs to kilobyte
<span style="color:black">SYSINIT:3416                 </span><span style="color:navy">mov     </span>ds:13h<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3419                 </span><span style="color:navy">mov     cs:</span>Int12Lied<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; mark that we are lying
<span style="color:black">SYSINIT:341F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3420                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3420                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3420 </span>SetInt12Mem     <span style="color:black">endp
SYSINIT:3420
SYSINIT:3421
SYSINIT:3421 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3421
SYSINIT:3421
SYSINIT:3421 </span>TrueInt12Mem    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3421                 </span><span style="color:navy">cmp     cs:</span>Int12Lied<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; were we lying so far?
<span style="color:black">SYSINIT:3427                 </span><span style="color:navy">mov     cs:</span>Int12Lied<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:342D                 </span><span style="color:navy">jz      short </span><span style="color:gray">timx      </span>; yes
<span style="color:black">SYSINIT:342D                                         </span>; no, we weren&#039;t
<span style="color:black">SYSINIT:342F                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3430                 </span><span style="color:navy">mov     ax, </span><span style="color:green">40h
</span><span style="color:black">SYSINIT:3433                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:3435                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3435                 </span><span style="color:navy">mov     ax, cs:</span>OldInt12Mem
<span style="color:black">SYSINIT:3439                 </span><span style="color:navy">mov     </span>ds:13h<span style="color:navy">, ax      </span>; restore INT 12h memory
<span style="color:black">SYSINIT:343C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:343D                 </span>assume ds:nothing
<span style="color:black">SYSINIT:343D
SYSINIT:343D </span><span style="color:gray">timx</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:343D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:343D </span>TrueInt12Mem    <span style="color:black">endp
SYSINIT:343D
SYSINIT:343E
SYSINIT:343E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:343E
SYSINIT:343E
SYSINIT:343E </span>IsIt3Com        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:343E                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:343F                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3440                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:3441                 </span><span style="color:navy">lds     si, cs:</span>DevEntry ; ptr to device header
<span style="color:black">SYSINIT:3446                 </span><span style="color:navy">add     si, </span><span style="color:green">10          </span>; SYSDEV.NAME ; ptr device name
<span style="color:black">SYSINIT:3449                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:344A                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:344B                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:344B                 </span><span style="color:navy">mov     di, offset </span>ThreeComName <span style="color:gray">; &quot;PROTMAN$&quot;
</span><span style="color:black">SYSINIT:344E                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8           </span>; name length
<span style="color:black">SYSINIT:3451                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">SYSINIT:3453                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:3454                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3455                 </span>assume es:nothing
<span style="color:black">SYSINIT:3455                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3456                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3456 </span>IsIt3Com        <span style="color:black">endp
SYSINIT:3456
SYSINIT:3457
SYSINIT:3457 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3457
SYSINIT:3457
SYSINIT:3457 </span>UpdatePDB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3457                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3458                 </span><span style="color:navy">mov     ah, </span><span style="color:green">62h
</span><span style="color:black">SYSINIT:345A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET PSP ADDRESS
<span style="color:black">SYSINIT:345C                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">SYSINIT:345E                 </span><span style="color:navy">mov     bx, cs:</span>ALLOCLIM
<span style="color:black">SYSINIT:3463                 </span><span style="color:navy">mov     ds:</span><span style="color:green">2</span><span style="color:navy">, bx        </span>; [PDB.BLOCK_LEN]
<span style="color:black">SYSINIT:3467                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3468                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3468 </span>UpdatePDB       <span style="color:black">endp
SYSINIT:3468
SYSINIT:3469
SYSINIT:3469 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3469
SYSINIT:3469
SYSINIT:3469 </span>InitVar         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3469                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:346A                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:346B                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:346C                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:346D                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:346E                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:346F                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:346F                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">SYSINIT:3471                 </span><span style="color:navy">mov     es:</span>fUmbTiny<span style="color:navy">, al </span>; Shrink UMBs? (made 1 if /S given)
<span style="color:black">SYSINIT:3475                 </span><span style="color:navy">mov     es:</span>fInHigh<span style="color:navy">, al  </span>; Set to 1 when DH/LH has been called
<span style="color:black">SYSINIT:3479                 </span><span style="color:navy">mov     es:</span>SegLoad<span style="color:navy">, ax  </span>; Load Address (seg), used for DH only
<span style="color:black">SYSINIT:347D                 </span><span style="color:navy">mov     es:</span>UmbLoad<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; UNSPECIFIED
<span style="color:black">SYSINIT:347D                                         </span>; Later is the # of the 1st spec&#039;d UMB
<span style="color:black">SYSINIT:3483                 </span><span style="color:navy">mov     es:</span>fm_argc<span style="color:navy">, al  </span>; Start with zero args having been read
<span style="color:black">SYSINIT:3487                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:3488                 </span><span style="color:navy">mov     cx, </span><span style="color:green">16          </span>; MAXUMB
<span style="color:black">SYSINIT:348B                 </span><span style="color:navy">mov     di, offset </span>UmbUsed ;
<span style="color:black">SYSINIT:348B                                         </span>; For each entry on the UmbUsed array,
<span style="color:black">SYSINIT:348E                 </span><span style="color:navy">rep stosb               </span>; Store 0
<span style="color:black">SYSINIT:3490                 </span><span style="color:navy">mov     cx, </span><span style="color:green">16          </span>; MAXUMB
<span style="color:black">SYSINIT:3493                 </span><span style="color:navy">mov     di, offset </span>UmbSize ; Okay...
<span style="color:black">SYSINIT:3493                                         </span>; for each entry on the UmbSize array,
<span style="color:black">SYSINIT:3496                 </span><span style="color:navy">rep stosw               </span>; Store 0
<span style="color:black">SYSINIT:3498                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3499                 </span>assume es:nothing
<span style="color:black">SYSINIT:3499                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:349A                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:349B                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:349C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:349C </span>InitVar         <span style="color:black">endp
SYSINIT:349C
SYSINIT:349D
SYSINIT:349D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:349D
SYSINIT:349D
SYSINIT:349D </span>FixMem          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:349D                 </span><span style="color:navy">push    ax              </span>; scans the upper memory chain
<span style="color:black">SYSINIT:349D                                         </span>; and concatenates adjacent free MCBs
<span style="color:black">SYSINIT:349E                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:349F                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:34A0                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:34A1                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:34A2                 </span><span style="color:navy">call    </span>fm_link         ; Link in UMBs
<span style="color:black">SYSINIT:34A5                 </span><span style="color:navy">call    </span>UmbHead         ; Get first upper-memory MCB address (0x9FFF)
<span style="color:black">SYSINIT:34A8                 </span><span style="color:navy">jb      short </span><span style="color:gray">fmX       </span>; (if couldn&#039;t get it, leave now).
<span style="color:black">SYSINIT:34AA                 </span><span style="color:navy">mov     es, ax          </span>; It returns in AX, so move it to ES.
<span style="color:black">SYSINIT:34AC                 </span><span style="color:navy">xor     dx, dx          </span>; We&#039;re keeping the address of the last MCB
<span style="color:black">SYSINIT:34AE                 </span><span style="color:navy">mov     cx, dx          </span>; in CX... and the last owner
<span style="color:black">SYSINIT:34B0                 </span><span style="color:navy">inc     dx              </span>; in dx as we go through the loop
<span style="color:black">SYSINIT:34B1
SYSINIT:34B1 </span><span style="color:gray">fm10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:34B1                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0        </span>; [es:ARENA.SIGNATURE]
<span style="color:black">SYSINIT:34B1                                         </span>; if &#039;Z&#039;, don&#039;t repeat loop
<span style="color:black">SYSINIT:34B5                 </span><span style="color:navy">mov     bx, es:</span><span style="color:green">1        </span>; [es:ARENA.OWNER] ; if not zero, do nothing
<span style="color:black">SYSINIT:34BA                 </span><span style="color:navy">or      bx, dx          </span>; dx was owner of previous MCB
<span style="color:black">SYSINIT:34BC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fm30      </span>; If not both zero, don&#039;t cat.
<span style="color:black">SYSINIT:34BE
SYSINIT:34BE </span>fm20<span style="color:navy">:                                   </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:34BE                 </span><span style="color:navy">mov     bx, es:</span><span style="color:green">3        </span>; Grab this block&#039;s Size,
<span style="color:black">SYSINIT:34C3                 </span><span style="color:navy">mov     es, cx          </span>; Go back to prev MCB&#039;s address
<span style="color:black">SYSINIT:34C5                 </span>assume es:nothing
<span style="color:black">SYSINIT:34C5                 </span><span style="color:navy">mov     </span>byte ptr es:0<span style="color:navy">, al </span>; [es:ARENA.SIGNATURE]
<span style="color:black">SYSINIT:34C5                                         </span>; &amp; move the SECOND sig here
<span style="color:black">SYSINIT:34C9                 </span><span style="color:navy">add     bx, </span>word ptr es:3 ; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:34C9                                         </span>; Size += first MCB&#039;s size
<span style="color:black">SYSINIT:34CE                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">1           </span>; And add one for the header
<span style="color:black">SYSINIT:34D1                 </span><span style="color:navy">mov     </span>word ptr es:3<span style="color:navy">, bx </span>; [es:ARENA.SIZE] ; Write the size
<span style="color:black">SYSINIT:34D6
SYSINIT:34D6 </span><span style="color:gray">fm30</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:34D6                 </span><span style="color:navy">mov     cx, es          </span>; Save MCB address
<span style="color:black">SYSINIT:34D8                 </span><span style="color:navy">mov     dx, </span>word ptr es:1 ; [es:ARENA.OWNER] ; And remember its owner
<span style="color:black">SYSINIT:34DD                 </span><span style="color:navy">mov     bx, es          </span>; Move to the next MCB
<span style="color:black">SYSINIT:34DF                 </span><span style="color:navy">add     bx, </span>word ptr es:3 ; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:34E4                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:34E5                 </span><span style="color:navy">mov     es, bx
</span><span style="color:black">SYSINIT:34E7                 </span>assume es:nothing
<span style="color:black">SYSINIT:34E7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; arena_signature_end
<span style="color:black">SYSINIT:34E9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fm10      </span>; If signature != &#039;Z&#039;, there are more.
<span style="color:black">SYSINIT:34EB
SYSINIT:34EB </span><span style="color:gray">fmX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:34EB                 </span><span style="color:navy">call    </span>fm_unlink       ; Unlink UMBs
<span style="color:black">SYSINIT:34EE                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:34EF                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:34F0                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:34F1                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:34F2                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:34F3                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:34F3 </span>FixMem          <span style="color:black">endp
SYSINIT:34F3
SYSINIT:34F4
SYSINIT:34F4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:34F4
SYSINIT:34F4
SYSINIT:34F4 </span>fm_link         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:34F4                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5802h       </span>; DOS_CHECK_UMBLINK
<span style="color:black">SYSINIT:34F7                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:34F7                                         </span>; AL = function code: (DOS 5beta) get UMB link state
<span style="color:black">SYSINIT:34F9                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:34FA                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:34FB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:34FC                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:34FC                 </span><span style="color:navy">mov     es:</span>fm_umb<span style="color:navy">, al   </span>; store current link-state (to use/set later)
<span style="color:black">SYSINIT:3500                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3501                 </span>assume es:nothing
<span style="color:black">SYSINIT:3501                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5803h       </span>; DOS_SET_UMBLINK
<span style="color:black">SYSINIT:3504                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:3507                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:3507                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:3509                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3509 </span>fm_link         <span style="color:black">endp
SYSINIT:3509
SYSINIT:350A
SYSINIT:350A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:350A
SYSINIT:350A
SYSINIT:350A </span>fm_unlink       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:350A                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">SYSINIT:350C                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:350D                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:350E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:350F                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:350F                 </span><span style="color:navy">mov     bl, </span>fm_umb      ; old link-state (to set again)
<span style="color:black">SYSINIT:3513                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3514                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3514                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5803h       </span>; DOS_SET_UMBLINK
<span style="color:black">SYSINIT:3517                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:3517                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:3519                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3519 </span>fm_unlink       <span style="color:black">endp
SYSINIT:3519
SYSINIT:351A
SYSINIT:351A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:351A
SYSINIT:351A
SYSINIT:351A </span>ParseVar        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:351A                 </span><span style="color:navy">push    di              </span>; parses [/S][/L:umb[,size][;umb[,size]]*]
<span style="color:black">SYSINIT:351A                                         </span>;   and builds the table laid out in highvar.inc
<span style="color:black">SYSINIT:351A                                         </span>; ENTRY:
<span style="color:black">SYSINIT:351A                                         </span>;   ES:SI points to command tail of LoadHigh/DeviceHigh
<span style="color:black">SYSINIT:351A                                         </span>;       (whitespace ok)
<span style="color:black">SYSINIT:351A                                         </span>; EXIT:
<span style="color:black">SYSINIT:351A                                         </span>;   ES:SI points to first character in child program name
<span style="color:black">SYSINIT:351B                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:351C                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:351D                 </span><span style="color:navy">push    es              </span>; Make DS:SI point to it, as well as ES:SI
<span style="color:black">SYSINIT:351E                 </span><span style="color:navy">pop     ds              </span>; (regardless if we&#039;re in devhigh or loadhigh)
<span style="color:black">SYSINIT:351F                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:3520
SYSINIT:3520 </span><span style="color:gray">pv10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3520                 </span><span style="color:navy">lodsb                   </span>; here, ES:SI==&quot;  /L...&quot;--must eat whitespace
<span style="color:black">SYSINIT:3521                 </span><span style="color:navy">call    </span>isWhite
<span style="color:black">SYSINIT:3524                 </span><span style="color:navy">jz      short </span><span style="color:gray">pv10      </span>; ES:SI==&quot; /L...&quot;--keep eating.
<span style="color:black">SYSINIT:3526                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; SWTCH ; ES:SI==&quot;/L...&quot;--go process a switch
<span style="color:black">SYSINIT:3528                 </span><span style="color:navy">jz      short </span><span style="color:gray">pv20
</span><span style="color:black">SYSINIT:352A                 </span><span style="color:navy">dec     si              </span>; Backup--it&#039;s now &quot;odule options&quot;, and we need
<span style="color:black">SYSINIT:352B                 </span><span style="color:navy">clc                     </span>; that &quot;m&quot; we just read (or whatever it is).
<span style="color:black">SYSINIT:352C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">pvX       </span>; Then return with carry clear == we&#039;re done.
<span style="color:black">SYSINIT:352E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:352E
SYSINIT:352E </span><span style="color:gray">pv20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:352E                 </span><span style="color:navy">lodsb                   </span>; Just read &#039;S&#039; or &#039;L&#039;, hopefully
<span style="color:black">SYSINIT:352F                 </span><span style="color:navy">and     al, </span><span style="color:green">0DFh        </span>; So we make it upper-case, and...
<span style="color:black">SYSINIT:3531                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">53h </span><span style="color:gray">; &#039;S&#039;   </span>; just read &#039;S&#039;?
<span style="color:black">SYSINIT:3533                 </span><span style="color:navy">jnz     short </span><span style="color:gray">pv30
</span><span style="color:black">SYSINIT:3535                 </span><span style="color:navy">call    </span>incArgc         ; If it&#039;s /S, it&#039;s another arg for LH to skip.
<span style="color:black">SYSINIT:3535                                         </span>;
<span style="color:black">SYSINIT:3535                                         </span>; Note: &#039;inc byte [cs:fm_argc]&#039; would be enough here
<span style="color:black">SYSINIT:3535                                         </span>; Erdogan Tan - 19/04/2019 (Retro DOS v4) - 11/07/2023
<span style="color:black">SYSINIT:3538                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3539                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:353A                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:353B                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:353B                 </span><span style="color:navy">mov     es:</span>fUmbTiny<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; /S, so ES:SI==&quot;  /L...&quot; or &quot; module opts&quot;, or
<span style="color:black">SYSINIT:3541                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3542                 </span>assume es:nothing
<span style="color:black">SYSINIT:3542                 </span><span style="color:navy">jmp     short </span><span style="color:gray">pv10      </span>; possibly even &quot;/L...&quot;.
<span style="color:black">SYSINIT:3544 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3544
SYSINIT:3544 </span><span style="color:gray">pv30</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3544                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Ch </span><span style="color:gray">; &#039;L&#039;   </span>; If it&#039;s not &#039;L&#039; either, then it&#039;s a bad switch!
<span style="color:black">SYSINIT:3546                 </span><span style="color:navy">jnz     short </span><span style="color:gray">pvE1
</span><span style="color:black">SYSINIT:3548                 </span><span style="color:navy">call    </span>incArgc
<span style="color:black">SYSINIT:354B                 </span><span style="color:navy">call    </span>parseL
<span style="color:black">SYSINIT:354E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">pv10      </span>; If no carry, go back and look for more
<span style="color:black">SYSINIT:3550                 </span><span style="color:navy">dec     si              </span>; Else, back up and exit.
<span style="color:black">SYSINIT:3551                 </span><span style="color:navy">jmp     short </span><span style="color:gray">pvErr
</span><span style="color:black">SYSINIT:3553 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3553
SYSINIT:3553 </span><span style="color:gray">pvE1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3553                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; PV_InvSwt ; Unrecognized switch passed
<span style="color:black">SYSINIT:3556
SYSINIT:3556 </span><span style="color:gray">pvErr</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3556                 </span><span style="color:navy">dec     si
</span><span style="color:black">SYSINIT:3557                 </span><span style="color:navy">dec     si
</span><span style="color:black">SYSINIT:3558                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3559
SYSINIT:3559 </span><span style="color:gray">pvX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3559                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:355A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:355B                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:355C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:355C </span>ParseVar        <span style="color:black">endp
SYSINIT:355C
SYSINIT:355D
SYSINIT:355D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:355D
SYSINIT:355D
SYSINIT:355D </span>parseL          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:355D                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:355E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;   </span>; Make sure they did /L:
<span style="color:black">SYSINIT:3560                 </span><span style="color:navy">jnz     short </span><span style="color:gray">plE1      </span>; If they didn&#039;t, return with carry set.
<span style="color:black">SYSINIT:3562
SYSINIT:3562 </span><span style="color:gray">pl10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3562                 </span><span style="color:navy">call    </span>GetXNum         ; After this, it&#039;s &quot;,size&quot; or &quot;;umb&quot; or &quot; mod&quot;
<span style="color:black">SYSINIT:3565                 </span><span style="color:navy">jb      short </span><span style="color:gray">plE2      </span>; And error if it&#039;s a bad number.
<span style="color:black">SYSINIT:3567                 </span><span style="color:navy">call    </span>convUMB         ; Convert any address to a UMB number
<span style="color:black">SYSINIT:356A                 </span><span style="color:navy">mov     cl, al          </span>; Remember the UMB number
<span style="color:black">SYSINIT:356C                 </span><span style="color:navy">call    </span>stowUMB         ; Mark this UMB # as used;
<span style="color:black">SYSINIT:356F                 </span><span style="color:navy">jb      short </span><span style="color:gray">plE2      </span>; If it was already marked, it&#039;ll error
<span style="color:black">SYSINIT:3571                 </span><span style="color:navy">call    </span>incArgc         ; Each UMB number is another arg for LH to skip
<span style="color:black">SYSINIT:3571                                         </span>; (&#039;inc byte [cs:fm_argc]&#039; would be enough)
<span style="color:black">SYSINIT:3571                                         </span>; Erdogan Tan - 08/04/2019 (Retro DOS v4) - 11/07/2023
<span style="color:black">SYSINIT:3574                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:3575                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Bh </span><span style="color:gray">; &#039;;&#039;   </span>; Did &quot;umb;&quot; ?
<span style="color:black">SYSINIT:3577                 </span><span style="color:navy">jz      short </span><span style="color:gray">pl10      </span>; Yep: go back and get another UMB.
<span style="color:black">SYSINIT:3579                 </span><span style="color:navy">call    </span>isWhite         ; Did &quot;umb &quot; ?
<span style="color:black">SYSINIT:357C                 </span><span style="color:navy">jz      short </span><span style="color:gray">plX       </span>; Yep: return (it&#039;ll go back to whitespace)
<span style="color:black">SYSINIT:357E                 </span><span style="color:navy">call    </span>isEOL           ; Did &quot;umb&quot; ?
<span style="color:black">SYSINIT:3581                 </span><span style="color:navy">jz      short </span><span style="color:gray">plSwX     </span>; If so, backup and exit like everything&#039;s ok
<span style="color:black">SYSINIT:3583                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; Did &quot;umb/&quot; ? (as in, &quot;/L:1,100;2/S&quot;)
<span style="color:black">SYSINIT:3585                 </span><span style="color:navy">jz      short </span><span style="color:gray">plSwX     </span>; If so, back up ES:SI one character and return
<span style="color:black">SYSINIT:3587                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Ch </span><span style="color:gray">; &#039;,&#039;   </span>; Did &quot;umb,&quot; ?
<span style="color:black">SYSINIT:3589                 </span><span style="color:navy">jnz     short </span><span style="color:gray">plE1      </span>; Just what the heck DID they do? Return error.
<span style="color:black">SYSINIT:358B                 </span><span style="color:navy">call    </span>GetXNum         ; Stop on &quot;size;&quot; or &quot;size &quot; or anything else
<span style="color:black">SYSINIT:358E                 </span><span style="color:navy">jb      short </span><span style="color:gray">plE1      </span>; And error if it&#039;s a bad size.
<span style="color:black">SYSINIT:3590                 </span><span style="color:navy">call    </span>toPara          ; Convert from bytes to paragraphs
<span style="color:black">SYSINIT:3593                 </span><span style="color:navy">call    </span>stowSiz         ; CL still has the UMB number for this routine
<span style="color:black">SYSINIT:3596                 </span><span style="color:navy">call    </span>incArgc         ; Each UMB size is another arg for LH to skip
<span style="color:black">SYSINIT:3596                                         </span>; (&#039;inc byte [cs:fm_argc]&#039;)
<span style="color:black">SYSINIT:3599                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:359A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Bh </span><span style="color:gray">; &#039;;&#039;   </span>; They did &quot;umb,size;&quot;, so get another UMB.
<span style="color:black">SYSINIT:359C                 </span><span style="color:navy">jz      short </span><span style="color:gray">pl10
</span><span style="color:black">SYSINIT:359E                 </span><span style="color:navy">call    </span>isWhite         ; Did it end with whitespace?
<span style="color:black">SYSINIT:35A1                 </span><span style="color:navy">jz      short </span><span style="color:gray">plX       </span>; If so, we&#039;re done here--go back.
<span style="color:black">SYSINIT:35A3                 </span><span style="color:navy">call    </span>isEOL           ; Did they do &quot;umb,size&quot; and end??? (stupid)
<span style="color:black">SYSINIT:35A6                 </span><span style="color:navy">jz      short </span><span style="color:gray">plSwX     </span>; If so, backup and exit like everything&#039;s ok
<span style="color:black">SYSINIT:35A8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; SWTCH ; Did they do &quot;umb,size/&quot; ?
<span style="color:black">SYSINIT:35AA                 </span><span style="color:navy">jz      short </span><span style="color:gray">plSwX     </span>; If so, again, we&#039;re done here.
<span style="color:black">SYSINIT:35AC
SYSINIT:35AC </span><span style="color:gray">plE1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35AC                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1           </span>; PV_InvArg ; If not, we don&#039;t know WHAT they did.
<span style="color:black">SYSINIT:35AF                 </span><span style="color:navy">dec     si
</span><span style="color:black">SYSINIT:35B0                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:35B1                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:35B2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:35B2
SYSINIT:35B2 </span><span style="color:gray">plE2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35B2                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; In this case, they&#039;ve specified a UMB twice
<span style="color:black">SYSINIT:35B5                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:35B6                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:35B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:35B7
SYSINIT:35B7 </span><span style="color:gray">plSwX</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35B7                 </span><span style="color:navy">dec     si              </span>; If we hit a &#039;/&#039; character, back up one char
<span style="color:black">SYSINIT:35B7                                         </span>; so the whitespace checker will see it too.
<span style="color:black">SYSINIT:35B8
SYSINIT:35B8 </span><span style="color:gray">plX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35B8                 </span><span style="color:navy">clc                     </span>; Then just return with carry clear, so
<span style="color:black">SYSINIT:35B8                                         </span>; ParseVar will go about its business.
<span style="color:black">SYSINIT:35B9                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:35B9 </span>parseL          <span style="color:black">endp
SYSINIT:35B9
SYSINIT:35BA
SYSINIT:35BA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:35BA
SYSINIT:35BA
SYSINIT:35BA </span>incArgc         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35BA                 </span><span style="color:navy">push    ax              </span>; increments fm_argc,
<span style="color:black">SYSINIT:35BA                                         </span>; for use with LoadHigh command-line parsing
<span style="color:black">SYSINIT:35BA                                         </span>; ***
<span style="color:black">SYSINIT:35BA                                         </span>; (&#039;inc byte [cs:fm_argc]&#039; would be enough)
<span style="color:black">SYSINIT:35BA                                         </span>; Erdogan Tan - 11/07/2023
<span style="color:black">SYSINIT:35BB                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:35BC                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:35BD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:35BE                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:35BE                 </span><span style="color:navy">mov     al, </span>fm_argc     ; Obtain previous value of fm_argc,
<span style="color:black">SYSINIT:35C1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:35C2                 </span>assume ds:nothing
<span style="color:black">SYSINIT:35C2                 </span><span style="color:navy">inc     al              </span>; Increment it,
<span style="color:black">SYSINIT:35C4                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:35C5                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:35C6                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:35C7                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:35C7                 </span><span style="color:navy">mov     es:</span>fm_argc<span style="color:navy">, al  </span>; And store it right back.
<span style="color:black">SYSINIT:35CB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:35CC                 </span>assume es:nothing
<span style="color:black">SYSINIT:35CC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:35CD                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:35CD </span>incArgc         <span style="color:black">endp
SYSINIT:35CD
SYSINIT:35CE
SYSINIT:35CE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:35CE
SYSINIT:35CE
SYSINIT:35CE </span>isEOL           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35CE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; Null-terminator
<span style="color:black">SYSINIT:35D0                 </span><span style="color:navy">jz      short </span><span style="color:gray">ieX
</span><span style="color:black">SYSINIT:35D2                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; CR ; Carriage Return
<span style="color:black">SYSINIT:35D4                 </span><span style="color:navy">jz      short </span><span style="color:gray">ieX
</span><span style="color:black">SYSINIT:35D6                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; LF ; LineFeed
<span style="color:black">SYSINIT:35D8
SYSINIT:35D8 </span><span style="color:gray">ieX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35D8                 </span><span style="color:navy">retn                    </span>; zf=1 if AL contains EOL character
<span style="color:black">SYSINIT:35D8 </span>isEOL           <span style="color:black">endp
SYSINIT:35D8
SYSINIT:35D9
SYSINIT:35D9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:35D9
SYSINIT:35D9
SYSINIT:35D9 </span>isWhite         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35D9                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; Space
<span style="color:black">SYSINIT:35DB                 </span><span style="color:navy">jz      short </span><span style="color:gray">iwX
</span><span style="color:black">SYSINIT:35DD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Dh </span><span style="color:gray">; &#039;=&#039;   </span>; Equals (treat as whitespace)
<span style="color:black">SYSINIT:35DF                 </span><span style="color:navy">jz      short </span><span style="color:gray">iwX
</span><span style="color:black">SYSINIT:35E1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; Tab
<span style="color:black">SYSINIT:35E3
SYSINIT:35E3 </span><span style="color:gray">iwX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35E3                 </span><span style="color:navy">retn                    </span>; zf=1 if AL contains space,
<span style="color:black">SYSINIT:35E3 </span>isWhite         <span style="color:black">endp                    </span>;         tab or equals character
<span style="color:black">SYSINIT:35E3
SYSINIT:35E4
SYSINIT:35E4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:35E4
SYSINIT:35E4
SYSINIT:35E4 </span>unMarkUMB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:35E4                 </span><span style="color:navy">push    ax              </span>; marks a given UMB as unused
<span style="color:black">SYSINIT:35E4                                         </span>; AL contains UMB number
<span style="color:black">SYSINIT:35E5                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:35E6                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:35E7                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:35E8                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:35E9                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:35EA                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:35EA                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:35EC                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">SYSINIT:35EE                 </span><span style="color:navy">mov     es:</span>UmbUsed<span style="color:navy">[bx], </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:35F4                 </span><span style="color:navy">cmp     es:</span>UmbLoad<span style="color:navy">, al
</span><span style="color:black">SYSINIT:35F9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">umu10     </span>; If unmarked the load UMB,
<span style="color:black">SYSINIT:35F9                                         </span>; load into convent.
<span style="color:black">SYSINIT:35FB                 </span><span style="color:navy">mov     es:</span>UmbLoad<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3601
SYSINIT:3601 </span><span style="color:gray">umu10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3601                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3602                 </span>assume es:nothing
<span style="color:black">SYSINIT:3602                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:3603                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3604                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3605                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3605 </span>unMarkUMB       <span style="color:black">endp
SYSINIT:3605
SYSINIT:3606
SYSINIT:3606 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3606
SYSINIT:3606
SYSINIT:3606 </span>stowUMB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3606                 </span><span style="color:navy">cmp     al, </span><span style="color:green">16          </span>; MAXUMB
<span style="color:black">SYSINIT:3608                 </span><span style="color:navy">jb      short </span><span style="color:gray">su10
</span><span style="color:black">SYSINIT:360A                 </span><span style="color:navy">stc                     </span>; Ooops-- UMB # &gt;= MAXUMB
<span style="color:black">SYSINIT:360B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:360C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:360C
SYSINIT:360C </span><span style="color:gray">su10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:360C                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:360D                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:360E                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:360F                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3610                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3611                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3612                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3613                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:3613                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3614                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3615                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3615                 </span><span style="color:navy">cmp     </span>UmbLoad<span style="color:navy">, </span><span style="color:#ff8000">0FFh   </span>; UNSPECIFIED
<span style="color:black">SYSINIT:3615                                         </span>; If this, we haven&#039;t been here before
<span style="color:black">SYSINIT:361A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">su20
</span><span style="color:black">SYSINIT:361C                 </span><span style="color:navy">mov     </span>UmbLoad<span style="color:navy">, al     </span>; So remember this UMB as the load UMB slot.
<span style="color:black">SYSINIT:361F
SYSINIT:361F </span><span style="color:gray">su20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:361F                 </span><span style="color:navy">or      al, al          </span>; If they gave UMB 0, there&#039;s really nothing
<span style="color:black">SYSINIT:3621                 </span><span style="color:navy">jz      short </span><span style="color:gray">su30      </span>; that we should do here.
<span style="color:black">SYSINIT:3623                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">SYSINIT:3625                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">SYSINIT:3627                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1           </span>; Now, AX = 1, and BX = UMB Number
<span style="color:black">SYSINIT:362A                 </span><span style="color:navy">xchg    al, es:</span>UmbUsed<span style="color:navy">[bx]
</span><span style="color:black">SYSINIT:362F                 </span><span style="color:navy">or      al, al          </span>; If it was already 1,
<span style="color:black">SYSINIT:362F                                         </span>; then al==1... and that means an error.
<span style="color:black">SYSINIT:3631                 </span><span style="color:navy">jz      short </span><span style="color:gray">su30
</span><span style="color:black">SYSINIT:3633                 </span><span style="color:navy">stc                     </span>; OOOPS! This one&#039;s been used before. :(
<span style="color:black">SYSINIT:3634
SYSINIT:3634 </span><span style="color:gray">su30</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3634                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3635                 </span>assume es:nothing
<span style="color:black">SYSINIT:3635                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3636                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3636                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:3637                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:3638                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3639                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3639 </span>stowUMB         <span style="color:black">endp
SYSINIT:3639
SYSINIT:363A
SYSINIT:363A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:363A
SYSINIT:363A
SYSINIT:363A </span>stowSiz         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:363A                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:363B                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:363C                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:363D                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:363E                 </span><span style="color:navy">pop     es              </span>; mov [cs:bx+UmbSize],ax !!! ; 08/09/2023
<span style="color:black">SYSINIT:363F                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:363F                 </span><span style="color:navy">mov     bl, cl          </span>; Now bl==UMB number, AX==size
<span style="color:black">SYSINIT:3641                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">0           </span>; bx==UMB number, AX==size
<span style="color:black">SYSINIT:3643                 </span><span style="color:navy">shl     bl, </span><span style="color:green">1           </span>; bx==offset into array
<span style="color:black">SYSINIT:3645                 </span><span style="color:navy">mov     es:</span>UmbSize<span style="color:navy">[bx], ax </span>; Store the size
<span style="color:black">SYSINIT:364A                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:364B                 </span>assume es:nothing
<span style="color:black">SYSINIT:364B                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:364C                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:364D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:364D </span>stowSiz         <span style="color:black">endp
SYSINIT:364D
SYSINIT:364D </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:364E </span>gnradix         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:364E                                         </span>; Must be a word--16x16 multiplication
<span style="color:black">SYSINIT:3650
SYSINIT:3650 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3650
SYSINIT:3650
SYSINIT:3650 </span>toDigit         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3650                 </span><span style="color:navy">cmp     cs:</span>gnradix<span style="color:navy">, </span><span style="color:#ff8000">10h
</span><span style="color:black">SYSINIT:3656                 </span><span style="color:navy">jnz     short </span><span style="color:gray">td10      </span>; Don&#039;t check hex digits if radix isn&#039;t 16
<span style="color:black">SYSINIT:3658                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">61h </span><span style="color:gray">; &#039;a&#039;
</span><span style="color:black">SYSINIT:365B                 </span><span style="color:navy">jb      short </span><span style="color:gray">td20
</span><span style="color:black">SYSINIT:365D                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">66h </span><span style="color:gray">; &#039;f&#039;
</span><span style="color:black">SYSINIT:3660                 </span><span style="color:navy">ja      short </span><span style="color:gray">tdE       </span>; Nothing valid above &#039;f&#039; at all...
<span style="color:black">SYSINIT:3662                 </span><span style="color:navy">sub     cl, </span><span style="color:green">57h         </span>; &#039;a&#039;-10 ; 87 ; Make &#039;a&#039;==10 and return.
<span style="color:black">SYSINIT:3665                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3666 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3666
SYSINIT:3666 </span><span style="color:gray">td20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3666                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;   </span>; Below &#039;A&#039;? Not a letter...
<span style="color:black">SYSINIT:3669                 </span><span style="color:navy">jb      short </span><span style="color:gray">td10
</span><span style="color:black">SYSINIT:366B                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">46h </span><span style="color:gray">; &#039;F&#039;   </span>; Above &#039;F&#039;? Not a digit.
<span style="color:black">SYSINIT:366E                 </span><span style="color:navy">ja      short </span><span style="color:gray">tdE
</span><span style="color:black">SYSINIT:3670                 </span><span style="color:navy">sub     cl, </span><span style="color:green">37h         </span>; &#039;A&#039;-10 ; 55 ; Make &#039;A&#039;==10 and return.
<span style="color:black">SYSINIT:3673                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3674 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3674
SYSINIT:3674 </span><span style="color:gray">td10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3674                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; If less than zero,
<span style="color:black">SYSINIT:3677                 </span><span style="color:navy">jb      short </span><span style="color:gray">tdE       </span>; Done.
<span style="color:black">SYSINIT:3679                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">39h </span><span style="color:gray">; &#039;9&#039;   </span>; Or, if greater than nine,
<span style="color:black">SYSINIT:367C                 </span><span style="color:navy">ja      short </span><span style="color:gray">tdE       </span>; Done.
<span style="color:black">SYSINIT:367E                 </span><span style="color:navy">sub     cl, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; Okay--make &#039;0&#039;==0 and return.
<span style="color:black">SYSINIT:3681                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3682 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3682
SYSINIT:3682 </span><span style="color:gray">tdE</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3682                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3683                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3683 </span>toDigit         <span style="color:black">endp
SYSINIT:3683
SYSINIT:3684
SYSINIT:3684 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3684
SYSINIT:3684
SYSINIT:3684 </span>GetXNum         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3684                 </span><span style="color:navy">push    bx              </span>; reads a 32-bit ASCII number at ES:SI
<span style="color:black">SYSINIT:3684                                         </span>; and returns it in DX:AX
<span style="color:black">SYSINIT:3685                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:3686                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3687                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:3688                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:368A                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">SYSINIT:368C                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:368E                 </span><span style="color:navy">xor     dx, dx          </span>; Start with 0 (makes sense)
<span style="color:black">SYSINIT:3690                 </span><span style="color:navy">mov     cs:</span>gnradix<span style="color:navy">, </span><span style="color:green">10  </span>; And default to a radix of 10 (dec)
<span style="color:black">SYSINIT:3697                 </span><span style="color:navy">mov     cl, es:[si]
</span><span style="color:black">SYSINIT:369A                 </span><span style="color:navy">call    </span>toDigit
<span style="color:black">SYSINIT:369D                 </span><span style="color:navy">jb      short </span><span style="color:gray">gxnE      </span>; If it&#039;s not a digit, leave now.
<span style="color:black">SYSINIT:369F                 </span><span style="color:navy">or      cl, cl
</span><span style="color:black">SYSINIT:36A1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gxn20     </span>; Doesn&#039;t have &#039;0x&#039;
<span style="color:black">SYSINIT:36A3                 </span><span style="color:navy">mov     cl, es:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:36A7                 </span><span style="color:navy">cmp     cl, &#039;</span><span style="color:green">x&#039;         </span>; Either &#039;x&#039;...
<span style="color:black">SYSINIT:36AA                 </span><span style="color:navy">jz      short </span><span style="color:gray">gxn10
</span><span style="color:black">SYSINIT:36AC                 </span><span style="color:navy">cmp     cl, &#039;</span><span style="color:green">X&#039;
</span><span style="color:black">SYSINIT:36AF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gxn20
</span><span style="color:black">SYSINIT:36B1
SYSINIT:36B1 </span><span style="color:gray">gxn10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36B1                 </span><span style="color:navy">mov     cs:</span>gnradix<span style="color:navy">, </span><span style="color:green">16
</span><span style="color:black">SYSINIT:36B8                 </span><span style="color:navy">inc     si              </span>; Since we read &quot;0x&quot;, march over it.
<span style="color:black">SYSINIT:36B9                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:36BA
SYSINIT:36BA </span><span style="color:gray">gxn20</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36BA                 </span><span style="color:navy">mov     cl, es:[si]     </span>; Now DX:AX=current total, CH=0/CL=char
<span style="color:black">SYSINIT:36BD                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:36BE                 </span><span style="color:navy">call    </span>toDigit         ; Accepts only valid digits, A-F -&gt; 10-16
<span style="color:black">SYSINIT:36C1                 </span><span style="color:navy">jb      short </span><span style="color:gray">gxnQ      </span>; &lt;- Ah... wasn&#039;t a digit. Stop.
<span style="color:black">SYSINIT:36C3                 </span><span style="color:navy">call    </span>mul32
<span style="color:black">SYSINIT:36C6                 </span><span style="color:navy">jb      short </span><span style="color:gray">gxnX
</span><span style="color:black">SYSINIT:36C8                 </span><span style="color:navy">add     ax, cx
</span><span style="color:black">SYSINIT:36CA                 </span><span style="color:navy">adc     dx, bx
</span><span style="color:black">SYSINIT:36CC                 </span><span style="color:navy">jb      short </span><span style="color:gray">gxnX
</span><span style="color:black">SYSINIT:36CE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">gxn20
</span><span style="color:black">SYSINIT:36D0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:36D0
SYSINIT:36D0 </span><span style="color:gray">gxnE</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36D0                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:36D1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">gxnX
</span><span style="color:black">SYSINIT:36D3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:36D3
SYSINIT:36D3 </span><span style="color:gray">gxnQ</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36D3                 </span><span style="color:navy">dec     si
</span><span style="color:black">SYSINIT:36D4                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:36D5
SYSINIT:36D5 </span><span style="color:gray">gxnX</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36D5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:36D6                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:36D7                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:36D8                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:36D8 </span>GetXNum         <span style="color:black">endp
SYSINIT:36D8
SYSINIT:36D9
SYSINIT:36D9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:36D9
SYSINIT:36D9
SYSINIT:36D9 </span>mul32           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36D9                 </span><span style="color:navy">push    ax              </span>; multiplies the number in DX:AX by gnradix
<span style="color:black">SYSINIT:36D9                                         </span>; DX=old:hi, AX=old:lo, TOS=old:lo, BX=0
<span style="color:black">SYSINIT:36DA                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">SYSINIT:36DC                 </span><span style="color:navy">mul     cs:</span>gnradix      ; DX=?, AX=new:hi, TOS=old:lo, BX=0
<span style="color:black">SYSINIT:36E1                 </span><span style="color:navy">jb      short </span><span style="color:gray">m32E      </span>; Too big?
<span style="color:black">SYSINIT:36E3                 </span><span style="color:navy">mov     dx, ax          </span>; DX=new:hi, AX=new:hi, TOS=old:lo, BX=0
<span style="color:black">SYSINIT:36E5                 </span><span style="color:navy">pop     ax              </span>; DX=new:hi, AX=old:lo, TOS=orig, BX=0
<span style="color:black">SYSINIT:36E6                 </span><span style="color:navy">xchg    dx, bx          </span>; DX=0, AX=old:lo, TOS=orig, BX=new:hi
<span style="color:black">SYSINIT:36E8                 </span><span style="color:navy">mul     cs:</span>gnradix      ; DX=carry, AX=new:lo, TOS=orig, BX=new:hi
<span style="color:black">SYSINIT:36ED                 </span><span style="color:navy">xchg    dx, bx
</span><span style="color:black">SYSINIT:36EF                 </span><span style="color:navy">add     dx, bx          </span>; DX=new:hi, AX=new:lo, TOS=orig, BX=carry
<span style="color:black">SYSINIT:36F1                 </span><span style="color:navy">xor     bx, bx          </span>; BX=0
<span style="color:black">SYSINIT:36F3                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:36F4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:36F4
SYSINIT:36F4 </span><span style="color:gray">m32E</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36F4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:36F5                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:36F5 </span>mul32           <span style="color:black">endp
SYSINIT:36F5
SYSINIT:36F6
SYSINIT:36F6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:36F6
SYSINIT:36F6
SYSINIT:36F6 </span>toPara          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:36F6                 </span><span style="color:navy">push    cx              </span>; divides DX:AX by 16; result in AX only
<span style="color:black">SYSINIT:36F7                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; DX:AX=HHHH hhhh hhhh hhhh:LLLL llll llll llll
<span style="color:black">SYSINIT:36F9                 </span><span style="color:navy">shr     ax, cl          </span>; DX:AX=HHHH hhhh hhhh hhhh:0000 LLLL llll llll
<span style="color:black">SYSINIT:36FB                 </span><span style="color:navy">xchg    ax, dx          </span>; DX:AX=0000 LLLL llll llll:HHHH hhhh hhhh hhhh
<span style="color:black">SYSINIT:36FC                 </span><span style="color:navy">mov     cl, </span><span style="color:green">12
</span><span style="color:black">SYSINIT:36FE                 </span><span style="color:navy">shl     ax, cl          </span>; DX:AX=0000 LLLL llll llll:hhhh 0000 0000 0000
<span style="color:black">SYSINIT:3700                 </span><span style="color:navy">or      ax, dx          </span>; AX=hhhh LLLL llll llll
<span style="color:black">SYSINIT:3702                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:3703                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3703 </span>toPara          <span style="color:black">endp
SYSINIT:3703
SYSINIT:3704
SYSINIT:3704 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3704
SYSINIT:3704
SYSINIT:3704 </span>UmbHead         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3704                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:3705                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3706                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3707                 </span><span style="color:navy">mov     ah, </span><span style="color:green">52h         </span>; GET_IN_VARS
<span style="color:black">SYSINIT:3709                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - GET LIST OF LISTS
<span style="color:black">SYSINIT:3709                                         </span>; Return: ES:BX -&gt; DOS list of lists
<span style="color:black">SYSINIT:370B                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">8Ch      </span>; [es:DOS_UMB_HEAD]
<span style="color:black">SYSINIT:370F                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:3712                 </span><span style="color:navy">jz      short </span><span style="color:gray">uhE
</span><span style="color:black">SYSINIT:3714                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3715                 </span><span style="color:navy">jmp     short </span><span style="color:gray">uhX
</span><span style="color:black">SYSINIT:3717 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3717
SYSINIT:3717 </span><span style="color:gray">uhE</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3717                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3718
SYSINIT:3718 </span><span style="color:gray">uhX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3718                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3719                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:371A                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:371B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:371B </span>UmbHead         <span style="color:black">endp
SYSINIT:371B
SYSINIT:371C
SYSINIT:371C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:371C
SYSINIT:371C
SYSINIT:371C </span>isSysMCB        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:371C                 </span><span style="color:navy">push    ax              </span>; sets ZF if ES points to an MCB owned by &quot;SC&quot;
<span style="color:black">SYSINIT:371D                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">1        </span>; [es:ARENA.OWNER]
<span style="color:black">SYSINIT:3721                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">8           </span>; SystemPSPOwner ; 8 (for US or Japan) is valid
<span style="color:black">SYSINIT:3724                 </span><span style="color:navy">jz      short </span><span style="color:gray">ism10
</span><span style="color:black">SYSINIT:3726                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">9           </span>; JapanPSPOwner ; 9 (for Japan) is valid
<span style="color:black">SYSINIT:3729                 </span><span style="color:navy">jz      short </span><span style="color:gray">ism10
</span><span style="color:black">SYSINIT:372B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ismX
</span><span style="color:black">SYSINIT:372D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:372D
SYSINIT:372D </span><span style="color:gray">ism10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:372D                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">8        </span>; [es:ARENA.NAME]
<span style="color:black">SYSINIT:3731                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4353h       </span>; &#039;SC&#039;
<span style="color:black">SYSINIT:3734
SYSINIT:3734 </span><span style="color:gray">ismX</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3734                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3735                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3735 </span>isSysMCB        <span style="color:black">endp
SYSINIT:3735
SYSINIT:3736
SYSINIT:3736 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3736
SYSINIT:3736
SYSINIT:3736 </span>AddrToUmb       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3736                 </span><span style="color:navy">push    cx              </span>; converts a segment address in AX
<span style="color:black">SYSINIT:3736                                         </span>; to its appropriate UMB number
<span style="color:black">SYSINIT:3737                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:3738                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3739                 </span><span style="color:navy">mov     dx, ax          </span>; DX = address to search for
<span style="color:black">SYSINIT:373B                 </span><span style="color:navy">call    </span>UmbHead         ; AX = first segment
<span style="color:black">SYSINIT:373E                 </span><span style="color:navy">jb      short </span><span style="color:gray">atuE      </span>; If it couldn&#039;t get it, error out
<span style="color:black">SYSINIT:3740                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3742                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">SYSINIT:3744
SYSINIT:3744 </span><span style="color:gray">atu10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3744                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:3746                 </span><span style="color:navy">cmp     ax, dx          </span>; Present segment &gt;= given segment?
<span style="color:black">SYSINIT:3748                 </span><span style="color:navy">jnb     short </span><span style="color:gray">atuX      </span>; yes, done.
<span style="color:black">SYSINIT:374A                 </span><span style="color:navy">call    </span>isSysMCB        ; Returns with ZF set if this is a system MCB
<span style="color:black">SYSINIT:374D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">atu20
</span><span style="color:black">SYSINIT:374F                 </span><span style="color:navy">inc     cx              </span>; If it _was_ a system MCB, we&#039;re in a new UMB.
<span style="color:black">SYSINIT:3750
SYSINIT:3750 </span><span style="color:gray">atu20</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3750                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0        </span>; [es:ARENA.SIGNATURE]
<span style="color:black">SYSINIT:3754                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">SYSINIT:3756                 </span><span style="color:navy">jz      short </span><span style="color:gray">atu30     </span>; &#039;Z&#039; means this was the last MCB... that&#039;s it.
<span style="color:black">SYSINIT:3758                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:375A                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:375F                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3760                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3762                 </span><span style="color:navy">jmp     short </span><span style="color:gray">atu10
</span><span style="color:black">SYSINIT:3764 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3764
SYSINIT:3764 </span><span style="color:gray">atu30</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3764                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:3766                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:376B                 </span><span style="color:navy">cmp     ax, dx          </span>; Present &gt;= given?
<span style="color:black">SYSINIT:376D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">atuX      </span>; Yep! It _was_ inside.
<span style="color:black">SYSINIT:376F
SYSINIT:376F </span><span style="color:gray">atuE</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:376F                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:3771                 </span><span style="color:navy">dec     cx              </span>; Address is above UM Range,
<span style="color:black">SYSINIT:3771                                         </span>; AX will return as 0FFFFh.
<span style="color:black">SYSINIT:3772
SYSINIT:3772 </span><span style="color:gray">atuX</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3772                 </span><span style="color:navy">mov     ax, cx          </span>; Return the UMB number in AX (0==conv)
<span style="color:black">SYSINIT:3774                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3775                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:3776                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:3777                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3777 </span>AddrToUmb       <span style="color:black">endp
SYSINIT:3777
SYSINIT:3778
SYSINIT:3778 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3778
SYSINIT:3778
SYSINIT:3778 </span>convUMB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3778                 </span><span style="color:navy">cmp     cs:</span>gnradix<span style="color:navy">, </span><span style="color:#ff8000">10h </span>; convert address to UMB number after GetXNum
<span style="color:black">SYSINIT:3778                                         </span>; (GetXNum has read a hex number)
<span style="color:black">SYSINIT:377E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cu10      </span>; GetXNum didn&#039;t read in hex, it is not an addr
<span style="color:black">SYSINIT:3780                 </span><span style="color:navy">call    </span>AddrToUmb       ; convert the address to a UMB number
<span style="color:black">SYSINIT:3783                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:3786                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cu10
</span><span style="color:black">SYSINIT:3788                 </span><span style="color:navy">inc     ax              </span>; If too high, ignore it (make it conventional)
<span style="color:black">SYSINIT:3789
SYSINIT:3789 </span><span style="color:gray">cu10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3789                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3789 </span>convUMB         <span style="color:black">endp
SYSINIT:3789
</span><span style="color:maroon">SYSINIT:378A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:378A
SYSINIT:378A </span>setUMBs<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:378A                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">SYSINIT:378B                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">SYSINIT:378C                 </span><span style="color:navy">call    </span>fm_link
<span style="color:maroon">SYSINIT:378F                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">SYSINIT:3790                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">SYSINIT:3791                 </span><span style="color:navy">retn
</span><span style="color:maroon">SYSINIT:3792 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:3792
SYSINIT:3792 </span>loadLow<span style="color:navy">:                                </span>; loadLow subroutine is not used anywhere
<span style="color:maroon">SYSINIT:3792                 </span><span style="color:navy">push    ds              </span>; of PCDOS 7.1 IBMBIO.COM (&amp; MSDOS 6.21 IO.SYS)
<span style="color:maroon">SYSINIT:3792                                         </span>; Erdogan Tan - 18/07/2023
<span style="color:maroon">SYSINIT:3793                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:3794                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:3795                 </span>assume ds:SYSINIT
<span style="color:maroon">SYSINIT:3795                 </span><span style="color:navy">mov     al, </span>UmbLoad
<span style="color:maroon">SYSINIT:3798                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; UNSPECIFIED ; -1
<span style="color:maroon">SYSINIT:379A                 </span><span style="color:navy">jnz     short </span>ll10
<span style="color:maroon">SYSINIT:379C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:379E                 </span><span style="color:navy">stc
</span><span style="color:maroon">SYSINIT:379F                 </span><span style="color:navy">jmp     short </span>llx
<span style="color:maroon">SYSINIT:37A1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:37A1
SYSINIT:37A1 </span>ll10<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:37A1                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">SYSINIT:37A3                 </span><span style="color:navy">jz      short </span>llx
<span style="color:maroon">SYSINIT:37A5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">SYSINIT:37A7                 </span><span style="color:navy">clc
</span><span style="color:maroon">SYSINIT:37A8
SYSINIT:37A8 </span>llx<span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:37A8                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:37A9                 </span>assume ds:nothing
<span style="color:maroon">SYSINIT:37A9                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:37AA
SYSINIT:37AA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:37AA
SYSINIT:37AA
SYSINIT:37AA </span>HideUMBs        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:37AA                 </span><span style="color:navy">push    ax              </span>; links UMBs and hides upper-memory as appropriate
<span style="color:black">SYSINIT:37AB                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:37AC                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:37AD                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:37AE                 </span><span style="color:navy">call    </span>UmbTest         ; cf=0 if UMBs are available
<span style="color:black">SYSINIT:37B1                 </span><span style="color:navy">jb      short </span><span style="color:gray">husX      </span>; there is nothing to do.
<span style="color:black">SYSINIT:37B3                 </span><span style="color:navy">call    </span>FixMem          ; Concatenate adjacent free MCBs in upper mem
<span style="color:black">SYSINIT:37B6                 </span><span style="color:navy">call    </span>setUMBs         ; Link UMBs and set memory-allocation strategy
<span style="color:black">SYSINIT:37B9                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:37BA                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:37BB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:37BC                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:37BC                 </span><span style="color:navy">mov     es:</span>fInHigh<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; Remember that we&#039;re now running high
<span style="color:black">SYSINIT:37C2                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:37C3                 </span>assume es:nothing
<span style="color:black">SYSINIT:37C3                 </span><span style="color:navy">call    </span>GetLoadUMB      ; See if they gave us a list to leave free
<span style="color:black">SYSINIT:37C6                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; UNSPECIFIED ; If they didn&#039;t,
<span style="color:black">SYSINIT:37C8                 </span><span style="color:navy">jz      short </span><span style="color:gray">husX      </span>; then we shouldn&#039;t do this loop:
<span style="color:black">SYSINIT:37CA                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">SYSINIT:37CC
SYSINIT:37CC </span><span style="color:gray">hus10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:37CC                 </span><span style="color:navy">inc     cx              </span>; +1 for each UMB
<span style="color:black">SYSINIT:37CD                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">16          </span>; MAXUMB
<span style="color:black">SYSINIT:37D0                 </span><span style="color:navy">jnb     short </span><span style="color:gray">hus20
</span><span style="color:black">SYSINIT:37D2                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">SYSINIT:37D4                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:37D5                 </span><span style="color:navy">call    </span>findUMB         ; ES:0 points to first MCB in UMB
<span style="color:black">SYSINIT:37D5                                         </span>; Carry set if couldn&#039;t reach UMB
<span style="color:black">SYSINIT:37D8                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:37D9                 </span><span style="color:navy">jb      short </span><span style="color:gray">hus20     </span>; outside of the valid range of UMBs
<span style="color:black">SYSINIT:37DB                 </span><span style="color:navy">call    </span>_hideUMB_       ; hide what we need to hide.
<span style="color:black">SYSINIT:37DE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">hus10
</span><span style="color:black">SYSINIT:37E0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:37E0
SYSINIT:37E0 </span><span style="color:gray">hus20</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:37E0                 </span><span style="color:navy">call    </span>GetLoadUMB      ; mov al,[cs:UmbLoad]
<span style="color:black">SYSINIT:37E3                 </span><span style="color:navy">or      al, al          </span>; or byte [cs:UmbLoad],0
<span style="color:black">SYSINIT:37E3                                         </span>; Is the load UMB 0? (-1==unspecified)
<span style="color:black">SYSINIT:37E5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">husX      </span>; no, done.
<span style="color:black">SYSINIT:37E7                 </span><span style="color:navy">call    </span>hl_unlink       ; fix UMBs and strategy.
<span style="color:black">SYSINIT:37EA
SYSINIT:37EA </span><span style="color:gray">husX</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:37EA                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:37EB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:37EC                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:37ED                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:37EE                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:37EE </span>HideUMBs        <span style="color:black">endp
SYSINIT:37EE
SYSINIT:37EF
SYSINIT:37EF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:37EF
SYSINIT:37EF
SYSINIT:37EF </span>GetLoadUMB      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:37EF                 </span><span style="color:navy">push    ds              </span>; Returns the load UMB number in AL
<span style="color:black">SYSINIT:37EF                                         </span>;  (-1 if not specified)
<span style="color:black">SYSINIT:37EF                                         </span>;
<span style="color:black">SYSINIT:37EF                                         </span>; Instead of calling this subroutine
<span style="color:black">SYSINIT:37EF                                         </span>; &quot;or byte [cs:UmbLoad],0&quot; then &quot;jz/jnz ..&quot;
<span style="color:black">SYSINIT:37EF                                         </span>; would be enough. Erdogan Tan - 18/07/2023
<span style="color:black">SYSINIT:37F0                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:37F1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:37F2                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:37F2                 </span><span style="color:navy">mov     al, </span>UmbLoad
<span style="color:black">SYSINIT:37F5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:37F6                 </span>assume ds:nothing
<span style="color:black">SYSINIT:37F6                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:37F6 </span>GetLoadUMB      <span style="color:black">endp
SYSINIT:37F6
SYSINIT:37F7
SYSINIT:37F7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:37F7
SYSINIT:37F7
SYSINIT:37F7 </span>GetLoadSize     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:37F7                 </span><span style="color:navy">push    bx              </span>; Returns the load UMB minimum size
<span style="color:black">SYSINIT:37F7                                         </span>;  (0 if not specified)
<span style="color:black">SYSINIT:37F8                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:37F9                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:37FA                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:37FB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:37FC                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:37FC                 </span><span style="color:navy">mov     al, </span>UmbLoad
<span style="color:black">SYSINIT:37FF                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:3801                 </span><span style="color:navy">mov     bx, offset </span>UmbSize ; array
<span style="color:black">SYSINIT:3804                 </span><span style="color:navy">shl     al, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:3806                 </span><span style="color:navy">add     ax, bx
</span><span style="color:black">SYSINIT:3808                 </span><span style="color:navy">mov     si, ax
</span><span style="color:black">SYSINIT:380A                 </span><span style="color:navy">lodsw                   </span>; ax==size
<span style="color:black">SYSINIT:380B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:380C                 </span>assume ds:nothing
<span style="color:black">SYSINIT:380C                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:380D                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:380E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:380E </span>GetLoadSize     <span style="color:black">endp
SYSINIT:380E
SYSINIT:380F
SYSINIT:380F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:380F
SYSINIT:380F
SYSINIT:380F </span>GetSize         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:380F                 </span><span style="color:navy">push    bx              </span>; Returns the UMB in AL&#039;s minimum size
<span style="color:black">SYSINIT:380F                                         </span>;  (0 if not specified)
<span style="color:black">SYSINIT:3810                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:3811                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3812                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3813                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3814                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3814                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:3816                 </span><span style="color:navy">mov     bx, offset </span>UmbSize ; array
<span style="color:black">SYSINIT:3819                 </span><span style="color:navy">shl     al, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:381B                 </span><span style="color:navy">add     ax, bx
</span><span style="color:black">SYSINIT:381D                 </span><span style="color:navy">mov     si, ax
</span><span style="color:black">SYSINIT:381F                 </span><span style="color:navy">lodsw                   </span>; ax==size
<span style="color:black">SYSINIT:3820                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3821                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3821                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:3822                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3823                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3823 </span>GetSize         <span style="color:black">endp
SYSINIT:3823
</span><span style="color:maroon">SYSINIT:3824 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:3824
SYSINIT:3824 </span>StoLoadUMB<span style="color:navy">:                             </span>; StoLoadUMB subroutine is not used anywhere
<span style="color:maroon">SYSINIT:3824                 </span><span style="color:navy">push    es              </span>; of PCDOS 7.1 IBMBIO.COM (&amp; MSDOS 6.21 IO.SYS)
<span style="color:maroon">SYSINIT:3824                                         </span>; Erdogan Tan - 18/07/2023
<span style="color:maroon">SYSINIT:3825                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">SYSINIT:3826                 </span><span style="color:navy">pop     es              </span>; mov [cs:UmbLoad], al !!!! ; 08/09/2023
<span style="color:maroon">SYSINIT:3827                 </span>assume es:SYSINIT
<span style="color:maroon">SYSINIT:3827                 </span><span style="color:navy">mov     es:</span>UmbLoad<span style="color:navy">, al  </span>; Overrides the load UMB number with what&#039;s in AL
<span style="color:maroon">SYSINIT:382B                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:382C                 </span>assume es:nothing
<span style="color:maroon">SYSINIT:382C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:382D
SYSINIT:382D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:382D
SYSINIT:382D
SYSINIT:382D </span>StoLoadSize     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:382D                 </span><span style="color:navy">push    dx              </span>; Overrides the load UMB min. size with what&#039;s in AX
<span style="color:black">SYSINIT:382E                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:382F                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3830                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3831                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3831                 </span><span style="color:navy">mov     dl, </span>UmbLoad     ; Put UMB# in DL
<span style="color:black">SYSINIT:3831                                         </span>;
<span style="color:black">SYSINIT:3831                                         </span>; BUG ! CL would/must be used here instead of DL (*)
<span style="color:black">SYSINIT:3831                                         </span>; 18/07/2023
<span style="color:black">SYSINIT:3835                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3836                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3836                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">0FFh        </span>; UNSPECIFIED ?
<span style="color:black">SYSINIT:3839                 </span><span style="color:navy">jz      short </span><span style="color:gray">sls10
</span><span style="color:black">SYSINIT:383B                 </span><span style="color:navy">call    </span>stowSiz         ; We&#039;ve got a function to do just this
<span style="color:black">SYSINIT:383B                                         </span>;
<span style="color:black">SYSINIT:383B                                         </span>; BUG ! stowSiz uses CL instead of DL !
<span style="color:black">SYSINIT:383B                                         </span>; (CL is set in ParseL which calls stowSiz)
<span style="color:black">SYSINIT:383B                                         </span>; (This BUG existing in MSDOS 6.21 IO.SYS also)
<span style="color:black">SYSINIT:383B                                         </span>; Erdogan Tan - 18/07/2023
<span style="color:black">SYSINIT:383E
SYSINIT:383E </span><span style="color:gray">sls10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:383E                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:383F                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:383F </span>StoLoadSize     <span style="color:black">endp
SYSINIT:383F
SYSINIT:3840
SYSINIT:3840 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3840
SYSINIT:3840
SYSINIT:3840 </span>hideUMB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3840                 </span><span style="color:navy">push    ax              </span>; marks as HIDDEN all FREE elements in UMB passed as AL
<span style="color:black">SYSINIT:3841                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3842                 </span><span style="color:navy">call    </span>findUMB         ; Returns with carry if err, else ES == MCB
<span style="color:black">SYSINIT:3845                 </span><span style="color:navy">jb      short </span><span style="color:gray">huX
</span><span style="color:black">SYSINIT:3847
SYSINIT:3847 </span><span style="color:gray">hu10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3847                 </span><span style="color:navy">call    </span>isSysMCB        ; Returns with ZF set if owner is SYSTEM
<span style="color:black">SYSINIT:384A                 </span><span style="color:navy">jz      short </span><span style="color:gray">huX
</span><span style="color:black">SYSINIT:384C                 </span><span style="color:navy">call    </span>isFreeMCB       ; or word [es:ARENA.OWNER],0
<span style="color:black">SYSINIT:384F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">hu20
</span><span style="color:black">SYSINIT:3851                 </span><span style="color:navy">call    </span>hideMCB
<span style="color:black">SYSINIT:3854
SYSINIT:3854 </span><span style="color:gray">hu20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3854                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0        </span>; [es:ARENA.SIGNATURE]
<span style="color:black">SYSINIT:3858                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; cmp byte [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:385A                 </span><span style="color:navy">jz      short </span><span style="color:gray">huX
</span><span style="color:black">SYSINIT:385C                 </span><span style="color:navy">mov     ax, es          </span>; Go on forward.
<span style="color:black">SYSINIT:385E                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3863                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3864                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3866                 </span><span style="color:navy">jmp     short </span><span style="color:gray">hu10
</span><span style="color:black">SYSINIT:3868 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3868
SYSINIT:3868 </span><span style="color:gray">huX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3868                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3869                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:386A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:386A </span>hideUMB         <span style="color:black">endp
SYSINIT:386A
SYSINIT:386B
SYSINIT:386B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:386B
SYSINIT:386B
SYSINIT:386B </span>isTiny          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:386B                 </span><span style="color:navy">push    ax              </span>; returns with ZF set if user didn&#039;t specify /S
<span style="color:black">SYSINIT:386C                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:386D                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:386E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:386F                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:386F                 </span><span style="color:navy">mov     al, </span>fUmbTiny
<span style="color:black">SYSINIT:3872                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3873                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3873                 </span><span style="color:navy">or      al, al
</span><span style="color:black">SYSINIT:3875                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3876                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3876 </span>isTiny          <span style="color:black">endp
SYSINIT:3876
SYSINIT:3877
SYSINIT:3877 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3877
SYSINIT:3877
SYSINIT:3877 </span>isFreeMCB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3877                 </span><span style="color:navy">or      word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">0 </span>; or word [es:ARENA.OWNER],0
<span style="color:black">SYSINIT:387D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:387D </span>isFreeMCB       <span style="color:black">endp
SYSINIT:387D
SYSINIT:387E
SYSINIT:387E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:387E
SYSINIT:387E
SYSINIT:387E </span>hideMCB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:387E                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; marks as HIDDEN the MCB at ES:0
<span style="color:black">SYSINIT:3885                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4948h </span>; &#039;HI&#039;
<span style="color:black">SYSINIT:388C                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">0Ah</span><span style="color:navy">, </span><span style="color:#ff8000">4444h </span>; &#039;DD&#039;
<span style="color:black">SYSINIT:3893                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">0Ch</span><span style="color:navy">, </span><span style="color:#ff8000">4E45h </span>; &#039;EN&#039;
<span style="color:black">SYSINIT:389A                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">0Eh</span><span style="color:navy">, </span><span style="color:#ff8000">2020h </span>; &#039;  &#039;
<span style="color:black">SYSINIT:38A1                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:38A1 </span>hideMCB         <span style="color:black">endp
SYSINIT:38A1
SYSINIT:38A2
SYSINIT:38A2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:38A2
SYSINIT:38A2
SYSINIT:38A2 </span>unHideMCB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38A2                 </span><span style="color:navy">push    ax              </span>; marks as FREE the MCB at ES:0
<span style="color:black">SYSINIT:38A3                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [es:ARENA.OWNER],FreePSPOwner
<span style="color:black">SYSINIT:38AA                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2020h       </span>; &#039;  &#039;
<span style="color:black">SYSINIT:38AD                 </span><span style="color:navy">mov     es:</span><span style="color:green">8</span><span style="color:navy">, ax        </span>; [es:ARENA.NAME+0]
<span style="color:black">SYSINIT:38B1                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Ah</span><span style="color:navy">, ax      </span>; [es:ARENA.NAME+2]
<span style="color:black">SYSINIT:38B5                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Ch</span><span style="color:navy">, ax      </span>; [es:ARENA.NAME+4]
<span style="color:black">SYSINIT:38B9                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Eh</span><span style="color:navy">, ax      </span>; [es:ARENA.NAME+6]
<span style="color:black">SYSINIT:38BD                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:38BE                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:38BE </span>unHideMCB       <span style="color:black">endp
SYSINIT:38BE
SYSINIT:38BF
SYSINIT:38BF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:38BF
SYSINIT:38BF
SYSINIT:38BF </span>findUMB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38BF                 </span><span style="color:navy">push    ax              </span>; makes ES:0 point to the first MCB in UMB given as AL
<span style="color:black">SYSINIT:38C0                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:38C1                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:38C2                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">SYSINIT:38C4                 </span><span style="color:navy">mov     dx, ax          </span>; Store the to-be-found UMB number in DX
<span style="color:black">SYSINIT:38C6                 </span><span style="color:navy">call    </span>UmbHead         ; Returns first UMB segment in AX
<span style="color:black">SYSINIT:38C9                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:38CB                 </span><span style="color:navy">xor     cx, cx          </span>; Pretend we&#039;re on UMB 0 for now...
<span style="color:black">SYSINIT:38CD
SYSINIT:38CD </span><span style="color:gray">fu10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38CD                 </span><span style="color:navy">cmp     cx, dx          </span>; If CX==DX, the UMB is found
<span style="color:black">SYSINIT:38CF                 </span><span style="color:navy">jz      short </span><span style="color:gray">fuX
</span><span style="color:black">SYSINIT:38D1                 </span><span style="color:navy">call    </span>isSysMCB        ; Returns with ZF set if owner is SYSTEM
<span style="color:black">SYSINIT:38D4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fu20
</span><span style="color:black">SYSINIT:38D6                 </span><span style="color:navy">inc     cx
</span><span style="color:black">SYSINIT:38D7
SYSINIT:38D7 </span><span style="color:gray">fu20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38D7                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0
</span><span style="color:black">SYSINIT:38DB                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; cmp byte [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:38DD                 </span><span style="color:navy">jz      short </span><span style="color:gray">fuE       </span>; &#039;Z&#039; means this was the last MCB
<span style="color:black">SYSINIT:38DF                 </span><span style="color:navy">mov     ax, es          </span>; Go on forward.
<span style="color:black">SYSINIT:38E1                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:38E6                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:38E7                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:38E9                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fu10
</span><span style="color:black">SYSINIT:38EB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:38EB
SYSINIT:38EB </span><span style="color:gray">fuE</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38EB                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:38EC
SYSINIT:38EC </span><span style="color:gray">fuX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38EC                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:38ED                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:38EE                 </span><span style="color:navy">pop     ax              </span>; The address is already in ES.
<span style="color:black">SYSINIT:38EF                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:38EF </span>findUMB         <span style="color:black">endp
SYSINIT:38EF
SYSINIT:38F0
SYSINIT:38F0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:38F0
SYSINIT:38F0
SYSINIT:38F0 </span>BigFree         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38F0                 </span><span style="color:navy">push    bx              </span>; makes ES:0 point to the largest free MCB
<span style="color:black">SYSINIT:38F0                                         </span>; in UMB given as AL
<span style="color:black">SYSINIT:38F1                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:38F2                 </span><span style="color:navy">call    </span>findUMB         ; Returns with CF if err, else ES==MCB
<span style="color:black">SYSINIT:38F5                 </span><span style="color:navy">jb      short </span><span style="color:gray">bfX
</span><span style="color:black">SYSINIT:38F7                 </span><span style="color:navy">xor     bx, bx          </span>; Segment address of largest free MCB
<span style="color:black">SYSINIT:38F9                 </span><span style="color:navy">xor     cx, cx          </span>; Size of largest free MCB
<span style="color:black">SYSINIT:38FB
SYSINIT:38FB </span><span style="color:gray">bf10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:38FB                 </span><span style="color:navy">call    </span>isSysMCB        ; If we&#039;ve left the MCB, we&#039;re done.
<span style="color:black">SYSINIT:38FE                 </span><span style="color:navy">jz      short </span><span style="color:gray">bf30
</span><span style="color:black">SYSINIT:3900                 </span><span style="color:navy">call    </span>isFreeMCB       ; or word [es:ARENA.OWNER],0
<span style="color:black">SYSINIT:3903                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bf20
</span><span style="color:black">SYSINIT:3905                 </span><span style="color:navy">cmp     cx, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE] ; Compare sizes..
<span style="color:black">SYSINIT:390A                 </span><span style="color:navy">jg      short </span><span style="color:gray">bf20
</span><span style="color:black">SYSINIT:390C                 </span><span style="color:navy">mov     bx, es          </span>; Unless we&#039;re bigger,
<span style="color:black">SYSINIT:390E                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">3        </span>; Store this new element&#039;s addr and size.
<span style="color:black">SYSINIT:3913
SYSINIT:3913 </span><span style="color:gray">bf20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3913                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0
</span><span style="color:black">SYSINIT:3917                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:3919                 </span><span style="color:navy">jz      short </span><span style="color:gray">bf30
</span><span style="color:black">SYSINIT:391B                 </span><span style="color:navy">mov     ax, es          </span>; NextMCB es,ax ; (macro) ; Go on forward.
<span style="color:black">SYSINIT:391D                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; es:ARENA.SIZE]
<span style="color:black">SYSINIT:3922                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3923                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3925                 </span><span style="color:navy">jmp     short </span><span style="color:gray">bf10
</span><span style="color:black">SYSINIT:3927 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3927
SYSINIT:3927 </span><span style="color:gray">bf30</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3927                 </span><span style="color:navy">mov     es, bx          </span>; Return the address
<span style="color:black">SYSINIT:3929                 </span><span style="color:navy">mov     ax, cx          </span>; Return the size
<span style="color:black">SYSINIT:392B                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">SYSINIT:392D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bfX
</span><span style="color:black">SYSINIT:392F                 </span><span style="color:navy">stc                     </span>; (if size==0, there&#039;s nothing free)
<span style="color:black">SYSINIT:3930
SYSINIT:3930 </span><span style="color:gray">bfX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3930                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:3931                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3932                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3932 </span>BigFree         <span style="color:black">endp
SYSINIT:3932
SYSINIT:3933
SYSINIT:3933 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3933
SYSINIT:3933
SYSINIT:3933 </span>isSpecified     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3933                 </span><span style="color:navy">push    ax              </span>; sets ZF if UMB in AL wasn&#039;t specified in DH/LH line.
<span style="color:black">SYSINIT:3934                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">SYSINIT:3936                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">SYSINIT:3938                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3939                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:393A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:393B                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:393B                 </span><span style="color:navy">mov     al, </span>UmbUsed<span style="color:navy">[bx]
</span><span style="color:black">SYSINIT:393F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3940                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3940                 </span><span style="color:navy">or      al, al          </span>; ets ZF if al==0 (ie, if unspecified)
<span style="color:black">SYSINIT:3942                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3943                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3943 </span>isSpecified     <span style="color:black">endp
SYSINIT:3943
SYSINIT:3944
SYSINIT:3944 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3944
SYSINIT:3944
SYSINIT:3944 </span>shrinkMCB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3944                 </span><span style="color:navy">push    bx              </span>; breaks an MCB into two pieces, the lowest one&#039;s size==AX
<span style="color:black">SYSINIT:3944                                         </span>; AX == new size, ES:0 == current MCB
<span style="color:black">SYSINIT:3945                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:3946                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3947                 </span><span style="color:navy">mov     bx, ax          </span>; requested size (lowest one)
<span style="color:black">SYSINIT:3949                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:394B                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3950                 </span><span style="color:navy">sub     cx, </span><span style="color:green">32          </span>; MIN_SPLIT_SIZE = 32
<span style="color:black">SYSINIT:3953                 </span><span style="color:navy">cmp     bx, cx          </span>; {New size} vs {Current Size-20h}
<span style="color:black">SYSINIT:3955                 </span><span style="color:navy">ja      short </span><span style="color:gray">smE       </span>; if wanted_size &gt; cur-20h, abort.
<span style="color:black">SYSINIT:3957                 </span><span style="color:navy">mov     dl, es:</span><span style="color:green">0        </span>; [es:ARENA.SIGNATURE]
<span style="color:black">SYSINIT:395C                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">3
</span><span style="color:black">SYSINIT:3961                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, bx        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3966                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [es:ARENA.SIGNATURE],&#039;M&#039;
<span style="color:black">SYSINIT:396C                 </span><span style="color:navy">add     ax, bx
</span><span style="color:black">SYSINIT:396E                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:396F                 </span><span style="color:navy">mov     es, ax          </span>; Move to new arena area
<span style="color:black">SYSINIT:3971                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">SYSINIT:3973                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:black">SYSINIT:3975                 </span><span style="color:navy">dec     ax              </span>; And prepare the new size
<span style="color:black">SYSINIT:3976                 </span><span style="color:navy">mov     es:</span><span style="color:green">0</span><span style="color:navy">, dl        </span>; [es:ARENA.SIGNATURE],dl
<span style="color:black">SYSINIT:397B                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [es:ARENA.OWNER]
<span style="color:black">SYSINIT:3982                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, ax        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3986                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2020h       </span>; &#039;  &#039;
<span style="color:black">SYSINIT:3989                 </span><span style="color:navy">mov     es:</span><span style="color:green">8</span><span style="color:navy">, ax        </span>; [es:ARENA.NAME+0]
<span style="color:black">SYSINIT:398D                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Ah</span><span style="color:navy">, ax      </span>; [es:ARENA.NAME+2]
<span style="color:black">SYSINIT:3991                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Ch</span><span style="color:navy">, ax      </span>; [es:ARENA.NAME+4]
<span style="color:black">SYSINIT:3995                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Eh</span><span style="color:navy">, ax      </span>; [es:ARENA.NAME+6]
<span style="color:black">SYSINIT:3999                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:399A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">smX
</span><span style="color:black">SYSINIT:399C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:399C
SYSINIT:399C </span><span style="color:gray">smE</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:399C                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:399D
SYSINIT:399D </span><span style="color:gray">smX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:399D                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:399E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:399F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:39A0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:39A0 </span>shrinkMCB       <span style="color:black">endp
SYSINIT:39A0
SYSINIT:39A1
SYSINIT:39A1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:39A1
SYSINIT:39A1
SYSINIT:39A1 </span>_hideUMB_       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:39A1                 </span><span style="color:navy">push    bx              </span>; hides as appropriate the UMB in CL
<span style="color:black">SYSINIT:39A2                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:39A3                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:39A4                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">SYSINIT:39A6                 </span><span style="color:navy">call    </span>isSpecified     ; Returns ZF set if al&#039;s umb was NOT specified
<span style="color:black">SYSINIT:39A9                 </span><span style="color:navy">jz      short </span><span style="color:gray">hu_20
</span><span style="color:black">SYSINIT:39AB                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">SYSINIT:39AD                 </span><span style="color:navy">call    </span>BigFree         ; Retrieve the size of the largest free element
<span style="color:black">SYSINIT:39AD                                         </span>; in AX, put its address in ES.
<span style="color:black">SYSINIT:39B0                 </span><span style="color:navy">jb      short </span><span style="color:gray">hu_20
</span><span style="color:black">SYSINIT:39B2                 </span><span style="color:navy">push    ax              </span>; TOS==size of BigFree in UMB
<span style="color:black">SYSINIT:39B3                 </span><span style="color:navy">mov     al, cl          </span>; Retrieve the user&#039;s specified
<span style="color:black">SYSINIT:39B5                 </span><span style="color:navy">call    </span>GetSize         ; minimum size for this umb (into AX)
<span style="color:black">SYSINIT:39B8                 </span><span style="color:navy">pop     bx              </span>; BX==BigFree, AX==Specified Size
<span style="color:black">SYSINIT:39B9                 </span><span style="color:navy">or      ax, ax          </span>; If they didn&#039;t specify one,
<span style="color:black">SYSINIT:39B9                                         </span>; skip over all this.
<span style="color:black">SYSINIT:39BB                 </span><span style="color:navy">jz      short </span><span style="color:gray">hu_20
</span><span style="color:black">SYSINIT:39BD                 </span><span style="color:navy">cmp     ax, bx          </span>; if (specified &gt; max free)
<span style="color:black">SYSINIT:39BF                 </span><span style="color:navy">jbe     short </span><span style="color:gray">hu_10
</span><span style="color:black">SYSINIT:39C1                 </span><span style="color:navy">mov     al, cl          </span>; then mark that UMB as unused.
<span style="color:black">SYSINIT:39C3                 </span><span style="color:navy">call    </span>unMarkUMB
<span style="color:black">SYSINIT:39C6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">hu_20
</span><span style="color:black">SYSINIT:39C8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:39C8
SYSINIT:39C8 </span><span style="color:gray">hu_10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:39C8                 </span><span style="color:navy">call    </span>isTiny          ; or byte [cs:fUmbTiny],0
<span style="color:black">SYSINIT:39CB                 </span><span style="color:navy">jz      short </span><span style="color:gray">hu_20
</span><span style="color:black">SYSINIT:39CD                 </span><span style="color:navy">call    </span>shrinkMCB       ; They specified /S, so shrink the MCB to AX
<span style="color:black">SYSINIT:39D0                 </span><span style="color:navy">jb      short </span><span style="color:gray">hu_20
</span><span style="color:black">SYSINIT:39D2                 </span><span style="color:navy">mov     dx, es
</span><span style="color:black">SYSINIT:39D4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">hu_30     </span>; Skip the spec check.. we wanna hide this one.
<span style="color:black">SYSINIT:39D6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:39D6
SYSINIT:39D6 </span><span style="color:gray">hu_20</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:39D6                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">SYSINIT:39D8                 </span><span style="color:navy">call    </span>isSpecified     ; If they specified this UMB, we&#039;re done.
<span style="color:black">SYSINIT:39DB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">hu_X      </span>; so leave.
<span style="color:black">SYSINIT:39DD                 </span><span style="color:navy">xor     dx, dx          </span>; 0
<span style="color:black">SYSINIT:39DF
SYSINIT:39DF </span><span style="color:gray">hu_30</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:39DF                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">SYSINIT:39E1                 </span><span style="color:navy">call    </span>hideUMB         ; Hides everything in UMB #al
<span style="color:black">SYSINIT:39E4                 </span><span style="color:navy">or      dx, dx          </span>; Did we shrink a UMB? If not, DX==0,
<span style="color:black">SYSINIT:39E6                 </span><span style="color:navy">jz      short </span><span style="color:gray">hu_X      </span>; So we should leave.
<span style="color:black">SYSINIT:39E8                 </span><span style="color:navy">mov     es, dx          </span>; Ah, but if it isn&#039;t, DX==the MCB&#039;s address;
<span style="color:black">SYSINIT:39EA                 </span><span style="color:navy">call    </span>unHideMCB       ; Un-hides the lower portion of that MCB.
<span style="color:black">SYSINIT:39ED
SYSINIT:39ED </span><span style="color:gray">hu_X</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:39ED                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:39EE                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:39EF                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:39F0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:39F0 </span>_hideUMB_       <span style="color:black">endp
SYSINIT:39F0
SYSINIT:39F1
SYSINIT:39F1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:39F1
SYSINIT:39F1
SYSINIT:39F1 </span>UnFreeze        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:39F1                 </span><span style="color:navy">push    ax              </span>; Marks FROZEN elements as FREE
<span style="color:black">SYSINIT:39F2                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:39F3                 </span><span style="color:navy">call    </span>UmbHead         ; Returns with carry if err, else ES == MCB
<span style="color:black">SYSINIT:39F6                 </span><span style="color:navy">jb      short </span><span style="color:gray">ufX
</span><span style="color:black">SYSINIT:39F8                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:39FA
SYSINIT:39FA </span><span style="color:gray">uf10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:39FA                 </span><span style="color:navy">call    </span>isFrozMCB       ; Returns with ZF set if MCB is FROZEN
<span style="color:black">SYSINIT:39FD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">uf20
</span><span style="color:black">SYSINIT:39FF                 </span><span style="color:navy">call    </span>unHideMCB
<span style="color:black">SYSINIT:3A02
SYSINIT:3A02 </span><span style="color:gray">uf20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A02                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0
</span><span style="color:black">SYSINIT:3A06                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; cmp byte [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:3A08                 </span><span style="color:navy">jz      short </span><span style="color:gray">ufX
</span><span style="color:black">SYSINIT:3A0A                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:3A0C                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3A11                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3A12                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3A14                 </span><span style="color:navy">jmp     short </span><span style="color:gray">uf10
</span><span style="color:black">SYSINIT:3A16 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3A16
SYSINIT:3A16 </span><span style="color:gray">ufX</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A16                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3A17                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3A18                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3A18 </span>UnFreeze        <span style="color:black">endp
SYSINIT:3A18
SYSINIT:3A19
SYSINIT:3A19 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3A19
SYSINIT:3A19
SYSINIT:3A19 </span>isFrozMCB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A19                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:3A1A                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">1        </span>; [es:ARENA.OWNER] ; Check the owner..
<span style="color:black">SYSINIT:3A1E                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">8           </span>; 8 (for US OR Japan) is valid
<span style="color:black">SYSINIT:3A21                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ifmX
</span><span style="color:black">SYSINIT:3A23                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">8        </span>; [es:ARENA.NAME+0]
<span style="color:black">SYSINIT:3A27                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">5246h       </span>; &#039;FR&#039;
<span style="color:black">SYSINIT:3A2A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ifmX
</span><span style="color:black">SYSINIT:3A2C                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0Ah      </span>; [es:ARENA.NAME+2]
<span style="color:black">SYSINIT:3A30                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">5A4Fh       </span>; &#039;OZ&#039;
<span style="color:black">SYSINIT:3A33                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ifmX
</span><span style="color:black">SYSINIT:3A35                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0Ch      </span>; [es:ARENA.NAME+4]
<span style="color:black">SYSINIT:3A39                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4E45h       </span>; &#039;EN&#039;
<span style="color:black">SYSINIT:3A3C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ifmX
</span><span style="color:black">SYSINIT:3A3E                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0Eh      </span>; [es:ARENA.NAME+6]
<span style="color:black">SYSINIT:3A42                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">2020h       </span>; &#039;  &#039;
<span style="color:black">SYSINIT:3A45
SYSINIT:3A45 </span><span style="color:gray">ifmX</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A45                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3A46                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3A46 </span>isFrozMCB       <span style="color:black">endp
SYSINIT:3A46
SYSINIT:3A47
SYSINIT:3A47 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3A47
SYSINIT:3A47
SYSINIT:3A47 </span>frezMCB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A47                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; marks as 8+FROZEN the MCB at ES:0
<span style="color:black">SYSINIT:3A47                                         </span>; mov word [es:ARENA.OWNER],SystemPSPOwner
<span style="color:black">SYSINIT:3A4E                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">5246h </span>; [es:ARENA.NAME+0],&#039;FR&#039;
<span style="color:black">SYSINIT:3A55                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">0Ah</span><span style="color:navy">, </span><span style="color:#ff8000">5A4Fh </span>; [es:ARENA.NAME+2],&#039;OZ&#039;
<span style="color:black">SYSINIT:3A5C                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">0Ch</span><span style="color:navy">, </span><span style="color:#ff8000">4E45h </span>; [es:ARENA.NAME+4],&#039;EN&#039;
<span style="color:black">SYSINIT:3A63                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">0Eh</span><span style="color:navy">, </span><span style="color:#ff8000">2020h </span>; [es:ARENA.NAME+6],&#039;  &#039;
<span style="color:black">SYSINIT:3A6A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3A6A </span>frezMCB         <span style="color:black">endp
SYSINIT:3A6A
SYSINIT:3A6B
SYSINIT:3A6B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3A6B
SYSINIT:3A6B
SYSINIT:3A6B </span>FreezeUM        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A6B                 </span><span style="color:navy">push    ax              </span>; Marks FROZEN all UM elements now FREE,
<span style="color:black">SYSINIT:3A6B                                         </span>; save those in load UMB
<span style="color:black">SYSINIT:3A6C                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:3A6D                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:3A6E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3A6F                 </span><span style="color:navy">call    </span>GetLoadUMB      ; mov al,[cs:UmbLoad]
<span style="color:black">SYSINIT:3A72                 </span><span style="color:navy">xor     ah, ah          </span>; 0
<span style="color:black">SYSINIT:3A74                 </span><span style="color:navy">mov     dx, ax          </span>; Store the load UMB in DX, so we can skip it
<span style="color:black">SYSINIT:3A76                 </span><span style="color:navy">call    </span>UmbHead         ; Returns first UMB segment in AX
<span style="color:black">SYSINIT:3A79                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3A7B                 </span><span style="color:navy">xor     cx, cx          </span>; Pretend we&#039;re on UMB 0 for now..
<span style="color:black">SYSINIT:3A7D
SYSINIT:3A7D </span><span style="color:gray">fum10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A7D                 </span><span style="color:navy">call    </span>isSysMCB        ; Returns with ZF set if owner is SYSTEM
<span style="color:black">SYSINIT:3A80                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fum20
</span><span style="color:black">SYSINIT:3A82                 </span><span style="color:navy">inc     cx              </span>; If it _was_ SYSTEM, we&#039;re in a new UMB.
<span style="color:black">SYSINIT:3A83
SYSINIT:3A83 </span><span style="color:gray">fum20</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A83                 </span><span style="color:navy">cmp     cx, dx          </span>; DX - UMB number to skip (load UMB)
<span style="color:black">SYSINIT:3A83                                         </span>;
<span style="color:black">SYSINIT:3A83                                         </span>; If this is the load UMB, we don&#039;t want to
<span style="color:black">SYSINIT:3A83                                         </span>; freeze anything.. so skip that section.
<span style="color:black">SYSINIT:3A85                 </span><span style="color:navy">jz      short </span><span style="color:gray">fum30
</span><span style="color:black">SYSINIT:3A87                 </span><span style="color:navy">call    </span>isFreeMCB       ; or word [es:ARENA.OWNER],0
<span style="color:black">SYSINIT:3A87                                         </span>; If it&#039;s not free, we can&#039;t freeze it
<span style="color:black">SYSINIT:3A8A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fum30
</span><span style="color:black">SYSINIT:3A8C                 </span><span style="color:navy">call    </span>frezMCB
<span style="color:black">SYSINIT:3A8F
SYSINIT:3A8F </span><span style="color:gray">fum30</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3A8F                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0
</span><span style="color:black">SYSINIT:3A93                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; cmp byte [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:3A95                 </span><span style="color:navy">jz      short </span><span style="color:gray">fumX
</span><span style="color:black">SYSINIT:3A97                 </span><span style="color:navy">mov     ax, es          </span>; NextMCB es, ax (macro) ; Go on forward.
<span style="color:black">SYSINIT:3A99                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3A9E                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3A9F                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3AA1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fum10
</span><span style="color:black">SYSINIT:3AA3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3AA3
SYSINIT:3AA3 </span><span style="color:gray">fumX</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3AA3                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3AA4                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:3AA5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:3AA6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3AA7                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3AA7 </span>FreezeUM        <span style="color:black">endp
SYSINIT:3AA7
SYSINIT:3AA8
SYSINIT:3AA8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3AA8
SYSINIT:3AA8
SYSINIT:3AA8 </span>UmbTest         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3AA8                 </span><span style="color:navy">push    ax              </span>; returns with carry set if UMBs are not available,
<span style="color:black">SYSINIT:3AA8                                         </span>;  else CF==false
<span style="color:black">SYSINIT:3AA9                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:3AAA                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3AAB                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3AAC                 </span><span style="color:navy">call    </span>fm_link         ; Link in UMBs (if not already linked)
<span style="color:black">SYSINIT:3AAF                 </span><span style="color:navy">call    </span>WalkMem         ; Check to see if they&#039;re really linked
<span style="color:black">SYSINIT:3AB2                 </span><span style="color:navy">pushf                   </span>; And remember what we found out
<span style="color:black">SYSINIT:3AB3                 </span><span style="color:navy">call    </span>fm_unlink       ; Unlink UMBs (if we have linked &#039;em)
<span style="color:black">SYSINIT:3AB6                 </span><span style="color:navy">popf                    </span>; And restore what we found out.
<span style="color:black">SYSINIT:3AB7                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3AB8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3AB9                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3ABA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3ABB                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3ABB </span>UmbTest         <span style="color:black">endp
SYSINIT:3ABB
SYSINIT:3ABC
SYSINIT:3ABC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3ABC
SYSINIT:3ABC
SYSINIT:3ABC </span>WalkMem         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3ABC                 </span><span style="color:navy">push    ax              </span>; WalkMem - travels memory chain and
<span style="color:black">SYSINIT:3ABC                                         </span>; returns carry clear if UMBs are linked
<span style="color:black">SYSINIT:3ABD                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:3ABE                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3ABF                 </span><span style="color:navy">mov     ah, </span><span style="color:green">52h
</span><span style="color:black">SYSINIT:3AC1                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - GET LIST OF LISTS
<span style="color:black">SYSINIT:3AC1                                         </span>; Return: ES:BX -&gt; DOS list of lists
<span style="color:black">SYSINIT:3AC3                 </span><span style="color:navy">mov     ax, es:[bx-</span><span style="color:green">2</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:3AC7                 </span><span style="color:navy">mov     es, ax          </span>; ES = Current MCB pointer
<span style="color:black">SYSINIT:3AC9
SYSINIT:3AC9 </span><span style="color:gray">um10</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3AC9                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0
</span><span style="color:black">SYSINIT:3ACD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; cmp byte [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:3ACF                 </span><span style="color:navy">jz      short </span><span style="color:gray">um20
</span><span style="color:black">SYSINIT:3AD1                 </span><span style="color:navy">mov     bx, es          </span>; Move to the next MCB
<span style="color:black">SYSINIT:3AD3                 </span><span style="color:navy">add     bx, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3AD8                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:3AD9                 </span><span style="color:navy">mov     es, bx
</span><span style="color:black">SYSINIT:3ADB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">um10
</span><span style="color:black">SYSINIT:3ADD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3ADD
SYSINIT:3ADD </span><span style="color:gray">um20</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3ADD                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:3ADF                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">9FFFh       </span>; This sets CF if ax &lt; 9FFFh.
<span style="color:black">SYSINIT:3AE2                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3AE3                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3AE4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3AE5                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3AE5 </span>WalkMem         <span style="color:black">endp
SYSINIT:3AE5
SYSINIT:3AE6
SYSINIT:3AE6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3AE6
SYSINIT:3AE6
SYSINIT:3AE6 </span>hl_unlink       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3AE6                 </span><span style="color:navy">xor     bh, bh          </span>; unlinks UMBs if fm_umb is set to 0;
<span style="color:black">SYSINIT:3AE6                                         </span>;  restores strategy too
<span style="color:black">SYSINIT:3AE8                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3AE9                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3AEA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3AEB                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3AEB                 </span><span style="color:navy">mov     bl, </span>fm_umb
<span style="color:black">SYSINIT:3AEF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3AF0                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3AF0                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5803h       </span>; DOS_SET_UMBLINK
<span style="color:black">SYSINIT:3AF3                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:3AF3                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:3AF5                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3AF5 </span>hl_unlink       <span style="color:black">endp
SYSINIT:3AF5
SYSINIT:3AF6
SYSINIT:3AF6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3AF6
SYSINIT:3AF6
SYSINIT:3AF6 </span>UnHideUMBs      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3AF6                 </span><span style="color:navy">push    ax              </span>; Marks HIDDEN elements as FREE
<span style="color:black">SYSINIT:3AF7                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3AF8                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3AF9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3AFA                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3AFA                 </span><span style="color:navy">mov     al, </span>fInHigh     ; mov al,[cs:fInHigh]
<span style="color:black">SYSINIT:3AFD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3AFE                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3AFE                 </span><span style="color:navy">or      al, al
</span><span style="color:black">SYSINIT:3B00                 </span><span style="color:navy">jnz     short </span><span style="color:gray">uhu10     </span>; If didn&#039;t call loadhigh/devicehigh earlier,
<span style="color:black">SYSINIT:3B02                 </span><span style="color:navy">pop     ax              </span>; then there&#039;s nothing to do here.
<span style="color:black">SYSINIT:3B03                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3B04                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3B05 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3B05
SYSINIT:3B05 </span><span style="color:gray">uhu10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B05                 </span><span style="color:navy">call    </span>linkumb         ; Make sure UMBs are linked in.
<span style="color:black">SYSINIT:3B08                 </span><span style="color:navy">call    </span>FreeUMBs
<span style="color:black">SYSINIT:3B0B                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3B0C                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3B0D                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3B0E                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:3B0E                 </span><span style="color:navy">mov     es:</span>fInHigh<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; We&#039;re leaving, so update fInHigh.
<span style="color:black">SYSINIT:3B14                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3B15                 </span>assume es:nothing
<span style="color:black">SYSINIT:3B15                 </span><span style="color:navy">call    </span>he_unlink       ; Unlink UMBs
<span style="color:black">SYSINIT:3B18                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3B19                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3B1A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3B1A </span>UnHideUMBs      <span style="color:black">endp
SYSINIT:3B1A
SYSINIT:3B1B
SYSINIT:3B1B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3B1B
SYSINIT:3B1B
SYSINIT:3B1B </span>he_unlink       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B1B                 </span><span style="color:navy">xor     bh, bh          </span>; unlinks UMBs if fm_umb is set to 0
<span style="color:black">SYSINIT:3B1D                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3B1E                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:3B1F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3B20                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:3B20                 </span><span style="color:navy">mov     bl, </span>fm_umb
<span style="color:black">SYSINIT:3B24                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3B25                 </span>assume ds:nothing
<span style="color:black">SYSINIT:3B25                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5803h
</span><span style="color:black">SYSINIT:3B28                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:3B28                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:3B2A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3B2A </span>he_unlink       <span style="color:black">endp
SYSINIT:3B2A
SYSINIT:3B2B
SYSINIT:3B2B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3B2B
SYSINIT:3B2B
SYSINIT:3B2B </span>FreeUMBs        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B2B                 </span><span style="color:navy">push    ax              </span>; frees all HIDDEN memory elements in upper-memory
<span style="color:black">SYSINIT:3B2C                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3B2D                 </span><span style="color:navy">call    </span>HeadUmb         ; Returns with carry if err, else ES == MCB
<span style="color:black">SYSINIT:3B30                 </span><span style="color:navy">jb      short </span><span style="color:gray">fusX
</span><span style="color:black">SYSINIT:3B32
SYSINIT:3B32 </span><span style="color:gray">fus10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B32                 </span><span style="color:navy">mov     es, ax          </span>; Prepare for the loop; ES = current MCB addr.
<span style="color:black">SYSINIT:3B34                 </span><span style="color:navy">call    </span>isHideMCB       ; Returns with ZF set if owner is 0
<span style="color:black">SYSINIT:3B37                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fus20
</span><span style="color:black">SYSINIT:3B39                 </span><span style="color:navy">call    </span>freeMCB
<span style="color:black">SYSINIT:3B3C
SYSINIT:3B3C </span><span style="color:gray">fus20</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B3C                 </span><span style="color:navy">mov     al, es:</span><span style="color:green">0
</span><span style="color:black">SYSINIT:3B40                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; cmp byte [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:3B42                 </span><span style="color:navy">jz      short </span><span style="color:gray">fusX
</span><span style="color:black">SYSINIT:3B44                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:3B46                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3B4B                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3B4C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fus10     </span>; Go on forward.
<span style="color:black">SYSINIT:3B4E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3B4E
SYSINIT:3B4E </span><span style="color:gray">fusX</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B4E                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3B4F                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3B50                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3B50 </span>FreeUMBs        <span style="color:black">endp
SYSINIT:3B50
SYSINIT:3B51
SYSINIT:3B51 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3B51
SYSINIT:3B51
SYSINIT:3B51 </span>isHideMCB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B51                 </span><span style="color:navy">push    ax              </span>; returns with ZF set if current MCB (ES:0) is HIDDEN
<span style="color:black">SYSINIT:3B52                 </span><span style="color:navy">cmp     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER],SystemPSPOwner
<span style="color:black">SYSINIT:3B52                                         </span>; If the owner&#039;s SYSTEM then check for HIDDEN
<span style="color:black">SYSINIT:3B58                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ihm_x
</span><span style="color:black">SYSINIT:3B5A                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">8
</span><span style="color:black">SYSINIT:3B5E                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4948h       </span>; cmp word [es:ARENA.NAME+0],&#039;HI&#039;
<span style="color:black">SYSINIT:3B61                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ihm_x
</span><span style="color:black">SYSINIT:3B63                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0Ah
</span><span style="color:black">SYSINIT:3B67                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4444h       </span>; cmp word [es:ARENA.NAME+2],&#039;DD&#039;
<span style="color:black">SYSINIT:3B6A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ihm_x
</span><span style="color:black">SYSINIT:3B6C                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0Ch
</span><span style="color:black">SYSINIT:3B70                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4E45h       </span>; cmp word [es:ARENA.NAME+4],&#039;EN&#039;
<span style="color:black">SYSINIT:3B73                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ihm_x
</span><span style="color:black">SYSINIT:3B75                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0Eh
</span><span style="color:black">SYSINIT:3B79                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">2020h       </span>; [es:ARENA.NAME+6],&#039;  &#039;
<span style="color:black">SYSINIT:3B7C
SYSINIT:3B7C </span><span style="color:gray">ihm_x</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B7C                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3B7D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3B7D </span>isHideMCB       <span style="color:black">endp
SYSINIT:3B7D
SYSINIT:3B7E
SYSINIT:3B7E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3B7E
SYSINIT:3B7E
SYSINIT:3B7E </span>freeMCB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B7E                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; marks as free the MCB at ES:0
<span style="color:black">SYSINIT:3B85                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2020h       </span>; &#039;  &#039;
<span style="color:black">SYSINIT:3B88                 </span><span style="color:navy">mov     es:</span><span style="color:green">8</span><span style="color:navy">, ax        </span>; mov word [es:ARENA.NAME+0],&#039;  &#039;
<span style="color:black">SYSINIT:3B8C                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Ah</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3B90                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Ch</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3B94                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Eh</span><span style="color:navy">, ax      </span>; [es:ARENA.NAME+6]
<span style="color:black">SYSINIT:3B98                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3B98 </span>freeMCB         <span style="color:black">endp
SYSINIT:3B98
SYSINIT:3B99
SYSINIT:3B99 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3B99
SYSINIT:3B99
SYSINIT:3B99 </span>HeadUmb         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3B99                 </span><span style="color:navy">push    es              </span>; returns in AX the addr of the 1st UMB block (0x9FFF)
<span style="color:black">SYSINIT:3B9A                 </span><span style="color:navy">mov     ah, </span><span style="color:green">52h
</span><span style="color:black">SYSINIT:3B9C                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - GET LIST OF LISTS
<span style="color:black">SYSINIT:3B9C                                         </span>; Return: ES:BX -&gt; DOS list of lists
<span style="color:black">SYSINIT:3B9E                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">8Ch      </span>; [es:UMB_HeadIdx]
<span style="color:black">SYSINIT:3BA2                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:3BA5                 </span><span style="color:navy">jz      short </span><span style="color:gray">xhu_e     </span>; If it&#039;s 0xFFFF, it&#039;s an error...
<span style="color:black">SYSINIT:3BA7                 </span><span style="color:navy">clc                     </span>; AX contains 0x9FFF for most systems
<span style="color:black">SYSINIT:3BA8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">xhu_x
</span><span style="color:black">SYSINIT:3BAA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3BAA
SYSINIT:3BAA </span><span style="color:gray">xhu_e</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3BAA                 </span><span style="color:navy">stc                     </span>; error
<span style="color:black">SYSINIT:3BAB
SYSINIT:3BAB </span><span style="color:gray">xhu_x</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3BAB                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3BAC                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3BAC </span>HeadUmb         <span style="color:black">endp
SYSINIT:3BAC
SYSINIT:3BAD
SYSINIT:3BAD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3BAD
SYSINIT:3BAD
SYSINIT:3BAD </span>linkumb         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3BAD                 </span><span style="color:navy">mov     ax, </span><span style="color:green">5802h       </span>; DOS_GET_UMBLINK
<span style="color:black">SYSINIT:3BB0                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:3BB0                                         </span>; AL = function code: (DOS 5beta) get UMB link state
<span style="color:black">SYSINIT:3BB2                 </span><span style="color:navy">or      al, al          </span>; Current link-state is now in al
<span style="color:black">SYSINIT:3BB2                                         </span>; al = 01h -&gt; UMBs in DOS memory chain
<span style="color:black">SYSINIT:3BB4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">lumbX     </span>; Jumps if UMBs already linked in
<span style="color:black">SYSINIT:3BB6                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5803h       </span>; DOS_SET_UMBLINK
<span style="color:black">SYSINIT:3BB9                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1           </span>; bx = 01h -&gt; add UMBs to DOS memory chain
<span style="color:black">SYSINIT:3BBC                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
<span style="color:black">SYSINIT:3BBC                                         </span>; AL = function code: (DOS 5beta) set UMB link state
<span style="color:black">SYSINIT:3BBE
SYSINIT:3BBE </span><span style="color:gray">lumbX</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3BBE                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3BBE </span>linkumb         <span style="color:black">endp
SYSINIT:3BBE
SYSINIT:3BBF
SYSINIT:3BBF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3BBF
SYSINIT:3BBF
SYSINIT:3BBF </span>InitDevLoad     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3BBF                 </span><span style="color:navy">cmp     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; Are we loading in UMB ?
<span style="color:black">SYSINIT:3BC5                 </span><span style="color:navy">jz      short </span><span style="color:gray">InitForLo </span>; no, init for lo mem
<span style="color:black">SYSINIT:3BC7                 </span><span style="color:navy">cmp     cs:</span>ConvLoad<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; Are we loading as per Dos 5?
<span style="color:black">SYSINIT:3BCD                 </span><span style="color:navy">jz      short </span><span style="color:gray">InitForConv
</span><span style="color:black">SYSINIT:3BCF                 </span><span style="color:navy">call    </span>ShrinkUMB       ; Stop using the old device arena
<span style="color:black">SYSINIT:3BD2                 </span><span style="color:navy">call    </span>HideUMBs        ; Mark up the UM area as we see fit
<span style="color:black">SYSINIT:3BD5                 </span><span style="color:navy">call    </span>FreezeUM        ; Hide everything BUT the load area
<span style="color:black">SYSINIT:3BD8                 </span><span style="color:navy">call    </span>GetUMBForDev    ; And grab that load area as needed
<span style="color:black">SYSINIT:3BDB                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:3BDC                 </span><span style="color:navy">call    </span>UnFreeze        ; Then unhide everything frozen
<span style="color:black">SYSINIT:3BDF                 </span><span style="color:navy">popf
</span><span style="color:black">SYSINIT:3BE0                 </span><span style="color:navy">jb      short </span><span style="color:gray">InitForLo </span>;  (if carry, it&#039;s loading low)
<span style="color:black">SYSINIT:3BE2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">InitForHi
</span><span style="color:black">SYSINIT:3BE4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3BE4
SYSINIT:3BE4 </span><span style="color:gray">InitForConv</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3BE4                 </span><span style="color:navy">call    </span>SpaceInUMB      ; Do we have space left in the current UMB ?
<span style="color:black">SYSINIT:3BE7                 </span><span style="color:navy">jnb     short </span><span style="color:gray">InitForHi </span>; yes, we have
<span style="color:black">SYSINIT:3BE9                 </span><span style="color:navy">call    </span>ShrinkUMB       ; shrink the current UMB in use
<span style="color:black">SYSINIT:3BEC                 </span><span style="color:navy">call    </span>GetUMBForDev    ; else try to allocate new UMB
<span style="color:black">SYSINIT:3BEF                 </span><span style="color:navy">jb      short </span><span style="color:gray">InitForLo </span>; we didn&#039;t succeed, so load in low memory
<span style="color:black">SYSINIT:3BF1
SYSINIT:3BF1 </span><span style="color:gray">InitForHi</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3BF1                 </span><span style="color:navy">mov     ax, cs:</span>DevUMBFree ; get Para addr of free mem
<span style="color:black">SYSINIT:3BF5                 </span><span style="color:navy">mov     dx, cs:</span>DevUMBAddr ; UMB start addr
<span style="color:black">SYSINIT:3BFA                 </span><span style="color:navy">add     dx, cs:</span>DevUMBSize ; dx = UMB End addr
<span style="color:black">SYSINIT:3BFF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">idl1
</span><span style="color:black">SYSINIT:3C01 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3C01
SYSINIT:3C01 </span><span style="color:gray">InitForLo</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C01                 </span><span style="color:navy">mov     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; in case we failed to load into UMB
<span style="color:black">SYSINIT:3C01                                         </span>; indicate that we are loading low
<span style="color:black">SYSINIT:3C07                 </span><span style="color:navy">mov     ax, cs:</span>memhi    ; start of Low memory
<span style="color:black">SYSINIT:3C0B                 </span><span style="color:navy">mov     dx, cs:</span>ALLOCLIM ; end of Low memory
<span style="color:black">SYSINIT:3C10
SYSINIT:3C10 </span><span style="color:gray">idl1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C10                 </span><span style="color:navy">call    </span>DevSetMark      ; setup a sub-arena for DD
<span style="color:black">SYSINIT:3C13                 </span><span style="color:navy">mov     cs:</span>DevLoadAddr<span style="color:navy">, ax </span>; init the Device load address
<span style="color:black">SYSINIT:3C17                 </span><span style="color:navy">mov     cs:</span>DevLoadEnd<span style="color:navy">, dx </span>; init the limit of the block
<span style="color:black">SYSINIT:3C1C                 </span><span style="color:navy">mov     word ptr cs:</span>DevEntry<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; init Entry point to DD
<span style="color:black">SYSINIT:3C23                 </span><span style="color:navy">mov     word ptr cs:</span>DevEntry<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3C27                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3C27 </span>InitDevLoad     <span style="color:black">endp
SYSINIT:3C27
SYSINIT:3C28
SYSINIT:3C28 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3C28
SYSINIT:3C28
SYSINIT:3C28 </span>SpaceInUMB      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C28                 </span><span style="color:navy">mov     ax, cs:</span>DevUMBSize
<span style="color:black">SYSINIT:3C2C                 </span><span style="color:navy">add     ax, cs:</span>DevUMBAddr ; End of UMB
<span style="color:black">SYSINIT:3C31                 </span><span style="color:navy">sub     ax, cs:</span>DevUMBFree ; - Free = Remaining space
<span style="color:black">SYSINIT:3C36                 </span><span style="color:navy">or      ax, ax          </span>; Nospace ?
<span style="color:black">SYSINIT:3C38                 </span><span style="color:navy">jnz     short </span><span style="color:gray">spcinumb1
</span><span style="color:black">SYSINIT:3C3A                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3C3B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3C3C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3C3C
SYSINIT:3C3C </span><span style="color:gray">spcinumb1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C3C                 </span><span style="color:navy">dec     ax              </span>; space for sub-arena
<span style="color:black">SYSINIT:3C3D                 </span><span style="color:navy">cmp     ax, cs:</span>DevSize  ; do we have space ?
<span style="color:black">SYSINIT:3C42                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3C42 </span>SpaceInUMB      <span style="color:black">endp
SYSINIT:3C42
SYSINIT:3C43
SYSINIT:3C43 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3C43
SYSINIT:3C43
SYSINIT:3C43 </span>PrepareMark     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C43                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3C44                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:3C46                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [ARENA.OWNER]
<span style="color:black">SYSINIT:3C4C                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4453h </span>; [ARENA.NAME],&#039;SD&#039;
<span style="color:black">SYSINIT:3C52                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3C53                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3C54                 </span><span style="color:navy">mov     cs:</span>DevUMBAddr<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3C58                 </span><span style="color:navy">mov     cs:</span>DevUMBFree<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3C5C                 </span><span style="color:navy">mov     cs:</span>DevUMBSize<span style="color:navy">, bx </span>; update the UMB Variables
<span style="color:black">SYSINIT:3C61                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3C61 </span>PrepareMark     <span style="color:black">endp
SYSINIT:3C61
SYSINIT:3C62
SYSINIT:3C62 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3C62
SYSINIT:3C62
SYSINIT:3C62 </span>GetUMBForDev    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C62                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">SYSINIT:3C65                 </span><span style="color:navy">mov     ax, </span><span style="color:green">4800h
</span><span style="color:black">SYSINIT:3C68                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:3C68                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:3C6A                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">SYSINIT:3C6C                 </span><span style="color:navy">jz      short </span><span style="color:gray">gufd_err
</span><span style="color:black">SYSINIT:3C6E                 </span><span style="color:navy">dec     bx
</span><span style="color:black">SYSINIT:3C6F                 </span><span style="color:navy">cmp     cs:</span>DevSize<span style="color:navy">, bx
</span><span style="color:black">SYSINIT:3C74                 </span><span style="color:navy">ja      short </span><span style="color:gray">gufd_err
</span><span style="color:black">SYSINIT:3C76                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:3C77                 </span><span style="color:navy">mov     ax, </span><span style="color:green">4800h
</span><span style="color:black">SYSINIT:3C7A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ALLOCATE MEMORY
<span style="color:black">SYSINIT:3C7A                                         </span>; BX = number of 16-byte paragraphs desired
<span style="color:black">SYSINIT:3C7C                 </span><span style="color:navy">jb      short </span><span style="color:gray">gufd_err
</span><span style="color:black">SYSINIT:3C7E                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:3C7F                 </span><span style="color:navy">call    </span>PrepareMark
<span style="color:black">SYSINIT:3C82                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3C83                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3C84 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3C84
SYSINIT:3C84 </span><span style="color:gray">gufd_err</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C84                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">SYSINIT:3C86                 </span><span style="color:navy">mov     cs:</span>DevUMBSize<span style="color:navy">, ax </span>; erase the previous values
<span style="color:black">SYSINIT:3C8A                 </span><span style="color:navy">mov     cs:</span>DevUMBAddr<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3C8E                 </span><span style="color:navy">mov     cs:</span>DevUMBFree<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3C92                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3C93                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3C93 </span>GetUMBForDev    <span style="color:black">endp
SYSINIT:3C93
SYSINIT:3C94
SYSINIT:3C94 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3C94
SYSINIT:3C94
SYSINIT:3C94 </span>DevSetMark      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3C94                 </span><span style="color:navy">push    es              </span>; Input :
<span style="color:black">SYSINIT:3C94                                         </span>; AX - Free segment were device is going to be loaded
<span style="color:black">SYSINIT:3C94                                         </span>; Output :
<span style="color:black">SYSINIT:3C94                                         </span>; AX - Segment at which device can be loaded (AX=AX+1)
<span style="color:black">SYSINIT:3C94                                         </span>;
<span style="color:black">SYSINIT:3C94                                         </span>; Creates a sub-arena for the device driver
<span style="color:black">SYSINIT:3C94                                         </span>; puts &#039;D&#039; marker in the sub-arena
<span style="color:black">SYSINIT:3C95                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:3C96                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:3C97                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:3C98                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3C9A                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">44h </span><span style="color:gray">; &#039;D&#039; </span>; [es:devmark.id],devmark_device ; &#039;D&#039;
<span style="color:black">SYSINIT:3CA0                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3CA1                 </span><span style="color:navy">mov     es:</span><span style="color:green">1</span><span style="color:navy">, ax        </span>; [es:devmark.seg]
<span style="color:black">SYSINIT:3CA5                 </span><span style="color:navy">push    ax              </span>; save load address
<span style="color:black">SYSINIT:3CA6                 </span><span style="color:navy">lds     si, cs:</span>bpb_addr ; command line is still there
<span style="color:black">SYSINIT:3CAB                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">SYSINIT:3CAD                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:3CAE
SYSINIT:3CAE </span><span style="color:gray">dsm_again</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3CAE                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:3CAF                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">SYSINIT:3CB1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">isit_slash
</span><span style="color:black">SYSINIT:3CB3                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">SYSINIT:3CB5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">dsm_again
</span><span style="color:black">SYSINIT:3CB7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3CB7
SYSINIT:3CB7 </span><span style="color:gray">isit_slash</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3CB7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">SYSINIT:3CB9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">isit_null
</span><span style="color:black">SYSINIT:3CBB                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">SYSINIT:3CBD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">dsm_again
</span><span style="color:black">SYSINIT:3CBF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3CBF
SYSINIT:3CBF </span><span style="color:gray">isit_null</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3CBF                 </span><span style="color:navy">or      al, al
</span><span style="color:black">SYSINIT:3CC1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dsm_again
</span><span style="color:black">SYSINIT:3CC3                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">SYSINIT:3CC5                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">8           </span>; devmark.filename ; 8
<span style="color:black">SYSINIT:3CC8                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8           </span>; maximum 8 characters
<span style="color:black">SYSINIT:3CCB
SYSINIT:3CCB </span><span style="color:gray">dsm_next_char</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3CCB                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:3CCC                 </span><span style="color:navy">or      al, al
</span><span style="color:black">SYSINIT:3CCE                 </span><span style="color:navy">jz      short </span><span style="color:gray">blankout
</span><span style="color:black">SYSINIT:3CD0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">SYSINIT:3CD2                 </span><span style="color:navy">jz      short </span><span style="color:gray">blankout
</span><span style="color:black">SYSINIT:3CD4                 </span><span style="color:navy">stosb
</span><span style="color:black">SYSINIT:3CD5                 </span><span style="color:navy">loop    </span><span style="color:gray">dsm_next_char
</span><span style="color:black">SYSINIT:3CD7
SYSINIT:3CD7 </span><span style="color:gray">blankout</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3CD7                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">dsm_exit
</span><span style="color:black">SYSINIT:3CD9                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:3CDB                 </span><span style="color:navy">rep stosb               </span>; blank out the rest
<span style="color:black">SYSINIT:3CDD
SYSINIT:3CDD </span><span style="color:gray">dsm_exit</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3CDD                 </span><span style="color:navy">pop     ax              </span>; restore load address
<span style="color:black">SYSINIT:3CDE                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:3CDF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3CE0                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:3CE1                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:3CE2                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3CE2 </span>DevSetMark      <span style="color:black">endp
SYSINIT:3CE2
SYSINIT:3CE3
SYSINIT:3CE3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3CE3
SYSINIT:3CE3
SYSINIT:3CE3 </span>SizeDevice      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3CE3                 </span><span style="color:navy">push    ds              </span>; Calculates the size of the device file in paras
<span style="color:black">SYSINIT:3CE3                                         </span>; and stores it in DevSize
<span style="color:black">SYSINIT:3CE4                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:3CE5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3CE6                 </span><span style="color:navy">mov     dx, si
</span><span style="color:black">SYSINIT:3CE8                 </span><span style="color:navy">mov     ax, </span><span style="color:green">3D00h
</span><span style="color:black">SYSINIT:3CEB                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - OPEN DISK FILE WITH HANDLE
<span style="color:black">SYSINIT:3CEB                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:black">SYSINIT:3CEB                                         </span>; AL = access mode
<span style="color:black">SYSINIT:3CEB                                         </span>; 0 - read
<span style="color:black">SYSINIT:3CED                 </span><span style="color:navy">jb      short </span><span style="color:gray">sd_err
</span><span style="color:black">SYSINIT:3CEF                 </span><span style="color:navy">mov     bx, ax          </span>; BX - file handle
<span style="color:black">SYSINIT:3CF1                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4202h
</span><span style="color:black">SYSINIT:3CF4                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:3CF6                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">SYSINIT:3CF8                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
<span style="color:black">SYSINIT:3CF8                                         </span>; AL = method: offset from end of file
<span style="color:black">SYSINIT:3CFA                 </span><span style="color:navy">jb      short </span><span style="color:gray">sd_close
</span><span style="color:black">SYSINIT:3CFC                 </span><span style="color:navy">add     ax, </span><span style="color:green">15
</span><span style="color:black">SYSINIT:3CFF                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3D02                 </span><span style="color:navy">test    dx, </span><span style="color:green">0FFF0h      </span>; size &gt; 0ffffh paras ?
<span style="color:black">SYSINIT:3D06                 </span><span style="color:navy">jz      short </span><span style="color:gray">sd_ctp    </span>; no
<span style="color:black">SYSINIT:3D08                 </span><span style="color:navy">mov     cs:</span>DevSize<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; invalid device size
<span style="color:black">SYSINIT:3D08                                         </span>; assuming that we fail later
<span style="color:black">SYSINIT:3D0F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sd_close
</span><span style="color:black">SYSINIT:3D11 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3D11
SYSINIT:3D11 </span><span style="color:gray">sd_ctp</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D11                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; convert it to paras
<span style="color:black">SYSINIT:3D13                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:black">SYSINIT:3D15                 </span><span style="color:navy">mov     cl, </span><span style="color:green">12
</span><span style="color:black">SYSINIT:3D17                 </span><span style="color:navy">shl     dx, cl
</span><span style="color:black">SYSINIT:3D19                 </span><span style="color:navy">or      ax, dx
</span><span style="color:black">SYSINIT:3D1B                 </span><span style="color:navy">mov     cs:</span>DevSize<span style="color:navy">, ax  </span>; save file size (in paragraphs)
<span style="color:black">SYSINIT:3D1F                 </span><span style="color:navy">clc                     </span>; CLC is not needed here
<span style="color:black">SYSINIT:3D1F                                         </span>; (OR instruction clears CF) - E.TAN 22/07/2023
<span style="color:black">SYSINIT:3D20
SYSINIT:3D20 </span><span style="color:gray">sd_close</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D20                 </span><span style="color:navy">pushf                   </span>; save carry flag
<span style="color:black">SYSINIT:3D21                 </span><span style="color:navy">mov     ax, </span><span style="color:green">3E00h
</span><span style="color:black">SYSINIT:3D24                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:black">SYSINIT:3D24                                         </span>; BX = file handle
<span style="color:black">SYSINIT:3D26                 </span><span style="color:navy">popf                    </span>; restore carry flag
<span style="color:black">SYSINIT:3D26                                         </span>; (we are not checking for &#039;close file&#039; err)
<span style="color:black">SYSINIT:3D27
SYSINIT:3D27 </span><span style="color:gray">sd_err</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D27                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3D28                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3D28 </span>SizeDevice      <span style="color:black">endp
SYSINIT:3D28
SYSINIT:3D29
SYSINIT:3D29 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3D29
SYSINIT:3D29
SYSINIT:3D29 </span>ExecDev         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D29                 </span><span style="color:navy">mov     bx, cs:</span>DevLoadAddr
<span style="color:black">SYSINIT:3D2E                 </span><span style="color:navy">mov     cs:</span>DevExecAddr<span style="color:navy">, bx </span>; Load the parameter block
<span style="color:black">SYSINIT:3D33                 </span><span style="color:navy">mov     cs:</span>DevExecReloc<span style="color:navy">, bx </span>; block for exec with Load address
<span style="color:black">SYSINIT:3D38                 </span><span style="color:navy">mov     bx, cs
</span><span style="color:black">SYSINIT:3D3A                 </span><span style="color:navy">mov     es, bx
</span><span style="color:black">SYSINIT:3D3C                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:3D3C                 </span><span style="color:navy">mov     bx, offset </span>DevExecAddr ; es:bx points to parameters
<span style="color:black">SYSINIT:3D3F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; (load program only)
<span style="color:black">SYSINIT:3D41                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4Bh         </span>; load in the device driver
<span style="color:black">SYSINIT:3D43                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - LOAD OR EXECUTE (EXEC)
<span style="color:black">SYSINIT:3D43                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:black">SYSINIT:3D43                                         </span>; ES:BX -&gt; parameter block
<span style="color:black">SYSINIT:3D43                                         </span>; AL = type of load
<span style="color:black">SYSINIT:3D45                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3D45 </span>ExecDev         <span style="color:black">endp
SYSINIT:3D45
SYSINIT:3D46
SYSINIT:3D46 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3D46
SYSINIT:3D46
SYSINIT:3D46 </span>RetFromUM       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D46                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:3D47                 </span><span style="color:navy">mov     cs:</span>ConvLoad<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; ConvLoad set if didn&#039;t previously call HideUMBs
<span style="color:black">SYSINIT:3D4D                 </span><span style="color:navy">call    </span>UnHideUMBs
<span style="color:black">SYSINIT:3D50                 </span><span style="color:navy">jb      short </span><span style="color:gray">rfUM1
</span><span style="color:black">SYSINIT:3D52                 </span><span style="color:navy">mov     cs:</span>ConvLoad<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; ConvLoad clear if did.
<span style="color:black">SYSINIT:3D58
SYSINIT:3D58 </span><span style="color:gray">rfUM1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D58                 </span><span style="color:navy">popf
</span><span style="color:black">SYSINIT:3D59                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3D59 </span>RetFromUM       <span style="color:black">endp
SYSINIT:3D59
SYSINIT:3D5A
SYSINIT:3D5A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3D5A
SYSINIT:3D5A
SYSINIT:3D5A </span>RemoveNull      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D5A                 </span><span style="color:navy">mov     bl, es:[si]
</span><span style="color:black">SYSINIT:3D5D                 </span><span style="color:navy">or      bl, bl          </span>; null ?
<span style="color:black">SYSINIT:3D5F                 </span><span style="color:navy">jz      short </span><span style="color:gray">rn_gotnull
</span><span style="color:black">SYSINIT:3D61                 </span><span style="color:navy">inc     si              </span>; advance the pointer
<span style="color:black">SYSINIT:3D62                 </span><span style="color:navy">jmp     short </span>RemoveNull
<span style="color:black">SYSINIT:3D64 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3D64
SYSINIT:3D64 </span><span style="color:gray">rn_gotnull</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D64                 </span><span style="color:navy">mov     bl, cs:</span>DevSavedDelim
<span style="color:black">SYSINIT:3D69                 </span><span style="color:navy">mov     es:[si], bl     </span>; replace null with blank
<span style="color:black">SYSINIT:3D6C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3D6C </span>RemoveNull      <span style="color:black">endp
SYSINIT:3D6C
SYSINIT:3D6D
SYSINIT:3D6D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3D6D
SYSINIT:3D6D
SYSINIT:3D6D </span>RoundBreakAddr  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D6D                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr ; Rounds DevBrkAddr to a para addr
<span style="color:black">SYSINIT:3D6D                                         </span>; so that it is of the form xxxx:0
<span style="color:black">SYSINIT:3D71                 </span><span style="color:navy">call    </span>ParaRound
<span style="color:black">SYSINIT:3D74                 </span><span style="color:navy">add     word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3D79                 </span><span style="color:navy">mov     word ptr cs:</span>DevBrkAddr<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3D80                 </span><span style="color:navy">mov     ax, cs:</span>DevLoadEnd
<span style="color:black">SYSINIT:3D84                 </span><span style="color:navy">cmp     word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3D89                 </span><span style="color:navy">jbe     short </span><span style="color:gray">rba_ok
</span><span style="color:black">SYSINIT:3D8B                 </span><span style="color:navy">jmp     </span>mem_err
<span style="color:black">SYSINIT:3D8E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3D8E
SYSINIT:3D8E </span><span style="color:gray">rba_ok</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D8E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3D8E </span>RoundBreakAddr  <span style="color:black">endp
SYSINIT:3D8E
SYSINIT:3D8F
SYSINIT:3D8F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3D8F
SYSINIT:3D8F
SYSINIT:3D8F </span>DevSetBreak     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3D8F                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:3D90                 </span><span style="color:navy">mov     ax, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2 </span>; remove the init code
<span style="color:black">SYSINIT:3D94                 </span><span style="color:navy">cmp     cs:</span>multdeviceflag<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3D9A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_break_continue </span>; do not check it.
<span style="color:black">SYSINIT:3D9C                 </span><span style="color:navy">cmp     ax, cs:</span>DevLoadAddr
<span style="color:black">SYSINIT:3DA1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_break_continue </span>; if not same, then o.k.
<span style="color:black">SYSINIT:3DA3                 </span><span style="color:navy">cmp     word ptr cs:</span>DevBrkAddr<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3DA9                 </span><span style="color:navy">jz      short </span><span style="color:gray">break_failed </span>; [DevBrkAddr+2]=[memhi] &amp; [DevBrkAddr]=0
<span style="color:black">SYSINIT:3DAB
SYSINIT:3DAB </span><span style="color:gray">set_break_continue</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3DAB                 </span><span style="color:navy">call    </span>RoundBreakAddr
<span style="color:black">SYSINIT:3DAE                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3DAF                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3DB0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3DB1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3DB1
SYSINIT:3DB1 </span><span style="color:gray">break_failed</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3DB1                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3DB2                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3DB3                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3DB3 </span>DevSetBreak     <span style="color:black">endp
SYSINIT:3DB3
SYSINIT:3DB4
SYSINIT:3DB4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3DB4
SYSINIT:3DB4
SYSINIT:3DB4 </span>DevBreak        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3DB4                 </span><span style="color:navy">push    ds              </span>; Marks a succesful install of a device driver
<span style="color:black">SYSINIT:3DB4                                         </span>; Sets device size field in sub-arena &amp;
<span style="color:black">SYSINIT:3DB4                                         </span>; Updates Free ptr in UMB or adjusts memhi
<span style="color:black">SYSINIT:3DB5                 </span><span style="color:navy">mov     ax, cs:</span>DevLoadAddr
<span style="color:black">SYSINIT:3DB9                 </span><span style="color:navy">mov     bx, word ptr cs:</span>DevBrkAddr<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">SYSINIT:3DBE                 </span><span style="color:navy">dec     ax              </span>; seg of sub-arena
<span style="color:black">SYSINIT:3DBF                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:3DC1                 </span><span style="color:navy">inc     ax              </span>; Back to Device segment
<span style="color:black">SYSINIT:3DC2                 </span><span style="color:navy">sub     ax, bx
</span><span style="color:black">SYSINIT:3DC4                 </span><span style="color:navy">neg     ax              </span>; size of device in paras
<span style="color:black">SYSINIT:3DC6                 </span><span style="color:navy">mov     ds:</span><span style="color:green">3</span><span style="color:navy">, ax        </span>; [devmark.size]
<span style="color:black">SYSINIT:3DC6                                         </span>; store it in sub-arena
<span style="color:black">SYSINIT:3DC9                 </span><span style="color:navy">cmp     cs:</span>DeviceHi<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3DCF                 </span><span style="color:navy">jz      short </span><span style="color:gray">db_lo
</span><span style="color:black">SYSINIT:3DD1                 </span><span style="color:navy">mov     cs:</span>DevUMBFree<span style="color:navy">, bx </span>; update Free ptr in UMB
<span style="color:black">SYSINIT:3DD6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">db_exit
</span><span style="color:black">SYSINIT:3DD8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3DD8
SYSINIT:3DD8 </span><span style="color:gray">db_lo</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3DD8                 </span><span style="color:navy">mov     cs:</span>memhi<span style="color:navy">, bx
</span><span style="color:black">SYSINIT:3DDD                 </span><span style="color:navy">mov     cs:</span>memlo<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3DE4
SYSINIT:3DE4 </span><span style="color:gray">db_exit</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3DE4                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3DE5                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3DE5 </span>DevBreak        <span style="color:black">endp
SYSINIT:3DE5
SYSINIT:3DE6
SYSINIT:3DE6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3DE6
SYSINIT:3DE6
SYSINIT:3DE6 </span>ParseSize       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3DE6                 </span><span style="color:navy">push    bx              </span>; Parses the command line for SIZE= command
<span style="color:black">SYSINIT:3DE7                 </span><span style="color:navy">mov     bx, si
</span><span style="color:black">SYSINIT:3DE9                 </span><span style="color:navy">mov     cs:</span>DevSizeOption<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; init the value
<span style="color:black">SYSINIT:3DF0                 </span><span style="color:navy">mov     cs:</span>DevCmdLine<span style="color:navy">, si
</span><span style="color:black">SYSINIT:3DF5                 </span><span style="color:navy">mov     cs:</span>DevCmdLine<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:3DFA                 </span><span style="color:navy">call    </span>SkipDelim
<span style="color:black">SYSINIT:3DFD                 </span><span style="color:navy">cmp     word ptr es:[si], </span><span style="color:#ff8000">4953h </span>; &#039;SI&#039;
<span style="color:black">SYSINIT:3E02                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ps_no_size
</span><span style="color:black">SYSINIT:3E04                 </span><span style="color:navy">cmp     word ptr es:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">455Ah </span>; &#039;ZE&#039;
<span style="color:black">SYSINIT:3E0A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ps_no_size
</span><span style="color:black">SYSINIT:3E0C                 </span><span style="color:navy">mov     al, es:[si+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:3E10                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:3E13                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ps_no_size </span>; cf=0 here
<span style="color:black">SYSINIT:3E15                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">5
</span><span style="color:black">SYSINIT:3E18                 </span><span style="color:navy">call    </span>GetHexNum
<span style="color:black">SYSINIT:3E1B                 </span><span style="color:navy">jb      short </span><span style="color:gray">ps_err
</span><span style="color:black">SYSINIT:3E1D                 </span><span style="color:navy">mov     cs:</span>DevSizeOption<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:3E21                 </span><span style="color:navy">call    </span>SkipDelim
<span style="color:black">SYSINIT:3E24                 </span><span style="color:navy">mov     bx, si          </span>; cf=0 here
<span style="color:black">SYSINIT:3E26
SYSINIT:3E26 </span><span style="color:gray">ps_no_size</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E26                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">SYSINIT:3E28                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3E29                 </span><span style="color:navy">clc                     </span>; cf=0 here (clc is not needed)
<span style="color:black">SYSINIT:3E29                                         </span>; 22/07/2023 - Erdogan Tan
<span style="color:black">SYSINIT:3E2A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E2B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3E2B
SYSINIT:3E2B </span><span style="color:gray">ps_err</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E2B                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:3E2C                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3E2D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E2D </span>ParseSize       <span style="color:black">endp
SYSINIT:3E2D
SYSINIT:3E2E
SYSINIT:3E2E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3E2E
SYSINIT:3E2E
SYSINIT:3E2E </span>SkipDelim       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E2E                 </span><span style="color:navy">mov     al, es:[si]     </span>; Skips delimiters in the string pointed to by ES:SI
<span style="color:black">SYSINIT:3E2E                                         </span>; Returns ptr to first non-delimiter character in ES:SI
<span style="color:black">SYSINIT:3E31                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:3E34                 </span><span style="color:navy">jnz     short </span><span style="color:gray">sd_ret
</span><span style="color:black">SYSINIT:3E36                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:3E37                 </span><span style="color:navy">jmp     short </span>SkipDelim
<span style="color:black">SYSINIT:3E39 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3E39
SYSINIT:3E39 </span><span style="color:gray">sd_ret</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E39                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E39 </span>SkipDelim       <span style="color:black">endp
SYSINIT:3E39
SYSINIT:3E3A
SYSINIT:3E3A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3E3A
SYSINIT:3E3A
SYSINIT:3E3A </span>GetHexNum       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E3A                 </span><span style="color:navy">xor     ax, ax          </span>; Converts an ascii string
<span style="color:black">SYSINIT:3E3A                                         </span>; terminated by a delimiter into binary.
<span style="color:black">SYSINIT:3E3A                                         </span>; Assumes that the ES:SI
<span style="color:black">SYSINIT:3E3A                                         </span>; points to a Hexadecimal string
<span style="color:black">SYSINIT:3E3C                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">SYSINIT:3E3E
SYSINIT:3E3E </span><span style="color:gray">ghn_next</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E3E                 </span><span style="color:navy">mov     bl, es:[si]
</span><span style="color:black">SYSINIT:3E41                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:3E44                 </span><span style="color:navy">jz      short </span><span style="color:gray">ghn_err
</span><span style="color:black">SYSINIT:3E46                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:3E49                 </span><span style="color:navy">jz      short </span><span style="color:gray">ghn_err
</span><span style="color:black">SYSINIT:3E4B                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:3E4C                 </span><span style="color:navy">mov     al, bl
</span><span style="color:black">SYSINIT:3E4E                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:3E51                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3E52                 </span><span style="color:navy">jz      short </span><span style="color:gray">ghn_into_paras
</span><span style="color:black">SYSINIT:3E54                 </span><span style="color:navy">call    </span>GetNibble
<span style="color:black">SYSINIT:3E57                 </span><span style="color:navy">jb      short </span><span style="color:gray">ghn_err
</span><span style="color:black">SYSINIT:3E59                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:black">SYSINIT:3E5C
SYSINIT:3E5C </span><span style="color:gray">ghn_shift1</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E5C                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:3E5E                 </span><span style="color:navy">rcl     dx, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:3E60                 </span><span style="color:navy">loop    </span><span style="color:gray">ghn_shift1
</span><span style="color:black">SYSINIT:3E62                 </span><span style="color:navy">or      al, bl
</span><span style="color:black">SYSINIT:3E64                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:3E65                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ghn_next
</span><span style="color:black">SYSINIT:3E67 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3E67
SYSINIT:3E67 </span><span style="color:gray">ghn_into_paras</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E67                 </span><span style="color:navy">add     ax, </span><span style="color:green">15
</span><span style="color:black">SYSINIT:3E6A                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:3E6D                 </span><span style="color:navy">test    dx, </span><span style="color:green">0FFF0h
</span><span style="color:black">SYSINIT:3E71                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ghn_err
</span><span style="color:black">SYSINIT:3E73                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:black">SYSINIT:3E76
SYSINIT:3E76 </span><span style="color:gray">ghn_shift2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E76                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3E77                 </span><span style="color:navy">rcr     dx, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:3E79                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:3E7B                 </span><span style="color:navy">loop    </span><span style="color:gray">ghn_shift2
</span><span style="color:black">SYSINIT:3E7D                 </span><span style="color:navy">clc                     </span>; AX = number of paras equivalent to the
<span style="color:black">SYSINIT:3E7D                                         </span>; hex number of bytes specified
<span style="color:black">SYSINIT:3E7D                                         </span>; by the hexadecimal string.
<span style="color:black">SYSINIT:3E7E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E7F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3E7F
SYSINIT:3E7F </span><span style="color:gray">ghn_err</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E7F                 </span><span style="color:navy">stc                     </span>; encountered a non-hex character or crlf
<span style="color:black">SYSINIT:3E80                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E80 </span>GetHexNum       <span style="color:black">endp
SYSINIT:3E80
SYSINIT:3E81
SYSINIT:3E81 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3E81
SYSINIT:3E81
SYSINIT:3E81 </span>GetNibble       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E81                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; Convert one nibble (hex digit) in BL into binary
<span style="color:black">SYSINIT:3E84                 </span><span style="color:navy">jb      short </span><span style="color:gray">gnib_err
</span><span style="color:black">SYSINIT:3E86                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">39h </span><span style="color:gray">; &#039;9&#039;
</span><span style="color:black">SYSINIT:3E89                 </span><span style="color:navy">ja      short </span><span style="color:gray">is_it_hex
</span><span style="color:black">SYSINIT:3E8B                 </span><span style="color:navy">sub     bl, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;
</span><span style="color:black">SYSINIT:3E8E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E8F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3E8F
SYSINIT:3E8F </span><span style="color:gray">is_it_hex</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E8F                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;
</span><span style="color:black">SYSINIT:3E92                 </span><span style="color:navy">jb      short </span><span style="color:gray">gnib_err
</span><span style="color:black">SYSINIT:3E94                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">46h </span><span style="color:gray">; &#039;F&#039;
</span><span style="color:black">SYSINIT:3E97                 </span><span style="color:navy">ja      short </span><span style="color:gray">gnib_err
</span><span style="color:black">SYSINIT:3E99                 </span><span style="color:navy">sub     bl, </span><span style="color:#ff8000">37h </span><span style="color:gray">; &#039;7&#039;   </span>; &#039;A&#039;- 10
<span style="color:black">SYSINIT:3E9C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E9D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3E9D
SYSINIT:3E9D </span><span style="color:gray">gnib_err</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E9D                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3E9E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3E9E </span>GetNibble       <span style="color:black">endp
SYSINIT:3E9E
SYSINIT:3E9F
SYSINIT:3E9F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3E9F
SYSINIT:3E9F
SYSINIT:3E9F </span>AllocUMB        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3E9F                 </span><span style="color:navy">call    </span>InitAllocUMB    ; Allocate all UMBs and link it to DOS arena chain
<span style="color:black">SYSINIT:3E9F                                         </span>; link in the first UMB
<span style="color:black">SYSINIT:3EA2                 </span><span style="color:navy">jb      short </span><span style="color:gray">au_exit   </span>; quit on error
<span style="color:black">SYSINIT:3EA4
SYSINIT:3EA4 </span><span style="color:gray">au_next</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3EA4                 </span><span style="color:navy">call    </span>umb_allocate    ; allocate
<span style="color:black">SYSINIT:3EA7                 </span><span style="color:navy">jb      short </span><span style="color:gray">au_coalesce
</span><span style="color:black">SYSINIT:3EA9                 </span><span style="color:navy">call    </span>umb_insert      ; &amp; insert till no UMBs
<span style="color:black">SYSINIT:3EAC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">au_next
</span><span style="color:black">SYSINIT:3EAE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3EAE
SYSINIT:3EAE </span><span style="color:gray">au_coalesce</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3EAE                 </span><span style="color:navy">call    </span>umb_coalesce    ; coalesce all UMBs
<span style="color:black">SYSINIT:3EB1
SYSINIT:3EB1 </span><span style="color:gray">au_exit</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3EB1                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3EB1 </span>AllocUMB        <span style="color:black">endp
SYSINIT:3EB1
SYSINIT:3EB2
SYSINIT:3EB2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3EB2
SYSINIT:3EB2
SYSINIT:3EB2 </span>InitAllocUMB    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3EB2                 </span><span style="color:navy">call    </span>IsXMSLoaded
<span style="color:black">SYSINIT:3EB5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">iau_err   </span>; quit on no XMS driver
<span style="color:black">SYSINIT:3EB7                 </span><span style="color:navy">mov     ah, </span><span style="color:green">52h
</span><span style="color:black">SYSINIT:3EB9                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ internal - GET LIST OF LISTS
<span style="color:black">SYSINIT:3EB9                                         </span>; Return: ES:BX -&gt; DOS list of lists
<span style="color:black">SYSINIT:3EBB                 </span><span style="color:navy">mov     cs:</span>DevDOSData<span style="color:navy">, es </span>; save dos data segment
<span style="color:black">SYSINIT:3EC0                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4310h
</span><span style="color:black">SYSINIT:3EC3                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - XMS - GET DRIVER ADDRESS
<span style="color:black">SYSINIT:3EC3                                         </span>; Return: ES:BX -&gt; driver entry point
<span style="color:black">SYSINIT:3EC5                 </span><span style="color:navy">mov     word ptr cs:</span>DevXMSAddr<span style="color:navy">, bx </span>; get XMS driver address
<span style="color:black">SYSINIT:3ECA                 </span><span style="color:navy">mov     word ptr cs:</span>DevXMSAddr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">SYSINIT:3ECF                 </span><span style="color:navy">cmp     cs:</span>FirstUMBLinked<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; have we already linked a UMB?
<span style="color:black">SYSINIT:3ED5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ia_1      </span>; quit if we already did it
<span style="color:black">SYSINIT:3ED7                 </span><span style="color:navy">call    </span>LinkFirstUMB    ; else link the first UMB
<span style="color:black">SYSINIT:3EDA                 </span><span style="color:navy">jb      short </span><span style="color:gray">iau_err
</span><span style="color:black">SYSINIT:3EDC                 </span><span style="color:navy">mov     cs:</span>FirstUMBLinked<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; mark that 1st UMB linked
<span style="color:black">SYSINIT:3EE2
SYSINIT:3EE2 </span><span style="color:gray">ia_1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3EE2                 </span><span style="color:navy">clc                     </span>; (cf is already zero here)
<span style="color:black">SYSINIT:3EE2                                         </span>; Erdogan tan - 27/07/2023
<span style="color:black">SYSINIT:3EE3                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3EE4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3EE4
SYSINIT:3EE4 </span><span style="color:gray">iau_err</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3EE4                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3EE5                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3EE5 </span>InitAllocUMB    <span style="color:black">endp
SYSINIT:3EE5
SYSINIT:3EE6
SYSINIT:3EE6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3EE6
SYSINIT:3EE6
SYSINIT:3EE6 </span>umb_allocate    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3EE6                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:3EE7                 </span><span style="color:navy">mov     ah, </span><span style="color:green">16          </span>; XMM_REQUEST_UMB
<span style="color:black">SYSINIT:3EE9                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0FFFFh      </span>; try to allocate largest possible
<span style="color:black">SYSINIT:3EEC                 </span><span style="color:navy">call    cs:</span>DevXMSAddr
<span style="color:black">SYSINIT:3EF1                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">SYSINIT:3EF3                 </span><span style="color:navy">jz      short </span><span style="color:gray">ua_err
</span><span style="color:black">SYSINIT:3EF5                 </span><span style="color:navy">mov     ah, </span><span style="color:green">16
</span><span style="color:black">SYSINIT:3EF7                 </span><span style="color:navy">call    cs:</span>DevXMSAddr
<span style="color:black">SYSINIT:3EFC                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">1           </span>; Q: was the reqst successful
<span style="color:black">SYSINIT:3EFF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ua_err    </span>; N: error
<span style="color:black">SYSINIT:3F01                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:3F02
SYSINIT:3F02 </span><span style="color:gray">ua_done</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3F02                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:3F03                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3F04 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3F04
SYSINIT:3F04 </span><span style="color:gray">ua_err</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3F04                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:3F05                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ua_done
</span><span style="color:black">SYSINIT:3F05 </span>umb_allocate    <span style="color:black">endp
SYSINIT:3F05
SYSINIT:3F07
SYSINIT:3F07 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3F07
SYSINIT:3F07
SYSINIT:3F07 </span>umb_insert      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3F07                 </span><span style="color:navy">push    ds              </span>; links the UMB into the arena chain
<span style="color:black">SYSINIT:3F08                 </span><span style="color:navy">mov     ds, cs:</span>DevDOSData
<span style="color:black">SYSINIT:3F0D                 </span><span style="color:navy">mov     ds, word ptr ds:</span><span style="color:green">8Ch </span>; [UMB_ARENA]  ; ds = UMB_HEAD
<span style="color:black">SYSINIT:3F11                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">SYSINIT:3F13                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:3F15                 </span>assume es:nothing
<span style="color:black">SYSINIT:3F15
SYSINIT:3F15 </span><span style="color:gray">ui_next</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3F15                 </span><span style="color:navy">cmp     ax, bx          </span>; BX = seg address of UMB to be linked in
<span style="color:black">SYSINIT:3F17                 </span><span style="color:navy">ja      short </span><span style="color:gray">ui_insert </span>; current block above new block, insert it
<span style="color:black">SYSINIT:3F19                 </span><span style="color:navy">cmp     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:3F1F                 </span><span style="color:navy">jz      short </span><span style="color:gray">ui_append </span>; if current block is the last,
<span style="color:black">SYSINIT:3F1F                                         </span>; append new block to chain
<span style="color:black">SYSINIT:3F21                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:3F23                 </span><span style="color:navy">call    </span>get_next
<span style="color:black">SYSINIT:3F26                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ui_next   </span>; ax = es = next block
<span style="color:black">SYSINIT:3F28 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3F28
SYSINIT:3F28 </span><span style="color:gray">ui_insert</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3F28                 </span><span style="color:navy">mov     cx, ds          </span>; ds = previous arena
<span style="color:black">SYSINIT:3F2A                 </span><span style="color:navy">inc     cx              </span>; top of previous block
<span style="color:black">SYSINIT:3F2B                 </span><span style="color:navy">sub     cx, bx
</span><span style="color:black">SYSINIT:3F2D                 </span><span style="color:navy">neg     cx              </span>; cx = size of used block
<span style="color:black">SYSINIT:3F2F                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [ARENA.SIGNATURE],arena_signature_normal
<span style="color:black">SYSINIT:3F34                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [ARENA.OWNER],8 ; mark as system owned
<span style="color:black">SYSINIT:3F3A                 </span><span style="color:navy">mov     ds:</span><span style="color:green">3</span><span style="color:navy">, cx        </span>; [ARENA.SIZE],cx
<span style="color:black">SYSINIT:3F3E                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4353h </span>; [ARENA.NAME],&#039;SC&#039;
<span style="color:black">SYSINIT:3F44                 </span><span style="color:navy">mov     es, bx          </span>; prepare the arena at start of new block
<span style="color:black">SYSINIT:3F46                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_normal
<span style="color:black">SYSINIT:3F4C                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [es:ARENA.OWNER],arena_owner_system ; mark as free
<span style="color:black">SYSINIT:3F53                 </span><span style="color:navy">sub     dx, </span><span style="color:#ff8000">2           </span>; DX = size of UMB to be linked in paras
<span style="color:black">SYSINIT:3F53                                         </span>; make room for arena at start &amp; end of new block
<span style="color:black">SYSINIT:3F56                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, dx        </span>; [es:ARENA.SIZE],dx
<span style="color:black">SYSINIT:3F5B                 </span><span style="color:navy">add     bx, dx          </span>; prepare arena at end of new block
<span style="color:black">SYSINIT:3F5D                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:3F5E                 </span><span style="color:navy">mov     es, bx          </span>; es = arena at top of new block
<span style="color:black">SYSINIT:3F60                 </span><span style="color:navy">inc     bx              </span>; bx = top of new block
<span style="color:black">SYSINIT:3F61                 </span><span style="color:navy">sub     ax, bx          </span>; ax contains arena just above this block
<span style="color:black">SYSINIT:3F61                                         </span>; result: ax = size of used block
<span style="color:black">SYSINIT:3F63                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_normal
<span style="color:black">SYSINIT:3F69                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER],8 ; mark as system owned
<span style="color:black">SYSINIT:3F70                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, ax        </span>; [es:ARENA.SIZE],ax
<span style="color:black">SYSINIT:3F74                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4353h </span>; [es:ARENA.NAME],&#039;SC&#039;
<span style="color:black">SYSINIT:3F7B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ui_done
</span><span style="color:black">SYSINIT:3F7D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3F7D
SYSINIT:3F7D </span><span style="color:gray">ui_append</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3F7D                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; es = arena of last block
<span style="color:black">SYSINIT:3F7D                                         </span>; [es:ARENA.SIZE] ; ax=top of last block-1 para
<span style="color:black">SYSINIT:3F82                 </span><span style="color:navy">sub     word ptr es:</span><span style="color:green">3</span><span style="color:navy">, </span><span style="color:#ff8000">1 </span>; reserve space on top of this
<span style="color:black">SYSINIT:3F82                                         </span>; block for the next arena.
<span style="color:black">SYSINIT:3F88                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_normal
<span style="color:black">SYSINIT:3F8E                 </span><span style="color:navy">mov     cx, ax          </span>; cx = top of prev block-1
<span style="color:black">SYSINIT:3F90                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:3F91                 </span><span style="color:navy">sub     ax, bx          </span>; ax = top of prev block - seg. addr of new block
<span style="color:black">SYSINIT:3F93                 </span><span style="color:navy">neg     ax
</span><span style="color:black">SYSINIT:3F95                 </span><span style="color:navy">mov     es, cx          </span>; es = arena of unused block
<span style="color:black">SYSINIT:3F97                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_normal
<span style="color:black">SYSINIT:3F9D                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER],8 ; mark as system owned
<span style="color:black">SYSINIT:3FA4                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, ax        </span>; mov [es:ARENA.SIZE],ax
<span style="color:black">SYSINIT:3FA8                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4353h </span>; mov word [es:ARENA.NAME],&#039;SC&#039;
<span style="color:black">SYSINIT:3FAF                 </span><span style="color:navy">mov     es, bx          </span>; prepare the arena at start of new block
<span style="color:black">SYSINIT:3FB1                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:3FB7                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [es:ARENA.OWNER],arena_owner_system
<span style="color:black">SYSINIT:3FB7                                         </span>; mark as free
<span style="color:black">SYSINIT:3FBE                 </span><span style="color:navy">dec     dx              </span>; make room for arena
<span style="color:black">SYSINIT:3FBF                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, dx        </span>; mov [es:ARENA.SIZE],dx
<span style="color:black">SYSINIT:3FC4
SYSINIT:3FC4 </span><span style="color:gray">ui_done</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3FC4                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:3FC5                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:3FC5 </span>umb_insert      <span style="color:black">endp
SYSINIT:3FC5
SYSINIT:3FC6
SYSINIT:3FC6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:3FC6
SYSINIT:3FC6
SYSINIT:3FC6 </span>umb_coalesce    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3FC6                 </span><span style="color:navy">xor     di, di          </span>; Combine free blocks ahead with current block
<span style="color:black">SYSINIT:3FC8                 </span><span style="color:navy">mov     es, cs:</span>DevDOSData
<span style="color:black">SYSINIT:3FCD                 </span><span style="color:navy">mov     es, word ptr es:</span><span style="color:green">8Ch </span>; [es:UMB_ARENA] ; es = UMB_HEAD
<span style="color:black">SYSINIT:3FD2
SYSINIT:3FD2 </span><span style="color:gray">uc_nextfree</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3FD2                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:3FD4                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:3FD6                 </span><span style="color:navy">cmp     es:</span><span style="color:green">1</span><span style="color:navy">, di        </span>; [es:ARENA.OWNER],di
<span style="color:black">SYSINIT:3FD6                                         </span>; Q: is current arena free
<span style="color:black">SYSINIT:3FDB                 </span><span style="color:navy">jz      short </span><span style="color:gray">uc_again  </span>; Y: try to coalesce with next block
<span style="color:black">SYSINIT:3FDB                                         </span>; N: get next arena
<span style="color:black">SYSINIT:3FDD                 </span><span style="color:navy">call    </span>get_next        ; es, ax = next arena
<span style="color:black">SYSINIT:3FE0                 </span><span style="color:navy">jb      short </span><span style="color:gray">uc_done
</span><span style="color:black">SYSINIT:3FE2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">uc_nextfree
</span><span style="color:black">SYSINIT:3FE4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:3FE4
SYSINIT:3FE4 </span><span style="color:gray">uc_again</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:3FE4                 </span><span style="color:navy">call    </span>get_next        ; es, ax = next arena
<span style="color:black">SYSINIT:3FE7                 </span><span style="color:navy">jb      short </span><span style="color:gray">uc_done
</span><span style="color:black">SYSINIT:3FE9                 </span><span style="color:navy">cmp     es:</span><span style="color:green">1</span><span style="color:navy">, di        </span>; [es:ARENA.OWNER],di
<span style="color:black">SYSINIT:3FE9                                         </span>; Q: is arena free
<span style="color:black">SYSINIT:3FEE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">uc_nextfree </span>; N: get next free arena
<span style="color:black">SYSINIT:3FEE                                         </span>; Y: coalesce
<span style="color:black">SYSINIT:3FF0                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:3FF0                                         </span>; cx = next block size
<span style="color:black">SYSINIT:3FF5                 </span><span style="color:navy">inc     cx              </span>; cx = cx + 1 (for header size)
<span style="color:black">SYSINIT:3FF6                 </span><span style="color:navy">add     ds:</span><span style="color:green">3</span><span style="color:navy">, cx        </span>; [ARENA.SIZE],cx
<span style="color:black">SYSINIT:3FF6                                         </span>; current size = current size + cx
<span style="color:black">SYSINIT:3FFA                 </span><span style="color:navy">mov     cl, es:[di]     </span>; move up signature
<span style="color:black">SYSINIT:3FFD                 </span><span style="color:navy">mov     [di], cl
</span><span style="color:black">SYSINIT:3FFF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">uc_again  </span>; try again
<span style="color:black">SYSINIT:4001 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4001
SYSINIT:4001 </span><span style="color:gray">uc_done</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4001                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4001 </span>umb_coalesce    <span style="color:black">endp
SYSINIT:4001
SYSINIT:4002
SYSINIT:4002 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4002
SYSINIT:4002
SYSINIT:4002 </span>get_next        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4002                 </span><span style="color:navy">cmp     byte ptr ds:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039; </span>; Find Next item in Arena
<span style="color:black">SYSINIT:4002                                         </span>; cmp byte [ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:4007                 </span><span style="color:navy">jz      short </span><span style="color:gray">gn_err
</span><span style="color:black">SYSINIT:4009                 </span><span style="color:navy">mov     ax, ds          </span>; ax = current block
<span style="color:black">SYSINIT:400B                 </span><span style="color:navy">add     ax, ds:</span><span style="color:green">3        </span>; add ax,[ARENA.SIZE]
<span style="color:black">SYSINIT:400B                                         </span>; ax = ax + current block length
<span style="color:black">SYSINIT:400F                 </span><span style="color:navy">inc     ax              </span>; remember that header!
<span style="color:black">SYSINIT:4010                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:4012                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:4013                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4014 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4014
SYSINIT:4014 </span><span style="color:gray">gn_err</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4014                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:4015                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4015 </span>get_next        <span style="color:black">endp
SYSINIT:4015
SYSINIT:4016
SYSINIT:4016 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4016
SYSINIT:4016
SYSINIT:4016 </span>LinkFirstUMB    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4016                 </span><span style="color:navy">call    </span>umb_allocate
<span style="color:black">SYSINIT:4019                 </span><span style="color:navy">jb      short </span><span style="color:gray">lfu_er
</span><span style="color:black">SYSINIT:401B                 </span><span style="color:navy">int     </span><span style="color:green">12h             </span>; MEMORY SIZE -
<span style="color:black">SYSINIT:401B                                         </span>; Return: AX = number of contiguous 1K blocks of memory
<span style="color:black">SYSINIT:401D                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">6
</span><span style="color:black">SYSINIT:401F                 </span><span style="color:navy">shl     ax, cl          </span>; ax = size in paragraphs
<span style="color:black">SYSINIT:4021                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:4023                 </span><span style="color:navy">sub     ax, bx          </span>; bx = segment of allocated UMB
<span style="color:black">SYSINIT:4023                                         </span>; ax = - size of unused block
<span style="color:black">SYSINIT:4025                 </span><span style="color:navy">neg     ax
</span><span style="color:black">SYSINIT:4027                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">1           </span>; cx = first umb_arena
<span style="color:black">SYSINIT:402A                 </span><span style="color:navy">mov     es, cx          </span>; es = first umb_arena
<span style="color:black">SYSINIT:402C                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_normal
<span style="color:black">SYSINIT:4032                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER],8 ; mark as system owned
<span style="color:black">SYSINIT:4039                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, ax        </span>; mov [es:ARENA.SIZE],ax
<span style="color:black">SYSINIT:403D                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">4353h </span>; [es:ARENA.NAME],&#039;SC&#039;
<span style="color:black">SYSINIT:4044                 </span><span style="color:navy">mov     es, bx          </span>; put in the arena for the first UMB
<span style="color:black">SYSINIT:4044                                         </span>; es has first free umb seg
<span style="color:black">SYSINIT:4046                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:404C                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; es:ARENA.OWNER],arena_owner_system
<span style="color:black">SYSINIT:404C                                         </span>; mark as free
<span style="color:black">SYSINIT:4053                 </span><span style="color:navy">dec     dx              </span>; dx = size of UMB
<span style="color:black">SYSINIT:4053                                         </span>; make room for arena
<span style="color:black">SYSINIT:4054                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, dx        </span>; [es:ARENA.SIZE],dx
<span style="color:black">SYSINIT:4059                 </span><span style="color:navy">mov     es, cs:</span>DevDOSData
<span style="color:black">SYSINIT:405E                 </span><span style="color:navy">mov     di, </span><span style="color:green">8Ch         </span>; UMB_ARENA
<span style="color:black">SYSINIT:4061                 </span><span style="color:navy">mov     es:[di], cx     </span>; initialize umb_head in DOS data segment
<span style="color:black">SYSINIT:4061                                         </span>; with the arena just below Top of Memory
<span style="color:black">SYSINIT:4061                                         </span>;
<span style="color:black">SYSINIT:4061                                         </span>; we must now scan the arena chain and
<span style="color:black">SYSINIT:4061                                         </span>; update the size of the last arena
<span style="color:black">SYSINIT:4064                 </span><span style="color:navy">mov     di, </span><span style="color:green">24h         </span>; DOS_ARENA
<span style="color:black">SYSINIT:4067                 </span><span style="color:navy">mov     es, word ptr es:[di] </span>; es = start arena
<span style="color:black">SYSINIT:406A                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">SYSINIT:406C
SYSINIT:406C </span><span style="color:gray">scannext</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:406C                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039; </span>; arena_signature_end
<span style="color:black">SYSINIT:4070                 </span><span style="color:navy">jz      short </span><span style="color:gray">got_last
</span><span style="color:black">SYSINIT:4072                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:4074                 </span><span style="color:navy">add     ax, es:</span><span style="color:green">3        </span>; [es:ARENA.SIZE]
<span style="color:black">SYSINIT:4079                 </span><span style="color:navy">inc     ax
</span><span style="color:black">SYSINIT:407A                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:407C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scannext
</span><span style="color:black">SYSINIT:407E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:407E
SYSINIT:407E </span><span style="color:gray">got_last</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:407E                 </span><span style="color:navy">sub     word ptr es:</span><span style="color:green">3</span><span style="color:navy">, </span><span style="color:#ff8000">1 </span>; sub word [es:ARENA.SIZE],1
<span style="color:black">SYSINIT:4084                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039; </span>; [es:ARENA.SIGNATURE],arena_signature_normal
<span style="color:black">SYSINIT:408A                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:408B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:408C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:408C
SYSINIT:408C </span><span style="color:gray">lfu_er</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:408C                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:408D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:408D </span>LinkFirstUMB    <span style="color:black">endp
SYSINIT:408D
SYSINIT:408E
SYSINIT:408E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:408E
SYSINIT:408E
SYSINIT:408E </span>ShrinkUMB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:408E                 </span><span style="color:navy">cmp     cs:</span>DevUMBAddr<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Shrinks the current UMB in use,
<span style="color:black">SYSINIT:408E                                         </span>; so that the unused portions of the UMB
<span style="color:black">SYSINIT:408E                                         </span>; is given back to the DOS free mem pool
<span style="color:black">SYSINIT:4094                 </span><span style="color:navy">jz      short </span><span style="color:gray">su_exit
</span><span style="color:black">SYSINIT:4096                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4097                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:4098                 </span><span style="color:navy">mov     bx, cs:</span>DevUMBFree
<span style="color:black">SYSINIT:409D                 </span><span style="color:navy">sub     bx, cs:</span>DevUMBAddr
<span style="color:black">SYSINIT:40A2                 </span><span style="color:navy">mov     es, cs:</span>DevUMBAddr
<span style="color:black">SYSINIT:40A7                 </span><span style="color:navy">mov     ax, </span><span style="color:green">4A00h
</span><span style="color:black">SYSINIT:40AA                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
<span style="color:black">SYSINIT:40AA                                         </span>; ES = segment address of block to change
<span style="color:black">SYSINIT:40AA                                         </span>; BX = new size in paragraphs
<span style="color:black">SYSINIT:40AC                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">SYSINIT:40AE                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:40AF                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:40B1                 </span>assume es:nothing
<span style="color:black">SYSINIT:40B1                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">8 </span>; [es:ARENA.OWNER]
<span style="color:black">SYSINIT:40B8                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:40B9                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:40BA                 </span>assume es:nothing
<span style="color:black">SYSINIT:40BA
SYSINIT:40BA </span><span style="color:gray">su_exit</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:40BA                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:40BA </span>ShrinkUMB       <span style="color:black">endp
SYSINIT:40BA
SYSINIT:40BB
SYSINIT:40BB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:40BB
SYSINIT:40BB
SYSINIT:40BB </span>UnlinkUMB       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:40BB                 </span><span style="color:navy">push    ds              </span>; Unlinks the UMBs from the DOS arena chain
<span style="color:black">SYSINIT:40BC                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:40BD                 </span><span style="color:navy">cmp     cs:</span>FirstUMBLinked<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:40C3                 </span><span style="color:navy">jz      short </span><span style="color:gray">ulu_x     </span>; nothing to unlink
<span style="color:black">SYSINIT:40C5                 </span><span style="color:navy">mov     es, cs:</span>DevDOSData ; get DOS data seg
<span style="color:black">SYSINIT:40CA                 </span><span style="color:navy">mov     ds, word ptr es:</span><span style="color:green">24h </span>; [es:DOS_ARENA]
<span style="color:black">SYSINIT:40CF                 </span><span style="color:navy">mov     di, es:</span><span style="color:green">8Ch      </span>; [es:UMB_ARENA]
<span style="color:black">SYSINIT:40D4
SYSINIT:40D4 </span><span style="color:gray">ulu_next</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:40D4                 </span><span style="color:navy">call    </span>get_next
<span style="color:black">SYSINIT:40D7                 </span><span style="color:navy">jb      short </span><span style="color:gray">ulu_x
</span><span style="color:black">SYSINIT:40D9                 </span><span style="color:navy">cmp     di, ax          </span>; is the next one UMB ?
<span style="color:black">SYSINIT:40DB                 </span><span style="color:navy">jz      short </span><span style="color:gray">ulu_found
</span><span style="color:black">SYSINIT:40DD                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:40DF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ulu_next
</span><span style="color:black">SYSINIT:40E1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:40E1
SYSINIT:40E1 </span><span style="color:gray">ulu_found</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:40E1                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039; </span>; [ARENA.SIGNATURE],arena_signature_end
<span style="color:black">SYSINIT:40E6
SYSINIT:40E6 </span><span style="color:gray">ulu_x</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:40E6                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:40E7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:40E8                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:40E8 </span>UnlinkUMB       <span style="color:black">endp
SYSINIT:40E8
SYSINIT:40E8 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:40E9                 </span><span style="color:navy">db </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:black">SYSINIT:40EB
SYSINIT:40EB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:40EB
SYSINIT:40EB
SYSINIT:40EB </span>setparms        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:40EB                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:40EC                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:40ED                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:40EE                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:40EF                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:40F0                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:40F1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:40F2                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:40F2                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">SYSINIT:40F4                 </span><span style="color:navy">mov     bl, </span>drive
<span style="color:black">SYSINIT:40F8                 </span><span style="color:navy">inc     bl              </span>; get it correct for ioctl call
<span style="color:black">SYSINIT:40F8                                         </span>; (1=A,2=A...)
<span style="color:black">SYSINIT:40FA                 </span><span style="color:navy">mov     dx, offset </span>devp_specialfunc ; offset deviceparameters
<span style="color:black">SYSINIT:40FD                 </span><span style="color:navy">mov     ah, </span><span style="color:green">44h         </span>; IOCTL
<span style="color:black">SYSINIT:40FF                 </span><span style="color:navy">mov     al, </span><span style="color:green">0Dh         </span>; GENERIC_IOCTL
<span style="color:black">SYSINIT:4101                 </span><span style="color:navy">mov     ch, </span><span style="color:green">8           </span>; RAWIO
<span style="color:black">SYSINIT:4103                 </span><span style="color:navy">mov     cl, </span><span style="color:green">40h         </span>; SET_DEVICE_PARAMETERS
<span style="color:black">SYSINIT:4105                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - IOCTL -
<span style="color:black">SYSINIT:4107                 </span><span style="color:navy">mov     ax, </span><span style="color:green">70h         </span>; DOSBIODATASEG ; BIOSDATA segment
<span style="color:black">SYSINIT:410A                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:410C                 </span>assume ds:nothing
<span style="color:black">SYSINIT:410C                 </span><span style="color:navy">test    cs:</span>switches<span style="color:navy">, </span><span style="color:green">4  </span>; flagec35
<span style="color:black">SYSINIT:4113                 </span><span style="color:navy">jz      short </span><span style="color:gray">not_ec35
</span><span style="color:black">SYSINIT:4115                 </span><span style="color:navy">mov     cl, cs:</span>drive    ; which drive was this for?
<span style="color:black">SYSINIT:411A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; assume drive 0
<span style="color:black">SYSINIT:411C                 </span><span style="color:navy">shl     al, cl          </span>; set proper bit depending on drive
<span style="color:black">SYSINIT:411E                 </span><span style="color:navy">or      ds:</span>ec35_flag<span style="color:navy">, al </span>; set the bit in the permanent flags
<span style="color:black">SYSINIT:4122
SYSINIT:4122 </span><span style="color:gray">not_ec35</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4122                 </span><span style="color:navy">mov     al, byte ptr cs:</span>devp_spt ; mov al,[cs:deviceparameters+20]
<span style="color:black">SYSINIT:4122                                         </span>; [cs:deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:4122                                         </span>; +A_BPB.BPB_SECTORSPERTRACK]
<span style="color:black">SYSINIT:4126                 </span><span style="color:navy">cmp     al, ds:</span>eot
<span style="color:black">SYSINIT:412A                 </span><span style="color:navy">jbe     short </span><span style="color:gray">eot_ok
</span><span style="color:black">SYSINIT:412C                 </span><span style="color:navy">mov     ds:</span>eot<span style="color:navy">, al
</span><span style="color:black">SYSINIT:412F
SYSINIT:412F </span><span style="color:gray">eot_ok</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:412F                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:4130                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4131                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4132                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4133                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4134                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4134                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4134 </span>setparms        <span style="color:black">endp
SYSINIT:4134
SYSINIT:4135
SYSINIT:4135 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4135
SYSINIT:4135
SYSINIT:4135 </span>diddleback      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4135                 </span><span style="color:navy">push    ds              </span>; replace default values for further drivparm commands
<span style="color:black">SYSINIT:4136                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:4137                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4138                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:4138                 </span><span style="color:navy">mov     </span>devp_cylinders<span style="color:navy">, </span><span style="color:green">80 </span>; [deviceparameters+4],80
<span style="color:black">SYSINIT:4138                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],80
<span style="color:black">SYSINIT:413E                 </span><span style="color:navy">mov     </span>devp_devtype<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; [deviceparameters+1],2
<span style="color:black">SYSINIT:413E                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],DEV_3INCH720KB
<span style="color:black">SYSINIT:4143                 </span><span style="color:navy">mov     </span>devp_devattr<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [deviceparameters+2],0
<span style="color:black">SYSINIT:4143                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES],0
<span style="color:black">SYSINIT:4149                 </span><span style="color:navy">mov     </span>switches<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; zero all switches
<span style="color:black">SYSINIT:414F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4150                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4150                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4150 </span>diddleback      <span style="color:black">endp
SYSINIT:4150
SYSINIT:4151
SYSINIT:4151 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4151
SYSINIT:4151
SYSINIT:4151 </span>parseline       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4151                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4152                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:4153                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4154                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:4154
SYSINIT:4154 </span><span style="color:gray">nextswtch</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4154                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; al contains the first character in command line.
<span style="color:black">SYSINIT:4156                 </span><span style="color:navy">jz      short </span><span style="color:gray">done_line </span>; cr
<span style="color:black">SYSINIT:4158                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">SYSINIT:415A                 </span><span style="color:navy">jz      short </span><span style="color:gray">put_back  </span>; lf ; put it back and done
<span style="color:black">SYSINIT:415C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:415E                 </span><span style="color:navy">jbe     short </span><span style="color:gray">getnext   </span>; skip over space
<span style="color:black">SYSINIT:4160                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;
</span><span style="color:black">SYSINIT:4162                 </span><span style="color:navy">jz      short </span><span style="color:gray">getparm
</span><span style="color:black">SYSINIT:4164                 </span><span style="color:navy">stc                     </span>; mark error invalid-character-in-input
<span style="color:black">SYSINIT:4165                 </span><span style="color:navy">jmp     short </span><span style="color:gray">exitpl
</span><span style="color:black">SYSINIT:4167 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4167
SYSINIT:4167 </span><span style="color:gray">getparm</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4167                 </span><span style="color:navy">call    </span>check_switch
<span style="color:black">SYSINIT:416A                 </span><span style="color:navy">mov     </span>switches<span style="color:navy">, bx    </span>; save switches read so far
<span style="color:black">SYSINIT:416E                 </span><span style="color:navy">jb      short </span><span style="color:gray">swterr
</span><span style="color:black">SYSINIT:4170
SYSINIT:4170 </span><span style="color:gray">getnext</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4170                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:4173                 </span><span style="color:navy">jb      short </span><span style="color:gray">done_line
</span><span style="color:black">SYSINIT:4175                 </span><span style="color:navy">jmp     short </span><span style="color:gray">nextswtch
</span><span style="color:black">SYSINIT:4177 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4177
SYSINIT:4177 </span><span style="color:gray">swterr</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4177                 </span><span style="color:navy">jmp     short </span><span style="color:gray">exitpl    </span>; exit if error
<span style="color:black">SYSINIT:4179 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4179
SYSINIT:4179 </span><span style="color:gray">done_line</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4179                 </span><span style="color:navy">test    </span>switches<span style="color:navy">, </span><span style="color:green">8     </span>; flagdrive ; see if drive specified
<span style="color:black">SYSINIT:417F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">okay
</span><span style="color:black">SYSINIT:4181                 </span><span style="color:navy">stc                     </span>; mark error no-drive-specified
<span style="color:black">SYSINIT:4182                 </span><span style="color:navy">jmp     short </span><span style="color:gray">exitpl
</span><span style="color:black">SYSINIT:4184 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4184
SYSINIT:4184 </span><span style="color:gray">okay</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4184                 </span><span style="color:navy">mov     ax, </span>switches
<span style="color:black">SYSINIT:4187                 </span><span style="color:navy">and     ax, </span><span style="color:green">3           </span>; get flag bits for changeline and non-rem
<span style="color:black">SYSINIT:418A                 </span><span style="color:navy">mov     </span>devp_devattr<span style="color:navy">, ax </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES]
<span style="color:black">SYSINIT:418D                 </span><span style="color:navy">mov     </span>devp_trktblents<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES]
<span style="color:black">SYSINIT:4193                 </span><span style="color:navy">clc                     </span>; everything is fine
<span style="color:black">SYSINIT:4194                 </span><span style="color:navy">call    </span>setdeviceparameters
<span style="color:black">SYSINIT:4197
SYSINIT:4197 </span><span style="color:gray">exitpl</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4197                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4198                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4198                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4199 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4199
SYSINIT:4199 </span><span style="color:gray">put_back</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4199                 </span><span style="color:navy">inc     ds:</span>count        ; one more char to scan
<span style="color:black">SYSINIT:419D                 </span><span style="color:navy">dec     ds:</span>chrptr       ; back up over linefeed
<span style="color:black">SYSINIT:41A1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">done_line
</span><span style="color:black">SYSINIT:41A1 </span>parseline       <span style="color:black">endp
SYSINIT:41A1
SYSINIT:41A3
SYSINIT:41A3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:41A3
SYSINIT:41A3
SYSINIT:41A3 </span>check_switch    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:41A3                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:41A6                 </span><span style="color:navy">jb      short </span><span style="color:gray">err_chk
</span><span style="color:black">SYSINIT:41A8                 </span><span style="color:navy">and     al, </span><span style="color:green">0DFh        </span>; convert it to upper case
<span style="color:black">SYSINIT:41AA                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;
</span><span style="color:black">SYSINIT:41AC                 </span><span style="color:navy">jb      short </span><span style="color:gray">err_chk
</span><span style="color:black">SYSINIT:41AE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">SYSINIT:41B0                 </span><span style="color:navy">ja      short </span><span style="color:gray">err_chk
</span><span style="color:black">SYSINIT:41B2                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:41B3                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:41B4                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:41B5                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:41B5                 </span><span style="color:navy">mov     cl, byte ptr ds:</span>switchlist ; get number of valid switches
<span style="color:black">SYSINIT:41B9                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0           </span>; point to string of valid switches
<span style="color:black">SYSINIT:41BB                 </span><span style="color:navy">mov     di, (offset </span>switchlist<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">) </span><span style="color:gray">; &quot;FHSTDICN&quot;
</span><span style="color:black">SYSINIT:41BE                 </span><span style="color:navy">repne scasb
</span><span style="color:black">SYSINIT:41C0                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:41C1                 </span>assume es:nothing
<span style="color:black">SYSINIT:41C1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">err_chk
</span><span style="color:black">SYSINIT:41C3                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:41C6                 </span><span style="color:navy">shl     ax, cl          </span>; set bit to indicate switch
<span style="color:black">SYSINIT:41C8                 </span><span style="color:navy">mov     bx, ds:</span>switches ; get switches so far
<span style="color:black">SYSINIT:41CC                 </span><span style="color:navy">or      bx, ax          </span>; save this with other switches
<span style="color:black">SYSINIT:41CE                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">SYSINIT:41D0                 </span><span style="color:navy">test    ax, </span><span style="color:green">0F8h        </span>; switchnum ; 0F8h
<span style="color:black">SYSINIT:41D0                                         </span>; test against switches that require number to follow
<span style="color:black">SYSINIT:41D3                 </span><span style="color:navy">jz      short </span><span style="color:gray">done_swtch
</span><span style="color:black">SYSINIT:41D5                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:41D8                 </span><span style="color:navy">jb      short </span><span style="color:gray">err_swtch
</span><span style="color:black">SYSINIT:41DA                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">:&#039;
</span><span style="color:black">SYSINIT:41DC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">err_swtch
</span><span style="color:black">SYSINIT:41DE                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:41E1                 </span><span style="color:navy">push    bx              </span>; preserve switches
<span style="color:black">SYSINIT:41E2                 </span><span style="color:navy">mov     cs:</span>sepchr<span style="color:navy">, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039; </span>; allow space separators
<span style="color:black">SYSINIT:41E8                 </span><span style="color:navy">call    </span>getnum
<span style="color:black">SYSINIT:41EB                 </span><span style="color:navy">mov     cs:</span>sepchr<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:41F1                 </span><span style="color:navy">pop     bx              </span>; restore switches
<span style="color:black">SYSINIT:41F2                 </span><span style="color:navy">call    </span>process_num
<span style="color:black">SYSINIT:41F5
SYSINIT:41F5 </span><span style="color:gray">done_swtch</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:41F5                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:41F6                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:41F7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:41F7
SYSINIT:41F7 </span><span style="color:gray">err_swtch</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:41F7                 </span><span style="color:navy">xor     bx, cx          </span>; remove this switch from the records
<span style="color:black">SYSINIT:41F9
SYSINIT:41F9 </span><span style="color:gray">err_chk</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:41F9                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:41FA                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:41FA </span>check_switch    <span style="color:black">endp
SYSINIT:41FA
SYSINIT:41FB
SYSINIT:41FB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:41FB
SYSINIT:41FB
SYSINIT:41FB </span>process_num     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:41FB                 </span><span style="color:navy">test    ds:</span>switches<span style="color:navy">, cx </span>; if this switch has been done before,
<span style="color:black">SYSINIT:41FF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">done_ret  </span>; ignore this one.
<span style="color:black">SYSINIT:4201                 </span><span style="color:navy">test    cx, </span><span style="color:green">8           </span>; flagdrive
<span style="color:black">SYSINIT:4205                 </span><span style="color:navy">jz      short </span><span style="color:gray">try_f
</span><span style="color:black">SYSINIT:4207                 </span><span style="color:navy">mov     ds:</span>drive<span style="color:navy">, al
</span><span style="color:black">SYSINIT:420A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">done_ret
</span><span style="color:black">SYSINIT:420C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:420C
SYSINIT:420C </span><span style="color:gray">try_f</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:420C                 </span><span style="color:navy">test    cx, </span><span style="color:green">80h         </span>; flagff
<span style="color:black">SYSINIT:4210                 </span><span style="color:navy">jz      short </span><span style="color:gray">try_t
</span><span style="color:black">SYSINIT:4212                 </span><span style="color:navy">mov     ds:</span>devp_devtype<span style="color:navy">, al
</span><span style="color:black">SYSINIT:4215                 </span><span style="color:navy">jmp     short </span><span style="color:gray">done_ret
</span><span style="color:black">SYSINIT:4217 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4217
SYSINIT:4217 </span><span style="color:gray">try_t</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4217                 </span><span style="color:navy">or      ax, ax          </span>; if number entered was 0, assume default value
<span style="color:black">SYSINIT:4219                 </span><span style="color:navy">jz      short </span><span style="color:gray">done_ret
</span><span style="color:black">SYSINIT:421B                 </span><span style="color:navy">test    cx, </span><span style="color:green">10h         </span>; flagcyln
<span style="color:black">SYSINIT:421F                 </span><span style="color:navy">jz      short </span><span style="color:gray">try_s
</span><span style="color:black">SYSINIT:4221                 </span><span style="color:navy">mov     ds:</span>devp_cylinders<span style="color:navy">, ax </span>; [deviceparameters+4],ax
<span style="color:black">SYSINIT:4221                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS]
<span style="color:black">SYSINIT:4224                 </span><span style="color:navy">jmp     short </span><span style="color:gray">done_ret
</span><span style="color:black">SYSINIT:4226 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4226
SYSINIT:4226 </span><span style="color:gray">try_s</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4226                 </span><span style="color:navy">test    cx, </span><span style="color:green">20h         </span>; flagseclim
<span style="color:black">SYSINIT:422A                 </span><span style="color:navy">jz      short </span><span style="color:gray">try_h     </span>; must be for number of heads
<span style="color:black">SYSINIT:422C                 </span><span style="color:navy">mov     ds:</span>slim<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:422F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">done_ret
</span><span style="color:black">SYSINIT:4231 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4231
SYSINIT:4231 </span><span style="color:gray">try_h</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4231                 </span><span style="color:navy">mov     ds:</span>hlim<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:4234
SYSINIT:4234 </span><span style="color:gray">done_ret</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4234                 </span><span style="color:navy">clc                     </span>; (test instruction resets cf)
<span style="color:black">SYSINIT:4235                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4235 </span>process_num     <span style="color:black">endp
SYSINIT:4235
SYSINIT:4236
SYSINIT:4236 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4236
SYSINIT:4236
SYSINIT:4236 </span>setdeviceparameters <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4236                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4237                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:4238                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:4239                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:4239                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">SYSINIT:423B                 </span><span style="color:navy">mov     bl, ds:</span>devp_devtype ; [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE]
<span style="color:black">SYSINIT:423F                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">0           </span>; DEV_5INCH
<span style="color:black">SYSINIT:4242                 </span><span style="color:navy">jnz     short </span>got_80
<span style="color:black">SYSINIT:4244                 </span><span style="color:navy">mov     ds:</span>devp_cylinders<span style="color:navy">, </span><span style="color:green">40 </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS]
<span style="color:black">SYSINIT:4244                                         </span>; 48 tpi = 40 cyl
<span style="color:black">SYSINIT:424A
SYSINIT:424A </span>got_80<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:424A                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1           </span>; get index into bpb table
<span style="color:black">SYSINIT:424C                 </span><span style="color:navy">mov     si, ds:</span>_bpbtable<span style="color:navy">[bx] </span>; get address of bpb
<span style="color:black">SYSINIT:4250                 </span><span style="color:navy">mov     di, offset </span>devp_bps ; deviceparameters+7
<span style="color:black">SYSINIT:4250                                         </span>; deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:4250                                         </span>; es:di -&gt; bpb
<span style="color:black">SYSINIT:4253                 </span><span style="color:navy">mov     cx, </span><span style="color:green">59          </span>; A_BPB.size
<span style="color:black">SYSINIT:4256                 </span><span style="color:navy">cld
</span><span style="color:black">SYSINIT:4257                 </span><span style="color:navy">rep movsb
</span><span style="color:black">SYSINIT:4259                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:425A                 </span>assume es:nothing
<span style="color:black">SYSINIT:425A                 </span><span style="color:navy">test    ds:</span>switches<span style="color:navy">, </span><span style="color:green">20h </span>; flagseclim
<span style="color:black">SYSINIT:4260                 </span><span style="color:navy">jz      short </span><span style="color:gray">see_heads
</span><span style="color:black">SYSINIT:4262                 </span><span style="color:navy">mov     ax, ds:</span>slim
<span style="color:black">SYSINIT:4265                 </span><span style="color:navy">mov     ds:</span>devp_spt<span style="color:navy">, ax </span>; [deviceparameters+20]
<span style="color:black">SYSINIT:4265                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:4265                                         </span>;  +A_BPB.BPB_SECTORSPERTRACK]
<span style="color:black">SYSINIT:4268
SYSINIT:4268 </span><span style="color:gray">see_heads</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4268                 </span><span style="color:navy">test    ds:</span>switches<span style="color:navy">, </span><span style="color:green">40h </span>; flagheads
<span style="color:black">SYSINIT:426E                 </span><span style="color:navy">jz      short </span><span style="color:gray">heads_not_altered
</span><span style="color:black">SYSINIT:4270                 </span><span style="color:navy">mov     ax, ds:</span>hlim
<span style="color:black">SYSINIT:4273                 </span><span style="color:navy">mov     ds:</span>devp_heads<span style="color:navy">, ax </span>; [deviceparameters+22]
<span style="color:black">SYSINIT:4273                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS]
<span style="color:black">SYSINIT:4276
SYSINIT:4276 </span><span style="color:gray">heads_not_altered</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4276                 </span><span style="color:navy">mov     ds:</span>devp_secperclus<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; [deviceparameters+9],2
<span style="color:black">SYSINIT:4276                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:4276                                         </span>;  +A_BPB.BPB_SECTORSPERCLUSTER]
<span style="color:black">SYSINIT:427B                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">0F0h        </span>; get default mediabyte
<span style="color:black">SYSINIT:427D                 </span><span style="color:navy">mov     bh, ds:</span>devp_mediaid ; [deviceparameters+17]
<span style="color:black">SYSINIT:427D                                         </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_MEDIADESCRIPTOR]
<span style="color:black">SYSINIT:4281                 </span><span style="color:navy">cmp     ds:</span>devp_heads<span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4286                 </span><span style="color:navy">ja      short </span><span style="color:gray">got_correct_mediaid </span>; just use default if heads&gt;2
<span style="color:black">SYSINIT:4288                 </span><span style="color:navy">jnz     short </span><span style="color:gray">only_one_head </span>; one head, do one head stuff
<span style="color:black">SYSINIT:428A                 </span><span style="color:navy">mov     bl, bh
</span><span style="color:black">SYSINIT:428C                 </span><span style="color:navy">cmp     ds:</span>devp_spt<span style="color:navy">, </span><span style="color:green">18 </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:428C                                         </span>;  +A_BPB.BPB_SECTORSPERTRACK]
<span style="color:black">SYSINIT:4291                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_144m
</span><span style="color:black">SYSINIT:4293                 </span><span style="color:navy">cmp     ds:</span>devp_cylinders<span style="color:navy">, </span><span style="color:green">80 </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS]
<span style="color:black">SYSINIT:4298                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_144m
</span><span style="color:black">SYSINIT:429A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">got_one_secperclus_drive </span>; cyl=80, heads=2, secpertrack=18.
<span style="color:black">SYSINIT:429A                                         </span>;  Set cluster size to 1.
<span style="color:black">SYSINIT:429C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:429C
SYSINIT:429C </span><span style="color:gray">not_144m</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:429C                 </span><span style="color:navy">cmp     ds:</span>devp_cylinders<span style="color:navy">, </span><span style="color:green">40 </span>; check for 320K
<span style="color:black">SYSINIT:42A1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_correct_mediaid
</span><span style="color:black">SYSINIT:42A3                 </span><span style="color:navy">cmp     ds:</span>devp_spt<span style="color:navy">, </span><span style="color:#ff8000">8
</span><span style="color:black">SYSINIT:42A8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_correct_mediaid
</span><span style="color:black">SYSINIT:42AA                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">0FCh
</span><span style="color:black">SYSINIT:42AC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">got_correct_mediaid
</span><span style="color:black">SYSINIT:42AE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:42AE
SYSINIT:42AE </span><span style="color:gray">only_one_head</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:42AE                 </span><span style="color:navy">cmp     ds:</span>devp_devtype<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],DEV_5INCH
<span style="color:black">SYSINIT:42B3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_one_secperclus_drive
</span><span style="color:black">SYSINIT:42B5                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">0FCh        </span>; single sided 9 sector media id
<span style="color:black">SYSINIT:42B7                 </span><span style="color:navy">cmp     ds:</span>devp_spt<span style="color:navy">, </span><span style="color:#ff8000">8  </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:42B7                                         </span>; +A_BPB.BPB_SECTORSPERTRACK],8
<span style="color:black">SYSINIT:42BC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_one_secperclus_drive </span>; okay if anything besides 8
<span style="color:black">SYSINIT:42BE                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">0FEh        </span>; 160K mediaid
<span style="color:black">SYSINIT:42C0
SYSINIT:42C0 </span><span style="color:gray">got_one_secperclus_drive</span><span style="color:navy">:               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:42C0                 </span><span style="color:navy">mov     ds:</span>devp_secperclus<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:42C0                                         </span>;  +A_BPB.BPB_SECTORSPERCLUSTER],1
<span style="color:black">SYSINIT:42C5
SYSINIT:42C5 </span><span style="color:gray">got_correct_mediaid</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:42C5                 </span><span style="color:navy">mov     ds:</span>devp_mediaid<span style="color:navy">, bl </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB
<span style="color:black">SYSINIT:42C5                                         </span>;  +A_BPB.BPB_MEDIADESCRIPTOR],bl
<span style="color:black">SYSINIT:42C9                 </span><span style="color:navy">mov     ax, ds:</span>devp_cylinders ; [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS]
<span style="color:black">SYSINIT:42CC                 </span><span style="color:navy">mul     ds:</span>devp_heads   ; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS]
<span style="color:black">SYSINIT:42D0                 </span><span style="color:navy">mul     ds:</span>devp_spt     ; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK]
<span style="color:black">SYSINIT:42D4                 </span><span style="color:navy">mov     ds:</span>devp_totalsecs<span style="color:navy">, ax </span>; [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS]
<span style="color:black">SYSINIT:42D7                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:42D8                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:42D8 </span>setdeviceparameters <span style="color:black">endp
SYSINIT:42D8
SYSINIT:42D9
SYSINIT:42D9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:42D9
SYSINIT:42D9
SYSINIT:42D9 </span>organize        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:42D9                 </span><span style="color:navy">mov     cx, cs:</span>count
<span style="color:black">SYSINIT:42DE                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">nochar1
</span><span style="color:black">SYSINIT:42E0                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">SYSINIT:42E2                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">SYSINIT:42E4                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:42E6                 </span><span style="color:navy">mov     cs:</span>com_level<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:42EC
SYSINIT:42EC </span><span style="color:gray">org1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:42EC                 </span><span style="color:navy">call    </span>skip_comment
<span style="color:black">SYSINIT:42EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_commd_line </span>; found a comment string and skipped.
<span style="color:black">SYSINIT:42F1                 </span><span style="color:navy">call    </span>get2            ; not a comment string. then get a char.
<span style="color:black">SYSINIT:42F4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:42F6                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_commd_line </span>; starts with a blank line.
<span style="color:black">SYSINIT:42F8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:42FA                 </span><span style="color:navy">jbe     short </span><span style="color:gray">org1      </span>; skip leading control characters
<span style="color:black">SYSINIT:42FC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">findit
</span><span style="color:black">SYSINIT:42FE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:42FE
SYSINIT:42FE </span><span style="color:gray">end_commd_line</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:42FE                 </span><span style="color:navy">stosb                   </span>; store line feed char in buffer for the linecount.
<span style="color:black">SYSINIT:42FF                 </span><span style="color:navy">mov     cs:</span>com_level<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset the command level.
<span style="color:black">SYSINIT:4305                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org1
</span><span style="color:black">SYSINIT:4307 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4307
SYSINIT:4307 </span><span style="color:gray">nochar1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4307                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:4308                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4309 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4309
SYSINIT:4309 </span><span style="color:gray">findit</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4309                 </span><span style="color:navy">push    cx              </span>; prepare to search command table
<span style="color:black">SYSINIT:430A                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:430B                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:430C                 </span><span style="color:navy">mov     bp, si
</span><span style="color:black">SYSINIT:430E                 </span><span style="color:navy">dec     bp
</span><span style="color:black">SYSINIT:430F                 </span><span style="color:navy">mov     si, offset </span>comtab <span style="color:gray">; &quot;\x01[[&quot;
</span><span style="color:black">SYSINIT:4312                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4314
SYSINIT:4314 </span><span style="color:gray">findcom</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4314                 </span><span style="color:navy">mov     di, bp
</span><span style="color:black">SYSINIT:4316                 </span><span style="color:navy">mov     cl, [si]
</span><span style="color:black">SYSINIT:4318                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:4319                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">nocom
</span><span style="color:black">SYSINIT:431B                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">3Bh </span><span style="color:gray">; &#039;;&#039; </span>; CONFIG_SEMICOLON
<span style="color:black">SYSINIT:431F                 </span><span style="color:navy">jz      short </span><span style="color:gray">semicolon
</span><span style="color:black">SYSINIT:4321
SYSINIT:4321 </span><span style="color:gray">loopcom</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4321                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">SYSINIT:4324                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4325                 </span><span style="color:navy">and     al, </span><span style="color:green">0DFh        </span>; ~20h ; force upper case
<span style="color:black">SYSINIT:4327                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:4328                 </span><span style="color:navy">cmp     al, [si-</span><span style="color:green">1</span><span style="color:navy">]      </span>; compare to byte @es:di
<span style="color:black">SYSINIT:432B                 </span><span style="color:navy">loope   </span><span style="color:gray">loopcom
</span><span style="color:black">SYSINIT:432D                 </span><span style="color:navy">lahf
</span><span style="color:black">SYSINIT:432E                 </span><span style="color:navy">add     si, cx          </span>; bump to next position without affecting flags
<span style="color:black">SYSINIT:4330                 </span><span style="color:navy">sahf
</span><span style="color:black">SYSINIT:4331                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:4332                 </span><span style="color:navy">jnz     short </span><span style="color:gray">findcom
</span><span style="color:black">SYSINIT:4334                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">0Dh </span>; the next char might be cr,lf
<span style="color:black">SYSINIT:4338                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotcom0
</span><span style="color:black">SYSINIT:433A                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">0Ah </span>; such as in &quot;rem&quot;,cr,lf case.
<span style="color:black">SYSINIT:433E                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotcom0
</span><span style="color:black">SYSINIT:4340                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Bh </span><span style="color:gray">; &#039;[&#039;   </span>; CONFIG_BEGIN
<span style="color:black">SYSINIT:4342                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotcom0
</span><span style="color:black">SYSINIT:4344                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:4345                 </span><span style="color:navy">mov     al, es:[di]     </span>; now the next char. should be a delim.
<span style="color:black">SYSINIT:4348                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;   </span>; explicit interactive command?
<span style="color:black">SYSINIT:434A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_query  </span>; no
<span style="color:black">SYSINIT:434C                 </span><span style="color:navy">pop     ax              </span>; yes, so retrieve the original code
<span style="color:black">SYSINIT:434D                 </span><span style="color:navy">or      al, </span><span style="color:green">80h         </span>; CONFIG_OPTION_QUERY ; and set the QUERY bit
<span style="color:black">SYSINIT:434F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">gotcom0
</span><span style="color:black">SYSINIT:4351 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4351
SYSINIT:4351 </span><span style="color:gray">semicolon</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4351                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; CONFIG_REM
<span style="color:black">SYSINIT:4353                 </span><span style="color:navy">jmp     short </span><span style="color:gray">gotcom0
</span><span style="color:black">SYSINIT:4355 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4355
SYSINIT:4355 </span><span style="color:gray">no_query</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4355                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:4358                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4359                 </span><span style="color:navy">jnz     short </span><span style="color:gray">findcom
</span><span style="color:black">SYSINIT:435B
SYSINIT:435B </span><span style="color:gray">gotcom0</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:435B                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:435C                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:435D                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:435E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">gotcom
</span><span style="color:black">SYSINIT:4360 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4360
SYSINIT:4360 </span><span style="color:gray">nocom</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4360                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:4361                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4362                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4363                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;   </span>; CONFIG_UNKNOWN
<span style="color:black">SYSINIT:4365                 </span><span style="color:navy">stosb                   </span>; save indicator char.
<span style="color:black">SYSINIT:4366
SYSINIT:4366 </span><span style="color:gray">_skipline</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4366                 </span><span style="color:navy">call    </span>get2
<span style="color:black">SYSINIT:4369                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf ; skip this bad command line
<span style="color:black">SYSINIT:436B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_skipline
</span><span style="color:black">SYSINIT:436D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">end_commd_line
</span><span style="color:black">SYSINIT:436F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:436F
SYSINIT:436F </span><span style="color:gray">gotcom</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:436F                 </span><span style="color:navy">stosb                   </span>; save indicator char in buffer
<span style="color:black">SYSINIT:4370                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; ~CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:4372                 </span><span style="color:navy">mov     cs:</span>cmd_indicator<span style="color:navy">, al </span>; save it for the future use.
<span style="color:black">SYSINIT:4376                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Bh </span><span style="color:gray">; &#039;[&#039;   </span>; CONFIG_BEGIN
<span style="color:black">SYSINIT:4378                 </span><span style="color:navy">jz      short </span><span style="color:gray">org31
</span><span style="color:black">SYSINIT:437A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Fh </span><span style="color:gray">; &#039;O&#039;   </span>; CONFIG_SUBMENU
<span style="color:black">SYSINIT:437C                 </span><span style="color:navy">jz      short </span><span style="color:gray">org2
</span><span style="color:black">SYSINIT:437E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">45h </span><span style="color:gray">; &#039;E&#039;   </span>; CONFIG_MENUITEM
<span style="color:black">SYSINIT:4380                 </span><span style="color:navy">jz      short </span><span style="color:gray">org2
</span><span style="color:black">SYSINIT:4382                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;   </span>; CONFIG_MENUDEFAULT
<span style="color:black">SYSINIT:4384                 </span><span style="color:navy">jz      short </span><span style="color:gray">org2
</span><span style="color:black">SYSINIT:4386                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Ah </span><span style="color:gray">; &#039;J&#039;   </span>; CONFIG_INCLUDE
<span style="color:black">SYSINIT:4388                 </span><span style="color:navy">jz      short </span><span style="color:gray">org2
</span><span style="color:black">SYSINIT:438A                 </span><span style="color:navy">call    </span>mapcase         ; map case of rest of line to UPPER
<span style="color:black">SYSINIT:438D
SYSINIT:438D </span><span style="color:gray">org2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:438D                 </span><span style="color:navy">call    </span>get2            ; skip the command name until delimiter
<span style="color:black">SYSINIT:4390                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:4392                 </span><span style="color:navy">jz      short </span><span style="color:gray">org21
</span><span style="color:black">SYSINIT:4394                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:4396                 </span><span style="color:navy">jz      short </span><span style="color:gray">org21
</span><span style="color:black">SYSINIT:4398                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; Added to allow DEVHIGH/L:...
<span style="color:black">SYSINIT:439A                 </span><span style="color:navy">jz      short </span><span style="color:gray">org21     </span>; to be parsed properly
<span style="color:black">SYSINIT:439C                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:439F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">org2
</span><span style="color:black">SYSINIT:43A1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org3
</span><span style="color:black">SYSINIT:43A3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:43A3
SYSINIT:43A3 </span><span style="color:gray">org21</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:43A3                 </span><span style="color:navy">dec     si              </span>; if cr or lf then
<span style="color:black">SYSINIT:43A4                 </span><span style="color:navy">inc     cx              </span>; undo si, cx register and continue
<span style="color:black">SYSINIT:43A5
SYSINIT:43A5 </span><span style="color:gray">org3</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:43A5                 </span><span style="color:navy">cmp     cs:</span>cmd_indicator<span style="color:navy">, </span><span style="color:#ff8000">59h </span><span style="color:gray">; &#039;Y&#039; </span>; CONFIG_COMMENT
<span style="color:black">SYSINIT:43AB                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_token
</span><span style="color:black">SYSINIT:43AD                 </span><span style="color:navy">cmp     cs:</span>cmd_indicator<span style="color:navy">, </span><span style="color:#ff8000">44h </span><span style="color:gray">; &#039;D&#039; </span>; CONFIG_DEVICE
<span style="color:black">SYSINIT:43B3                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_file
</span><span style="color:black">SYSINIT:43B5                 </span><span style="color:navy">cmp     cs:</span>cmd_indicator<span style="color:navy">, </span><span style="color:#ff8000">49h </span><span style="color:gray">; &#039;I&#039; </span>; CONFIG_INSTALL
<span style="color:black">SYSINIT:43BB                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_file
</span><span style="color:black">SYSINIT:43BD                 </span><span style="color:navy">cmp     cs:</span>cmd_indicator<span style="color:navy">, </span><span style="color:#ff8000">57h </span><span style="color:gray">; &#039;W&#039; </span>; CONFIG_INSTALLHIGH
<span style="color:black">SYSINIT:43C3                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_file
</span><span style="color:black">SYSINIT:43C5                 </span><span style="color:navy">cmp     cs:</span>cmd_indicator<span style="color:navy">, </span><span style="color:#ff8000">53h </span><span style="color:gray">; &#039;S&#039; </span>; CONFIG_SHELL
<span style="color:black">SYSINIT:43CB                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_file
</span><span style="color:black">SYSINIT:43CD                 </span><span style="color:navy">cmp     cs:</span>cmd_indicator<span style="color:navy">, </span><span style="color:#ff8000">31h </span><span style="color:gray">; &#039;1&#039; </span>; CONFIG_SWITCHES
<span style="color:black">SYSINIT:43D3                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_switch
</span><span style="color:black">SYSINIT:43D5
SYSINIT:43D5 </span><span style="color:gray">org31</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:43D5                 </span><span style="color:navy">jmp     </span><span style="color:gray">org4
</span><span style="color:black">SYSINIT:43D8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:43D8
SYSINIT:43D8 </span><span style="color:gray">org_switch</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:43D8                 </span><span style="color:navy">call    </span>skip_comment
<span style="color:black">SYSINIT:43DB                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_commd_line_brdg
</span><span style="color:black">SYSINIT:43DD                 </span><span style="color:navy">call    </span>get2
<span style="color:black">SYSINIT:43E0                 </span><span style="color:navy">call    </span>org_delim
<span style="color:black">SYSINIT:43E3                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_switch
</span><span style="color:black">SYSINIT:43E5                 </span><span style="color:navy">stosb
</span><span style="color:black">SYSINIT:43E6                 </span><span style="color:navy">jmp     </span><span style="color:gray">org5
</span><span style="color:black">SYSINIT:43E9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:43E9
SYSINIT:43E9 </span><span style="color:gray">org_file</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:43E9                 </span><span style="color:navy">call    </span>skip_comment    ; get the filename and put 0 at end
<span style="color:black">SYSINIT:43EC                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_put_zero
</span><span style="color:black">SYSINIT:43EE                 </span><span style="color:navy">call    </span>get2            ; not a comment
<span style="color:black">SYSINIT:43F1                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:43F4                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_file  </span>; skip the possible delimiters
<span style="color:black">SYSINIT:43F6                 </span><span style="color:navy">stosb                   </span>; copy the first non delim char found in buffer
<span style="color:black">SYSINIT:43F7
SYSINIT:43F7 </span><span style="color:gray">org_copy_file</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:43F7                 </span><span style="color:navy">call    </span>skip_comment    ; comment char in the filename?
<span style="color:black">SYSINIT:43FA                 </span><span style="color:navy">jz      short </span><span style="color:gray">org_put_zero </span>; then stop copying filename at that point
<span style="color:black">SYSINIT:43FC                 </span><span style="color:navy">call    </span>get2
<span style="color:black">SYSINIT:43FF                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; a switch char? (device=filename/xxx)
<span style="color:black">SYSINIT:4401                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_file_slash </span>; this will be the special case.
<span style="color:black">SYSINIT:4403                 </span><span style="color:navy">stosb                   </span>; save the char. in buffer
<span style="color:black">SYSINIT:4404                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:4407                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_copy_file
</span><span style="color:black">SYSINIT:4409                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:440B                 </span><span style="color:navy">ja      short </span><span style="color:gray">org_copy_file </span>; keep copying
<span style="color:black">SYSINIT:440D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">end_copy_file </span>; otherwise, assume end of the filename.
<span style="color:black">SYSINIT:440F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:440F
SYSINIT:440F </span><span style="color:gray">get_cmt_token</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:440F                 </span><span style="color:navy">call    </span>get2            ; get the token. just max. 2 char.
<span style="color:black">SYSINIT:4412                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; skip white spaces or &quot;=&quot; char.
<span style="color:black">SYSINIT:4414                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_token </span>; (we are allowing the other special
<span style="color:black">SYSINIT:4416                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; characters can used for comment id.
<span style="color:black">SYSINIT:4418                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_token </span>; character.)
<span style="color:black">SYSINIT:441A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Dh </span><span style="color:gray">; &#039;=&#039;   </span>; = is special in this case.
<span style="color:black">SYSINIT:441C                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_token
</span><span style="color:black">SYSINIT:441E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh
</span><span style="color:black">SYSINIT:4420                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_end </span>; cannot accept the carriage return
<span style="color:black">SYSINIT:4422                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">SYSINIT:4424                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_end
</span><span style="color:black">SYSINIT:4426                 </span><span style="color:navy">mov     cs:</span>cmmt1<span style="color:navy">, al    </span>; store it
<span style="color:black">SYSINIT:442A                 </span><span style="color:navy">mov     cs:</span>cmmt<span style="color:navy">, </span><span style="color:#ff8000">1      </span>; 1 char. so far.
<span style="color:black">SYSINIT:4430                 </span><span style="color:navy">call    </span>get2
<span style="color:black">SYSINIT:4433                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; space
<span style="color:black">SYSINIT:4435                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_end
</span><span style="color:black">SYSINIT:4437                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; tab
<span style="color:black">SYSINIT:4439                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_end
</span><span style="color:black">SYSINIT:443B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:443D                 </span><span style="color:navy">jz      short </span><span style="color:gray">get_cmt_end
</span><span style="color:black">SYSINIT:443F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:4441                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_commd_line_brdg
</span><span style="color:black">SYSINIT:4443                 </span><span style="color:navy">mov     cs:</span>cmmt2<span style="color:navy">, al
</span><span style="color:black">SYSINIT:4447                 </span><span style="color:navy">inc     cs:</span>cmmt
<span style="color:black">SYSINIT:444C
SYSINIT:444C </span><span style="color:gray">get_cmt_end</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:444C                 </span><span style="color:navy">call    </span>get2
<span style="color:black">SYSINIT:444F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:4451                 </span><span style="color:navy">jnz     short </span><span style="color:gray">get_cmt_end </span>; skip it.
<span style="color:black">SYSINIT:4453
SYSINIT:4453 </span><span style="color:gray">end_commd_line_brdg</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4453                 </span><span style="color:navy">jmp     </span><span style="color:gray">end_commd_line  </span>; else jmp to end_commd_line
<span style="color:black">SYSINIT:4456 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4456
SYSINIT:4456 </span><span style="color:gray">org_put_zero</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4456                 </span><span style="color:navy">mov     byte ptr es:[di], </span><span style="color:#ff8000">0 </span>; make the filename in front of
<span style="color:black">SYSINIT:4456                                         </span>; the comment string to be an asciiz.
<span style="color:black">SYSINIT:445A                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:445B                 </span><span style="color:navy">jmp     </span><span style="color:gray">end_commd_line  </span>; (maybe null if device=/*)
<span style="color:black">SYSINIT:445E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:445E
SYSINIT:445E </span><span style="color:gray">end_file_slash</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:445E                 </span><span style="color:navy">mov     byte ptr es:[di], </span><span style="color:#ff8000">0 </span>; al = &quot;/&quot; option char.
<span style="color:black">SYSINIT:445E                                         </span>; make a filename an asciiz
<span style="color:black">SYSINIT:4462                 </span><span style="color:navy">inc     di              </span>; and
<span style="color:black">SYSINIT:4463                 </span><span style="color:navy">stosb                   </span>; store &quot;/&quot; after that.
<span style="color:black">SYSINIT:4464                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org5      </span>; continue with the rest of the line
<span style="color:black">SYSINIT:4466 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4466
SYSINIT:4466 </span><span style="color:gray">end_copy_file</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4466                 </span><span style="color:navy">mov     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; make it an asciiz and handle the next char.
<span style="color:black">SYSINIT:446B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:446D                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_commd_line_brdg
</span><span style="color:black">SYSINIT:446F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org5
</span><span style="color:black">SYSINIT:4471 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4471
SYSINIT:4471 </span><span style="color:gray">org4</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4471                 </span><span style="color:navy">call    </span>skip_comment    ; org4 skips all delimiters
<span style="color:black">SYSINIT:4471                                         </span>; after the command name except for &#039;/&#039;
<span style="color:black">SYSINIT:4474                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_commd_line_brdg
</span><span style="color:black">SYSINIT:4476                 </span><span style="color:navy">call    </span>get2
<span style="color:black">SYSINIT:4479                 </span><span style="color:navy">call    </span>org_delim       ; skip delimiters except &#039;/&#039;
<span style="color:black">SYSINIT:447C                 </span><span style="color:navy">jz      short </span><span style="color:gray">org4
</span><span style="color:black">SYSINIT:447E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org51
</span><span style="color:black">SYSINIT:4480 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4480
SYSINIT:4480 </span><span style="color:gray">org5</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4480                 </span><span style="color:navy">call    </span>skip_comment    ; rest of the line is
<span style="color:black">SYSINIT:4483                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_commd_line_brdg </span>; comment.
<span style="color:black">SYSINIT:4485                 </span><span style="color:navy">call    </span>get2            ; not a comment.
<span style="color:black">SYSINIT:4488
SYSINIT:4488 </span><span style="color:gray">org51</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4488                 </span><span style="color:navy">stosb                   </span>; copy the character
<span style="color:black">SYSINIT:4489                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">22h </span><span style="color:gray">; &#039;&quot;&#039;   </span>; a quote ?
<span style="color:black">SYSINIT:448B                 </span><span style="color:navy">jz      short </span><span style="color:gray">at_quote
</span><span style="color:black">SYSINIT:448D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; cmp al,0Ah
<span style="color:black">SYSINIT:448D                                         </span>; jne short org5
<span style="color:black">SYSINIT:448D                                         </span>; jmp org1 (Erdogan Tan - 28/07/2023)
<span style="color:black">SYSINIT:448F                 </span><span style="color:navy">ja      short </span><span style="color:gray">org5
</span><span style="color:black">SYSINIT:4491                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; cmp al,lf
<span style="color:black">SYSINIT:4493                 </span><span style="color:navy">jz      short </span><span style="color:gray">org1_brdg
</span><span style="color:black">SYSINIT:4495                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org5
</span><span style="color:black">SYSINIT:4497 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4497
SYSINIT:4497 </span><span style="color:gray">org1_brdg</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4497                 </span><span style="color:navy">jmp     </span><span style="color:gray">org1
</span><span style="color:black">SYSINIT:449A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:449A
SYSINIT:449A </span><span style="color:gray">at_quote</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:449A                 </span><span style="color:navy">cmp     cs:</span>com_level<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:44A0                 </span><span style="color:navy">jz      short </span><span style="color:gray">up_level
</span><span style="color:black">SYSINIT:44A2                 </span><span style="color:navy">mov     cs:</span>com_level<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset it
<span style="color:black">SYSINIT:44A8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org5
</span><span style="color:black">SYSINIT:44AA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:44AA
SYSINIT:44AA </span><span style="color:gray">up_level</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:44AA                 </span><span style="color:navy">inc     cs:</span>com_level    ; set it
<span style="color:black">SYSINIT:44AF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">org5
</span><span style="color:black">SYSINIT:44AF </span>organize        <span style="color:black">endp
SYSINIT:44AF
</span><span style="color:maroon">SYSINIT:44B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:44B1
SYSINIT:44B1 </span>get2<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:44B1                 </span><span style="color:navy">jcxz    short </span>noget
<span style="color:maroon">SYSINIT:44B3                 </span><span style="color:navy">lods    byte ptr es:[si]
</span><span style="color:maroon">SYSINIT:44B5                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">SYSINIT:44B6                 </span><span style="color:navy">retn
</span><span style="color:maroon">SYSINIT:44B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:44B7
SYSINIT:44B7 </span>noget<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:44B7                 </span><span style="color:navy">pop     cx              </span>; This was the rather kludgy way
<span style="color:maroon">SYSINIT:44B7                                         </span>; out of procedure &quot;organize&quot;,
<span style="color:maroon">SYSINIT:44B7                                         </span>; but instead of returning to doconf,
<span style="color:maroon">SYSINIT:44B7                                         </span>; we now want to check config.sys BEGIN/END blocks
<span style="color:maroon">SYSINIT:44B7                                         </span>; and the new boot menu stuff
<span style="color:maroon">SYSINIT:44B8                 </span><span style="color:navy">mov     cs:</span>count<span style="color:navy">, di
</span><span style="color:maroon">SYSINIT:44BD                 </span><span style="color:navy">mov     cs:</span>org_count<span style="color:navy">, di
</span><span style="color:maroon">SYSINIT:44C2                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">SYSINIT:44C4                 </span><span style="color:navy">mov     cs:</span>chrptr<span style="color:navy">, si
</span><span style="color:maroon">SYSINIT:44C9                 </span><span style="color:navy">mov     cx, di
</span><span style="color:maroon">SYSINIT:44CB                 </span><span style="color:navy">jmp     </span>menu_check
<span style="color:black">SYSINIT:44CE
SYSINIT:44CE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:44CE
SYSINIT:44CE
SYSINIT:44CE </span>skip_comment    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:44CE                 </span><span style="color:navy">jcxz    short </span>noget     ; get out of the organize routine.
<span style="color:black">SYSINIT:44CE                                         </span>; ...
<span style="color:black">SYSINIT:44CE                                         </span>; skip the commented string until lf,
<span style="color:black">SYSINIT:44CE                                         </span>; if current es:si-&gt; a comment string.
<span style="color:black">SYSINIT:44CE                                         </span>; ...
<span style="color:black">SYSINIT:44D0                 </span><span style="color:navy">cmp     cs:</span>com_level<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; only check it if parameter level is 0.
<span style="color:black">SYSINIT:44D6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_commt  </span>; (not inside quotations)
<span style="color:black">SYSINIT:44D8                 </span><span style="color:navy">cmp     cs:</span>cmmt<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:44DE                 </span><span style="color:navy">jb      short </span><span style="color:gray">no_commt
</span><span style="color:black">SYSINIT:44E0                 </span><span style="color:navy">mov     al, es:[si]
</span><span style="color:black">SYSINIT:44E3                 </span><span style="color:navy">cmp     cs:</span>cmmt1<span style="color:navy">, al
</span><span style="color:black">SYSINIT:44E8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_commt
</span><span style="color:black">SYSINIT:44EA                 </span><span style="color:navy">cmp     cs:</span>cmmt<span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:44F0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">skip_cmmt
</span><span style="color:black">SYSINIT:44F2                 </span><span style="color:navy">mov     al, es:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:44F6                 </span><span style="color:navy">cmp     cs:</span>cmmt2<span style="color:navy">, al
</span><span style="color:black">SYSINIT:44FB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_commt
</span><span style="color:black">SYSINIT:44FD
SYSINIT:44FD </span><span style="color:gray">skip_cmmt</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:44FD                 </span><span style="color:navy">jcxz    short </span>noget     ; get out of organize routine.
<span style="color:black">SYSINIT:44FF                 </span><span style="color:navy">mov     al, es:[si]
</span><span style="color:black">SYSINIT:4502                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:4503                 </span><span style="color:navy">dec     cx
</span><span style="color:black">SYSINIT:4504                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf ; line feed ?
<span style="color:black">SYSINIT:4506                 </span><span style="color:navy">jnz     short </span><span style="color:gray">skip_cmmt
</span><span style="color:black">SYSINIT:4508
SYSINIT:4508 </span><span style="color:gray">no_commt</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4508                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4508 </span>skip_comment    <span style="color:black">endp
SYSINIT:4508
SYSINIT:4509
SYSINIT:4509 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4509
SYSINIT:4509
SYSINIT:4509 </span>kbd_read        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4509                 </span><span style="color:navy">test    ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">2 </span>; wait for keystroke
<span style="color:black">SYSINIT:450E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">kbd_nodelay </span>;
<span style="color:black">SYSINIT:450E                                         </span>; the bios timer tick count is incremented
<span style="color:black">SYSINIT:450E                                         </span>; 18.2 times per second;
<span style="color:black">SYSINIT:450E                                         </span>; watch the timer tick count for 37 transitions
<span style="color:black">SYSINIT:450E                                         </span>; get initial value
<span style="color:black">SYSINIT:4510                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4511                 </span><span style="color:navy">sub     ax, ax
</span><span style="color:black">SYSINIT:4513                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:4515                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4515
SYSINIT:4515 </span><span style="color:gray">kbd_loop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4515                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1           </span>; peek the keyboard
<span style="color:black">SYSINIT:4517                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - CHECK BUFFER, DO NOT CLEAR
<span style="color:black">SYSINIT:4517                                         </span>; Return: ZF clear if character in buffer
<span style="color:black">SYSINIT:4517                                         </span>; AH = scan code, AL = character
<span style="color:black">SYSINIT:4517                                         </span>; ZF set if no character in buffer
<span style="color:black">SYSINIT:4519                 </span><span style="color:navy">jnz     short </span><span style="color:gray">kbd_loopdone
</span><span style="color:black">SYSINIT:451B                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:451D                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - GET SHIFT STATUS
<span style="color:black">SYSINIT:451D                                         </span>; AL = shift status bits
<span style="color:black">SYSINIT:451F                 </span><span style="color:navy">test    al, </span><span style="color:green">3           </span>; either right or left shift key bits set?
<span style="color:black">SYSINIT:4521                 </span><span style="color:navy">jnz     short </span><span style="color:gray">kbd_loopdone </span>; yes
<span style="color:black">SYSINIT:4523                 </span><span style="color:navy">mov     ax, </span>ds:046Ch    ; system timer, lw
<span style="color:black">SYSINIT:4526                 </span><span style="color:navy">sub     ax, cs:</span>_timer_lw_ ; get difference
<span style="color:black">SYSINIT:452B                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">37          </span>; reached limit? ; (2 seconds)
<span style="color:black">SYSINIT:452E                 </span><span style="color:navy">jb      short </span><span style="color:gray">kbd_loop
</span><span style="color:black">SYSINIT:4530
SYSINIT:4530 </span><span style="color:gray">kbd_loopdone</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4530                 </span><span style="color:navy">pop     ds              </span>; delay complete!
<span style="color:black">SYSINIT:4531                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4531
SYSINIT:4531 </span><span style="color:gray">kbd_nodelay</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4531                 </span><span style="color:navy">sub     bx, bx          </span>; assume clean boot
<span style="color:black">SYSINIT:4533                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; peek the shift states
<span style="color:black">SYSINIT:4535                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - GET SHIFT STATUS
<span style="color:black">SYSINIT:4535                                         </span>; AL = shift status bits
<span style="color:black">SYSINIT:4537                 </span><span style="color:navy">test    al, </span><span style="color:green">3           </span>; either right or left shift key bits set?
<span style="color:black">SYSINIT:4539                 </span><span style="color:navy">jz      short </span><span style="color:gray">kbd_notshift </span>; no
<span style="color:black">SYSINIT:453B                 </span><span style="color:navy">inc     bx              </span>; yes
<span style="color:black">SYSINIT:453C                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:453D                 </span><span style="color:navy">or      ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">4
</span><span style="color:black">SYSINIT:4542
SYSINIT:4542 </span><span style="color:gray">kbd_notshift</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4542                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1           </span>; peek the keyboard
<span style="color:black">SYSINIT:4544                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - CHECK BUFFER, DO NOT CLEAR
<span style="color:black">SYSINIT:4544                                         </span>; Return: ZF clear if character in buffer
<span style="color:black">SYSINIT:4544                                         </span>; AH = scan code, AL = character
<span style="color:black">SYSINIT:4544                                         </span>; ZF set if no character in buffer
<span style="color:black">SYSINIT:4546                 </span><span style="color:navy">jz      short </span><span style="color:gray">kbd_test  </span>; no key present
<span style="color:black">SYSINIT:4548                 </span><span style="color:navy">or      al, al          </span>; is it a function key?
<span style="color:black">SYSINIT:454A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">kbd_test  </span>; no
<span style="color:black">SYSINIT:454C                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">62h         </span>; CTRL F5
<span style="color:black">SYSINIT:454F                 </span><span style="color:navy">jz      short </span><span style="color:gray">kbd_cfg_bypass
</span><span style="color:black">SYSINIT:4551                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">3Fh         </span>; F5 function key?
<span style="color:black">SYSINIT:4554                 </span><span style="color:navy">jnz     short </span><span style="color:gray">kbd_notf5 </span>; no
<span style="color:black">SYSINIT:4556
SYSINIT:4556 </span><span style="color:gray">kbd_cfg_bypass</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4556                 </span><span style="color:navy">mov     dx, offset </span>_$CleanMsg <span style="color:gray">; &quot;PC DOS is bypassing your CONFIG.SYS and&quot;...
</span><span style="color:black">SYSINIT:4559                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:455C                 </span><span style="color:navy">or      ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">4
</span><span style="color:black">SYSINIT:4561                 </span><span style="color:navy">jmp     short </span><span style="color:gray">kbd_eat   </span>; yes, clean boot selected
<span style="color:black">SYSINIT:4563 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4563
SYSINIT:4563 </span><span style="color:gray">kbd_notf5</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4563                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">65h         </span>; CTRL F8
<span style="color:black">SYSINIT:4566                 </span><span style="color:navy">jz      short </span><span style="color:gray">kbd_cfg_confirm
</span><span style="color:black">SYSINIT:4568                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">42h         </span>; F8
<span style="color:black">SYSINIT:456B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">kbd_exit
</span><span style="color:black">SYSINIT:456D
SYSINIT:456D </span><span style="color:gray">kbd_cfg_confirm</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:456D                 </span><span style="color:navy">mov     dx, offset </span>_$InterMsg <span style="color:gray">; &quot;PC DOS will prompt you to confirm each &quot;...
</span><span style="color:black">SYSINIT:4570                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:4573                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">1           </span>; yes, interactive-boot option enabled
<span style="color:black">SYSINIT:4575                 </span><span style="color:navy">mov     ds:</span>bQueryOpt<span style="color:navy">, bl </span>; change default setting
<span style="color:black">SYSINIT:4579
SYSINIT:4579 </span><span style="color:gray">kbd_eat</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4579                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0           </span>; eat the key we assumed was a signal
<span style="color:black">SYSINIT:457B                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
<span style="color:black">SYSINIT:457B                                         </span>; Return: AH = scan code, AL = character
<span style="color:black">SYSINIT:457D                 </span><span style="color:navy">mov     ds:</span>secElapsed<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:black">SYSINIT:4582                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">SYSINIT:4584                 </span><span style="color:navy">jz      short </span><span style="color:gray">kbd_clean
</span><span style="color:black">SYSINIT:4586
SYSINIT:4586 </span><span style="color:gray">kbd_test</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4586                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4589                 </span><span style="color:navy">jb      short </span><span style="color:gray">kbd_exit
</span><span style="color:black">SYSINIT:458B
SYSINIT:458B </span><span style="color:gray">kbd_clean</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:458B                 </span><span style="color:navy">call    </span>disable_autoexec ; yes, tell COMMAND to skip autoexec.bat
<span style="color:black">SYSINIT:458E                 </span><span style="color:navy">stc                     </span>; set carry to indicate abort
<span style="color:black">SYSINIT:458F                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4590 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4590
SYSINIT:4590 </span><span style="color:gray">kbd_exit</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4590                 </span><span style="color:navy">clc                     </span>; clear carry to indicate success
<span style="color:black">SYSINIT:4591                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4591 </span>kbd_read        <span style="color:black">endp
SYSINIT:4591
SYSINIT:4592
SYSINIT:4592 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4592
SYSINIT:4592
SYSINIT:4592 </span>set_numlock     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4592                 </span><span style="color:navy">push    ax              </span>; set numlock LED
<span style="color:black">SYSINIT:4593                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4594                 </span><span style="color:navy">in      al, </span><span style="color:green">64h         </span>; 8042 keyboard controller status register
<span style="color:black">SYSINIT:4594                                         </span>; 7:  PERR    1=parity error in data received from keyboard
<span style="color:black">SYSINIT:4594                                         </span>;    +----------- AT Mode ----------+------------ PS/2 Mode ------------+
<span style="color:black">SYSINIT:4594                                         </span>; 6: |RxTO    receive (Rx) timeout  | TO      general timeout (Rx or Tx)|
<span style="color:black">SYSINIT:4594                                         </span>; 5: |TxTO    transmit (Tx) timeout | MOBF    mouse output buffer full  |
<span style="color:black">SYSINIT:4594                                         </span>;    +------------------------------+-----------------------------------+
<span style="color:black">SYSINIT:4594                                         </span>; 4:  INH     0=keyboard communications inhibited
<span style="color:black">SYSINIT:4594                                         </span>; 3:  A2      0=60h was the port last written to, 1=64h was last
<span style="color:black">SYSINIT:4594                                         </span>; 2:  SYS     distinguishes reset types: 0=cold reboot, 1=warm reboot
<span style="color:black">SYSINIT:4594                                         </span>; 1:  IBF     1=input buffer full (keyboard can&#039;t accept data)
<span style="color:black">SYSINIT:4594                                         </span>; 0:  OBF     1=output buffer full (data from keyboard is available)
<span style="color:black">SYSINIT:4596                 </span><span style="color:navy">test    al, </span><span style="color:green">10h
</span><span style="color:black">SYSINIT:4598                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_done  </span>; keyboard communications inhibited
<span style="color:black">SYSINIT:459A                 </span><span style="color:navy">sub     ax, ax
</span><span style="color:black">SYSINIT:459C                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">SYSINIT:459E                 </span>assume ds:nothing
<span style="color:black">SYSINIT:459E                 </span><span style="color:navy">mov     ax, es:[si]     </span>; get 1st 2 bytes of value (ON or OF)
<span style="color:black">SYSINIT:45A1                 </span><span style="color:navy">cmp     ax, word ptr cs:</span>OnOff2 <span style="color:gray">; &quot;OFF&quot;
</span><span style="color:black">SYSINIT:45A6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_off
</span><span style="color:black">SYSINIT:45A8                 </span><span style="color:navy">and     </span>byte ptr ds:0417h<span style="color:navy">, </span><span style="color:green">0DFh </span>; ~20h ; turn it off
<span style="color:black">SYSINIT:45AD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set_done
</span><span style="color:black">SYSINIT:45AF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:45AF
SYSINIT:45AF </span><span style="color:gray">not_off</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45AF                 </span><span style="color:navy">cmp     ax, word ptr cs:</span>OnOff <span style="color:gray">; &quot;ON&quot;
</span><span style="color:black">SYSINIT:45B4                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:45B5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_done
</span><span style="color:black">SYSINIT:45B7                 </span><span style="color:navy">or      </span>byte ptr ds:0417h<span style="color:navy">, </span><span style="color:green">20h </span>; turn it on
<span style="color:black">SYSINIT:45BC
SYSINIT:45BC </span><span style="color:gray">set_done</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45BC                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:45BD                 </span>assume ds:nothing
<span style="color:black">SYSINIT:45BD                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:45BE                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:45BE </span>set_numlock     <span style="color:black">endp
SYSINIT:45BE
SYSINIT:45BF
SYSINIT:45BF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:45BF
SYSINIT:45BF
SYSINIT:45BF </span>menu_check      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45BF                 </span><span style="color:navy">push    cx              </span>; Search for SWITCHES,
<span style="color:black">SYSINIT:45BF                                         </span>; determine if /N or /F are present;
<span style="color:black">SYSINIT:45BF                                         </span>; if so, then disable clean/interactive boot options
<span style="color:black">SYSINIT:45C0                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:45C1                 </span><span style="color:navy">sub     bx, bx          </span>; remains ZERO until first block
<span style="color:black">SYSINIT:45C3
SYSINIT:45C3 </span><span style="color:gray">swchk_loop</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45C3                 </span><span style="color:navy">call    </span>get_char        ; get first char of current line
<span style="color:black">SYSINIT:45C6                 </span><span style="color:navy">jb      short </span><span style="color:gray">swchk_end </span>; hit eof
<span style="color:black">SYSINIT:45C8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Bh </span><span style="color:gray">; &#039;[&#039;   </span>; CONFIG_BEGIN
<span style="color:black">SYSINIT:45CA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">swchk_next1
</span><span style="color:black">SYSINIT:45CC                 </span><span style="color:navy">inc     bx              </span>; remember that we&#039;ve seen a block
<span style="color:black">SYSINIT:45CD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">swchk_nextline
</span><span style="color:black">SYSINIT:45CF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:45CF
SYSINIT:45CF </span><span style="color:gray">swchk_next1</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45CF                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Eh </span><span style="color:gray">; &#039;N&#039;   </span>; CONFIG_NUMLOCK
<span style="color:black">SYSINIT:45D1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">swchk_next2
</span><span style="color:black">SYSINIT:45D3                 </span><span style="color:navy">or      bx, bx          </span>; only do NUMLOCK commands that exist
<span style="color:black">SYSINIT:45D5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">swchk_nextline </span>; before the first block
<span style="color:black">SYSINIT:45D7                 </span><span style="color:navy">call    </span>set_numlock     ; REM it out so we don&#039;t act on it later, too
<span style="color:black">SYSINIT:45DA                 </span><span style="color:navy">mov     byte ptr es:[si-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039; </span>; CONFIG_REM
<span style="color:black">SYSINIT:45DF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">swchk_nextline
</span><span style="color:black">SYSINIT:45E1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:45E1
SYSINIT:45E1 </span><span style="color:gray">swchk_next2</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45E1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">31h </span><span style="color:gray">; &#039;1&#039;   </span>; CONFIG_SWITCHES
<span style="color:black">SYSINIT:45E3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">swchk_nextline </span>; this line ain&#039;t it
<span style="color:black">SYSINIT:45E5
SYSINIT:45E5 </span><span style="color:gray">swchk_scan</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45E5                 </span><span style="color:navy">call    </span>get_char        ; look for /N or /F
<span style="color:black">SYSINIT:45E8
SYSINIT:45E8 </span><span style="color:gray">swchk_scan1</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:45E8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; LF ; end of line ?
<span style="color:black">SYSINIT:45EA                 </span><span style="color:navy">jz      short </span><span style="color:gray">swchk_nextline
</span><span style="color:black">SYSINIT:45EC                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;   </span>; switch-char?
<span style="color:black">SYSINIT:45EE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">swchk_scan </span>; no
<span style="color:black">SYSINIT:45F0                 </span><span style="color:navy">call    </span>get_char
<span style="color:black">SYSINIT:45F3                 </span><span style="color:navy">and     al, </span><span style="color:green">0DFh        </span>; ~20h ; convert to upper case
<span style="color:black">SYSINIT:45F5                 </span><span style="color:navy">cmp     al, byte ptr ds:</span>swit_n<span style="color:navy">+</span><span style="color:green">1 </span><span style="color:gray">; &quot;N&quot;
</span><span style="color:black">SYSINIT:45F9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">swchk_scan2 </span>; no
<span style="color:black">SYSINIT:45FB                 </span><span style="color:navy">or      ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4600                 </span><span style="color:navy">jmp     short </span><span style="color:gray">swchk_scan </span>; continue looking for switches of interest
<span style="color:black">SYSINIT:4602 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4602
SYSINIT:4602 </span><span style="color:gray">swchk_scan2</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4602                 </span><span style="color:navy">cmp     al, byte ptr ds:</span>swit_f<span style="color:navy">+</span><span style="color:green">1 </span><span style="color:gray">; &quot;F&quot;
</span><span style="color:black">SYSINIT:4606                 </span><span style="color:navy">jnz     short </span><span style="color:gray">swchk_scan1 </span>; no
<span style="color:black">SYSINIT:4608                 </span><span style="color:navy">or      ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">2
</span><span style="color:black">SYSINIT:460D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">swchk_scan </span>; continue looking for switches of interest
<span style="color:black">SYSINIT:460F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:460F
SYSINIT:460F </span><span style="color:gray">swchk_nextline</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:460F                 </span><span style="color:navy">call    </span>skip_opt_line
<span style="color:black">SYSINIT:4612                 </span><span style="color:navy">jmp     short </span><span style="color:gray">swchk_loop
</span><span style="color:black">SYSINIT:4614 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4614
SYSINIT:4614 </span><span style="color:gray">swchk_end</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4614                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4615                 </span><span style="color:navy">pop     cx              </span>;
<span style="color:black">SYSINIT:4615                                         </span>; Do the keyboard tests for clean/interactive boot now,
<span style="color:black">SYSINIT:4615                                         </span>; but only if the DisableUI flag is still clear
<span style="color:black">SYSINIT:4616                 </span><span style="color:navy">test    ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:461B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">menu_search </span>;
<span style="color:black">SYSINIT:461B                                         </span>; Wait for 2 seconds first,
<span style="color:black">SYSINIT:461B                                         </span>; UNLESS the /F bit was set in bDisableUI, or
<span style="color:black">SYSINIT:461B                                         </span>; there is anything at all in the keyboard buffer
<span style="color:black">SYSINIT:461D                 </span><span style="color:navy">call    </span>kbd_read
<span style="color:black">SYSINIT:4620                 </span><span style="color:navy">jnb     short </span><span style="color:gray">menu_search
</span><span style="color:black">SYSINIT:4622                 </span><span style="color:navy">jmp     </span><span style="color:gray">menu_abort
</span><span style="color:black">SYSINIT:4625 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4625
SYSINIT:4625 </span><span style="color:gray">menu_search</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4625                 </span><span style="color:navy">sub     bx, bx          </span>; Search for MENU block;
<span style="color:black">SYSINIT:4625                                         </span>; it is allowed to be anywhere in config.sys
<span style="color:black">SYSINIT:4627                 </span><span style="color:navy">mov     di, offset </span>szMenu <span style="color:gray">; &quot;MENU&quot;
</span><span style="color:black">SYSINIT:462A                 </span><span style="color:navy">call    </span>find_block      ; find the MENU block
<span style="color:black">SYSINIT:462A                                         </span>; if no MENU, default to zero for no_selection
<span style="color:black">SYSINIT:462D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">menu_found
</span><span style="color:black">SYSINIT:462F                 </span><span style="color:navy">mov     byte ptr ds:</span>szBoot<span style="color:navy">, </span><span style="color:#ff8000">0 </span><span style="color:gray">; &quot;CONFIG=&quot;
</span><span style="color:black">SYSINIT:4634                 </span><span style="color:navy">jmp     </span><span style="color:gray">no_selection    </span>; not found
<span style="color:black">SYSINIT:4637 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4637
SYSINIT:4637 </span><span style="color:gray">menu_color</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4637                 </span><span style="color:navy">push    cx              </span>; Process the requested menu color(s)
<span style="color:black">SYSINIT:4638                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4639                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">7           </span>; default color setting
<span style="color:black">SYSINIT:463C                 </span><span style="color:navy">call    </span>get_number      ; get first number
<span style="color:black">SYSINIT:463F                 </span><span style="color:navy">and     bl, </span><span style="color:green">0Fh         </span>; first # is foreground color (for low nibble)
<span style="color:black">SYSINIT:4642                 </span><span style="color:navy">mov     ch, bl          </span>; save it in CH
<span style="color:black">SYSINIT:4644                 </span><span style="color:navy">and     dl, </span><span style="color:green">0F0h
</span><span style="color:black">SYSINIT:4647                 </span><span style="color:navy">or      dl, bl
</span><span style="color:black">SYSINIT:4649                 </span><span style="color:navy">call    </span>delim           ; did we hit a delimiter
<span style="color:black">SYSINIT:464C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">check_color </span>; no, all done
<span style="color:black">SYSINIT:464E                 </span><span style="color:navy">call    </span>get_number      ; get next number
<span style="color:black">SYSINIT:4651                 </span><span style="color:navy">and     bl, </span><span style="color:green">0Fh         </span>; second # is background color (for high nibble)
<span style="color:black">SYSINIT:4654                 </span><span style="color:navy">mov     dh, bl          </span>; save it in DH
<span style="color:black">SYSINIT:4656                 </span><span style="color:navy">and     dl, </span><span style="color:green">0Fh
</span><span style="color:black">SYSINIT:4659                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">SYSINIT:465B                 </span><span style="color:navy">shl     bl, cl
</span><span style="color:black">SYSINIT:465D                 </span><span style="color:navy">or      dl, bl
</span><span style="color:black">SYSINIT:465F
SYSINIT:465F </span><span style="color:gray">check_color</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:465F                 </span><span style="color:navy">cmp     ch, dh          </span>; are foreground/background the same?
<span style="color:black">SYSINIT:4661                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_color </span>; no
<span style="color:black">SYSINIT:4663                 </span><span style="color:navy">xor     dl, </span><span style="color:green">8           </span>; yes, so modify the fgnd intensity
<span style="color:black">SYSINIT:4666
SYSINIT:4666 </span><span style="color:gray">set_color</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4666                 </span><span style="color:navy">mov     ds:</span>bMenuColor<span style="color:navy">, dl
</span><span style="color:black">SYSINIT:466A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:466B                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:466C                 </span><span style="color:navy">jmp     </span><span style="color:gray">menu_nextitem
</span><span style="color:black">SYSINIT:466F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:466F
SYSINIT:466F </span><span style="color:gray">menu_found</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:466F                 </span><span style="color:navy">mov     ds:</span>bDefBlock<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:4674                 </span><span style="color:navy">mov     ds:</span>offDefBlock<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:467A                 </span><span style="color:navy">mov     ds:</span>secTimeOut<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:black">SYSINIT:467F                 </span><span style="color:navy">and     ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">0FDh </span>; ~2
<span style="color:black">SYSINIT:4684                 </span><span style="color:navy">call    </span>skip_opt_line   ; skip to next line
<span style="color:black">SYSINIT:4687                 </span><span style="color:navy">sub     dx, dx          </span>; initialize total block count (0 =&gt; none yet)
<span style="color:black">SYSINIT:4689
SYSINIT:4689 </span><span style="color:gray">menu_process</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4689                 </span><span style="color:navy">call    </span>get_char        ; get first char of current line
<span style="color:black">SYSINIT:468C                 </span><span style="color:navy">jb      short </span><span style="color:gray">to_menu_getdefault </span>; could happen if menu block at end (rare)
<span style="color:black">SYSINIT:468E                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; ~CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:4690                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Bh </span><span style="color:gray">; &#039;[&#039;   </span>; CONFIG_BEGIN
<span style="color:black">SYSINIT:4692                 </span><span style="color:navy">jz      short </span><span style="color:gray">to_menu_getdefault </span>; BEGIN implies END
<span style="color:black">SYSINIT:4694                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Fh </span><span style="color:gray">; &#039;O&#039;   </span>; CONFIG_SUBMENU
<span style="color:black">SYSINIT:4696                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_item </span>; go process sub-menu
<span style="color:black">SYSINIT:4698                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">45h </span><span style="color:gray">; &#039;E&#039;   </span>; CONFIG_MENUITEM
<span style="color:black">SYSINIT:469A                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_item </span>; go process menu item
<span style="color:black">SYSINIT:469C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;   </span>; CONFIG_MENUDEFAULT
<span style="color:black">SYSINIT:469E                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_default </span>; go process menu default
<span style="color:black">SYSINIT:46A0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">52h </span><span style="color:gray">; &#039;R&#039;   </span>; CONFIG_MENUCOLOR
<span style="color:black">SYSINIT:46A2                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_color </span>; go process menu color
<span style="color:black">SYSINIT:46A4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Eh </span><span style="color:gray">; &#039;N&#039;   </span>; CONFIG_NUMLOCK
<span style="color:black">SYSINIT:46A6                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_numlock
</span><span style="color:black">SYSINIT:46A8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; CONFIG_REM
<span style="color:black">SYSINIT:46AA                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_nextitem </span>; allow remarks in menu block
<span style="color:black">SYSINIT:46AC                 </span><span style="color:navy">call    </span>any_delim       ; allow blank lines and such
<span style="color:black">SYSINIT:46AF                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_nextitem
</span><span style="color:black">SYSINIT:46B1                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:46B2                 </span><span style="color:navy">call    </span>print_error     ; non-MENU command!
<span style="color:black">SYSINIT:46B5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">menu_nextitem
</span><span style="color:black">SYSINIT:46B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:46B7
SYSINIT:46B7 </span><span style="color:gray">menu_numlock</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:46B7                 </span><span style="color:navy">call    </span>set_numlock
<span style="color:black">SYSINIT:46BA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">menu_nextitem
</span><span style="color:black">SYSINIT:46BC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:46BC
SYSINIT:46BC </span><span style="color:gray">to_menu_getdefault</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:46BC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">menu_getdefault
</span><span style="color:black">SYSINIT:46BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:46BE
SYSINIT:46BE </span><span style="color:gray">menu_default</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:46BE                 </span><span style="color:navy">mov     ds:</span>offDefBlock<span style="color:navy">, si </span>; save address of default block name
<span style="color:black">SYSINIT:46C2                 </span><span style="color:navy">cmp     ds:</span>secElapsed<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:46C7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">timeout_skip </span>; secElapsed is only zero for the FIRST menu,
<span style="color:black">SYSINIT:46C9                 </span><span style="color:navy">call    </span>skip_token      ; and for subsequent menus IF nothing was typed;
<span style="color:black">SYSINIT:46CC                 </span><span style="color:navy">jb      short </span><span style="color:gray">menu_nextitem </span>; secElapsed becomes -1 forever as soon as
<span style="color:black">SYSINIT:46CE                 </span><span style="color:navy">call    </span>skip_delim      ; something is typed
<span style="color:black">SYSINIT:46D1                 </span><span style="color:navy">jb      short </span><span style="color:gray">menu_nextitem
</span><span style="color:black">SYSINIT:46D3                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">SYSINIT:46D5                 </span><span style="color:navy">call    </span>get_number      ; get number (of seconds for timeout)
<span style="color:black">SYSINIT:46D8                 </span><span style="color:navy">cmp     bl, </span><span style="color:green">90          </span>; limit it to a reasonable number
<span style="color:black">SYSINIT:46DB                 </span><span style="color:navy">jb      short </span><span style="color:gray">timeout_ok </span>; (besides, 99 is the largest # my simple
<span style="color:black">SYSINIT:46DD                 </span><span style="color:navy">mov     bl, </span><span style="color:green">90
</span><span style="color:black">SYSINIT:46DF
SYSINIT:46DF </span><span style="color:gray">timeout_ok</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:46DF                 </span><span style="color:navy">mov     ds:</span>secTimeOut<span style="color:navy">, bl
</span><span style="color:black">SYSINIT:46E3
SYSINIT:46E3 </span><span style="color:gray">timeout_skip</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:46E3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">menu_nextitem
</span><span style="color:black">SYSINIT:46E5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:46E5
SYSINIT:46E5 </span><span style="color:gray">menu_item</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:46E5                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">9           </span>; MAX_MULTI_CONFIG
<span style="color:black">SYSINIT:46E5                                         </span>; have we reached the max # of items yet?
<span style="color:black">SYSINIT:46E8                 </span><span style="color:navy">jnb     short </span><span style="color:gray">menu_nextitem
</span><span style="color:black">SYSINIT:46EA                 </span><span style="color:navy">mov     di, si          </span>; DS:DI -&gt; block name to search for
<span style="color:black">SYSINIT:46EC                 </span><span style="color:navy">call    </span>srch_block
<span style="color:black">SYSINIT:46EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_itemfound </span>; srch_block, having succeeded,
<span style="color:black">SYSINIT:46EF                                         </span>; returns DI -&gt; past the token that it just matched,
<span style="color:black">SYSINIT:46EF                                         </span>; which in this case should be a descriptive string;
<span style="color:black">SYSINIT:46EF                                         </span>; ES:SI and CX are unmodified
<span style="color:black">SYSINIT:46F1                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:46F2                 </span><span style="color:navy">call    </span>print_error     ; print error and pause
<span style="color:black">SYSINIT:46F5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">menu_nextitem </span>; if not found, ignore this menu item
<span style="color:black">SYSINIT:46F7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:46F7
SYSINIT:46F7 </span><span style="color:gray">menu_itemfound</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:46F7                 </span><span style="color:navy">inc     dx              </span>; otherwise, increment total block count
<span style="color:black">SYSINIT:46F8                 </span><span style="color:navy">mov     bx, dx          </span>; and use it to index the arrays of offsets
<span style="color:black">SYSINIT:46FA                 </span><span style="color:navy">mov     ds:</span>abBlockType<span style="color:navy">[bx], al
</span><span style="color:black">SYSINIT:46FE                 </span><span style="color:navy">add     bx, bx          </span>; of recorded block names and descriptions
<span style="color:black">SYSINIT:4700                 </span><span style="color:navy">mov     ds:</span>aoffBlockName<span style="color:navy">[bx], si </span>;
<span style="color:black">SYSINIT:4700                                         </span>; There should be a description immediately following
<span style="color:black">SYSINIT:4700                                         </span>; the block name on MENUITEM line; failing that,
<span style="color:black">SYSINIT:4700                                         </span>; we&#039;ll just use the block name as the description...
<span style="color:black">SYSINIT:4704                 </span><span style="color:navy">mov     ds:</span>aoffBlockDesc<span style="color:navy">[bx], si
</span><span style="color:black">SYSINIT:4708                 </span><span style="color:navy">mov     di, bx          </span>; skip_delim modifies BX, so stash it in DI
<span style="color:black">SYSINIT:470A                 </span><span style="color:navy">call    </span>skip_token
<span style="color:black">SYSINIT:470D                 </span><span style="color:navy">jb      short </span><span style="color:gray">menu_nextitem </span>; hit eol/eof
<span style="color:black">SYSINIT:470F                 </span><span style="color:navy">call    </span>skip_delim
<span style="color:black">SYSINIT:4712                 </span><span style="color:navy">jb      short </span><span style="color:gray">menu_nextitem </span>; hit eol/eof
<span style="color:black">SYSINIT:4714                 </span><span style="color:navy">xchg    bx, di
</span><span style="color:black">SYSINIT:4716                 </span><span style="color:navy">mov     ds:</span>aoffBlockDesc<span style="color:navy">[bx], di
</span><span style="color:black">SYSINIT:471A
SYSINIT:471A </span><span style="color:gray">menu_nextitem</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:471A                 </span><span style="color:navy">call    </span>skip_opt_line
<span style="color:black">SYSINIT:471D                 </span><span style="color:navy">jmp     </span><span style="color:gray">menu_process    </span>; go back for more lines
<span style="color:black">SYSINIT:4720 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4720
SYSINIT:4720 </span><span style="color:gray">menu_getdefault</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4720                 </span><span style="color:navy">or      dl, dl          </span>; Display menu items now,
<span style="color:black">SYSINIT:4720                                         </span>; after determining which one is default
<span style="color:black">SYSINIT:4720                                         </span>;
<span style="color:black">SYSINIT:4720                                         </span>; where there any valid blocks at all?
<span style="color:black">SYSINIT:4722                 </span><span style="color:navy">jnz     short </span><span style="color:gray">menu_valid </span>; yes
<span style="color:black">SYSINIT:4724                 </span><span style="color:navy">sub     bx, bx          </span>; no, so force autoselect of 0
<span style="color:black">SYSINIT:4726                 </span><span style="color:navy">jmp     </span><span style="color:gray">menu_autoselect </span>; (meaning: process common blocks only)
<span style="color:black">SYSINIT:4729 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4729
SYSINIT:4729 </span><span style="color:gray">menu_valid</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4729                 </span><span style="color:navy">sub     bx, bx
</span><span style="color:black">SYSINIT:472B                 </span><span style="color:navy">mov     ds:</span>bMaxBlock<span style="color:navy">, dl </span>; first, record how many blocks we found
<span style="color:black">SYSINIT:472F                 </span><span style="color:navy">mov     di, ds:</span>offDefBlock
<span style="color:black">SYSINIT:4733                 </span><span style="color:navy">or      di, di          </span>; does a default block exist?
<span style="color:black">SYSINIT:4735                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_nodefault </span>; no
<span style="color:black">SYSINIT:4737                 </span><span style="color:navy">inc     bx              </span>; yes, walk name table, looking for default
<span style="color:black">SYSINIT:4738
SYSINIT:4738 </span><span style="color:gray">menu_chkdefault</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4738                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:4739                 </span><span style="color:navy">add     bx, bx
</span><span style="color:black">SYSINIT:473B                 </span><span style="color:navy">mov     si, ds:</span>aoffBlockName<span style="color:navy">[bx]
</span><span style="color:black">SYSINIT:473F                 </span><span style="color:navy">mov     cx, </span><span style="color:green">128         </span>; arbitrary maximum length of a name
<span style="color:black">SYSINIT:4742                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4743                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4744                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4745                 </span><span style="color:navy">call    </span>comp_names      ; is this block the same as the default?
<span style="color:black">SYSINIT:4748                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4749                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:474A                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_setdefault </span>; yes
<span style="color:black">SYSINIT:474C                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:474D                 </span><span style="color:navy">cmp     bl, ds:</span>bMaxBlock ; all done searching?
<span style="color:black">SYSINIT:4751                 </span><span style="color:navy">jbe     short </span><span style="color:gray">menu_chkdefault </span>; not yet
<span style="color:black">SYSINIT:4753
SYSINIT:4753 </span><span style="color:gray">menu_nodefault</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4753                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">1           </span>; if no default, force default to #1
<span style="color:black">SYSINIT:4755
SYSINIT:4755 </span><span style="color:gray">menu_setdefault</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4755                 </span><span style="color:navy">mov     ds:</span>bDefBlock<span style="color:navy">, bl </span>; yes, this will be the initial current block
<span style="color:black">SYSINIT:4755                                         </span>;
<span style="color:black">SYSINIT:4755                                         </span>; If the timeout was explicitly set to 0 (or technically,
<span style="color:black">SYSINIT:4755                                         </span>; anything that failed to resolve to a number, like &quot;NONE&quot;
<span style="color:black">SYSINIT:4755                                         </span>; or &quot;EAT POTATOES&quot;), then we&#039;re supposed to skip menu display
<span style="color:black">SYSINIT:4755                                         </span>; and run with the specified default block; however,
<span style="color:black">SYSINIT:4755                                         </span>; if the user hit Enter prior to boot, thereby requesting fully
<span style="color:black">SYSINIT:4755                                         </span>; INTERACTIVE boot, then we shall display the menu block anyway
<span style="color:black">SYSINIT:4755                                         </span>; (though still with no timeout)
<span style="color:black">SYSINIT:4759                 </span><span style="color:navy">cmp     ds:</span>secTimeOut<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; is timeout zero? (ie, assume default)
<span style="color:black">SYSINIT:475E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">menu_display </span>; no
<span style="color:black">SYSINIT:4760                 </span><span style="color:navy">test    ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">1 </span>; yes, but was INTERACTIVE requested?
<span style="color:black">SYSINIT:4765                 </span><span style="color:navy">jnz     short </span><span style="color:gray">menu_display </span>; yes, so *don&#039;t* assume default after all
<span style="color:black">SYSINIT:4767                 </span><span style="color:navy">jmp     </span><span style="color:gray">not_topmenu
</span><span style="color:black">SYSINIT:476A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:476A
SYSINIT:476A </span><span style="color:gray">menu_display</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:476A                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Fh         </span>; Reset the mode,
<span style="color:black">SYSINIT:476A                                         </span>; so that we know screen is clean and cursor is home
<span style="color:black">SYSINIT:476A                                         </span>; ;
<span style="color:black">SYSINIT:476C                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - GET CURRENT VIDEO MODE
<span style="color:black">SYSINIT:476C                                         </span>; Return: AH = number of columns on screen
<span style="color:black">SYSINIT:476C                                         </span>; AL = current video mode
<span style="color:black">SYSINIT:476C                                         </span>; BH = current active display page
<span style="color:black">SYSINIT:476E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4770                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET VIDEO MODE
<span style="color:black">SYSINIT:4770                                         </span>; AL = mode
<span style="color:black">SYSINIT:4772                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4773                 </span><span style="color:navy">mov     ax, </span><span style="color:green">40h         </span>; reach down into the ROM BIOS data area
<span style="color:black">SYSINIT:4776                 </span><span style="color:navy">mov     es, ax          </span>; and save the current (default) video page
<span style="color:black">SYSINIT:4778                 </span>assume es:nothing
<span style="color:black">SYSINIT:4778                 </span><span style="color:navy">mov     ax, </span>es:4Eh      ; start address and page #, in case the
<span style="color:black">SYSINIT:477C                 </span><span style="color:navy">mov     ds:</span>wCRTStart<span style="color:navy">, ax </span>; undocumented QUIET option was enabled
<span style="color:black">SYSINIT:477F                 </span><span style="color:navy">mov     al, </span>es:62h
<span style="color:black">SYSINIT:4783                 </span><span style="color:navy">mov     ds:</span>bCRTPage<span style="color:navy">, al
</span><span style="color:black">SYSINIT:4786                 </span><span style="color:navy">mov     ax, word ptr ds:</span>bMenuPage ; select new page for menu
<span style="color:black">SYSINIT:4789                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO -
<span style="color:black">SYSINIT:478B                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">600h        </span>; clear entire screen
<span style="color:black">SYSINIT:478E                 </span><span style="color:navy">mov     bh, ds:</span>bMenuColor ; using this color
<span style="color:black">SYSINIT:4792                 </span><span style="color:navy">sub     cx, cx          </span>; upper left row/col
<span style="color:black">SYSINIT:4794                 </span><span style="color:navy">mov     dl, </span>es:4Ah      ; [es:CRT_Cols]
<span style="color:black">SYSINIT:4799                 </span><span style="color:navy">dec     dl
</span><span style="color:black">SYSINIT:479B                 </span><span style="color:navy">mov     dh, </span>es:84h      ; [es:CRT_Rows]
<span style="color:black">SYSINIT:47A0                 </span><span style="color:navy">or      dh, dh          </span>; # of rows valid?
<span style="color:black">SYSINIT:47A2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">menu_clear </span>; hopefully
<span style="color:black">SYSINIT:47A4                 </span><span style="color:navy">mov     dh, ds:</span>bLastRow ; no, use a default
<span style="color:black">SYSINIT:47A8
SYSINIT:47A8 </span><span style="color:gray">menu_clear</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:47A8                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; clear the screen using the req. attribute
<span style="color:black">SYSINIT:47A8                                         </span>;
<span style="color:black">SYSINIT:47A8                                         </span>; - VIDEO - SCROLL PAGE UP
<span style="color:black">SYSINIT:47A8                                         </span>; AL = number of lines to scroll window (0 = blank whole window)
<span style="color:black">SYSINIT:47A8                                         </span>; BH = attributes to be used on blanked lines
<span style="color:black">SYSINIT:47A8                                         </span>; CH,CL = row,column of upper left corner of window to scroll
<span style="color:black">SYSINIT:47A8                                         </span>; DH,DL = row,column of lower right corner of window
<span style="color:black">SYSINIT:47AA                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:47AB                 </span>assume es:nothing
<span style="color:black">SYSINIT:47AB                 </span><span style="color:navy">mov     ds:</span>bLastRow<span style="color:navy">, dh </span>; save DH
<span style="color:black">SYSINIT:47AF                 </span><span style="color:navy">mov     dx, offset </span>_$MenuHeader <span style="color:gray">; &quot;\r\n  PC DOS 7.1 Startup Menu\r\n  &quot;
</span><span style="color:black">SYSINIT:47B2                 </span><span style="color:navy">call    </span>print           ; cursor now on row 3 (numbered from 0)
<span style="color:black">SYSINIT:47B5                 </span><span style="color:navy">test    ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:47BA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">menu_nostatus
</span><span style="color:black">SYSINIT:47BC                 </span><span style="color:navy">mov     bh, ds:</span>bMenuPage
<span style="color:black">SYSINIT:47C0                 </span><span style="color:navy">mov     dh, ds:</span>bLastRow ; restore DH
<span style="color:black">SYSINIT:47C4                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0           </span>; print the status line on row DH, col 0,
<span style="color:black">SYSINIT:47C6                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; now that we can trash the cursor position
<span style="color:black">SYSINIT:47C8                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:47C8                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:47C8                                         </span>; BH = page number
<span style="color:black">SYSINIT:47CA                 </span><span style="color:navy">mov     dx, offset </span>_$StatusLine <span style="color:gray">; &quot;F5=Bypass startup files F8=Confirm each&quot;...
</span><span style="color:black">SYSINIT:47CD                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:47D0                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3           </span>; get cursor position
<span style="color:black">SYSINIT:47D2                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - READ CURSOR POSITION
<span style="color:black">SYSINIT:47D2                                         </span>; BH = page number
<span style="color:black">SYSINIT:47D2                                         </span>; Return: DH,DL = row,column, CH = cursor start line, CL = cursor end line
<span style="color:black">SYSINIT:47D4                 </span><span style="color:navy">sub     dl, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:47D7                 </span><span style="color:navy">mov     ds:</span>bLastCol<span style="color:navy">, dl </span>; save column where status char will go
<span style="color:black">SYSINIT:47DB
SYSINIT:47DB </span><span style="color:gray">menu_nostatus</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:47DB                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1           </span>; now prepare to display all the menu items
<span style="color:black">SYSINIT:47DE
SYSINIT:47DE </span><span style="color:gray">menu_disploop</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:47DE                 </span><span style="color:navy">call    </span>print_item      ; print item #BL
<span style="color:black">SYSINIT:47E1                 </span><span style="color:navy">inc     bx              </span>; why &quot;inc bx&quot;? because it&#039;s a 1-byte opcode
<span style="color:black">SYSINIT:47E2                 </span><span style="color:navy">cmp     bl, ds:</span>bMaxBlock ; all done?
<span style="color:black">SYSINIT:47E6                 </span><span style="color:navy">jbe     short </span><span style="color:gray">menu_disploop </span>; not yet
<span style="color:black">SYSINIT:47E8                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0           </span>; Set cursor position to just below the menu items
<span style="color:black">SYSINIT:47E8                                         </span>; column 0
<span style="color:black">SYSINIT:47EA                 </span><span style="color:navy">mov     dh, bl
</span><span style="color:black">SYSINIT:47EC                 </span><span style="color:navy">add     dh, </span><span style="color:#ff8000">4           </span>; select row below menu
<span style="color:black">SYSINIT:47EF                 </span><span style="color:navy">mov     bh, ds:</span>bMenuPage
<span style="color:black">SYSINIT:47F3                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; set cursor position beneath the block list
<span style="color:black">SYSINIT:47F5                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:47F5                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:47F5                                         </span>; BH = page number
<span style="color:black">SYSINIT:47F7                 </span><span style="color:navy">mov     dx, offset </span>_$MenuPrmpt <span style="color:gray">; &quot;  Enter a choice: $&quot;
</span><span style="color:black">SYSINIT:47FA                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:47FD                 </span><span style="color:navy">call    </span>select_item     ; make a selection, return # in BX
<span style="color:black">SYSINIT:4800                 </span><span style="color:navy">mov     dx, offset </span>crlfm <span style="color:gray">; &quot;\r\n$&quot;
</span><span style="color:black">SYSINIT:4803                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:4806                 </span><span style="color:navy">push    word ptr ds:</span>bDisableUI
<span style="color:black">SYSINIT:480A                 </span><span style="color:navy">or      ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:480F                 </span><span style="color:navy">call    </span>show_status     ; clear the status line now
<span style="color:black">SYSINIT:4812                 </span><span style="color:navy">pop     word ptr ds:</span>bDisableUI ;
<span style="color:black">SYSINIT:4812                                         </span>; Now begins the &quot;re-organization&quot; process...
<span style="color:black">SYSINIT:4816
SYSINIT:4816 </span><span style="color:gray">menu_autoselect</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4816                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFFh      </span>; -1 ; clean boot requested?
<span style="color:black">SYSINIT:4819                 </span><span style="color:navy">jnz     short </span><span style="color:gray">normal_boot
</span><span style="color:black">SYSINIT:481B                 </span><span style="color:navy">call    </span>disable_autoexec
<span style="color:black">SYSINIT:481E
SYSINIT:481E </span><span style="color:gray">menu_abort</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:481E                 </span><span style="color:navy">sub     cx, cx
</span><span style="color:black">SYSINIT:4820                 </span><span style="color:navy">jmp     </span><span style="color:gray">menu_exit
</span><span style="color:black">SYSINIT:4823 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4823
SYSINIT:4823 </span><span style="color:gray">normal_boot</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4823                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFEh      </span>; -2 ; back to top-level menu?
<span style="color:black">SYSINIT:4826                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_topmenu </span>; no
<span style="color:black">SYSINIT:4828                 </span><span style="color:navy">mov     cx, ds:</span>count    ; yes, start all over
<span style="color:black">SYSINIT:482C                 </span><span style="color:navy">sub     si, si
</span><span style="color:black">SYSINIT:482E                 </span><span style="color:navy">jmp     </span><span style="color:gray">menu_search
</span><span style="color:black">SYSINIT:4831 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4831
SYSINIT:4831 </span><span style="color:gray">not_topmenu</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4831                 </span><span style="color:navy">cmp     ds:</span>abBlockType<span style="color:navy">[bx], </span><span style="color:green">4Fh </span>; CONFIG_SUBMENU
<span style="color:black">SYSINIT:4836                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_submenu
</span><span style="color:black">SYSINIT:4838                 </span><span style="color:navy">add     bx, bx
</span><span style="color:black">SYSINIT:483A                 </span><span style="color:navy">mov     di, ds:</span>aoffBlockName<span style="color:navy">[bx]
</span><span style="color:black">SYSINIT:483E                 </span><span style="color:navy">call    </span>srch_block      ; THIS CANNOT FAIL!
<span style="color:black">SYSINIT:4841                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">SYSINIT:4843                 </span><span style="color:navy">mov     cx, bx          </span>; ES:SI and CX are ready for another round
<span style="color:black">SYSINIT:4845                 </span><span style="color:navy">jmp     </span><span style="color:gray">menu_found
</span><span style="color:black">SYSINIT:4848 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4848
SYSINIT:4848 </span><span style="color:gray">not_submenu</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4848                 </span><span style="color:navy">add     bx, bx          </span>; get BX -&gt; name of selected block
<span style="color:black">SYSINIT:484A                 </span><span style="color:navy">mov     bx, ds:</span>aoffBlockName<span style="color:navy">[bx] </span>;
<span style="color:black">SYSINIT:484A                                         </span>; BX should now either be ZERO
<span style="color:black">SYSINIT:484A                                         </span>; (meaning no block has been selected) or the offset
<span style="color:black">SYSINIT:484A                                         </span>; relative to ES of the block name to be processed
<span style="color:black">SYSINIT:484A                                         </span>; (along with all the &quot;common&quot; lines of course)
<span style="color:black">SYSINIT:484E
SYSINIT:484E </span><span style="color:gray">no_selection</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:484E                 </span><span style="color:navy">mov     ds:</span>offDefBlock<span style="color:navy">, bx </span>; save selection
<span style="color:black">SYSINIT:4852                 </span><span style="color:navy">mov     cx, ds:</span>count    ; reset ES:SI and CX for reprocessing
<span style="color:black">SYSINIT:4856                 </span><span style="color:navy">sub     si, si
</span><span style="color:black">SYSINIT:4858                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4859                 </span><span style="color:navy">mov     ds, ds:</span>config_wrkseg ; this is where we&#039;ll store new config.sys image
<span style="color:black">SYSINIT:485D                 </span><span style="color:navy">sub     di, di          </span>;
<span style="color:black">SYSINIT:485D                                         </span>; ES:SI-&gt; config.sys, DS:DI -&gt; new config.sys workspace
<span style="color:black">SYSINIT:485D                                         </span>;
<span style="color:black">SYSINIT:485D                                         </span>; Work our way through the config.sys image again, this time copying
<span style="color:black">SYSINIT:485D                                         </span>; all lines that are (A) &quot;common&quot; lines outside any block or (B) lines
<span style="color:black">SYSINIT:485D                                         </span>; within the requested block. Lines inside INCLUDEd blocks are
<span style="color:black">SYSINIT:485D                                         </span>; transparently copied by copy_block in a recursive fashion;
<span style="color:black">SYSINIT:485D                                         </span>; the amount of recursion is limited by the fact INCLUDE statements are
<span style="color:black">SYSINIT:485D                                         </span>; REMed by copy_block as they are processed and by the number of unique
<span style="color:black">SYSINIT:485D                                         </span>; INCLUDE stmts in config.sys...
<span style="color:black">SYSINIT:485F
SYSINIT:485F </span><span style="color:gray">copyblock_loop</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:485F                 </span><span style="color:navy">push    bx              </span>; save selected block name
<span style="color:black">SYSINIT:4860                 </span><span style="color:navy">call    </span>copy_block      ; process (named or common) block
<span style="color:black">SYSINIT:4863                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4864                 </span><span style="color:navy">jb      short </span><span style="color:gray">move_config </span>; hit eof
<span style="color:black">SYSINIT:4866
SYSINIT:4866 </span><span style="color:gray">copyblock_begin</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4866                 </span><span style="color:navy">push    ax              </span>; copy_block can only return for two reasons:
<span style="color:black">SYSINIT:4866                                         </span>;  it hit eof or a new block
<span style="color:black">SYSINIT:4867                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:4868                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4869                 </span><span style="color:navy">push    di              </span>; always do &quot;common&quot; blocks
<span style="color:black">SYSINIT:486A                 </span><span style="color:navy">mov     di, offset </span>szCommon <span style="color:gray">; &quot;COMMON&quot;
</span><span style="color:black">SYSINIT:486D                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:486E                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:486F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4870                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:4870                 </span><span style="color:navy">call    </span>comp_names
<span style="color:black">SYSINIT:4873                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4874                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4874                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:4875                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4876                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4877                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4878                 </span><span style="color:navy">jz      short </span><span style="color:gray">copyblock_check
</span><span style="color:black">SYSINIT:487A                 </span><span style="color:navy">or      bx, bx          </span>; is there a block name to check?
<span style="color:black">SYSINIT:487C                 </span><span style="color:navy">jz      short </span><span style="color:gray">copyblock_skip </span>; no
<span style="color:black">SYSINIT:487E                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:487F                 </span><span style="color:navy">mov     di, bx          </span>; check block against given block name
<span style="color:black">SYSINIT:4881                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4882                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4883                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4884                 </span><span style="color:navy">call    </span>comp_names      ; is this the block we really want to do?
<span style="color:black">SYSINIT:4887                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4888                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:4889
SYSINIT:4889 </span><span style="color:gray">copyblock_check</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4889                 </span><span style="color:navy">jb      short </span><span style="color:gray">move_config </span>; hit eof
<span style="color:black">SYSINIT:488B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copyblock_skip
</span><span style="color:black">SYSINIT:488D                 </span><span style="color:navy">call    </span>skip_opt_line
<span style="color:black">SYSINIT:4890                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copyblock_loop
</span><span style="color:black">SYSINIT:4892 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4892
SYSINIT:4892 </span><span style="color:gray">copyblock_skip</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4892                 </span><span style="color:navy">call    </span>skip_opt_line   ; this ain&#039;t the block we wanted, so skip it
<span style="color:black">SYSINIT:4895                 </span><span style="color:navy">call    </span>get_char
<span style="color:black">SYSINIT:4898                 </span><span style="color:navy">jb      short </span><span style="color:gray">move_config </span>; hit eof
<span style="color:black">SYSINIT:489A                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; ~CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:489C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Bh </span><span style="color:gray">; &#039;[&#039;   </span>; CONFIG_BEGIN
<span style="color:black">SYSINIT:489E                 </span><span style="color:navy">jz      short </span><span style="color:gray">copyblock_begin
</span><span style="color:black">SYSINIT:48A0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copyblock_skip </span>; anything else is just skipped
<span style="color:black">SYSINIT:48A2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:48A2
SYSINIT:48A2 </span><span style="color:gray">move_config</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:48A2                 </span><span style="color:navy">mov     cx, di          </span>; To create as little risk to the rest of SysInit
<span style="color:black">SYSINIT:48A2                                         </span>; as little as possible, and to free the workspace
<span style="color:black">SYSINIT:48A2                                         </span>; at &quot;config_wrkseg&quot; for creating an environment,
<span style="color:black">SYSINIT:48A2                                         </span>; copy the new config.sys image to &quot;confbot&quot;.
<span style="color:black">SYSINIT:48A2                                         </span>;
<span style="color:black">SYSINIT:48A2                                         </span>; now copy workspace at DS:DI to &quot;confbot&quot;
<span style="color:black">SYSINIT:48A4                 </span><span style="color:navy">push    cx              </span>;
<span style="color:black">SYSINIT:48A4                                         </span>; But first, copy the CONFIG=&lt;configuration&gt;&lt;0&gt; string
<span style="color:black">SYSINIT:48A4                                         </span>; to the workspace, since the configuration name only
<span style="color:black">SYSINIT:48A4                                         </span>; currently exists in the &quot;confbot&quot; area.
<span style="color:black">SYSINIT:48A4                                         </span>; ;
<span style="color:black">SYSINIT:48A5                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">7           </span>; szMenu-szBoot-1
<span style="color:black">SYSINIT:48A5                                         </span>; first copy the CONFIG= part
<span style="color:black">SYSINIT:48A8                 </span><span style="color:navy">mov     si, offset </span>szBoot <span style="color:gray">; &quot;CONFIG=&quot;
</span><span style="color:black">SYSINIT:48AB                 </span><span style="color:navy">inc     di              </span>; skip a byte, in case absolutely nothing
<span style="color:black">SYSINIT:48AB                                         </span>; was copied to the workspace, because we always
<span style="color:black">SYSINIT:48AB                                         </span>; zero the first byte of the workspace (below)
<span style="color:black">SYSINIT:48AC
SYSINIT:48AC </span><span style="color:gray">copy_boot</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:48AC                 </span><span style="color:navy">lods    byte ptr cs:[si]
</span><span style="color:black">SYSINIT:48AE                 </span><span style="color:navy">mov     [di], al
</span><span style="color:black">SYSINIT:48B0                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:48B1                 </span><span style="color:navy">loop    </span><span style="color:gray">copy_boot
</span><span style="color:black">SYSINIT:48B3                 </span><span style="color:navy">push    es              </span>; then copy the configuration name
<span style="color:black">SYSINIT:48B4                 </span><span style="color:navy">mov     cx, </span><span style="color:green">121         </span>; 128-7 ; put an upper limit on the name, to be safe
<span style="color:black">SYSINIT:48B7                 </span><span style="color:navy">mov     si, cs:</span>offDefBlock ; ES:SI -&gt; default block name
<span style="color:black">SYSINIT:48BC                 </span><span style="color:navy">or      si, si          </span>; valid?
<span style="color:black">SYSINIT:48BE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">l1        </span>; yes
<span style="color:black">SYSINIT:48C0                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:48C1                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:48C2                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:48C2                 </span><span style="color:navy">mov     si, offset </span>szCommon <span style="color:gray">; &quot;COMMON&quot;
</span><span style="color:black">SYSINIT:48C5
SYSINIT:48C5 </span><span style="color:gray">l1</span><span style="color:navy">:                                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:48C5                 </span><span style="color:navy">mov     al, es:[si]
</span><span style="color:black">SYSINIT:48C8                 </span><span style="color:navy">call    </span>any_delim
<span style="color:black">SYSINIT:48CB                 </span><span style="color:navy">jz      short </span><span style="color:gray">l2
</span><span style="color:black">SYSINIT:48CD                 </span><span style="color:navy">mov     [di], al
</span><span style="color:black">SYSINIT:48CF                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:48D0                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:48D1                 </span><span style="color:navy">loop    </span><span style="color:gray">l1
</span><span style="color:black">SYSINIT:48D3
SYSINIT:48D3 </span><span style="color:gray">l2</span><span style="color:navy">:                                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:48D3                 </span><span style="color:navy">mov     byte ptr [di], </span><span style="color:#ff8000">0Ah </span>; terminate the configuration string
<span style="color:black">SYSINIT:48D6                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:48D7                 </span>assume es:nothing
<span style="color:black">SYSINIT:48D7                 </span><span style="color:navy">sub     di, di          </span>; Now we can copy &quot;config_wrkseg&quot; (DS) to &quot;confbot&quot; (ES)
<span style="color:black">SYSINIT:48D9                 </span><span style="color:navy">mov     cs:</span>config_envlen<span style="color:navy">, di
</span><span style="color:black">SYSINIT:48DE                 </span><span style="color:navy">sub     si, si
</span><span style="color:black">SYSINIT:48E0                 </span><span style="color:navy">pop     cx              </span>; recover the size of &quot;config_wrkseg&quot;
<span style="color:black">SYSINIT:48E1                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:48E2                 </span><span style="color:navy">rep movsb               </span>; moved!
<span style="color:black">SYSINIT:48E4                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:48E5                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">SYSINIT:48E7                 </span><span style="color:navy">pop     ds              </span>; Now that the config_wrkseg is available once again,
<span style="color:black">SYSINIT:48E7                                         </span>; we shall use it to create an environment. The first
<span style="color:black">SYSINIT:48E7                                         </span>; thing to go in will be the &quot;CONFIG=configuration&quot; thing.
<span style="color:black">SYSINIT:48E7                                         </span>; It is also important to zero the first byte of the workspace,
<span style="color:black">SYSINIT:48E7                                         </span>; so that copy_envvar knows the buffer is empty.
<span style="color:black">SYSINIT:48E8                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:48E9                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:48EB                 </span><span style="color:navy">inc     si              </span>; ES:SI -&gt; &quot;CONFIG=configuration&quot;
<span style="color:black">SYSINIT:48EC                 </span><span style="color:navy">mov     byte ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; empty the environment block
<span style="color:black">SYSINIT:48F2                 </span><span style="color:navy">call    </span>copy_envvar     ; copy envvar at ES:SI to &quot;config_wrkseg&quot;
<span style="color:black">SYSINIT:48F5                 </span><span style="color:navy">pop     es              </span>;
<span style="color:black">SYSINIT:48F5                                         </span>; Before returning, restore the default video page setting
<span style="color:black">SYSINIT:48F5                                         </span>; but do NOT do it using INT 10h&#039;s Set Active Page function,
<span style="color:black">SYSINIT:48F5                                         </span>; because if the menu was displayed on a different page,
<span style="color:black">SYSINIT:48F5                                         </span>; then it&#039;s because we don&#039;t want to see all the device
<span style="color:black">SYSINIT:48F5                                         </span>; driver/TSR goop (which goes to the default page)
<span style="color:black">SYSINIT:48F6                 </span><span style="color:navy">cmp     ds:</span>bMenuPage<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:48FB                 </span><span style="color:navy">jz      short </span><span style="color:gray">menu_exit
</span><span style="color:black">SYSINIT:48FD                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:48FE                 </span><span style="color:navy">mov     ax, </span><span style="color:green">40h
</span><span style="color:black">SYSINIT:4901                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">SYSINIT:4903                 </span>assume es:nothing
<span style="color:black">SYSINIT:4903                 </span><span style="color:navy">mov     ax, ds:</span>wCRTStart
<span style="color:black">SYSINIT:4906                 </span><span style="color:navy">mov     </span>es:4Eh<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:490A                 </span><span style="color:navy">mov     al, ds:</span>bCRTPage
<span style="color:black">SYSINIT:490D                 </span><span style="color:navy">mov     </span>es:62h<span style="color:navy">, al
</span><span style="color:black">SYSINIT:4911                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:4912                 </span>assume es:nothing
<span style="color:black">SYSINIT:4912
SYSINIT:4912 </span><span style="color:gray">menu_exit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4912                 </span><span style="color:navy">mov     ds:</span>count<span style="color:navy">, cx
</span><span style="color:black">SYSINIT:4916                 </span><span style="color:navy">mov     ds:</span>org_count<span style="color:navy">, cx
</span><span style="color:black">SYSINIT:491A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:491A </span>menu_check      <span style="color:black">endp
SYSINIT:491A
SYSINIT:491B
SYSINIT:491B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:491B
SYSINIT:491B
SYSINIT:491B </span>copy_envvar     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:491B                 </span><span style="color:navy">push    cx              </span>; copy the envvar at ES:SI to &quot;config_wrkseg&quot;
<span style="color:black">SYSINIT:491B                                         </span>; ES:SI -&gt; environment variable
<span style="color:black">SYSINIT:491B                                         </span>;          (in the form &quot;var=string&lt;cr/lf&gt;&quot;)
<span style="color:black">SYSINIT:491C                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:491D                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:491E                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:491F                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4920                 </span><span style="color:navy">mov     es, ds:</span>config_wrkseg ; ES:DI to point to next available byte
<span style="color:black">SYSINIT:4924                 </span><span style="color:navy">pop     ds              </span>; DS:SI to point to envvar
<span style="color:black">SYSINIT:4925                 </span><span style="color:navy">sub     cx, cx
</span><span style="color:black">SYSINIT:4927
SYSINIT:4927 </span><span style="color:gray">copy_varlen</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4927                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:4928                 </span><span style="color:navy">or      al, al          </span>; NULL?
<span style="color:black">SYSINIT:492A                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:492B                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envexit </span>; yes, abort
<span style="color:black">SYSINIT:492D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:492F                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:4930                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envexit
</span><span style="color:black">SYSINIT:4932                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:4934                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:4935                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envexit
</span><span style="color:black">SYSINIT:4937                 </span><span style="color:navy">inc     cx
</span><span style="color:black">SYSINIT:4938                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Dh </span><span style="color:gray">; &#039;=&#039;
</span><span style="color:black">SYSINIT:493A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copy_varlen
</span><span style="color:black">SYSINIT:493C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:493E                 </span><span style="color:navy">mov     ah, [si]        </span>; save char after &#039;=&#039;
<span style="color:black">SYSINIT:4940                 </span><span style="color:navy">sub     si, cx          </span>; back up to given varname
<span style="color:black">SYSINIT:4942                 </span><span style="color:navy">dec     cx              </span>; CX == # of bytes in varname
<span style="color:black">SYSINIT:4943                 </span><span style="color:navy">sub     di, di          </span>; start looking for DS:SI at ES:0
<span style="color:black">SYSINIT:4945
SYSINIT:4945 </span><span style="color:gray">copy_varsrch</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4945                 </span><span style="color:navy">cmp     es:[di], al
</span><span style="color:black">SYSINIT:4948                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envprep </span>; search failed, just copy var
<span style="color:black">SYSINIT:494A                 </span><span style="color:navy">mov     bx, di          </span>; ES:BX -&gt; start of this varname
<span style="color:black">SYSINIT:494C                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:494D                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:494E                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">SYSINIT:4950                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4951                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4952                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copy_varnext </span>; no match, skip to next varname
<span style="color:black">SYSINIT:4954                 </span><span style="color:navy">cmp     byte ptr es:[di], &#039;</span><span style="color:green">=&#039;
</span><span style="color:black">SYSINIT:4958                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copy_varnext </span>; no match, there&#039;s more characters
<span style="color:black">SYSINIT:4958                                         </span>;
<span style="color:black">SYSINIT:4958                                         </span>; Previous occurrence of variable has been found;
<span style="color:black">SYSINIT:4958                                         </span>; determine the entire length and then destroy it
<span style="color:black">SYSINIT:495A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">SYSINIT:495D                 </span><span style="color:navy">repne scasb             </span>; guaranteed to get null (since we put it there)
<span style="color:black">SYSINIT:495F                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4960                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">SYSINIT:4962                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">SYSINIT:4964                 </span><span style="color:navy">mov     cx, cs:</span>config_envlen
<span style="color:black">SYSINIT:4969                 </span><span style="color:navy">sub     cx, si          </span>; destroy variable now
<span style="color:black">SYSINIT:496B                 </span><span style="color:navy">rep movs byte ptr es:[di], byte ptr es:[si]
</span><span style="color:black">SYSINIT:496E                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:496F
SYSINIT:496F </span><span style="color:gray">copy_envprep</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:496F                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0Dh         </span>; if there is nothing after the &#039;=&#039;
<span style="color:black">SYSINIT:4972                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envdel
</span><span style="color:black">SYSINIT:4974                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">SYSINIT:4977                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envdel
</span><span style="color:black">SYSINIT:4979                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copy_envloop
</span><span style="color:black">SYSINIT:497B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:497B
SYSINIT:497B </span><span style="color:gray">copy_varnext</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:497B                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:497C                 </span><span style="color:navy">mov     cx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">SYSINIT:497F                 </span><span style="color:navy">repne scasb
</span><span style="color:black">SYSINIT:4981                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4982                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copy_varsrch
</span><span style="color:black">SYSINIT:4984 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4984
SYSINIT:4984 </span><span style="color:gray">copy_envloop</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4984                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:4985                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:4987                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envdone
</span><span style="color:black">SYSINIT:4989                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:498B                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_envdone
</span><span style="color:black">SYSINIT:498D                 </span><span style="color:navy">stosb
</span><span style="color:black">SYSINIT:498E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copy_envloop
</span><span style="color:black">SYSINIT:4990 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4990
SYSINIT:4990 </span><span style="color:gray">copy_envdone</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4990                 </span><span style="color:navy">sub     al, al          </span>; do SUB to clear carry as well
<span style="color:black">SYSINIT:4992                 </span><span style="color:navy">stosb                   </span>; always null-terminate these puppies
<span style="color:black">SYSINIT:4993
SYSINIT:4993 </span><span style="color:gray">copy_envdel</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4993                 </span><span style="color:navy">mov     es:[di], al     </span>; and stick another null to terminate the env.
<span style="color:black">SYSINIT:4996                 </span><span style="color:navy">mov     cs:</span>config_envlen<span style="color:navy">, di
</span><span style="color:black">SYSINIT:499B
SYSINIT:499B </span><span style="color:gray">copy_envexit</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:499B                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:499C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:499D                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:499E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:499F                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:499F </span>copy_envvar     <span style="color:black">endp
SYSINIT:499F
SYSINIT:49A0
SYSINIT:49A0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:49A0
SYSINIT:49A0
SYSINIT:49A0 </span>copy_block      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:49A0                 </span><span style="color:navy">call    </span>get_char        ; copy the current block to the new config.sys workspace
<span style="color:black">SYSINIT:49A0                                         </span>;
<span style="color:black">SYSINIT:49A0                                         </span>; CX == remaining bytes in &quot;organized&quot; config.sys memory image
<span style="color:black">SYSINIT:49A0                                         </span>; ES:SI -&gt; remaining bytes in &quot;organized&quot; config.sys memory image
<span style="color:black">SYSINIT:49A0                                         </span>; DS:DI -&gt; new config.sys workspace (equal in size to the original
<span style="color:black">SYSINIT:49A0                                         </span>;        config.sys image) where the current block is to be copied
<span style="color:black">SYSINIT:49A0                                         </span>;
<span style="color:black">SYSINIT:49A0                                         </span>; check for include
<span style="color:black">SYSINIT:49A3                 </span><span style="color:navy">jb      short </span><span style="color:gray">copy_done
</span><span style="color:black">SYSINIT:49A5                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; ~CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:49A7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Bh </span><span style="color:gray">; &#039;[&#039;   </span>; CONFIG_BEGIN
<span style="color:black">SYSINIT:49A7                                         </span>; another BEGIN implies END as well
<span style="color:black">SYSINIT:49A9                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_done
</span><span style="color:black">SYSINIT:49AB                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Ah </span><span style="color:gray">; &#039;J&#039;   </span>; CONFIG_INCLUDE ; &#039;J&#039;
<span style="color:black">SYSINIT:49AD                 </span><span style="color:navy">mov     al, ah          </span>; AL == the original line code
<span style="color:black">SYSINIT:49AF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copy_line </span>; not an &quot;include&quot; line
<span style="color:black">SYSINIT:49AF                                         </span>;
<span style="color:black">SYSINIT:49AF                                         </span>; We have hit an &quot;INCLUDE&quot; line; first, REM out the line
<span style="color:black">SYSINIT:49AF                                         </span>; so that we never try to include the block again
<span style="color:black">SYSINIT:49AF                                         </span>; (no infinite include loops please), then search for
<span style="color:black">SYSINIT:49AF                                         </span>; the named block and call copy_block again.
<span style="color:black">SYSINIT:49B1                 </span><span style="color:navy">mov     byte ptr es:[si-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039; </span>; CONFIG_REM
<span style="color:black">SYSINIT:49B6                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:49B7                 </span><span style="color:navy">mov     di, offset </span>szMenu <span style="color:gray">; &quot;MENU&quot;
</span><span style="color:black">SYSINIT:49BA                 </span><span style="color:navy">call    </span>comp_names_safe ; don&#039;t allow INCLUDE MENU
<span style="color:black">SYSINIT:49BD                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_skip
</span><span style="color:black">SYSINIT:49BF                 </span><span style="color:navy">mov     di, offset </span>szCommon <span style="color:gray">; &quot;COMMON&quot;
</span><span style="color:black">SYSINIT:49C2                 </span><span style="color:navy">call    </span>comp_names_safe ; don&#039;t allow INCLUDE COMMON
<span style="color:black">SYSINIT:49C5                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_skip
</span><span style="color:black">SYSINIT:49C7                 </span><span style="color:navy">mov     di, si          </span>; try to find the block
<span style="color:black">SYSINIT:49C9                 </span><span style="color:navy">call    </span>srch_block
<span style="color:black">SYSINIT:49CC                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">SYSINIT:49CE                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:49CF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copy_error </span>; no such block
<span style="color:black">SYSINIT:49D1                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:49D2                 </span><span style="color:navy">mov     cx, bx
</span><span style="color:black">SYSINIT:49D4                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:49D5                 </span><span style="color:navy">dec     dx
</span><span style="color:black">SYSINIT:49D6                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">SYSINIT:49D8                 </span><span style="color:navy">call    </span>skip_line       ; skip the rest of the &quot;block name&quot; line
<span style="color:black">SYSINIT:49DB                 </span><span style="color:navy">call    </span>copy_block      ; and copy in the rest of that block
<span style="color:black">SYSINIT:49DE                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:49DF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:49E0                 </span><span style="color:navy">sub     al, al          </span>; force skip_opt_line to skip...
<span style="color:black">SYSINIT:49E2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copy_nextline
</span><span style="color:black">SYSINIT:49E4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:49E4
SYSINIT:49E4 </span><span style="color:gray">copy_skip</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:49E4                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:49E5
SYSINIT:49E5 </span><span style="color:gray">copy_error</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:49E5                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:49E6                 </span><span style="color:navy">call    </span>print_error     ; note that carry is clear, no pause
<span style="color:black">SYSINIT:49E9                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copy_nextline
</span><span style="color:black">SYSINIT:49EB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:49EB
SYSINIT:49EB </span><span style="color:gray">copy_line</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:49EB                 </span><span style="color:navy">mov     [di], al        </span>; Copy the line at ES:SI
<span style="color:black">SYSINIT:49EB                                         </span>;  to the current location at DS:DI
<span style="color:black">SYSINIT:49ED                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:49EE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; is this is a &quot;real&quot; line with a &quot;real&quot; code?
<span style="color:black">SYSINIT:49F0                 </span><span style="color:navy">jb      short </span><span style="color:gray">copy_nextline </span>; no
<span style="color:black">SYSINIT:49F2                 </span><span style="color:navy">cmp     cs:</span>config_multi<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:49F8                 </span><span style="color:navy">jz      short </span><span style="color:gray">copy_loop </span>; not a multi-config config.sys, don&#039;t embed #s
<span style="color:black">SYSINIT:49FA                 </span><span style="color:navy">call    </span>get_linenum     ; BX == line # of line @ES:SI
<span style="color:black">SYSINIT:49FD                 </span><span style="color:navy">mov     [di], bx        </span>; stash it immediately following the line code
<span style="color:black">SYSINIT:49FF                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4A00                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4A01                 </span><span style="color:navy">jmp     short </span><span style="color:gray">copy_next
</span><span style="color:black">SYSINIT:4A03 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4A03
SYSINIT:4A03 </span><span style="color:gray">copy_loop</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A03                 </span><span style="color:navy">call    </span>get_char
<span style="color:black">SYSINIT:4A06                 </span><span style="color:navy">jb      short </span><span style="color:gray">copy_done </span>; end of file
<span style="color:black">SYSINIT:4A08                 </span><span style="color:navy">mov     [di], al
</span><span style="color:black">SYSINIT:4A0A                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4A0B
SYSINIT:4A0B </span><span style="color:gray">copy_next</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A0B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf ; done with line?
<span style="color:black">SYSINIT:4A0D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">copy_loop </span>; nope
<span style="color:black">SYSINIT:4A0F
SYSINIT:4A0F </span><span style="color:gray">copy_nextline</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A0F                 </span><span style="color:navy">call    </span>skip_opt_line
<span style="color:black">SYSINIT:4A12                 </span><span style="color:navy">jmp     short </span>copy_block
<span style="color:black">SYSINIT:4A14 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4A14
SYSINIT:4A14 </span><span style="color:gray">copy_done</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A14                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4A14 </span>copy_block      <span style="color:black">endp
SYSINIT:4A14
SYSINIT:4A15
SYSINIT:4A15 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4A15
SYSINIT:4A15
SYSINIT:4A15 </span>get_linenum     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A15                 </span><span style="color:navy">push    ax              </span>; return line # (in BX) of current line (@ES:SI)
<span style="color:black">SYSINIT:4A16                 </span><span style="color:navy">sub     bx, bx          </span>; BX == line # (to be returned)
<span style="color:black">SYSINIT:4A18                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:4A19                 </span><span style="color:navy">mov     dx, si          </span>; DX == the offset we&#039;re looking for
<span style="color:black">SYSINIT:4A1B                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4A1C                 </span><span style="color:navy">mov     cx, cs:</span>count
<span style="color:black">SYSINIT:4A21                 </span><span style="color:navy">sub     si, si          </span>; prepare to scan entire file
<span style="color:black">SYSINIT:4A23
SYSINIT:4A23 </span><span style="color:gray">get_linenum_loop</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A23                 </span><span style="color:navy">call    </span>skip_line
<span style="color:black">SYSINIT:4A26                 </span><span style="color:navy">jb      short </span><span style="color:gray">get_linenum_done
</span><span style="color:black">SYSINIT:4A28                 </span><span style="color:navy">inc     bx
</span><span style="color:black">SYSINIT:4A29                 </span><span style="color:navy">cmp     si, dx          </span>; have we exceeded the desired offset yet?
<span style="color:black">SYSINIT:4A2B                 </span><span style="color:navy">jb      short </span><span style="color:gray">get_linenum_loop </span>; no
<span style="color:black">SYSINIT:4A2D
SYSINIT:4A2D </span><span style="color:gray">get_linenum_done</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A2D                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4A2E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4A2F                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4A30                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4A30 </span>get_linenum     <span style="color:black">endp
SYSINIT:4A30
SYSINIT:4A31
SYSINIT:4A31 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4A31
SYSINIT:4A31
SYSINIT:4A31 </span>srch_block      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A31                 </span><span style="color:navy">push    ax              </span>; searches entire config.sys
<span style="color:black">SYSINIT:4A31                                         </span>; for block name @ES:DI
<span style="color:black">SYSINIT:4A32                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:4A33                 </span><span style="color:navy">mov     cx, cs:</span>count
<span style="color:black">SYSINIT:4A38                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4A39                 </span><span style="color:navy">sub     si, si
</span><span style="color:black">SYSINIT:4A3B                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4A3C                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4A3D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4A3E                 </span><span style="color:navy">call    </span>find_block
<span style="color:black">SYSINIT:4A41                 </span><span style="color:navy">mov     di, si          </span>; ES:DI -&gt; just past the name in the block heading, if found
<span style="color:black">SYSINIT:4A43                 </span><span style="color:navy">mov     bx, cx          </span>; BX == # bytes remaining from that point, if found
<span style="color:black">SYSINIT:4A45                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4A46                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4A47                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4A48                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4A49                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4A49 </span>srch_block      <span style="color:black">endp
SYSINIT:4A49
SYSINIT:4A4A
SYSINIT:4A4A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4A4A
SYSINIT:4A4A
SYSINIT:4A4A </span>find_block      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A4A                 </span><span style="color:navy">call    </span>get_char        ; searches rest of config.sys for block name @DS:DI
<span style="color:black">SYSINIT:4A4A                                         </span>; get line code
<span style="color:black">SYSINIT:4A4D                 </span><span style="color:navy">jb      short </span><span style="color:gray">find_exit </span>; end of file
<span style="color:black">SYSINIT:4A4F                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; ~CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:4A51                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Bh </span><span style="color:gray">; &#039;[&#039;   </span>; CONFIG_BEGIN ; beginning of a block?
<span style="color:black">SYSINIT:4A53                 </span><span style="color:navy">jz      short </span><span style="color:gray">check_line </span>; no
<span style="color:black">SYSINIT:4A55                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4Ah </span><span style="color:gray">; &#039;J&#039;   </span>; CONFIG_INCLUDE
<span style="color:black">SYSINIT:4A57                 </span><span style="color:navy">jnz     short </span><span style="color:gray">next_line
</span><span style="color:black">SYSINIT:4A59                 </span><span style="color:navy">or      cs:</span>config_multi<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4A5F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">next_line
</span><span style="color:black">SYSINIT:4A61 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4A61
SYSINIT:4A61 </span><span style="color:gray">check_line</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A61                 </span><span style="color:navy">or      cs:</span>config_multi<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4A67                 </span><span style="color:navy">call    </span>comp_names      ; compare block names
<span style="color:black">SYSINIT:4A6A                 </span><span style="color:navy">jbe     short </span><span style="color:gray">find_exit </span>; end of file, or names matched
<span style="color:black">SYSINIT:4A6C
SYSINIT:4A6C </span><span style="color:gray">next_line</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A6C                 </span><span style="color:navy">call    </span>skip_opt_line   ; no, so skip to next line
<span style="color:black">SYSINIT:4A6F                 </span><span style="color:navy">jmp     short </span>find_block
<span style="color:black">SYSINIT:4A71 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4A71
SYSINIT:4A71 </span><span style="color:gray">find_exit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A71                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4A71 </span>find_block      <span style="color:black">endp
SYSINIT:4A71
SYSINIT:4A72
SYSINIT:4A72 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4A72
SYSINIT:4A72
SYSINIT:4A72 </span>comp_names      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A72                 </span><span style="color:navy">push    di              </span>; compares keyword @DS:DI
<span style="color:black">SYSINIT:4A72                                         </span>;  to position in config.sys @ES:SI
<span style="color:black">SYSINIT:4A73
SYSINIT:4A73 </span><span style="color:gray">comp_loop</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A73                 </span><span style="color:navy">call    </span>get_char
<span style="color:black">SYSINIT:4A76                 </span><span style="color:navy">jb      short </span><span style="color:gray">comp_exit
</span><span style="color:black">SYSINIT:4A78                 </span><span style="color:navy">call    </span>any_delim       ; is next character a delimiter?
<span style="color:black">SYSINIT:4A7B                 </span><span style="color:navy">mov     ah, [di]        </span>; (get next character we&#039;re supposed to match)
<span style="color:black">SYSINIT:4A7D                 </span><span style="color:navy">jz      short </span><span style="color:gray">comp_almost </span>; yes, it *could* be a match
<span style="color:black">SYSINIT:4A7F                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4A80                 </span><span style="color:navy">and     ax, </span><span style="color:green">0DFDFh      </span>; ~2020h
<span style="color:black">SYSINIT:4A83                 </span><span style="color:navy">cmp     al, ah          </span>; match?
<span style="color:black">SYSINIT:4A85                 </span><span style="color:navy">jz      short </span><span style="color:gray">comp_loop </span>; yes, keep looking at the characters
<span style="color:black">SYSINIT:4A87                 </span><span style="color:navy">clc                     </span>; prevent erroneous eof indication: clear carry
<span style="color:black">SYSINIT:4A88
SYSINIT:4A88 </span><span style="color:gray">comp_exit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A88                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:4A89                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4A8A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4A8A
SYSINIT:4A8A </span><span style="color:gray">comp_almost</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A8A                 </span><span style="color:navy">xchg    al, ah          </span>; we don&#039;t know for sure if it&#039;s a match
<span style="color:black">SYSINIT:4A8C                 </span><span style="color:navy">call    </span>any_delim       ; until we verify that the second string
<span style="color:black">SYSINIT:4A8F                 </span><span style="color:navy">xchg    al, ah          </span>; has been exhausted also...
<span style="color:black">SYSINIT:4A91                 </span><span style="color:navy">jmp     short </span><span style="color:gray">comp_exit </span>; if we are, this call to any_delim will tell...
<span style="color:black">SYSINIT:4A91 </span>comp_names      <span style="color:black">endp
SYSINIT:4A91
SYSINIT:4A93
SYSINIT:4A93 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4A93
SYSINIT:4A93
SYSINIT:4A93 </span>comp_names_safe <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4A93                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:4A94                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:4A95                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4A96                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4A97                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:4A98                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4A99                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:4A99                 </span><span style="color:navy">call    </span>comp_names
<span style="color:black">SYSINIT:4A9C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4A9D                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4A9D                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4A9E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4A9F                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4AA0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4AA0 </span>comp_names_safe <span style="color:black">endp
SYSINIT:4AA0
SYSINIT:4AA1
SYSINIT:4AA1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4AA1
SYSINIT:4AA1
SYSINIT:4AA1 </span>print_item      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4AA1                 </span><span style="color:navy">push    ax              </span>; display menu item #BL
<span style="color:black">SYSINIT:4AA2                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:4AA3                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:4AA4                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4AA5                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4AA6                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3           </span>; get cursor position
<span style="color:black">SYSINIT:4AA8                 </span><span style="color:navy">mov     bh, ds:</span>bMenuPage ; always page zero
<span style="color:black">SYSINIT:4AAC                 </span><span style="color:navy">int     </span><span style="color:#ff8000">10h             </span>; - VIDEO - READ CURSOR POSITION
<span style="color:black">SYSINIT:4AAC                                         </span>; BH = page number
<span style="color:black">SYSINIT:4AAC                                         </span>; Return: DH,DL = row,column, CH = cursor start line, CL = cursor end line
<span style="color:black">SYSINIT:4AAE                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4AAF                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; set cursor position for correct row/col
<span style="color:black">SYSINIT:4AB1                 </span><span style="color:navy">mov     dh, bl
</span><span style="color:black">SYSINIT:4AB3                 </span><span style="color:navy">add     dh, </span><span style="color:#ff8000">3
</span><span style="color:black">SYSINIT:4AB6                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">5
</span><span style="color:black">SYSINIT:4AB8                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4AB8                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4AB8                                         </span>; BH = page number
<span style="color:black">SYSINIT:4ABA                 </span><span style="color:navy">mov     al, bl
</span><span style="color:black">SYSINIT:4ABC                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; convert menu item # to ASCII digit
<span style="color:black">SYSINIT:4ABE                 </span><span style="color:navy">mov     ah, ds:</span>bMenuColor ; normal attribute
<span style="color:black">SYSINIT:4AC2                 </span><span style="color:navy">cmp     bl, ds:</span>bDefBlock ; are we printing the current block?
<span style="color:black">SYSINIT:4AC6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">print_other </span>; no
<span style="color:black">SYSINIT:4AC8                 </span><span style="color:navy">or      ah, </span><span style="color:green">70h         </span>; yes, set bgnd color to white
<span style="color:black">SYSINIT:4ACB                 </span><span style="color:navy">mov     ch, ah
</span><span style="color:black">SYSINIT:4ACD                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">SYSINIT:4ACF                 </span><span style="color:navy">rol     ch, cl
</span><span style="color:black">SYSINIT:4AD1                 </span><span style="color:navy">cmp     ch, ah          </span>; are fgnd/bgnd the same?
<span style="color:black">SYSINIT:4AD3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">print_other </span>; no
<span style="color:black">SYSINIT:4AD5                 </span><span style="color:navy">xor     ah, </span><span style="color:green">8           </span>; yes, so modify the fgnd intensity
<span style="color:black">SYSINIT:4AD8
SYSINIT:4AD8 </span><span style="color:gray">print_other</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4AD8                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4ADA                 </span><span style="color:navy">add     bx, bx
</span><span style="color:black">SYSINIT:4ADC                 </span><span style="color:navy">mov     di, ds:</span>aoffBlockDesc<span style="color:navy">[bx]
</span><span style="color:black">SYSINIT:4AE0                 </span><span style="color:navy">mov     bl, ah          </span>; put the attribute in the correct register now
<span style="color:black">SYSINIT:4AE2                 </span><span style="color:navy">mov     bh, ds:</span>bMenuPage ; get correct video page #
<span style="color:black">SYSINIT:4AE6                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">9           </span>; write char/attr
<span style="color:black">SYSINIT:4AE8                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:4AEB                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE ATTRIBUTES/CHARACTERS AT CURSOR POSITION
<span style="color:black">SYSINIT:4AEB                                         </span>; AL = character, BH = display page
<span style="color:black">SYSINIT:4AEB                                         </span>; BL = attributes of character (alpha modes) or color (graphics modes)
<span style="color:black">SYSINIT:4AEB                                         </span>; CX = number of times to write character
<span style="color:black">SYSINIT:4AED                 </span><span style="color:navy">inc     dl              </span>; increment column
<span style="color:black">SYSINIT:4AEF                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4AF1                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4AF1                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4AF1                                         </span>; BH = page number
<span style="color:black">SYSINIT:4AF3                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">92Eh        </span>; display &#039;.&#039;
<span style="color:black">SYSINIT:4AF6                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE ATTRIBUTES/CHARACTERS AT CURSOR POSITION
<span style="color:black">SYSINIT:4AF6                                         </span>; AL = character, BH = display page
<span style="color:black">SYSINIT:4AF6                                         </span>; BL = attributes of character (alpha modes) or color (graphics modes)
<span style="color:black">SYSINIT:4AF6                                         </span>; CX = number of times to write character
<span style="color:black">SYSINIT:4AF8                 </span><span style="color:navy">inc     dl              </span>; increment column
<span style="color:black">SYSINIT:4AFA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4AFC                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4AFC                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4AFC                                         </span>; BH = page number
<span style="color:black">SYSINIT:4AFE                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">920h        </span>; display &#039; &#039;
<span style="color:black">SYSINIT:4B01                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE ATTRIBUTES/CHARACTERS AT CURSOR POSITION
<span style="color:black">SYSINIT:4B01                                         </span>; AL = character, BH = display page
<span style="color:black">SYSINIT:4B01                                         </span>; BL = attributes of character (alpha modes) or color (graphics modes)
<span style="color:black">SYSINIT:4B01                                         </span>; CX = number of times to write character
<span style="color:black">SYSINIT:4B03                 </span><span style="color:navy">inc     dl              </span>; increment column
<span style="color:black">SYSINIT:4B05                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4B07                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4B07                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4B07                                         </span>; BH = page number
<span style="color:black">SYSINIT:4B09                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4B0A
SYSINIT:4B0A </span><span style="color:gray">print_loop</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4B0A                 </span><span style="color:navy">mov     al, es:[di]     </span>; get a character of the description
<span style="color:black">SYSINIT:4B0D                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4B0E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; TAB ; substitute spaces for tabs
<span style="color:black">SYSINIT:4B10                 </span><span style="color:navy">jnz     short </span><span style="color:gray">print_nontab
</span><span style="color:black">SYSINIT:4B12                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:4B14
SYSINIT:4B14 </span><span style="color:gray">print_nontab</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4B14                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:4B16                 </span><span style="color:navy">jb      short </span><span style="color:gray">print_done </span>; stop at the 1st character &lt; space
<span style="color:black">SYSINIT:4B18                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">24h </span><span style="color:gray">; &#039;$&#039;
</span><span style="color:black">SYSINIT:4B1A                 </span><span style="color:navy">jz      short </span><span style="color:gray">print_done </span>; also stop on $
<span style="color:black">SYSINIT:4B1C                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">9
</span><span style="color:black">SYSINIT:4B1E                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE ATTRIBUTES/CHARACTERS AT CURSOR POSITION
<span style="color:black">SYSINIT:4B1E                                         </span>; AL = character, BH = display page
<span style="color:black">SYSINIT:4B1E                                         </span>; BL = attributes of character (alpha modes) or color (graphics modes)
<span style="color:black">SYSINIT:4B1E                                         </span>; CX = number of times to write character
<span style="color:black">SYSINIT:4B20                 </span><span style="color:navy">inc     dl              </span>; increment column
<span style="color:black">SYSINIT:4B22                 </span><span style="color:navy">cmp     dl, </span><span style="color:green">78          </span>; far enough?
<span style="color:black">SYSINIT:4B25                 </span><span style="color:navy">jnb     short </span><span style="color:gray">print_done </span>; yes
<span style="color:black">SYSINIT:4B27                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4B29                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4B29                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4B29                                         </span>; BH = page number
<span style="color:black">SYSINIT:4B2B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">print_loop
</span><span style="color:black">SYSINIT:4B2D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4B2D
SYSINIT:4B2D </span><span style="color:gray">print_done</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4B2D                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:4B2E                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:4B2F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; restore previous row/col
<span style="color:black">SYSINIT:4B31                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4B31                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4B31                                         </span>; BH = page number
<span style="color:black">SYSINIT:4B33                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4B34                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:4B35                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4B36                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4B37                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4B38                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4B38 </span>print_item      <span style="color:black">endp
SYSINIT:4B38
SYSINIT:4B39
SYSINIT:4B39 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4B39
SYSINIT:4B39
SYSINIT:4B39 </span>select_item     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4B39                 </span><span style="color:navy">mov     bl, ds:</span>bDefBlock ; wait for user to select menu item, with time-out
<span style="color:black">SYSINIT:4B39                                         </span>;
<span style="color:black">SYSINIT:4B39                                         </span>; returns digit value in BX (trashes AX/CX/DX)
<span style="color:black">SYSINIT:4B3D                 </span><span style="color:navy">mov     al, bl          </span>; BL will be the default block #
<span style="color:black">SYSINIT:4B3F                 </span><span style="color:navy">call    </span>disp_num
<span style="color:black">SYSINIT:4B42                 </span><span style="color:navy">call    </span>show_status     ; display current interactive status
<span style="color:black">SYSINIT:4B45                 </span><span style="color:navy">cmp     ds:</span>secTimeOut<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:black">SYSINIT:4B4A                 </span><span style="color:navy">jz      short </span><span style="color:gray">input_key </span>; no time-out, just go to input
<span style="color:black">SYSINIT:4B4C                 </span><span style="color:navy">mov     ah, </span><span style="color:green">2Ch         </span>; GET_TIME
<span style="color:black">SYSINIT:4B4E                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - GET CURRENT TIME
<span style="color:black">SYSINIT:4B4E                                         </span>; Return: CH = hours, CL = minutes, DH = seconds
<span style="color:black">SYSINIT:4B4E                                         </span>; DL = hundredths of seconds
<span style="color:black">SYSINIT:4B4E                                         </span>; ;
<span style="color:black">SYSINIT:4B50                 </span><span style="color:navy">mov     bh, dh          </span>; BH = initial # of seconds
<span style="color:black">SYSINIT:4B52
SYSINIT:4B52 </span><span style="color:gray">check_time</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4B52                 </span><span style="color:navy">mov     al, ds:</span>secTimeOut
<span style="color:black">SYSINIT:4B55                 </span><span style="color:navy">sub     al, ds:</span>secElapsed
<span style="color:black">SYSINIT:4B59                 </span><span style="color:navy">jnb     short </span><span style="color:gray">show_time
</span><span style="color:black">SYSINIT:4B5B                 </span><span style="color:navy">or      ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">2 </span>; disable all further prompting
<span style="color:black">SYSINIT:4B60                 </span><span style="color:navy">mov     ds:</span>secElapsed<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4B65                 </span><span style="color:navy">jmp     </span><span style="color:gray">select_done     </span>; time&#039;s up!
<span style="color:black">SYSINIT:4B68 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4B68
SYSINIT:4B68 </span><span style="color:gray">show_time</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4B68                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:4B69                 </span><span style="color:navy">mov     bl, al          </span>; save # in BL
<span style="color:black">SYSINIT:4B6B                 </span><span style="color:navy">mov     bh, ds:</span>bMenuPage
<span style="color:black">SYSINIT:4B6F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3
</span><span style="color:black">SYSINIT:4B71                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - READ CURSOR POSITION
<span style="color:black">SYSINIT:4B71                                         </span>; BH = page number
<span style="color:black">SYSINIT:4B71                                         </span>; Return: DH,DL = row,column, CH = cursor start line, CL = cursor end line
<span style="color:black">SYSINIT:4B73                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4B74                 </span><span style="color:navy">add     dl, </span><span style="color:#ff8000">8           </span>; move cursor to the right
<span style="color:black">SYSINIT:4B77                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4B79                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4B79                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4B79                                         </span>; BH = page number
<span style="color:black">SYSINIT:4B7B                 </span><span style="color:navy">mov     dx, offset </span>_$TimeOut <span style="color:gray">; &quot;Time remaining: $&quot;
</span><span style="color:black">SYSINIT:4B7E                 </span><span style="color:navy">call    </span>print           ; print the &quot;Time remaining: &quot; prompt
<span style="color:black">SYSINIT:4B81                 </span><span style="color:navy">mov     al, bl          </span>; recover # from BL
<span style="color:black">SYSINIT:4B83                 </span><span style="color:navy">cbw                     </span>; this works because AL is always &lt;= 90
<span style="color:black">SYSINIT:4B84                 </span><span style="color:navy">mov     cl, </span><span style="color:green">10
</span><span style="color:black">SYSINIT:4B86                 </span><span style="color:navy">div     cl              </span>; AL = tens digit, AH = ones digit
<span style="color:black">SYSINIT:4B88                 </span><span style="color:navy">mov     cl, ah
</span><span style="color:black">SYSINIT:4B8A                 </span><span style="color:navy">add     al, &#039;</span><span style="color:green">0&#039;         </span>; write TTY tens digit
<span style="color:black">SYSINIT:4B8C                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:black">SYSINIT:4B8E                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:black">SYSINIT:4B8E                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:black">SYSINIT:4B8E                                         </span>; BL = foreground color (graphics modes)
<span style="color:black">SYSINIT:4B90                 </span><span style="color:navy">mov     al, cl
</span><span style="color:black">SYSINIT:4B92                 </span><span style="color:navy">add     al, &#039;</span><span style="color:green">0&#039;         </span>; write TTY ones digit
<span style="color:black">SYSINIT:4B94                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:black">SYSINIT:4B96                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:black">SYSINIT:4B96                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:black">SYSINIT:4B96                                         </span>; BL = foreground color (graphics modes)
<span style="color:black">SYSINIT:4B98                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:4B99                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; set cursor position back to where it was
<span style="color:black">SYSINIT:4B9B                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4B9B                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4B9B                                         </span>; BH = page number
<span style="color:black">SYSINIT:4B9D                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4B9E
SYSINIT:4B9E </span><span style="color:gray">input_key</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4B9E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">6           </span>; RAW_CON_IO
<span style="color:black">SYSINIT:4BA0                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0FFh        </span>; input request
<span style="color:black">SYSINIT:4BA2                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DIRECT CONSOLE I/O CHARACTER OUTPUT
<span style="color:black">SYSINIT:4BA2                                         </span>; DL = character &lt;&gt; FFh
<span style="color:black">SYSINIT:4BA2                                         </span>;  Return: ZF set = no character
<span style="color:black">SYSINIT:4BA2                                         </span>;   ZF clear = character recieved, AL = character
<span style="color:black">SYSINIT:4BA4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_key
</span><span style="color:black">SYSINIT:4BA6                 </span><span style="color:navy">cmp     ds:</span>secTimeOut<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1 ; is there a time-out?
<span style="color:black">SYSINIT:4BAB                 </span><span style="color:navy">jz      short </span><span style="color:gray">input_key </span>; no, just go back to input
<span style="color:black">SYSINIT:4BAD                 </span><span style="color:navy">mov     ah, </span><span style="color:green">2Ch         </span>; GET_TIME
<span style="color:black">SYSINIT:4BAF                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - GET CURRENT TIME
<span style="color:black">SYSINIT:4BAF                                         </span>; Return: CH = hours, CL = minutes, DH = seconds
<span style="color:black">SYSINIT:4BAF                                         </span>; DL = hundredths of seconds
<span style="color:black">SYSINIT:4BB1                 </span><span style="color:navy">mov     ah, dh
</span><span style="color:black">SYSINIT:4BB3                 </span><span style="color:navy">sub     dh, bh          </span>; should generally be zero or one
<span style="color:black">SYSINIT:4BB5                 </span><span style="color:navy">mov     bh, ah
</span><span style="color:black">SYSINIT:4BB7                 </span><span style="color:navy">jnb     short </span><span style="color:gray">got_time
</span><span style="color:black">SYSINIT:4BB9                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">1           </span>; it wrapped back to zero, so assume one
<span style="color:black">SYSINIT:4BBB
SYSINIT:4BBB </span><span style="color:gray">got_time</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4BBB                 </span><span style="color:navy">or      dh, dh          </span>; any change?
<span style="color:black">SYSINIT:4BBD                 </span><span style="color:navy">jz      short </span><span style="color:gray">input_key </span>; no
<span style="color:black">SYSINIT:4BBF                 </span><span style="color:navy">add     ds:</span>secElapsed<span style="color:navy">, dh
</span><span style="color:black">SYSINIT:4BC3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">check_time
</span><span style="color:black">SYSINIT:4BC5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4BC5
SYSINIT:4BC5 </span><span style="color:gray">got_key</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4BC5                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:4BC6                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; -1 ; zap both secTimeOut and secElapsed
<span style="color:black">SYSINIT:4BC9                 </span><span style="color:navy">xchg    ax, word ptr ds:</span>secTimeOut
<span style="color:black">SYSINIT:4BCD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; -1 ; was time-out already disabled?
<span style="color:black">SYSINIT:4BCF                 </span><span style="color:navy">jz      short </span><span style="color:gray">timeout_disabled </span>; yes
<span style="color:black">SYSINIT:4BD1                 </span><span style="color:navy">push    bx              </span>; let&#039;s disable # seconds display
<span style="color:black">SYSINIT:4BD2                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0A20h       </span>; write multiple spaces
<span style="color:black">SYSINIT:4BD5                 </span><span style="color:navy">mov     bx, word ptr ds:</span>bMenuColor
<span style="color:black">SYSINIT:4BD9                 </span><span style="color:navy">mov     cx, </span><span style="color:green">80          </span>; 80 of them, to be safe
<span style="color:black">SYSINIT:4BD9                                         </span>; to completely obliterate # seconds display
<span style="color:black">SYSINIT:4BDC                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTERS ONLY AT CURSOR POSITION
<span style="color:black">SYSINIT:4BDC                                         </span>; AL = character, BH = display page - alpha mode
<span style="color:black">SYSINIT:4BDC                                         </span>; BL = color of character (graphics mode, PCjr only)
<span style="color:black">SYSINIT:4BDC                                         </span>; CX = number of times to write character
<span style="color:black">SYSINIT:4BDE                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4BDF
SYSINIT:4BDF </span><span style="color:gray">timeout_disabled</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4BDF                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4BE0                 </span><span style="color:navy">or      al, al          </span>; extended key pressed?
<span style="color:black">SYSINIT:4BE2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">normal_key </span>; no
<span style="color:black">SYSINIT:4BE4                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; get the next part of the key then
<span style="color:black">SYSINIT:4BE6                 </span><span style="color:navy">jz      short </span><span style="color:gray">input_key </span>; what happened to the second part!?
<span style="color:black">SYSINIT:4BE8                 </span><span style="color:navy">cmp     al, </span><span style="color:green">48h         </span>; up arrow?
<span style="color:black">SYSINIT:4BEA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_up    </span>; no
<span style="color:black">SYSINIT:4BEC                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">1           </span>; are we as up as up can get?
<span style="color:black">SYSINIT:4BEF                 </span><span style="color:navy">jbe     short </span><span style="color:gray">input_key </span>; yes, ignore it
<span style="color:black">SYSINIT:4BF1                 </span><span style="color:navy">dec     ds:</span>bDefBlock
<span style="color:black">SYSINIT:4BF5                 </span><span style="color:navy">call    </span>print_item      ; re-print the current item
<span style="color:black">SYSINIT:4BF8                 </span><span style="color:navy">dec     bl              </span>; and then print the new current item
<span style="color:black">SYSINIT:4BFA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">print1
</span><span style="color:black">SYSINIT:4BFC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4BFC
SYSINIT:4BFC </span><span style="color:gray">not_up</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4BFC                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">50h </span><span style="color:gray">; &#039;P&#039;   </span>; down arrow?
<span style="color:black">SYSINIT:4BFE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_down  </span>; no
<span style="color:black">SYSINIT:4C00                 </span><span style="color:navy">cmp     bl, ds:</span>bMaxBlock ; are we as down as down can get?
<span style="color:black">SYSINIT:4C04                 </span><span style="color:navy">jnb     short </span><span style="color:gray">to_input_key </span>; yes, ignore it
<span style="color:black">SYSINIT:4C06                 </span><span style="color:navy">inc     ds:</span>bDefBlock
<span style="color:black">SYSINIT:4C0A                 </span><span style="color:navy">call    </span>print_item      ; re-print the current item
<span style="color:black">SYSINIT:4C0D                 </span><span style="color:navy">inc     bx              </span>; and then print the new current item
<span style="color:black">SYSINIT:4C0E
SYSINIT:4C0E </span><span style="color:gray">print1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C0E                 </span><span style="color:navy">mov     al, bl
</span><span style="color:black">SYSINIT:4C10
SYSINIT:4C10 </span><span style="color:gray">print2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C10                 </span><span style="color:navy">call    </span>print_item
<span style="color:black">SYSINIT:4C13                 </span><span style="color:navy">call    </span>disp_num
<span style="color:black">SYSINIT:4C16
SYSINIT:4C16 </span><span style="color:gray">to_input_key</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C16                 </span><span style="color:navy">jmp     short </span><span style="color:gray">input_key
</span><span style="color:black">SYSINIT:4C18 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4C18
SYSINIT:4C18 </span><span style="color:gray">not_down</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C18                 </span><span style="color:navy">test    ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4C1D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">to_input_key </span>; don&#039;t allow F8 or F5
<span style="color:black">SYSINIT:4C1F                 </span><span style="color:navy">cmp     al, </span><span style="color:green">42h         </span>; F8 function key?
<span style="color:black">SYSINIT:4C21                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_f8    </span>; no
<span style="color:black">SYSINIT:4C23                 </span><span style="color:navy">xor     ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4C28                 </span><span style="color:navy">call    </span>show_status
<span style="color:black">SYSINIT:4C2B                 </span><span style="color:navy">jmp     </span><span style="color:gray">input_key
</span><span style="color:black">SYSINIT:4C2E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4C2E
SYSINIT:4C2E </span><span style="color:gray">not_f8</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C2E                 </span><span style="color:navy">cmp     al, </span><span style="color:green">3Fh         </span>; F5 function key?
<span style="color:black">SYSINIT:4C30                 </span><span style="color:navy">jnz     short </span><span style="color:gray">to_input_key </span>; no
<span style="color:black">SYSINIT:4C32                 </span><span style="color:navy">or      ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">4 </span>; no more queries
<span style="color:black">SYSINIT:4C37                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh      </span>; special return code (-1) indicating clean boot
<span style="color:black">SYSINIT:4C3A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; don&#039;t want to display anything really;
<span style="color:black">SYSINIT:4C3C                 </span><span style="color:navy">jmp     short </span>disp_input
<span style="color:black">SYSINIT:4C3E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4C3E
SYSINIT:4C3E </span><span style="color:gray">normal_key</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C3E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; Enter?
<span style="color:black">SYSINIT:4C40                 </span><span style="color:navy">jz      short </span><span style="color:gray">select_done </span>; yes
<span style="color:black">SYSINIT:4C42                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8           </span>; backspace?
<span style="color:black">SYSINIT:4C44                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_backspace </span>; no
<span style="color:black">SYSINIT:4C46                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFEh      </span>; -2 ; yes, special return code
<span style="color:black">SYSINIT:4C49                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4C4A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4C4A
SYSINIT:4C4A </span><span style="color:gray">not_backspace</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C4A                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; is greater than &#039;0&#039;?
<span style="color:black">SYSINIT:4C4C                 </span><span style="color:navy">jbe     short </span><span style="color:gray">to_input_key </span>; no
<span style="color:black">SYSINIT:4C4E                 </span><span style="color:navy">cmp     al, ds:</span>bMaxBlock ; is less than or equal to the maximum digit?
<span style="color:black">SYSINIT:4C52                 </span><span style="color:navy">ja      short </span><span style="color:gray">to_input_key </span>; no
<span style="color:black">SYSINIT:4C54                 </span><span style="color:navy">mov     ds:</span>bDefBlock<span style="color:navy">, al
</span><span style="color:black">SYSINIT:4C57                 </span><span style="color:navy">call    </span>print_item      ; redisplay the current selection
<span style="color:black">SYSINIT:4C5A                 </span><span style="color:navy">mov     bl, al          </span>; set new selection
<span style="color:black">SYSINIT:4C5C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">print2
</span><span style="color:black">SYSINIT:4C5E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4C5E
SYSINIT:4C5E </span><span style="color:gray">select_done</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C5E                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">0           </span>; return a full 16-bit value (for indexing)
<span style="color:black">SYSINIT:4C60                 </span><span style="color:navy">mov     al, bl
</span><span style="color:black">SYSINIT:4C62                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; convert it into a digit, then display it
<span style="color:black">SYSINIT:4C62 </span>select_item     <span style="color:black">endp
SYSINIT:4C62
SYSINIT:4C64
SYSINIT:4C64 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4C64
SYSINIT:4C64
SYSINIT:4C64 </span>disp_input      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C64                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:4C65                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:4C67                 </span><span style="color:navy">jnb     short </span><span style="color:gray">disp_ok
</span><span style="color:black">SYSINIT:4C69                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:4C6B
SYSINIT:4C6B </span><span style="color:gray">disp_ok</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C6B                 </span><span style="color:navy">mov     dl, al
</span><span style="color:black">SYSINIT:4C6D                 </span><span style="color:navy">mov     ah, </span><span style="color:green">2           </span>; STD_CON_OUTPUT
<span style="color:black">SYSINIT:4C6F                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:black">SYSINIT:4C6F                                         </span>; DL = character to send to standard output
<span style="color:black">SYSINIT:4C71                 </span><span style="color:navy">mov     dx, offset </span>crlfm <span style="color:gray">; &quot;\r\n$&quot;
</span><span style="color:black">SYSINIT:4C74                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:4C77                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4C78                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4C78 </span>disp_input      <span style="color:black">endp
SYSINIT:4C78
SYSINIT:4C79
SYSINIT:4C79 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4C79
SYSINIT:4C79
SYSINIT:4C79 </span>disp_num        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C79                 </span><span style="color:navy">push    bx              </span>; display a single character + cr/lf
<span style="color:black">SYSINIT:4C7A                 </span><span style="color:navy">add     al, &#039;</span><span style="color:green">0&#039;
</span><span style="color:black">SYSINIT:4C7C                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">SYSINIT:4C7E                 </span><span style="color:navy">mov     bx, word ptr ds:</span>bMenuColor
<span style="color:black">SYSINIT:4C82                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:4C85                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTERS ONLY AT CURSOR POSITION
<span style="color:black">SYSINIT:4C85                                         </span>; AL = character, BH = display page - alpha mode
<span style="color:black">SYSINIT:4C85                                         </span>; BL = color of character (graphics mode, PCjr only)
<span style="color:black">SYSINIT:4C85                                         </span>; CX = number of times to write character
<span style="color:black">SYSINIT:4C87                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4C88                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4C88 </span>disp_num        <span style="color:black">endp
SYSINIT:4C88
SYSINIT:4C89
SYSINIT:4C89 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4C89
SYSINIT:4C89
SYSINIT:4C89 </span>show_status     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4C89                 </span><span style="color:navy">push    bx              </span>; display current interactive mode setting (on/off/none)
<span style="color:black">SYSINIT:4C8A                 </span><span style="color:navy">mov     bx, word ptr ds:</span>bMenuColor
<span style="color:black">SYSINIT:4C8E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3
</span><span style="color:black">SYSINIT:4C90                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - READ CURSOR POSITION
<span style="color:black">SYSINIT:4C90                                         </span>; BH = page number
<span style="color:black">SYSINIT:4C90                                         </span>; Return: DH,DL = row,column, CH = cursor start line, CL = cursor end line
<span style="color:black">SYSINIT:4C92                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4C93                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4C95                 </span><span style="color:navy">mov     dx, word ptr ds:</span>bLastCol ; set correct row/col
<span style="color:black">SYSINIT:4C99                 </span><span style="color:navy">test    ds:</span>bDisableUI<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4C9E                 </span><span style="color:navy">jz      short </span><span style="color:gray">show_onoff </span>; just show on/off
<span style="color:black">SYSINIT:4CA0                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4CA2                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4CA2                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4CA2                                         </span>; BH = page number
<span style="color:black">SYSINIT:4CA4                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0A20h       </span>; write multiple spaces
<span style="color:black">SYSINIT:4CA7                 </span><span style="color:navy">mov     cx, </span><span style="color:green">80          </span>; 80 of them, to be exact to obliterate the status line
<span style="color:black">SYSINIT:4CAA                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTERS ONLY AT CURSOR POSITION
<span style="color:black">SYSINIT:4CAA                                         </span>; AL = character, BH = display page - alpha mode
<span style="color:black">SYSINIT:4CAA                                         </span>; BL = color of character (graphics mode, PCjr only)
<span style="color:black">SYSINIT:4CAA                                         </span>; CX = number of times to write character
<span style="color:black">SYSINIT:4CAC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">show_done
</span><span style="color:black">SYSINIT:4CAE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4CAE
SYSINIT:4CAE </span><span style="color:gray">show_onoff</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CAE                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO -
<span style="color:black">SYSINIT:4CB0                 </span><span style="color:navy">mov     al, byte ptr ds:</span>_$NO <span style="color:gray">; &quot;NO $&quot;
</span><span style="color:black">SYSINIT:4CB3                 </span><span style="color:navy">cmp     ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; is interactive mode on?
<span style="color:black">SYSINIT:4CB8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">show_noton </span>; no
<span style="color:black">SYSINIT:4CBA                 </span><span style="color:navy">mov     al, byte ptr ds:</span>_$YES <span style="color:gray">; &quot;YES$&quot;
</span><span style="color:black">SYSINIT:4CBD
SYSINIT:4CBD </span><span style="color:gray">show_noton</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CBD                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:black">SYSINIT:4CBF                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:black">SYSINIT:4CBF                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:black">SYSINIT:4CBF                                         </span>; BL = foreground color (graphics modes)
<span style="color:black">SYSINIT:4CC1
SYSINIT:4CC1 </span><span style="color:gray">show_done</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CC1                 </span><span style="color:navy">pop     dx              </span>; restore original cursor position
<span style="color:black">SYSINIT:4CC2                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">SYSINIT:4CC4                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET CURSOR POSITION
<span style="color:black">SYSINIT:4CC4                                         </span>; DH,DL = row, column (0,0 = upper left)
<span style="color:black">SYSINIT:4CC4                                         </span>; BH = page number
<span style="color:black">SYSINIT:4CC6                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4CC7                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4CC7 </span>show_status     <span style="color:black">endp
SYSINIT:4CC7
SYSINIT:4CC8
SYSINIT:4CC8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4CC8
SYSINIT:4CC8
SYSINIT:4CC8 </span>skip_token      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CC8                 </span><span style="color:navy">call    </span>get_char        ; advances ES:SI/CX past the current token
<span style="color:black">SYSINIT:4CCB                 </span><span style="color:navy">jb      short </span>skip_token_done
<span style="color:black">SYSINIT:4CCD                 </span><span style="color:navy">call    </span>any_delim
<span style="color:black">SYSINIT:4CD0                 </span><span style="color:navy">jnz     short </span>skip_token
<span style="color:black">SYSINIT:4CD2
SYSINIT:4CD2 </span>skip_check_eol<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CD2                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; CR
<span style="color:black">SYSINIT:4CD4                 </span><span style="color:navy">jz      short </span><span style="color:gray">skip_token_eol
</span><span style="color:black">SYSINIT:4CD6                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; LF
<span style="color:black">SYSINIT:4CD8                 </span><span style="color:navy">jz      short </span><span style="color:gray">skip_token_eol
</span><span style="color:black">SYSINIT:4CDA                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:4CDB                 </span><span style="color:navy">jmp     short </span>skip_token_done
<span style="color:black">SYSINIT:4CDD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4CDD
SYSINIT:4CDD </span><span style="color:gray">skip_token_eol</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CDD                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:4CDE
SYSINIT:4CDE </span>skip_token_done<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CDE                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4CDE </span>skip_token      <span style="color:black">endp
SYSINIT:4CDE
SYSINIT:4CDF
SYSINIT:4CDF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4CDF
SYSINIT:4CDF
SYSINIT:4CDF </span>skip_delim      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CDF                 </span><span style="color:navy">call    </span>get_char        ; advances ES:SI/CX past the current delimiter
<span style="color:black">SYSINIT:4CE2                 </span><span style="color:navy">lea     bx, [si-</span><span style="color:green">1</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:4CE5                 </span><span style="color:navy">jb      short </span>skip_token_done
<span style="color:black">SYSINIT:4CE7                 </span><span style="color:navy">call    </span>delim
<span style="color:black">SYSINIT:4CEA                 </span><span style="color:navy">jz      short </span>skip_delim
<span style="color:black">SYSINIT:4CEC                 </span><span style="color:navy">jmp     short </span>skip_check_eol
<span style="color:black">SYSINIT:4CEC </span>skip_delim      <span style="color:black">endp
SYSINIT:4CEC
SYSINIT:4CEE
SYSINIT:4CEE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4CEE
SYSINIT:4CEE
SYSINIT:4CEE </span>skip_opt_line   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CEE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; LF
<span style="color:black">SYSINIT:4CF0                 </span><span style="color:navy">jz      short </span>skip_line_done
<span style="color:black">SYSINIT:4CF0 </span>skip_opt_line   <span style="color:black">endp
SYSINIT:4CF0
SYSINIT:4CF2
SYSINIT:4CF2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4CF2
SYSINIT:4CF2
SYSINIT:4CF2 </span>skip_line       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CF2                 </span><span style="color:navy">call    </span>get_char
<span style="color:black">SYSINIT:4CF5                 </span><span style="color:navy">jb      short </span>skip_line_done
<span style="color:black">SYSINIT:4CF7
SYSINIT:4CF7 </span>_skip_opt_line_<span style="color:navy">:                        </span>; skip_opt_line: (Erdogan Tan - 03/08/2023)
<span style="color:black">SYSINIT:4CF7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; LF
<span style="color:black">SYSINIT:4CF9                 </span><span style="color:navy">jnz     short </span>skip_line
<span style="color:black">SYSINIT:4CFB
SYSINIT:4CFB </span>skip_line_done<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CFB                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4CFB </span>skip_line       <span style="color:black">endp
SYSINIT:4CFB
SYSINIT:4CFC
SYSINIT:4CFC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4CFC
SYSINIT:4CFC
SYSINIT:4CFC </span>get_number      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CFC                 </span><span style="color:navy">sub     bx, bx          </span>; return binary equivalent of numeric string
<span style="color:black">SYSINIT:4CFC                                         </span>; BX = result
<span style="color:black">SYSINIT:4CFE
SYSINIT:4CFE </span><span style="color:gray">num_loop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4CFE                 </span><span style="color:navy">call    </span>get_char
<span style="color:black">SYSINIT:4D01                 </span><span style="color:navy">jb      short </span><span style="color:gray">num_done
</span><span style="color:black">SYSINIT:4D03                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; convert to value
<span style="color:black">SYSINIT:4D05                 </span><span style="color:navy">jb      short </span><span style="color:gray">num_done  </span>; no more number
<span style="color:black">SYSINIT:4D07                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">39h </span><span style="color:gray">; &#039;9&#039;
</span><span style="color:black">SYSINIT:4D09                 </span><span style="color:navy">ja      short </span><span style="color:gray">num_done
</span><span style="color:black">SYSINIT:4D0B                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:4D0C                 </span><span style="color:navy">mov     ax, </span><span style="color:green">10
</span><span style="color:black">SYSINIT:4D0F                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4D10                 </span><span style="color:navy">mul     bx
</span><span style="color:black">SYSINIT:4D12                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:4D13                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">SYSINIT:4D15                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4D16                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;
</span><span style="color:black">SYSINIT:4D18                 </span><span style="color:navy">cbw
</span><span style="color:black">SYSINIT:4D19                 </span><span style="color:navy">add     bx, ax
</span><span style="color:black">SYSINIT:4D1B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">num_loop
</span><span style="color:black">SYSINIT:4D1D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4D1D
SYSINIT:4D1D </span><span style="color:gray">num_done</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D1D                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4D1D </span>get_number      <span style="color:black">endp
SYSINIT:4D1D
SYSINIT:4D1E
SYSINIT:4D1E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4D1E
SYSINIT:4D1E
SYSINIT:4D1E </span>get_char        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D1E                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">1           </span>; return next character,
<span style="color:black">SYSINIT:4D1E                                         </span>; advance ES:SI, and decrement CX
<span style="color:black">SYSINIT:4D1E                                         </span>; (use SUB to set carry,zero)
<span style="color:black">SYSINIT:4D21                 </span><span style="color:navy">jb      short </span><span style="color:gray">get_fail  </span>; out of data
<span style="color:black">SYSINIT:4D23                 </span><span style="color:navy">lods    byte ptr es:[si] </span>; es
<span style="color:black">SYSINIT:4D23                                         </span>; lodsb
<span style="color:black">SYSINIT:4D25                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">SYSINIT:4D27                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4D28 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4D28
SYSINIT:4D28 </span><span style="color:gray">get_fail</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D28                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">0           </span>; restore CX to zero
<span style="color:black">SYSINIT:4D28                                         </span>; leave carry set, zero not set
<span style="color:black">SYSINIT:4D2B
SYSINIT:4D2B </span>nearby_ret<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D2B                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4D2B </span>get_char        <span style="color:black">endp
SYSINIT:4D2B
SYSINIT:4D2C
SYSINIT:4D2C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4D2C
SYSINIT:4D2C
SYSINIT:4D2C </span>query_user      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D2C                 </span><span style="color:navy">test    ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">4 </span>; ask user whether to execute current config.sys command
<span style="color:black">SYSINIT:4D2C                                         </span>; answer no to everything?
<span style="color:black">SYSINIT:4D31                 </span><span style="color:navy">jz      short </span><span style="color:gray">qu_1      </span>; no
<span style="color:black">SYSINIT:4D33                 </span><span style="color:navy">jmp     </span><span style="color:gray">skip_all        </span>; yes
<span style="color:black">SYSINIT:4D36 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4D36
SYSINIT:4D36 </span><span style="color:gray">qu_1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D36                 </span><span style="color:navy">test    ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">2 </span>; answer yes to everything?
<span style="color:black">SYSINIT:4D3B                 </span><span style="color:navy">jnz     short </span>nearby_ret ; yes (and return carry clear!)
<span style="color:black">SYSINIT:4D3D                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:4D3E                 </span><span style="color:navy">mov     al, ds:</span>config_cmd
<span style="color:black">SYSINIT:4D41                 </span><span style="color:navy">test    ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">1 </span>; query every command?
<span style="color:black">SYSINIT:4D46                 </span><span style="color:navy">jnz     short </span><span style="color:gray">query_all </span>; yes
<span style="color:black">SYSINIT:4D48                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:4D4A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">query_all
</span><span style="color:black">SYSINIT:4D4C                 </span><span style="color:navy">jmp     </span><span style="color:gray">do_cmd
</span><span style="color:black">SYSINIT:4D4F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4D4F
SYSINIT:4D4F </span><span style="color:gray">query_all</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D4F                 </span><span style="color:navy">push    si              </span>; save pointer to rest of CONFIG.SYS line
<span style="color:black">SYSINIT:4D50                 </span><span style="color:navy">mov     dx, offset </span>_$AutoPrmpt <span style="color:gray">; &quot;Process AUTOEXEC.BAT [Y,N]?$&quot;
</span><span style="color:black">SYSINIT:4D53                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; ~CONFIG_OPTION_QUERY
<span style="color:black">SYSINIT:4D55                 </span><span style="color:navy">jz      short </span><span style="color:gray">generic_prompt </span>; config_cmd must have been 0
<span style="color:black">SYSINIT:4D57                 </span><span style="color:navy">mov     dh, al          </span>; save config_cmd in DH
<span style="color:black">SYSINIT:4D59                 </span><span style="color:navy">sub     bx, bx          </span>; 0
<span style="color:black">SYSINIT:4D5B                 </span><span style="color:navy">mov     di, offset </span>comtab <span style="color:gray">; &quot;\x01[[&quot;
</span><span style="color:black">SYSINIT:4D5E
SYSINIT:4D5E </span><span style="color:gray">find_match</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D5E                 </span><span style="color:navy">mov     bl, [di]        </span>; get size of current keyword
<span style="color:black">SYSINIT:4D60                 </span><span style="color:navy">or      bl, bl
</span><span style="color:black">SYSINIT:4D62                 </span><span style="color:navy">jz      short </span><span style="color:gray">line_print </span>; end of table
<span style="color:black">SYSINIT:4D64                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4D65                 </span><span style="color:navy">cmp     al, [bx+di]     </span>; match?
<span style="color:black">SYSINIT:4D67                 </span><span style="color:navy">jz      short </span><span style="color:gray">cmd_match </span>; yes
<span style="color:black">SYSINIT:4D69                 </span><span style="color:navy">lea     di, [bx+di+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; otherwise, skip this command code
<span style="color:black">SYSINIT:4D6C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">find_match </span>; loop
<span style="color:black">SYSINIT:4D6E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4D6E
SYSINIT:4D6E </span><span style="color:gray">cmd_match</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D6E                 </span><span style="color:navy">mov     cl, [di-</span><span style="color:green">1</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:4D71                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4D73                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; STD_CON_OUTPUT
<span style="color:black">SYSINIT:4D75
SYSINIT:4D75 </span><span style="color:gray">cmd_print</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D75                 </span><span style="color:navy">mov     al, [di]
</span><span style="color:black">SYSINIT:4D77                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:4D78                 </span><span style="color:navy">mov     dl, al
</span><span style="color:black">SYSINIT:4D7A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:black">SYSINIT:4D7A                                         </span>; DL = character to send to standard output
<span style="color:black">SYSINIT:4D7C                 </span><span style="color:navy">loop    </span><span style="color:gray">cmd_print
</span><span style="color:black">SYSINIT:4D7E                 </span><span style="color:navy">mov     dl, &#039;</span><span style="color:green">=&#039;         </span>; &#039;=&#039; looks funny on SET commands
<span style="color:black">SYSINIT:4D80                 </span><span style="color:navy">cmp     dh, &#039;</span><span style="color:green">V&#039;         </span>; CONFIG_SET
<span style="color:black">SYSINIT:4D83                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cmd_notset
</span><span style="color:black">SYSINIT:4D85                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; for SET commands, don&#039;t display a &#039;=&#039;
<span style="color:black">SYSINIT:4D87
SYSINIT:4D87 </span><span style="color:gray">cmd_notset</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D87                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:black">SYSINIT:4D87                                         </span>; DL = character to send to standard output
<span style="color:black">SYSINIT:4D89
SYSINIT:4D89 </span><span style="color:gray">line_print</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D89                 </span><span style="color:navy">lods    byte ptr es:[si]
</span><span style="color:black">SYSINIT:4D8B                 </span><span style="color:navy">or      al, al
</span><span style="color:black">SYSINIT:4D8D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">non_null
</span><span style="color:black">SYSINIT:4D8F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:4D91
SYSINIT:4D91 </span><span style="color:gray">non_null</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D91                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; control code?
<span style="color:black">SYSINIT:4D93                 </span><span style="color:navy">jb      short </span><span style="color:gray">prompt_user </span>; yes, assume end of line
<span style="color:black">SYSINIT:4D95                 </span><span style="color:navy">jnz     short </span><span style="color:gray">non_space
</span><span style="color:black">SYSINIT:4D97                 </span><span style="color:navy">cmp     byte ptr es:[si], </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">SYSINIT:4D9B                 </span><span style="color:navy">jb      short </span><span style="color:gray">prompt_user
</span><span style="color:black">SYSINIT:4D9D
SYSINIT:4D9D </span><span style="color:gray">non_space</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4D9D                 </span><span style="color:navy">mov     dl, al
</span><span style="color:black">SYSINIT:4D9F                 </span><span style="color:navy">mov     ah, </span><span style="color:green">2
</span><span style="color:black">SYSINIT:4DA1                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:black">SYSINIT:4DA1                                         </span>; DL = character to send to standard output
<span style="color:black">SYSINIT:4DA3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">line_print
</span><span style="color:black">SYSINIT:4DA5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4DA5
SYSINIT:4DA5 </span><span style="color:gray">prompt_user</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DA5                 </span><span style="color:navy">mov     dx, offset </span>_$InterPrmpt <span style="color:gray">; &quot; [Y,N,ESC]?$&quot;
</span><span style="color:black">SYSINIT:4DA8
SYSINIT:4DA8 </span><span style="color:gray">generic_prompt</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DA8                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:4DAB
SYSINIT:4DAB </span><span style="color:gray">input_loop</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DAB                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4DAD                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
<span style="color:black">SYSINIT:4DAD                                         </span>; Return: AH = scan code, AL = character
<span style="color:black">SYSINIT:4DAF                 </span><span style="color:navy">or      al, al          </span>; is it a function key?
<span style="color:black">SYSINIT:4DB1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_func  </span>; no
<span style="color:black">SYSINIT:4DB3                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">3Fh         </span>; F5 function key?
<span style="color:black">SYSINIT:4DB6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">input_loop </span>; no
<span style="color:black">SYSINIT:4DB8                 </span><span style="color:navy">mov     al, byte ptr ds:</span>_$NO <span style="color:gray">; &quot;NO $&quot;
</span><span style="color:black">SYSINIT:4DBB                 </span><span style="color:navy">or      ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">4 </span>; no more queries
<span style="color:black">SYSINIT:4DC0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">legal_char
</span><span style="color:black">SYSINIT:4DC2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4DC2
SYSINIT:4DC2 </span><span style="color:gray">not_func</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DC2                 </span><span style="color:navy">and     al, </span><span style="color:green">0DFh        </span>; ~20h ; converting to upper case
<span style="color:black">SYSINIT:4DC2                                         </span>; converting to upper case
<span style="color:black">SYSINIT:4DC2                                         </span>; verify character is legal
<span style="color:black">SYSINIT:4DC4                 </span><span style="color:navy">cmp     al, byte ptr ds:</span>_$NO <span style="color:gray">; &quot;NO $&quot;
</span><span style="color:black">SYSINIT:4DC8                 </span><span style="color:navy">jz      short </span><span style="color:gray">legal_char
</span><span style="color:black">SYSINIT:4DCA                 </span><span style="color:navy">cmp     al, byte ptr ds:</span>_$YES <span style="color:gray">; &quot;YES$&quot;
</span><span style="color:black">SYSINIT:4DCE                 </span><span style="color:navy">jz      short </span><span style="color:gray">legal_char
</span><span style="color:black">SYSINIT:4DD0                 </span><span style="color:navy">cmp     ds:</span>config_cmd<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4DD5                 </span><span style="color:navy">jz      short </span><span style="color:gray">input_loop </span>; don&#039;t allow Esc on this query
<span style="color:black">SYSINIT:4DD7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1Bh         </span>; Esc?
<span style="color:black">SYSINIT:4DD9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">input_loop
</span><span style="color:black">SYSINIT:4DDB                 </span><span style="color:navy">or      ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">2 </span>; no more interactive boot prompts
<span style="color:black">SYSINIT:4DE0                 </span><span style="color:navy">mov     al, byte ptr ds:</span>_$YES <span style="color:gray">; &quot;YES$&quot;
</span><span style="color:black">SYSINIT:4DE3
SYSINIT:4DE3 </span><span style="color:gray">legal_char</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DE3                 </span><span style="color:navy">call    </span>disp_input
<span style="color:black">SYSINIT:4DE6                 </span><span style="color:navy">pop     si              </span>; restore pointer to rest of CONFIG.SYS line
<span style="color:black">SYSINIT:4DE6                                         </span>; process line?
<span style="color:black">SYSINIT:4DE7                 </span><span style="color:navy">cmp     al, byte ptr ds:</span>_$NO <span style="color:gray">; &quot;NO $&quot;
</span><span style="color:black">SYSINIT:4DEB                 </span><span style="color:navy">jz      short </span><span style="color:gray">skip_cmd  </span>; no
<span style="color:black">SYSINIT:4DED
SYSINIT:4DED </span><span style="color:gray">do_cmd</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DED                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4DEE                 </span><span style="color:navy">clc                     </span>; just do the command
<span style="color:black">SYSINIT:4DEF                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4DF0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4DF0
SYSINIT:4DF0 </span><span style="color:gray">skip_cmd</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DF0                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4DF1
SYSINIT:4DF1 </span><span style="color:gray">skip_all</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DF1                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;   </span>; CONFIG_REM ; fake out the rest of sysinit&#039;s processing
<span style="color:black">SYSINIT:4DF3                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:4DF4                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4DF4 </span>query_user      <span style="color:black">endp
SYSINIT:4DF4
SYSINIT:4DF5
SYSINIT:4DF5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4DF5
SYSINIT:4DF5
SYSINIT:4DF5 </span>print_error     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4DF5                 </span><span style="color:navy">push    ax              </span>; displays multi-config error conditions
<span style="color:black">SYSINIT:4DF6                 </span><span style="color:navy">push    bx
</span><span style="color:black">SYSINIT:4DF7                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:4DF8                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4DF9                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4DFA                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:4DFB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4DFC                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:4DFC                 </span><span style="color:navy">pushf
</span><span style="color:black">SYSINIT:4DFD                 </span><span style="color:navy">call    </span>get_linenum
<span style="color:black">SYSINIT:4E00                 </span><span style="color:navy">mov     </span>linecount<span style="color:navy">, bx
</span><span style="color:black">SYSINIT:4E04                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:4E07                 </span><span style="color:navy">popf
</span><span style="color:black">SYSINIT:4E08                 </span><span style="color:navy">jnb     short </span><span style="color:gray">pe_ret
</span><span style="color:black">SYSINIT:4E0A                 </span><span style="color:navy">mov     dx, offset </span>_$PauseMsg <span style="color:gray">; &quot;Press any key to continue...\r\n$&quot;
</span><span style="color:black">SYSINIT:4E0D                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:4E10                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0C07h       </span>; flush input buffer, then wait for key
<span style="color:black">SYSINIT:4E13                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - CLEAR KEYBOARD BUFFER
<span style="color:black">SYSINIT:4E13                                         </span>; AL must be 01h, 06h, 07h, 08h, or 0Ah.
<span style="color:black">SYSINIT:4E15                 </span><span style="color:navy">or      al, al          </span>; extended key?
<span style="color:black">SYSINIT:4E17                 </span><span style="color:navy">jnz     short </span><span style="color:gray">pe_1      </span>; no
<span style="color:black">SYSINIT:4E19                 </span><span style="color:navy">mov     ah, </span><span style="color:green">7           </span>; yes, eat it too
<span style="color:black">SYSINIT:4E1B                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DIRECT STDIN INPUT, NO ECHO
<span style="color:black">SYSINIT:4E1D
SYSINIT:4E1D </span><span style="color:gray">pe_1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E1D                 </span><span style="color:navy">mov     dx, offset </span>crlfm <span style="color:gray">; &quot;\r\n$&quot;
</span><span style="color:black">SYSINIT:4E20                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:4E23
SYSINIT:4E23 </span><span style="color:gray">pe_ret</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E23                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4E24                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4E24                 </span><span style="color:navy">pop     dx
</span><span style="color:black">SYSINIT:4E25                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4E26                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4E27                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4E28                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4E28 </span>print_error     <span style="color:black">endp
SYSINIT:4E28
SYSINIT:4E29
SYSINIT:4E29 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4E29
SYSINIT:4E29
SYSINIT:4E29 </span>disable_autoexec <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E29                 </span><span style="color:navy">test    ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">4 </span>; This function is very simple:
<span style="color:black">SYSINIT:4E29                                         </span>; it merely prepends a &quot;/D&quot; to the command-line for the shell;
<span style="color:black">SYSINIT:4E29                                         </span>; this (undocumented) switch disables AUTOEXEC.BAT processing
<span style="color:black">SYSINIT:4E29                                         </span>; and the date/time prompt that is usually displayed
<span style="color:black">SYSINIT:4E29                                         </span>; when there&#039;s no AUTOEXEC.BAT.
<span style="color:black">SYSINIT:4E2E                 </span><span style="color:navy">jz      short </span>disable_exit
<span style="color:black">SYSINIT:4E30                 </span><span style="color:navy">test    ds:</span>dae_flag<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4E35                 </span><span style="color:navy">jnz     short </span>disable_exit
<span style="color:black">SYSINIT:4E37                 </span><span style="color:navy">or      ds:</span>dae_flag<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">SYSINIT:4E3C                 </span><span style="color:navy">or      word ptr ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:green">102h </span>; [bDefBlock] = 1
<span style="color:black">SYSINIT:4E42                 </span><span style="color:navy">mov     dx, &#039; </span><span style="color:green">D&#039;        </span>; 2044h ; &#039;D &#039; (NASM syntax)
<span style="color:black">SYSINIT:4E45
SYSINIT:4E45 </span>dae_1<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E45                 </span><span style="color:navy">mov     al, ds:</span>def_swchr ; get default switchchar
<span style="color:black">SYSINIT:4E48                 </span><span style="color:navy">or      al, al
</span><span style="color:black">SYSINIT:4E4A                 </span><span style="color:navy">jz      short </span>disable_exit
<span style="color:black">SYSINIT:4E4C                 </span><span style="color:navy">mov     bl, byte ptr ds:</span>command_line <span style="color:gray">; &quot;\x02/P&quot;
</span><span style="color:black">SYSINIT:4E50                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">0           </span>; BX == command-line length
<span style="color:black">SYSINIT:4E52                 </span><span style="color:navy">mov     cx, bx
</span><span style="color:black">SYSINIT:4E54                 </span><span style="color:navy">add     bl, </span><span style="color:#ff8000">3
</span><span style="color:black">SYSINIT:4E57                 </span><span style="color:navy">cmp     bl, </span><span style="color:green">126
</span><span style="color:black">SYSINIT:4E5A                 </span><span style="color:navy">ja      short </span>disable_exit ;
<span style="color:black">SYSINIT:4E5A                                         </span>; update length
<span style="color:black">SYSINIT:4E5C                 </span><span style="color:navy">mov     byte ptr ds:</span>command_line<span style="color:navy">, bl </span><span style="color:gray">; &quot;\x02/P&quot;
</span><span style="color:black">SYSINIT:4E60                 </span><span style="color:navy">add     bx, (offset </span>command_line<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">) </span>;
<span style="color:black">SYSINIT:4E60                                         </span>; make sure we move the NULL too
<span style="color:black">SYSINIT:4E64                 </span><span style="color:navy">inc     cx              </span>; (just for consistency sake)
<span style="color:black">SYSINIT:4E65
SYSINIT:4E65 </span><span style="color:gray">disable_loop</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E65                 </span><span style="color:navy">mov     ah, [bx-</span><span style="color:green">3</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:4E68                 </span><span style="color:navy">mov     [bx], ah
</span><span style="color:black">SYSINIT:4E6A                 </span><span style="color:navy">dec     bx
</span><span style="color:black">SYSINIT:4E6B                 </span><span style="color:navy">loop    </span><span style="color:gray">disable_loop
</span><span style="color:black">SYSINIT:4E6D                 </span><span style="color:navy">mov     [bx-</span><span style="color:green">2</span><span style="color:navy">], al
</span><span style="color:black">SYSINIT:4E70                 </span><span style="color:navy">mov     [bx-</span><span style="color:green">1</span><span style="color:navy">], dx      </span>; &#039;D &#039; ; /D is stuffed into place now
<span style="color:black">SYSINIT:4E73
SYSINIT:4E73 </span>disable_exit<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E73                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4E73 </span>disable_autoexec <span style="color:black">endp
SYSINIT:4E73
SYSINIT:4E74
SYSINIT:4E74 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4E74
SYSINIT:4E74
SYSINIT:4E74 </span>CheckQueryOpt   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E74                 </span><span style="color:navy">cmp     ds:</span>bQueryOpt<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">SYSINIT:4E79                 </span><span style="color:navy">jnz     short </span>disable_exit
<span style="color:black">SYSINIT:4E7B                 </span><span style="color:navy">test    ds:</span>dae_flag<span style="color:navy">, </span><span style="color:green">2
</span><span style="color:black">SYSINIT:4E80                 </span><span style="color:navy">jnz     short </span>disable_exit
<span style="color:black">SYSINIT:4E82                 </span><span style="color:navy">or      ds:</span>dae_flag<span style="color:navy">, </span><span style="color:green">2
</span><span style="color:black">SYSINIT:4E87                 </span><span style="color:navy">mov     dx, &#039; </span><span style="color:green">Y&#039;        </span>; &#039;Y &#039; ; 2059h
<span style="color:black">SYSINIT:4E8A                 </span><span style="color:navy">jmp     short </span>dae_1
<span style="color:black">SYSINIT:4E8A </span>CheckQueryOpt   <span style="color:black">endp
SYSINIT:4E8A
SYSINIT:4E8C
SYSINIT:4E8C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4E8C
SYSINIT:4E8C
SYSINIT:4E8C </span>any_delim       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E8C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:4E8E                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4E90                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:4E92                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4E94                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">[&#039;
</span><span style="color:black">SYSINIT:4E96                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4E98                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">]&#039;
</span><span style="color:black">SYSINIT:4E9A                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4E9A </span>any_delim       <span style="color:black">endp
SYSINIT:4E9A
SYSINIT:4E9C
SYSINIT:4E9C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4E9C
SYSINIT:4E9C
SYSINIT:4E9C </span>delim           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4E9C                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">/&#039;         </span>; ibm will assume &quot;/&quot; as an delimeter
<span style="color:black">SYSINIT:4E9E                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4EA0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; special case for sysinit!
<span style="color:black">SYSINIT:4EA2                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4EA4
SYSINIT:4EA4 </span>org_delim<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EA4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; space
<span style="color:black">SYSINIT:4EA6                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4EA8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; tab
<span style="color:black">SYSINIT:4EAA                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4EAC                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">=&#039;
</span><span style="color:black">SYSINIT:4EAE                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4EB0                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">,&#039;
</span><span style="color:black">SYSINIT:4EB2                 </span><span style="color:navy">jz      short </span>delim_ret
<span style="color:black">SYSINIT:4EB4                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">;&#039;
</span><span style="color:black">SYSINIT:4EB6                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:4EB7
SYSINIT:4EB7 </span>delim_ret<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EB7                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4EB7 </span>delim           <span style="color:black">endp
SYSINIT:4EB7
SYSINIT:4EB8
SYSINIT:4EB8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4EB8
SYSINIT:4EB8
SYSINIT:4EB8 </span>newline         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EB8                 </span><span style="color:navy">call    </span>getchr          ; skip non-control characters
<span style="color:black">SYSINIT:4EBB                 </span><span style="color:navy">jb      short </span><span style="color:gray">nl_ret    </span>; no char
<span style="color:black">SYSINIT:4EBD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:4EBF                 </span><span style="color:navy">jnz     short </span>newline
<span style="color:black">SYSINIT:4EC1                 </span><span style="color:navy">call    </span>getchr
<span style="color:black">SYSINIT:4EC4
SYSINIT:4EC4 </span><span style="color:gray">nl_ret</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EC4                 </span><span style="color:navy">retn                    </span>; al = first character of next line (if cf=0)
<span style="color:black">SYSINIT:4EC4 </span>newline         <span style="color:black">endp
SYSINIT:4EC4
SYSINIT:4EC5
SYSINIT:4EC5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4EC5
SYSINIT:4EC5
SYSINIT:4EC5 </span>mapcase         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EC5                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:4EC6                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4EC7                 </span><span style="color:navy">push    ds
</span><span style="color:black">SYSINIT:4EC8                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4EC9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4ECA                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">SYSINIT:4ECC
SYSINIT:4ECC </span><span style="color:gray">convloop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4ECC                 </span><span style="color:navy">lodsb
</span><span style="color:black">SYSINIT:4ECD                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">a&#039;
</span><span style="color:black">SYSINIT:4ECF                 </span><span style="color:navy">jb      short </span><span style="color:gray">noconv
</span><span style="color:black">SYSINIT:4ED1                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">z&#039;
</span><span style="color:black">SYSINIT:4ED3                 </span><span style="color:navy">ja      short </span><span style="color:gray">noconv
</span><span style="color:black">SYSINIT:4ED5                 </span><span style="color:navy">sub     al, </span><span style="color:green">20h         </span>; convert to upper-case (and al,0DFh)
<span style="color:black">SYSINIT:4ED7                 </span><span style="color:navy">mov     [si-</span><span style="color:green">1</span><span style="color:navy">], al
</span><span style="color:black">SYSINIT:4EDA
SYSINIT:4EDA </span><span style="color:gray">noconv</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EDA                 </span><span style="color:navy">cmp     bl, &#039;</span><span style="color:green">V&#039;         </span>; CONFIG_SET ; preserve case for part of the line?
<span style="color:black">SYSINIT:4EDD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">check_eol </span>; no, just check for end-of-line
<span style="color:black">SYSINIT:4EDF                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">=&#039;         </span>; separator between SET var and value?
<span style="color:black">SYSINIT:4EE1                 </span><span style="color:navy">jz      short </span><span style="color:gray">convdone  </span>; yes
<span style="color:black">SYSINIT:4EE1                                         </span>; (we don&#039;t want to upper-case
<span style="color:black">SYSINIT:4EE1                                         </span>; anything after the &quot;=&quot; in a SET)
<span style="color:black">SYSINIT:4EE3
SYSINIT:4EE3 </span><span style="color:gray">check_eol</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EE3                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr
<span style="color:black">SYSINIT:4EE5                 </span><span style="color:navy">jz      short </span><span style="color:gray">convdone
</span><span style="color:black">SYSINIT:4EE7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf
<span style="color:black">SYSINIT:4EE9                 </span><span style="color:navy">jz      short </span><span style="color:gray">convdone
</span><span style="color:black">SYSINIT:4EEB                 </span><span style="color:navy">loop    </span><span style="color:gray">convloop
</span><span style="color:black">SYSINIT:4EED
SYSINIT:4EED </span><span style="color:gray">convdone</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EED                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4EEE                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4EEF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:4EF0                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4EF0 </span>mapcase         <span style="color:black">endp
SYSINIT:4EF0
SYSINIT:4EF1
SYSINIT:4EF1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4EF1
SYSINIT:4EF1
SYSINIT:4EF1 </span>round           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4EF1
SYSINIT:4EF1 </span><span style="color:gray">; FUNCTION CHUNK AT SYSINIT:1468 SIZE 00000001 BYTES
</span><span style="color:black">SYSINIT:4EF1
SYSINIT:4EF1                 </span><span style="color:navy">push    ax              </span>; round the values in memlo and memhi
<span style="color:black">SYSINIT:4EF1                                         </span>; to paragraph boundary.
<span style="color:black">SYSINIT:4EF1                                         </span>; perform bounds check.
<span style="color:black">SYSINIT:4EF2                 </span><span style="color:navy">mov     ax, cs:</span>memlo
<span style="color:black">SYSINIT:4EF6                 </span><span style="color:navy">call    </span>ParaRound       ; para round up
<span style="color:black">SYSINIT:4EF9                 </span><span style="color:navy">add     cs:</span>memhi<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:4EFE                 </span><span style="color:navy">mov     cs:</span>memlo<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4F05                 </span><span style="color:navy">mov     ax, cs:</span>memhi    ; ax = new memhi
<span style="color:black">SYSINIT:4F09                 </span><span style="color:navy">cmp     ax, cs:</span>ALLOCLIM
<span style="color:black">SYSINIT:4F0E                 </span><span style="color:navy">jnb     short </span>mem_err
<span style="color:black">SYSINIT:4F10                 </span><span style="color:navy">test    cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">2 </span>; for_devmark
<span style="color:black">SYSINIT:4F16                 </span><span style="color:navy">jz      short </span><span style="color:gray">skip_set_devmarksize
</span><span style="color:black">SYSINIT:4F18                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4F19                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4F1A                 </span><span style="color:navy">mov     si, cs:</span>devmark_addr
<span style="color:black">SYSINIT:4F1F                 </span><span style="color:navy">mov     es, si
</span><span style="color:black">SYSINIT:4F21                 </span><span style="color:navy">sub     ax, si
</span><span style="color:black">SYSINIT:4F23                 </span><span style="color:navy">dec     ax
</span><span style="color:black">SYSINIT:4F24                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, ax        </span>; mov [es:devmark.size],ax ; paragraph
<span style="color:black">SYSINIT:4F28                 </span><span style="color:navy">and     cs:</span>setdevmarkflag<span style="color:navy">, </span><span style="color:green">0FDh </span>; ~2 ; not 2
<span style="color:black">SYSINIT:4F28                                         </span>; not_for_devmark
<span style="color:black">SYSINIT:4F2E                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4F2F                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:4F30
SYSINIT:4F30 </span><span style="color:gray">skip_set_devmarksize</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4F30                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:4F31                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:4F32                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4F33 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4F33
SYSINIT:4F33 </span>mem_err<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4F33                 </span><span style="color:navy">mov     dx, offset </span>badmem <span style="color:gray">; &quot;\r\nConfiguration too large for memory&quot;...
</span><span style="color:black">SYSINIT:4F36                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:4F37                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:4F38                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:4F38                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:4F3B                 </span><span style="color:navy">jmp     </span>stall
<span style="color:black">SYSINIT:4F3B </span>round           <span style="color:black">endp
SYSINIT:4F3B
SYSINIT:4F3E
SYSINIT:4F3E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4F3E
SYSINIT:4F3E
SYSINIT:4F3E </span>calldev         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4F3E                 </span><span style="color:navy">mov     ds, word ptr cs:</span>DevEntry<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">SYSINIT:4F43                 </span>assume ds:nothing
<span style="color:black">SYSINIT:4F43                 </span><span style="color:navy">add     bx, word ptr cs:</span>DevEntry ; do a little relocation
<span style="color:black">SYSINIT:4F48                 </span><span style="color:navy">mov     ax, [bx]
</span><span style="color:black">SYSINIT:4F4A                 </span><span style="color:navy">push    word ptr cs:</span>DevEntry
<span style="color:black">SYSINIT:4F4F                 </span><span style="color:navy">mov     word ptr cs:</span>DevEntry<span style="color:navy">, ax
</span><span style="color:black">SYSINIT:4F53                 </span><span style="color:navy">mov     bx, offset </span>packet
<span style="color:black">SYSINIT:4F56                 </span><span style="color:navy">call    cs:</span>DevEntry
<span style="color:black">SYSINIT:4F5B                 </span><span style="color:navy">pop     word ptr cs:</span>DevEntry
<span style="color:black">SYSINIT:4F60                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4F60 </span>calldev         <span style="color:black">endp
SYSINIT:4F60
SYSINIT:4F61
SYSINIT:4F61 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4F61
SYSINIT:4F61
SYSINIT:4F61 </span>todigit         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4F61                 </span><span style="color:navy">sub     al, &#039;</span><span style="color:green">0&#039;
</span><span style="color:black">SYSINIT:4F63                 </span><span style="color:navy">jb      short </span><span style="color:gray">notdig
</span><span style="color:black">SYSINIT:4F65                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9
</span><span style="color:black">SYSINIT:4F67                 </span><span style="color:navy">ja      short </span><span style="color:gray">notdig
</span><span style="color:black">SYSINIT:4F69                 </span><span style="color:navy">clc
</span><span style="color:black">SYSINIT:4F6A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4F6B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4F6B
SYSINIT:4F6B </span><span style="color:gray">notdig</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4F6B                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:4F6C                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4F6C </span>todigit         <span style="color:black">endp
SYSINIT:4F6C
SYSINIT:4F6D
SYSINIT:4F6D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4F6D
SYSINIT:4F6D
SYSINIT:4F6D </span>getnum          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4F6D                 </span><span style="color:navy">push    bx              </span>; getnum parses a decimal number.
<span style="color:black">SYSINIT:4F6D                                         </span>; returns it in ax, sets zero flag if ax = 0
<span style="color:black">SYSINIT:4F6D                                         </span>; (may be considered an error),
<span style="color:black">SYSINIT:4F6D                                         </span>; if number is bad carry is set, zero is set, ax=0.
<span style="color:black">SYSINIT:4F6D                                         </span>; ;;
<span style="color:black">SYSINIT:4F6E                 </span><span style="color:navy">xor     bx, bx          </span>; running count is zero
<span style="color:black">SYSINIT:4F70
SYSINIT:4F70 </span><span style="color:gray">b2</span><span style="color:navy">:                                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4F70                 </span><span style="color:navy">call    </span>todigit         ; do we have a digit ?
<span style="color:black">SYSINIT:4F73                 </span><span style="color:navy">jb      short </span><span style="color:gray">badnum    </span>; no, bomb
<span style="color:black">SYSINIT:4F75                 </span><span style="color:navy">xchg    ax, bx          </span>; put total in ax
<span style="color:black">SYSINIT:4F76                 </span><span style="color:navy">push    bx              </span>; save digit (0 to 9)
<span style="color:black">SYSINIT:4F77                 </span><span style="color:navy">mov     bx, </span><span style="color:green">10          </span>; base of arithmetic
<span style="color:black">SYSINIT:4F7A                 </span><span style="color:navy">mul     bx              </span>; shift by one decimal digit
<span style="color:black">SYSINIT:4F7C                 </span><span style="color:navy">pop     bx              </span>; get back digit (0 to 9)
<span style="color:black">SYSINIT:4F7D                 </span><span style="color:navy">add     al, bl          </span>; get total
<span style="color:black">SYSINIT:4F7F                 </span><span style="color:navy">adc     ah, </span><span style="color:#ff8000">0           </span>; make that 16 bits
<span style="color:black">SYSINIT:4F82                 </span><span style="color:navy">jb      short </span><span style="color:gray">badnum    </span>; too big a number
<span style="color:black">SYSINIT:4F84                 </span><span style="color:navy">xchg    ax, bx          </span>; stash total
<span style="color:black">SYSINIT:4F85                 </span><span style="color:navy">call    </span>getchr          ; get next digit
<span style="color:black">SYSINIT:4F88                 </span><span style="color:navy">jb      short </span><span style="color:gray">b1        </span>; no more characters
<span style="color:black">SYSINIT:4F8A                 </span><span style="color:navy">cmp     al, &#039; &#039;         </span>; space?
<span style="color:black">SYSINIT:4F8C                 </span><span style="color:navy">jz      short </span><span style="color:gray">b15       </span>; then end of digits
<span style="color:black">SYSINIT:4F8E                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">,&#039;         </span>; &#039;,&#039; is a seperator!!!
<span style="color:black">SYSINIT:4F90                 </span><span style="color:navy">jz      short </span><span style="color:gray">b15       </span>; then end of digits.
<span style="color:black">SYSINIT:4F92                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; tab
<span style="color:black">SYSINIT:4F94                 </span><span style="color:navy">jz      short </span><span style="color:gray">b15
</span><span style="color:black">SYSINIT:4F96                 </span><span style="color:navy">cmp     al, cs:</span>sepchr   ; allow 0 or special separators
<span style="color:black">SYSINIT:4F9B                 </span><span style="color:navy">jz      short </span><span style="color:gray">b15
</span><span style="color:black">SYSINIT:4F9D                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">/&#039;         </span>; see if another switch follows
<span style="color:black">SYSINIT:4F9F                 </span><span style="color:navy">nop                     </span>; cas - remnant of old bad code
<span style="color:black">SYSINIT:4FA0                 </span><span style="color:navy">nop                     </span>; (04/08/2023 - Erdogan Tan - &#039;nop,nop&#039; is not neded)
<span style="color:black">SYSINIT:4FA1                 </span><span style="color:navy">jz      short </span><span style="color:gray">b15
</span><span style="color:black">SYSINIT:4FA3                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; lf ; line-feed?
<span style="color:black">SYSINIT:4FA5                 </span><span style="color:navy">jz      short </span><span style="color:gray">b15
</span><span style="color:black">SYSINIT:4FA7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; cr ; carriage return?
<span style="color:black">SYSINIT:4FA9                 </span><span style="color:navy">jz      short </span><span style="color:gray">b15
</span><span style="color:black">SYSINIT:4FAB                 </span><span style="color:navy">or      al, al          </span>; end of line separator?
<span style="color:black">SYSINIT:4FAD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">b2        </span>; no, try as a valid char...
<span style="color:black">SYSINIT:4FAF
SYSINIT:4FAF </span><span style="color:gray">b15</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4FAF                 </span><span style="color:navy">inc     cs:</span>count        ; one more character to s...
<span style="color:black">SYSINIT:4FB4                 </span><span style="color:navy">dec     cs:</span>chrptr       ; clears carry, sets zero accordingly
<span style="color:black">SYSINIT:4FB9
SYSINIT:4FB9 </span><span style="color:gray">b1</span><span style="color:navy">:                                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4FB9                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">SYSINIT:4FBB                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">SYSINIT:4FBD                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4FBE                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4FBF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:4FBF
SYSINIT:4FBF </span><span style="color:gray">badnum</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4FBF                 </span><span style="color:navy">mov     cs:</span>sepchr<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:4FC5                 </span><span style="color:navy">xor     ax, ax          </span>; set zero flag, and ax = 0
<span style="color:black">SYSINIT:4FC7                 </span><span style="color:navy">pop     bx
</span><span style="color:black">SYSINIT:4FC8                 </span><span style="color:navy">stc                     </span>; and carry set
<span style="color:black">SYSINIT:4FC9                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:4FC9 </span>getnum          <span style="color:black">endp
SYSINIT:4FC9
SYSINIT:4FCA
SYSINIT:4FCA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:4FCA
SYSINIT:4FCA
SYSINIT:4FCA </span>setdoscountryinfo <span style="color:black">proc near             </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:4FCA                 </span><span style="color:navy">push    di              </span>; input:
<span style="color:black">SYSINIT:4FCA                                         </span>;   es:di -&gt; pointer to dos_country_cdpg_info
<span style="color:black">SYSINIT:4FCA                                         </span>;   ds:0  -&gt; buffer.
<span style="color:black">SYSINIT:4FCA                                         </span>;      si = 0
<span style="color:black">SYSINIT:4FCA                                         </span>;      ax = country id
<span style="color:black">SYSINIT:4FCA                                         </span>;      dx = code page id. (if 0, then use ccsyscodepage as a default.)
<span style="color:black">SYSINIT:4FCA                                         </span>;      bx = file handle
<span style="color:black">SYSINIT:4FCA                                         </span>;   this routine can handle maximum 438 country_data entries.
<span style="color:black">SYSINIT:4FCA                                         </span>; output:
<span style="color:black">SYSINIT:4FCA                                         </span>;   dos_country_cdpg_info set.
<span style="color:black">SYSINIT:4FCA                                         </span>;   carry set if any file read failure or wrong information in the file.
<span style="color:black">SYSINIT:4FCA                                         </span>;   carry set and cx = -1 if cannot find the matching country_id,
<span style="color:black">SYSINIT:4FCA                                         </span>;         codepage_id in the file.
<span style="color:black">SYSINIT:4FCB                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:4FCC                 </span><span style="color:navy">push    dx
</span><span style="color:black">SYSINIT:4FCD                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">SYSINIT:4FCF                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">SYSINIT:4FD1                 </span><span style="color:navy">mov     ax, </span><span style="color:green">512         </span>; read 512 bytes
<span style="color:black">SYSINIT:4FD4                 </span><span style="color:navy">call    </span>readincontrolbuffer ; read the file header
<span style="color:black">SYSINIT:4FD7                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:4FD9                 </span><span style="color:navy">push    es
</span><span style="color:black">SYSINIT:4FDA                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:4FDB                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:4FDC                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:4FDD                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:4FDD                 </span><span style="color:navy">mov     di, offset </span>country_file_signature ; db 0FFh,&#039;COUNTRY&#039;
<span style="color:black">SYSINIT:4FE0                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8           </span>; length of the signature
<span style="color:black">SYSINIT:4FE3                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">SYSINIT:4FE5                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:4FE6                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:4FE7                 </span>assume es:nothing
<span style="color:black">SYSINIT:4FE7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdosdata_fail </span>; signature mismatch
<span style="color:black">SYSINIT:4FE9                 </span><span style="color:navy">add     si, </span><span style="color:green">18
</span><span style="color:black">SYSINIT:4FEC                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">1 </span>; si -&gt; county info type
<span style="color:black">SYSINIT:4FEC                                         </span>; only accept type 1 (currently only 1 header type)
<span style="color:black">SYSINIT:4FEF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdosdata_fail </span>; cannot proceed. error return
<span style="color:black">SYSINIT:4FF1                 </span><span style="color:navy">inc     si              </span>; si -&gt; file offset
<span style="color:black">SYSINIT:4FF2                 </span><span style="color:navy">mov     dx, [si]        </span>; get the info file offset.
<span style="color:black">SYSINIT:4FF4                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:4FF7                 </span><span style="color:navy">mov     ax, </span><span style="color:green">6144        </span>; read 6144 bytes.
<span style="color:black">SYSINIT:4FFA                 </span><span style="color:navy">call    </span>readincontrolbuffer ; read info
<span style="color:black">SYSINIT:4FFD                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:4FFF                 </span><span style="color:navy">mov     cx, [si]        </span>; get the # of country, codepage combination entries
<span style="color:black">SYSINIT:5001                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">438         </span>; cannot handle more than 438 entries.
<span style="color:black">SYSINIT:5005                 </span><span style="color:navy">ja      short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:5007                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:5008                 </span><span style="color:navy">inc     si              </span>; si -&gt; entry information packet
<span style="color:black">SYSINIT:5009                 </span><span style="color:navy">pop     dx              </span>; restore code page id
<span style="color:black">SYSINIT:500A                 </span><span style="color:navy">pop     ax              </span>; restore country id
<span style="color:black">SYSINIT:500B                 </span><span style="color:navy">pop     di              </span>; search for desired country_id,codepage_id.
<span style="color:black">SYSINIT:500C
SYSINIT:500C </span><span style="color:gray">setdoscntry_find</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:500C                 </span><span style="color:navy">cmp     ax, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; compare country_id
<span style="color:black">SYSINIT:500F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdoscntry_next
</span><span style="color:black">SYSINIT:5011                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0           </span>; no user specified code page ?
<span style="color:black">SYSINIT:5014                 </span><span style="color:navy">jz      short </span><span style="color:gray">setdoscntry_any_codepage </span>; then no need to match code page id.
<span style="color:black">SYSINIT:5016                 </span><span style="color:navy">cmp     dx, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; compare code page id
<span style="color:black">SYSINIT:5019                 </span><span style="color:navy">jz      short </span><span style="color:gray">setdoscntry_got_it
</span><span style="color:black">SYSINIT:501B
SYSINIT:501B </span><span style="color:gray">setdoscntry_next</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:501B                 </span><span style="color:navy">add     si, [si]        </span>; next entry
<span style="color:black">SYSINIT:501D                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:501E                 </span><span style="color:navy">inc     si              </span>; take a word for size of entry itself
<span style="color:black">SYSINIT:501F                 </span><span style="color:navy">loop    </span><span style="color:gray">setdoscntry_find
</span><span style="color:black">SYSINIT:5021                 </span><span style="color:navy">mov     cx, </span><span style="color:green">0FFFFh      </span>; -1 ; signals that bad country id entered.
<span style="color:black">SYSINIT:5024
SYSINIT:5024 </span><span style="color:gray">setdoscntry_fail</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5024                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:5025                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:5026 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:5026
SYSINIT:5026 </span><span style="color:gray">setdosdata_fail</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5026                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:5027                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:5028                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:5029                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setdoscntry_fail
</span><span style="color:black">SYSINIT:502B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:502B
SYSINIT:502B </span><span style="color:gray">setdoscntry_any_codepage</span><span style="color:navy">:               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:502B                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; use the code_page_id of the country_id found.
<span style="color:black">SYSINIT:502E
SYSINIT:502E </span><span style="color:gray">setdoscntry_got_it</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:502E                 </span><span style="color:navy">mov     cs:</span>cntrycodepage_id<span style="color:navy">, dx </span>; save code page id for this country.
<span style="color:black">SYSINIT:5033                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:green">10</span><span style="color:navy">]     </span>; get the file offset of country data
<span style="color:black">SYSINIT:5036                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:green">12</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:5039                 </span><span style="color:navy">mov     ax, </span><span style="color:green">512         </span>; read 512 bytes
<span style="color:black">SYSINIT:503C                 </span><span style="color:navy">call    </span>readincontrolbuffer
<span style="color:black">SYSINIT:503F                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdoscntry_fail
</span><span style="color:black">SYSINIT:5041                 </span><span style="color:navy">mov     cx, [si]        </span>; get the number of entries to handle.
<span style="color:black">SYSINIT:5043                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:5044                 </span><span style="color:navy">inc     si              </span>; si -&gt; first entry
<span style="color:black">SYSINIT:5045
SYSINIT:5045 </span><span style="color:gray">setdoscntry_data</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5045                 </span><span style="color:navy">push    di              </span>; es:di -&gt; dos_country_cdpg_info
<span style="color:black">SYSINIT:5046                 </span><span style="color:navy">push    cx              </span>; save # of entry left
<span style="color:black">SYSINIT:5047                 </span><span style="color:navy">push    si              </span>; si -&gt; current entry in control buffer
<span style="color:black">SYSINIT:5048                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; get data entry id
<span style="color:black">SYSINIT:504B                 </span><span style="color:navy">call    </span>getcountrydestination ; get the address of destination in es:di
<span style="color:black">SYSINIT:504E                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdoscntry_data_next </span>; no matching data entry id in dos
<span style="color:black">SYSINIT:5050                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; get offset of data
<span style="color:black">SYSINIT:5053                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:5056                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4200h
</span><span style="color:black">SYSINIT:5059                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:505A                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
<span style="color:black">SYSINIT:505A                                         </span>; AL = method: offset from beginning of file
<span style="color:black">SYSINIT:505C                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdosdata_fail </span>;
<span style="color:black">SYSINIT:505C                                         </span>; read the country.sys data
<span style="color:black">SYSINIT:505E                 </span><span style="color:navy">mov     dx, </span><span style="color:green">512         </span>; start of data buffer
<span style="color:black">SYSINIT:5061                 </span><span style="color:navy">mov     cx, </span><span style="color:green">20          </span>; read 20 bytes only. we only need to
<span style="color:black">SYSINIT:5064                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Fh         </span>; look at the length of the data in the file.
<span style="color:black">SYSINIT:5066                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:5067                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - READ FROM FILE WITH HANDLE
<span style="color:black">SYSINIT:5067                                         </span>; BX = file handle, CX = number of bytes to read
<span style="color:black">SYSINIT:5067                                         </span>; DS:DX -&gt; buffer
<span style="color:black">SYSINIT:5069                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdosdata_fail </span>; read failure
<span style="color:black">SYSINIT:506B                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">SYSINIT:506D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:506F                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; get offset of data again.
<span style="color:black">SYSINIT:5072                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">SYSINIT:5075                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4200h       </span>; move pointer back again
<span style="color:black">SYSINIT:5078                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:5079                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
<span style="color:black">SYSINIT:5079                                         </span>; AL = method: offset from beginning of file
<span style="color:black">SYSINIT:507B                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:507D                 </span><span style="color:navy">push    si
</span><span style="color:black">SYSINIT:507E                 </span><span style="color:navy">mov     si, </span><span style="color:green">520         </span>; (512+8) ; get length of the data from the file
<span style="color:black">SYSINIT:5081                 </span><span style="color:navy">mov     cx, [si]
</span><span style="color:black">SYSINIT:5083                 </span><span style="color:navy">pop     si
</span><span style="color:black">SYSINIT:5084                 </span><span style="color:navy">mov     dx, </span><span style="color:green">512         </span>; start of data buffer
<span style="color:black">SYSINIT:5087                 </span><span style="color:navy">add     cx, </span><span style="color:green">10          </span>; signature + a word for the length itself
<span style="color:black">SYSINIT:508A                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Fh         </span>; read the data from the file.
<span style="color:black">SYSINIT:508C                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:508D                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - READ FROM FILE WITH HANDLE
<span style="color:black">SYSINIT:508D                                         </span>; BX = file handle, CX = number of bytes to read
<span style="color:black">SYSINIT:508D                                         </span>; DS:DX -&gt; buffer
<span style="color:black">SYSINIT:508F                 </span><span style="color:navy">jb      short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:5091                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">SYSINIT:5093                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:5095                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; save data id for future use.
<span style="color:black">SYSINIT:5098                 </span><span style="color:navy">mov     si, </span><span style="color:green">520         </span>; (512+8) ; si-&gt; data buffer + id tag field
<span style="color:black">SYSINIT:509B                 </span><span style="color:navy">mov     cx, [si]        </span>; get the length of the file
<span style="color:black">SYSINIT:509D                 </span><span style="color:navy">inc     cx              </span>; take care of a word for lenght of tab itself.
<span style="color:black">SYSINIT:509E                 </span><span style="color:navy">inc     cx
</span><span style="color:black">SYSINIT:509F                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">1528        </span>; (2048-512-8) ; fit into the buffer?
<span style="color:black">SYSINIT:50A3                 </span><span style="color:navy">ja      short </span><span style="color:gray">setdosdata_fail
</span><span style="color:black">SYSINIT:50A5                 </span><span style="color:navy">call    </span>setdbcs_before_copy
<span style="color:black">SYSINIT:50A8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; SetCountryInfo ; is the data for setcountryinfo table?
<span style="color:black">SYSINIT:50AA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdoscntry_mov </span>; no, don&#039;t worry
<span style="color:black">SYSINIT:50AC                 </span><span style="color:navy">push    word ptr es:[di+</span><span style="color:green">24</span><span style="color:navy">] </span>;
<span style="color:black">SYSINIT:50AC                                         </span>; [es:di+country_cdpg_info.ccMono_Ptr
<span style="color:black">SYSINIT:50AC                                         </span>;  -country_cdpg_info.ccCountryInfoLen]
<span style="color:black">SYSINIT:50B0                 </span><span style="color:navy">push    word ptr es:[di+</span><span style="color:green">26</span><span style="color:navy">] </span>;
<span style="color:black">SYSINIT:50B0                                         </span>; [es:di+country_cdpg_info.ccMono_Ptr
<span style="color:black">SYSINIT:50B0                                         </span>;  -country_cdpg_info.ccCountryInfoLen+2]
<span style="color:black">SYSINIT:50B0                                         </span>;
<span style="color:black">SYSINIT:50B0                                         </span>; at this time di -&gt; cccountryinfolen
<span style="color:black">SYSINIT:50B4                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:50B5                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:50B6                 </span><span style="color:navy">mov     ax, cs:</span>cntrycodepage_id ; do not use the code page info in country_info
<span style="color:black">SYSINIT:50BA                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax      </span>; use the saved one for this !!!
<span style="color:black">SYSINIT:50BD                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:50BE
SYSINIT:50BE </span><span style="color:gray">setdoscntry_mov</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:50BE                 </span><span style="color:navy">rep movsb               </span>; copy the table into dos
<span style="color:black">SYSINIT:50C0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; SetCountryInfo ; was the ccmono_ptr saved?
<span style="color:black">SYSINIT:50C2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setdoscntry_data_next
</span><span style="color:black">SYSINIT:50C4                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:50C5                 </span><span style="color:navy">pop     word ptr es:[di+</span><span style="color:green">26</span><span style="color:navy">] </span>;
<span style="color:black">SYSINIT:50C5                                         </span>; [es:di+country_cdpg_info.ccMono_Ptr
<span style="color:black">SYSINIT:50C5                                         </span>;  -country_cdpg_info.ccCountryInfoLen+2]
<span style="color:black">SYSINIT:50C9                 </span><span style="color:navy">pop     word ptr es:[di+</span><span style="color:green">24</span><span style="color:navy">] </span>;
<span style="color:black">SYSINIT:50C9                                         </span>; [es:di+country_cdpg_info.ccMono_Ptr
<span style="color:black">SYSINIT:50C9                                         </span>;  -country_cdpg_info.ccCountryInfoLen]
<span style="color:black">SYSINIT:50CD
SYSINIT:50CD </span><span style="color:gray">setdoscntry_data_next</span><span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:50CD                 </span><span style="color:navy">pop     si              </span>; restore control buffer pointer
<span style="color:black">SYSINIT:50CE                 </span><span style="color:navy">pop     cx              </span>; restore # of entries left
<span style="color:black">SYSINIT:50CF                 </span><span style="color:navy">pop     di              </span>; restore pointer to dso_country_cdpg
<span style="color:black">SYSINIT:50D0                 </span><span style="color:navy">add     si, [si]        </span>; try to get the next entry
<span style="color:black">SYSINIT:50D2                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:50D3                 </span><span style="color:navy">inc     si              </span>; take a word of entry length itself
<span style="color:black">SYSINIT:50D4                 </span><span style="color:navy">dec     cx
</span><span style="color:black">SYSINIT:50D5                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">0
</span><span style="color:black">SYSINIT:50D8                 </span><span style="color:navy">jz      short </span><span style="color:gray">setdoscntry_ok
</span><span style="color:black">SYSINIT:50DA                 </span><span style="color:navy">jmp     </span><span style="color:gray">setdoscntry_data
</span><span style="color:black">SYSINIT:50DD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:50DD
SYSINIT:50DD </span><span style="color:gray">setdoscntry_ok</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:50DD                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:50DD </span><span style="background:red">setdoscountryinfo endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">SYSINIT:50DD
SYSINIT:50DE
SYSINIT:50DE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:50DE
SYSINIT:50DE
SYSINIT:50DE </span>setdbcs_before_copy <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:50DE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7           </span>; SetDBCS ; dbcs vector set?
<span style="color:black">SYSINIT:50E0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">sdbcsbc   </span>; jump if not
<span style="color:black">SYSINIT:50E2                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; zero byte data block?
<span style="color:black">SYSINIT:50E6                 </span><span style="color:navy">jz      short </span><span style="color:gray">sdbcsbc   </span>; jump if so
<span style="color:black">SYSINIT:50E8                 </span><span style="color:navy">push    di
</span><span style="color:black">SYSINIT:50E9                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:50EA                 </span><span style="color:navy">push    cx
</span><span style="color:black">SYSINIT:50EB                 </span><span style="color:navy">mov     cx, es:[di]     </span>; load block length
<span style="color:black">SYSINIT:50EE                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">2           </span>; points actual data
<span style="color:black">SYSINIT:50F1                 </span><span style="color:navy">xor     al, al          </span>; fill bytes
<span style="color:black">SYSINIT:50F3                 </span><span style="color:navy">rep stosb               </span>; clear data block
<span style="color:black">SYSINIT:50F5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:50F6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:50F7                 </span><span style="color:navy">pop     di
</span><span style="color:black">SYSINIT:50F8
SYSINIT:50F8 </span><span style="color:gray">sdbcsbc</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:50F8                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:50F8 </span>setdbcs_before_copy <span style="color:black">endp
SYSINIT:50F8
SYSINIT:50F9
SYSINIT:50F9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:50F9
SYSINIT:50F9
SYSINIT:50F9 </span>getcountrydestination <span style="color:black">proc near         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:50F9                 </span><span style="color:navy">push    cx              </span>; get the destination address
<span style="color:black">SYSINIT:50F9                                         </span>;  in the dos country info table.
<span style="color:black">SYSINIT:50FA                 </span><span style="color:navy">add     di, </span><span style="color:green">74          </span>; country_cdpg_info.ccNumber_of_entries
<span style="color:black">SYSINIT:50FA                                         </span>; skip the reserved area, syscodepage etc.
<span style="color:black">SYSINIT:50FD                 </span><span style="color:navy">mov     cx, es:[di]     </span>; get the number of entries
<span style="color:black">SYSINIT:5100                 </span><span style="color:navy">inc     di
</span><span style="color:black">SYSINIT:5101                 </span><span style="color:navy">inc     di              </span>; si -&gt; the first start entry id
<span style="color:black">SYSINIT:5102
SYSINIT:5102 </span><span style="color:gray">getcntrydest</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5102                 </span><span style="color:navy">cmp     es:[di], al
</span><span style="color:black">SYSINIT:5105                 </span><span style="color:navy">jz      short </span><span style="color:gray">getcntrydest_ok
</span><span style="color:black">SYSINIT:5107                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">1 </span>; SetCountryInfo ; was it setcountryinfo entry?
<span style="color:black">SYSINIT:510B                 </span><span style="color:navy">jz      short </span><span style="color:gray">getcntrydest_1
</span><span style="color:black">SYSINIT:510D                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">5           </span>; next data id
<span style="color:black">SYSINIT:5110                 </span><span style="color:navy">jmp     short </span><span style="color:gray">getcntrydest_loop
</span><span style="color:black">SYSINIT:5112 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:5112
SYSINIT:5112 </span><span style="color:gray">getcntrydest_1</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5112                 </span><span style="color:navy">add     di, </span><span style="color:green">41          </span>; NEW_COUNTRY_SIZE+3 ; next data id
<span style="color:black">SYSINIT:5115
SYSINIT:5115 </span><span style="color:gray">getcntrydest_loop</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5115                 </span><span style="color:navy">loop    </span><span style="color:gray">getcntrydest
</span><span style="color:black">SYSINIT:5117                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:5118                 </span><span style="color:navy">jmp     short </span><span style="color:gray">getcntrydest_exit
</span><span style="color:black">SYSINIT:511A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:511A
SYSINIT:511A </span><span style="color:gray">getcntrydest_ok</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:511A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; SetCountryInfo ; select country info?
<span style="color:black">SYSINIT:511C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">getcntrydest_ok1
</span><span style="color:black">SYSINIT:511E                 </span><span style="color:navy">inc     di              </span>; now di -&gt; cccountryinfolen
<span style="color:black">SYSINIT:511F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">getcntrydest_exit
</span><span style="color:black">SYSINIT:5121 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:5121
SYSINIT:5121 </span><span style="color:gray">getcntrydest_ok1</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5121                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; get the destination in es:di
<span style="color:black">SYSINIT:5125
SYSINIT:5125 </span><span style="color:gray">getcntrydest_exit</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5125                 </span><span style="color:navy">pop     cx
</span><span style="color:black">SYSINIT:5126                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:5126 </span>getcountrydestination <span style="color:black">endp
SYSINIT:5126
SYSINIT:5127
SYSINIT:5127 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:5127
SYSINIT:5127
SYSINIT:5127 </span>readincontrolbuffer <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5127                 </span><span style="color:navy">push    ax              </span>; # of bytes to read
<span style="color:black">SYSINIT:5128                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4200h
</span><span style="color:black">SYSINIT:512B                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:512C                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
<span style="color:black">SYSINIT:512C                                         </span>; AL = method: offset from beginning of file
<span style="color:black">SYSINIT:512E                 </span><span style="color:navy">pop     cx              </span>; # of bytes to read
<span style="color:black">SYSINIT:512F                 </span><span style="color:navy">jb      short </span><span style="color:gray">ricb_exit
</span><span style="color:black">SYSINIT:5131                 </span><span style="color:navy">xor     dx, dx          </span>; ds:dx -&gt; control buffer
<span style="color:black">SYSINIT:5133                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">SYSINIT:5135                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Fh         </span>; read into the buffer
<span style="color:black">SYSINIT:5135                                         </span>; should be less than 1024 bytes.
<span style="color:black">SYSINIT:5137                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:5138                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - READ FROM FILE WITH HANDLE
<span style="color:black">SYSINIT:5138                                         </span>; BX = file handle, CX = number of bytes to read
<span style="color:black">SYSINIT:5138                                         </span>; DS:DX -&gt; buffer
<span style="color:black">SYSINIT:513A
SYSINIT:513A </span><span style="color:gray">ricb_exit</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:513A                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:513A </span>readincontrolbuffer <span style="color:black">endp
SYSINIT:513A
</span><span style="color:maroon">SYSINIT:513B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:513B
SYSINIT:513B </span>set_country_path<span style="color:navy">:                       </span>; ! this procedure is not called from anywhere !
<span style="color:maroon">SYSINIT:513B                 </span><span style="color:navy">push    si              </span>; Erdogan Tan - 04/08/2023
<span style="color:maroon">SYSINIT:513C                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:513D                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:513E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:513F                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:5140                 </span><span style="color:navy">call    </span>chk_drive_letter
<span style="color:maroon">SYSINIT:5143                 </span><span style="color:navy">jb      short </span>scp_default_drv
<span style="color:maroon">SYSINIT:5145                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:maroon">SYSINIT:5147                 </span><span style="color:navy">inc     si
</span><span style="color:maroon">SYSINIT:5148                 </span><span style="color:navy">inc     si
</span><span style="color:maroon">SYSINIT:5149                 </span><span style="color:navy">jmp     short </span>scp_setdrv
<span style="color:maroon">SYSINIT:514B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:514B
SYSINIT:514B </span>scp_default_drv<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:514B                 </span><span style="color:navy">mov     ah, </span><span style="color:green">19h
</span><span style="color:maroon">SYSINIT:514D                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - GET DEFAULT DISK NUMBER
<span style="color:maroon">SYSINIT:514F                 </span><span style="color:navy">add     al, &#039;</span><span style="color:green">A&#039;
</span><span style="color:maroon">SYSINIT:5151
SYSINIT:5151 </span>scp_setdrv<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:5151                 </span><span style="color:navy">mov     byte ptr cs:</span>cntry_drv<span style="color:navy">, al </span><span style="color:gray">; &quot;A:&quot;
</span><span style="color:maroon">SYSINIT:5155                 </span><span style="color:navy">mov     di, offset </span>cntry_path <span style="color:gray">; &quot;COUNTRY.SYS&quot;
</span><span style="color:maroon">SYSINIT:5158                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:maroon">SYSINIT:515A                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">\&#039;
</span><span style="color:maroon">SYSINIT:515C                 </span><span style="color:navy">jz      short </span>scp_root_dir
<span style="color:maroon">SYSINIT:515E                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">/&#039;
</span><span style="color:maroon">SYSINIT:5160                 </span><span style="color:navy">jz      short </span>scp_root_dir
<span style="color:maroon">SYSINIT:5162                 </span><span style="color:navy">jmp     short </span>scp_path
<span style="color:maroon">SYSINIT:5164 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:5164
SYSINIT:5164 </span>scp_root_dir<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:5164                 </span><span style="color:navy">dec     di
</span><span style="color:maroon">SYSINIT:5165
SYSINIT:5165 </span>scp_path<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">SYSINIT:5165                 </span><span style="color:navy">call    </span>move_asciiz
<span style="color:maroon">SYSINIT:5168                 </span><span style="color:navy">mov     di, offset </span>cntry_drv <span style="color:gray">; &quot;A:&quot;
</span><span style="color:maroon">SYSINIT:516B                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">SYSINIT:516C                 </span><span style="color:navy">push    es
</span><span style="color:maroon">SYSINIT:516D                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">SYSINIT:516E                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">SYSINIT:516F                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">SYSINIT:5170                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:5171
SYSINIT:5171 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:5171
SYSINIT:5171
SYSINIT:5171 </span>chk_drive_letter <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5171                 </span><span style="color:navy">push    ax
</span><span style="color:black">SYSINIT:5172                 </span><span style="color:navy">cmp     byte ptr [si], &#039;</span><span style="color:green">A&#039;
</span><span style="color:black">SYSINIT:5175                 </span><span style="color:navy">jb      short </span><span style="color:gray">cdletter_no
</span><span style="color:black">SYSINIT:5177                 </span><span style="color:navy">cmp     byte ptr [si], &#039;</span><span style="color:green">Z&#039;
</span><span style="color:black">SYSINIT:517A                 </span><span style="color:navy">ja      short </span><span style="color:gray">cdletter_no
</span><span style="color:black">SYSINIT:517C                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">1</span><span style="color:navy">], &#039;</span><span style="color:green">:&#039;
</span><span style="color:black">SYSINIT:5180                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cdletter_no
</span><span style="color:black">SYSINIT:5182                 </span><span style="color:navy">jmp     short </span><span style="color:gray">cdletter_exit
</span><span style="color:black">SYSINIT:5184 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:5184
SYSINIT:5184 </span><span style="color:gray">cdletter_no</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5184                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:5185
SYSINIT:5185 </span><span style="color:gray">cdletter_exit</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5185                 </span><span style="color:navy">pop     ax
</span><span style="color:black">SYSINIT:5186                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:5186 </span>chk_drive_letter <span style="color:black">endp
SYSINIT:5186
SYSINIT:5187
SYSINIT:5187 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:5187
SYSINIT:5187
SYSINIT:5187 </span>move_asciiz     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5187                 </span><span style="color:navy">movsb
</span><span style="color:black">SYSINIT:5188                 </span><span style="color:navy">cmp     byte ptr [si-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; was it 0?
<span style="color:black">SYSINIT:518C                 </span><span style="color:navy">jnz     short </span>move_asciiz
<span style="color:black">SYSINIT:518E                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:518E </span>move_asciiz     <span style="color:black">endp
SYSINIT:518E
SYSINIT:518F
SYSINIT:518F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:518F
SYSINIT:518F
SYSINIT:518F </span>badfil          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:518F                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:5190                 </span><span style="color:navy">pop     es
</span><span style="color:black">SYSINIT:5191                 </span>assume es:SYSINIT
<span style="color:black">SYSINIT:5191                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">SYSINIT:5193
SYSINIT:5193 </span>badload<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5193                 </span><span style="color:navy">mov     dx, offset </span>badld_pre <span style="color:gray">; &quot;\r\nBad or missing $&quot;
</span><span style="color:black">SYSINIT:5196                 </span><span style="color:navy">mov     bx, offset </span>crlfm <span style="color:gray">; &quot;\r\n$&quot;
</span><span style="color:black">SYSINIT:5199
SYSINIT:5199 </span>prnerr<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:5199                 </span><span style="color:navy">push    cs
</span><span style="color:black">SYSINIT:519A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">SYSINIT:519B                 </span>assume ds:SYSINIT
<span style="color:black">SYSINIT:519B                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:519E
SYSINIT:519E </span><span style="color:gray">prn1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:519E                 </span><span style="color:navy">mov     dl, es:[si]
</span><span style="color:black">SYSINIT:51A1                 </span><span style="color:navy">or      dl, dl
</span><span style="color:black">SYSINIT:51A3                 </span><span style="color:navy">jz      short </span><span style="color:gray">prn2
</span><span style="color:black">SYSINIT:51A5                 </span><span style="color:navy">mov     ah, </span><span style="color:green">2
</span><span style="color:black">SYSINIT:51A7                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:black">SYSINIT:51A7                                         </span>; DL = character to send to standard output
<span style="color:black">SYSINIT:51A9                 </span><span style="color:navy">inc     si
</span><span style="color:black">SYSINIT:51AA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">prn1
</span><span style="color:black">SYSINIT:51AC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:51AC
SYSINIT:51AC </span><span style="color:gray">prn2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51AC                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">SYSINIT:51AE                 </span><span style="color:navy">call    </span>print
<span style="color:black">SYSINIT:51B1                 </span><span style="color:navy">cmp     cs:</span>donotshownum<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; suppress line number when handling command.com
<span style="color:black">SYSINIT:51B7                 </span><span style="color:navy">jz      short </span><span style="color:gray">prnexit
</span><span style="color:black">SYSINIT:51B9                 </span><span style="color:navy">call    </span>error_line
<span style="color:black">SYSINIT:51BC
SYSINIT:51BC </span><span style="color:gray">prnexit</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51BC                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:51BC </span>badfil          <span style="color:black">endp
SYSINIT:51BC
SYSINIT:51BD
SYSINIT:51BD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:51BD
SYSINIT:51BD
SYSINIT:51BD </span>print           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51BD                 </span><span style="color:navy">mov     ah, </span><span style="color:green">9
</span><span style="color:black">SYSINIT:51BF                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - PRINT STRING
<span style="color:black">SYSINIT:51BF                                         </span>; DS:DX -&gt; string terminated by &quot;$&quot;
<span style="color:black">SYSINIT:51C1                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:51C1 </span>print           <span style="color:black">endp
SYSINIT:51C1
SYSINIT:51C2
SYSINIT:51C2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:51C2
SYSINIT:51C2
SYSINIT:51C2 </span>open_dev        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51C2                 </span><span style="color:navy">call    </span>open_file
<span style="color:black">SYSINIT:51C5                 </span><span style="color:navy">jnb     short </span><span style="color:gray">open_dev3
</span><span style="color:black">SYSINIT:51C7
SYSINIT:51C7 </span><span style="color:gray">open_dev1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51C7                 </span><span style="color:navy">mov     dx, offset </span>nuldev <span style="color:gray">; &quot;NUL&quot;
</span><span style="color:black">SYSINIT:51CA                 </span><span style="color:navy">call    </span>open_file
<span style="color:black">SYSINIT:51CD
SYSINIT:51CD </span><span style="color:gray">of_retn</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51CD                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:51CE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">SYSINIT:51CE
SYSINIT:51CE </span><span style="color:gray">open_dev3</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51CE                 </span><span style="color:navy">mov     bx, ax          </span>; handle from open to bx
<span style="color:black">SYSINIT:51D0                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">SYSINIT:51D2                 </span><span style="color:navy">mov     ah, </span><span style="color:green">44h
</span><span style="color:black">SYSINIT:51D4                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - IOCTL - GET DEVICE INFORMATION
<span style="color:black">SYSINIT:51D4                                         </span>; BX = file or device handle
<span style="color:black">SYSINIT:51D6                 </span><span style="color:navy">test    dl, </span><span style="color:green">80h
</span><span style="color:black">SYSINIT:51D9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">of_retn
</span><span style="color:black">SYSINIT:51DB                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:black">SYSINIT:51DD                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:black">SYSINIT:51DD                                         </span>; BX = file handle
<span style="color:black">SYSINIT:51DF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">open_dev1
</span><span style="color:black">SYSINIT:51DF </span>open_dev        <span style="color:black">endp
SYSINIT:51DF
SYSINIT:51E1
SYSINIT:51E1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">SYSINIT:51E1
SYSINIT:51E1
SYSINIT:51E1 </span>open_file       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">SYSINIT:51E1                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Dh         </span>; OPEN
<span style="color:black">SYSINIT:51E3                 </span><span style="color:navy">stc
</span><span style="color:black">SYSINIT:51E4                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - OPEN DISK FILE WITH HANDLE
<span style="color:black">SYSINIT:51E4                                         </span>; DS:DX -&gt; ASCIZ filename
<span style="color:black">SYSINIT:51E4                                         </span>; AL = access mode
<span style="color:black">SYSINIT:51E4                                         </span>; 0 - read, 1 - write, 2 - read &amp; write
<span style="color:black">SYSINIT:51E6                 </span><span style="color:navy">retn
</span><span style="color:black">SYSINIT:51E6 </span>open_file       <span style="color:black">endp
SYSINIT:51E6
</span><span style="color:maroon">SYSINIT:51E7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">SYSINIT:51E7
SYSINIT:51E7 </span>int24<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">SYSINIT:51E7                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; fail the system call
<span style="color:maroon">SYSINIT:51E9                 </span><span style="color:navy">iret                    </span>; return back to dos.
<span style="color:maroon">SYSINIT:51E9 </span><span style="color:gray">; ---------------------------------------------------------------------------
SYSINIT:51EA </span>IBMDOSV71COPYR  <span style="color:navy">db &#039;IBM DOS Version 7.1 (C)Copyright 1981-2002 IBM Corporation Licens&#039;
</span><span style="color:gray">SYSINIT:51EA                 </span><span style="color:navy">db &#039;ed Material - Property of IBM All rights reserved &#039;
</span><span style="color:gray">SYSINIT:525D </span>nuldev          <span style="color:navy">db &#039;NUL&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5261 </span>condev          <span style="color:navy">db &#039;CON&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5265 </span>auxdev          <span style="color:navy">db &#039;AUX&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5269 </span>prndev          <span style="color:navy">db &#039;PRN&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:526D </span>config          <span style="color:navy">db &#039;\CONFIG.SYS&#039;,0      </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5279 </span>cntry_drv       <span style="color:navy">db &#039;A:&#039;                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:527B </span>cntry_root      <span style="color:navy">db &#039;</span><span style="color:green">\&#039;                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:527C </span>cntry_path      <span style="color:navy">db &#039;COUNTRY.SYS&#039;,0      </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5288                 </span><span style="color:navy">db </span><span style="color:#008040">52 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:52BC </span>country_file_signature <span style="color:navy">db </span><span style="color:green">0FFh</span><span style="color:navy">,&#039;</span><span style="color:green">COUNTRY&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:52C4 </span>cntrycodepage_id <span style="color:navy">dw </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:52C6 </span>newcmd          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:52C6                                         </span>; non-zero if non-std shell specified
<span style="color:gray">SYSINIT:52C7 </span>tmplate         <span style="color:navy">db </span><span style="color:#008040">64</span><span style="color:navy">, </span><span style="color:#008040">12               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:52C7                                         </span>; must precede commnd
<span style="color:gray">SYSINIT:52C7                                         </span>; size of commnd line (excl. null)
<span style="color:gray">SYSINIT:52C7                                         </span>; 5309h-52C9h = 40h = 64
<span style="color:gray">SYSINIT:52C9 </span>commnd          <span style="color:navy">db &#039;\COMMAND.COM&#039;,0     </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:52D6                 </span><span style="color:navy">db </span><span style="color:#008040">50 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:5308 </span>commnd_63       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5309 </span>commnd2         <span style="color:navy">db &#039;\COMMAND.COM&#039;,0     </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5309                                         </span>; alternate commands to exec
<span style="color:gray">SYSINIT:5316                 </span><span style="color:navy">db </span><span style="color:green">2</span><span style="color:navy">,&#039;</span><span style="color:green">/P&#039;</span><span style="color:navy">,</span><span style="color:green">0             </span>; followed by their respective alternate command lines
<span style="color:gray">SYSINIT:531A </span>commnd3         <span style="color:navy">db &#039;\MSDOS\COMMAND.COM&#039;,0 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:532D                 </span><span style="color:navy">db </span><span style="color:#008040">11
</span><span style="color:gray">SYSINIT:532E                 </span><span style="color:navy">db &#039;A:\MSDOS /P&#039;,0
</span><span style="color:gray">SYSINIT:533A </span>commnd4         <span style="color:navy">db &#039;\DOS\COMMAND.COM&#039;,0 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:534B                 </span><span style="color:navy">db </span><span style="color:#008040">9
</span><span style="color:gray">SYSINIT:534C                 </span><span style="color:navy">db &#039;A:\DOS /P&#039;,0
</span><span style="color:gray">SYSINIT:5356 </span>def_swchr       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5357 </span>command_line    <span style="color:navy">db </span><span style="color:green">2</span><span style="color:navy">,&#039;</span><span style="color:green">/P&#039;               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:535A                 </span><span style="color:navy">db </span><span style="color:#008040">123 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:53D5 </span>command_line_126 <span style="color:navy">db </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:53D6                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:53D7 </span>pathstring      <span style="color:navy">db </span><span style="color:#008040">64 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:5417 </span>dae_flag        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5418 </span>bMenuColor      <span style="color:navy">db </span><span style="color:#008040">7                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5418                                         </span>; default fgnd/bgnd color
<span style="color:gray">SYSINIT:5419 </span>bMenuPage       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5419                                         </span>; menu video page (KEEP AFTER bMenuColor)
<span style="color:gray">SYSINIT:541A                 </span><span style="color:navy">db </span><span style="color:#008040">5                    </span>; video page function # (KEEP AFTER bMenuPage)
<span style="color:gray">SYSINIT:541B </span>bLastCol        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:541B                                         </span>; ending column on status line
<span style="color:gray">SYSINIT:541C </span>bLastRow        <span style="color:navy">db </span><span style="color:#008040">24                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:541C                                         </span>; row # of status line (KEEP AFTER bLastCol)
<span style="color:gray">SYSINIT:541D </span>bDisableUI      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:541D                                         </span>; 1=disable clean/interactive
<span style="color:gray">SYSINIT:541D                                         </span>; 2=disable default 2-second delay
<span style="color:gray">SYSINIT:541E </span>bCRTPage        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:541E                                         </span>; value saved from BIOS data area
<span style="color:gray">SYSINIT:541F </span>wCRTStart       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:541F                                         </span>; value saved from BIOS data area
<span style="color:gray">SYSINIT:5421 </span>bQueryOpt       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5421                                         </span>; 0=off, 1=prompt all, 2=prompt none, 4=skip all
<span style="color:gray">SYSINIT:5422 </span>bDefBlock       <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5422                                         </span>; default block #
<span style="color:gray">SYSINIT:5423 </span>bMaxBlock       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5423                                         </span>; maximum block #
<span style="color:gray">SYSINIT:5424 </span>offDefBlock     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5424                                         </span>; offset of name of default block (if any)
<span style="color:gray">SYSINIT:5426 </span>secTimeOut      <span style="color:navy">db </span><span style="color:#008040">0FFh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5426                                         </span>; # of seconds for timeout (-1 == indefinite)
<span style="color:gray">SYSINIT:5427 </span>secElapsed      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5427                                         </span>; # of seconds elapsed so far (KEEP AFTER secTimeOut)
<span style="color:gray">SYSINIT:5428 </span>abBlockType     <span style="color:navy">db </span><span style="color:#008040">10 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5428                                         </span>; times MAX_MULTI_CONFIG+1 db 0
<span style="color:gray">SYSINIT:5428                                         </span>; array of block types
<span style="color:gray">SYSINIT:5432 </span>aoffBlockName   <span style="color:navy">dw </span><span style="color:#008040">10 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5432                                         </span>; times MAX_MULTI_CONFIG+1 dw 0
<span style="color:gray">SYSINIT:5432                                         </span>; array of offsets of block names
<span style="color:gray">SYSINIT:5446 </span>aoffBlockDesc   <span style="color:navy">dw </span><span style="color:#008040">10 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5446                                         </span>; times MAX_MULTI_CONFIG+1 dw 0
<span style="color:gray">SYSINIT:5446                                         </span>; array of offsets of block descriptions
<span style="color:gray">SYSINIT:545A </span>szBoot          <span style="color:navy">db &#039;CONFIG=&#039;,0          </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5462 </span>szMenu          <span style="color:navy">db &#039;MENU&#039;,0             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5467 </span>szCommon        <span style="color:navy">db &#039;COMMON&#039;,0           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:546E </span>comtab          <span style="color:navy">db </span><span style="color:green">1</span><span style="color:navy">,&#039;</span><span style="color:green">[[&#039;               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:546E                                         </span>; CONFIG.SYS Command Table
<span style="color:gray">SYSINIT:546E                                         </span>; CONFIG_BEGIN
<span style="color:gray">SYSINIT:5471 </span>aBreak          <span style="color:navy">db </span><span style="color:green">5</span><span style="color:navy">,&#039;</span><span style="color:green">BREAKC&#039;           </span>; CONFIG_BREAK
<span style="color:gray">SYSINIT:5478 </span>aBuffers        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">BUFFERSB&#039;         </span>; CONFIG_BUFFERS
<span style="color:gray">SYSINIT:5481 </span>aComment        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">COMMENTY&#039;         </span>; CONFIG_COMMENT
<span style="color:gray">SYSINIT:548A </span>aCountry        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">COUNTRYQ&#039;         </span>; CONFIG_COUNTRY
<span style="color:gray">SYSINIT:5493 </span>aDevice         <span style="color:navy">db </span><span style="color:green">6</span><span style="color:navy">,&#039;</span><span style="color:green">DEVICED&#039;          </span>; CONFIG_DEVICE
<span style="color:gray">SYSINIT:549B </span>aDevicehigh     <span style="color:navy">db </span><span style="color:green">0Ah                  </span>; CONFIG_DEVICEHIGH
<span style="color:gray">SYSINIT:549B                 </span><span style="color:navy">db &#039;DEVICEHIGHU&#039;
</span><span style="color:gray">SYSINIT:54A7 </span>aDos            <span style="color:navy">db </span><span style="color:green">3</span><span style="color:navy">,&#039;</span><span style="color:green">DOSH&#039;             </span>; CONFIG_DOS
<span style="color:gray">SYSINIT:54AC </span>aDrivparm       <span style="color:navy">db </span><span style="color:green">8</span><span style="color:navy">,&#039;</span><span style="color:green">DRIVPARMP&#039;        </span>; CONFIG_DRIVPARM
<span style="color:gray">SYSINIT:54B6 </span>aFcbs           <span style="color:navy">db </span><span style="color:green">4</span><span style="color:navy">,&#039;</span><span style="color:green">FCBSX&#039;            </span>; CONFIG_FCBS
<span style="color:gray">SYSINIT:54BC </span>aFiles          <span style="color:navy">db </span><span style="color:green">5</span><span style="color:navy">,&#039;</span><span style="color:green">FILESF&#039;           </span>; CONFIG_FILES
<span style="color:gray">SYSINIT:54C3 </span>aInclude        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">INCLUDEJ&#039;         </span>; CONFIG_INCLUDE
<span style="color:gray">SYSINIT:54CC </span>aInstall        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">INSTALLI&#039;         </span>; CONFIG_INSTALL
<span style="color:gray">SYSINIT:54D5 </span>aInstallhigh    <span style="color:navy">db </span><span style="color:green">0Bh</span><span style="color:navy">,&#039;</span><span style="color:green">INSTALLHIGHW&#039;   </span>; CONFIG_INSTALLHIGH
<span style="color:gray">SYSINIT:54E2 </span>aLastdrive      <span style="color:navy">db </span><span style="color:green">9</span><span style="color:navy">,&#039;</span><span style="color:green">LASTDRIVEL&#039;       </span>; CONFIG_LASTDRIVE
<span style="color:gray">SYSINIT:54ED </span>aSubmenu        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">SUBMENUO&#039;         </span>; CONFIG_SUBMENU
<span style="color:gray">SYSINIT:54F6 </span>aMenucolor      <span style="color:navy">db </span><span style="color:green">9</span><span style="color:navy">,&#039;</span><span style="color:green">MENUCOLORR&#039;       </span>; CONFIG_MENUCOLOR
<span style="color:gray">SYSINIT:5501 </span>aMenudefault    <span style="color:navy">db </span><span style="color:green">0Bh</span><span style="color:navy">,&#039;</span><span style="color:green">MENUDEFAULTA&#039;   </span>; CONFIG_MENUDEFAULT
<span style="color:gray">SYSINIT:550E </span>aMenuitem       <span style="color:navy">db </span><span style="color:green">8</span><span style="color:navy">,&#039;</span><span style="color:green">MENUITEME&#039;        </span>; CONFIG_MENUITEM
<span style="color:gray">SYSINIT:5518 </span>aMultitrack     <span style="color:navy">db </span><span style="color:green">0Ah                  </span>; CONFIG_MULTITRACK
<span style="color:gray">SYSINIT:5518                 </span><span style="color:navy">db &#039;MULTITRACKM&#039;
</span><span style="color:gray">SYSINIT:5524 </span>aNumlock        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">NUMLOCKN&#039;         </span>; CONFIG_NUMLOCK
<span style="color:gray">SYSINIT:552D </span>aRem            <span style="color:navy">db </span><span style="color:green">3</span><span style="color:navy">,&#039;</span><span style="color:green">REM0&#039;             </span>; CONFIG_REM
<span style="color:gray">SYSINIT:5532 </span>aSet            <span style="color:navy">db </span><span style="color:green">3</span><span style="color:navy">,&#039;</span><span style="color:green">SETV&#039;             </span>; CONFIG_SET
<span style="color:gray">SYSINIT:5537 </span>aShell          <span style="color:navy">db </span><span style="color:green">5</span><span style="color:navy">,&#039;</span><span style="color:green">SHELLS&#039;           </span>; CONFIG_SHELL
<span style="color:gray">SYSINIT:553E </span>aStacks         <span style="color:navy">db </span><span style="color:green">6</span><span style="color:navy">,&#039;</span><span style="color:green">STACKSK&#039;          </span>; CONFIG_STACKS
<span style="color:gray">SYSINIT:5546 </span>aSwitches       <span style="color:navy">db </span><span style="color:green">8</span><span style="color:navy">,&#039;</span><span style="color:green">SWITCHES1&#039;        </span>; CONFIG_SWITCHES
<span style="color:gray">SYSINIT:5550 </span>aDosdata        <span style="color:navy">db </span><span style="color:green">7</span><span style="color:navy">,&#039;</span><span style="color:green">DOSDATAT&#039;         </span>; CONFIG_DOSDATA
<span style="color:gray">SYSINIT:5559                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; end of command table
<span style="color:gray">SYSINIT:555A </span>devp_specialfunc <span style="color:navy">db </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:555A                                         </span>; deviceparameters
<span style="color:gray">SYSINIT:555B </span>devp_devtype    <span style="color:navy">db </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:555C </span>devp_devattr    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:555E </span>devp_cylinders  <span style="color:navy">dw </span><span style="color:#008040">80                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5560                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5561 </span>devp_bps        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5561                                         </span>; A_DEVICEPARAMETERS.DP_BPB
<span style="color:gray">SYSINIT:5561                                         </span>; bytes per sectors
<span style="color:gray">SYSINIT:5563 </span>devp_secperclus <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5564                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5566                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5567                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5569 </span>devp_totalsecs  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5569                                         </span>; total sectors
<span style="color:gray">SYSINIT:556B </span>devp_mediaid    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:556C                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:556E </span>devp_spt        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5570 </span>devp_heads      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5572                 </span><span style="color:navy">db </span><span style="color:#008040">68 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:55B6 </span>devp_trktblents <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:55B8                 </span><span style="color:navy">db </span><span style="color:#008040">252 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:56B4 </span>hlim            <span style="color:navy">dw </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:56B6 </span>slim            <span style="color:navy">dw </span><span style="color:#008040">9                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:56B8 </span>drive           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:56B9 </span>switches        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:56BB </span>_bpb48t         <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:56BB                                         </span>; 48 tpi diskettes
<span style="color:gray">SYSINIT:56BD                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56BE                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:56C0                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56C1                 </span><span style="color:navy">dw </span><span style="color:#008040">112
</span><span style="color:gray">SYSINIT:56C3                 </span><span style="color:navy">dw </span><span style="color:#008040">720                  </span>; 2*9*40
<span style="color:gray">SYSINIT:56C5                 </span><span style="color:navy">db </span><span style="color:#008040">0FDh
</span><span style="color:gray">SYSINIT:56C6                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56C8                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">SYSINIT:56CA                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56CC                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:56D0                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:56D4 </span>_bpb96t         <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:56D4                                         </span>; 96tpi diskettes
<span style="color:gray">SYSINIT:56D6                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:56D7                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:56D9                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56DA                 </span><span style="color:navy">dw </span><span style="color:#008040">224
</span><span style="color:gray">SYSINIT:56DC                 </span><span style="color:navy">dw </span><span style="color:#008040">2400                 </span>; 2*15*80
<span style="color:gray">SYSINIT:56DE                 </span><span style="color:navy">db </span><span style="color:#008040">0F9h
</span><span style="color:gray">SYSINIT:56DF                 </span><span style="color:navy">dw </span><span style="color:#008040">7
</span><span style="color:gray">SYSINIT:56E1                 </span><span style="color:navy">dw </span><span style="color:#008040">15
</span><span style="color:gray">SYSINIT:56E3                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56E5                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:56E9                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:56ED </span>_bpb35          <span style="color:navy">dw </span><span style="color:#008040">200h                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:56ED                                         </span>; 3 1/2 inch diskette bpb
<span style="color:gray">SYSINIT:56EF                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56F0                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:56F2                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56F3                 </span><span style="color:navy">dw </span><span style="color:#008040">112
</span><span style="color:gray">SYSINIT:56F5                 </span><span style="color:navy">dw </span><span style="color:#008040">1440                 </span>; 2*9*80
<span style="color:gray">SYSINIT:56F7                 </span><span style="color:navy">db </span><span style="color:#008040">0F9h
</span><span style="color:gray">SYSINIT:56F8                 </span><span style="color:navy">dw </span><span style="color:#008040">3
</span><span style="color:gray">SYSINIT:56FA                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">SYSINIT:56FC                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:56FE                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5702                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5706 </span>_bpb35h         <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5708                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:5709                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:570B                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:570C                 </span><span style="color:navy">dw </span><span style="color:#008040">224
</span><span style="color:gray">SYSINIT:570E                 </span><span style="color:navy">dw </span><span style="color:#008040">2880                 </span>; 2*18*80
<span style="color:gray">SYSINIT:5710                 </span><span style="color:navy">db </span><span style="color:#008040">0F0h
</span><span style="color:gray">SYSINIT:5711                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">SYSINIT:5713                 </span><span style="color:navy">dw </span><span style="color:#008040">18
</span><span style="color:gray">SYSINIT:5715                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:5717                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:571B                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:571F </span>_bpb288         <span style="color:navy">dw </span><span style="color:#008040">512                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5721                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:5722                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">SYSINIT:5724                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:5725                 </span><span style="color:navy">dw </span><span style="color:#008040">240
</span><span style="color:gray">SYSINIT:5727                 </span><span style="color:navy">dw </span><span style="color:#008040">5760                 </span>; 2*36*80
<span style="color:gray">SYSINIT:5729                 </span><span style="color:navy">db </span><span style="color:#008040">0F0h
</span><span style="color:gray">SYSINIT:572A                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">SYSINIT:572C                 </span><span style="color:navy">dw </span><span style="color:#008040">36
</span><span style="color:gray">SYSINIT:572E                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">SYSINIT:5730                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5734                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5738 </span>_bpbtable       <span style="color:navy">dw offset </span>_bpb48t       <span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5738                                         </span>; 48tpi drives
<span style="color:gray">SYSINIT:573A                 </span><span style="color:navy">dw offset </span>_bpb96t       ; 96tpi drives
<span style="color:gray">SYSINIT:573C                 </span><span style="color:navy">dw offset </span>_bpb35        ; 3.5&quot; drives
<span style="color:gray">SYSINIT:573E                 </span><span style="color:navy">dw offset </span>_bpb35        ; not used - 8&quot; drives - default to 3.5&quot;
<span style="color:gray">SYSINIT:5740                 </span><span style="color:navy">dw offset </span>_bpb35        ; not used - 8&quot; drives - default to 3.5&quot;
<span style="color:gray">SYSINIT:5742                 </span><span style="color:navy">dw offset </span>_bpb35        ; not used - hard files - default to 3.5&quot;
<span style="color:gray">SYSINIT:5744                 </span><span style="color:navy">dw offset </span>_bpb35        ; not used - tape drives - default to 3.5&quot;
<span style="color:gray">SYSINIT:5746                 </span><span style="color:navy">dw offset </span>_bpb35h       ; 3-1/2&quot; 1.44mb drive
<span style="color:gray">SYSINIT:5748                 </span><span style="color:navy">dw offset </span>_bpb35        ; ERIMO
<span style="color:gray">SYSINIT:574A                 </span><span style="color:navy">dw offset </span>_bpb288       ; 2.88 MB diskette drives
<span style="color:gray">SYSINIT:574C </span>switchlist      <span style="color:navy">db </span><span style="color:green">8</span><span style="color:navy">,&#039;</span><span style="color:green">FHSTDICN&#039;         </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:574C                                         </span>; preserve the positions of n and c
<span style="color:gray">SYSINIT:5755                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">SYSINIT:5756 </span>badopm          <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5756                 </span><span style="color:navy">db &#039;Unrecognized command in CONFIG.SYS&#039;
</span><span style="color:gray">SYSINIT:577A </span>crlfm           <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah</span><span style="color:navy">,&#039;</span><span style="color:green">$&#039;          </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:577D </span>badparm         <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:577D                 </span><span style="color:navy">db &#039;Bad command or parameters - $&#039;
</span><span style="color:gray">SYSINIT:579C </span>badsiz_pre      <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:579C                 </span><span style="color:navy">db &#039;Sector size too large in file $&#039;
</span><span style="color:gray">SYSINIT:57BD </span>badld_pre       <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:57BD                 </span><span style="color:navy">db &#039;Bad or missing $&#039;
</span><span style="color:gray">SYSINIT:57CF </span>badcom          <span style="color:navy">db &#039;Command Interpreter&#039;,0 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:57E3 </span>badcountry      <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:57E3                 </span><span style="color:navy">db &#039;Invalid country code or code page&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">SYSINIT:5809 </span>badcountrycom   <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5809                 </span><span style="color:navy">db &#039;Error in COUNTRY command&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">SYSINIT:5826 </span>insufmemory     <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5826                 </span><span style="color:navy">db &#039;Insufficient memory for COUNTRY.SYS file&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">SYSINIT:5853 </span>badmem          <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5853                 </span><span style="color:navy">db &#039;Configuration too large for memory&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">SYSINIT:587A </span>badblock        <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:587A                 </span><span style="color:navy">db &#039;Too many block devices&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">SYSINIT:5895 </span>badstack        <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5895                 </span><span style="color:navy">db &#039;Invalid STACK parameters&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">SYSINIT:58B2 </span>badorder        <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:58B2                 </span><span style="color:navy">db &#039;Incorrect order in CONFIG.SYS line $&#039;
</span><span style="color:gray">SYSINIT:58D8 </span>errorcmd        <span style="color:navy">db &#039;Error in CONFIG.SYS line $&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:58F2 </span>OnOff           <span style="color:navy">db &#039;ON&#039;                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:58F4 </span>OnOff2          <span style="color:navy">db &#039;OFF&#039;                </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:58F7 </span>StartMsg        <span style="color:navy">db &#039;Starting PC DOS...&#039;,0Dh,0Ah </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:58F7                 </span><span style="color:navy">db </span><span style="color:green">0Ah</span><span style="color:navy">,</span><span style="color:green">0
</span><span style="color:gray">SYSINIT:590D </span>_$PauseMsg      <span style="color:navy">db &#039;Press any key to continue...&#039;,0Dh,0Ah,&#039;$&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:592C </span>_$CleanMsg      <span style="color:navy">db &#039;PC DOS is bypassing your CONFIG.SYS and AUTOEXEC.BAT files.&#039;,0Dh,0Ah </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:592C                 </span><span style="color:navy">db &#039;$&#039;
</span><span style="color:gray">SYSINIT:596A </span>_$InterMsg      <span style="color:navy">db &#039;PC DOS will prompt you to confirm each CONFIG.SYS command.&#039;,0Dh,0Ah </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:596A                 </span><span style="color:navy">db &#039;$&#039;
</span><span style="color:gray">SYSINIT:59A7 </span>_$MenuHeader    <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:59A7                 </span><span style="color:navy">db &#039;  PC DOS 7.1 Startup Menu&#039;,0Dh,0Ah
</span><span style="color:gray">SYSINIT:59A7                 </span><span style="color:navy">db &#039;  &#039;
</span><span style="color:gray">SYSINIT:59C6                 </span><span style="color:navy">db </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh </span>; &#039;═&#039; ; ASCII code 205
<span style="color:gray">SYSINIT:59C6                 </span><span style="color:navy">db </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh
</span><span style="color:gray">SYSINIT:59C6                 </span><span style="color:navy">db </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">0CDh
</span><span style="color:gray">SYSINIT:59DE                 </span><span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah
</span><span style="color:olive">SYSINIT:59E0                 </span><span style="color:navy">db  </span><span style="color:#008040">24h </span><span style="color:gray">; $
SYSINIT:59E1 </span>_$MenuPrmpt     <span style="color:navy">db &#039;  Enter a choice: $&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:59F4 </span>_$StatusLine    <span style="color:navy">db &#039;F5=Bypass startup files F8=Confirm each line of CONFIG.SYS and AU&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:59F4                 </span><span style="color:navy">db &#039;TOEXEC.BAT [ ]$&#039;
</span><span style="color:gray">SYSINIT:5A44 </span>_$InterPrmpt    <span style="color:navy">db &#039; [Y,N,ESC]?$&#039;       </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5A50 </span>_$YES           <span style="color:navy">db &#039;YES$&#039;               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5A54 </span>_$NO            <span style="color:navy">db &#039;NO $&#039;               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5A58 </span>_$TimeOut       <span style="color:navy">db &#039;Time remaining: $&#039;  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5A69 </span>badcomprmpt     <span style="color:navy">db &#039;Enter correct name of Command Interpreter (for example, C:\COMMAN&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5A69                 </span><span style="color:navy">db &#039;D.COM)&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">SYSINIT:5AB3 </span>_$AutoPrmpt     <span style="color:navy">db &#039;Process AUTOEXEC.BAT [Y,N]?$&#039; </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5ACF </span>TooManyDrivesMsg <span style="color:navy">db &#039;WARNING! Logical drives past Z: exist and will be ignored&#039;,0Dh,0Ah </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5ACF                 </span><span style="color:navy">db &#039;$&#039;
</span><span style="color:gray">SYSINIT:5B0B </span>baddblspace     <span style="color:navy">db &#039;Required system component is not installed&#039;,0Dh,0Ah </span><span style="color:#8080ff">; ...
</span><span style="color:gray">SYSINIT:5B0B                 </span><span style="color:navy">db &#039;$&#039;,0
</span><span style="color:gray">SYSINIT:5B39                 </span><span style="color:navy">db </span><span style="color:#008040">7 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">SYSINIT:5B39 </span>SYSINIT         ends
<span style="color:gray">SYSINIT:5B39
SYSINIT:5B39
SYSINIT:5B39                 </span>end
</span></body></html>
