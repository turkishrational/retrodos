     1                                  ; ****************************************************************************
     2                                  ; FDISK3R5.ASM (FDISK3R5.COM) - Retro DOS v5 Hard Disk Partitioning Utility
     3                                  ; fdisk3.s						(for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; Last Update: 15/07/2024
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 11/10/2020
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.15
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Modified from 'FDISK3.ASM' (FDISK3.COM) source code by Erdogan Tan
    12                                  ; (04/05/2024) - TRDOS 386 v2 fixed disk partitioning utility -
    13                                  ; ****************************************************************************
    14                                  ; nasm fdisk3r5.s -l fdisk3r5.txt -o FDISK3R5.COM -Z error.txt
    15                                  
    16                                  ; Masterboot / Partition Table at Beginning+1BEh
    17                                  ptBootable      equ 0
    18                                  ptBeginHead     equ 1
    19                                  ptBeginSector   equ 2
    20                                  ptBeginCylinder equ 3
    21                                  ptFileSystemID	equ 4
    22                                  ptEndHead       equ 5
    23                                  ptEndSector     equ 6
    24                                  ptEndCylinder   equ 7
    25                                  ptStartSector   equ 8
    26                                  ptSectors       equ 12
    27                                  
    28                                  ; BIOS Disk Parameters
    29                                  DPDiskNumber  equ 0h
    30                                  DPDType       equ 1h
    31                                  DPReturn      equ 2h
    32                                  DPHeads       equ 3h
    33                                  DPCylinders   equ 4h
    34                                  DPSecPerTrack equ 6h
    35                                  DPDisks       equ 7h
    36                                  DPTableOff    equ 8h
    37                                  DPTableSeg    equ 0Ah
    38                                  DPNumOfSecs   equ 0Ch
    39                                  
    40                                  ; BIOS INT 13h Extensions (LBA extensions)
    41                                  ; Just After DP Data (DPDiskNumber+)
    42                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    43                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    44                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    45                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    46                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    47                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    48                                                          ; C1= Selected Cylinder Number
    49                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    50                                                          ; H1= Selected Head Number
    51                                                          ; S0= Maximum Sector Number
    52                                                          ; S1= Selected Sector Number
    53                                                          ; QUAD WORD
    54                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    55                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    56                                                               ; TR-DOS will not use 64 bit Flat Address
    57                                  
    58                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    59                                  ; Just After DP Data (DPDiskNumber+)
    60                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
    61                                  GDP_48h_InfoFlag equ 22h ; Word
    62                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
    63                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
    64                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
    65                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
    66                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
    67                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
    68                                  
    69                                  pTableOffset equ 1BEh ; 446
    70                                  
    71                                  	; Convert LBA to CHS
    72                                  	; 08/02/2019
    73                                  
    74                                  	; LBA = ((C1*H0+H1)*S0)+S1-1
    75                                  	;
    76                                  	; C1 = Selected Cylinder Number
    77                                  	; H0 = Number of Heads (Maximum Head Number + 1)
    78                                  	; H1 = Selected Head Number
    79                                  	; S0 = Maximum Sector Number
    80                                  	; S1 = Selected Sector Number
    81                                  	;
    82                                  	; Phoenix, Enchanced Disk Drive Specicifications, v1.1, Page 8)
    83                                  		
    84                                  
    85                                  [BITS 16]
    86                                  [ORG 100h]
    87                                  
    88                                  	;cli
    89                                  	;cld
    90                                  	;push	cs
    91                                  	;pop	ss
    92                                  	;mov	sp, 0FFFEh
    93                                  	;sti
    94                                  	
    95                                  	;mov	bx, SizeOfFile+100
    96                                  	
    97 00000000 BB[C470]                	mov	bx, bss_end
    98                                  
    99 00000003 83C30F                          add	bx, 15
   100 00000006 D1EB                            shr	bx, 1
   101 00000008 D1EB                            shr	bx, 1
   102 0000000A D1EB                    	shr	bx, 1
   103 0000000C D1EB                    	shr	bx, 1
   104 0000000E B44A                            mov	ah, 4Ah ; modify memory allocation
   105                                          ;push	cs
   106                                          ;pop	es
   107 00000010 CD21                            int	21h
   108                                  
   109                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   110                                  ; clear BSS
   111                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   112                                  ; 03/02/2019
   113                                  
   114                                  	;mov	cx, bss_end
   115 00000012 B9[946F]                	mov	cx, bss_clear_end ; 15/02/2019
   116                                  
   117 00000015 BF[5268]                	mov	di, bss_start
   118 00000018 29F9                    	sub	cx, di
   119 0000001A 41                      	inc	cx
   120 0000001B D1E9                    	shr	cx, 1
   121 0000001D 31C0                    	xor	ax, ax
   122 0000001F F3AB                    	rep	stosw 
   123                                  
   124                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   125                                  ; display program name & version
   126                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   127                                  
   128 00000021 BE[8243]                	mov	si, TrDOS_Welcome
   129 00000024 E86B1B                  	call	print_msg
   130                                  
   131                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   132                                  ; get hard disk name
   133                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   134                                  ; 11/10/2020
   135                                  
   136 00000027 BE8000                  	mov	si, 80h			; PSP command tail
   137 0000002A AC                       	lodsb
   138 0000002B 08C0                    	or	al, al 			; command tail length
   139 0000002D 7431                    	jz	short A_05		; jump if zero
   140                                  A_01:
   141 0000002F AC                      	lodsb
   142 00000030 3C20                    	cmp	al, ' '			; is it SPACE ?
   143 00000032 74FB                    	je	short A_01
   144 00000034 722A                    	jb	short A_05
   145                                  	
   146                                  	; check disk name
   147                                  
   148 00000036 3C68                    	cmp	al, 'h'
   149 00000038 751B                    	jne	short A_03
   150 0000003A 803C64                  	cmp	byte [si], 'd'
   151 0000003D 7516                    	jne	short A_03
   152 0000003F 46                      	inc	si
   153 00000040 AC                      	lodsb
   154 00000041 3C30                    	cmp	al, '0'
   155 00000043 7406                    	je	short A_02
   156 00000045 720E                    	jb	short A_03
   157 00000047 3C33                    	cmp	al, '3'
   158 00000049 770A                    	ja	short A_03
   159                                  A_02:
   160 0000004B 803C20                  	cmp	byte [si], ' '
   161 0000004E 720B                    	jb	short A_04
   162 00000050 7703                    	ja	short A_03
   163 00000052 46                      	inc	si
   164 00000053 EBF6                    	jmp	short A_02
   165                                  A_03:
   166 00000055 BE[E343]                	mov	si, TrDOS_Usage
   167 00000058 E94F07                  	jmp	_p_exit
   168                                  A_04:
   169 0000005B 0450                    	add	al, 80h - '0'
   170 0000005D A2[5268]                	mov	[DrvNum], al	; 80h .. 83h
   171                                  
   172                                  A_05:
   173                                  
   174                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   175                                  ; get hard disk parameters 
   176                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   177                                  ; 11/10/2020
   178                                  
   179                                  	; check bios int 13h extensions
   180 00000060 B441                    	mov	ah, 41h
   181 00000062 BBAA55                  	mov	bx, 55AAh
   182 00000065 B280                    	mov	dl, 80h
   183 00000067 CD13                    	int	13h
   184 00000069 720B                    	jc	short A_06
   185 0000006B 81FB55AA                	cmp	bx, 0AA55h
   186 0000006F 7505                    	jne	short A_06
   187                                  
   188 00000071 C606[6A31]01            	mov	byte [int13h_x], 1
   189                                  A_06:
   190                                  	;mov	dl, 80h	 ; hd0
   191 00000076 B408                    	mov	ah, 08h  ; return disk parameters
   192 00000078 CD13                    	int	13h	
   193 0000007A 7313                    	jnc	short A_10
   194                                  A_07:
   195 0000007C 803E[5268]80            	cmp 	byte [DrvNum], 80h  ; hard disk name option ?
   196 00000081 7206                    	jb	short A_09 ; no, default
   197                                  A_08:
   198 00000083 BE[D863]                	mov	si, msg_drv_not_ready ; drive not ready
   199 00000086 E92107                  	jmp	_p_exit
   200                                  A_09:
   201 00000089 BE[0264]                	mov	si, msg_not_any_disks ; there is not a hard disk
   202 0000008C E91B07                  	jmp	_p_exit
   203                                  A_10:
   204 0000008F 08E4                    	or	ah, ah	 ; ah = 0 ?	
   205 00000091 75E9                    	jnz	short A_07  ; no, there is an error !
   206                                  	
   207 00000093 8816[5368]              	mov	[hdc], dl ; number of hard disks
   208                                  
   209 00000097 A0[5268]                	mov	al, [DrvNum]
   210                                  
   211 0000009A 3C80                    	cmp	al, 80h
   212 0000009C 7308                    	jnb	short A_11 ; option
   213                                  	; default
   214 0000009E C606[5268]80            	mov	byte [DrvNum], 80h
   215 000000A3 E98F00                  	jmp	A_14
   216                                  A_11:
   217                                  	; hard disk name option
   218 000000A6 80C27F                  	add	dl, 7Fh
   219                                  
   220 000000A9 38D0                    	cmp	al, dl
   221 000000AB 77D6                    	ja	short A_08
   222                                  
   223 000000AD 80FA80                  	cmp	dl, 80h
   224 000000B0 760C                    	jna	short A_13 ; hd0 parameters are ready
   225                                  A_12:
   226 000000B2 88C2                    	mov	dl, al ; [DrvNum]
   227                                  
   228 000000B4 B408                    	mov	ah, 08h  ; return (get) disk parameters
   229 000000B6 CD13                    	int	13h	
   230 000000B8 72C2                    	jc	short A_07
   231 000000BA 08E4                    	or	ah, ah
   232 000000BC 75BE                    	jnz	short A_07
   233                                  A_13:
   234 000000BE 88C8                    	mov	al, cl
   235 000000C0 243F                    	and	al, 3Fh ; 63
   236 000000C2 C0E906                  	shr	cl, 6
   237 000000C5 86E9                    	xchg	ch, cl
   238 000000C7 41                      	inc	cx
   239 000000C8 41                      	inc	cx ; 15/10/2020 ; BIOS BugFix 
   240                                  				; (for reserved last cylinder)
   241 000000C9 890E[823F]              	mov	[cylinders], cx
   242                                  	;mov	word [cylinders+2], 0 ; 16/10/2020
   243 000000CD FEC6                    	inc	dh
   244 000000CF 8836[803F]              	mov	[heads], dh	
   245 000000D3 A2[7E3F]                	mov	[sectors], al
   246 000000D6 F6E6                    	mul	dh
   247 000000D8 A3[146D]                	mov	[hs], ax ; heads*sectors ; 15/10/2020
   248 000000DB F7E1                    	mul	cx
   249 000000DD A3[5668]                	mov	[disksize], ax
   250 000000E0 8916[5868]              	mov	[disksize+2], dx
   251 000000E4 83E801                  	sub	ax, 1	; 17/10/2020
   252 000000E7 83DA00                  	sbb	dx, 0
   253 000000EA A3[5A68]                	mov	[chs_limit], ax	
   254 000000ED 8916[5C68]              	mov	[chs_limit+2], dx
   255                                  
   256 000000F1 803E[6A31]01            	cmp	byte [int13h_x], 1
   257 000000F6 0F82D700                	jb	A_20
   258                                  
   259 000000FA BE[A870]                	mov	si, gdp_buffer
   260                                  	;mov	word [si], 30 ; buffer length (minimum)
   261 000000FD C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   262 00000101 B448                    	mov	ah, 48h
   263 00000103 8A16[5268]              	mov	dl, [DrvNum]
   264 00000107 CD13                    	int	13h
   265 00000109 0F82C400                	jc	A_20
   266 0000010D 20E4                    	and	ah, ah
   267 0000010F 0F85BE00                	jnz	A_20
   268                                  
   269                                  	; number of physical sectors
   270 00000113 8B4410                  	mov	ax, [si+16]
   271 00000116 8B5412                  	mov	dx, [si+18]
   272 00000119 A3[5668]                	mov	[disksize], ax
   273 0000011C 8916[5868]              	mov	[disksize+2], dx
   274                                  
   275                                  	; 15/10/2020
   276 00000120 8B0E[146D]              	mov	cx, [hs]
   277 00000124 E8560B                  	call	div32
   278                                  	; 16/10/2020
   279                                  	;mov	[lba_cyls], ax
   280                                  	;mov	[lba_cyls+2], dx
   281 00000127 A3[823F]                	mov	[cylinders], ax
   282 0000012A 8916[843F]              	mov	[cylinders+2], dx
   283 0000012E 891E[5E68]              	mov	[lba_chs_remain], bx
   284                                  
   285 00000132 E99C00                  	jmp	A_20	
   286                                  A_14:
   287 00000135 80FA01                  	cmp	dl, 1
   288 00000138 7684                    	jna	short A_13 ; [DrvNum] = 80h
   289                                  
   290 0000013A 80C230                  	add	dl, '0' ; '2' to '4'
   291 0000013D 8816[A844]              	mov	byte [TrDOS_dnmax], dl
   292                                  
   293 00000141 BE[8A44]                	mov	si, TrDOS_Options
   294 00000144 E84B1A                  	call	print_msg
   295                                  
   296                                  	; check bios int 13h extensions
   297 00000147 803E[6A31]01            	cmp	byte [int13h_x], 1
   298 0000014C 732D                    	jnb	short A_16
   299                                  A_15:
   300 0000014E 8A16[5268]              	mov	dl, [DrvNum]
   301 00000152 B408                    	mov	ah, 08h  ; return disk parameters
   302 00000154 CD13                    	int	13h	
   303 00000156 724D                    	jc	short A_17
   304 00000158 08E4                    	or	ah, ah
   305 0000015A 7549                    	jnz	short A_17
   306                                  
   307 0000015C 88C8                    	mov	al, cl
   308 0000015E 243F                    	and	al, 3Fh ; 63
   309 00000160 C0E906                  	shr	cl, 6
   310 00000163 86E9                    	xchg	ch, cl
   311 00000165 41                      	inc	cx
   312 00000166 FEC6                    	inc	dh
   313 00000168 F6E6                    	mul	dh
   314 0000016A F7E1                    	mul	cx
   315                                  
   316                                  	; dx:ax = disk size
   317                                  
   318 0000016C E89D02                  	call	display_hd_row	
   319                                  
   320 0000016F FE0E[5368]              	dec	byte [hdc]
   321 00000173 7430                    	jz	short A_17
   322 00000175 FE06[5268]              	inc	byte [DrvNum]
   323 00000179 EBD3                    	jmp	short A_15
   324                                  A_16:
   325 0000017B BE[A870]                	mov	si, gdp_buffer
   326                                  	;mov	word [si], 30 ; buffer length (minimum)
   327 0000017E C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   328 00000182 B448                    	mov	ah, 48h
   329 00000184 8A16[5268]              	mov	dl, [DrvNum]
   330 00000188 CD13                    	int	13h
   331 0000018A 72C2                    	jc	short A_15
   332 0000018C 20E4                    	and	ah, ah
   333 0000018E 75BE                    	jnz	short A_15
   334                                  
   335                                  	; number of phsical sectors
   336 00000190 8B4410                  	mov	ax, [si+16]
   337 00000193 8B5412                  	mov	dx, [si+18]
   338                                  
   339                                  	; dx:ax = disk size
   340                                  
   341 00000196 E87302                  	call	display_hd_row	
   342                                  
   343 00000199 FE0E[5368]              	dec	byte [hdc]
   344 0000019D 7406                    	jz	short A_17
   345 0000019F FE06[5268]              	inc	byte [DrvNum]
   346 000001A3 EBD6                    	jmp	short A_16
   347                                  A_17:
   348 000001A5 BE[7F55]                	mov	si, CRLF
   349 000001A8 E8E719                  	call	print_msg
   350                                  
   351                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   352                                  ; hard disk number input (getchar)
   353                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   354                                  ; 11/10/2020
   355                                  	
   356                                  A_18:
   357 000001AB 31C0                    	xor	ax, ax
   358 000001AD CD16                    	int	16h			; wait for keyboard command
   359                                  
   360 000001AF 83F800                  	cmp	ax, 0			; CTRL+BREAK
   361 000001B2 761A                    	jna	short A_19
   362                                  
   363 000001B4 3C03                    	cmp	al, 'C'-40h		; 3
   364 000001B6 7416                    	je	short A_19             	; CTRL+C
   365 000001B8 3C1B                    	cmp	al, 27			; ESCape
   366 000001BA 7412                    	je	short A_19
   367                                  
   368 000001BC 3C31                    	cmp	al, '1'			; "(1) hd0" 
   369 000001BE 72EB                    	jb	short A_18		; retry
   370 000001C0 3A06[A844]              	cmp	al, [TrDOS_dnmax]	; ('2' to '4')	
   371 000001C4 77E5                    	ja	short A_18		; retry
   372 000001C6 044F                    	add	al, 80h-'1'		; bios disk num (80h-83h)
   373 000001C8 A2[5268]                	mov	[DrvNum], al
   374 000001CB E9E4FE                  	jmp	A_12			; get disk parameters
   375                                  A_19:
   376 000001CE E9DC05                  	jmp	_exit			; Exit
   377                                  
   378                                  A_20:
   379                                  
   380                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   381                                  ; read masterboot sector
   382                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   383                                  ; 12/10/2020
   384                                  
   385 000001D1 BB[FA55]                	mov	bx, MasterBootBuff
   386 000001D4 B90100                  	mov	cx, 1	; cylinder = 0
   387                                  			; sector = 1
   388 000001D7 B600                    	mov	dh, 0	; head = 0
   389 000001D9 8A16[5268]              	mov	dl, [DrvNum]
   390 000001DD B80102                  	mov	ax, 0201h ; read one sector
   391 000001E0 CD13                    	int	13h
   392 000001E2 7306                    	jnc	short A_21
   393                                  
   394 000001E4 BE[D863]                	mov	si, msg_drv_not_ready ; drive not ready
   395 000001E7 E98700                  	jmp	A_26
   396                                  A_21:
   397                                  
   398                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   399                                  ; display CHS values and disk size (LBA) and partition table
   400                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   401                                  ; 12/10/2020
   402                                  
   403 000001EA B80300                  	mov	ax, 3  ; clear screen
   404 000001ED CD10                    	int	10h
   405                                  
   406 000001EF E81321                  	call	init_partition_table ; 13/10/2020
   407                                  
   408 000001F2 E81C1B                  	call	display_chs_table
   409                                  
   410 000001F5 A1[5668]                	mov	ax, [disksize]
   411 000001F8 8B16[5868]              	mov	dx, [disksize+2]
   412                                  
   413 000001FC 81FA0001                	cmp	dx, 256 ; >= 8GB  
   414 00000200 7315                    	jnb	short A_22
   415                                  
   416                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   417                                  	;div	cx
   418                                  
   419                                  	; shift dx:ax to 8 bits right (/256)
   420 00000202 88E0                    	mov	al, ah
   421 00000204 88D4                    	mov	ah, dl
   422 00000206 C1E803                  	shr	ax, 3 ; /8 
   423                                  		; result = (dx:ax)/2048
   424                                  
   425                                  	; ax =  0 to 8191
   426                                  
   427 00000209 C606[DE44]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   428 0000020E EB11                    	jmp	short A_23
   429                                  
   430                                  
   431                                  A_29:	; 16/10/2020
   432 00000210 E89E27                  	call	partition_table_fix
   433 00000213 73D5                    	jnc	short A_21
   434                                  
   435 00000215 CD20                    	int	20h
   436                                  ;here:	
   437                                  	;jmp	short here
   438                                  
   439                                  A_22:
   440                                  	; 1024 MB = 1GB (2097152 sectors)
   441                                  	; DX/32 --> GB 
   442 00000217 89D0                    	mov	ax, dx
   443 00000219 C1E805                  	shr	ax, 5 ; /32
   444                                  
   445                                  	; ax = 8 to 2047
   446 0000021C C606[DE44]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   447                                  A_23:
   448                                  	;xor	dx, dx
   449 00000221 BE[E444]                	mov	si, TrDOS_hdrow_capacity
   450 00000224 E82402                  	call	convert_to_decimal
   451                                  
   452 00000227 BE[EB44]                	mov	si, TrDOS_disksize
   453 0000022A E86519                  	call	print_msg
   454                                  
   455 0000022D BE[E444]                	mov	si, TrDOS_hdrow_capacity
   456 00000230 E85F19                  	call	print_msg
   457                                  
   458 00000233 BE[DE44]                	mov	si, TrDOS_hdrow_unit
   459 00000236 E85919                  	call	print_msg
   460                                  
   461                                  	; 16/10/2020
   462                                  	;cmp	word [lba_cyls+2], 0
   463 00000239 833E[843F]00            	cmp	word [cylinders+2], 0
   464 0000023E 7736                    	ja	short A_27  ; Huge disk ! number of (lba) cylinders > 65335
   465                                  			    ; Current FDISK version (v3) can not be used !
   466                                  
   467 00000240 BE[7F55]                	mov	si, CRLF
   468 00000243 E84C19                  	call	print_msg
   469                                  
   470 00000246 E8BA25                  	call	dpt_1
   471                                  
   472 00000249 BE[7F55]                	mov	si, CRLF
   473 0000024C E84319                  	call	print_msg
   474                                  
   475                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   476                                  ; display edit or exit option, getchar
   477                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   478                                  
   479 0000024F BE[AE53]                	mov	si, msg_edit_or_exit
   480 00000252 E83D19                  	call	print_msg
   481                                  A_24:
   482 00000255 30E4                    	xor	ah, ah
   483 00000257 CD16                    	int	16h
   484                                  
   485 00000259 3C0D                    	cmp	al, 13 ; CR (ENTER) key
   486 0000025B 744A                    	je	short A_28 
   487                                  
   488 0000025D 3C1B                    	cmp	al, 27 ; ESCape key
   489 0000025F 740D                    	je	short A_25
   490                                  
   491 00000261 3C20                    	cmp	al, 32 ; SPACE key
   492 00000263 7442                    	je	short A_28
   493                                  
   494 00000265 3C03                    	cmp	al, 3 ; CTRL+C
   495 00000267 7405                    	je	short A_25
   496                                  
   497 00000269 83F800                  	cmp	ax, 0 ; CTRL+BREAK
   498 0000026C 77E7                    	ja	short A_24
   499                                  A_25:
   500 0000026E BE[7F55]                	mov	si, CRLF
   501                                  A_26:
   502 00000271 E81E19                  	call	print_msg
   503                                  
   504 00000274 CD20                    	int	20h
   505                                  ;here:
   506                                  ;	jmp	short here
   507                                  
   508                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   509                                  ; display fdisk program disk capacity limit message and then exit
   510                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   511                                  
   512                                  A_27:
   513                                  	; 16/10/2020
   514                                  	; 15/10/2020
   515                                  	; Display FDISK (v3) capacity limit (error) message
   516                                  
   517 00000276 B8FFFF                  	mov	ax, 65535
   518 00000279 F726[146D]              	mul	word [hs]
   519                                  		; 1024 MB = 1GB (2097152 sectors)
   520                                  	; DX/32 --> GB 
   521 0000027D 89D0                    	mov	ax, dx
   522 0000027F C1E805                  	shr	ax, 5 ; /32
   523                                  
   524                                  	; ax = 8 to 2047
   525 00000282 C606[DE44]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   526                                  	;mov	byte [TrDOS_hdrow_unit+1], 'B'
   527 00000287 C606[E044]2E            	mov	byte [TrDOS_hdrow_unit+2], '.'
   528                                  
   529                                  	;xor	dx, dx
   530 0000028C BE[E444]                	mov	si, TrDOS_hdrow_capacity	
   531 0000028F E8B901                  	call	convert_to_decimal
   532                                  
   533 00000292 BE[FA44]                	mov	si, msg_fdisk_capacity_err
   534 00000295 E8FA18                  	call 	print_msg
   535                                  
   536 00000298 BE[E444]                	mov	si, TrDOS_hdrow_capacity
   537 0000029B E8F418                  	call	print_msg
   538                                  
   539 0000029E BE[DE44]                	mov	si, TrDOS_hdrow_unit
   540 000002A1 E8EE18                  	call	print_msg
   541                                  	
   542 000002A4 E90605                  	jmp	_exit
   543                                  
   544                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   545                                  ; check defective pte and then init extended partition table(s)
   546                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   547                                  
   548                                  A_28:
   549 000002A7 E8BE01                  	call	check_defective_partition
   550 000002AA 0F8262FF                	jc	A_29 ; ds:si -> defective pte
   551                                  
   552                                  	; 17/10/2020
   553                                  	; 26/02/2019
   554 000002AE 803E[DF6F]00            	cmp	byte [epnumber], 0
   555 000002B3 7603                    	jna	short A_30
   556                                  
   557 000002B5 E8092D                  	call	init_ext_partition_table
   558                                  A_30:
   559                                  	; 17/10/2020
   560                                  	; 04/02/2019
   561                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   562 000002B8 E83025                  	call	display_partition_table ; 12/03/2021
   563                                  
   564                                  	; 17/10/2020
   565 000002BB 803E[DC6F]00            	cmp	byte [pcount], 0
   566 000002C0 0F86F000                	jna	A_38 ; empty partition table
   567                                  
   568                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   569                                  ; check CHS parms against start sector address and partition size 
   570                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   571                                  
   572                                  A_31:
   573                                  	; Check disk parameters with current CHS settings
   574 000002C4 31DB                    	xor	bx, bx
   575 000002C6 31C9                    	xor	cx, cx
   576                                  A_32:
   577                                  	; 17/10/2020
   578 000002C8 80BF[996F]00            	cmp	byte [part_table_sys_id+bx], 0
   579 000002CD 767C                    	jna	short A_33
   580                                  
   581                                  	; 27/10/2020
   582                                  	;mov	ax, [sectors]
   583                                  	;mul	word [heads]
   584                                  	; dx = 0, ax = heads*sectors
   585                                  
   586 000002CF 8B97[976F]              	mov	dx, [part_table_start_cyl+bx]
   587                                  	; 27/10/2020
   588 000002D3 81FAFF03                	cmp	dx, 1023 ; fixed cylinder number (> 1023)
   589                                  			 ; (partition's start sector is used for fixing)
   590 000002D7 7772                    	ja	short A_33 ; no need to check CHS parms here
   591                                  			; (also, CHS to LBA calculation is not applicable)
   592 000002D9 A1[146D]                	mov	ax, [hs] ; heads*sectors
   593                                  
   594 000002DC F7E2                    	mul	dx
   595                                  		; dx:ax = cylinder*heads*spt
   596 000002DE 89C6                    	mov	si, ax
   597 000002E0 89D7                    	mov	di, dx
   598 000002E2 8A87[956F]              	mov	al, [part_table_start_head+bx]
   599 000002E6 F626[7E3F]              	mul	byte [sectors]
   600 000002EA 01C6                    	add	si, ax
   601 000002EC 83D700                  	adc	di, 0
   602                                  		; di:si = (cylinder*heads*spt) + head*spt
   603 000002EF 8A87[966F]              	mov	al, [part_table_start_sector+bx]
   604 000002F3 30E4                    	xor	ah, ah
   605 000002F5 FEC8                    	dec	al ; 1 -> 0
   606 000002F7 01C6                    	add	si, ax
   607 000002F9 83D700                  	adc	di, 0
   608                                  		; di:si = (cylinder*heads*spt) + head*spt + sector - 1
   609                                  		; (start sector as converted to LBA)
   610                                  
   611 000002FC 3BBF[A06F]              	cmp	di, [part_table_rel_sec_hw+bx]
   612 00000300 7556                    	jne	short A_34 ; Invalid !
   613                                  
   614 00000302 3BB7[9E6F]              	cmp	si, [part_table_rel_sec_lw+bx]
   615 00000306 7550                    	jne	short A_34 ; Invalid !
   616                                  		; di:si = partition's start sector (LBA)
   617                                  
   618                                  	; 27/10/2020
   619                                  	;mov	ax, [sectors]
   620                                  	;mul	word [heads]
   621                                  	; dx = 0, ax = heads*sectors
   622                                  
   623 00000308 8B97[9C6F]              	mov	dx, [part_table_end_cyl+bx]
   624                                  
   625                                  	; 27/10/2020
   626 0000030C 81FAFF03                	cmp	dx, 1023 ; fixed cylinder number (> 1023)
   627                                  			 ; (partition's end sector is used for fixing)
   628 00000310 7739                    	ja	short A_33 ; no need to check CHS parms here
   629                                  			; (also, CHS to LBA calculation is not applicable)
   630 00000312 A1[146D]                	mov	ax, [hs] ; heads*sectors
   631                                  
   632 00000315 F7E2                    	mul	dx
   633                                  		; dx:ax = cylinder*heads*spt
   634 00000317 89C6                    	mov	si, ax
   635 00000319 89D7                    	mov	di, dx
   636 0000031B 8A87[9A6F]              	mov	al, [part_table_end_head+bx]
   637 0000031F F626[7E3F]              	mul	byte [sectors]
   638 00000323 01C6                    	add	si, ax
   639 00000325 83D700                  	adc	di, 0
   640                                  		; di:si = (cylinder*heads*spt) + head*spt
   641 00000328 8A87[9B6F]              	mov	al, [part_table_end_sector+bx]
   642 0000032C 30E4                    	xor	ah, ah
   643                                  	;dec	al ; 63 -> 62
   644 0000032E 01C6                    	add	si, ax
   645 00000330 83D700                  	adc	di, 0
   646                                  		; di:si = (cylinder*heads*spt) + head*spt + sector
   647                                  		; (end sector + 1 as converted to LBA)
   648 00000333 8B87[A26F]              	mov	ax, [part_table_num_sec_lw+bx]
   649 00000337 8B97[A46F]              	mov	dx, [part_table_num_sec_hw+bx]
   650                                  	
   651 0000033B 0387[9E6F]              	add	ax, [part_table_rel_sec_lw+bx]
   652 0000033F 1397[A06F]              	adc	dx, [part_table_rel_sec_hw+bx]
   653                                  		; dx:ax = partition's end sector (LBA) + 1
   654                                  
   655 00000343 39F0                    	cmp	ax, si
   656 00000345 7511                    	jne	short A_34 ; Invalid !
   657                                  
   658 00000347 39FA                    	cmp	dx, di
   659 00000349 750D                    	jne	short A_34 ; Invalid !
   660                                  A_33:
   661 0000034B FEC1                    	inc	cl
   662                                  
   663 0000034D 80F904                  	cmp	cl, 4
   664 00000350 730E                    	jnb	short A_35
   665                                  
   666 00000352 83C312                  	add	bx, 18  ; partition table structure size
   667                                  	
   668 00000355 E970FF                  	jmp	A_32
   669                                  A_34:
   670 00000358 BE[115F]                	mov	si, msg_defective_pt
   671 0000035B E83418                  	call	print_msg
   672 0000035E EB54                    	jmp	short A_38
   673                                  
   674                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   675                                  ; sort MBR partitions
   676                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   677                                  
   678                                  A_35:
   679                                  	; LBA and CHS values of all partitions are OK (here)
   680                                  
   681                                  	; sort MBR (primary) partitions
   682                                  
   683 00000360 E87321                  	call	sort_partition_table
   684                                  
   685                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   686                                  ; Check partition (start, size) overlaps after sorting 
   687                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   688                                  
   689                                  	; Checking partition overlaps (via start and end cylinders)
   690                                  
   691 00000363 31DB                    	xor	bx, bx
   692 00000365 BA1200                  	mov	dx, 18
   693                                  A_36:
   694 00000368 FEC3                    	inc	bl
   695                                  
   696 0000036A 8A87[246D]              	mov	al, [bx+sort]
   697 0000036E F6E2                    	mul	dl
   698 00000370 89C6                    	mov	si, ax	; current
   699                                  
   700 00000372 80BC[996F]00            	cmp	byte [part_table_sys_id+si], 0
   701 00000377 7636                    	jna	short A_37
   702                                  
   703 00000379 8A87[236D]              	mov	al, [bx+sort-1]
   704 0000037D F6E2                    	mul	dl
   705 0000037F 89C7                    	mov	di, ax  ; previous
   706                                  
   707 00000381 8B85[9C6F]              	mov	ax, [part_table_end_cyl+di]
   708 00000385 3B84[976F]              	cmp	ax, [part_table_start_cyl+si]
   709 00000389 7224                    	jb	short A_37
   710                                  	; 29/10/2020
   711 0000038B 77CB                    	ja	short A_34 ; overlap !
   712                                  
   713                                  	; 17/10/2020
   714                                  	;and	ax, ax
   715                                  	;jnz	short A_34 ; overlap error (except empty entries)
   716                                  
   717                                  	; 29/10/2020
   718                                  	; same cylinder
   719                                  	; check end-start sectors for overlap
   720                                  
   721 0000038D 21C0                    	and	ax, ax
   722 0000038F 741E                    	jz	short A_37 ; empty pt entries
   723                                  			; (previous pte is empty)
   724                                  
   725 00000391 8B85[9E6F]              	mov	ax, [part_table_rel_sec_lw+di] ; previous
   726 00000395 8B95[A06F]              	mov	dx, [part_table_rel_sec_hw+di]
   727 00000399 0385[A26F]              	add	ax, [part_table_num_sec_lw+di]
   728 0000039D 1395[A46F]              	adc	dx, [part_table_num_sec_hw+di]
   729                                  	;jc	short A_34
   730                                  		 ; dx:ax = end sector + 1
   731 000003A1 3B94[A06F]              	cmp	dx, [part_table_rel_sec_hw+si] ; current
   732 000003A5 7208                    	jb	short A_37
   733 000003A7 77AF                    	ja	short A_34 ; overlap error !	
   734 000003A9 3B84[9E6F]              	cmp	ax, [part_table_rel_sec_lw+si]
   735 000003AD 73A9                    	jnb	short A_34 ; overlap error ! 	
   736                                  A_37:
   737 000003AF 80FB03                  	cmp	bl, 3
   738 000003B2 72B4                    	jb	short A_36
   739                                  
   740                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   741                                  ; display partition table editing options
   742                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   743                                  
   744                                  A_38:
   745 000003B4 BE[E859]                	mov	si, mbr_editing_options
   746 000003B7 E8D817                  	call	print_msg
   747                                  
   748 000003BA BE[965A]                	mov	si, enter_option_number_msg
   749 000003BD E8D217                  	call	print_msg
   750                                  
   751 000003C0 803E[226D]00            	cmp	byte [ldrives], 0
   752 000003C5 760C                    	jna	short A_39
   753                                  
   754 000003C7 BE[7F55]                	mov	si, CRLF
   755 000003CA E8C517                  	call	print_msg
   756                                  
   757 000003CD BE[5960]                	mov	si, str_display_ebr_pt
   758 000003D0 E8BF17                  	call	print_msg
   759                                  A_39:	
   760                                  	;mov	si, CRLF
   761                                  	;call	print_msg
   762                                  
   763                                  A_40:
   764 000003D3 30E4                    	xor	ah, ah
   765 000003D5 CD16                    	int	16h
   766                                  
   767 000003D7 3C30                    	cmp	al, '0'
   768 000003D9 742A                    	je	short A_41
   769                                  
   770 000003DB 3C31                    	cmp	al, '1'
   771 000003DD 0F84A600                	je	create_partition
   772 000003E1 3C32                    	cmp	al, '2'
   773 000003E3 0F843701                	je	activate_partition
   774 000003E7 3C33                    	cmp	al, '3'
   775 000003E9 0F84D001                	je	delete_partition
   776 000003ED 3C34                    	cmp	al, '4'
   777 000003EF 0F84D302                	je	write_pt_mbr
   778                                  	
   779 000003F3 3C1B                    	cmp	al, 27 ; ESCape
   780 000003F5 740E                    	je	short A_41
   781                                  
   782                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   783                                  ; display (EPT) logical drives/partitions if 'SPACE' is pressed
   784                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   785                                  
   786                                  	; 28/02/2019
   787 000003F7 803E[226D]00            	cmp	byte [ldrives], 0
   788 000003FC 76D5                    	jna	short A_40
   789                                  
   790 000003FE 3C20                    	cmp	al, 20h ; SPACE
   791 00000400 75D1                    	jne	short A_40
   792                                  
   793 00000402 E9DF25                  	jmp	display_extended_pt
   794                                  
   795                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   796                                  ; exit if ESC key or '0' is pressed
   797                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   798                                  
   799                                  A_41:
   800                                  	; terminate
   801 00000405 CD20                    	int	20h
   802                                  
   803                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   804                                  ; display partition table again
   805                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   806                                  
   807                                  A_42:
   808                                  	; 24/02/2019
   809                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   810 00000407 E8E123                  	call	display_partition_table ; 12/03/2021
   811 0000040A EBA8                    	jmp	short A_38
   812                                  
   813                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   814                                  ; display a row for hard disk name, number and capacity 
   815                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   816                                  ; 11/10/2020
   817                                  
   818                                  display_hd_row:
   819                                  	; dx:ax = disk size
   820                                  
   821 0000040C 81FA0001                	cmp	dx, 256 ; >= 8GB  
   822 00000410 730E                    	jnb	short dhdr_1
   823                                  
   824                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   825                                  	;div	cx
   826                                  
   827                                  	; shift dx:ax to 8 bits right (/256)
   828 00000412 88E0                    	mov	al, ah
   829 00000414 88D4                    	mov	ah, dl
   830 00000416 C1E803                  	shr	ax, 3 ; /8 
   831                                  		; result = (dx:ax)/2048
   832                                  
   833                                  	; ax =  0 to 8191
   834                                  
   835 00000419 C606[DE44]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   836 0000041E EB0A                    	jmp	short dhdr_2
   837                                  	
   838                                  dhdr_1:
   839                                  	; 1024 MB = 1GB (2097152 sectors)
   840                                  	; DX/32 --> GB 
   841 00000420 89D0                    	mov	ax, dx
   842 00000422 C1E805                  	shr	ax, 5 ; /32
   843                                  
   844                                  	; ax = 8 to 2047
   845 00000425 C606[DE44]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   846                                  dhdr_2:
   847                                  	;xor	dx, dx
   848 0000042A BE[E444]                	mov	si, TrDOS_hdrow_capacity
   849 0000042D E81B00                  	call	convert_to_decimal
   850                                  
   851 00000430 FE06[C944]              	inc	byte [TrDOS_hdrow_n] ; next number for "(#)"
   852                                  	
   853 00000434 BE[C644]                	mov	si, TrDOS_hdrow
   854 00000437 E85817                  	call	print_msg
   855 0000043A BE[E444]                	mov	si, TrDOS_hdrow_capacity ; db "#### ", 0
   856 0000043D E85217                  	call	print_msg
   857 00000440 BE[DE44]                	mov	si, TrDOS_hdrow_unit ; "GB" or "MB"
   858 00000443 E84C17                  	call	print_msg
   859                                  
   860 00000446 FE06[CE44]              	inc	byte [TrDOS_hdrow_i] ; next number for "hd#"
   861                                  
   862 0000044A C3                      	retn	
   863                                  
   864                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   865                                  ; convert binary number to decimal character string
   866                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   867                                  ; 11/10/2020
   868                                  
   869                                  convert_to_decimal:
   870                                  	; ax = binary number
   871                                  	; si = decimal string start addr (max. 5 digits + space)
   872 0000044B B90A00                  	mov	cx, 10
   873 0000044E 89E5                    	mov	bp, sp
   874                                  ctd_1:
   875 00000450 31D2                    	xor	dx, dx
   876 00000452 F7F1                    	div	cx
   877 00000454 52                      	push	dx ; 0 to 9
   878 00000455 09C0                    	or	ax, ax
   879 00000457 75F7                    	jnz	short ctd_1
   880                                  ctd_2:
   881 00000459 58                      	pop	ax
   882 0000045A 0430                    	add	al, '0'
   883 0000045C 8804                    	mov	[si], al
   884 0000045E 46                      	inc	si
   885 0000045F 39E5                    	cmp	bp, sp
   886 00000461 77F6                    	ja	short ctd_2
   887                                  	;mov	byte [si], 20h ; space before size unit char
   888                                  	;inc	si 
   889                                  	;mov	byte [si], 0 ; ASCIIZ string terminator (Z)
   890 00000463 C7042000                	mov	word [si], 20h
   891 00000467 C3                      	retn
   892                                  
   893                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   894                                  ; check defective partition signature 
   895                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   896                                  ; 16/10/2020
   897                                  
   898                                  check_defective_partition:
   899 00000468 BB[946F]                	mov	bx, part_table_boot_ind
   900 0000046B 31F6                    	xor	si, si 
   901                                  chk_dp_1:
   902 0000046D 803FFF                  	cmp	byte [bx], 0FFh ; invalid/defective/partition sign
   903 00000470 7509                    	jne	short chk_dp_2
   904 00000472 C1E604                  	shl	si, 4 ; * 16
   905 00000475 81C6[B857]              	add	si, MasterBootBuff+446
   906 00000479 F9                      	stc
   907 0000047A C3                      	retn
   908                                  chk_dp_2:
   909                                  	;cmp	bx, part_table_boot_ind+(18*4)
   910 0000047B 83FE03                  	cmp	si, 3
   911 0000047E 7306                    	jnb	short chk_dp_3
   912 00000480 83C312                  	add	bx, 18
   913 00000483 46                      	inc	si
   914 00000484 EBE7                    	jmp	short chk_dp_1 
   915                                  chk_dp_3:
   916                                  	;sub	si, si
   917 00000486 C3                      	retn
   918                                  
   919                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   920                                  ; create a disk partition (on MBR partition table)
   921                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   922                                  ; 18/10/2020
   923                                  
   924                                  create_partition:
   925                                  	; 19/10/2020
   926                                  	; 10/02/2019 (hdimage.s)
   927 00000487 31C0                    	xor	ax, ax
   928 00000489 A2[F06C]                	mov	byte [wholedisk], al ; 0 ; Reset wholedisk flag
   929                                  
   930                                  	; 19/10/2020
   931 0000048C 3806[DC6F]              	cmp	byte [pcount], al ; 0 ; number of (valid) partitions
   932 00000490 7621                    	jna	short cp_1
   933                                  ;cp_0:
   934 00000492 803E[DC6F]04            	cmp	byte [pcount], 4
   935 00000497 731D                    	jnb	short cp_2 ; full pt !
   936                                  
   937                                  	; al = 0
   938 00000499 E89E20                  	call	find_part_free_space
   939                                  		 ; Following values are for the max. free space on disk
   940                                  
   941 0000049C 21C9                    	and	cx, cx
   942 0000049E 7427                    	jz	short cp_3 ; there is not free space on disk
   943                                  
   944                                  	;mov	[c_cylinders], cx  ; count of free cylinders in the gap
   945 000004A0 891E[7A70]              	mov	[c_fspc_offset], bx  ; offset from beginning of 'fspc:'
   946                                  	;mov	[c_gap], al ; gap (space index) number of this free space
   947                                  	;		    ; 0 -> before partition 1 (as PTE)
   948                                  	;		    ; 1-2-3 -> between partitions 1 to 4
   949                                  	;		    ; 4 -> after partition 4 (as PTE)
   950                                  
   951                                  	; Start to job with non-aligned (full) free sectors of this max. space
   952                                  	
   953 000004A4 8B87[3070]              	mov	ax, [free_space.sectors_unused+bx]
   954 000004A8 8B97[3270]              	mov	dx, [free_space.sectors_unused+2+bx]
   955                                  
   956 000004AC A3[EC6C]                	mov	[pp_Sectors], ax
   957 000004AF 8916[EE6C]              	mov	[pp_Sectors+2], dx
   958                                  cp_1:
   959 000004B3 E9E907                  	jmp	B_01 ; New/Empty disk, create partition menu
   960                                  
   961                                  cp_2:
   962                                  	; 13/02/2019
   963                                  	; There is not a free pt entry to create a new partition
   964                                  
   965                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   966 000004B6 E83223                  	call	display_partition_table ; 12/03/2021
   967                                  
   968 000004B9 BE[785B]                	mov	si, msg_full_pt
   969 000004BC E8D316                  	call	print_msg
   970 000004BF BE[A55B]                	mov	si, msg_to_create_new_p
   971 000004C2 E8CD16                  	call	print_msg
   972                                  
   973 000004C5 EB67                    	jmp	ap_0
   974                                  cp_3:
   975                                  	; 19/10/2020
   976 000004C7 803E[DF6F]00            	cmp	byte [epnumber], 0
   977 000004CC 7708                    	ja	short create_logical_drives
   978                                  ;cp_4:
   979                                  	; 15/02/2019
   980                                  	; There is not (enough) free space to create a new partition
   981                                  
   982 000004CE BE[C35B]                	mov	si, msg_no_free_space
   983 000004D1 E8BE16                  	call	print_msg
   984 000004D4 EB58                    	jmp	ap_0
   985                                  
   986                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   987                                  ; create logical -dos- drives
   988                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   989                                  ; 19/10/2020
   990                                  
   991                                  create_logical_drives:
   992                                  	; 05/03/2019
   993 000004D6 E88A28                  	call	check_ext_free_space
   994 000004D9 723B                    	jc	short cld_5
   995                                  cld_1:
   996                                  	; 05/03/2019
   997 000004DB 803E[226D]04            	cmp	byte [ldrives], 4
   998 000004E0 7203                    	jb	short cld_2
   999 000004E2 E96D25                  	jmp	eetc_2
  1000                                  cld_2:
  1001                                  	; 01/11/2020
  1002 000004E5 A3[9E70]                	mov	[ep_free_sectors], ax
  1003 000004E8 8916[A070]              	mov	[ep_free_sectors+2], dx
  1004                                  
  1005 000004EC BE[5C63]                	mov	si, msg_c_ldd_q
  1006 000004EF E8A016                  	call	print_msg
  1007                                  cld_3:	
  1008 000004F2 28E4                    	sub	ah, ah
  1009 000004F4 CD16                    	int	16h
  1010                                  
  1011 000004F6 3C1B                    	cmp	al, 27 ; ESCAPE key
  1012                                  	;je	cp_esc
  1013 000004F8 7419                    	je	short cld_6 ; 19/10/2020
  1014 000004FA 24DF                    	and	al, 0DFh
  1015 000004FC 3C4E                    	cmp	al, 'N'
  1016 000004FE 740D                    	je	short cld_4
  1017 00000500 3C59                    	cmp	al, 'Y'
  1018 00000502 75EE                    	jne	short cld_3
  1019 00000504 BE[B85C]                	mov	si, _msg_YES
  1020 00000507 E88816                  	call	print_msg
  1021                                  
  1022 0000050A E97825                  	jmp	edit_ext_table_create_x
  1023                                  cld_4:	
  1024 0000050D BE[BE5C]                	mov	si, _msg_NO
  1025 00000510 E87F16                  	call	print_msg
  1026                                  cld_6:
  1027                                  	;jmp	cp_esc
  1028                                  	; 19/10/2020
  1029 00000513 E9F1FE                  	jmp	A_42
  1030                                  cld_5:	
  1031 00000516 BE[2C63]                	mov	si, msg_c_part_error
  1032 00000519 E87616                  	call	print_msg
  1033                                  
  1034                                  	; 21/03/2021
  1035                                  	;cmp	byte [ldrives], 3
  1036                                  	;;jna	short cld_2
  1037                                  	; 21/03/2021
  1038                                  	;jna	short ap_0
  1039                                  
  1040                                  	;mov	si, msg_c_ldd_error
  1041                                  	;call	print_msg
  1042                                  
  1043 0000051C EB10                    	jmp	short ap_0
  1044                                  
  1045                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1046                                  ; set active partition
  1047                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1048                                  ; 19/10/2020 
  1049                                  	
  1050                                  activate_partition:
  1051                                  	; 12/02/2019
  1052                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1053 0000051E E8CA22                  	call	display_partition_table ; 12/03/2021
  1054                                  
  1055 00000521 803E[DC6F]00            	cmp	byte [pcount], 0
  1056 00000526 7713                    	ja	short ap_1
  1057                                  
  1058 00000528 BE[2C5B]                	mov	si, msg_empty_pt
  1059 0000052B E86416                  	call	print_msg
  1060                                  ap_0:
  1061 0000052E BE[DB55]                	mov	si, msg_press_any_key
  1062 00000531 E85E16                  	call	print_msg
  1063                                  
  1064 00000534 30E4                    	xor	ah, ah
  1065 00000536 CD16                    	int	16h
  1066                                  ap_5:
  1067                                  	;jmp	ap_esc
  1068                                  	; 19/10/2020
  1069 00000538 E9CCFE                  	jmp	A_42
  1070                                  
  1071                                  ap_1:
  1072                                  	; Set valid_ppnums (MBR partition IDs) list
  1073 0000053B BE[B857]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1074 0000053E BB[366F]                	mov	bx, valid_ppnums
  1075 00000541 B104                    	mov	cl, 4
  1076                                  ap_2:
  1077 00000543 8A4404                  	mov	al, [si+ptFileSystemID]
  1078 00000546 8807                    	mov	[bx], al
  1079 00000548 FEC9                    	dec	cl
  1080 0000054A 7406                    	jz	short ap_3
  1081 0000054C 43                      	inc	bx
  1082 0000054D 83C610                  	add	si, 16
  1083 00000550 EBF1                    	jmp	short ap_2
  1084                                  ap_3:
  1085 00000552 BE[AB5D]                	mov	si, msg_enter_pn_to_act
  1086 00000555 E83A16                  	call	print_msg
  1087                                  ap_getchar:
  1088 00000558 30E4                    	xor	ah, ah
  1089 0000055A CD16                    	int	16h
  1090                                  	
  1091                                  	; 19/10/2020
  1092 0000055C 3C1B                    	cmp	al, 27
  1093                                  	;je	ap_esc
  1094 0000055E 74D8                    	je	short ap_5
  1095                                  
  1096                                  	;cmp	al, '0'
  1097                                  	;;je	ap_esc
  1098                                  	;je	short ap_5
  1099                                  
  1100 00000560 3C31                    	cmp	al, '1'
  1101 00000562 72F4                    	jb	short ap_getchar
  1102 00000564 3C34                    	cmp	al, '4'
  1103 00000566 77F0                    	ja	short ap_getchar
  1104                                  
  1105 00000568 30E4                    	xor	ah, ah
  1106 0000056A 89C2                    	mov	dx, ax
  1107                                  	
  1108 0000056C 80EA31                  	sub	dl, '1'
  1109 0000056F 89D6                    	mov	si, dx
  1110 00000571 38A4[366F]              	cmp	byte [si+valid_ppnums], ah  ; 0
  1111 00000575 76E1                    	jna	short ap_getchar ; Empty partition table entry, it is not shown
  1112                                  
  1113 00000577 BB0700                  	mov	bx, 07h
  1114 0000057A B409                    	mov	ah, 09h
  1115 0000057C B90100                  	mov	cx, 1
  1116 0000057F CD10                    	int	10h
  1117                                  
  1118 00000581 BE[B857]                	mov	si, MasterBootBuff+pTableOffset
  1119 00000584 BF[946F]                	mov	di, part_table_boot_ind ; (**)
  1120                                  
  1121                                  	; Clear all of possible active partition flags
  1122 00000587 8834                    	mov	[si], dh ; 0
  1123 00000589 887410                  	mov	[si+16], dh ; 0
  1124 0000058C 887420                  	mov	[si+32], dh ; 0
  1125 0000058F 887430                  	mov	[si+48], dh ; 0
  1126                                  
  1127                                  	; This may not be needed !? 
  1128                                  	; (**) (Primary partitions structure/list)
  1129 00000592 8835                    	mov	[di], dh ; 0	
  1130 00000594 887512                  	mov	[di+18], dh ; 0
  1131 00000597 887524                  	mov	[di+36], dh ; 0
  1132 0000059A 887536                  	mov	[di+54], dh ; 0
  1133                                  
  1134 0000059D 20D2                    	and 	dl, dl
  1135 0000059F 740D                    	jz	short ap_4
  1136                                  
  1137 000005A1 89D0                    	mov	ax, dx
  1138                                  
  1139 000005A3 C0E004                  	shl	al, 4 ; * 16
  1140 000005A6 01C6                    	add	si, ax
  1141                                  
  1142 000005A8 B012                    	mov	al, 18
  1143 000005AA F6E2                    	mul	dl ; 1 to 3
  1144 000005AC 01C7                    	add	di, ax
  1145                                  ap_4:
  1146                                  	; Then	set active partition as requested by user
  1147 000005AE C60480                  	mov	byte [si], 80h
  1148 000005B1 C60580                  	mov	byte [di], 80h ; (**)
  1149                                  
  1150 000005B4 BE[7F55]                	mov	si, CRLF ; Next line	
  1151 000005B7 E8D815                  	call	print_msg
  1152                                  
  1153                                  	; NOTE: Only the MBR buffer has been changed
  1154                                  	; (Masterboot sector will not be updated unless/till
  1155                                  	;  MBR partition table -and MBR code- will be written
  1156                                  	;  to disk image as result of 'write part. table' command.)
  1157                                  
  1158                                  	;; wait for 1 second
  1159                                  	;mov	ah, 02h
  1160                                  	;int	1Ah
  1161                                  	;mov	[GetChar], dh
  1162                                  ;ap_wait:
  1163                                  	;mov	ah, 02h
  1164                                  	;int	1Ah
  1165                                  	;cmp	dh, [GetChar]
  1166                                  	;je	short ap_wait
  1167                                  
  1168                                  	; 17/10/2020
  1169 000005BA E94AFE                  	jmp	A_42 ; display partition table again
  1170                                  
  1171                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1172                                  ; delete selected partition
  1173                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1174                                  ; 19/10/2020
  1175                                  
  1176                                  delete_partition:
  1177                                  	; 10/02/2019
  1178                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1179 000005BD E82B22                  	call	display_partition_table ; 12/03/2021
  1180                                  
  1181 000005C0 803E[DC6F]00            	cmp	byte [pcount], 0
  1182 000005C5 7712                    	ja	short dp_1
  1183                                  
  1184 000005C7 BE[2C5B]                	mov	si, msg_empty_pt
  1185 000005CA E8C515                  	call	print_msg
  1186                                  
  1187 000005CD BE[DB55]                	mov	si, msg_press_any_key
  1188 000005D0 E8BF15                  	call	print_msg
  1189                                  
  1190 000005D3 30E4                    	xor	ah, ah
  1191 000005D5 CD16                    	int	16h
  1192                                  
  1193 000005D7 EB73                    	jmp	short dp_esc
  1194                                  
  1195                                  dp_1:
  1196                                  	; Set valid_ppnums (MBR partition IDs) list
  1197 000005D9 BE[B857]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1198 000005DC BB[366F]                	mov	bx, valid_ppnums
  1199 000005DF B104                    	mov	cl, 4
  1200                                  dp_2:
  1201 000005E1 8A4404                  	mov	al, [si+ptFileSystemID]
  1202 000005E4 8807                    	mov	[bx], al
  1203 000005E6 FEC9                    	dec	cl
  1204 000005E8 7406                    	jz	short dp_3
  1205 000005EA 43                      	inc	bx
  1206 000005EB 83C610                  	add	si, 16
  1207 000005EE EBF1                    	jmp	short dp_2
  1208                                  dp_3:
  1209 000005F0 BE[E75B]                	mov	si, msg_enter_pn_to_del
  1210 000005F3 E89C15                  	call	print_msg
  1211                                  dp_getchar1:
  1212 000005F6 30E4                    	xor	ah, ah
  1213 000005F8 CD16                    	int	16h
  1214                                  	
  1215                                  	; 19/10/2020
  1216 000005FA 3C1B                    	cmp	al, 27
  1217 000005FC 744E                    	je	short dp_esc
  1218 000005FE 3C30                    	cmp	al, '0'
  1219 00000600 744A                    	je	short dp_esc
  1220                                  	;cmp	al, '1'
  1221 00000602 72F2                    	jb	short dp_getchar1
  1222 00000604 3C34                    	cmp	al, '4'
  1223 00000606 77EE                    	ja	short dp_getchar1
  1224                                  
  1225 00000608 30FF                    	xor	bh, bh
  1226 0000060A 88C3                    	mov	bl, al
  1227                                  	;dec	bl
  1228 0000060C 80EB31                  	sub	bl, '1'
  1229 0000060F 38BF[366F]              	cmp	byte [bx+valid_ppnums], bh ; 0 ; 12/02/2019
  1230 00000613 76E1                    	jna	short dp_getchar1  ; Empty partition table entry, it is not shown
  1231                                  	
  1232 00000615 881E[416F]              	mov	[del_part_num], bl ; Selected partition number to be deleted.
  1233 00000619 A2[0B5C]                	mov	[chr_del_pnum1], al ; Partition number for "Enter ..." text
  1234 0000061C A2[AD5C]                	mov	[chr_del_pnum2], al ; Partition number for "Do you want ..." text
  1235                                  
  1236 0000061F BE[0B5C]                	mov	si, chr_del_pnum1 ; write partition number (user input)
  1237 00000622 E86D15                  	call	print_msg
  1238                                  
  1239                                  	;xor	al, al
  1240 00000625 A2[0B5C]                	mov	[chr_del_pnum1], al ; 0 ; reset
  1241                                  
  1242 00000628 BE[0F5C]                	mov	si, msg_delete_partition_q ; question for deleting (with warning)
  1243 0000062B E86415                  	call	print_msg
  1244                                  
  1245                                  dp_getchar2:
  1246 0000062E 30E4                    	xor	ah, ah
  1247 00000630 CD16                    	int	16h
  1248                                  
  1249 00000632 3C1B                    	cmp	al, 27
  1250 00000634 7416                    	je	short dp_esc
  1251                                  
  1252 00000636 24DF                    	and	al, 0DFh
  1253 00000638 3C59                    	cmp	al, 'Y'
  1254 0000063A 7413                    	je	short dp_yes
  1255 0000063C 3C4E                    	cmp	al, 'N'
  1256 0000063E 75EE                    	jne	short dp_getchar2
  1257                                  dp_no:
  1258 00000640 BE[BF5C]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  1259 00000643 E84C15                  	call	print_msg
  1260                                  	
  1261 00000646 BE[7F55]                	mov	si, CRLF  ; Next line
  1262 00000649 E84615                  	call	print_msg
  1263                                  	
  1264                                  	;jmp	short dp_esc
  1265                                  
  1266                                  ;cp_esc:
  1267                                  ;ap_esc:
  1268                                  ;wptmbr_esc:
  1269                                  dp_esc:
  1270                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1271                                  	;call	display_partition_table
  1272                                  	;jmp	A_38 ; 17/10/2020
  1273                                  
  1274                                  	; 19/10/2020
  1275 0000064C E9B8FD                  	jmp	A_42
  1276                                  
  1277                                  dp_yes:
  1278 0000064F BE[B95C]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  1279 00000652 E83D15                  	call	print_msg
  1280                                  
  1281 00000655 BF[B857]                	mov	di, MasterBootBuff+pTableOffset
  1282 00000658 A0[416F]                	mov	al, [del_part_num]
  1283 0000065B 20C0                    	and 	al, al
  1284 0000065D 7406                    	jz	short dp_4
  1285 0000065F 98                      	cbw
  1286                                  	;xor	ah, ah
  1287 00000660 C0E004                  	shl	al, 4 ; * 16
  1288 00000663 01C7                    	add	di, ax
  1289                                  dp_4:
  1290 00000665 BE[7F55]                	mov	si, CRLF ; Next line
  1291 00000668 E82715                  	call	print_msg
  1292                                  
  1293                                  	; 27/02/2019
  1294 0000066B 807D0405                	cmp	byte [di+ptFileSystemID], 05h ; EXTENDED (CHS)  
  1295                                  	;jne	short dp_5
  1296 0000066F 7406                    	je	short dp_6
  1297                                  	; 24/10/2020
  1298 00000671 807D040F                	cmp	byte [di+ptFileSystemID], 0Fh ; EXTENDED (LBA)
  1299 00000675 7545                    	jne	short dp_5
  1300                                  dp_6:
  1301 00000677 3806[226D]              	cmp	byte [ldrives], al ; 0
  1302 0000067B 763F                    	jna	short dp_5
  1303                                  
  1304 0000067D BE[2F5F]                	mov	si, msg_ext_part_del_error
  1305 00000680 E80F15                  	call	print_msg
  1306 00000683 BE[6F5F]                	mov	si, msg_cancel_continue
  1307 00000686 E80915                  	call	print_msg
  1308                                       	
  1309 00000689 30E4                    	xor	ah, ah
  1310 0000068B CD16                    	int	16h
  1311                                  	
  1312 0000068D 3C1B                    	cmp	al, 27 ; ESCape
  1313 0000068F 74BB                    	je	short dp_esc
  1314                                  
  1315 00000691 E83C2A                  	call	delete_logical_drives
  1316                                  	
  1317                                  	; 28/02/2019
  1318 00000694 803E[226D]01            	cmp	byte [ldrives], 1
  1319 00000699 73B1                    	jnb	short dp_esc
  1320                                  
  1321                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1322 0000069B E84D21                  	call	display_partition_table ; 12/03/2021
  1323                                  
  1324 0000069E BE[0260]                	mov	si, msg_delete_ext_part
  1325 000006A1 E8EE14                  	call	print_msg
  1326                                  
  1327                                  dp_ask_again:
  1328 000006A4 28E4                    	sub	ah, ah
  1329 000006A6 CD16                    	int	16h
  1330                                  
  1331 000006A8 3C1B                    	cmp	al, 27 ; ESCape
  1332 000006AA 74A0                    	je	short dp_esc	
  1333                                  
  1334 000006AC 3C0D                    	cmp	al, 13 ; ENTER/CR
  1335 000006AE 75F4                    	jne	short dp_ask_again
  1336                                  
  1337 000006B0 BF[B857]                	mov	di, MasterBootBuff+pTableOffset
  1338 000006B3 A0[416F]                	mov	al, [del_part_num]
  1339 000006B6 98                      	cbw
  1340 000006B7 C0E004                  	shl	al, 4 ; * 16
  1341 000006BA 01C7                    	add	di, ax
  1342                                  dp_5:
  1343 000006BC 31C0                    	xor	ax, ax
  1344                                  
  1345                                  	; clear partition table entry in MBR buffer
  1346 000006BE B90800                  	mov	cx, 8
  1347 000006C1 F3AB                    	rep	stosw
  1348                                  	
  1349                                  	; NOTE: Only the MBR buffer will be cleared
  1350                                  	; (Masterboot sector will not be updated unless/till
  1351                                  	;  MBR partition table -and MBR code- will be written
  1352                                  	;  to disk image as result of 'write part. table' command.)
  1353                                  
  1354 000006C3 E924FB                  	jmp	A_21 ; 17/10/2020
  1355                                   	 
  1356                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1357                                  ; write partition table (and MBR code) onto disk
  1358                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1359                                  ; 18/10/2020
  1360                                  
  1361                                  write_pt_mbr:
  1362                                  	; 18/10/2020 (fdisk3.s)
  1363                                  	; 11/02/2019 (hdimage.s)
  1364                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1365 000006C6 E82221                  	call	display_partition_table ; 12/03/2021
  1366                                  
  1367 000006C9 BE[C35C]                	mov	si, msg_write_masterboot_sector
  1368 000006CC E8C314                  	call	print_msg
  1369                                  
  1370 000006CF A2[126D]                	mov	[GetChar], al ; 0
  1371                                  
  1372 000006D2 BE[A65D]                	mov	si, option_input
  1373 000006D5 E8BA14                  	call	print_msg
  1374                                  
  1375 000006D8 B403                    	mov	ah, 3
  1376                                  	;mov	bx, 7
  1377 000006DA CD10                    	int	10h ; Return Cursor Position
  1378                                  	; DL = Column
  1379                                  	
  1380 000006DC FECA                    	dec	dl ; previous char ; ']'
  1381 000006DE FECA                    	dec	dl ; previous char ; '[ ]'
  1382                                  
  1383 000006E0 B402                    	mov	ah, 2
  1384                                  	;mov	bx, 7
  1385 000006E2 CD10                    	int	10h ; Set Cursor Position
  1386                                  
  1387                                  	; write char at current cursor position
  1388                                  
  1389 000006E4 B030                    	mov	al, '0' ; Write default char
  1390                                  
  1391                                  	;;mov	bx, 07h
  1392 000006E6 B409                    	mov	ah, 09h
  1393 000006E8 B90100                  	mov	cx, 1
  1394 000006EB CD10                    	int	10h
  1395                                  
  1396                                  wptmbr_getchar:
  1397 000006ED 30E4                    	xor	ah, ah
  1398 000006EF CD16                    	int	16h
  1399                                  
  1400 000006F1 3C1B                    	cmp	al, 1Bh ; 27
  1401                                  	;je	wptmbr_esc ; 19/10/2020
  1402 000006F3 0F8410FD                	je	A_42
  1403                                  
  1404 000006F7 3C0D                    	cmp	al, 0Dh ; 13
  1405 000006F9 7414                    	je	short wptmbr_1
  1406                                                  
  1407 000006FB 3C31                    	cmp	al, '1'
  1408 000006FD 72EE                    	jb	short wptmbr_getchar
  1409                                  
  1410 000006FF 3C32                    	cmp	al, '2'
  1411 00000701 77EA                    	ja 	short wptmbr_getchar
  1412                                  
  1413 00000703 A2[126D]                	mov	[GetChar], al
  1414                                  
  1415                                  	;;mov	bx, 07h
  1416 00000706 B409                    	mov	ah, 09h
  1417 00000708 B90100                  	mov	cx, 1
  1418 0000070B CD10                    	int	10h
  1419 0000070D EBDE                    	jmp	short wptmbr_getchar
  1420                                  
  1421                                  wptmbr_1:
  1422 0000070F 803E[126D]00            	cmp	byte [GetChar], 0
  1423 00000714 76D7                    	jna	short wptmbr_getchar
  1424                                  
  1425 00000716 BE[745D]                	mov	si, msg_writing_ptable
  1426 00000719 E87614                  	call	print_msg
  1427                                  
  1428 0000071C 803E[126D]32            	cmp	byte [GetChar], '2'
  1429 00000721 751F                    	jne	short wptmbr_2 ; Do not write Singlix MBR code
  1430                                  
  1431                                  	; Write CHS parameters in Singlix (FS specific) MBR
  1432                                  	
  1433 00000723 BE[6B31]                	mov	si, TRDOS386_MASTERBOOT_SECTOR
  1434 00000726 B9DF00                  	mov	cx, 446/2 ; Copy Singlix FS 1 MBR code
  1435                                  			  ; except Partition Table
  1436 00000729 BF[FA55]                	mov	di, MasterBootBuff
  1437 0000072C F3A5                    	rep	movsw
  1438                                  	
  1439                                  	; This (Below) is not needed; because, if MBR magicword
  1440                                  	; would not be 0AA55h, we would not be able to come here!
  1441                                  	;;add	di, 64  ; skip partition table	
  1442                                  	;;mov	ax, 0AA55h
  1443                                  	;;stosw
  1444                                  	;mov 	word [MBIDCode], 0AA55h
  1445                                  
  1446                                  	; 12/02/2019
  1447                                  	; Copy CHS parameters to Singlix MBR (on disk)
  1448                                  	
  1449 0000072E BF[9E57]                	mov	di, MasterBootBuff+420
  1450                                  
  1451 00000731 A1[823F]                	mov	ax, [cylinders]
  1452 00000734 AB                      	stosw 			; cylinders
  1453 00000735 A1[803F]                	mov	ax, [heads]
  1454 00000738 AB                      	stosw 			; heads
  1455 00000739 A1[7E3F]                	mov	ax, [sectors]
  1456 0000073C AB                      	stosw 			; sectors
  1457                                  
  1458                                  	; 13/03/2021
  1459                                  	; copy 32 bit disk size (total LBA sectors) to MBR offset 426
  1460 0000073D BE[5668]                	mov	si, disksize
  1461 00000740 A5                      	movsw
  1462 00000741 A5                      	movsw
  1463                                  
  1464                                  wptmbr_2:
  1465                                  	;xor	ax, ax ; 0
  1466                                  	;xor	dx, dx ; 0
  1467                                  	;; DX_AX = Masterboot Sector = 0
  1468                                  	;mov	bx, MasterBootBuff
  1469                                  	;; ES:BX = Sector Buffer
  1470                                  	;call	write_hd_sector
  1471                                  	;jc	short print_error_code 
  1472                                  			; ! display error msg and then exit !
  1473                                  
  1474 00000742 C606[5568]05            	mov	byte [rcnt], 5  ; retry count
  1475                                  
  1476 00000747 BB[FA55]                	mov	bx, MasterBootBuff
  1477                                  
  1478 0000074A B90100                  	mov	cx, 1	; cylinder = 0
  1479                                  			; sector = 1
  1480 0000074D B600                    	mov	dh, 0	; head = 0
  1481 0000074F 8A16[5268]              	mov	dl, [DrvNum]
  1482                                  wptmbr_3:
  1483 00000753 B80103                  	mov	ax, 0301h ; write one sector
  1484 00000756 CD13                    	int	13h	
  1485 00000758 730C                    	jnc     short wptmbr_4
  1486                                               
  1487 0000075A FE0E[5568]              	dec	byte [rcnt]
  1488 0000075E 7431                    	jz	short print_error_code
  1489                                          
  1490 00000760 30E4                    	xor	ah, ah
  1491                                  	;mov	dl, [DrvNum]
  1492 00000762 CD13                    	int	13h	; BIOS Service func (ah) = 0
  1493                                  			; Reset disk system
  1494 00000764 EBED                    	jmp	short wptmbr_3
  1495                                  
  1496                                  wptmbr_4:
  1497 00000766 BE[9D5D]                	mov	si, _msg_OK
  1498 00000769 E82614                  	call	print_msg
  1499                                  
  1500                                  	; wait for 1 second
  1501 0000076C B402                    	mov	ah, 02h
  1502 0000076E CD1A                    	int	1Ah
  1503 00000770 8836[126D]              	mov	[GetChar], dh
  1504                                  wptmbr_wait:
  1505 00000774 B402                    	mov	ah, 02h
  1506 00000776 CD1A                    	int	1Ah
  1507 00000778 3A36[126D]              	cmp	dh, [GetChar]
  1508 0000077C 74F6                    	je	short wptmbr_wait
  1509                                  	
  1510 0000077E BE[DB55]                	mov	si, msg_press_any_key
  1511 00000781 E80E14                  	call	print_msg
  1512                                                  
  1513 00000784 30E4                    	xor	ah, ah	; "Press any key to continue"
  1514 00000786 CD16                    	int	16h
  1515                                  
  1516 00000788 BE[7F55]                	mov	si, CRLF
  1517 0000078B E80414                  	call	print_msg
  1518                                  
  1519                                  	;jmp	wptmbr_esc
  1520                                  	; 19/10/2020
  1521 0000078E E976FC                  	jmp	A_42
  1522                                  
  1523                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1524                                  ; print error message and exit
  1525                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1526                                  ; 18/10/2020 (fdisk3.s)
  1527                                  	
  1528                                  print_error_code:
  1529                                  	; 25/02/2019 (hdimage.s)
  1530                                  
  1531 00000791 88E0                    	mov	al, ah	; error code
  1532 00000793 E8D214                  	call	bin_to_hex
  1533 00000796 A3[8D55]                	mov 	[error_code], ax
  1534                                  
  1535 00000799 BE[7F55]                	mov	si, CRLF
  1536 0000079C E8F313                  	call	print_msg
  1537                                  
  1538 0000079F BE[8255]                	mov	si, Msg_Error
  1539 000007A2 E8ED13                  	call	print_msg
  1540                                  	
  1541 000007A5 CD20                    	int	20h	; Exit
  1542                                  
  1543                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1544                                  ; exit, print_msg & exit
  1545                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1546                                  ; 19/10/2020
  1547                                  
  1548                                  _crlf_exit:
  1549 000007A7 BE[7F55]                	mov	si, CRLF
  1550                                  _p_exit:
  1551                                  	; 11/10/2020
  1552 000007AA E8E513                  	call	print_msg
  1553                                  _exit:
  1554 000007AD B8004C                  	mov	ax, 4C00h		; terminate
  1555 000007B0 CD21                    	int	21h
  1556                                  
  1557                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1558                                  ; display create partition menu & get partition type input
  1559                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1560                                  ; 19/10/2020
  1561                                  
  1562                                  create_partition_input:
  1563                                  	; 15/02/2019
  1564                                  	; clear screen
  1565 000007B2 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1566 000007B5 CD10                    	int	10h
  1567                                  	
  1568 000007B7 BE[7945]                	mov	si, msg_create_partition_h ; header
  1569 000007BA E8D513                  	call	print_msg
  1570 000007BD BE[6E46]                	mov	si, msg_create_partition_m ; menu
  1571 000007C0 E8CF13                  	call	print_msg
  1572                                  cpi_1:
  1573 000007C3 30E4                    	xor	ah, ah
  1574 000007C5 CD16                    	int	16h
  1575 000007C7 3C1B                    	cmp	al, 27 ; ESC key	
  1576 000007C9 7445                    	je	short cpi_4  ; 25/02/2019
  1577 000007CB 3C30                    	cmp	al, '0'
  1578 000007CD 7441                    	je	short cpi_4  ; 25/02/2019
  1579 000007CF 72F2                    	jb	short cpi_1
  1580 000007D1 3C34                    	cmp	al, '4'
  1581 000007D3 77EE                    	ja	short cpi_1
  1582                                  
  1583 000007D5 30E4                    	xor	ah, ah
  1584 000007D7 2C30                    	sub	al, '0'
  1585                                  
  1586                                  	;mov	[pp_type], al
  1587                                  
  1588                                  	;mov	byte [pp_type_user], 0
  1589                                  
  1590 000007D9 3C01                    	cmp	al, 1 ; DOS partition
  1591 000007DB 7536                    	jne	short cpi_5 ; ah = 0 
  1592                                  			    ; (al = 2 -> singlix, al = 3 -> retro unix)
  1593                                  cpi_2:
  1594                                  	; clear screen
  1595 000007DD B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1596 000007E0 CD10                    	int	10h
  1597                                  	
  1598 000007E2 BE[2448]                	mov	si, msg_create_dos_partition_h ; header
  1599 000007E5 E8AA13                  	call	print_msg
  1600 000007E8 BE[F84B]                	mov	si, msg_create_dos_partition_m ; menu
  1601 000007EB E8A413                  	call	print_msg
  1602                                  cpi_3:
  1603 000007EE 30E4                    	xor	ah, ah
  1604 000007F0 CD16                    	int	16h
  1605 000007F2 3C1B                    	cmp	al, 27 ; ESC key
  1606 000007F4 741A                    	je	short cpi_4
  1607 000007F6 3C30                    	cmp	al, '0'
  1608 000007F8 7416                    	je	short cpi_4
  1609 000007FA 72F2                    	jb	short cpi_3
  1610 000007FC 3C33                    	cmp	al, '3'
  1611 000007FE 77EE                    	ja	short cpi_3
  1612                                  	
  1613 00000800 30E4                    	xor	ah, ah
  1614 00000802 2C30                    	sub	al, '0'
  1615 00000804 3C01                    	cmp	al, 1
  1616 00000806 7424                    	je	short cpi_6  ;	ah = 0 (al = primary dos partition)
  1617                                  
  1618                                  	;mov	byte [pp_type], 5
  1619                                  
  1620 00000808 3C02                    	cmp	al, 2
  1621 0000080A 7621                    	jna	short cpi_7
  1622                                  
  1623 0000080C B80600                  	mov	ax, 6	; ah = 0 (al = logical dos drive/partition)
  1624 0000080F C3                      	retn
  1625                                  
  1626                                  cpi_4:
  1627 00000810 31C0                    	xor	ax, ax	; ah = 0 (al = 0 -> ESCape/Cancel)
  1628 00000812 C3                      	retn
  1629                                  cpi_5:
  1630 00000813 3C04                    	cmp	al, 4	 ; option num. for partition type (user) input
  1631 00000815 7515                    	jne	short cpi_6
  1632                                  
  1633 00000817 E82318                  	call	partition_type_input
  1634                                  	
  1635                                  	; 29/10/2020
  1636 0000081A 08C0                    	or	al, al
  1637                                  	;jz	short cpi_6 ; invalid (zero) input or ESC key
  1638 0000081C 74F2                    	jz	short cpi_4
  1639                                  
  1640 0000081E B404                    	mov	ah, 4 ; user/another type partition flag
  1641                                  	; al = Partition ID
  1642 00000820 50                      	push	ax
  1643 00000821 BE[DB55]                	mov	si, msg_press_any_key 
  1644 00000824 E86B13                  	call	print_msg
  1645 00000827 28E4                    	sub	ah, ah
  1646 00000829 CD16                    	int	16h
  1647 0000082B 58                      	pop	ax
  1648                                  cpi_6:
  1649 0000082C C3                      	retn
  1650                                  cpi_7:
  1651 0000082D B80500                  	mov	ax, 5	; ah = 0 (al = extended dos partition)
  1652 00000830 C3                      	retn
  1653                                  
  1654                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1655                                  ; create primary (dos or non-dos) partition
  1656                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1657                                  ; 19/10/2020 
  1658                                  ;	(This procedure must be called after 'find_part_free_space')
  1659                                  
  1660                                  create_primary_partition:  
  1661                                  	; 16/02/2019
  1662                                  
  1663                                  	; INPUT:
  1664                                  	;	none 
  1665                                  	;  (CHS parameters and free space calculation result will be used.) 
  1666                                  	;
  1667                                  	; OUTPUT:
  1668                                  	;	Partition table in MBR buffer will be updated.
  1669                                  	;
  1670                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  1671                                  
  1672                                  	; Create primary dos or non-dos partition,
  1673                                  	; make partition table entry
  1674                                  
  1675                                  	; 19/10/2020
  1676 00000831 803E[DC6F]00            	cmp	byte [pcount], 0  ; count of (valid) partitions
  1677 00000836 770A                    	ja	short cpp_0
  1678                                  
  1679                                  	; cylinder = 0, head = 1, sector = 1
  1680                                  	; LBA = (((cylinder*heads)+head)*sectors)+sector-1
  1681                                  
  1682 00000838 BE[B857]                	mov	si, MasterBootBuff+pTableOffset
  1683                                  
  1684 0000083B A1[7E3F]                	mov	ax, [sectors] ; LBA = 17 or 63
  1685 0000083E 31D2                    	xor	dx, dx
  1686 00000840 EB56                    	jmp	short cpp_4
  1687                                  cpp_0:
  1688                                  	; 16/02/2019
  1689 00000842 E8671F                  	call	get_first_free_pte
  1690                                  		 ; CX = First free PTE number, 0 to 3 
  1691                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  1692                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  1693                                   	 	 ; SI = PTE address/offset in MBR buffer
  1694                                  
  1695                                  	;mov	si, MasterBootBuff+pTableOffset
  1696                                  	;shl	cl, 4 ; * 16
  1697                                  	;add	si, cx
  1698                                  
  1699                                  	; 18/02/2019
  1700 00000845 8B3E[7A70]              	mov	di, [c_fspc_offset]
  1701 00000849 8B9D[2A70]              	mov	bx, [di+free_space.start]
  1702 0000084D A0[803F]                	mov	al, [heads]
  1703 00000850 F626[7E3F]              	mul	byte [sectors]
  1704 00000854 F7E3                    	mul	bx
  1705                                  		; DX:AX = LBA of start cylinder, head 0, sector 1
  1706                                  	
  1707 00000856 8A0E[7C70]              	mov	cl, [cylinder_boundary]
  1708                                  
  1709                                  	;cmp	cl, 0 ; Default (partition size unit is one of C, G, M)
  1710                                  		      ; boundary alignment is forced as default
  1711                                  	;je	short cpp_4
  1712                                  
  1713                                  	; 20/02/2019
  1714                                  	;and	cl, cl
  1715                                  	;jz 	short cpp_1
  1716                                  
  1717 0000085A 80F959                  	cmp	cl, 'Y'
  1718 0000085D 7439                    	je	short cpp_4 ; cylinder boundary option (answer) = YES
  1719                                  
  1720 0000085F 80F94E                  	cmp	cl, 'N'
  1721 00000862 750A                    	jne	short cpp_1 ; cylinder boundary option (answer) = YES/NO
  1722                                  
  1723                                  	; cylinder boundary option (answer) = NO 
  1724 00000864 8B85[3470]              	mov	ax, [di+free_space.startsector]
  1725 00000868 8B95[3670]              	mov	dx, [di+free_space.startsector+2]
  1726 0000086C EB2A                    	jmp	short cpp_4
  1727                                  cpp_1:
  1728                                  	;cmp	cl, 27 ; ESCape
  1729                                  	;jne	short cpp_4 ; 'Y'
  1730                                  
  1731                                  	; check	cylinder boundary alignment of the start sector
  1732                                  
  1733                                  	; if start sector is not aligned, end sector must not be aligned
  1734                                  	; (this rule is valid for ESCape key from the user) 
  1735                                  
  1736 0000086E C606[7C70]59            	mov	byte [cylinder_boundary], 'Y' ; YES for end sector check
  1737                                  
  1738 00000873 8B8D[3470]              	mov	cx, [di+free_space.startsector]
  1739                                  
  1740 00000877 09DB                    	or	bx, bx
  1741                                  
  1742 00000879 8B9D[3670]              	mov	bx, [di+free_space.startsector+2]
  1743                                  
  1744 0000087D 7508                    	jnz	short cpp_2 ; start cylinder > 0
  1745                                  
  1746                                  	;and	bx, bx
  1747                                  	;jnz	short cpp_3
  1748                                  
  1749 0000087F 3B0E[7E3F]              	cmp	cx, [sectors]
  1750 00000883 7413                    	je	short cpp_4 ; start sector is as aligned 
  1751 00000885 EB08                    	jmp	short cpp_3
  1752                                  cpp_2:
  1753 00000887 39C8                    	cmp	ax, cx
  1754 00000889 7504                    	jne	short cpp_3
  1755 0000088B 39DA                    	cmp	dx, bx
  1756 0000088D 7409                    	je	short cpp_4 
  1757                                  cpp_3:
  1758 0000088F 89C8                    	mov	ax, cx
  1759 00000891 89DA                    	mov	dx, bx
  1760 00000893 C606[7C70]4E            	mov	byte [cylinder_boundary], 'N'
  1761                                  cpp_4:
  1762 00000898 894408                  	mov	[si+ptStartSector], ax
  1763 0000089B 89540A                  	mov	[si+ptStartSector+2], dx
  1764                                  
  1765                                  	; save start sector (for partition formatting procedure)
  1766 0000089E A3[E86C]                	mov	[pp_StartSector], ax
  1767 000008A1 8916[EA6C]              	mov	[pp_StartSector+2], dx
  1768                                  
  1769                                  	; 14/03/2021
  1770 000008A5 8B0E[1A6D]              	mov	cx, [ppn_Sectors]
  1771 000008A9 8B1E[1C6D]              	mov	bx, [ppn_Sectors+2]
  1772                                  
  1773                                  	; 19/10/2020
  1774 000008AD 803E[DC6F]00            	cmp	byte [pcount], 0
  1775 000008B2 775E                    	ja	short cpp_5
  1776                                  
  1777                                  	;xor	cx, cx
  1778                                  	;mov	[si+ptBeginCylinder], cx ; 0
  1779                                  	;inc	cl  ; 1
  1780                                  	;mov	[si+ptBeginSector], cl ; 1
  1781                                  	;mov	[si+ptBeginHead], cl ; 1
  1782                                  	; 14/03/2021
  1783 000008B4 C744030000              	mov	word [si+ptBeginCylinder], 0
  1784 000008B9 C6440201                	mov	byte [si+ptBeginSector], 1
  1785 000008BD C6440101                	mov	byte [si+ptBeginHead], 1
  1786                                  
  1787                                  	; set active partition flag
  1788                                  	;mov	byte [si+ptBootable], 80h ; bootable/active partition
  1789 000008C1 C60480                  	mov	byte [si], 80h ; bootable/active partition
  1790                                  
  1791                                  	; 14/03/2021
  1792                                  	; 18/02/2019
  1793                                  	;mov	cx, [ppn_Sectors]
  1794                                  	;mov	bx, [ppn_Sectors+2]
  1795                                  
  1796 000008C4 803E[F06C]00            	cmp	byte [wholedisk], 0
  1797 000008C9 0F865401                	jna	cpp_12
  1798                                  
  1799                                  	; 26/10/2020
  1800 000008CD 01C8                    	add	ax, cx
  1801 000008CF 11DA                    	adc	dx, bx
  1802 000008D1 83E801                  	sub	ax, 1
  1803 000008D4 83DA00                  	sbb	dx, 0 
  1804                                  
  1805                                  	; 24/10/2020
  1806 000008D7 3B16[5C68]              	cmp	dx, [chs_limit+2]
  1807 000008DB 7217                    	jb	short cpp_17
  1808 000008DD 7706                    	ja	short cpp_16
  1809 000008DF 3B06[5A68]              	cmp	ax, [chs_limit]
  1810 000008E3 760F                    	jna	short cpp_17
  1811                                  cpp_16:
  1812 000008E5 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  1813 000008E9 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  1814 000008ED C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  1815 000008F1 E9C801                  	jmp	cpp_15
  1816                                  cpp_17:
  1817 000008F4 A0[803F]                	mov	al, [heads]
  1818 000008F7 FEC8                    	dec	al
  1819 000008F9 884405                  	mov	[si+ptEndHead], al
  1820 000008FC A0[7E3F]                	mov	al, [sectors]
  1821 000008FF 884406                  	mov	[si+ptEndSector], al
  1822 00000902 A1[823F]                	mov	ax, [cylinders]
  1823 00000905 48                      	dec	ax
  1824 00000906 884407                  	mov	[si+ptEndCylinder], al
  1825 00000909 C0E406                  	shl	ah, 6
  1826 0000090C 086406                  	or	[si+ptEndSector], ah
  1827                                  
  1828                                  	;jmp	cpp_16
  1829 0000090F E9AA01                  	jmp	cpp_15 ; 06/03/2019
  1830                                  cpp_5:
  1831                                  	; 18/02/2019
  1832 00000912 803E[7C70]59            	cmp	byte [cylinder_boundary], 'Y'
  1833 00000917 753D                    	jne	short cpp_7
  1834                                  
  1835 00000919 30DB                    	xor	bl, bl ; head  = 0
  1836                                  
  1837 0000091B 8B8D[2A70]              	mov	cx, [di+free_space.start]
  1838                                  
  1839                                  	; 06/03/2019
  1840                                  	;or	ax, ax
  1841                                  	;jnz	short cpp_6
  1842                                  
  1843                                  	;and	cx, cx  ; start cylinder = 0 ?
  1844                                  	;jnz	short cpp_6
  1845                                  
  1846 0000091F 09C8                    	or	ax, cx
  1847                                  	;jnz	short cpp_6
  1848 00000921 740B                    	jz	short cpp_24 ; 31/10/2020
  1849                                  
  1850                                  	; 31/10/2020
  1851 00000923 A0[7E3F]                	mov	al, [sectors]
  1852 00000926 F626[803F]              	mul	byte [heads]
  1853 0000092A F7E1                    	mul	cx
  1854                                  	; dx:ax = LBA sector address
  1855                                  	; bl = head = 0
  1856                                  	; cx = cylinder number
  1857                                  	; ax = sector number
  1858 0000092C EB07                    	jmp	short cpp_6
  1859                                  cpp_24:
  1860 0000092E A1[7E3F]                	mov	ax, [sectors]
  1861                                  	; cylinder 0, head 1, sector 1 (LBA = 17 or 63)
  1862 00000931 FEC3                    	inc	bl  ; head = 1
  1863 00000933 31D2                    	xor	dx, dx ; 0
  1864                                  cpp_6:
  1865                                  	; 31/10/2020
  1866 00000935 894408                  	mov	[si+ptStartSector], ax
  1867 00000938 89540A                  	mov	[si+ptStartSector+2], dx
  1868                                  
  1869 0000093B A3[E86C]                	mov	[pp_StartSector], ax
  1870 0000093E 8916[EA6C]              	mov	[pp_StartSector+2], dx
  1871                                  
  1872 00000942 09C9                    	or	cx, cx  ; start cylinder ?
  1873 00000944 7508                    	jnz	short cpp_25 ; > 0
  1874                                  	
  1875                                  	;and	bl, bl  ; head = 0 ?
  1876                                  	;jz	short cpp_25
  1877                                  
  1878                                  	; cylinder = 0, head = 1, dx:ax = [sectors]
  1879                                  
  1880                                  	;sub	[pp_Sectors], ax
  1881                                  	;sbb	[pp_Sectors+2], cx ; 0
  1882                                  
  1883 00000946 2906[1A6D]              	sub	[ppn_Sectors], ax
  1884 0000094A 190E[1C6D]              	sbb	[ppn_Sectors+2], cx ; 0
  1885                                  cpp_25:
  1886 0000094E 89C8                    	mov	ax, cx
  1887                                  	; 29/10/2020
  1888 00000950 C6440201                	mov	byte [si+ptBeginSector], 1 ; sector = 1	
  1889 00000954 EB16                    	jmp	short cpp_8
  1890                                  cpp_7:
  1891                                  	; 18/02/2019
  1892                                  
  1893                                  	; [wholedisk] = 0
  1894                                  
  1895                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  1896                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  1897                                  	; if it is 65536 sectors.)
  1898                                  	
  1899 00000956 E87301                  	call	fix_32mb_dos_psize
  1900                                  		; bx:cx = [ppn_sectors] = partition size
  1901                                  		; dx:ax = start sector's LBA 
  1902                                  
  1903                                  	;cylinder = LBA / (heads_per_cylinder * sectors_per_track)
  1904                                  	;temp = LBA % (heads_per_cylinder * sectors_per_track)
  1905                                  	;head = temp / sectors_per_track
  1906                                  	;sector = temp % sectors_per_track + 1
  1907                                  	
  1908                                  	; Convert LBA sector address to CHS parameters
  1909 00000959 8B0E[7E3F]              	mov	cx, [sectors]
  1910 0000095D E81D03                  	call	div32
  1911                                  	; BX = Sector number - 1
  1912 00000960 FEC3                    	inc	bl ; sector number (1 based)
  1913 00000962 885C02                  	mov	[si+ptBeginSector], bl	
  1914                                  	; DX_AX = cylinders * heads + head
  1915 00000965 8B0E[803F]              	mov	cx, [heads]
  1916 00000969 E81103                  	call	div32
  1917                                  	; ax = cylinder
  1918                                  	; bl = head
  1919                                  cpp_8:
  1920                                  	; 24/10/2020
  1921                                  	;mov	bh, 1  ; [si+ptBeginSector]
  1922 0000096C 3DFF03                  	cmp	ax, 1023  ; CHS limit
  1923 0000096F 7609                    	jna	short cpp_18	
  1924                                  	; > CHS limit
  1925 00000971 B8FF03                  	mov	ax, 1023 ; cylinder
  1926 00000974 B3FE                    	mov	bl, 0FEh ; 254 (head)
  1927                                  	;mov	bh, 3Fh ; 63 (sector)
  1928                                  	; 26/10/2020
  1929 00000976 C644023F                	mov	byte [si+ptBeginSector], 3Fh
  1930                                  cpp_18:
  1931                                  	; BL = Head number
  1932 0000097A 885C01                  	mov	[si+ptBeginHead], bl
  1933                                  	; AX = Cylinder number
  1934                                  	;and	ax, 1023
  1935 0000097D 884403                  	mov	[si+ptBeginCylinder], al
  1936 00000980 C0E406                  	shl	ah, 6
  1937                                  	; 24/10/2020
  1938                                  	;or	ah, bh	; bh = sector number
  1939                                  	; 26/10/2020
  1940 00000983 086402                  	or	[si+ptBeginSector], ah
  1941                                  	;mov	[si+ptBeginSector], ah
  1942                                  
  1943                                  	; clear active partition flag (for now)
  1944                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  1945 00000986 C60400                  	mov	byte [si], 0 ; not bootable/active partition
  1946                                  
  1947                                  	;mov	di, [c_fspc_offset]
  1948                                  
  1949 00000989 803E[7C70]59            	cmp	byte [cylinder_boundary], 'Y'
  1950 0000098E 0F858000                	jne	cpp_11
  1951                                  
  1952 00000992 8A0E[803F]              	mov	cl, [heads]
  1953 00000996 A0[7E3F]                	mov	al, [sectors]
  1954 00000999 88C5                    	mov	ch, al
  1955 0000099B F6E1                    	mul	cl	
  1956                                  	; ax = heads*sectors
  1957                                  
  1958 0000099D 8B9D[2C70]              	mov	bx, [di+free_space.end]	; end cylinder of the partition
  1959                                  
  1960 000009A1 803E[F06C]00            	cmp	byte [wholedisk], 0 ; entire free space ?
  1961 000009A6 7721                    	ja	short cpp_10
  1962                                  
  1963 000009A8 89C3                    	mov	bx, ax
  1964 000009AA A1[1A6D]                	mov	ax, [ppn_Sectors]
  1965 000009AD 8B16[1C6D]              	mov	dx, [ppn_Sectors+2]
  1966 000009B1 0306[E86C]              	add	ax, [pp_StartSector]
  1967 000009B5 1316[EA6C]              	adc	dx, [pp_StartSector+2]
  1968 000009B9 83E801                  	sub	ax, 1
  1969 000009BC 83DA00                  	sbb	dx, 0
  1970                                  		; dx:ax = end sector
  1971 000009BF F7F3                    	div	bx
  1972                                  		; ax = cylinder number
  1973                                  	; 31/10/2020
  1974                                  	;and	dx, dx
  1975                                  	;jz	short cpp_9
  1976                                  	;inc	ax ; + 1 (because of remainder > 0)
  1977                                  cpp_9:	
  1978 000009C1 93                      	xchg	ax, bx
  1979                                  		; bx = end cylinder
  1980                                  		; ax = heads*sectors
  1981                                  	; free space limit check
  1982 000009C2 3B9D[2C70]              	cmp	bx, [di+free_space.end]
  1983 000009C6 7601                    	jna	short cpp_10 ; ok
  1984                                  	; end cylinder is out of free space
  1985 000009C8 4B                      	dec	bx  ; decrease end cylinder number
  1986                                  cpp_10: 
  1987 000009C9 F7E3                    	mul	bx
  1988                                  		 ; dx:ax = (end cylinder)*heads*sectors
  1989 000009CB 52                      	push	dx ; **
  1990 000009CC 50                      	push	ax ; *
  1991                                  
  1992                                  	; 24/10/2020
  1993 000009CD 81FBFF03                	cmp	bx, 1023  ; CHS limit
  1994 000009D1 7606                    	jna	short cpp_19	
  1995                                  	; > CHS limit
  1996 000009D3 BBFF03                  	mov	bx, 1023 ; cylinder
  1997                                  	;mov	cl, 0FFh ; 255 (head+1)
  1998                                  	;mov	ch, 3Fh ; 63 (sector)
  1999 000009D6 B9FF3F                  	mov	cx, 3FFFh
  2000                                  cpp_19:
  2001 000009D9 FEC9                    	dec	cl ; heads - 1 = end head
  2002                                  
  2003 000009DB 884C05                  	mov	[si+ptEndHead], cl
  2004                                  	; 26/10/2020
  2005                                  	;mov	al, [sectors]
  2006                                  	; 31/10/2020
  2007 000009DE 88E8                    	mov	al, ch
  2008 000009E0 885C07                  	mov	[si+ptEndCylinder], bl
  2009                                  	;mov	bl, al
  2010                                  	;shl	bh, 6 ; shift high bytes (2 bits) of end cyl num
  2011                                  	;	      ; to 6 bits left	
  2012                                  	;or	bh, bl ; combine high bits of end cyl num and end sector
  2013 000009E3 C0E706                  	shl	bh, 6
  2014 000009E6 08EF                    	or	bh, ch ; ch = end sector (= sectors)
  2015 000009E8 887C06                  	mov	[si+ptEndSector], bh
  2016                                  
  2017                                  	; 24/10/2020
  2018                                  	;mov	bl, [sectors]
  2019                                  	;xor	bh, bh ; clear bh
  2020 000009EB 8B1E[7E3F]              	mov	bx, [sectors] ; 17 or 63
  2021                                  
  2022 000009EF FECB                    	dec	bl ; sectors - 1 ; 22/02/2019
  2023 000009F1 F6E1                    	mul	cl ; sectors * [end head]
  2024 000009F3 5A                      	pop	dx ; *
  2025                                  	; 22/02/2019
  2026 000009F4 31C9                    	xor	cx, cx
  2027 000009F6 01D0                    	add	ax, dx
  2028 000009F8 5A                      	pop	dx ; **
  2029 000009F9 11CA                    	adc	dx, cx ; 0
  2030 000009FB 01D8                    	add	ax, bx
  2031 000009FD 11CA                    	adc	dx, cx ; 0
  2032                                  	; dx:ax = ((([end cylinder]*heads)+[end head])*sectors)+sectors-1
  2033                                  
  2034                                  	; calculate aligned partition size in sectors
  2035 000009FF 89C1                    	mov	cx, ax
  2036 00000A01 89D3                    	mov	bx, dx
  2037 00000A03 83C101                  	add	cx, 1
  2038 00000A06 83D300                  	adc	bx, 0	
  2039 00000A09 2B4C08                  	sub	cx, [si+ptStartSector]
  2040 00000A0C 1B5C0A                  	sbb	bx, [si+ptStartSector+2]
  2041                                  		; bx:cx = partition size
  2042                                  	;mov	[ppn_Sectors], cx
  2043                                  	;mov	[ppn_Sectors+2], bx
  2044                                  	;jmp	cpp_16
  2045 00000A0F E9AA00                  	jmp	cpp_15 ; 06/03/2019
  2046                                  cpp_11:
  2047                                  	; 20/02/2019
  2048 00000A12 8B0E[1A6D]              	mov	cx, [ppn_Sectors]
  2049 00000A16 8B1E[1C6D]              	mov	bx, [ppn_Sectors+2]
  2050                                  
  2051                                  	;;mov	ax, [di+free_space.startsector]
  2052                                  	;;mov	ax, [di+free_space.startsector+2]
  2053                                  	;mov	ax, [si+ptStartSector]
  2054                                  	;mov	dx, [si+ptStartSector+2]
  2055 00000A1A A1[E86C]                	mov	ax, [pp_StartSector]
  2056 00000A1D 8B16[EA6C]              	mov	dx, [pp_StartSector+2]
  2057                                  cpp_12:	
  2058                                  	; 18/02/2019
  2059                                  
  2060                                  	; [wholedisk] = 0
  2061                                  
  2062                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  2063                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  2064                                  	; if it is 65536 sectors.)
  2065                                  
  2066 00000A21 E8A800                  	call	fix_32mb_dos_psize
  2067                                  		; bx:cx = [ppn_sectors] = partition size
  2068                                  		; dx:ax = start sector's LBA
  2069                                  
  2070 00000A24 01C8                    	add	ax, cx
  2071 00000A26 11DA                    	adc	dx, bx
  2072                                  
  2073                                  	; Convert LBA sector address to CHS parameters
  2074 00000A28 83E801                  	sub	ax, 1 ; locate on to end sector of the partition
  2075 00000A2B 83DA00                  	sbb	dx, 0
  2076                                  
  2077                                  	; 06/03/2019
  2078 00000A2E 803E[7C70]59            	cmp	byte [cylinder_boundary],'Y'
  2079                                  	;jne	short cpp_15
  2080 00000A33 754D                    	jne	short cpp_14
  2081                                  
  2082 00000A35 89C1                    	mov	cx, ax
  2083 00000A37 A0[803F]                	mov	al, [heads]
  2084 00000A3A F626[7E3F]              	mul	byte [sectors]
  2085 00000A3E 89C7                    	mov	di, ax ; [heads]*[sectors]
  2086 00000A40 91                      	xchg	ax, cx
  2087                                  		; cx = heads*spt
  2088                                  
  2089 00000A41 E83902                  	call	div32
  2090                                  		; dx = 0
  2091                                  		; ax = end cylinder
  2092                                  		; bx = remainder	
  2093                                  	;and	bx, bx
  2094                                  	;jz	short cpp_13
  2095                                  	;inc	ax
  2096                                  ;cpp_13:
  2097                                  	;cmp	ax, [cylinders]
  2098                                  	;jb	short cpp_14
  2099                                  	;dec	ax
  2100                                  ;cpp_14:
  2101                                  
  2102                                  	; 26/10/2020
  2103 00000A44 3DFF03                  	cmp	ax, 1023
  2104 00000A47 760E                    	jna	short cpp_20
  2105                                  
  2106 00000A49 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2107 00000A4D C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2108 00000A51 C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2109 00000A55 EB1A                    	jmp	short cpp_21
  2110                                  cpp_20:
  2111 00000A57 8B1E[803F]              	mov	bx, [heads]
  2112 00000A5B FECB                    	dec	bl
  2113 00000A5D 885C05                  	mov	[si+ptEndHead], bl
  2114 00000A60 8B0E[7E3F]              	mov	cx, [sectors]
  2115 00000A64 88E2                    	mov	dl, ah
  2116 00000A66 C0E206                  	shl	dl, 6
  2117 00000A69 08CA                    	or	dl, cl
  2118 00000A6B 885406                  	mov	[si+ptEndSector], dl
  2119 00000A6E 884407                  	mov	[si+ptEndCylinder], al	
  2120                                  	;mul	di ; [cylinders]*[heads]*[sectors]
  2121                                  	;;sub	di, cx ; ([heads] - 1) * [sectors]
  2122                                  	;add	ax, di
  2123                                  	;adc	dx, 0
  2124                                  	;;add	ax, cx
  2125                                  	;;adc	dx, 0
  2126                                  cpp_21:
  2127 00000A71 40                      	inc	ax
  2128 00000A72 F7E7                    	mul	di  ; result = start LBA of next cylinder
  2129                                  	; dx:ax = end sector LBA + 1 (as cyl. boundary aligned)
  2130 00000A74 2B06[E86C]              	sub	ax, [pp_StartSector]
  2131 00000A78 1B16[EA6C]              	sbb	dx, [pp_StartSector+2]
  2132                                  
  2133 00000A7C 89C1                    	mov	cx, ax
  2134 00000A7E 89D3                    	mov	bx, dx
  2135                                  	;jmp	short cpp_16
  2136 00000A80 EB3A                    	jmp	short cpp_15
  2137                                  ;cpp_15:
  2138                                  cpp_14:
  2139 00000A82 8B0E[7E3F]              	mov	cx, [sectors]
  2140 00000A86 E8F401                  	call	div32
  2141                                  	; BX = Sector number - 1
  2142 00000A89 FEC3                    	inc	bl ; sector number (1 based)
  2143 00000A8B 885C06                  	mov	[si+ptEndSector], bl	
  2144                                  	; DX_AX = cylinders * heads + head
  2145 00000A8E 8B0E[803F]              	mov	cx, [heads]
  2146 00000A92 E8E801                  	call	div32
  2147                                  	; BX = Head number
  2148 00000A95 885C05                  	mov	[si+ptEndHead], bl
  2149                                  	; AX = Cylinder number
  2150                                  	;and	ax, 1023
  2151                                  
  2152                                  	; 26/10/2020
  2153 00000A98 3DFF03                  	cmp	ax, 1023
  2154 00000A9B 760E                    	jna	short cpp_22
  2155                                  		
  2156 00000A9D C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2157 00000AA1 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2158 00000AA5 C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2159 00000AA9 EB09                    	jmp	short cpp_23
  2160                                  cpp_22:
  2161 00000AAB 884407                  	mov	[si+ptEndCylinder], al
  2162                                  	; 18/02/2019
  2163 00000AAE C0E406                  	shl	ah, 6
  2164 00000AB1 086406                  	or	[si+ptEndSector], ah
  2165                                  cpp_23:
  2166 00000AB4 8B0E[1A6D]              	mov	cx, [ppn_Sectors]
  2167 00000AB8 8B1E[1C6D]              	mov	bx, [ppn_Sectors+2]
  2168                                  ;cpp_16:
  2169                                  cpp_15:
  2170 00000ABC 894C0C                  	mov	[si+ptSectors], cx
  2171 00000ABF 895C0E                  	mov	[si+ptSectors+2], bx
  2172                                  
  2173                                  	; set partition ID after checking DOS FAT limits
  2174 00000AC2 E8EF00                  	call	set_partition_id
  2175                                  	; al = partition ID
  2176                                  
  2177 00000AC5 A2[F16C]                	mov	[pp_type], al
  2178                                  
  2179 00000AC8 884404                  	mov	[si+ptFileSystemID], al
  2180                                  
  2181 00000ACB C3                      	retn
  2182                                  
  2183                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2184                                  ; decrease DOS partition size when it is (exact) 65536 sectors
  2185                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2186                                  ; 18/02/2019
  2187                                  
  2188                                  fix_32mb_dos_psize:	; call this if [wholedisk] = 0
  2189                                  
  2190                                  ; Purpose: 
  2191                                  ;	If a DOS partition's size is 65536 sectors
  2192                                  ;	MSDOS 3.3 can not use it. (FAT 16 partition ID = 06h)
  2193                                  ;	Decreasing partition size to 65535 sectors will ensure
  2194                                  ;	MSDOS 3.3 compatibility (FAT 16 partition ID will be 04h).
  2195                                  
  2196                                  	; INPUT:
  2197                                  	;    BX:CX = partition size in sectors
  2198                                  	;    [pp_type] = partition type dos, non-dos, user input
  2199                                  	;
  2200                                  	; OUTPUT:
  2201                                  	;    Partition size will be changed to 65535 sectors, if
  2202                                  	;    	- partition size is 65536 sectors and
  2203                                  	; 	- [pp_type] is 1 (DOS)
  2204                                  	;
  2205                                  	;    [ppn_Sectors] = 65535 (if it will be changed)
  2206                                  	;
  2207                                  	; (Modified registers: cx, bx) 
  2208                                  
  2209                                  	;mov	cx, [ppn_Sectors]
  2210                                  	;mov	bx, [ppn_Sectors+2]
  2211                                  
  2212 00000ACC 803E[F16C]01            	cmp	byte [pp_type], 1 ;  DOS partition
  2213 00000AD1 7513                    	jne	short psfx_0  ; non-dos partition or user input
  2214                                  			      ; nothing to do ! 	
  2215 00000AD3 09C9                    	or	cx, cx
  2216 00000AD5 750F                    	jnz	short psfx_0 ; <> 65536 sectors
  2217 00000AD7 83FB01                  	cmp	bx, 1
  2218 00000ADA 750A                    	jne	short psfx_0
  2219 00000ADC 4B                      	dec	bx
  2220                                  	;mov	[wholedisk], bx ; 0
  2221 00000ADD 49                      	dec	cx  ; bx:cx = 65535
  2222 00000ADE 890E[1A6D]              	mov	[ppn_Sectors], cx
  2223 00000AE2 891E[1C6D]              	mov	[ppn_Sectors+2], bx
  2224                                  psfx_0:
  2225 00000AE6 C3                      	retn
  2226                                  
  2227                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2228                                  ; create extended dos partition
  2229                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2230                                  ; 24/10/2020 (fdisk3.s)
  2231                                  
  2232                                  ; 16/02/2019 (hdimage.s) 
  2233                                  ;	(This procedure must be called after 'find_part_free_space')
  2234                                  
  2235                                  create_extended_partition:  
  2236                                  	; 15/02/2019
  2237                                  
  2238                                  	; INPUT:
  2239                                  	;	none 
  2240                                  	;  (CHS parameters and free space calculation result will be used.) 
  2241                                  	;
  2242                                  	; OUTPUT:
  2243                                  	;	Partition table in MBR buffer will be updated.
  2244                                  	;
  2245                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  2246                                  
  2247                                  	; Create extended dos partition, make partition table entry
  2248                                  	; (Extended partition will be created on cylinder bounds.)
  2249                                  
  2250                                  	; 16/02/2019
  2251 00000AE7 E8C21C                  	call	get_first_free_pte
  2252                                  		 ; CX = First free PTE number, 0 to 3 
  2253                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  2254                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  2255                                   	 	 ; SI = PTE addres/offset in MBR buffer
  2256                                  
  2257                                  	;mov	si, MasterBootBuff+pTableOffset
  2258                                  	;shl	cl, 4 ; * 16
  2259                                  	;add	si, cx
  2260                                  	
  2261 00000AEA 8B1E[7A70]              	mov	bx, [c_fspc_offset]
  2262                                  	
  2263 00000AEE 8B87[2A70]              	mov	ax, [bx+free_space.start]
  2264                                  
  2265                                  	; 24/10/2020
  2266 00000AF2 89C7                    	mov	di, ax
  2267                                  	;mov	cx, 1
  2268 00000AF4 B101                    	mov	cl, 1 ; head (ch) = 0, sector (cl) = 1
  2269                                  
  2270 00000AF6 3DFF03                  	cmp	ax, 1023
  2271 00000AF9 7606                    	jna	short cep_4
  2272                                  
  2273                                  	; partition start  > CHS limit
  2274 00000AFB B8FF03                  	mov	ax, 1023
  2275                                  	;mov	ch, 254
  2276                                  	;mov	cl, 63
  2277 00000AFE B93FFE                  	mov	cx, 0FE3Fh
  2278                                  cep_4:	
  2279                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  2280                                  	;mov	[si], ch ; 0 ; not bootable/active partition
  2281                                  	; 26/10/2020
  2282 00000B01 C60400                  	mov	byte [si], 0
  2283 00000B04 886C01                  	mov	[si+ptBeginHead], ch
  2284 00000B07 C0E406                  	shl	ah, 6
  2285 00000B0A 08E1                    	or	cl, ah
  2286 00000B0C 884C02                  	mov	[si+ptBeginSector], cl ; Sector 1 
  2287 00000B0F 884403                  	mov	[si+ptBeginCylinder], al
  2288                                  
  2289 00000B12 A0[803F]                	mov	al, [heads]
  2290 00000B15 F626[7E3F]              	mul	byte [sectors]
  2291                                  		; ax = heads*sectors
  2292 00000B19 F7E7                    	mul	di  ; AX * cylinder count before start cylinder
  2293                                  		; DX:AX = LBA of cylinder DI, head 0, sector 1 
  2294                                  
  2295 00000B1B 894408                  	mov	[si+ptStartSector], ax
  2296 00000B1E 89540A                  	mov	[si+ptStartSector+2], dx
  2297                                  
  2298                                  	; This is not needed for extended partition.
  2299                                  	; 16/02/2019
  2300                                  	;mov	[pp_StartSector], ax
  2301                                  	;mov	[pp_StartSector+2], dx
  2302                                  
  2303                                  	; 16/02/2019
  2304 00000B21 803E[F06C]00            	cmp	byte [wholedisk], 0
  2305 00000B26 772A                    	ja	short cep_2 ; all of free space will be used
  2306                                  			    ; ([bx+free_space.end] will be end cyl)	
  2307                                  
  2308                                  	; calculate cylinder count (from partition size input)
  2309 00000B28 A0[803F]                	mov	al, [heads]
  2310 00000B2B F626[7E3F]              	mul	byte [sectors]
  2311 00000B2F 89C1                    	mov	cx, ax
  2312 00000B31 A1[1A6D]                	mov	ax, [ppn_Sectors]
  2313 00000B34 8B16[1C6D]              	mov	dx, [ppn_Sectors+2]
  2314 00000B38 E84201                  	call	div32
  2315                                  		; ax = cylinders
  2316                                  		; bx = remainder
  2317 00000B3B 21DB                    	and	bx, bx
  2318 00000B3D 7401                    	jz	short cep_1
  2319                                  
  2320 00000B3F 40                      	inc	ax  ; round up
  2321                                  cep_1:
  2322                                  	; 16/02/2019
  2323                                  	; DI  = extended partition's start cylinder
  2324 00000B40 89C2                    	mov	dx, ax ; cylinder count
  2325 00000B42 01FA                    	add	dx, di ; result is end cyl + 1
  2326 00000B44 4A                      	dec	dx ; decrease number for current end cylinder
  2327 00000B45 8B1E[7A70]              	mov	bx, [c_fspc_offset]
  2328 00000B49 3B97[2C70]              	cmp	dx, [bx+free_space.end]
  2329 00000B4D 7607                    	jna	short cep_3
  2330                                  	; 24/10/2020
  2331                                  	;dec	ax ; decrease cylinder count down to the limit
  2332 00000B4F 4A                      	dec	dx ; decrease end cylinder down to the limit
  2333 00000B50 EB04                    	jmp	short cep_3 	
  2334                                  cep_2:
  2335 00000B52 8B97[2C70]              	mov	dx, [bx+free_space.end]
  2336                                  	;mov	ax, [bx+free_space.space]
  2337                                  cep_3:
  2338                                  	; 24/10/2020
  2339 00000B56 89D0                    	mov	ax, dx ; end cylinder
  2340 00000B58 B305                    	mov	bl, 05h	; Extended Partition ID (CHS)
  2341 00000B5A 3DFF03                  	cmp	ax, 1023
  2342 00000B5D 760A                    	jna	short cep_5
  2343                                  
  2344                                  	; partition end > CHS limit
  2345 00000B5F B8FF03                  	mov	ax, 1023
  2346                                  	;mov	ch, 254
  2347                                  	;mov	cl, 63
  2348 00000B62 B93FFE                  	mov	cx, 0FE3Fh
  2349 00000B65 B30F                    	mov	bl, 0Fh	; Extended Partition ID (LBA)
  2350 00000B67 EB0A                    	jmp	short cep_6
  2351                                  cep_5:
  2352 00000B69 8A2E[803F]              	mov	ch, [heads]
  2353 00000B6D FECD                    	dec	ch 
  2354 00000B6F 8A0E[7E3F]              	mov	cl, [sectors]
  2355                                  cep_6:
  2356 00000B73 886C05                  	mov	[si+ptEndHead], ch
  2357                                  	; 24/10/2020
  2358                                  	; ax = (chs limit compatible) end cylinder (<= 1023)
  2359                                  	; 23/02/2019
  2360                                  	;mov	bl, dh
  2361                                  	;shl	bl, 6
  2362                                  	;or	bl, cl
  2363 00000B76 C0E406                  	shl	ah, 6
  2364 00000B79 08E1                    	or	cl, ah
  2365                                  	;mov	[si+ptEndSector], bl
  2366 00000B7B 884C06                  	mov	[si+ptEndSector], cl	
  2367                                  	;mov	[si+ptEndCylinder], dl
  2368 00000B7E 884407                  	mov	[si+ptEndCylinder], al
  2369                                  	; dx = (lba compatible) end cylinder (up to 65535)
  2370                                  
  2371                                  	;mov	al, [heads]
  2372                                  	; 26/10/2020
  2373                                  	;;mul	cl
  2374                                  	;mul	byte [sectors]
  2375 00000B81 8A2E[803F]              	mov	ch, [heads]
  2376 00000B85 A0[7E3F]                	mov	al, [sectors]
  2377 00000B88 F6E5                    	mul	ch	
  2378                                  	; ax = heads*sectors	
  2379 00000B8A F7E2                    	mul	dx ; AX * cylinder count before end cylinder
  2380                                  		; DX:AX = LBA of cylinder DX, head 0, sector 1
  2381 00000B8C 52                      	push	dx
  2382 00000B8D 50                      	push	ax
  2383 00000B8E 88E8                    	mov	al, ch
  2384 00000B90 FEC8                    	dec	al ; 26/10/2020 ; [heads] - 1
  2385 00000B92 8B0E[7E3F]              	mov	cx, [sectors]  ; 63 or 17
  2386 00000B96 F6E1                    	mul	cl
  2387                                  		; ax = (heads-1)*sectors
  2388 00000B98 5A                      	pop	dx
  2389 00000B99 01D0                    	add	ax, dx
  2390 00000B9B 5A                      	pop	dx
  2391 00000B9C 83D200                  	adc	dx, 0
  2392                                  		; dx:ax = ((end cylinder)*heads)+(heads-1)*sectors
  2393 00000B9F 01C8                    	add	ax, cx
  2394 00000BA1 83D200                  	adc	dx, 0
  2395                                  	; dx:ax = (((end cylinder)*heads)+(heads-1)*sectors) + sectors
  2396                                  	; dx:ax = LBA of the partition's end sector + 1
  2397 00000BA4 2B4408                  	sub	ax, [si+ptStartSector]
  2398 00000BA7 1B540A                  	sbb	dx, [si+ptStartSector+2] 
  2399                                  
  2400 00000BAA 89440C                  	mov	[si+ptSectors], ax
  2401 00000BAD 89540E                  	mov	[si+ptSectors+2], dx
  2402                                  
  2403                                  	;mov	[pp_type], al
  2404                                  
  2405                                  	;mov	byte [si+ptFileSystemID], 5
  2406                                  	; 24/10/2020
  2407 00000BB0 885C04                  	mov	 [si+ptFileSystemID], bl ; 05h or 0Fh
  2408                                  	
  2409 00000BB3 C3                      	retn
  2410                                  
  2411                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2412                                  ; set DOS (and non-dos) partition ID according to partition size
  2413                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2414                                  ; 23/10/2020
  2415                                  
  2416                                  set_partition_id: 
  2417                                  	; 23/10/2020 (fdisk3.s)
  2418                                  	; input:
  2419                                  	;   si = partition table offset
  2420                                  	;   bx:cx = partition size
  2421                                  
  2422                                  	; 18/02/2019 (hdimage.s)
  2423                                  	;mov	cx, [ppn_Sectors]
  2424                                  	;mov	bx, [ppn_Sectors+2]
  2425                                  
  2426 00000BB4 A0[F16C]                	mov	al, [pp_type]
  2427                                  
  2428                                  	;cmp	byte [pp_type], 1
  2429 00000BB7 3C01                    	cmp	al, 1 ; primary DOS (FAT12, FAT16, FAT32)
  2430 00000BB9 7519                    	jne	short spid_2 ; singlix, runix or user type 
  2431                                  
  2432                                  	;mov	al, 1	; FAT12
  2433                                  
  2434 00000BBB 09DB                    	or	bx, bx
  2435 00000BBD 750A                    	jnz	short spid_1
  2436                                  
  2437 00000BBF 81F9A87F                	cmp	cx, 32680
  2438                                  	;jna	short spid_8	; FAT12 file system
  2439 00000BC3 761C                    	jna	short spid_19 ; 23/10/2020
  2440                                  
  2441 00000BC5 B004                    	mov	al, 4	; FAT16 (< 32MB)
  2442                                  
  2443 00000BC7 EB39                    	jmp	short spid_8	; FAT16 (CHS) file system
  2444                                  
  2445                                  spid_1:
  2446 00000BC9 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  2447                                  
  2448 00000BCB 83FB10                  	cmp	bx, 10h
  2449 00000BCE 7332                    	jnb	short spid_8	; FAT32 (CHS) file system
  2450                                  
  2451 00000BD0 B006                    	mov	al, 6	; FAT16 (>= 32MB)
  2452                                  
  2453 00000BD2 EB2E                    	jmp	short spid_8	; FAT16 big (CHS) file system
  2454                                  
  2455                                  spid_2:
  2456                                  	;cmp	byte [pp_type], 2 ; Singlix FS
  2457 00000BD4 3C02                    	cmp	al, 2
  2458 00000BD6 7503                    	jne	short spid_3
  2459 00000BD8 B0A1                    	mov	al, 0A1h
  2460                                  	;jmp	short spid_8
  2461 00000BDA C3                      	retn	; 23/10/2020
  2462                                  spid_3:
  2463                                  	;cmp	byte [pp_type], 3 ; Retro Unix FS
  2464 00000BDB 3C03                    	cmp	al, 3
  2465 00000BDD 7503                    	jne	short spid_4
  2466 00000BDF B071                    	mov	al, 71h	
  2467                                  	;jmp	short spid_8
  2468                                  spid_19:
  2469 00000BE1 C3                      	retn
  2470                                  
  2471                                  spid_4:
  2472                                  	; another partition type (user input)
  2473                                  	
  2474                                  	; [pp_type] = 4
  2475                                  
  2476 00000BE2 A0[F26C]                	mov	al, [pp_type_user]
  2477                                  
  2478                                  	; Check FAT12 fs size validation
  2479                                  
  2480 00000BE5 3C01                    	cmp	al, 1 ; FAT12
  2481 00000BE7 7737                    	ja	short spid_9
  2482                                  
  2483 00000BE9 21DB                    	and	bx, bx
  2484 00000BEB 750A                    	jnz	short spid_6
  2485                                  
  2486 00000BED 81F9A87F                	cmp	cx, 32680
  2487                                  	;jna	short spid_8
  2488 00000BF1 76EE                    	jna	short spid_19 ; 23/10/2020 
  2489                                  spid_5:
  2490 00000BF3 B004                    	mov	al, 4 ; FAT16 (<= 32MB) 
  2491 00000BF5 EB0B                    	jmp	short spid_8
  2492                                  spid_6:
  2493                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  2494                                  	; 15/03/2021
  2495 00000BF7 83FB40                  	cmp	bx, 40h ; 2GB (64*32MB)
  2496 00000BFA 7304                    	jnb	short spid_7
  2497                                  	
  2498 00000BFC B006                    	mov	al, 6
  2499 00000BFE EB02                    	jmp	short spid_8
  2500                                  spid_7:
  2501 00000C00 B00B                    	mov	al, 0Bh ; FAT32 (CHS) partition
  2502                                  spid_8:
  2503                                  	; 23/10/2020
  2504                                  	; check the partition's end sector against CHS limit and
  2505                                  	; convert partition ID if the partition overs CHS limit
  2506                                  	;cmp	al, 1  ; FAT12 fs
  2507                                  	;je	short spid_19 ; nothing to do (for FAT12 fs)
  2508 00000C02 034C08                  	add	cx, [si+ptStartSector]
  2509 00000C05 135C0A                  	adc	bx, [si+ptStartSector+2]
  2510 00000C08 3B1E[5C68]              	cmp	bx, [chs_limit+2] ; 07/11/2020
  2511 00000C0C 72D3                    	jb	short spid_19 ; partition's end sector is in CHS limit 
  2512 00000C0E 7706                    	ja	short spid_17 ; out of CHS limit
  2513 00000C10 3B0E[5A68]              	cmp	cx, [chs_limit]
  2514 00000C14 76CB                    	jna	short spid_19 ; partition's end sector is in CHS limit
  2515                                  spid_17:
  2516                                  	; out of CHS limit, partition ID conversion is needed
  2517 00000C16 3C0B                    	cmp	al, 0Bh	; FAT32 CHS
  2518 00000C18 7203                    	jb	short spid_18
  2519 00000C1A B00C                    	mov	al, 0Ch	; FAT 32 LBA
  2520 00000C1C C3                      	retn
  2521                                  spid_18:
  2522 00000C1D B00E                    	mov	al, 0Eh ; FAT16 LBA
  2523 00000C1F C3                      	retn
  2524                                  spid_9:
  2525 00000C20 3C04                    	cmp	al, 4 ; FAT16 (< 32 MB)
  2526 00000C22 750C                    	jne	short spid_10
  2527                                  
  2528 00000C24 09DB                    	or	bx, bx
  2529 00000C26 75CF                    	jnz	short spid_6
  2530                                  
  2531                                  	; 15/03/2021
  2532 00000C28 81F93610                	cmp	cx, 4150 ; 4085 + 32 + 32 + 1
  2533 00000C2C 7217                    	jb	short spid_12
  2534                                  	
  2535                                  	;retn	; FAT16 (< 32 MB) partition
  2536 00000C2E EBD2                    	jmp	short spid_8  ; 23/10/2020
  2537                                  
  2538                                  spid_10:
  2539 00000C30 3C06                    	cmp	al, 6 ; FAT 16 big partition
  2540 00000C32 7514                    	jne	short spid_13 ; Extended partition or another type
  2541                                  	
  2542 00000C34 21DB                    	and	bx, bx
  2543 00000C36 7407                    	jz	short spid_11
  2544                                  
  2545                                  	;cmp	bx, 10h	; 512MB (16*32MB)
  2546                                  	; 15/03/2021
  2547 00000C38 83FB40                  	cmp	bx, 40h ; 2GB (64*32MB)
  2548 00000C3B 73C3                    	jnb	short spid_7
  2549                                  
  2550                                  	;retn
  2551 00000C3D EBC3                    	jmp	short spid_8 ; 23/10/2020
  2552                                  
  2553                                  spid_11:
  2554                                  	;cmp	ax, 4150 ; 4085 + 32 + 32 + 1
  2555 00000C3F 81F93610                	cmp	cx, 4150 ; 14/09/2020 (BugFix)
  2556 00000C43 73AE                    	jnb	short spid_5
  2557                                  spid_12:
  2558 00000C45 B001                    	mov	al, 1 ;  FAT12 partition
  2559                                  spid_16:
  2560 00000C47 C3                      	retn
  2561                                  spid_13:
  2562                                  	; 14/09/2020
  2563 00000C48 3C0B                    	cmp	al, 0Bh ; FAT 32 (CHS) partition
  2564 00000C4A 7420                    	je	short spid_15 ; FAT 32 CHS
  2565 00000C4C 3C0C                    	cmp	al, 0Ch	 
  2566 00000C4E 750C                    	jne	short spid_14 
  2567                                  	; FAT 32 LBA
  2568 00000C50 21DB                    	and	bx, bx	; < 33 MB
  2569 00000C52 74EB                    	jz	short spid_11 ; force to FAT 16 CHS or FAT 12
  2570 00000C54 83FB10                  	cmp	bx, 10h ; 512 MB
  2571                                  	;jnb	short spid_8  ; OK, FAT 32 LBA has been confirmed
  2572 00000C57 73EE                    	jnb	short spid_16 ; 23/10/2020
  2573 00000C59 B00E                    	mov	al, 0Eh ; force to FAT 16 LBA
  2574 00000C5B C3                      	retn
  2575                                  spid_14:
  2576                                  	; 14/09/2020
  2577 00000C5C 3C0E                    	cmp	al, 0Eh
  2578                                  	;jne	short spid_8 ; non-dos or extended partition
  2579 00000C5E 75E7                    	jne	short spid_16 ; 23/10/2020
  2580                                  	; FAT 16 LBA
  2581 00000C60 09DB                    	or	bx, bx
  2582 00000C62 74DB                    	jz	short spid_11
  2583                                  	; 23/10/2020
  2584 00000C64 83FB20                  	cmp	bx, 20h ; 1 GB
  2585 00000C67 72DE                    	jb	short spid_16
  2586 00000C69 B00C                    	mov	al, 0Ch	; FAT 32 LBA
  2587 00000C6B C3                      	retn
  2588                                  spid_15:
  2589                                  	; Minimum size of FAT 32 FS = 65525 + 512 + 512 + 32
  2590                                   	; >= 66581 sectors (or >= 65525 data clusters)
  2591 00000C6C 83FB01                  	cmp	bx, 1
  2592 00000C6F 72CE                    	jb	short spid_11  ; invalid! (< 33 MB)
  2593 00000C71 778F                    	ja	short spid_8
  2594 00000C73 81F91504                	cmp	cx, 1045
  2595                                  	;jb	short spid_16  ; invalid! (< 33 MB)
  2596                                  	;retn
  2597                                  	;jmp	short spid_8 ; 23/10/2020
  2598 00000C77 7389                    	jnb	short spid_8
  2599                                  ;spid_16:
  2600 00000C79 B006                    	mov	al, 6
  2601                                  	;retn
  2602 00000C7B EB85                    	jmp	short spid_8 ; 23/10/2020
  2603                                  
  2604                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2605                                  ; 32 bit division by using 16 bit registers
  2606                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2607                                  
  2608                                  div32:
  2609                                  	; DX_AX/CX
  2610                                  	; Result: DX_AX, BX (remainder) 
  2611 00000C7D 89C3                    	mov	bx, ax
  2612                                  	;or	dx, ax ; * DX_AX = 0 ?       
  2613                                  	;jz	short div32_retn ; yes, do not divide! 
  2614 00000C7F 89D0                    	mov	ax, dx
  2615 00000C81 31D2                            xor	dx, dx
  2616 00000C83 F7F1                            div	cx	; at first, divide DX
  2617                                  			; remainder is in DX 
  2618 00000C85 93                      	xchg	ax, bx	; now quotient is in BX
  2619                                    			; and initial AX value is in AX
  2620 00000C86 F7F1                    	div	cx	; now, DX_AX has been divided and
  2621                                  			; AX has quotient
  2622                                  			; DX has remainder
  2623 00000C88 87D3                    	xchg	dx, bx	; finally, BX has remainder
  2624                                  ;div32_retn:
  2625 00000C8A C3                              retn
  2626                                  
  2627                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2628                                  ; 32 bit multiplication by using 16 bit registers
  2629                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2630                                  
  2631                                  mul32:
  2632                                  	; DX_AX*CX
  2633                                  	; Result: BX_DX_AX 
  2634 00000C8B 51                      	push	cx
  2635 00000C8C 89D3                    	mov	bx, dx
  2636 00000C8E F7E1                    	mul	cx
  2637 00000C90 93                       	xchg	ax, bx
  2638 00000C91 52                      	push	dx
  2639 00000C92 F7E1                    	mul	cx 
  2640 00000C94 59                      	pop	cx 
  2641 00000C95 01C8                    	add	ax, cx 
  2642 00000C97 83D200                  	adc	dx, 0
  2643 00000C9A 93                      	xchg	bx, ax
  2644 00000C9B 87D3                    	xchg	dx, bx
  2645 00000C9D 59                      	pop	cx
  2646 00000C9E C3                      	retn
  2647                                  
  2648                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2649                                  ; creeate new partition input menu
  2650                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2651                                  
  2652                                  B_01:
  2653                                  	; 06/03/2019
  2654 00000C9F C606[FE6C]4D            	mov	byte [pSize_unit], 'M' ; default (for 'whole' disk/space)
  2655                                  	; 15/02/2019
  2656 00000CA4 E80BFB                  	call	create_partition_input
  2657                                  B_02:		
  2658 00000CA7 21C0                    	and	ax, ax
  2659                                  	;jz	_crlf_exit ; 0 = none or not a valid input
  2660 00000CA9 0F845AF7                	jz	A_42 ; 25/02/2019
  2661                                  
  2662                                  	;or	ah, ah
  2663                                  	;jz	short B_03
  2664                                  
  2665                                  	; 23/02/2019
  2666 00000CAD 80FC04                  	cmp	ah, 4  ; user's partition type input ?
  2667 00000CB0 7505                    	jne	short B_03 ; no
  2668                                  
  2669                                  	; 29/10/2020
  2670                                  	; (ah = 0)
  2671                                  	;or	al, al
  2672                                  	;jz	A_42  ; invalid partition type input
  2673                                  	;	      ; or ESC key has been pressed
  2674                                  
  2675                                  	; user type input
  2676 00000CB2 A2[F26C]                	mov	[pp_type_user], al
  2677 00000CB5 88E0                    	mov	al, ah ; mov al, 4
  2678                                  B_03:
  2679 00000CB7 A2[F16C]                	mov	[pp_type], al
  2680                                  
  2681                                  	; clear screen
  2682 00000CBA B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  2683 00000CBD CD10                    	int	10h
  2684                                  
  2685 00000CBF A0[F16C]                	mov	al, [pp_type]
  2686 00000CC2 3C01                    	cmp	al, 1
  2687 00000CC4 7705                    	ja	short B_04
  2688                                  
  2689 00000CC6 BE[2448]                	mov	si,  msg_create_dos_partition_h ; header
  2690 00000CC9 EB70                    	jmp	short B_09
  2691                                  B_04:
  2692 00000CCB 3C05                    	cmp	al, 5
  2693 00000CCD 7269                    	jb	short B_08
  2694                                  	;ja	short B_07
  2695 00000CCF 7741                    	ja	short B_58 ; 26/10/2020
  2696                                  
  2697                                  	; 23/02/2019
  2698 00000CD1 BE[1949]                	mov	si, msg_create_ext_partition_h
  2699 00000CD4 E8BB0E                  	call	print_msg
  2700                                  
  2701                                  	; 24/02/2019
  2702 00000CD7 803E[DF6F]00            	cmp	byte [epnumber], 0
  2703 00000CDC 7613                    	jna	short B_05	
  2704                                  
  2705 00000CDE BE[EB5E]                	mov	si, msg_ext_partition_exists
  2706 00000CE1 E8AE0E                  	call 	print_msg
  2707                                  
  2708 00000CE4 BE[DB55]                	mov	si, msg_press_any_key
  2709 00000CE7 E8A80E                  	call	print_msg
  2710                                  
  2711 00000CEA 30E4                    	xor	ah, ah
  2712 00000CEC CD16                    	int	16h
  2713                                  
  2714 00000CEE E916F7                  	jmp	A_42
  2715                                  B_05:
  2716 00000CF1 803E[DD6F]00            	cmp	byte [ppcount], 0  ; primary partition count
  2717 00000CF6 7746                    	ja	short B_10
  2718                                  
  2719                                  	; 09/02/2019
  2720 00000CF8 BE[A04F]                	mov	si, msg_ext_partition_error
  2721 00000CFB E8940E                  	call	print_msg
  2722                                  B_06:	
  2723 00000CFE BE[DB55]                	mov	si, msg_press_any_key
  2724 00000D01 E88E0E                  	call	print_msg
  2725                                  
  2726 00000D04 30E4                    	xor	ah, ah
  2727 00000D06 CD16                    	int	16h
  2728                                  
  2729 00000D08 C606[F16C]01            	mov	byte [pp_type], 1
  2730                                  
  2731 00000D0D E8CDFA                  	call	cpi_2 ; 15/02/2019
  2732 00000D10 EB95                    	jmp	short B_02
  2733                                  
  2734                                  B_58:
  2735                                  	; 26/10/2020
  2736 00000D12 803E[5268]80            	cmp	byte [DrvNum], 80h ; hd0 ?
  2737 00000D17 7707                    	ja	short B_59 ; Do not check primary dos partition count
  2738                                  	; The second hard disk may contain extended partition without
  2739                                  	; a primary dos partition
  2740 00000D19 803E[DD6F]00            	cmp	byte [ppcount], 0  ; primary dos partition count
  2741 00000D1E 760A                    	jna	short B_07
  2742                                  B_59:
  2743 00000D20 803E[DF6F]00            	cmp	byte [epnumber], 0
  2744                                  			; is there an extended partition ?
  2745 00000D25 7603                    	jna	short B_07 ; no
  2746 00000D27 E9ACF7                  	jmp	create_logical_drives
  2747                                  B_07:
  2748 00000D2A BE[0E4A]                	mov	si, msg_create_logical_drive_h
  2749 00000D2D E8620E                  	call	print_msg
  2750                                  
  2751 00000D30 BE[DF4F]                	mov	si, msg_logical_drive_error
  2752 00000D33 E85C0E                  	call	print_msg
  2753 00000D36 EBC6                    	jmp	short B_06
  2754                                  
  2755                                  ;	mov	si, msg_use_entire_ep_space
  2756                                  ;	jmp	short B_12
  2757                                  	
  2758                                  B_08:
  2759 00000D38 BE[034B]                	mov	si, msg_create_nondos_partition_h
  2760                                  B_09:
  2761 00000D3B E8540E                  	call	print_msg
  2762                                  B_10:
  2763                                  	; 15/02/2019
  2764                                  	;cmp	byte [newdisk], 0
  2765                                  	;ja	short B_11
  2766                                  
  2767 00000D3E 803E[DC6F]00            	cmp	byte [pcount], 0 ; (valid) partition count
  2768 00000D43 7605                    	jna	short B_11
  2769                                  
  2770 00000D45 BE[384E]                	mov	si, msg_use_all_space
  2771 00000D48 EB03                    	jmp	short B_12
  2772                                  B_11:
  2773 00000D4A BE[114E]                	mov	si, msg_use_whole_disk ; partition size: whole disk
  2774                                  B_12:
  2775 00000D4D E8420E                  	call	print_msg
  2776                                  B_13:
  2777 00000D50 30E4                    	xor	ah, ah
  2778 00000D52 CD16                    	int	16h
  2779                                  
  2780 00000D54 3C1B                    	cmp	al, 27 ; ESCAPE key
  2781                                  	;;je	_crlf_exit
  2782 00000D56 0F84ADF6                	je	A_42 ; 25/02/2019
  2783 00000D5A 24DF                    	and	al, 0DFh
  2784 00000D5C 3C4E                    	cmp	al, 'N'
  2785 00000D5E 740D                    	je	short B_14  ;02/03/2019
  2786 00000D60 3C59                    	cmp	al, 'Y'
  2787 00000D62 75EC                    	jne	short B_13
  2788                                  	
  2789 00000D64 FE06[F06C]              	inc	byte [wholedisk]
  2790                                  	
  2791                                  	; 02/03/2019
  2792 00000D68 BE[B85C]                	mov	si, _msg_YES
  2793                                  	;call	print_msg
  2794 00000D6B EB03                    	jmp	short B_15	
  2795                                  B_14:
  2796 00000D6D BE[BE5C]                	mov	si, _msg_NO
  2797                                  B_15:	; 06/03/2019
  2798 00000D70 E81F0E                  	call	print_msg
  2799                                  
  2800                                  	; 15/02/2019
  2801 00000D73 29DB                    	sub	bx, bx
  2802                                  	;cmp	byte [newdisk], bl ; 0
  2803                                  	;ja	short B_16 ; 23/02/2019
  2804                                  	; 19/10/2020
  2805                                  	;cmp	byte [pcount], 0
  2806                                  	; 03/11/2020
  2807 00000D75 381E[DC6F]              	cmp	byte [pcount], bl ; 0
  2808 00000D79 7608                    	jna	short B_16 ; [pcount] = 0 (newdisk, empty pt) 
  2809 00000D7B 381E[F06C]              	cmp	byte [wholedisk], bl ; 0
  2810 00000D7F 0F871C01                	ja	B_27 ; 23/02/2019
  2811                                  B_16:
  2812                                  	; 08/02/2019
  2813                                  	;sub	bx, bx
  2814 00000D83 A1[5668]                	mov	ax, [total_sectors]
  2815 00000D86 8B16[5868]              	mov	dx, [total_sectors+2]
  2816 00000D8A 2B06[7E3F]              	sub	ax, [sectors]
  2817 00000D8E 19DA                    	sbb	dx, bx ; sbb dx, 0
  2818                                  
  2819 00000D90 A3[EC6C]                	mov	[pp_Sectors], ax   ; = [total_sectors] - [sectors]
  2820 00000D93 8916[EE6C]              	mov	[pp_Sectors+2], dx ; = [total_sectors+2] - carry bit
  2821                                  B_17:
  2822 00000D97 381E[F06C]              	cmp	byte [wholedisk], bl ; 0
  2823 00000D9B 0F870701                	ja	B_28 ; 09/02/2019
  2824                                  B_18:
  2825                                  	; clear screen
  2826 00000D9F B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  2827 00000DA2 CD10                    	int	10h
  2828                                  
  2829                                  	; 04/11/2020
  2830 00000DA4 803E[F16C]01            	cmp	byte [pp_type], 1 ; primary dos partition ?
  2831 00000DA9 7405                    	je	short B_61
  2832                                  	; "Create Partition"
  2833 00000DAB BE[7945]                	mov	si, msg_create_partition_h
  2834 00000DAE EB03                    	jmp	short B_62
  2835                                  B_61:
  2836                                  	; "Create DOS partition"
  2837 00000DB0 BE[2448]                	mov	si, msg_create_dos_partition_h ; header
  2838                                  B_62:
  2839 00000DB3 E8DC0D                  	call	print_msg
  2840 00000DB6 BE[B54C]                	mov	si, msg_create_trdos_partition_s ; size options
  2841 00000DB9 E8D60D                  	call	print_msg	
  2842                                  B_19:	
  2843 00000DBC 30E4                    	xor	ah, ah
  2844 00000DBE CD16                    	int	16h
  2845                                  
  2846                                  	; 24/02/2019
  2847 00000DC0 3C1B                    	cmp	al, 27	; ESCAPE key 
  2848 00000DC2 0F8441F6                	je	A_42	; Cancel
  2849                                  
  2850 00000DC6 3C20                    	cmp	al, 32	; SPACE key
  2851 00000DC8 7521                    	jne	short B_21
  2852                                  
  2853                                  		; Entire space
  2854 00000DCA A1[EC6C]                	mov	ax, [pp_Sectors]
  2855 00000DCD 8B16[EE6C]              	mov	dx, [pp_Sectors+2]
  2856                                  
  2857 00000DD1 C606[F06C]01            	mov 	byte [wholedisk], 1 ; 09/02/2019
  2858 00000DD6 EB5A                    	jmp	short B_23
  2859                                  
  2860                                  B_60:	; 31/10/2020
  2861 00000DD8 75C5                    	jnz	short B_18  ; ESCape (return to options menu)
  2862                                  	; partition size input is ZERO !
  2863                                  B_20:
  2864                                  	; ZERO partition size message
  2865 00000DDA BE[CB5A]                	mov	si, msg_zero_partition_size
  2866 00000DDD E8B20D                  	call	print_msg
  2867                                  	
  2868 00000DE0 30E4                    	xor	ah, ah
  2869 00000DE2 CD16                    	int	16h
  2870 00000DE4 3C1B                    	cmp	al, 27 ; ESCAPE key
  2871 00000DE6 75B7                    	jne	short B_18 ; Retry
  2872                                  
  2873                                  	; 19/10/2020
  2874 00000DE8 E9BCF9                  	jmp	_crlf_exit ; exit
  2875                                  
  2876                                  B_21:
  2877 00000DEB C606[FE6C]25            	mov	byte [pSize_unit], '%'
  2878 00000DF0 3C25                    	cmp	al, '%'
  2879 00000DF2 7422                    	je	short B_22
  2880 00000DF4 C606[FE6C]53            	mov	byte [pSize_unit], 'S'
  2881 00000DF9 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  2882 00000DFB 7419                    	je	short B_22
  2883 00000DFD 24DF                    	and	al, 0DFh
  2884 00000DFF 3C53                    	cmp	al, 'S'
  2885 00000E01 7413                    	je	short B_22
  2886 00000E03 A2[FE6C]                	mov	[pSize_unit], al
  2887 00000E06 3C4B                    	cmp	al, 'K'
  2888 00000E08 740C                    	je	short B_22
  2889 00000E0A 3C4D                    	cmp	al, 'M'
  2890 00000E0C 7408                    	je	short B_22
  2891 00000E0E 3C47                    	cmp	al, 'G'
  2892 00000E10 7404                    	je	short B_22
  2893 00000E12 3C43                    	cmp	al, 'C'
  2894 00000E14 75A6                    	jne	short B_19
  2895                                  B_22:
  2896 00000E16 C606[3364]73            	mov	byte [msg_sectors_crlf_s], 's' ; " sectors"
  2897                                  
  2898 00000E1B E8E40F                  	call	partition_size_input
  2899                                  	;jc	_crlf_exit ; exit if partition size input is 0
  2900                                  	;jc	short B_20
  2901                                  	; 29/10/2020
  2902                                  	;jnc	short B_60
  2903                                  	;jz	short B_20 ; partition size input is ZERO !
  2904                                  	;jmp	short B_18 ; ESCape (return to options menu)
  2905                                  	; 31/10/2020
  2906 00000E1E 72B8                    	jc	short B_60 ; ESC or zero partition size
  2907                                  ;B_60:
  2908 00000E20 21DB                    	and	bx, bx ; bx_dx_ax = partition size
  2909                                  	;jnz	short B_29
  2910                                  	; 23/02/2019 
  2911 00000E22 7540                    	jnz	short B_24 ; invalid! (use maximum available sectors)
  2912                                  
  2913                                  	; 08/02/2019
  2914 00000E24 09D2                    	or	dx, dx
  2915 00000E26 750A                    	jnz	short B_23 ; proper size (for now)
  2916                                  
  2917 00000E28 8B1E[146D]              	mov	bx, [min_sectors] ; minimum sectors
  2918 00000E2C 39C3                    	cmp	bx, ax
  2919 00000E2E 7602                    	jna	short B_23 ; proper size (for now)	 
  2920                                  
  2921                                  	; invalid! (use minimum sectors or sectors per cylinder)
  2922 00000E30 89D8                    	mov	ax, bx
  2923                                  B_23:
  2924                                  	; 09/02/2019
  2925                                  	; save dx,ax
  2926 00000E32 8916[1C6D]              	mov	[ppn_Sectors+2], dx
  2927 00000E36 A3[1A6D]                	mov	[ppn_Sectors], ax
  2928                                  
  2929                                  	; write partition size
  2930                                  	;push	dx
  2931                                  	;push	ax
  2932                                  	;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  2933                                  	; 06/11/2020
  2934 00000E39 BE[0B6D]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  2935 00000E3C E8120E                  	call	bin_to_decimal
  2936                                  	; ds:si = beginning of decimal number text
  2937 00000E3F E8500D                  	call	print_msg
  2938 00000E42 BE[2C64]                	mov	si, msg_sectors_crlf
  2939 00000E45 E84A0D                  	call	print_msg
  2940                                  	;pop	ax
  2941                                  	;pop	dx
  2942                                  
  2943 00000E48 803E[F06C]00            	cmp	byte [wholedisk], 0
  2944 00000E4D 775E                    	ja	short B_29 ; 09/02/2019
  2945                                  
  2946                                  	; restore ax,dx
  2947 00000E4F A1[1A6D]                	mov	ax, [ppn_Sectors]
  2948 00000E52 8B16[1C6D]              	mov	dx, [ppn_Sectors+2]
  2949                                  
  2950                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2951                                  ; select whole disk
  2952                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2953                                  
  2954                                  	; select whole disk 
  2955                                  	;   if partition size > disk size
  2956 00000E56 3B16[EE6C]              	cmp	dx, [pp_Sectors+2]
  2957 00000E5A 7708                    	ja	short B_24
  2958 00000E5C 724F                    	jb	short B_29
  2959 00000E5E 3B06[EC6C]              	cmp	ax, [pp_Sectors]
  2960 00000E62 7649                    	jna	short B_29
  2961                                  B_24:
  2962                                  	;cmp	byte [newdisk], 0
  2963                                  	;jna	short B_30
  2964                                  	; 19/10/2020
  2965 00000E64 803E[DC6F]00            	cmp	byte [pcount], 0
  2966 00000E69 7767                    	ja	short B_30
  2967                                  
  2968                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2969                                  ; "use whole disk or go to back" question
  2970                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2971                                  
  2972 00000E6B BE[364F]                	mov	si, msg_partition_size_overs
  2973                                  B_25:
  2974 00000E6E E8210D                  	call	print_msg
  2975                                  B_26:
  2976 00000E71 30E4                    	xor	ah, ah
  2977 00000E73 CD16                    	int	16h
  2978                                  	
  2979 00000E75 3C1B                    	cmp	al, 27 ; ESCAPE key
  2980                                  	;je	B_01
  2981 00000E77 0F8424FF                	je	B_18 ; 09/02/2019
  2982 00000E7B 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  2983 00000E7D 75F2                    	jne	short B_26
  2984                                  
  2985 00000E7F FE06[F06C]              	inc	byte [wholedisk]
  2986                                  
  2987                                  	; 24/02/2019
  2988                                  	;cmp	byte [newdisk], 0
  2989                                  	;ja	short B_27
  2990 00000E83 803E[DC6F]00            	cmp	byte [pcount], 0  ; (valid) partition count
  2991 00000E88 7615                    	jna	short B_27 ; no
  2992                                  
  2993 00000E8A 8B1E[7A70]              	mov	bx, [c_fspc_offset]
  2994 00000E8E 8B87[3070]              	mov	ax, [free_space.sectors_unused+bx]
  2995 00000E92 8B97[3270]              	mov	dx, [free_space.sectors_unused+bx+2]
  2996 00000E96 A3[EC6C]                	mov	[pp_Sectors], ax
  2997 00000E99 8916[EE6C]              	mov	[pp_Sectors+2], dx
  2998 00000E9D EB07                    	jmp	short B_28 
  2999                                  B_27:
  3000                                  	; 09/02/2019
  3001 00000E9F 8B16[EE6C]              	mov	dx, [pp_Sectors+2]
  3002 00000EA3 A1[EC6C]                	mov	ax, [pp_Sectors]
  3003                                  B_28:
  3004 00000EA6 8916[1C6D]              	mov	[ppn_Sectors+2], dx
  3005 00000EAA A3[1A6D]                	mov	[ppn_Sectors], ax
  3006                                  B_29:
  3007 00000EAD 803E[F16C]05            	cmp	byte [pp_type], 5
  3008 00000EB2 0F853601                	jne	B_51
  3009                                  
  3010 00000EB6 803E[DD6F]00            	cmp	byte [ppcount], 0  ; primary partition count
  3011 00000EBB 0F87C500                	ja	B_45
  3012                                  
  3013 00000EBF BE[A04F]                	mov	si, msg_ext_partition_error
  3014 00000EC2 E8CD0C                  	call	print_msg
  3015 00000EC5 BE[194F]                	mov	si, msg_any_key_to_retry
  3016 00000EC8 E8C70C                  	call	print_msg
  3017                                  
  3018                                  	; 09/02/2019
  3019 00000ECB 30E4                    	xor	ah, ah
  3020 00000ECD CD16                    	int	16h
  3021                                  
  3022                                  	;jmp	B_01
  3023 00000ECF E90BF9                  	jmp	cpi_2 
  3024                                  
  3025                                  B_30:
  3026                                  	; clear screen
  3027 00000ED2 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3028 00000ED5 CD10                    	int	10h
  3029                                  
  3030 00000ED7 BE[2448]                	mov	si, msg_create_dos_partition_h ; header
  3031 00000EDA E8B50C                  	call	print_msg
  3032                                  
  3033 00000EDD BE[D75D]                	mov	si, msg_partition_size_limit
  3034 00000EE0 E8AF0C                  	call	print_msg
  3035                                  
  3036 00000EE3 8B1E[7A70]              	mov	bx, [c_fspc_offset]
  3037                                  
  3038 00000EE7 803E[FE6C]53            	cmp	byte [pSize_unit], 'S'
  3039 00000EEC 7415                    	je	short B_31
  3040 00000EEE 803E[FE6C]4B            	cmp	byte [pSize_unit], 'K'
  3041 00000EF3 740E                    	je	short B_31
  3042                                  
  3043 00000EF5 803E[FE6C]25            	cmp	byte [pSize_unit], '%'
  3044 00000EFA 7469                    	je	short B_41
  3045                                  
  3046 00000EFC 803E[FE6C]43            	cmp	byte [pSize_unit], 'C'
  3047 00000F01 7479                    	je	B_44
  3048                                  B_31:
  3049                                  	; 'S', 'K'
  3050 00000F03 81C3[3070]              	add	bx, free_space.sectors_unused	
  3051 00000F07 8B07                    	mov	ax, [bx]
  3052 00000F09 8B5702                  	mov	dx, [bx+2]
  3053                                  		
  3054 00000F0C B90A00                  	mov	cx, 10
  3055 00000F0F 89E5                    	mov	bp, sp
  3056                                  B_32:
  3057 00000F11 E869FD                  	call	div32
  3058 00000F14 53                      	push	bx
  3059 00000F15 09D2                    	or	dx, dx
  3060 00000F17 75F8                    	jnz	short B_32
  3061 00000F19 83F809                  	cmp	ax, 9
  3062 00000F1C 77F3                    	ja	short B_32
  3063                                  B_33:
  3064 00000F1E BB0700                  	mov	bx, 07h
  3065 00000F21 09C0                    	or	ax, ax
  3066 00000F23 7501                    	jnz	short B_35
  3067                                  B_34:
  3068 00000F25 58                      	pop	ax
  3069                                  B_35:
  3070 00000F26 0430                    	add	al, '0'
  3071                                  B_36:
  3072 00000F28 B40E                    	mov	ah, 0Eh
  3073                                  	;mov	bx, 07h
  3074 00000F2A CD10                    	int	10h	; write character (as tty)
  3075                                  
  3076 00000F2C 39EC                    	cmp	sp, bp
  3077 00000F2E 72F5                    	jb	short B_34
  3078                                  
  3079 00000F30 803E[FE6C]53            	cmp	byte [pSize_unit], 'S'
  3080 00000F35 7422                    	je	short B_38
  3081 00000F37 803E[FE6C]4B            	cmp	byte [pSize_unit], 'K'
  3082 00000F3C 741B                    	je	short B_38
  3083                                  
  3084 00000F3E 803E[FE6C]25            	cmp	byte [pSize_unit], '%'
  3085 00000F43 7508                    	jne	short B_37
  3086                                  
  3087                                  	; 24/02/2019
  3088 00000F45 3C25                    	cmp	al, '%'
  3089 00000F47 7416                    	je	short B_40
  3090 00000F49 B025                    	mov	al, '%'
  3091 00000F4B EBDB                    	jmp	short B_36 
  3092                                  B_37:
  3093 00000F4D 803E[FE6C]43            	cmp	byte [pSize_unit], 'C'
  3094 00000F52 7505                    	jne	short B_38
  3095                                  
  3096 00000F54 BE[735E]                	mov	si, msg_cylinders
  3097 00000F57 EB03                    	jmp	short B_39
  3098                                  B_38:
  3099 00000F59 BE[7E5E]                	mov	si, msg_sectors
  3100                                  B_39:
  3101 00000F5C E8330C                  	call	print_msg
  3102                                  B_40:
  3103 00000F5F BE[245E]                	mov	si, msg_partition_size_limit_r
  3104                                  	;call	print_msg
  3105                                  
  3106 00000F62 E909FF                  	jmp	B_25
  3107                                  
  3108                                  B_41:
  3109                                  	; '%'
  3110 00000F65 81C3[2E70]              	add	bx, free_space.percent_unused
  3111 00000F69 8B07                    	mov	ax, [bx]
  3112                                  B_42:	
  3113 00000F6B 89E5                    	mov	bp, sp
  3114 00000F6D B90A00                  	mov	cx, 10
  3115                                  B_43:	
  3116 00000F70 31D2                    	xor	dx, dx
  3117                                  	;mov	cx, 10
  3118 00000F72 F7F1                    	div	cx
  3119 00000F74 52                      	push	dx
  3120 00000F75 83F809                  	cmp	ax, 9
  3121 00000F78 77F6                    	ja	short B_43	
  3122 00000F7A EBA2                    	jmp	short B_33
  3123                                  B_44:
  3124                                  	; 'C'
  3125 00000F7C 81C3[2870]              	add	bx, free_space.space
  3126 00000F80 8B07                    	mov	ax, [bx]
  3127 00000F82 EBE7                    	jmp	short B_42
  3128                                  
  3129                                  B_45:
  3130                                  	; 23/02/2019
  3131 00000F84 8B1E[7A70]              	mov	bx, [c_fspc_offset]
  3132 00000F88 8B87[2A70]              	mov	ax, [bx+free_space.start]
  3133                                  
  3134                                  	; set free space start cylinder to 1 if it is 0
  3135 00000F8C 09C0                    	or	ax, ax
  3136 00000F8E 750F                    	jnz	short B_46
  3137                                  
  3138 00000F90 B005                    	mov	al, 5	; Get free space for extended partition
  3139 00000F92 E8A515                  	call	find_part_free_space
  3140                                  
  3141 00000F95 891E[7A70]              	mov	[c_fspc_offset], bx
  3142                                  
  3143                                  	; 19/10/2020
  3144 00000F99 21C9                    	and	cx, cx
  3145 00000F9B 0F8428F5                	jz	cp_3	; there is not free space on disk
  3146                                  B_46:
  3147                                  	; 24/02/2019
  3148 00000F9F E81100                  	call	partition_size_fixup_x
  3149 00000FA2 0F822CFF                	jc	B_30
  3150                                  
  3151                                  	; 16/02/2019
  3152 00000FA6 E83EFB                  	call	create_extended_partition 
  3153                                  			; must be called after 'find_part_free_space'.
  3154                                  	; 24/02/2019
  3155 00000FA9 E87411                  	call	show_selected_partition
  3156 00000FAC E9BE00                  	jmp	C_02
  3157                                  
  3158                                  partition_size_fixup:
  3159                                  	; 24/02/2019
  3160 00000FAF 8B1E[7A70]              	mov	bx, [c_fspc_offset]
  3161                                  partition_size_fixup_x:
  3162                                  	; 19/10/2020
  3163                                  
  3164                                  	;cmp	byte [newdisk], 0
  3165                                  	;ja	short B_50
  3166                                  
  3167 00000FB3 803E[DC6F]00            	cmp	byte [pcount], 0 ; (valid) partition count
  3168 00000FB8 7631                    	jna	short B_50
  3169                                  
  3170 00000FBA 81C3[3070]              	add	bx, free_space.sectors_unused
  3171 00000FBE 8B07                    	mov	ax, [bx]
  3172 00000FC0 8B5702                  	mov	dx, [bx+2]
  3173                                  
  3174 00000FC3 3B16[1C6D]              	cmp	dx, [ppn_Sectors+2]
  3175 00000FC7 7222                    	jb	short B_50 ; 24/02/2019
  3176 00000FC9 7708                    	ja	short B_47
  3177 00000FCB 3B06[1A6D]              	cmp	ax, [ppn_Sectors]
  3178 00000FCF 721A                    	jb	short B_50 ; 24/02/2019
  3179 00000FD1 7411                    	je	short B_49
  3180                                  
  3181                                  B_47:
  3182                                  	; 19/02/2019
  3183 00000FD3 A1[1A6D]                	mov	ax, [ppn_Sectors]
  3184                                  B_48:
  3185 00000FD6 8B16[1C6D]              	mov	dx, [ppn_Sectors+2]
  3186                                  
  3187                                  	; 18/02/2019
  3188                                  
  3189                                  	; check for best fit
  3190                                  	; (leave max. available space to next time if 
  3191                                  	;  another space/gap fits to partition size request.)
  3192                                  
  3193 00000FDA E87517                  	call	find_enough_free_sectors
  3194                                  		; CX = Free space index (0 to 4)
  3195                                  		; DX:AX = First available space which fits to request
  3196                                  	;mov	bx, cx
  3197                                  	;shl	bl, 4 ; * 16  ; * Free space structure size
  3198                                  	;mov	[c_fspc_offset], bx
  3199                                  	
  3200                                  	; 22/02/2019
  3201 00000FDD C0E104                  	shl	cl, 4
  3202 00000FE0 890E[7A70]              	mov	[c_fspc_offset], cx 
  3203                                  
  3204                                  	;add	bx, free_space.sectors_unused
  3205                                  	;mov	ax, [bx]
  3206                                  	;mov	dx, [bx+2]
  3207                                  B_49:		
  3208                                  	; Save max. available space
  3209 00000FE4 A3[EC6C]                	mov	[pp_Sectors], ax
  3210 00000FE7 8916[EE6C]              	mov	[pp_Sectors+2], dx
  3211                                  B_50:
  3212 00000FEB C3                      	retn
  3213                                  
  3214                                  B_51:
  3215                                  	; 24/02/2019
  3216 00000FEC E8C0FF                  	call	partition_size_fixup
  3217 00000FEF 0F82DFFE                	jc	B_30
  3218                                  
  3219                                  	; 16/02/2019
  3220                                  	; Force cylinder boundary alignment except
  3221                                  	;   sectors ('S') and kilobytes ('K') as sizing unit.
  3222                                  
  3223 00000FF3 C606[7C70]59            	mov	byte [cylinder_boundary], 'Y' ; Default
  3224                                  				; sizing unit is one of
  3225                                  				; 'cylinders','megabytes','gigabytes'
  3226                                  				; and boundary alignment is yes for them.
  3227 00000FF8 A0[FE6C]                	mov	al, [pSize_unit]
  3228                                  
  3229                                  	;cmp	byte [pSize_unit], 'S' ; Sectors
  3230 00000FFB 3C53                    	cmp	al, 'S'
  3231 00000FFD 7404                    	je	short B_52
  3232                                  
  3233                                  	;cmp	byte [pSize_unit], 'K' ; Kilobytes
  3234 00000FFF 3C4B                    	cmp	al, 'K'
  3235 00001001 752F                    	jne	short B_56
  3236                                  B_52:
  3237                                  	; Sizing unit is one of 'sectors' and/or 'kilobytes'
  3238                                  	; and bound aligment will be applied if the answer will be yes.
  3239                                  
  3240 00001003 BE[2850]                	mov	si, msg_cylinder_boundary_set
  3241 00001006 E8890B                  	call	print_msg
  3242                                  B_53:
  3243 00001009 30E4                    	xor	ah, ah
  3244 0000100B CD16                    	int	16h
  3245                                  	; Cylinder boundary adjusting
  3246 0000100D 3C0D                    	cmp	al, 13 ; ENTER key
  3247 0000100F 74F2                    	je	short B_52
  3248 00001011 3C1B                    	cmp	al, 27 ; ESCAPE key
  3249 00001013 741A                    	je	short B_55	; Align end of the partition only
  3250                                  				; if start of the partition is aligned
  3251                                  				; or it starts at cyl 0, head 1, sect 17 or 63.
  3252                                  				; (End of the partition will be extended to
  3253                                  				; end sector of it's last cylinder if the size
  3254                                  				; will not over [pp_Sectors] value.)
  3255 00001015 24DF                    	and	al, 0DFh
  3256                                  
  3257                                  	; 22/02/2019
  3258 00001017 3C59                    	cmp	al, 'Y'
  3259 00001019 7508                    	jne	short B_54
  3260                                  
  3261 0000101B BE[B85C]                	mov	si, _msg_YES
  3262 0000101E E8710B                  	call	print_msg
  3263                                  
  3264                                  	;mov	al, 'Y'
  3265                                  	;jmp	short B_55
  3266 00001021 EB0F                    	jmp	short B_56
  3267                                  B_54:
  3268 00001023 3C4E                    	cmp	al, 'N'
  3269 00001025 75E2                    	jne	short B_53
  3270                                  
  3271 00001027 BE[BE5C]                	mov	si, _msg_NO
  3272 0000102A E8650B                  	call	print_msg
  3273                                  
  3274 0000102D B04E                    	mov	al, 'N'
  3275                                  		; do not align partition to cylinder boundary 
  3276                                  B_55:
  3277 0000102F A2[7C70]                	mov	[cylinder_boundary], al
  3278                                  B_56:
  3279 00001032 E8FCF7                  	call	create_primary_partition
  3280                                  	
  3281                                  	; 18/02/2019
  3282                                  	;cmp	byte [newdisk], 0
  3283                                  	;jna	short B_57
  3284                                  
  3285                                  	; 19/10/2020
  3286 00001035 803E[DC6F]00            	cmp	byte [pcount], 0
  3287 0000103A 770E                    	ja	short B_57
  3288                                  
  3289 0000103C 31C0                    	xor	ax, ax ; 0
  3290 0000103E 31D2                    	xor	dx, dx ; 0
  3291                                  	; DX_AX = Masterboot Sector = 0
  3292 00001040 BB[FA55]                	mov	bx, MasterBootBuff
  3293                                  	; ES:BX = Sector Buffer
  3294 00001043 E8B10B                  	call	write_hd_sector
  3295 00001046 0F8247F7                	jc	print_error_code ; 18/10/2020
  3296                                  B_57:
  3297                                  	; DS:SI = Partition Table Entry address
  3298                                  	; 25/02/2019
  3299 0000104A 8936[A270]              	mov	[pte_address], si  ; save PTE address
  3300 0000104E E8CF10                  	call	show_selected_partition
  3301                                  
  3302                                  	;jmp	C_01
  3303                                  
  3304                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3305                                  ; format question
  3306                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3307                                  
  3308                                  C_01:
  3309                                  	;mov	si, CRLF
  3310                                  	;call	print_msg
  3311                                  
  3312 00001051 C606[0D6D]01            	mov	byte [format_q], 1
  3313                                  
  3314 00001056 A0[F16C]                	mov	al, [pp_type]
  3315 00001059 3C01                    	cmp	al, 1		; FAT12 (CHS)
  3316 0000105B 741D                    	je	short C_03
  3317 0000105D 3C04                    	cmp	al, 4		; FAT16 CHS
  3318 0000105F 7419                    	je	short C_03
  3319 00001061 3C06                    	cmp	al, 6		; FAT16 BIG CHS
  3320 00001063 7415                    	je	short C_03
  3321 00001065 3C0B                    	cmp	al, 0Bh		; FAT32 CHS
  3322 00001067 7411                    	je	short C_03
  3323 00001069 3CA1                    	cmp	al, 0A1h	; SINGLIX FS1
  3324 0000106B 740D                    	je	short C_03
  3325                                  
  3326                                  	;cmp	al, 71h
  3327                                  	;je	short C_03	; RETRO UNIX 386
  3328                                  
  3329                                  	;dec	byte [format_q] ; 0
  3330                                  C_02:
  3331 0000106D C606[0D6D]00            	mov	byte [format_q], 0 ; 24/02/2019
  3332                                  
  3333                                  	; NON-DOS partition!
  3334                                  	; Ask for editing PT or exit (continue without formatting)
  3335 00001072 BE[AE53]                	mov	si, msg_edit_or_exit
  3336 00001075 E81A0B                  	call	print_msg
  3337 00001078 EB06                    	jmp	short C_04
  3338                                  C_03:
  3339                                  	; Ask for formatting, editing PT or exit
  3340 0000107A BE[3F53]                	mov	si, msg_format_stage
  3341 0000107D E8120B                  	call	print_msg
  3342                                  C_04:
  3343 00001080 BE[7F53]                	mov	si, msg_partition_edit
  3344 00001083 E80C0B                  	call	print_msg
  3345                                  C_05:
  3346 00001086 28E4                    	sub	ah, ah
  3347 00001088 CD16                    	int	16h
  3348                                  
  3349 0000108A 3C0D                    	cmp	al, 13
  3350 0000108C 7435                    	je	short C_08
  3351                                  
  3352                                  	;; 07/03/2019
  3353 0000108E 3C20                    	cmp	al, 20h ; SPACE
  3354                                  	;je	A_21 ; edit partition table option is selected
  3355 00001090 7503                    	jne	short C_06
  3356                                  	; 19/10/2020	
  3357 00001092 E955F1                  	jmp	A_21
  3358                                  C_06:
  3359 00001095 3C1B                    	cmp	al, 27 ; ESCAPE
  3360 00001097 75ED                    	jne	short C_05
  3361                                  	
  3362                                  	; 19/010/2020
  3363 00001099 E911F7                  	jmp	_exit
  3364                                  
  3365                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3366                                  ; save MBR then exit
  3367                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3368                                  
  3369                                  save_mbr_exit:
  3370                                  	; 24/02/2019
  3371 0000109C E86612                  	call	init_partition_table
  3372                                  
  3373 0000109F E84917                  	call	display_partition_table
  3374                                  
  3375 000010A2 BE[7F55]                	mov	si, CRLF
  3376 000010A5 E8EA0A                  	call	print_msg
  3377                                  
  3378 000010A8 BE[3354]                	mov	si, msg_writing_mbr
  3379 000010AB E8E40A                  	call	print_msg
  3380                                  
  3381 000010AE 31C0                    	xor	ax, ax ; 0
  3382 000010B0 31D2                    	xor	dx, dx ; 0
  3383                                  	; DX_AX = Masterboot Sector = 0
  3384 000010B2 BB[FA55]                	mov	bx, MasterBootBuff
  3385                                  	; ES:BX = Sector Buffer
  3386 000010B5 E83F0B                  	call	write_hd_sector
  3387 000010B8 7303                    	jnc	short C_07
  3388 000010BA E9D4F6                  	jmp	print_error_code ; 18/10/2020
  3389                                  
  3390                                  C_07:
  3391 000010BD BE[7B55]                	mov	si, Msg_OK
  3392                                  	;call	print_msg
  3393                                  	; 19/10/2020
  3394                                  	;jmp	_exit
  3395 000010C0 E9E7F6                  	jmp	_p_exit
  3396                                  
  3397                                  C_08:
  3398 000010C3 803E[0D6D]01            	cmp	byte [format_q], 1
  3399 000010C8 72D2                    	jb	short save_mbr_exit
  3400                                  
  3401                                  	; 25/02/2019
  3402                                  	; Write MBR without writing message
  3403                                  	
  3404                                  	; NOTE: This may be second time of MBR writing...
  3405                                  	;	but, if partition table is modified,
  3406                                  	;	we need to write MBR to disk, here.
  3407                                  	;
  3408                                  	; (Otherwise.. the last created partition would not be recorded.)
  3409                                  
  3410 000010CA 31C0                    	xor	ax, ax ; 0
  3411 000010CC 31D2                    	xor	dx, dx ; 0
  3412                                  	; DX_AX = Masterboot Sector = 0
  3413 000010CE BB[FA55]                	mov	bx, MasterBootBuff
  3414                                  	; ES:BX = Sector Buffer
  3415 000010D1 E8230B                  	call	write_hd_sector
  3416 000010D4 0F82B9F6                	jc	print_error_code ; 18/10/2020
  3417                                  
  3418                                  	;; clear screen
  3419                                  	;mov	ax, 3 ; set video mode to 03h (80x25 text)
  3420                                  	;int	10h
  3421                                  
  3422                                  	; 25/02/2019
  3423 000010D8 8B36[A270]              	mov	si, [pte_address]
  3424                                  
  3425                                  	; 18/02/2019
  3426 000010DC E84110                  	call	show_selected_partition	
  3427                                  
  3428 000010DF A0[6653]                	mov	al, [partition_num_chr]
  3429 000010E2 A2[2654]                	mov	[partition_num_txt], al
  3430                                  
  3431 000010E5 BE[0454]                	mov	si, msg_format_question
  3432 000010E8 E8A70A                  	call	print_msg
  3433                                  C_09:
  3434 000010EB 30E4                    	xor	ah, ah
  3435 000010ED CD16                    	int	16h
  3436                                  
  3437 000010EF 3C1B                    	cmp	al, 1Bh ; ESCAPE
  3438 000010F1 74A2                    	je	short C_06
  3439                                  
  3440 000010F3 24DF                    	and	al, 0DFh ; capitalization
  3441 000010F5 3C59                    	cmp	al, 'Y'
  3442 000010F7 740C                    	je	short C_10
  3443 000010F9 3C4E                    	cmp	al, 'N'
  3444 000010FB 75EE                    	jne	short C_09
  3445 000010FD BE[BE5C]                	mov	si, _msg_NO 
  3446 00001100 E88F0A                  	call	print_msg
  3447                                  	;jmp	short C_06
  3448                                  	; 24/02/2019
  3449 00001103 EB97                    	jmp	short save_mbr_exit 
  3450                                  C_10:
  3451 00001105 BE[B85C]                	mov	si, _msg_YES
  3452 00001108 E8870A                  	call	print_msg
  3453                                  
  3454                                  	; [pp_StartSector] = partition's start sector
  3455                                  	; [pp_Sectors] = partition size including start & end sector
  3456                                  	; [partition_num_chr] = partition number + '0'
  3457                                  	; [pp_type] = partition type (for TRDOS 386 boot sector)
  3458                                  
  3459 0000110B 8926[6068]              	mov	[old_sp], sp
  3460                                  	
  3461 0000110F 8A16[F16C]              	mov	dl, [pp_type]
  3462                                  	; DL = partition type (file system ID)
  3463                                  	;dec	dl
  3464                                  	;jz	FAT12_hd_format
  3465 00001113 80FA01                  	cmp	dl, 1 ; 14/09/2020 (BugFix)
  3466 00001116 0F86DC05                	jna	FAT12_hd_format
  3467                                  	;cmp	dl, 4
  3468                                  	;je	FAT16_hd_format
  3469                                  	;cmp	dl, 6
  3470                                  	;je	FAT16_hd_format
  3471 0000111A 80FA0B                  	cmp	dl, 0Bh 
  3472 0000111D 0F82D203                	jb	FAT16_hd_format
  3473                                  	;je	short FAT32_hd_format
  3474                                  	;cmp	dl, 0Ch ; 14/09/2020
  3475 00001121 0F877207                	ja	SINGLIX_hd_format
  3476                                  
  3477                                  	;cmp	dl, 0A1h
  3478                                  	;je	SINGLIX_hd_format
  3479                                  	;jb	RUNIX386_hd_format ; dl = 071h
  3480                                  
  3481                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3482                                  ; FAT32 FORMATTING
  3483                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3484                                  	
  3485                                  	; 08/02/2019 (Modified for -only- FAT32 CHS partitions)
  3486                                  FAT32_hd_format:
  3487                                  	;mov	ax, 000Ch ; db 0Ch, 00h ; 'or al, 0'
  3488                                  	;cmp	dl, al ; 0Ch
  3489                                  	;je	short FAT32_lbAx_format
  3490                                  	;mov	ax, 0C00Bh ; db 0Bh, 0C0h ; 'or ax, ax'
  3491                                  ;FAT32_lba_format:
  3492                                  	; Put TRDOS 386 FAT32 partition magic word 
  3493                                  	; at offset 5Ah, in TRDOS386 FAT32 boot sector 0.
  3494 00001125 BD[6B33]                	mov	bp, TRDOS_FAT32_hd_bs
  3495 00001128 8D7E03                  	lea	di, [bp+3]
  3496 0000112B BE[3864]                	mov	si, bs_oem_name
  3497 0000112E B90400                  	mov	cx, 4
  3498 00001131 F3A5                    	rep	movsw 
  3499                                  	;mov	[bp+5Ah], ax	; [loc_5A]
  3500 00001133 C7465A0BC0              	mov	word [bp+5Ah], 0C00Bh ; 08/02/2019
  3501 00001138 A1[7E3F]                	mov	ax, [sectors]
  3502 0000113B 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  3503 0000113E A1[803F]                	mov	ax, [heads]
  3504 00001141 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  3505 00001144 A1[E86C]                	mov	ax, [pp_StartSector]
  3506 00001147 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  3507 0000114A A1[EA6C]                	mov	ax, [pp_StartSector+2]
  3508 0000114D 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  3509                                  	;mov	ax, [pp_Sectors]
  3510 00001150 A1[1A6D]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  3511 00001153 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  3512                                  	;mov	dx, [pp_Sectors+2]
  3513 00001156 8B16[1C6D]              	mov	dx, [ppn_Sectors+2] ; 16/02/2019
  3514 0000115A 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  3515                                  	
  3516                                  	; Sectors per cluster calculation
  3517                                  	; (According to MS FAT32 FS specification.)
  3518 0000115D B108                    	mov	cl, 8  ; 8 sectors per cluster
  3519 0000115F 83FA08                  	cmp	dx, 8  ; >= 532480 sectors
  3520 00001162 7709                    	ja	short FAT32_f_2 ; 8 sectors per cluster
  3521 00001164 7205                    	jb	short FAT32_f_1 ; 1 sector per cluster
  3522 00001166 3D0020                  	cmp	ax, 2000h ; dx_ax = (8*65536)+8192
  3523 00001169 7302                    	jnb	short FAT32_f_2 ; 12/09/2020 (BugFix)
  3524                                  FAT32_f_1:
  3525 0000116B B101                    	mov	cl, 1	; 1 sector per cluster
  3526                                  FAT32_f_2:
  3527 0000116D 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  3528                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  3529                                  	;mov	word [bp+0Eh], 32 ; [BPB_RsvdSecCnt] 
  3530                                  
  3531                                  	; Calculating FAT size in sectors
  3532                                  	; (According to MS FAT32 FS Specification, 2000)
  3533                                  
  3534                                  	; DX_AX = partition (volume) size in sectors
  3535 00001170 2B460E                  	sub	ax, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  3536 00001173 83DA00                  	sbb	dx, 0
  3537                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  3538                                  		;	     		RootDirsectors)
  3539                                  		; RootDirSectors = 0 (for FAT32 FS)
  3540 00001176 89CB                    	mov	bx, cx ; ch = 0
  3541 00001178 C1E308                  	shl	bx, 8 ; * 256
  3542 0000117B 8A4E10                  	mov	cl, [bp+10h] ; [BPB_NumFATs] 
  3543 0000117E 01CB                    	add	bx, cx	
  3544                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  3545 00001180 D1EB                    	shr	bx, 1
  3546                                  		; TmpVal2 = TmpVal2/2
  3547 00001182 89D9                    	mov	cx, bx
  3548 00001184 4B                      	dec	bx  ; TmpVal2-1
  3549 00001185 01D8                    	add	ax, bx
  3550 00001187 83D200                  	adc	dx, 0
  3551 0000118A E8F0FA                  	call	div32
  3552                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  3553                                  	; DX_AX = FAT size in sectors
  3554 0000118D 894624                  	mov	[bp+24h], ax	; [BPB_FATSz32]
  3555 00001190 895626                  	mov	[bp+26h], dx	; [BPB_FATSz32+2]
  3556                                  	; * 2
  3557 00001193 89D3                    	mov	bx, dx
  3558 00001195 01C0                    	add	ax, ax
  3559 00001197 11D3                    	adc	bx, dx
  3560                                  	; BX_AX = [BPB_NumFATs] * [BPB_FATSz32]
  3561 00001199 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  3562 0000119C 01C1                    	add	cx, ax
  3563 0000119E 83D300                  	adc	bx, 0
  3564                                  	; BX_CX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  3565 000011A1 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  3566 000011A4 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  3567 000011A7 29C8                    	sub	ax, cx
  3568 000011A9 19DA                    	sbb	dx, bx
  3569 000011AB 890E[626A]              	mov	[data_start], cx
  3570 000011AF 891E[646A]              	mov	[data_start+2], bx
  3571                                  	; DX_AX = Data sectors
  3572 000011B3 A3[666A]                	mov	[data_sectors], ax
  3573 000011B6 8916[686A]              	mov	[data_sectors+2], dx
  3574 000011BA 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  3575 000011BD 30ED                    	xor	ch, ch
  3576 000011BF E8BBFA                  	call	div32 ; DX_AX/CX
  3577                                  	; DX_AX = Count of clusters (rounded down)
  3578 000011C2 A3[6A6A]                	mov	[cluster_count], ax
  3579 000011C5 8916[6C6A]              	mov	[cluster_count+2], dx
  3580                                  		
  3581 000011C9 8D7E47                  	lea	di, [bp+71] ; [BS_VolLab]
  3582 000011CC E89B01                  	call	write_volume_name
  3583 000011CF 8D7643                  	lea	si, [bp+67] ; [BS_VolID]
  3584 000011D2 E8F401                  	call	write_volume_serial
  3585 000011D5 E80503                  	call	write_cluster_count
  3586                                  
  3587 000011D8 E87502                  	call	write_formatting_msg
  3588 000011DB B000                    	mov	al, 0
  3589 000011DD E8D102                  	call	write_format_percent_x
  3590                                  
  3591 000011E0 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  3592 000011E3 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  3593 000011E6 0106[626A]              	add	[data_start], ax
  3594 000011EA 1116[646A]              	adc	[data_start+2], dx
  3595                                  FAT32_f_3:
  3596                                  	; DX_AX = FAT32 Boot Sector address
  3597 000011EE BB[6B33]                	mov	bx, TRDOS_FAT32_hd_bs
  3598                                  	; ES:BX = Boot Sector 1 Buffer
  3599 000011F1 E8030A                  	call	write_hd_sector
  3600 000011F4 0F82CD02                	jc	formatting_error
  3601 000011F8 E87902                  	call	write_format_percent
  3602 000011FB 83C001                  	add	ax, 1
  3603 000011FE 83D200                  	adc	dx, 0
  3604 00001201 BB[4E66]                	mov	bx, HDFORMAT_FSINFO_BUFF
  3605                                  	; ES:BX = FS INFO Sector Buffer (= BS+1)
  3606 00001204 E8F009                  	call	write_hd_sector
  3607 00001207 0F82BA02                	jc	formatting_error
  3608 0000120B E86602                  	call	write_format_percent
  3609 0000120E 83C001                  	add	ax, 1
  3610 00001211 83D200                  	adc	dx, 0	
  3611 00001214 BB[6B35]                	mov	bx, TRDOS_FAT32_hd_bs + 512
  3612                                  	; ES:BX = Boot Sector 2 Buffer
  3613 00001217 E8DD09                  	call	write_hd_sector
  3614 0000121A 0F82A702                	jc	formatting_error
  3615 0000121E E85302                  	call	write_format_percent
  3616 00001221 B90300                  	mov	cx, 3
  3617                                  FAT32_f_4:
  3618 00001224 51                      	push	cx
  3619 00001225 83C001                  	add	ax, 1
  3620 00001228 83D200                  	adc	dx, 0
  3621 0000122B BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3622 0000122E E8C609                  	call	write_hd_sector
  3623 00001231 0F829002                	jc	formatting_error
  3624 00001235 E83C02                  	call	write_format_percent
  3625 00001238 59                      	pop	cx
  3626 00001239 FEC9                    	dec	cl
  3627 0000123B 75E7                    	jnz	short FAT32_f_4
  3628 0000123D 83C001                  	add	ax, 1
  3629 00001240 83D200                  	adc	dx, 0
  3630 00001243 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  3631 00001246 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  3632 00001249 83C10C                  	add	cx, 12
  3633 0000124C 83D300                  	adc	bx, 0
  3634                                  	; write BACKUP sectors
  3635                                  	; (6,7,8 boot+fsi and 9,10,11 empty sectors)
  3636 0000124F 39DA                    	cmp	dx, bx
  3637 00001251 729B                    	jb	short FAT32_f_3
  3638 00001253 39C8                    	cmp	ax, cx
  3639 00001255 7297                    	jb	short FAT32_f_3
  3640                                  	; write remain part of reserved sectors
  3641 00001257 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt]
  3642 0000125A 83E90C                  	sub	cx, 12
  3643 0000125D 7618                    	jna	short FAT32_f_6
  3644                                  FAT32_f_5:
  3645 0000125F 51                      	push	cx
  3646 00001260 BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3647 00001263 E89109                  	call	write_hd_sector
  3648 00001266 0F825B02                	jc	formatting_error
  3649 0000126A E80702                  	call	write_format_percent
  3650 0000126D 83C001                  	add	ax, 1
  3651 00001270 83D200                  	adc	dx, 0
  3652 00001273 59                      	pop	cx
  3653 00001274 49                      	dec	cx
  3654 00001275 75E8                    	jnz	short FAT32_f_5
  3655                                  FAT32_f_6:
  3656                                  	; write FAT sectors
  3657 00001277 8B0E[626A]              	mov	cx, [data_start] ; lba/abs addr
  3658 0000127B 8B1E[646A]              	mov	bx, [data_start+2] ; lba/abs addr
  3659 0000127F 53                      	push	bx
  3660 00001280 51                      	push	cx
  3661 00001281 BB[6268]                	mov	bx, HDFORMAT_FATBUFFER
  3662                                  	; ES:BX = FAT Sector Buffer
  3663 00001284 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  3664 00001287 B5FF                    	mov	ch, 0FFh
  3665 00001289 890F                    	mov	[bx], cx
  3666 0000128B 88E9                    	mov	cl, ch ; cx = 0FFFFh
  3667 0000128D 894F02                  	mov	[bx+2], cx
  3668 00001290 894F04                  	mov	[bx+4], cx
  3669 00001293 894F06                  	mov	[bx+6], cx
  3670                                  	; Root dir cluster number = 2
  3671                                  	; 0FFFFFFFh = end of cluster chain 
  3672 00001296 894F08                  	mov	[bx+8], cx  ; 0FFFFh
  3673 00001299 80E50F                  	and	ch, 0Fh
  3674 0000129C 894F0A                  	mov	[bx+10], cx ; 0FFFh
  3675                                  	;inc	cx
  3676 0000129F E85509                  	call	write_hd_sector
  3677 000012A2 0F821F02                	jc	formatting_error
  3678 000012A6 E8CB01                  	call	write_format_percent
  3679                                  	;mov	bx, HDFORMAT_FATBUFFER
  3680 000012A9 B90000                  	mov	cx, 0
  3681 000012AC 890F                    	mov	[bx], cx
  3682 000012AE 894F02                  	mov	[bx+2], cx
  3683 000012B1 894F04                  	mov	[bx+4], cx
  3684 000012B4 894F06                  	mov	[bx+6], cx
  3685 000012B7 894F08                  	mov	[bx+8], cx
  3686 000012BA 894F0A                  	mov	[bx+10], cx
  3687 000012BD EB0F                    	jmp	short FAT32_f_8
  3688                                  FAT32_f_7:	
  3689 000012BF 53                      	push	bx
  3690 000012C0 51                      	push	cx
  3691 000012C1 BB[6268]                	mov	bx, HDFORMAT_FATBUFFER
  3692 000012C4 E83009                  	call	write_hd_sector
  3693 000012C7 0F82FA01                	jc	formatting_error
  3694 000012CB E8A601                  	call	write_format_percent
  3695                                  FAT32_f_8:	
  3696 000012CE 59                      	pop	cx
  3697 000012CF 5B                      	pop	bx
  3698 000012D0 83C001                  	add	ax, 1
  3699 000012D3 83D200                  	adc	dx, 0
  3700 000012D6 39DA                    	cmp	dx, bx
  3701 000012D8 72E5                    	jb	short FAT32_f_7
  3702 000012DA 39C8                    	cmp	ax, cx
  3703 000012DC 72E1                    	jb	short FAT32_f_7
  3704                                  
  3705                                  	; write	root directory (1st cluster)
  3706                                  	; as empty sectors
  3707 000012DE 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  3708 000012E1 30ED                    	xor	ch, ch
  3709 000012E3 290E[666A]              	sub	[data_sectors], cx
  3710 000012E7 831E[686A]00            	sbb	word [data_sectors+2], 0
  3711                                  FAT32_f_9:
  3712 000012EC 51                      	push	cx
  3713 000012ED BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3714 000012F0 E80409                  	call	write_hd_sector
  3715 000012F3 0F82CE01                	jc	formatting_error
  3716 000012F7 E87A01                  	call	write_format_percent
  3717 000012FA 83C001                  	add	ax, 1
  3718 000012FD 83D200                  	adc	dx, 0
  3719 00001300 59                      	pop	cx
  3720 00001301 FEC9                    	dec	cl
  3721 00001303 75E7                    	jnz	short FAT32_f_9
  3722                                  
  3723                                  	; write DATA sectors 
  3724                                  	; (after root directory 1st cluster)
  3725 00001305 8B0E[666A]              	mov	cx, [data_sectors]
  3726 00001309 8B1E[686A]              	mov	bx, [data_sectors+2] 
  3727                                  			; NOTE: Partition size must be >= 512 MB
  3728                                  			;	for FAT32 FS  ((BX >= 15))
  3729                                  FAT32_f_10:	
  3730 0000130D 53                      	push	bx
  3731 0000130E 51                      	push	cx	
  3732 0000130F BB[4E64]                	mov	bx, HDFORMAT_SECBUFFER
  3733 00001312 E8E208                  	call	write_hd_sector
  3734 00001315 0F82AC01                	jc	formatting_error
  3735 00001319 E85801                  	call	write_format_percent
  3736 0000131C 59                      	pop	cx
  3737 0000131D 5B                      	pop	bx
  3738 0000131E 83C001                  	add	ax, 1
  3739 00001321 83D200                  	adc	dx, 0
  3740 00001324 49                      	dec	cx
  3741 00001325 75E6                    	jnz	short FAT32_f_10
  3742 00001327 4B                      	dec	bx
  3743 00001328 75E3                    	jnz	short FAT32_f_10
  3744                                  
  3745                                  	; If there are, format remain sectors which are
  3746                                  	; at beyond of data clusters, with zero bytes.
  3747                                  	
  3748 0000132A 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  3749 0000132D 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  3750                                  FAT16_f_18:	
  3751 00001330 034E20                  	add	cx, [bp+20h]	; [BPB_TotSec32]
  3752 00001333 135E22                  	adc	bx, [bp+22h]	; [BPB_TotSec32+2]
  3753                                  FAT16_f_19:
  3754                                  FAT12_f_8:
  3755                                  	; are there remain sectors (in partition) ?
  3756 00001336 29C1                    	sub	cx, ax
  3757 00001338 19D3                    	sbb	bx, dx
  3758                                  	; 11/02/2019
  3759                                  	; BX must be 0 (Because, 1 cluster <= 32KB. So, 
  3760                                  	;	        remain sectors must not be more than 32K)
  3761 0000133A 751C                    	jnz	short FAT32_f_12 ; There is a wrong thing !!!
  3762                                  				 ; If BX is not zero,	
  3763                                  				 ; it is better to skip this stage...)
  3764 0000133C 09C9                    	or	cx, cx		
  3765 0000133E 7418                    	jz	short FAT32_f_12 ; no..
  3766                                  				 ; (good! FAT contains all data sectors)
  3767                                  FAT32_f_11:
  3768 00001340 51                      	push	cx
  3769 00001341 BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  3770 00001344 E8B008                  	call	write_hd_sector
  3771 00001347 0F827A01                	jc	formatting_error
  3772 0000134B E82601                  	call	write_format_percent
  3773 0000134E 59                      	pop	cx
  3774 0000134F 83C001                  	add	ax, 1
  3775 00001352 83D200                  	adc	dx, 0
  3776 00001355 49                      	dec	cx
  3777 00001356 75E8                    	jnz	short FAT32_f_11
  3778                                  
  3779                                  FAT32_f_12:
  3780                                  SINGLIX_fs1_f_12:
  3781                                  	; End of FAT format routine...
  3782                                  end_of_formatting:
  3783 00001358 B064                    	mov	al, 100
  3784 0000135A E85401                  	call	write_format_percent_x
  3785                                  	;mov	si, CRLF
  3786                                  	;call	print_msg
  3787 0000135D BE[7B55]                	mov	si, Msg_OK
  3788                                  	;call	print_msg
  3789                                  	;jmp	_exit
  3790                                  	; 19/10/2020
  3791 00001360 E947F4                  	jmp	_p_exit
  3792                                  
  3793                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3794                                  ; set & write volume name
  3795                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3796                                  
  3797                                  write_fs_volume_name:
  3798 00001363 C606[3764]40            	mov	byte [vname_length], 64
  3799 00001368 EB05                    	jmp	short svn_fs
  3800                                  
  3801                                  write_volume_name:
  3802 0000136A C606[3764]0B            	mov	byte [vname_length], 11
  3803                                  svn_fs:
  3804                                  	; DI = (BS) Volume Label address
  3805 0000136F BE[1D55]                	mov	si, Msg_Volume_Name
  3806 00001372 E81D08                  	call	print_msg
  3807                                  
  3808                                  	; get cursor position
  3809                                  	; bh = 0  ; video page
  3810 00001375 B403                    	mov     ah, 3 ; get cursor pos
  3811 00001377 CD10                    	int     10h
  3812 00001379 8916[C354]              	mov	[Cursor_Pos], dx
  3813                                  
  3814 0000137D E8FF08                  	call	rw_char
  3815 00001380 7207                    	jc	short svn_1
  3816                                  svn_0:
  3817 00001382 AC                      	lodsb
  3818 00001383 3C20                    	cmp	al, 20h
  3819 00001385 7706                    	ja	short svn_2
  3820 00001387 74F9                    	je	short svn_0 
  3821                                  svn_1:
  3822 00001389 BE[4264]                	mov	si, no_name
  3823 0000138C AC                      	lodsb
  3824                                  svn_2:
  3825                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
  3826                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
  3827 0000138D 89FB                    	mov	bx, di ; *
  3828 0000138F 30ED                    	xor	ch, ch
  3829 00001391 8A0E[3764]              	mov	cl, [vname_length] ; 11
  3830 00001395 EB05                    	jmp	short svn_4
  3831                                  svn_3:
  3832 00001397 AC                      	lodsb
  3833 00001398 3C20                    	cmp	al, 20h
  3834 0000139A 7226                    	jb	short svn_6
  3835                                  svn_4:
  3836 0000139C AA                      	stosb
  3837 0000139D E2F8                    	loop	svn_3
  3838                                  svn_5:
  3839 0000139F 8A0E[3764]              	mov	cl, [vname_length] ; 11
  3840 000013A3 89DE                    	mov	si, bx ; *
  3841 000013A5 BF[DC54]                	mov	di, StrVolumeName
  3842 000013A8 F3A4                    	rep	movsb
  3843                                  	;mov	byte [di], 0
  3844                                  
  3845 000013AA 8B16[C354]              	mov	dx, [Cursor_Pos]
  3846 000013AE BB0700                  	mov	bx, 7
  3847 000013B1 B402                    	mov	ah, 2
  3848 000013B3 CD10                    	int	10h  ; Set Cursor Position
  3849                                  
  3850 000013B5 BE[DC54]                	mov	si, StrVolumeName
  3851 000013B8 E8D707                  	call	print_msg
  3852 000013BB BE[7F55]                	mov	si, CRLF
  3853 000013BE E8D107                  	call	print_msg
  3854 000013C1 C3                      	retn
  3855                                  svn_6:
  3856 000013C2 B020                    	mov	al, 20h
  3857                                  svn_7:
  3858 000013C4 AA                      	stosb
  3859 000013C5 E2FD                    	loop	svn_7
  3860 000013C7 EBD6                    	jmp	short svn_5
  3861                                  
  3862                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3863                                  ; set & write volume serial number (volume ID)
  3864                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3865                                  
  3866                                  write_volume_serial:
  3867                                  	; SI = (BS) Volume Serial Number (binary) address
  3868                                  
  3869                                  	;xor	ax, ax
  3870                                  	;int	1Ah			; get time of day
  3871                                  
  3872                                  	;mov	[si], dx
  3873                                  	;mov	[si+2], cx		; set unique volume ID
  3874                                  
  3875                                  	;mov	ah, 02h			; Return Current Time
  3876                                  	;int	1Ah
  3877                                  	;xchg	ch, cl
  3878                                  	;xchg	dh, dl
  3879                                  
  3880                                  	;add	cx, dx
  3881                                  	;add	[si+2], cx
  3882                                                 
  3883                                  	;mov	ah, 04h			; Return Current Date
  3884                                  	;int	1Ah
  3885                                  
  3886                                  	;xchg	ch,cl
  3887                                  	;xchg	dh,dl
  3888                                  
  3889                                  	;add	cx, dx
  3890                                  	;add	[si+2], cx
  3891                                  
  3892                                  	; According to Microsoft DOS 6.0 serial number
  3893                                  	; production method...
  3894                                  	; < Create unique 32 bit serial number >
  3895                                  
  3896                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
  3897                                  	; (20/04/1987)
  3898                                  	;
  3899                                  	;  Get date (INT 21h, AH=2Bh)
  3900                                  	;  Get time (INT 21h, AH=2Ch)
  3901                                  	;  Serial_ID+0 = DX reg date + DX reg time
  3902                                  	;  Serial_ID+2 = CX reg date + CX reg time
  3903                                  	;  Serial_Num_Low = Serial_ID+2
  3904                                  	;  Serial_Num_High = Serial_ID+0
  3905                                  
  3906 000013C9 B404                    	mov	ah, 04h		; Return Current Date
  3907 000013CB CD1A                    	int	1Ah
  3908                                  
  3909                                  	; DL = Day (BCD)	(20h)
  3910                                  	; DH = Month (BCD)	(12h)
  3911                                  	; CH = Century (BCD)	(20h)
  3912                                  	; CL = Year (BCD) 	(17h)
  3913                                  
  3914 000013CD 88D0                    	mov	al, dl
  3915 000013CF E87100                  	call	bcd_to_bin
  3916 000013D2 88C2                    	mov	dl, al 
  3917 000013D4 88F0                    	mov	al, dh
  3918 000013D6 E86A00                  	call	bcd_to_bin
  3919 000013D9 88C6                    	mov	dh, al 
  3920 000013DB 88C8                    	mov	al, cl
  3921 000013DD E86300                  	call	bcd_to_bin
  3922 000013E0 88C1                    	mov	cl, al 
  3923 000013E2 88E8                    	mov	al, ch
  3924 000013E4 E85C00                  	call	bcd_to_bin
  3925 000013E7 88C5                    	mov	ch, al
  3926                                  
  3927                                  	; DH = Month (1-10)
  3928                                  	; DL = Day (1-31)
  3929                                  	; CX = Year (1900-2099)
  3930                                  
  3931 000013E9 52                      	push	dx 
  3932 000013EA 51                      	push	cx
  3933                                  
  3934 000013EB B402                    	mov	ah, 02h		; Return Current Time
  3935 000013ED CD1A                    	int	1Ah
  3936                                  	
  3937                                  	; DH = Seconds (BCD)	(59h)
  3938                                  	; CL = Minutes (BCD)	(59h)
  3939                                  	; CH = Hours (BCD)	(23h)
  3940                                  	; DL = Daylight savings time option (1=yes)
  3941                                  
  3942 000013EF 88F0                    	mov	al, dh
  3943 000013F1 E84F00                  	call	bcd_to_bin
  3944 000013F4 88C6                    	mov	dh, al 
  3945 000013F6 88C8                    	mov	al, cl
  3946 000013F8 E84800                  	call	bcd_to_bin
  3947 000013FB 88C1                    	mov	cl, al 
  3948 000013FD 88E8                    	mov	al, ch
  3949 000013FF E84100                  	call	bcd_to_bin
  3950 00001402 88C5                    	mov	ch, al 
  3951                                  
  3952                                  	; CH = Hour (0-23)
  3953                                  	; CL = Minutes (0-59)
  3954                                  	; DH = Seconds (0-59)
  3955                                  	; ((DL = Hundredths (0-99) - MSDOS!))
  3956                                  	; DL = 0 or 1 (here!)
  3957                                  
  3958 00001404 89C8                    	mov	ax, cx
  3959 00001406 59                      	pop	cx
  3960 00001407 01C8                    	add	ax, cx
  3961                                  
  3962 00001409 894402                  	mov	[si+2], ax
  3963                                  
  3964 0000140C 89D0                    	mov	ax, dx
  3965 0000140E 5A                      	pop	dx
  3966 0000140F 01D0                    	add	ax, dx
  3967                                  
  3968 00001411 8904                    	mov	[si], ax
  3969                                  
  3970 00001413 30E4                    	xor	ah, ah		; Read time counter
  3971 00001415 CD1A                    	int	1Ah
  3972                                  
  3973                                  	; CX = High word of clock count
  3974                                  	; DX = Low word of clock count
  3975                                  	; AL = 0 if 24 hours has not passed, else 1
  3976                                  
  3977                                  	; NOTES: 
  3978                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
  3979                                  	;
  3980                                     	; Following formulas convert the clock count to
  3981                                          ; the time of day:
  3982                                   	;	Hour      = Clock / 65543 (1007h)
  3983                                  	;	Remainder = Clock MOD 65543
  3984                                   	;
  3985                                  	;	Minutes   = Remainder / 1092 (444h)
  3986                                  	;	Remainder = Remainder MOD 1092
  3987                                  	;
  3988                                  	;	Second    = Remainder / 18.21
  3989                                  	;	Remainder = Remainder MOD 18.21
  3990                                  	;
  3991                                  	;	Hundredths = CINT(Remainder * 100)
  3992                                  
  3993 00001417 0014                    	add	[si], dl
  3994                                  
  3995                                  	; SI = Volume serial number address (4 bytes) 
  3996 00001419 8A04                    	mov	al, [si]
  3997 0000141B E84A08                  	call	bin_to_hex
  3998 0000141E A3[4855]                	mov	[Vol_Serial2+2], ax
  3999 00001421 8A4401                  	mov	al, [si+1]
  4000 00001424 E84108                  	call	bin_to_hex
  4001 00001427 A3[4655]                	mov	[Vol_Serial2], ax
  4002 0000142A 8A4402                  	mov	al, [si+2]
  4003 0000142D E83808                  	call	bin_to_hex
  4004 00001430 A3[4355]                	mov	[Vol_Serial1+2], ax
  4005 00001433 8A4403                  	mov	al, [si+3]
  4006 00001436 E82F08                  	call	bin_to_hex
  4007 00001439 A3[4155]                	mov	[Vol_Serial1], ax
  4008                                  
  4009 0000143C BE[2F55]                	mov	si, Msg_Volume_Serial
  4010 0000143F E85007                  	call	print_msg
  4011                                  
  4012 00001442 C3                      	retn
  4013                                  
  4014                                  bcd_to_bin:
  4015 00001443 53                      	push	bx
  4016 00001444 D410                    	db	0D4h,10h  ; Undocumented inst. AAM
  4017                                  			  ; AH = AL / 10h
  4018                                  			  ; AL = AL MOD 10h
  4019 00001446 88C3                    	mov	bl, al
  4020 00001448 B00A                    	mov	al, 10
  4021 0000144A F6E4                    	mul	ah
  4022 0000144C 00D8                    	add	al, bl
  4023 0000144E 5B                      	pop	bx
  4024 0000144F C3                      	retn
  4025                                  
  4026                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4027                                  ; write formatting percentage
  4028                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4029                                  
  4030                                  write_formatting_msg:
  4031                                  	;mov	ax, [pp_Sectors]
  4032                                  	;mov	dx, [pp_Sectors+2]
  4033                                  	; 16/02/2019
  4034 00001450 A1[1A6D]                	mov	ax, [ppn_Sectors]
  4035 00001453 8B16[1C6D]              	mov	dx, [ppn_Sectors+2]
  4036                                  
  4037                                  	; DX_AX = Total sectors for percentage
  4038                                  	;mov	cx, 100	
  4039 00001457 B90064                  	mov	cx, 256*100 ; 16/03/2021 
  4040 0000145A E820F8                  	call	div32
  4041 0000145D A3[706A]                	mov	[format_percent], ax
  4042                                  
  4043 00001460 BE[6755]                	mov	si, msg_formatting
  4044 00001463 E82C07                  	call	print_msg
  4045                                  
  4046                                  	; get cursor position
  4047                                  	; bh = 0  ; video page
  4048 00001466 B403                    	mov     ah, 3 ; get cursor pos
  4049 00001468 CD10                    	int     10h
  4050 0000146A 8916[C354]              	mov	[Cursor_Pos], dx
  4051                                  
  4052 0000146E C606[726A]FF            	mov	byte [prev_percent], 255
  4053                                  
  4054 00001473 C3                      	retn
  4055                                  
  4056                                  write_format_percent:
  4057                                  	; DX_AX = Current sector (which has been written)
  4058                                  
  4059 00001474 50                      	push	ax
  4060 00001475 52                      	push	dx
  4061 00001476 53                      	push	bx
  4062 00001477 51                      	push	cx
  4063 00001478 56                      	push	si
  4064                                  
  4065 00001479 2B461C                  	sub	ax, [bp+1Ch]	; [BPB_HiddSec]
  4066 0000147C 1B561E                  	sbb	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4067                                  wpc_t:
  4068 0000147F 8B0E[706A]              	mov	cx, [format_percent]
  4069 00001483 E8F7F7                  	call	div32
  4070                                  	; AL = percentage value between 1 to 100
  4071                                  	; 16/03/2021
  4072                                  	; AH = percentage value between 1 to 100
  4073                                  wpc_x:
  4074                                  	;cmp	al, [prev_percent]
  4075                                  	;je	short wpc_y
  4076                                  	;mov	[prev_percent], al
  4077                                  	; 16/03/2021
  4078 00001486 3A26[726A]              	cmp	ah, [prev_percent]
  4079 0000148A 741F                    	je	short wpc_y
  4080 0000148C 8826[726A]              	mov	[prev_percent], ah
  4081 00001490 8B16[C354]              	mov	dx, [Cursor_Pos]
  4082 00001494 BB0700                  	mov	bx, 7
  4083 00001497 B402                    	mov	ah, 2
  4084 00001499 CD10                    	int	10h  ; Set Cursor Position
  4085 0000149B 31D2                    	xor	dx, dx
  4086 0000149D 30E4                    	xor	ah, ah
  4087 0000149F A0[726A]                	mov	al, [prev_percent] ; 16/03/2021
  4088 000014A2 BE[7555]                	mov	si, format_percent_str + 2
  4089 000014A5 E8A907                  	call	bin_to_decimal
  4090 000014A8 E8E706                  	call	print_msg
  4091                                  wpc_y:
  4092 000014AB 5E                      	pop	si
  4093 000014AC 59                      	pop	cx
  4094 000014AD 5B                      	pop	bx
  4095 000014AE 5A                      	pop	dx
  4096 000014AF 58                      	pop	ax
  4097 000014B0 C3                      	retn
  4098                                  
  4099                                  write_format_percent_x:
  4100                                  	; AL = % number
  4101                                  
  4102 000014B1 50                      	push	ax
  4103 000014B2 52                      	push	dx
  4104 000014B3 53                      	push	bx
  4105 000014B4 51                      	push	cx
  4106 000014B5 56                      	push	si
  4107                                  
  4108 000014B6 EBCE                    	jmp	short wpc_x
  4109                                  
  4110                                  write_fs_format_percent:
  4111                                  	; DX_AX = Current sector (which has been written)
  4112                                  
  4113 000014B8 50                      	push	ax
  4114 000014B9 52                      	push	dx
  4115 000014BA 53                      	push	bx
  4116 000014BB 51                      	push	cx
  4117 000014BC 56                      	push	si
  4118                                  
  4119 000014BD 2B460C                  	sub	ax, [bp+0Ch]	; [bsBeginSector]
  4120 000014C0 1B560E                  	sbb	dx, [bp+0Eh]	; [bsBeginSector+2]
  4121 000014C3 EBBA                    	jmp	short wpc_t
  4122                                  	
  4123                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4124                                  ; format error 
  4125                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4126                                  
  4127                                  formatting_error:
  4128 000014C5 8B26[6068]              	mov	sp, [old_sp]
  4129                                  
  4130 000014C9 88E0                    	mov	al, ah ;  error code
  4131 000014CB E89A07                  	call	bin_to_hex
  4132 000014CE A3[8D55]                	mov 	[error_code], ax
  4133                                  
  4134 000014D1 BE[7F55]                	mov	si, CRLF
  4135 000014D4 E8BB06                  	call	print_msg
  4136                                  
  4137 000014D7 BE[8255]                	mov	si, Msg_Error
  4138                                  	;call	print_msg
  4139                                  	;jmp	_exit
  4140                                  	; 19/10/2020
  4141 000014DA E9CDF2                  	jmp	_p_exit
  4142                                  
  4143                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4144                                  ; write cluster count
  4145                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4146                                  
  4147                                  write_cluster_count:
  4148 000014DD BE[4D55]                	mov	si, msg_cluster_count
  4149 000014E0 E8AF06                  	call	print_msg
  4150 000014E3 A1[6A6A]                	mov	ax, [cluster_count]
  4151 000014E6 8B16[6C6A]              	mov	dx, [cluster_count+2]
  4152 000014EA BE[6355]                	mov	si, cluster_count_str+6
  4153 000014ED E86107                  	call	bin_to_decimal
  4154                                  	;call	print_msg
  4155                                  	;retn
  4156                                  	; 19/10/2020
  4157 000014F0 E99F06                  	jmp	print_msg 
  4158                                  
  4159                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4160                                  ; FAT16 FORMATTING
  4161                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4162                                  	; 08/02/2019 (Modified for -only- FAT16 CHS partitions)
  4163                                  FAT16_hd_format:
  4164                                  ; 04/05/2024 (Retro DOS v5 modification)
  4165                                  ; DL = Partition (FS) ID
  4166                                  ;	mov	ax, 0706h ; db 06h, 07h ; 'push es, pop es'
  4167                                  ;	cmp	dl, al ; 06h ; Big CHS partition (>= 32MB)
  4168                                  ;	je	short FAT16_big_chs_format
  4169                                  ;	;mov	ax, 070Eh ; db 0Eh, 07h	; 'push cs, pop es'
  4170                                  ;	;cmp	dl, al ; 0Eh ; LBA partition
  4171                                  ;	;je	short FAT16_lba_format
  4172                                  ;FAT16_chs_format:  
  4173                                  ;	; Partition Type: 04h, CHS (<32 MB) partition
  4174                                  ;	mov	ax, 0004h ; db 04h, 00h ; 'add al, 0'
  4175                                  ;FAT16_big_chs_format:
  4176                                  ;;;
  4177                                  ;;FAT16_lba_format:
  4178                                  	; Put TRDOS 386 FAT16 partition magic word 
  4179                                  	; at offset 3Eh, in TRDOS386 FAT16 boot sector.
  4180 000014F3 BD[6B37]                	mov	bp, TRDOS_FAT16_hd_bs
  4181 000014F6 8D7E03                  	lea	di, [bp+3]
  4182 000014F9 BE[3864]                	mov	si, bs_oem_name
  4183 000014FC B90400                  	mov	cx, 4
  4184 000014FF F3A5                    	rep	movsw 
  4185                                  
  4186                                  	;mov	[bp+3Eh], ax	; [loc_3E]
  4187                                  	; 04/05/2024 (Retro DOS v5 modification)
  4188 00001501 80FA06                  	cmp	dl, 6
  4189 00001504 7404                    	je	short FAT16_f_x ; skip ; db 'RDv5 FAT16 06h', 0
  4190                                  	; dl = 04h or 0Eh
  4191 00001506 8896CE01                	mov	[bp+1CEh], dl	; Retro DOS v5 boot sect off 1CEh
  4192                                  				; (see: 'rd5hdbs.txt' for 1CEh)
  4193                                  FAT16_f_x:
  4194 0000150A A1[7E3F]                	mov	ax, [sectors]
  4195 0000150D 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4196 00001510 A1[803F]                	mov	ax, [heads]
  4197 00001513 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4198 00001516 A1[E86C]                	mov	ax, [pp_StartSector]
  4199 00001519 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4200 0000151C A1[EA6C]                	mov	ax, [pp_StartSector+2]
  4201 0000151F 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4202                                  	;mov	ax, [pp_Sectors]
  4203 00001522 A1[1A6D]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  4204                                  	;mov	dx, [pp_Sectors+2]
  4205 00001525 8B16[1C6D]              	mov	dx, [ppn_Sectors+2] ; 16/02/2019
  4206 00001529 21D2                    	and	dx, dx
  4207 0000152B 7505                    	jnz	short FAT16_f_0
  4208 0000152D 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  4209                                  	; CX = 0
  4210                                  	;mov	[bp+20h], cx	; [BPB_TotSec32] =  0
  4211                                  	;mov	[bp+22h], cx	; [BPB_TotSec32+2] = 0
  4212 00001530 EB06                    	jmp	short FAT16_f_1
  4213                                  FAT16_f_0:
  4214 00001532 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  4215                                  	;;mov	dx, [pp_Sectors+2]
  4216                                  	;mov	dx, [ppn_Sectors+2] ; 16/02/2019 
  4217 00001535 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  4218                                  	; CX = 0
  4219                                  	;mov	[bp+13h], cx ; [BPB_TotSec16] = 0
  4220                                  FAT16_f_1:
  4221                                  	; Sectors per cluster calculation
  4222                                  	; (According to MS FAT32 FS specification.)
  4223 00001538 B102                    	mov	cl, 2  ; 2 sectors per cluster
  4224 0000153A 09D2                    	or	dx, dx
  4225 0000153C 7507                    	jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  4226 0000153E 3DA87F                  	cmp	ax, 32680
  4227 00001541 763C                    	jna	short FAT16_f_10 ; 2 sectors, <=16MB
  4228                                  	; > 16MB
  4229 00001543 EB38                    	jmp	short FAT16_f_9 ; 4 sectors per cluster
  4230                                  FAT16_f_2:
  4231 00001545 83FA04                  	cmp	dx, 4  ; >= 262144 sectors ; >=128MB
  4232 00001548 7708                    	ja	short FAT16_f_3 ; >4 sectors per cluster
  4233 0000154A 7231                    	jb	short FAT16_f_9 ; 4 sectors per cluster	
  4234 0000154C 09C0                    	or	ax, ax ; dx_ax = (4*65536)+0
  4235 0000154E 742D                    	jz	short FAT16_f_9 ; 4 sectors per cluster
  4236 00001550 EB29                    	jmp	short FAT16_f_8 ; 8 sectors per cluster
  4237                                  FAT16_f_3:
  4238 00001552 83FA08                  	cmp	dx, 8  ; >= 524288 sectors ; >=256MB
  4239 00001555 7708                    	ja	short FAT16_f_4 ; >8 sectors per cluster
  4240 00001557 7222                    	jb	short FAT16_f_8 ; 8 sectors per cluster	
  4241 00001559 21C0                    	and	ax, ax ; dx_ax = (8*65536)+0
  4242 0000155B 741E                    	jz	short FAT16_f_8 ; 8 sectors per cluster
  4243 0000155D EB1A                    	jmp	short FAT16_f_7 ; 16 sectors per cluster
  4244                                  FAT16_f_4:
  4245 0000155F 83FA10                  	cmp	dx, 16 ; >= 1048576 sectors ; >=512MB
  4246 00001562 7708                    	ja	short FAT16_f_5 ; >16 sectors per cluster
  4247 00001564 7213                    	jb	short FAT16_f_7 ; 16 sectors per cluster
  4248 00001566 21C0                    	and	ax, ax ; dx_ax = (16*65536)+0
  4249 00001568 740F                    	jz	short FAT16_f_7 ; 16 sectors per cluster
  4250 0000156A EB0B                    	jmp	short FAT16_f_6 ; 32 sectors per cluster
  4251                                  FAT16_f_5:
  4252 0000156C 83FA20                  	cmp	dx, 32 ; >= 2097152 sectors ; >=1GB
  4253 0000156F 7206                    	jb	short FAT16_f_6 ; 32 sectors per cluster
  4254 00001571 09C0                    	or	ax, ax		; dx_ax = (32*65536)+0
  4255 00001573 7402                    	jz	short FAT16_f_6 ; 32 sectors per cluster
  4256                                  	; >1GB (<=2GB)
  4257                                  	; 64 sectors per cluster
  4258 00001575 D0E1                    	shl	cl, 1
  4259                                  FAT16_f_6:
  4260                                  	; 32 sectors per cluster (for <= 2GB volumes)
  4261 00001577 D0E1                    	shl	cl, 1	
  4262                                  FAT16_f_7:
  4263                                  	; 16 sectors per cluster (for <= 1GB volumes)
  4264 00001579 D0E1                    	shl	cl, 1
  4265                                  FAT16_f_8:
  4266                                  	; 8 sectors per cluster (for <= 512MB volumes)
  4267 0000157B D0E1                    	shl	cl, 1	
  4268                                  FAT16_f_9:
  4269                                  	; 4 sectors per cluster (for <= 256MB volumes)
  4270 0000157D D0E1                    	shl	cl, 1	
  4271                                  FAT16_f_10:	
  4272                                  	; 2 sectors per cluster (for <= 128MB volumes)
  4273 0000157F 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4274                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4275                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  4276                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  4277                                  	
  4278                                  	; Calculating FAT size in sectors
  4279                                  	; (According to MS FAT32 FS Specification, 2000)
  4280                                  
  4281                                  	; DX_AX = partition (volume) size in sectors
  4282 00001582 8B5E11                  	mov	bx, [bp+11h]	; [BPB_RootEntCnt] = 512
  4283 00001585 83C30F                  	add	bx, 15 ; bx = 527
  4284 00001588 C1EB04                  	shr	bx, 4 ; /16 = 527/16 = 32
  4285                                  		; ((32*BX)+511)/512
  4286 0000158B 891E[6E6A]              	mov	[root_dir_secs], bx
  4287 0000158F 035E0E                  	add	bx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4288 00001592 29D8                    	sub	ax, bx
  4289 00001594 83DA00                  	sbb	dx, 0
  4290                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  4291                                  		;	     		RootDirsectors)
  4292                                  	;mov	bx, cx ; ch = 0
  4293                                  	;shl	bx, 8 ; * 256
  4294                                  	; 11/02/2019
  4295 00001597 88CF                    	mov	bh, cl
  4296 00001599 30DB                    	xor	bl, bl
  4297 0000159B B102                    	mov	cl, 2 ; [BPB_NumFATs]
  4298 0000159D 01CB                    	add	bx, cx	
  4299                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  4300 0000159F 89D9                    	mov	cx, bx
  4301 000015A1 4B                      	dec	bx  ; TmpVal2-1
  4302 000015A2 01D8                    	add	ax, bx
  4303 000015A4 83D200                  	adc	dx, 0
  4304 000015A7 E8D3F6                  	call	div32
  4305                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  4306                                  	; AX = FAT size in sectors
  4307                                  	; DX = 0
  4308 000015AA 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  4309                                  	; * 2
  4310 000015AD D1E0                    	shl	ax, 1
  4311                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  4312 000015AF 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4313 000015B2 01C1                    	add	cx, ax
  4314                                  	
  4315                                  	; 15/07/2024 (bugfix)
  4316 000015B4 894E42                  	mov	[bp+42h], cx	; bsRootDirStart
  4317 000015B7 8B1E[6E6A]              	mov	bx, [root_dir_secs]
  4318 000015BB 895E44                  	mov	[bp+44h], bx	; bsRootDirSects
  4319                                  	;mov	word [bp+46h], 16 ; bsDirEntsPerSec
  4320                                  
  4321                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4322                                  	;add	cx, [root_dir_secs] ; + RootDirsectors
  4323                                  	; 15/07/2024
  4324 000015BE 01D9                    	add	cx, bx
  4325 000015C0 29DB                    	sub	bx, bx ; BX = 0
  4326                                  	; BX_CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4327                                  	;	  + RootDirSectors
  4328 000015C2 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  4329                                  	;sub	dx, dx 
  4330                                  	; DX = 0
  4331 000015C5 21C0                    	and	ax, ax
  4332 000015C7 7506                    	jnz	short FAT16_f_11
  4333 000015C9 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  4334 000015CC 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  4335                                  FAT16_f_11:
  4336 000015CF 29C8                    	sub	ax, cx
  4337 000015D1 19DA                    	sbb	dx, bx
  4338 000015D3 890E[626A]              	mov	[data_start], cx
  4339 000015D7 891E[646A]              	mov	[data_start+2], bx
  4340                                  
  4341                                  	; 15/07/2024 (bugfix)
  4342 000015DB 894E40                  	mov	 [bp+40h], cx	; bsDataStart
  4343                                  
  4344                                  	; DX_AX = Data sectors
  4345 000015DE A3[666A]                	mov	[data_sectors], ax
  4346 000015E1 8916[686A]              	mov	[data_sectors+2], dx
  4347 000015E5 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4348 000015E8 30ED                    	xor	ch, ch
  4349 000015EA E890F6                  	call	div32 ; DX_AX/CX
  4350                                  	; AX = Count of clusters (rounded down)
  4351                                  	; DX = 0
  4352 000015ED A3[6A6A]                	mov	[cluster_count], ax
  4353 000015F0 8916[6C6A]              	mov	[cluster_count+2], dx
  4354                                  
  4355 000015F4 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  4356 000015F7 E870FD                  	call	write_volume_name
  4357 000015FA 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  4358 000015FD E8C9FD                  	call	write_volume_serial
  4359 00001600 E8DAFE                  	call	write_cluster_count	
  4360                                  
  4361 00001603 E84AFE                  	call	write_formatting_msg
  4362 00001606 B000                    	mov	al, 0
  4363 00001608 E8A6FE                  	call	write_format_percent_x
  4364                                  
  4365 0000160B 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4366 0000160E 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4367                                  
  4368 00001611 0106[626A]              	add	[data_start], ax
  4369 00001615 1116[646A]              	adc	[data_start+2], dx
  4370                                  
  4371                                  	; DX_AX = FAT16 Boot Sector address
  4372 00001619 BB[6B37]                	mov	bx, TRDOS_FAT16_hd_bs
  4373                                  	; ES:BX = Boot Sector Buffer
  4374 0000161C E8D805                  	call	write_hd_sector
  4375 0000161F 0F82A2FE                	jc	formatting_error
  4376 00001623 E84EFE                  	call	write_format_percent
  4377 00001626 83C001                  	add	ax, 1
  4378 00001629 83D200                  	adc	dx, 0
  4379                                  	; write remain part of reserved sectors
  4380 0000162C 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  4381                                  	;sub	cx, 1
  4382                                  	;jna	short FAT16_f_13
  4383                                  	; 11/02/2019
  4384 0000162F 49                      	dec	cx
  4385 00001630 7418                    	jz	short FAT16_f_13
  4386                                  FAT16_f_12:
  4387 00001632 51                      	push	cx
  4388 00001633 BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4389 00001636 E8BE05                  	call	write_hd_sector
  4390 00001639 0F8288FE                	jc	formatting_error
  4391 0000163D E834FE                  	call	write_format_percent
  4392 00001640 83C001                  	add	ax, 1
  4393 00001643 83D200                  	adc	dx, 0
  4394 00001646 59                      	pop	cx
  4395 00001647 49                      	dec	cx ; dec cl
  4396 00001648 75E8                    	jnz	short FAT16_f_12
  4397                                  FAT16_f_13:
  4398                                  	; write FAT sectors
  4399 0000164A 8B0E[626A]              	mov	cx, [data_start] ; lba/abs addr
  4400 0000164E 8B1E[646A]              	mov	bx, [data_start+2] ; lba/abs addr
  4401                                  
  4402                                  	; 11/02/2019
  4403 00001652 2B0E[6E6A]              	sub	cx, [root_dir_secs]
  4404 00001656 83DB00                  	sbb	bx, 0
  4405                                  
  4406 00001659 53                      	push	bx
  4407 0000165A 51                      	push	cx
  4408 0000165B BB[6268]                	mov	bx, HDFORMAT_FATBUFFER
  4409                                  	; ES:BX = FAT Sector Buffer
  4410 0000165E 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4411 00001661 B5FF                    	mov	ch, 0FFh
  4412 00001663 890F                    	mov	[bx], cx ; 0FFF8h
  4413 00001665 88E9                    	mov	cl, ch ; cx = 0FFFFh
  4414 00001667 894F02                  	mov	[bx+2], cx
  4415                                  	;inc	cx
  4416 0000166A E88A05                  	call	write_hd_sector
  4417 0000166D 0F8254FE                	jc	formatting_error
  4418 00001671 E800FE                  	call	write_format_percent
  4419                                  	;mov	bx, HDFORMAT_FATBUFFER
  4420 00001674 B90000                  	mov	cx, 0
  4421 00001677 890F                    	mov	[bx], cx
  4422 00001679 894F02                  	mov	[bx+2], cx
  4423 0000167C EB0F                    	jmp	short FAT16_f_15
  4424                                  FAT16_f_14:	
  4425 0000167E 53                      	push	bx
  4426 0000167F 51                      	push	cx	
  4427 00001680 BB[6268]                	mov	bx, HDFORMAT_FATBUFFER
  4428 00001683 E87105                  	call	write_hd_sector
  4429 00001686 0F823BFE                	jc	formatting_error
  4430 0000168A E8E7FD                  	call	write_format_percent
  4431                                  FAT16_f_15:	
  4432 0000168D 59                      	pop	cx
  4433 0000168E 5B                      	pop	bx
  4434 0000168F 83C001                  	add	ax, 1
  4435 00001692 83D200                  	adc	dx, 0
  4436 00001695 39DA                    	cmp	dx, bx
  4437 00001697 72E5                    	jb	short FAT16_f_14
  4438 00001699 39C8                    	cmp	ax, cx
  4439 0000169B 72E1                    	jb	short FAT16_f_14
  4440                                  
  4441                                  	; write	root directory sectors
  4442                                  	; as empty sectors
  4443 0000169D 8B0E[6E6A]              	mov	cx, [root_dir_secs]
  4444                                  FAT16_f_16:
  4445 000016A1 51                      	push	cx
  4446 000016A2 BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4447 000016A5 E84F05                  	call	write_hd_sector
  4448 000016A8 0F8219FE                	jc	formatting_error
  4449 000016AC E8C5FD                  	call	write_format_percent
  4450 000016AF 83C001                  	add	ax, 1
  4451 000016B2 83D200                  	adc	dx, 0
  4452 000016B5 59                      	pop	cx
  4453 000016B6 49                      	dec	cx
  4454 000016B7 75E8                    	jnz	short FAT16_f_16
  4455                                  
  4456                                  	; write DATA sectors 
  4457                                  	; (after root directory sectors)
  4458 000016B9 8B0E[666A]              	mov	cx, [data_sectors]
  4459 000016BD 8B1E[686A]              	mov	bx, [data_sectors+2]
  4460                                  	; 11/02/2019
  4461 000016C1 43                      	inc	bx ; 0 -> 1, 1-> 2
  4462                                  FAT16_f_17:	
  4463 000016C2 53                      	push	bx
  4464 000016C3 51                      	push	cx	
  4465 000016C4 BB[4E64]                	mov	bx, HDFORMAT_SECBUFFER
  4466 000016C7 E82D05                  	call	write_hd_sector
  4467 000016CA 0F82F7FD                	jc	formatting_error
  4468 000016CE E8A3FD                  	call	write_format_percent
  4469 000016D1 59                      	pop	cx
  4470 000016D2 5B                      	pop	bx
  4471 000016D3 83C001                  	add	ax, 1
  4472 000016D6 83D200                  	adc	dx, 0
  4473 000016D9 49                      	dec	cx
  4474 000016DA 75E6                    	jnz	short FAT16_f_17
  4475 000016DC 4B                      	dec	bx
  4476 000016DD 75E3                    	jnz	short FAT16_f_17
  4477                                  
  4478                                  	; If there are, format remain sectors which are
  4479                                  	; at beyond of data clusters, with zero bytes.
  4480                                  	
  4481 000016DF 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4482 000016E2 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4483                                  
  4484 000016E5 837E1300                	cmp	word [bp+13h], 0 ; [BPB_TotSec16]
  4485 000016E9 0F8443FC                	jz	FAT16_f_18
  4486 000016ED 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  4487 000016F0 83D300                  	adc	bx, 0
  4488 000016F3 E940FC                  	jmp	FAT16_f_19
  4489                                  
  4490                                  FAT12_hd_format:
  4491 000016F6 BD[6B39]                	mov	bp, TRDOS_FAT12_hd_bs
  4492 000016F9 8D7E03                  	lea	di, [bp+3]
  4493 000016FC BE[3864]                	mov	si, bs_oem_name
  4494 000016FF B90400                  	mov	cx, 4
  4495 00001702 F3A5                    	rep	movsw 
  4496 00001704 A1[7E3F]                	mov	ax, [sectors]
  4497 00001707 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4498 0000170A A1[803F]                	mov	ax, [heads]
  4499 0000170D 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4500 00001710 A1[E86C]                	mov	ax, [pp_StartSector]
  4501 00001713 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4502 00001716 A1[EA6C]                	mov	ax, [pp_StartSector+2]
  4503 00001719 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4504                                  	;mov	ax, [pp_Sectors]
  4505 0000171C A1[1A6D]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  4506 0000171F 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  4507                                  
  4508                                  	; 11/02/2019
  4509 00001722 31F6                    	xor	si, si ; reset (FAT size fix) flag
  4510 00001724 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4511 00001727 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  4512 0000172A 83C20F                  	add	dx, 15	; (16-1) (512-1)
  4513 0000172D C1EA04                  	shr	dx, 4	; /16  (*32/512)
  4514                                  	; AX = Root dir sectors
  4515                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4516 00001730 01D1                    	add	cx, dx ; + RootDirsectors ; + 32
  4517 00001732 890E[6E6A]              	mov	[root_dir_secs], cx ; = 33
  4518                                  
  4519                                  	; 11/02/2019
  4520                                  	;sub	ax, 33  ; 1 reserved sector, 32 root dir sectors
  4521                                  			; .. now AX has number of data sectors
  4522                                  			;	 		+ 2* (FAT sectors)
  4523 00001736 29C8                    	sub	ax, cx	
  4524                                  FAT12_f_10:	; 11/02/2019
  4525                                  	; Sectors per cluster calculation
  4526                                  	; (According to MS FAT32 FS specification.)
  4527                                  	;mov	cx, 1  ; 1 sector per cluster
  4528 00001738 B101                    	mov	cl, 1  ; CH = 0
  4529                                  FAT12_f_0:
  4530 0000173A 3DF50F                  	cmp	ax, 4085 ; Max. cluster count for FAT12
  4531 0000173D 7206                    	jb	short FAT12_f_1
  4532 0000173F D0E1                    	shl	cl, 1 ; *2
  4533 00001741 D1E8                    	shr	ax, 1 ; /2
  4534 00001743 EBF5                    	jmp	short FAT12_f_0
  4535                                  FAT12_f_1:
  4536 00001745 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4537                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4538                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  4539                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  4540                                  	
  4541                                  	; Calculating FAT size in sectors
  4542                                  	; AX = partition (volume) size in sectors
  4543                                  	; CX = sectors per clusters
  4544 00001748 31D2                    	xor	dx, dx
  4545 0000174A F7F1                    	div	cx
  4546                                  	; AX = cluster count (only for FAT size calc)
  4547                                  	; DX = 0
  4548 0000174C 83C002                  	add	ax, 2  ; cluster 2 to ...
  4549 0000174F 89C2                    	mov	dx, ax
  4550 00001751 D1E2                    	shl	dx, 1
  4551 00001753 01D0                    	add	ax, dx ; *3
  4552 00001755 D1E8                    	shr	ax, 1  ; /2
  4553 00001757 83D000                  	adc	ax, 0  ; +0.5 -> +1
  4554                                  
  4555                                  	; AX = FAT bytes for 12 bit cluster numbers
  4556                                  	
  4557 0000175A B90002                  	mov	cx, 512		; [BPB_BytesPerSec]
  4558 0000175D 01C8                    	add	ax, cx
  4559 0000175F 48                      	dec	ax		; [BPB_BytesPerSec] - 1
  4560 00001760 29D2                    	sub	dx, dx
  4561 00001762 F7F1                    	div	cx
  4562 00001764 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  4563                                  	; * 2
  4564 00001767 D1E0                    	shl	ax, 1
  4565                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  4566                                  
  4567                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4568                                  	;add	cx, ax
  4569                                  	;mov	ax, [bp+11h]	; [BPB_RootEntCnt] = 512
  4570                                  	;add	ax, 15	; (16-1) (512-1)
  4571                                  	;shr	ax, 4	; /16  (*32/512)
  4572                                  	;; AX = Root dir sectors
  4573                                  	;; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4574                                  	;add	cx, ax ; + RootDirsectors
  4575                                  	;mov	[root_dir_secs], ax
  4576                                  
  4577                                  	; 11/02/2019
  4578                                  	;mov	cx, 33
  4579 00001769 8B0E[6E6A]              	mov	cx, [root_dir_secs]
  4580                                  
  4581                                  	; 15/07/2024 (bugfix)
  4582                                  	; ax = 2 * FAT size (in sectors)
  4583 0000176D 03460E                  	add	ax, [bp+0Eh] ; total FAT sectors + reserved sectors
  4584 00001770 894642                  	mov	[bp+42h], ax	; bsRootDirStart
  4585 00001773 894E44                  	mov	[bp+44h], cx	; bsRootDirSects
  4586                                  	;mov	word [bp+46h], 16 ; bsDirEntsPerSec
  4587                                  
  4588                                  	; 15/07/2024
  4589                                  	;add	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  4590                                  		; cx = root directory sectors + reserved sectors
  4591 00001776 01C1                    	add	cx, ax
  4592                                  		; cx = root dir sects + rsvd sects + total FAT sects
  4593                                  
  4594                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  4595                                  	;	  + RootDirSectors
  4596 00001778 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  4597 0000177B 29C8                    	sub	ax, cx
  4598                                  		 ; AX = data sectors
  4599                                  		 ; cH = 0
  4600                                  
  4601                                  	; 11/02/2019 - fix FAT size (better method)
  4602 0000177D 09F6                    	or	si, si
  4603 0000177F 7504                    	jnz	short FAT12_f_9
  4604                                  
  4605 00001781 89C6                    	mov	si, ax  ; ax = data sectors
  4606 00001783 EBB3                    	jmp	short FAT12_f_10
  4607                                  
  4608                                  FAT12_f_9:
  4609 00001785 31D2                    	xor	dx, dx
  4610 00001787 890E[626A]              	mov	[data_start], cx
  4611 0000178B 8916[646A]              	mov	[data_start+2], dx ; 0
  4612                                  	
  4613                                  	; 15/07/2024 (bugfix)
  4614 0000178F 894E40                  	mov	 [bp+40h], cx	; bsDataStart
  4615                                  
  4616                                  	; DX_AX = Data sectors
  4617 00001792 A3[666A]                	mov	[data_sectors], ax
  4618 00001795 8916[686A]              	mov	[data_sectors+2], dx ; 0
  4619 00001799 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4620 0000179C 28ED                    	sub	ch, ch
  4621 0000179E F7F1                    	div	cx
  4622                                  	; AX = Count of clusters (rounded down)
  4623 000017A0 29D2                    	sub	dx, dx ; 0
  4624 000017A2 A3[6A6A]                	mov	[cluster_count], ax
  4625 000017A5 8916[6C6A]              	mov	[cluster_count+2], dx ; 0
  4626                                  
  4627 000017A9 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  4628 000017AC E8BBFB                  	call	write_volume_name
  4629 000017AF 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  4630 000017B2 E814FC                  	call	write_volume_serial
  4631 000017B5 E825FD                  	call	write_cluster_count
  4632                                  
  4633 000017B8 E895FC                  	call	write_formatting_msg
  4634 000017BB B000                    	mov	al, 0
  4635 000017BD E8F1FC                  	call	write_format_percent_x
  4636                                  
  4637 000017C0 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4638 000017C3 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4639                                  
  4640 000017C6 0106[626A]              	add	[data_start], ax
  4641 000017CA 1116[646A]              	adc	[data_start+2], dx
  4642                                  
  4643                                  	; DX_AX = FAT12 Boot Sector address
  4644 000017CE BB[6B39]                	mov	bx, TRDOS_FAT12_hd_bs
  4645                                  	; ES:BX = Boot Sector Buffer
  4646 000017D1 E82304                  	call	write_hd_sector
  4647 000017D4 0F82EDFC                	jc	formatting_error
  4648 000017D8 E899FC                  	call	write_format_percent
  4649 000017DB 83C001                  	add	ax, 1
  4650 000017DE 83D200                  	adc	dx, 0
  4651                                  	; write remain part of reserved sectors
  4652 000017E1 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  4653                                  	;sub	cx, 1
  4654                                  	;jna	short FAT12_f_3
  4655                                  	; 11/02/2019
  4656 000017E4 49                      	dec	cx
  4657 000017E5 7418                    	jz	short FAT12_f_3
  4658                                  FAT12_f_2:
  4659 000017E7 51                      	push	cx
  4660 000017E8 BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4661 000017EB E80904                  	call	write_hd_sector
  4662 000017EE 0F82D3FC                	jc	formatting_error
  4663 000017F2 E87FFC                  	call	write_format_percent
  4664 000017F5 83C001                  	add	ax, 1
  4665 000017F8 83D200                  	adc	dx, 0
  4666 000017FB 59                      	pop	cx
  4667 000017FC 49                      	dec	cx ; dec cl
  4668 000017FD 75E8                    	jnz	short FAT12_f_2
  4669                                  FAT12_f_3:
  4670                                  	; write FAT sectors
  4671 000017FF 8B0E[626A]              	mov	cx, [data_start] ; lba/abs addr
  4672 00001803 8B1E[646A]              	mov	bx, [data_start+2] ; lba/abs addr
  4673                                  
  4674                                  	; 11/02/2019
  4675 00001807 2B0E[6E6A]              	sub	cx, [root_dir_secs]
  4676 0000180B 83DB00                  	sbb	bx, 0
  4677                                  
  4678 0000180E 53                      	push	bx
  4679 0000180F 51                      	push	cx
  4680 00001810 BB[6268]                	mov	bx, HDFORMAT_FATBUFFER
  4681                                  	; ES:BX = FAT Sector Buffer
  4682 00001813 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4683 00001816 B5FF                    	mov	ch, 0FFh
  4684 00001818 890F                    	mov	[bx], cx ; 0FFF8h
  4685 0000181A 886F02                  	mov	[bx+2], ch ; 0FFFFF8h
  4686                                  	;xor	cx, cx
  4687 0000181D E8D703                  	call	write_hd_sector
  4688 00001820 0F82A1FC                	jc	formatting_error
  4689 00001824 E84DFC                  	call	write_format_percent
  4690                                  	;mov	bx, HDFORMAT_FATBUFFER
  4691 00001827 B90000                  	mov	cx, 0
  4692 0000182A 890F                    	mov	[bx], cx
  4693 0000182C 884F02                  	mov	[bx+2], cl
  4694 0000182F EB0F                    	jmp	short FAT12_f_5
  4695                                  FAT12_f_4:	
  4696 00001831 53                      	push	bx
  4697 00001832 51                      	push	cx	
  4698 00001833 BB[6268]                	mov	bx, HDFORMAT_FATBUFFER
  4699 00001836 E8BE03                  	call	write_hd_sector
  4700 00001839 0F8288FC                	jc	formatting_error
  4701 0000183D E834FC                  	call	write_format_percent
  4702                                  FAT12_f_5:	
  4703 00001840 59                      	pop	cx
  4704 00001841 5B                      	pop	bx
  4705 00001842 83C001                  	add	ax, 1
  4706 00001845 83D200                  	adc	dx, 0
  4707 00001848 39DA                    	cmp	dx, bx
  4708 0000184A 72E5                    	jb	short FAT12_f_4
  4709 0000184C 39C8                    	cmp	ax, cx
  4710 0000184E 72E1                    	jb	short FAT12_f_4
  4711                                  
  4712                                  	; write	root directory sectors
  4713                                  	; as empty sectors
  4714 00001850 8B0E[6E6A]              	mov	cx, [root_dir_secs]
  4715                                  FAT12_f_6:
  4716 00001854 51                      	push	cx
  4717 00001855 BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4718 00001858 E89C03                  	call	write_hd_sector
  4719 0000185B 0F8266FC                	jc	formatting_error
  4720 0000185F E812FC                  	call	write_format_percent
  4721 00001862 83C001                  	add	ax, 1
  4722 00001865 83D200                  	adc	dx, 0
  4723 00001868 59                      	pop	cx
  4724 00001869 49                      	dec	cx ; dec cl
  4725 0000186A 75E8                    	jnz	short FAT12_f_6
  4726                                  
  4727                                  	; write DATA sectors 
  4728                                  	; (after root directory sectors)
  4729 0000186C 8B0E[666A]              	mov	cx, [data_sectors]
  4730                                  	;mov	bx, [data_sectors+2]
  4731                                  	;inc	bx ; 11/02/2019
  4732                                  FAT12_f_7:	
  4733                                  	;push	bx
  4734 00001870 51                      	push	cx
  4735 00001871 BB[4E64]                	mov	bx, HDFORMAT_SECBUFFER
  4736 00001874 E88003                  	call	write_hd_sector
  4737 00001877 0F824AFC                	jc	formatting_error
  4738 0000187B E8F6FB                  	call	write_format_percent
  4739 0000187E 59                      	pop	cx
  4740                                  	;pop	bx
  4741 0000187F 83C001                  	add	ax, 1
  4742 00001882 83D200                  	adc	dx, 0
  4743 00001885 49                      	dec	cx
  4744 00001886 75E8                    	jnz	short FAT12_f_7
  4745                                  	;dec	bx
  4746                                  	;jnz	short FAT12_f_7
  4747                                  
  4748                                  	; If there are, format remain sectors which are
  4749                                  	; at beyond of data clusters, with zero bytes.
  4750                                  	
  4751 00001888 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4752 0000188B 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4753                                  
  4754 0000188E 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  4755 00001891 83D300                  	adc	bx, 0
  4756 00001894 E99FFA                  	jmp	FAT12_f_8
  4757                                  
  4758                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4759                                  ; SINGLIX FS FORMATTING
  4760                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4761                                  
  4762                                  	; 20/03/2021
  4763                                  	; 19/03/2021
  4764                                  SINGLIX_hd_format:
  4765                                  	; 06/01/2018
  4766                                  	; 05/01/2018
  4767                                  	; If Sectors/Track = 17, use CHS+LBA type boot sector
  4768 00001897 8B1E[7E3F]              	mov	bx, [sectors]
  4769 0000189B 83FB11                  	cmp	bx, 17
  4770 0000189E 7711                    	ja	short SINGLIX_fs1_f_1
  4771                                  SINGLIX_fs1_f_0:
  4772 000018A0 BD[6B3B]                	mov	bp, TRDOS_TRFS1_chs_bs
  4773 000018A3 887E2D                  	mov	[bp+45], bh ; 0 ; [bs_LBA_Ready] = 0
  4774 000018A6 885E2E                  	mov	[bp+46], bl	; [bs_Disk_SecPerTrack]
  4775 000018A9 A0[803F]                	mov	al, [heads]
  4776 000018AC 88462F                  	mov	[bp+47], al	; [bs_Disk_Heads]
  4777 000018AF EB15                    	jmp	short SINGLIX_fs1_f_3
  4778                                  SINGLIX_fs1_f_1:
  4779                                  	; Sectors per Track = 63
  4780                                  	; If disk capacity >= 63*16*1024 use LBA type boot sector
  4781 000018B1 8B0E[803F]              	mov	cx, [heads]
  4782 000018B5 A1[823F]                	mov	ax, [cylinders]
  4783 000018B8 F7E1                    	mul	cx
  4784 000018BA 21D2                    	and	dx, dx
  4785 000018BC 7505                    	jnz	short SINGLIX_fs1_f_2
  4786 000018BE 3D0040                  	cmp	ax, 16384
  4787 000018C1 72DD                    	jb	short SINGLIX_fs1_f_0
  4788                                  SINGLIX_fs1_f_2:	
  4789 000018C3 BD[6B3D]                	mov	bp, TRDOS_TRFS1_lba_bs
  4790                                  	;mov	byte [bp+45], 1 ; [bs_LBA_Ready] = 1
  4791                                  SINGLIX_fs1_f_3:	
  4792                                  	;mov	ax, [pp_Sectors]
  4793                                  	;mov	dx, [pp_Sectors+2]
  4794                                  	; 16/02/2019
  4795 000018C6 A1[1A6D]                	mov	ax, [ppn_Sectors]
  4796 000018C9 8B16[1C6D]              	mov	dx, [ppn_Sectors+2]
  4797 000018CD 894610                  	mov	[bp+16], ax	; [bsVolumeSize]
  4798 000018D0 895612                  	mov	[bp+18], dx	; [bsVolumeSize+2]
  4799 000018D3 8B0E[E86C]              	mov	cx, [pp_StartSector]
  4800 000018D7 8B1E[EA6C]              	mov	bx, [pp_StartSector+2]
  4801 000018DB 894E0C                  	mov	[bp+12], cx	; [bsBeginSector]
  4802 000018DE 895E0E                  	mov	[bp+14], bx	; [bsBeginSector+2]
  4803 000018E1 C6462C80                	mov	byte [bp+44], 80h ; [bsDriveNumber]  ; hd0
  4804                                  
  4805                                  	; Prepare MAT
  4806 000018E5 A3[C86A]                	mov	[MAT_VolumeSize], ax ; Total Sectors of the FS
  4807 000018E8 8916[CA6A]              	mov	[MAT_VolumeSize+2], dx
  4808 000018EC 890E[CC6A]              	mov	[MAT_BeginSector], cx ; Beginning Sector of the FS
  4809 000018F0 891E[CE6A]              	mov	[MAT_BeginSector+2], bx
  4810                                  	;mov	cx, [bp+24]	; [bsMATLocation]
  4811                                  	;mov	bx, [bp+26]	; [bsMATLocation+2]
  4812                                  	;add	cx, 1
  4813                                  	;adc	bx, 0
  4814                                  	; Note: (as Default) MAT Address = 1, DAT Address = 2
  4815 000018F4 B90200                  	mov	cx, 2
  4816                                  	;xor	bx, bx ; 0
  4817                                  	;mov	[bp+24], cx	; [bsMATLocation]
  4818                                  	;mov	[bp+26], bx	; [bsMATLocation+2]
  4819 000018F7 890E[D06A]              	mov	[DAT_Address], cx
  4820                                  	;mov	[DAT_Address+2], bx
  4821                                  	; DX_AX = FS1 Volume Size
  4822 000018FB 83C007                  	add	ax, 7 ; 7 bits more (for round up)
  4823 000018FE 83D200                  	adc	dx, 0
  4824 00001901 B90800                  	mov	cx, 8 ;  1 DAT byte == 8 sectors 
  4825 00001904 E876F3                  	call	div32
  4826                                  	; DX_AX = DAT bytes
  4827 00001907 B9FF01                  	mov	cx, 511
  4828 0000190A 01C8                    	add	ax, cx
  4829 0000190C 83D200                  	adc	dx, 0
  4830 0000190F 41                      	inc	cx ; 512
  4831 00001910 E86AF3                  	call	div32
  4832                                  	; DX_AX = DAT sectors (DX must be 0 for volume sizes < 128GB)
  4833 00001913 A3[D46A]                	mov	[DAT_SectorCount], ax
  4834                                  	; 19/03/2021
  4835 00001916 8916[D66A]              	mov	[DAT_SectorCount+2], dx
  4836                                  
  4837 0000191A 83C002                  	add	ax, 2  ; BS + MAT
  4838 0000191D 83D200                  	adc	dx, 0  ; 19/03/2021
  4839 00001920 89461C                  	mov	[bp+28], ax  ; [bsRootDirDT] ; RDT address (offset)
  4840 00001923 89561E                  	mov	[bp+30], dx ; 19/03/2021
  4841                                  
  4842                                  	; Free Sectors = Total Sectors - (BS+MAT+DATsects+RDT+4)
  4843 00001926 83C005                  	add	ax, 5 ; DATsects + (BS+MAT+RDT+4)
  4844                                  	; 19/03/2021
  4845 00001929 83D200                  	adc	dx, 0
  4846                                  	;mov	dx, ax ; ? ; 19/03/2021
  4847 0000192C 8B0E[C86A]              	mov	cx, [MAT_VolumeSize]
  4848 00001930 8B1E[CA6A]              	mov	bx, [MAT_VolumeSize+2]
  4849 00001934 29C1                    	sub	cx, ax
  4850                                  	; 19/03/2021
  4851                                  	;sbb	bx, 0
  4852 00001936 19D3                    	sbb	bx, dx	
  4853                                  
  4854 00001938 890E[D86A]              	mov	[MAT_FreeSectors], cx
  4855 0000193C 891E[DA6A]              	mov	[MAT_FreeSectors+2], bx
  4856 00001940 A3[DC6A]                	mov	[MAT_FirstFreeSector], ax
  4857                                  	;mov	word [MAT_FirstFreeSector+2], 0
  4858                                  	; 19/03/2021
  4859 00001943 8916[DE6A]              	mov	[MAT_FirstFreeSector+2], dx
  4860                                  	
  4861 00001947 BF[746A]                	mov	di, fs_volume_name
  4862 0000194A E816FA                  	call	write_fs_volume_name
  4863 0000194D BE[B46A]                	mov	si, fs_volume_serial
  4864 00001950 E876FA                  	call	write_volume_serial
  4865                                  
  4866                                  	; Modify FS volume name
  4867                                  	; (Convert 20h tail bytes to 0)
  4868 00001953 B94000                  	mov	cx, 64 
  4869 00001956 BE[746A]                	mov	si, fs_volume_name
  4870 00001959 31DB                    	xor	bx, bx
  4871 0000195B B0FF                    	mov	al, 0FFh
  4872                                  modify_fs_vname_1:	
  4873 0000195D 88C4                    	mov	ah, al
  4874 0000195F AC                      	lodsb
  4875 00001960 3C20                    	cmp	al, 20h
  4876 00001962 7708                    	ja	short modify_fs_vname_2
  4877 00001964 80FC20                  	cmp	ah, 20h
  4878 00001967 7603                    	jna	short modify_fs_vname_2
  4879 00001969 89F3                    	mov	bx, si
  4880 0000196B 4B                      	dec	bx
  4881                                  modify_fs_vname_2:
  4882 0000196C E2EF                    	loop	modify_fs_vname_1
  4883 0000196E 09DB                    	or	bx, bx
  4884 00001970 740B                    	jz	short modify_fs_vname_3
  4885 00001972 89DF                    	mov	di, bx
  4886 00001974 B9[B46A]                	mov	cx, fs_volume_name+64
  4887 00001977 29D9                    	sub	cx, bx
  4888 00001979 30C0                    	xor	al, al
  4889 0000197B F3AA                    	rep	stosb 
  4890                                  
  4891                                  modify_fs_vname_3:
  4892 0000197D E8D0FA                  	call	write_formatting_msg
  4893 00001980 B000                    	mov	al, 0
  4894 00001982 E82CFB                  	call	write_format_percent_x
  4895                                  
  4896 00001985 8B460C                  	mov	ax, [bp+12]	; [bsBeginSector]
  4897 00001988 8B560E                  	mov	dx, [bp+14]	; [bsBeginSector+2]
  4898                                  
  4899                                  	; DX_AX = TRFS1 Boot Sector address
  4900 0000198B 89EB                    	mov	bx, bp
  4901                                  	; ES:BX = Boot Sector Buffer
  4902 0000198D E86702                  	call	write_hd_sector
  4903 00001990 0F8231FB                	jc	formatting_error
  4904                                  	
  4905 00001994 83C001                  	add	ax, 1
  4906 00001997 83D200                  	adc	dx, 0
  4907                                  
  4908                                  	; DX_AX = MAT (DAT header) sector address
  4909 0000199A BB[C46A]                	mov	bx, FS_MAT_Buffer
  4910                                  	; 16/02/2019
  4911 0000199D C7074D41                	mov	word [bx],'MA'
  4912 000019A1 C6470254                	mov	byte [bx+2],'T'
  4913 000019A5 E84F02                  	call	write_hd_sector
  4914 000019A8 0F8219FB                	jc	formatting_error
  4915 000019AC E809FB                  	call	write_fs_format_percent
  4916                                  
  4917                                  	; Calculate DAT bits 
  4918                                  	; NOTE: 4096 bits per DAT sector
  4919 000019AF A1[DC6A]                	mov	ax, [MAT_FirstFreeSector]
  4920                                  	; 19/03/2021
  4921                                  	;xor	dx, dx
  4922 000019B2 8B16[DE6A]              	mov	dx, [MAT_FirstFreeSector+2]
  4923 000019B6 52                      	push	dx
  4924 000019B7 50                      	push	ax
  4925 000019B8 B90010                  	mov	cx, 4096
  4926 000019BB E8BFF2                  	call	div32
  4927 000019BE 891E[B86A]              	mov	[DAT_FFBit], bx
  4928 000019C2 A3[BA6A]                	mov	[DAT_FFSector], ax
  4929                                  	; 19/03/2021
  4930 000019C5 8916[BC6A]              	mov	[DAT_FFSector+2], dx
  4931 000019C9 58                      	pop	ax
  4932 000019CA 5A                      	pop	dx
  4933 000019CB 83E801                  	sub	ax, 1
  4934 000019CE 83DA00                  	sbb	dx, 0
  4935 000019D1 0306[D86A]              	add	ax, [MAT_FreeSectors]
  4936 000019D5 1316[DA6A]              	adc	dx, [MAT_FreeSectors+2]
  4937 000019D9 E8A1F2                  	call	div32
  4938 000019DC 891E[BE6A]              	mov	[DAT_LFBit], bx
  4939 000019E0 A3[C06A]                	mov	[DAT_LFSector], ax
  4940                                  	; 19/03/2021
  4941 000019E3 8916[C26A]              	mov	[DAT_LFSector+2], dx
  4942                                  	;
  4943 000019E7 31F6                    	xor	si, si ; 0
  4944                                  	; 19/03/2021
  4945 000019E9 8936[C270]              	mov	[tempword], si ; 0
  4946                                  SINGLIX_fs1_f_4:
  4947                                  	; calculate free bits for current DAT sector
  4948                                  	;			(to be written)
  4949 000019ED BF[E06A]                	mov	di, FS_DAT_Buffer
  4950                                  
  4951                                  	; 19/03/2021
  4952 000019F0 A1[C270]                	mov	ax, [tempword]
  4953 000019F3 3B06[BC6A]              	cmp	ax, [DAT_FFSector+2]
  4954 000019F7 7260                    	jb	short SINGLIX_fs1_f_9
  4955 000019F9 7708                    	ja	short SINGLIX_fs1_f_13
  4956                                  
  4957 000019FB 3B36[BA6A]              	cmp	si, [DAT_FFSector]
  4958 000019FF 743A                    	je	short SINGLIX_fs1_f_7
  4959 00001A01 7256                    	jb	short SINGLIX_fs1_f_9
  4960                                  SINGLIX_fs1_f_13:
  4961                                  	; 19/03/2021
  4962 00001A03 3B06[C26A]              	cmp	ax, [DAT_LFSector+2]
  4963 00001A07 722D                    	jb	short SINGLIX_fs1_f_6
  4964 00001A09 774E                    	ja	short SINGLIX_fs1_f_9
  4965                                  
  4966 00001A0B 3B36[C06A]              	cmp	si, [DAT_LFSector]
  4967 00001A0F 7225                    	jb	short SINGLIX_fs1_f_6
  4968 00001A11 7746                    	ja	short SINGLIX_fs1_f_9
  4969                                  
  4970                                  	;mov	bx, [DAT_LFBit]
  4971                                  	;;mov	al, 0FFh
  4972                                  	;mov	ah, bl
  4973                                  	;shr	bx, 3 ; bit count to byte count
  4974                                  	;jz	short SINGLIX_fs1_f_5
  4975                                  	; 20/03/2021
  4976 00001A13 8B0E[BE6A]              	mov	cx, [DAT_LFBit]
  4977 00001A17 88CC                    	mov	ah, cl
  4978 00001A19 C1E903                   	shr	cx, 3 ; bit count to byte count
  4979 00001A1C 7404                    	jz	short SINGLIX_fs1_f_5
  4980                                  	;Example:
  4981                                  	;last free sector = 47 -> byte 5, bit 7
  4982                                  	;last free sector = 48 -> byte 6, bit 0
  4983                                  	; (also previous sectors are free sectors)
  4984 00001A1E B0FF                    	mov	al, 0FFh ; 20/03/2021
  4985                                  	;mov	cx, bx
  4986 00001A20 F3AA                    	rep	stosb
  4987                                  	; 20/03/2021
  4988                                  	;mov	di, FS_DAT_Buffer
  4989                                  	;add	di, bx
  4990                                  SINGLIX_fs1_f_5:
  4991 00001A22 80E407                  	and	ah, 7
  4992                                  	;mov	cl, ah
  4993                                  	;shl	al, cl
  4994                                  	;not	al
  4995                                  	; 20/03/2021
  4996 00001A25 30C0                    	xor	al, al
  4997                                  SINGLIX_fs1_f_15:
  4998                                  	; 20/03/2021 
  4999                                  	; 0 -> 00000001b (last free bit is bit 0)
  5000                                  	; 1 -> 00000011b (last free bit is bit 1)
  5001                                  	; 7 -> 11111111b (last free bit is bit 7)
  5002 00001A27 0C01                    	or	al, 1
  5003 00001A29 08E4                    	or	ah, ah
  5004 00001A2B 7406                    	jz	short SINGLIX_fs1_f_16
  5005 00001A2D D0E0                    	shl	al, 1
  5006 00001A2F FECC                    	dec	ah
  5007 00001A31 EBF4                    	jmp	short SINGLIX_fs1_f_15
  5008                                  SINGLIX_fs1_f_16:
  5009 00001A33 AA                      	stosb
  5010                                  	;mov	cx, 511
  5011                                  	;sub	cx, bx
  5012                                  	;jna	short SINGLIX_fs1_f_9
  5013                                  	;mov	al, 0 ; out of volume bits (=0)
  5014                                  	;rep	stosb
  5015 00001A34 EB23                    	jmp	short SINGLIX_fs1_f_9
  5016                                  SINGLIX_fs1_f_6:
  5017 00001A36 B90002                  	mov	cx, 512
  5018 00001A39 EB1A                    	jmp	short SINGLIX_fs1_f_8
  5019                                  SINGLIX_fs1_f_7:
  5020                                  	; 20/03/2021
  5021                                  	;Example:
  5022                                  	;first free sector = 23 -> byte 2, bit 7
  5023                                  	;first free sector = 24 -> byte 3, bit 0
  5024                                  	; (previous sectors are allocated sectors)
  5025 00001A3B 8B1E[B86A]              	mov	bx, [DAT_FFBit]
  5026 00001A3F 88D9                    	mov	cl, bl
  5027 00001A41 80E107                  	and	cl, 7
  5028 00001A44 C1EB03                  	shr	bx, 3 ; from bits to bytes
  5029 00001A47 01DF                    	add	di, bx
  5030 00001A49 B0FF                    	mov	al, 0FFh
  5031 00001A4B D2E0                    	shl	al, cl
  5032 00001A4D AA                      	stosb
  5033 00001A4E B9FF01                  	mov	cx, 511
  5034 00001A51 29D9                    	sub	cx, bx
  5035 00001A53 7604                    	jna	short SINGLIX_fs1_f_9
  5036                                  SINGLIX_fs1_f_8:
  5037 00001A55 B0FF                    	mov	al, 0FFh ; Free sector bits (=1)
  5038 00001A57 F3AA                    	rep	stosb
  5039                                  SINGLIX_fs1_f_9:
  5040 00001A59 A1[CC6A]                	mov	ax, [MAT_BeginSector]
  5041 00001A5C 8B16[CE6A]              	mov	dx, [MAT_BeginSector+2]
  5042                                  	;add	ax, [DAT_Address] ; = 2
  5043                                  	;adc	dx, [DAT_Address+2]
  5044 00001A60 83C002                  	add	ax, 2
  5045 00001A63 83D200                  	adc	dx, 0
  5046 00001A66 01F0                    	add	ax, si
  5047 00001A68 83D200                  	adc	dx, 0
  5048                                  	; Write DAT sector(s)
  5049                                  	; DX_AX = Disk Allocation Table sector address
  5050 00001A6B BB[E06A]                	mov	bx, FS_DAT_Buffer
  5051 00001A6E E88601                  	call	write_hd_sector
  5052 00001A71 0F8250FA                	jc	formatting_error
  5053 00001A75 E840FA                  	call	write_fs_format_percent
  5054                                  	; Clear DAT buffer again (for next stage)
  5055 00001A78 B90001                  	mov	cx, 256
  5056 00001A7B BF[E06A]                	mov	di, FS_DAT_Buffer
  5057 00001A7E 29C0                    	sub	ax, ax
  5058 00001A80 F3AB                    	rep	stosw
  5059                                  
  5060 00001A82 46                      	inc	si
  5061                                  	; 19/03/2021
  5062 00001A83 7504                    	jnz	short SINGLIX_fs1_f_14
  5063                                  
  5064                                  	; 19/03/2021
  5065 00001A85 FF06[C270]              	inc	word [tempword]
  5066                                  SINGLIX_fs1_f_14:
  5067 00001A89 A1[C270]                	mov	ax, [tempword]
  5068 00001A8C 3B06[D66A]              	cmp	ax, [DAT_SectorCount+2]
  5069 00001A90 0F8259FF                	jb	SINGLIX_fs1_f_4
  5070                                  
  5071 00001A94 3B36[D46A]              	cmp	si, [DAT_SectorCount]
  5072                                  	;jna	SINGLIX_fs1_f_4
  5073                                  	; 19/03/2021 (bugfix)
  5074 00001A98 0F8251FF                	jb	SINGLIX_fs1_f_4
  5075                                  
  5076                                  	; ;;;
  5077                                  	
  5078                                  	; DAT sectors has been written..
  5079                                  	; Now, Root Directory Description Table is in order
  5080                                  
  5081 00001A9C BF[E06A]                	mov	di, FS_RDT_Buffer
  5082 00001A9F B84444                  	mov	ax, 'DD' 
  5083 00001AA2 AB                      	stosw
  5084 00001AA3 30E4                    	xor	ah, ah
  5085 00001AA5 B054                    	mov	al, 'T'
  5086 00001AA7 AB                      	stosw
  5087 00001AA8 B80002                  	mov	ax, 512 ; Sector size (Bytes per sector)
  5088 00001AAB AB                      	stosw
  5089 00001AAC 31C0                    	xor	ax, ax ; RDT sequence number (= 0, section 1)
  5090 00001AAE AB                      	stosw	
  5091                                  	; RDT address
  5092 00001AAF A1[D46A]                	mov	ax, [DAT_SectorCount]
  5093 00001AB2 8B16[D66A]              	mov	dx, [DAT_SectorCount+2]
  5094 00001AB6 83C002                  	add	ax, 2 ; BS + MAT
  5095 00001AB9 83D200                  	adc	dx, 0
  5096 00001ABC AB                      	stosw
  5097 00001ABD 89D0                    	mov	ax, dx
  5098 00001ABF AB                      	stosw
  5099 00001AC0 29C0                    	sub	ax, ax ; Next RDT number
  5100 00001AC2 AB                      	stosw
  5101 00001AC3 AB                      	stosw
  5102                                  	;mov	ax, 4 ; Sector count of this section	
  5103                                  	;	      ; (4*512)/4 = 512 root dir entries
  5104                                  	; 20/03/2021
  5105 00001AC4 B004                    	mov	al, 4
  5106 00001AC6 AB                      	stosw
  5107 00001AC7 30C0                    	xor	al, al
  5108 00001AC9 AB                      	stosw
  5109                                  	; Volume beginning sector
  5110 00001ACA 8B460C                  	mov	ax, [bp+12]	; [bsBeginSector]
  5111 00001ACD 8B560E                  	mov	dx, [bp+14]	; [bsBeginSector+2]
  5112 00001AD0 AB                      	stosw
  5113 00001AD1 89D0                    	mov	ax, dx
  5114 00001AD3 AB                      	stosw
  5115 00001AD4 31C0                    	xor	ax, ax
  5116 00001AD6 48                      	dec	ax ; 0FFFFh
  5117                                  	; Parent Dir Serial (= FFFFFFFFh for root dir)
  5118 00001AD7 AB                      	stosw
  5119 00001AD8 AB                      	stosw
  5120                                  
  5121                                  set_fs_volume_serial_number:
  5122 00001AD9 BE[B46A]                	mov	si, fs_volume_serial
  5123 00001ADC A5                      	movsw
  5124 00001ADD A5                      	movsw
  5125                                  
  5126 00001ADE 29C0                    	sub	ax, ax
  5127                                  	;stosb	; sub directory level = 0
  5128                                  	;stosb	; 0, reserved
  5129 00001AE0 AB                      	stosw
  5130 00001AE1 B004                    	mov	al, 00000100b ;  (DOS) System attribute
  5131 00001AE3 AA                      	stosb	; (DOS) Basic attributes
  5132 00001AE4 28C0                    	sub	al, al ; Extended attributes (0 for TRDOS 386)
  5133 00001AE6 AA                      	stosb
  5134                                  	; 20/03/2021
  5135                                  	;sub	ax, ax ; reserved (8) bytes for TR-MULTIX
  5136 00001AE7 AB                      	stosw
  5137 00001AE8 AB                      	stosw
  5138 00001AE9 AB                      	stosw
  5139 00001AEA AB                      	stosw
  5140 00001AEB B85254                  	mov	ax, 'RT' ; TRFS Root directory signature
  5141 00001AEE AB                      	stosw
  5142 00001AEF 31C0                    	xor	ax, ax ; Country (language, date, text format)
  5143                                  		       ; (0 = Default, 1 = USA, 90 = Turkiye)
  5144                                  	;stosb
  5145                                  	;stosb	; Time Zone (0 = GMT = default ; -11 to +12)
  5146 00001AF1 AB                      	stosw
  5147                                  
  5148 00001AF2 89FE                    	mov	si, di
  5149                                  	; get the date (from RTC)
  5150 00001AF4 B404                    	mov	ah, 4
  5151 00001AF6 CD1A                    	int	1Ah
  5152                                  	; Creating Date (of root directory)
  5153 00001AF8 86E9                    	xchg	ch, cl ; 07/01/2018
  5154 00001AFA 89C8                    	mov	ax, cx ; cl = century (BCD), ch = year (BCD)
  5155 00001AFC AB                      	stosw
  5156 00001AFD 88F0                    	mov	al, dh  ; month (BCD)
  5157 00001AFF AA                      	stosb
  5158 00001B00 88D0                    	mov	al, dl  ; day (BCD)
  5159 00001B02 AA                      	stosb
  5160                                  	; get the time (from RTC)
  5161 00001B03 B402                    	mov	ah, 2
  5162 00001B05 CD1A                    	int	1Ah
  5163                                  	; Creating Time (of root directory)
  5164 00001B07 86CD                    	xchg	cl, ch ; ch = hour (BCD), cl = minute (BSD)
  5165 00001B09 89C8                    	mov	ax, cx ; al = hour, ah = minute
  5166 00001B0B AB                      	stosw
  5167 00001B0C 88F0                    	mov	al, dh ; seconds (BCD)
  5168 00001B0E AA                      	stosb
  5169 00001B0F 88D0                    	mov	al, dl ; daylight savings time option 
  5170 00001B11 AA                      	stosb
  5171                                  	; Set Last Modification Date&Time
  5172 00001B12 B90400                  	mov	cx, 4
  5173 00001B15 F3A5                    	rep	movsw ; copy creating date&time values to
  5174                                  		; last modification date time values
  5175                                  		; (last modif date&time = creating date&time)
  5176                                  
  5177                                  set_fs_volume_name:
  5178 00001B17 BE[746A]                	mov	si, fs_volume_name
  5179 00001B1A B120                    	mov	cl, 32 
  5180 00001B1C F3A5                    	rep	movsw
  5181                                  
  5182                                  	; Fill remain bytes (of this RDT) with zero
  5183 00001B1E B9C000                  	mov	cx, (128+256)/2
  5184 00001B21 31C0                    	xor	ax, ax
  5185 00001B23 F3AB                    	rep	stosw
  5186                                  
  5187                                  	; RDT is ready here...
  5188                                  
  5189 00001B25 8B461C                  	mov	ax, [bp+28]	; [bsRootDirDT]
  5190 00001B28 8B561E                  	mov	dx, [bp+30]	; [bsRootDirDT+2]
  5191                                  	; 20/03/2021
  5192                                  	;xor	dx, dx
  5193 00001B2B 03460C                  	add	ax, [bp+12]	; [bsBeginSector]
  5194 00001B2E 13560E                  	adc	dx, [bp+14]	; [bsBeginSector+2]
  5195                                  
  5196                                  	; Write RDT sector
  5197                                  	; DX_AX = Root Directory Description Table address
  5198 00001B31 BB[E06A]                	mov	bx, FS_RDT_Buffer
  5199 00001B34 E8C000                  	call	write_hd_sector
  5200 00001B37 0F828AF9                	jc	formatting_error
  5201 00001B3B E87AF9                  	call	write_fs_format_percent
  5202                                  
  5203 00001B3E 83C001                  	add	ax, 1
  5204 00001B41 83D200                  	adc	dx, 0
  5205                                  
  5206                                  	; write root directory data sectors
  5207 00001B44 B90400                  	mov	cx, 4
  5208                                  
  5209                                  SINGLIX_fs1_f_10:
  5210 00001B47 51                      	push	cx
  5211                                  	; Write root directory sector(s)
  5212                                  	; DX_AX = Root Directory Sector address
  5213 00001B48 BB[6268]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5214 00001B4B E8A900                  	call	write_hd_sector
  5215 00001B4E 0F8273F9                	jc	formatting_error
  5216 00001B52 E863F9                  	call	write_fs_format_percent
  5217 00001B55 83C001                  	add	ax, 1
  5218 00001B58 83D200                  	adc	dx, 0
  5219 00001B5B 59                      	pop	cx
  5220 00001B5C FEC9                    	dec	cl
  5221 00001B5E 75E7                    	jnz	short SINGLIX_fs1_f_10
  5222                                  
  5223                                  	; Fill remain sectors with 'F6h' bytes
  5224 00001B60 8B4E10                  	mov	cx, [bp+16]	; [bsVolumeSize]
  5225 00001B63 8B5E12                  	mov	bx, [bp+18]	; [bsVolumeSize+2]
  5226 00001B66 034E0C                  	add	cx, [bp+12]	; [bsBeginSector]
  5227 00001B69 135E0E                  	adc	bx, [bp+14]	; [bsBeginSector+2]
  5228                                  
  5229                                  	; write DATA sectors 
  5230                                  	; (after root directory sectors)
  5231                                  SINGLIX_fs1_f_11:
  5232 00001B6C 53                      	push	bx
  5233 00001B6D 51                      	push	cx
  5234 00001B6E BB[4E64]                	mov	bx, HDFORMAT_SECBUFFER
  5235 00001B71 E88300                  	call	write_hd_sector
  5236 00001B74 0F824DF9                	jc	formatting_error
  5237 00001B78 E8F9F8                  	call	write_format_percent
  5238 00001B7B 59                      	pop	cx
  5239 00001B7C 5B                      	pop	bx
  5240 00001B7D 83C001                  	add	ax, 1
  5241 00001B80 83D200                  	adc	dx, 0
  5242 00001B83 39DA                    	cmp	dx, bx
  5243 00001B85 72E5                    	jb	short SINGLIX_fs1_f_11
  5244 00001B87 0F87CDF7                	ja	SINGLIX_fs1_f_12
  5245 00001B8B 39C8                    	cmp	ax, cx
  5246 00001B8D 72DD                    	jb	short SINGLIX_fs1_f_11
  5247 00001B8F E9C6F7                  	jmp	SINGLIX_fs1_f_12	
  5248                                  
  5249                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5250                                  ; print messages
  5251                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5252                                  
  5253                                  print_msg:
  5254                                  
  5255                                  print_msg_LOOP:
  5256 00001B92 AC                      	lodsb                           ; Load byte at DS:SI to AL
  5257 00001B93 20C0                    	and     al, al
  5258 00001B95 7409                    	jz      short print_msg_OK
  5259 00001B97 B40E                    	mov	ah, 0Eh
  5260 00001B99 BB0700                  	mov     bx, 07h
  5261 00001B9C CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  5262                                  					; Write char as TTY
  5263                                  					; AL-char BH-page BL-color
  5264 00001B9E EBF2                    	jmp     short print_msg_LOOP
  5265                                  
  5266                                  print_msg_OK:
  5267 00001BA0 C3                      	retn
  5268                                  
  5269                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5270                                  ; reading a block (sector) on hard disk
  5271                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5272                                  ; 17/10/2020
  5273                                  
  5274                                  read_hd_sector:
  5275                                  
  5276                                  	; INPUT -> DX_AX = Logical Block Address
  5277                                  	; 	   ES:BX = Sector Buffer
  5278                                  	; OUTPUT ->
  5279                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  5280                                  	;	     ES:BX = Sector Buffer
  5281                                  	;  cf = 1 -> AH = Error Number
  5282                                  
  5283 00001BA1 3B16[5C68]              	cmp	dx, [chs_limit+2]
  5284 00001BA5 770F                    	ja	short read_lba_sector
  5285 00001BA7 7206                    	jb	short read_chs_sector
  5286 00001BA9 3B06[5A68]              	cmp	ax, [chs_limit]
  5287 00001BAD 7707                    	ja	short read_lba_sector
  5288                                  	;jmp	short read_chs_sector
  5289                                  
  5290                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5291                                  ; reading a block (sector) by using CHS read (ROMBIOS) function
  5292                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5293                                  ; 17/10/2020
  5294                                  
  5295                                  read_chs_sector:
  5296                                  	; hdformat.s (25/09/2020)
  5297 00001BAF C606[5468]02            	mov	byte [rw], 2 ; read
  5298 00001BB4 EB54                    	jmp	short chs_rw
  5299                                  
  5300                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5301                                  ; reading a block (sector) by using LBA read (ROMBIOS) function
  5302                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5303                                  ; 17/10/2020
  5304                                  
  5305                                  read_lba_sector:
  5306                                  	; hdformat.s (25/09/2020)
  5307 00001BB6 C606[5468]42            	mov	byte [rw], 42h
  5308 00001BBB EB05                    	jmp	short lba_rw
  5309                                  
  5310                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5311                                  ; writing a block (sector) by using LBA write (ROMBIOS) function
  5312                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5313                                  ; 17/10/2020
  5314                                  
  5315                                  	; 18/10/2020 
  5316                                  write_lba_sector:
  5317                                  	; hdformat.s (25/09/2020)
  5318 00001BBD C606[5468]43            	mov	byte [rw], 43h
  5319                                  	;jmp	short lba_rw
  5320                                  lba_rw:
  5321                                  	;mov	di, 5
  5322                                  	; 18/10/2020
  5323 00001BC2 C606[5568]05            	mov	byte [rcnt], 5  ; Retry count
  5324                                  lba_rw_1:
  5325                                  	;pusha			; db 60h
  5326 00001BC7 60                      	db	60h
  5327                                  	;push 	0		; db 6Ah, 00h
  5328 00001BC8 6A00                    	db	6Ah, 0
  5329                                  	;push	0		; db 6Ah, 00h
  5330 00001BCA 6A00                    	db	6Ah, 0
  5331 00001BCC 52                      	push    dx
  5332 00001BCD 50                      	push    ax
  5333 00001BCE 06                      	push    es
  5334 00001BCF 53                      	push    bx
  5335                                  	;push	1		; db 6Ah, 01h
  5336 00001BD0 6A01                    	db	6Ah, 01h                     
  5337                                  	;push	10h		; db 6Ah, 10h
  5338 00001BD2 6A10                    	db	6Ah, 10h
  5339                                  
  5340 00001BD4 89E6                    	mov     si, sp
  5341 00001BD6 8A16[5268]              	mov     dl, [DrvNum]
  5342 00001BDA 30C0                    	xor	al, al	; verify off 
  5343                                  lba_rw_2:
  5344 00001BDC 8A26[5468]              	mov     ah, [rw] ; 42h = LBA read, 43h = LBA write
  5345                                  	;xor	al, al	; verify off 
  5346 00001BE0 CD13                    	int     13h
  5347                                  
  5348                                  	;mov	[error], ah
  5349 00001BE2 7310                    	jnc     short lba_rw_3
  5350                                  
  5351                                  	;dec	di 
  5352                                  	; 18/10/2020
  5353 00001BE4 FE0E[5568]              	dec	byte [rcnt]
  5354 00001BE8 740A                    	jz	short lba_rw_3 
  5355                                          
  5356 00001BEA 30E4                    	xor	ah, ah
  5357                                  	;mov	dl, [DrvNum]
  5358 00001BEC CD13                    	int	13h	; BIOS Service func (ah) = 0
  5359                                  			; Reset disk system
  5360                                  
  5361                                  	;mov	word [si+2], 1 ; set r/w count to 1 again
  5362 00001BEE C6440201                	mov	byte [si+2], 1
  5363                                  
  5364 00001BF2 EBE8                    	jmp	short lba_rw_2
  5365                                  
  5366                                  lba_rw_3:
  5367                                  	;popa
  5368 00001BF4 61                      	db	61h
  5369                                  	;popa
  5370 00001BF5 61                      	db	61h
  5371 00001BF6 C3                      	retn
  5372                                  
  5373                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5374                                  ; writing a block (sector) on hard disk
  5375                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5376                                  ; 17/10/2020
  5377                                  
  5378                                  write_hd_sector:
  5379                                  
  5380                                  	; INPUT -> DX_AX = Logical Block Address
  5381                                  	; 	   ES:BX = Sector Buffer
  5382                                  	; OUTPUT ->
  5383                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  5384                                  	;	     ES:BX = Sector Buffer
  5385                                  	;  cf = 1 -> AH = Error Number
  5386                                  
  5387 00001BF7 3B16[5C68]              	cmp	dx, [chs_limit+2]
  5388 00001BFB 77C0                    	ja	short write_lba_sector
  5389 00001BFD 7206                    	jb	short write_chs_sector
  5390 00001BFF 3B06[5A68]              	cmp	ax, [chs_limit]
  5391 00001C03 77B8                    	ja	short write_lba_sector
  5392                                  	;jmp	short write_chs_sector
  5393                                  
  5394                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5395                                  ; writing a block (sector) by using CHS write (ROMBIOS) function
  5396                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5397                                  ; 17/10/2020
  5398                                  
  5399                                  	; 18/10/2020
  5400                                  write_chs_sector:
  5401                                  	; hdformat.s (25/09/2020)
  5402 00001C05 C606[5468]03            	mov	byte [rw], 3 ; write
  5403                                  	;jmp	short chs_rw
  5404                                  chs_rw:
  5405 00001C0A 56                      	push	si
  5406 00001C0B 51                              push	cx        
  5407                                  chs_rw_0:
  5408                                  	;mov	di, 5
  5409                                  	; 18/10/2020
  5410 00001C0C C606[5568]05            	mov	byte [rcnt], 5  ; Retry count
  5411                                  chs_rw_1:               
  5412 00001C11 52                      	push	dx	; Linear sector #
  5413 00001C12 50                      	push	ax	; DX_AX = Linear address (sectors)
  5414 00001C13 8B0E[7E3F]              	mov	cx, [sectors]
  5415 00001C17 53                      	push	bx
  5416                                  
  5417 00001C18 E862F0                  	call    div32	; 32 bit divide
  5418                                  
  5419 00001C1B 89D9                    	mov	cx, bx	; Sector (zero based)
  5420 00001C1D 41                      	inc	cx	; To make it 1 based
  5421 00001C1E 51                      	push	cx
  5422 00001C1F 8B0E[803F]              	mov     cx, [heads]
  5423 00001C23 E857F0                  	call	div32	; Convert track to head & cyl
  5424 00001C26 88DE                    	mov	dh, bl	; BX = Head (max. FFh)
  5425 00001C28 59                      	pop	cx	; AX=Cyl, DH=Head, CX=Sector
  5426 00001C29 5B                      	pop     bx	; ES:BX = Buffer
  5427                                  
  5428 00001C2A 8A16[5268]              	mov	dl, [DrvNum]
  5429 00001C2E 88C5                    	mov	ch, al
  5430 00001C30 D0CC                    	ror	ah, 1	; Rotate right
  5431 00001C32 D0CC                    	ror	ah, 1
  5432 00001C34 08E1                    	or	cl, ah
  5433                                  chs_rw_2:
  5434 00001C36 8A26[5468]              	mov	ah, [rw] ; 02h = read, 03h = write
  5435 00001C3A B001                    	mov	al, 01h
  5436 00001C3C CD13                    	int	13h	; BIOS Service func (ah) = 2/3
  5437                                  			; Read/Write disk sectors
  5438                                  			; AL-sec num CH-track CL-sec
  5439                                  			; DH-head DL-drive ES:BX-buffer
  5440                                  			; CF-flag AH-status AL-sectors written/read
  5441                                  			; If CF = 1 then AH = Error code (>0) 
  5442                                          
  5443 00001C3E 730C                    	jnc     short chs_rw_3
  5444                                  	;dec	di                 
  5445 00001C40 FE0E[5568]              	dec	byte [rcnt] ; 18/10/2020
  5446 00001C44 7406                    	jz	short chs_rw_3 
  5447                                          
  5448 00001C46 30E4                    	xor	ah, ah
  5449                                  	;mov	dl, [DrvNum]
  5450 00001C48 CD13                    	int	13h	; BIOS Service func (ah) = 0
  5451                                  			; Reset disk system
  5452 00001C4A EBEA                    	jmp	short chs_rw_2
  5453                                  
  5454                                  chs_rw_3:
  5455 00001C4C 58                      	pop	ax
  5456 00001C4D 5A                      	pop	dx
  5457 00001C4E 59                      	pop	cx
  5458 00001C4F 5E                      	pop	si	
  5459 00001C50 C3                      	retn
  5460                                  	
  5461                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5462                                  ; convert byte to decimal number
  5463                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5464                                  
  5465                                  bin_to_decimal:
  5466                                  	; INPUT: DS:SI = Target location
  5467                                  	;        DX_AX = Binary Number (Integer)
  5468                                  	; OUTPUT: Decimal char at DS:SI
  5469                                  	; 	 SI decremented after every division
  5470                                  	; 	 till AX<10.
  5471                                  	; CX, DX, BX will be changed.
  5472                                  	;
  5473 00001C51 B90A00                  	mov	cx, 10
  5474                                  btd_0:
  5475                                  	; DX_AX = Dividend
  5476                                  	; CX = Divisor
  5477 00001C54 E826F0                  	call	div32
  5478                                  	; DX_AX = Quotient
  5479                                  	; BX = remainder
  5480 00001C57 80C330                  	add	bl, '0'
  5481 00001C5A 881C                    	mov	[si], bl
  5482 00001C5C 21D2                    	and	dx, dx
  5483 00001C5E 7403                    	jz	short btd_2
  5484                                  btd_1:
  5485 00001C60 4E                      	dec	si
  5486 00001C61 EBF1                    	jmp	short btd_0
  5487                                  btd_2:
  5488 00001C63 09C0                    	or	ax, ax
  5489 00001C65 75F9                    	jnz	short btd_1
  5490                                  
  5491 00001C67 C3                      	retn
  5492                                  
  5493                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5494                                  ; convert byte to hexadecimal number
  5495                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5496                                  
  5497                                  byte_to_hex: ; 04/02/2019
  5498                                  bin_to_hex:
  5499                                  	; INPUT ->
  5500                                  	; 	AL = byte (binary number)
  5501                                  	; OUTPUT ->
  5502                                  	;	AX = hexadecimal string
  5503                                  	;
  5504 00001C68 53                      	push	bx
  5505 00001C69 31DB                    	xor	bx, bx
  5506 00001C6B 88C3                    	mov	bl, al
  5507 00001C6D C0EB04                  	shr	bl, 4
  5508 00001C70 8A9F[6C3F]              	mov	bl, [bx+hexchrs]
  5509 00001C74 86D8                    	xchg	bl, al
  5510 00001C76 80E30F                  	and	bl, 0Fh
  5511 00001C79 8AA7[6C3F]              	mov	ah, [bx+hexchrs]
  5512 00001C7D 5B                      	pop	bx	
  5513 00001C7E C3                      	retn
  5514                                  
  5515                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5516                                  ; read & write characters
  5517                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5518                                  
  5519                                  rw_char:
  5520                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  5521 00001C7F BE[DC54]                	mov     si, StrVolumeName
  5522 00001C82 BB0700                  	mov     bx, 7
  5523 00001C85 B403                    	mov     ah, 3
  5524 00001C87 CD10                    	int     10h
  5525 00001C89 8916[C354]              	mov     [Cursor_Pos], dx
  5526                                  read_next_char:
  5527 00001C8D 30E4                    	xor     ah, ah
  5528 00001C8F CD16                    	int     16h
  5529 00001C91 20C0                    	and     al, al
  5530 00001C93 7439                    	jz      short loc_arrow
  5531 00001C95 3CE0                    	cmp     al, 0E0h
  5532 00001C97 7435                    	je      short loc_arrow
  5533 00001C99 3C08                    	cmp     al, 8
  5534 00001C9B 753D                    	jne     short char_return
  5535                                  loc_back:
  5536 00001C9D B403                    	mov     ah, 3
  5537 00001C9F CD10                    	int     10h
  5538 00001CA1 3A16[C354]              	cmp     dl, byte [Cursor_Pos]
  5539 00001CA5 761F                    	jna     short loc_beep
  5540                                  prev_column:
  5541 00001CA7 FECA                    	dec     dl
  5542                                  set_cursor_pos:
  5543 00001CA9 B402                    	mov     ah, 2
  5544 00001CAB CD10                    	int     10h
  5545 00001CAD 88D3                    	mov     bl, dl
  5546 00001CAF 2A1E[C354]              	sub     bl, byte [Cursor_Pos]
  5547 00001CB3 B90100                  	mov     cx, 1
  5548 00001CB6 B409                    	mov     ah, 9
  5549 00001CB8 B020                    	mov     al, 20h
  5550 00001CBA 8800                    	mov     [si+bx], al
  5551                                  loc_write_it:
  5552 00001CBC B307                    	mov     bl, 7
  5553 00001CBE CD10                    	int     10h
  5554 00001CC0 8B16[C354]              	mov     dx, [Cursor_Pos]
  5555 00001CC4 EBC7                    	jmp     short read_next_char
  5556                                  loc_beep:
  5557 00001CC6 B40E                    	mov     ah, 0Eh
  5558 00001CC8 B007                    	mov     al, 7
  5559 00001CCA CD10                    	int     10h
  5560 00001CCC EBBF                    	jmp     short read_next_char
  5561                                  loc_arrow:    
  5562 00001CCE 80FC4B                  	cmp     ah, 4Bh
  5563 00001CD1 74CA                    	je      short loc_back
  5564 00001CD3 80FC53                  	cmp     ah, 53h
  5565 00001CD6 74C5                    	je      short loc_back
  5566 00001CD8 EBB3                    	jmp     short read_next_char
  5567                                  char_return:
  5568 00001CDA B403                    	mov     ah, 3
  5569 00001CDC CD10                    	int     10h
  5570                                  check_char_type:
  5571 00001CDE 3C20                    	cmp     al, 20h
  5572 00001CE0 7229                    	jb      short loc_escape
  5573 00001CE2 88D4                    	mov     ah, dl
  5574 00001CE4 2A26[C354]              	sub     ah, byte [Cursor_Pos]
  5575                                  	;cmp	ah, 10 
  5576                                  	;ja	short loc_beep
  5577 00001CE8 3A26[3764]              	cmp     ah, [vname_length] ; 05/01/2018
  5578 00001CEC 73D8                    	jnb	short loc_beep
  5579 00001CEE 3C7A                    	cmp     al, 'z'
  5580 00001CF0 779B                    	ja      short read_next_char
  5581 00001CF2 3C61                    	cmp     al, 'a'
  5582 00001CF4 7202                    	jb      short pass_capitalize
  5583 00001CF6 24DF                    	and     al, 0DFh
  5584                                  pass_capitalize:
  5585 00001CF8 88E3                    	mov     bl, ah 
  5586 00001CFA 30E4                    	xor     ah, ah
  5587 00001CFC 8900                    	mov     [si+bx], ax
  5588 00001CFE B307                    	mov     bl, 7
  5589 00001D00 B40E                    	mov     ah, 0Eh
  5590 00001D02 CD10                    	int     10h
  5591 00001D04 EB87                    	jmp     short read_next_char
  5592                                  pass_escape:
  5593 00001D06 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  5594 00001D08 7583                    	jne     short read_next_char
  5595                                  	;mov	ah, 0Eh
  5596                                  	;int	10h
  5597                                  	;mov	al, 0Ah
  5598                                  	;int	10h
  5599 00001D0A C3                      	retn
  5600                                  loc_escape:
  5601 00001D0B 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  5602 00001D0D 75F7                    	jne     short pass_escape
  5603 00001D0F F9                      	stc
  5604 00001D10 C3                      	retn
  5605                                  
  5606                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5607                                  ; display CHS takle
  5608                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5609                                  
  5610                                  display_chs_table:
  5611                                  
  5612                                  	; 16/10/2020
  5613                                  	; 12/10/2020 (fdisk3)
  5614                                  	; 11/02/2019 (hdimage)
  5615                                  
  5616 00001D11 06                      	push	es
  5617 00001D12 BF00B8                  	mov	di, 0B800h
  5618 00001D15 8EC7                    	mov	es, di
  5619 00001D17 BFA000                  	mov	di, 160 ; row 1
  5620 00001D1A B407                    	mov	ah, 07h
  5621 00001D1C B044                    	mov	al, 'D'
  5622 00001D1E AB                      	stosw
  5623 00001D1F B069                    	mov	al, 'i'
  5624 00001D21 AB                      	stosw
  5625 00001D22 B073                    	mov	al, 's'
  5626 00001D24 AB                      	stosw
  5627 00001D25 B06B                    	mov	al, 'k'
  5628 00001D27 AB                      	stosw
  5629 00001D28 B03A                    	mov	al, ':'
  5630 00001D2A AB                      	stosw
  5631 00001D2B B020                    	mov	al, ' '
  5632 00001D2D AB                      	stosw
  5633 00001D2E B068                    	mov	al, 'h'
  5634 00001D30 AB                      	stosw
  5635 00001D31 B064                    	mov	al, 'd'
  5636 00001D33 AB                      	stosw
  5637 00001D34 A0[5268]                	mov	al, [DrvNum]
  5638 00001D37 2C50                    	sub	al, 80h-'0'
  5639 00001D39 AB                      	stosw
  5640 00001D3A BF4001                  	mov	di, 320 ; row 2
  5641 00001D3D B95000                  	mov	cx, 80		
  5642 00001D40 B82007                  	mov	ax, 0720h
  5643 00001D43 F3AB                    	rep	stosw
  5644 00001D45 B150                    	mov	cl, 80	; row 3 
  5645 00001D47 B02D                    	mov	al, "-"
  5646 00001D49 F3AB                    	rep	stosw
  5647                                  	;mov	cl, 19
  5648 00001D4B B112                    	mov	cl, 18 ; 16/10/2020 ; row 4
  5649 00001D4D B020                    	mov	al, 20h
  5650 00001D4F F3AB                    	rep	stosw
  5651 00001D51 B043                    	mov	al, 'C'
  5652 00001D53 AB                      	stosw
  5653 00001D54 B079                    	mov	al, 'y'
  5654 00001D56 AB                      	stosw
  5655 00001D57 B06C                    	mov	al, 'l'
  5656 00001D59 AB                      	stosw
  5657 00001D5A B069                    	mov	al, 'i'
  5658 00001D5C AB                       	stosw
  5659 00001D5D B06E                    	mov	al, 'n'
  5660 00001D5F AB                      	stosw	
  5661 00001D60 B064                    	mov	al, 'd'
  5662 00001D62 AB                      	stosw
  5663 00001D63 B065                    	mov	al, 'e'
  5664 00001D65 AB                      	stosw
  5665 00001D66 B072                    	mov	al, 'r'
  5666 00001D68 AB                       	stosw
  5667 00001D69 B073                    	mov	al, 's'
  5668 00001D6B AB                       	stosw
  5669 00001D6C B03A                    	mov	al, ':'
  5670 00001D6E AB                      	stosw
  5671 00001D6F B020                    	mov	al, 20h
  5672 00001D71 AB                      	stosw
  5673                                  	;mov	[cylnumpos], di
  5674 00001D72 A1[823F]                	mov	ax, [cylinders]
  5675 00001D75 8B16[843F]              	mov	dx, [cylinders+2] ; 16/10/2020
  5676                                  	;mov	cl, 4
  5677                                  	;mov	ch, 07h ; color
  5678 00001D79 E86A00                  	call	write_number
  5679                                  	
  5680                                  	;mov	ax, 0720h
  5681 00001D7C B020                    	mov	al, 20h ; 16/10/2020
  5682 00001D7E AB                      	stosw
  5683 00001D7F AB                      	stosw
  5684 00001D80 B048                    	mov	al, 'H'
  5685 00001D82 AB                      	stosw
  5686 00001D83 B065                    	mov	al, 'e'
  5687 00001D85 AB                      	stosw
  5688 00001D86 B061                    	mov	al, 'a'
  5689 00001D88 AB                      	stosw
  5690 00001D89 B064                    	mov	al, 'd'
  5691 00001D8B AB                       	stosw
  5692 00001D8C B073                    	mov	al, 's'
  5693 00001D8E AB                       	stosw
  5694 00001D8F B03A                    	mov	al, ':'
  5695 00001D91 AB                      	stosw
  5696 00001D92 B020                    	mov	al, 20h
  5697 00001D94 AB                      	stosw
  5698                                  	;mov	[hednumpos], di
  5699 00001D95 A1[803F]                	mov	ax, [heads]
  5700 00001D98 31D2                    	xor	dx, dx ; 16/10/2020
  5701                                  	;mov	cl, 2
  5702                                  	;mov	ch, 07h ; color
  5703 00001D9A E84900                  	call	write_number
  5704                                  
  5705                                  	;mov	ax, 0720h
  5706 00001D9D B020                    	mov	al, 20h ; 16/10/2020
  5707 00001D9F AB                      	stosw
  5708 00001DA0 AB                      	stosw
  5709 00001DA1 B053                    	mov	al, 'S'
  5710 00001DA3 AB                      	stosw
  5711 00001DA4 B065                    	mov	al, 'e'
  5712 00001DA6 AB                      	stosw
  5713 00001DA7 B063                    	mov	al, 'c'
  5714 00001DA9 AB                      	stosw
  5715 00001DAA B074                    	mov	al, 't'
  5716 00001DAC AB                       	stosw
  5717 00001DAD B06F                    	mov	al, 'o'
  5718 00001DAF AB                      	stosw
  5719 00001DB0 B072                    	mov	al, 'r'
  5720 00001DB2 AB                       	stosw
  5721 00001DB3 B073                    	mov	al, 's'
  5722 00001DB5 AB                       	stosw
  5723 00001DB6 B03A                    	mov	al, ':'
  5724 00001DB8 AB                      	stosw
  5725 00001DB9 B020                    	mov	al, 20h
  5726 00001DBB AB                      	stosw
  5727                                  	;mov	[secnumpos], di
  5728 00001DBC A1[7E3F]                	mov	ax, [sectors]
  5729 00001DBF 29D2                    	sub	dx, dx ; 16/10/2020
  5730                                  	;mov	cl, 2
  5731                                  	;mov	ch, 07h ; color
  5732 00001DC1 E82200                  	call	write_number
  5733                                  
  5734 00001DC4 B92003                  	mov	cx, 800 ; 16/10/2020 ; row 5
  5735 00001DC7 29F9                    	sub	cx, di
  5736 00001DC9 D0E9                    	shr	cl, 1
  5737                                  	;mov	cl, 22
  5738                                  	;mov	ax, 0720h
  5739 00001DCB B020                    	mov	al, 20h ; 16/10/2020
  5740 00001DCD F3AB                    	rep	stosw
  5741                                  	
  5742 00001DCF B150                    	mov	cl, 80 	; row 6
  5743 00001DD1 B02D                    	mov	al, "-"
  5744 00001DD3 F3AB                    	rep	stosw
  5745                                  
  5746 00001DD5 B150                    	mov	cl, 80	 ; row 7
  5747                                  	;mov	cl, 160	 ; row 7, 8
  5748 00001DD7 B020                    	mov	al, 20h
  5749 00001DD9 F3AB                    	rep	stosw
  5750                                  
  5751 00001DDB BA0006                  	mov	dx, 0600h ; DH = row, DL = 0 column
  5752 00001DDE 31DB                    	xor	bx, bx ; BH = video page (0)
  5753 00001DE0 B402                    	mov	ah, 02h ; set cursor position
  5754 00001DE2 CD10                    	int	10h
  5755                                  
  5756 00001DE4 07                      	pop	es
  5757 00001DE5 C3                      	retn
  5758                                  
  5759                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5760                                  ; write decimal number
  5761                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5762                                  
  5763                                  ;write_number:
  5764                                  ;	; 12/10/2020
  5765                                  ;	mov	bx, 10
  5766                                  ;	mov	si, cx
  5767                                  ;wnum_1:
  5768                                  ;	xor	dx, dx
  5769                                  ;	div	bx
  5770                                  ;	push	dx
  5771                                  ;	dec	cl
  5772                                  ;	jnz	short wnum_1
  5773                                  ;	mov	cx, si
  5774                                  ;	mov	ah, ch	; color (07h or 0Fh)
  5775                                  ;	xor	ch, ch
  5776                                  ;wnum_2:
  5777                                  ;	pop	dx
  5778                                  ;	mov	al, dl
  5779                                  ;	add	al, '0'
  5780                                  ;	stosw
  5781                                  ;	loop	wnum_2
  5782                                  ;	retn
  5783                                  
  5784                                  write_number:
  5785                                  	; 16/10/2020
  5786                                  	; dx:ax = binary number
  5787                                  	; di = decimal number/string location
  5788                                  	; modified registers: ax, bx, cx, dx, bp, di
  5789 00001DE6 B90A00                  	mov	cx, 10
  5790 00001DE9 89E5                    	mov	bp, sp
  5791                                  wnum_1:
  5792 00001DEB E88FEE                  	call	div32
  5793 00001DEE 53                      	push	bx
  5794 00001DEF 21D2                    	and	dx, dx
  5795 00001DF1 75F8                    	jnz	short wnum_1
  5796 00001DF3 09C0                    	or	ax, ax
  5797 00001DF5 75F4                    	jnz	short wnum_1
  5798                                  wnum_2:	
  5799 00001DF7 58                      	pop	ax
  5800 00001DF8 0430                    	add	al, '0'
  5801 00001DFA B407                    	mov	ah, 07h ; color
  5802 00001DFC AB                      	stosw
  5803 00001DFD 39E5                    	cmp	bp, sp
  5804 00001DFF 77F6                    	ja	short wnum_2
  5805 00001E01 C3                      	retn
  5806                                  
  5807                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5808                                  ; partition size input
  5809                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5810                                  
  5811                                  	; 12/03/2021
  5812                                  partition_size_input:
  5813                                  	; 23/10/2020 (fdisk3.s modification on hdimage.s source code)
  5814                                  
  5815 00001E02 C706[FA6C]0000          	mov	word [pSize_multiplier+2], 0
  5816 00001E08 C606[FF6C]42            	mov	byte [msg_psize_unit+1], 'B'
  5817 00001E0D A0[FE6C]                	mov	al, [pSize_unit]
  5818 00001E10 3C25                    	cmp	al, '%'
  5819 00001E12 7529                    	jne	short psu_0
  5820                                  	; 08/02/2019
  5821                                  	; calculate sector count for max. available sectors percentage
  5822 00001E14 8B16[EE6C]              	mov	dx, [pp_Sectors+2] ; max. available sectors
  5823 00001E18 A1[EC6C]                	mov	ax, [pp_Sectors]   ; for a new partition
  5824                                  	;mov	dx, [total_sectors+2]
  5825                                  	;mov	ax, [total_sectors]
  5826                                  	;mov	cx, 100
  5827                                  	; 13/03/2021
  5828 00001E1B B96300                  	mov	cx, 99
  5829 00001E1E 01C8                    	add	ax, cx
  5830 00001E20 83D200                  	adc	dx, 0
  5831 00001E23 41                      	inc	cx ; cx = 100
  5832 00001E24 E856EE                  	call	div32
  5833 00001E27 A3[F86C]                	mov	[pSize_multiplier], ax
  5834                                  	; 29/10/2020
  5835 00001E2A 8916[FA6C]              	mov	[pSize_multiplier+2], dx
  5836 00001E2E B400                    	mov	ah, 0
  5837 00001E30 8826[FF6C]              	mov	[msg_psize_unit+1], ah
  5838                                  	;mov	byte [pSize_maxdigits], 2
  5839 00001E34 C606[FC6C]03            	mov	byte [pSize_maxdigits], 3 ; 29/10/2020
  5840 00001E39 B025                    	mov	al, '%'
  5841 00001E3B EB65                    	jmp	short psu_6
  5842                                  psu_0:
  5843 00001E3D 3C43                    	cmp	al, 'C'
  5844 00001E3F 7517                    	jne	short psu_1
  5845 00001E41 A1[7E3F]                	mov	ax, [sectors]
  5846 00001E44 F726[803F]              	mul	word [heads]
  5847 00001E48 A3[F86C]                	mov	[pSize_multiplier], ax
  5848                                  	;mov	byte [pSize_maxdigits], 4
  5849                                  	; <= 65535 cylinders
  5850 00001E4B C606[FC6C]05            	mov	byte [pSize_maxdigits], 5 ; 23/10/2020
  5851                                  	;sub	dh, dh
  5852 00001E50 8836[FF6C]              	mov	[msg_psize_unit+1], dh
  5853 00001E54 B043                    	mov	al, 'C'
  5854 00001E56 EB4A                    	jmp	short psu_6
  5855                                  psu_1:
  5856 00001E58 3C47                    	cmp	al, 'G'
  5857 00001E5A 7513                    	jne	short psu_2
  5858 00001E5C C706[F86C]0008          	mov	word [pSize_multiplier], 2*1024
  5859 00001E62 C706[FA6C]0004          	mov	word [pSize_multiplier+2], 1024
  5860                                  	;mov	byte [pSize_maxdigits], 1
  5861 00001E68 C606[FC6C]03            	mov	byte [pSize_maxdigits], 3 ; <= 512 GB ; 23/10/2020
  5862 00001E6D EB33                    	jmp	short psu_6
  5863                                  psu_2:
  5864 00001E6F 3C4D                    	cmp	al, 'M'
  5865 00001E71 750D                    	jne	short psu_3
  5866 00001E73 C706[F86C]0008          	mov	word [pSize_multiplier], 2*1024
  5867                                  	;;mov	byte [pSize_maxdigits], 4
  5868                                  	;mov	byte [pSize_maxdigits], 7 ; 23/10/2020
  5869                                  	; 12/03/2021
  5870 00001E79 C606[FC6C]06            	mov	byte [pSize_maxdigits], 6 ; <= 524288
  5871 00001E7E EB22                    	jmp	short psu_6
  5872                                  psu_3:
  5873 00001E80 3C4B                    	cmp	al, 'K'
  5874 00001E82 750D                    	jne	short psu_4
  5875 00001E84 C706[F86C]0200          	mov	word [pSize_multiplier], 2
  5876                                  	;jmp	short psu_5
  5877                                  	; 12/03/2021
  5878 00001E8A C606[FC6C]09            	mov	byte [pSize_maxdigits], 9 ; <= 536870912
  5879 00001E8F EB11                    	jmp	short psu_6 	
  5880                                  psu_4:
  5881                                  	; al = 'S'
  5882 00001E91 30E4                    	xor	ah, ah
  5883 00001E93 8826[FF6C]              	mov	[msg_psize_unit+1], ah
  5884 00001E97 C706[F86C]0100          	mov	word [pSize_multiplier], 1
  5885                                  psu_5:
  5886                                  	;mov	byte [pSize_maxdigits], 7
  5887 00001E9D C606[FC6C]0A            	mov	byte [pSize_maxdigits], 10 ; 23/10/2020
  5888                                  psu_6:
  5889 00001EA2 A2[BB4E]                	mov	[msg_partition_size_x], al
  5890 00001EA5 BE[A74E]                	mov	si, msg_partition_size	
  5891 00001EA8 E8E7FC                  	call	print_msg
  5892                                  
  5893 00001EAB 89E5                    	mov	bp, sp
  5894 00001EAD 31DB                    	xor	bx, bx
  5895 00001EAF 891E[F46C]              	mov	[pSize_temp], bx ; 0
  5896                                  	;mov	[pSize_temp+2], bx ; 0
  5897 00001EB3 881E[FD6C]              	mov	[pSize_digitpos], bl ; 0
  5898                                  	; bh = 0  ; video page
  5899 00001EB7 B403                    	mov     ah, 3	; get cursor pos
  5900 00001EB9 CD10                    	int     10h
  5901 00001EBB 8916[C354]              	mov	[Cursor_Pos], dx
  5902                                  	; 09/02/2019
  5903 00001EBF B307                    	mov     bl, 7   ; page 0, color 7 (light gray)   
  5904                                  psu_7:
  5905 00001EC1 30E4                    	xor	ah, ah
  5906 00001EC3 CD16                    	int	16h
  5907                                  
  5908 00001EC5 3C30                    	cmp	al, '0'
  5909 00001EC7 7225                    	jb	short psu_8
  5910 00001EC9 3C39                    	cmp	al, '9'
  5911 00001ECB 77F4                    	ja	short psu_7
  5912 00001ECD 8A1E[FD6C]              	mov	bl, [pSize_digitpos]
  5913 00001ED1 3A1E[FC6C]              	cmp	bl, [pSize_maxdigits]
  5914 00001ED5 73EA                    	jnb	short psu_7
  5915 00001ED7 FE06[FD6C]              	inc	byte [pSize_digitpos]
  5916 00001EDB 2C30                    	sub	al, '0'
  5917 00001EDD 30E4                    	xor	ah, ah
  5918 00001EDF 50                      	push	ax
  5919 00001EE0 0430                    	add	al, '0'
  5920 00001EE2 B40E                    	mov	ah, 0Eh	; write char as tty
  5921                                  	;mov	bx, 7   ; page 0, color 7 (light gray)
  5922 00001EE4 CD10                    	int	10h
  5923 00001EE6 EBD9                    	jmp	short psu_7
  5924                                  
  5925                                  psu_8esc:
  5926                                  	; 29/10/2020 (ESCape)
  5927 00001EE8 89EC                    	mov	sp, bp ; clean stack
  5928                                  
  5929 00001EEA 08C0                    	or	al, al ; zf = 0
  5930 00001EEC F9                      	stc
  5931 00001EED C3                      	retn	
  5932                                  psu_8:
  5933 00001EEE 20C0                    	and	al, al
  5934 00001EF0 0F849300                	jz	psu_15 ; check for left arrow key
  5935 00001EF4 3C1B                    	cmp	al, 27
  5936 00001EF6 74F0                    	je	short psu_8esc ; ESCAPE key ; 29/10/2020
  5937 00001EF8 0F878500                	ja	psu_14 ; check for left arrow key
  5938 00001EFC 3C0D                    	cmp	al, 13
  5939                                  	;je	short psu_9  ; ENTER key
  5940 00001EFE 7249                    	jb	short psu_11 ; check for backspace key
  5941                                  	;jmp	short psu_7
  5942 00001F00 77BF                    	ja	short psu_7
  5943                                  psu_9:
  5944 00001F02 31C0                    	xor	ax, ax
  5945 00001F04 A3[F66C]                	mov	[pSize_temp+2], ax ; 0 ; 08/02/2019
  5946 00001F07 3806[FD6C]              	cmp	byte [pSize_digitpos], al ; 0
  5947 00001F0B 0F868500                	jna	psu_16		
  5948                                  	;xor	bh, bh
  5949 00001F0F 8A1E[FD6C]              	mov	bl, [pSize_digitpos]
  5950 00001F13 FECB                    	dec	bl
  5951 00001F15 D0E3                    	shl	bl, 1
  5952 00001F17 01E3                    	add	bx, sp
  5953 00001F19 8B07                    	mov	ax, [bx]
  5954 00001F1B A3[F46C]                	mov	[pSize_temp], ax
  5955                                  	;mov	word [pSize_temp+2], 0
  5956 00001F1E B90A00                  	mov	cx, 10
  5957                                  psu_10:
  5958 00001F21 FE0E[FD6C]              	dec	byte [pSize_digitpos]
  5959 00001F25 746D                    	jz	short psu_16
  5960                                  	
  5961 00001F27 A1[F46C]                	mov	ax, [pSize_temp]
  5962 00001F2A 8B16[F66C]              	mov	dx, [pSize_temp+2]
  5963                                  	;mov	cx, 10
  5964 00001F2E E85AED                  	call	mul32
  5965                                  	;mov	[pSize_temp], ax
  5966                                  	;mov	[pSize_temp+2], dx
  5967                                  	;xor	bh, bh
  5968 00001F31 8A1E[FD6C]              	mov	bl, [pSize_digitpos]
  5969 00001F35 FECB                    	dec	bl
  5970 00001F37 D0E3                    	shl	bl, 1
  5971 00001F39 01E3                    	add	bx, sp ; (*)
  5972                                  	;mov	ax, [bx]
  5973                                  	;add	[pSize_temp], ax
  5974                                  	;adc	word [pSize_temp+2], 0
  5975 00001F3B 0307                    	add	ax, [bx]
  5976 00001F3D 83D200                  	adc	dx, 0
  5977 00001F40 A3[F46C]                	mov	[pSize_temp], ax
  5978 00001F43 8916[F66C]              	mov	[pSize_temp+2], dx
  5979 00001F47 EBD8                    	jmp	short psu_10
  5980                                  	
  5981                                  	; Left arrow, backspace, DEL key checking
  5982                                  psu_11:
  5983 00001F49 3C08                    	cmp	al, 8 ; backspace key
  5984 00001F4B 0F8572FF                	jne	psu_7
  5985                                  psu_12:
  5986                                  	;; bh = 0  ; video page
  5987                                  	;mov	ah, 3 ; get cursor pos
  5988                                  	;int	10h
  5989                                  	;cmp	dl, [Cursor_Pos]
  5990                                  	;jna	short psu_13
  5991                                  	;dec	dl
  5992                                  	;dec	byte [pSize_digitpos]
  5993                                  
  5994                                  	; 08/02/2019
  5995 00001F4F 8B16[C354]              	mov	dx, [Cursor_Pos]
  5996 00001F53 8A1E[FD6C]              	mov	bl, [pSize_digitpos]
  5997 00001F57 20DB                    	and	bl, bl
  5998 00001F59 741D                    	jz	short psu_13
  5999                                  
  6000 00001F5B FECB                    	dec	bl 
  6001 00001F5D 881E[FD6C]              	mov	[pSize_digitpos], bl
  6002                                  	
  6003 00001F61 00DA                    	add	dl, bl
  6004                                  
  6005                                  	; bh = 0  ; video page
  6006 00001F63 B402                    	mov	ah, 2 ; set cursor pos
  6007 00001F65 CD10                    	int	10h
  6008                                  	;mov	bl, dl
  6009                                  	;sub	bl, [Cursor_Pos] 
  6010 00001F67 B90100                  	mov	cx, 1
  6011 00001F6A B409                    	mov	ah, 9 ; write char at current curs pos
  6012 00001F6C B020                    	mov	al, 20h ; space (blank)
  6013 00001F6E 8800                    	mov	[si+bx], al
  6014                                  	; bh = 0 ; video page
  6015 00001F70 B307                    	mov	bl, 7 ; attribute/color (light gray)
  6016 00001F72 CD10                    	int	10h
  6017                                  
  6018                                  	; 09/02/2019
  6019 00001F74 58                      	pop	ax ; remove last digit on top of stack 
  6020                                  		   ; set sp to correct position for BX (*)
  6021 00001F75 E949FF                  	jmp	psu_7
  6022                                  psu_13:
  6023 00001F78 B40E                    	mov	ah, 0Eh
  6024 00001F7A B007                    	mov	al, 7
  6025                                  	;mov	bx, 7
  6026 00001F7C CD10                    	int	10h
  6027 00001F7E E940FF                  	jmp	psu_7
  6028                                  psu_14:
  6029 00001F81 3CE0                    	cmp	al, 0E0h
  6030 00001F83 0F853AFF                	jne	psu_7
  6031                                  psu_15:    
  6032 00001F87 80FC4B                  	cmp	ah, 4Bh ; left arrow
  6033 00001F8A 74C3                    	je	short psu_12
  6034 00001F8C 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  6035 00001F8F 74BE                    	je	short psu_12
  6036 00001F91 E92DFF                  	jmp	psu_7
  6037                                  psu_16:
  6038 00001F94 89EC                    	mov	sp, bp
  6039                                  
  6040                                  	; 29/10/2020
  6041 00001F96 803E[FE6C]25            	cmp	byte [pSize_unit], '%'
  6042 00001F9B 751E                    	jne	short psu_23
  6043                                  
  6044 00001F9D B86400                  	mov	ax, 100
  6045 00001FA0 3906[F46C]              	cmp	word [pSize_temp], ax ; 100 ; % limit
  6046 00001FA4 7624                    	jna	short psu_17
  6047 00001FA6 A3[F46C]                	mov	word [pSize_temp], ax
  6048                                  
  6049                                  	; (re)set asciiz number string to '100'
  6050                                  
  6051 00001FA9 28FF                    	sub	bh, bh ; 0 ; video page 0
  6052 00001FAB 8B16[C354]              	mov	dx, [Cursor_Pos]
  6053 00001FAF B402                    	mov	ah, 2 ; set cursor pos
  6054 00001FB1 CD10                    	int	10h
  6055                                  
  6056 00001FB3 BE[4E68]                	mov	si, msg_100
  6057 00001FB6 E8D9FB                  	call	print_msg
  6058                                  
  6059 00001FB9 EB0F                    	jmp	short psu_17
  6060                                  psu_23:
  6061 00001FBB 803E[FE6C]53            	cmp	byte [pSize_unit], 'S'
  6062 00001FC0 7508                    	jne	short psu_17 
  6063                                  
  6064 00001FC2 BE[2C64]                	mov	si, msg_sectors_crlf
  6065 00001FC5 E8CAFB                  	call	print_msg
  6066                                  	;xor	bx, bx
  6067 00001FC8 EB30                    	jmp	short psu_18
  6068                                  psu_17:
  6069 00001FCA BE[FE6C]                	mov	si, msg_psize_unit
  6070 00001FCD E8C2FB                  	call	print_msg
  6071                                  
  6072 00001FD0 BE[7F55]                	mov	si, CRLF
  6073 00001FD3 E8BCFB                  	call	print_msg
  6074                                  
  6075                                  	; 29/10/2020
  6076 00001FD6 803E[FE6C]25            	cmp	byte [pSize_unit], '%'
  6077 00001FDB 751D                    	jne	short psu_18
  6078                                  	
  6079 00001FDD 8B0E[F46C]              	mov	cx, [pSize_temp]
  6080                                  
  6081 00001FE1 21C9                    	and	cx, cx
  6082 00001FE3 7443                    	jz	short psu_21 ; 0%, ZERO !
  6083                                  
  6084 00001FE5 83F964                  	cmp	cx, 100
  6085 00001FE8 7606                    	jna	short psu_24
  6086                                  
  6087                                  	; show 100% for 1 second (for >100%)
  6088 00001FEA E83D00                  	call	wait1second ; 29/10/2020
  6089                                  
  6090 00001FED B96400                  	mov	cx, 100
  6091                                  psu_24:
  6092 00001FF0 A1[F86C]                	mov	ax, [pSize_multiplier]
  6093 00001FF3 8B16[FA6C]              	mov	dx, [pSize_multiplier+2]
  6094                                  
  6095                                  	;mov	cx, [pSize_temp]
  6096                                  	;and	cx, cx
  6097                                  	;jz	short psu_21 ; 0%, ZERO !
  6098                                  
  6099 00001FF7 E991EC                  	jmp	mul32
  6100                                  psu_18:
  6101 00001FFA A1[F46C]                	mov	ax, [pSize_temp]
  6102 00001FFD 8B16[F66C]              	mov	dx, [pSize_temp+2]
  6103 00002001 89C1                    	mov	cx, ax
  6104 00002003 09D1                    	or	cx, dx
  6105                                  	;jz	short psu_20
  6106 00002005 7421                    	jz	short psu_21 ; 08/02/2019
  6107 00002007 8B0E[F86C]              	mov	cx, [pSize_multiplier]
  6108 0000200B 803E[FE6C]43            	cmp	byte [pSize_unit], 'C'
  6109 00002010 7413                    	je	short psu_20 ; 09/02/2019
  6110                                  	;jne	short psu_19
  6111                                  	;call	mul32
  6112                                  	; 08/02/2019
  6113                                  	; dx:ax = requested partition size in sectors
  6114                                  	;retn	
  6115                                  ;psu_19:
  6116                                  	;mov	cx, [pSize_multiplier]
  6117 00002012 83F901                  	cmp	cx, 1
  6118                                  	;jna	short psu_20
  6119 00002015 7703                    	ja	short psu_19
  6120                                  	; 09/02/2019
  6121 00002017 31DB                    	xor	bx, bx
  6122 00002019 C3                      	retn
  6123                                  psu_19:
  6124 0000201A E86EEC                  	call	mul32
  6125                                  	;and	bx, bx
  6126                                  	;jnz	short psu_22 ; 09/02/2019
  6127 0000201D 8B0E[FA6C]              	mov	cx, [pSize_multiplier+2]
  6128 00002021 09C9                    	or	cx, cx
  6129                                  	;jz	short psu_20
  6130 00002023 7404                    	jz	short psu_22 ; 09/02/2019
  6131                                  psu_20:
  6132                                  	;call	mul32
  6133                                  	;retn
  6134 00002025 E963EC                  	jmp	mul32 ; 23/10/2020
  6135                                  psu_21:
  6136                                  	; zf = 1 ; 29/10/2020
  6137 00002028 F9                      	stc
  6138                                  psu_22:
  6139 00002029 C3                      	retn
  6140                                  
  6141                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6142                                  ; wait for 1 second
  6143                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6144                                  
  6145                                  	; 29/10/2020
  6146                                  wait1second:
  6147 0000202A B402                    	mov	ah, 2
  6148 0000202C CD1A                    	int	1Ah ; get time of day
  6149 0000202E 720C                    	jc	short w1s_2
  6150                                  w1s_1:
  6151 00002030 52                      	push	dx
  6152 00002031 B402                    	mov	ah, 2
  6153 00002033 CD1A                    	int	1Ah ; get time of day
  6154 00002035 58                      	pop	ax
  6155 00002036 7204                    	jc	short w1s_2
  6156 00002038 38E6                    	cmp	dh, ah
  6157 0000203A 74F4                    	je	short w1s_1 ; same second
  6158                                  w1s_2:
  6159 0000203C C3                      	retn
  6160                                  
  6161                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6162                                  ; partition type input
  6163                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6164                                  
  6165                                  partition_type_input:
  6166 0000203D BE[C14E]                	mov	si, msg_partition_type
  6167 00002040 E84FFB                  	call	print_msg
  6168                                  
  6169 00002043 31DB                    	xor	bx, bx
  6170                                  
  6171 00002045 881E[0E6D]              	mov	[pType_pos], bl ; 0
  6172 00002049 891E[0F6D]              	mov	[pType_num], bx ; 0
  6173                                  
  6174                                  	; bh = 0  ; video page
  6175 0000204D B403                    	mov     ah, 3 ; get cursor pos
  6176 0000204F CD10                    	int     10h
  6177 00002051 8916[C354]              	mov	[Cursor_Pos], dx
  6178                                  ptu_0:
  6179 00002055 30E4                    	xor	ah, ah
  6180 00002057 CD16                    	int	16h
  6181                                  
  6182 00002059 803E[0E6D]01            	cmp	byte [pType_pos], 1
  6183 0000205E 773F                    	ja	short ptu_5	
  6184                                  
  6185 00002060 3C30                    	cmp	al, '0'
  6186 00002062 723B                    	jb	short ptu_5
  6187 00002064 3C39                    	cmp	al, '9'
  6188 00002066 7707                    	ja	short ptu_1
  6189 00002068 88C4                    	mov	ah, al
  6190 0000206A 80EC30                  	sub	ah, '0'
  6191 0000206D EB13                    	jmp	short ptu_2 
  6192                                  ptu_1:
  6193 0000206F 3CE0                    	cmp     al, 0E0h
  6194 00002071 7473                    	je	short ptu_9
  6195                                  
  6196 00002073 24DF                    	and	al, 0DFh
  6197 00002075 3C41                    	cmp	al, 'A'
  6198 00002077 72DC                    	jb	short ptu_0
  6199 00002079 3C46                    	cmp	al, 'F'
  6200 0000207B 77D8                    	ja	short ptu_0
  6201 0000207D 88C4                    	mov	ah, al
  6202 0000207F 80EC37                  	sub	ah, 'A'-10
  6203                                  ptu_2:
  6204 00002082 803E[0E6D]00            	cmp	byte [pType_pos], 0
  6205 00002087 7606                    	jna	short ptu_3
  6206 00002089 8826[106D]              	mov	[pType_num+1], ah
  6207 0000208D EB04                    	jmp	short ptu_4 
  6208                                  ptu_3:
  6209 0000208F 8826[0F6D]              	mov	[pType_num], ah
  6210                                  ptu_4:
  6211 00002093 B40E                    	mov	ah, 0Eh
  6212 00002095 B307                    	mov	bl, 7
  6213 00002097 CD10                    	int	10h
  6214                                  
  6215 00002099 FE06[0E6D]              	inc	byte [pType_pos]
  6216                                  
  6217 0000209D EBB6                    	jmp	short ptu_0 
  6218                                  ptu_5:
  6219 0000209F 20C0                    	and	al, al
  6220 000020A1 7443                    	jz	short ptu_9 ; check for left arrow key 
  6221 000020A3 3C1B                    	cmp	al, 27
  6222 000020A5 744C                    	je	short ptu_10 ; ESCAPE key
  6223 000020A7 77AC                    	ja	short ptu_0
  6224 000020A9 3C0D                    	cmp	al, 13
  6225 000020AB 744A                    	je	short ptu_11  ; ENTER key
  6226 000020AD 77A6                    	ja	short ptu_0
  6227                                  ptu_6:
  6228                                  	; Left arrow, backspace, DEL key checking
  6229                                  
  6230 000020AF 3C08                    	cmp	al, 8 ; backspace key
  6231 000020B1 75A2                    	jne	short ptu_0
  6232                                  ptu_7:
  6233                                  	; bh = 0  ; video page
  6234 000020B3 B403                    	mov	ah, 3 ; get cursor pos
  6235 000020B5 CD10                    	int	10h
  6236 000020B7 3A16[C354]              	cmp	dl, [Cursor_Pos]
  6237 000020BB 7620                    	jna	short ptu_8
  6238 000020BD FECA                    	dec	dl
  6239 000020BF FE0E[0E6D]              	dec	byte [pType_pos]
  6240                                  	; bh = 0  ; video page
  6241 000020C3 B402                    	mov	ah, 2 ; set cursor pos
  6242 000020C5 CD10                    	int	10h
  6243 000020C7 88D3                    	mov	bl, dl
  6244 000020C9 2A1E[C354]              	sub	bl, [Cursor_Pos] 
  6245 000020CD B90100                  	mov	cx, 1
  6246 000020D0 B409                    	mov	ah, 9 ; write char at current curs pos
  6247 000020D2 B020                    	mov	al, 20h ; space (blank)
  6248 000020D4 8800                    	mov	[si+bx], al
  6249                                  	; bh = 0 ; video page
  6250 000020D6 B307                    	mov	bl, 7 ; attribute/color (light gray)
  6251 000020D8 CD10                    	int	10h
  6252 000020DA E978FF                  	jmp	ptu_0
  6253                                  ptu_8:
  6254 000020DD B40E                    	mov	ah, 0Eh
  6255 000020DF B007                    	mov	al, 7
  6256 000020E1 CD10                    	int	10h
  6257 000020E3 E96FFF                  	jmp	ptu_0
  6258                                  ptu_9:    
  6259 000020E6 80FC4B                  	cmp	ah, 4Bh ; left arrow
  6260 000020E9 74C8                    	je	short ptu_7
  6261 000020EB 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  6262 000020EE 74C3                    	je	short ptu_7
  6263 000020F0 E962FF                  	jmp	ptu_0
  6264                                  
  6265                                  ptu_10: ; ESCAPE
  6266                                  	;mov	al, 0
  6267                                  	; 29/10/2020
  6268 000020F3 28C0                    	sub	al, al ; 0
  6269                                  	; partition type is 0 (none)
  6270 000020F5 EB12                    	jmp	short ptu_12
  6271                                  ptu_11: ; ENTER
  6272 000020F7 A0[0F6D]                	mov	al, [pType_num]
  6273 000020FA 803E[0E6D]01            	cmp	byte [pType_pos], 1
  6274 000020FF 7608                    	jna	short ptu_12
  6275 00002101 B410                    	mov	ah, 16
  6276 00002103 F6E4                    	mul	ah
  6277 00002105 0206[106D]              	add	al, [pType_num+1]
  6278                                  ptu_12:
  6279 00002109 50                      	push	ax
  6280 0000210A E85BFB                  	call	bin_to_hex
  6281 0000210D A3[D74E]                	mov	[msg_ptype_num], ax
  6282                                  	; bh = 0  ; video page
  6283 00002110 B402                    	mov	ah, 2 ; set cursor pos
  6284 00002112 8B16[C354]              	mov	dx, [Cursor_Pos]
  6285 00002116 CD10                    	int	10h
  6286 00002118 BE[D74E]                	mov	si, msg_ptype_num 
  6287 0000211B E874FA                  	call	print_msg
  6288 0000211E 58                      	pop	ax
  6289 0000211F C3                      	retn
  6290                                  
  6291                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6292                                  ; show selected partition
  6293                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6294                                  
  6295                                  show_selected_partition:
  6296                                  	; INPUT ->
  6297                                  	; 	DS:SI = Partition table row address
  6298                                  	
  6299                                  	; 2019 - 2020 (hdimage.s)
  6300                                  	;pt_s_offset	equ 7
  6301                                  	;pt_bh_offset	equ 11
  6302                                  	;pt_bs_offset	equ 15
  6303                                  	;pt_bc_offset	equ 19
  6304                                  	;pt_fs_offset	equ 23
  6305                                  	;pt_eh_offset	equ 27
  6306                                  	;pt_es_offset	equ 31
  6307                                  	;pt_ec_offset	equ 35
  6308                                  	;pt_rs_offset	equ 41
  6309                                  	;pt_ts_offset	equ 52
  6310                                  	;pt_fsn_offset	equ 63
  6311                                  
  6312                                  	; 24/10/2020 (fdisk3.s)
  6313                                  	pt_s_offset	equ 6
  6314                                  	pt_bh_offset	equ 10
  6315                                  	pt_bs_offset	equ 14
  6316                                  	pt_bc_offset	equ 18
  6317                                  	pt_fs_offset	equ 22
  6318                                  	pt_eh_offset	equ 26
  6319                                  	pt_es_offset	equ 30
  6320                                  	pt_ec_offset	equ 34
  6321                                  	pt_rs_offset	equ 40
  6322                                  	pt_ts_offset	equ 51
  6323                                  	pt_fsn_offset	equ 63
  6324                                  
  6325                                  	; clear screen
  6326 00002120 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  6327 00002123 CD10                    	int	10h	
  6328                                  
  6329 00002125 89F0                    	mov	ax, si
  6330 00002127 2D[B857]                	sub	ax, MasterBootBuff + pTableOffset ; + 446
  6331 0000212A C0E804                  	shr	al, 4 ; from offset to partition number
  6332 0000212D 0431                    	add	al, '1'  ; 1 based partition number (chr)
  6333                                  	; Write partition number to the header location
  6334 0000212F A2[9750]                	mov	[msg_selected_partition+43], al ; '1' to '4'
  6335                                  	
  6336                                  	; Partition number will be used at formatting stage
  6337 00002132 A2[6653]                	mov	[partition_num_chr], al ; number + '0'
  6338                                  
  6339 00002135 B268                    	mov	dl, 'h'
  6340 00002137 8A04                    	mov	al, [si+ptBootable]
  6341 00002139 E82CFB                  	call	bin_to_hex
  6342 0000213C A3[B251]                	mov	[pt_row+pt_s_offset], ax
  6343 0000213F 8816[B451]              	mov	[pt_row+pt_s_offset+2], dl ; 'h'
  6344 00002143 8A4401                  	mov	al, [si+ptBeginHead]
  6345 00002146 E81FFB                  	call	bin_to_hex
  6346 00002149 A3[B651]                	mov	[pt_row+pt_bh_offset], ax
  6347 0000214C 8816[B851]              	mov	[pt_row+pt_bh_offset+2], dl ; 'h'
  6348 00002150 8A4402                  	mov	al, [si+ptBeginSector]
  6349 00002153 E812FB                  	call	bin_to_hex
  6350 00002156 A3[BA51]                	mov	[pt_row+pt_bs_offset], ax
  6351 00002159 8816[BC51]              	mov	[pt_row+pt_bs_offset+2], dl ; 'h'
  6352 0000215D 8A4403                  	mov	al, [si+ptBeginCylinder]
  6353 00002160 E805FB                  	call	bin_to_hex
  6354 00002163 A3[BE51]                	mov	[pt_row+pt_bc_offset], ax
  6355 00002166 8816[C051]              	mov	[pt_row+pt_bc_offset+2], dl ; 'h'
  6356 0000216A 8A4404                  	mov	al, [si+ptFileSystemID]
  6357                                   	; Partition type will be used at formatting stage
  6358 0000216D A2[F26C]                	mov	[pp_type_user], al
  6359 00002170 E8F5FA                  	call	bin_to_hex
  6360 00002173 A3[C251]                	mov	[pt_row+pt_fs_offset], ax
  6361 00002176 8816[C451]              	mov	[pt_row+pt_fs_offset+2], dl ; 'h'
  6362 0000217A 8A4405                  	mov	al, [si+ptEndHead]
  6363 0000217D E8E8FA                  	call	bin_to_hex
  6364 00002180 A3[C651]                	mov	[pt_row+pt_eh_offset], ax
  6365 00002183 8816[C851]              	mov	[pt_row+pt_eh_offset+2], dl ; 'h'
  6366 00002187 8A4406                  	mov	al, [si+ptEndSector]
  6367 0000218A E8DBFA                  	call	bin_to_hex
  6368 0000218D A3[CA51]                	mov	[pt_row+pt_es_offset], ax
  6369 00002190 8816[CC51]              	mov	[pt_row+pt_es_offset+2], dl ; 'h'
  6370 00002194 8A4407                  	mov	al, [si+ptEndCylinder]
  6371 00002197 E8CEFA                  	call	bin_to_hex
  6372 0000219A A3[CE51]                	mov	[pt_row+pt_ec_offset], ax
  6373 0000219D 8816[D051]              	mov	[pt_row+pt_ec_offset+2], dl ; 'h'
  6374 000021A1 8A4408                  	mov	al, [si+ptStartSector]
  6375 000021A4 E8C1FA                  	call	bin_to_hex
  6376 000021A7 A3[DA51]                	mov	[pt_row+pt_rs_offset+6], ax
  6377 000021AA 8816[DC51]              	mov	[pt_row+pt_rs_offset+8], dl ; 'h'
  6378 000021AE 8A4409                  	mov	al, [si+ptStartSector+1]
  6379 000021B1 E8B4FA                  	call	bin_to_hex
  6380 000021B4 A3[D851]                	mov	[pt_row+pt_rs_offset+4], ax
  6381 000021B7 8A440A                  	mov	al, [si+ptStartSector+2]
  6382 000021BA E8ABFA                  	call	bin_to_hex
  6383 000021BD A3[D651]                	mov	[pt_row+pt_rs_offset+2], ax
  6384 000021C0 8A440B                  	mov	al, [si+ptStartSector+3]
  6385 000021C3 E8A2FA                  	call	bin_to_hex
  6386 000021C6 A3[D451]                	mov	[pt_row+pt_rs_offset], ax
  6387 000021C9 8A440C                  	mov	al, [si+ptSectors]
  6388 000021CC E899FA                  	call	bin_to_hex
  6389 000021CF A3[E551]                	mov	[pt_row+pt_ts_offset+6], ax
  6390 000021D2 8816[E751]              	mov	[pt_row+pt_ts_offset+8], dl ; 'h'
  6391 000021D6 8A440D                  	mov	al, [si+ptSectors+1]
  6392 000021D9 E88CFA                  	call	bin_to_hex
  6393 000021DC A3[E351]                	mov	[pt_row+pt_ts_offset+4], ax
  6394 000021DF 8A440E                  	mov	al, [si+ptSectors+2]
  6395 000021E2 E883FA                  	call	bin_to_hex
  6396 000021E5 A3[E151]                	mov	[pt_row+pt_ts_offset+2], ax
  6397 000021E8 8A440F                  	mov	al, [si+ptSectors+3]
  6398 000021EB E87AFA                  	call	bin_to_hex
  6399 000021EE A3[DF51]                	mov	[pt_row+pt_ts_offset], ax
  6400                                  
  6401 000021F1 8A4404                  	mov	al, [si+ptFileSystemID]
  6402 000021F4 BF[9E40]                	mov	di, valid_partitions
  6403 000021F7 B91300                  	mov	cx, 19
  6404 000021FA F2AE                    	repnz	scasb
  6405 000021FC 7405                    	jz	short ssp_1
  6406 000021FE B8[9040]                	mov	ax, FS_OTHERS	 
  6407 00002201 EB0C                    	jmp	short ssp_2
  6408                                  ssp_1:
  6409 00002203 81EF[9F40]              	sub	di, valid_partitions + 1
  6410 00002207 B80E00                  	mov	ax, 14
  6411 0000220A F7E7                    	mul	di
  6412 0000220C 05[863F]                	add	ax, FileSys_Names
  6413                                  ssp_2:
  6414 0000220F 96                      	xchg	ax, si 
  6415 00002210 B107                    	mov	cl, 7
  6416 00002212 BF[EB51]                	mov	di, pt_row + pt_fsn_offset
  6417 00002215 F3A5                    	rep	movsw
  6418 00002217 89C7                    	mov	di, ax ; partition table row address
  6419                                  
  6420 00002219 BE[6C50]                	mov	si, msg_selected_partition
  6421 0000221C E873F9                  	call	print_msg
  6422                                  
  6423 0000221F BE[4D52]                	mov	si, msg_boot_indicator
  6424 00002222 E86DF9                  	call	print_msg
  6425 00002225 BE[B95C]                	mov	si, msg_YES
  6426 00002228 F60580                  	test	byte [di+ptBootable], 80h
  6427 0000222B 7503                    	jnz	short ssp_3
  6428 0000222D BE[BF5C]                	mov	si, msg_NO
  6429                                  ssp_3:
  6430 00002230 E85FF9                  	call	print_msg
  6431                                  
  6432 00002233 BE[6552]                	mov	si, msg_starting_head
  6433 00002236 E859F9                  	call	print_msg
  6434 00002239 8A4501                  	mov	al, [di+ptBeginHead]
  6435 0000223C E8B200                  	call	write_byte_decimal
  6436 0000223F E850F9                  	call	print_msg
  6437 00002242 BE[7D52]                	mov	si, msg_starting_sector
  6438 00002245 E84AF9                  	call	print_msg
  6439 00002248 8A4502                  	mov	al, [di+ptBeginSector]
  6440 0000224B 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  6441 0000224D 243F                    	and	al, 3Fh ; sector number, 1 to 63
  6442 0000224F E89F00                  	call	write_byte_decimal
  6443 00002252 E83DF9                  	call	print_msg	
  6444 00002255 BE[9552]                	mov	si, msg_starting_cylinder
  6445 00002258 E837F9                  	call	print_msg
  6446 0000225B 8A4503                  	mov	al, [di+ptBeginCylinder] ; bits 0to7 of cyl
  6447 0000225E C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  6448 00002261 88D4                    	mov	ah, dl
  6449 00002263 31D2                    	xor	dx, dx
  6450                                  	;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6451                                  	; 06/11/2020
  6452 00002265 BE[0B6D]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  6453                                  	; dx_ax: binary number
  6454 00002268 E8E6F9                  	call	bin_to_decimal
  6455                                  	; ds:si = decimal number text address
  6456 0000226B E824F9                  	call	print_msg
  6457 0000226E BE[AD52]                	mov	si, msg_system_id
  6458 00002271 E81EF9                  	call	print_msg
  6459                                  	; Write file system name (again, copy)
  6460 00002274 BE[EB51]                	mov	si, pt_row + pt_fsn_offset
  6461                                  	;mov	cx, 14
  6462 00002277 B10E                    	mov	cl, 14
  6463 00002279 B40E                    	mov	ah, 0Eh ; write tty
  6464 0000227B BB0700                  	mov	bx, 7
  6465                                  ssp_4:	 
  6466 0000227E AC                      	lodsb
  6467 0000227F CD10                    	int	10h
  6468 00002281 E2FB                    	loop	ssp_4
  6469                                  
  6470 00002283 BE[C552]                	mov	si, msg_ending_head
  6471 00002286 E809F9                  	call	print_msg
  6472 00002289 8A4505                  	mov	al, [di+ptEndHead]
  6473 0000228C E86200                  	call	write_byte_decimal
  6474 0000228F E800F9                  	call	print_msg
  6475 00002292 BE[DD52]                	mov	si, msg_ending_sector
  6476 00002295 E8FAF8                  	call	print_msg
  6477 00002298 8A4506                  	mov	al, [di+ptEndSector]
  6478 0000229B 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  6479 0000229D 243F                    	and	al, 3Fh ; sector number, 1 to 63
  6480 0000229F E84F00                  	call	write_byte_decimal
  6481 000022A2 E8EDF8                  	call	print_msg	
  6482 000022A5 BE[F552]                	mov	si, msg_ending_cylinder
  6483 000022A8 E8E7F8                  	call	print_msg
  6484 000022AB 8A4507                  	mov	al, [di+ptEndCylinder] ; bits 0to7 of cyl
  6485 000022AE C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  6486 000022B1 88D4                    	mov	ah, dl
  6487 000022B3 31D2                    	xor	dx, dx
  6488                                  	;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6489                                  	; 06/11/2020
  6490 000022B5 BE[0B6D]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits 
  6491                                  	; dx_ax: binary number
  6492 000022B8 E896F9                  	call	bin_to_decimal
  6493                                  	; ds:si = decimal number text address
  6494 000022BB E8D4F8                  	call	print_msg
  6495                                  
  6496 000022BE BE[0D53]                	mov	si, msg_relative_sectors
  6497 000022C1 E8CEF8                  	call	print_msg
  6498 000022C4 8B4508                  	mov	ax, [di+ptStartSector]
  6499 000022C7 8B550A                  	mov	dx, [di+ptStartSector+2]
  6500                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6501                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  6502                                  	; 06/11/2020
  6503 000022CA BE[0B6D]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  6504 000022CD E881F9                  	call	bin_to_decimal
  6505 000022D0 E8BFF8                  	call	print_msg
  6506                                  
  6507 000022D3 BE[2753]                	mov	si, msg_total_sectors
  6508 000022D6 E8B9F8                  	call	print_msg
  6509 000022D9 8B450C                  	mov	ax, [di+ptSectors]
  6510 000022DC 8B550E                  	mov	dx, [di+ptSectors+2]
  6511                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  6512                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  6513                                  	; 06/11/2020
  6514 000022DF BE[0B6D]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  6515 000022E2 E86CF9                  	call	bin_to_decimal	
  6516 000022E5 E8AAF8                  	call	print_msg
  6517                                  
  6518                                  	; 24/02/2019
  6519 000022E8 BE[7F55]                	mov	si, CRLF
  6520 000022EB E8A4F8                  	call	print_msg
  6521                                  
  6522 000022EE 89FE                    	mov	si, di  ; partition table row address
  6523                                  
  6524 000022F0 C3                      	retn
  6525                                  
  6526                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6527                                  ; write byte as descimal number
  6528                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6529                                  
  6530                                  write_byte_decimal:
  6531                                  	; INPUT ->
  6532                                  	;	AL = binary number
  6533                                  	; OUTPUT ->
  6534                                  	;	DS:SI = decimal number text address
  6535                                  	;	        (ASCIIZ string)
  6536                                  	;
  6537                                  	; (SI, AX, CX will be modified)	
  6538                                  
  6539                                  	;mov	si, msg_partition_sectors + 8 ; max. 8 digits
  6540                                  	; 06/11/2020
  6541 000022F1 BE[0C6D]                	mov	si, msg_partition_sectors + 11 ; max. 11 digits
  6542 000022F4 B10A                    	mov	cl, 10
  6543                                  wbd_loop:
  6544 000022F6 4E                      	dec	si
  6545 000022F7 30E4                    	xor	ah, ah
  6546 000022F9 F6F1                    	div	cl
  6547 000022FB 80C430                  	add	ah, '0'
  6548 000022FE 8824                    	mov	[si], ah
  6549 00002300 20C0                    	and	al, al
  6550 00002302 75F2                    	jnz	short wbd_loop
  6551 00002304 C3                      	retn
  6552                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6553                                  ; init (MBR) partition table
  6554                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6555                                  ; 16/10/2020
  6556                                  
  6557                                  	; 03/02/2019
  6558                                  init_partition_table:
  6559                                  
  6560                                  	; INPUT -> none
  6561                                  	; OUTPUT -> none
  6562                                  
  6563                                  	; 15/10/2020
  6564                                  	; (If a partition row contains invalid/wrong/defective parameters)
  6565                                  	; (it's active partition flag/byte will be 0FFh, an invalid value!)
  6566                                  
  6567                                  	; 12/02/2019	
  6568                                  	;cmp	word [MBIDCode], 0AA55h
  6569                                  	;jne	ipt_stc ; invalid
  6570                                  
  6571                                  	; 15/02/2019
  6572                                  	; clear primary partition table structure/list
  6573                                  
  6574 00002305 BF[946F]                	mov	di, part_table_boot_ind
  6575 00002308 B92400                  	mov	cx, 36 ; 18*4 = 72 bytes
  6576 0000230B 31C0                    	xor	ax, ax ; 0
  6577 0000230D F3AB                    	rep	stosw
  6578                                  
  6579 0000230F A3[DC6F]                	mov	[pcount], ax ; reset (pcount & ppcount)
  6580 00002312 A3[DE6F]                	mov	[apcount], ax ; reset (apcount & epnumber)
  6581                                  
  6582 00002315 BE[B857]                	mov	si, MasterBootBuff+446 ; Partition table offset
  6583                                  	;mov	cx, 4
  6584 00002318 B104                    	mov	cl, 4
  6585 0000231A 31FF                    	xor	di, di
  6586                                  ipt_0:
  6587 0000231C 8A6404                  	mov	ah, [si+ptFileSystemID]
  6588                                  
  6589 0000231F 20E4                    	and	ah, ah
  6590 00002321 0F841601                	jz	ipt_8 ; empty
  6591                                  
  6592 00002325 FE06[DC6F]              	inc	byte [pcount] ; partition count
  6593                                  
  6594 00002329 80FC01                  	cmp	ah, 1	; FAT12
  6595 0000232C 7442                    	je	short ipt_2
  6596 0000232E 80FC04                  	cmp	ah, 4	; FAT16
  6597 00002331 743D                    	je	short ipt_2
  6598 00002333 723F                    	jb	short ipt_3	
  6599 00002335 80FC06                  	cmp	ah, 6	; FAT16 big
  6600 00002338 7436                    	je	short ipt_2
  6601 0000233A 7715                    	ja	short ipt_1 ; EXTENDED
  6602                                  
  6603                                  	;cmp	ah, 5 ; EXTENDED
  6604                                  	;jne	short ipt_3
  6605                                  ipt_17:
  6606 0000233C 803E[DF6F]00            	cmp	byte [epnumber], 0
  6607                                  	;ja	short ipt_stc ; invalid  (more than 1 extended dos partition)
  6608 00002341 7605                    	jna	short ipt_15
  6609                                  	
  6610 00002343 C685[946F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6611                                  				; Invalid/Defective partition flag
  6612                                  ipt_15:	
  6613 00002348 B005                    	mov	al, 5
  6614 0000234A 28C8                    	sub	al, cl ; partition number 1 to 4
  6615 0000234C A2[DF6F]                	mov	byte [epnumber], al ; extended partition entry number (1 to 4)
  6616 0000234F EB23                    	jmp	short ipt_3
  6617                                  ipt_1:
  6618                                  	; 26/10/2020
  6619 00002351 80FC07                  	cmp	ah, 07h ; NTFS (Windows FS)
  6620 00002354 741A                    	je	short ipt_2 ; accept NTFS as primary dos partition
  6621                                  			    ; (then, extended partition can be created)	
  6622                                  	; 24/10/2020
  6623 00002356 80FC0C                  	cmp	ah, 0Ch ; FAT32 (LBA)
  6624 00002359 7415                    	je	short ipt_2
  6625 0000235B 7707                    	ja	short ipt_18
  6626                                  	; 16/10/2020
  6627 0000235D 80FC0B                  	cmp	ah, 0Bh ; FAT32 (CHS)
  6628                                  	;jne	short ipt_3
  6629                                  	; 24/10/2020
  6630 00002360 740E                    	je	short ipt_2
  6631 00002362 7210                    	jb	short ipt_3 ; non-dos partition (NTFS or unknown fs type)
  6632                                  ipt_18:
  6633 00002364 80FC0F                  	cmp	ah, 0Fh  ; EXTENDED (LBA)
  6634 00002367 74D3                    	je	short ipt_17
  6635 00002369 7709                    	ja	short ipt_3 ; non-dos partition 
  6636                                  			    ; (xenix/unix/linux/singlix/runix or unknown)
  6637 0000236B 80FC0E                  	cmp	ah, 0Eh ; FAT16 (LBA)
  6638 0000236E 7504                    	jne	short ipt_3 ; 0Dh
  6639                                  	; FAT16 LBA (0Eh)
  6640                                  ipt_2:
  6641 00002370 FE06[DD6F]              	inc	byte [ppcount] ; primary dos partition count
  6642                                  ipt_3:
  6643 00002374 88A5[996F]              	mov	[part_table_sys_id+di], ah  ; Partition Type (FS type)
  6644                                  	
  6645 00002378 8A04                    	mov	al, [si+ptBootable]
  6646                                  
  6647 0000237A 20C0                    	and	al, al
  6648 0000237C 7413                    	jz	short ipt_4
  6649                                  
  6650 0000237E 803E[DE6F]01            	cmp	byte [apcount], 1 ; check (previous) active partition count
  6651                                  	;jnb	short ipt_stc  ; invalid (if it is not zero here)
  6652 00002383 7304                    	jnb	short ipt_16
  6653                                  
  6654 00002385 3C80                    	cmp	al, 80h  ; active partition sign/flag?
  6655                                  	;jne	short ipt_stc  ; invalid flag
  6656 00002387 7404                    	je	short ipt_11
  6657                                  ipt_16:
  6658                                  	; 15/10/2020
  6659 00002389 B0FF                    	mov	al, 0FFh ; Invalid/Defective partition flag
  6660 0000238B EB04                    	jmp	short ipt_4
  6661                                  ipt_11:
  6662 0000238D FE06[DE6F]              	inc	byte [apcount]  ; active partition count = 1
  6663                                  ipt_4:
  6664 00002391 8885[946F]              	mov	[part_table_boot_ind+di], al
  6665                                  
  6666                                  	;mov	al, [heads]
  6667                                  ;ipt_4_fix:
  6668                                  	;dec	al
  6669 00002395 8A6401                  	mov	ah, [si+ptBeginHead]
  6670                                  	;cmp	al, ah
  6671                                  	;;jb	short ipt_retn ; invalid
  6672                                  	;jb	ipt_heads_fix ; 10/02/2019
  6673 00002398 88A5[956F]              	mov	[part_table_start_head+di], ah
  6674 0000239C 8A6405                  	mov	ah, [si+ptEndHead]
  6675                                  	;cmp	al, ah
  6676                                  	;;jb	short ipt_retn ; invalid
  6677                                  	;jb	short ipt_heads_fix ; 10/02/2019
  6678 0000239F 88A5[9A6F]              	mov	[part_table_end_head+di], ah
  6679                                  	;mov	al, [sectors]
  6680 000023A3 8A7C02                  	mov	bh, [si+ptBeginSector]
  6681 000023A6 88FC                    	mov	ah, bh
  6682 000023A8 80E43F                  	and	ah, 3Fh ; 63
  6683                                  	;cmp	al, ah
  6684                                  	;jb	short ipt_retn ; invalid
  6685 000023AB 88A5[966F]              	mov	[part_table_start_sector+di], ah
  6686 000023AF 8A7406                  	mov	dh, [si+ptEndSector]
  6687 000023B2 88F4                    	mov	ah, dh
  6688 000023B4 80E43F                  	and	ah, 3Fh ; 63
  6689                                  	;cmp	al, ah
  6690                                  	;jb	short ipt_retn ; invalid
  6691 000023B7 88A5[9B6F]              	mov	[part_table_end_sector+di], ah
  6692 000023BB C0EF06                  	shr	bh, 6
  6693 000023BE 8A5C03                  	mov	bl, [si+ptBeginCylinder]
  6694                                  	;mov	ax, [cylinders]
  6695                                  	;dec	ax	
  6696                                  	;cmp	ax, bx
  6697                                  	;jb	short ipt_retn ; invalid
  6698 000023C1 899D[976F]              	mov	[part_table_start_cyl+di], bx
  6699 000023C5 C0EE06                  	shr	dh, 6
  6700 000023C8 8A5407                  	mov	dl, [si+ptEndCylinder]
  6701                                  	;cmp	ax, dx
  6702                                  	;jb	short ipt_retn ; invalid
  6703 000023CB 8995[9C6F]              	mov	[part_table_end_cyl+di], dx
  6704                                  
  6705 000023CF 8B4408                  	mov	ax, [si+ptStartSector]
  6706 000023D2 8B540A                  	mov	dx, [si+ptStartSector+2]
  6707                                  
  6708 000023D5 8985[9E6F]              	mov	[part_table_rel_sec_lw+di], ax
  6709 000023D9 8995[A06F]              	mov	[part_table_rel_sec_hw+di], dx
  6710                                  
  6711 000023DD 09D0                    	or	ax, dx
  6712                                  	;jz	short ipt_stc ; invalid (start sector must not be zero)
  6713 000023DF 7505                    	jnz	short ipt_12
  6714                                  	; 15/10/2020
  6715 000023E1 C685[946F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6716                                  				; Invalid/Defective partition flag
  6717                                  ipt_12:
  6718 000023E6 8B440C                  	mov	ax, [si+ptSectors]
  6719 000023E9 8B540E                  	mov	dx, [si+ptSectors+2]
  6720                                  
  6721 000023EC 89D3                    	mov	bx, dx
  6722 000023EE 09C3                    	or	bx, ax
  6723                                  	;jz	short ipt_stc	; invalid (zero size of partition)
  6724 000023F0 7505                    	jnz	short ipt_6 ; 10/02/2019
  6725                                  
  6726                                  	; 15/10/2020
  6727 000023F2 C685[946F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6728                                  				; Invalid/Defective partition flag
  6729                                  
  6730                                  	;cmp	dx, [total_sectors+2]
  6731                                  	;ja	short ipt_stc	; invalid (partition size > disk capacity)
  6732                                  	;jb	short ipt_6
  6733                                  	;;cmp	ax, [total_sectors] ; (ax + 1) <= total sectors
  6734                                  	;jb	short ipt_6
  6735                                  	
  6736                                  ;ipt_stc:
  6737                                  ;	; invalid MBR data
  6738                                  ;	;stc
  6739                                  ;ipt_retn:
  6740                                  ;	retn
  6741                                  
  6742                                  ;ipt_heads_fix:
  6743                                  	; 10/02/2019
  6744                                  	; AL = [heads] - 1
  6745                                  
  6746                                  	;test	byte [cylinders], 1
  6747                                  	;jnz	short ipt_stc ; odd cylinder count (can not be shifted)
  6748                                  	
  6749                                  	;inc	al ; = [heads]
  6750                                  	;cmp	al, 8
  6751                                  	;ja	short ipt_stc ; this fix is needed for <= 16 heads (& 17 spt)
  6752                                  	;shl	al, 1
  6753                                  	;mov	[heads], al ; heads = heads*2
  6754                                  	;shr	word [cylinders], 1 ; cylinders = cylinders/2
  6755                                  	;jmp	ipt_4_fix
  6756                                  
  6757                                  ipt_6:
  6758 000023F7 8985[A26F]              	mov	[part_table_num_sec_lw+di], ax
  6759 000023FB 8995[A46F]              	mov	[part_table_num_sec_hw+di], dx
  6760                                  
  6761 000023FF 0385[9E6F]              	add	ax, [part_table_rel_sec_lw+di]
  6762 00002403 1395[A06F]              	adc	dx, [part_table_rel_sec_hw+di]
  6763                                  	;jc	short ipt_retn  ; invalid
  6764                                  	; 27/10/2020
  6765 00002407 720E                    	jc	short ipt_13
  6766                                  
  6767 00002409 3B16[5868]              	cmp	dx, [total_sectors+2]
  6768                                  	;ja	short ipt_stc	; invalid (partition end > disk capacity)
  6769 0000240D 720D                    	jb	short ipt_7
  6770                                  	; 27/10/2020
  6771 0000240F 7706                    	ja	short ipt_13
  6772 00002411 3B06[5668]              	cmp	ax, [total_sectors] ; ax <= total sectors
  6773                                  	;ja	short ipt_stc	; invalid (partition end > disk capacity)
  6774 00002415 7605                    	jna	short ipt_7
  6775                                  ipt_13:
  6776                                  	; 15/10/2020
  6777 00002417 C685[946F]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  6778                                  				; Invalid/Defective partition flag 
  6779                                  ipt_7:
  6780                                  	; 27/10/2020
  6781 0000241C B8FE03                  	mov	ax, 1022 ; CHS cylinder number limit
  6782 0000241F 3985[976F]              	cmp	[part_table_start_cyl+di], ax
  6783 00002423 7707                    	ja	short ipt_19 ; = 1023
  6784 00002425 40                      	inc	ax ; 1023
  6785 00002426 3985[9C6F]              	cmp	[part_table_end_cyl+di], ax
  6786 0000242A 7203                    	jb	short ipt_14  ; < 1023
  6787                                  ipt_19:
  6788                                  	; 27/10/2020
  6789                                  	; set cylinder number if the partition's start or end sector is
  6790                                  	; at the beyond of chs limit 
  6791                                  	; ax = 1022 -> set start cylinder
  6792                                  	; ax = 1023 -> set end cylinder
  6793 0000242C E82100                  	call	cylindernumberfix
  6794                                  ipt_14:
  6795 0000242F 83C610                  	add	si, 16
  6796 00002432 E201                    	loop	ipt_5
  6797                                  	
  6798                                  	; OK!
  6799                                  
  6800                                  	;clc
  6801 00002434 C3                      	retn
  6802                                  
  6803                                  ipt_5:
  6804 00002435 83C712                  	add	di, 18
  6805 00002438 E9E1FE                  	jmp	ipt_0
  6806                                  
  6807                                  ipt_8:
  6808                                  	; Empty partition table check (all of 16 bytes must be 0)
  6809 0000243B 51                      	push	cx
  6810 0000243C 56                      	push	si ; 16/10/2020
  6811 0000243D B108                    	mov	cl, 8
  6812                                  ipt_9:
  6813 0000243F AD                      	lodsw
  6814 00002440 09C0                    	or	ax, ax
  6815 00002442 7507                    	jnz	short ipt_10
  6816 00002444 E2F9                    	loop	ipt_9
  6817 00002446 59                      	pop	cx ; 16/10/2020  ; (discard si)
  6818 00002447 59                      	pop	cx
  6819 00002448 E2EB                    	loop	ipt_5
  6820                                  	
  6821                                  	;clc
  6822 0000244A C3                      	retn
  6823                                  ipt_10:
  6824                                  	;pop	cx
  6825                                  	; invalid
  6826                                  	;stc
  6827                                  	; 27/10/2020
  6828                                  	; 15/10/2020
  6829                                  	;mov	byte [part_table_boot_ind+di], 0FFh
  6830                                  				; Invalid/Defective partition flag 
  6831                                  	;retn
  6832                                  	; 16/10/2020
  6833                                  	; 31/10/2020
  6834                                  	;mov	byte [part_table_sys_id+di], 0	; Empty partition
  6835 0000244B 5E                      	pop	si
  6836 0000244C 59                      	pop	cx
  6837 0000244D E939FF                  	jmp	ipt_16
  6838                                  
  6839                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6840                                  ; set cylinder number to partition's start or end sector 
  6841                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6842                                  ; 27/10/2020
  6843                                  
  6844                                  cylindernumberfix:
  6845                                  	; ax = 1022 -> set start cylinder
  6846                                  	; ax = 1023 -> set end cylinder
  6847                                  	; di = partition table structure offset
  6848                                  
  6849                                  	; modified registers: ax, dx, bx
  6850                                  	
  6851 00002450 3DFF03                  	cmp	ax, 1023
  6852 00002453 7343                    	jnb	short cnf_4 ; set end cylinder
  6853                                  	
  6854 00002455 80BD[956F]FE            	cmp	byte [part_table_start_head+di], 0FEh ; 254
  6855 0000245A 753C                    	jne	short cnf_4 ; no need to fix (start cyl) 
  6856                                  			; 30/10/2020
  6857                                  	; 28/10/2020
  6858 0000245C 80BD[966F]3F            	cmp	byte [part_table_start_sector+di], 3Fh ; 63
  6859 00002461 7535                    	jne	short cnf_4 ; no need to fix (start cyl)
  6860                                  			; 30/10/2020
  6861                                  
  6862 00002463 8B85[9E6F]              	mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  6863 00002467 8B95[A06F]              	mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  6864 0000246B 51                      	push	cx
  6865 0000246C 8B0E[146D]              	mov	cx, [hs] ; [heads*spt]
  6866 00002470 E80AE8                  	call	div32
  6867                                  		; dx:ax = cylinder number, dx = 0, quotient
  6868                                  		; bx = remainder
  6869 00002473 59                      	pop	cx
  6870 00002474 09D2                    	or 	dx, dx
  6871 00002476 751A                    	jnz	short cnf_2 ; invalid
  6872 00002478 3B85[976F]              	cmp	ax, [part_table_start_cyl+di]
  6873                                  	;je	short cnf_5
  6874 0000247C 7406                    	je	short cnf_1
  6875 0000247E 7212                    	jb	short cnf_2 ; invalid
  6876 00002480 8985[976F]              	mov	[part_table_start_cyl+di], ax ; change it
  6877                                  	;jmp	short cnf_5 
  6878                                  cnf_1:
  6879 00002484 80BD[9A6F]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  6880 00002489 7507                    	jne	short cnf_2 ; no need to fix (also invalid)
  6881                                  	
  6882                                  	; 28/10/2020
  6883 0000248B 80BD[9B6F]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  6884 00002490 7414                    	je	short cnf_5 ; fix
  6885                                  	; no need to fix (also invalid)
  6886                                  cnf_2:
  6887 00002492 C685[946F]FF            	mov	byte [part_table_boot_ind+di], 0FFh ; invalid PTE
  6888                                  cnf_3:
  6889 00002497 C3                      	retn
  6890                                  cnf_4:
  6891 00002498 80BD[9A6F]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  6892 0000249D 75F8                    	jne	short cnf_3 ; no need to fix (end cyl)
  6893                                  	
  6894                                  	; 28/10/2020
  6895 0000249F 80BD[9B6F]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  6896 000024A4 75F1                    	jne	short cnf_3 ; no need to fix (end cyl)
  6897                                  cnf_5:
  6898 000024A6 8B85[9E6F]              	mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  6899 000024AA 8B95[A06F]              	mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  6900                                  
  6901 000024AE 0385[A26F]              	add	ax, [part_table_num_sec_lw+di] ; number of sectors, lw 
  6902 000024B2 1395[A46F]              	adc	dx, [part_table_num_sec_hw+di] ; number of sectors, hw 
  6903                                  	;jc	short cnf_2
  6904                                  
  6905 000024B6 83E801                  	sub	ax, 1
  6906 000024B9 83DA00                  	sbb	dx, 0	
  6907                                  		; dx:ax = end sector
  6908 000024BC 51                      	push	cx
  6909 000024BD 8B0E[146D]              	mov	cx, [hs] ; [heads*spt]
  6910 000024C1 E8B9E7                  	call	div32
  6911                                  		; dx:ax = cylinder number, dx = 0, quotient
  6912                                  		; bx = remainder
  6913 000024C4 59                      	pop	cx
  6914 000024C5 09D2                    	or 	dx, dx
  6915 000024C7 75C9                    	jnz	short cnf_2 ; invalid
  6916 000024C9 3B85[9C6F]              	cmp	ax, [part_table_end_cyl+di]
  6917 000024CD 74C8                    	je	short cnf_3 ; same cylinder number
  6918 000024CF 72C1                    	jb	short cnf_2 ; invalid
  6919 000024D1 8985[9C6F]              	mov	[part_table_end_cyl+di], ax ; change it
  6920 000024D5 C3                      	retn
  6921                                  
  6922                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6923                                  ; sort partition table in (ending) cylinder number order
  6924                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6925                                  ; 25/10/2020 (fdisk3.s)
  6926                                  
  6927                                  	; 02/02/2019 (hdimage.s)
  6928                                  	
  6929                                  sort_partition_table:
  6930                                  
  6931                                  	; INPUT -> none
  6932                                  	; OUTPUT -> none
  6933                                  
  6934 000024D6 31DB                    	xor	bx, bx
  6935                                  	;jmp	short sortpt_2 ; 25/10/2020
  6936                                  sortpt_1:
  6937 000024D8 889F[246D]              	mov	[bx+sort], bl ; 0
  6938 000024DC FEC3                    	inc	bl
  6939                                  sortpt_2:
  6940 000024DE 80FB04                  	cmp	bl, 4 ; number of partition table entries to sort
  6941 000024E1 72F5                    	jb	short sortpt_1
  6942                                  
  6943                                  	; Do a bubble sort
  6944                                  
  6945 000024E3 EB04                    	jmp	short sortpt_4
  6946                                  sortpt_3:
  6947                                  	; Sort until we don't do a swap
  6948                                  
  6949 000024E5 08C9                    	or	cl, cl ; sort changed ?
  6950 000024E7 7450                    	jz	short sortpt_8 ; no
  6951                                  sortpt_4:
  6952 000024E9 30C9                    	xor	cl, cl
  6953                                  
  6954 000024EB B301                    	mov	bl, 1
  6955                                  
  6956 000024ED B212                    	mov	dl, 18  ; partition table structure size
  6957 000024EF EB07                    	jmp	short sortpt_6
  6958                                  sortpt_5:
  6959 000024F1 FEC3                    	inc	bl
  6960                                  
  6961 000024F3 80FB04                  	cmp	bl, 4
  6962 000024F6 73ED                    	jnb	short sortpt_3
  6963                                  
  6964                                  sortpt_6:
  6965 000024F8 8A87[246D]              	mov	al, [bx+sort]
  6966                                  
  6967 000024FC F6E2                    	mul	dl
  6968                                  
  6969 000024FE 89C6                    	mov	si, ax
  6970                                  
  6971 00002500 8BBC[9C6F]              	mov	di, [part_table_end_cyl+si]
  6972                                  
  6973 00002504 8A87[236D]              	mov	al, [bx+sort-1]
  6974                                  
  6975 00002508 F6E2                    	mul	dl ; * 18
  6976                                  
  6977 0000250A 97                      	xchg	di, ax
  6978                                  
  6979 0000250B 3985[9C6F]              	cmp	[part_table_end_cyl+di], ax ; previous > current
  6980 0000250F 771A                    	ja	short sortpt_7 ; swap order indicators
  6981                                  		; 31/10/2020
  6982                                  		; current end cyl >= previous end cyl
  6983                                  	; 31/10/2020
  6984 00002511 72DE                    	jb	short sortpt_5  
  6985                                  		; current end cyl > previous end cyl
  6986                                  	
  6987 00002513 21C0                    	and	ax, ax ; cylinder 0 ?
  6988 00002515 75DA                    	jnz	short sortpt_5 ; no
  6989                                  		; current end cyl = previous end cyl, cyl > 0
  6990                                  	
  6991                                  	; current end cyl = previous end cyl = 0
  6992                                  
  6993                                  	; If current entry is empty partition entry
  6994                                  	; and previous entry is not empty partition entry
  6995                                  	; swap them.
  6996                                  	;
  6997 00002517 8B85[A46F]              	mov	ax, [part_table_num_sec_hw+di] ; previous entry
  6998 0000251B 0B85[A26F]              	or	ax, [part_table_num_sec_lw+di]
  6999 0000251F 74D0                    	jz	short sortpt_5
  7000                                  
  7001 00002521 8B84[A46F]              	mov	ax, [part_table_num_sec_hw+si] ; current entry
  7002 00002525 0B84[A26F]              	or	ax, [part_table_num_sec_lw+si]
  7003 00002529 75C6                    	jnz	short sortpt_5
  7004                                  sortpt_7:
  7005                                  	; Swap the order indicators
  7006                                  
  7007 0000252B 8B87[236D]              	mov	ax, [bx+sort-1]
  7008 0000252F 86E0                    	xchg	ah, al
  7009 00002531 8987[236D]              	mov	[bx+sort-1], ax
  7010                                  
  7011 00002535 B101                    	mov	cl, 1 ; sort changed
  7012 00002537 EBB8                    	jmp	short sortpt_5
  7013                                  
  7014                                  sortpt_8:
  7015                                  	; 30/10/2020
  7016                                  	;mov 	byte [p_sorted], 1 ; 04/02/2019
  7017                                  
  7018 00002539 C3                      	retn
  7019                                  
  7020                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7021                                  ; find free space before/after/between partitions
  7022                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7023                                  ; 03/02/2019
  7024                                  
  7025                                  find_part_free_space:  ; find/calculate free space for partitions
  7026                                  	; 15/02/2019
  7027                                  
  7028                                  	; INPUT -> 
  7029                                  	;	AL = 0 -> calculate for primary/MBR partitions 
  7030                                  	;	AL = 5 -> calculate for extended partition
  7031                                  	; OUTPUT ->
  7032                                  	;	CX = the largest free space/cylinders (between partitions)
  7033                                  	;	AX = Free space index (gap number) - from 0 to 4 -
  7034                                  	;	BX = Free space structure offset (for the largest free space)
  7035                                  	;
  7036                                  	;	22/02/2019
  7037                                  	;	[freespace_count] = number of free spaces/gaps
  7038                                  
  7039 0000253A A2[3F6F]                	mov	[p_type], al
  7040                                  
  7041                                  	; Sort the partition table
  7042                                  
  7043 0000253D E896FF                  	call	sort_partition_table ; 16/02/2019
  7044                                  
  7045                                  	; Initialize free space to zero
  7046                                  
  7047                                  	; 15/02/2019
  7048 00002540 BF[2870]                	mov	di, fspc ; free_space.space
  7049 00002543 B92800                  	mov	cx, 5*8 ; (5*16/2)
  7050 00002546 31C0                    	xor	ax, ax ; 0
  7051 00002548 F3AB                    	rep	stosw
  7052                                  
  7053 0000254A A2[3C6F]                	mov	[freespace_count], al ; 0
  7054                                  	; 22/02/2019
  7055                                  	;mov	[last_found_partition], al ; 0
  7056                                  
  7057 0000254D A3[3A6F]                	mov	[_i_], ax ; 0
  7058                                  	;jmp	short fpfs_2
  7059                                  	; 31/10/020
  7060 00002550 EB0E                    	jmp	short fpfs_3
  7061                                  fpfs_1:	
  7062 00002552 FE06[3A6F]              	inc	byte [_i_]
  7063                                  ;;fpfs_2:
  7064 00002556 803E[3A6F]04            	cmp	byte [_i_], 4
  7065 0000255B 7203                    	jb	short fpfs_3
  7066 0000255D E97601                  	jmp	fpfs_13
  7067                                  fpfs_3:
  7068                                  	; Find space between start of disk and first partition
  7069                                  
  7070                                  	;mov	ax, [_i_]
  7071 00002560 8B1E[3A6F]              	mov	bx, [_i_] ; 31/10/2020
  7072                                  fpfs_2:
  7073                                  	;mov	bx, ax ; 31/10/2020
  7074                                  	;mov	al, [sort+bx]
  7075 00002564 8A8F[246D]              	mov	cl, [sort+bx] ; 15/02/2019
  7076                                  
  7077                                  	;mov	cl, 18 ; partition table structure size = 18 bytes
  7078 00002568 B012                    	mov	al, 18 ; 15/02/2019
  7079 0000256A F6E1                    	mul	cl
  7080 0000256C 89C3                    	mov	bx, ax
  7081                                  
  7082 0000256E 80BF[996F]00            	cmp	byte [part_table_sys_id+bx], 0
  7083 00002573 74DD                    	je	short fpfs_1
  7084                                  
  7085 00002575 880E[3E6F]              	mov	[last_found_partition], cl ; 15/02/2019
  7086                                  
  7087                                  	;xor	cx, cx
  7088 00002579 30C9                    	xor	cl, cl ; 0 	
  7089                                  	;mov	al, 1 ; LBA = 1 (after MBR) ; ah = 0
  7090                                  	; 03/11/2020
  7091 0000257B A0[7E3F]                	mov	al, [sectors] ; 63 or 17 ; 03/11/2020
  7092                                  
  7093 0000257E 803E[3F6F]05            	cmp	byte [p_type], 5  ; EXTENDED
  7094 00002583 7506                    	jne	short fpfs_4
  7095                                  
  7096                                  	; This is a special case - the extended partition can not start
  7097                                  	; on cylinder 0 due to its architecture. Protect against that here
  7098                                  
  7099                                  	; 13/02/2019
  7100                                  	; LBA value of free space start
  7101                                  	;mov	al, [sectors] ; 03/11/2020
  7102 00002585 F626[803F]              	mul	byte [heads]
  7103                                  		; ax = start sector (for Extended Partition)
  7104 00002589 FEC1                    	inc	cl ; 1  ; cx = start cylinder = 1
  7105                                  fpfs_4:
  7106                                  	; Found a partition, get the space
  7107                                  
  7108                                  	; 15/02/2019
  7109 0000258B 8B97[976F]              	mov	dx, [part_table_start_cyl+bx] 
  7110                                  		       ; Start cylinder of the 1st partition (as sorted)
  7111 0000258F 39CA                    	cmp	dx, cx ; (cx=0 for primary partition, cx=1 for extd partition)
  7112 00002591 0F86C300                	jna	fpfs_9 ; It is accepted as free (partition) space
  7113                                  		       ; if this space between masterboot sector and partition 1
  7114                                  		       ; has 1 cylinder (heads*spt) size at least.
  7115                                  	; 22/02/2019
  7116 00002595 31FF                    	xor	di, di  ; 0 ; Reset Free Space Table offset
  7117                                  
  7118 00002597 FE06[3C6F]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  7119                                  
  7120 0000259B 890E[2A70]              	mov	[free_space.start], cx ; 0 (for PP) or 1 (for EP)
  7121                                  	
  7122                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  7123                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  7124                                  	;	if new partition will be selected as a primary dos partition.
  7125                                  	;	(But, start sector -LBA- will not be changed 
  7126                                  	;	 if it is a non-dos or user input type partition.. unless
  7127                                  	;	 cylinder boundary alignment option is used.)
  7128                                  	 	
  7129 0000259F A3[3470]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  7130                                  					     ; or 1 (for PP)
  7131                                  	;mov	[free_space.startsector+2], 0
  7132                                  
  7133                                  	; free space ends before start of next valid partition
  7134 000025A2 89D0                    	mov	ax, dx	; start cylinder of partition 1 (as sorted)
  7135 000025A4 29CA                    	sub	dx, cx	; cylinder count of free space 1 (gap 1)
  7136 000025A6 48                      	dec	ax	; end cylinder of free space 1 (gap 1)
  7137 000025A7 A3[2C70]                	mov	[free_space.end], ax 
  7138 000025AA 8916[2870]              	mov	[free_space.space], dx
  7139                                  
  7140                                  	; save free space (1) as (non-aligned) sector count
  7141 000025AE 8B87[9E6F]              	mov	ax, [part_table_rel_sec_lw+bx]
  7142 000025B2 8B97[A06F]              	mov	dx, [part_table_rel_sec_hw+bx]
  7143 000025B6 2B06[3470]              	sub	ax, [free_space.startsector]
  7144 000025BA 83DA00                  	sbb	dx, 0
  7145 000025BD A3[3070]                	mov	[free_space.sectors_unused], ax
  7146 000025C0 8916[3270]              	mov	[free_space.sectors_unused+2], dx
  7147                                  
  7148                                  	;mov	ax, [free_space.space]
  7149                                  
  7150                                  	;call	cylinders_to_sectors
  7151                                  
  7152                                  	;mov	[free_space.sectors_unused], ax
  7153                                  	;mov	[free_space.sectors_unused+2], dx
  7154                                  
  7155 000025C4 8B0E[823F]              	mov	cx, [cylinders]		; Total (disk) cylinders -divisor-
  7156 000025C8 8B1E[2870]              	mov	bx, [free_space.space]	; Partition cylinders -dividend-
  7157                                  
  7158 000025CC E8F801                  	call	cylinders_to_percent
  7159                                  
  7160 000025CF A3[2E70]                	mov	[free_space.percent_unused], ax
  7161                                  
  7162                                  	; 15/02/2019
  7163                                  	;mov	bl, [_i_]
  7164                                  	;xor	bh, bh
  7165                                  	;mov	al, [sort+bx]
  7166                                  
  7167                                  	;mov	[last_found_partition], al
  7168                                  
  7169                                  	; 31/10/2020
  7170 000025D2 E98300                  	jmp	fpfs_9
  7171                                  
  7172                                  	; Look for space between the rest of the partitions
  7173                                  
  7174                                  fpfs_7:
  7175                                  	; ah = 0
  7176                                  	;mov	al, [_i_]
  7177                                  	;;cbw
  7178                                  	;mov	bx, ax
  7179                                  	; 22/02/2019
  7180 000025D5 8B1E[3A6F]              	mov	bx, [_i_]
  7181                                  
  7182                                  	; 15/02/2019
  7183                                  	;mov	al, [sort+bx]
  7184 000025D9 8A8F[246D]              	mov	cl, [sort+bx]
  7185                                  	;mov	bl, 18
  7186                                  	;mul	bl
  7187 000025DD B012                    	mov	al, 18
  7188 000025DF F6E1                    	mul	cl
  7189 000025E1 89C6                    	mov	si, ax
  7190                                  	
  7191 000025E3 80BC[996F]00            	cmp	byte [part_table_sys_id+si], 0
  7192 000025E8 746E                    	je	short fpfs_9
  7193                                  
  7194                                  	; 15/02/2019
  7195 000025EA 860E[3E6F]              	xchg	[last_found_partition], cl
  7196                                  
  7197                                  	; Check to see if more than one partition on a cylinder
  7198                                  	; If so, leave the space at zero */
  7199                                  
  7200                                  	; NOTE:
  7201                                  	; It is accepted as valid free (partition) space
  7202                                  	; if free space (gap) between partitions
  7203                                  	; has 1 cylinder (heads*spt) size at least.
  7204                                  
  7205 000025EE B012                    	mov	al, 18 ; Partition tables/data structure size = 18 bytes
  7206 000025F0 F6E1                    	mul	cl
  7207 000025F2 89C3                    	mov	bx, ax  ; ah = 0
  7208                                  
  7209 000025F4 8B97[9C6F]              	mov	dx, [part_table_end_cyl+bx]   ; end cyl. of previous partition 
  7210 000025F8 8B84[976F]              	mov	ax, [part_table_start_cyl+si] ; start cyl. of current partition
  7211                                  
  7212 000025FC 42                      	inc	dx  ; start cylinder of free space is after the end cylinder of
  7213                                  		    ; the previous partition (as sorted)
  7214                                  
  7215 000025FD 39D0                    	cmp	ax, dx ; and it must be before than the next partition (as sorted)
  7216 000025FF 7657                    	jna	short fpfs_9 ; je short fpfs_9
  7217                                  		
  7218                                  	; No, things are normal
  7219                                  	; Get space between the end of the last one and the start of the next one
  7220                                  
  7221                                  	; 22/02/2019
  7222                                  	;add	di, 16
  7223 00002601 8B3E[3C6F]              	mov	di, [freespace_count] 
  7224 00002605 C1E704                  	shl	di, 4	; * 16 ; next entry offset (in free space table)
  7225                                  
  7226 00002608 FE06[3C6F]              	inc	byte [freespace_count]
  7227                                  
  7228 0000260C 89C1                    	mov	cx, ax
  7229 0000260E 29D1                    	sub	cx, dx
  7230 00002610 48                      	dec	ax
  7231 00002611 8995[2A70]              	mov	[free_space.start+di], dx
  7232 00002615 8985[2C70]              	mov	[free_space.end+di], ax
  7233 00002619 898D[2870]              	mov	[free_space.space+di], cx
  7234                                  
  7235                                  	;mov	ax, [free_space.space+di]
  7236                                  	;call	cylinders_to_sectors
  7237                                  	;mov	[free_space.sectors_unused+di], ax
  7238                                  	;mov	[free_space.sectors_unused+2+di], dx
  7239                                  
  7240                                  	; calculate and save (non-aligned) free sector count between partitions
  7241                                  
  7242 0000261D 8B87[9E6F]              	mov	ax, [part_table_rel_sec_lw+bx]
  7243 00002621 8B97[A06F]              	mov	dx, [part_table_rel_sec_hw+bx]
  7244 00002625 0387[A26F]              	add	ax, [part_table_num_sec_lw+bx]
  7245 00002629 1397[A46F]              	adc	dx, [part_table_num_sec_hw+bx]
  7246                                  
  7247 0000262D 8B8C[9E6F]              	mov	cx, [part_table_rel_sec_lw+si]
  7248 00002631 8B9C[A06F]              	mov	bx, [part_table_rel_sec_hw+si]
  7249                                  
  7250 00002635 8985[3470]              	mov	[free_space.startsector+di], ax
  7251 00002639 8995[3670]              	mov	[free_space.startsector+2+di], dx
  7252                                  
  7253 0000263D 29C1                    	sub	cx, ax
  7254 0000263F 19D3                    	sbb	bx, dx
  7255                                  
  7256 00002641 898D[3070]              	mov	[free_space.sectors_unused+di], cx
  7257 00002645 899D[3270]              	mov	[free_space.sectors_unused+2+di], bx
  7258                                  
  7259                                  fpfs_8:
  7260                                  	; NOTE: Percentage is based on cylinder-boundary aligned partition size.
  7261                                  	; (total disk cylinders and partition's cylinder count are used for that)
  7262                                  
  7263 00002649 8B0E[823F]              	mov	cx, [cylinders] ; -divisor-
  7264 0000264D 8B9D[2870]              	mov	bx, [free_space.space+di] ; -dividend-
  7265 00002651 E87301                  	call	cylinders_to_percent
  7266                                  	
  7267 00002654 8985[2E70]              	mov	[free_space.percent_unused+di], ax
  7268                                  	
  7269                                  	; ah = 0
  7270                                  
  7271                                  	; 15/02/2019
  7272                                  	;mov	bl, [_i_]
  7273                                  	;xor	bh, bh
  7274                                  	;mov	al, [sort+bx]
  7275                                  	;	
  7276                                  	;mov	[last_found_partition], al
  7277                                  
  7278                                  fpfs_9:
  7279 00002658 FE06[3A6F]              	inc	byte [_i_]
  7280                                  fpfs_10:
  7281 0000265C 803E[3A6F]04            	cmp	byte [_i_], 4
  7282 00002661 7303                    	jnb	short fpfs_11
  7283                                  
  7284 00002663 E96FFF                  	jmp	fpfs_7
  7285                                  
  7286                                  fpfs_11:
  7287                                  	; Find the space between the last partition and the end of the disk
  7288                                  	; Make sure that freespace cannot become negative
  7289                                  
  7290 00002666 A0[3E6F]                	mov	al, [last_found_partition]
  7291 00002669 B112                    	mov	cl, 18  ; Partition table structure size = 18 bytes
  7292 0000266B F6E1                    	mul	cl
  7293 0000266D 89C3                    	mov	bx, ax
  7294 0000266F 8B0E[823F]              	mov	cx, [cylinders]
  7295 00002673 49                      	dec	cx ; 15/02/2019
  7296                                  		   ; (min. cylinder count = 1 for a valid/usable free space)
  7297 00002674 8B87[9C6F]              	mov	ax, [part_table_end_cyl+bx]
  7298                                  	;cmp	[part_table_end_cyl+bx], cx
  7299 00002678 39C8                    	cmp	ax, cx	; cx = end cylinder of the disk
  7300 0000267A 7203                    	jb	short fpfs_12
  7301 0000267C E9A400                  	jmp	fpfs_15
  7302                                  fpfs_12:
  7303                                  	; 22/02/2019
  7304 0000267F 8B3E[3C6F]              	mov	di, [freespace_count]
  7305 00002683 C1E704                  	shl	di, 4 ; * 16  ; next entry offset (in free space table)
  7306                                  
  7307 00002686 FE06[3C6F]              	inc	byte [freespace_count]
  7308                                  
  7309 0000268A 898D[2C70]              	mov	[free_space.end+di], cx	; end cyl. of free space 5 (gap 5)
  7310                                  	;mov	ax, [part_table_end_cyl+bx]
  7311                                  	
  7312                                  	;mov	dx, cx
  7313                                  	;sub	dx, ax
  7314                                  	;mov	[free_space.space+di], dx ; di = 4*16
  7315                                  	; 12/03/2021
  7316                                  	; ax = end cylinder of the last partition
  7317                                  	; cx = end cylinder of the disk
  7318 0000268E 29C1                    	sub	cx, ax
  7319 00002690 898D[2870]              	mov	[free_space.space+di], cx ; di = 4*16
  7320                                  
  7321 00002694 40                      	inc	ax
  7322 00002695 8985[2A70]              	mov	[free_space.start+di], ax
  7323                                  	
  7324                                  	;inc	cx ; [cylinders]
  7325                                  	;mov	ax, [free_space.space+si]
  7326                                  	;call	cylinders_to_sectors
  7327                                  	;mov	[free_space.sectors_unused+di], ax
  7328                                  	;mov	[free_space.sectors_unused+2+di], dx
  7329                                  
  7330                                  	; calculate and save (non-aligned) free sector count
  7331                                  
  7332                                  	; 22/02/2019
  7333 00002699 8B87[9E6F]              	mov	ax, [part_table_rel_sec_lw+bx]
  7334 0000269D 8B97[A06F]              	mov	dx, [part_table_rel_sec_hw+bx]
  7335 000026A1 0387[A26F]              	add	ax, [part_table_num_sec_lw+bx]
  7336 000026A5 1397[A46F]              	adc	dx, [part_table_num_sec_hw+bx]
  7337                                  
  7338 000026A9 8985[3470]              	mov	[free_space.startsector+di], ax
  7339 000026AD 8995[3670]              	mov	[free_space.startsector+2+di], dx
  7340                                  
  7341 000026B1 8B0E[5668]              	mov	cx, [total_sectors]
  7342 000026B5 8B1E[5868]              	mov	bx, [total_sectors+2]
  7343 000026B9 29C1                    	sub	cx, ax
  7344 000026BB 19D3                    	sbb	bx, dx
  7345 000026BD 898D[3070]              	mov	[free_space.sectors_unused+di], cx
  7346 000026C1 899D[3270]              	mov	[free_space.sectors_unused+2+di], bx
  7347                                  
  7348 000026C5 8B0E[823F]              	mov	cx, [cylinders]
  7349 000026C9 8B9D[2870]              	mov	bx, [free_space.space+di]
  7350 000026CD E8F700                  	call	cylinders_to_percent
  7351 000026D0 8985[2E70]              	mov	[free_space.percent_unused+di], ax
  7352 000026D4 EB4D                    	jmp	short fpfs_15
  7353                                  
  7354                                  fpfs_13:
  7355                                  	; No partitions found, show entire space as free
  7356                                  
  7357                                  	; 22/02/2019
  7358 000026D6 FE06[3C6F]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  7359                                  	
  7360                                  	; 15/02/2019
  7361                                  	;sub	ax, ax
  7362                                  	; ah = 0 ; 31/10/2020
  7363 000026DA 29D2                    	sub	dx, dx
  7364                                  
  7365                                  	;inc	al ; LBA = 1 (after MBR) ; ah = 0
  7366 000026DC B001                    	mov	al, 1 ; 25/02/2019
  7367                                  
  7368                                  	;This is a special case - the extended partition can not start
  7369                                  	;on cylinder 0 due to its architecture. Protect against that here
  7370                                  
  7371 000026DE 803E[3F6F]05            	cmp	byte [p_type], 5 ; EXTENDED
  7372 000026E3 7509                    	jne	short fpfs_14
  7373                                  		
  7374 000026E5 FEC2                    	inc	dl
  7375                                  
  7376                                  	; 15/02/2019
  7377                                  	; LBA value of free space start
  7378 000026E7 A0[7E3F]                	mov	al, [sectors]
  7379 000026EA F626[803F]              	mul	byte [heads]
  7380                                  		; ax = start sector (for Extended Partition)
  7381                                  fpfs_14:
  7382 000026EE 8916[2A70]              	mov	[free_space.start], dx ; 0 or 1
  7383                                  
  7384                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  7385                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  7386                                  	;	if new partition will be selected as a primary dos partition.
  7387                                  	 	
  7388 000026F2 A3[3470]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  7389                                  					     ; or 1 (for PP)
  7390                                  	;mov	[free_space.startsector+2], 0
  7391                                  
  7392 000026F5 A1[823F]                	mov	ax, [cylinders] ; disk capacity
  7393 000026F8 89C1                    	mov	cx, ax
  7394 000026FA 48                      	dec	ax
  7395 000026FB A3[2C70]                	mov	[free_space.end], ax
  7396 000026FE 29D0                    	sub	ax, dx
  7397 00002700 40                      	inc	ax
  7398 00002701 A3[2870]                	mov	[free_space.space], ax
  7399                                  
  7400 00002704 A1[5668]                	mov	ax, [total_sectors]
  7401 00002707 8B16[5868]              	mov	dx, [total_sectors+2]
  7402 0000270B 2B06[3470]              	sub	ax, [free_space.startsector]
  7403 0000270F 83DA00                  	sbb	dx, 0
  7404 00002712 A3[3070]                	mov	[free_space.sectors_unused], ax
  7405 00002715 8916[3270]              	mov	[free_space.sectors_unused+2], dx
  7406                                  
  7407                                  	;mov	cx, [cylinders] 
  7408 00002719 8B1E[2870]              	mov	bx, [free_space.space]
  7409 0000271D E8A700                  	call	cylinders_to_percent
  7410 00002720 A3[2E70]                	mov	[free_space.percent_unused], ax
  7411                                  
  7412                                  fpfs_15:
  7413                                  	; Find largest free space
  7414 00002723 29C9                    	sub	cx, cx
  7415                                  	; 22/02/2019
  7416 00002725 29C0                    	sub	ax, ax
  7417 00002727 31DB                    	xor	bx, bx
  7418 00002729 8A16[3C6F]              	mov	dl, [freespace_count]
  7419 0000272D 08D2                    	or	dl, dl
  7420 0000272F 7420                    	jz	short fpfs_19
  7421 00002731 8816[3A6F]              	mov	[_i_], dl
  7422                                  fpfs_16:
  7423 00002735 8B97[2870]              	mov	dx, [free_space.space+bx]
  7424 00002739 39CA                    	cmp	dx, cx
  7425 0000273B 7604                    	jbe	short fpfs_17
  7426                                  	; 22/02/2019
  7427 0000273D 89D1                    	mov	cx, dx ; Largest free space
  7428 0000273F 89D8                    	mov	ax, bx
  7429                                  fpfs_17:
  7430 00002741 FE0E[3A6F]              	dec	byte [_i_]
  7431 00002745 7405                    	jz	short fpfs_18
  7432                                  
  7433 00002747 83C310                  	add	bx, 16 ; Free space structure size
  7434 0000274A EBE9                    	jmp	short fpfs_16
  7435                                  fpfs_18:
  7436                                  	; 22/02/2019
  7437 0000274C 89C3                    	mov	bx, ax ; offset (from 0 to 64)
  7438 0000274E C0E804                  	shr	al, 4  ; index (from 0 to 4)
  7439                                  fpfs_19:
  7440 00002751 C3                      	retn
  7441                                  
  7442                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7443                                  ; find enough free space
  7444                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7445                                  
  7446                                  ;	; 15/02/2019
  7447                                  ;find_enough_free_space:
  7448                                  ;	; Find enough free space
  7449                                  ;	;
  7450                                  ;	; INPUT:
  7451                                  ;	;	AX = Requested space (in cylinders)
  7452                                  ;	;	22/02/2019
  7453                                  ;	;	[freespace_count] = number of free spaces/gaps
  7454                                  ;	; OUTPUT:
  7455                                  ;	;	AX = Available space
  7456                                  	;	DX = Requested space
  7457                                  ;	;	If CF = 0 -> AX >= DX
  7458                                  ;	;	If CF = 1 -> AX < DX
  7459                                  ;	;	CX = Index of available space in free space structure
  7460                                  ;	;	     (GAP number, 0 to 4) - if AX > 0 -
  7461                                  ;
  7462                                  ;	mov	dx, ax ; 22/02/2019
  7463                                  ;	sub	ax, ax
  7464                                  ;	xor	bx, bx
  7465                                  ;	; 22/02/2019
  7466                                  ;	mov	ch, [freespace_count]
  7467                                  ;	mov	[_i_], ax ; 0
  7468                                  ;	jmp	short fefs_1
  7469                                  ;fefs_0:
  7470                                  ;	;mov	al, 16
  7471                                  ;	;mul	byte [_i_]
  7472                                  ;	;mov	bx, ax
  7473                                  ;	mov	bl, [_i_]
  7474                                  ;	shl	bl, 4 ; * 16
  7475                                  ;fefs_1:
  7476                                  ;	mov	ax, [free_space.space+bx]
  7477                                  ;	and	ax, ax
  7478                                  ;	jz	short fefs_2 ; not a free space
  7479                                  ;	mov	cl, [_i_] 
  7480                                  ;	cmp	ax, dx
  7481                                  ;	jnb	short fefs_3 ; enough space
  7482                                  ;fefs_2:
  7483                                  ;	; 22/02/2019
  7484                                  ;	inc	byte [_i_]
  7485                                  ;	cmp	byte [_i_], ch	
  7486                                  ;	jb	short fefs_0
  7487                                  ;	sub	ch, ch
  7488                                  ;	stc
  7489                                  ;	retn
  7490                                  ;fefs_3:
  7491                                  ;	xor	ch, ch
  7492                                  ;	retn
  7493                                  
  7494                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7495                                  ; find enough free sectors
  7496                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7497                                  
  7498                                  	; 15/02/2019
  7499                                  find_enough_free_sectors:
  7500                                  	; Find (first) enough free space in sectors
  7501                                  	;
  7502                                  	; INPUT:
  7503                                  	;	DX:AX = Requested space (as non-aligned free sectors)
  7504                                  	;	22/02/2019
  7505                                  	;	[freespace_count] = number of free spaces/gaps
  7506                                  	; OUTPUT:
  7507                                  	;	DX:AX = Available space
  7508                                  	;	If CF = 0 -> DX:AX >= Request
  7509                                  	;	If CF = 1 -> DX:AX < Request
  7510                                  	;	CX = Index of available space in free space structure
  7511                                  	;	     (GAP number, 0 to 4) - if DX:AX > 0 -
  7512                                  
  7513 00002752 31FF                    	xor	di, di
  7514 00002754 31F6                    	xor	si, si
  7515 00002756 31DB                    	xor	bx, bx
  7516                                  	; 22/02/2019
  7517 00002758 8A2E[3C6F]              	mov	ch, [freespace_count]
  7518 0000275C 891E[3A6F]              	mov	[_i_], bx ; 0
  7519 00002760 EB07                    	jmp	short fefss_1
  7520                                  fefss_0:
  7521                                  	;mov	al, 16
  7522                                  	;mul	byte [_i_]
  7523                                  	;mov	bx, ax
  7524 00002762 8B1E[3A6F]              	mov	bx, [_i_]
  7525 00002766 C0E304                  	shl	bl, 4 ; * 16
  7526                                  fefss_1:
  7527 00002769 81C3[3070]              	add	bx, free_space.sectors_unused
  7528 0000276D 3B5702                  	cmp	dx, [bx+2]
  7529 00002770 7230                    	jb	short fefss_7
  7530 00002772 7706                    	ja	short fefss_2
  7531 00002774 3B07                    	cmp	ax, [bx]
  7532 00002776 742F                    	je	short fefss_8
  7533 00002778 7228                    	jb	short fefss_7 ; 18/02/2019
  7534                                  fefss_2:
  7535                                  	; 30/10/2020
  7536                                  	;cmp	word [bx], 0
  7537                                  	;jne	short fefss_3
  7538                                  	;cmp	word [bx+2], 0
  7539                                  	;je	short fefss_6	
  7540                                  fefss_3:
  7541 0000277A 3B7F02                  	cmp	di, [bx+2]
  7542 0000277D 7711                    	ja	short fefss_6
  7543 0000277F 7405                    	je	short fefss_4
  7544 00002781 8B7F02                  	mov	di, [bx+2]
  7545 00002784 EB04                    	jmp	short fefss_5
  7546                                  fefss_4:
  7547 00002786 3B37                    	cmp	si, [bx]
  7548 00002788 7306                    	jnb	short fefss_6
  7549                                  fefss_5:
  7550 0000278A 8B37                    	mov	si, [bx]
  7551                                  	; 22/02/2019
  7552 0000278C 8A0E[3A6F]              	mov	cl, [_i_]
  7553                                  fefss_6:
  7554 00002790 FE06[3A6F]              	inc	byte [_i_]
  7555 00002794 382E[3A6F]              	cmp	byte [_i_], ch ; [freespace_count]
  7556 00002798 72C8                    	jb	short fefss_0
  7557                                  	
  7558 0000279A 89F0                    	mov	ax, si
  7559 0000279C 89FA                    	mov	dx, di
  7560 0000279E 30ED                    	xor	ch, ch
  7561 000027A0 F9                      	stc
  7562 000027A1 C3                      	retn
  7563                                  fefss_7:
  7564 000027A2 8B07                    	mov	ax, [bx]
  7565 000027A4 8B5702                  	mov	dx, [bx+2]
  7566                                  fefss_8:
  7567 000027A7 8B0E[3A6F]              	mov	cx, [_i_]
  7568 000027AB C3                      	retn
  7569                                  
  7570                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7571                                  ; get first free partition table entry
  7572                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7573                                  
  7574                                  	; 16/02/2019
  7575                                  get_first_free_pte:
  7576                                  	; Find free partition table entry
  7577                                  	;
  7578                                  	; INPUT:
  7579                                  	;	none
  7580                                  	; OUTPUT:
  7581                                  	;	If CF = 0 -> CX = partition table entry number
  7582                                  	;	If CF = 1 -> there is not a free entry in partition table
  7583                                  
  7584 000027AC BE[B857]                	mov	si, MasterBootBuff+pTableOffset
  7585 000027AF 31C9                    	xor	cx, cx
  7586                                  gffp_1:
  7587 000027B1 8A4404                  	mov	al, [si+ptFileSystemID] ; 23/02/2019
  7588                                  
  7589 000027B4 20C0                    	and	al, al
  7590 000027B6 740E                    	jz	short gffp_3 ; empty
  7591                                  
  7592 000027B8 80F903                  	cmp	cl, 3
  7593 000027BB 7307                    	jnb	short gffp_2
  7594                                  
  7595 000027BD FEC1                    	inc	cl
  7596 000027BF 83C610                  	add	si, 16 ; Partition table entry size
  7597 000027C2 EBED                    	jmp	short gffp_1
  7598                                  gffp_2:
  7599                                  	; CL = 3
  7600 000027C4 F9                      	stc
  7601 000027C5 C3                      	retn
  7602                                  gffp_3:
  7603                                  	; CL = PTE number (0 to 3)
  7604 000027C6 C3                      	retn 	
  7605                                  
  7606                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7607                                  ; convert cylinder count to sectors
  7608                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7609                                  ; 03/02/2019
  7610                                  
  7611                                  	; 15/03/2021
  7612                                  ;cylinders_to_sectors:
  7613                                  	; INPUT:
  7614                                  	;	ax = Cylinders (Total or partition's cylinder count)
  7615                                  	; OUTPUT:
  7616                                  	;	dx:ax = Sectors
  7617                                  
  7618                                  	;;mov	dx, [heads]
  7619                                  	;;mul	dx
  7620                                  	;; 30/10/2020
  7621                                  	;mul	word [heads]	
  7622                                  	;; dx:ax = Number of tracks (cylinders*heads)
  7623                                  	;mov	cx, [sectors]
  7624                                  	;call	mul32
  7625                                  	;	; dx:ax = Number of sectors 
  7626                                  	;retn
  7627                                  		
  7628                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7629                                  ; convert cylinder count to percent of disk size (total cylinders)
  7630                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7631                                  ; 03/02/2019
  7632                                  
  7633                                  cylinders_to_percent:
  7634                                  
  7635                                  	; INPUT:
  7636                                  	;	bx = Number of cylinders (of partition) -dividend-
  7637                                  	;	cx = Total cylinders -divisor-
  7638                                  	; OUTPUT:
  7639                                  	;	ax = Percentage
  7640                                  
  7641                                  	;  if (cylinders_in == 0)
  7642                                  	;	 percentage_out = 0;
  7643                                  	;  else if (total_cylinders == 0)
  7644                                  	;           percentage_out = 0;
  7645                                  	;       else
  7646                                  
  7647 000027C7 09DB                    	or	bx, bx
  7648 000027C9 741B                    	jz	short ctpc_6 ; ax = 0 = percentage_out 
  7649                                  ctpc_1:
  7650 000027CB 09C9                    	or	cx, cx
  7651 000027CD 7417                    	jz	short ctpc_6
  7652                                  
  7653 000027CF B86400                  	mov	ax, 100
  7654 000027D2 F7E3                    	mul	bx ; [cylinders_in]
  7655                                  
  7656                                  		; dx:ax = Dividend
  7657                                  
  7658 000027D4 E8A6E4                  	call	div32 ; 100*cylinders_in / total_cylinders
  7659                                  		; DX:AX = Quotient
  7660                                  		; BX = Remainder
  7661                                  
  7662                                  	; ax = percentage_out
  7663                                  
  7664                                  	; 12/03/2021
  7665 000027D7 D1E9                    	shr	cx, 1
  7666                                  
  7667 000027D9 39CB                    	cmp	bx, cx	; is remainder >= total_cylinders/2 ?
  7668 000027DB 7201                    	jb	short ctpc_5 ; No. 
  7669                                  ctpc_4:
  7670 000027DD 40                      	inc	ax
  7671                                  ctpc_5:
  7672 000027DE 83F864                  	cmp	ax, 100
  7673 000027E1 7603                    	jbe	short ctpc_6
  7674 000027E3 B86400                  	mov	ax, 100
  7675                                  ctpc_6:
  7676 000027E6 C3                      	retn
  7677                                  
  7678                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7679                                  ; display partition table
  7680                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7681                                  ; 04/02/2019
  7682                                  
  7683                                  	; 12/03/2021
  7684                                  display_partition_table_x:
  7685 000027E7 B005                    	mov	al, 5 ; display extended partition table
  7686 000027E9 EB02                    	jmp	short dpt_x
  7687                                  
  7688                                  display_partition_table:
  7689                                  
  7690                                  	; INPUT:
  7691                                  	;	al = 0 for MBR
  7692                                  	;	   = 5 for EBR (logical drives in extended partition)
  7693                                  	; OUTPUT:
  7694                                  	;	none
  7695                                  
  7696                                  	; 12/03/2021
  7697 000027EB 30C0                    	xor	al, al ; display primary partition table
  7698                                  dpt_x:
  7699                                  ;pt_positions:
  7700                                  n_pos	equ 30 ; 1 byte	
  7701                                  
  7702 000027ED A2[406F]                	mov	[_e_], al	
  7703                                  
  7704                                  	; clear screen
  7705 000027F0 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  7706 000027F3 CD10                    	int	10h
  7707                                  
  7708 000027F5 803E[406F]05            	cmp	byte [_e_], 5
  7709 000027FA 7507                    	jne	short dpt_1
  7710                                  dpt_0:
  7711 000027FC BD[E06F]                	mov	bp, ext_table_boot_ind
  7712 000027FF B045                    	mov	al, 'E'
  7713 00002801 EB05                    	jmp	short dpt_4
  7714                                  dpt_1:
  7715 00002803 BD[946F]                	mov	bp, part_table_boot_ind
  7716 00002806 B04D                    	mov	al, 'M'
  7717                                  dpt_4:
  7718 00002808 BE[5458]                	mov	si, p_table_header
  7719 0000280B 88441E                  	mov	[si+n_pos], al
  7720 0000280E E881F3                         	call 	print_msg
  7721                                     
  7722 00002811 31DB                    	xor	bx, bx
  7723 00002813 891E[3A6F]              	mov	[_i_], bx
  7724                                  dpt_5:
  7725 00002817 FE06[3A6F]              	inc	byte [_i_]
  7726                                  
  7727                                  	; BX = partition entry (0 to 3)
  7728                                  	; BP = partition table structure address
  7729                                  
  7730 0000281B E86600                  	call	display_pt_entry  ; display partition table row
  7731                                  
  7732 0000281E 8B1E[3A6F]              	mov	bx, [_i_] 
  7733                                  	
  7734 00002822 80FB04                  	cmp	bl, 4
  7735 00002825 72F0                    	jb	short dpt_5
  7736                                  
  7737 00002827 BE[9559]                	mov	si, p_table_footer
  7738 0000282A E865F3                         	call 	print_msg
  7739                                  
  7740                                  	; 27/02/2019
  7741 0000282D BF[AB55]                	mov	di, str_disk_sectors
  7742                                  
  7743 00002830 803E[406F]05            	cmp	byte [_e_], 5
  7744 00002835 741D                    	je	short dpt_9 
  7745                                  
  7746                                  	; display total disk sectors
  7747                                  
  7748                                  	;mov	di, str_disk_sectors
  7749                                  
  7750                                  	;cmp	byte [di], '0'
  7751                                  	;jnb	short dpt_8
  7752                                  
  7753 00002837 A1[5668]                        mov	ax, [total_sectors]
  7754 0000283A 8B16[5868]                      mov	dx, [total_sectors+2]
  7755                                  
  7756 0000283E E82200                  	call	dpt_10
  7757                                  dpt_8:
  7758 00002841 BE[9555]                	mov	si, msg_disk_sectors
  7759                                  dpt_11:
  7760 00002844 E84BF3                  	call	print_msg
  7761                                  
  7762 00002847 BE[AB55]                	mov	si, str_disk_sectors
  7763 0000284A E845F3                  	call	print_msg
  7764                                  
  7765 0000284D BE[7F55]                	mov	si, CRLF
  7766 00002850 E83FF3                  	call	print_msg
  7767                                  
  7768 00002853 C3                      	retn
  7769                                  
  7770                                  dpt_9:
  7771                                  	; display extended partition size
  7772                                  
  7773 00002854 A1[326F]                	mov	ax, [ep_Size]
  7774 00002857 8B16[346F]                      mov	dx, [ep_Size+2]
  7775                                  
  7776 0000285B E80500                  	call	dpt_10
  7777                                  
  7778 0000285E BE[B655]                	mov	si, msg_ep_size
  7779 00002861 EBE1                    	jmp	short dpt_11
  7780                                  
  7781                                  dpt_10:
  7782 00002863 89E6                    	mov	si, sp
  7783 00002865 B90A00                  	mov	cx, 10
  7784                                  dpt_6:
  7785 00002868 E812E4                  	call	div32
  7786                                  	
  7787 0000286B 80C330                  	add	bl, '0'
  7788 0000286E 53                      	push	bx
  7789 0000286F 21C0                    	and	ax, ax
  7790 00002871 75F5                    	jnz	short dpt_6
  7791 00002873 21D2                    	and	dx, dx
  7792 00002875 75F1                    	jnz	short dpt_6
  7793                                  
  7794 00002877 29E6                    	sub	si, sp
  7795 00002879 D1EE                    	shr	si, 1
  7796                                  dpt_7:
  7797 0000287B 58                      	pop	ax
  7798 0000287C AA                      	stosb
  7799 0000287D 4E                      	dec	si
  7800 0000287E 75FB                    	jnz	short dpt_7
  7801                                  
  7802 00002880 30C0                    	xor	al, al
  7803 00002882 AA                      	stosb
  7804                                  
  7805                                  	; 27/02/2019
  7806 00002883 C3                      	retn
  7807                                  
  7808                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7809                                  ; display partition table entry/row
  7810                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7811                                  ; 04/02/2019
  7812                                  
  7813                                  struc ptbl
  7814                                  
  7815 00000000 ??                      .boot_ind:	resb 1
  7816 00000001 ??                      .start_head:	resb 1
  7817 00000002 ??                      .start_sector:	resb 1
  7818 00000003 ????                    .start_cyl:	resw 1
  7819 00000005 ??                      .sys_id:	resb 1
  7820 00000006 ??                      .end_head:	resb 1
  7821 00000007 ??                      .end_sector:	resb 1
  7822 00000008 ????                    .end_cyl:	resw 1
  7823 0000000A ????                    .rel_sec_lw:	resw 1
  7824 0000000C ????                    .rel_sec_hw:	resw 1
  7825 0000000E ????                    .num_sec_lw:	resw 1
  7826 00000010 ????                    .num_sec_hw:	resw 1
  7827                                  .size:
  7828                                  
  7829                                  endstruc
  7830                                  
  7831                                  display_pt_entry:
  7832                                  	; 24/10/2020 (fdisk3.s)
  7833                                  
  7834                                  	; INPUT:
  7835                                  	;	bl = partition entry
  7836                                  	;	bh = 0
  7837                                  	;	bp = partition table structure address
  7838                                  	; OUTPUT:
  7839                                  	;	none
  7840                                  
  7841                                  ; 24/10/2020 (fdisk3.s)
  7842                                  ;pt_positions:
  7843                                  p_pos	equ 3  ; 1 byte
  7844                                  s_pos	equ 6  ; 2+1 byte
  7845                                  bh_pos	equ 10 ; 2+1 bytes
  7846                                  bs_pos	equ 14 ; 2+1 bytes
  7847                                  bc_pos	equ 18 ; 2+1 bytes
  7848                                  fs_pos  equ 22 ; 2+1 bytes
  7849                                  eh_pos  equ 26 ; 2+1 bytes
  7850                                  es_pos	equ 30 ; 2+1 bytes
  7851                                  ec_pos	equ 34 ; 2+1 bytes
  7852                                  rs_pos	equ 42 ; 10 bytes
  7853                                  ns_pos	equ 53 ; 10 bytes
  7854                                  fsx_pos equ 64 ; 14 bytes
  7855                                  
  7856                                  ; 2019-2020 (hdimage.s)
  7857                                  ;;pt_positions:
  7858                                  ;p_pos	equ 7  ; 1 byte
  7859                                  ;s_pos	equ 9  ; 2+1 byte
  7860                                  ;bh_pos	equ 13 ; 2+1 bytes
  7861                                  ;bs_pos	equ 17 ; 2+1 bytes
  7862                                  ;bc_pos	equ 21 ; 2+1 bytes
  7863                                  ;fs_pos equ 25 ; 2+1 bytes
  7864                                  ;eh_pos equ 29 ; 2+1 bytes
  7865                                  ;es_pos	equ 33 ; 2+1 bytes
  7866                                  ;ec_pos	equ 37 ; 2+1 bytes
  7867                                  ;rs_pos	equ 42 ; 7 bytes
  7868                                  ;ns_pos	equ 52 ; 7 bytes
  7869                                  ;fsx_pos equ 61 ; 14 bytes
  7870                                  
  7871 00002884 55                      	push	 bp ; 23/02/2019
  7872                                  
  7873 00002885 08DB                    	or	bl, bl
  7874 00002887 7406                    	jz	short dpte_0
  7875                                  
  7876                                  	;xor	bh, bh
  7877 00002889 B012                    	mov	al, ptbl.size ; 18
  7878 0000288B F6E3                    	mul	bl
  7879 0000288D 01C5                    	add	bp, ax
  7880                                  dpte_0:
  7881 0000288F 807E0500                	cmp	byte [bp+ptbl.sys_id], 0
  7882 00002893 0F861801                	jna	dpte_9
  7883                                  
  7884 00002897 B768                    	mov	bh, 'h'
  7885                                  
  7886 00002899 BE[426F]                	mov	si, pte_row
  7887                                  
  7888                                  	; clear partition table display buffer/row
  7889 0000289C 89F7                    	mov	di, si
  7890 0000289E B92800                  	mov	cx, 40
  7891 000028A1 B82020                  	mov	ax, 2020h
  7892 000028A4 F3AB                    	rep	stosw
  7893                                  
  7894 000028A6 88D8                    	mov	al, bl
  7895 000028A8 0431                    	add	al, '1'
  7896 000028AA 884403                  	mov	[si+p_pos], al  ; partition number '1' to '4'
  7897                                  
  7898                                  	; partition status, type and CHS parameters
  7899                                  	; (as hexadecimal number)
  7900                                  
  7901                                  	;mov	al, [bp+ptbl.boot_ind]
  7902 000028AD 8A4600                  	mov	al, [bp]
  7903 000028B0 E8B5F3                  	call	byte_to_hex
  7904                                  
  7905 000028B3 894406                  	mov	[si+s_pos], ax
  7906 000028B6 887C08                  	mov	[si+s_pos+2], bh ; 'h'
  7907                                  
  7908 000028B9 8A4601                  	mov	al, [bp+ptbl.start_head]
  7909 000028BC E8A9F3                  	call	byte_to_hex
  7910                                  
  7911 000028BF 89440A                  	mov	[si+bh_pos], ax
  7912 000028C2 887C0C                  	mov	[si+bh_pos+2], bh ; 'h'
  7913                                  
  7914 000028C5 8B4E03                  	mov	cx, [bp+ptbl.start_cyl]
  7915                                  	; 28/10/2020
  7916 000028C8 81F9FF03                	cmp	cx, 1023
  7917 000028CC 7603                    	jna	short dpte_10 ; cyl number is in CHS limit
  7918 000028CE B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  7919                                  			 ; to correct display PTE (CHS bytes)
  7920                                  dpte_10:
  7921 000028D1 C0E506                  	shl	ch, 6
  7922 000028D4 8A4602                  	mov	al, [bp+ptbl.start_sector]
  7923 000028D7 08E8                    	or	al, ch
  7924 000028D9 E88CF3                  	call	byte_to_hex
  7925                                  
  7926 000028DC 89440E                  	mov	[si+bs_pos], ax
  7927 000028DF 887C10                  	mov	[si+bs_pos+2], bh ; 'h'
  7928                                  
  7929                                  	;mov	al, [bp+ptbl.start_cyl]
  7930 000028E2 88C8                    	mov	al, cl
  7931 000028E4 E881F3                  	call	byte_to_hex
  7932                                  
  7933 000028E7 894412                  	mov	[si+bc_pos], ax
  7934 000028EA 887C14                  	mov	[si+bc_pos+2], bh ; 'h'
  7935                                  
  7936 000028ED 8A4605                  	mov	al, [bp+ptbl.sys_id]
  7937 000028F0 E875F3                  	call	byte_to_hex
  7938                                  
  7939 000028F3 894416                  	mov	[si+fs_pos], ax
  7940 000028F6 887C18                  	mov	[si+fs_pos+2], bh ; 'h'
  7941                                  
  7942 000028F9 8A4606                  	mov	al, [bp+ptbl.end_head]
  7943 000028FC E869F3                  	call	byte_to_hex
  7944                                  
  7945 000028FF 89441A                  	mov	[si+eh_pos], ax
  7946 00002902 887C1C                  	mov	[si+eh_pos+2], bh ; 'h'
  7947                                  
  7948 00002905 8B4E08                  	mov	cx, [bp+ptbl.end_cyl]
  7949                                  	; 28/10/2020
  7950 00002908 81F9FF03                	cmp	cx, 1023
  7951 0000290C 7603                    	jna	short dpte_11 ; cyl number is in CHS limit
  7952 0000290E B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  7953                                  			 ; to correct display PTE (CHS bytes)
  7954                                  dpte_11:
  7955 00002911 C0E506                  	shl	ch, 6
  7956 00002914 8A4607                  	mov	al, [bp+ptbl.end_sector]
  7957 00002917 08E8                    	or	al, ch
  7958 00002919 E84CF3                  	call	byte_to_hex
  7959                                  
  7960 0000291C 89441E                  	mov	[si+es_pos], ax
  7961 0000291F 887C20                  	mov	[si+es_pos+2], bh ; 'h'
  7962                                  
  7963                                  	;mov	al, [bp+ptbl.end_cyl]
  7964 00002922 88C8                    	mov	al, cl
  7965 00002924 E841F3                  	call	byte_to_hex
  7966                                  
  7967 00002927 894422                  	mov	[si+ec_pos], ax
  7968 0000292A 887C24                  	mov	[si+ec_pos+2], bh ; 'h'
  7969                                  
  7970                                  	; relative (start) sector address (lba)
  7971                                  	; (as decimal number)
  7972                                  
  7973 0000292D 8B460A                          mov	ax, [bp+ptbl.rel_sec_lw]
  7974 00002930 8B560C                          mov	dx, [bp+ptbl.rel_sec_hw]
  7975                                  
  7976 00002933 89E7                    	mov	di, sp
  7977 00002935 B90A00                  	mov	cx, 10
  7978                                  dpte_1:
  7979 00002938 E842E3                  	call	div32
  7980                                  	
  7981 0000293B 80C330                  	add	bl, '0'
  7982 0000293E 53                      	push	bx
  7983 0000293F 21C0                    	and	ax, ax
  7984 00002941 75F5                    	jnz	short dpte_1
  7985 00002943 21D2                    	and	dx, dx
  7986 00002945 75F1                    	jnz	short dpte_1
  7987                                  
  7988 00002947 8D5C31                  	lea	bx, [si+rs_pos+7]
  7989                                  
  7990 0000294A 29E7                    	sub	di, sp
  7991 0000294C D1EF                    	shr	di, 1
  7992 0000294E 29FB                    	sub	bx, di	
  7993                                  dpte_2:
  7994 00002950 58                      	pop	ax
  7995 00002951 8807                    	mov	[bx], al
  7996 00002953 4F                      	dec	di
  7997 00002954 7403                    	jz	short dpte_3
  7998                                  	
  7999 00002956 43                      	inc	bx
  8000 00002957 EBF7                    	jmp	short dpte_2
  8001                                  
  8002                                  dpte_3:
  8003                                  	; number of sectors)
  8004                                  	; (as decimal number)
  8005                                  
  8006 00002959 8B460E                          mov	ax, [bp+ptbl.num_sec_lw]
  8007 0000295C 8B5610                          mov	dx, [bp+ptbl.num_sec_hw]
  8008                                  
  8009 0000295F 89E7                    	mov	di, sp
  8010                                  	;mov	cx, 10
  8011                                  dpte_4:
  8012 00002961 E819E3                  	call	div32
  8013                                  	
  8014 00002964 80C330                  	add	bl, '0'
  8015 00002967 53                      	push	bx
  8016 00002968 21C0                    	and	ax, ax
  8017 0000296A 75F5                    	jnz	short dpte_4
  8018 0000296C 21D2                    	and	dx, dx
  8019 0000296E 75F1                    	jnz	short dpte_4
  8020                                  
  8021 00002970 8D5C3C                  	lea	bx, [si+ns_pos+7]
  8022                                  
  8023 00002973 29E7                    	sub	di, sp
  8024 00002975 D1EF                    	shr	di, 1
  8025 00002977 29FB                    	sub	bx, di	
  8026                                  dpte_5:
  8027 00002979 58                      	pop	ax
  8028 0000297A 8807                    	mov	[bx], al
  8029 0000297C 4F                      	dec	di
  8030 0000297D 7403                    	jz	short dpte_6
  8031                                  	
  8032 0000297F 43                      	inc	bx
  8033 00002980 EBF7                    	jmp	short dpte_5
  8034                                  dpte_6:
  8035                                  	; set file system name
  8036                                  
  8037 00002982 8A4605                  	mov	al, [bp+ptbl.sys_id]
  8038 00002985 BF[9E40]                	mov	di, valid_partitions
  8039 00002988 B91300                  	mov	cx, 19
  8040 0000298B F2AE                    	repnz	scasb
  8041 0000298D 7405                    	jz	short dpte_7
  8042 0000298F B8[9040]                	mov	ax, FS_OTHERS
  8043 00002992 EB0C                    	jmp	short dpte_8
  8044                                  dpte_7:
  8045 00002994 81EF[9F40]              	sub	di, valid_partitions + 1
  8046 00002998 B80E00                  	mov	ax, 14
  8047 0000299B F7E7                    	mul	di
  8048 0000299D 05[863F]                	add	ax, FileSys_Names
  8049                                  dpte_8:
  8050 000029A0 8D7C40                  	lea	di, [si+fsx_pos]
  8051 000029A3 89C6                    	mov	si, ax
  8052 000029A5 B107                    	mov	cl, 7
  8053 000029A7 F3A5                    	rep	movsw
  8054                                  
  8055 000029A9 BE[426F]                	mov	si, pte_row
  8056 000029AC E8E3F1                  	call	print_msg
  8057                                  dpte_9:
  8058 000029AF 5D                      	pop	bp ; 23/02/2019
  8059                                  	
  8060 000029B0 C3                      	retn
  8061                                  
  8062                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8063                                  ; fix partition table
  8064                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8065                                  ; 24/02/2019
  8066                                  
  8067                                  partition_table_fix:
  8068                                  	; DELETE or EXIT option for Invalid Partition Table Entry
  8069                                  	; INPUT: 
  8070                                  	;	DS:SI = PTE address in MBR buffer
  8071                                  	
  8072 000029B1 56                      	push	si  ; save PTE address
  8073                                  
  8074 000029B2 89F0                    	mov	ax, si
  8075 000029B4 2D[B857]                	sub	ax, MasterBootBuff+446
  8076 000029B7 C0E804                  	shr	al, 4 ; / 16 
  8077 000029BA 0431                    	add	al, '1'
  8078 000029BC A2[B65E]                	mov	[inv_pte_num], al
  8079                                  
  8080                                  	; DS:SI = PTE address in MBR buffer
  8081 000029BF E85EF7                  	call	show_selected_partition
  8082                                  
  8083                                  	;mov	si, CRLF
  8084                                  	;call	print_msg
  8085                                  
  8086                                  	; Warning message...
  8087                                  
  8088 000029C2 BE[925E]                	mov	si, msg_inv_pte
  8089 000029C5 E8CAF1                  	call	print_msg
  8090                                  
  8091 000029C8 5F                      	pop	di  ; restore PTE address
  8092                                  ptf_0:	
  8093 000029C9 30E4                    	xor	ah, ah
  8094 000029CB CD16                    	int	16h
  8095                                  
  8096 000029CD 3C0D                    	cmp	al, 13
  8097 000029CF 7406                    	je	short ptf_1
  8098                                  
  8099 000029D1 3C1B                    	cmp	al, 27
  8100 000029D3 75F4                    	jne	short ptf_0
  8101                                  
  8102 000029D5 F9                      	stc
  8103 000029D6 C3                      	retn
  8104                                  ptf_1:
  8105                                  	; Clear that (invalid) PTE
  8106 000029D7 31C0                    	xor	ax, ax	
  8107 000029D9 B90800                  	mov	cx, 8
  8108 000029DC F3AB                    	rep	stosw
  8109                                  
  8110                                  	; Clear screen
  8111 000029DE B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  8112 000029E1 CD10                    	int	10h
  8113                                  
  8114 000029E3 C3                      	retn
  8115                                  
  8116                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8117                                  ; display (& edit) EXTENDED (DOS) partition table
  8118                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8119                                  ; 28/02/2019
  8120                                  
  8121                                  display_extended_pt:
  8122                                  	;mov	al, 5 ; extended partition (logical drives)
  8123                                  	;call	display_partition_table
  8124                                  	; 12/03/2021
  8125 000029E4 E800FE                  	call	display_partition_table_x
  8126                                  
  8127 000029E7 BE[8A60]                	mov	si, ebr_editing_options
  8128 000029EA E8A5F1                  	call	print_msg
  8129                                  
  8130 000029ED BE[3F5D]                	mov	si, enter_opt_num_cancel_msg
  8131 000029F0 E89FF1                  	call	print_msg
  8132                                  
  8133 000029F3 BE[7F55]                	mov	si, CRLF
  8134 000029F6 E899F1                  	call	print_msg
  8135                                  dept_1:
  8136 000029F9 30E4                    	xor	ah, ah
  8137 000029FB CD16                    	int	16h
  8138                                  
  8139 000029FD 3C30                    	cmp	al, '0'
  8140 000029FF 740C                    	je	short dept_2
  8141                                  
  8142 00002A01 3C31                    	cmp	al, '1'
  8143 00002A03 7464                    	je	short edit_ext_table_create
  8144 00002A05 3C32                    	cmp	al, '2'
  8145 00002A07 7407                    	je	short edit_ext_table_delete
  8146                                  		
  8147 00002A09 3C1B                    	cmp	al, 27 ; ESCape
  8148 00002A0B 75EC                    	jne	short dept_1
  8149                                  dept_2:
  8150 00002A0D E9F7D9                  	jmp	A_42
  8151                                  
  8152                                  edit_ext_table_delete:
  8153                                  	; 28/02/2019
  8154                                  	;mov	al, 5 ; extended partition (logical drives)
  8155                                  	;call	display_partition_table
  8156                                  	; 12/03/2021
  8157 00002A10 E8D4FD                  	call	display_partition_table_x
  8158                                  
  8159 00002A13 BE[0961]                	mov	si, msg_delete_ldd_q
  8160 00002A16 E879F1                  	call	print_msg
  8161                                  
  8162                                  	;mov	si, CRLF
  8163                                  	;call	print_msg
  8164                                  eetd_1:
  8165 00002A19 30E4                    	xor	ah, ah
  8166 00002A1B CD16                    	int	16h
  8167                                  
  8168 00002A1D 3C1B                    	cmp	al, 27
  8169 00002A1F 7410                    	je	short eetd_2
  8170                                  
  8171 00002A21 24DF                    	and	al, 0DFh
  8172 00002A23 3C59                    	cmp	al, 'Y'
  8173 00002A25 7412                    	je	short eetd_yes
  8174 00002A27 3C4E                    	cmp	al, 'N'
  8175 00002A29 75EE                    	jne	short eetd_1
  8176                                  eetd_no:
  8177 00002A2B BE[BF5C]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  8178 00002A2E E861F1                  	call	print_msg
  8179                                  eetd_2:	
  8180 00002A31 BE[7F55]                	mov	si, CRLF  ; Next line
  8181 00002A34 E85BF1                  	call	print_msg
  8182 00002A37 EBAB                    	jmp	short display_extended_pt
  8183                                  eetd_yes:
  8184 00002A39 BE[B95C]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  8185 00002A3C E853F1                  	call	print_msg
  8186 00002A3F BE[7F55]                	mov	si, CRLF  ; Next line
  8187 00002A42 E84DF1                  	call	print_msg
  8188 00002A45 E88806                  	call	delete_logical_drives
  8189 00002A48 803E[226D]00            	cmp	byte [ldrives], 0
  8190 00002A4D 7795                    	ja	short display_extended_pt
  8191 00002A4F E9B5D9                  	jmp	A_42
  8192                                  
  8193                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8194                                  ; logical drive count limit error 
  8195                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8196                                  
  8197                                  eetc_2:
  8198 00002A52 BE[6F61]                	mov	si, msg_create_ldd_max_error
  8199                                  eetc_10:
  8200 00002A55 E83AF1                  	call	print_msg
  8201 00002A58 BE[DB55]                	mov	si, msg_press_any_key
  8202 00002A5B E834F1                  	call	print_msg
  8203 00002A5E 30E4                    	xor	ah, ah
  8204 00002A60 CD16                    	int	16h
  8205 00002A62 EB80                    	jmp	display_extended_pt
  8206                                  
  8207                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8208                                  ; no free space in extended partition
  8209                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8210                                  	
  8211                                  	; 05/03/2019
  8212                                  eetc_9:
  8213 00002A64 BE[A863]                	mov	si, msg_c_ldd_nofspc_error
  8214 00002A67 EBEC                    	jmp	short eetc_10
  8215                                  
  8216                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8217                                  ; create logical dos drive in EXTENDED (DOS) partition
  8218                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8219                                  ; 19/10/2020 (fdisk3.s) 
  8220                                  
  8221                                  edit_ext_table_create:	; 01/03/2019 (hdimage.s)
  8222                                  
  8223                                  ; Create Method: ; 04/03/2019
  8224                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  8225                                  ;LDD 2 <- LDD_START1, ebr 2nd entry <- EBR 1
  8226                                  ;LDD 3 <- LDD_START2, ebr 2nd entry <- EBR 2
  8227                                  ;LDD 4 <- LDD_START3, ebr 2nd entry <- EBR 3
  8228                                  
  8229                                  	; 01/03/2019
  8230 00002A69 803E[DF6F]00            	cmp	byte [epnumber], 0 ; check extended partition
  8231 00002A6E 0F86B8E2                	jna	B_07		; cancel with error message
  8232                                  
  8233                                  	; 05/03/2019
  8234 00002A72 E8EE02                  	call	check_ext_free_space
  8235 00002A75 72ED                    	jc	eetc_9	; error, no free space in extented partition
  8236                                  
  8237                                  	; 30/10/2020
  8238 00002A77 A3[9E70]                	mov	[ep_free_sectors], ax
  8239 00002A7A 8916[A070]              	mov	[ep_free_sectors+2], dx
  8240                                  
  8241 00002A7E 803E[226D]04            	cmp	byte [ldrives], 4
  8242 00002A83 73CD                    	jnb	eetc_2	; error, write program limit message
  8243                                  
  8244                                  edit_ext_table_create_x: ; 02/03/2019
  8245                                  
  8246                                  	; Get logical drive size/cylinders (request) from user
  8247 00002A85 E87303                  	call	get_ldd_size
  8248 00002A88 833E[A470]01            	cmp	word [lcylinders], 1  ; at least 1 cylinder
  8249 00002A8D 0F8253FF                	jb	display_extended_pt ; cancel
  8250                                  
  8251                                  	; 03/03/2019
  8252 00002A91 A0[226D]                	mov	al, [ldrives]
  8253                                  
  8254                                  	;cmp	byte [ldrives], 1
  8255                                  	;jnb	short eetc_3	; skip verify MBR extended partition
  8256                                  
  8257 00002A94 20C0                    	and	al, al
  8258 00002A96 757E                    	jnz	short eetc_3
  8259                                  
  8260 00002A98 31ED                    	xor	bp, bp
  8261                                  
  8262                                  	; Read MBR at EBR buffer
  8263 00002A9A 30E4                    	xor	ah, ah ; 19/10/2020
  8264 00002A9C 31D2                    	xor	dx, dx
  8265 00002A9E BB[286D]                	mov	bx, ebr_buffer
  8266 00002AA1 E8FDF0                  	call	read_hd_sector
  8267 00002AA4 7218                    	jc	short eetc_0
  8268                                  
  8269 00002AA6 A0[DF6F]                	mov	al, [epnumber]
  8270 00002AA9 98                      	cbw
  8271 00002AAA C0E004                  	shl	al, 4 ; * 16
  8272 00002AAD BE[E66E]                	mov	si, ebr_buffer+446
  8273 00002AB0 01C6                    	add	si, ax
  8274 00002AB2 BF[B857]                	mov	di, MasterBootBuff+446
  8275 00002AB5 01C7                    	add	di, ax
  8276 00002AB7 B90800                  	mov	cx, 8
  8277 00002ABA F3A7                    	repe	cmpsw	; repeat comparising while cx > 0 and zf = 1
  8278 00002ABC E30C                    	jcxz	eetc_1	; Extended partition entry is not changed 
  8279                                  	; Different PTE (means there is a new extended partition) 
  8280                                  eetc_0:
  8281                                  	; Write current MBR (with modified PT)
  8282 00002ABE BB[FA55]                	mov	bx, MasterBootBuff
  8283 00002AC1 31C0                    	xor	ax, ax
  8284                                  	;xor	dx, dx
  8285 00002AC3 E831F1                  	call	write_hd_sector
  8286 00002AC6 0F82C7DC                	jc	print_error_code ; ! display error msg and then exit !
  8287                                  eetc_1:
  8288                                  	; clear	EBR buffer
  8289 00002ACA BF[286D]                	mov	di, ebr_buffer
  8290 00002ACD 31C0                    	xor	ax, ax
  8291 00002ACF B9FF00                  	mov	cx, 255
  8292 00002AD2 F3AB                    	rep	stosw
  8293 00002AD4 C70555AA                	mov	word [di], 0AA55h
  8294                                  
  8295                                  	; Set logical dos drive parameters in it's EBR
  8296 00002AD8 BF[E66E]                	mov	di, ebr_buffer+446
  8297                                  
  8298 00002ADB 8B0E[7E3F]              	mov	cx, [sectors]
  8299 00002ADF 29DB                    	sub	bx, bx ; 0
  8300 00002AE1 A1[2A6F]                	mov	ax, [ep_StartSector]
  8301 00002AE4 8B16[2C6F]              	mov	dx, [ep_StartSector+2]
  8302                                  
  8303                                  	; 03/03/2019
  8304                                  	; set partition start address & size
  8305                                  
  8306 00002AE8 A3[7E70]                	mov	[ldd_start], ax
  8307 00002AEB 8916[8070]              	mov	[ldd_start+2], dx
  8308                                  
  8309                                  	; 01/11/2020
  8310 00002AEF 833E[A470]FF            	cmp	word [lcylinders], 65535
  8311                                  			; sign for using all of available sectors
  8312 00002AF4 7209                    	jb	short eetc_11
  8313                                  
  8314 00002AF6 A1[9E70]                	mov	ax, [ep_free_sectors]
  8315 00002AF9 8B16[A070]              	mov	dx, [ep_free_sectors+2]
  8316 00002AFD EB0B                    	jmp	short eetc_12
  8317                                  eetc_11:
  8318 00002AFF A0[803F]                	mov	al, [heads]
  8319 00002B02 F626[7E3F]              	mul	byte [sectors]
  8320 00002B06 F726[A470]              	mul	word [lcylinders]
  8321                                  eetc_12:
  8322                                  	; 01/11/2020
  8323 00002B0A 31ED                    	xor	bp, bp
  8324 00002B0C A3[8E70]                	mov	[ldd_size], ax
  8325 00002B0F 8916[9070]              	mov	[ldd_size+2], dx
  8326                                  
  8327                                  	; 1st ldd start sector is always 63 or 17 (= spt)
  8328                                  	;sub	ax, cx ; cx = 63 or 17, [sectors]
  8329                                  	;sbb	dx, bx ; sbb dx, 0
  8330                                  
  8331                                  	; 01/11/2020
  8332 00002B13 E9DE00                  	jmp	eetc_4
  8333                                  
  8334                                  	;mov	[di+ptStartSector], cx
  8335                                  	;mov	[di+ptStartSector+2], bx
  8336                                  	;
  8337                                  	;; 01/11/2020
  8338                                  	;mov	[di+ptSectors], ax
  8339                                  	;mov	[di+ptSectors+2], dx
  8340                                  	;
  8341                                  	;mov	cx, ax
  8342                                  	;mov	bx, dx
  8343                                  	;; cx:bx = volume size of logical -dos- drive
  8344                                  	;
  8345                                  	;pop	ax ; ldd's LBA
  8346                                  	;pop	dx
  8347                                  	;; dx:ax = start sector address of ldd
  8348                                  	;
  8349                                  	;; 01/11/2020
  8350                                  	;add	cx, ax
  8351                                  	;adc	bx, dx
  8352                                  	;sub	cx, 1
  8353                                  	;sbb	bx, 0
  8354                                  	;; bx:cx = end sector address of ldd
  8355                                  	;push	cx
  8356                                  	;push	bx
  8357                                  	;
  8358                                  	;jmp	eetc_4
  8359                                  
  8360                                  eetc_3:
  8361                                  	; [ldrives] >= 1
  8362                                  	; Read EBR
  8363                                  	;mov	al, [ldrives]
  8364 00002B16 30E4                    	xor	ah, ah ; 02/11/2020
  8365 00002B18 C0E002                  	shl	al, 2
  8366 00002B1B 89C5                    	mov	bp, ax
  8367                                  
  8368                                  	; 03/03/2019
  8369 00002B1D 8B86[7A70]              	mov	ax, [bp+ldd_start-4]
  8370 00002B21 8B96[7C70]              	mov	dx, [bp+ldd_start-2]
  8371 00002B25 BB[286D]                	mov	bx, ebr_buffer
  8372 00002B28 E876F0                  	call	read_hd_sector
  8373 00002B2B 0F8262DC                	jc	print_error_code ; ! display error msg and then exit !
  8374                                  
  8375                                  	; 04/03/2019
  8376 00002B2F BE[F66E]                	mov	si, ebr_buffer+446+16 ; 2nd entry (next EBR)
  8377                                  	
  8378                                  	; 03/03/2019
  8379 00002B32 8B86[7A70]              	mov	ax, [bp+ldd_start-4]
  8380 00002B36 8B96[7C70]              	mov	dx, [bp+ldd_start-2]
  8381 00002B3A 0386[8A70]              	add	ax, [bp+ldd_size-4]
  8382 00002B3E 1396[8C70]              	adc	dx, [bp+ldd_size-2]
  8383                                  
  8384 00002B42 8B0E[2A6F]              	mov	cx, [ep_StartSector]
  8385 00002B46 8B1E[2C6F]              	mov	bx, [ep_StartSector+2]
  8386                                  
  8387 00002B4A 8986[7E70]              	mov	[bp+ldd_start], ax
  8388 00002B4E 8996[8070]              	mov	[bp+ldd_start+2], dx
  8389                                  
  8390 00002B52 52                      	push	dx ; ldd's start sector LBA
  8391 00002B53 50                      	push	ax
  8392                                  	
  8393 00002B54 29C8                    	sub	ax, cx
  8394 00002B56 19DA                    	sbb	dx, bx
  8395                                  	; dx:ax = offset from start of the ep start sector
  8396                                  
  8397 00002B58 894408                  	mov	[si+ptStartSector], ax
  8398 00002B5B 89540A                  	mov	[si+ptStartSector+2], dx
  8399                                  
  8400                                  	; 01/11/2020
  8401 00002B5E 833E[A470]FF            	cmp	word [lcylinders], 65535
  8402                                  			; sign for using all of available sectors
  8403 00002B63 7209                    	jb	short eetc_13
  8404                                  
  8405 00002B65 A1[9E70]                	mov	ax, [ep_free_sectors]
  8406 00002B68 8B16[A070]              	mov	dx, [ep_free_sectors+2]
  8407 00002B6C EB0B                    	jmp	short eetc_14
  8408                                  eetc_13:
  8409 00002B6E A0[803F]                	mov	al, [heads]
  8410 00002B71 F626[7E3F]              	mul	byte [sectors]
  8411 00002B75 F726[A470]              	mul	word [lcylinders]
  8412                                  eetc_14:
  8413                                  	; 01/11/2020
  8414 00002B79 8986[8E70]              	mov	[bp+ldd_size], ax
  8415 00002B7D 8996[9070]              	mov	[bp+ldd_size+2], dx
  8416                                  
  8417 00002B81 89440C                   	mov	[si+ptSectors], ax
  8418 00002B84 89540E                  	mov	[si+ptSectors+2], dx
  8419                                  
  8420                                  	; 01/11/2020
  8421 00002B87 89C1                    	mov	cx, ax
  8422 00002B89 89D3                    	mov	bx, dx
  8423                                  	; cx:bx = volume size of logical -dos- drive
  8424                                  
  8425 00002B8B 58                      	pop	ax ; ldd's start sector LBA
  8426 00002B8C 5A                      	pop	dx
  8427                                  
  8428                                  	; 01/11/2020
  8429 00002B8D 01C1                    	add	cx, ax
  8430 00002B8F 11D3                    	adc	bx, dx
  8431 00002B91 83E901                  	sub	cx, 1
  8432 00002B94 83DB00                  	sbb	bx, 0
  8433                                  	; bx:cx = end sector address of ldd
  8434 00002B97 51                      	push	cx
  8435 00002B98 53                      	push	bx
  8436                                  
  8437                                  	; calculate CHS from LBA
  8438 00002B99 E80A02                  	call	lba_to_chs
  8439                                  		; ax = cylinder
  8440                                  		; dl = sector
  8441                                  		; dh = head
  8442                                  
  8443 00002B9C C60400                  	mov	byte [si+ptBootable], 0
  8444 00002B9F 887401                  	mov	[si+ptBeginHead], dh
  8445 00002BA2 884403                  	mov	[si+ptBeginCylinder], al
  8446 00002BA5 C0E406                  	shl	ah, 6
  8447 00002BA8 08E2                    	or	dl, ah		
  8448 00002BAA 885402                  	mov	[si+ptBeginSector], dl
  8449                                  
  8450                                   	;;mov	ax, [si+ptSectors]
  8451                                  	;;mov	dx, [si+ptSectors+2]
  8452                                   	;mov	ax, [bp+ldd_size]
  8453                                  	;mov	dx, [bp+ldd_size+2]
  8454                                  	;sub	ax, 1
  8455                                  	;sbb	dx, 0
  8456                                  	;add	ax, [bp+ldd_start]
  8457                                  	;adc	dx, [bp+ldd_start+2]
  8458                                  	;	; dx:ax = end sector
  8459                                  	
  8460                                  	; 01/11/2020
  8461 00002BAD 58                      	pop	ax
  8462 00002BAE 5A                      	pop	dx
  8463                                  	; dx:ax = end sector address of ldd
  8464                                  
  8465 00002BAF E8F401                  	call	lba_to_chs
  8466                                  		; ax = cylinder
  8467                                  		; dl = sector
  8468                                  		; dh = head
  8469                                  		; 24/10/2020
  8470                                  		; bl = Extended partition ID
  8471                                  		
  8472                                  	;mov	byte [si+ptFileSystemID], 5 ; EXTENDED
  8473                                  	; 24/10/2020
  8474 00002BB2 885C04                  	mov	[si+ptFileSystemID], bl ; EXTENDED ; 05h or 0Fh
  8475                                  	;
  8476 00002BB5 887405                  	mov	[si+ptEndHead], dh
  8477 00002BB8 884407                  	mov	[si+ptEndCylinder], al
  8478 00002BBB C0E406                  	shl	ah, 6
  8479 00002BBE 08D4                    	or	ah, dl	
  8480 00002BC0 886406                  	mov	[si+ptEndSector], ah
  8481                                  
  8482                                  	; Write EBR
  8483 00002BC3 8B86[7A70]              	mov	ax, [bp+ldd_start-4]
  8484 00002BC7 8B96[7C70]              	mov	dx, [bp+ldd_start-2]
  8485 00002BCB BB[286D]                	mov	bx, ebr_buffer
  8486 00002BCE E826F0                  	call	write_hd_sector
  8487 00002BD1 0F82BCDB                	jc	print_error_code ; ! display error msg and then exit !
  8488                                  
  8489                                  	; clear	EBR buffer
  8490 00002BD5 BF[286D]                	mov	di, ebr_buffer
  8491 00002BD8 31C0                    	xor	ax, ax
  8492 00002BDA B9FF00                  	mov	cx, 255
  8493 00002BDD F3AB                    	rep	stosw
  8494 00002BDF C70555AA                	mov	word [di], 0AA55h
  8495                                  
  8496 00002BE3 BF[E66E]                	mov	di, ebr_buffer+446 ; 1st entry points to LDD
  8497                                  
  8498 00002BE6 8B0E[7E3F]              	mov	cx, [sectors]
  8499 00002BEA 29DB                    	sub	bx, bx ; 0
  8500                                  	; 01/11/2020
  8501 00002BEC 8B86[8E70]              	mov	ax, [bp+ldd_size]
  8502 00002BF0 8B96[9070]              	mov	dx, [bp+ldd_size+2]
  8503                                  	;sub	ax, cx
  8504                                  	;sbb	dx, bx ; sbb dx, 0 
  8505                                  eetc_4:	
  8506 00002BF4 894D08                  	mov	[di+ptStartSector], cx
  8507 00002BF7 895D0A                  	mov	[di+ptStartSector+2], bx
  8508                                  
  8509                                  	; 01/11/2020
  8510                                  	; 1st ldd start sector is always 63 or 17 (= spt)
  8511 00002BFA 29C8                    	sub	ax, cx ; cx = 63 or 17, [sectors]
  8512 00002BFC 19DA                    	sbb	dx, bx ; sbb dx, 0
  8513                                  
  8514                                  	; 01/11/2020
  8515 00002BFE 89450C                  	mov	[di+ptSectors], ax
  8516 00002C01 89550E                  	mov	[di+ptSectors+2], dx
  8517                                  
  8518 00002C04 8B8E[8E70]              	mov	cx, [bp+ldd_size]
  8519 00002C08 8B9E[9070]              	mov	bx, [bp+ldd_size+2]
  8520                                  	; cx:bx = volume size of logical -dos- drive
  8521                                  
  8522 00002C0C 8B86[7E70]              	mov	ax, [bp+ldd_start]
  8523 00002C10 8B96[8070]              	mov	dx, [bp+ldd_start+2]
  8524                                  	; dx:ax = start sector address of ldd (EBR addr)
  8525                                  
  8526                                  	; 01/11/2020
  8527 00002C14 01C1                    	add	cx, ax
  8528 00002C16 11D3                    	adc	bx, dx
  8529 00002C18 83E901                  	sub	cx, 1
  8530 00002C1B 83DB00                  	sbb	bx, 0
  8531                                  	; bx:cx = end sector address of ldd
  8532 00002C1E 53                      	push	bx
  8533 00002C1F 51                      	push	cx
  8534                                  ;eetc_4:
  8535                                  	; 01/11/2020
  8536                                  	; stack = end sector address of ldd
  8537                                  	; dx:ax = start sector address of ldd
  8538                                  
  8539                                  	; calculate CHS from LBA
  8540                                  
  8541 00002C20 E88301                  	call	lba_to_chs
  8542                                  		; ax = cylinder
  8543                                  		; dl = sector
  8544                                  		; dh = head
  8545                                  
  8546                                  	;mov	byte [di+ptBootable], 0
  8547 00002C23 887501                  	mov	[di+ptBeginHead], dh
  8548 00002C26 884503                  	mov	[di+ptBeginCylinder], al
  8549                                  	;mov	bl, ah
  8550                                  	;shl	bl, 6
  8551                                  	;or	dl, bl
  8552                                  	; 01/11/2020
  8553 00002C29 C0E406                  	shl	ah, 6
  8554 00002C2C 08E2                    	or	dl, ah
  8555 00002C2E 885502                  	mov	[di+ptBeginSector], dl
  8556                                  
  8557                                  	;add	ax, [lcylinders]
  8558                                  	;dec	ax ; end cylinder
  8559                                  	;mov	bx, ax
  8560                                  
  8561                                  	; 01/11/2020
  8562 00002C31 58                      	pop	ax
  8563 00002C32 5A                      	pop	dx
  8564                                  	; dx:ax = end sector address of ldd
  8565                                  
  8566 00002C33 E87001                  	call	lba_to_chs
  8567                                  		; ax = cylinder number (0-1023)
  8568                                  		; dl = sector
  8569                                  		; dh = head
  8570                                  		; 01/11/2020
  8571                                  		; cx = cylinder number (0-65535)
  8572                                  
  8573                                  	; 02/11/2020
  8574                                  	;mov	[endcyl], cx ; 01/11/2020
  8575 00002C36 870E[A670]              	xchg	[endcyl], cx 
  8576                                  		; cx = end cylinder of the ep
  8577                                  		; [endcyl] = end cylinder of the ldd
  8578                                  
  8579                                  	;mov	[di+ptFileSystemID], 0
  8580                                  	;mov	cx, [heads]
  8581                                  	;dec	cl
  8582                                  	;mov	[di+ptEndHead], cl
  8583                                  	; 01/11/2020
  8584 00002C3A 887505                  	mov	[di+ptEndHead], dh
  8585                                  
  8586 00002C3D 884507                  	mov	[di+ptEndCylinder], al
  8587                                  	;mov	dx, [sectors]
  8588 00002C40 C0E406                  	shl	ah, 6
  8589 00002C43 08D4                    	or	ah, dl	
  8590 00002C45 886506                  	mov	[di+ptEndSector], ah
  8591                                  
  8592                                  	; 02/03/2019
  8593                                  	; Check unused space if it is 3rd LDD
  8594                                  	; (write message to add unused space.)
  8595                                  
  8596                                  	; 02/11/2020
  8597                                  	;cmp	byte [ldrives], 3
  8598                                  	;jb	eetc_7
  8599                                  
  8600                                  	; 01/11/2020
  8601 00002C48 833E[A470]FF            	cmp	word [lcylinders], 65535  
  8602                                  			; sign for using all of available sectors
  8603 00002C4D 0F83B500                	jnb	eetc_7	; no need to add unused sector 
  8604                                  			; (there are not any unused sectors)
  8605                                  
  8606                                  	; cx = cylinder number (0 to 65535)
  8607                                  
  8608                                  	; 02/11/2020
  8609 00002C51 803E[226D]03            	cmp	byte [ldrives], 3 ; is this logical drive 4 ?
  8610 00002C56 7309                    	jnb	short eetc_17  
  8611                                  			; force to show unused space message
  8612                                  
  8613                                  	; 02/11/2020
  8614                                  	; (add unused space if cyl nums are same or diff is 1)
  8615 00002C58 49                      	dec	cx  ; tolerate cylinder numbers n and n-1 
  8616 00002C59 3B0E[A670]              	cmp	cx, [endcyl]
  8617 00002C5D 0F87A500                	ja	eetc_7  ; the end cyl number of the last ldd
  8618                                  			; is 2 or more cyls less than
  8619                                  			; the end cyl number of the ep
  8620                                  			; (a next ldd can be added to
  8621                                  			; extd partition with 2 or more cyls)
  8622                                  eetc_17:
  8623                                  	; 02/11/2020
  8624 00002C61 A0[226D]                	mov	al, [ldrives]
  8625                                  	;add	al, '0'
  8626 00002C64 0431                    	add	al, '1'	; 03/11/2020
  8627 00002C66 A2[E761]                	mov	[char_lddn], al
  8628                                  
  8629 00002C69 A0[7E3F]                	mov	al, [sectors]
  8630 00002C6C 88C7                    	mov	bh, al
  8631 00002C6E 8A1E[803F]              	mov	bl, [heads]
  8632 00002C72 FECB                    	dec	bl
  8633 00002C74 F6E3                    	mul	bl ; [sectors] * [heads] - 1
  8634                                  
  8635 00002C76 50                      	push	ax
  8636                                  
  8637 00002C77 88F8                    	mov	al, bh  ; [sectors]
  8638                                  	;mul	byte [heads]
  8639 00002C79 FEC3                    	inc	bl
  8640 00002C7B F6E3                    	mul	bl
  8641                                  		; ax = heads * sectors
  8642                                  	;mul	cx ; * end cylinder
  8643 00002C7D F726[A670]              	mul	word [endcyl] ; 02/11/2020
  8644                                  		; dx:ax = end cylinder * heads * sectors
  8645 00002C81 59                      	pop	cx
  8646 00002C82 01C8                    	add	ax, cx ; + (sectors * (heads - 1))
  8647 00002C84 83D200                  	adc	dx, 0
  8648                                  
  8649                                  	; 03/03/2019
  8650 00002C87 8B0E[7E3F]              	mov	cx, [sectors]
  8651 00002C8B FEC9                    	dec	cl  ; [sectors] - 1
  8652 00002C8D 01C8                    	add	ax, cx ; + (sectors - 1)
  8653 00002C8F 83D200                  	adc	dx, 0
  8654                                  		; DX:AX = end LBA
  8655                                  	
  8656 00002C92 8B0E[2E6F]              	mov	cx, [ep_EndSector]
  8657 00002C96 8B1E[306F]              	mov	bx, [ep_EndSector+2]
  8658                                  
  8659 00002C9A 39DA                      	cmp	dx, bx
  8660 00002C9C 7504                    	jne	short eetc_5
  8661 00002C9E 39C8                    	cmp	ax, cx
  8662 00002CA0 7464                    	je	short eetc_7 ; 05/03/2019
  8663                                  eetc_5:
  8664 00002CA2 53                      	push	bx
  8665 00002CA3 BE[A461]                	mov	si, msg_c_ldd_unused_warning
  8666 00002CA6 E8E9EE                  	call	print_msg
  8667 00002CA9 5B                      	pop	bx
  8668                                  eetc_6:
  8669 00002CAA 28E4                    	sub	ah, ah
  8670 00002CAC CD16                    	int	16h
  8671 00002CAE 3C0D                    	cmp	al, 13 ; ENTER
  8672 00002CB0 7454                    	je	short eetc_7 ; continue
  8673 00002CB2 3C1B                    	cmp	al, 27 ; ESC
  8674 00002CB4 75F4                    	jne	short eetc_6
  8675                                  
  8676                                  	; 03/03/2019
  8677                                  	; change end cylinder value
  8678 00002CB6 A0[DF6F]                	mov	al, [epnumber]
  8679 00002CB9 FEC8                    	dec	al
  8680 00002CBB B412                    	mov	ah, 18  ; primary partition table structure size
  8681 00002CBD F6E4                    	mul	ah
  8682 00002CBF 89C6                    	mov	si, ax
  8683 00002CC1 8B84[9C6F]              	mov	ax, [si+part_table_end_cyl]
  8684                                  	; 02/11/2020
  8685 00002CC5 A3[A670]                	mov	[endcyl], ax ; end cylinder of the ep
  8686                                  eetc_19:
  8687                                  	; 03/11/2020
  8688 00002CC8 3DFF03                  	cmp	ax, 1023 ; overs CHS limit ?
  8689 00002CCB 7603                    	jna	short eetc_20 ; no
  8690 00002CCD B8FF03                  	mov	ax, 1023 ; 03FFh ; fix end CHS values of the PTE
  8691                                  eetc_20:
  8692 00002CD0 884507                  	mov	[di+ptEndCylinder], al
  8693 00002CD3 8A84[9B6F]              	mov	al, [si+part_table_end_sector]
  8694 00002CD7 C0E406                  	shl	ah, 6
  8695 00002CDA 08C4                    	or	ah, al	
  8696 00002CDC 886506                  	mov	[di+ptEndSector], ah
  8697 00002CDF 8A84[9A6F]              	mov	al, [si+part_table_end_head]
  8698 00002CE3 884505                  	mov	[di+ptEndHead], al
  8699                                  
  8700 00002CE6 89C8                    	mov	ax, cx
  8701 00002CE8 89DA                    	mov	dx, bx
  8702 00002CEA 83C001                  	add	ax, 1
  8703 00002CED 83D200                  	adc	dx, 0
  8704                                  		; dx:ax = end of extd partition + 1 
  8705                                  
  8706                                  	; 02/11/2020
  8707 00002CF0 2B86[7E70]              	sub	ax, [bp+ldd_start]
  8708 00002CF4 1B96[8070]              	sbb	dx, [bp+ldd_start+2]
  8709 00002CF8 2B4508                  	sub	ax, [di+ptStartSector]
  8710 00002CFB 1B550A                  	sbb	dx, [di+ptStartSector+2]
  8711                                  		; dx:ax = new sector count of the ldd
  8712                                  
  8713 00002CFE 89450C                  	mov	[di+ptSectors], ax
  8714 00002D01 89550E                  	mov	[di+ptSectors+2], dx
  8715 00002D04 EB06                    	jmp	short eetc_8
  8716                                  eetc_7:
  8717 00002D06 8B450C                  	mov	ax, [di+ptSectors]
  8718 00002D09 8B550E                  	mov	dx, [di+ptSectors+2]
  8719                                  eetc_8:
  8720                                  	; 01/11/2020
  8721 00002D0C 813E[A670]FF03          	cmp	word [endcyl], 1023
  8722 00002D12 7605                    	jna	short eetc_15
  8723                                  
  8724                                  	; 25/10/2020
  8725                                  	;mov	cx, [bp+ldd_start]
  8726                                  	;mov	bx, [bp+ldd_start+2]
  8727                                  	;; 01/11/2020
  8728                                  	;add	cx, [bp+ldd_size]
  8729                                  	;adc	bx, [bp+ldd_size+2]
  8730                                  	;sub	cx, 1 ; *
  8731                                  	;sbb	bx, 0 ; *
  8732                                  	;cmp	bx, [chs_limit+2]
  8733                                  	;jb	short eetc_15
  8734                                  	;ja	short eetc_19
  8735                                  	;cmp	cx, [chs_limit]
  8736                                  	;jna	short eetc_15
  8737                                  ;eetc_19:
  8738 00002D14 E8D000                  	call	size_to_fat_type_lba ; 25/10/2020
  8739 00002D17 EB03                    	jmp	short eetc_16
  8740                                  eetc_15:
  8741                                  	; Get proper FAT type in [ldd_type]
  8742                                  	; by using DX:AX - size -
  8743 00002D19 E8B100                  	call	size_to_fat_type
  8744                                  eetc_16:
  8745 00002D1C 884504                  	mov	[di+ptFileSystemID], al
  8746                                  
  8747                                  	; Write current EBR (with modified PT)
  8748 00002D1F 8B86[7E70]              	mov	ax, [bp+ldd_start]
  8749 00002D23 8B96[8070]              	mov	dx, [bp+ldd_start+2]
  8750                                  
  8751                                  	; 01/11/2020
  8752                                  	; ! safety ! (to protect MBR and primary partition)
  8753                                  ;eetc_16:
  8754                                  	;cmp	dx, [ep_StartSector+2]
  8755                                  	;jb	short eetc_18
  8756                                  	;ja	short eetc_17
  8757                                  	;cmp	ax, [ep_StartSector]
  8758                                  	;jna	short eetc_18
  8759                                  ;eetc_17:
  8760                                  	;mov	ah, 0FFh
  8761                                  	;jmp	print_error_code
  8762                                  ;eetc_18:
  8763                                  
  8764 00002D27 BB[286D]                	mov	bx, ebr_buffer
  8765 00002D2A E8CAEE                  	call	write_hd_sector
  8766 00002D2D 0F8260DA                	jc	print_error_code ; ! display error msg and then exit !
  8767                                  
  8768 00002D31 A0[226D]                	mov	al, [ldrives]
  8769 00002D34 B412                    	mov	ah, 18 ; extended partition table structure size
  8770 00002D36 F6E4                    	mul	ah
  8771                                  
  8772 00002D38 89C6                    	mov	si, ax
  8773 00002D3A 81C6[E06F]              	add	si, ext_table_boot_ind
  8774 00002D3E 87F7                    	xchg	si, di
  8775                                  
  8776                                  	; set partition (logical -dos- drive) data
  8777 00002D40 A5                      	movsw	; boot indicator, beginning head
  8778 00002D41 AC                      	lodsb
  8779 00002D42 88C4                    	mov	ah, al
  8780 00002D44 243F                    	and	al, 3Fh
  8781 00002D46 AA                      	stosb	; beginning sector
  8782 00002D47 C0EC06                  	shr	ah, 6
  8783 00002D4A AC                      	lodsb	; beginning cylinder
  8784 00002D4B AB                      	stosw	
  8785 00002D4C A5                      	movsw	; partition id, end head
  8786 00002D4D AC                      	lodsb
  8787 00002D4E 88C4                    	mov	ah, al
  8788 00002D50 243F                    	and	al, 3Fh
  8789 00002D52 AA                      	stosb	; end sector
  8790 00002D53 C0EC06                  	shr	ah, 6
  8791 00002D56 AC                      	lodsb	; end cylinder
  8792 00002D57 AB                      	stosw
  8793                                  
  8794 00002D58 A5                      	movsw	; copy start sector (LBA) and sector count
  8795 00002D59 A5                      	movsw
  8796 00002D5A A5                      	movsw
  8797 00002D5B A5                      	movsw
  8798                                  
  8799 00002D5C FE06[226D]              	inc	byte [ldrives]
  8800                                  
  8801 00002D60 E981FC                  	jmp	display_extended_pt
  8802                                  
  8803                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8804                                  ; check free space in EXTENDED (DOS) partition
  8805                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8806                                  ; 05/03/2019
  8807                                  
  8808                                  check_ext_free_space:
  8809 00002D63 A1[326F]                	mov	ax, [ep_Size]
  8810 00002D66 8B16[346F]              	mov	dx, [ep_Size+2]
  8811                                  
  8812 00002D6A 8A1E[226D]              	mov	bl, [ldrives]
  8813 00002D6E 20DB                    	and	bl, bl
  8814 00002D70 7433                    	jz	short cefs_1
  8815 00002D72 80FB04                  	cmp	bl, 4
  8816 00002D75 7602                    	jna	short cefs_0
  8817 00002D77 B304                    	mov	bl, 4
  8818                                  cefs_0:
  8819 00002D79 FECB                    	dec	bl
  8820 00002D7B C0E302                  	shl	bl, 2 ; * 4
  8821 00002D7E 30FF                    	xor	bh, bh
  8822 00002D80 89DE                    	mov	si, bx
  8823                                  
  8824 00002D82 8B8C[7E70]              	mov	cx, [si+ldd_start]
  8825 00002D86 8B9C[8070]              	mov	bx, [si+ldd_start+2]
  8826 00002D8A 038C[8E70]              	add	cx, [si+ldd_size]
  8827 00002D8E 139C[9070]              	adc	bx, [si+ldd_size+2]
  8828                                  
  8829 00002D92 0306[2A6F]              	add	ax, [ep_StartSector]
  8830 00002D96 1316[2C6F]              	adc	dx, [ep_StartSector+2]
  8831                                  
  8832 00002D9A 29C8                    	sub	ax, cx
  8833 00002D9C 19DA                    	sbb	dx, bx
  8834 00002D9E 7505                    	jnz	short cefs_1
  8835                                  	
  8836 00002DA0 09C0                    	or	ax, ax
  8837 00002DA2 7501                    	jnz	short cefs_1
  8838                                  
  8839                                  	; cf = 0 if the result not negative
  8840                                  
  8841 00002DA4 F9                      	stc
  8842                                  
  8843                                  	; cf = 1 if the result is negative or zero
  8844                                  	 
  8845                                  	; If cf = 0 -> There is free space as in DX:AX
  8846                                  	; NOTE: This calculation is unsafe if
  8847                                  	; logical dos drive count > 4 !	
  8848                                  	; (But still meaningful for creating a new ldd.
  8849                                  	;  Because a new ldd will be created only
  8850                                  	;  if ldd count < 4.)
  8851                                  cefs_1:
  8852 00002DA5 C3                      	retn
  8853                                  
  8854                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8855                                  ; convert LBA to CHS parameters (in registers)
  8856                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8857                                  ; 24/10/2020
  8858                                  
  8859                                  	; 13/01/2021 (BugFix)
  8860                                  	; 01/03/2019 (hdimage.s)
  8861                                  lba_to_chs:
  8862                                  	; INPUT:
  8863                                  	;	DX:AX = LBA address
  8864                                  	; OUTPUT:
  8865                                  	;	AX = cylinder
  8866                                  	;	DL = sector
  8867                                  	;	DH = head
  8868                                  	; 24/10/2020
  8869                                  	;	BL = extended partition ID (05h, 0Fh)
  8870                                  	;
  8871                                  	; (modified registers: ax, bx, cx, dx)
  8872                                  
  8873 00002DA6 8B0E[7E3F]              	mov	cx, [sectors]
  8874 00002DAA E8D0DE                  	call	div32
  8875 00002DAD FEC3                    	inc	bl
  8876 00002DAF 53                      	push	bx ; BL = sector
  8877 00002DB0 8B0E[803F]              	mov	cx, [heads]
  8878 00002DB4 E8C6DE                  	call	div32
  8879 00002DB7 5A                      	pop	dx  ; DL = sector	
  8880 00002DB8 88DE                    	mov	dh, bl ; BL = head
  8881                                  	
  8882                                  	; 24/10/2020
  8883                                  	; check cylinder number (CHS) limit
  8884                                  	;mov	bh, 05h ; ENTENTED (LBA)
  8885                                  	; 13/03/2021
  8886 00002DBA B305                    	mov	bl, 05h ; EXTENDED (LBA)
  8887                                  
  8888 00002DBC 89C1                    	mov	cx, ax ; 01/11/2020
  8889                                  
  8890 00002DBE 3DFF03                  	cmp	ax, 1023
  8891 00002DC1 7609                    	jna	short lbatochs_ok
  8892                                  
  8893 00002DC3 B8FF03                  	mov	ax, 1023 ; BC/EC = 0FFh
  8894 00002DC6 B23F                    	mov	dl, 63  ; BS/ES = 0FFh
  8895 00002DC8 B6FE                    	mov	dh, 254 ; BH/EH = 0FEh
  8896 00002DCA B30F                    	mov	bl, 0Fh ; EXTENDED (CHS)
  8897                                  lbatochs_ok:
  8898 00002DCC C3                      	retn
  8899                                  
  8900                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8901                                  ; specify FAT type by using partition/volume size (CHS)
  8902                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8903                                  ; 02/03/2019
  8904                                  
  8905                                  size_to_fat_type:
  8906                                  	; INPUT:
  8907                                  	;	DX:AX = DOS Partition Size in sectors
  8908                                  	; OUTPUT:
  8909                                  	;	AL = Partition type/ID (FAT type)
  8910                                  
  8911 00002DCD 09D2                    	or	dx, dx
  8912 00002DCF 750B                    	jnz	short stft_2
  8913                                  
  8914 00002DD1 3DA87F                  	cmp	ax, 32680
  8915 00002DD4 7703                    	ja	short stft_1
  8916                                  stft_0:	
  8917 00002DD6 B001                    	mov	al, 1	; FAT12 file system
  8918 00002DD8 C3                      	retn
  8919                                  stft_1:
  8920 00002DD9 B004                    	mov	al, 4	; FAT16 (< 32MB)
  8921 00002DDB C3                      	retn	
  8922                                  stft_2:
  8923 00002DDC 83FA10                  	cmp	dx, 10h
  8924 00002DDF 7303                    	jnb	short stft_3 ; FAT32 (CHS) file system
  8925                                  
  8926 00002DE1 B006                    	mov	al, 6	; FAT16 (>= 32MB)
  8927 00002DE3 C3                      	retn
  8928                                  stft_3:
  8929 00002DE4 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  8930 00002DE6 C3                      	retn
  8931                                  
  8932                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8933                                  ; specify FAT type by using partition/volume size (LBA)
  8934                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8935                                  ; 25/10/2020
  8936                                  
  8937                                  size_to_fat_type_lba:
  8938                                  	; INPUT:
  8939                                  	;	DX:AX = DOS Partition Size in sectors
  8940                                  	; OUTPUT:
  8941                                  	;	AL = Partition type/ID (FAT type)
  8942                                  
  8943 00002DE7 09D2                    	or	dx, dx
  8944 00002DE9 7408                    	jz	short stft_4
  8945                                  
  8946 00002DEB 83FA10                  	cmp	dx, 10h
  8947 00002DEE 7208                    	jb	short stft_5 ; FAT16 (LBA) file system
  8948                                  
  8949 00002DF0 B00C                    	mov	al, 0Ch ; FAT32 file system (LBA)
  8950 00002DF2 C3                      	retn
  8951                                  stft_4:
  8952 00002DF3 3DA87F                  	cmp	ax, 32680
  8953 00002DF6 76DE                    	jna	short stft_0  ; FAT12 file system
  8954                                  stft_5:	
  8955 00002DF8 B00E                    	mov	al, 0Eh	; FAT16 file system (LBA)
  8956 00002DFA C3                      	retn
  8957                                  
  8958                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8959                                  ; get requested logical dos drive size (from user)
  8960                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8961                                  ; 02/03/2019
  8962                                  
  8963                                  get_ldd_size:
  8964                                  	; INPUT -> none
  8965                                  	;
  8966                                  	; OUTPUT -> 
  8967                                  	;	[lcylinders] = cylinder count
  8968                                  	;
  8969                                  	; (Modified registers: ax, bx, cx, dx, si, di) 
  8970                                  
  8971 00002DFB B80300                  	mov	ax, 3 ; clear screen
  8972 00002DFE CD10                    	int	10h
  8973                                  
  8974 00002E00 BE[2448]                	mov	si, msg_create_dos_partition_h
  8975 00002E03 E88CED                  	call	print_msg
  8976                                  
  8977                                  	; 03/03/2019
  8978 00002E06 A0[226D]                	mov	al, [ldrives]
  8979 00002E09 08C0                    	or	al, al		; cmp byte [ldrives], 0
  8980 00002E0B 7405                    	jz	short gldds_1	; jna short gldds_0
  8981                                  
  8982                                  	;push	ax ; *	
  8983                                  
  8984                                  	;dec	al
  8985                                  	;mov	ah, 18
  8986                                  	;mul	ah
  8987                                  	
  8988                                  	;mov	di, ext_table_rel_sec_lw
  8989                                  	;add	di, ax
  8990                                  
  8991 00002E0D BE[384E]                	mov	si, msg_use_all_space
  8992                                  	; 01/11/2020
  8993                                  	;call	print_msg
  8994 00002E10 EB03                    	jmp	short gldds_2
  8995                                  
  8996                                  	; Calculate available space
  8997                                  
  8998                                  	;mov	ax, [ep_Size] ; ext part size in sectors
  8999                                  	;mov	dx, [ep_Size+2]
  9000                                  	
  9001                                  	; 04/03/2019
  9002                                  ;gldds_0:
  9003                                  	;mov	cx, [di]    ; start sector
  9004                                  	;mov	bx, [di+2]
  9005                                  	;add	cx, [di+4]  ; sectors
  9006                                  	;adc	bx, [di+6]
  9007                                  	;	; bx:cx = start of next ldd
  9008                                  	;sub	ax, cx
  9009                                  	;sbb	dx, bx
  9010                                  	;	; dx:ax = free space in sectors
  9011                                  	;
  9012                                  	;pop	cx ; *
  9013                                  	;dec	cl
  9014                                  	;jz	short gldds_2
  9015                                  	;sub	di, 18
  9016                                  	;push	cx ; *
  9017                                  	;jmp	short gldds_0
  9018                                  
  9019                                  	; 05/03/2019
  9020                                  	;call	check_ext_free_space
  9021                                  	;jc	short gldds_cancel
  9022                                  	
  9023                                  	; 01/11/2020
  9024                                  	; 30/10/2020
  9025                                  	;mov	ax, [ep_free_sectors]
  9026                                  	;mov	dx, [ep_free_sectors+2]
  9027                                  	
  9028                                  		; DX:AX = free sectors in extended partition
  9029                                  	;jmp	short gldds_2
  9030                                  gldds_1:
  9031 00002E12 BE[6B4E]                	mov	si, msg_use_entire_ep_space
  9032                                  	;call	print_msg
  9033                                  	
  9034                                  	; 01/11/2020
  9035                                  	; Calculate free space in extended partition
  9036                                  	;mov	ax, [ep_Size]
  9037                                  	;mov	dx, [ep_Size+2]
  9038                                  gldds_2:
  9039                                  	; 01/11/2020
  9040 00002E15 E87AED                  	call	print_msg
  9041                                  
  9042 00002E18 A0[803F]                	mov	al, [heads]
  9043 00002E1B F626[7E3F]              	mul	byte [sectors]
  9044 00002E1F 89C1                    	mov	cx, ax
  9045                                  		
  9046 00002E21 A1[9E70]                	mov	ax, [ep_free_sectors]
  9047 00002E24 8B16[A070]              	mov	dx, [ep_free_sectors+2]
  9048                                  
  9049                                  	; 01/11/2020
  9050                                  	; this is needed for partition size input
  9051                                  	; (maximum available sectors)
  9052                                  	;mov	[pp_Sectors], ax
  9053                                  	;mov	[pp_Sectors+2], dx
  9054                                  
  9055                                  	; 01/11/2020
  9056                                  	; subtrack start offset (which always equals to spt value)
  9057                                  	;sub	ax, [sectors]
  9058                                  	;sbb	dx, 0
  9059                                  
  9060                                  	;mov	cx, ax
  9061                                  	;mov	al, [heads]
  9062                                  	;mul	byte [sectors]
  9063                                  	;xchg	ax, cx
  9064                                  		; dx:ax = sectors
  9065                                  		; cx = heads*spt 
  9066                                  	;call	div32
  9067                                  		; ax = cylinders
  9068                                  		; bx = remainder
  9069                                   		; dx = 0
  9070                                  	;and	bx, bx
  9071                                  	;jz	short gldds_3
  9072                                  	;inc	ax
  9073                                  	; 01/11/2020
  9074 00002E28 F7F1                    	div	cx
  9075                                  	;and	dx, dx
  9076                                  	;jz	short gldds_3
  9077                                  	;inc	ax
  9078                                  gldds_3:
  9079 00002E2A A3[A470]                	mov	[lcylinders], ax ; <= 65535 (< 65535)
  9080                                  gldds_getchar:
  9081 00002E2D 30E4                    	xor	ah, ah
  9082 00002E2F CD16                    	int	16h
  9083                                  
  9084 00002E31 3C1B                    	cmp	al, 27 ; ESCAPE key
  9085 00002E33 7416                    	je	short gldds_cancel
  9086 00002E35 24DF                    	and	al, 0DFh
  9087 00002E37 3C4E                    	cmp	al, 'N'
  9088 00002E39 7417                    	je	short gldds_4
  9089 00002E3B 3C59                    	cmp	al, 'Y'
  9090 00002E3D 75EE                    	jne	short gldds_getchar
  9091                                  
  9092                                  	; 01/11/2020
  9093 00002E3F C706[A470]FFFF          	mov	word [lcylinders], 65535 ; sign for all free sectors
  9094                                  	
  9095 00002E45 BE[B85C]                	mov	si, _msg_YES
  9096                                  	;call	print_msg
  9097                                  	;retn
  9098 00002E48 E947ED                  	jmp	print_msg
  9099                                  
  9100                                  gldds_cancel:
  9101 00002E4B C706[A470]0000          	mov	word [lcylinders], 0
  9102                                  gldds_28:
  9103 00002E51 C3                      	retn
  9104                                  gldds_4:	
  9105 00002E52 BE[BE5C]                	mov	si, _msg_NO
  9106 00002E55 E83AED                  	call	print_msg
  9107                                  gldds_26:
  9108 00002E58 B80300                  	mov	ax, 3 ; clear screen
  9109 00002E5B CD10                    	int	10h
  9110                                  
  9111 00002E5D BE[2448]                	mov	si, msg_create_dos_partition_h
  9112 00002E60 E82FED                  	call	print_msg
  9113                                  
  9114 00002E63 BE[2A62]                	mov	si, msg_create_ldd_s
  9115 00002E66 E829ED                  	call	print_msg
  9116 00002E69 BE[F64D]                	mov	si, msg_press_esc_to_cancel
  9117 00002E6C E823ED                  	call	print_msg
  9118                                  gldds_25:
  9119 00002E6F 30E4                    	xor	ah, ah
  9120 00002E71 CD16                    	int	16h
  9121                                  
  9122 00002E73 3C1B                    	cmp	al, 27 ; ESCAPE key
  9123 00002E75 7502                    	jne	short gldds_5
  9124                                  
  9125 00002E77 EBD2                    	jmp	short gldds_cancel
  9126                                  gldds_5:
  9127                                  	; 04/03/2019
  9128 00002E79 3C20                    	cmp	al, 32 ; SPACE key
  9129 00002E7B 74D4                    	je	short gldds_28
  9130                                  	
  9131                                  	; 01/11/2020
  9132                                  	;mov	byte [pSize_unit], '%'
  9133 00002E7D 3C25                    	cmp	al, '%'
  9134 00002E7F 7416                    	je	short gldds_6
  9135                                  	;mov	byte [pSize_unit], 'M'
  9136 00002E81 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  9137                                  	;je	short gldds_6
  9138 00002E83 7504                    	jne	short gldds_29
  9139                                  	; 01/11/2020
  9140 00002E85 B04D                    	mov	al, 'M'
  9141 00002E87 EB0E                    	jmp	short gldds_6
  9142                                  gldds_29:
  9143 00002E89 24DF                    	and	al, 0DFh
  9144 00002E8B 3C4D                    	cmp	al, 'M'
  9145 00002E8D 7408                    	je	short gldds_6
  9146                                  	;mov	[pSize_unit], al
  9147 00002E8F 3C47                    	cmp	al, 'G'
  9148 00002E91 7404                    	je	short gldds_6
  9149 00002E93 3C43                    	cmp	al, 'C'
  9150 00002E95 75D8                    	jne	short gldds_25
  9151                                  gldds_6:
  9152                                  	; 01/11/2020
  9153 00002E97 A2[FE6C]                	mov	[pSize_unit], al
  9154                                  
  9155                                  	; Set maximum sector count (all of extended partition)
  9156                                  	;mov	al, [sectors]
  9157                                  	;mul	byte [heads]
  9158                                  	;mul	word [lcylinders]
  9159                                  	; 01/11/2020	
  9160 00002E9A A1[9E70]                	mov	ax, [ep_free_sectors]
  9161 00002E9D 8B16[A070]              	mov	dx, [ep_free_sectors+2]
  9162 00002EA1 A3[EC6C]                	mov	[pp_Sectors], ax
  9163 00002EA4 8916[EE6C]              	mov	[pp_Sectors+2], dx
  9164                                  	
  9165 00002EA8 E857EF                   	call	partition_size_input
  9166 00002EAB 729E                    	jc	short gldds_cancel
  9167                                  		; DX:AX = Partition size in sectors
  9168                                  	;or	bx, bx
  9169                                  	;jnz	short gldds_cancel
  9170                                  
  9171                                  	; 01/11/2020
  9172 00002EAD A3[1A6D]                	mov	[ppn_Sectors], ax
  9173 00002EB0 8916[1C6D]              	mov	[ppn_Sectors+2], dx
  9174                                  		
  9175                                  	;mov	cx, ax
  9176                                  	;mov	al, [heads]
  9177                                  	;mul	byte [sectors]
  9178                                  	;xchg	ax, cx
  9179                                  	; 13/03/2021
  9180 00002EB4 8B0E[146D]              	mov	cx, [hs] ; heads*sectors
  9181                                  		; dx:ax = sectors
  9182                                  		; cx = heads*spt 
  9183 00002EB8 E8C2DD                  	call	div32
  9184                                  		; ax = cylinders
  9185                                  		; bx = remainder
  9186                                   		; dx = 0
  9187                                  	; 02/11/2020
  9188                                  	;and	bx, bx
  9189                                  	;jz	short gldds_7
  9190                                  	;inc	ax
  9191                                  gldds_7:
  9192 00002EBB 3B06[A470]              	cmp	ax, [lcylinders]
  9193 00002EBF 7704                    	ja	short gldds_9
  9194                                  gldds_8:
  9195                                  	; OK
  9196 00002EC1 A3[A470]                	mov	[lcylinders], ax
  9197 00002EC4 C3                      	retn
  9198                                  
  9199                                  gldds_9:
  9200                                  	; Partition size limit message
  9201                                  	
  9202 00002EC5 803E[FE6C]43            	cmp	byte [pSize_unit], 'C'
  9203 00002ECA 741C                    	je	short gldds_10
  9204                                  
  9205                                  	; Tolerate 1 cylinder if unit is not cylinder
  9206                                  	;dec	ax
  9207                                  	;cmp	ax, [lcylinders]
  9208                                  	;jna	short gldds_8
  9209                                  
  9210                                  	; 01/11/2020
  9211                                  	; Tolerate sectors if sectorcount doesn't over ep limit
  9212 00002ECC A1[1A6D]                	mov	ax, [ppn_Sectors]
  9213 00002ECF 8B16[1C6D]              	mov	dx, [ppn_Sectors+2]
  9214 00002ED3 3B16[A070]              	cmp	dx, [ep_free_sectors+2]
  9215 00002ED7 770F                    	ja	short gldds_10
  9216 00002ED9 7206                    	jb	short gldds_30
  9217 00002EDB 3B06[9E70]              	cmp	ax, [ep_free_sectors]
  9218 00002EDF 7707                    	ja	short gldds_10
  9219                                  gldds_30:
  9220 00002EE1 C706[A470]FFFF          	mov	word [lcylinders], 65535 ; sign for all free sectors
  9221 00002EE7 C3                      	retn
  9222                                  
  9223                                  gldds_10:
  9224                                  	; clear screen
  9225 00002EE8 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  9226 00002EEB CD10                    	int	10h
  9227                                  
  9228 00002EED BE[2448]                	mov	si, msg_create_dos_partition_h ; header
  9229 00002EF0 E89FEC                  	call	print_msg
  9230                                  
  9231 00002EF3 BE[D75D]                	mov	si, msg_partition_size_limit
  9232 00002EF6 E899EC                  	call	print_msg
  9233                                  
  9234 00002EF9 803E[FE6C]4D            	cmp	byte [pSize_unit], 'M'
  9235 00002EFE 7413                    	je	short gldds_11
  9236                                  
  9237 00002F00 803E[FE6C]25            	cmp	byte [pSize_unit], '%'
  9238 00002F05 7457                    	je	short gldds_22
  9239                                  
  9240 00002F07 803E[FE6C]43            	cmp	byte [pSize_unit], 'C'
  9241 00002F0C 7505                    	jne	short gldds_11
  9242                                  
  9243 00002F0E A1[A470]                	mov	ax, [lcylinders]
  9244 00002F11 EB0F                    	jmp	short gldds_12
  9245                                  gldds_11:
  9246                                  	; 'M'
  9247 00002F13 A1[EC6C]                	mov	ax, [pp_Sectors]
  9248 00002F16 8B16[EE6C]              	mov	dx, [pp_Sectors+2]
  9249 00002F1A B90008                  	mov	cx, 2*1024 ; sectors -> MB
  9250 00002F1D E85DDD                  	call	div32
  9251                                  		; DX = 0 
  9252                                  		; AX = Available space in Megabytes
  9253 00002F20 89C7                    	mov	di, ax
  9254                                  gldds_12:	
  9255 00002F22 B90A00                  	mov	cx, 10
  9256 00002F25 89E5                    	mov	bp, sp
  9257                                  gldds_13:
  9258 00002F27 31D2                    	xor	dx, dx
  9259                                  	;mov	cx, 10
  9260 00002F29 F7F1                    	div	cx
  9261 00002F2B 52                      	push	dx
  9262 00002F2C 83F809                  	cmp	ax, 9
  9263 00002F2F 77F6                    	ja	short gldds_13
  9264                                  gldds_14:
  9265 00002F31 BB0700                  	mov	bx, 07h
  9266 00002F34 09C0                    	or	ax, ax
  9267 00002F36 7501                    	jnz	short gldds_16
  9268                                  gldds_15:
  9269 00002F38 58                      	pop	ax
  9270                                  gldds_16:
  9271 00002F39 0430                    	add	al, '0'
  9272                                  gldds_17:
  9273 00002F3B B40E                    	mov	ah, 0Eh
  9274                                  	;mov	bx, 07h
  9275 00002F3D CD10                    	int	10h	; write character (as tty)
  9276                                  
  9277 00002F3F 39EC                    	cmp	sp, bp
  9278 00002F41 72F5                    	jb	short gldds_15
  9279                                  
  9280 00002F43 803E[FE6C]25            	cmp	byte [pSize_unit], '%'
  9281 00002F48 7508                    	jne	short gldds_18
  9282                                  
  9283 00002F4A 3C25                    	cmp	al, '%'
  9284 00002F4C 745E                    	je	short gldds_21
  9285 00002F4E B025                    	mov	al, '%'
  9286 00002F50 EBE9                    	jmp	short gldds_17
  9287                                  gldds_18:
  9288 00002F52 803E[FE6C]43            	cmp	byte [pSize_unit], 'C'
  9289 00002F57 753E                    	jne	short gldds_19
  9290                                  
  9291 00002F59 BE[735E]                	mov	si, msg_cylinders
  9292 00002F5C EB4B                    	jmp	short gldds_20
  9293                                  
  9294                                  gldds_22:
  9295                                  	; '%'
  9296                                  	; 01/11/2020
  9297 00002F5E 8B16[346F]              	mov	dx, [ep_Size+2]
  9298 00002F62 A1[326F]                	mov	ax, [ep_Size] ; *
  9299 00002F65 21D2                    	and	dx, dx
  9300 00002F67 7419                    	jz	short gldds_33 ; dx = 0
  9301 00002F69 B90100                  	mov	cx, 1
  9302                                  gldds_31:
  9303 00002F6C D1E1                    	shl	cx, 1
  9304 00002F6E E80CDD                  	call	div32
  9305 00002F71 09D2                    	or	dx, dx
  9306 00002F73 7409                    	jz	short gldds_32 ; *
  9307 00002F75 A1[326F]                	mov	ax, [ep_Size]	
  9308 00002F78 8B16[346F]              	mov	dx, [ep_Size+2]
  9309 00002F7C EBEE                    	jmp	short gldds_31
  9310                                  gldds_32:
  9311 00002F7E 8B16[A070]              	mov	dx, [ep_free_sectors+2]
  9312                                  	; ep free sectors <= ep size
  9313                                  gldds_33:
  9314 00002F82 50                      	push	ax ; * ; dx = 0 (ep size weight)
  9315 00002F83 A1[9E70]                	mov	ax, [ep_free_sectors]
  9316 00002F86 B96400                  	mov	cx, 100
  9317                                  	;and	dx, dx
  9318                                  	;jnz	short gldds_34
  9319                                  	;mul	cx
  9320                                  	;jmp	short gldds_35
  9321                                  ;gldds_34:
  9322 00002F89 E8FFDC                  	call	mul32
  9323                                  		; dx:ax = 100 * ep free sectors weight
  9324                                  ;gldds_35:
  9325 00002F8C 59                      	pop	cx ; *
  9326 00002F8D E8EDDC                  	call	div32 ; 100 * ep free sectors / ep size
  9327                                  		; ax = % value (<= 100)
  9328 00002F90 09C0                    	or	ax, ax
  9329                                  	;jnz	short gldds_23
  9330 00002F92 758E                    	jnz	short gldds_12 ; 13/01/2021
  9331 00002F94 40                      	inc	ax ; 0 -> 1
  9332                                  	; 13/03/2021
  9333 00002F95 EB8B                    	jmp	short gldds_12
  9334                                  
  9335                                  ;gldds_23:	
  9336                                  	;mov	bp, sp
  9337                                  	;mov	cx, 10
  9338                                  ;gldds_24:	
  9339                                  	;xor	dx, dx
  9340                                  	;div	cx
  9341                                  	;push	dx ; *
  9342                                  	;cmp	ax, 9
  9343                                  	;ja	short gldds_24
  9344                                  	;jmp	short gldds_14
  9345                                  
  9346                                  gldds_19:
  9347 00002F97 BE[875E]                	mov	si, msg_megabytes
  9348 00002F9A C606[905E]73            	mov	byte [msg_megabytes_s], 's'
  9349 00002F9F 83FF01                  	cmp	di, 1
  9350 00002FA2 7705                    	ja	short gldds_20
  9351 00002FA4 C606[905E]00            	mov	byte [msg_megabytes_s], 0
  9352                                  gldds_20:
  9353 00002FA9 E8E6EB                  	call	print_msg
  9354                                  gldds_21:
  9355 00002FAC BE[245E]                	mov	si, msg_partition_size_limit_r
  9356 00002FAF E8E0EB                  	call	print_msg
  9357                                  gldds_27:
  9358 00002FB2 30E4                    	xor	ah, ah
  9359 00002FB4 CD16                    	int	16h
  9360                                  	
  9361 00002FB6 3C1B                    	cmp	al, 27 ; ESCAPE key
  9362 00002FB8 0F849CFE                	je	gldds_26
  9363 00002FBC 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  9364 00002FBE 75F2                    	jne	short gldds_27
  9365                                  
  9366                                  	;mov	ax, [lcylinders]
  9367 00002FC0 C3                      	retn
  9368                                  	
  9369                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9370                                  ; initialize extended (dos) partition table 
  9371                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9372                                  ; 18/10/2020 (fdisk3.s)
  9373                                  ; 26/02/2019 (hdimage.s)
  9374                                  
  9375                                  init_ext_partition_table:
  9376                                  
  9377                                  	; INPUT -> 
  9378                                  	;	[epnumber] = extended partition number
  9379                                  	;
  9380                                  	; OUTPUT -> none
  9381                                  
  9382                                  ; Display Method: ; 04/03/2019
  9383                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  9384                                  ;LDD 2 <- LDD_START1, ebr 1st entry <- EBR 1
  9385                                  ;LDD 3 <- LDD_START2, ebr 1st entry <- EBR 2
  9386                                  ;LDD 4 <- LDD_START3, ebr 1st entry <- EBR 3
  9387                                  ;LDD 5 <- LDD_START3, ebr 2nd entry (LDD 5 is not displayed)
  9388                                  
  9389                                  	; 08/03/2019
  9390                                  
  9391                                  	; clear extended partition table structure/list
  9392                                  
  9393 00002FC1 BF[E06F]                	mov	di, ext_table_boot_ind
  9394 00002FC4 89FE                    	mov	si, di ; 28/02/2019
  9395 00002FC6 B92400                  	mov	cx, 36 ; 18*4 = 72 bytes
  9396 00002FC9 31C0                    	xor	ax, ax ; 0
  9397 00002FCB F3AB                    	rep	stosw
  9398 00002FCD 89F7                    	mov	di, si ; 28/02/2019
  9399                                  
  9400                                  	;mov	byte [ldrives], 0
  9401 00002FCF A2[226D]                	mov	[ldrives], al ; 0
  9402                                  
  9403                                  	;cmp	byte [epnumber], 1
  9404                                  	;jb	short iept_0
  9405                                  
  9406 00002FD2 A0[DF6F]                	mov	al, [epnumber]
  9407 00002FD5 FEC8                    	dec	al
  9408 00002FD7 B412                    	mov	ah, 18  ; partition table structure size 
  9409 00002FD9 F6E4                    	mul	ah
  9410 00002FDB BE[9E6F]                	mov	si, part_table_rel_sec_lw
  9411 00002FDE 01C6                    	add	si, ax
  9412                                  	; 02/11/2020
  9413                                  	;(save end cylinder for comparising later)
  9414 00002FE0 8B44FE                  	mov	ax, [si-2] ; part_table_end_cyl
  9415                                  			; 16 bit cylinder number
  9416 00002FE3 A3[A670]                	mov	[endcyl], ax
  9417                                  	;
  9418 00002FE6 8B04                    	mov	ax, [si]
  9419 00002FE8 8B5402                  	mov	dx, [si+2]
  9420 00002FEB A3[2A6F]                	mov	[ep_StartSector], ax
  9421 00002FEE 8916[2C6F]              	mov	[ep_StartSector+2], dx
  9422 00002FF2 8B4C04                  	mov	cx, [si+4]
  9423 00002FF5 8B5C06                  	mov	bx, [si+6]
  9424 00002FF8 890E[326F]              	mov	[ep_Size], cx
  9425 00002FFC 891E[346F]              	mov	[ep_Size+2], bx
  9426 00003000 83E901                  	sub	cx, 1
  9427 00003003 83DB00                  	sbb	bx, 0
  9428 00003006 01C1                    	add	cx, ax
  9429 00003008 11D3                    	adc	bx, dx 
  9430 0000300A 890E[2E6F]              	mov	[ep_EndSector], cx
  9431 0000300E 891E[306F]              	mov	[ep_EndSector+2], bx
  9432                                  
  9433                                  	; 27/02/2019
  9434 00003012 A3[7E70]                	mov	[ldd_start], ax
  9435 00003015 8916[8070]              	mov	[ldd_start+2], dx
  9436                                  
  9437                                  	; 03/03/2019
  9438                                  	;mov	word [ldd_size], 0
  9439                                  	;mov	word [ldd_size+2], 0
  9440                                  	
  9441 00003019 BB[286D]                	mov	bx, ebr_buffer
  9442                                  	; dx:ax = Extended partition address
  9443                                  	; es:bx = Extended partition buffer
  9444 0000301C E882EB                  	call	read_hd_sector
  9445 0000301F 7209                    	jc	short iept_0
  9446                                  
  9447                                  	; Check EBR if it is a valid boot record or not
  9448 00003021 813E[266F]55AA          	cmp	word [ebr_buffer+510], 0AA55h
  9449 00003027 7402                    	je	short iept_1
  9450                                  iept_stc_retn:
  9451 00003029 F9                      	stc
  9452                                  iept_0:
  9453 0000302A C3                      	retn
  9454                                  iept_1:
  9455                                  	; Check PTE 1, if it is valid or not
  9456 0000302B A0[EA6E]                	mov	al, [ebr_buffer+446+ptFileSystemID]
  9457 0000302E 20C0                    	and	al, al
  9458 00003030 74F7                    	jz	short iept_stc_retn ; empty pte, error
  9459 00003032 3C05                    	cmp	al, 5
  9460 00003034 74F3                    	je	short iept_stc_retn ; extended partition, error
  9461                                  	; 24/10/2020
  9462 00003036 3C0F                    	cmp	al, 0Fh
  9463 00003038 74EF                    	je	short iept_stc_retn ; extended partition, error
  9464                                  
  9465                                  	;inc	byte [ldrives] ; logical (dos) drive count
  9466                                  
  9467 0000303A BE[E66E]                	mov	si, ebr_buffer+446 ; Partition table offset
  9468 0000303D B90400                  	mov	cx, 4
  9469                                  
  9470                                  	; set partition (logical -dos- drive) data
  9471 00003040 A5                      	movsw	; boot indicator, beginning head
  9472 00003041 AC                      	lodsb
  9473 00003042 88C4                    	mov	ah, al
  9474 00003044 243F                    	and	al, 3Fh
  9475 00003046 AA                      	stosb	; beginning sector
  9476 00003047 C0EC06                  	shr	ah, 6
  9477 0000304A AC                      	lodsb	; beginning cylinder
  9478 0000304B AB                      	stosw	
  9479 0000304C A5                      	movsw	; partition id, end head
  9480 0000304D AC                      	lodsb
  9481 0000304E 88C4                    	mov	ah, al
  9482 00003050 243F                    	and	al, 3Fh
  9483 00003052 AA                      	stosb	; end sector
  9484 00003053 C0EC06                  	shr	ah, 6
  9485 00003056 AC                      	lodsb	; end cylinder
  9486 00003057 AB                      	stosw
  9487                                  
  9488                                  	; 04/03/2019
  9489 00003058 8A1E[226D]              	mov	bl, [ldrives]
  9490                                  	;dec 	bl
  9491                                  	;jnz	short iept_2
  9492                                  
  9493                                  	; 05/03/2019
  9494 0000305C 08DB                    	or	bl, bl
  9495 0000305E 7518                    	jnz	short iept_2
  9496                                  
  9497 00003060 8B04                    	mov	ax, [si]   ; start sector of 1st LDD (offset)
  9498 00003062 8B5402                  	mov	dx, [si+2]
  9499 00003065 034404                  	add	ax, [si+4] ; size of 1st LDD (volume)
  9500 00003068 135406                  	adc	dx, [si+6]
  9501                                  
  9502 0000306B A3[8E70]                	mov	[ldd_size], ax ; size of 1st LDD (partition)
  9503 0000306E 8916[9070]              	mov	[ldd_size+2], dx
  9504                                  	; 05/03/2019
  9505 00003072 FE06[226D]              	inc	byte [ldrives] ; logical (dos) drive count
  9506 00003076 FEC3                    	inc	bl
  9507                                  iept_2:
  9508 00003078 F3A5                    	rep	movsw ; copy start sector (LBA) and sector count
  9509                                  
  9510                                  	; get next extended partition (logical -dos- drive) data
  9511 0000307A 8A4404                  	mov	al, [si+ptFileSystemID]
  9512 0000307D 20C0                    	and	al, al ; EMPTY
  9513 0000307F 74A9                    	jz	short iept_0 ; end of logical -dos- drive chain
  9514                                  
  9515 00003081 3C05                    	cmp	al, 5 ; EXTENDED
  9516                                  	;jne	short iept_stc_retn  ; 2nd PTE must have
  9517                                  	;			     ; extended partition ID
  9518 00003083 7404                    	je	short iept_4
  9519                                  	; 24/10/2020
  9520 00003085 3C0F                    	cmp	al, 0Fh ; EXTENDED (LBA)
  9521 00003087 75A0                    	jne	short iept_stc_retn  ; 2nd PTE must have
  9522                                  				     ; extended partition ID
  9523                                  iept_4:
  9524                                  	; 05/03/2019
  9525 00003089 FE06[226D]              	inc	byte [ldrives] ; logical (dos) drive count
  9526                                  
  9527                                  	;cmp	byte [ldrives], al ; 5
  9528 0000308D 80FB04                  	cmp	bl, 4 ; number of logical dos drives (till here)
  9529 00003090 733D                    	jnb	short iept_3
  9530                                  
  9531 00003092 83C608                  	add	si, 8
  9532                                  
  9533 00003095 AD                      	lodsw	
  9534 00003096 89C2                    	mov	dx, ax	; start sector
  9535 00003098 AD                      	lodsw
  9536 00003099 92                      	xchg	dx, ax	; start sector + 2
  9537                                  
  9538                                  	; 04/03/2019
  9539 0000309A 0306[2A6F]              	add	ax, [ep_StartSector]
  9540 0000309E 1316[2C6F]              	adc	dx, [ep_StartSector+2]
  9541                                  	
  9542 000030A2 30FF                    	xor	bh, bh
  9543 000030A4 C0E302                  	shl	bl, 2 ; *4
  9544                                  
  9545                                  	; 28/02/2019
  9546 000030A7 8987[7E70]              	mov	[bx+ldd_start], ax ; start of (next) LDD (partition)
  9547 000030AB 8997[8070]              	mov	[bx+ldd_start+2], dx
  9548                                  
  9549                                  	; 03/03/2019
  9550                                  	; set partition size for logical dos drive
  9551 000030AF 8B0C                    	mov	cx, [si]
  9552 000030B1 898F[8E70]              	mov	[bx+ldd_size], cx
  9553 000030B5 8B4C02                  	mov	cx, [si+2]
  9554 000030B8 898F[9070]              	mov	[bx+ldd_size+2], cx
  9555                                  
  9556 000030BC BB[286D]                	mov	bx, ebr_buffer
  9557                                  	; dx:ax = Extended partition address
  9558                                  	; es:bx = Extended partition buffer
  9559 000030BF E8DFEA                  	call	read_hd_sector
  9560 000030C2 720B                    	jc	short iept_3 ; 03/03/2019
  9561                                  
  9562                                  	; Check EBR if it is valid or not
  9563 000030C4 813E[266F]55AA          	cmp	word [ebr_buffer+510], 0AA55h
  9564 000030CA 0F845DFF                	je	iept_1
  9565                                  
  9566 000030CE F9                      	stc
  9567                                  iept_3:	
  9568 000030CF C3                      	retn
  9569                                  
  9570                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9571                                  ; delete logical -dos- drives in extended partition
  9572                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9573                                  ; 18/10/2020 (fdisk3.s)
  9574                                  
  9575                                  delete_logical_drives:
  9576                                  		; 27/02/2019 (hdimage.s)
  9577                                  
  9578                                  ; Delete Method: ; 04/03/2019
  9579                                  ;LDD 5 <- LDD_START3, ebr 2nd entry
  9580                                  ;LDD 4 <- LDD_START2, ebr 2nd entry
  9581                                  ;LDD 3 <- LDD_START1, ebr 2nd entry
  9582                                  ;LDD 2 <- LDD_START0, ebr 2nd entry
  9583                                  ;LDD 1 <- LDD_START0, ebr 1st entry
  9584                                  
  9585                                  	;cmp	byte [ldrives], 0
  9586                                  	;jna	short dld_stc
  9587                                  
  9588                                  	;mov	al, 5 ; extended partition (logical drives)
  9589                                  	;call	display_partition_table
  9590                                  	; 12/03/2021
  9591 000030D0 E814F7                  	call	display_partition_table_x
  9592                                  
  9593 000030D3 A0[226D]                	mov	al, [ldrives]
  9594 000030D6 0430                    	add	al, '0'
  9595 000030D8 A2[FD5F]                	mov	[lddp_num], al
  9596                                  
  9597 000030DB BE[AA5F]                	mov	si, msg_delete_ldd
  9598 000030DE E8B1EA                  	call	print_msg
  9599                                  
  9600 000030E1 BE[F64D]                	mov	si, msg_press_esc_to_cancel
  9601 000030E4 E8ABEA                  	call	print_msg
  9602                                  dld_0:
  9603 000030E7 30E4                    	xor	ah, ah
  9604 000030E9 CD16                    	int	16h
  9605                                  
  9606 000030EB 80FC53                  	cmp	ah, 53h  ; DELETE or DEL key
  9607 000030EE 751C                    	jne	short dld_1
  9608                                  
  9609                                  	; Delete PTE 1 & PTE 2 on EBR 1
  9610 000030F0 30E4                    	xor	ah, ah
  9611 000030F2 A0[226D]                	mov	al, [ldrives]
  9612 000030F5 FEC8                    	dec	al
  9613 000030F7 7518                    	jnz	short dld_2
  9614                                  
  9615 000030F9 BF[E66E]                	mov	di, ebr_buffer+446
  9616 000030FC B91000                  	mov	cx, 16
  9617 000030FF F3AB                    	rep	stosw
  9618                                  
  9619                                  	; 04/03/2019
  9620                                  	; Clear ldd data in extended partition table/structure
  9621 00003101 BF[E06F]                	mov	di, ext_table_boot_ind
  9622 00003104 B109                    	mov	cl, 9
  9623 00003106 F3AB                    	rep	stosw
  9624 00003108 31F6                    	xor	si, si
  9625 0000310A EB40                    	jmp	short dld_3
  9626                                  dld_1:	
  9627 0000310C 3C1B                    	cmp	al, 27 ; ESC key
  9628 0000310E 75D7                    	jne	short dld_0
  9629                                  dld_5:
  9630 00003110 C3                      	retn
  9631                                  
  9632                                  ;dld_stc:
  9633                                  ;	stc
  9634                                  ;	retn	
  9635                                  
  9636                                  dld_2:
  9637                                  	; 04/03/2019
  9638                                  	; Delete 2nd PTE on EBR 2 to 4
  9639 00003111 FEC8                    	dec	al 
  9640 00003113 C0E002                  	shl	al, 2 ; * 4
  9641 00003116 89C6                    	mov	si, ax
  9642                                  
  9643 00003118 8B84[7E70]              	mov	ax, [si+ldd_start]
  9644 0000311C 8B94[8070]              	mov	dx, [si+ldd_start+2]
  9645 00003120 BB[286D]                	mov	bx, ebr_buffer
  9646 00003123 E87BEA                  	call	read_hd_sector
  9647 00003126 7238                    	jc	short dld_4
  9648                                  
  9649 00003128 BF[F66E]                	mov	di, ebr_buffer+446+16
  9650 0000312B B90800                  	mov	cx, 8
  9651 0000312E 29C0                    	sub	ax, ax
  9652 00003130 F3AB                    	rep	stosw
  9653                                  
  9654                                  	; 04/03/2019
  9655                                  	;cmp	byte [ldrives], 5
  9656                                  	;jnb	short dld_3
  9657 00003132 8A26[226D]              	mov	ah, [ldrives]
  9658 00003136 80FC05                  	cmp	ah, 5
  9659 00003139 7311                    	jnb	short dld_3
  9660                                  
  9661                                  	; Clear ldd data in extended partition table/structure
  9662                                  	;mov	ah, [ldrives]
  9663 0000313B FECC                    	dec	ah
  9664 0000313D B012                    	mov	al, 18
  9665 0000313F F6E4                    	mul	ah
  9666 00003141 BF[E06F]                	mov	di, ext_table_boot_ind
  9667 00003144 01C7                    	add	di, ax
  9668                                  	;mov	cx, 9
  9669 00003146 B109                    	mov	cl, 9
  9670                                  	;xor	ax, ax
  9671 00003148 30C0                    	xor	al, al
  9672 0000314A F3AB                    	rep	stosw
  9673                                  dld_3:
  9674                                  	; Write changed EBR
  9675 0000314C 8B84[7E70]              	mov	ax, [si+ldd_start]
  9676 00003150 8B94[8070]              	mov	dx, [si+ldd_start+2]
  9677 00003154 BB[286D]                	mov	bx, ebr_buffer
  9678 00003157 E89DEA                  	call	write_hd_sector
  9679 0000315A 7204                    	jc	short dld_4
  9680                                  
  9681                                  	; 28/02/2019
  9682 0000315C FE0E[226D]              	dec	byte [ldrives]
  9683                                  dld_4:
  9684 00003160 803E[226D]00            	cmp	byte [ldrives], 0
  9685 00003165 0F8767FF                	ja	delete_logical_drives
  9686                                  
  9687 00003169 C3                      	retn
  9688                                  
  9689                                  ;=============================================================================
  9690                                  ;        	initialized data
  9691                                  ;=============================================================================
  9692                                  
  9693                                  ; 12/10/2020
  9694 0000316A 00                      int13h_x:	db	0
  9695                                  
  9696                                  TRDOS386_MASTERBOOT_SECTOR:
  9697 0000316B <bin 200h>              	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR
  9698                                  
  9699                                  TRDOS_FAT_hd_bs:
  9700                                  	;incbin 'TRHDBS.BIN'
  9701                                  	; 04/05/2024
  9702                                  TRDOS_FAT32_hd_bs:
  9703                                  	;incbin	'FAT32_BS.BIN' ; 27/04/2024
  9704 0000336B <bin 400h>              	incbin	'RD5HDBS3.BIN' ; 29/04/2024
  9705                                  TRDOS_FAT16_hd_bs: 
  9706                                  	;incbin	'FAT16_BS.BIN' ; 26/12/2017
  9707 0000376B <bin 200h>              	incbin	'RD5HDBS2.BIN' ; 20/04/2024
  9708                                  TRDOS_FAT12_hd_bs: 
  9709                                  	;incbin	'FAT12_BS.BIN' ; 26/12/2017
  9710 0000396B <bin 200h>              	incbin	'RD5HDBS1.BIN' ; 20/04/2024
  9711                                  
  9712                                  TRDOS_TRFS1_chs_bs:
  9713 00003B6B <bin 200h>              	incbin	'TRFS1CHS.BIN' ; Singlix FS1 (CHS+LBA Disk) BS
  9714                                  TRDOS_TRFS1_lba_bs:
  9715 00003D6B <bin 200h>              	incbin	'TRFS1LBA.BIN' ; Singlix FS1 (LBA Disk) BS
  9716                                  
  9717 00003F6B 00                      	db	0
  9718                                  
  9719                                  hexchrs:
  9720 00003F6C 303132333435363738-     	db	'0123456789ABCDEF'
  9720 00003F75 39414243444546     
  9721                                  
  9722                                  ; 05/11/2020
  9723 00003F7C 00                      	db	0
  9724                                  
  9725 00003F7D 90                      align 2
  9726                                  
  9727                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
  9728                                  
  9729                                  sectors: ; sectors per track (63)
  9730 00003F7E 3F00                    	dw 63
  9731                                  heads:	 ; number of heads (16 or 32 or 64) 
  9732 00003F80 1000                    	dw 16
  9733                                  cylinders: ; number of cylinders (16 to 1024)
  9734 00003F82 0004                    	dw 1024
  9735 00003F84 0000                    	dw 0 ; 16/10/2020 (double word)
  9736                                  
  9737                                  ; 05/11/2020
  9738                                  
  9739                                  ;random:
  9740                                  ;	db 0  ; random write to file (0 = sequental)
  9741                                  ;newdisk:
  9742                                  ;	db 0
  9743                                  
  9744                                  FileSys_Names: ; 2003-2017
  9745                                  ; (Valid FileSystems for TRDOS 386, SINGLIX, RETRO UNIX OS projects in 2017)
  9746 00003F86 464154313220202020-     FS_FAT12:     db "FAT12         "  ; 01h = FAT12
  9746 00003F8F 2020202020         
  9747 00003F94 58454E495820202020-     FS_XENIX:     db "XENIX         "  ; 02h , XENIX System V root
  9747 00003F9D 2020202020         
  9748 00003FA2 58454E495820757372-     FS_XENIX_USR: db "XENIX usr     "  ; 03h , XENIX System V user
  9748 00003FAB 2020202020         
  9749 00003FB0 464154313620283034-     FS_FAT16:     db "FAT16 (04h)   "  ; 04h = FAT16 < 32MB
  9749 00003FB9 6829202020         
  9750 00003FBE 455854454E44454420-     FS_EXT_CHS:   db "EXTENDED (CHS)"  ; 05h = Extended DOS Partition
  9750 00003FC7 2843485329         
  9751 00003FCC 464154313620283036-     FS_FAT16_BIG: db "FAT16 (06h)   "  ; 06h = FAT16 > 32MB, CHS mode
  9751 00003FD5 6829202020         
  9752 00003FDA 4E5446532020202020-     FS_NTFS:      db "NTFS          "  ; 07h , WINDOWS NTFS Partition
  9752 00003FE3 2020202020         
  9753 00003FE8 464154333220284348-     FS_FAT32_CHS: db "FAT32 (CHS)   "  ; 0Bh = FAT32, CHS mode
  9753 00003FF1 5329202020         
  9754 00003FF6 464154333220284C42-     FS_FAT32_LBA: db "FAT32 (LBA)   "  ; 0Ch = FAT32, LBA mode
  9754 00003FFF 4129202020         
  9755 00004004 464154313620284C42-     FS_FAT16_LBA: db "FAT16 (LBA)   "  ; 0Eh = FAT16, LBA mode
  9755 0000400D 4129202020         
  9756 00004012 455854454E44454420-     FS_EXT_LBA:   db "EXTENDED (LBA)"  ; 0Fh = Extented Partition, LBA mode
  9756 0000401B 284C424129         
  9757 00004020 554E49582053595354-     FS_UNIX_SYSV: db "UNIX SYSTEM V "  ; 63h , SCO UNIX, UNIXWARE, OPENSERVER
  9757 00004029 454D205620         
  9758 0000402E 524554524F20554E49-     FS_RETROUNIX: db "RETRO UNIX    "  ; 71h , Retro UNIX 386 v2 Partition
  9758 00004037 5820202020         
  9759 0000403C 554E49582056372020-     FS_UNIX_V7:   db "UNIX V7       "  ; 72h , UNIX v7 x86 Partition  
  9759 00004045 2020202020         
  9760 0000404A 4C494E555820535741-     FS_LINUXSWAP: db "LINUX SWAP    "  ; 82h , LINUX SWAP Partition
  9760 00004053 5020202020         
  9761 00004058 4C494E555820202020-     FS_LINUX:     db "LINUX         "  ; 83h , LINUX NATIVE (ext2) Partition
  9761 00004061 2020202020         
  9762 00004066 4C494E555820455854-     FS_LINUXEXT:  db "LINUX EXTENDED"  ; 85h , LINUX EXTENDED Partition
  9762 0000406F 454E444544         
  9763 00004074 524444202020202020-     FS_TRDD:      db "RDD           "  ; A0h , (Random Data Disk) LBA
  9763 0000407D 2020202020         
  9764 00004082 53494E474C49582046-     FS_TRFS:      db "SINGLIX FS1   "  ; A1h , (32 bit, 512 bytes per sector)
  9764 0000408B 5331202020         
  9765 00004090 554E4B4E4F574E2046-     FS_OTHERS:    db "UNKNOWN FS    "  ; Another or Unknown File Systems
  9765 00004099 5320202020         
  9766                                   
  9767                                  valid_partitions: ; (*)
  9768 0000409E 01020304050607          	      db 01h, 02h, 03h, 04h, 05h, 06h, 07h
  9769 000040A5 0B0C0E0F637172          	      db 0Bh, 0Ch, 0Eh, 0Fh, 63h, 71h, 72h
  9770 000040AC 828385A0A1              	      db 82h, 83h, 85h, 0A0h, 0A1h
  9771                                  
  9772                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9773                                  ;  messages
  9774                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9775                                  
  9776                                  CHS_msg: ; 80 bytes per row
  9777 000040B1 507265737320274327-     db  "Press 'C' to set cylinders then press '+,-' keys to change number of cylinders. "
  9777 000040BA 20746F207365742063-
  9777 000040C3 796C696E6465727320-
  9777 000040CC 7468656E2070726573-
  9777 000040D5 7320272B2C2D27206B-
  9777 000040DE 65797320746F206368-
  9777 000040E7 616E6765206E756D62-
  9777 000040F0 6572206F662063796C-
  9777 000040F9 696E646572732E20   
  9778 00004101 507265737320274827-     db  "Press 'H' to set heads then press '+,-' keys to change number of heads.         "
  9778 0000410A 20746F207365742068-
  9778 00004113 65616473207468656E-
  9778 0000411C 20707265737320272B-
  9778 00004125 2C2D27206B65797320-
  9778 0000412E 746F206368616E6765-
  9778 00004137 206E756D626572206F-
  9778 00004140 662068656164732E20-
  9778 00004149 2020202020202020   
  9779 00004151 507265737320275327-     db  "Press 'S' to set sectors then press '+,-' keys to change numb of sectors/track. "
  9779 0000415A 20746F207365742073-
  9779 00004163 6563746F7273207468-
  9779 0000416C 656E20707265737320-
  9779 00004175 272B2C2D27206B6579-
  9779 0000417E 7320746F206368616E-
  9779 00004187 6765206E756D62206F-
  9779 00004190 6620736563746F7273-
  9779 00004199 2F747261636B2E20   
  9780 000041A1 202020202020202020-     db  "                                                                                "
  9780 000041AA 202020202020202020-
  9780 000041B3 202020202020202020-
  9780 000041BC 202020202020202020-
  9780 000041C5 202020202020202020-
  9780 000041CE 202020202020202020-
  9780 000041D7 202020202020202020-
  9780 000041E0 202020202020202020-
  9780 000041E9 2020202020202020   
  9781 000041F1 202020202020202020-     db  "                                                                                "
  9781 000041FA 202020202020202020-
  9781 00004203 202020202020202020-
  9781 0000420C 202020202020202020-
  9781 00004215 202020202020202020-
  9781 0000421E 202020202020202020-
  9781 00004227 202020202020202020-
  9781 00004230 202020202020202020-
  9781 00004239 2020202020202020   
  9782 00004241 507265737320454E54-     db  "Press ENTER to use current CHS values.                                          "
  9782 0000424A 455220746F20757365-
  9782 00004253 2063757272656E7420-
  9782 0000425C 4348532076616C7565-
  9782 00004265 732E20202020202020-
  9782 0000426E 202020202020202020-
  9782 00004277 202020202020202020-
  9782 00004280 202020202020202020-
  9782 00004289 2020202020202020   
  9783 00004291 202020202020202020-     db  "                                                                                "
  9783 0000429A 202020202020202020-
  9783 000042A3 202020202020202020-
  9783 000042AC 202020202020202020-
  9783 000042B5 202020202020202020-
  9783 000042BE 202020202020202020-
  9783 000042C7 202020202020202020-
  9783 000042D0 202020202020202020-
  9783 000042D9 2020202020202020   
  9784 000042E1 507265737320455343-     db  "Press ESC to cancel.                                                            "
  9784 000042EA 20746F2063616E6365-
  9784 000042F3 6C2E20202020202020-
  9784 000042FC 202020202020202020-
  9784 00004305 202020202020202020-
  9784 0000430E 202020202020202020-
  9784 00004317 202020202020202020-
  9784 00004320 202020202020202020-
  9784 00004329 2020202020202020   
  9785 00004331 202020202020202020-     db  "                                                                                "
  9785 0000433A 202020202020202020-
  9785 00004343 202020202020202020-
  9785 0000434C 202020202020202020-
  9785 00004355 202020202020202020-
  9785 0000435E 202020202020202020-
  9785 00004367 202020202020202020-
  9785 00004370 202020202020202020-
  9785 00004379 2020202020202020   
  9786 00004381 00                      db  0
  9787                                  
  9788                                  	; 04/05/2024
  9789                                  TrDOS_Welcome:
  9790 00004382 0D0A                    	db	0Dh, 0Ah
  9791                                  	;db	'TR-DOS 386 Fixed Disk Partitioning Utility'
  9792 00004384 526574726F20444F53-     	db	'Retro DOS v5 Fixed Disk Partitioning Utility'
  9792 0000438D 207635204669786564-
  9792 00004396 204469736B20506172-
  9792 0000439F 746974696F6E696E67-
  9792 000043A8 205574696C697479   
  9793 000043B0 0D0A                    	db	0Dh, 0Ah
  9794                                  	;db	"v1.1.240504 (c) Erdogan TAN 2021-2024"
  9795 000043B2 464449534B33207632-     	db	"FDISK3 v2.0.240715 (c) Erdogan TAN 2021-2024"
  9795 000043BB 2E302E323430373135-
  9795 000043C4 20286329204572646F-
  9795 000043CD 67616E2054414E2032-
  9795 000043D6 3032312D32303234   
  9796 000043DE 0D0A                    	db	0Dh,0Ah
  9797 000043E0 0D0A                    	db	0Dh,0Ah
  9798 000043E2 00                      	db	0
  9799                                  TrDOS_Usage:
  9800 000043E3 55736167653A206664-     	db	'Usage: fdisk3r5 <hard disk name> '
  9800 000043EC 69736B337235203C68-
  9800 000043F5 617264206469736B20-
  9800 000043FE 6E616D653E20       
  9801 00004404 0D0A                    	db	0Dh, 0Ah
  9802 00004406 0D0A                    	db	0Dh, 0Ah
  9803 00004408 48617264206469736B-     	db	"Hard disk names: "
  9803 00004411 206E616D65733A20   
  9804 00004419 0D0A                    	db	0Dh, 0Ah
  9805 0000441B 0D0A                    	db	0Dh, 0Ah
  9806 0000441D 20686430202E2E666F-     	db	" hd0 ..for 1st hard disk "
  9806 00004426 722031737420686172-
  9806 0000442F 64206469736B20     
  9807 00004436 0D0A                    	db	0Dh, 0Ah
  9808 00004438 20686431202E2E666F-     	db	" hd1 ..for 2nd hard disk "
  9808 00004441 7220326E6420686172-
  9808 0000444A 64206469736B20     
  9809 00004451 0D0A                    	db	0Dh, 0Ah
  9810 00004453 20686432202E2E666F-     	db	" hd2 ..for 3rd hard disk "
  9810 0000445C 722033726420686172-
  9810 00004465 64206469736B20     
  9811 0000446C 0D0A                    	db	0Dh, 0Ah
  9812 0000446E 20686433202E2E666F-     	db	" hd3 ..for 4th hard disk "
  9812 00004477 722034746820686172-
  9812 00004480 64206469736B20     
  9813 00004487 0D0A00                  	db	0Dh, 0Ah, 0
  9814                                  
  9815                                  TrDOS_Options:
  9816 0000448A 53656C656374206861-     	db	"Select hard disk number (1 to "
  9816 00004493 7264206469736B206E-
  9816 0000449C 756D62657220283120-
  9816 000044A5 746F20             
  9817                                  TrDOS_dnmax:
  9818 000044A8 3429206F7220707265-     	db	"4) or press ESC to exit ..."
  9818 000044B1 73732045534320746F-
  9818 000044BA 2065786974202E2E2E 
  9819 000044C3 0D0A00                  	db	0Dh, 0Ah, 0
  9820                                  TrDOS_hdrow:
  9821 000044C6 0D0A                    	db	0Dh, 0Ah 
  9822 000044C8 28                      	db	"("
  9823                                  TrDOS_hdrow_n:
  9824 000044C9 3029206864              	db	"0) hd"
  9825                                  TrDOS_hdrow_i:
  9826 000044CE 30202D204361706163-     	db	"0 - Capacity : "
  9826 000044D7 697479203A20       
  9827 000044DD 00                      	db	0
  9828                                  TrDOS_hdrow_unit:
  9829 000044DE 474220                  	db	"GB "
  9830 000044E1 0D0A00                  	db 	0Dh, 0Ah, 0
  9831                                  
  9832                                  TrDOS_hdrow_capacity:
  9833 000044E4 303030302000            	db	"0000 ", 0
  9834 000044EA 00                      	db	0
  9835                                  
  9836                                  TrDOS_disksize:
  9837 000044EB 0D0A                    	db	0Dh, 0Ah
  9838 000044ED 4469736B2073697A65-     	db	"Disk size : "
  9838 000044F6 203A20             
  9839 000044F9 00                      	db	0
  9840                                  
  9841                                  msg_fdisk_capacity_err:
  9842 000044FA 0D0A                    	db	0Dh, 0Ah
  9843 000044FC 48756765206469736B-     	db	"Huge disk !"
  9843 00004505 2021               
  9844 00004507 0D0A                    	db	0Dh, 0Ah
  9845 00004509 546869732046444953-     	db	"This FDISK version (v3) can work with disk sizes up to "
  9845 00004512 4B2076657273696F6E-
  9845 0000451B 20287633292063616E-
  9845 00004524 20776F726B20776974-
  9845 0000452D 68206469736B207369-
  9845 00004536 7A657320757020746F-
  9845 0000453F 20                 
  9846 00004540 00                      	db	0
  9847                                  
  9848                                  msg_any_key_esc_exit:
  9849 00004541 0D0A                    	db	0Dh, 0Ah
  9850 00004543 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
  9850 0000454C 20746F206578697420-
  9850 00004555 6F7220707265737320-
  9850 0000455E 616E6F74686572206B-
  9850 00004567 657920746F20636F6E-
  9850 00004570 74696E75652E2E2E   
  9851 00004578 00                      	db	0
  9852                                  
  9853                                  msg_create_partition_h:
  9854 00004579 0D0A                    	db	0Dh, 0Ah
  9855 0000457B 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9855 00004584 2D2D2D2D2D2D2D2D2D-
  9855 0000458D 2D2D2D2D2D2D2D2D2D-
  9855 00004596 2D2D2D2D2D2D2D2D2D-
  9855 0000459F 2D2D2D2D2D2D2D2D2D-
  9855 000045A8 2D2D2D2D2D2D2D2D2D-
  9855 000045B1 2D2D2D2D2D2D2D2D2D-
  9855 000045BA 2D2D2D2D2D2D2D2D2D-
  9855 000045C3 2D2D2D2D2D2D2D2D   
  9856 000045CB 202020202020202020-     	db	"                               Create Partition                                 "
  9856 000045D4 202020202020202020-
  9856 000045DD 202020202020202020-
  9856 000045E6 202020204372656174-
  9856 000045EF 652050617274697469-
  9856 000045F8 6F6E20202020202020-
  9856 00004601 202020202020202020-
  9856 0000460A 202020202020202020-
  9856 00004613 2020202020202020   
  9857 0000461B 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9857 00004624 2D2D2D2D2D2D2D2D2D-
  9857 0000462D 2D2D2D2D2D2D2D2D2D-
  9857 00004636 2D2D2D2D2D2D2D2D2D-
  9857 0000463F 2D2D2D2D2D2D2D2D2D-
  9857 00004648 2D2D2D2D2D2D2D2D2D-
  9857 00004651 2D2D2D2D2D2D2D2D2D-
  9857 0000465A 2D2D2D2D2D2D2D2D2D-
  9857 00004663 2D2D2D2D2D2D2D2D   
  9858 0000466B 0D0A00                  	db	0Dh, 0Ah, 0
  9859                                  msg_create_partition_m:
  9860 0000466E 53656C65637420616E-     	db	"Select an option: "
  9860 00004677 206F7074696F6E3A20 
  9861 00004680 0D0A                    	db	0Dh, 0Ah
  9862 00004682 0D0A                    	db	0Dh, 0Ah
  9863 00004684 202031292043726561-     	db	"  1) Create DOS partition ", 0Dh, 0Ah
  9863 0000468D 746520444F53207061-
  9863 00004696 72746974696F6E200D-
  9863 0000469F 0A                 
  9864 000046A0 202032292043726561-     	db	"  2) Create SINGLIX FS partition ", 0Dh, 0Ah
  9864 000046A9 74652053494E474C49-
  9864 000046B2 582046532070617274-
  9864 000046BB 6974696F6E200D0A   
  9865 000046C3 202033292043726561-     	db	"  3) Create RETRO UNIX partition ", 0Dh, 0Ah
  9865 000046CC 746520524554524F20-
  9865 000046D5 554E49582070617274-
  9865 000046DE 6974696F6E200D0A   
  9866 000046E6 202034292043726561-     	db	"  4) Create another type of partition ", 0Dh, 0Ah
  9866 000046EF 746520616E6F746865-
  9866 000046F8 722074797065206F66-
  9866 00004701 20706172746974696F-
  9866 0000470A 6E200D0A           
  9867 0000470E 0D0A                    	db	0Dh, 0Ah
  9868 00004710 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
  9868 00004719 206F72203020746F20-
  9868 00004722 63616E63656C202E2E-
  9868 0000472B 20                 
  9869 0000472C 0D0A00                   	db 	0Dh, 0Ah, 0
  9870                                  
  9871                                  msg_create_primary_partition_h:
  9872 0000472F 0D0A                    	db	0Dh, 0Ah
  9873 00004731 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9873 0000473A 2D2D2D2D2D2D2D2D2D-
  9873 00004743 2D2D2D2D2D2D2D2D2D-
  9873 0000474C 2D2D2D2D2D2D2D2D2D-
  9873 00004755 2D2D2D2D2D2D2D2D2D-
  9873 0000475E 2D2D2D2D2D2D2D2D2D-
  9873 00004767 2D2D2D2D2D2D2D2D2D-
  9873 00004770 2D2D2D2D2D2D2D2D2D-
  9873 00004779 2D2D2D2D2D2D2D2D   
  9874 00004781 202020202020202020-     	db	"                          Create Primary DOS Partition                          "
  9874 0000478A 202020202020202020-
  9874 00004793 202020202020202043-
  9874 0000479C 726561746520507269-
  9874 000047A5 6D61727920444F5320-
  9874 000047AE 506172746974696F6E-
  9874 000047B7 202020202020202020-
  9874 000047C0 202020202020202020-
  9874 000047C9 2020202020202020   
  9875 000047D1 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9875 000047DA 2D2D2D2D2D2D2D2D2D-
  9875 000047E3 2D2D2D2D2D2D2D2D2D-
  9875 000047EC 2D2D2D2D2D2D2D2D2D-
  9875 000047F5 2D2D2D2D2D2D2D2D2D-
  9875 000047FE 2D2D2D2D2D2D2D2D2D-
  9875 00004807 2D2D2D2D2D2D2D2D2D-
  9875 00004810 2D2D2D2D2D2D2D2D2D-
  9875 00004819 2D2D2D2D2D2D2D2D   
  9876 00004821 0D0A00                  	db	0Dh, 0Ah, 0
  9877                                  
  9878                                  msg_create_dos_partition_h:
  9879 00004824 0D0A                    	db	0Dh, 0Ah
  9880 00004826 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9880 0000482F 2D2D2D2D2D2D2D2D2D-
  9880 00004838 2D2D2D2D2D2D2D2D2D-
  9880 00004841 2D2D2D2D2D2D2D2D2D-
  9880 0000484A 2D2D2D2D2D2D2D2D2D-
  9880 00004853 2D2D2D2D2D2D2D2D2D-
  9880 0000485C 2D2D2D2D2D2D2D2D2D-
  9880 00004865 2D2D2D2D2D2D2D2D2D-
  9880 0000486E 2D2D2D2D2D2D2D2D   
  9881 00004876 202020202020202020-     	db	"                   Create DOS Partition or Logical DOS Drive                    "
  9881 0000487F 202020202020202020-
  9881 00004888 204372656174652044-
  9881 00004891 4F5320506172746974-
  9881 0000489A 696F6E206F72204C6F-
  9881 000048A3 676963616C20444F53-
  9881 000048AC 204472697665202020-
  9881 000048B5 202020202020202020-
  9881 000048BE 2020202020202020   
  9882 000048C6 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9882 000048CF 2D2D2D2D2D2D2D2D2D-
  9882 000048D8 2D2D2D2D2D2D2D2D2D-
  9882 000048E1 2D2D2D2D2D2D2D2D2D-
  9882 000048EA 2D2D2D2D2D2D2D2D2D-
  9882 000048F3 2D2D2D2D2D2D2D2D2D-
  9882 000048FC 2D2D2D2D2D2D2D2D2D-
  9882 00004905 2D2D2D2D2D2D2D2D2D-
  9882 0000490E 2D2D2D2D2D2D2D2D   
  9883 00004916 0D0A00                  	db	0Dh, 0Ah, 0
  9884                                  
  9885                                  msg_create_ext_partition_h:
  9886 00004919 0D0A                    	db	0Dh, 0Ah
  9887 0000491B 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9887 00004924 2D2D2D2D2D2D2D2D2D-
  9887 0000492D 2D2D2D2D2D2D2D2D2D-
  9887 00004936 2D2D2D2D2D2D2D2D2D-
  9887 0000493F 2D2D2D2D2D2D2D2D2D-
  9887 00004948 2D2D2D2D2D2D2D2D2D-
  9887 00004951 2D2D2D2D2D2D2D2D2D-
  9887 0000495A 2D2D2D2D2D2D2D2D2D-
  9887 00004963 2D2D2D2D2D2D2D2D   
  9888 0000496B 202020202020202020-     	db	"                         Create Extended DOS Partition                          "
  9888 00004974 202020202020202020-
  9888 0000497D 202020202020204372-
  9888 00004986 656174652045787465-
  9888 0000498F 6E64656420444F5320-
  9888 00004998 506172746974696F6E-
  9888 000049A1 202020202020202020-
  9888 000049AA 202020202020202020-
  9888 000049B3 2020202020202020   
  9889 000049BB 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9889 000049C4 2D2D2D2D2D2D2D2D2D-
  9889 000049CD 2D2D2D2D2D2D2D2D2D-
  9889 000049D6 2D2D2D2D2D2D2D2D2D-
  9889 000049DF 2D2D2D2D2D2D2D2D2D-
  9889 000049E8 2D2D2D2D2D2D2D2D2D-
  9889 000049F1 2D2D2D2D2D2D2D2D2D-
  9889 000049FA 2D2D2D2D2D2D2D2D2D-
  9889 00004A03 2D2D2D2D2D2D2D2D   
  9890 00004A0B 0D0A00                  	db	0Dh, 0Ah, 0
  9891                                  
  9892                                  msg_create_logical_drive_h:
  9893 00004A0E 0D0A                    	db	0Dh, 0Ah
  9894 00004A10 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9894 00004A19 2D2D2D2D2D2D2D2D2D-
  9894 00004A22 2D2D2D2D2D2D2D2D2D-
  9894 00004A2B 2D2D2D2D2D2D2D2D2D-
  9894 00004A34 2D2D2D2D2D2D2D2D2D-
  9894 00004A3D 2D2D2D2D2D2D2D2D2D-
  9894 00004A46 2D2D2D2D2D2D2D2D2D-
  9894 00004A4F 2D2D2D2D2D2D2D2D2D-
  9894 00004A58 2D2D2D2D2D2D2D2D   
  9895 00004A60 202020202020202020-     	db	"                            Create Logical DOS Drive                            "
  9895 00004A69 202020202020202020-
  9895 00004A72 202020202020202020-
  9895 00004A7B 20437265617465204C-
  9895 00004A84 6F676963616C20444F-
  9895 00004A8D 532044726976652020-
  9895 00004A96 202020202020202020-
  9895 00004A9F 202020202020202020-
  9895 00004AA8 2020202020202020   
  9896 00004AB0 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9896 00004AB9 2D2D2D2D2D2D2D2D2D-
  9896 00004AC2 2D2D2D2D2D2D2D2D2D-
  9896 00004ACB 2D2D2D2D2D2D2D2D2D-
  9896 00004AD4 2D2D2D2D2D2D2D2D2D-
  9896 00004ADD 2D2D2D2D2D2D2D2D2D-
  9896 00004AE6 2D2D2D2D2D2D2D2D2D-
  9896 00004AEF 2D2D2D2D2D2D2D2D2D-
  9896 00004AF8 2D2D2D2D2D2D2D2D   
  9897 00004B00 0D0A00                  	db	0Dh, 0Ah, 0
  9898                                  
  9899                                  msg_create_nondos_partition_h:
  9900 00004B03 0D0A                    	db	0Dh, 0Ah
  9901 00004B05 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  9901 00004B0E 2D2D2D2D2D2D2D2D2D-
  9901 00004B17 2D2D2D2D2D2D2D2D2D-
  9901 00004B20 2D2D2D2D2D2D2D2D2D-
  9901 00004B29 2D2D2D2D2D2D2D2D2D-
  9901 00004B32 2D2D2D2D2D2D2D2D2D-
  9901 00004B3B 2D2D2D2D2D2D2D2D2D-
  9901 00004B44 2D2D2D2D2D2D2D2D2D-
  9901 00004B4D 2D2D2D2D2D2D2D2D   
  9902 00004B55 202020202020202020-     	db	"                            Create NON-DOS Partition                            "
  9902 00004B5E 202020202020202020-
  9902 00004B67 202020202020202020-
  9902 00004B70 20437265617465204E-
  9902 00004B79 4F4E2D444F53205061-
  9902 00004B82 72746974696F6E2020-
  9902 00004B8B 202020202020202020-
  9902 00004B94 202020202020202020-
  9902 00004B9D 2020202020202020   
  9903 00004BA5 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  9903 00004BAE 2D2D2D2D2D2D2D2D2D-
  9903 00004BB7 2D2D2D2D2D2D2D2D2D-
  9903 00004BC0 2D2D2D2D2D2D2D2D2D-
  9903 00004BC9 2D2D2D2D2D2D2D2D2D-
  9903 00004BD2 2D2D2D2D2D2D2D2D2D-
  9903 00004BDB 2D2D2D2D2D2D2D2D2D-
  9903 00004BE4 2D2D2D2D2D2D2D2D2D-
  9903 00004BED 2D2D2D2D2D2D2D2D   
  9904 00004BF5 0D0A00                  	db	0Dh, 0Ah, 0
  9905                                  
  9906                                  msg_create_dos_partition_m:
  9907 00004BF8 53656C65637420616E-     	db	"Select an option: "
  9907 00004C01 206F7074696F6E3A20 
  9908 00004C0A 0D0A                    	db	0Dh, 0Ah
  9909 00004C0C 0D0A                    	db	0Dh, 0Ah
  9910 00004C0E 202031292043726561-     	db	"  1) Create Primary DOS partition ", 0Dh, 0Ah
  9910 00004C17 7465205072696D6172-
  9910 00004C20 7920444F5320706172-
  9910 00004C29 746974696F6E200D0A 
  9911 00004C32 202032292043726561-     	db	"  2) Create Extended DOS partition ", 0Dh, 0Ah
  9911 00004C3B 746520457874656E64-
  9911 00004C44 656420444F53207061-
  9911 00004C4D 72746974696F6E200D-
  9911 00004C56 0A                 
  9912 00004C57 202033292043726561-     	db	"  3) Create Logical DOS drive(s) in Extended DOS partition ", 0Dh, 0Ah
  9912 00004C60 7465204C6F67696361-
  9912 00004C69 6C20444F5320647269-
  9912 00004C72 766528732920696E20-
  9912 00004C7B 457874656E64656420-
  9912 00004C84 444F53207061727469-
  9912 00004C8D 74696F6E200D0A     
  9913 00004C94 0D0A                    	db	0Dh, 0Ah	
  9914 00004C96 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
  9914 00004C9F 206F72203020746F20-
  9914 00004CA8 63616E63656C202E2E-
  9914 00004CB1 20                 
  9915 00004CB2 0D0A00                   	db 	0Dh, 0Ah, 0
  9916                                  
  9917                                  msg_create_trdos_partition_s:
  9918 00004CB5 53656C65637420616E-     	db	"Select an option to set partition size: "
  9918 00004CBE 206F7074696F6E2074-
  9918 00004CC7 6F2073657420706172-
  9918 00004CD0 746974696F6E207369-
  9918 00004CD9 7A653A20           
  9919 00004CDD 0D0A                    	db	0Dh, 0Ah
  9920 00004CDF 0D0A                    	db	0Dh, 0Ah
  9921 00004CE1 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah   
  9921 00004CEA 6E64657220636F756E-
  9921 00004CF3 740D0A             
  9922 00004CF6 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
  9922 00004CFF 6D652070657263656E-
  9922 00004D08 746167652028232325-
  9922 00004D11 290D0A             
  9923 00004D14 202053292053656374-     	db	"  S) Sectors (number of 512 bytes)", 0Dh, 0Ah
  9923 00004D1D 6F727320286E756D62-
  9923 00004D26 6572206F6620353132-
  9923 00004D2F 206279746573290D0A 
  9924 00004D38 20204B29204B696C6F-     	db	"  K) Kilo bytes (KB, 2*K sectors)", 0Dh, 0Ah
  9924 00004D41 20627974657320284B-
  9924 00004D4A 422C20322A4B207365-
  9924 00004D53 63746F7273290D0A   
  9925 00004D5B 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
  9925 00004D64 20627974657320284D-
  9925 00004D6D 422C20322A31303234-
  9925 00004D76 2A4D20736563746F72-
  9925 00004D7F 73290D0A           
  9926 00004D83 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
  9926 00004D8C 206279746573202847-
  9926 00004D95 422C20322A31303234-
  9926 00004D9E 2A313032342A472073-
  9926 00004DA7 6563746F7273290D0A 
  9927 00004DB0 0D0A                    	db	0Dh, 0Ah	
  9928 00004DB2 507265737320535041-     	db	"Press SPACE to use whole disk or press ENTER to set sector count .. "
  9928 00004DBB 434520746F20757365-
  9928 00004DC4 2077686F6C65206469-
  9928 00004DCD 736B206F7220707265-
  9928 00004DD6 737320454E54455220-
  9928 00004DDF 746F20736574207365-
  9928 00004DE8 63746F7220636F756E-
  9928 00004DF1 74202E2E20         
  9929                                  msg_press_esc_to_cancel:
  9930 00004DF6 0D0A                     	db	0Dh, 0Ah
  9931 00004DF8 285072657373204553-     	db	"(Press ESC to CANCEL) "
  9931 00004E01 4320746F2043414E43-
  9931 00004E0A 454C2920           
  9932 00004E0E 0D0A00                  	db 	0Dh, 0Ah, 0
  9933                                  
  9934                                  msg_use_whole_disk:
  9935 00004E11 446F20796F75207761-     	db	"Do you want to use WHOLE disk !? (Y/N)", 0
  9935 00004E1A 6E7420746F20757365-
  9935 00004E23 2057484F4C45206469-
  9935 00004E2C 736B20213F2028592F-
  9935 00004E35 4E2900             
  9936                                  
  9937                                  msg_use_all_space:
  9938 00004E38 446F20796F75207761-     	db	"Do you want to use all of available space !? (Y/N)", 0
  9938 00004E41 6E7420746F20757365-
  9938 00004E4A 20616C6C206F662061-
  9938 00004E53 7661696C61626C6520-
  9938 00004E5C 737061636520213F20-
  9938 00004E65 28592F4E2900       
  9939                                  
  9940                                  msg_use_entire_ep_space:
  9941 00004E6B 446F20796F75207761-     	db	"Do you want to use entire extended partition space !? (Y/N)", 0
  9941 00004E74 6E7420746F20757365-
  9941 00004E7D 20656E746972652065-
  9941 00004E86 7874656E6465642070-
  9941 00004E8F 6172746974696F6E20-
  9941 00004E98 737061636520213F20-
  9941 00004EA1 28592F4E2900       
  9942                                  
  9943                                  msg_partition_size:
  9944 00004EA7 0D0A                    	db	0Dh, 0Ah
  9945 00004EA9 0D0A                    	db	0Dh, 0Ah
  9946 00004EAB 506172746974696F6E-     	db	"Partition size ("
  9946 00004EB4 2073697A652028     
  9947                                  msg_partition_size_x:
  9948 00004EBB 3F29203A20              	db	"?) : "
  9949 00004EC0 00                      	db	0
  9950                                  
  9951                                  msg_partition_type:
  9952 00004EC1 0D0A                    	db	0Dh, 0Ah
  9953 00004EC3 0D0A                    	db	0Dh, 0Ah
  9954 00004EC5 506172746974696F6E-     	db	"Partition type : "
  9954 00004ECE 2074797065203A20   
  9955 00004ED6 00                      	db	0
  9956                                  
  9957                                  msg_ptype_num:
  9958 00004ED7 3030680D0A00            	db	"00h", 0Dh, 0Ah, 0
  9959                                  
  9960                                  msg_partition_type_error:
  9961 00004EDD 506172746974696F6E-     	db	"Partition size is not proper for selected partition type !"
  9961 00004EE6 2073697A6520697320-
  9961 00004EEF 6E6F742070726F7065-
  9961 00004EF8 7220666F722073656C-
  9961 00004F01 656374656420706172-
  9961 00004F0A 746974696F6E207479-
  9961 00004F13 70652021           
  9962 00004F17 0D0A                    	db	0Dh, 0Ah
  9963                                  msg_any_key_to_retry:
  9964 00004F19 28507265737320616E-     	db	"(Press any key to retry..)"
  9964 00004F22 79206B657920746F20-
  9964 00004F2B 72657472792E2E29   
  9965 00004F33 0D0A00                  	db	0Dh, 0Ah, 0
  9966                                  
  9967                                  msg_partition_size_overs:
  9968 00004F36 0D0A                    	db	0Dh, 0Ah
  9969 00004F38 506172746974696F6E-     	db	"Partition size overs the disk capacity !"
  9969 00004F41 2073697A65206F7665-
  9969 00004F4A 727320746865206469-
  9969 00004F53 736B20636170616369-
  9969 00004F5C 74792021           
  9970 00004F60 0D0A                    	db	0Dh, 0Ah
  9971 00004F62 28507265737320454E-     	db	"(Press ENTER to use WHOLE disk or press ESC key to retry..)" 
  9971 00004F6B 54455220746F207573-
  9971 00004F74 652057484F4C452064-
  9971 00004F7D 69736B206F72207072-
  9971 00004F86 65737320455343206B-
  9971 00004F8F 657920746F20726574-
  9971 00004F98 72792E2E29         
  9972 00004F9D 0D0A00                  	db	0Dh, 0Ah, 0
  9973                                  
  9974                                  msg_ext_partition_error:
  9975 00004FA0 457874656E64656420-     	db	"Extended partition must be created after primary partition !"
  9975 00004FA9 706172746974696F6E-
  9975 00004FB2 206D75737420626520-
  9975 00004FBB 637265617465642061-
  9975 00004FC4 66746572207072696D-
  9975 00004FCD 617279207061727469-
  9975 00004FD6 74696F6E2021       
  9976 00004FDC 0D0A00                  	db	0Dh, 0Ah,0
  9977                                  
  9978                                  msg_logical_drive_error:
  9979 00004FDF 5072696D6172792061-     	db	"Primary and extended partitions must be created before logical drive !"
  9979 00004FE8 6E6420657874656E64-
  9979 00004FF1 656420706172746974-
  9979 00004FFA 696F6E73206D757374-
  9979 00005003 206265206372656174-
  9979 0000500C 6564206265666F7265-
  9979 00005015 206C6F676963616C20-
  9979 0000501E 64726976652021     
  9980 00005025 0D0A00                  	db	0Dh, 0Ah,0
  9981                                  
  9982                                  msg_cylinder_boundary_set:
  9983 00005028 0D0A                    	db	0Dh, 0Ah
  9984 0000502A 446F20796F75207761-     	db	"Do you want to adjust partition size to cylinder boundary ? (Y/N)"
  9984 00005033 6E7420746F2061646A-
  9984 0000503C 757374207061727469-
  9984 00005045 74696F6E2073697A65-
  9984 0000504E 20746F2063796C696E-
  9984 00005057 64657220626F756E64-
  9984 00005060 617279203F2028592F-
  9984 00005069 4E29               
  9985 0000506B 00                      	db	0
  9986                                  
  9987                                  	; 2019 - 2020 (hdimage.s)
  9988                                  ;msg_selected_partition:
  9989                                  ;	db	"                                 PARTITION 0                                    "
  9990                                  ;	db	"================================================================================"
  9991                                  ;	db	"        S  BH  BS  BC  FS  EH  ES  EC    START SEC   SECTORS   FILE SYSTEM      "
  9992                                  ;	db	"--------------------------------------------------------------------------------"
  9993                                  ;pt_row: db	"                                                                                "
  9994                                  ;	db	"================================================================================"
  9995                                  ;	db	0
  9996                                  
  9997                                  	; 24/10/2020 (fdisk3.s)
  9998                                  msg_selected_partition:
  9999 0000506C 202020202020202020-     	db	"                                 PARTITION 0                                    "
  9999 00005075 202020202020202020-
  9999 0000507E 202020202020202020-
  9999 00005087 202020202020504152-
  9999 00005090 544954494F4E203020-
  9999 00005099 202020202020202020-
  9999 000050A2 202020202020202020-
  9999 000050AB 202020202020202020-
  9999 000050B4 2020202020202020   
 10000 000050BC 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 10000 000050C5 3D3D3D3D3D3D3D3D3D-
 10000 000050CE 3D3D3D3D3D3D3D3D3D-
 10000 000050D7 3D3D3D3D3D3D3D3D3D-
 10000 000050E0 3D3D3D3D3D3D3D3D3D-
 10000 000050E9 3D3D3D3D3D3D3D3D3D-
 10000 000050F2 3D3D3D3D3D3D3D3D3D-
 10000 000050FB 3D3D3D3D3D3D3D3D3D-
 10000 00005104 3D3D3D3D3D3D3D3D   
 10001 0000510C 202020202020205320-     	db	"       S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS   FILE SYSTEM      "
 10001 00005115 204248202042532020-
 10001 0000511E 424320204653202045-
 10001 00005127 482020455320204543-
 10001 00005130 202020535441525420-
 10001 00005139 534543542020202053-
 10001 00005142 4543544F5253202020-
 10001 0000514B 46494C452053595354-
 10001 00005154 454D202020202020   
 10002 0000515C 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 10002 00005165 2D2D2D2D2D2D2D2D2D-
 10002 0000516E 2D2D2D2D2D2D2D2D2D-
 10002 00005177 2D2D2D2D2D2D2D2D2D-
 10002 00005180 2D2D2D2D2D2D2D2D2D-
 10002 00005189 2D2D2D2D2D2D2D2D2D-
 10002 00005192 2D2D2D2D2D2D2D2D2D-
 10002 0000519B 2D2D2D2D2D2D2D2D2D-
 10002 000051A4 2D2D2D2D2D2D2D2D   
 10003 000051AC 202020202020202020-     pt_row:	db	"                                                                                "
 10003 000051B5 202020202020202020-
 10003 000051BE 202020202020202020-
 10003 000051C7 202020202020202020-
 10003 000051D0 202020202020202020-
 10003 000051D9 202020202020202020-
 10003 000051E2 202020202020202020-
 10003 000051EB 202020202020202020-
 10003 000051F4 2020202020202020   
 10004 000051FC 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 10004 00005205 3D3D3D3D3D3D3D3D3D-
 10004 0000520E 3D3D3D3D3D3D3D3D3D-
 10004 00005217 3D3D3D3D3D3D3D3D3D-
 10004 00005220 3D3D3D3D3D3D3D3D3D-
 10004 00005229 3D3D3D3D3D3D3D3D3D-
 10004 00005232 3D3D3D3D3D3D3D3D3D-
 10004 0000523B 3D3D3D3D3D3D3D3D3D-
 10004 00005244 3D3D3D3D3D3D3D3D   
 10005 0000524C 00                      	db	0
 10006                                  msg_boot_indicator:
 10007 0000524D 0D0A                    	db	0Dh, 0Ah
 10008 0000524F 20202020426F6F7420-     	db	"    Boot Indicator : ", 0 ; "YES", "NO"
 10008 00005258 496E64696361746F72-
 10008 00005261 203A2000           
 10009                                  msg_starting_head:
 10010 00005265 0D0A                    	db	0Dh, 0Ah
 10011 00005267 202020202053746172-     	db 	"     Starting Head : ", 0
 10011 00005270 74696E672048656164-
 10011 00005279 203A2000           
 10012                                  msg_starting_sector:
 10013 0000527D 0D0A                    	db	0Dh, 0Ah
 10014 0000527F 202020537461727469-     	db	"   Starting Sector : ", 0
 10014 00005288 6E6720536563746F72-
 10014 00005291 203A2000           
 10015                                  msg_starting_cylinder:
 10016 00005295 0D0A                    	db	0Dh, 0Ah
 10017 00005297 205374617274696E67-     	db	" Starting Cylinder : ", 0
 10017 000052A0 2043796C696E646572-
 10017 000052A9 203A2000           
 10018                                  msg_system_id:
 10019 000052AD 0D0A                    	db	0Dh, 0Ah
 10020 000052AF 202020202020202020-     	db	"         System ID : ", 0
 10020 000052B8 53797374656D204944-
 10020 000052C1 203A2000           
 10021                                  msg_ending_head:
 10022 000052C5 0D0A                    	db	0Dh, 0Ah
 10023 000052C7 20202020202020456E-     	db 	"       Ending Head : ", 0
 10023 000052D0 64696E672048656164-
 10023 000052D9 203A2000           
 10024                                  msg_ending_sector:
 10025 000052DD 0D0A                    	db	0Dh, 0Ah
 10026 000052DF 2020202020456E6469-     	db	"     Ending Sector : ", 0
 10026 000052E8 6E6720536563746F72-
 10026 000052F1 203A2000           
 10027                                  msg_ending_cylinder:
 10028 000052F5 0D0A                    	db	0Dh, 0Ah
 10029 000052F7 202020456E64696E67-     	db	"   Ending Cylinder : ", 0
 10029 00005300 2043796C696E646572-
 10029 00005309 203A2000           
 10030                                  msg_relative_sectors:
 10031 0000530D 0D0A                    	db	0Dh, 0Ah
 10032 0000530F 0D0A                    	db	0Dh, 0Ah
 10033 00005311 202052656C61746976-     	db	"  Relative Sectors : ", 0
 10033 0000531A 6520536563746F7273-
 10033 00005323 203A2000           
 10034                                  msg_total_sectors:
 10035 00005327 0D0A                    	db	0Dh, 0Ah
 10036 00005329 2020202020546F7461-     	db	"     Total Sectors : ", 0
 10036 00005332 6C20536563746F7273-
 10036 0000533B 203A2000           
 10037                                  
 10038                                  msg_format_stage:
 10039 0000533F 0D0A                    	db	0Dh, 0Ah
 10040 00005341 507265737320454E54-     	db	"Press ENTER to FORMAT disk partition "
 10040 0000534A 455220746F20464F52-
 10040 00005353 4D4154206469736B20-
 10040 0000535C 706172746974696F6E-
 10040 00005365 20                 
 10041                                  partition_num_chr:
 10042 00005366 30                      	db	"0"
 10043 00005367 206F72207072657373-     	db	" or press ESC to EXIT.."
 10043 00005370 2045534320746F2045-
 10043 00005379 5849542E2E         
 10044 0000537E 00                      	db	0
 10045                                  msg_partition_edit:
 10046 0000537F 0D0A                    	db	0Dh, 0Ah
 10047 00005381 2E2E206F7220707265-     	db	".. or press SPACE to EDIT partition table."
 10047 0000538A 737320535041434520-
 10047 00005393 746F20454449542070-
 10047 0000539C 6172746974696F6E20-
 10047 000053A5 7461626C652E       
 10048 000053AB 0D0A00                  	db	0Dh, 0Ah, 0
 10049                                  
 10050                                  msg_edit_or_exit:
 10051 000053AE 0D0A                    	db 	0Dh, 0Ah
 10052 000053B0 507265737320454E54-     	db	"Press ENTER to continue or press ESC to exit.."
 10052 000053B9 455220746F20636F6E-
 10052 000053C2 74696E7565206F7220-
 10052 000053CB 707265737320455343-
 10052 000053D4 20746F20657869742E-
 10052 000053DD 2E                 
 10053 000053DE 00                      	db	0
 10054                                  
 10055                                  msg_overwrite_question1:
 10056 000053DF 0D0A                    	db	0Dh, 0Ah
 10057 000053E1 446F20796F75207761-     	db	'Do you want to overwrite '
 10057 000053EA 6E7420746F206F7665-
 10057 000053F3 72777269746520     
 10058 000053FA 27                      	db	27h
 10059 000053FB 00                      	db	0
 10060                                  
 10061                                  msg_overwrite_question2: 
 10062 000053FC 27                      	db	27h
 10063 000053FD 2066696C6520            	db	' file '
 10064 00005403 00                      	db	0
 10065                                  
 10066                                  msg_format_question:
 10067 00005404 0D0A                    	db	0Dh, 0Ah
 10068 00005406 446F20796F75207761-     	db	"Do you want to format partition "
 10068 0000540F 6E7420746F20666F72-
 10068 00005418 6D6174207061727469-
 10068 00005421 74696F6E20         
 10069                                  partition_num_txt:
 10070 00005426 3020                    	db	 "0 "
 10071                                  msg_yes_no:
 10072 00005428 285965732F4E6F293F-     	db	'(Yes/No)? ', 0
 10072 00005431 2000               
 10073                                  
 10074                                  msg_writing_mbr:
 10075 00005433 57726974696E67206D-     	db	"Writing masterboot sector...", 0
 10075 0000543C 6173746572626F6F74-
 10075 00005445 20736563746F722E2E-
 10075 0000544E 2E00               
 10076                                  
 10077                                  msg_writing_disk_sectors:
 10078 00005450 57726974696E672064-     	db	"Writing disk sector: ", 0
 10078 00005459 69736B20736563746F-
 10078 00005462 723A2000           
 10079                                  
 10080                                  Msg_Writing_Boot_Sector:
 10081 00005466 57726974696E672074-     	db	"Writing trdos boot sector...", 0
 10081 0000546F 72646F7320626F6F74-
 10081 00005478 20736563746F722E2E-
 10081 00005481 2E00               
 10082                                  
 10083                                  Msg_Writing_Root_Dir:
 10084 00005483 57726974696E672072-     	db	"Writing root directory sectors...", 0
 10084 0000548C 6F6F74206469726563-
 10084 00005495 746F72792073656374-
 10084 0000549E 6F72732E2E2E00     
 10085                                  
 10086                                  Msg_Writing_Data_Sectors:
 10087 000054A5 57726974696E672064-     	db	"Writing data sector: ", 0
 10087 000054AE 61746120736563746F-
 10087 000054B7 723A2000           
 10088                                  
 10089                                  Sector_Str:
 10090 000054BB 3030303030303000        	db	"0000000", 0
 10091                                  Cursor_Pos:
 10092 000054C3 0000                    	dw	0
 10093                                  
 10094                                  Msg_Writing_FAT_Sectors:
 10095 000054C5 57726974696E672046-     	db	"Writing FAT sectors...", 0
 10095 000054CE 415420736563746F72-
 10095 000054D7 732E2E2E00         
 10096                                  
 10097                                  StrVolumeName:
 10098                                  	;times 	12 db  0
 10099 000054DC 00<rep 41h>             	times	65 db 0  ; 05/01/2018 (fs1 volume name)	
 10100                                  
 10101                                  Msg_Volume_Name:
 10102 0000551D 0D0A                    	db	0Dh, 0Ah
 10103 0000551F 0D0A                    	db	0Dh, 0Ah
 10104 00005521 566F6C756D65204E61-     	db	"Volume Name: ", 0
 10104 0000552A 6D653A2000         
 10105                                  
 10106                                  Msg_Volume_Serial:
 10107 0000552F 566F6C756D65205365-     	db	"Volume Serial No: "
 10107 00005538 7269616C204E6F3A20 
 10108                                  Vol_Serial1:
 10109 00005541 30303030                	db	"0000"
 10110 00005545 2D                      	db	"-"
 10111                                  Vol_Serial2:
 10112 00005546 30303030                	db	"0000"
 10113 0000554A 0D0A00                  	db	0Dh, 0Ah, 0
 10114                                  
 10115                                  msg_cluster_count:
 10116 0000554D 436C75737465722043-     	db	"Cluster Count: ", 0
 10116 00005556 6F756E743A2000     
 10117                                  cluster_count_str:
 10118 0000555D 30303030303030          	db	"0000000"
 10119 00005564 0D0A00                  	db	0Dh, 0Ah, 0
 10120                                  msg_formatting:
 10121 00005567 466F726D617474696E-     	db	"Formatting ", 0
 10121 00005570 672000             
 10122                                  format_percent_str:
 10123 00005573 30303025                	db	"000%"
 10124 00005577 00                      	db	0
 10125                                  
 10126                                  Msg_3dot_OK:
 10127 00005578 2E2E2E                  	db	"..."
 10128                                  Msg_OK:
 10129 0000557B 204F4B2E                	db	' OK.'
 10130                                  CRLF:
 10131 0000557F 0D0A00                  	db	0Dh, 0Ah, 0
 10132                                  
 10133                                  Msg_Error:
 10134 00005582 0D0A                    	db	0Dh, 0Ah
 10135 00005584 4572726F72202120        	db	'Error ! '
 10136 0000558C 28                      	db	'('
 10137                                  error_code:
 10138 0000558D 3030                    	dw	3030h
 10139 0000558F 68                      	db	'h'
 10140 00005590 2920                    	db	') '
 10141 00005592 0D0A                    	db	0Dh, 0Ah
 10142 00005594 00                      	db	0
 10143                                  
 10144                                  msg_disk_sectors:
 10145 00005595 546F74616C20446973-     	db	"Total Disk Sectors : ", 0
 10145 0000559E 6B20536563746F7273-
 10145 000055A7 203A2000           
 10146                                  
 10147                                  str_disk_sectors:
 10148                                  	;times	8 db 0
 10149 000055AB 00<rep Bh>              	times	11 db 0 ; 27/10/2020
 10150                                  
 10151                                  msg_ep_size:
 10152 000055B6 457874656E64656420-     	db	"Extended Partition Size in Sectors: ", 0
 10152 000055BF 506172746974696F6E-
 10152 000055C8 2053697A6520696E20-
 10152 000055D1 536563746F72733A20-
 10152 000055DA 00                 
 10153                                  
 10154                                  msg_press_any_key:
 10155 000055DB 0D0A                    	db	0Dh, 0Ah
 10156 000055DD 50726573732061206B-     	db	"Press a key to continue..." 
 10156 000055E6 657920746F20636F6E-
 10156 000055EF 74696E75652E2E2E   
 10157 000055F7 0D0A00                  	db	0Dh, 0Ah, 0
 10158                                  
 10159                                  align 2
 10160                                  
 10161                                  ; Masterboot sector
 10162                                  
 10163                                  MasterBootBuff:
 10164                                  MasterBootCode: 
 10165 000055FA 00<rep 1BEh>            	times	446 db 0
 10166                                  PartitionTable:
 10167 000057B8 00<rep 40h>             	times	64 db 0
 10168                                  MBIDCode:
 10169 000057F8 0000                    	dw	0
 10170                                  
 10171                                  PTable_Buffer:
 10172 000057FA 00<rep 40h>             	times	64 db 0
 10173                                   
 10174 0000583A 286329204572646F67-     	db	'(c) Erdogan TAN 2019-2024'
 10174 00005843 616E2054414E203230-
 10174 0000584C 31392D32303234     
 10175                                  
 10176                                  ; 05/11/2020
 10177 00005853 00                      	db	0
 10178                                  
 10179                                  	; 2019 - 2020 (hdimage.s)
 10180                                  ;p_table_header:
 10181                                  ;	db	"                              ?BR PARTITION TABLE                               "
 10182                                  ;	db	"================================================================================"
 10183                                  ;	db	"       P  S  BH  BS  BC  FS  EH  ES  EC  START SEC  SECTORS  FILE SYSTEM        "
 10184                                  ;	db	"--------------------------------------------------------------------------------"
 10185                                  ;	db	0
 10186                                  ;p_table_footer:
 10187                                  ;	db	"================================================================================"
 10188                                  ;	db	0Dh, 0Ah, 0
 10189                                  
 10190                                  	; 24/10/2020 (fdisk3.s)
 10191                                  p_table_header:
 10192 00005854 202020202020202020-     	db	"                              ?BR PARTITION TABLE                               "
 10192 0000585D 202020202020202020-
 10192 00005866 202020202020202020-
 10192 0000586F 2020203F4252205041-
 10192 00005878 52544954494F4E2054-
 10192 00005881 41424C452020202020-
 10192 0000588A 202020202020202020-
 10192 00005893 202020202020202020-
 10192 0000589C 2020202020202020   
 10193 000058A4 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 10193 000058AD 3D3D3D3D3D3D3D3D3D-
 10193 000058B6 3D3D3D3D3D3D3D3D3D-
 10193 000058BF 3D3D3D3D3D3D3D3D3D-
 10193 000058C8 3D3D3D3D3D3D3D3D3D-
 10193 000058D1 3D3D3D3D3D3D3D3D3D-
 10193 000058DA 3D3D3D3D3D3D3D3D3D-
 10193 000058E3 3D3D3D3D3D3D3D3D3D-
 10193 000058EC 3D3D3D3D3D3D3D3D   
 10194 000058F4 202020502020205320-     	db	"   P   S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS    FILE SYSTEM     "
 10194 000058FD 204248202042532020-
 10194 00005906 424320204653202045-
 10194 0000590F 482020455320204543-
 10194 00005918 202020535441525420-
 10194 00005921 534543542020202053-
 10194 0000592A 4543544F5253202020-
 10194 00005933 2046494C4520535953-
 10194 0000593C 54454D2020202020   
 10195 00005944 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 10195 0000594D 2D2D2D2D2D2D2D2D2D-
 10195 00005956 2D2D2D2D2D2D2D2D2D-
 10195 0000595F 2D2D2D2D2D2D2D2D2D-
 10195 00005968 2D2D2D2D2D2D2D2D2D-
 10195 00005971 2D2D2D2D2D2D2D2D2D-
 10195 0000597A 2D2D2D2D2D2D2D2D2D-
 10195 00005983 2D2D2D2D2D2D2D2D2D-
 10195 0000598C 2D2D2D2D2D2D2D2D   
 10196 00005994 00                      	db	0
 10197                                  p_table_footer:
 10198 00005995 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 10198 0000599E 3D3D3D3D3D3D3D3D3D-
 10198 000059A7 3D3D3D3D3D3D3D3D3D-
 10198 000059B0 3D3D3D3D3D3D3D3D3D-
 10198 000059B9 3D3D3D3D3D3D3D3D3D-
 10198 000059C2 3D3D3D3D3D3D3D3D3D-
 10198 000059CB 3D3D3D3D3D3D3D3D3D-
 10198 000059D4 3D3D3D3D3D3D3D3D3D-
 10198 000059DD 3D3D3D3D3D3D3D3D   
 10199 000059E5 0D0A00                  	db	0Dh, 0Ah, 0
 10200                                  
 10201                                  mbr_editing_options:
 10202 000059E8 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 10203 000059EC 4D4252205061727469-     	db	"MBR Partition Table Editing Options:"
 10203 000059F5 74696F6E205461626C-
 10203 000059FE 652045646974696E67-
 10203 00005A07 204F7074696F6E733A 
 10204 00005A10 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10205 00005A14 20202020202020312E-     	db	"       1. Create Partition", 0Dh, 0Ah
 10205 00005A1D 204372656174652050-
 10205 00005A26 6172746974696F6E0D-
 10205 00005A2F 0A                 
 10206 00005A30 20202020202020322E-     	db	"       2. Set Active Partition", 0Dh, 0Ah
 10206 00005A39 205365742041637469-
 10206 00005A42 766520506172746974-
 10206 00005A4B 696F6E0D0A         
 10207 00005A50 20202020202020332E-     	db	"       3. Delete Partition", 0Dh, 0Ah  
 10207 00005A59 2044656C6574652050-
 10207 00005A62 6172746974696F6E0D-
 10207 00005A6B 0A                 
 10208 00005A6C 20202020202020342E-     	db	"       4. Write Current Partition Table", 0Dh, 0Ah, 0
 10208 00005A75 205772697465204375-
 10208 00005A7E 7272656E7420506172-
 10208 00005A87 746974696F6E205461-
 10208 00005A90 626C650D0A00       
 10209                                  
 10210                                  enter_option_number_msg:
 10211 00005A96 0D0A                    	db	0Dh, 0Ah
 10212 00005A98 456E74657220746865-     	db	"Enter the option number or press ESC to exit ...", 0Dh, 0Ah
 10212 00005AA1 206F7074696F6E206E-
 10212 00005AAA 756D626572206F7220-
 10212 00005AB3 707265737320455343-
 10212 00005ABC 20746F206578697420-
 10212 00005AC5 2E2E2E0D0A         
 10213                                  	;db	0Dh, 0Ah, 0
 10214 00005ACA 00                      	db	0 
 10215                                  
 10216                                  msg_zero_partition_size:  ; 19/02/2019
 10217 00005ACB 0D0A                    	db	0Dh, 0Ah
 10218 00005ACD 506172746974696F6E-     	db	"Partition size input must not be ZERO !", 0Dh, 0Ah
 10218 00005AD6 2073697A6520696E70-
 10218 00005ADF 7574206D757374206E-
 10218 00005AE8 6F74206265205A4552-
 10218 00005AF1 4F20210D0A         
 10219 00005AF6 285072657373204553-     	db	"(Press ESC to exit or press another key to retry..)", 0Dh, 0Ah
 10219 00005AFF 4320746F2065786974-
 10219 00005B08 206F72207072657373-
 10219 00005B11 20616E6F7468657220-
 10219 00005B1A 6B657920746F207265-
 10219 00005B23 7472792E2E290D0A   
 10220 00005B2B 00                      	db	0 
 10221                                  
 10222                                  msg_empty_pt:
 10223 00005B2C 0D0A                    	db	0Dh, 0Ah
 10224 00005B2E 456D70747920706172-     	db	"Empty partition table !", 0Dh, 0Ah
 10224 00005B37 746974696F6E207461-
 10224 00005B40 626C6520210D0A     
 10225 00005B47 28412076616C696420-     	db	"(A valid partition must be created at first..)", 0Dh, 0Ah
 10225 00005B50 706172746974696F6E-
 10225 00005B59 206D75737420626520-
 10225 00005B62 637265617465642061-
 10225 00005B6B 742066697273742E2E-
 10225 00005B74 290D0A             
 10226 00005B77 00                      	db	0
 10227                                  
 10228                                  msg_full_pt:
 10229 00005B78 0D0A                    	db	0Dh, 0Ah
 10230 00005B7A 546865726520697320-     	db	"There is not a free partition table entry ", 0
 10230 00005B83 6E6F74206120667265-
 10230 00005B8C 652070617274697469-
 10230 00005B95 6F6E207461626C6520-
 10230 00005B9E 656E7472792000     
 10231                                  msg_to_create_new_p: 
 10232 00005BA5 746F20637265617465-     	db	"to create a new partition !", 0Dh, 0Ah
 10232 00005BAE 2061206E6577207061-
 10232 00005BB7 72746974696F6E2021-
 10232 00005BC0 0D0A               
 10233 00005BC2 00                      	db	0
 10234                                  msg_no_free_space:
 10235 00005BC3 0D0A                    	db	0Dh, 0Ah
 10236 00005BC5 546865726520697320-     	db	"There is not (enough) free space ", 0
 10236 00005BCE 6E6F742028656E6F75-
 10236 00005BD7 676829206672656520-
 10236 00005BE0 73706163652000     
 10237                                  
 10238                                  msg_enter_pn_to_del:
 10239 00005BE7 0D0A                    	db	0Dh, 0Ah
 10240 00005BE9 456E74657220706172-     	db	"Enter partition number to delete: "
 10240 00005BF2 746974696F6E206E75-
 10240 00005BFB 6D62657220746F2064-
 10240 00005C04 656C6574653A20     
 10241                                  chr_del_pnum1:
 10242 00005C0B 00                      	db	0       
 10243 00005C0C 0D0A00                  	db	0Dh, 0Ah, 0
 10244                                  
 10245                                  msg_delete_partition_q:
 10246 00005C0F 0D0A                    	db 	0Dh, 0Ah
 10247 00005C11 5741524E494E472120-     	db 	"WARNING! All of data in the selected partition will be lost", 0Dh, 0Ah
 10247 00005C1A 416C6C206F66206461-
 10247 00005C23 746120696E20746865-
 10247 00005C2C 2073656C6563746564-
 10247 00005C35 20706172746974696F-
 10247 00005C3E 6E2077696C6C206265-
 10247 00005C47 206C6F73740D0A     
 10248 00005C4E 202020202020202020-     	db	"         after you write changed partition table to disk !!", 0Dh, 0Ah
 10248 00005C57 616674657220796F75-
 10248 00005C60 207772697465206368-
 10248 00005C69 616E67656420706172-
 10248 00005C72 746974696F6E207461-
 10248 00005C7B 626C6520746F206469-
 10248 00005C84 736B2021210D0A     
 10249 00005C8B 0D0A                    	db	0Dh, 0Ah
 10250 00005C8D 446F20796F75207761-     	db	"Do you want to delete PARTITION "
 10250 00005C96 6E7420746F2064656C-
 10250 00005C9F 657465205041525449-
 10250 00005CA8 54494F4E20         
 10251                                  chr_del_pnum2:
 10252 00005CAD 30                      	db	'0'
 10253 00005CAE 203F2028592F4E2920-     	db	' ? (Y/N) ', 0
 10253 00005CB7 00                 
 10254                                  
 10255                                  _msg_YES:
 10256 00005CB8 20                      	db	 20h
 10257                                  msg_YES:
 10258 00005CB9 5945532000              	db	'YES ', 0
 10259                                  _msg_NO:
 10260 00005CBE 20                      	db	20h
 10261                                  msg_NO:
 10262 00005CBF 4E4F2000                	db	'NO ', 0
 10263                                  
 10264                                  ; 11/02/2019
 10265                                  msg_write_masterboot_sector:
 10266 00005CC3 0D0A                    	db	0Dh, 0Ah 
 10267 00005CC5 577269746520437572-     	db	"Write Current Partition Table:" 
 10267 00005CCE 72656E742050617274-
 10267 00005CD7 6974696F6E20546162-
 10267 00005CE0 6C653A             
 10268 00005CE3 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10269 00005CE7 20312E205772697465-     	db	" 1. Write Partition Table only", 0Dh, 0Ah
 10269 00005CF0 20506172746974696F-
 10269 00005CF9 6E205461626C65206F-
 10269 00005D02 6E6C790D0A         
 10270 00005D07 20322E205772697465-     	db	" 2. Write Partition Table and Singlix Master Boot Code", 0Dh, 0Ah
 10270 00005D10 20506172746974696F-
 10270 00005D19 6E205461626C652061-
 10270 00005D22 6E642053696E676C69-
 10270 00005D2B 78204D617374657220-
 10270 00005D34 426F6F7420436F6465-
 10270 00005D3D 0D0A               
 10271                                  enter_opt_num_cancel_msg:
 10272 00005D3F 0D0A                    	db	0Dh, 0Ah
 10273 00005D41 456E74657220746865-     	db	"Enter the option number or press ESC to cancel ...", 0
 10273 00005D4A 206F7074696F6E206E-
 10273 00005D53 756D626572206F7220-
 10273 00005D5C 707265737320455343-
 10273 00005D65 20746F2063616E6365-
 10273 00005D6E 6C202E2E2E00       
 10274                                  
 10275                                  msg_writing_ptable:
 10276 00005D74 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah  
 10277 00005D78 57726974696E672070-     	db	"Writing partition table on disk ... ", 0
 10277 00005D81 6172746974696F6E20-
 10277 00005D8A 7461626C65206F6E20-
 10277 00005D93 6469736B202E2E2E20-
 10277 00005D9C 00                 
 10278                                  _msg_OK:
 10279                                  	;db	7
 10280 00005D9D 0D0A                    	db	0Dh, 0Ah
 10281 00005D9F 4F4B2021                	db	"OK !"
 10282 00005DA3 0D0A00                  	db	0Dh, 0Ah, 0
 10283                                  
 10284                                  option_input:
 10285 00005DA6 205B205D00              	db	' [ ]', 0
 10286                                  
 10287                                  msg_enter_pn_to_act:
 10288 00005DAB 0D0A                    	db	0Dh, 0Ah
 10289 00005DAD 456E74657220706172-     	db	"Enter partition number to set as active: ", 0 
 10289 00005DB6 746974696F6E206E75-
 10289 00005DBF 6D62657220746F2073-
 10289 00005DC8 657420617320616374-
 10289 00005DD1 6976653A2000       
 10290                                  
 10291                                  ; 04/05/2024
 10292                                  ;trdos386_disk_chs_header:
 10293                                  ;	db	0Dh, 0Ah
 10294                                  ;	db	"                     TRDOS 386 (SINGLIX) HARD DISK IMAGE                        "
 10295                                  ;	db 	0
 10296                                  
 10297                                  ;disk_chs_header:
 10298                                  ;	db	0Dh, 0Ah
 10299                                  ;	db	"                                HARD DISK IMAGE                                 "
 10300                                  ;	db 	0
 10301                                  
 10302                                  msg_partition_size_limit:
 10303 00005DD7 0D0A                    	db	0Dh, 0Ah
 10304 00005DD9 506172746974696F6E-     	db	"Partition size overs available free space !"
 10304 00005DE2 2073697A65206F7665-
 10304 00005DEB 727320617661696C61-
 10304 00005DF4 626C65206672656520-
 10304 00005DFD 73706163652021     
 10305 00005E04 0D0A                    	db	0Dh, 0Ah
 10306 00005E06 4D61782E2061766169-     	db 	"Max. available free space is ", 0
 10306 00005E0F 6C61626C6520667265-
 10306 00005E18 652073706163652069-
 10306 00005E21 732000             
 10307                                  
 10308                                  msg_partition_size_limit_r:
 10309 00005E24 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10310 00005E28 28507265737320454E-     	db	"(Press ENTER to use all of available space or press ESC key to retry..) " 
 10310 00005E31 54455220746F207573-
 10310 00005E3A 6520616C6C206F6620-
 10310 00005E43 617661696C61626C65-
 10310 00005E4C 207370616365206F72-
 10310 00005E55 207072657373204553-
 10310 00005E5E 43206B657920746F20-
 10310 00005E67 72657472792E2E2920 
 10311 00005E70 000A00                  	db	0D, 0Ah, 0
 10312                                  
 10313                                  msg_cylinders:
 10314 00005E73 2063796C696E646572-     	db	" cylinders", 0
 10314 00005E7C 7300               
 10315                                  msg_sectors:
 10316 00005E7E 20736563746F727300      	db	" sectors", 0
 10317                                  
 10318                                  ; 02/03/2019
 10319                                  msg_megabytes:
 10320 00005E87 206D65676162797465      	db	" megabyte"
 10321                                  msg_megabytes_s:
 10322 00005E90 0000                    	db	0, 0
 10323                                  
 10324                                  msg_inv_pte:
 10325 00005E92 0D0A                    	db	0Dh, 0Ah
 10326 00005E94 496E76616C69642070-     	db	"Invalid partition table entry ! (P"
 10326 00005E9D 6172746974696F6E20-
 10326 00005EA6 7461626C6520656E74-
 10326 00005EAF 72792021202850     
 10327 00005EB6 3F290D0A                inv_pte_num: db	"?)", 0Dh, 0Ah
 10328 00005EBA 28507265737320454E-     	db	"(Press ENTER to DELETE or press ESC to EXIT..)"
 10328 00005EC3 54455220746F204445-
 10328 00005ECC 4C455445206F722070-
 10328 00005ED5 726573732045534320-
 10328 00005EDE 746F20455849542E2E-
 10328 00005EE7 29                 
 10329 00005EE8 0D0A00                  	db	0Dh, 0Ah, 0
 10330                                  
 10331                                  msg_ext_partition_exists:
 10332 00005EEB 457874656E64656420-     	db	"Extended partition already exists !"
 10332 00005EF4 706172746974696F6E-
 10332 00005EFD 20616C726561647920-
 10332 00005F06 6578697374732021   
 10333 00005F0E 0D0A00                  	db	0Dh, 0Ah, 0
 10334                                  
 10335                                  msg_defective_pt:
 10336 00005F11 0D0A                    	db	0Dh, 0Ah
 10337 00005F13 446566656374697665-     	db	"Defective partition table !", 0
 10337 00005F1C 20706172746974696F-
 10337 00005F25 6E207461626C652021-
 10337 00005F2E 00                 
 10338                                  
 10339                                  ; 27/02/2019
 10340                                  msg_ext_part_del_error:
 10341 00005F2F 0D0A                    	db	0Dh, 0Ah
 10342 00005F31 457874656E64656420-     	db	"Extended partition must be deleted after logical drive(s) !"
 10342 00005F3A 706172746974696F6E-
 10342 00005F43 206D75737420626520-
 10342 00005F4C 64656C657465642061-
 10342 00005F55 66746572206C6F6769-
 10342 00005F5E 63616C206472697665-
 10342 00005F67 2873292021         
 10343 00005F6C 0D0A00                  	db	0Dh, 0Ah, 0
 10344                                  
 10345                                  msg_cancel_continue:
 10346 00005F6F 285072657373204553-     	db	"(Press ESC to cancel or press another key to continue..)"
 10346 00005F78 4320746F2063616E63-
 10346 00005F81 656C206F7220707265-
 10346 00005F8A 737320616E6F746865-
 10346 00005F93 72206B657920746F20-
 10346 00005F9C 636F6E74696E75652E-
 10346 00005FA5 2E29               
 10347 00005FA7 0D0A00                  	db	0Dh, 0Ah, 0
 10348                                  
 10349                                  msg_delete_ldd:
 10350 00005FAA 0D0A                    	db	0Dh, 0Ah
 10351 00005FAC 0D0A                    	db	0Dh, 0Ah
 10352 00005FAE 44656C657465204C6F-     	db	"Delete Logical (DOS) Drive:"
 10352 00005FB7 676963616C2028444F-
 10352 00005FC0 53292044726976653A 
 10353 00005FC9 0D0A                    	db	0Dh, 0Ah
 10354 00005FCB 50726573732044454C-     	db	"Press DELETE key to delete logical disk partition "
 10354 00005FD4 455445206B65792074-
 10354 00005FDD 6F2064656C65746520-
 10354 00005FE6 6C6F676963616C2064-
 10354 00005FEF 69736B207061727469-
 10354 00005FF8 74696F6E20         
 10355 00005FFD 3F2E                    lddp_num: db	"?."
 10356 00005FFF 0D0A00                  	db	0Dh, 0Ah, 0
 10357                                  
 10358                                  msg_delete_ext_part:
 10359 00006002 0D0A                    	db	0Dh, 0Ah
 10360 00006004 0D0A                    	db	0Dh, 0Ah
 10361 00006006 44656C657465204578-     	db	"Delete Extended (DOS) Partition:"
 10361 0000600F 74656E646564202844-
 10361 00006018 4F5329205061727469-
 10361 00006021 74696F6E3A         
 10362 00006026 0D0A                    	db	0Dh, 0Ah
 10363 00006028 507265737320454E54-     	db	"Press ENTER to delete or press ESC to cancel.."
 10363 00006031 455220746F2064656C-
 10363 0000603A 657465206F72207072-
 10363 00006043 657373204553432074-
 10363 0000604C 6F2063616E63656C2E-
 10363 00006055 2E                 
 10364 00006056 0D0A00                  	db	0Dh, 0Ah, 0
 10365                                  
 10366                                  str_display_ebr_pt:
 10367 00006059 285072657373205350-     	db	"(Press SPACE to edit EXTENDED Partition Table)", 0Dh, 0Ah, 0
 10367 00006062 41434520746F206564-
 10367 0000606B 697420455854454E44-
 10367 00006074 454420506172746974-
 10367 0000607D 696F6E205461626C65-
 10367 00006086 290D0A00           
 10368                                  
 10369                                  ebr_editing_options:
 10370 0000608A 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 10371 0000608E 457874656E64656420-     	db	"Extended Partition Table Editing Options:" 
 10371 00006097 506172746974696F6E-
 10371 000060A0 205461626C65204564-
 10371 000060A9 6974696E67204F7074-
 10371 000060B2 696F6E733A         
 10372 000060B7 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 10373 000060BB 20202020202020312E-     	db	"       1. Create Logical DOS Drive", 0Dh, 0Ah
 10373 000060C4 20437265617465204C-
 10373 000060CD 6F676963616C20444F-
 10373 000060D6 532044726976650D0A 
 10374 000060DF 20202020202020322E-     	db	"       2. Delete Logical (DOS) Drive(s)",0Dh, 0Ah, 0
 10374 000060E8 2044656C657465204C-
 10374 000060F1 6F676963616C202844-
 10374 000060FA 4F5329204472697665-
 10374 00006103 2873290D0A00       
 10375                                  
 10376                                  msg_delete_ldd_q:
 10377 00006109 0D0A                    	db 	0Dh, 0Ah
 10378 0000610B 5741524E494E47210D-     	db 	"WARNING!", 0Dh, 0Ah 
 10378 00006114 0A                 
 10379 00006115 416C6C206F66206461-     	db	"All of data in logical (DOS) drive(s) will be lost !!", 0Dh, 0Ah
 10379 0000611E 746120696E206C6F67-
 10379 00006127 6963616C2028444F53-
 10379 00006130 292064726976652873-
 10379 00006139 292077696C6C206265-
 10379 00006142 206C6F73742021210D-
 10379 0000614B 0A                 
 10380 0000614C 0D0A                    	db	0Dh, 0Ah
 10381 0000614E 446F20796F75207761-     	db	"Do you want to continue ? (Y/N) ", 0
 10381 00006157 6E7420746F20636F6E-
 10381 00006160 74696E7565203F2028-
 10381 00006169 592F4E292000       
 10382                                  
 10383                                  msg_create_ldd_max_error:
 10384 0000616F 0D0A                    	db	0Dh, 0Ah
 10385 00006171 50726F6772616D206C-     	db	"Program limit for logical dos drive count is 4 !"
 10385 0000617A 696D697420666F7220-
 10385 00006183 6C6F676963616C2064-
 10385 0000618C 6F7320647269766520-
 10385 00006195 636F756E7420697320-
 10385 0000619E 342021             
 10386 000061A1 0D0A00                  	db 	0Dh, 0Ah, 0
 10387                                  
 10388                                  msg_c_ldd_unused_warning:
 10389 000061A4 0D0A                    	db	0Dh, 0Ah
 10390 000061A6 546865726520697320-     	db	"There is unused extended partition space after logical dos drive "
 10390 000061AF 756E75736564206578-
 10390 000061B8 74656E646564207061-
 10390 000061C1 72746974696F6E2073-
 10390 000061CA 706163652061667465-
 10390 000061D3 72206C6F676963616C-
 10390 000061DC 20646F732064726976-
 10390 000061E5 6520               
 10391                                  char_lddn:
 10392 000061E7 342021                  	db	"4 !"
 10393 000061EA 0D0A                    	db 	0Dh, 0Ah
 10394 000061EC 285072657373204553-     	db	"(Press ESC to add unused space or press ENTER to continue.)"
 10394 000061F5 4320746F2061646420-
 10394 000061FE 756E75736564207370-
 10394 00006207 616365206F72207072-
 10394 00006210 65737320454E544552-
 10394 00006219 20746F20636F6E7469-
 10394 00006222 6E75652E29         
 10395 00006227 0D0A00                  	db 	0Dh, 0Ah, 0
 10396                                  
 10397                                  msg_create_ldd_s:
 10398 0000622A 53656C65637420616E-     	db	"Select an option to set logical dos drive size: "
 10398 00006233 206F7074696F6E2074-
 10398 0000623C 6F20736574206C6F67-
 10398 00006245 6963616C20646F7320-
 10398 0000624E 64726976652073697A-
 10398 00006257 653A20             
 10399 0000625A 0D0A                    	db	0Dh, 0Ah
 10400 0000625C 0D0A                    	db	0Dh, 0Ah
 10401 0000625E 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah   
 10401 00006267 6E64657220636F756E-
 10401 00006270 740D0A             
 10402 00006273 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
 10402 0000627C 6D652070657263656E-
 10402 00006285 746167652028232325-
 10402 0000628E 290D0A             
 10403 00006291 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
 10403 0000629A 20627974657320284D-
 10403 000062A3 422C20322A31303234-
 10403 000062AC 2A4D20736563746F72-
 10403 000062B5 73290D0A           
 10404 000062B9 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
 10404 000062C2 206279746573202847-
 10404 000062CB 422C20322A31303234-
 10404 000062D4 2A313032342A472073-
 10404 000062DD 6563746F7273290D0A 
 10405 000062E6 0D0A                    	db	0Dh, 0Ah	
 10406 000062E8 507265737320535041-     	db	"Press SPACE to use entire space or press ENTER to set Megabytes .. ", 0
 10406 000062F1 434520746F20757365-
 10406 000062FA 20656E746972652073-
 10406 00006303 70616365206F722070-
 10406 0000630C 7265737320454E5445-
 10406 00006315 5220746F2073657420-
 10406 0000631E 4D6567616279746573-
 10406 00006327 202E2E2000         
 10407                                  
 10408                                  msg_c_part_error:
 10409 0000632C 0D0A                    	db 	0Dh, 0Ah
 10410                                  	;db	"No free space for a new primary partition", 0Dh, 0Ah, 0
 10411                                  	; 21/03/2021
 10412 0000632E 4E6F20667265652073-     	db	"No free space for a new primary partition !", 0Dh, 0Ah, 0
 10412 00006337 7061636520666F7220-
 10412 00006340 61206E657720707269-
 10412 00006349 6D6172792070617274-
 10412 00006352 6974696F6E20210D0A-
 10412 0000635B 00                 
 10413                                  ; 21/03/2021
 10414                                  ;msg_c_ldd_error: 
 10415                                  ;	db	"and logical dos drives over program limit (4) !", 0Dh, 0Ah, 0
 10416                                  msg_c_ldd_q:
 10417 0000635C 0D0A                    	db	0Dh, 0Ah
 10418 0000635E 446F20796F75207761-     	db	"Do you want to create logical dos drive in extended dos partition "
 10418 00006367 6E7420746F20637265-
 10418 00006370 617465206C6F676963-
 10418 00006379 616C20646F73206472-
 10418 00006382 69766520696E206578-
 10418 0000638B 74656E64656420646F-
 10418 00006394 732070617274697469-
 10418 0000639D 6F6E20             
 10419 000063A0 3F2028592F4E2900        	db	'? (Y/N)', 0
 10420                                  
 10421                                  msg_c_ldd_nofspc_error:
 10422 000063A8 0D0A                    	db 	0Dh, 0Ah
 10423 000063AA 4E6F20667265652073-     	db	"No free space for a new logical dos drive !", 0Dh, 0Ah, 0
 10423 000063B3 7061636520666F7220-
 10423 000063BC 61206E6577206C6F67-
 10423 000063C5 6963616C20646F7320-
 10423 000063CE 647269766520210D0A-
 10423 000063D7 00                 
 10424                                  
 10425                                  	; 12/10/2020
 10426                                  msg_drv_not_ready:
 10427 000063D8 0D0A                    	db	0Dh, 0Ah
 10428 000063DA 4469736B2064726976-     	db	"Disk drive not ready or read error ! "
 10428 000063E3 65206E6F7420726561-
 10428 000063EC 6479206F7220726561-
 10428 000063F5 64206572726F722021-
 10428 000063FE 20                 
 10429 000063FF 0D0A00                  	db	0Dh, 0Ah, 0
 10430                                  
 10431                                  msg_not_any_disks:
 10432 00006402 0D0A                    	db	0Dh, 0Ah
 10433 00006404 546865726520697320-     	db	"There is not a hard disk (ready) ! "
 10433 0000640D 6E6F74206120686172-
 10433 00006416 64206469736B202872-
 10433 0000641F 6561647929202120   
 10434 00006427 0D0A00                  	db	0Dh, 0Ah, 0
 10435                                  
 10436 0000642A 90<rep 2h>              align 4
 10437                                  
 10438                                  msg_sectors_crlf:
 10439 0000642C 20736563746F72          	db	" sector"
 10440                                  msg_sectors_crlf_s:
 10441 00006433 73                      	db	"s"
 10442 00006434 0D0A00                  	db	0Dh, 0Ah, 0
 10443                                  
 10444                                  vname_length:
 10445 00006437 00                      	db	0 ; 05/01/2018
 10446                                  
 10447                                  bs_oem_name:
 10448                                  	;db	'TRDOS2.0', 0
 10449                                  	; 04/05/2024
 10450 00006438 524554524F444F5300      	db	'RETRODOS', 0
 10451 00006441 90                      align 2
 10452                                  
 10453                                  no_name:
 10454 00006442 4E4F204E414D452020-     	db 	'NO NAME    ', 0
 10454 0000644B 202000             
 10455                                  
 10456                                  align 2
 10457                                  
 10458                                  FDFORMAT_SECBUFFER:
 10459                                  HDFORMAT_SECBUFFER:
 10460 0000644E F6<rep 200h>            	times	512 db 0F6h
 10461                                  HDFORMAT_FSINFO_BUFF:
 10462 0000664E 52526141                	dd	41615252h  ; FSI_LeadSig
 10463 00006652 00<rep 1E0h>            	times	480 db 0   ; FSI_Reserved1
 10464 00006832 72724161                	dd	61417272h  ; FSI_StrucSig
 10465 00006836 FFFFFFFF                	dd	0FFFFFFFFh ; FSI_Free_Count
 10466 0000683A 02000000                	dd	000000002h ; FSI_Nxt_Free
 10467 0000683E 00<rep Ch>              	times	12 db 0	   ; FSI_Reserved2
 10468 0000684A 000055AA                	dd	0AA550000h ; FSI_TrailSig
 10469                                  
 10470                                  ; 29/10/2020
 10471                                  msg_100:
 10472 0000684E 31303000                	db	'100', 0
 10473                                  
 10474                                  SizeOfFile equ $-100
 10475                                  
 10476                                  ; 03/02/2019
 10477                                  
 10478                                  ;=============================================================================
 10479                                  ;        	uninitialized data
 10480                                  ;=============================================================================
 10481                                  
 10482                                  bss_start:
 10483                                  
 10484                                  ABSOLUTE bss_start
 10485                                  
 10486                                  ; 12/10/2020
 10487 00006852 ??                      DrvNum:	resb 1
 10488 00006853 ??                      hdc:	resb 1
 10489                                  ;hs:	resw 1 ; (bios/dos virtual) head*sectors ; 16/10/2020
 10490 00006854 ??                      rw:	resb 1 
 10491 00006855 ??                      rcnt:	resb 1 ; 18/10/2020
 10492                                  total_sectors:
 10493 00006856 ????????                disksize: resd 1
 10494 0000685A ????????                chs_limit: resd 1
 10495                                  
 10496                                  ; 16/10/2020
 10497                                  ;lba_cyls: resd 1  ; cylinder count calculated from LBA sectors
 10498 0000685E ????                    lba_chs_remain: resw 1	 ; remain sectors after the last cylinder
 10499                                  
 10500                                  alignb 2
 10501 00006860 ????                    old_sp:	resw 1
 10502                                  
 10503                                  HDFORMAT_FATBUFFER:
 10504                                  HDFORMAT_EMPTY_BUFF:
 10505 00006862 <res 200h>              	resb 512
 10506                                  
 10507 00006A62 ????????                data_start: resd 1
 10508 00006A66 ????????                data_sectors: resd 1
 10509 00006A6A ????????                cluster_count: resd 1
 10510 00006A6E ????                    root_dir_secs: resw 1
 10511 00006A70 ????                    format_percent: resw 1
 10512 00006A72 ??                      prev_percent:	resb 1
 10513 00006A73 ??                      rsvdbyte:	resb 1
 10514                                  
 10515                                  alignb 4
 10516                                  
 10517                                  ; 05/01/2018
 10518 00006A74 <res 40h>               fs_volume_name: resb 64
 10519 00006AB4 ????????                fs_volume_serial: resd 1
 10520 00006AB8 ????                    DAT_FFBit:	resw 1
 10521 00006ABA ????                    DAT_FFSector:	resw 1
 10522 00006ABC ????                    		resw 1 ; 19/03/2021
 10523 00006ABE ????                    DAT_LFBit:	resw 1
 10524 00006AC0 ????                    DAT_LFSector:	resw 1
 10525 00006AC2 ????                    		resw 1 ; 19/03/2021
 10526                                  
 10527                                  ;alignb 4
 10528                                  
 10529                                  FS_MAT_Buffer: ; TRFS1 Master Allocation Table (05/01/2018)
 10530 00006AC4 ??????                  MAT_Sign:		resb    3	; Offset 0  ; 'MAT' 
 10531 00006AC7 ??                      MAT_Version:		resb 	1	; 	 3  ; 0	
 10532 00006AC8 ????????                MAT_VolumeSize:		resd	1	;	 4  ; FS1 Volume Size
 10533 00006ACC ????????                MAT_BeginSector:	resd	1	;	 8  ; FS1 Start Sector
 10534 00006AD0 ????????                DAT_Address:		resd	1	;	12  ; Offset (=2)
 10535 00006AD4 ????????                DAT_SectorCount:	resd	1	;	16  
 10536 00006AD8 ????????                MAT_FreeSectors:	resd 	1	; 	20
 10537 00006ADC ????????                MAT_FirstFreeSector:	resd	1	;	24
 10538                                  ;MAT_OS_Reserved:
 10539                                  ;	 		resb	9
 10540                                  ;MAT_Unused:
 10541                                  ;			resb	112
 10542                                  FS_DAT_Buffer: ; TRFS1 Disk Allocation Table (05/01/2018)
 10543                                  FS_RDT_Buffer: ; TRFS1 Root Directory Description Table (05/01/2018)
 10544 00006AE0 <res 200h>              			resb	512		
 10545                                  ;alignb 4
 10546                                  
 10547                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
 10548                                  
 10549                                  ;total_sectors: resd 1
 10550 00006CE0 ????????                pType:	       resb 4
 10551 00006CE4 ????????                file_size:     resd 1
 10552 00006CE8 ????????                pp_StartSector: resd 1
 10553 00006CEC ????????                pp_Sectors:	resd 1
 10554 00006CF0 ??                      wholedisk:	resb 1
 10555 00006CF1 ??                      pp_type: resb 1 ; Primary partition type (for this program)
 10556 00006CF2 ??                      pp_type_user: resb 1
 10557 00006CF3 ??                      chs_focus: resb 1
 10558 00006CF4 ????????                pSize_temp: resd 1
 10559 00006CF8 ????????                pSize_multiplier: resd 1
 10560 00006CFC ??                      pSize_maxdigits: resb 1
 10561 00006CFD ??                      pSize_digitpos: resb 1
 10562                                  msg_psize_unit:
 10563 00006CFE ????                    pSize_unit:	resw 1
 10564 00006D00 ??                      		resb 1
 10565                                  ; 06/11/2020		
 10566                                  ;reserved_bytes: resb 3 ; for 11 bytes of numbers
 10567                                  msg_partition_sectors:
 10568                                  		;resb 8
 10569 00006D01 <res Bh>                		resb 11 ; 06/11/2020
 10570 00006D0C ??                      		resb 1
 10571 00006D0D ??                      format_q:	resb 1 ; 03/02/2018
 10572                                  
 10573                                  ;alignb 2
 10574 00006D0E ??                      pType_pos:	resb 1
 10575 00006D0F ??                      pType_num:	resb 1
 10576 00006D10 ??                      		resb 1
 10577                                  ;cylinder_boundary:
 10578 00006D11 ??                      		resb 1
 10579                                  ; 05/11/2020
 10580                                  
 10581                                  alignb 2
 10582                                  
 10583 00006D12 ??                      GetChar:	resb 1 ; 11/02/2019
 10584 00006D13 ??                      existingfile:	resb 1 ; 12/02/2019
 10585                                  
 10586                                  hs: ; 17/10/2020 ; (bios/dos virtual) head*sectors
 10587 00006D14 ????                    min_sectors:	resw 1 ; 08/02/2019
 10588 00006D16 ????                    pp_StartCylinder: resw 1
 10589 00006D18 ????                    pp_EndCylinder:	resw 1
 10590                                  
 10591 00006D1A ????????                ppn_Sectors:	resd 1 ; 09/02/2019
 10592                                  
 10593 00006D1E ????                    input_col:	resw 1
 10594 00006D20 ??                      No:		resb 1
 10595 00006D21 ??                      Yes:		resb 1
 10596                                  
 10597                                  ; 26/02/2019
 10598 00006D22 ??                      ldrives:	resb 1	
 10599                                  
 10600                                  ;sort_1:	resb 1
 10601 00006D23 ??                      		resb 1 ; 23/10/2020
 10602 00006D24 ????????                sort:		resb 4
 10603                                  
 10604                                  ;max_sector:	resb 8
 10605                                  ebr_buffer:		; 26/02/2019
 10606 00006D28 <res 200h>              boot_record:	resb 512
 10607                                  
 10608 00006F28 ??                      valid_input:	resb 1
 10609 00006F29 ??                      		resb 1
 10610                                  
 10611                                  ; 26/02/2019
 10612 00006F2A ????????                ep_StartSector:	resd 1
 10613 00006F2E ????????                ep_EndSector:	resd 1
 10614 00006F32 ????????                ep_Size:	resd 1
 10615                                  
 10616                                  ; 10/02/2019
 10617 00006F36 ????????                valid_ppnums:	resb 4	
 10618                                  
 10619 00006F3A ????                    _i_:	resw 1
 10620                                  
 10621 00006F3C ????                    freespace_count: resw 1
 10622 00006F3E ??                      last_found_partition: resb 1
 10623 00006F3F ??                      p_type: resb 1	
 10624                                  
 10625                                  ; 30/10/2020
 10626                                  ;p_sorted:
 10627                                  ;	resb 1
 10628                                  ;ep_sorted:
 10629                                  ;	resb 1
 10630                                  
 10631 00006F40 ??                      _e_:	resb 1
 10632                                  
 10633                                  act_part_num:
 10634                                  cre_part_num:
 10635 00006F41 ??                      del_part_num: resb 1 ; 10/02/2019
 10636                                  
 10637                                  alignb 2
 10638                                  
 10639 00006F42 <res 50h>               pte_row: resb 80
 10640                                  
 10641 00006F92 ??                      _zero_:	resb 1
 10642                                  
 10643                                  ;alignb 2
 10644                                  
 10645 00006F93 ??                      	resb 1
 10646                                  
 10647                                  bss_clear_end: ; 15/02/2019
 10648                                  
 10649                                  ; PARTITION DATA STRUCTURE
 10650                                  ; 4 partitions
 10651                                  ; 18 byte partition data structure per partition
 10652                                  ; 72 bytes (4*18)
 10653                                  
 10654 00006F94 ??                      part_table_boot_ind:	 resb 1
 10655 00006F95 ??                      part_table_start_head:	 resb 1
 10656 00006F96 ??                      part_table_start_sector: resb 1
 10657 00006F97 ????                    part_table_start_cyl:	 resw 1
 10658 00006F99 ??                      part_table_sys_id:	 resb 1
 10659 00006F9A ??                      part_table_end_head:	 resb 1
 10660 00006F9B ??                      part_table_end_sector:	 resb 1
 10661 00006F9C ????                    part_table_end_cyl:	 resw 1
 10662 00006F9E ????                    part_table_rel_sec_lw:	 resw 1
 10663 00006FA0 ????                    part_table_rel_sec_hw:	 resw 1
 10664 00006FA2 ????                    part_table_num_sec_lw:	 resw 1
 10665 00006FA4 ????                    part_table_num_sec_hw:	 resw 1
 10666                                  
 10667 00006FA6 <res 36h>               			resb 54 ; 3*18 bytes
 10668                                  
 10669 00006FDC ??                      pcount:		resb 1
 10670 00006FDD ??                      ppcount:	resb 1
 10671 00006FDE ??                      apcount:	resb 1
 10672 00006FDF ??                      epnumber:	resb 1
 10673                                  
 10674                                  ; LOGICAL PARTITION DATA STRUCTURE
 10675                                  ; (for logical partitions in extended partition)
 10676                                  
 10677                                  ; 1 extended partition
 10678                                  ; 4 logical drives (18 bytes)
 10679                                  ; 72 bytes (4*18)
 10680                                  
 10681 00006FE0 ??                      ext_table_boot_ind:	resb 1
 10682 00006FE1 ??                      ext_table_start_head:	resb 1
 10683 00006FE2 ??                      ext_table_start_sector: resb 1
 10684 00006FE3 ????                    ext_table_start_cyl:	resw 1
 10685 00006FE5 ??                      ext_table_sys_id:	resb 1
 10686 00006FE6 ??                      ext_table_end_head:	resb 1
 10687 00006FE7 ??                      ext_table_end_sector:	resb 1
 10688 00006FE8 ????                    ext_table_end_cyl:	resw 1
 10689 00006FEA ????                    ext_table_rel_sec_lw:	resw 1
 10690 00006FEC ????                    ext_table_rel_sec_hw:	resw 1
 10691 00006FEE ????                    ext_table_num_sec_lw:	resw 1
 10692 00006FF0 ????                    ext_table_num_sec_hw:	resw 1
 10693                                  
 10694 00006FF2 <res 36h>               			resb 54 ; 3*18 bytes
 10695                                  
 10696                                  fspc:		; 5*8 words (for free space calculations)
 10697                                  
 10698                                  ; Space 1 - unused cylinders before partition 0
 10699                                  ; Space 2 - unused cylinders between partition 0 & 1
 10700                                  ; Space 3 - unused cylinders between partition 1 & 2
 10701                                  ; Space 4 - unused cylinders between partition 2 & 3
 10702                                  ; Space 5 - unused cylinders after partition 3
 10703                                  
 10704 00007028 ????                    free_space.space:   	   resw 1
 10705 0000702A ????                    free_space.start:   	   resw 1
 10706 0000702C ????                    free_space.end:	   	   resw 1
 10707 0000702E ????                    free_space.percent_unused: resw 1
 10708 00007030 ????????                free_space.sectors_unused: resd 1
 10709 00007034 ????????                free_space.startsector:   resd 1 ; 13/02/2019
 10710                                  		;resw  4*6 
 10711 00007038 <res 40h>               		resw   4*8 ; 4*16 bytes ; 13/02/2019
 10712                                  
 10713                                  ; 18/02/2019
 10714 00007078 ????                    c_cylinder:	resw 1
 10715 0000707A ????                    c_fspc_offset:	resw 1
 10716 0000707C ??                      cylinder_boundary: resb 1
 10717                                  ;c_gap:		resb 1
 10718 0000707D ??                      		resb 1
 10719                                  
 10720                                  ; 27/02/2019
 10721 0000707E <res 10h>               ldd_start:	resd 4
 10722                                  ; 03/03/2019
 10723 0000708E <res 10h>               ldd_size:	resd 4
 10724                                  ; 30/10/2020
 10725 0000709E ????????                ep_free_sectors: resd 1
 10726                                  
 10727                                  ; 25/02/2019
 10728 000070A2 ????                    pte_address:	resw 1
 10729                                  ; 02/03/2019
 10730 000070A4 ????                    lcylinders:	resw 1
 10731                                  ; 01/11/2020
 10732 000070A6 ????                    endcyl:		resw 1
 10733                                  
 10734                                  ;bss_clear_end: ; 18/02/2019
 10735                                  
 10736                                  ; 11/10/2020
 10737                                  ;gdp_buffer:	resb 30 ; buffer for int 13h, ah = 48h
 10738 000070A8 <res 1Ah>               gdp_buffer:	resb 26 ; buffer for int 13h, ah = 48h
 10739                                  ; 19/03/2021
 10740 000070C2 ????                    tempword:	resw 1
 10741                                  
 10742                                  bss_end:
