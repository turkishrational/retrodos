     1                                  ; ****************************************************************************
     2                                  ; 'rd5hdi12.s' - Retro DOS v5 Hard Disk Image (FAT12 FS) Formatting Utility
     3                                  ; 					 	        (for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; Last Update: 04/05/2024
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 04/05/2024
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.15
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Modified from 'fat12hdi.s'(FAT12HDI.COM) source code by Erdogan Tan
    12                                  ; (28/10/2023) - Retro DOS v2-v4 hard disk (FAT12) image formatting utility -
    13                                  ; ****************************************************************************
    14                                  ; nasm rd5hdi12.s -l rd5hdi12.txt -o RD5HDI12.COM
    15                                  
    16                                  bsOemName	equ RETRODOS_FAT12_hd_bs + 3
    17                                  bsBytesPerSec	equ RETRODOS_FAT12_hd_bs + 11
    18                                  bsSecPerClust	equ RETRODOS_FAT12_hd_bs + 13
    19                                  bsResSectors	equ RETRODOS_FAT12_hd_bs + 14
    20                                  bsFATs		equ RETRODOS_FAT12_hd_bs + 16	
    21                                  bsRootDirEnts	equ RETRODOS_FAT12_hd_bs + 17
    22                                  bsSectors	equ RETRODOS_FAT12_hd_bs + 19
    23                                  bsMedia		equ RETRODOS_FAT12_hd_bs + 21
    24                                  bsFATsecs	equ RETRODOS_FAT12_hd_bs + 22
    25                                  bsSecPerTrk	equ RETRODOS_FAT12_hd_bs + 24
    26                                  bsHeads		equ RETRODOS_FAT12_hd_bs + 26
    27                                  bsHidden1	equ RETRODOS_FAT12_hd_bs + 28
    28                                  bsHidden2	equ RETRODOS_FAT12_hd_bs + 30	
    29                                  bsHugeSectors	equ RETRODOS_FAT12_hd_bs + 32
    30                                  bsDriveNumber   equ RETRODOS_FAT12_hd_bs + 36
    31                                  bsReserved1	equ RETRODOS_FAT12_hd_bs + 37
    32                                  bsBpbSignature	equ RETRODOS_FAT12_hd_bs + 38
    33                                  bsVolumeID      equ RETRODOS_FAT12_hd_bs + 39
    34                                  bsVolumeLabel   equ RETRODOS_FAT12_hd_bs + 43
    35                                  bsFileSysType	equ RETRODOS_FAT12_hd_bs + 54
    36                                  bsReserved2	equ RETRODOS_FAT12_hd_bs + 62
    37                                  bsDataStart	equ RETRODOS_FAT12_hd_bs + 64	
    38                                  bsRootDirStart	equ RETRODOS_FAT12_hd_bs + 66
    39                                  bsRootDirSects	equ RETRODOS_FAT12_hd_bs + 68
    40                                  
    41                                  ; DTA (PSP+80h= Offset 128)
    42                                  DTA_Attrib equ 149 ; PDP+21
    43                                  DTA_Time equ 150 ; PSP+22
    44                                  DTA_Date equ 152 ; PSP 24
    45                                  DTA_FileSize equ 154 ; PSP + 26
    46                                  DTA_FileName equ 158 ; PSP + 30
    47                                  
    48                                  ; Masterboot / Partition Table at Beginning+1BEh
    49                                  ptBootable      equ 0
    50                                  ptBeginHead     equ 1
    51                                  ptBeginSector   equ 2
    52                                  ptBeginCylinder equ 3
    53                                  ptFileSystemID	equ 4
    54                                  ptEndHead       equ 5
    55                                  ptEndSector     equ 6
    56                                  ptEndCylinder   equ 7
    57                                  ptStartSector   equ 8
    58                                  ptSectors       equ 12
    59                                  
    60                                  pt_cylinders	equ RETRODOS_MASTERBOOT_SECTOR + 1B8h	
    61                                  pt_heads	equ RETRODOS_MASTERBOOT_SECTOR + 1BAh	
    62                                  pt_sectors	equ RETRODOS_MASTERBOOT_SECTOR + 1BCh
    63                                  partition_table equ RETRODOS_MASTERBOOT_SECTOR + 1BEh
    64                                  
    65                                  ; BIOS Disk Parameters
    66                                  DPDiskNumber  equ 0h
    67                                  DPDType       equ 1h
    68                                  DPReturn      equ 2h
    69                                  DPHeads       equ 3h
    70                                  DPCylinders   equ 4h
    71                                  DPSecPerTrack equ 6h
    72                                  DPDisks       equ 7h
    73                                  DPTableOff    equ 8h
    74                                  DPTableSeg    equ 0Ah
    75                                  DPNumOfSecs   equ 0Ch
    76                                  
    77                                  ; BIOS INT 13h Extensions (LBA extensions)
    78                                  ; Just After DP Data (DPDiskNumber+)
    79                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    80                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    81                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    82                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    83                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    84                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    85                                                          ; C1= Selected Cylinder Number
    86                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    87                                                          ; H1= Selected Head Number
    88                                                          ; S0= Maximum Sector Number
    89                                                          ; S1= Selected Sector Number
    90                                                          ; QUAD WORD
    91                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    92                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    93                                                               ; TR-DOS will not use 64 bit Flat Address
    94                                  
    95                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    96                                  ; Just After DP Data (DPDiskNumber+)
    97                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
    98                                  GDP_48h_InfoFlag equ 22h ; Word
    99                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
   100                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
   101                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
   102                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
   103                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
   104                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
   105                                  
   106                                  ; Cursor Location
   107                                  CCCpointer equ  0450h   ; BIOS data, current cursor column
   108                                  
   109                                  ; MINIMUM & MAXIMUM SECTORS (partition and disk size limits in sectors)
   110                                  MINPARTSIZE equ 4096 ; 2GB
   111                                  MAXPARTSIZE equ 4128768 - 1 ; 2GB - masterboot sector	
   112                                  MINDISKSIZE equ 16384 ; 8MB
   113                                  MAXDISKSIZE equ 4128768 ; 2GB
   114                                  
   115                                  pTableOffset equ 1BEh ; 446		
   116                                  
   117                                  [BITS 16]
   118                                  [ORG 100h]
   119                                  
   120                                  	;cli
   121                                  	;cld
   122                                  	;push	cs
   123                                  	;pop	ss
   124                                  	;mov	sp, 0FFFEh
   125                                  	;sti
   126                                  	
   127 00000000 BB[FF18]                	mov	bx, SizeOfFile+100
   128 00000003 83C30F                          add	bx, 15
   129 00000006 D1EB                            shr	bx, 1
   130 00000008 D1EB                            shr	bx, 1
   131 0000000A D1EB                    	shr	bx, 1
   132 0000000C D1EB                    	shr	bx, 1
   133 0000000E B44A                            mov	ah, 4Ah ; modify memory allocation
   134                                          ;push	cs
   135                                          ;pop	es
   136 00000010 CD21                            int	21h 
   137                                  
   138                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   139                                  ; get fd image file name
   140                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   141                                  
   142 00000012 BE8000                  	mov	si, 80h			; PSP command tail
   143 00000015 AC                       	lodsb
   144 00000016 08C0                    	or	al, al 			; command tail length                            
   145 00000018 0F840801                	jz	R_15			; jump if zero
   146                                  R_01:
   147 0000001C AC                      	lodsb
   148 0000001D 3C20                    	cmp	al, ' '			; is it SPACE ?
   149 0000001F 74FB                    	je	short R_01 		
   150 00000021 0F82FF00                	jb	R_15
   151                                  	
   152                                  	; check hd image file name
   153                                  R_02:
   154 00000025 BF[D716]                       	mov	di, img_file_name
   155 00000028 AA                      	stosb
   156                                  R_03:
   157 00000029 AC                      	lodsb
   158                                  	;cmp	al, 0Dh ; ENTER (CR) key
   159 0000002A 3C20                    	cmp	al, 20h ; ' '
   160 0000002C 760C                    	jna	short R_04
   161 0000002E AA                      	stosb
   162 0000002F 81FF[E316]              	cmp	di, img_file_name + 12
   163 00000033 72F4                    	jb	short R_03
   164 00000035 803C20                  	cmp	byte [si], 20h 
   165 00000038 7748                    	ja	short R_11
   166                                  R_04:
   167                                  	;sub	al, al
   168                                  	;stosb
   169                                  
   170                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   171                                  ; File name capitalization
   172                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   173                                  
   174 0000003A BE[D716]                	mov	si, img_file_name
   175 0000003D 89F7                    	mov	di, si
   176 0000003F 89F3                    	mov	bx, si
   177                                  R_05:
   178 00000041 AC                      	lodsb
   179 00000042 3C61                    	cmp	al, 'a'
   180 00000044 730D                    	jnb	short R_07
   181 00000046 20C0                    	and	al, al
   182 00000048 7412                    	jz	short R_08
   183 0000004A 3C2E                    	cmp	al, '.'
   184 0000004C 7502                    	jne	short R_06
   185 0000004E 89FB                    	mov	bx, di ; dot position	
   186                                  R_06:
   187 00000050 AA                      	stosb
   188 00000051 EBEE                    	jmp	short R_05 		
   189                                  R_07:
   190 00000053 3C7A                    	cmp	al, 'z'
   191 00000055 77F9                    	ja	short R_06
   192 00000057 24DF                    	and	al, 0DFh ; NOT 32
   193 00000059 AA                      	stosb
   194 0000005A EBE5                    	jmp	short R_05	
   195                                  R_08:
   196 0000005C 8805                    	mov	[di], al
   197 0000005E 4F                      	dec	di
   198 0000005F 39FB                    	cmp	bx, di
   199 00000061 7316                    	jnb	short R_10
   200 00000063 29DF                    	sub	di, bx
   201 00000065 81EB[D716]              	sub	bx, img_file_name
   202 00000069 83FF03                  	cmp	di, 3
   203 0000006C 7606                    	jna	short R_09
   204 0000006E 21DB                    	and	bx, bx
   205 00000070 7507                    	jnz	short R_10
   206 00000072 EB0E                    	jmp	short R_11		
   207                                  R_09:
   208 00000074 83FB08                  	cmp	bx, 8
   209 00000077 7609                    	jna	short R_11
   210                                  R_10:
   211 00000079 BE[9B11]                	mov	si, msg_inv_file_name
   212 0000007C E88904                  	call	print_msg
   213 0000007F E99700                  	jmp	R_14
   214                                  
   215                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   216                                  ; Find image file
   217                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   218                                  	
   219                                  R_11:
   220 00000082 BA[D716]                	mov	dx, img_file_name
   221 00000085 B93F00                  	mov	cx, 3Fh ; File Attributes
   222 00000088 B44E                    	mov	ah, 4Eh ; MS-DOS Function = Find First File
   223 0000008A CD21                    	int	21h
   224 0000008C 0F82B900                	jc	R_19
   225                                  
   226                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   227                                  ; Check image file features
   228                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   229                                  
   230 00000090 BE9500                  	mov	si, DTA_Attrib
   231 00000093 8A04                    	mov	al, [si]
   232 00000095 241F                    	and	al, 1Fh ; directory, volume label, system, hidden, read only
   233 00000097 0F859900                	jnz	R_17     
   234 0000009B BE9A00                  	mov	si, DTA_FileSize
   235 0000009E AD                      	lodsw
   236 0000009F 8B14                    	mov	dx, [si]
   237 000000A1 81FAF801                	cmp	dx, 1F8h
   238 000000A5 0F878B00                	ja	R_17
   239 000000A9 A9FF01                  	test	ax, 511
   240 000000AC 0F858400                	jnz	R_17
   241 000000B0 C1E809                  	shr	ax, 9
   242 000000B3 C1E207                  	shl	dx, 7
   243 000000B6 01D0                    	add	ax, dx
   244                                  
   245                                  	; max. size of Retro DOS v2 hard disk image < 32MB
   246 000000B8 3D00FC                  	cmp	ax, 64512 ; 64*16*63 sectors
   247 000000BB 7777                    	ja	short R_17
   248 000000BD 7426                    	je	short R_12
   249 000000BF 3DC04E                  	cmp	ax, 20160 ; 20*16*63 sectors
   250 000000C2 7421                    	je	short R_12
   251 000000C4 726E                    	jb	short R_17
   252 000000C6 3D4851                  	cmp	ax, 20808 ; 306*4*17 sectors
   253 000000C9 7269                    	jb	short R_17
   254 000000CB 7418                    	je	short R_12
   255 000000CD 3D90A2                  	cmp	ax, 41616 ; 306*8*17 sectors
   256 000000D0 7413                    	je	short R_12
   257 000000D2 3D70F5                  	cmp	ax, 62832 ; 462*8*17 sectors
   258 000000D5 740E                    	je	short R_12
   259 000000D7 775B                    	ja	short R_17
   260 000000D9 3D007E                  	cmp	ax, 32256 ; 32*16*63 sectors
   261 000000DC 7407                    	je	short R_12
   262 000000DE 7254                    	jb	short R_17
   263 000000E0 3D809D                  	cmp	ax, 40320 ; 40*16*63 sectors
   264 000000E3 754F                    	jne	short R_17		
   265                                  R_12:
   266                                  
   267                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   268                                  ; Overwrite question
   269                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   270                                  
   271 000000E5 BE[0915]                	mov	si, msg_overwrite_question1
   272 000000E8 E81D04                  	call	print_msg
   273 000000EB BE9E00                  	mov	si, DTA_FileName
   274 000000EE E81704                  	call	print_msg
   275 000000F1 BE[2615]                	mov	si, msg_overwrite_question2
   276 000000F4 E81104                  	call	print_msg
   277 000000F7 BE[2E15]                	mov	si, msg_yes_no
   278 000000FA E80B04                  	call	print_msg
   279                                  
   280                                  	; get answer
   281                                  R_13:
   282 000000FD 31C0                    	xor	ax, ax
   283 000000FF CD16                    	int	16h			; wait for keyboard command
   284 00000101 3C03                    	cmp	al, 'C'-40h
   285 00000103 7414                    	je	short R_14 ; Exit                   
   286 00000105 3C1B                    	cmp	al, 27
   287 00000107 7410                    	je	short R_14 ; Exit
   288 00000109 24DF                    	and	al, 0DFh
   289 0000010B 3C59                    	cmp	al, 'Y'			; Yes?
   290 0000010D 741D                    	je	short R_16		; write
   291 0000010F 3C4E                    	cmp	al, 'N'			; No?
   292 00000111 75EA                    	jne	short R_13      
   293                                  					; no write (exit)  
   294 00000113 BE[0916]                	mov	si, Msg_NO
   295 00000116 E8EF03                  	call	print_msg 
   296                                  
   297                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   298                                  ; Nextline & Exit
   299                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   300                                  
   301                                  R_14:
   302 00000119 BE[0116]                	mov	si, CRLF
   303 0000011C E8E903                  	call	print_msg
   304 0000011F B8004C                  	mov	ax, 4C00h		; terminate
   305 00000122 CD21                    	int	21h
   306                                  
   307                                  R_15:
   308 00000124 BE[0B11]                	mov	si, RetroDOS_Welcome
   309 00000127 E8DE03                  	call	print_msg
   310 0000012A EBED                    	jmp	short R_14 ; Exit
   311                                  
   312                                  R_16:
   313 0000012C BE[0416]                	mov	si, Msg_YES
   314 0000012F E8D603                  	call	print_msg
   315 00000132 EB08                    	jmp	short R_18
   316                                  
   317                                  R_17:
   318 00000134 BE[DD11]                	mov	si, msg_inv_image_file
   319 00000137 E8CE03                  	call	print_msg
   320 0000013A EBDD                    	jmp	short R_14
   321                                  
   322                                  R_18:
   323                                  	; Delete existing image file
   324 0000013C B441                    	mov	ah, 41h ; Delete file
   325 0000013E BA[D716]                	mov	dx, img_file_name
   326 00000141 CD21                    	int	21h
   327 00000143 7304                    	jnc	short R_19
   328 00000145 3C02                    	cmp	al, 2 ; file not found
   329 00000147 75EB                    	jne	short R_17 ; invalid image file
   330                                  
   331                                  R_19:
   332 00000149 E87304                  	call	write_chs_table
   333                                  R_20:
   334 0000014C 30E4                    	xor	ah, ah
   335 0000014E CD16                    	int	16h
   336                                  
   337 00000150 3C31                    	cmp	al, '1'
   338 00000152 7208                    	jb	short R_21
   339 00000154 3C37                    	cmp	al, '7'
   340 00000156 77F4                    	ja	short R_20
   341                                  	; 19/10/2018
   342 00000158 2C30                    	sub	al, '0'
   343 0000015A EB09                    	jmp	short R_22
   344                                  R_21:
   345 0000015C 3C1B                    	cmp	al, 27 ;  ESCape key
   346 0000015E 75EC                    	jne	short R_20
   347                                  
   348                                  	; Exit
   349 00000160 B8004C                  	mov	ax, 4C00h
   350 00000163 CD21                    	int	21h
   351                                  
   352                                  R_22:
   353 00000165 A2[D616]                	mov	[DiskType], al ; 19/10/2018
   354                                  
   355                                  	; clear screen
   356 00000168 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   357 0000016B CD10                    	int	10h
   358                                  
   359 0000016D 8A1E[D616]              	mov	bl, [DiskType]	; 1 to 7
   360 00000171 FECB                    	dec	bl 		; 0 to 6
   361                                  	;xor	bh, bh
   362 00000173 89DE                    	mov	si, bx
   363 00000175 D0E3                    	shl	bl, 1
   364 00000177 81C3[BB16]              	add	bx, DskTypeNumStr
   365 0000017B 8B07                    	mov	ax, [bx]
   366 0000017D A3[A116]                	mov	[msg_disk_size], ax
   367 00000180 C1E603                  	shl	si, 3 ; * 8
   368 00000183 81C6[CB05]              	add	si, DskTypeParms
   369 00000187 AD                      	lodsw
   370 00000188 A3[BE08]                	mov	[pt_cylinders], ax
   371 0000018B AD                      	lodsw
   372 0000018C A3[C008]                	mov	[pt_heads], ax
   373 0000018F AD                      	lodsw
   374 00000190 A3[C208]                	mov	[pt_sectors], ax
   375 00000193 AD                      	lodsw	
   376 00000194 A3[D416]                	mov	[diskimage_size], ax
   377                                  	
   378 00000197 BE[9616]                	mov	si, msg_creating
   379 0000019A E86B03                  	call	print_msg
   380                                  
   381                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   382                                  ; Create a new hard disk image file
   383                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   384                                  		
   385 0000019D BA[D716]                	mov	dx, img_file_name
   386 000001A0 B90000                  	mov	cx, 0 ; File Attributes
   387 000001A3 B43C                    	mov	ah, 3Ch ; MS-DOS Function = Create File
   388 000001A5 CD21                    	int	21h
   389 000001A7 7208                    	jc	short R_23
   390                                  
   391                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   392                                  ; Open image file for writing
   393                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   394                                  
   395 000001A9 B002                    	mov	al, 2 ; open for reading and writing
   396                                  	;mov	dx, img_file_name
   397 000001AB B43D                    	mov	ah, 3Dh ; open file
   398 000001AD CD21                    	int	21h
   399 000001AF 7314                    	jnc	short R_24
   400                                  
   401                                  R_23:
   402                                  	; AL = error code
   403 000001B1 E86303                  	call	bin_to_hex
   404 000001B4 A3[1816]                	mov 	[error_code], ax
   405                                  
   406 000001B7 BE[0116]                	mov	si, CRLF
   407 000001BA E84B03                  	call	print_msg
   408                                  
   409 000001BD BE[0D16]                	mov	si, Msg_Error
   410 000001C0 E84503                  	call	print_msg
   411                                  
   412 000001C3 CD20                    	int	20h	; Exit
   413                                  
   414                                  R_24:
   415 000001C5 A3[180B]                	mov	[img_file_handle], ax
   416 000001C8 BA[E416]                	mov	dx, HDFORMAT_SECBUFFER  ; 0F6h buffer
   417                                  R_25:
   418 000001CB B90002                  	mov	cx, 512
   419 000001CE 8B1E[180B]              	mov	bx, [img_file_handle]
   420 000001D2 B440                    	mov	ah, 40h ; write to file	
   421 000001D4 CD21                    	int	21h
   422 000001D6 7226                    	jc	short R_26
   423                                  
   424 000001D8 FF06[D216]              	inc	word [CWSector]
   425 000001DC A1[D416]                	mov	ax, [diskimage_size]
   426                                  
   427 000001DF B90100                  	mov	cx, 1
   428                                  
   429 000001E2 3B06[D216]              	cmp	ax, [CWSector]
   430 000001E6 761E                    	jna	short R_27
   431                                  	
   432 000001E8 A1[D216]                	mov	ax, [CWSector]
   433 000001EB 83E003                  	and	ax, 3
   434 000001EE BB[CB16]                	mov	bx, RSymbols
   435 000001F1 01C3                    	add	bx, ax
   436 000001F3 8A07                    	mov	al, [bx]
   437 000001F5 BB0700                  	mov	bx, 7
   438                                  	;mov	cx, 1
   439 000001F8 B40A                    	mov	ah, 0Ah ; write character (on previous cpos)
   440 000001FA CD10                    	int	10h
   441                                  
   442 000001FC EBCD                    	jmp	short R_25
   443                                  
   444                                  R_26:
   445                                  	; Error.. close file..
   446 000001FE 50                      	push	ax
   447 000001FF B43E                    	mov	ah, 3Eh ; close file
   448                                  	;mov	bx, [img_file_handle]
   449 00000201 CD21                    	int	21h
   450 00000203 58                      	pop	ax
   451 00000204 EBAB                    	jmp	short R_23
   452                                  
   453                                  R_27:
   454 00000206 B020                    	mov	al, 20h ; space
   455 00000208 BB0700                  	mov	bx, 7
   456 0000020B B40A                    	mov	ah, 0Ah ; write character (on previous cpos)
   457                                  	;mov	cx, 1
   458 0000020D CD10                    	int	10h
   459                                  	
   460 0000020F BE[FD15]                	mov	si, msg_OK
   461 00000212 E8F302                  	call	print_msg
   462                                  
   463                                  	; Wait about 1 second (~16/18.2)
   464                                  	; "before press any key to continue message"
   465 00000215 30E4                    	xor	ah, ah ; 0
   466 00000217 CD1A                    	int	1Ah
   467                                  	; CX:DX = tick count (18.2 ticks per second)
   468 00000219 83E20F                  	and	dx, 0Fh
   469 0000021C 89D6                    	mov	si, dx
   470 0000021E 31DB                    	xor	bx, bx
   471                                  R_28:
   472 00000220 B80000                  	mov	ax,0
   473 00000223 CD1A                    	int	1Ah	
   474 00000225 43                      	inc	bx
   475 00000226 7407                    	jz	short R_29 
   476 00000228 83E20F                  	and	dx, 0Fh
   477 0000022B 39F2                    	cmp	dx, si
   478 0000022D 75F1                    	jne	short R_28
   479                                  R_29:
   480 0000022F BE[7716]                	mov	si, msg_press_any_key
   481 00000232 E8D302                  	call	print_msg
   482                                  
   483 00000235 30E4                    	xor	ah, ah
   484 00000237 CD16                    	int	16h
   485                                  
   486                                  R_30:
   487                                  	; clear screen
   488 00000239 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   489 0000023C CD10                    	int	10h
   490                                  	
   491 0000023E BE[BF12]                	mov	si, msg_create_dos_partition_h ; header
   492 00000241 E8C402                  	call	print_msg
   493 00000244 BE[B413]                	mov	si, msg_create_dos_partition_m ; menu
   494 00000247 E8BE02                  	call	print_msg
   495                                  R_31:
   496 0000024A 30E4                    	xor	ah, ah
   497 0000024C CD16                    	int	16h
   498 0000024E 3C1B                    	cmp	al, 27 ; ESC key	
   499 00000250 743B                    	je	short R_32
   500 00000252 3C30                    	cmp	al, '0'
   501 00000254 7437                    	je	short R_32
   502 00000256 72F2                    	jb	short R_31
   503 00000258 3C36                    	cmp	al, '6'
   504 0000025A 77EE                    	ja	short R_31
   505                                  
   506 0000025C 30ED                    	xor	ch, ch
   507 0000025E 2C30                    	sub	al, '0'
   508 00000260 88C1                    	mov	cl, al
   509 00000262 FEC9                    	dec	cl  ; 0 to 5
   510 00000264 8A1E[D616]              	mov	bl, [DiskType]
   511 00000268 FECB                    	dec	bl  ; 0 to 6
   512 0000026A B006                    	mov	al, 6
   513 0000026C F6E3                    	mul	bl	
   514 0000026E BB[DB06]                	mov	bx, OptionValidatingTable
   515 00000271 01C8                    	add	ax, cx
   516 00000273 01C3                    	add	bx, ax
   517 00000275 8A07                    	mov	al, [bx]
   518 00000277 20C0                    	and	al, al
   519 00000279 7520                    	jnz	short R_34
   520                                  
   521 0000027B BE[2212]                	mov	si, msg_option_not_proper
   522 0000027E E88702                  	call	print_msg
   523 00000281 BE[7716]                	mov	si, msg_press_any_key
   524 00000284 E88102                  	call	print_msg
   525 00000287 30E4                    	xor	ah, ah
   526 00000289 CD16                    	int	16h
   527 0000028B EBAC                    	jmp	short R_30
   528                                  
   529                                  R_32:	
   530 0000028D BE[0116]                	mov	si, CRLF
   531 00000290 E87502                  	call	print_msg
   532                                  
   533 00000293 30C0                    	xor	al, al	; return code = 0
   534 00000295 B44C                    	mov	ah, 4Ch ; EXIT - terminate with return code
   535 00000297 CD21                    	int	21h
   536                                  
   537                                  R_33:
   538 00000299 EBFE                    	jmp	short R_33
   539                                  
   540                                  R_34:
   541 0000029B FEC8                    	dec	al ; zero based type of partition selection
   542 0000029D B412                    	mov	ah, 18
   543 0000029F F6E4                    	mul	ah
   544 000002A1 BE[0306]                	mov	si, partition_parms
   545 000002A4 01C6                    	add	si, ax
   546 000002A6 BB[C408]                	mov	bx, partition_table
   547 000002A9 AD                      	lodsw
   548 000002AA A2[1309]                	mov	[bsSecPerClust], al  ; sectors per cluster
   549 000002AD AD                      	lodsw
   550                                  	;mov	cx, ax  	     ; number of clusters
   551 000002AE AD                      	lodsw
   552 000002AF A3[1709]                	mov	[bsRootDirEnts], ax  ; root directory entries
   553 000002B2 83C00F                  	add	ax,15
   554 000002B5 C1E804                  	shr	ax, 4
   555 000002B8 A3[4A09]                	mov	[bsRootDirSects], ax ; root directory sectors	
   556 000002BB AD                      	lodsw
   557 000002BC A3[2209]                	mov	[bsHidden1], ax	     ; hidden sectors
   558 000002BF 894708                  	mov	[bx+ptStartSector], ax ; start sector
   559                                  	;mov	word [bx+ptStartSector+2], 0
   560                                  
   561                                  	;mov	word [bsHidden2], 0
   562 000002C2 AD                      	lodsw
   563                                  	;mov	[bsResSectors], ax   ; reserved sectors = 1
   564 000002C3 AD                      	lodsw
   565 000002C4 A3[1C09]                	mov	[bsFATsecs], ax      ; fat sectors
   566 000002C7 AD                      	lodsw
   567 000002C8 A3[4809]                	mov	[bsRootDirStart], ax ; root directory address
   568 000002CB AD                      	lodsw
   569 000002CC A3[4609]                	mov	[bsDataStart], ax    ; first data sector address
   570 000002CF AD                      	lodsw
   571 000002D0 A3[1909]                	mov	[bsSectors], ax      ; partition/volume size in sectors
   572 000002D3 A3[2609]                	mov	[bsHugeSectors], ax 
   573                                  	;mov	word [bsHugeSectors+2], 0
   574 000002D6 89470C                  	mov	[bx+ptSectors], ax
   575                                  	;mov	word [bx+ptSectors+2], 0
   576                                  
   577 000002D9 89C1                    	mov	cx, ax 		     ; volume/partition size in sectors
   578                                  
   579 000002DB C60780                  	mov	byte [bx], 80h       ; Active/Bootable partition
   580 000002DE B001                    	mov	al, 1
   581 000002E0 884704                  	mov	[bx+ptFileSystemID], al ; 1
   582 000002E3 884701                  	mov	[bx+ptBeginHead], al ; beginning head = 1
   583 000002E6 884702                  	mov	[bx+ptBeginSector], al ; beginning sector = 1
   584 000002E9 30E4                    	xor	ah, ah	
   585                                  	;mov	[bx+ptBeginCylinder], ah ; beginning cylinder = 0
   586                                  		
   587 000002EB A0[C208]                	mov	al, [pt_sectors]
   588 000002EE A2[1E09]                	mov	[bsSecPerTrk], al
   589                                  	;mov	byte [bsSecPerTrk+1], 0
   590 000002F1 884706                  	mov	[bx+ptEndSector], al	
   591 000002F4 01C1                    	add	cx, ax		     ; + sectors per track      		           
   592                                  
   593 000002F6 8A26[C008]              	mov	ah, [pt_heads]
   594 000002FA 8826[2009]              	mov	[bsHeads], ah
   595                                  	;mov	byte [bsHeads+1], 0
   596 000002FE FECC                    	dec	ah
   597 00000300 886705                  	mov	[bx+ptEndHead], ah
   598 00000303 FEC4                    	inc	ah
   599 00000305 F6E4                    	mul	ah
   600 00000307 91                      	xchg	cx, ax
   601 00000308 31D2                    	xor	dx, dx
   602 0000030A F7F1                    	div	cx
   603 0000030C 48                      	dec	ax  ; the last cylinder of the partition (< 1024) 
   604 0000030D 884707                  	mov	[bx+ptEndCylinder], al
   605                                  
   606                                  	; 19/10/2018
   607 00000310 20E4                    	and	ah, ah
   608 00000312 7406                    	jz	short R_35  ; last cylinder number is less than 256
   609                                  
   610 00000314 C0E406                  	shl	ah, 6 ; shift cylinder (AX) bits 8 & 9 to AH bits 6 & 7
   611 00000317 086706                  	or	byte [bx+ptEndSector],ah ; .. and put it in EndSector bits 6 & 7
   612                                  
   613                                  R_35:
   614                                  	; clear screen
   615 0000031A B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   616 0000031D CD10                    	int	10h	
   617                                  
   618 0000031F BE[3915]                	mov	si, msg_writing_mbr
   619 00000322 E8E301                  	call	print_msg
   620                                  
   621                                  	; Move file pointer to start of the file
   622                                  	;xor	al, al
   623 00000325 8B1E[180B]              	mov	bx, [img_file_handle]
   624 00000329 29C9                    	sub	cx, cx
   625                                  	;sub	dx, dx
   626 0000032B B442                    	mov	ah, 42h ; seek (move file pointer)
   627 0000032D CD21                    	int	21h
   628                                  
   629                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   630                                  ; writing masterboot sector
   631                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   632                                  
   633                                  	;mov	bx, [img_file_handle]
   634 0000032F BA[0607]                	mov	dx, RETRODOS_MASTERBOOT_SECTOR ; Singlix FS1 MBR
   635 00000332 B90002                  	mov	cx, 512
   636 00000335 B440                    	mov	ah, 40h ; write to file	
   637 00000337 CD21                    	int	21h
   638 00000339 0F82C1FE                	jc	R_26 ; write error message then exit
   639                                  
   640 0000033D BE[FD15]                	mov	si, msg_OK
   641 00000340 E8C501                  	call	print_msg
   642                                  
   643 00000343 BF[3109]                	mov	di, bsVolumeLabel
   644 00000346 E8E600                  	call	write_volume_name
   645 00000349 BE[2D09]                	mov	si, bsVolumeID
   646 0000034C E83201                  	call	write_volume_serial
   647                                  
   648 0000034F BE[6C15]                	mov	si, msg_writing_boot_sector
   649 00000352 E8B301                  	call	print_msg
   650                                  
   651                                  	; Move file pointer to start of the dos partition
   652 00000355 8B16[CC08]              	mov	dx, [partition_table+ptStartSector]
   653                                  	
   654 00000359 B80002                  	mov	ax, 512
   655 0000035C F7E2                    	mul	dx
   656 0000035E 89D1                    	mov	cx, dx
   657 00000360 89C2                    	mov	dx, ax
   658                                  
   659 00000362 28C0                    	sub	al, al
   660 00000364 8B1E[180B]              	mov	bx, [img_file_handle]
   661 00000368 B442                    	mov	ah, 42h ; seek (move file pointer)
   662 0000036A CD21                    	int	21h
   663                                  	;jc	R_26
   664                                  
   665                                  	;mov	bx, [img_file_handle]
   666 0000036C BA[0609]                	mov	dx, RETRODOS_FAT12_hd_bs
   667 0000036F B90002                  	mov	cx, 512
   668 00000372 B440                    	mov	ah, 40h ; write to file	
   669 00000374 CD21                    	int	21h
   670 00000376 0F8284FE                	jc	R_26 ; write error message then exit
   671                                  
   672 0000037A BE[FD15]                	mov	si, msg_OK
   673 0000037D E88801                  	call	print_msg
   674                                  
   675                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   676                                  ; writing FAT sectors
   677                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   678                                  
   679                                  	;mov	si, CRLF
   680                                  	;call	print_msg
   681                                  
   682                                  	; Clear sector buffer (clear 0F6h bytes)
   683 00000380 BF[E416]                	mov	di, HDFORMAT_FATBUFFER
   684 00000383 31C0                    	xor	ax, ax
   685 00000385 B90001                  	mov	cx, 256
   686 00000388 F3AB                    	rep	stosw 
   687                                  
   688 0000038A BE[8A15]                	mov	si, msg_writing_FAT_sectors
   689 0000038D E87801                  	call	print_msg
   690                                  
   691 00000390 8B2E[1C09]              	mov	bp, [bsFATsecs]
   692 00000394 4D                      	dec	bp
   693 00000395 89EF                    	mov	di, bp
   694                                  
   695 00000397 B8F8FF                  	mov	ax, 0FFF8h
   696 0000039A BE[E416]                	mov	si, HDFORMAT_FATBUFFER
   697 0000039D 8904                    	mov	[SI], ax
   698 0000039F 886402                  	mov	[SI+2], ah
   699                                  	
   700 000003A2 28C0                    	sub	al, al
   701 000003A4 8B1E[180B]              	mov	bx, [img_file_handle]
   702 000003A8 89F2                    	mov	dx, si ; [HDFORMAT_FATBUFFER]
   703 000003AA B90002                  	mov	cx, 512
   704 000003AD B440                    	mov	ah, 40h ; write to file	
   705 000003AF CD21                    	int	21h
   706 000003B1 0F8249FE                	jc	R_26 ; write error message then exit
   707                                  	;mov	bx, [img_file_handle]
   708 000003B5 BA[E416]                	mov	dx, HDFORMAT_ZERO_BUFF
   709                                  	;mov	cx, 512
   710 000003B8 31C0                    	xor	ax, ax
   711 000003BA 8904                    	mov	[SI], ax
   712 000003BC 886402                  	mov	[SI+2], ah
   713                                  R_36:
   714 000003BF 28C0                    	sub	al, al
   715                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   716                                  	;mov	cx, 512
   717 000003C1 B440                    	mov	ah, 40h ; write to file	
   718 000003C3 CD21                    	int	21h
   719 000003C5 0F8235FE                	jc	R_26 ; write error message then exit
   720                                  
   721 000003C9 4D                      	dec	bp
   722 000003CA 75F3                    	jnz	short R_36
   723                                  
   724 000003CC B8F8FF                  	mov	ax, 0FFF8h
   725                                  	;mov	si, HDFORMAT_FATBUFFER
   726 000003CF 8904                    	mov	[SI], ax
   727 000003D1 886402                  	mov	[SI+2], ah
   728                                  
   729 000003D4 28C0                    	sub	al, al
   730                                  	;mov	bx, [img_file_handle]
   731 000003D6 89F2                    	mov	dx, si; [HDFORMAT_FATBUFFER]
   732                                  	;mov	cx, 512
   733 000003D8 B440                    	mov	ah, 40h ; write to file	
   734 000003DA CD21                    	int	21h
   735 000003DC 0F821EFE                	jc	R_26 ; write error message then exit
   736                                  	;mov	bx, [img_file_handle]
   737 000003E0 BA[E416]                	mov	dx, HDFORMAT_ZERO_BUFF
   738                                  	;mov	cx, 512
   739 000003E3 29C0                    	sub	ax, ax
   740 000003E5 8904                    	mov	[SI], ax
   741 000003E7 886402                  	mov	[SI+2], ah
   742                                  R_37:
   743 000003EA 28C0                    	sub	al, al
   744                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   745                                  	;mov	cx, 512
   746 000003EC B440                    	mov	ah, 40h ; write to file	
   747 000003EE CD21                    	int	21h
   748 000003F0 0F820AFE                	jc	R_26 ; write error message then exit
   749                                  	
   750 000003F4 4F                      	dec	di
   751 000003F5 75F3                    	jnz	short R_37
   752                                  
   753 000003F7 BE[FD15]                	mov	si, msg_OK
   754 000003FA E80B01                  	call	print_msg
   755                                  
   756                                  	;mov	si, CRLF
   757                                  	;call	print_msg
   758                                  
   759 000003FD BE[A115]                	mov	si, msg_writing_root_dir
   760 00000400 E80501                  	call	print_msg
   761                                  
   762 00000403 8B3E[1709]              	mov	di, [bsRootDirEnts]
   763 00000407 C1EF04                  	shr	di, 4 ; 240/16 = 15, 512/16 =  32 sectors
   764 0000040A 8B1E[180B]              	mov	bx, [img_file_handle]
   765 0000040E BA[E416]                	mov	dx, HDFORMAT_ZERO_BUFF
   766                                  	;mov	cx, 512
   767                                  R_38:
   768 00000411 28C0                    	sub	al, al
   769                                  	;mov	bx, [img_file_handle]
   770                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   771                                  	;mov	cx, 512
   772 00000413 B440                    	mov	ah, 40h ; write to file	
   773 00000415 CD21                    	int	21h
   774 00000417 0F82E3FD                	jc	R_26 ; write error message then exit
   775                                  	
   776 0000041B 4F                      	dec	di
   777 0000041C 75F3                    	jnz	short R_38
   778                                  
   779 0000041E BE[FD15]                	mov	si, msg_OK
   780 00000421 E8E400                  	call	print_msg
   781                                  
   782 00000424 B43E                    	mov	ah, 3Eh ; close file
   783 00000426 8B1E[180B]              	mov	bx, [img_file_handle]
   784 0000042A CD21                    	int	21h
   785                                  
   786 0000042C E95EFE                  	jmp	R_32
   787                                  
   788                                  
   789                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   790                                  ; set & write volume name
   791                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   792                                  
   793                                  write_volume_name:
   794                                  	;mov	byte [vname_length], 11
   795                                  svn_fs:
   796                                  	; DI = (BS) Volume Label address
   797 0000042F BE[CF15]                	mov	si, Msg_Volume_Name
   798 00000432 E8D300                  	call	print_msg
   799                                  
   800                                  	; get cursor position
   801                                  	; bh = 0  ; video page
   802 00000435 B403                    	mov     ah, 3 ; get cursor pos
   803 00000437 CD10                    	int     10h
   804 00000439 8916[D016]              	mov	[Cursor_Pos], dx
   805                                  
   806 0000043D E8EE00                  	call	rw_char
   807                                  	;jc	short svn_1
   808 00000440 7216                    	jc	short svn_5
   809                                  svn_0:
   810 00000442 AC                      	lodsb
   811 00000443 3C20                    	cmp	al, 20h
   812 00000445 74FB                    	je	short svn_0 
   813                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
   814                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
   815 00000447 89FB                    	mov	bx, di ; *	
   816                                  	;ja	short svn_2
   817 00000449 720D                    	jb	short svn_5
   818                                  ;svn_1:
   819                                  ;	mov	si, no_name
   820                                  ;	lodsb
   821                                  svn_2:
   822 0000044B B90B00                  	mov	cx, 11; [vname_length]
   823 0000044E EB05                    	jmp	short svn_4
   824                                  svn_3:
   825 00000450 AC                      	lodsb
   826 00000451 3C20                    	cmp	al, 20h
   827 00000453 7225                    	jb	short svn_6
   828                                  svn_4:
   829 00000455 AA                      	stosb
   830 00000456 E2F8                    	loop	svn_3
   831                                  svn_5:
   832 00000458 B90B00                  	mov	cx, 11 ; [vname_length]
   833 0000045B 89DE                    	mov	si, bx ; *
   834 0000045D BF[C315]                	mov	di, StrVolumeName
   835 00000460 F3A4                    	rep	movsb
   836                                  	;mov	byte [di], 0
   837                                  
   838 00000462 8B16[D016]              	mov	dx, [Cursor_Pos]
   839 00000466 BB0700                  	mov	bx, 7
   840 00000469 B402                    	mov	ah, 2
   841 0000046B CD10                    	int	10h  ; Set Cursor Position
   842                                  
   843 0000046D BE[C315]                	mov	si, StrVolumeName
   844 00000470 E89500                  	call	print_msg
   845 00000473 BE[0116]                	mov	si, CRLF
   846 00000476 E88F00                  	call	print_msg
   847 00000479 C3                      	retn
   848                                  svn_6:
   849 0000047A B020                    	mov	al, 20h
   850                                  svn_7:
   851 0000047C AA                      	stosb
   852 0000047D E2FD                    	loop	svn_7
   853 0000047F EBD7                    	jmp	short svn_5
   854                                  
   855                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   856                                  ; set & write volume serial number (volume ID)
   857                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   858                                  
   859                                  write_volume_serial:
   860                                  	; SI = (BS) Volume Serial Number (binary) address
   861                                  
   862                                  	;xor	ax, ax
   863                                  	;int	1Ah			; get time of day
   864                                  
   865                                  	;mov	[si], dx
   866                                  	;mov	[si+2], cx		; set unique volume ID
   867                                  
   868                                  	;mov	ah, 02h			; Return Current Time
   869                                  	;int	1Ah
   870                                  	;xchg	ch, cl
   871                                  	;xchg	dh, dl
   872                                  
   873                                  	;add	cx, dx  
   874                                  	;add	[si+2], cx
   875                                                 
   876                                  	;mov	ah, 04h			; Return Current Date
   877                                  	;int	1Ah
   878                                  
   879                                  	;xchg	ch,cl
   880                                  	;xchg	dh,dl
   881                                  
   882                                  	;add	cx, dx  
   883                                  	;add	[si+2], cx
   884                                  
   885                                  	; According to Microsoft DOS 6.0 serial number
   886                                  	; production method...
   887                                  	; < Create unique 32 bit serial number >
   888                                  
   889                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
   890                                  	; (20/04/1987)
   891                                  	;
   892                                  	;  Get date (INT 21h, AH=2Bh)
   893                                  	;  Get time (INT 21h, AH=2Ch)
   894                                  	;  Serial_ID+0 = DX reg date + DX reg time
   895                                  	;  Serial_ID+2 = CX reg date + CX reg time
   896                                  	;  Serial_Num_Low = Serial_ID+2
   897                                  	;  Serial_Num_High = Serial_ID+0
   898                                  
   899 00000481 B404                    	mov	ah, 04h		; Return Current Date
   900 00000483 CD1A                    	int	1Ah
   901                                  
   902                                  	; DL = Day (BCD)	(20h) 	
   903                                  	; DH = Month (BCD)	(12h)
   904                                  	; CH = Century (BCD)	(20h)
   905                                  	; CL = Year (BCD) 	(17h)
   906                                  
   907 00000485 88D0                    	mov	al, dl
   908 00000487 E87100                  	call	bcd_to_bin
   909 0000048A 88C2                    	mov	dl, al 
   910 0000048C 88F0                    	mov	al, dh
   911 0000048E E86A00                  	call	bcd_to_bin
   912 00000491 88C6                    	mov	dh, al 
   913 00000493 88C8                    	mov	al, cl
   914 00000495 E86300                  	call	bcd_to_bin
   915 00000498 88C1                    	mov	cl, al 
   916 0000049A 88E8                    	mov	al, ch
   917 0000049C E85C00                  	call	bcd_to_bin
   918 0000049F 88C5                    	mov	ch, al
   919                                  
   920                                  	; DH = Month (1-10)
   921                                  	; DL = Day (1-31)
   922                                  	; CX = Year (1900-2099)
   923                                  
   924 000004A1 52                      	push	dx 
   925 000004A2 51                      	push	cx
   926                                  
   927 000004A3 B402                    	mov	ah, 02h		; Return Current Time
   928 000004A5 CD1A                    	int	1Ah
   929                                  	
   930                                  	; DH = Seconds (BCD)	(59h) 	
   931                                  	; CL = Minutes (BCD)	(59h)
   932                                  	; CH = Hours (BCD)	(23h)
   933                                  	; DL = Daylight savings time option (1=yes)
   934                                  
   935 000004A7 88F0                    	mov	al, dh
   936 000004A9 E84F00                  	call	bcd_to_bin
   937 000004AC 88C6                    	mov	dh, al 
   938 000004AE 88C8                    	mov	al, cl
   939 000004B0 E84800                  	call	bcd_to_bin
   940 000004B3 88C1                    	mov	cl, al 
   941 000004B5 88E8                    	mov	al, ch
   942 000004B7 E84100                  	call	bcd_to_bin
   943 000004BA 88C5                    	mov	ch, al 
   944                                  
   945                                  	; CH = Hour (0-23)
   946                                  	; CL = Minutes (0-59)
   947                                  	; DH = Seconds (0-59)
   948                                  	; ((DL = Hundredths (0-99) - MSDOS!))
   949                                  	; DL = 0 or 1 (here!)
   950                                  
   951 000004BC 89C8                    	mov	ax, cx
   952 000004BE 59                      	pop	cx
   953 000004BF 01C8                    	add	ax, cx
   954                                  
   955 000004C1 894402                  	mov	[si+2], ax
   956                                  
   957 000004C4 89D0                    	mov	ax, dx
   958 000004C6 5A                      	pop	dx
   959 000004C7 01D0                    	add	ax, dx
   960                                  
   961 000004C9 8904                    	mov	[si], ax
   962                                  
   963 000004CB 30E4                    	xor	ah, ah		; Read time counter
   964 000004CD CD1A                    	int	1Ah
   965                                  
   966                                  	; CX = High word of clock count
   967                                  	; DX = Low word of clock count
   968                                  	; AL = 0 if 24 hours has not passed, else 1
   969                                  
   970                                  	; NOTES: 
   971                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
   972                                  	;
   973                                     	; Following formulas convert the clock count to
   974                                          ; the time of day:
   975                                   	;	Hour      = Clock / 65543 (1007h)
   976                                  	;	Remainder = Clock MOD 65543
   977                                   	;
   978                                  	;	Minutes   = Remainder / 1092 (444h)
   979                                  	;	Remainder = Remainder MOD 1092
   980                                  	;
   981                                  	;	Second    = Remainder / 18.21
   982                                  	;	Remainder = Remainder MOD 18.21
   983                                  	;
   984                                  	;	Hundredths = CINT(Remainder * 100)
   985                                  
   986 000004CF 0014                    	add	[si], dl
   987                                  
   988                                  	; SI = Volume serial number address (4 bytes) 
   989 000004D1 8A04                    	mov	al, [si]
   990 000004D3 E84100                  	call	bin_to_hex
   991 000004D6 A3[F815]                	mov	[Vol_Serial2+2], ax	
   992 000004D9 8A4401                  	mov	al, [si+1]
   993 000004DC E83800                  	call	bin_to_hex
   994 000004DF A3[F615]                	mov	[Vol_Serial2], ax
   995 000004E2 8A4402                  	mov	al, [si+2]
   996 000004E5 E82F00                  	call	bin_to_hex
   997 000004E8 A3[F315]                	mov	[Vol_Serial1+2], ax	
   998 000004EB 8A4403                  	mov	al, [si+3]
   999 000004EE E82600                  	call	bin_to_hex
  1000 000004F1 A3[F115]                	mov	[Vol_Serial1], ax
  1001                                  
  1002 000004F4 BE[DF15]                	mov	si, Msg_Volume_Serial
  1003 000004F7 E80E00                  	call	print_msg
  1004                                  
  1005 000004FA C3                      	retn
  1006                                  
  1007                                  bcd_to_bin:
  1008 000004FB 53                      	push	bx
  1009 000004FC D410                    	db	0D4h,10h  ; Undocumented inst. AAM
  1010                                  			  ; AH = AL / 10h
  1011                                  			  ; AL = AL MOD 10h
  1012 000004FE 88C3                    	mov	bl, al
  1013 00000500 B00A                    	mov	al, 10
  1014 00000502 F6E4                    	mul	ah
  1015 00000504 00D8                    	add	al, bl
  1016 00000506 5B                      	pop	bx
  1017 00000507 C3                      	retn
  1018                                  
  1019                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1020                                  ; Print messages
  1021                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1022                                  
  1023                                  print_msg:
  1024                                  
  1025                                  print_msg_LOOP:
  1026 00000508 AC                      	lodsb                           ; Load byte at DS:SI to AL
  1027 00000509 20C0                    	and     al, al            
  1028 0000050B 7409                    	jz      short print_msg_OK       
  1029 0000050D B40E                    	mov	ah, 0Eh			
  1030 0000050F BB0700                  	mov     bx, 07h             
  1031 00000512 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  1032                                  					; Write char as TTY
  1033                                  					; AL-char BH-page BL-color
  1034 00000514 EBF2                    	jmp     short print_msg_LOOP           
  1035                                  
  1036                                  print_msg_OK:
  1037 00000516 C3                      	retn
  1038                                  
  1039                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1040                                  ; Convert byte to hexadecimal number
  1041                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1042                                  
  1043                                  bin_to_hex:
  1044                                  	; INPUT ->
  1045                                  	; 	AL = byte (binary number)
  1046                                  	; OUTPUT ->
  1047                                  	;	AX = hexadecimal string
  1048                                  	;
  1049 00000517 53                      	push	bx
  1050 00000518 31DB                    	xor	bx, bx
  1051 0000051A 88C3                    	mov	bl, al
  1052 0000051C C0EB04                  	shr	bl, 4
  1053 0000051F 8A9F[070B]              	mov	bl, [bx+hexchrs] 	 	
  1054 00000523 86D8                    	xchg	bl, al
  1055 00000525 80E30F                  	and	bl, 0Fh
  1056 00000528 8AA7[070B]              	mov	ah, [bx+hexchrs] 
  1057 0000052C 5B                      	pop	bx	
  1058 0000052D C3                      	retn
  1059                                  
  1060                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1061                                  ; Read & Write characters
  1062                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1063                                  
  1064                                  rw_char:
  1065                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  1066 0000052E BE[C315]                	mov     si, StrVolumeName
  1067 00000531 BB0700                  	mov     bx, 7
  1068 00000534 B403                    	mov     ah, 3
  1069 00000536 CD10                    	int     10h
  1070 00000538 8916[D016]              	mov     [Cursor_Pos], dx
  1071                                  read_next_char:
  1072 0000053C 30E4                    	xor     ah, ah
  1073 0000053E CD16                    	int     16h
  1074 00000540 20C0                    	and     al, al
  1075 00000542 7439                    	jz      short loc_arrow    
  1076 00000544 3CE0                    	cmp     al, 0E0h          
  1077 00000546 7435                    	je      short loc_arrow
  1078 00000548 3C08                    	cmp     al, 8
  1079 0000054A 753D                    	jne     short char_return
  1080                                  loc_back:
  1081 0000054C B403                    	mov     ah, 3
  1082 0000054E CD10                    	int     10h
  1083 00000550 3A16[D016]              	cmp     dl, byte [Cursor_Pos]
  1084 00000554 761F                    	jna     short loc_beep
  1085                                  prev_column:
  1086 00000556 FECA                    	dec     dl
  1087                                  set_cursor_pos:
  1088 00000558 B402                    	mov     ah, 2
  1089 0000055A CD10                    	int     10h
  1090 0000055C 88D3                    	mov     bl, dl
  1091 0000055E 2A1E[D016]              	sub     bl, byte [Cursor_Pos] 
  1092 00000562 B90100                  	mov     cx, 1
  1093 00000565 B409                    	mov     ah, 9
  1094 00000567 B020                    	mov     al, 20h
  1095 00000569 8800                    	mov     [si+bx], al
  1096                                  loc_write_it:
  1097 0000056B B307                    	mov     bl, 7
  1098 0000056D CD10                    	int     10h
  1099 0000056F 8B16[D016]              	mov     dx, [Cursor_Pos]
  1100 00000573 EBC7                    	jmp     short read_next_char
  1101                                  loc_beep:
  1102 00000575 B40E                    	mov     ah, 0Eh
  1103 00000577 B007                    	mov     al, 7
  1104 00000579 CD10                    	int     10h
  1105 0000057B EBBF                    	jmp     short read_next_char
  1106                                  loc_arrow:    
  1107 0000057D 80FC4B                  	cmp     ah, 4Bh
  1108 00000580 74CA                    	je      short loc_back
  1109 00000582 80FC53                  	cmp     ah, 53h
  1110 00000585 74C5                    	je      short loc_back
  1111 00000587 EBB3                    	jmp     short read_next_char
  1112                                  char_return:
  1113 00000589 B403                    	mov     ah, 3
  1114 0000058B CD10                    	int     10h
  1115                                  check_char_type:
  1116 0000058D 3C20                    	cmp     al, 20h
  1117 0000058F 7228                    	jb      short loc_escape
  1118 00000591 88D4                    	mov     ah, dl
  1119 00000593 2A26[D016]              	sub     ah, byte [Cursor_Pos]
  1120                                  	;cmp	ah, 10 
  1121                                  	;ja	short loc_beep
  1122 00000597 80FC0B                  	cmp     ah, 11 ; [vname_length]
  1123 0000059A 73D9                    	jnb	short loc_beep
  1124 0000059C 3C7A                    	cmp     al, 'z'
  1125 0000059E 779C                    	ja      short read_next_char
  1126 000005A0 3C61                    	cmp     al, 'a'
  1127 000005A2 7202                    	jb      short pass_capitalize
  1128 000005A4 24DF                    	and     al, 0DFh
  1129                                  pass_capitalize:
  1130 000005A6 88E3                    	mov     bl, ah 
  1131 000005A8 30E4                    	xor     ah, ah
  1132 000005AA 8900                    	mov     [si+bx], ax
  1133 000005AC B307                    	mov     bl, 7
  1134 000005AE B40E                    	mov     ah, 0Eh
  1135 000005B0 CD10                    	int     10h
  1136 000005B2 EB88                    	jmp     short read_next_char
  1137                                  pass_escape:
  1138 000005B4 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  1139 000005B6 7584                    	jne     short read_next_char
  1140                                  	;mov	ah, 0Eh
  1141                                  	;int	10h
  1142                                  	;mov	al, 0Ah
  1143                                  	;int	10h
  1144 000005B8 C3                      	retn
  1145                                  loc_escape:
  1146 000005B9 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  1147 000005BB 75F7                    	jne     short pass_escape
  1148 000005BD F9                      	stc
  1149 000005BE C3                      	retn
  1150                                  
  1151                                  write_chs_table:
  1152                                  	; clear screen
  1153 000005BF B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1154 000005C2 CD10                    	int	10h
  1155                                  
  1156 000005C4 BE[1A0B]                	mov	si, Dsk_Type_Select_msg
  1157 000005C7 E83EFF                  	call	print_msg
  1158                                  
  1159 000005CA C3                      	retn
  1160                                  
  1161                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1162                                  ;  Data
  1163                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1164                                  
  1165                                  DskTypeParms:
  1166                                  DskType1Parms:
  1167 000005CB 3201                    cyl1:	dw 306
  1168 000005CD 0400                    hed1:	dw 4
  1169 000005CF 1100                    spt1:	dw 17
  1170 000005D1 4851                    cap1:	dw 306*4*17
  1171                                  DskType2Parms:
  1172 000005D3 3201                    cyl2:	dw 306
  1173 000005D5 0800                    hed2:	dw 8
  1174 000005D7 1100                    spt2:	dw 17
  1175 000005D9 90A2                    cap2:	dw 306*8*17
  1176                                  DskType3Parms:
  1177 000005DB CE01                    cyl3:	dw 462
  1178 000005DD 0800                    hed3:	dw 8
  1179 000005DF 1100                    spt3:	dw 17
  1180 000005E1 70F5                    cap3:	dw 462*8*17
  1181                                  DskType4Parms:
  1182 000005E3 1400                    cyl4:	dw 20
  1183 000005E5 1000                    hed4:	dw 16
  1184 000005E7 3F00                    spt4:	dw 63
  1185 000005E9 C04E                    cap4:	dw 20*16*63
  1186                                  DskType5Parms:
  1187 000005EB 2000                    cyl5:	dw 32
  1188 000005ED 1000                    hed5:	dw 16
  1189 000005EF 3F00                    spt5:	dw 63
  1190 000005F1 007E                    cap5:	dw 32*16*63
  1191                                  DskType6Parms:
  1192 000005F3 2800                    cyl6:	dw 40
  1193 000005F5 1000                    hed6:	dw 16
  1194 000005F7 3F00                    spt6:	dw 63
  1195 000005F9 809D                    cap6:	dw 40*16*63
  1196                                  DskType7Parms:
  1197 000005FB 4000                    cyl7:	dw 64
  1198 000005FD 1000                    hed7:	dw 16
  1199 000005FF 3F00                    spt7:	dw 63
  1200 00000601 00FC                    cap7:	dw 64*16*63
  1201                                  
  1202                                  partition_parms:
  1203                                  
  1204                                  Partition_4MB_17: ; 1
  1205 00000603 0400                    secpc0a: dw 4
  1206 00000605 EC07                    clsts0a: dw 2028
  1207 00000607 0001                    roote0a: dw 256
  1208 00000609 1100                    hidds0a: dw 17
  1209 0000060B 0100                    ressc0a: dw 1
  1210 0000060D 0600                    fatsc0a: dw 6
  1211 0000060F 0D00                    rootd0a: dw 13
  1212 00000611 1D00                    fdats0a: dw 29
  1213 00000613 CF1F                    parts0a: dw (60*8*17)-17 ; 8143 (2 sectors free)
  1214                                  
  1215                                  Partition_4MB_63: ; 2
  1216 00000615 0400                    secpc0b: dw 4
  1217 00000617 C907                    clsts0b: dw 1993
  1218 00000619 0001                    roote0b: dw 256
  1219 0000061B 3F00                    hidds0b: dw 63
  1220 0000061D 0100                    ressc0b: dw 1
  1221 0000061F 0600                    fatsc0b: dw 6
  1222 00000621 0D00                    rootd0b: dw 13
  1223 00000623 1D00                    fdats0b: dw 29
  1224 00000625 411F                    parts0b: dw (8*16*63)-63 ; 8001 (0 sector free)
  1225                                  
  1226                                  Partition_8MB_17: ; 3
  1227 00000627 0800                    secpc1a: dw 8
  1228 00000629 F007                    clsts1a: dw 2032
  1229 0000062B 0002                    roote1a: dw 512
  1230 0000062D 1100                    hidds1a: dw 17
  1231 0000062F 0100                    ressc1a: dw 1
  1232 00000631 0600                    fatsc1a: dw 6
  1233 00000633 0D00                    rootd1a: dw 13
  1234 00000635 2D00                    fdats1a: dw 45
  1235 00000637 AF3F                    parts1a: dw (120*8*17)-17 ; 16303 (2 sectors free)
  1236                                  
  1237                                  Partition_8MB_63: ; 4
  1238 00000639 0800                    secpc1b: dw 8
  1239 0000063B D207                    clsts1b: dw 2002
  1240 0000063D 0002                    roote1b: dw 512
  1241 0000063F 3F00                    hidds1b: dw 63
  1242 00000641 0100                    ressc1b: dw 1
  1243 00000643 0600                    fatsc1b: dw 6
  1244 00000645 0D00                    rootd1b: dw 13
  1245 00000647 2D00                    fdats1b: dw 45
  1246 00000649 C13E                    parts1b: dw (16*16*63)-63 ; 16065 (4 sectors free)
  1247                                  
  1248                                  Partition_10MB_17: ; 5
  1249 0000064B 0800                    secpc2a: dw 8
  1250 0000064D 200A                    clsts2a: dw 2592
  1251 0000064F 0002                    roote2a: dw 512
  1252 00000651 1100                    hidds2a: dw 17
  1253 00000653 0100                    ressc2a: dw 1
  1254 00000655 0800                    fatsc2a: dw 8
  1255 00000657 1100                    rootd2a: dw 17
  1256 00000659 3100                    fdats2a: dw 49
  1257 0000065B 3751                    parts2a: dw (306*4*17)-17 ; 20791 (6 sectors free)
  1258                                  
  1259                                  Partition_10MB_63: ; 6
  1260 0000065D 0800                    secpc2b: dw 8
  1261 0000065F CA09                    clsts2b: dw 2506
  1262 00000661 0002                    roote2b: dw 512
  1263 00000663 3F00                    hidds2b: dw 63
  1264 00000665 0100                    ressc2b: dw 1
  1265 00000667 0800                    fatsc2b: dw 8
  1266 00000669 1100                    rootd2b: dw 17
  1267 0000066B 3100                    fdats2b: dw 49
  1268 0000066D 814E                    parts2b: dw (20*16*63)-63 ; 20097 (0 sector free)
  1269                                  
  1270                                  Partition_16MB_17: ; 7
  1271 0000066F 0800                    secpc3a: dw 8
  1272 00000671 E60F                    clsts3a: dw 4070
  1273 00000673 0002                    roote3a: dw 512
  1274 00000675 1100                    hidds3a: dw 17
  1275 00000677 0100                    ressc3a: dw 1
  1276 00000679 0C00                    fatsc3a: dw 12
  1277 0000067B 1900                    rootd3a: dw 25
  1278 0000067D 3900                    fdats3a: dw 57
  1279 0000067F 6F7F                    parts3a: dw (240*8*17)-17 ; 32623 (6 sectors free)
  1280                                  
  1281                                  Partition_16MB_63: ; 8
  1282 00000681 0800                    secpc3b: dw 8
  1283 00000683 B10F                    clsts3b: dw 4017
  1284 00000685 0002                    roote3b: dw 512
  1285 00000687 3F00                    hidds3b: dw 63
  1286 00000689 0100                    ressc3b: dw 1
  1287 0000068B 0C00                    fatsc3b: dw 12
  1288 0000068D 1900                    rootd3b: dw 25
  1289 0000068F 3900                    fdats3b: dw 57
  1290 00000691 C17D                    parts3b: dw (32*16*63)-63 ; 32193 (0 sector free)					
  1291                                  
  1292                                  Partition_20MB_17: ; 9
  1293 00000693 1000                    secpc4a: dw 16
  1294 00000695 220A                    clsts4a: dw 2594
  1295 00000697 0004                    roote4a: dw 1024
  1296 00000699 1100                    hidds4a: dw 17
  1297 0000069B 0100                    ressc4a: dw 1
  1298 0000069D 0800                    fatsc4a: dw 8
  1299 0000069F 1100                    rootd4a: dw 17
  1300 000006A1 5100                    fdats4a: dw 81
  1301 000006A3 7FA2                    parts4a: dw (306*8*17)-17 ; 41599 (14 sectors free)
  1302                                  
  1303                                  Partition_20MB_63: ; 10	
  1304 000006A5 1000                    secpc4b: dw 16
  1305 000006A7 CF09                    clsts4b: dw 2511
  1306 000006A9 0004                    roote4b: dw 1024
  1307 000006AB 3F00                    hidds4b: dw 63
  1308 000006AD 0100                    ressc4b: dw 1
  1309 000006AF 0800                    fatsc4b: dw 8
  1310 000006B1 1100                    rootd4b: dw 17
  1311 000006B3 5100                    fdats4b: dw 81
  1312 000006B5 419D                    parts4b: dw (40*16*63)-63 ; 40257 (0 sector free)
  1313                                  
  1314                                  Partition_31MB:    ; 11
  1315 000006B7 1000                    secpc5a: dw 16
  1316 000006B9 500F                    clsts5a: dw 3920
  1317 000006BB 0004                    roote5a: dw 1024
  1318 000006BD 1100                    hidds5a: dw 17
  1319 000006BF 0100                    ressc5a: dw 1
  1320 000006C1 0C00                    fatsc5a: dw 12
  1321 000006C3 1900                    rootd5a: dw 25
  1322 000006C5 5900                    fdats5a: dw 89
  1323 000006C7 5FF5                    parts5a: dw (462*8*17)-17 ; 62815 (6 sectors free)
  1324                                  
  1325                                  Partition_32MB:	  ;  12
  1326 000006C9 1000                    secpc5b: dw 16
  1327 000006CB B60F                    clsts5b: dw 4022
  1328 000006CD 0004                    roote5b: dw 1024
  1329 000006CF 3F00                    hidds5b: dw 63
  1330 000006D1 0100                    ressc5b: dw 1
  1331 000006D3 0C00                    fatsc5b: dw 12
  1332 000006D5 1900                    rootd5b: dw 25
  1333 000006D7 5900                    fdats5b: dw 89
  1334 000006D9 C1FB                    parts5b: dw (64*16*63)-63 ; 64449 (8 sectors free)
  1335                                  
  1336                                  
  1337                                  OptionValidatingTable:
  1338                                  ; 	Option  4MB,8MB,10M,16M,20M,WHOLE DISK	
  1339 000006DB 010005000005            	db	 1,  0,  5,  0,  0,  5   ; 10MB, 17SPT	 	
  1340 000006E1 010305000909            	db	 1,  3,  5,  0,  9,  9	 ; 20MB, 17SPT
  1341 000006E7 01030507000B            	db	 1,  3,  5,  7,  0, 11   ; 31MB, 17SPT	 	
  1342 000006ED 020006000006            	db	 2,  0,  6,  0,  0,  6   ; 10MB, 63SPT	 	
  1343 000006F3 020400080008            	db	 2,  4,  0,  8,  0,  8	 ; 16MB, 63SPT
  1344 000006F9 020406000A0A            	db	 2,  4,  6,  0, 10, 10	 ; 20MB, 63SPT
  1345 000006FF 02040608000C            	db	 2,  4,  6,  8,  0, 12   ; 32MB, 63SPT
  1346                                  
  1347 00000705 00                      	db	0
  1348                                  
  1349                                  RETRODOS_MASTERBOOT_SECTOR:
  1350 00000706 <bin 200h>              	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR	
  1351                                  
  1352                                  RETRODOS_FAT12_hd_bs: 
  1353                                  	;incbin	'RD2HDBS.BIN' ; BS Last Update: 25/10/2023
  1354                                  	; 04/05/2024
  1355 00000906 <bin 200h>              	incbin	'RD5HDBS1.BIN' ; 20/04/2024
  1356                                  
  1357 00000B06 00                      	db	0
  1358                                  
  1359                                  hexchrs:
  1360 00000B07 303132333435363738-     	db	'0123456789ABCDEF'
  1360 00000B10 39414243444546     
  1361                                  
  1362 00000B17 90                      align 2
  1363                                  
  1364                                  img_file_handle:
  1365 00000B18 0000                    	dw	0
  1366                                  
  1367                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1368                                  ;  Messages
  1369                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1370                                  
  1371                                  Dsk_Type_Select_msg:
  1372                                  ;db  "RETRO DOS v2.0 Hard Disk Image Utility by Erdogan Tan (2018)                    "
  1373 00000B1A 524554524F20444F53-     db  "RETRO DOS v5.0 Hard Disk Image Utility by Erdogan Tan (2018-2024)               "
  1373 00000B23 2076352E3020486172-
  1373 00000B2C 64204469736B20496D-
  1373 00000B35 616765205574696C69-
  1373 00000B3E 747920627920457264-
  1373 00000B47 6F67616E2054616E20-
  1373 00000B50 28323031382D323032-
  1373 00000B59 342920202020202020-
  1373 00000B62 2020202020202020   
  1374 00000B6A 202020202020202020-     db  "                                                                                "
  1374 00000B73 202020202020202020-
  1374 00000B7C 202020202020202020-
  1374 00000B85 202020202020202020-
  1374 00000B8E 202020202020202020-
  1374 00000B97 202020202020202020-
  1374 00000BA0 202020202020202020-
  1374 00000BA9 202020202020202020-
  1374 00000BB2 2020202020202020   
  1375 00000BBA 202020202020202020-     db  "                                                                                "
  1375 00000BC3 202020202020202020-
  1375 00000BCC 202020202020202020-
  1375 00000BD5 202020202020202020-
  1375 00000BDE 202020202020202020-
  1375 00000BE7 202020202020202020-
  1375 00000BF0 202020202020202020-
  1375 00000BF9 202020202020202020-
  1375 00000C02 2020202020202020   
  1376 00000C0A 4469736B2054797065-     db  "Disk Type     Cylinders     Heads     Sectors       Capacity                    "
  1376 00000C13 202020202043796C69-
  1376 00000C1C 6E6465727320202020-
  1376 00000C25 204865616473202020-
  1376 00000C2E 2020536563746F7273-
  1376 00000C37 202020202020204361-
  1376 00000C40 706163697479202020-
  1376 00000C49 202020202020202020-
  1376 00000C52 2020202020202020   
  1377 00000C5A 2D2D2D2D2D2D2D2D2D-     db  "---------     ---------     -----     -------       --------                    "
  1377 00000C63 20202020202D2D2D2D-
  1377 00000C6C 2D2D2D2D2D20202020-
  1377 00000C75 202D2D2D2D2D202020-
  1377 00000C7E 20202D2D2D2D2D2D2D-
  1377 00000C87 202020202020202D2D-
  1377 00000C90 2D2D2D2D2D2D202020-
  1377 00000C99 202020202020202020-
  1377 00000CA2 2020202020202020   
  1378 00000CAA 202020202031202020-     db  "     1           306          4         17            10 MB                     "
  1378 00000CB3 202020202020202033-
  1378 00000CBC 303620202020202020-
  1378 00000CC5 202020342020202020-
  1378 00000CCE 202020203137202020-
  1378 00000CD7 202020202020202020-
  1378 00000CE0 3130204D4220202020-
  1378 00000CE9 202020202020202020-
  1378 00000CF2 2020202020202020   
  1379 00000CFA 202020202032202020-     db  "     2           306          8         17            20 MB                     "
  1379 00000D03 202020202020202033-
  1379 00000D0C 303620202020202020-
  1379 00000D15 202020382020202020-
  1379 00000D1E 202020203137202020-
  1379 00000D27 202020202020202020-
  1379 00000D30 3230204D4220202020-
  1379 00000D39 202020202020202020-
  1379 00000D42 2020202020202020   
  1380 00000D4A 202020202033202020-     db  "     3           462          8         17            31 MB                     " 	      	     	
  1380 00000D53 202020202020202034-
  1380 00000D5C 363220202020202020-
  1380 00000D65 202020382020202020-
  1380 00000D6E 202020203137202020-
  1380 00000D77 202020202020202020-
  1380 00000D80 3331204D4220202020-
  1380 00000D89 202020202020202020-
  1380 00000D92 2020202020202020   
  1381 00000D9A 202020202020202020-     db  "                                                                                "
  1381 00000DA3 202020202020202020-
  1381 00000DAC 202020202020202020-
  1381 00000DB5 202020202020202020-
  1381 00000DBE 202020202020202020-
  1381 00000DC7 202020202020202020-
  1381 00000DD0 202020202020202020-
  1381 00000DD9 202020202020202020-
  1381 00000DE2 2020202020202020   
  1382 00000DEA 202020202034202020-     db  "     4            20         16         63            10 MB                     "
  1382 00000DF3 202020202020202020-
  1382 00000DFC 323020202020202020-
  1382 00000E05 202031362020202020-
  1382 00000E0E 202020203633202020-
  1382 00000E17 202020202020202020-
  1382 00000E20 3130204D4220202020-
  1382 00000E29 202020202020202020-
  1382 00000E32 2020202020202020   
  1383 00000E3A 202020202035202020-     db  "     5            32         16         63            16 MB                     "   	
  1383 00000E43 202020202020202020-
  1383 00000E4C 333220202020202020-
  1383 00000E55 202031362020202020-
  1383 00000E5E 202020203633202020-
  1383 00000E67 202020202020202020-
  1383 00000E70 3136204D4220202020-
  1383 00000E79 202020202020202020-
  1383 00000E82 2020202020202020   
  1384 00000E8A 202020202036202020-     db  "     6            40         16         63            20 MB                     "
  1384 00000E93 202020202020202020-
  1384 00000E9C 343020202020202020-
  1384 00000EA5 202031362020202020-
  1384 00000EAE 202020203633202020-
  1384 00000EB7 202020202020202020-
  1384 00000EC0 3230204D4220202020-
  1384 00000EC9 202020202020202020-
  1384 00000ED2 2020202020202020   
  1385 00000EDA 202020202037202020-     db  "     7            64         16         63            32 MB                     " 	 
  1385 00000EE3 202020202020202020-
  1385 00000EEC 363420202020202020-
  1385 00000EF5 202031362020202020-
  1385 00000EFE 202020203633202020-
  1385 00000F07 202020202020202020-
  1385 00000F10 3332204D4220202020-
  1385 00000F19 202020202020202020-
  1385 00000F22 2020202020202020   
  1386 00000F2A 202020202020202020-     db  "                                                                                "
  1386 00000F33 202020202020202020-
  1386 00000F3C 202020202020202020-
  1386 00000F45 202020202020202020-
  1386 00000F4E 202020202020202020-
  1386 00000F57 202020202020202020-
  1386 00000F60 202020202020202020-
  1386 00000F69 202020202020202020-
  1386 00000F72 2020202020202020   
  1387 00000F7A 202020202020202020-     db  "                                                                                "
  1387 00000F83 202020202020202020-
  1387 00000F8C 202020202020202020-
  1387 00000F95 202020202020202020-
  1387 00000F9E 202020202020202020-
  1387 00000FA7 202020202020202020-
  1387 00000FB0 202020202020202020-
  1387 00000FB9 202020202020202020-
  1387 00000FC2 2020202020202020   
  1388 00000FCA 507265737320646973-     db  "Press disk number (1 to 7) to SELECT or                                         "
  1388 00000FD3 6B206E756D62657220-
  1388 00000FDC 283120746F20372920-
  1388 00000FE5 746F2053454C454354-
  1388 00000FEE 206F72202020202020-
  1388 00000FF7 202020202020202020-
  1388 00001000 202020202020202020-
  1388 00001009 202020202020202020-
  1388 00001012 2020202020202020   
  1389 0000101A 202020202020202020-     db  "                                                                                " 
  1389 00001023 202020202020202020-
  1389 0000102C 202020202020202020-
  1389 00001035 202020202020202020-
  1389 0000103E 202020202020202020-
  1389 00001047 202020202020202020-
  1389 00001050 202020202020202020-
  1389 00001059 202020202020202020-
  1389 00001062 2020202020202020   
  1390 0000106A 507265737320455343-     db  "Press ESC to cancel.                                                            "
  1390 00001073 20746F2063616E6365-
  1390 0000107C 6C2E20202020202020-
  1390 00001085 202020202020202020-
  1390 0000108E 202020202020202020-
  1390 00001097 202020202020202020-
  1390 000010A0 202020202020202020-
  1390 000010A9 202020202020202020-
  1390 000010B2 2020202020202020   
  1391 000010BA 202020202020202020-     db  "                                                                                " 
  1391 000010C3 202020202020202020-
  1391 000010CC 202020202020202020-
  1391 000010D5 202020202020202020-
  1391 000010DE 202020202020202020-
  1391 000010E7 202020202020202020-
  1391 000010F0 202020202020202020-
  1391 000010F9 202020202020202020-
  1391 00001102 2020202020202020   
  1392 0000110A 00                      db  0
  1393                                  
  1394                                  RetroDOS_Welcome:
  1395 0000110B 0D0A                    	db	0Dh, 0Ah
  1396 0000110D 526574726F20444F53-     	db	'Retro DOS v5 Fixed Disk Image (FAT12 FS) Format Utility'
  1396 00001116 207635204669786564-
  1396 0000111F 204469736B20496D61-
  1396 00001128 676520284641543132-
  1396 00001131 2046532920466F726D-
  1396 0000113A 6174205574696C6974-
  1396 00001143 79                 
  1397 00001144 0D0A                    	db	0Dh, 0Ah
  1398 00001146 464154313248444920-     	db	"FAT12HDI v5.0.240504 (c) Erdogan TAN 2018-2024"
  1398 0000114F 76352E302E32343035-
  1398 00001158 303420286329204572-
  1398 00001161 646F67616E2054414E-
  1398 0000116A 20323031382D323032-
  1398 00001173 34                 
  1399 00001174 0D0A                    	db	0Dh,0Ah
  1400 00001176 0D0A                    	db	0Dh,0Ah
  1401 00001178 55736167653A207264-     	db	'Usage: rd5hdi12 <image file name> '
  1401 00001181 356864693132203C69-
  1401 0000118A 6D6167652066696C65-
  1401 00001193 206E616D653E20     
  1402 0000119A 00                      	db	0
  1403                                  
  1404                                  msg_inv_file_name: 
  1405 0000119B 0D0A                    	db	0Dh, 0Ah
  1406 0000119D 496E76616C69642066-     	db	"Invalid file name !", 0Dh, 0Ah
  1406 000011A6 696C65206E616D6520-
  1406 000011AF 210D0A             
  1407 000011B2 2846696C65206E616D-     	db	"(File name must fit to 8.3 DOS format) !"
  1407 000011BB 65206D757374206669-
  1407 000011C4 7420746F20382E3320-
  1407 000011CD 444F5320666F726D61-
  1407 000011D6 74292021           
  1408 000011DA 0D0A00                  	db	0Dh, 0Ah, 0
  1409                                  
  1410                                  msg_inv_image_file:
  1411 000011DD 0D0A                    	db	0Dh, 0Ah
  1412 000011DF 496E76616C69642066-     	db	"Invalid fixed disk image file !", 0Dh, 0Ah
  1412 000011E8 69786564206469736B-
  1412 000011F1 20696D616765206669-
  1412 000011FA 6C6520210D0A       
  1413 00001200 2846696C652073697A-     	db	"(File size is not compatible) !"
  1413 00001209 65206973206E6F7420-
  1413 00001212 636F6D70617469626C-
  1413 0000121B 65292021           
  1414 0000121F 0D0A00                  	db	0Dh, 0Ah, 0 
  1415                                  
  1416                                  msg_option_not_proper:
  1417 00001222 53656C656374656420-     	db	"Selected partion size is not proper for selected disk size !"
  1417 0000122B 70617274696F6E2073-
  1417 00001234 697A65206973206E6F-
  1417 0000123D 742070726F70657220-
  1417 00001246 666F722073656C6563-
  1417 0000124F 746564206469736B20-
  1417 00001258 73697A652021       
  1418 0000125E 0D0A                    	db	0Dh, 0Ah
  1419 00001260 28596F75206E656564-     	db	"(You need to select another option.)"
  1419 00001269 20746F2073656C6563-
  1419 00001272 7420616E6F74686572-
  1419 0000127B 206F7074696F6E2E29 
  1420 00001284 0D0D00                  	db	0Dh, 0Dh, 0 
  1421                                  
  1422                                  msg_any_key_esc_exit:
  1423 00001287 0D0A                    	db	0Dh, 0Ah
  1424 00001289 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
  1424 00001292 20746F206578697420-
  1424 0000129B 6F7220707265737320-
  1424 000012A4 616E6F74686572206B-
  1424 000012AD 657920746F20636F6E-
  1424 000012B6 74696E75652E2E2E   
  1425 000012BE 00                      	db	0
  1426                                  
  1427                                  msg_create_dos_partition_h:
  1428 000012BF 0D0A                    	db	0Dh, 0Ah
  1429 000012C1 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  1429 000012CA 2D2D2D2D2D2D2D2D2D-
  1429 000012D3 2D2D2D2D2D2D2D2D2D-
  1429 000012DC 2D2D2D2D2D2D2D2D2D-
  1429 000012E5 2D2D2D2D2D2D2D2D2D-
  1429 000012EE 2D2D2D2D2D2D2D2D2D-
  1429 000012F7 2D2D2D2D2D2D2D2D2D-
  1429 00001300 2D2D2D2D2D2D2D2D2D-
  1429 00001309 2D2D2D2D2D2D2D2D   
  1430 00001311 202020202020202020-     	db	"                        Create Primary DOS Partition                            "
  1430 0000131A 202020202020202020-
  1430 00001323 202020202020437265-
  1430 0000132C 617465205072696D61-
  1430 00001335 727920444F53205061-
  1430 0000133E 72746974696F6E2020-
  1430 00001347 202020202020202020-
  1430 00001350 202020202020202020-
  1430 00001359 2020202020202020   
  1431 00001361 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  1431 0000136A 2D2D2D2D2D2D2D2D2D-
  1431 00001373 2D2D2D2D2D2D2D2D2D-
  1431 0000137C 2D2D2D2D2D2D2D2D2D-
  1431 00001385 2D2D2D2D2D2D2D2D2D-
  1431 0000138E 2D2D2D2D2D2D2D2D2D-
  1431 00001397 2D2D2D2D2D2D2D2D2D-
  1431 000013A0 2D2D2D2D2D2D2D2D2D-
  1431 000013A9 2D2D2D2D2D2D2D2D   
  1432 000013B1 0D0A00                  	db	0Dh, 0Ah, 0	
  1433                                  msg_create_dos_partition_m:
  1434 000013B4 53656C65637420616E-     	db	"Select an option: "
  1434 000013BD 206F7074696F6E3A20 
  1435 000013C6 0D0A                    	db	0Dh, 0Ah
  1436 000013C8 0D0A                    	db	0Dh, 0Ah
  1437 000013CA 202031292055736520-     	db	"  1) Use  4 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1437 000013D3 2034204D4220646973-
  1437 000013DC 6B2073706163652066-
  1437 000013E5 6F7220464154313220-
  1437 000013EE 706172746974696F6E-
  1437 000013F7 200D0A             
  1438 000013FA 202032292055736520-     	db	"  2) Use  8 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1438 00001403 2038204D4220646973-
  1438 0000140C 6B2073706163652066-
  1438 00001415 6F7220464154313220-
  1438 0000141E 706172746974696F6E-
  1438 00001427 200D0A             
  1439 0000142A 202033292055736520-     	db	"  3) Use 10 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1439 00001433 3130204D4220646973-
  1439 0000143C 6B2073706163652066-
  1439 00001445 6F7220464154313220-
  1439 0000144E 706172746974696F6E-
  1439 00001457 200D0A             
  1440 0000145A 202034292055736520-     	db	"  4) Use 16 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1440 00001463 3136204D4220646973-
  1440 0000146C 6B2073706163652066-
  1440 00001475 6F7220464154313220-
  1440 0000147E 706172746974696F6E-
  1440 00001487 200D0A             
  1441 0000148A 202035292055736520-     	db	"  5) Use 20 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1441 00001493 3230204D4220646973-
  1441 0000149C 6B2073706163652066-
  1441 000014A5 6F7220464154313220-
  1441 000014AE 706172746974696F6E-
  1441 000014B7 200D0A             
  1442 000014BA 202036292055736520-     	db	"  6) Use whole disk space for FAT12 partition ", 0Dh, 0Ah
  1442 000014C3 77686F6C6520646973-
  1442 000014CC 6B2073706163652066-
  1442 000014D5 6F7220464154313220-
  1442 000014DE 706172746974696F6E-
  1442 000014E7 200D0A             
  1443 000014EA 0D0A                    	db	0Dh, 0Ah	
  1444 000014EC 507265737320455343-     	db	"Press ESC or 0 to exit .. "
  1444 000014F5 206F72203020746F20-
  1444 000014FE 65786974202E2E20   
  1445 00001506 0D0A00                   	db 	0Dh, 0Ah, 0
  1446                                  
  1447                                  msg_overwrite_question1:
  1448 00001509 0D0A                    	db	0Dh, 0Ah
  1449 0000150B 446F20796F75207761-     	db	'Do you want to overwrite '
  1449 00001514 6E7420746F206F7665-
  1449 0000151D 72777269746520     
  1450 00001524 27                      	db	27h
  1451 00001525 00                      	db	0
  1452                                  
  1453                                  msg_overwrite_question2: 
  1454 00001526 27                      	db	27h
  1455 00001527 2066696C6520            	db	' file '
  1456 0000152D 00                      	db	0
  1457                                  
  1458                                  msg_yes_no:
  1459 0000152E 285965732F4E6F293F-     	db	'(Yes/No)? ', 0	
  1459 00001537 2000               
  1460                                  
  1461                                  msg_writing_mbr:
  1462 00001539 57726974696E67206D-     	db	"Writing masterboot sector...", 0
  1462 00001542 6173746572626F6F74-
  1462 0000154B 20736563746F722E2E-
  1462 00001554 2E00               
  1463                                  
  1464                                  msg_writing_disk_sectors:
  1465 00001556 57726974696E672064-     	db	"Writing disk sector: ", 0
  1465 0000155F 69736B20736563746F-
  1465 00001568 723A2000           
  1466                                  
  1467                                  msg_writing_boot_sector:
  1468 0000156C 57726974696E672076-     	db	"Writing volume boot sector...", 0
  1468 00001575 6F6C756D6520626F6F-
  1468 0000157E 7420736563746F722E-
  1468 00001587 2E2E00             
  1469                                  
  1470                                  msg_writing_FAT_sectors:
  1471 0000158A 57726974696E672046-     	db	"Writing FAT sectors...", 0
  1471 00001593 415420736563746F72-
  1471 0000159C 732E2E2E00         
  1472                                  
  1473                                  msg_writing_root_dir:
  1474 000015A1 57726974696E672072-     	db	"Writing root directory sectors...", 0
  1474 000015AA 6F6F74206469726563-
  1474 000015B3 746F72792073656374-
  1474 000015BC 6F72732E2E2E00     
  1475                                  
  1476                                  StrVolumeName:
  1477 000015C3 00<rep Ch>              	times 	12 db  0
  1478                                  
  1479                                  Msg_Volume_Name:
  1480 000015CF 0D0A                    	db	0Dh, 0Ah
  1481 000015D1 566F6C756D65204E61-     	db	"Volume Name: ", 0
  1481 000015DA 6D653A2000         
  1482                                  
  1483                                  Msg_Volume_Serial:
  1484 000015DF 566F6C756D65205365-     	db	"Volume Serial No: "
  1484 000015E8 7269616C204E6F3A20 
  1485                                  Vol_Serial1:
  1486 000015F1 30303030                	db	"0000"
  1487 000015F5 2D                      	db	"-"
  1488                                  Vol_Serial2:
  1489 000015F6 30303030                	db	"0000"
  1490 000015FA 0D0A00                  	db	0Dh, 0Ah, 0
  1491                                  
  1492                                  msg_OK:
  1493 000015FD 204F4B2E                	db	' OK.'
  1494                                  CRLF:
  1495 00001601 0D0A00                  	db	0Dh, 0Ah, 0
  1496                                  Msg_YES:
  1497 00001604 20                      	db	 20h
  1498                                  msg_yes_:
  1499 00001605 59455300                	db	'YES', 0
  1500                                  Msg_NO:
  1501 00001609 20                      	db	20h
  1502                                  msg_no_:
  1503 0000160A 4E4F00                  	db	'NO', 0
  1504                                  
  1505                                  Msg_Error:
  1506 0000160D 0D0A                    	db	0Dh, 0Ah
  1507 0000160F 4572726F72202120        	db	'Error ! '
  1508 00001617 28                      	db	'('
  1509                                  error_code:
  1510 00001618 3030                    	dw	3030h
  1511 0000161A 68                      	db	'h'
  1512 0000161B 2920                    	db	') '
  1513 0000161D 0D0A                    	db	0Dh, 0Ah
  1514 0000161F 00                      	db	0
  1515                                  
  1516                                  msg_disk_type_selected:
  1517 00001620 4469736B2054797065-     	db	"Disk Type "
  1517 00001629 20                 
  1518                                  delected_disk_num:
  1519 0000162A 202068617320626565-     	db	"  has been selected."
  1519 00001633 6E2073656C65637465-
  1519 0000163C 642E               
  1520 0000163E 0D0A00                  	db 0Dh, 0Ah, 0
  1521                                  msg_enter_cancel:
  1522 00001641 0D0A                    	db	0Dh, 0Ah
  1523 00001643 507265737320454E54-     	db	"Press ENTER to write file or press ESC to cancel." 
  1523 0000164C 455220746F20777269-
  1523 00001655 74652066696C65206F-
  1523 0000165E 722070726573732045-
  1523 00001667 534320746F2063616E-
  1523 00001670 63656C2E           
  1524 00001674 0D0A00                  	db	0Dh, 0Ah, 0
  1525                                  
  1526                                  msg_press_any_key:
  1527 00001677 0D0A                    	db	0Dh, 0Ah
  1528 00001679 50726573732061206B-     	db	"Press a key to continue..." 
  1528 00001682 657920746F20636F6E-
  1528 0000168B 74696E75652E2E2E   
  1529 00001693 0D0A00                  	db	0Dh, 0Ah, 0
  1530                                  
  1531                                  msg_creating:
  1532 00001696 0D0A                    	db	0Dh, 0Ah
  1533 00001698 4372656174696E6720      	db	"Creating "
  1534                                  msg_disk_size:
  1535 000016A1 31304D422068617264-     	db	"10MB hard disk image... ",
  1535 000016AA 206469736B20696D61-
  1535 000016B3 67652E2E2E20       
  1536 000016B9 20                      	db	" "
  1537 000016BA 00                      	db	0
  1538                                  
  1539                                  DskTypeNumStr:	
  1540 000016BB 313032303331313031-     	db	"10203110162032"
  1540 000016C4 3632303332         
  1541 000016C9 0000                    	dw	0
  1542                                  
  1543                                  RSymbols:
  1544 000016CB 2D5C7C2F                	db	"-\|/"
  1545                                  
  1546 000016CF 90                      align 2
  1547                                  
  1548                                  Cursor_Pos:
  1549 000016D0 0000                    	dw	0
  1550                                  
  1551                                  CWSector:
  1552 000016D2 0000                    	dw	0
  1553                                  
  1554                                  diskimage_size:
  1555 000016D4 0000                    	dw	0
  1556                                  
  1557                                  DiskType:
  1558 000016D6 00                      	db	0
  1559                                  
  1560                                  img_file_name:  
  1561 000016D7 00<rep Dh>              	times	13 db 0
  1562                                  
  1563                                  ;no_name:
  1564                                  ;	db 	'NO NAME    ', 0
  1565                                  
  1566                                  align 2
  1567                                  
  1568                                  HDFORMAT_SECBUFFER:
  1569                                  HDFORMAT_FATBUFFER:
  1570                                  HDFORMAT_ZERO_BUFF:
  1571 000016E4 F6<rep 200h>            	times	512 db 0F6h
  1572                                  
  1573 000018E4 00                      	db	0
  1574 000018E5 286329204572646F67-     	db	'(c) Erdogan TAN 2018-2024'
  1574 000018EE 616E2054414E203230-
  1574 000018F7 31382D32303234     
  1575 000018FE 00                      	db	0
  1576                                  
  1577                                  SizeOfFile equ $-100
