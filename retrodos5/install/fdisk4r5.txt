     1                                  ; ****************************************************************************
     2                                  ; FDISK4R5.ASM (FDISK4R5.COM) - Retro DOS v5 Hard Disk Partitioning Utility
     3                                  ; fdisk4.s						(for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; 32 bit cylinder numbers modification on fdisk3.s (2TB hardisk partitioning)
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Last Update: 04/05/2024
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Beginning: 05/11/2020
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Assembler: NASM version 2.15
    12                                  ; ----------------------------------------------------------------------------
    13                                  ; Modified from 'FDISK4.ASM' (FDISK4.COM) source code by Erdogan Tan
    14                                  ; (04/05/2024) - TRDOS 386 v2 fixed disk partitioning utility -
    15                                  ; ****************************************************************************
    16                                  ; nasm fdisk4r5.s -l fdisk4r5.txt -o FDISK4R5.COM -Z error.txt
    17                                  
    18                                  ; Masterboot / Partition Table at Beginning+1BEh
    19                                  ptBootable      equ 0
    20                                  ptBeginHead     equ 1
    21                                  ptBeginSector   equ 2
    22                                  ptBeginCylinder equ 3
    23                                  ptFileSystemID	equ 4
    24                                  ptEndHead       equ 5
    25                                  ptEndSector     equ 6
    26                                  ptEndCylinder   equ 7
    27                                  ptStartSector   equ 8
    28                                  ptSectors       equ 12
    29                                  
    30                                  ; BIOS Disk Parameters
    31                                  DPDiskNumber  equ 0h
    32                                  DPDType       equ 1h
    33                                  DPReturn      equ 2h
    34                                  DPHeads       equ 3h
    35                                  DPCylinders   equ 4h
    36                                  DPSecPerTrack equ 6h
    37                                  DPDisks       equ 7h
    38                                  DPTableOff    equ 8h
    39                                  DPTableSeg    equ 0Ah
    40                                  DPNumOfSecs   equ 0Ch
    41                                  
    42                                  ; BIOS INT 13h Extensions (LBA extensions)
    43                                  ; Just After DP Data (DPDiskNumber+)
    44                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    45                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    46                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    47                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    48                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    49                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    50                                                          ; C1= Selected Cylinder Number
    51                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    52                                                          ; H1= Selected Head Number
    53                                                          ; S0= Maximum Sector Number
    54                                                          ; S1= Selected Sector Number
    55                                                          ; QUAD WORD
    56                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    57                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    58                                                               ; TR-DOS will not use 64 bit Flat Address
    59                                  
    60                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    61                                  ; Just After DP Data (DPDiskNumber+)
    62                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
    63                                  GDP_48h_InfoFlag equ 22h ; Word
    64                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
    65                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
    66                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
    67                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
    68                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
    69                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
    70                                  
    71                                  pTableOffset equ 1BEh ; 446
    72                                  
    73                                  	; Convert LBA to CHS
    74                                  	; 08/02/2019
    75                                  
    76                                  	; LBA = ((C1*H0+H1)*S0)+S1-1
    77                                  	;
    78                                  	; C1 = Selected Cylinder Number
    79                                  	; H0 = Number of Heads (Maximum Head Number + 1)
    80                                  	; H1 = Selected Head Number
    81                                  	; S0 = Maximum Sector Number
    82                                  	; S1 = Selected Sector Number
    83                                  	;
    84                                  	; Phoenix, Enchanced Disk Drive Specicifications, v1.1, Page 8)
    85                                  
    86                                  [BITS 16]
    87                                  [ORG 100h]
    88                                  
    89                                  ; Note: 80386 cpu is required (this program will not run on 80286 systems)
    90                                  
    91                                  	; Detect 80386 cpu (386+)
    92                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    93                                  ; detect 386+ cpu
    94                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    95                                  ; 06/11/2020
    96                                  	; (https://forum.osdev.org/viewtopic.php?p=36822)
    97                                  	; (ogotay)
    98                                  
    99 00000000 9C                      	pushf
   100 00000001 B4D0                    	mov	ah, 0D0h
   101 00000003 50                      	push	ax
   102 00000004 9D                      	popf
   103 00000005 9C                      	pushf
   104 00000006 58                      	pop	ax
   105 00000007 9D                      	popf
   106 00000008 80FC50                  	cmp	ah, 50h
   107 0000000B 7408                    	je	short _386_ok
   108                                  	
   109                                  	; Write program message and terminate
   110                                  
   111 0000000D BE[A240]                	mov	si, TrDOS_Welcome
   112 00000010 E89919                  	call	print_msg
   113                                  	
   114 00000013 CD20                    	int	20h
   115                                  
   116                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   117                                  _386_ok:
   118                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   119                                  
   120                                  	;cli
   121                                  	;cld
   122                                  	;push	cs
   123                                  	;pop	ss
   124                                  	;mov	sp, 0FFFEh
   125                                  	;sti
   126                                  	
   127                                  	;mov	bx, SizeOfFile+100
   128                                  	
   129 00000015 BB[E06D]                	mov	bx, bss_end
   130                                  
   131 00000018 83C30F                          add	bx, 15
   132 0000001B D1EB                            shr	bx, 1
   133 0000001D D1EB                            shr	bx, 1
   134 0000001F D1EB                    	shr	bx, 1
   135 00000021 D1EB                    	shr	bx, 1
   136 00000023 B44A                            mov	ah, 4Ah ; modify memory allocation
   137                                          ;push	cs
   138                                          ;pop	es
   139 00000025 CD21                            int	21h
   140                                  
   141                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   142                                  ; clear BSS
   143                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   144                                  ; 03/02/2019
   145                                  
   146                                  	;mov	cx, bss_end
   147 00000027 B9[726C]                	mov	cx, bss_clear_end ; 15/02/2019
   148                                  
   149 0000002A BF[2A65]                	mov	di, bss_start
   150 0000002D 29F9                    	sub	cx, di
   151 0000002F 41                      	inc	cx
   152 00000030 D1E9                    	shr	cx, 1
   153 00000032 31C0                    	xor	ax, ax
   154 00000034 F3AB                    	rep	stosw 
   155                                  
   156                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   157                                  ; display program name & version
   158                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   159                                  
   160 00000036 BE[A240]                	mov	si, TrDOS_Welcome
   161 00000039 E87019                  	call	print_msg
   162                                  
   163                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   164                                  ; get hard disk name
   165                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   166                                  ; 11/10/2020
   167                                  
   168 0000003C BE8000                  	mov	si, 80h			; PSP command tail
   169 0000003F AC                       	lodsb
   170 00000040 08C0                    	or	al, al 			; command tail length
   171 00000042 7431                    	jz	short A_05		; jump if zero
   172                                  A_01:
   173 00000044 AC                      	lodsb
   174 00000045 3C20                    	cmp	al, ' '			; is it SPACE ?
   175 00000047 74FB                    	je	short A_01
   176 00000049 722A                    	jb	short A_05
   177                                  	
   178                                  	; check disk name
   179                                  
   180 0000004B 3C68                    	cmp	al, 'h'
   181 0000004D 751B                    	jne	short A_03
   182 0000004F 803C64                  	cmp	byte [si], 'd'
   183 00000052 7516                    	jne	short A_03
   184 00000054 46                      	inc	si
   185 00000055 AC                      	lodsb
   186 00000056 3C30                    	cmp	al, '0'
   187 00000058 7406                    	je	short A_02
   188 0000005A 720E                    	jb	short A_03
   189 0000005C 3C33                    	cmp	al, '3'
   190 0000005E 770A                    	ja	short A_03
   191                                  A_02:
   192 00000060 803C20                  	cmp	byte [si], ' '
   193 00000063 720B                    	jb	short A_04
   194 00000065 7703                    	ja	short A_03
   195 00000067 46                      	inc	si
   196 00000068 EBF6                    	jmp	short A_02
   197                                  A_03:
   198 0000006A BE[0341]                	mov	si, TrDOS_Usage
   199 0000006D E90207                  	jmp	_p_exit
   200                                  A_04:
   201 00000070 0450                    	add	al, 80h - '0'
   202 00000072 A2[2A65]                	mov	[DrvNum], al	; 80h .. 83h
   203                                  
   204                                  A_05:
   205                                  
   206                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   207                                  ; get hard disk parameters 
   208                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   209                                  ; 11/10/2020
   210                                  
   211                                  	; check bios int 13h extensions
   212 00000075 B441                    	mov	ah, 41h
   213 00000077 BBAA55                  	mov	bx, 55AAh
   214 0000007A B280                    	mov	dl, 80h
   215 0000007C CD13                    	int	13h
   216 0000007E 720B                    	jc	short A_06
   217 00000080 81FB55AA                	cmp	bx, 0AA55h
   218 00000084 7505                    	jne	short A_06
   219                                  
   220 00000086 C606[8B2E]01            	mov	byte [int13h_x], 1
   221                                  A_06:
   222                                  	;mov	dl, 80h	 ; hd0
   223 0000008B B408                    	mov	ah, 08h  ; return disk parameters
   224 0000008D CD13                    	int	13h	
   225 0000008F 7313                    	jnc	short A_10
   226                                  A_07:
   227 00000091 803E[2A65]80            	cmp 	byte [DrvNum], 80h  ; hard disk name option ?
   228 00000096 7206                    	jb	short A_09 ; no, default
   229                                  A_08:
   230 00000098 BE[B260]                	mov	si, msg_drv_not_ready ; drive not ready
   231 0000009B E9D406                  	jmp	_p_exit
   232                                  A_09:
   233 0000009E BE[DC60]                	mov	si, msg_not_any_disks ; there is not a hard disk
   234 000000A1 E9CE06                  	jmp	_p_exit
   235                                  A_10:
   236 000000A4 08E4                    	or	ah, ah	 ; ah = 0 ?
   237 000000A6 75E9                    	jnz	short A_07  ; no, there is an error !
   238                                  	
   239 000000A8 8816[2B65]              	mov	[hdc], dl ; number of hard disks
   240                                  
   241 000000AC A0[2A65]                	mov	al, [DrvNum]
   242                                  
   243 000000AF 3C80                    	cmp	al, 80h
   244 000000B1 7308                    	jnb	short A_11 ; option
   245                                  	; default
   246 000000B3 C606[2A65]80            	mov	byte [DrvNum], 80h
   247 000000B8 E98D00                  	jmp	A_14
   248                                  A_11:
   249                                  	; hard disk name option
   250 000000BB 80C27F                  	add	dl, 7Fh
   251                                  
   252 000000BE 38D0                    	cmp	al, dl
   253 000000C0 77D6                    	ja	short A_08
   254                                  
   255 000000C2 80FA80                  	cmp	dl, 80h
   256 000000C5 760C                    	jna	short A_13 ; hd0 parameters are ready 
   257                                  A_12:
   258 000000C7 88C2                    	mov	dl, al ; [DrvNum]
   259                                  
   260 000000C9 B408                    	mov	ah, 08h  ; return (get) disk parameters
   261 000000CB CD13                    	int	13h	
   262 000000CD 72C2                    	jc	short A_07
   263 000000CF 08E4                    	or	ah, ah
   264 000000D1 75BE                    	jnz	short A_07
   265                                  A_13:
   266 000000D3 88C8                    	mov	al, cl
   267 000000D5 243F                    	and	al, 3Fh ; 63
   268 000000D7 C0E906                  	shr	cl, 6
   269 000000DA 86E9                    	xchg	ch, cl
   270 000000DC 41                      	inc	cx
   271 000000DD 41                      	inc	cx ; 15/10/2020 ; BIOS BugFix
   272                                  				; (for reserved last cylinder)
   273 000000DE 890E[A23C]              	mov	[cylinders], cx
   274                                  	;mov	word [cylinders+2], 0 ; 16/10/2020
   275 000000E2 FEC6                    	inc	dh
   276 000000E4 8836[A03C]              	mov	[heads], dh
   277 000000E8 A2[9E3C]                	mov	[sectors], al
   278 000000EB F6E6                    	mul	dh
   279 000000ED A3[EC69]                	mov	[hs], ax ; heads*sectors ; 15/10/2020
   280 000000F0 F7E1                    	mul	cx
   281 000000F2 A3[2E65]                	mov	[disksize], ax
   282 000000F5 8916[3065]              	mov	[disksize+2], dx
   283 000000F9 83E801                  	sub	ax, 1	; 17/10/2020
   284 000000FC 83DA00                  	sbb	dx, 0
   285 000000FF A3[3265]                	mov	[chs_limit], ax
   286 00000102 8916[3465]              	mov	[chs_limit+2], dx
   287                                  
   288 00000106 803E[8B2E]01            	cmp	byte [int13h_x], 1
   289 0000010B 0F82D500                	jb	A_20
   290                                  
   291 0000010F BE[C66D]                	mov	si, gdp_buffer
   292                                  	;mov	word [si], 30 ; buffer length (minimum)
   293 00000112 C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   294 00000116 B448                    	mov	ah, 48h
   295 00000118 8A16[2A65]              	mov	dl, [DrvNum]
   296 0000011C CD13                    	int	13h
   297 0000011E 0F82C200                	jc	A_20
   298 00000122 20E4                    	and	ah, ah
   299 00000124 0F85BC00                	jnz	A_20
   300                                  
   301                                  	; 06/11/2020
   302                                  	; number of physical sectors
   303                                  	;mov	ax, [si+16]
   304                                  	;mov	dx, [si+18]
   305                                  	;mov	[disksize], ax
   306                                  	;mov	[disksize+2], dx
   307                                  	
   308 00000128 668B4410                	mov	eax, [si+16]
   309 0000012C 66A3[2E65]              	mov	[disksize], eax
   310 00000130 6631D2                  	xor	edx, edx
   311                                  
   312                                  	; 15/10/2020
   313                                  	;mov	cx, [hs]
   314                                  	;call	div32
   315                                  	;; 16/10/2020
   316                                  	;;mov	[lba_cyls], ax
   317                                  	;;mov	[lba_cyls+2], dx
   318                                  	;mov	[cylinders], ax
   319                                  	;mov	[cylinders+2], dx
   320                                  	;mov	[lba_chs_remain], bx
   321                                  
   322                                  	; 06/11/2020
   323 00000133 66F736[EC69]            	div 	dword [hs]
   324 00000138 66A3[A23C]              	mov	[cylinders], eax
   325 0000013C 8916[3665]              	mov	[lba_chs_remain], dx
   326                                  	; reset
   327 00000140 6631C0                  	xor	eax, eax
   328                                  	;xor	edx, edx
   329 00000143 31D2                    	xor	dx, dx
   330                                  
   331 00000145 E99C00                  	jmp	A_20
   332                                  A_14:
   333 00000148 80FA01                  	cmp	dl, 1
   334 0000014B 7686                    	jna	short A_13 ; [DrvNum] = 80h
   335                                  
   336 0000014D 80C230                  	add	dl, '0' ; '2' to '4'
   337 00000150 8816[C841]              	mov	byte [TrDOS_dnmax], dl
   338                                  
   339 00000154 BE[AA41]                	mov	si, TrDOS_Options
   340 00000157 E85218                  	call	print_msg
   341                                  
   342                                  	; check bios int 13h extensions
   343 0000015A 803E[8B2E]01            	cmp	byte [int13h_x], 1
   344 0000015F 732D                    	jnb	short A_16
   345                                  A_15:
   346 00000161 8A16[2A65]              	mov	dl, [DrvNum]
   347 00000165 B408                    	mov	ah, 08h  ; return disk parameters
   348 00000167 CD13                    	int	13h	
   349 00000169 724D                    	jc	short A_17
   350 0000016B 08E4                    	or	ah, ah
   351 0000016D 7549                    	jnz	short A_17
   352                                  
   353 0000016F 88C8                    	mov	al, cl
   354 00000171 243F                    	and	al, 3Fh ; 63
   355 00000173 C0E906                  	shr	cl, 6
   356 00000176 86E9                    	xchg	ch, cl
   357 00000178 41                      	inc	cx
   358 00000179 FEC6                    	inc	dh
   359 0000017B F6E6                    	mul	dh
   360 0000017D F7E1                    	mul	cx
   361                                  
   362                                  	; dx:ax = disk size
   363                                  
   364 0000017F E85602                  	call	display_hd_row
   365                                  
   366 00000182 FE0E[2B65]              	dec	byte [hdc]
   367 00000186 7430                    	jz	short A_17
   368 00000188 FE06[2A65]              	inc	byte [DrvNum]
   369 0000018C EBD3                    	jmp	short A_15
   370                                  A_16:
   371 0000018E BE[C66D]                	mov	si, gdp_buffer
   372                                  	;mov	word [si], 30 ; buffer length (minimum)
   373 00000191 C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   374 00000195 B448                    	mov	ah, 48h
   375 00000197 8A16[2A65]              	mov	dl, [DrvNum]
   376 0000019B CD13                    	int	13h
   377 0000019D 72C2                    	jc	short A_15
   378 0000019F 20E4                    	and	ah, ah
   379 000001A1 75BE                    	jnz	short A_15
   380                                  
   381                                  	; number of phsical sectors
   382 000001A3 8B4410                  	mov	ax, [si+16]
   383 000001A6 8B5412                  	mov	dx, [si+18]
   384                                  
   385                                  	; dx:ax = disk size
   386                                  
   387 000001A9 E82C02                  	call	display_hd_row
   388                                  
   389 000001AC FE0E[2B65]              	dec	byte [hdc]
   390 000001B0 7406                    	jz	short A_17
   391 000001B2 FE06[2A65]              	inc	byte [DrvNum]
   392 000001B6 EBD6                    	jmp	short A_16
   393                                  A_17:
   394 000001B8 BE[5852]                	mov	si, CRLF
   395 000001BB E8EE17                  	call	print_msg
   396                                  
   397                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   398                                  ; hard disk number input (getchar)
   399                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   400                                  ; 11/10/2020
   401                                  	
   402                                  A_18:
   403 000001BE 31C0                    	xor	ax, ax
   404 000001C0 CD16                    	int	16h			; wait for keyboard command
   405                                  
   406 000001C2 83F800                  	cmp	ax, 0			; CTRL+BREAK
   407 000001C5 761A                    	jna	short A_19
   408                                  
   409 000001C7 3C03                    	cmp	al, 'C'-40h		; 3
   410 000001C9 7416                    	je	short A_19             	; CTRL+C
   411 000001CB 3C1B                    	cmp	al, 27			; ESCape
   412 000001CD 7412                    	je	short A_19
   413                                  
   414 000001CF 3C31                    	cmp	al, '1'			; "(1) hd0" 
   415 000001D1 72EB                    	jb	short A_18		; retry
   416 000001D3 3A06[C841]              	cmp	al, [TrDOS_dnmax]	; ('2' to '4')
   417 000001D7 77E5                    	ja	short A_18		; retry
   418 000001D9 044F                    	add	al, 80h-'1'		; bios disk num (80h-83h)
   419 000001DB A2[2A65]                	mov	[DrvNum], al
   420 000001DE E9E6FE                  	jmp	A_12			; get disk parameters
   421                                  A_19:
   422 000001E1 E99105                  	jmp	_exit			; Exit
   423                                  
   424                                  A_20:
   425                                  
   426                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   427                                  ; read masterboot sector
   428                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   429                                  ; 12/10/2020
   430                                  
   431 000001E4 BB[D452]                	mov	bx, MasterBootBuff
   432 000001E7 B90100                  	mov	cx, 1	; cylinder = 0
   433                                  			; sector = 1
   434 000001EA B600                    	mov	dh, 0	; head = 0
   435 000001EC 8A16[2A65]              	mov	dl, [DrvNum]
   436 000001F0 B80102                  	mov	ax, 0201h ; read one sector
   437 000001F3 CD13                    	int	13h
   438 000001F5 7306                    	jnc	short A_21
   439                                  
   440 000001F7 BE[B260]                	mov	si, msg_drv_not_ready ; drive not ready
   441 000001FA E98000                  	jmp	A_26
   442                                  A_21:
   443                                  
   444                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   445                                  ; display CHS values and disk size (LBA) and partition table
   446                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   447                                  ; 12/10/2020
   448                                  
   449 000001FD B80300                  	mov	ax, 3  ; clear screen
   450 00000200 CD10                    	int	10h
   451                                  
   452 00000202 E8CD1E                  	call	init_partition_table ; 13/10/2020
   453                                  
   454 00000205 E82119                  	call	display_chs_table
   455                                  
   456 00000208 A1[2E65]                	mov	ax, [disksize]
   457 0000020B 8B16[3065]              	mov	dx, [disksize+2]
   458                                  
   459 0000020F 81FA0001                	cmp	dx, 256 ; >= 8GB
   460 00000213 7315                    	jnb	short A_22
   461                                  
   462                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   463                                  	;div	cx
   464                                  
   465                                  	; shift dx:ax to 8 bits right (/256)
   466 00000215 88E0                    	mov	al, ah
   467 00000217 88D4                    	mov	ah, dl
   468 00000219 C1E803                  	shr	ax, 3 ; /8 
   469                                  		; result = (dx:ax)/2048
   470                                  
   471                                  	; ax =  0 to 8191
   472                                  
   473 0000021C C606[FE41]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   474 00000221 EB11                    	jmp	short A_23
   475                                  
   476                                  
   477                                  A_29:	; 16/10/2020
   478 00000223 E84125                  	call	partition_table_fix
   479 00000226 73D5                    	jnc	short A_21
   480                                  
   481 00000228 CD20                    	int	20h
   482                                  ;here:	
   483                                  	;jmp	short here
   484                                  
   485                                  A_22:
   486                                  	; 1024 MB = 1GB (2097152 sectors)
   487                                  	; DX/32 --> GB
   488 0000022A 89D0                    	mov	ax, dx
   489 0000022C C1E805                  	shr	ax, 5 ; /32
   490                                  
   491                                  	; ax = 8 to 2047
   492 0000022F C606[FE41]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   493                                  A_23:
   494                                  	;xor	dx, dx
   495 00000234 BE[0442]                	mov	si, TrDOS_hdrow_capacity
   496 00000237 E8DD01                  	call	convert_to_decimal
   497                                  
   498 0000023A BE[0B42]                	mov	si, TrDOS_disksize
   499 0000023D E86C17                  	call	print_msg
   500                                  
   501 00000240 BE[0442]                	mov	si, TrDOS_hdrow_capacity
   502 00000243 E86617                  	call	print_msg
   503                                  
   504 00000246 BE[FE41]                	mov	si, TrDOS_hdrow_unit
   505 00000249 E86017                  	call	print_msg
   506                                  
   507                                  	; 05/11/2020
   508                                  	; fdisk4 can be used for 2TB hard disks 
   509                                  	;	(because of 32 bit virtual cylinder number)
   510                                   	; (fdisk3 limit is 502GB disks size and 65535 cylinders)
   511                                  
   512                                  	;; 16/10/2020
   513                                  	;;cmp	word [lba_cyls+2], 0
   514                                  	;cmp	word [cylinders+2], 0
   515                                  	;ja	short A_27  ; Huge disk ! number of (lba) cylinders > 65335
   516                                  	;		    ; Current FDISK version (v3) can not be used !
   517                                  
   518 0000024C BE[5852]                	mov	si, CRLF
   519 0000024F E85A17                  	call	print_msg
   520                                  
   521 00000252 E86923                  	call	dpt_1
   522                                  
   523 00000255 BE[5852]                	mov	si, CRLF
   524 00000258 E85117                  	call	print_msg
   525                                  
   526                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   527                                  ; display edit or exit option, getchar
   528                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   529                                  
   530 0000025B BE[8750]                	mov	si, msg_edit_or_exit
   531 0000025E E84B17                  	call	print_msg
   532                                  A_24:
   533 00000261 30E4                    	xor	ah, ah
   534 00000263 CD16                    	int	16h
   535                                  
   536 00000265 3C0D                    	cmp	al, 13 ; CR (ENTER) key
   537 00000267 7419                    	je	short A_28 
   538                                  
   539 00000269 3C1B                    	cmp	al, 27 ; ESCape key
   540 0000026B 740D                    	je	short A_25
   541                                  
   542 0000026D 3C20                    	cmp	al, 32 ; SPACE key
   543 0000026F 7411                    	je	short A_28
   544                                  
   545 00000271 3C03                    	cmp	al, 3 ; CTRL+C
   546 00000273 7405                    	je	short A_25
   547                                  
   548 00000275 83F800                  	cmp	ax, 0 ; CTRL+BREAK
   549 00000278 77E7                    	ja	short A_24
   550                                  A_25:
   551 0000027A BE[5852]                	mov	si, CRLF
   552                                  A_26:
   553 0000027D E82C17                  	call	print_msg
   554                                  
   555 00000280 CD20                    	int	20h
   556                                  ;here:
   557                                  ;	jmp	short here
   558                                  
   559                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   560                                  ; display fdisk program disk capacity limit message and then exit
   561                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   562                                  	; 05/11/2020 
   563                                  	; (fdisk4 is proper for -upto- 2TB hard disks)
   564                                  ;A_27:
   565                                  	;; 16/10/2020
   566                                  	;; 15/10/2020
   567                                  	;; Display FDISK (v3) capacity limit (error) message
   568                                  	;
   569                                  	;mov	ax, 65535
   570                                  	;mul	word [hs]
   571                                  	;	; 1024 MB = 1GB (2097152 sectors)
   572                                  	;; DX/32 --> GB 
   573                                  	;mov	ax, dx
   574                                  	;shr	ax, 5 ; /32
   575                                  	;
   576                                  	;; ax = 8 to 2047
   577                                  	;mov	byte [TrDOS_hdrow_unit], 'G'
   578                                  	;mov	byte [TrDOS_hdrow_unit+1], 'B'
   579                                  	;mov	byte [TrDOS_hdrow_unit+2], '.'
   580                                  	;
   581                                  	;;xor	dx, dx
   582                                  	;mov	si, TrDOS_hdrow_capacity
   583                                  	;call	convert_to_decimal
   584                                  	;
   585                                  	;mov	si, msg_fdisk_capacity_err
   586                                  	;call 	print_msg
   587                                  	;
   588                                  	;mov	si, TrDOS_hdrow_capacity
   589                                  	;call	print_msg
   590                                  	;
   591                                  	;mov	si, TrDOS_hdrow_unit
   592                                  	;call	print_msg
   593                                  	;	
   594                                  	;jmp	_exit
   595                                  
   596                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   597                                  ; check defective pte and then init extended partition table(s)
   598                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   599                                  
   600                                  A_28:
   601 00000282 E8AF01                  	call	check_defective_partition
   602 00000285 729C                    	jc	A_29 ; ds:si -> defective pte
   603                                  
   604                                  	; 17/10/2020
   605                                  	; 26/02/2019
   606 00000287 803E[CD6C]00            	cmp	byte [epnumber], 0
   607 0000028C 7603                    	jna	short A_30
   608                                  
   609 0000028E E8752A                  	call	init_ext_partition_table
   610                                  A_30:
   611                                  	; 17/10/2020
   612                                  	; 04/02/2019
   613                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   614                                  	; 12/03/2021
   615                                  	;xor	eax, eax
   616 00000291 E81123                  	call	display_partition_table
   617                                  
   618                                  	; 17/10/2020
   619 00000294 803E[CA6C]00            	cmp	byte [pcount], 0
   620 00000299 0F86E300                	jna	A_38 ; empty partition table
   621                                  
   622                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   623                                  ; check CHS parms against start sector address and partition size 
   624                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   625                                  
   626                                  A_31:
   627                                  	; Check disk parameters with current CHS settings
   628 0000029D 31DB                    	xor	bx, bx
   629 0000029F 31C9                    	xor	cx, cx
   630                                  A_32:
   631                                  	; 17/10/2020
   632 000002A1 80BF[796C]00            	cmp	byte [part_table_sys_id+bx], 0
   633 000002A6 7670                    	jna	short A_33
   634                                  
   635                                  	; 27/10/2020
   636                                  	;mov	ax, [sectors]
   637                                  	;mul	word [heads]
   638                                  	; dx = 0, ax = heads*sectors
   639                                  
   640                                  	; 06/11/2020
   641                                  	;mov	dx, [part_table_start_cyl+bx]
   642 000002A8 668B87[756C]            	mov	eax, [part_table_start_cyl+bx] ; 10/03/2021
   643                                  	; 27/10/2020
   644                                  	;cmp	ax, 1023 ; fixed cylinder number (> 1023)
   645                                  			 ; (partition's start sector is used for fixing)
   646 000002AD 663DFF030000            	cmp	eax, 1023 ; 06/11/2020 
   647 000002B3 7763                    	ja	short A_33 ; no need to check CHS parms here
   648                                  			; (also, CHS to LBA calculation is not applicable)
   649                                  	;mov	dx, [hs] ; heads*sectors
   650                                  	;
   651                                  	;mul	dx
   652                                  	;	; dx:ax = cylinder*heads*spt
   653                                  	
   654                                  	; 10/03/2021
   655 000002B5 66F726[EC69]            	mul	dword [hs]
   656 000002BA 6689C6                  	mov	esi, eax
   657                                  
   658                                  	;mov	si, ax
   659                                  	;mov	di, dx
   660                                  
   661 000002BD 6631C0                  	xor	eax, eax
   662 000002C0 8A87[736C]              	mov	al, [part_table_start_head+bx]
   663 000002C4 F626[9E3C]              	mul	byte [sectors]
   664                                  	;add	si, ax
   665                                  	;adc	di, 0
   666                                  		; di:si = (cylinder*heads*spt) + head*spt
   667                                  	; 10/03/2021
   668 000002C8 6601C6                  	add	esi, eax
   669                                  
   670 000002CB 8A87[746C]              	mov	al, [part_table_start_sector+bx]
   671 000002CF 30E4                    	xor	ah, ah
   672 000002D1 FEC8                    	dec	al ; 1 -> 0
   673                                  	;add	si, ax
   674                                  	;adc	di, 0
   675                                  		; di:si = (cylinder*heads*spt) + head*spt + sector - 1
   676                                  		; (start sector as converted to LBA)
   677                                  
   678                                  	; 10/03/2021
   679 000002D3 6601F0                  	add	eax, esi
   680                                  	;xor	esi, esi
   681                                  
   682                                  	; 07/11/2020
   683                                  	;;cmp	di, [part_table_rel_sec_hw+bx]
   684                                  	;cmp	di, [bx+part_table_rel_sec+2]
   685                                  	;jne	short A_34 ; Invalid !
   686                                  
   687                                  	;;cmp	si, [part_table_rel_sec_lw+bx]
   688                                  	;cmp	si, [bx+part_table_rel_sec]
   689                                  	;jne	short A_34 ; Invalid !
   690                                  		; di:si = partition's start sector (LBA)
   691                                  
   692 000002D6 663B87[806C]            	cmp	eax, [part_table_rel_sec+bx]
   693 000002DB 7548                    	jne	short A_34 ; Invalid ! 
   694                                  
   695                                  	; 27/10/2020
   696                                  	;mov	ax, [sectors]
   697                                  	;mul	word [heads]
   698                                  	; dx = 0, ax = heads*sectors
   699                                  
   700                                  	; 10/03/2021
   701 000002DD 668B87[7C6C]            	mov	eax, [part_table_end_cyl+bx]
   702 000002E2 663DFF030000            	cmp	eax, 1023
   703                                  	; 27/10/2020
   704                                  	;cmp	ax, 1023 ; fixed cylinder number (> 1023)
   705                                  			 ; (partition's end sector is used for fixing)
   706 000002E8 772E                    	ja	short A_33 ; no need to check CHS parms here
   707                                  			; (also, CHS to LBA calculation is not applicable)
   708                                  	;mov	ax, [hs] ; heads*sectors
   709                                  	;
   710                                  	;mul	dx
   711                                  	;	; dx:ax = cylinder*heads*spt
   712                                  	;mov	si, ax
   713                                  	;mov	di, dx
   714                                  	
   715 000002EA 66F726[EC69]            	mul	dword [hs]
   716 000002EF 6689C6                  	mov	esi, eax 
   717                                  	
   718 000002F2 6631C0                  	xor	eax, eax
   719 000002F5 8A87[7A6C]              	mov	al, [part_table_end_head+bx]
   720 000002F9 F626[9E3C]              	mul	byte [sectors]
   721                                  	;add	si, ax
   722                                  	;adc	di, 0
   723                                  		; di:si = (cylinder*heads*spt) + head*spt
   724                                  	; 10/03/2021
   725 000002FD 6601C6                  	add	esi, eax
   726                                  
   727 00000300 8A87[7B6C]              	mov	al, [part_table_end_sector+bx]
   728 00000304 30E4                    	xor	ah, ah
   729                                  	;dec	al ; 63 -> 62
   730                                  	;add	si, ax
   731                                  	;adc	di, 0
   732                                  		; di:si = (cylinder*heads*spt) + head*spt + sector
   733                                  		; (end sector + 1 as converted to LBA)
   734                                  	; 10/03/2021
   735 00000306 6601C6                  	add	esi, eax
   736                                  
   737                                  	;mov	ax, [part_table_num_sec_lw+bx]
   738                                  	;mov	dx, [part_table_num_sec_hw+bx]
   739                                  	;
   740                                  	;add	ax, [part_table_rel_sec_lw+bx]
   741                                  	;adc	dx, [part_table_rel_sec_hw+bx]
   742                                  	;	; dx:ax = partition's end sector (LBA) + 1
   743                                  
   744                                  	; 10/03/2021
   745 00000309 668B87[846C]            	mov	eax, [part_table_num_sec+bx]
   746 0000030E 660387[806C]            	add	eax, [part_table_rel_sec+bx]
   747                                  
   748 00000313 6639C6                  	cmp	esi, eax
   749 00000316 750D                    	jne	short A_34 ; Invalid !
   750                                  
   751                                  	;cmp	ax, si
   752                                  	;jne	short A_34 ; Invalid !
   753                                  
   754                                  	;cmp	dx, di
   755                                  	;jne	short A_34 ; Invalid !
   756                                  A_33:
   757 00000318 FEC1                    	inc	cl
   758                                  
   759 0000031A 80F904                  	cmp	cl, 4
   760 0000031D 7311                    	jnb	short A_35
   761                                  
   762                                  	;add	bx, 18 ; partition table structure size
   763                                  	; 05/11/2020
   764 0000031F 83C316                  	add	bx, 22 ; partition table structure size	
   765                                  
   766 00000322 E97CFF                  	jmp	A_32
   767                                  A_34:
   768                                  	;mov	si, msg_defective_pt
   769                                  	; 10/03/2021
   770 00000325 66BE[EB5B0000]          	mov	esi, msg_defective_pt
   771 0000032B E87E16                  	call	print_msg
   772 0000032E EB50                    	jmp	short A_38
   773                                  
   774                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   775                                  ; sort MBR partitions
   776                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   777                                  
   778                                  A_35:
   779                                  	; 10/03/2021
   780 00000330 6631F6                  	xor	esi, esi
   781                                  	; 06/11/2020
   782 00000333 6631D2                  	xor	edx, edx
   783                                  
   784                                  	; LBA and CHS values of all partitions are OK (here)
   785                                  
   786                                  	; sort MBR (primary) partitions
   787                                  
   788 00000336 E8541F                  	call	sort_partition_table
   789                                  
   790                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   791                                  ; Check partition (start, size) overlaps after sorting 
   792                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   793                                  
   794                                  	; Checking partition overlaps (via start and end cylinders)
   795                                  
   796 00000339 31DB                    	xor	bx, bx
   797                                  	;mov	dx, 18
   798                                  	; 05/11/2020
   799 0000033B BA1600                  	mov	dx, 22
   800                                  A_36:
   801 0000033E FEC3                    	inc	bl
   802                                  
   803 00000340 8A87[026A]              	mov	al, [bx+sort]
   804 00000344 F6E2                    	mul	dl
   805 00000346 89C6                    	mov	si, ax	; current
   806                                  
   807 00000348 80BC[796C]00            	cmp	byte [part_table_sys_id+si], 0
   808 0000034D 762C                    	jna	short A_37
   809                                  
   810 0000034F 8A87[016A]              	mov	al, [bx+sort-1]
   811 00000353 F6E2                    	mul	dl
   812 00000355 89C7                    	mov	di, ax  ; previous
   813                                  
   814                                  	;mov	ax, [part_table_end_cyl+di]
   815                                  	;cmp	ax, [part_table_start_cyl+si]
   816                                  	;jb	short A_37
   817                                  	; 29/10/2020
   818                                  	;ja	short A_34 ; overlap !
   819                                  	; 10/03/2021
   820 00000357 668B85[7C6C]            	mov	eax, [part_table_end_cyl+di]
   821 0000035C 663B84[756C]            	cmp	eax, [part_table_start_cyl+si]
   822 00000361 7218                    	jb	short A_37
   823 00000363 77C0                    	ja	short A_34 ; overlap !
   824                                  
   825                                  	; 17/10/2020
   826                                  	;and	ax, ax
   827                                  	;jnz	short A_34 ; overlap error (except empty entries)
   828                                  
   829                                  	; 29/10/2020
   830                                  	; same cylinder
   831                                  	; check end-start sectors for overlap
   832                                  
   833                                  	;and	ax, ax
   834                                  	;jz	short A_37 ; empty pt entries
   835                                  			; (previous pte is empty)
   836                                  	; 10/03/2021
   837 00000365 6621C0                  	and	eax, eax
   838 00000368 7411                    	jz	short A_37 ; empty pt entries
   839                                  			; (previous pte is empty)
   840                                  
   841                                  	;mov	ax, [part_table_rel_sec_lw+di] ; previous
   842                                  	;mov	dx, [part_table_rel_sec_hw+di]
   843                                  	;add	ax, [part_table_num_sec_lw+di]
   844                                  	;adc	dx, [part_table_num_sec_hw+di]
   845                                  	;;jc	short A_34
   846                                  	;	 ; dx:ax = end sector + 1
   847                                  	; 10/03/2021	
   848 0000036A 668B85[806C]            	mov	eax, [part_table_rel_sec+di] ; previous
   849 0000036F 660385[846C]            	add	eax, [part_table_num_sec+di]
   850                                  
   851                                  	;cmp	dx, [part_table_rel_sec_hw+si] ; current
   852                                  	;jb	short A_37
   853                                  	;ja	short A_34 ; overlap error !
   854                                  	;cmp	ax, [part_table_rel_sec_lw+si]
   855                                  	;jnb	short A_34 ; overlap error !
   856                                  	; 10/03/2021
   857 00000374 663B84[806C]            	cmp	eax, [part_table_rel_sec+si] ; current
   858 00000379 73AA                    	jnb	short A_34 ; overlap error !
   859                                   A_37:
   860 0000037B 80FB03                  	cmp	bl, 3
   861 0000037E 72BE                    	jb	short A_36
   862                                  
   863                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   864                                  ; display partition table editing options
   865                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   866                                  
   867                                  A_38:
   868 00000380 BE[C256]                	mov	si, mbr_editing_options
   869 00000383 E82616                  	call	print_msg
   870                                  
   871 00000386 BE[7057]                	mov	si, enter_option_number_msg
   872 00000389 E82016                  	call	print_msg
   873                                  
   874 0000038C 803E[006A]00            	cmp	byte [ldrives], 0
   875 00000391 760C                    	jna	short A_39
   876                                  
   877 00000393 BE[5852]                	mov	si, CRLF
   878 00000396 E81316                  	call	print_msg
   879                                  
   880 00000399 BE[335D]                	mov	si, str_display_ebr_pt
   881 0000039C E80D16                  	call	print_msg
   882                                  A_39:	
   883                                  	;mov	si, CRLF
   884                                  	;call	print_msg
   885                                  
   886                                  A_40:
   887 0000039F 30E4                    	xor	ah, ah
   888 000003A1 CD16                    	int	16h
   889                                  
   890 000003A3 3C30                    	cmp	al, '0'
   891 000003A5 742A                    	je	short A_41
   892                                  
   893 000003A7 3C31                    	cmp	al, '1'
   894 000003A9 0F84A600                	je	create_partition
   895 000003AD 3C32                    	cmp	al, '2'
   896 000003AF 0F842F01                	je	activate_partition
   897 000003B3 3C33                    	cmp	al, '3'
   898 000003B5 0F84C801                	je	delete_partition
   899 000003B9 3C34                    	cmp	al, '4'
   900 000003BB 0F84CB02                	je	write_pt_mbr
   901                                  	
   902 000003BF 3C1B                    	cmp	al, 27 ; ESCape
   903 000003C1 740E                    	je	short A_41
   904                                  
   905                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   906                                  ; display (EPT) logical drives/partitions if 'SPACE' is pressed
   907                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   908                                  
   909                                  	; 28/02/2019
   910 000003C3 803E[006A]00            	cmp	byte [ldrives], 0
   911 000003C8 76D5                    	jna	short A_40
   912                                  
   913 000003CA 3C20                    	cmp	al, 20h ; SPACE
   914 000003CC 75D1                    	jne	short A_40
   915                                  
   916 000003CE E9C923                  	jmp	display_extended_pt
   917                                  
   918                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   919                                  ; exit if ESC key or '0' is pressed
   920                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   921                                  
   922                                  A_41:
   923                                  	; terminate
   924 000003D1 CD20                    	int	20h
   925                                  
   926                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   927                                  ; display partition table again
   928                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   929                                  
   930                                  A_42:
   931                                  	; 24/02/2019
   932                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   933                                  	; 12/03/2021
   934                                  	;xor	eax, eax
   935 000003D3 E8CF21                  	call	display_partition_table
   936 000003D6 EBA8                    	jmp	short A_38
   937                                  
   938                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   939                                  ; display a row for hard disk name, number and capacity 
   940                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   941                                  ; 11/10/2020
   942                                  
   943                                  display_hd_row:
   944                                  	; dx:ax = disk size
   945                                  
   946 000003D8 81FA0001                	cmp	dx, 256 ; >= 8GB
   947 000003DC 730E                    	jnb	short dhdr_1
   948                                  
   949                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   950                                  	;div	cx
   951                                  
   952                                  	; shift dx:ax to 8 bits right (/256)
   953 000003DE 88E0                    	mov	al, ah
   954 000003E0 88D4                    	mov	ah, dl
   955 000003E2 C1E803                  	shr	ax, 3 ; /8 
   956                                  		; result = (dx:ax)/2048
   957                                  
   958                                  	; ax =  0 to 8191
   959                                  
   960 000003E5 C606[FE41]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   961 000003EA EB0A                    	jmp	short dhdr_2
   962                                  	
   963                                  dhdr_1:
   964                                  	; 1024 MB = 1GB (2097152 sectors)
   965                                  	; DX/32 --> GB 
   966 000003EC 89D0                    	mov	ax, dx
   967 000003EE C1E805                  	shr	ax, 5 ; /32
   968                                  
   969                                  	; ax = 8 to 2047
   970 000003F1 C606[FE41]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   971                                  dhdr_2:
   972                                  	;xor	dx, dx
   973 000003F6 BE[0442]                	mov	si, TrDOS_hdrow_capacity
   974 000003F9 E81B00                  	call	convert_to_decimal
   975                                  
   976 000003FC FE06[E941]              	inc	byte [TrDOS_hdrow_n] ; next number for "(#)"
   977                                  	
   978 00000400 BE[E641]                	mov	si, TrDOS_hdrow
   979 00000403 E8A615                  	call	print_msg
   980 00000406 BE[0442]                	mov	si, TrDOS_hdrow_capacity ; db "#### ", 0
   981 00000409 E8A015                  	call	print_msg
   982 0000040C BE[FE41]                	mov	si, TrDOS_hdrow_unit ; "GB" or "MB"
   983 0000040F E89A15                  	call	print_msg
   984                                  
   985 00000412 FE06[EE41]              	inc	byte [TrDOS_hdrow_i] ; next number for "hd#"
   986                                  
   987 00000416 C3                      	retn	
   988                                  
   989                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   990                                  ; convert binary number to decimal character string
   991                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   992                                  ; 11/10/2020
   993                                  
   994                                  convert_to_decimal:
   995                                  	; ax = binary number
   996                                  	; si = decimal string start addr (max. 5 digits + space)
   997 00000417 B90A00                  	mov	cx, 10
   998 0000041A 89E5                    	mov	bp, sp
   999                                  ctd_1:
  1000 0000041C 31D2                    	xor	dx, dx
  1001 0000041E F7F1                    	div	cx
  1002 00000420 52                      	push	dx ; 0 to 9
  1003 00000421 09C0                    	or	ax, ax
  1004 00000423 75F7                    	jnz	short ctd_1
  1005                                  ctd_2:
  1006 00000425 58                      	pop	ax
  1007 00000426 0430                    	add	al, '0'
  1008 00000428 8804                    	mov	[si], al
  1009 0000042A 46                      	inc	si
  1010 0000042B 39E5                    	cmp	bp, sp
  1011 0000042D 77F6                    	ja	short ctd_2
  1012                                  	;mov	byte [si], 20h ; space before size unit char
  1013                                  	;inc	si 
  1014                                  	;mov	byte [si], 0 ; ASCIIZ string terminator (Z)
  1015 0000042F C7042000                	mov	word [si], 20h
  1016 00000433 C3                      	retn
  1017                                  
  1018                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1019                                  ; check defective partition signature 
  1020                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1021                                  ; 16/10/2020
  1022                                  
  1023                                  check_defective_partition:
  1024 00000434 BB[726C]                	mov	bx, part_table_boot_ind
  1025 00000437 31F6                    	xor	si, si 
  1026                                  chk_dp_1:
  1027 00000439 803FFF                  	cmp	byte [bx], 0FFh ; invalid/defective/partition sign
  1028 0000043C 7509                    	jne	short chk_dp_2
  1029 0000043E C1E604                  	shl	si, 4 ; * 16
  1030 00000441 81C6[9254]              	add	si, MasterBootBuff+446
  1031 00000445 F9                      	stc
  1032 00000446 C3                      	retn
  1033                                  chk_dp_2:
  1034                                  	;cmp	bx, part_table_boot_ind+(22*4) ; 05/11/2020
  1035 00000447 83FE03                  	cmp	si, 3
  1036 0000044A 7306                    	jnb	short chk_dp_3
  1037                                  	;add	bx, 18
  1038                                  	; 05/11/2020
  1039 0000044C 83C316                  	add	bx, 22
  1040 0000044F 46                      	inc	si
  1041 00000450 EBE7                    	jmp	short chk_dp_1 
  1042                                  chk_dp_3:
  1043                                  	;sub	si, si
  1044 00000452 C3                      	retn
  1045                                  
  1046                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1047                                  ; create a disk partition (on MBR partition table)
  1048                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1049                                  ; 18/10/2020
  1050                                  
  1051                                  	; 12/03/2021
  1052                                  	; 11/03/2021 (fdisk4.s)
  1053                                  create_partition:
  1054                                  	; 19/10/2020
  1055                                  	; 10/02/2019 (hdimage.s)
  1056 00000453 31C0                    	xor	ax, ax
  1057                                  	;xor	eax, eax ; 12/03/2021
  1058 00000455 A2[C869]                	mov	byte [wholedisk], al ; 0 ; Reset wholedisk flag
  1059                                  
  1060                                  	; 19/10/2020
  1061 00000458 3806[CA6C]              	cmp	byte [pcount], al ; 0 ; number of (valid) partitions
  1062 0000045C 761C                    	jna	short cp_1
  1063                                  ;cp_0:
  1064 0000045E 803E[CA6C]04            	cmp	byte [pcount], 4
  1065 00000463 7318                    	jnb	short cp_2 ; full pt !
  1066                                  
  1067                                  	; al = 0
  1068 00000465 E88D1E                  	call	find_part_free_space
  1069                                  		 ; Following values are for the max. free space on disk
  1070                                  
  1071                                  	;and	cx, cx
  1072                                  	; 12/03/2021
  1073 00000468 6621C9                  	and	ecx, ecx
  1074 0000046B 7421                    	jz	short cp_3 ; there is not free space on disk
  1075                                  
  1076                                  	;mov	[c_cylinders], cx  ; count of free cylinders in the gap
  1077 0000046D 891E[946D]              	mov	[c_fspc_offset], bx  ; offset from beginning of 'fspc:'
  1078                                  	;mov	[c_gap], al ; gap (space index) number of this free space
  1079                                  	;		    ; 0 -> before partition 1 (as PTE)
  1080                                  	;		    ; 1-2-3 -> between partitions 1 to 4
  1081                                  	;		    ; 4 -> after partition 4 (as PTE)
  1082                                  
  1083                                  	; Start to job with non-aligned (full) free sectors of this max. space
  1084                                  	
  1085                                  	;mov	ax, [free_space.sectors_unused+bx]
  1086                                  	;mov	dx, [free_space.sectors_unused+2+bx]
  1087                                  	; 12/03/2021
  1088 00000471 668B87[326D]            	mov	eax, [free_space.sectors_unused+bx]
  1089                                  
  1090                                  	;mov	[pp_Sectors], ax
  1091                                  	;mov	[pp_Sectors+2], dx
  1092                                  	; 12/03/2021
  1093 00000476 66A3[C469]              	mov	[pp_Sectors], eax
  1094                                  cp_1:
  1095 0000047A E9C807                  	jmp	B_01 ; New/Empty disk, create partition menu
  1096                                  ;cp_2:
  1097                                  	; 13/02/2019
  1098                                  	; There is not a free pt entry to create a new partition
  1099                                  
  1100                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1101                                  	; 12/03/2021
  1102                                  	;xor	eax, eax
  1103                                  cp_2:
  1104 0000047D E82521                  	call	display_partition_table
  1105                                  
  1106 00000480 BE[5258]                	mov	si, msg_full_pt
  1107 00000483 E82615                  	call	print_msg
  1108 00000486 BE[7F58]                	mov	si, msg_to_create_new_p
  1109 00000489 E82015                  	call	print_msg
  1110                                  
  1111 0000048C EB64                    	jmp	ap_0
  1112                                  cp_3:
  1113                                  	; 19/10/2020
  1114 0000048E 803E[CD6C]00            	cmp	byte [epnumber], 0
  1115 00000493 7708                    	ja	short create_logical_drives
  1116                                  ;cp_4:
  1117                                  	; 15/02/2019
  1118                                  	; There is not (enough) free space to create a new partition
  1119                                  
  1120 00000495 BE[9D58]                	mov	si, msg_no_free_space
  1121 00000498 E81115                  	call	print_msg
  1122 0000049B EB55                    	jmp	ap_0
  1123                                  
  1124                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1125                                  ; create logical -dos- drives
  1126                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1127                                  ; 19/10/2020
  1128                                  
  1129                                  	; 12/03/2021 (fdisk4.s)
  1130                                  create_logical_drives:
  1131                                  	; 05/03/2019
  1132 0000049D E82126                  	call	check_ext_free_space
  1133 000004A0 7238                    	jc	short cld_5
  1134                                  cld_1:
  1135                                  	; 05/03/2019
  1136 000004A2 803E[006A]04            	cmp	byte [ldrives], 4
  1137 000004A7 7203                    	jb	short cld_2
  1138 000004A9 E95C23                  	jmp	eetc_2
  1139                                  cld_2:
  1140                                  	; 01/11/2020
  1141                                  	;mov	[ep_free_sectors], ax
  1142                                  	;mov	[ep_free_sectors+2], dx
  1143                                  	; 12/03/2021
  1144 000004AC 66A3[B86D]              	mov	[ep_free_sectors], eax
  1145                                  
  1146 000004B0 BE[3660]                	mov	si, msg_c_ldd_q
  1147 000004B3 E8F614                  	call	print_msg
  1148                                  cld_3:	
  1149 000004B6 28E4                    	sub	ah, ah
  1150 000004B8 CD16                    	int	16h
  1151                                  
  1152 000004BA 3C1B                    	cmp	al, 27 ; ESCAPE key
  1153                                  	;je	cp_esc
  1154 000004BC 7419                    	je	short cld_6 ; 19/10/2020
  1155 000004BE 24DF                    	and	al, 0DFh
  1156 000004C0 3C4E                    	cmp	al, 'N'
  1157 000004C2 740D                    	je	short cld_4
  1158 000004C4 3C59                    	cmp	al, 'Y'
  1159 000004C6 75EE                    	jne	short cld_3
  1160 000004C8 BE[9259]                	mov	si, _msg_YES
  1161 000004CB E8DE14                  	call	print_msg
  1162                                  
  1163 000004CE E96723                  	jmp	edit_ext_table_create_x
  1164                                  cld_4:	
  1165 000004D1 BE[9859]                	mov	si, _msg_NO
  1166 000004D4 E8D514                  	call	print_msg
  1167                                  cld_6:
  1168                                  	;jmp	cp_esc
  1169                                  	; 19/10/2020
  1170 000004D7 E9F9FE                  	jmp	A_42
  1171                                  cld_5:	
  1172 000004DA BE[0660]                	mov	si, msg_c_part_error
  1173 000004DD E8CC14                  	call	print_msg
  1174                                  
  1175                                  	; 21/03/2021
  1176                                  	;cmp	byte [ldrives], 3
  1177                                  	;;jna	short cld_2
  1178                                  	; 21/03/2021
  1179                                  	;jna	short ap_0
  1180                                  
  1181                                  	;mov	si, msg_c_ldd_error
  1182                                  	;call	print_msg
  1183                                  
  1184 000004E0 EB10                    	jmp	short ap_0
  1185                                  
  1186                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1187                                  ; set active partition
  1188                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1189                                  ; 19/10/2020 
  1190                                  	
  1191                                  activate_partition:
  1192                                  	; 12/02/2019
  1193                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1194                                  	; 12/03/2021
  1195                                  	;xor	eax, eax
  1196 000004E2 E8C020                  	call	display_partition_table
  1197                                  
  1198 000004E5 803E[CA6C]00            	cmp	byte [pcount], 0
  1199 000004EA 7713                    	ja	short ap_1
  1200                                  
  1201 000004EC BE[0658]                	mov	si, msg_empty_pt
  1202 000004EF E8BA14                  	call	print_msg
  1203                                  ap_0:
  1204 000004F2 BE[B452]                	mov	si, msg_press_any_key
  1205 000004F5 E8B414                  	call	print_msg
  1206                                  
  1207 000004F8 30E4                    	xor	ah, ah
  1208 000004FA CD16                    	int	16h
  1209                                  ap_5:
  1210                                  	;jmp	ap_esc
  1211                                  	; 19/10/2020
  1212 000004FC E9D4FE                  	jmp	A_42
  1213                                  
  1214                                  ap_1:
  1215                                  	; Set valid_ppnums (MBR partition IDs) list
  1216 000004FF BE[9254]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1217 00000502 BB[146C]                	mov	bx, valid_ppnums
  1218 00000505 B104                    	mov	cl, 4
  1219                                  ap_2:
  1220 00000507 8A4404                  	mov	al, [si+ptFileSystemID]
  1221 0000050A 8807                    	mov	[bx], al
  1222 0000050C FEC9                    	dec	cl
  1223 0000050E 7406                    	jz	short ap_3
  1224 00000510 43                      	inc	bx
  1225 00000511 83C610                  	add	si, 16
  1226 00000514 EBF1                    	jmp	short ap_2
  1227                                  ap_3:
  1228 00000516 BE[855A]                	mov	si, msg_enter_pn_to_act
  1229 00000519 E89014                  	call	print_msg
  1230                                  ap_getchar:
  1231 0000051C 30E4                    	xor	ah, ah
  1232 0000051E CD16                    	int	16h
  1233                                  	
  1234                                  	; 19/10/2020
  1235 00000520 3C1B                    	cmp	al, 27
  1236                                  	;je	ap_esc
  1237 00000522 74D8                    	je	short ap_5
  1238                                  
  1239                                  	;cmp	al, '0'
  1240                                  	;;je	ap_esc
  1241                                  	;je	short ap_5
  1242                                  
  1243 00000524 3C31                    	cmp	al, '1'
  1244 00000526 72F4                    	jb	short ap_getchar
  1245 00000528 3C34                    	cmp	al, '4'
  1246 0000052A 77F0                    	ja	short ap_getchar
  1247                                  
  1248 0000052C 30E4                    	xor	ah, ah
  1249 0000052E 89C2                    	mov	dx, ax
  1250                                  	
  1251 00000530 80EA31                  	sub	dl, '1'
  1252 00000533 89D6                    	mov	si, dx
  1253 00000535 38A4[146C]              	cmp	byte [si+valid_ppnums], ah  ; 0
  1254 00000539 76E1                    	jna	short ap_getchar ; Empty partition table entry, it is not shown
  1255                                  
  1256 0000053B BB0700                  	mov	bx, 07h
  1257 0000053E B409                    	mov	ah, 09h
  1258 00000540 B90100                  	mov	cx, 1
  1259 00000543 CD10                    	int	10h
  1260                                  
  1261 00000545 BE[9254]                	mov	si, MasterBootBuff+pTableOffset
  1262 00000548 BF[726C]                	mov	di, part_table_boot_ind ; (**)
  1263                                  
  1264                                  	; Clear all of possible active partition flags
  1265 0000054B 8834                    	mov	[si], dh ; 0
  1266 0000054D 887410                  	mov	[si+16], dh ; 0
  1267 00000550 887420                  	mov	[si+32], dh ; 0
  1268 00000553 887430                  	mov	[si+48], dh ; 0
  1269                                  
  1270                                  	; 09/03/2021
  1271                                  	; This may not be needed !?
  1272                                  	; (**) (Primary partitions structure/list)
  1273 00000556 8835                    	mov	[di], dh ; 0
  1274 00000558 887516                  	mov	[di+22], dh ; 0
  1275 0000055B 88752C                  	mov	[di+44], dh ; 0
  1276 0000055E 887542                  	mov	[di+66], dh ; 0
  1277                                  
  1278 00000561 20D2                    	and 	dl, dl
  1279 00000563 740D                    	jz	short ap_4
  1280                                  
  1281 00000565 89D0                    	mov	ax, dx
  1282                                  
  1283 00000567 C0E004                  	shl	al, 4 ; * 16
  1284 0000056A 01C6                    	add	si, ax
  1285                                  
  1286                                  	;mov	al, 18
  1287                                  	; 05/11/2020
  1288 0000056C B016                    	mov	al, 22
  1289 0000056E F6E2                    	mul	dl ; 1 to 3
  1290 00000570 01C7                    	add	di, ax
  1291                                  ap_4:
  1292                                  	; Then	set active partition as requested by user
  1293 00000572 C60480                  	mov	byte [si], 80h
  1294 00000575 C60580                  	mov	byte [di], 80h ; (**)
  1295                                  
  1296 00000578 BE[5852]                	mov	si, CRLF ; Next line
  1297 0000057B E82E14                  	call	print_msg
  1298                                  
  1299                                  	; NOTE: Only the MBR buffer has been changed
  1300                                  	; (Masterboot sector will not be updated unless/till
  1301                                  	;  MBR partition table -and MBR code- will be written
  1302                                  	;  to disk image as result of 'write part. table' command.)
  1303                                  
  1304                                  	;; wait for 1 second
  1305                                  	;mov	ah, 02h
  1306                                  	;int	1Ah
  1307                                  	;mov	[GetChar], dh
  1308                                  ;ap_wait:
  1309                                  	;mov	ah, 02h
  1310                                  	;int	1Ah
  1311                                  	;cmp	dh, [GetChar]
  1312                                  	;je	short ap_wait
  1313                                  
  1314                                  	; 17/10/2020 
  1315 0000057E E952FE                  	jmp	A_42 ; display partition table again
  1316                                  
  1317                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1318                                  ; delete selected partition
  1319                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1320                                  ; 19/10/2020
  1321                                  
  1322                                  delete_partition:
  1323                                  	; 10/02/2019
  1324                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1325                                  	; 12/03/2021
  1326                                  	;xor	eax, eax
  1327 00000581 E82120                  	call	display_partition_table
  1328                                  
  1329 00000584 803E[CA6C]00            	cmp	byte [pcount], 0
  1330 00000589 7712                    	ja	short dp_1
  1331                                  
  1332 0000058B BE[0658]                	mov	si, msg_empty_pt
  1333 0000058E E81B14                  	call	print_msg
  1334                                  
  1335 00000591 BE[B452]                	mov	si, msg_press_any_key
  1336 00000594 E81514                  	call	print_msg
  1337                                  
  1338 00000597 30E4                    	xor	ah, ah
  1339 00000599 CD16                    	int	16h
  1340                                  
  1341 0000059B EB73                    	jmp	short dp_esc
  1342                                  
  1343                                  dp_1:
  1344                                  	; Set valid_ppnums (MBR partition IDs) list
  1345 0000059D BE[9254]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1346 000005A0 BB[146C]                	mov	bx, valid_ppnums
  1347 000005A3 B104                    	mov	cl, 4
  1348                                  dp_2:
  1349 000005A5 8A4404                  	mov	al, [si+ptFileSystemID]
  1350 000005A8 8807                    	mov	[bx], al
  1351 000005AA FEC9                    	dec	cl
  1352 000005AC 7406                    	jz	short dp_3
  1353 000005AE 43                      	inc	bx
  1354 000005AF 83C610                  	add	si, 16
  1355 000005B2 EBF1                    	jmp	short dp_2
  1356                                  dp_3:
  1357 000005B4 BE[C158]                	mov	si, msg_enter_pn_to_del
  1358 000005B7 E8F213                  	call	print_msg
  1359                                  dp_getchar1:
  1360 000005BA 30E4                    	xor	ah, ah
  1361 000005BC CD16                    	int	16h
  1362                                  	
  1363                                  	; 19/10/2020
  1364 000005BE 3C1B                    	cmp	al, 27
  1365 000005C0 744E                    	je	short dp_esc
  1366 000005C2 3C30                    	cmp	al, '0'
  1367 000005C4 744A                    	je	short dp_esc
  1368                                  	;cmp	al, '1'
  1369 000005C6 72F2                    	jb	short dp_getchar1
  1370 000005C8 3C34                    	cmp	al, '4'
  1371 000005CA 77EE                    	ja	short dp_getchar1
  1372                                  
  1373 000005CC 30FF                    	xor	bh, bh
  1374 000005CE 88C3                    	mov	bl, al
  1375                                  	;dec	bl
  1376 000005D0 80EB31                  	sub	bl, '1'
  1377 000005D3 38BF[146C]              	cmp	byte [bx+valid_ppnums], bh ; 0 ; 12/02/2019
  1378 000005D7 76E1                    	jna	short dp_getchar1  ; Empty partition table entry, it is not shown
  1379                                  	
  1380 000005D9 881E[1E6C]              	mov	[del_part_num], bl ; Selected partition number to be deleted.
  1381 000005DD A2[E558]                	mov	[chr_del_pnum1], al ; Partition number for "Enter ..." text
  1382 000005E0 A2[8759]                	mov	[chr_del_pnum2], al ; Partition number for "Do you want ..." text
  1383                                  
  1384 000005E3 BE[E558]                	mov	si, chr_del_pnum1 ; write partition number (user input)
  1385 000005E6 E8C313                  	call	print_msg
  1386                                  
  1387                                  	;xor	al, al
  1388 000005E9 A2[E558]                	mov	[chr_del_pnum1], al ; 0 ; reset
  1389                                  
  1390 000005EC BE[E958]                	mov	si, msg_delete_partition_q ; question for deleting (with warning)
  1391 000005EF E8BA13                  	call	print_msg
  1392                                  
  1393                                  dp_getchar2:
  1394 000005F2 30E4                    	xor	ah, ah
  1395 000005F4 CD16                    	int	16h
  1396                                  
  1397 000005F6 3C1B                    	cmp	al, 27
  1398 000005F8 7416                    	je	short dp_esc
  1399                                  
  1400 000005FA 24DF                    	and	al, 0DFh
  1401 000005FC 3C59                    	cmp	al, 'Y'
  1402 000005FE 7413                    	je	short dp_yes
  1403 00000600 3C4E                    	cmp	al, 'N'
  1404 00000602 75EE                    	jne	short dp_getchar2
  1405                                  dp_no:
  1406 00000604 BE[9959]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  1407 00000607 E8A213                  	call	print_msg
  1408                                  	
  1409 0000060A BE[5852]                	mov	si, CRLF  ; Next line
  1410 0000060D E89C13                  	call	print_msg
  1411                                  	
  1412                                  	;jmp	short dp_esc
  1413                                  
  1414                                  ;cp_esc:
  1415                                  ;ap_esc:
  1416                                  ;wptmbr_esc:
  1417                                  dp_esc:
  1418                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1419                                  	;call	display_partition_table
  1420                                  	;jmp	A_38 ; 17/10/2020
  1421                                  
  1422                                  	; 19/10/2020
  1423 00000610 E9C0FD                  	jmp	A_42
  1424                                  
  1425                                  dp_yes:
  1426 00000613 BE[9359]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  1427 00000616 E89313                  	call	print_msg
  1428                                  
  1429 00000619 BF[9254]                	mov	di, MasterBootBuff+pTableOffset
  1430 0000061C A0[1E6C]                	mov	al, [del_part_num]
  1431 0000061F 20C0                    	and 	al, al
  1432 00000621 7406                    	jz	short dp_4
  1433 00000623 98                      	cbw
  1434                                  	;xor	ah, ah
  1435 00000624 C0E004                  	shl	al, 4 ; * 16
  1436 00000627 01C7                    	add	di, ax
  1437                                  dp_4:
  1438 00000629 BE[5852]                	mov	si, CRLF ; Next line
  1439 0000062C E87D13                  	call	print_msg
  1440                                  
  1441                                  	; 27/02/2019
  1442 0000062F 807D0405                	cmp	byte [di+ptFileSystemID], 05h ; EXTENDED (CHS)
  1443                                  	;jne	short dp_5
  1444 00000633 7406                    	je	short dp_6
  1445                                  	; 24/10/2020
  1446 00000635 807D040F                	cmp	byte [di+ptFileSystemID], 0Fh ; EXTENDED (LBA)
  1447 00000639 7545                    	jne	short dp_5
  1448                                  dp_6:
  1449 0000063B 3806[006A]              	cmp	byte [ldrives], al ; 0
  1450 0000063F 763F                    	jna	short dp_5
  1451                                  
  1452 00000641 BE[095C]                	mov	si, msg_ext_part_del_error
  1453 00000644 E86513                  	call	print_msg
  1454 00000647 BE[495C]                	mov	si, msg_cancel_continue
  1455 0000064A E85F13                  	call	print_msg
  1456                                       	
  1457 0000064D 30E4                    	xor	ah, ah
  1458 0000064F CD16                    	int	16h
  1459                                  	
  1460 00000651 3C1B                    	cmp	al, 27 ; ESCape
  1461 00000653 74BB                    	je	short dp_esc
  1462                                  
  1463 00000655 E89F27                  	call	delete_logical_drives
  1464                                  	
  1465                                  	; 28/02/2019
  1466 00000658 803E[006A]01            	cmp	byte [ldrives], 1
  1467 0000065D 73B1                    	jnb	short dp_esc
  1468                                  
  1469                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1470                                  	; 12/03/2021
  1471                                  	;xor	eax, eax
  1472 0000065F E8431F                  	call	display_partition_table
  1473                                  
  1474 00000662 BE[DC5C]                	mov	si, msg_delete_ext_part
  1475 00000665 E84413                  	call	print_msg
  1476                                  
  1477                                  dp_ask_again:
  1478 00000668 28E4                    	sub	ah, ah
  1479 0000066A CD16                    	int	16h
  1480                                  
  1481 0000066C 3C1B                    	cmp	al, 27 ; ESCape
  1482 0000066E 74A0                    	je	short dp_esc
  1483                                  
  1484 00000670 3C0D                    	cmp	al, 13 ; ENTER/CR
  1485 00000672 75F4                    	jne	short dp_ask_again
  1486                                  
  1487 00000674 BF[9254]                	mov	di, MasterBootBuff+pTableOffset
  1488 00000677 A0[1E6C]                	mov	al, [del_part_num]
  1489 0000067A 98                      	cbw
  1490 0000067B C0E004                  	shl	al, 4 ; * 16
  1491 0000067E 01C7                    	add	di, ax
  1492                                  dp_5:
  1493 00000680 31C0                    	xor	ax, ax
  1494                                  
  1495                                  	; clear partition table entry in MBR buffer
  1496 00000682 B90800                  	mov	cx, 8
  1497 00000685 F3AB                    	rep	stosw
  1498                                  	
  1499                                  	; NOTE: Only the MBR buffer will be cleared
  1500                                  	; (Masterboot sector will not be updated unless/till
  1501                                  	;  MBR partition table -and MBR code- will be written
  1502                                  	;  to disk image as result of 'write part. table' command.)
  1503                                  
  1504 00000687 E973FB                  	jmp	A_21 ; 17/10/2020
  1505                                   	 
  1506                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1507                                  ; write partition table (and MBR code) onto disk
  1508                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1509                                  ; 18/10/2020
  1510                                  
  1511                                  	; 13/03/2021 (fdisk4.s)	
  1512                                  write_pt_mbr:
  1513                                  	; 18/10/2020 (fdisk3.s)
  1514                                  	; 11/02/2019 (hdimage.s)
  1515                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1516                                  	; 12/03/2021
  1517                                  	;xor	eax, eax
  1518 0000068A E8181F                  	call	display_partition_table
  1519                                  
  1520 0000068D BE[9D59]                	mov	si, msg_write_masterboot_sector
  1521 00000690 E81913                  	call	print_msg
  1522                                  
  1523 00000693 A2[EA69]                	mov	[GetChar], al ; 0
  1524                                  
  1525 00000696 BE[805A]                	mov	si, option_input
  1526 00000699 E81013                  	call	print_msg
  1527                                  
  1528 0000069C B403                    	mov	ah, 3
  1529                                  	;mov	bx, 7
  1530 0000069E CD10                    	int	10h ; Return Cursor Position
  1531                                  	; DL = Column
  1532                                  	
  1533 000006A0 FECA                    	dec	dl ; previous char ; ']'
  1534 000006A2 FECA                    	dec	dl ; previous char ; '[ ]'
  1535                                  
  1536 000006A4 B402                    	mov	ah, 2
  1537                                  	;mov	bx, 7
  1538 000006A6 CD10                    	int	10h ; Set Cursor Position
  1539                                  
  1540                                  	; write char at current cursor position
  1541                                  
  1542 000006A8 B030                    	mov	al, '0' ; Write default char
  1543                                  
  1544                                  	;;mov	bx, 07h
  1545 000006AA B409                    	mov	ah, 09h
  1546 000006AC B90100                  	mov	cx, 1
  1547 000006AF CD10                    	int	10h
  1548                                  
  1549                                  wptmbr_getchar:
  1550 000006B1 30E4                    	xor	ah, ah
  1551 000006B3 CD16                    	int	16h
  1552                                  
  1553 000006B5 3C1B                    	cmp	al, 1Bh ; 27
  1554                                  	;je	wptmbr_esc ; 19/10/2020
  1555 000006B7 0F8418FD                	je	A_42
  1556                                  
  1557 000006BB 3C0D                    	cmp	al, 0Dh ; 13
  1558 000006BD 7414                    	je	short wptmbr_1
  1559                                                  
  1560 000006BF 3C31                    	cmp	al, '1'
  1561 000006C1 72EE                    	jb	short wptmbr_getchar
  1562                                  
  1563 000006C3 3C32                    	cmp	al, '2'
  1564 000006C5 77EA                    	ja 	short wptmbr_getchar
  1565                                  
  1566 000006C7 A2[EA69]                	mov	[GetChar], al
  1567                                  
  1568                                  	;;mov	bx, 07h
  1569 000006CA B409                    	mov	ah, 09h
  1570 000006CC B90100                  	mov	cx, 1
  1571 000006CF CD10                    	int	10h
  1572 000006D1 EBDE                    	jmp	short wptmbr_getchar
  1573                                  
  1574                                  wptmbr_1:
  1575 000006D3 803E[EA69]00            	cmp	byte [GetChar], 0
  1576 000006D8 76D7                    	jna	short wptmbr_getchar
  1577                                  
  1578 000006DA BE[4E5A]                	mov	si, msg_writing_ptable
  1579 000006DD E8CC12                  	call	print_msg
  1580                                  
  1581 000006E0 803E[EA69]32            	cmp	byte [GetChar], '2'
  1582 000006E5 7523                    	jne	short wptmbr_2 ; Do not write Singlix MBR code
  1583                                  
  1584                                  	; Write CHS parameters in Singlix (FS specific) MBR
  1585                                  	
  1586 000006E7 BE[8C2E]                	mov	si, TRDOS386_MASTERBOOT_SECTOR
  1587 000006EA B9DF00                  	mov	cx, 446/2 ; Copy Singlix FS 1 MBR code
  1588                                  			  ; except Partition Table
  1589 000006ED BF[D452]                	mov	di, MasterBootBuff
  1590 000006F0 F3A5                    	rep	movsw
  1591                                  	
  1592                                  	; This (Below) is not needed; because, if MBR magicword
  1593                                  	; would not be 0AA55h, we would not be able to come here!
  1594                                  	;;add	di, 64  ; skip partition table	
  1595                                  	;;mov	ax, 0AA55h
  1596                                  	;;stosw
  1597                                  	;mov 	word [MBIDCode], 0AA55h
  1598                                  
  1599                                  	; 12/02/2019
  1600                                  	; Copy CHS parameters to Singlix MBR (on disk)
  1601                                  	
  1602                                  	; 13/03/2021
  1603                                  	;mov	di, MasterBootBuff+420
  1604 000006F2 BF[7754]                	mov	di, MasterBootBuff+419
  1605                                  	
  1606                                  	; (if disk size > 512 GB, number of cylinders will be > 65535)
  1607 000006F5 A0[A43C]                	mov	al, [cylinders+2]
  1608 000006F8 AA                      	stosb
  1609                                  	;
  1610 000006F9 A1[A23C]                	mov	ax, [cylinders]
  1611 000006FC AB                      	stosw 			; cylinders
  1612 000006FD A1[A03C]                	mov	ax, [heads]
  1613 00000700 AB                      	stosw 			; heads
  1614 00000701 A1[9E3C]                	mov	ax, [sectors]
  1615 00000704 AB                      	stosw 			; sectors
  1616                                  
  1617                                  	; 13/03/2021
  1618                                  	; copy 32 bit disk size (total LBA sectors) to MBR offset 426
  1619 00000705 BE[2E65]                	mov	si, disksize
  1620 00000708 A5                      	movsw
  1621 00000709 A5                      	movsw
  1622                                  
  1623                                  wptmbr_2:
  1624                                  	;xor	ax, ax ; 0
  1625                                  	;xor	dx, dx ; 0
  1626                                  	;; DX_AX = Masterboot Sector = 0
  1627                                  	;mov	bx, MasterBootBuff
  1628                                  	;; ES:BX = Sector Buffer
  1629                                  	;call	write_hd_sector
  1630                                  	;jc	short print_error_code
  1631                                  			; ! display error msg and then exit !
  1632                                  
  1633 0000070A C606[2D65]05            	mov	byte [rcnt], 5  ; retry count
  1634                                  
  1635 0000070F BB[D452]                	mov	bx, MasterBootBuff
  1636                                  
  1637 00000712 B90100                  	mov	cx, 1	; cylinder = 0
  1638                                  			; sector = 1
  1639 00000715 B600                    	mov	dh, 0	; head = 0
  1640 00000717 8A16[2A65]              	mov	dl, [DrvNum]
  1641                                  wptmbr_3:
  1642 0000071B B80103                  	mov	ax, 0301h ; write one sector
  1643 0000071E CD13                    	int	13h	
  1644 00000720 730C                    	jnc     short wptmbr_4
  1645                                               
  1646 00000722 FE0E[2D65]              	dec	byte [rcnt]
  1647 00000726 7431                    	jz	short print_error_code
  1648                                          
  1649 00000728 30E4                    	xor	ah, ah
  1650                                  	;mov	dl, [DrvNum]
  1651 0000072A CD13                    	int	13h	; BIOS Service func (ah) = 0
  1652                                  			; Reset disk system
  1653 0000072C EBED                    	jmp	short wptmbr_3
  1654                                  
  1655                                  wptmbr_4:
  1656 0000072E BE[775A]                	mov	si, _msg_OK
  1657 00000731 E87812                  	call	print_msg
  1658                                  
  1659                                  	; wait for 1 second
  1660 00000734 B402                    	mov	ah, 02h
  1661 00000736 CD1A                    	int	1Ah
  1662 00000738 8836[EA69]              	mov	[GetChar], dh
  1663                                  wptmbr_wait:
  1664 0000073C B402                    	mov	ah, 02h
  1665 0000073E CD1A                    	int	1Ah
  1666 00000740 3A36[EA69]              	cmp	dh, [GetChar]
  1667 00000744 74F6                    	je	short wptmbr_wait
  1668                                  	
  1669 00000746 BE[B452]                	mov	si, msg_press_any_key
  1670 00000749 E86012                  	call	print_msg
  1671                                                  
  1672 0000074C 30E4                    	xor	ah, ah	; "Press any key to continue"
  1673 0000074E CD16                    	int	16h
  1674                                  
  1675 00000750 BE[5852]                	mov	si, CRLF
  1676 00000753 E85612                  	call	print_msg
  1677                                  
  1678                                  	;jmp	wptmbr_esc
  1679                                  	; 19/10/2020
  1680 00000756 E97AFC                  	jmp	A_42
  1681                                  
  1682                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1683                                  ; print error message and exit
  1684                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1685                                  ; 18/10/2020 (fdisk3.s)
  1686                                  	
  1687                                  print_error_code:
  1688                                  	; 25/02/2019 (hdimage.s)
  1689                                  
  1690 00000759 88E0                    	mov	al, ah	; error code
  1691 0000075B E82213                  	call	bin_to_hex
  1692 0000075E A3[6652]                	mov 	[error_code], ax
  1693                                  
  1694 00000761 BE[5852]                	mov	si, CRLF
  1695 00000764 E84512                  	call	print_msg
  1696                                  
  1697 00000767 BE[5B52]                	mov	si, Msg_Error
  1698 0000076A E83F12                  	call	print_msg
  1699                                  	
  1700 0000076D CD20                    	int	20h	; Exit
  1701                                  
  1702                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1703                                  ; exit, print_msg & exit
  1704                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1705                                  ; 19/10/2020
  1706                                  
  1707                                  _crlf_exit:
  1708 0000076F BE[5852]                	mov	si, CRLF
  1709                                  _p_exit:
  1710                                  	; 11/10/2020
  1711 00000772 E83712                  	call	print_msg
  1712                                  _exit:
  1713 00000775 B8004C                  	mov	ax, 4C00h		; terminate
  1714 00000778 CD21                    	int	21h
  1715                                  
  1716                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1717                                  ; display create partition menu & get partition type input
  1718                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1719                                  ; 19/10/2020
  1720                                  
  1721                                  create_partition_input:
  1722                                  	; 15/02/2019
  1723                                  	; clear screen
  1724 0000077A B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1725 0000077D CD10                    	int	10h
  1726                                  	
  1727 0000077F BE[5242]                	mov	si, msg_create_partition_h ; header
  1728 00000782 E82712                  	call	print_msg
  1729 00000785 BE[4743]                	mov	si, msg_create_partition_m ; menu
  1730 00000788 E82112                  	call	print_msg
  1731                                  cpi_1:
  1732 0000078B 30E4                    	xor	ah, ah
  1733 0000078D CD16                    	int	16h
  1734 0000078F 3C1B                    	cmp	al, 27 ; ESC key
  1735 00000791 7445                    	je	short cpi_4  ; 25/02/2019
  1736 00000793 3C30                    	cmp	al, '0'
  1737 00000795 7441                    	je	short cpi_4  ; 25/02/2019
  1738 00000797 72F2                    	jb	short cpi_1
  1739 00000799 3C34                    	cmp	al, '4'
  1740 0000079B 77EE                    	ja	short cpi_1
  1741                                  
  1742 0000079D 30E4                    	xor	ah, ah
  1743 0000079F 2C30                    	sub	al, '0'
  1744                                  
  1745                                  	;mov	[pp_type], al
  1746                                  
  1747                                  	;mov	byte [pp_type_user], 0
  1748                                  
  1749 000007A1 3C01                    	cmp	al, 1 ; DOS partition
  1750 000007A3 7536                    	jne	short cpi_5 ; ah = 0 
  1751                                  			    ; (al = 2 -> singlix, al = 3 -> retro unix)
  1752                                  cpi_2:
  1753                                  	; clear screen
  1754 000007A5 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1755 000007A8 CD10                    	int	10h
  1756                                  	
  1757 000007AA BE[FD44]                	mov	si, msg_create_dos_partition_h ; header
  1758 000007AD E8FC11                  	call	print_msg
  1759 000007B0 BE[D148]                	mov	si, msg_create_dos_partition_m ; menu
  1760 000007B3 E8F611                  	call	print_msg
  1761                                  cpi_3:
  1762 000007B6 30E4                    	xor	ah, ah
  1763 000007B8 CD16                    	int	16h
  1764 000007BA 3C1B                    	cmp	al, 27 ; ESC key
  1765 000007BC 741A                    	je	short cpi_4
  1766 000007BE 3C30                    	cmp	al, '0'
  1767 000007C0 7416                    	je	short cpi_4
  1768 000007C2 72F2                    	jb	short cpi_3
  1769 000007C4 3C33                    	cmp	al, '3'
  1770 000007C6 77EE                    	ja	short cpi_3
  1771                                  	
  1772 000007C8 30E4                    	xor	ah, ah
  1773 000007CA 2C30                    	sub	al, '0'
  1774 000007CC 3C01                    	cmp	al, 1
  1775 000007CE 7424                    	je	short cpi_6  ;	ah = 0 (al = primary dos partition)
  1776                                  
  1777                                  	;mov	byte [pp_type], 5
  1778                                  
  1779 000007D0 3C02                    	cmp	al, 2
  1780 000007D2 7621                    	jna	short cpi_7
  1781                                  
  1782 000007D4 B80600                  	mov	ax, 6	; ah = 0 (al = logical dos drive/partition)
  1783 000007D7 C3                      	retn
  1784                                  
  1785                                  cpi_4:
  1786 000007D8 31C0                    	xor	ax, ax	; ah = 0 (al = 0 -> ESCape/Cancel)
  1787 000007DA C3                      	retn
  1788                                  cpi_5:
  1789 000007DB 3C04                    	cmp	al, 4	 ; option num. for partition type (user) input
  1790 000007DD 7515                    	jne	short cpi_6
  1791                                  
  1792 000007DF E82B16                  	call	partition_type_input
  1793                                  	
  1794                                  	; 29/10/2020
  1795 000007E2 08C0                    	or	al, al
  1796                                  	;jz	short cpi_6 ; invalid (zero) input or ESC key
  1797 000007E4 74F2                    	jz	short cpi_4
  1798                                  
  1799 000007E6 B404                    	mov	ah, 4 ; user/another type partition flag
  1800                                  	; al = Partition ID
  1801 000007E8 50                      	push	ax
  1802 000007E9 BE[B452]                	mov	si, msg_press_any_key 
  1803 000007EC E8BD11                  	call	print_msg
  1804 000007EF 28E4                    	sub	ah, ah
  1805 000007F1 CD16                    	int	16h
  1806 000007F3 58                      	pop	ax
  1807                                  cpi_6:
  1808 000007F4 C3                      	retn
  1809                                  cpi_7:
  1810 000007F5 B80500                  	mov	ax, 5	; ah = 0 (al = extended dos partition)
  1811 000007F8 C3                      	retn
  1812                                  
  1813                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1814                                  ; create primary (dos or non-dos) partition
  1815                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1816                                  ; 19/10/2020 
  1817                                  ;	(This procedure must be called after 'find_part_free_space')
  1818                                  
  1819                                  	; 14/03/2021 (fdisk4.s)
  1820                                  create_primary_partition:  
  1821                                  	; 16/02/2019
  1822                                  
  1823                                  	; INPUT:
  1824                                  	;	none 
  1825                                  	;  (CHS parameters and free space calculation result will be used.) 
  1826                                  	;
  1827                                  	; OUTPUT:
  1828                                  	;	Partition table in MBR buffer will be updated.
  1829                                  	;
  1830                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  1831                                  
  1832                                  	; Create primary dos or non-dos partition,
  1833                                  	; make partition table entry
  1834                                  
  1835                                  	; 19/10/2020
  1836 000007F9 803E[CA6C]00            	cmp	byte [pcount], 0  ; count of (valid) partitions
  1837 000007FE 770B                    	ja	short cpp_0
  1838                                  
  1839                                  	; cylinder = 0, head = 1, sector = 1
  1840                                  	; LBA = (((cylinder*heads)+head)*sectors)+sector-1
  1841                                  
  1842 00000800 BE[9254]                	mov	si, MasterBootBuff+pTableOffset
  1843                                  
  1844                                  	;mov	ax, [sectors] ; LBA = 17 or 63
  1845                                  	; 07/11/2020
  1846 00000803 660FB606[9E3C]          	movzx	eax, byte [sectors]
  1847                                  	;xor	dx, dx
  1848 00000809 EB4F                    	jmp	short cpp_4
  1849                                  cpp_0:
  1850                                  	; 16/02/2019
  1851 0000080B E8431D                  	call	get_first_free_pte
  1852                                  		 ; CX = First free PTE number, 0 to 3 
  1853                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  1854                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  1855                                   	 	 ; SI = PTE address/offset in MBR buffer
  1856                                  
  1857                                  	;mov	si, MasterBootBuff+pTableOffset
  1858                                  	;shl	cl, 4 ; * 16
  1859                                  	;add	si, cx
  1860                                  
  1861                                  	; 18/02/2019
  1862 0000080E 8B3E[946D]              	mov	di, [c_fspc_offset]
  1863                                  	;mov	bx, [di+free_space.start]
  1864                                  	;mov	al, [heads]
  1865                                  	;; 07/11/2020
  1866                                  	;movzx	eax, byte [heads]
  1867                                  	;mul	byte [sectors]
  1868                                  	;;mul	bx
  1869                                  	;	; DX:AX = LBA of start cylinder, head 0, sector 1
  1870                                  	; 14/03/2021
  1871 00000812 66A1[EC69]              	mov	eax, [hs] ; [heads] * [sectors]
  1872                                  	; 07/11/2020
  1873 00000816 668B9D[2A6D]            	mov	ebx, [di+free_space.start]
  1874 0000081B 66F7E3                  	mul	ebx
  1875                                  	;	; EAX =  LBA of start cylinder, head 0, sector 1
  1876                                  	
  1877 0000081E 8A0E[966D]              	mov	cl, [cylinder_boundary]
  1878                                  
  1879                                  	;cmp	cl, 0 ; Default (partition size unit is one of C, G, M)
  1880                                  		      ; boundary alignment is forced as default
  1881                                  	;je	short cpp_4
  1882                                  
  1883                                  	; 20/02/2019
  1884                                  	;and	cl, cl
  1885                                  	;jz 	short cpp_1
  1886                                  
  1887 00000822 80F959                  	cmp	cl, 'Y'
  1888 00000825 7433                    	je	short cpp_4 ; cylinder boundary option (answer) = YES
  1889                                  
  1890 00000827 80F94E                  	cmp	cl, 'N'
  1891 0000082A 7507                    	jne	short cpp_1 ; cylinder boundary option (answer) = YES/NO
  1892                                  
  1893                                  	; cylinder boundary option (answer) = NO 
  1894                                  	;mov	ax, [di+free_space.startsector]
  1895                                  	;mov	dx, [di+free_space.startsector+2]
  1896                                  	; 07/11/2020
  1897 0000082C 668B85[366D]            	mov	eax, [di+free_space.startsector]
  1898 00000831 EB27                    	jmp	short cpp_4
  1899                                  cpp_1:
  1900                                  	;cmp	cl, 27 ; ESCape
  1901                                  	;jne	short cpp_4 ; 'Y'
  1902                                  
  1903                                  	; check	cylinder boundary alignment of the start sector
  1904                                  
  1905                                  	; if start sector is not aligned, end sector must not be aligned
  1906                                  	; (this rule is valid for ESCape key from the user) 
  1907                                  
  1908 00000833 C606[966D]59            	mov	byte [cylinder_boundary], 'Y' ; YES for end sector check
  1909                                  
  1910                                  	;mov	cx, [di+free_space.startsector]
  1911                                  
  1912                                  	;or	bx, bx
  1913                                  
  1914                                  	;mov	bx, [di+free_space.startsector+2]
  1915                                  
  1916                                  	;jnz	short cpp_2 ; start cylinder > 0
  1917                                  
  1918                                  	;and	bx, bx
  1919                                  	;jnz	short cpp_3
  1920                                  
  1921 00000838 668B8D[366D]            	mov	ecx, [di+free_space.startsector]
  1922 0000083D 6609DB                  	or	ebx, ebx
  1923 00000840 750B                    	jnz	short cpp_2 ; start cylinder > 0
  1924                                  
  1925                                  	; 07/11/2020
  1926 00000842 8A1E[9E3C]              	mov	bl, [sectors]
  1927                                  	;cmp	cx, [sectors]
  1928                                  	;je	short cpp_4 ; start sector is as aligned 
  1929 00000846 6639D9                  	cmp	ecx, ebx 
  1930 00000849 740F                    	je	short cpp_4 ; start sector is as aligned 
  1931 0000084B EB05                    	jmp	short cpp_3
  1932                                  cpp_2:
  1933                                  	;cmp	ax, cx
  1934                                  	;jne	short cpp_3
  1935                                  	;cmp	dx, bx
  1936                                  	;je	short cpp_4
  1937                                  	; 07/11/2020
  1938 0000084D 6639C8                  	cmp	eax, ecx
  1939 00000850 7408                    	je	short cpp_4
  1940                                  cpp_3:
  1941                                  	;mov	ax, cx
  1942                                  	;mov	dx, bx
  1943                                  	; 07/11/2020
  1944 00000852 6689C8                  	mov	eax, ecx 
  1945 00000855 C606[966D]4E            	mov	byte [cylinder_boundary], 'N'
  1946                                  cpp_4:
  1947                                  	;mov	[si+ptStartSector], ax
  1948                                  	;mov	[si+ptStartSector+2], dx
  1949                                  	; 07/11/2020
  1950 0000085A 66894408                	mov	[si+ptStartSector], eax
  1951                                  
  1952                                  	; save start sector (for partition formatting procedure)
  1953                                  	;mov	[pp_StartSector], ax
  1954                                  	;mov	[pp_StartSector+2], dx
  1955 0000085E 66A3[C069]              	mov	[pp_StartSector], eax
  1956                                  
  1957                                  	; 14/03/2021
  1958 00000862 668B0E[F869]            	mov	ecx, [ppn_Sectors]
  1959                                  
  1960                                  	; 19/10/2020
  1961 00000867 803E[CA6C]00            	cmp	byte [pcount], 0
  1962 0000086C 7752                    	ja	short cpp_5
  1963                                  
  1964                                  	; 07/11/2020
  1965                                  	;;xor	cx, cx
  1966                                  	;xor	ecx, ecx
  1967                                  	;mov	[si+ptBeginCylinder], cx ; 0
  1968                                  	;inc	cl  ; 1
  1969                                  	;mov	[si+ptBeginSector], cl ; 1
  1970                                  	;mov	[si+ptBeginHead], cl ; 1
  1971                                  	; 14/03/2021
  1972 0000086E C744030000              	mov	word [si+ptBeginCylinder], 0
  1973 00000873 C6440201                	mov	byte [si+ptBeginSector], 1
  1974 00000877 C6440101                	mov	byte [si+ptBeginHead], 1
  1975                                  
  1976                                  	; set active partition flag
  1977                                  	;mov	byte [si+ptBootable], 80h ; bootable/active partition
  1978 0000087B C60480                  	mov	byte [si], 80h ; bootable/active partition
  1979                                  
  1980                                  	; 18/02/2019
  1981                                  
  1982                                  	;;mov	cx, [ppn_Sectors]
  1983                                  	;;mov	bx, [ppn_Sectors+2]
  1984                                  	; 07/11/2020
  1985                                  	;mov	ecx, [ppn_sectors]
  1986                                  
  1987 0000087E 803E[C869]00            	cmp	byte [wholedisk], 0
  1988 00000883 0F864101                	jna	cpp_12
  1989                                  
  1990                                  	; 26/10/2020
  1991                                  	;add	ax, cx
  1992                                  	;adc	dx, bx
  1993                                  	;sub	ax, 1
  1994                                  	;sbb	dx, 0 
  1995                                  	; 07/11/2020
  1996 00000887 6601C8                  	add	eax, ecx
  1997 0000088A 6648                    	dec	eax  ; sub eax, 1
  1998                                  
  1999                                  	; 24/10/2020
  2000                                  	;cmp	dx, [chs_limit+2]
  2001                                  	;jb	short cpp_17
  2002                                  	;ja	short cpp_16
  2003                                  	;cmp	ax, [chs_limit]
  2004                                  	;jna	short cpp_17
  2005                                  	; 07/11/2020
  2006 0000088C 663B06[3265]            	cmp	eax, [chs_limit]
  2007 00000891 760F                    	jna	short cpp_17
  2008                                  cpp_16:
  2009 00000893 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2010 00000897 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2011 0000089B C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2012 0000089F E9BA01                  	jmp	cpp_15
  2013                                  cpp_17:
  2014 000008A2 A0[A03C]                	mov	al, [heads]
  2015 000008A5 FEC8                    	dec	al
  2016 000008A7 884405                  	mov	[si+ptEndHead], al
  2017 000008AA A0[9E3C]                	mov	al, [sectors]
  2018 000008AD 884406                  	mov	[si+ptEndSector], al
  2019 000008B0 A1[A23C]                	mov	ax, [cylinders]
  2020 000008B3 48                      	dec	ax
  2021 000008B4 884407                  	mov	[si+ptEndCylinder], al
  2022 000008B7 C0E406                  	shl	ah, 6
  2023 000008BA 086406                  	or	[si+ptEndSector], ah
  2024                                  
  2025                                  	;jmp	cpp_16
  2026 000008BD E99C01                  	jmp	cpp_15 ; 06/03/2019
  2027                                  cpp_5:
  2028                                  	; 14/03/2021
  2029                                  	; eax = start sector
  2030                                  
  2031                                  	; 18/02/2019
  2032 000008C0 803E[966D]59            	cmp	byte [cylinder_boundary], 'Y'
  2033 000008C5 7535                    	jne	short cpp_7
  2034                                  
  2035 000008C7 30DB                    	xor	bl, bl ; head  = 0
  2036                                  
  2037                                  	; 14/03/2021
  2038                                  	;mov	cx, [di+free_space.start]
  2039 000008C9 668B8D[2A6D]            	mov	ecx, [di+free_space.start]
  2040                                  	; ecx = start cylinder
  2041                                  
  2042                                  	; 06/03/2019
  2043                                  	;or	ax, ax
  2044                                  	;jnz	short cpp_6
  2045                                  
  2046                                  	;and	cx, cx  ; start cylinder = 0 ?
  2047                                  	;jnz	short cpp_6
  2048                                  
  2049                                  	;or	ax, cx
  2050                                  	;;jnz	short cpp_6
  2051                                  	;jz	short cpp_24 ; 31/10/2020
  2052                                  	; 14/03/2021
  2053 000008CE 6609C8                  	or	eax, ecx
  2054 000008D1 7409                    	jz	short cpp_24 ; cyl = 0, sector = 0
  2055                                  
  2056                                  	; 31/10/2020
  2057                                  	;mov	al, [sectors]
  2058                                  	;mul	byte [heads]
  2059                                  	;mul	cx
  2060                                  	;; dx:ax = LBA sector address
  2061                                  	;; bl = head = 0
  2062                                  	;; cx = cylinder number
  2063                                  	; 14/03/2021
  2064 000008D3 66A1[EC69]              	mov	eax, [hs] ; [heads] * [sectors]
  2065 000008D7 66F7E1                  	mul	ecx 	
  2066                                  		; eax = LBA sector address
  2067                                  		; ecx = cylinder number
  2068                                  		; bl = head = 0
  2069                                   
  2070 000008DA EB05                    	jmp	short cpp_6
  2071                                  cpp_24:
  2072                                  	; 14/03/2021
  2073                                  	;mov	ax, [sectors]
  2074 000008DC A0[9E3C]                	mov	al, [sectors]
  2075                                  
  2076                                  	; cylinder 0, head 1, sector 1 (LBA = 17 or 63)
  2077 000008DF FEC3                    	inc	bl  ; head = 1
  2078                                  	; 14/03/2021
  2079                                  	;xor	dx, dx ; 0
  2080                                  cpp_6:
  2081                                  	; 31/10/2020
  2082                                  	;mov	[si+ptStartSector], ax
  2083                                  	;mov	[si+ptStartSector+2], dx
  2084                                  	; 14/03/2021
  2085 000008E1 66894408                	mov	[si+ptStartSector], eax
  2086                                  
  2087                                  	;mov	[pp_StartSector], ax
  2088                                  	;mov	[pp_StartSector+2], dx
  2089                                  	; 14/03/2021
  2090 000008E5 66A3[C069]              	mov	[pp_StartSector], eax
  2091                                  
  2092                                  	;or	cx, cx  ; start cylinder ?
  2093                                  	;jnz	short cpp_25 ; > 0
  2094                                  	; 14/03/2021
  2095 000008E9 6609C9                  	or	ecx, ecx  ; start cylinder ?
  2096 000008EC 7505                    	jnz	short cpp_25 ; > 0
  2097                                  
  2098                                  	;and	bl, bl  ; head = 0 ?
  2099                                  	;jz	short cpp_25
  2100                                  
  2101                                  	; cylinder = 0, head = 1, dx:ax = [sectors]
  2102                                  
  2103                                  	;;sub	[pp_Sectors], ax
  2104                                  	;;sbb	[pp_Sectors+2], cx ; 0
  2105                                  
  2106                                  	;sub	[ppn_Sectors], ax
  2107                                  	;sbb	[ppn_Sectors+2], cx ; 0
  2108                                  	; 14/03/2021
  2109 000008EE 662906[F869]            	sub	[ppn_Sectors], eax
  2110                                  cpp_25:
  2111                                  	; 14/03/2021
  2112                                  	;mov	ax, cx
  2113 000008F3 6689C8                  	mov	eax, ecx
  2114                                  
  2115                                  	; 29/10/2020
  2116 000008F6 C6440201                	mov	byte [si+ptBeginSector], 1 ; sector = 1	
  2117 000008FA EB1E                    	jmp	short cpp_8
  2118                                  cpp_7:
  2119                                  	; 18/02/2019
  2120                                  
  2121                                  	; [wholedisk] = 0
  2122                                  
  2123                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  2124                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  2125                                  	; if it is 65536 sectors.)
  2126                                  	
  2127 000008FC E86E01                  	call	fix_32mb_dos_psize
  2128                                  		; bx:cx = [ppn_sectors] = partition size
  2129                                  		; dx:ax = start sector's LBA
  2130                                  
  2131                                  	;cylinder = LBA / (heads_per_cylinder * sectors_per_track)
  2132                                  	;temp = LBA % (heads_per_cylinder * sectors_per_track)
  2133                                  	;head = temp / sectors_per_track
  2134                                  	;sector = temp % sectors_per_track + 1
  2135                                  	
  2136                                  	; Convert LBA sector address to CHS parameters
  2137                                  	;mov	cx, [sectors]
  2138                                  	;call	div32
  2139                                  	;; BX = Sector number - 1
  2140                                  	;inc	bl ; sector number (1 based)
  2141                                  	;mov	[si+ptBeginSector], bl
  2142                                  	
  2143                                  	; 14/03/2021
  2144                                  	; eax = start sector address (LBA)
  2145                                  
  2146                                  	; 07/11/2020
  2147 000008FF 6629D2                  	sub	edx, edx ; 14/03/2021
  2148                                  	;movzx	ecx, byte [sectors]
  2149 00000902 6631C9                  	xor	ecx, ecx
  2150 00000905 8A0E[9E3C]              	mov	cl, [sectors]
  2151 00000909 66F7F1                  	div	ecx
  2152 0000090C FEC2                    	inc	dl ; sector number (1 based)
  2153 0000090E 885402                  	mov	[si+ptBeginSector], dl
  2154                                  	; eax = cylinders * heads + head
  2155                                  
  2156                                  	;; DX_AX = cylinders * heads + head
  2157                                  	;mov	cx, [heads]
  2158                                  	;call	div32
  2159                                  	;; ax = cylinder
  2160                                  	;; bl = head
  2161                                  
  2162                                  	; 07/11/2020
  2163                                  	;sub	edx, edx
  2164                                  	;sub	dx, dx
  2165 00000911 28D2                    	sub	dl, dl
  2166                                  	;movzx	ecx, byte [heads]
  2167 00000913 8A0E[A03C]              	mov	cl, [heads]
  2168 00000917 66F7F1                  	div	ecx
  2169                                  	; eax = cylinder
  2170                                  	; dl = head
  2171                                  cpp_8:
  2172                                  	;; 24/10/2020
  2173                                  	;;mov	bh, 1  ; [si+ptBeginSector]
  2174                                  	;cmp	ax, 1023  ; CHS limit
  2175                                  	;jna	short cpp_18	
  2176                                  	; 07/11/2020
  2177 0000091A 663DFF030000            	cmp	eax, 1023
  2178 00000920 760C                    	jna	short cpp_18
  2179                                  
  2180                                  	; > CHS limit
  2181                                  	;mov	ax, 1023 ; cylinder
  2182                                  	;mov	bl, 0FEh ; 254 (head)
  2183                                  	;mov	bh, 3Fh ; 63 (sector)
  2184                                  	; 07/11/2020
  2185 00000922 66B8FF030000            	mov	eax, 1023
  2186 00000928 B2FE                    	mov	dl, 0FEh ; 254
  2187                                  	; 26/10/2020
  2188 0000092A C644023F                	mov	byte [si+ptBeginSector], 3Fh
  2189                                  cpp_18:
  2190                                  	; 07/11/2020
  2191                                  	; DL = Head number
  2192 0000092E 885401                  	mov	[si+ptBeginHead], dl
  2193                                  
  2194                                  	;; BL = Head number
  2195                                  	;mov	[si+ptBeginHead], bl
  2196                                  	; AX = Cylinder number
  2197                                  	;and	ax, 1023
  2198 00000931 884403                  	mov	[si+ptBeginCylinder], al
  2199 00000934 C0E406                  	shl	ah, 6
  2200                                  	; 24/10/2020
  2201                                  	;or	ah, bh	; bh = sector number
  2202                                  	; 26/10/2020
  2203 00000937 086402                  	or	[si+ptBeginSector], ah
  2204                                  	;mov	[si+ptBeginSector], ah
  2205                                  
  2206                                  	; clear active partition flag (for now)
  2207                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  2208 0000093A C60400                  	mov	byte [si], 0 ; not bootable/active partition
  2209                                  
  2210                                  	;mov	di, [c_fspc_offset]
  2211                                  
  2212 0000093D 803E[966D]59            	cmp	byte [cylinder_boundary], 'Y'
  2213 00000942 757B                    	jne	cpp_11
  2214                                  
  2215                                  	;mov	cl, [heads]
  2216                                  	;mov	al, [sectors]
  2217                                  	;mov	ch, al
  2218                                  	;mul	cl	
  2219                                  	;; ax = heads*sectors
  2220                                  	; 14/03/2021
  2221                                  	;mov	eax, [hs] ; heads * spt
  2222                                  
  2223                                  	;mov	bx, [di+free_space.end]	; end cylinder of the partition
  2224                                  	; 14/03/2021
  2225                                  	;mov	ebx, [di+free_space.end]
  2226 00000944 668B85[2E6D]            	mov	eax, [di+free_space.end]
  2227                                  
  2228 00000949 803E[C869]00            	cmp	byte [wholedisk], 0 ; entire free space ?
  2229 0000094E 771C                    	ja	short cpp_10
  2230                                  
  2231                                  	;mov	bx, ax
  2232                                  	;mov	ax, [ppn_Sectors]
  2233                                  	;mov	dx, [ppn_Sectors+2]
  2234                                  	;add	ax, [pp_StartSector]
  2235                                  	;adc	dx, [pp_StartSector+2]
  2236                                  	;sub	ax, 1
  2237                                  	;sbb	dx, 0
  2238                                  	;	; dx:ax = end sector
  2239                                  	;div	bx
  2240                                  	;	; ax = cylinder number
  2241                                  	; 14/03/2021
  2242                                  	;mov	ebx, eax
  2243 00000950 66A1[F869]              	mov	eax, [ppn_Sectors]
  2244 00000954 660306[C069]            	add	eax, [pp_StartSector]
  2245 00000959 6648                    	dec	eax
  2246 0000095B 6631D2                  	xor	edx, edx
  2247                                  	;div	ebx
  2248 0000095E 66F736[EC69]            	div	dword [hs] ; heads * spt
  2249                                  		; eax = (end) cylinder number
  2250                                  
  2251                                  	; 31/10/2020
  2252                                  	;and	dx, dx
  2253                                  	;jz	short cpp_9
  2254                                  	;inc	ax ; + 1 (because of remainder > 0)
  2255                                  cpp_9:	
  2256                                  	;xchg	ax, bx
  2257                                  	;	; bx = end cylinder
  2258                                  	;	; ax = heads*sectors
  2259                                  	; 14/03/2021
  2260                                  	;xchg	eax, ebx
  2261                                  
  2262                                  	; free space limit check
  2263                                  	;cmp	bx, [di+free_space.end]
  2264                                  	;jna	short cpp_10 ; ok
  2265                                  	;; end cylinder is out of free space
  2266                                  	;dec	bx  ; decrease end cylinder number
  2267                                  	; 14/03/2021
  2268 00000963 663B85[2E6D]            	cmp	eax, [di+free_space.end]
  2269 00000968 7602                    	jna	short cpp_10 ; ok
  2270 0000096A 6648                    	dec	eax
  2271                                  cpp_10: 
  2272 0000096C 6650                    	push	eax ; * ; end cylinder
  2273                                  	;mul	bx
  2274                                  	;	 ; dx:ax = (end cylinder)*heads*sectors
  2275                                  	; 14/03/2021
  2276 0000096E 66F726[EC69]            	mul	dword [hs] ; heads * spt
  2277                                  		; eax = (end cylinder)*heads*sectors
  2278                                  		; edx = 0
  2279 00000973 665A                    	pop	edx ; * ; end cylinder
  2280                                  
  2281                                  	;push	dx ; **
  2282                                  	;push	ax ; *
  2283                                  	; 14/03/2021
  2284 00000975 6650                    	push	eax ; **
  2285                                  
  2286 00000977 6631C0                  	xor	eax, eax ; clear high word of eax
  2287 0000097A A0[9E3C]                	mov	al, [sectors]
  2288 0000097D 8A26[A03C]              	mov	ah, [heads]
  2289                                  
  2290                                  	; 24/10/2020
  2291                                  	;cmp	bx, 1023  ; CHS limit
  2292                                  	;jna	short cpp_19	
  2293                                  	;; > CHS limit
  2294                                  	;mov	bx, 1023 ; cylinder
  2295                                  	;;mov	cl, 0FFh ; 255 (head+1)
  2296                                  	;;mov	ch, 3Fh ; 63 (sector)
  2297                                  	;mov	cx, 3FFFh
  2298                                  	; 14/03/2021
  2299 00000981 6681FAFF030000          	cmp	edx, 1023  ; CHS limit
  2300 00000988 7609                    	jna	short cpp_19	
  2301                                  	; > CHS limit
  2302 0000098A 66BAFF030000            	mov	edx, 1023 ; cylinder
  2303 00000990 B83FFF                  	mov	ax, 0FF3Fh ; heads = 255, sector = 63
  2304                                  cpp_19:
  2305                                  	;dec	cl ; heads - 1 = end head
  2306                                  	; 14/03/2021
  2307 00000993 FECC                    	dec	ah ; heads - 1 = end head
  2308                                  
  2309                                  	; 14/03/2021
  2310                                  	; al = sectors (spt), ah = end head
  2311                                  
  2312                                  	;mov	[si+ptEndHead], cl
  2313                                  	; 14/03/2021
  2314 00000995 886405                  	mov	[si+ptEndHead], ah
  2315                                  
  2316                                  	;; 26/10/2020
  2317                                  	;;mov	al, [sectors]
  2318                                  	;; 31/10/2020
  2319                                  	;mov	al, ch
  2320                                  	;mov	[si+ptEndCylinder], bl
  2321                                  	;;mov	bl, al
  2322                                  	;;shl	bh, 6 ; shift high bytes (2 bits) of end cyl num
  2323                                  	;;	      ; to 6 bits left	
  2324                                  	;;or	bh, bl ; combine high bits of end cyl num and end sector
  2325                                  	;shl	bh, 6
  2326                                  	;or	bh, ch ; ch = end sector (= sectors)
  2327                                  	;mov	[si+ptEndSector], bh
  2328                                  	; 14/03/2021
  2329 00000998 885407                  	mov	[si+ptEndCylinder], dl
  2330 0000099B C0E606                  	shl	dh, 6
  2331 0000099E 08C6                    	or	dh, al ; or dh, byte [sectors]
  2332 000009A0 887406                  	mov	[si+ptEndSector], dh
  2333                                  
  2334                                  	; 24/10/2020
  2335                                  	;;mov	bl, [sectors]
  2336                                  	;;xor	bh, bh ; clear bh
  2337                                  	;mov	bx, [sectors] ; 17 or 63
  2338                                  	;dec	bl ; sectors - 1 ; 22/02/2019
  2339                                  	; 14/03/2021
  2340 000009A3 88C2                    	mov	dl, al ; sectors (spt)
  2341 000009A5 30F6                    	xor	dh, dh
  2342 000009A7 FECA                    	dec	dl
  2343                                  	; edx = sectors - 1
  2344                                  
  2345                                  	;mul	cl ; sectors * [end head]
  2346                                  	; 14/03/2021
  2347 000009A9 F6E4                    	mul	ah 
  2348                                  		; eax = sectors * [end head]
  2349                                  	
  2350                                  	;pop	dx ; *
  2351                                  	;; 22/02/2019
  2352                                  	;xor	cx, cx
  2353                                  	;add	ax, dx
  2354                                  	;pop	dx ; **
  2355                                  	;adc	dx, cx ; 0
  2356                                  	;add	ax, bx
  2357                                  	;adc	dx, cx ; 0
  2358                                  	;; dx:ax = ((([end cylinder]*heads)+[end head])*sectors)+sectors-1
  2359                                  	; 14/03/2021
  2360 000009AB 6601D0                  	add	eax, edx ; ([end head]*sectors)+sectors-1
  2361 000009AE 665A                    	pop	edx ; (end cylinder)*heads*sectors
  2362 000009B0 6601D0                  	add	eax, edx
  2363                                  	; eax = (([end cylinder]*heads)+[end head])*sectors)+sectors-1
  2364                                  
  2365                                  	; calculate aligned partition size in sectors
  2366                                  	;mov	cx, ax
  2367                                  	;mov	bx, dx
  2368                                  	;add	cx, 1
  2369                                  	;adc	bx, 0	
  2370                                  	;sub	cx, [si+ptStartSector]
  2371                                  	;sbb	bx, [si+ptStartSector+2]
  2372                                  	;	; bx:cx = partition size
  2373                                  	;;mov	[ppn_Sectors], cx
  2374                                  	;;mov	[ppn_Sectors+2], bx
  2375                                  	;;jmp	cpp_16
  2376                                  	; 14/03/2021
  2377 000009B3 6689C1                  	mov	ecx, eax
  2378 000009B6 6641                    	inc	ecx
  2379 000009B8 662B4C08                	sub	ecx, [si+ptStartSector]
  2380                                  		; ecx = partition size in sectors
  2381                                  
  2382 000009BC E99D00                  	jmp	cpp_15 ; 06/03/2019
  2383                                  cpp_11:
  2384                                  	; 20/02/2019
  2385                                  	;mov	cx, [ppn_Sectors]
  2386                                  	;mov	bx, [ppn_Sectors+2]
  2387                                  	; 14/03/2021
  2388 000009BF 668B0E[F869]            	mov	ecx, [ppn_Sectors] 
  2389                                  
  2390                                  	;;;mov	ax, [di+free_space.startsector]
  2391                                  	;;;mov	ax, [di+free_space.startsector+2]
  2392                                  	;;mov	ax, [si+ptStartSector]
  2393                                  	;;mov	dx, [si+ptStartSector+2]
  2394                                  	;mov	ax, [pp_StartSector]
  2395                                  	;mov	dx, [pp_StartSector+2]
  2396                                  	; 14/03/2021
  2397 000009C4 66A1[C069]              	mov	eax, [pp_StartSector]
  2398                                  cpp_12:	
  2399                                  	; 18/02/2019
  2400                                  
  2401                                  	; [wholedisk] = 0
  2402                                  
  2403                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  2404                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  2405                                  	; if it is 65536 sectors.)
  2406                                  
  2407 000009C8 E8A200                  	call	fix_32mb_dos_psize
  2408                                  		; bx:cx = [ppn_sectors] = partition size
  2409                                  		; dx:ax = start sector's LBA
  2410                                  
  2411                                  	;add	ax, cx
  2412                                  	;adc	dx, bx
  2413                                  	; 14/03/2021
  2414 000009CB 6601C8                  	add	eax, ecx
  2415                                  	
  2416                                  	; Convert LBA sector address to CHS parameters
  2417                                  	;sub	ax, 1 ; locate on to end sector of the partition
  2418                                  	;sbb	dx, 0
  2419                                  	; 14/03/2021
  2420 000009CE 6648                    	dec	eax ; end sector of the partition
  2421                                  
  2422                                  	; 06/03/2019
  2423 000009D0 803E[966D]59            	cmp	byte [cylinder_boundary],'Y'
  2424                                  	;jne	short cpp_15
  2425 000009D5 7545                    	jne	short cpp_14
  2426                                  
  2427                                  	;mov	cx, ax
  2428                                  	;mov	al, [heads]
  2429                                  	;mul	byte [sectors]
  2430                                  	;mov	di, ax ; [heads]*[sectors]
  2431                                  	;xchg	ax, cx
  2432                                  	;	; cx = heads*spt
  2433                                  	;
  2434                                  	;call	div32
  2435                                  	;	; dx = 0
  2436                                  	;	; ax = end cylinder
  2437                                  	;	; bx = remainder
  2438                                  	; 14/03/2021
  2439 000009D7 6631D2                  	xor	edx, edx
  2440 000009DA 66F736[EC69]            	div	dword [hs] ; heads*spt
  2441                                  		; eax = end cylinder
  2442                                  		; dx = remainder
  2443                                  
  2444                                  	;and	bx, bx
  2445                                  	;jz	short cpp_13
  2446                                  	;inc	ax
  2447                                  ;cpp_13:
  2448                                  	;cmp	ax, [cylinders]
  2449                                  	;jb	short cpp_14
  2450                                  	;dec	ax
  2451                                  ;cpp_14:
  2452                                  
  2453                                  	; 26/10/2020
  2454                                  	;cmp	ax, 1023
  2455                                  	;jna	short cpp_20
  2456                                  	; 14/03/2021
  2457 000009DF 663DFF030000            	cmp	eax, 1023
  2458 000009E5 760E                    	jna	short cpp_20
  2459                                  	
  2460 000009E7 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2461 000009EB C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2462 000009EF C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2463 000009F3 EB16                    	jmp	short cpp_21
  2464                                  cpp_20:
  2465                                  	;mov	bx, [heads]
  2466 000009F5 8A1E[A03C]              	mov	bl, [heads]
  2467 000009F9 FECB                    	dec	bl
  2468 000009FB 885C05                  	mov	[si+ptEndHead], bl
  2469                                  	;;mov	cx, [sectors]
  2470                                  	;mov	cl, [sectors]
  2471                                  	;mov	dl, ah
  2472                                  	;shl	dl, 6
  2473                                  	;or	dl, cl
  2474                                  	;mov	[si+ptEndSector], dl
  2475                                  	; 14/03/2021
  2476 000009FE C0E406                  	shl	ah, 6
  2477 00000A01 0A26[9E3C]              	or	ah, [sectors]
  2478 00000A05 886406                  	mov	[si+ptEndSector], ah
  2479 00000A08 884407                  	mov	[si+ptEndCylinder], al	
  2480                                  	;mul	di ; [cylinders]*[heads]*[sectors]
  2481                                  	;;sub	di, cx ; ([heads] - 1) * [sectors]
  2482                                  	;add	ax, di
  2483                                  	;adc	dx, 0
  2484                                  	;;add	ax, cx
  2485                                  	;;adc	dx, 0
  2486                                  cpp_21:
  2487                                  	;inc	ax
  2488                                  	;mul	di  ; result = start LBA of next cylinder
  2489                                  	;; dx:ax = end sector LBA + 1 (as cyl. boundary aligned)
  2490                                  	; 14/03/2021
  2491 00000A0B 6640                    	inc	eax ; end sector address + 1
  2492 00000A0D 66F726[EC69]            	mul	dword [hs] ; heads*spt
  2493                                  	
  2494                                  	;sub	ax, [pp_StartSector]
  2495                                  	;sbb	dx, [pp_StartSector+2]
  2496                                  	; 14/03/2021
  2497 00000A12 662B06[C069]            	sub	eax, [pp_StartSector]
  2498                                  
  2499                                  	;mov	cx, ax
  2500                                  	;mov	bx, dx
  2501                                  	;;jmp	short cpp_16
  2502                                  	; 14/03/2021
  2503 00000A17 6689C1                  	mov	ecx, eax ; partition size
  2504                                  
  2505 00000A1A EB40                    	jmp	short cpp_15
  2506                                  ;cpp_15:
  2507                                  cpp_14:
  2508                                  	; 14/03/2021
  2509                                  	; eax =  end sector
  2510                                  
  2511                                  	;mov	cx, [sectors]
  2512                                  	;call	div32
  2513                                  	;; BX = Sector number - 1
  2514                                  	;inc	bl ; sector number (1 based)
  2515                                  	;mov	[si+ptEndSector], bl
  2516                                  	;; DX_AX = cylinders * heads + head
  2517                                  	; 14/03/2021
  2518                                  	;xor	edx, edx
  2519 00000A1C 31D2                    	xor	dx, dx
  2520 00000A1E 660FB61E[9E3C]          	movzx	ebx, byte [sectors]
  2521 00000A24 66F7F3                  	div	ebx
  2522                                  		 ; dl = sector number - 1
  2523 00000A27 FEC2                    	inc	dl ; sector number
  2524 00000A29 885406                  	mov	[si+ptEndSector], dl
  2525                                  
  2526                                  	;mov	cx, [heads]
  2527                                  	;call	div32
  2528                                  	;; BX = Head number
  2529                                  	;mov	[si+ptEndHead], bl
  2530                                  	;; AX = Cylinder number
  2531                                  	;;and	ax, 1023
  2532                                  	; 14/03/2021
  2533                                  	;xor	dx, dx
  2534 00000A2C 30D2                    	xor	dl, dl
  2535 00000A2E 8A1E[A03C]              	mov	bl, [heads]
  2536 00000A32 66F7F3                  	div	ebx
  2537                                  		; eax = cylinder number
  2538                                  		; dl = head number
  2539 00000A35 885405                  	mov	[si+ptEndHead], dl
  2540                                  
  2541                                  	; 26/10/2020
  2542                                  	;cmp	ax, 1023
  2543                                  	;jna	short cpp_22
  2544                                  	; 14/03/2021
  2545 00000A38 663DFF030000            	cmp	eax, 1023
  2546 00000A3E 760E                    	jna	short cpp_22
  2547                                  	
  2548 00000A40 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2549 00000A44 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2550 00000A48 C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2551 00000A4C EB09                    	jmp	short cpp_23
  2552                                  cpp_22:
  2553 00000A4E 884407                  	mov	[si+ptEndCylinder], al
  2554                                  	; 18/02/2019
  2555 00000A51 C0E406                  	shl	ah, 6
  2556 00000A54 086406                  	or	[si+ptEndSector], ah
  2557                                  cpp_23:
  2558                                  	;mov	cx, [ppn_Sectors]
  2559                                  	;mov	bx, [ppn_Sectors+2]
  2560                                  	; 14/03/2021
  2561 00000A57 668B0E[F869]            	mov	ecx, [ppn_Sectors]
  2562                                  ;cpp_16:
  2563                                  cpp_15:
  2564                                  	;mov	[si+ptSectors], cx
  2565                                  	;mov	[si+ptSectors+2], bx
  2566                                  	; 14/03/2021
  2567 00000A5C 66894C0C                	mov	[si+ptSectors], ecx
  2568                                  
  2569                                  	; set partition ID after checking DOS FAT limits
  2570 00000A60 E8E500                  	call	set_partition_id
  2571                                  	; al = partition ID
  2572                                  
  2573                                  	; 14/03/2021
  2574                                  	; clear -specially- high word of ecx
  2575 00000A63 6631C9                  	xor	ecx, ecx ; (this may not be needed!?)
  2576                                  
  2577 00000A66 A2[C969]                	mov	[pp_type], al
  2578                                  
  2579 00000A69 884404                  	mov	[si+ptFileSystemID], al
  2580                                  
  2581 00000A6C C3                      	retn
  2582                                  
  2583                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2584                                  ; decrease DOS partition size when it is (exact) 65536 sectors
  2585                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2586                                  ; 07/11/2020 (fdisk4)
  2587                                  ; 18/02/2019
  2588                                  
  2589                                  fix_32mb_dos_psize:	; call this if [wholedisk] = 0
  2590                                  
  2591                                  ; Purpose: 
  2592                                  ;	If a DOS partition's size is 65536 sectors
  2593                                  ;	MSDOS 3.3 can not use it. (FAT 16 partition ID = 06h)
  2594                                  ;	Decreasing partition size to 65535 sectors will ensure
  2595                                  ;	MSDOS 3.3 compatibility (FAT 16 partition ID will be 04h).
  2596                                  
  2597                                  	; INPUT:
  2598                                  	;    BX:CX = partition size in sectors
  2599                                  	;    [pp_type] = partition type dos, non-dos, user input
  2600                                  	;
  2601                                  	; OUTPUT:
  2602                                  	;    Partition size will be changed to 65535 sectors, if
  2603                                  	;    	- partition size is 65536 sectors and
  2604                                  	; 	- [pp_type] is 1 (DOS)
  2605                                  	;
  2606                                  	;    [ppn_Sectors] = 65535 (if it will be changed)
  2607                                  	;
  2608                                  	; (Modified registers: cx, bx) 
  2609                                  
  2610                                  	;mov	cx, [ppn_Sectors]
  2611                                  	;mov	bx, [ppn_Sectors+2]
  2612                                  
  2613 00000A6D 803E[C969]01            	cmp	byte [pp_type], 1 ;  DOS partition
  2614 00000A72 7514                    	jne	short psfx_0  ; non-dos partition or user input
  2615                                  			      ; nothing to do !
  2616                                  	; 07/11/2020
  2617                                  	;or	cx, cx
  2618 00000A74 7512                    	jnz	short psfx_0 ; <> 65536 sectors
  2619                                  	;cmp	bx, 1
  2620 00000A76 7510                    	jne	short psfx_0
  2621                                  	;dec	bx
  2622                                  	;;mov	[wholedisk], bx ; 0
  2623                                  	;dec	cx  ; bx:cx = 65535
  2624                                  	;mov	[ppn_Sectors], cx
  2625                                  	;mov	[ppn_Sectors+2], bx
  2626                                  
  2627                                  	; 07/11/2020 (fdisk4)
  2628 00000A78 6681F900000100          	cmp	ecx, 65536
  2629 00000A7F 7507                    	jne	short psfx_0
  2630 00000A81 6649                    	dec	ecx  ; 65535
  2631 00000A83 66890E[F869]            	mov	[ppn_Sectors], ecx
  2632                                  psfx_0:
  2633 00000A88 C3                      	retn
  2634                                  
  2635                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2636                                  ; create extended dos partition
  2637                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2638                                  ; 24/10/2020 (fdisk3.s)
  2639                                  
  2640                                  ; 16/02/2019 (hdimage.s) 
  2641                                  ;	(This procedure must be called after 'find_part_free_space')
  2642                                  
  2643                                  	; 15/03/2021 (fdisk4.s)
  2644                                  create_extended_partition:  
  2645                                  	; 15/02/2019
  2646                                  
  2647                                  	; INPUT:
  2648                                  	;	none 
  2649                                  	;  (CHS parameters and free space calculation result will be used.)
  2650                                  	;
  2651                                  	; OUTPUT:
  2652                                  	;	Partition table in MBR buffer will be updated.
  2653                                  	;
  2654                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  2655                                  
  2656                                  	; Create extended dos partition, make partition table entry
  2657                                  	; (Extended partition will be created on cylinder bounds.)
  2658                                  
  2659                                  	; 16/02/2019
  2660 00000A89 E8C51A                  	call	get_first_free_pte
  2661                                  		 ; CX = First free PTE number, 0 to 3 
  2662                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  2663                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  2664                                   	 	 ; SI = PTE addres/offset in MBR buffer
  2665                                  
  2666                                  	;mov	si, MasterBootBuff+pTableOffset
  2667                                  	;shl	cl, 4 ; * 16
  2668                                  	;add	si, cx
  2669                                  	
  2670                                  	;mov	bx, [c_fspc_offset]
  2671                                  	; 15/03/2021
  2672 00000A8C 8B3E[946D]              	mov	di, [c_fspc_offset]
  2673                                  
  2674                                  	;mov	ax, [bx+free_space.start]
  2675                                  	; 15/03/2021
  2676 00000A90 668B85[2A6D]            	mov	eax, [di+free_space.start]
  2677                                  
  2678                                  	; 24/10/2020
  2679                                  	;mov	di, ax ; 15/03/2021
  2680                                  
  2681                                  	;mov	cx, 1
  2682 00000A95 B101                    	mov	cl, 1 ; head (ch) = 0, sector (cl) = 1
  2683                                  
  2684                                  	; 15/03/2021
  2685 00000A97 6689C3                  	mov	ebx, eax
  2686                                  
  2687                                  	;cmp	ax, 1023
  2688                                  	;jna	short cep_4
  2689                                  	; 15/03/2021
  2690 00000A9A 663DFF030000            	cmp	eax, 1023
  2691 00000AA0 7609                    	jna	short cep_4
  2692                                  
  2693                                  	; partition start  > CHS limit
  2694                                  	;mov	ax, 1023
  2695                                  	; 15/03/2021
  2696 00000AA2 66B8FF030000            	mov	eax, 1023
  2697                                  
  2698                                  	;mov	ch, 254
  2699                                  	;mov	cl, 63
  2700 00000AA8 B93FFE                  	mov	cx, 0FE3Fh
  2701                                  cep_4:	
  2702                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  2703                                  	;mov	[si], ch ; 0 ; not bootable/active partition
  2704                                  	; 26/10/2020
  2705 00000AAB C60400                  	mov	byte [si], 0
  2706 00000AAE 886C01                  	mov	[si+ptBeginHead], ch
  2707 00000AB1 C0E406                  	shl	ah, 6
  2708 00000AB4 08E1                    	or	cl, ah
  2709 00000AB6 884C02                  	mov	[si+ptBeginSector], cl ; Sector 1
  2710 00000AB9 884403                  	mov	[si+ptBeginCylinder], al
  2711                                  
  2712                                  	;mov	al, [heads]
  2713                                  	;mul	byte [sectors]
  2714                                  	;	; ax = heads*sectors
  2715                                  	;mul	di  ; AX * cylinder count before start cylinder
  2716                                  	;	; DX:AX = LBA of cylinder DI, head 0, sector 1 
  2717                                  	; 15/03/2021
  2718                                  	; eax = start cylinder
  2719 00000ABC 6689D8                  	mov	eax, ebx
  2720 00000ABF 66F726[EC69]            	mul	dword [hs] ; heads * sectors
  2721                                  		; eax = start sector, edx = 0
  2722                                  	
  2723                                  	;mov	[si+ptStartSector], ax
  2724                                  	;mov	[si+ptStartSector+2], dx
  2725                                  	; 15/03/2021
  2726 00000AC4 66894408                	mov	[si+ptStartSector], eax
  2727                                  
  2728                                  	; This is not needed for extended partition.
  2729                                  	; 16/02/2019
  2730                                  	;mov	[pp_StartSector], ax
  2731                                  	;mov	[pp_StartSector+2], dx
  2732                                  	; 15/03/2021
  2733                                  	;mov	[pp_StartSector], eax
  2734                                  
  2735                                  	; 16/02/2019
  2736 00000AC8 803E[C869]00            	cmp	byte [wholedisk], 0
  2737 00000ACD 7719                    	ja	short cep_2 ; all of free space will be used
  2738                                  			    ; ([bx+free_space.end] will be end cyl)
  2739                                  
  2740                                  	; calculate cylinder count (from partition size input)
  2741                                  	;mov	al, [heads]
  2742                                  	;mul	byte [sectors]
  2743                                  	;mov	cx, ax
  2744                                  	;mov	ax, [ppn_Sectors]
  2745                                  	;mov	dx, [ppn_Sectors+2]
  2746                                  	;call	div32
  2747                                  	;	; ax = cylinders
  2748                                  	;	; bx = remainder
  2749                                  	;and	bx, bx
  2750                                  	;jz	short cep_1
  2751                                  	;inc	ax  ; round up
  2752                                  	; 15/03/2021
  2753                                  	; edx = 0
  2754 00000ACF 66A1[F869]              	mov	eax, [ppn_Sectors]
  2755 00000AD3 66F736[EC69]            	div	dword [hs] ; heads * spt
  2756                                  		; eax = cylinders, dx = remainder
  2757 00000AD8 21D2                    	and	dx, dx
  2758 00000ADA 7402                    	jz	short cep_1
  2759 00000ADC 6640                    	inc	eax ; round up
  2760                                  cep_1:
  2761                                  	; 15/03/2021
  2762                                  	; EBX = extended partition's start cylinder
  2763                                   	; 16/02/2019
  2764                                  	; DI  = extended partition's start cylinder
  2765                                  	;mov	dx, ax ; cylinder count
  2766                                  	;add	dx, di ; result is end cyl + 1
  2767                                  	;dec	dx ; decrease number for current end cylinder
  2768                                  	;mov	bx, [c_fspc_offset]
  2769                                  	;cmp	dx, [bx+free_space.end]
  2770                                  	;jna	short cep_3
  2771                                  	; 24/10/2020
  2772                                  	;;dec	ax ; decrease cylinder count down to the limit
  2773                                  	;dec	dx ; decrease end cylinder down to the limit
  2774                                  	; 15/03/2021	
  2775 00000ADE 6689C2                  	mov	edx, eax ; cylinder count
  2776 00000AE1 6601DA                  	add	edx, ebx ; result is end cyl + 1
  2777 00000AE4 664A                    	dec	edx ; end cylinder
  2778                                  	;mov	di, [c_fspc_offset]
  2779                                  
  2780 00000AE6 EB05                    	jmp	short cep_3
  2781                                  cep_2:
  2782                                  	; 15/03/2021
  2783                                  	; DI = [c_fspc_offset]
  2784                                  
  2785                                  	;mov	dx, [bx+free_space.end]
  2786                                  	;;mov	ax, [bx+free_space.space]
  2787                                  	; 15/03/2021
  2788 00000AE8 668B97[2E6D]            	mov	edx, [bx+free_space.end]
  2789                                  cep_3:
  2790                                  	; 15/03/2021
  2791 00000AED 6631DB                  	xor	ebx, ebx
  2792                                  
  2793                                  	; 24/10/2020
  2794                                  	;mov	ax, dx ; end cylinder
  2795                                  	;mov	bl, 05h	; Extended Partition ID (CHS)
  2796                                  	;cmp	ax, 1023
  2797                                  	;jna	short cep_5
  2798                                  	; 15/03/2021
  2799 00000AF0 6689D0                  	mov	eax, edx ; end cylinder
  2800 00000AF3 B305                    	mov	bl, 05h ; Extended Partition ID (CHS)
  2801 00000AF5 663DFF030000            	cmp	eax, 1023
  2802 00000AFB 760D                    	jna	short cep_5
  2803                                  
  2804                                  	; partition end > CHS limit
  2805                                  	;mov	ax, 1023
  2806                                  	; 15/03/2021
  2807 00000AFD 66B8FF030000            	mov	eax, 1023
  2808                                  
  2809                                  	;mov	ch, 254
  2810                                  	;mov	cl, 63
  2811 00000B03 B93FFE                  	mov	cx, 0FE3Fh
  2812 00000B06 B30F                    	mov	bl, 0Fh	; Extended Partition ID (LBA)
  2813 00000B08 EB0A                    	jmp	short cep_6
  2814                                  cep_5:
  2815 00000B0A 8A2E[A03C]              	mov	ch, [heads]
  2816 00000B0E FECD                    	dec	ch 
  2817 00000B10 8A0E[9E3C]              	mov	cl, [sectors]
  2818                                  cep_6:
  2819 00000B14 886C05                  	mov	[si+ptEndHead], ch
  2820                                  	; 24/10/2020
  2821                                  	; ax = (chs limit compatible) end cylinder (<= 1023)
  2822                                  	; 23/02/2019
  2823                                  	;mov	bl, dh
  2824                                  	;shl	bl, 6
  2825                                  	;or	bl, cl
  2826 00000B17 C0E406                  	shl	ah, 6
  2827                                  	;or	cl, ah
  2828                                  	;;mov	[si+ptEndSector], bl
  2829                                  	;mov	[si+ptEndSector], cl
  2830                                  	; 15/03/2021
  2831 00000B1A 08CC                    	or	ah, cl
  2832 00000B1C 886406                  	mov	[si+ptEndSector], ah
  2833                                  	;mov	[si+ptEndCylinder], dl
  2834 00000B1F 884407                  	mov	[si+ptEndCylinder], al
  2835                                  	; dx = (lba compatible) end cylinder (up to 65535)
  2836                                  
  2837                                  	;mov	al, [heads]
  2838                                  	; 26/10/2020
  2839                                  	;;;mul	cl
  2840                                  	;;mul	byte [sectors]
  2841                                  	;mov	ch, [heads]
  2842                                  	;mov	al, [sectors]
  2843                                  	;mul	ch	
  2844                                  	;; ax = heads*sectors
  2845                                  	;mul	dx ; AX * cylinder count before end cylinder
  2846                                  	;	; DX:AX = LBA of cylinder DX, head 0, sector 1
  2847                                  	; 15/03/2021
  2848                                  	; edx = end cylinder
  2849 00000B22 66A1[EC69]              	mov	eax, [hs] ; [heads] * [sectors]
  2850 00000B26 66F7E2                  	mul	edx
  2851                                  		; eax = LBA of end cylinder, head 0, sector 1
  2852                                  		; edx = 0
  2853                                  	;push	dx
  2854                                  	;push	ax
  2855                                  	; 15/03/2021
  2856 00000B29 6650                    	push	eax ; (end cylinder)*heads*sectors
  2857                                  	
  2858 00000B2B 88E8                    	mov	al, ch
  2859 00000B2D FEC8                    	dec	al ; 26/10/2020 ; [heads] - 1
  2860                                  	;mov	cx, [sectors]  ; 63 or 17
  2861                                  	; cl = sectors ; 15/03/2021
  2862 00000B2F F6E1                    	mul	cl
  2863                                  		; ax = (heads-1)*sectors
  2864                                  	; 15/03/2021
  2865 00000B31 89C2                    	mov	dx, ax ; (heads-1)*sectors
  2866                                  	
  2867                                  	;pop	dx
  2868                                  	;add	ax, dx
  2869                                  	;pop	dx
  2870                                  	;adc	dx, 0
  2871                                  	;	; dx:ax = ((end cylinder)*heads)+(heads-1)*sectors
  2872                                  	;add	ax, cx
  2873                                  	;adc	dx, 0
  2874                                  	; dx:ax = (((end cylinder)*heads)+(heads-1))*sectors) + sectors
  2875                                  	; dx:ax = LBA of the partition's end sector + 1
  2876                                  
  2877                                  	; 15/03/2021
  2878 00000B33 30ED                    	xor	ch, ch
  2879 00000B35 01CA                    	add	dx, cx ; ((heads-1)*sectors)+sectors
  2880 00000B37 6658                    	pop	eax ; ((end cylinder)*heads)*sectors
  2881 00000B39 6601D0                  	add	eax, edx
  2882                                  	; eax = (((end cylinder)*heads)+(heads-1))*sectors)+sectors
  2883                                  
  2884                                  	;sub	ax, [si+ptStartSector]
  2885                                  	;sbb	dx, [si+ptStartSector+2]
  2886                                  	; 15/03/2021
  2887 00000B3C 662B4408                	sub	eax, [si+ptStartSector]
  2888                                  	
  2889                                  	;mov	[si+ptSectors], ax
  2890                                  	;mov	[si+ptSectors+2], dx
  2891                                  	; 15/03/2021
  2892 00000B40 6689440C                	mov	[si+ptSectors], eax
  2893                                  
  2894                                  	;mov	[pp_type], al
  2895                                  
  2896                                  	;mov	byte [si+ptFileSystemID], 5
  2897                                  	; 24/10/2020
  2898 00000B44 885C04                  	mov	 [si+ptFileSystemID], bl ; 05h or 0Fh
  2899                                  	
  2900 00000B47 C3                      	retn
  2901                                  
  2902                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2903                                  ; set DOS (and non-dos) partition ID according to partition size
  2904                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2905                                  ; 23/10/2020
  2906                                  
  2907                                  	; 15/03/2021
  2908                                  set_partition_id: 
  2909                                  	; 07/11/2020 (fdisk4.s, 32 bit registers)
  2910                                  	; 23/10/2020 (fdisk3.s)
  2911                                  	; input:
  2912                                  	;   si = partition table offset
  2913                                  	;   bx:cx = partition size
  2914                                  
  2915                                  	; 18/02/2019 (hdimage.s)
  2916                                  	;mov	cx, [ppn_Sectors]
  2917                                  	;mov	bx, [ppn_Sectors+2]
  2918                                  
  2919 00000B48 A0[C969]                	mov	al, [pp_type]
  2920                                  
  2921                                  	;cmp	byte [pp_type], 1
  2922 00000B4B 3C01                    	cmp	al, 1 ; primary DOS (FAT12, FAT16, FAT32)
  2923 00000B4D 7525                    	jne	short spid_2 ; singlix, runix or user type
  2924                                  
  2925                                  	;mov	al, 1	; FAT12
  2926                                  
  2927                                  	;or	bx, bx
  2928                                  	;jnz	short spid_1
  2929                                  	; 15/03/2021
  2930 00000B4F 6681F900000100          	cmp	ecx, 65536 ; >= 32 MB
  2931 00000B56 730D                    	jnb	short spid_1	
  2932                                  
  2933                                  	;cmp	cx, 32680
  2934                                  	;;jna	short spid_8	; FAT12 file system
  2935                                  	;jna	short spid_19 ; 23/10/2020
  2936                                  	; 07/11/2020
  2937 00000B58 6681F9A87F0000          	cmp	ecx, 32680
  2938 00000B5F 7620                    	jna	short spid_19
  2939                                  
  2940 00000B61 B004                    	mov	al, 4	; FAT16 (< 32MB)
  2941                                  
  2942 00000B63 EB46                    	jmp	short spid_8	; FAT16 (CHS) file system
  2943                                  
  2944                                  spid_1:
  2945 00000B65 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  2946                                  
  2947                                  	;cmp	bx, 10h
  2948                                  	; 07/11/2020
  2949 00000B67 6681F900001000          	cmp	ecx, 100000h ; 512 MB 
  2950 00000B6E 733B                    	jnb	short spid_8	; FAT32 (CHS) file system
  2951                                  
  2952 00000B70 B006                    	mov	al, 6	; FAT16 (>= 32MB)
  2953                                  
  2954 00000B72 EB37                    	jmp	short spid_8	; FAT16 big (CHS) file system
  2955                                  
  2956                                  spid_2:
  2957                                  	;cmp	byte [pp_type], 2 ; Singlix FS
  2958 00000B74 3C02                    	cmp	al, 2
  2959 00000B76 7503                    	jne	short spid_3
  2960 00000B78 B0A1                    	mov	al, 0A1h
  2961                                  	;jmp	short spid_8
  2962 00000B7A C3                      	retn	; 23/10/2020
  2963                                  spid_3:
  2964                                  	;cmp	byte [pp_type], 3 ; Retro Unix FS
  2965 00000B7B 3C03                    	cmp	al, 3
  2966 00000B7D 7503                    	jne	short spid_4
  2967 00000B7F B071                    	mov	al, 71h	
  2968                                  	;jmp	short spid_8
  2969                                  spid_19:
  2970 00000B81 C3                      	retn
  2971                                  
  2972                                  spid_4:
  2973                                  	; another partition type (user input)
  2974                                  	
  2975                                  	; [pp_type] = 4
  2976                                  
  2977 00000B82 A0[CA69]                	mov	al, [pp_type_user]
  2978                                  
  2979                                  	; Check FAT12 fs size validation
  2980                                  
  2981 00000B85 3C01                    	cmp	al, 1 ; FAT12
  2982 00000B87 7737                    	ja	short spid_9
  2983                                  
  2984                                  	;and	bx, bx
  2985                                  	;jnz	short spid_6
  2986                                  
  2987                                  	;cmp	cx, 32680
  2988                                  	;;jna	short spid_8
  2989                                  	;jna	short spid_19 ; 23/10/2020
  2990                                  
  2991                                  	; 07/11/2020
  2992 00000B89 6681F900000100          	cmp	ecx, 65536
  2993 00000B90 730A                    	jnb	short spid_6
  2994 00000B92 81F9A87F                	cmp	cx, 32680
  2995 00000B96 76E9                    	jna	short spid_19
  2996                                  spid_5:
  2997 00000B98 B004                    	mov	al, 4 ; FAT16 (<= 32MB)
  2998 00000B9A EB0F                    	jmp	short spid_8
  2999                                  spid_6:
  3000                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  3001                                  	;cmp	bx, 40h ; 2GB (64*32MB)
  3002                                  	;jnb	short spid_7
  3003                                  	; 15/03/2021
  3004 00000B9C 6681F900004000          	cmp	ecx, 400000h ; 2GB (64K*64 sectors)
  3005 00000BA3 7304                    	jnb	short spid_7
  3006                                  
  3007 00000BA5 B006                    	mov	al, 6
  3008 00000BA7 EB02                    	jmp	short spid_8
  3009                                  spid_7:
  3010 00000BA9 B00B                    	mov	al, 0Bh ; FAT32 (CHS) partition
  3011                                  spid_8:
  3012                                  	; 23/10/2020
  3013                                  	; check the partition's end sector against CHS limit and
  3014                                  	; convert partition ID if the partition overs CHS limit
  3015                                  	;cmp	al, 1 ; FAT12 fs
  3016                                  	;je	short spid_19 ; nothing to do (for FAT12 fs)
  3017                                  	;add	cx, [si+ptStartSector]
  3018                                  	;adc	bx, [si+ptStartSector+2]
  3019                                  	; 15/03/2021
  3020 00000BAB 66034C08                	add	ecx, [si+ptStartSector]
  3021                                  	
  3022                                  	;cmp	bx, [chs_limit+2]
  3023                                  	;jb	short spid_19 ; partition's end sector is in CHS limit
  3024                                  	;ja	short spid_17 ; out of CHS limit
  3025                                  	;cmp	cx, [chs_limit]
  3026                                  	;jna	short spid_19 ; partition's end sector is in CHS limit
  3027                                  	; 07/11/2020
  3028 00000BAF 663B0E[3265]            	cmp	ecx, [chs_limit]
  3029 00000BB4 76CB                    	jna	short spid_19 ; partition's end sector is in CHS limit
  3030                                  spid_17:
  3031                                  	; out of CHS limit, partition ID conversion is needed
  3032 00000BB6 3C0B                    	cmp	al, 0Bh	; FAT32 CHS
  3033 00000BB8 7203                    	jb	short spid_18
  3034 00000BBA B00C                    	mov	al, 0Ch	; FAT 32 LBA
  3035 00000BBC C3                      	retn
  3036                                  spid_18:
  3037 00000BBD B00E                    	mov	al, 0Eh ; FAT16 LBA
  3038 00000BBF C3                      	retn
  3039                                  spid_9:
  3040 00000BC0 3C04                    	cmp	al, 4 ; FAT16 (< 32 MB)
  3041 00000BC2 7511                    	jne	short spid_10
  3042                                  
  3043                                  	;or	bx, bx
  3044                                  	;jnz	short spid_6
  3045                                  	; 15/03/2021
  3046 00000BC4 6681F900000100          	cmp	ecx, 65536
  3047 00000BCB 73CF                    	jnb	short spid_6
  3048 00000BCD 81F93610                	cmp	cx, 4150 ; 4085 + 32 + 32 + 1
  3049 00000BD1 7220                    	jb	short spid_12
  3050                                  	
  3051                                  	;retn	; FAT16 (< 32 MB) partition
  3052 00000BD3 EBD6                    	jmp	short spid_8  ; 23/10/2020
  3053                                  
  3054                                  spid_10:
  3055 00000BD5 3C06                    	cmp	al, 6 ; FAT 16 big partition
  3056 00000BD7 751D                    	jne	short spid_13 ; Extended partition or another type
  3057                                  	
  3058                                  	;and	bx, bx
  3059                                  	;jz	short spid_11
  3060                                  	; 07/11/2020
  3061 00000BD9 6681F900000100          	cmp	ecx, 65536
  3062 00000BE0 720B                    	jb	short spid_11
  3063                                  
  3064                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  3065                                  	;cmp	bx, 40h ; 2GB (64*32MB)
  3066                                  	;jnb	short spid_7
  3067                                  	; 15/03/2021
  3068 00000BE2 6681F900004000          	cmp	ecx, 400000h ; 2GB (64K*64 sectors)
  3069 00000BE9 73BE                    	jnb	short spid_7
  3070                                  
  3071                                  	;retn
  3072 00000BEB EBBE                    	jmp	short spid_8 ; 23/10/2020
  3073                                  
  3074                                  spid_11:
  3075                                  	;cmp	ax, 4150 ; 4085 + 32 + 32 + 1
  3076 00000BED 81F93610                	cmp	cx, 4150 ; 14/09/2020 (BugFix)
  3077 00000BF1 73A5                    	jnb	short spid_5
  3078                                  spid_12:
  3079 00000BF3 B001                    	mov	al, 1 ;  FAT12 partition
  3080                                  spid_16:
  3081 00000BF5 C3                      	retn
  3082                                  spid_13:
  3083                                  	; 14/09/2020
  3084 00000BF6 3C0B                    	cmp	al, 0Bh ; FAT 32 (CHS) partition
  3085 00000BF8 7432                    	je	short spid_15 ; FAT 32 CHS
  3086 00000BFA 3C0C                    	cmp	al, 0Ch	 
  3087 00000BFC 7515                    	jne	short spid_14
  3088                                  	; FAT 32 LBA
  3089                                  	;and	bx, bx	; < 33 MB
  3090                                  	;jz	short spid_11 ; force to FAT 16 CHS or FAT 12
  3091                                  	;cmp	bx, 10h ; 512 MB
  3092                                  	;;jnb	short spid_8  ; OK, FAT 32 LBA has been confirmed
  3093                                  	;jnb	short spid_16 ; 23/10/2020
  3094                                  	; 15/03/2021
  3095 00000BFE 6681F900000100          	cmp	ecx, 65536
  3096 00000C05 72E6                    	jb	short  spid_11 ; force to FAT 16 CHS or FAT 12
  3097 00000C07 6681F900001000          	cmp	ecx, 100000h ; 512MB
  3098 00000C0E 73E5                    	jnb	short spid_16  ; OK
  3099                                  	; < 512MB
  3100 00000C10 B00E                    	mov	al, 0Eh ; force to FAT 16 LBA
  3101 00000C12 C3                      	retn
  3102                                  spid_14:
  3103                                  	; 14/09/2020
  3104 00000C13 3C0E                    	cmp	al, 0Eh
  3105                                  	;jne	short spid_8 ; non-dos or extended partition
  3106 00000C15 75DE                    	jne	short spid_16 ; 23/10/2020
  3107                                  	; FAT 16 LBA
  3108                                  	;or	bx, bx
  3109                                  	;jz	short spid_11
  3110                                  	; 15/03/2021
  3111 00000C17 6681F900000100          	cmp	ecx, 65536
  3112 00000C1E 72CD                    	jb	short spid_11
  3113                                  	; 23/10/2020
  3114                                  	;cmp	bx, 20h ; 1 GB
  3115                                  	;jb	short spid_16
  3116                                  	; 15/03/2021
  3117                                  	;((this 1GB limit may be 2GB))
  3118 00000C20 6681F900002000          	cmp	ecx, 200000h ; 1GB
  3119 00000C27 72CC                    	jb	short spid_16
  3120 00000C29 B00C                    	mov	al, 0Ch	; FAT 32 LBA
  3121 00000C2B C3                      	retn
  3122                                  spid_15:
  3123                                  	; Minimum size of FAT 32 FS = 65525 + 512 + 512 + 32
  3124                                   	; >= 66581 sectors (or >= 65525 data clusters)
  3125                                  	;cmp	bx, 1
  3126                                  	;jb	short spid_11  ; invalid! (< 32 MB)
  3127                                  	;ja	short spid_8
  3128                                  	;cmp	cx, 1045
  3129                                  	;;jb	short spid_16  ; invalid! (< 33 MB)
  3130                                  	;;retn
  3131                                  	;;jmp	short spid_8 ; 23/10/2020
  3132                                  	;jnb	short spid_8
  3133                                  	; 15/03/2021
  3134 00000C2C 6681F915040100          	cmp	ecx, 66581
  3135 00000C33 0F8374FF                	jnb	spid_8   ; OK (>= 33MB)
  3136 00000C37 6681F900000100          	cmp	ecx, 65536
  3137 00000C3E 72AD                    	jb	short spid_11  ; invalid! (< 32MB)
  3138                                  ;spid_16:
  3139 00000C40 B006                    	mov	al, 6
  3140                                  	;retn
  3141 00000C42 E966FF                  	jmp	spid_8 ; 23/10/2020
  3142                                  
  3143                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3144                                  ; 32 bit division by using 16 bit registers
  3145                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3146                                  
  3147                                  	; 06/11/2020 (fdisk4)
  3148                                  	; 32 bit division (80386 div instruction for 32 bit regs)
  3149                                  	; will be used instead of div32 procedure for 16 bit regs
  3150                                  ;div32:
  3151                                  	;; DX_AX/CX
  3152                                  	;; Result: DX_AX, BX (remainder)
  3153                                  	;mov	bx, ax
  3154                                  	;;or	dx, ax ; * DX_AX = 0 ?
  3155                                  	;;jz	short div32_retn ; yes, do not divide!
  3156                                  	;mov	ax, dx
  3157                                          ;xor	dx, dx
  3158                                          ;div	cx	; at first, divide DX
  3159                                  	;		; remainder is in DX 
  3160                                  	;xchg	ax, bx	; now quotient is in BX
  3161                                    	;		; and initial AX value is in AX
  3162                                  	;div	cx	; now, DX_AX has been divided and
  3163                                  	;		; AX has quotient
  3164                                  	;		; DX has remainder
  3165                                  	;xchg	dx, bx	; finally, BX has remainder
  3166                                  ;;div32_retn:
  3167                                          ;retn
  3168                                  
  3169                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3170                                  ; 32 bit multiplication by using 16 bit registers
  3171                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3172                                  
  3173                                  	; 06/11/2020 (fdisk4)
  3174                                  	; 32 bit multiplication (80386 mul instruction)
  3175                                  	; will be used instead of mul32 procedure for 16 bit regs
  3176                                  ;mul32:
  3177                                  	;; DX_AX*CX
  3178                                  	;; Result: BX_DX_AX 
  3179                                  	;push	cx
  3180                                  	;mov	bx, dx
  3181                                  	;mul	cx
  3182                                   	;xchg	ax, bx
  3183                                  	;push	dx
  3184                                  	;mul	cx 
  3185                                  	;pop	cx 
  3186                                  	;add	ax, cx 
  3187                                  	;adc	dx, 0
  3188                                  	;xchg	bx, ax
  3189                                  	;xchg	dx, bx
  3190                                  	;pop	cx
  3191                                  	;retn
  3192                                  
  3193                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3194                                  ; creeate new partition input menu
  3195                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3196                                  
  3197                                  B_01:
  3198                                  	; 06/03/2019
  3199 00000C45 C606[D669]4D            	mov	byte [pSize_unit], 'M' ; default (for 'whole' disk/space)
  3200                                  	; 15/02/2019
  3201 00000C4A E82DFB                  	call	create_partition_input
  3202                                  B_02:		
  3203 00000C4D 21C0                    	and	ax, ax
  3204                                  	;jz	_crlf_exit ; 0 = none or not a valid input
  3205 00000C4F 0F8480F7                	jz	A_42 ; 25/02/2019
  3206                                  
  3207                                  	;or	ah, ah
  3208                                  	;jz	short B_03
  3209                                  
  3210                                  	; 23/02/2019
  3211 00000C53 80FC04                  	cmp	ah, 4  ; user's partition type input ?
  3212 00000C56 7505                    	jne	short B_03 ; no
  3213                                  
  3214                                  	; 29/10/2020
  3215                                  	; (ah = 0)
  3216                                  	;or	al, al
  3217                                  	;jz	A_42  ; invalid partition type input
  3218                                  	;	      ; or ESC key has been pressed
  3219                                  
  3220                                  	; user type input
  3221 00000C58 A2[CA69]                	mov	[pp_type_user], al
  3222 00000C5B 88E0                    	mov	al, ah ; mov al, 4
  3223                                  B_03:
  3224 00000C5D A2[C969]                	mov	[pp_type], al
  3225                                  
  3226                                  	; clear screen
  3227 00000C60 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3228 00000C63 CD10                    	int	10h
  3229                                  
  3230 00000C65 A0[C969]                	mov	al, [pp_type]
  3231 00000C68 3C01                    	cmp	al, 1
  3232 00000C6A 7705                    	ja	short B_04
  3233                                  
  3234 00000C6C BE[FD44]                	mov	si,  msg_create_dos_partition_h ; header
  3235 00000C6F EB70                    	jmp	short B_09
  3236                                  B_04:
  3237 00000C71 3C05                    	cmp	al, 5
  3238 00000C73 7269                    	jb	short B_08
  3239                                  	;ja	short B_07
  3240 00000C75 7741                    	ja	short B_58 ; 26/10/2020
  3241                                  
  3242                                  	; 23/02/2019
  3243 00000C77 BE[F245]                	mov	si, msg_create_ext_partition_h
  3244 00000C7A E82F0D                  	call	print_msg
  3245                                  
  3246                                  	; 24/02/2019
  3247 00000C7D 803E[CD6C]00            	cmp	byte [epnumber], 0
  3248 00000C82 7613                    	jna	short B_05
  3249                                  
  3250 00000C84 BE[C55B]                	mov	si, msg_ext_partition_exists
  3251 00000C87 E8220D                  	call 	print_msg
  3252                                  
  3253 00000C8A BE[B452]                	mov	si, msg_press_any_key
  3254 00000C8D E81C0D                  	call	print_msg
  3255                                  
  3256 00000C90 30E4                    	xor	ah, ah
  3257 00000C92 CD16                    	int	16h
  3258                                  
  3259 00000C94 E93CF7                  	jmp	A_42
  3260                                  B_05:
  3261 00000C97 803E[CB6C]00            	cmp	byte [ppcount], 0  ; primary partition count
  3262 00000C9C 7746                    	ja	short B_10
  3263                                  
  3264                                  	; 09/02/2019
  3265 00000C9E BE[794C]                	mov	si, msg_ext_partition_error
  3266 00000CA1 E8080D                  	call	print_msg
  3267                                  B_06:	
  3268 00000CA4 BE[B452]                	mov	si, msg_press_any_key
  3269 00000CA7 E8020D                  	call	print_msg
  3270                                  
  3271 00000CAA 30E4                    	xor	ah, ah
  3272 00000CAC CD16                    	int	16h
  3273                                  
  3274 00000CAE C606[C969]01            	mov	byte [pp_type], 1
  3275                                  
  3276 00000CB3 E8EFFA                  	call	cpi_2 ; 15/02/2019
  3277 00000CB6 EB95                    	jmp	short B_02
  3278                                  
  3279                                  B_58:
  3280                                  	; 26/10/2020
  3281 00000CB8 803E[2A65]80            	cmp	byte [DrvNum], 80h ; hd0 ?
  3282 00000CBD 7707                    	ja	short B_59 ; Do not check primary dos partition count
  3283                                  	; The second hard disk may contain extended partition without
  3284                                  	; a primary dos partition
  3285 00000CBF 803E[CB6C]00            	cmp	byte [ppcount], 0  ; primary dos partition count
  3286 00000CC4 760A                    	jna	short B_07
  3287                                  B_59:
  3288 00000CC6 803E[CD6C]00            	cmp	byte [epnumber], 0
  3289                                  			; is there an extended partition ?
  3290 00000CCB 7603                    	jna	short B_07 ; no
  3291 00000CCD E9CDF7                  	jmp	create_logical_drives
  3292                                  B_07:
  3293 00000CD0 BE[E746]                	mov	si, msg_create_logical_drive_h
  3294 00000CD3 E8D60C                  	call	print_msg
  3295                                  
  3296 00000CD6 BE[B84C]                	mov	si, msg_logical_drive_error
  3297 00000CD9 E8D00C                  	call	print_msg
  3298 00000CDC EBC6                    	jmp	short B_06
  3299                                  
  3300                                  ;	mov	si, msg_use_entire_ep_space
  3301                                  ;	jmp	short B_12
  3302                                  	
  3303                                  B_08:
  3304 00000CDE BE[DC47]                	mov	si, msg_create_nondos_partition_h
  3305                                  B_09:
  3306 00000CE1 E8C80C                  	call	print_msg
  3307                                  B_10:
  3308                                  	; 15/02/2019
  3309                                  	;cmp	byte [newdisk], 0
  3310                                  	;ja	short B_11
  3311                                  
  3312 00000CE4 803E[CA6C]00            	cmp	byte [pcount], 0 ; (valid) partition count
  3313 00000CE9 7605                    	jna	short B_11
  3314                                  
  3315 00000CEB BE[114B]                	mov	si, msg_use_all_space
  3316 00000CEE EB03                    	jmp	short B_12
  3317                                  B_11:
  3318 00000CF0 BE[EA4A]                	mov	si, msg_use_whole_disk ; partition size: whole disk
  3319                                  B_12:
  3320 00000CF3 E8B60C                  	call	print_msg
  3321                                  B_13:
  3322 00000CF6 30E4                    	xor	ah, ah
  3323 00000CF8 CD16                    	int	16h
  3324                                  
  3325 00000CFA 3C1B                    	cmp	al, 27 ; ESCAPE key
  3326                                  	;;je	_crlf_exit
  3327 00000CFC 0F84D3F6                	je	A_42 ; 25/02/2019
  3328 00000D00 24DF                    	and	al, 0DFh
  3329 00000D02 3C4E                    	cmp	al, 'N'
  3330 00000D04 740D                    	je	short B_14  ;02/03/2019
  3331 00000D06 3C59                    	cmp	al, 'Y'
  3332 00000D08 75EC                    	jne	short B_13
  3333                                  	
  3334 00000D0A FE06[C869]              	inc	byte [wholedisk]
  3335                                  	
  3336                                  	; 02/03/2019
  3337 00000D0E BE[9259]                	mov	si, _msg_YES
  3338                                  	;call	print_msg
  3339 00000D11 EB03                    	jmp	short B_15
  3340                                  B_14:
  3341 00000D13 BE[9859]                	mov	si, _msg_NO
  3342                                  B_15:	; 06/03/2019
  3343 00000D16 E8930C                  	call	print_msg
  3344                                  
  3345                                  	; 15/02/2019
  3346 00000D19 29DB                    	sub	bx, bx
  3347                                  	;cmp	byte [newdisk], bl ; 0
  3348                                  	;ja	short B_16 ; 23/02/2019
  3349                                  	; 19/10/2020
  3350                                  	;cmp	byte [pcount], 0
  3351                                  	; 03/11/2020
  3352 00000D1B 381E[CA6C]              	cmp	byte [pcount], bl ; 0
  3353 00000D1F 7608                    	jna	short B_16 ; [pcount] = 0 (newdisk, empty pt)
  3354 00000D21 381E[C869]              	cmp	byte [wholedisk], bl ; 0
  3355 00000D25 0F87FE00                	ja	B_27 ; 23/02/2019
  3356                                  B_16:
  3357                                  	; 08/02/2019
  3358                                  	;;sub	bx, bx
  3359                                  	;mov	ax, [total_sectors]
  3360                                  	;mov	dx, [total_sectors+2]
  3361                                  	;sub	ax, [sectors]
  3362                                  	;sbb	dx, bx ; sbb dx, 0
  3363                                  	;
  3364                                  	;mov	[pp_Sectors], ax   ; = [total_sectors] - [sectors]
  3365                                  	;mov	[pp_Sectors+2], dx ; = [total_sectors+2] - carry bit
  3366                                  	; 21/03/2021
  3367 00000D29 66A1[2E65]              	mov	eax, [total_sectors]
  3368 00000D2D 660FB716[9E3C]          	movzx	edx, word [sectors]
  3369 00000D33 6629D0                  	sub	eax, edx
  3370 00000D36 66A3[C469]              	mov	[pp_Sectors], eax  ; = [total_sectors] - [sectors]
  3371                                  B_17:
  3372 00000D3A 381E[C869]              	cmp	byte [wholedisk], bl ; 0
  3373 00000D3E 0F87E900                	ja	B_28 ; 09/02/2019
  3374                                  B_18:
  3375                                  	; clear screen
  3376 00000D42 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3377 00000D45 CD10                    	int	10h
  3378                                  
  3379                                  	; 04/11/2020
  3380 00000D47 803E[C969]01            	cmp	byte [pp_type], 1 ; primary dos partition ?
  3381 00000D4C 7405                    	je	short B_61
  3382                                  	; "Create Partition"
  3383 00000D4E BE[5242]                	mov	si, msg_create_partition_h
  3384 00000D51 EB03                    	jmp	short B_62
  3385                                  B_61:
  3386                                  	; "Create DOS partition"
  3387 00000D53 BE[FD44]                	mov	si, msg_create_dos_partition_h ; header
  3388                                  B_62:
  3389 00000D56 E8530C                  	call	print_msg
  3390 00000D59 BE[8E49]                	mov	si, msg_create_trdos_partition_s ; size options
  3391 00000D5C E84D0C                  	call	print_msg	
  3392                                  B_19:	
  3393 00000D5F 30E4                    	xor	ah, ah
  3394 00000D61 CD16                    	int	16h
  3395                                  
  3396                                  	; 24/02/2019
  3397 00000D63 3C1B                    	cmp	al, 27	; ESCAPE key
  3398 00000D65 0F846AF6                	je	A_42	; Cancel
  3399                                  
  3400 00000D69 3C20                    	cmp	al, 32	; SPACE key
  3401 00000D6B 751E                    	jne	short B_21
  3402                                  
  3403                                  		; Entire space
  3404                                  	;mov	ax, [pp_Sectors]
  3405                                  	;mov	dx, [pp_Sectors+2]
  3406                                  	; 15/03/2021
  3407 00000D6D 66A1[C469]              	mov	eax, [pp_Sectors]
  3408                                  
  3409 00000D71 C606[C869]01            	mov 	byte [wholedisk], 1 ; 09/02/2019
  3410 00000D76 EB55                    	jmp	short B_23
  3411                                  
  3412                                  B_60:	; 31/10/2020
  3413 00000D78 75C8                    	jnz	short B_18  ; ESCape (return to options menu)
  3414                                  	; partition size input is ZERO !
  3415                                  B_20:
  3416                                  	; ZERO partition size message
  3417 00000D7A BE[A557]                	mov	si, msg_zero_partition_size
  3418 00000D7D E82C0C                  	call	print_msg
  3419                                  	
  3420 00000D80 30E4                    	xor	ah, ah
  3421 00000D82 CD16                    	int	16h
  3422 00000D84 3C1B                    	cmp	al, 27 ; ESCAPE key
  3423 00000D86 75BA                    	jne	short B_18 ; Retry
  3424                                  
  3425                                  	; 19/10/2020
  3426 00000D88 E9E4F9                  	jmp	_crlf_exit ; exit
  3427                                  
  3428                                  B_21:
  3429 00000D8B C606[D669]25            	mov	byte [pSize_unit], '%'
  3430 00000D90 3C25                    	cmp	al, '%'
  3431 00000D92 7422                    	je	short B_22
  3432 00000D94 C606[D669]53            	mov	byte [pSize_unit], 'S'
  3433 00000D99 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  3434 00000D9B 7419                    	je	short B_22
  3435 00000D9D 24DF                    	and	al, 0DFh
  3436 00000D9F 3C53                    	cmp	al, 'S'
  3437 00000DA1 7413                    	je	short B_22
  3438 00000DA3 A2[D669]                	mov	[pSize_unit], al
  3439 00000DA6 3C4B                    	cmp	al, 'K'
  3440 00000DA8 740C                    	je	short B_22
  3441 00000DAA 3C4D                    	cmp	al, 'M'
  3442 00000DAC 7408                    	je	short B_22
  3443 00000DAE 3C47                    	cmp	al, 'G'
  3444 00000DB0 7404                    	je	short B_22
  3445 00000DB2 3C43                    	cmp	al, 'C'
  3446 00000DB4 75A9                    	jne	short B_19
  3447                                  B_22:
  3448 00000DB6 C606[0B61]73            	mov	byte [msg_sectors_crlf_s], 's' ; " sectors"
  3449                                  
  3450 00000DBB E85C0E                  	call	partition_size_input
  3451                                  	;jc	_crlf_exit ; exit if partition size input is 0
  3452                                  	;jc	short B_20
  3453                                  	; 29/10/2020
  3454                                  	;jnc	short B_60
  3455                                  	;jz	short B_20 ; partition size input is ZERO !
  3456                                  	;jmp	short B_18 ; ESCape (return to options menu)
  3457                                  	; 31/10/2020
  3458 00000DBE 72B8                    	jc	short B_60 ; ESC or zero partition size
  3459                                  ;B_60:
  3460                                  	; 13/03/2021
  3461                                  	;and	bx, bx ; bx_dx_ax = partition size
  3462                                  	;;jnz	short B_29
  3463                                  	;; 23/02/2019 
  3464                                  	;jnz	short B_24 ; invalid! (use maximum available sectors)
  3465                                  	;; 08/02/2019
  3466                                  	;or	dx, dx
  3467                                  	;jnz	short B_23 ; proper size (for now)
  3468                                  	
  3469                                  	; 13/03/2021
  3470                                  	;or	edx, edx
  3471                                  	;jnz	short B_24 ; invalid! (use maximum available sectors)
  3472                                  
  3473                                  	;mov	bx, [min_sectors] ; minimum sectors
  3474                                  	;cmp	bx, ax
  3475                                  	;jna	short B_23 ; proper size (for now)
  3476                                  	; 13/03/2021
  3477 00000DC0 668B16[EC69]            	mov	edx, [min_sectors]
  3478 00000DC5 6639D0                  	cmp	eax, edx
  3479 00000DC8 7303                    	jnb	short B_23 ; proper size (for now)
  3480                                  	
  3481                                  	; invalid! (use minimum sectors or sectors per cylinder)
  3482                                  	;mov	ax, bx
  3483                                  	; 13/03/2021
  3484 00000DCA 6689D0                  	mov	eax, edx
  3485                                  B_23:
  3486                                  	; 09/02/2019
  3487                                  	; save dx,ax
  3488                                  	;mov	[ppn_Sectors+2], dx 
  3489                                  	;mov	[ppn_Sectors], ax
  3490                                  	; 13/03/2021
  3491 00000DCD 66A3[F869]              	mov	[ppn_Sectors], eax
  3492                                  
  3493                                  	; write partition size
  3494                                  	;push	dx
  3495                                  	;push	ax
  3496                                  	; 06/11/2020
  3497 00000DD1 BE[E369]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  3498 00000DD4 E88E0C                  	call	bin_to_decimal
  3499                                  	; ds:si = beginning of decimal number text
  3500 00000DD7 E8D20B                  	call	print_msg
  3501 00000DDA BE[0461]                	mov	si, msg_sectors_crlf
  3502 00000DDD E8CC0B                  	call	print_msg
  3503                                  	;pop	ax
  3504                                  	;pop	dx
  3505                                  
  3506 00000DE0 803E[C869]00            	cmp	byte [wholedisk], 0
  3507 00000DE5 7748                    	ja	short B_29 ; 09/02/2019
  3508                                  
  3509                                  	; 15/03/2021
  3510                                  	;sub	eax, eax ; no need to clear hw of eax here
  3511                                  
  3512                                  	; restore ax,dx
  3513                                  	;mov	ax, [ppn_Sectors]
  3514                                  	;mov	dx, [ppn_Sectors+2]
  3515                                  
  3516                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3517                                  ; select whole disk
  3518                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3519                                  
  3520                                  	; 15/03/2021
  3521 00000DE7 66A1[F869]              	mov	eax, [ppn_Sectors]
  3522                                  
  3523                                  	; select whole disk 
  3524                                  	;   if partition size > disk size
  3525                                  	;cmp	dx, [pp_Sectors+2]
  3526                                  	;ja	short B_24
  3527                                  	;jb	short B_29
  3528                                  	;cmp	ax, [pp_Sectors]
  3529                                  	;jna	short B_29
  3530                                  	; 15/03/2021
  3531 00000DEB 663B06[C469]            	cmp	eax, [pp_Sectors]
  3532 00000DF0 763D                    	jna	short B_29
  3533                                  B_24:
  3534                                  	;cmp	byte [newdisk], 0
  3535                                  	;jna	short B_30
  3536                                  	; 19/10/2020
  3537 00000DF2 803E[CA6C]00            	cmp	byte [pcount], 0
  3538 00000DF7 775B                    	ja	short B_30
  3539                                  
  3540                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3541                                  ; "use whole disk or go to back" question
  3542                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3543                                  
  3544 00000DF9 BE[0F4C]                	mov	si, msg_partition_size_overs
  3545                                  B_25:
  3546 00000DFC E8AD0B                  	call	print_msg
  3547                                  B_26:
  3548 00000DFF 30E4                    	xor	ah, ah
  3549 00000E01 CD16                    	int	16h
  3550                                  	
  3551 00000E03 3C1B                    	cmp	al, 27 ; ESCAPE key
  3552                                  	;je	B_01
  3553 00000E05 0F8439FF                	je	B_18 ; 09/02/2019
  3554 00000E09 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  3555 00000E0B 75F2                    	jne	short B_26
  3556                                  
  3557 00000E0D FE06[C869]              	inc	byte [wholedisk]
  3558                                  
  3559                                  	; 24/02/2019
  3560                                  	;cmp	byte [newdisk], 0
  3561                                  	;ja	short B_27
  3562 00000E11 803E[CA6C]00            	cmp	byte [pcount], 0  ; (valid) partition count
  3563 00000E16 760F                    	jna	short B_27 ; no
  3564                                  
  3565 00000E18 8B1E[946D]              	mov	bx, [c_fspc_offset]
  3566                                  	;mov	ax, [free_space.sectors_unused+bx]
  3567                                  	;mov	dx, [free_space.sectors_unused+bx+2]
  3568                                  	;mov	[pp_Sectors], ax
  3569                                  	;mov	[pp_Sectors+2], dx
  3570                                  	; 15/03/2021
  3571 00000E1C 668B87[326D]            	mov	eax, [free_space.sectors_unused+bx]
  3572 00000E21 66A3[C469]              	mov	[pp_Sectors], eax
  3573                                  
  3574 00000E25 EB04                    	jmp	short B_28 
  3575                                  B_27:
  3576                                  	; 09/02/2019
  3577                                  	;mov	dx, [pp_Sectors+2]
  3578                                  	;mov	ax, [pp_Sectors]
  3579                                  	; 15/03/2021
  3580 00000E27 66A1[C469]              	mov	eax, [pp_Sectors]
  3581                                  B_28:
  3582                                  	;mov	[ppn_Sectors+2], dx
  3583                                  	;mov	[ppn_Sectors], ax
  3584                                  	; 15/03/2021
  3585 00000E2B 66A3[F869]              	mov	[ppn_Sectors], eax
  3586                                  B_29:
  3587 00000E2F 803E[C969]05            	cmp	byte [pp_type], 5
  3588 00000E34 0F852C01                	jne	B_51
  3589                                  
  3590 00000E38 803E[CB6C]00            	cmp	byte [ppcount], 0  ; primary partition count
  3591 00000E3D 0F87C700                	ja	B_45
  3592                                  
  3593 00000E41 BE[794C]                	mov	si, msg_ext_partition_error
  3594 00000E44 E8650B                  	call	print_msg
  3595 00000E47 BE[F24B]                	mov	si, msg_any_key_to_retry
  3596 00000E4A E85F0B                  	call	print_msg
  3597                                  
  3598                                  	; 09/02/2019
  3599 00000E4D 30E4                    	xor	ah, ah
  3600 00000E4F CD16                    	int	16h
  3601                                  
  3602                                  	;jmp	B_01
  3603 00000E51 E951F9                  	jmp	cpi_2
  3604                                  
  3605                                  B_30:
  3606                                  	; clear screen
  3607 00000E54 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3608 00000E57 CD10                    	int	10h
  3609                                  
  3610 00000E59 BE[FD44]                	mov	si, msg_create_dos_partition_h ; header
  3611 00000E5C E84D0B                  	call	print_msg
  3612                                  
  3613 00000E5F BE[B15A]                	mov	si, msg_partition_size_limit
  3614 00000E62 E8470B                  	call	print_msg
  3615                                  
  3616 00000E65 8B1E[946D]              	mov	bx, [c_fspc_offset]
  3617                                  
  3618 00000E69 803E[D669]53            	cmp	byte [pSize_unit], 'S'
  3619 00000E6E 7415                    	je	short B_31
  3620 00000E70 803E[D669]4B            	cmp	byte [pSize_unit], 'K'
  3621 00000E75 740E                    	je	short B_31
  3622                                  
  3623 00000E77 803E[D669]25            	cmp	byte [pSize_unit], '%'
  3624 00000E7C 746D                    	je	short B_41
  3625                                  
  3626 00000E7E 803E[D669]43            	cmp	byte [pSize_unit], 'C'
  3627 00000E83 747D                    	je	B_44
  3628                                  B_31:
  3629                                  	; 'S', 'K'
  3630 00000E85 81C3[326D]              	add	bx, free_space.sectors_unused
  3631                                  	;mov	ax, [bx]
  3632                                  	;mov	dx, [bx+2]
  3633                                  B_42:
  3634                                  	; 15/03/2021	
  3635 00000E89 668B07                  	mov	eax, [bx]
  3636 00000E8C 6631D2                  	xor	edx, edx
  3637 00000E8F 6631C9                  	xor	ecx, ecx
  3638 00000E92 B10A                    	mov	cl, 10 
  3639                                  	
  3640                                  	;mov	cx, 10
  3641 00000E94 89E5                    	mov	bp, sp
  3642                                  ;B_32:
  3643                                  	;call	div32
  3644                                  	;push	bx
  3645                                  	;or	dx, dx
  3646                                  	;jnz	short B_32
  3647                                  	;cmp	ax, 9
  3648                                  	;ja	short B_32
  3649                                  B_32:
  3650                                  	; 15/03/2021
  3651 00000E96 66F7F1                  	div	ecx
  3652 00000E99 52                      	push	dx
  3653 00000E9A 6683F809                	cmp	eax, 9
  3654 00000E9E 7604                    	jna	short B_33
  3655 00000EA0 28D2                    	sub	dl, dl
  3656                                  	; edx = 0
  3657 00000EA2 EBF2                    	jmp	short B_32
  3658                                  B_33:
  3659 00000EA4 BB0700                  	mov	bx, 07h
  3660                                  	;or	ax, ax
  3661                                  	;jnz	short B_35
  3662                                  	; 15/03/2021
  3663 00000EA7 08C0                    	or	al, al
  3664 00000EA9 7501                    	jnz	short B_35
  3665                                  B_34:
  3666 00000EAB 58                      	pop	ax
  3667                                  B_35:
  3668 00000EAC 0430                    	add	al, '0'
  3669                                  B_36:
  3670 00000EAE B40E                    	mov	ah, 0Eh
  3671                                  	;mov	bx, 07h
  3672 00000EB0 CD10                    	int	10h	; write character (as tty)
  3673                                  
  3674 00000EB2 39EC                    	cmp	sp, bp
  3675 00000EB4 72F5                    	jb	short B_34
  3676                                  
  3677 00000EB6 803E[D669]53            	cmp	byte [pSize_unit], 'S'
  3678 00000EBB 7422                    	je	short B_38
  3679 00000EBD 803E[D669]4B            	cmp	byte [pSize_unit], 'K'
  3680 00000EC2 741B                    	je	short B_38
  3681                                  
  3682 00000EC4 803E[D669]25            	cmp	byte [pSize_unit], '%'
  3683 00000EC9 7508                    	jne	short B_37
  3684                                  
  3685                                  	; 24/02/2019
  3686 00000ECB 3C25                    	cmp	al, '%'
  3687 00000ECD 7416                    	je	short B_40
  3688 00000ECF B025                    	mov	al, '%'
  3689 00000ED1 EBDB                    	jmp	short B_36 
  3690                                  B_37:
  3691 00000ED3 803E[D669]43            	cmp	byte [pSize_unit], 'C'
  3692 00000ED8 7505                    	jne	short B_38
  3693                                  
  3694 00000EDA BE[4D5B]                	mov	si, msg_cylinders
  3695 00000EDD EB03                    	jmp	short B_39
  3696                                  B_38:
  3697 00000EDF BE[585B]                	mov	si, msg_sectors
  3698                                  B_39:
  3699 00000EE2 E8C70A                  	call	print_msg
  3700                                  B_40:
  3701 00000EE5 BE[FE5A]                	mov	si, msg_partition_size_limit_r
  3702                                  	;call	print_msg
  3703                                  
  3704 00000EE8 E911FF                  	jmp	B_25
  3705                                  
  3706                                  B_41:
  3707                                  	; '%'
  3708 00000EEB 81C3[3A6D]              	add	bx, free_space.percent_unused
  3709 00000EEF 8B07                    	mov	ax, [bx]
  3710                                  ;B_42:	
  3711 00000EF1 89E5                    	mov	bp, sp
  3712 00000EF3 B90A00                  	mov	cx, 10
  3713                                  B_43:	
  3714 00000EF6 31D2                    	xor	dx, dx
  3715 00000EF8 F7F1                    	div	cx
  3716 00000EFA 52                      	push	dx
  3717 00000EFB 83F809                  	cmp	ax, 9
  3718 00000EFE 77F6                    	ja	short B_43
  3719 00000F00 EBA2                    	jmp	short B_33
  3720                                  B_44:
  3721                                  	; 'C'
  3722 00000F02 81C3[266D]              	add	bx, free_space.space
  3723                                  	;mov	ax, [bx]
  3724                                  	;jmp	short B_42
  3725                                  	; 15/03/2021
  3726 00000F06 EB81                    	jmp	short B_42
  3727                                  
  3728                                  B_45:
  3729                                  	; 23/02/2019
  3730 00000F08 8B1E[946D]              	mov	bx, [c_fspc_offset]
  3731                                  	;mov	ax, [bx+free_space.start]
  3732                                  	; 15/03/2021
  3733 00000F0C 668B87[2A6D]            	mov	eax, [bx+free_space.start]
  3734                                  
  3735                                  	; set free space start cylinder to 1 if it is 0
  3736                                  	;or	ax, ax
  3737                                  	;jnz	short B_46
  3738                                  	; 15/03/2021
  3739 00000F11 6609C0                  	or	eax, eax
  3740 00000F14 7510                    	jnz	short B_46
  3741                                  
  3742 00000F16 B005                    	mov	al, 5	; Get free space for extended partition
  3743 00000F18 E8DA13                  	call	find_part_free_space
  3744                                  
  3745 00000F1B 891E[946D]              	mov	[c_fspc_offset], bx
  3746                                  
  3747                                  	; 19/10/2020
  3748                                  	;and	cx, cx
  3749                                  	; 15/03/2021
  3750 00000F1F 6621C9                  	and	ecx, ecx
  3751 00000F22 0F8468F5                	jz	cp_3	; there is not free space on disk
  3752                                  B_46:
  3753                                  	; 15/03/2021
  3754                                  	;sub	eax, eax ; no need to clear hw of eax here
  3755                                  
  3756                                  	; 24/02/2019
  3757 00000F26 E81100                  	call	partition_size_fixup_x
  3758 00000F29 0F8227FF                	jc	B_30
  3759                                  
  3760                                  	; 16/02/2019
  3761 00000F2D E859FB                  	call	create_extended_partition 
  3762                                  			; must be called after 'find_part_free_space'.
  3763                                  	; 24/02/2019
  3764 00000F30 E8BD0F                  	call	show_selected_partition
  3765 00000F33 E9AE00                  	jmp	C_02
  3766                                  
  3767                                  partition_size_fixup:
  3768                                  	; 24/02/2019
  3769 00000F36 8B1E[946D]              	mov	bx, [c_fspc_offset]
  3770                                  partition_size_fixup_x:
  3771                                  	; 19/10/2020
  3772                                  
  3773                                  	;cmp	byte [newdisk], 0
  3774                                  	;ja	short B_50
  3775                                  
  3776 00000F3A 803E[CA6C]00            	cmp	byte [pcount], 0 ; (valid) partition count
  3777 00000F3F 7622                    	jna	short B_50
  3778                                  
  3779 00000F41 81C3[326D]              	add	bx, free_space.sectors_unused
  3780                                  	;mov	ax, [bx]
  3781                                  	;mov	dx, [bx+2]
  3782                                  	; 15/03/2021
  3783 00000F45 668B07                  	mov	eax, [bx]
  3784                                  
  3785                                  	;cmp	dx, [ppn_Sectors+2]
  3786                                  	;jb	short B_50 ; 24/02/2019
  3787                                  	;ja	short B_47
  3788                                  	;cmp	ax, [ppn_Sectors]
  3789                                  	;jb	short B_50 ; 24/02/2019
  3790                                  	;je	short B_49
  3791                                  	; 15/03/2021
  3792 00000F48 663B06[F869]            	cmp	eax, [ppn_Sectors]
  3793 00000F4D 7214                    	jb	short B_50
  3794 00000F4F 740E                    	je	short B_49
  3795                                  B_47:
  3796                                  	; 19/02/2019
  3797                                  	;mov	ax, [ppn_Sectors]
  3798                                  B_48:
  3799                                  	;mov	dx, [ppn_Sectors+2]
  3800                                  	; 15/03/2021
  3801 00000F51 66A1[F869]              	mov	eax, [ppn_Sectors] 
  3802                                  
  3803                                  	; 18/02/2019
  3804                                  
  3805                                  	; check for best fit
  3806                                  	; (leave max. available space to next time if 
  3807                                  	;  another space/gap fits to partition size request)
  3808                                  
  3809 00000F55 E8AC15                  	call	find_enough_free_sectors
  3810                                  		; CX = Free space index (0 to 4)
  3811                                  		; DX:AX = First available space which fits to request
  3812                                  	; 15/03/2021
  3813                                  	; eax = First available space which fits to request
  3814                                  	
  3815                                  	;mov	bx, cx
  3816                                  	;shl	bl, 4 ; * 16  ; * Free space structure size
  3817                                  	;mov	[c_fspc_offset], bx
  3818                                  	
  3819                                  	; 22/02/2019
  3820 00000F58 C0E104                  	shl	cl, 4
  3821 00000F5B 890E[946D]              	mov	[c_fspc_offset], cx
  3822                                  
  3823                                  	;add	bx, free_space.sectors_unused
  3824                                  	;mov	ax, [bx]
  3825                                  	;mov	dx, [bx+2]
  3826                                  B_49:		
  3827                                  	; Save max. available space
  3828                                  	;mov	[pp_Sectors], ax
  3829                                  	;mov	[pp_Sectors+2], dx
  3830                                  	; 15/03/2021
  3831 00000F5F 66A3[C469]              	mov	[pp_Sectors], eax
  3832                                  B_50:
  3833 00000F63 C3                      	retn
  3834                                  B_51:
  3835                                  	; 24/02/2019
  3836 00000F64 E8CFFF                  	call	partition_size_fixup
  3837 00000F67 0F82E9FE                	jc	B_30
  3838                                  
  3839                                  	; 16/02/2019
  3840                                  	; Force cylinder boundary alignment except
  3841                                  	;   sectors ('S') and kilobytes ('K') as sizing unit.
  3842                                  
  3843 00000F6B C606[966D]59            	mov	byte [cylinder_boundary], 'Y' ; Default
  3844                                  				; sizing unit is one of
  3845                                  				; 'cylinders','megabytes','gigabytes'
  3846                                  				; and boundary alignment is yes for them.
  3847 00000F70 A0[D669]                	mov	al, [pSize_unit]
  3848                                  
  3849                                  	;cmp	byte [pSize_unit], 'S' ; Sectors
  3850 00000F73 3C53                    	cmp	al, 'S'
  3851 00000F75 7404                    	je	short B_52
  3852                                  
  3853                                  	;cmp	byte [pSize_unit], 'K' ; Kilobytes
  3854 00000F77 3C4B                    	cmp	al, 'K'
  3855 00000F79 752F                    	jne	short B_56
  3856                                  B_52:
  3857                                  	; Sizing unit is one of 'sectors' and/or 'kilobytes'
  3858                                  	; and bound aligment will be applied if the answer will be yes.
  3859                                  
  3860 00000F7B BE[014D]                	mov	si, msg_cylinder_boundary_set
  3861 00000F7E E82B0A                  	call	print_msg
  3862                                  B_53:
  3863 00000F81 30E4                    	xor	ah, ah
  3864 00000F83 CD16                    	int	16h
  3865                                  	; Cylinder boundary adjusting
  3866 00000F85 3C0D                    	cmp	al, 13 ; ENTER key
  3867 00000F87 74F2                    	je	short B_52
  3868 00000F89 3C1B                    	cmp	al, 27 ; ESCAPE key
  3869 00000F8B 741A                    	je	short B_55	; Align end of the partition only
  3870                                  				; if start of the partition is aligned
  3871                                  				; or it starts at cyl 0, head 1, sect 17 or 63.
  3872                                  				; (End of the partition will be extended to
  3873                                  				; end sector of it's last cylinder if the size
  3874                                  				; will not over [pp_Sectors] value.)
  3875 00000F8D 24DF                    	and	al, 0DFh
  3876                                  
  3877                                  	; 22/02/2019
  3878 00000F8F 3C59                    	cmp	al, 'Y'
  3879 00000F91 7508                    	jne	short B_54
  3880                                  
  3881 00000F93 BE[9259]                	mov	si, _msg_YES
  3882 00000F96 E8130A                  	call	print_msg
  3883                                  
  3884                                  	;mov	al, 'Y'
  3885                                  	;jmp	short B_55
  3886 00000F99 EB0F                    	jmp	short B_56
  3887                                  B_54:
  3888 00000F9B 3C4E                    	cmp	al, 'N'
  3889 00000F9D 75E2                    	jne	short B_53
  3890                                  
  3891 00000F9F BE[9859]                	mov	si, _msg_NO
  3892 00000FA2 E8070A                  	call	print_msg
  3893                                  
  3894 00000FA5 B04E                    	mov	al, 'N'
  3895                                  		; do not align partition to cylinder boundary
  3896                                  B_55:
  3897 00000FA7 A2[966D]                	mov	[cylinder_boundary], al
  3898                                  B_56:
  3899 00000FAA E84CF8                  	call	create_primary_partition
  3900                                  	
  3901                                  	; 18/02/2019
  3902                                  	;cmp	byte [newdisk], 0
  3903                                  	;jna	short B_57
  3904                                  
  3905                                  	; 19/10/2020
  3906 00000FAD 803E[CA6C]00            	cmp	byte [pcount], 0
  3907 00000FB2 770D                    	ja	short B_57
  3908                                  
  3909                                  	;xor	ax, ax ; 0
  3910                                  	;xor	dx, dx ; 0
  3911                                  	; 09/03/2021
  3912 00000FB4 6631C0                  	xor	eax, eax
  3913                                  
  3914                                  	; DX_AX = Masterboot Sector = 0
  3915                                  
  3916 00000FB7 BB[D452]                	mov	bx, MasterBootBuff
  3917                                  
  3918                                  	; ES:BX = Sector Buffer
  3919                                  	; 09/03/2021
  3920                                  	; EAX = Masterboot Sector = 0
  3921                                  
  3922 00000FBA E84D0A                  	call	write_hd_sector
  3923 00000FBD 0F8298F7                	jc	print_error_code ; 18/10/2020
  3924                                  B_57:
  3925                                  	; DS:SI = Partition Table Entry address
  3926                                  	; 25/02/2019
  3927 00000FC1 8936[C06D]              	mov	[pte_address], si  ; save PTE address
  3928 00000FC5 E8280F                  	call	show_selected_partition
  3929                                  
  3930                                  	;jmp	C_01
  3931                                  
  3932                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3933                                  ; format question
  3934                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3935                                  
  3936                                  C_01:
  3937                                  	;mov	si, CRLF
  3938                                  	;call	print_msg
  3939                                  
  3940 00000FC8 C606[E569]01            	mov	byte [format_q], 1
  3941                                  
  3942 00000FCD A0[C969]                	mov	al, [pp_type]
  3943 00000FD0 3C01                    	cmp	al, 1		; FAT12 (CHS)
  3944 00000FD2 741D                    	je	short C_03
  3945 00000FD4 3C04                    	cmp	al, 4		; FAT16 CHS
  3946 00000FD6 7419                    	je	short C_03
  3947 00000FD8 3C06                    	cmp	al, 6		; FAT16 BIG CHS
  3948 00000FDA 7415                    	je	short C_03
  3949 00000FDC 3C0B                    	cmp	al, 0Bh		; FAT32 CHS
  3950 00000FDE 7411                    	je	short C_03
  3951 00000FE0 3CA1                    	cmp	al, 0A1h	; SINGLIX FS1
  3952 00000FE2 740D                    	je	short C_03
  3953                                  
  3954                                  	;cmp	al, 71h
  3955                                  	;je	short C_03	; RETRO UNIX 386
  3956                                  
  3957                                  	;dec	byte [format_q] ; 0
  3958                                  C_02:
  3959 00000FE4 C606[E569]00            	mov	byte [format_q], 0 ; 24/02/2019
  3960                                  
  3961                                  	; NON-DOS partition!
  3962                                  	; Ask for editing PT or exit (continue without formatting)
  3963 00000FE9 BE[8750]                	mov	si, msg_edit_or_exit
  3964 00000FEC E8BD09                  	call	print_msg
  3965 00000FEF EB06                    	jmp	short C_04
  3966                                  C_03:
  3967                                  	; Ask for formatting, editing PT or exit
  3968 00000FF1 BE[1850]                	mov	si, msg_format_stage
  3969 00000FF4 E8B509                  	call	print_msg
  3970                                  C_04:
  3971 00000FF7 BE[5850]                	mov	si, msg_partition_edit
  3972 00000FFA E8AF09                  	call	print_msg
  3973                                  C_05:
  3974 00000FFD 28E4                    	sub	ah, ah
  3975 00000FFF CD16                    	int	16h
  3976                                  
  3977 00001001 3C0D                    	cmp	al, 13
  3978 00001003 7434                    	je	short C_08
  3979                                  
  3980                                  	;; 07/03/2019
  3981 00001005 3C20                    	cmp	al, 20h ; SPACE
  3982                                  	;je	A_21 ; edit partition table option is selected
  3983 00001007 7503                    	jne	short C_06
  3984                                  	; 19/10/2020	
  3985 00001009 E9F1F1                  	jmp	A_21
  3986                                  C_06:
  3987 0000100C 3C1B                    	cmp	al, 27 ; ESCAPE
  3988 0000100E 75ED                    	jne	short C_05
  3989                                  	
  3990                                  	; 19/010/2020
  3991 00001010 E962F7                  	jmp	_exit
  3992                                  
  3993                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3994                                  ; save MBR then exit
  3995                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3996                                  
  3997                                  save_mbr_exit:
  3998                                  	; 24/02/2019
  3999 00001013 E8BC10                  	call	init_partition_table
  4000                                  	; 12/03/2021
  4001                                  	;xor	eax, eax
  4002 00001016 E88C15                  	call	display_partition_table
  4003                                  
  4004 00001019 BE[5852]                	mov	si, CRLF
  4005 0000101C E88D09                  	call	print_msg
  4006                                  
  4007 0000101F BE[0C51]                	mov	si, msg_writing_mbr
  4008 00001022 E88709                  	call	print_msg
  4009                                  
  4010                                  	;xor	ax, ax ; 0
  4011                                  	;xor	dx, dx ; 0
  4012                                  	; 09/03/2021
  4013 00001025 6631C0                  	xor	eax, eax
  4014                                  
  4015                                  	; DX_AX = Masterboot Sector = 0
  4016                                  
  4017 00001028 BB[D452]                	mov	bx, MasterBootBuff
  4018                                  
  4019                                  	; ES:BX = Sector Buffer
  4020                                  	; 09/03/2021
  4021                                  	; EAX = Masterboot Sector = 0
  4022                                  
  4023 0000102B E8DC09                  	call	write_hd_sector
  4024 0000102E 7303                    	jnc	short C_07
  4025 00001030 E926F7                  	jmp	print_error_code ; 18/10/2020
  4026                                  
  4027                                  C_07:
  4028 00001033 BE[5452]                	mov	si, Msg_OK
  4029                                  	;call	print_msg
  4030                                  	; 19/10/2020
  4031                                  	;jmp	_exit
  4032 00001036 E939F7                  	jmp	_p_exit
  4033                                  
  4034                                  C_08:
  4035 00001039 803E[E569]01            	cmp	byte [format_q], 1
  4036 0000103E 72D3                    	jb	short save_mbr_exit
  4037                                  
  4038                                  	; 25/02/2019
  4039                                  	; Write MBR without writing message
  4040                                  	
  4041                                  	; NOTE: This may be second time of MBR writing...
  4042                                  	;	but, if partition table is modified,
  4043                                  	;	we need to write MBR to disk, here.
  4044                                  	;
  4045                                  	; (Otherwise.. the last created partition would not be recorded.)
  4046                                  
  4047                                  	;xor	ax, ax ; 0
  4048                                  	;xor	dx, dx ; 0
  4049                                  	; 09/03/2021
  4050 00001040 6631C0                  	xor	eax, eax
  4051                                  
  4052                                  	; DX_AX = Masterboot Sector = 0
  4053                                  
  4054 00001043 BB[D452]                	mov	bx, MasterBootBuff
  4055                                  
  4056                                  	; ES:BX = Sector Buffer
  4057                                  	; 09/03/2021
  4058                                  	; EAX = Masterboot Sector = 0
  4059                                  
  4060 00001046 E8C109                  	call	write_hd_sector
  4061 00001049 0F820CF7                	jc	print_error_code ; 18/10/2020
  4062                                  
  4063                                  	;; clear screen
  4064                                  	;mov	ax, 3 ; set video mode to 03h (80x25 text)
  4065                                  	;int	10h
  4066                                  
  4067                                  	; 25/02/2019
  4068 0000104D 8B36[C06D]              	mov	si, [pte_address]
  4069                                  
  4070                                  	; 18/02/2019
  4071 00001051 E89C0E                  	call	show_selected_partition	
  4072                                  
  4073 00001054 A0[3F50]                	mov	al, [partition_num_chr]
  4074 00001057 A2[FF50]                	mov	[partition_num_txt], al
  4075                                  
  4076 0000105A BE[DD50]                	mov	si, msg_format_question
  4077 0000105D E84C09                  	call	print_msg
  4078                                  C_09:
  4079 00001060 30E4                    	xor	ah, ah
  4080 00001062 CD16                    	int	16h
  4081                                  
  4082 00001064 3C1B                    	cmp	al, 1Bh ; ESCAPE
  4083 00001066 74A4                    	je	short C_06
  4084                                  
  4085 00001068 24DF                    	and	al, 0DFh ; capitalization
  4086 0000106A 3C59                    	cmp	al, 'Y'
  4087 0000106C 740C                    	je	short C_10
  4088 0000106E 3C4E                    	cmp	al, 'N'
  4089 00001070 75EE                    	jne	short C_09
  4090 00001072 BE[9859]                	mov	si, _msg_NO 
  4091 00001075 E83409                  	call	print_msg
  4092                                  	;jmp	short C_06
  4093                                  	; 24/02/2019
  4094 00001078 EB99                    	jmp	short save_mbr_exit 
  4095                                  C_10:
  4096 0000107A BE[9259]                	mov	si, _msg_YES
  4097 0000107D E82C09                  	call	print_msg
  4098                                  
  4099                                  	; [pp_StartSector] = partition's start sector
  4100                                  	; [pp_Sectors] = partition size including start & end sector
  4101                                  	; [partition_num_chr] = partition number + '0'
  4102                                  	; [pp_type] = partition type (for TRDOS 386 boot sector)
  4103                                  
  4104 00001080 8926[3865]              	mov	[old_sp], sp
  4105                                  
  4106                                  	; 16/03/2021
  4107 00001084 6631D2                  	xor	edx, edx ; (this may not be necessary)
  4108 00001087 6631DB                  	xor	ebx, ebx ; (this may not be necessary)
  4109 0000108A 6631C9                  	xor	ecx, ecx ; (this may not be necessary)
  4110                                  
  4111 0000108D 8A16[C969]              	mov	dl, [pp_type]
  4112                                  	; DL = partition type (file system ID)
  4113                                  	;dec	dl
  4114                                  	;jz	FAT12_hd_format
  4115 00001091 80FA01                  	cmp	dl, 1 ; 14/09/2020 (BugFix)
  4116 00001094 0F862205                	jna	FAT12_hd_format
  4117                                  	;cmp	dl, 4
  4118                                  	;je	FAT16_hd_format
  4119                                  	;cmp	dl, 6
  4120                                  	;je	FAT16_hd_format
  4121 00001098 80FA0B                  	cmp	dl, 0Bh 
  4122 0000109B 0F826303                	jb	FAT16_hd_format
  4123                                  	;je	short FAT32_hd_format
  4124                                  	;cmp	dl, 0Ch ; 14/09/2020
  4125 0000109F 0F878406                	ja	SINGLIX_hd_format
  4126                                  
  4127                                  	;cmp	dl, 0A1h
  4128                                  	;je	SINGLIX_hd_format
  4129                                  	;jb	RUNIX386_hd_format ; dl = 071h
  4130                                  
  4131                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4132                                  ; FAT32 FORMATTING
  4133                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4134                                  	
  4135                                  	; 16/03/2021 (fdisk4.s)
  4136                                  	; 08/02/2019 (Modified for -only- FAT32 CHS partitions)
  4137                                  FAT32_hd_format:
  4138                                  	;mov	ax, 000Ch ; db 0Ch, 00h ; 'or al, 0'
  4139                                  	;cmp	dl, al ; 0Ch
  4140                                  	;je	short FAT32_lbAx_format
  4141                                  	;mov	ax, 0C00Bh ; db 0Bh, 0C0h ; 'or ax, ax'
  4142                                  ;FAT32_lba_format:
  4143                                  	; Put TRDOS 386 FAT32 partition magic word 
  4144                                  	; at offset 5Ah, in TRDOS386 FAT32 boot sector 0.
  4145 000010A3 BD[8C30]                	mov	bp, TRDOS_FAT32_hd_bs
  4146 000010A6 8D7E03                  	lea	di, [bp+3]
  4147 000010A9 BE[1061]                	mov	si, bs_oem_name
  4148 000010AC B90400                  	mov	cx, 4
  4149 000010AF F3A5                    	rep	movsw 
  4150                                  	;mov	[bp+5Ah], ax	; [loc_5A]
  4151 000010B1 C7465A0BC0              	mov	word [bp+5Ah], 0C00Bh ; 08/02/2019
  4152 000010B6 A1[9E3C]                	mov	ax, [sectors]
  4153 000010B9 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4154 000010BC A1[A03C]                	mov	ax, [heads]
  4155 000010BF 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4156                                  	; 16/03/2021
  4157                                  	;mov	ax, [pp_StartSector]
  4158                                  	;mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4159                                  	;mov	ax, [pp_StartSector+2]
  4160                                  	;mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4161 000010C2 66A1[C069]              	mov	eax, [pp_StartSector]
  4162 000010C6 6689461C                	mov	[bp+1Ch], eax	; [BPB_HiddSec]
  4163                                  	;;mov	ax, [pp_Sectors]
  4164                                  	;mov	ax, [ppn_Sectors] ; 16/02/2019
  4165                                  	;mov	[bp+20h], ax	; [BPB_TotSec32]
  4166                                  	;;mov	dx, [pp_Sectors+2]
  4167                                  	;mov	dx, [ppn_Sectors+2] ; 16/02/2019
  4168                                  	;mov	[bp+22h], dx	; [BPB_TotSec32+2]
  4169 000010CA 66A1[F869]              	mov	eax, [ppn_Sectors]
  4170 000010CE 66894620                	mov	[bp+20h], eax	; [BPB_TotSec32]
  4171                                  	
  4172                                  	; Sectors per cluster calculation
  4173                                  	; (According to MS FAT32 FS specification.)
  4174 000010D2 B108                    	mov	cl, 8  ; 8 sectors per cluster
  4175                                  	;cmp	dx, 8  ; >= 532480 sectors
  4176                                  	;ja	short FAT32_f_2 ; 8 sectors per cluster
  4177                                  	;jb	short FAT32_f_1 ; 1 sector per cluster
  4178                                  	;cmp	ax, 2000h ; dx_ax = (8*65536)+8192
  4179                                  	;jnb	short FAT32_f_2 ; 12/09/2020 (BugFix)
  4180                                  	; 16/03/2021
  4181 000010D4 663D00200800            	cmp	eax, 532480
  4182 000010DA 7302                    	jnb	short FAT32_f_2
  4183                                  FAT32_f_1:
  4184 000010DC B101                    	mov	cl, 1	; 1 sector per cluster
  4185                                  FAT32_f_2:
  4186 000010DE 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4187                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4188                                  	;mov	word [bp+0Eh], 32 ; [BPB_RsvdSecCnt]
  4189                                  
  4190                                  	; Calculating FAT size in sectors
  4191                                  	; (According to MS FAT32 FS Specification, 2000)
  4192                                  
  4193                                  	; DX_AX = partition (volume) size in sectors
  4194                                  	;sub	ax, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  4195                                  	;sbb	dx, 0
  4196                                  	;	; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  4197                                  	;	;	     		RootDirsectors)
  4198                                  	;	; RootDirSectors = 0 (for FAT32 FS)
  4199                                  	; 16/03/2021
  4200                                  	;xor	edx, edx
  4201 000010E1 8B560E                  	mov	dx, [bp+0Eh] ; [BPB_RsvdSecCnt] ; 2 bytes
  4202 000010E4 6629D0                  	sub	eax, edx ; sub eax, 32
  4203                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  4204                                  		;	     		RootDirsectors)
  4205                                  		; RootDirSectors = 0 (for FAT32 FS)
  4206                                  
  4207                                  	;mov	bx, cx ; ch = 0
  4208                                  	;shl	bx, 8 ; * 256
  4209                                  	;mov	cl, [bp+10h] ; [BPB_NumFATs] 
  4210                                  	;add	bx, cx	
  4211                                  	;	; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  4212                                  	;shr	bx, 1
  4213                                  	;	; TmpVal2 = TmpVal2/2
  4214                                  	;mov	cx, bx
  4215                                  	;dec	bx  ; TmpVal2-1
  4216                                  	;add	ax, bx
  4217                                  	;adc	dx, 0
  4218                                  	;call	div32
  4219                                  	;	; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  4220                                  	; DX_AX = FAT size in sectors
  4221                                  	; 16/03/2021
  4222 000010E7 88CE                    	mov	dh, cl ; * 256
  4223 000010E9 8A5610                  	mov	dl, [bp+10h] ; [BPB_NumFATs]
  4224                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  4225 000010EC D1EA                    	shr	dx, 1
  4226                                  		; TmpVal2 = TmpVal2/2
  4227 000010EE 6689D1                  	mov	ecx, edx
  4228 000010F1 4A                      	dec	dx ; TmpVal2-1
  4229 000010F2 6601D0                  	add	eax, edx
  4230                                  	;xor	edx, edx
  4231 000010F5 31D2                    	xor	dx, dx
  4232 000010F7 66F7F1                  	div	ecx
  4233                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  4234                                  	; EAX = FAT size in sectors
  4235                                  
  4236                                  	;mov	[bp+24h], ax	; [BPB_FATSz32]
  4237                                  	;mov	[bp+26h], dx	; [BPB_FATSz32+2]
  4238                                  	;; * 2
  4239                                  	;mov	bx, dx
  4240                                  	;add	ax, ax
  4241                                  	;adc	bx, dx
  4242                                  	;; BX_AX = [BPB_NumFATs] * [BPB_FATSz32]
  4243                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  4244                                  	;add	cx, ax
  4245                                  	;adc	bx, 0
  4246                                  	;; BX_CX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  4247                                  	;mov	ax, [bp+20h]	; [BPB_TotSec32]
  4248                                  	;mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  4249                                  	;sub	ax, cx
  4250                                  	;sbb	dx, bx
  4251                                  	;mov	[data_start], cx
  4252                                  	;mov	[data_start+2], bx
  4253                                  	;; DX_AX = Data sectors
  4254                                  	;mov	[data_sectors], ax
  4255                                  	;mov	[data_sectors+2], dx
  4256                                  	;mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4257                                  	;xor	ch, ch
  4258                                  	;call	div32 ; DX_AX/CX
  4259                                  	;; DX_AX = Count of clusters (rounded down)
  4260                                  	;mov	[cluster_count], ax
  4261                                  	;mov	[cluster_count+2], dx
  4262                                  	; 16/03/2021
  4263 000010FA 66894624                	mov	[bp+24h], eax	; [BPB_FATSz32]
  4264                                  	; * 2
  4265 000010FE 66D1E0                  	shl	eax, 1
  4266                                  	;add	eax, eax
  4267                                  	;EAX = [BPB_NumFATs] * [BPB_FATSz32] ; 2 * FATsz
  4268 00001101 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  4269 00001104 6601C1                  	add	ecx, eax
  4270                                  	;ECX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  4271 00001107 668B4620                	mov	eax, [bp+20h]	; [BPB_TotSec32]
  4272 0000110B 6629C8                  	sub	eax, ecx
  4273 0000110E 66890E[3A67]            	mov	[data_start], ecx
  4274                                  	;EAX = Data sectors
  4275 00001113 66A3[3E67]              	mov	[data_sectors], eax
  4276 00001117 660FB64E0D              	movzx	ecx, byte [bp+0Dh] ; [BPB_SecPerClus]
  4277 0000111C 6629D2                  	sub	edx, edx
  4278 0000111F 66F7F1                  	div	ecx
  4279                                  	;EAX = Count of clusters (rounded down)
  4280 00001122 66A3[4267]              	mov	[cluster_count], eax
  4281 00001126 30D2                    	xor	dl, dl
  4282                                  	
  4283 00001128 8D7E47                  	lea	di, [bp+71] ; [BS_VolLab]
  4284 0000112B E84B01                  	call	write_volume_name
  4285 0000112E 8D7643                  	lea	si, [bp+67] ; [BS_VolID]
  4286 00001131 E8A401                  	call	write_volume_serial
  4287 00001134 E8B802                  	call	write_cluster_count
  4288                                  
  4289 00001137 E82502                  	call	write_formatting_msg
  4290 0000113A B000                    	mov	al, 0
  4291 0000113C E88202                  	call	write_format_percent_x
  4292                                  
  4293                                  	;mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4294                                  	;mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4295                                  	;add	[data_start], ax
  4296                                  	;adc	[data_start+2], dx
  4297                                  	; 16/03/2021
  4298 0000113F 668B461C                	mov	eax, [bp+1Ch]	; [BPB_HiddSec]
  4299 00001143 660106[3A67]            	add	[data_start], eax 
  4300                                  FAT32_f_3:
  4301                                  	;; DX_AX = FAT32 Boot Sector address
  4302                                  	; 16/03/2021
  4303                                  	; EAX = FAT32 Boot Sector address
  4304 00001148 BB[8C30]                	mov	bx, TRDOS_FAT32_hd_bs
  4305                                  	; ES:BX = Boot Sector 1 Buffer
  4306 0000114B E8BC08                  	call	write_hd_sector
  4307 0000114E 0F828502                	jc	formatting_error
  4308 00001152 E83202                  	call	write_format_percent
  4309                                  	;add	ax, 1
  4310                                  	;adc	dx, 0
  4311                                  	; 16/03/2021
  4312 00001155 6640                    	inc	eax
  4313 00001157 BB[2663]                	mov	bx, HDFORMAT_FSINFO_BUFF
  4314                                  	; ES:BX = FS INFO Sector Buffer (= BS+1)
  4315 0000115A E8AD08                  	call	write_hd_sector
  4316 0000115D 0F827602                	jc	formatting_error
  4317 00001161 E82302                  	call	write_format_percent
  4318                                  	;add	ax, 1
  4319                                  	;adc	dx, 0
  4320                                  	; 16/03/2021
  4321 00001164 6640                    	inc	eax
  4322 00001166 BB[8C32]                	mov	bx, TRDOS_FAT32_hd_bs + 512
  4323                                  	; ES:BX = Boot Sector 2 Buffer
  4324 00001169 E89E08                  	call	write_hd_sector
  4325 0000116C 0F826702                	jc	formatting_error
  4326 00001170 E81402                  	call	write_format_percent
  4327 00001173 B90300                  	mov	cx, 3
  4328                                  FAT32_f_4:
  4329 00001176 51                      	push	cx
  4330                                  	;add	ax, 1
  4331                                  	;adc	dx, 0
  4332                                  	; 16/03/2021
  4333 00001177 6640                    	inc	eax
  4334 00001179 BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4335 0000117C E88B08                  	call	write_hd_sector
  4336 0000117F 0F825402                	jc	formatting_error
  4337 00001183 E80102                  	call	write_format_percent
  4338 00001186 59                      	pop	cx
  4339 00001187 FEC9                    	dec	cl
  4340 00001189 75EB                    	jnz	short FAT32_f_4
  4341                                  	;add	ax, 1
  4342                                  	;adc	dx, 0
  4343                                  	; 16/03/2021
  4344 0000118B 6640                    	inc	eax
  4345                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4346                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4347                                  	;add	cx, 12
  4348                                  	;adc	bx, 0
  4349                                  	; 16/03/2021
  4350 0000118D 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  4351 00001191 6683C20C                	add	edx, 12
  4352                                  	; write BACKUP sectors
  4353                                  	; (6,7,8 boot+fsi and 9,10,11 empty sectors)
  4354                                  	;cmp	dx, bx
  4355                                  	;jb	short FAT32_f_3
  4356                                  	;cmp	ax, cx
  4357                                  	;jb	short FAT32_f_3
  4358                                  	; 16/03/2021
  4359 00001195 6639D0                  	cmp	eax, edx
  4360 00001198 72AE                    	jb	short FAT32_f_3	
  4361                                  
  4362                                  	; write remain part of reserved sectors
  4363 0000119A 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt]
  4364 0000119D 83E90C                  	sub	cx, 12
  4365 000011A0 7614                    	jna	short FAT32_f_6
  4366                                  FAT32_f_5:
  4367 000011A2 51                      	push	cx
  4368 000011A3 BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4369 000011A6 E86108                  	call	write_hd_sector
  4370 000011A9 0F822A02                	jc	formatting_error
  4371 000011AD E8D701                  	call	write_format_percent
  4372                                  	;add	ax, 1
  4373                                  	;adc	dx, 0
  4374                                  	; 16/03/2021
  4375 000011B0 6640                    	inc	eax
  4376 000011B2 59                      	pop	cx
  4377 000011B3 49                      	dec	cx
  4378 000011B4 75EC                    	jnz	short FAT32_f_5
  4379                                  FAT32_f_6:
  4380                                  	; write FAT sectors
  4381                                  	;mov	cx, [data_start] ; lba/abs addr
  4382                                  	;mov	bx, [data_start+2] ; lba/abs addr
  4383                                  	;push	bx
  4384                                  	;push	cx
  4385                                  	; 16/03/2021
  4386 000011B6 668B16[3A67]            	mov	edx, [data_start]
  4387                                  	;push	edx ; *
  4388                                  	; eax = sector address
  4389 000011BB BB[3A65]                	mov	bx, HDFORMAT_FATBUFFER
  4390                                  	; ES:BX = FAT Sector Buffer
  4391 000011BE 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4392 000011C1 B5FF                    	mov	ch, 0FFh
  4393 000011C3 890F                    	mov	[bx], cx
  4394 000011C5 88E9                    	mov	cl, ch ; cx = 0FFFFh
  4395 000011C7 894F02                  	mov	[bx+2], cx
  4396 000011CA 894F04                  	mov	[bx+4], cx
  4397 000011CD 894F06                  	mov	[bx+6], cx
  4398                                  	; Root dir cluster number = 2
  4399                                  	; 0FFFFFFFh = end of cluster chain
  4400 000011D0 894F08                  	mov	[bx+8], cx  ; 0FFFFh
  4401 000011D3 80E50F                  	and	ch, 0Fh
  4402 000011D6 894F0A                  	mov	[bx+10], cx ; 0FFFh
  4403                                  	;inc	cx
  4404 000011D9 E82E08                  	call	write_hd_sector
  4405 000011DC 0F82F701                	jc	formatting_error
  4406 000011E0 E8A401                  	call	write_format_percent
  4407                                  	;mov	bx, HDFORMAT_FATBUFFER
  4408 000011E3 B90000                  	mov	cx, 0
  4409 000011E6 890F                    	mov	[bx], cx
  4410 000011E8 894F02                  	mov	[bx+2], cx
  4411 000011EB 894F04                  	mov	[bx+4], cx
  4412 000011EE 894F06                  	mov	[bx+6], cx
  4413 000011F1 894F08                  	mov	[bx+8], cx
  4414 000011F4 894F0A                  	mov	[bx+10], cx
  4415 000011F7 EB0D                    	jmp	short FAT32_f_8
  4416                                  FAT32_f_7:	
  4417                                  	;push	bx
  4418                                  	;push	cx
  4419                                  	; 16/03/2021
  4420                                  	;push	edx ; *
  4421 000011F9 BB[3A65]                	mov	bx, HDFORMAT_FATBUFFER
  4422 000011FC E80B08                  	call	write_hd_sector
  4423 000011FF 0F82D401                	jc	formatting_error
  4424 00001203 E88101                  	call	write_format_percent
  4425                                  FAT32_f_8:	
  4426                                  	;pop	cx
  4427                                  	;pop	bx
  4428                                  	;add	ax, 1
  4429                                  	;adc	dx, 0
  4430                                  	;cmp	dx, bx
  4431                                  	;jb	short FAT32_f_7
  4432                                  	;cmp	ax, cx
  4433                                  	;jb	short FAT32_f_7
  4434                                  	; 16/03/2021
  4435                                  	;pop	edx ; *
  4436 00001206 6640                    	inc	eax ; next sector
  4437 00001208 6639D0                  	cmp	eax, edx
  4438 0000120B 72EC                    	jb	short FAT32_f_7
  4439                                  	
  4440                                  	; write	root directory (1st cluster)
  4441                                  	; as empty sectors
  4442 0000120D 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4443 00001210 30ED                    	xor	ch, ch
  4444 00001212 290E[3E67]              	sub	[data_sectors], cx
  4445 00001216 831E[4067]00            	sbb	word [data_sectors+2], 0
  4446                                  FAT32_f_9:
  4447 0000121B 51                      	push	cx
  4448 0000121C BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4449 0000121F E8E807                  	call	write_hd_sector
  4450 00001222 0F82B101                	jc	formatting_error
  4451 00001226 E85E01                  	call	write_format_percent
  4452                                  	;add	ax, 1
  4453                                  	;adc	dx, 0
  4454                                  	; 16/03/2021
  4455 00001229 6640                    	inc	eax
  4456 0000122B 59                      	pop	cx
  4457 0000122C FEC9                    	dec	cl
  4458 0000122E 75EB                    	jnz	short FAT32_f_9
  4459                                  
  4460                                  	; write DATA sectors 
  4461                                  	; (after root directory 1st cluster)
  4462                                  	;mov	cx, [data_sectors]
  4463                                  	;mov	bx, [data_sectors+2] 
  4464                                  	;		; NOTE: Partition size must be >= 512 MB
  4465                                  	;		;	for FAT32 FS  ((BX >= 15))
  4466                                  	; 16/03/2021
  4467 00001230 668B16[3E67]            	mov	edx, [data_sectors]
  4468                                  FAT32_f_10:	
  4469                                  	;push	bx
  4470                                  	;push	cx
  4471                                  	; 16/03/2021
  4472                                  	;push	edx
  4473 00001235 BB[2661]                	mov	bx, HDFORMAT_SECBUFFER
  4474 00001238 E8CF07                  	call	write_hd_sector
  4475 0000123B 0F829801                	jc	formatting_error
  4476 0000123F E84501                  	call	write_format_percent
  4477                                  	;pop	edx
  4478                                  	;pop	cx
  4479                                  	;pop	bx
  4480                                  	;add	ax, 1
  4481                                  	;adc	dx, 0
  4482 00001242 6640                    	inc	eax
  4483                                  	;dec	cx
  4484                                  	;jnz	short FAT32_f_10
  4485                                  	;dec	bx
  4486                                  	;jnz	short FAT32_f_10
  4487                                  	; 16/03/2021
  4488 00001244 664A                    	dec	edx
  4489 00001246 75ED                    	jnz	short FAT32_f_10
  4490                                  
  4491                                  	; If there are, format remain sectors which are
  4492                                  	; at beyond of data clusters, with zero bytes.
  4493                                  	
  4494                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4495                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4496                                  	; 16/03/2021
  4497 00001248 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  4498                                  FAT16_f_18:	
  4499                                  	;add	cx, [bp+20h]	; [BPB_TotSec32]
  4500                                  	;adc	bx, [bp+22h]	; [BPB_TotSec32+2]
  4501                                  	; 16/03/2021
  4502 0000124C 66035620                	add	edx, [bp+20h]	; [BPB_TotSec32]
  4503                                  FAT16_f_19:
  4504                                  FAT12_f_8:
  4505                                  	; are there remain sectors (in partition) ?
  4506                                  	;sub	cx, ax
  4507                                  	;sbb	bx, dx
  4508                                  	; 11/02/2019
  4509                                  	; BX must be 0 (Because, 1 cluster <= 32KB. So, 
  4510                                  	;	        remain sectors must not be more than 32K)
  4511                                  	;jnz	short FAT32_f_12 ; There is a wrong thing !!!
  4512                                  	;			 ; If BX is not zero,	
  4513                                  	;			 ; it is better to skip this stage...)
  4514                                  	;or	cx, cx
  4515                                  	;jz	short FAT32_f_12 ; no.. 
  4516                                  	;			 ; (good! FAT contains all data sectors)
  4517                                  	; 16/03/2021
  4518 00001250 6629C2                  	sub	edx, eax
  4519 00001253 7612                    	jna	short FAT32_f_12
  4520                                  FAT32_f_11:
  4521                                  	;push	cx
  4522                                  	; 16/03/2021
  4523                                  	;push	dx ; edx <= 32K
  4524 00001255 BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4525 00001258 E8AF07                  	call	write_hd_sector
  4526 0000125B 0F827801                	jc	formatting_error
  4527 0000125F E82501                  	call	write_format_percent
  4528                                  	; 16/03/2021
  4529                                  	;pop	dx ; edx <= 32K
  4530                                  	;pop	cx
  4531                                  	;add	ax, 1
  4532                                  	;adc	dx, 0
  4533                                  	; 16/03/2021
  4534 00001262 6640                    	inc	eax
  4535                                  	;dec	cx
  4536 00001264 4A                      	dec	dx 
  4537 00001265 75EE                    	jnz	short FAT32_f_11
  4538                                  
  4539                                  FAT32_f_12:
  4540                                  SINGLIX_fs1_f_12:
  4541                                  	; End of FAT format routine...
  4542                                  end_of_formatting:
  4543 00001267 B064                    	mov	al, 100
  4544 00001269 E85501                  	call	write_format_percent_x
  4545                                  	;mov	si, CRLF
  4546                                  	;call	print_msg
  4547 0000126C BE[5452]                	mov	si, Msg_OK
  4548                                  	;call	print_msg
  4549                                  	;jmp	_exit
  4550                                  	; 19/10/2020
  4551 0000126F E900F5                  	jmp	_p_exit
  4552                                  
  4553                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4554                                  ; set & write volume name
  4555                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4556                                  
  4557                                  write_fs_volume_name:
  4558 00001272 C606[0F61]40            	mov	byte [vname_length], 64
  4559 00001277 EB05                    	jmp	short svn_fs
  4560                                  
  4561                                  write_volume_name:
  4562 00001279 C606[0F61]0B            	mov	byte [vname_length], 11
  4563                                  svn_fs:
  4564                                  	; DI = (BS) Volume Label address
  4565 0000127E BE[F651]                	mov	si, Msg_Volume_Name
  4566 00001281 E82807                  	call	print_msg
  4567                                  
  4568                                  	; get cursor position
  4569                                  	; bh = 0  ; video page
  4570 00001284 B403                    	mov     ah, 3 ; get cursor pos
  4571 00001286 CD10                    	int     10h
  4572 00001288 8916[9C51]              	mov	[Cursor_Pos], dx
  4573                                  
  4574 0000128C E80808                  	call	rw_char
  4575 0000128F 7207                    	jc	short svn_1
  4576                                  svn_0:
  4577 00001291 AC                      	lodsb
  4578 00001292 3C20                    	cmp	al, 20h
  4579 00001294 7706                    	ja	short svn_2
  4580 00001296 74F9                    	je	short svn_0
  4581                                  svn_1:
  4582 00001298 BE[1A61]                	mov	si, no_name
  4583 0000129B AC                      	lodsb
  4584                                  svn_2:
  4585                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
  4586                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
  4587 0000129C 89FB                    	mov	bx, di ; *
  4588 0000129E 30ED                    	xor	ch, ch
  4589 000012A0 8A0E[0F61]              	mov	cl, [vname_length] ; 11
  4590 000012A4 EB05                    	jmp	short svn_4
  4591                                  svn_3:
  4592 000012A6 AC                      	lodsb
  4593 000012A7 3C20                    	cmp	al, 20h
  4594 000012A9 7226                    	jb	short svn_6
  4595                                  svn_4:
  4596 000012AB AA                      	stosb
  4597 000012AC E2F8                    	loop	svn_3
  4598                                  svn_5:
  4599 000012AE 8A0E[0F61]              	mov	cl, [vname_length] ; 11
  4600 000012B2 89DE                    	mov	si, bx ; *
  4601 000012B4 BF[B551]                	mov	di, StrVolumeName
  4602 000012B7 F3A4                    	rep	movsb
  4603                                  	;mov	byte [di], 0
  4604                                  
  4605 000012B9 8B16[9C51]              	mov	dx, [Cursor_Pos]
  4606 000012BD BB0700                  	mov	bx, 7
  4607 000012C0 B402                    	mov	ah, 2
  4608 000012C2 CD10                    	int	10h  ; Set Cursor Position
  4609                                  
  4610 000012C4 BE[B551]                	mov	si, StrVolumeName
  4611 000012C7 E8E206                  	call	print_msg
  4612 000012CA BE[5852]                	mov	si, CRLF
  4613 000012CD E8DC06                  	call	print_msg
  4614 000012D0 C3                      	retn
  4615                                  svn_6:
  4616 000012D1 B020                    	mov	al, 20h
  4617                                  svn_7:
  4618 000012D3 AA                      	stosb
  4619 000012D4 E2FD                    	loop	svn_7
  4620 000012D6 EBD6                    	jmp	short svn_5
  4621                                  
  4622                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4623                                  ; set & write volume serial number (volume ID)
  4624                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4625                                  
  4626                                  write_volume_serial:
  4627                                  	; SI = (BS) Volume Serial Number (binary) address
  4628                                  
  4629                                  	;xor	ax, ax
  4630                                  	;int	1Ah			; get time of day
  4631                                  
  4632                                  	;mov	[si], dx
  4633                                  	;mov	[si+2], cx		; set unique volume ID
  4634                                  
  4635                                  	;mov	ah, 02h			; Return Current Time
  4636                                  	;int	1Ah
  4637                                  	;xchg	ch, cl
  4638                                  	;xchg	dh, dl
  4639                                  
  4640                                  	;add	cx, dx
  4641                                  	;add	[si+2], cx
  4642                                                 
  4643                                  	;mov	ah, 04h			; Return Current Date
  4644                                  	;int	1Ah
  4645                                  
  4646                                  	;xchg	ch,cl
  4647                                  	;xchg	dh,dl
  4648                                  
  4649                                  	;add	cx, dx
  4650                                  	;add	[si+2], cx
  4651                                  
  4652                                  	; According to Microsoft DOS 6.0 serial number
  4653                                  	; production method...
  4654                                  	; < Create unique 32 bit serial number >
  4655                                  
  4656                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
  4657                                  	; (20/04/1987)
  4658                                  	;
  4659                                  	;  Get date (INT 21h, AH=2Bh)
  4660                                  	;  Get time (INT 21h, AH=2Ch)
  4661                                  	;  Serial_ID+0 = DX reg date + DX reg time
  4662                                  	;  Serial_ID+2 = CX reg date + CX reg time
  4663                                  	;  Serial_Num_Low = Serial_ID+2
  4664                                  	;  Serial_Num_High = Serial_ID+0
  4665                                  
  4666 000012D8 B404                    	mov	ah, 04h		; Return Current Date
  4667 000012DA CD1A                    	int	1Ah
  4668                                  
  4669                                  	; DL = Day (BCD)	(20h)
  4670                                  	; DH = Month (BCD)	(12h)
  4671                                  	; CH = Century (BCD)	(20h)
  4672                                  	; CL = Year (BCD) 	(17h)
  4673                                  
  4674 000012DC 88D0                    	mov	al, dl
  4675 000012DE E87100                  	call	bcd_to_bin
  4676 000012E1 88C2                    	mov	dl, al 
  4677 000012E3 88F0                    	mov	al, dh
  4678 000012E5 E86A00                  	call	bcd_to_bin
  4679 000012E8 88C6                    	mov	dh, al 
  4680 000012EA 88C8                    	mov	al, cl
  4681 000012EC E86300                  	call	bcd_to_bin
  4682 000012EF 88C1                    	mov	cl, al 
  4683 000012F1 88E8                    	mov	al, ch
  4684 000012F3 E85C00                  	call	bcd_to_bin
  4685 000012F6 88C5                    	mov	ch, al
  4686                                  
  4687                                  	; DH = Month (1-10)
  4688                                  	; DL = Day (1-31)
  4689                                  	; CX = Year (1900-2099)
  4690                                  
  4691 000012F8 52                      	push	dx 
  4692 000012F9 51                      	push	cx
  4693                                  
  4694 000012FA B402                    	mov	ah, 02h		; Return Current Time
  4695 000012FC CD1A                    	int	1Ah
  4696                                  	
  4697                                  	; DH = Seconds (BCD)	(59h)
  4698                                  	; CL = Minutes (BCD)	(59h)
  4699                                  	; CH = Hours (BCD)	(23h)
  4700                                  	; DL = Daylight savings time option (1=yes)
  4701                                  
  4702 000012FE 88F0                    	mov	al, dh
  4703 00001300 E84F00                  	call	bcd_to_bin
  4704 00001303 88C6                    	mov	dh, al 
  4705 00001305 88C8                    	mov	al, cl
  4706 00001307 E84800                  	call	bcd_to_bin
  4707 0000130A 88C1                    	mov	cl, al 
  4708 0000130C 88E8                    	mov	al, ch
  4709 0000130E E84100                  	call	bcd_to_bin
  4710 00001311 88C5                    	mov	ch, al 
  4711                                  
  4712                                  	; CH = Hour (0-23)
  4713                                  	; CL = Minutes (0-59)
  4714                                  	; DH = Seconds (0-59)
  4715                                  	; ((DL = Hundredths (0-99) - MSDOS!))
  4716                                  	; DL = 0 or 1 (here!)
  4717                                  
  4718 00001313 89C8                    	mov	ax, cx
  4719 00001315 59                      	pop	cx
  4720 00001316 01C8                    	add	ax, cx
  4721                                  
  4722 00001318 894402                  	mov	[si+2], ax
  4723                                  
  4724 0000131B 89D0                    	mov	ax, dx
  4725 0000131D 5A                      	pop	dx
  4726 0000131E 01D0                    	add	ax, dx
  4727                                  
  4728 00001320 8904                    	mov	[si], ax
  4729                                  
  4730 00001322 30E4                    	xor	ah, ah		; Read time counter
  4731 00001324 CD1A                    	int	1Ah
  4732                                  
  4733                                  	; CX = High word of clock count
  4734                                  	; DX = Low word of clock count
  4735                                  	; AL = 0 if 24 hours has not passed, else 1
  4736                                  
  4737                                  	; NOTES: 
  4738                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
  4739                                  	;
  4740                                     	; Following formulas convert the clock count to
  4741                                          ; the time of day:
  4742                                   	;	Hour      = Clock / 65543 (1007h)
  4743                                  	;	Remainder = Clock MOD 65543
  4744                                   	;
  4745                                  	;	Minutes   = Remainder / 1092 (444h)
  4746                                  	;	Remainder = Remainder MOD 1092
  4747                                  	;
  4748                                  	;	Second    = Remainder / 18.21
  4749                                  	;	Remainder = Remainder MOD 18.21
  4750                                  	;
  4751                                  	;	Hundredths = CINT(Remainder * 100)
  4752                                  
  4753 00001326 0014                    	add	[si], dl
  4754                                  
  4755                                  	; SI = Volume serial number address (4 bytes)
  4756 00001328 8A04                    	mov	al, [si]
  4757 0000132A E85307                  	call	bin_to_hex
  4758 0000132D A3[2152]                	mov	[Vol_Serial2+2], ax
  4759 00001330 8A4401                  	mov	al, [si+1]
  4760 00001333 E84A07                  	call	bin_to_hex
  4761 00001336 A3[1F52]                	mov	[Vol_Serial2], ax
  4762 00001339 8A4402                  	mov	al, [si+2]
  4763 0000133C E84107                  	call	bin_to_hex
  4764 0000133F A3[1C52]                	mov	[Vol_Serial1+2], ax
  4765 00001342 8A4403                  	mov	al, [si+3]
  4766 00001345 E83807                  	call	bin_to_hex
  4767 00001348 A3[1A52]                	mov	[Vol_Serial1], ax
  4768                                  
  4769 0000134B BE[0852]                	mov	si, Msg_Volume_Serial
  4770 0000134E E85B06                  	call	print_msg
  4771                                  
  4772 00001351 C3                      	retn
  4773                                  
  4774                                  bcd_to_bin:
  4775 00001352 53                      	push	bx
  4776 00001353 D410                    	db	0D4h, 10h ; Undocumented inst. AAM
  4777                                  			  ; AH = AL / 10h
  4778                                  			  ; AL = AL MOD 10h
  4779 00001355 88C3                    	mov	bl, al
  4780 00001357 B00A                    	mov	al, 10
  4781 00001359 F6E4                    	mul	ah
  4782 0000135B 00D8                    	add	al, bl
  4783 0000135D 5B                      	pop	bx
  4784 0000135E C3                      	retn
  4785                                  
  4786                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4787                                  ; write formatting percentage
  4788                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4789                                  
  4790                                  	; 16/03/2021 (fdisk4.s)
  4791                                  write_formatting_msg:
  4792                                  	;;mov	ax, [pp_Sectors]
  4793                                  	;;mov	dx, [pp_Sectors+2]
  4794                                  	;; 16/02/2019
  4795                                  	;mov	ax, [ppn_Sectors]
  4796                                  	;mov	dx, [ppn_Sectors+2]
  4797                                  	; 16/03/2021
  4798 0000135F 66A1[F869]              	mov	eax, [ppn_Sectors] 
  4799                                  
  4800                                  	;; DX_AX = Total sectors for percentage
  4801                                  	;mov	cx, 100	
  4802                                  	;call	div32
  4803                                  	;mov	[format_percent], ax
  4804                                  	; 16/03/2021
  4805 00001363 6631D2                  	xor	edx, edx
  4806 00001366 66B964000000            	mov	ecx, 100
  4807 0000136C 66F7F1                  	div	ecx
  4808 0000136F 66A3[4867]              	mov	[format_percent], eax
  4809                                  	
  4810 00001373 BE[4052]                	mov	si, msg_formatting
  4811 00001376 E83306                  	call	print_msg
  4812                                  
  4813                                  	; get cursor position
  4814                                  	; bh = 0  ; video page
  4815 00001379 B403                    	mov     ah, 3 ; get cursor pos
  4816 0000137B CD10                    	int     10h
  4817 0000137D 8916[9C51]              	mov	[Cursor_Pos], dx
  4818                                  
  4819 00001381 C606[4C67]FF            	mov	byte [prev_percent], 255
  4820                                  
  4821 00001386 C3                      	retn
  4822                                  
  4823                                  	; 16/03/2021 (fdisk4.s)
  4824                                  write_format_percent:
  4825                                  	; DX_AX = Current sector (which has been written)
  4826                                  
  4827                                  	; 16/03/2021
  4828                                  	; EAX = current sector (which has been written)
  4829                                  
  4830                                  	;push	ax
  4831                                  	;push	dx
  4832                                  	; 16/03/2021
  4833 00001387 6650                    	push	eax
  4834 00001389 6652                    	push	edx
  4835 0000138B 53                      	push	bx
  4836 0000138C 51                      	push	cx
  4837 0000138D 56                      	push	si
  4838                                  
  4839                                  	;sub	ax, [bp+1Ch]	; [BPB_HiddSec]
  4840                                  	;sbb	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4841                                  	; 16/03/2021
  4842 0000138E 662B461C                	sub	eax, [bp+1Ch]	; [BPB_HiddSec]
  4843                                  wpc_t:
  4844                                  	;mov	cx, [format_percent]
  4845                                  	;call	div32
  4846                                  	; 16/03/2021
  4847 00001392 6629D2                  	sub	edx, edx
  4848 00001395 66F736[4867]            	div	dword [format_percent]
  4849                                  	; AL = percentage value between 1 to 100
  4850                                  wpc_x:
  4851 0000139A 3A06[4C67]              	cmp	al, [prev_percent]
  4852 0000139E 7419                    	je	short wpc_y
  4853 000013A0 A2[4C67]                	mov	[prev_percent], al
  4854 000013A3 8B16[9C51]              	mov	dx, [Cursor_Pos]
  4855 000013A7 BB0700                  	mov	bx, 7
  4856 000013AA B402                    	mov	ah, 2
  4857 000013AC CD10                    	int	10h  ; Set Cursor Position
  4858                                  	;;xor	dx, dx
  4859                                  	;xor	edx, edx ; 16/03/2021
  4860 000013AE 30E4                    	xor	ah, ah
  4861                                  	;mov	al, [prev_percent]
  4862 000013B0 BE[4E52]                	mov	si, format_percent_str + 2
  4863 000013B3 E8AF06                  	call	bin_to_decimal
  4864 000013B6 E8F305                  	call	print_msg
  4865                                  wpc_y:
  4866 000013B9 5E                      	pop	si
  4867 000013BA 59                      	pop	cx
  4868 000013BB 5B                      	pop	bx
  4869                                  	; 16/03/2021
  4870 000013BC 665A                    	pop	edx
  4871 000013BE 6658                    	pop	eax
  4872                                  	;pop	dx
  4873                                  	;pop	ax
  4874 000013C0 C3                      	retn
  4875                                  
  4876                                  write_format_percent_x:
  4877                                  	; AL = % number
  4878                                  
  4879                                  	;push	ax
  4880                                  	;push	dx
  4881                                  	; 16/03/2021
  4882 000013C1 6650                    	push	eax
  4883 000013C3 6652                    	push	edx
  4884 000013C5 53                      	push	bx
  4885 000013C6 51                      	push	cx
  4886 000013C7 56                      	push	si
  4887                                  
  4888 000013C8 EBD0                    	jmp	short wpc_x
  4889                                  
  4890                                  write_fs_format_percent:
  4891                                  	; DX_AX = Current sector (which has been written)
  4892                                  	; 16/03/2021
  4893                                  	; EAX = Current sector
  4894                                  
  4895                                  	;push	ax
  4896                                  	;push	dx
  4897                                  	; 16/03/2021
  4898 000013CA 6650                    	push	eax
  4899 000013CC 6652                    	push	edx
  4900 000013CE 53                      	push	bx
  4901 000013CF 51                      	push	cx
  4902 000013D0 56                      	push	si
  4903                                  
  4904                                  	;sub	ax, [bp+0Ch]	; [bsBeginSector]
  4905                                  	;sbb	dx, [bp+0Eh]	; [bsBeginSector+2]
  4906                                  	; 16/03/2021
  4907 000013D1 662B460C                	sub	eax, [bp+0Ch]	; [bsBeginSector]
  4908                                  
  4909 000013D5 EBBB                    	jmp	short wpc_t
  4910                                  	
  4911                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4912                                  ; format error 
  4913                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4914                                  
  4915                                  formatting_error:
  4916 000013D7 8B26[3865]              	mov	sp, [old_sp]
  4917                                  
  4918 000013DB 88E0                    	mov	al, ah ;  error code
  4919 000013DD E8A006                  	call	bin_to_hex
  4920 000013E0 A3[6652]                	mov 	[error_code], ax
  4921                                  
  4922 000013E3 BE[5852]                	mov	si, CRLF
  4923 000013E6 E8C305                  	call	print_msg
  4924                                  
  4925 000013E9 BE[5B52]                	mov	si, Msg_Error
  4926                                  	;call	print_msg
  4927                                  	;jmp	_exit
  4928                                  	; 19/10/2020
  4929 000013EC E983F3                  	jmp	_p_exit
  4930                                  
  4931                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4932                                  ; write cluster count
  4933                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4934                                  
  4935                                  write_cluster_count:
  4936 000013EF BE[2652]                	mov	si, msg_cluster_count
  4937 000013F2 E8B705                  	call	print_msg
  4938                                  	;mov	ax, [cluster_count]
  4939                                  	;mov	dx, [cluster_count+2]
  4940                                  	; 16/03/2021
  4941 000013F5 66A1[4267]              	mov	eax, [cluster_count]
  4942 000013F9 BE[3C52]                	mov	si, cluster_count_str+6
  4943 000013FC E86606                  	call	bin_to_decimal
  4944                                  	;call	print_msg
  4945                                  	;retn
  4946                                  	; 19/10/2020
  4947 000013FF E9AA05                  	jmp	print_msg 
  4948                                  
  4949                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4950                                  ; FAT16 FORMATTING
  4951                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4952                                  	
  4953                                  	; 17/03/2021 (fdisk4.s)
  4954                                  	; 08/02/2019 (Modified for -only- FAT16 CHS partitions) 
  4955                                  FAT16_hd_format:
  4956                                  ; 04/05/2024 (Retro DOS v5 modification)
  4957                                  ; DL = Partition (FS) ID
  4958                                  ;	mov	ax, 0706h ; db 06h, 07h ; 'push es, pop es'
  4959                                  ;	cmp	dl, al ; 06h ; Big CHS partition (>= 32MB)
  4960                                  ;	je	short FAT16_big_chs_format
  4961                                  ;	;mov	ax, 070Eh ; db 0Eh, 07h	; 'push cs, pop es'
  4962                                  ;	;cmp	dl, al ; 0Eh ; LBA partition
  4963                                  ;	;je	short FAT16_lba_format
  4964                                  ;FAT16_chs_format:  
  4965                                  ;	; Partition Type: 04h, CHS (<32 MB) partition
  4966                                  ;	mov	ax, 0004h ; db 04h, 00h ; 'add al, 0'
  4967                                  ;FAT16_big_chs_format:
  4968                                  ;;;
  4969                                  ;;FAT16_lba_format:
  4970                                  	; Put TRDOS 386 FAT16 partition magic word 
  4971                                  	; at offset 3Eh, in TRDOS386 FAT16 boot sector.
  4972 00001402 BD[8C34]                	mov	bp, TRDOS_FAT16_hd_bs
  4973 00001405 8D7E03                  	lea	di, [bp+3]
  4974 00001408 BE[1061]                	mov	si, bs_oem_name
  4975 0000140B B90400                  	mov	cx, 4
  4976 0000140E F3A5                    	rep	movsw 
  4977                                  
  4978                                  	;mov	[bp+3Eh], ax	; [loc_3E]
  4979                                  	; 04/05/2024 (Retro DOS v5 modification)
  4980 00001410 80FA06                  	cmp	dl, 6
  4981 00001413 7404                    	je	short FAT16_f_x ; skip ; db 'RDv5 FAT16 06h', 0
  4982                                  	; dl = 04h or 0Eh
  4983 00001415 8896CE01                	mov	[bp+1CEh], dl	; Retro DOS v5 boot sect off 1CEh
  4984                                  				; (see: 'rd5hdbs.txt' for 1CEh)
  4985                                  FAT16_f_x: 
  4986 00001419 A1[9E3C]                	mov	ax, [sectors]
  4987 0000141C 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4988 0000141F A1[A03C]                	mov	ax, [heads]
  4989 00001422 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4990 00001425 A1[C069]                	mov	ax, [pp_StartSector]
  4991 00001428 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4992 0000142B A1[C269]                	mov	ax, [pp_StartSector+2]
  4993 0000142E 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4994                                  	
  4995                                  	;;mov	ax, [pp_Sectors]
  4996                                  	;mov	ax, [ppn_Sectors] ; 16/02/2019
  4997                                  	;;mov	dx, [pp_Sectors+2]
  4998                                  	;mov	dx, [ppn_Sectors+2] ; 16/02/2019
  4999                                  	;and	dx, dx
  5000                                  	;jnz	short FAT16_f_0
  5001                                  	; 17/03/2021
  5002 00001431 66A1[F869]              	mov	eax,[ppn_Sectors]
  5003 00001435 663D00000100            	cmp	eax, 65536
  5004 0000143B 7305                    	jnb	short FAT16_f_0
  5005                                  
  5006 0000143D 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  5007                                  	; CX = 0
  5008                                  	;mov	[bp+20h], cx	; [BPB_TotSec32] =  0
  5009                                  	;mov	[bp+22h], cx	; [BPB_TotSec32+2] = 0
  5010 00001440 EB04                    	jmp	short FAT16_f_1
  5011                                  FAT16_f_0:
  5012                                  	;mov	[bp+20h], ax	; [BPB_TotSec32]
  5013                                  	;;;mov	dx, [pp_Sectors+2]
  5014                                  	;;mov	dx, [ppn_Sectors+2] ; 16/02/2019 
  5015                                  	;mov	[bp+22h], dx	; [BPB_TotSec32+2]
  5016                                  	;; CX = 0
  5017                                  	;;mov	[bp+13h], cx ; [BPB_TotSec16] = 0
  5018                                  	; 17/03/2021
  5019 00001442 66894620                	mov	[bp+20h], eax	; [BPB_TotSec32]
  5020                                  FAT16_f_1:
  5021                                  	; Sectors per cluster calculation
  5022                                  	; (According to MS FAT32 FS specification.)
  5023 00001446 B102                    	mov	cl, 2  ; 2 sectors per cluster
  5024                                  	; 17/03/2021
  5025 00001448 6689C2                  	mov	edx, eax
  5026 0000144B 66C1EA10                	shr	edx, 16
  5027 0000144F 7507                    	jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  5028                                  	;or	dx, dx
  5029                                  	;jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  5030 00001451 3DA87F                  	cmp	ax, 32680
  5031 00001454 763C                    	jna	short FAT16_f_10 ; 2 sectors, <=16MB
  5032                                  	; > 16MB
  5033 00001456 EB38                    	jmp	short FAT16_f_9 ; 4 sectors per cluster
  5034                                  FAT16_f_2:
  5035 00001458 83FA04                  	cmp	dx, 4  ; >= 262144 sectors ; >=128MB
  5036 0000145B 7708                    	ja	short FAT16_f_3 ; >4 sectors per cluster
  5037 0000145D 7231                    	jb	short FAT16_f_9 ; 4 sectors per cluster	
  5038 0000145F 09C0                    	or	ax, ax ; dx_ax = (4*65536)+0
  5039 00001461 742D                    	jz	short FAT16_f_9 ; 4 sectors per cluster
  5040 00001463 EB29                    	jmp	short FAT16_f_8 ; 8 sectors per cluster
  5041                                  FAT16_f_3:
  5042 00001465 83FA08                  	cmp	dx, 8  ; >= 524288 sectors ; >=256MB
  5043 00001468 7708                    	ja	short FAT16_f_4 ; >8 sectors per cluster
  5044 0000146A 7222                    	jb	short FAT16_f_8 ; 8 sectors per cluster	
  5045 0000146C 21C0                    	and	ax, ax ; dx_ax = (8*65536)+0
  5046 0000146E 741E                    	jz	short FAT16_f_8 ; 8 sectors per cluster
  5047 00001470 EB1A                    	jmp	short FAT16_f_7 ; 16 sectors per cluster
  5048                                  FAT16_f_4:
  5049 00001472 83FA10                  	cmp	dx, 16 ; >= 1048576 sectors ; >=512MB
  5050 00001475 7708                    	ja	short FAT16_f_5 ; >16 sectors per cluster
  5051 00001477 7213                    	jb	short FAT16_f_7 ; 16 sectors per cluster
  5052 00001479 21C0                    	and	ax, ax ; dx_ax = (16*65536)+0
  5053 0000147B 740F                    	jz	short FAT16_f_7 ; 16 sectors per cluster
  5054 0000147D EB0B                    	jmp	short FAT16_f_6 ; 32 sectors per cluster
  5055                                  FAT16_f_5:
  5056 0000147F 83FA20                  	cmp	dx, 32 ; >= 2097152 sectors ; >=1GB
  5057 00001482 7206                    	jb	short FAT16_f_6 ; 32 sectors per cluster
  5058 00001484 09C0                    	or	ax, ax		; dx_ax = (32*65536)+0
  5059 00001486 7402                    	jz	short FAT16_f_6 ; 32 sectors per cluster
  5060                                  	; >1GB (<=2GB)
  5061                                  	; 64 sectors per cluster
  5062 00001488 D0E1                    	shl	cl, 1
  5063                                  FAT16_f_6:
  5064                                  	; 32 sectors per cluster (for <= 2GB volumes)
  5065 0000148A D0E1                    	shl	cl, 1
  5066                                  FAT16_f_7:
  5067                                  	; 16 sectors per cluster (for <= 1GB volumes)
  5068 0000148C D0E1                    	shl	cl, 1
  5069                                  FAT16_f_8:
  5070                                  	; 8 sectors per cluster (for <= 512MB volumes)
  5071 0000148E D0E1                    	shl	cl, 1
  5072                                  FAT16_f_9:
  5073                                  	; 4 sectors per cluster (for <= 256MB volumes)
  5074 00001490 D0E1                    	shl	cl, 1
  5075                                  FAT16_f_10:	
  5076                                  	; 2 sectors per cluster (for <= 128MB volumes)
  5077 00001492 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  5078                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  5079                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt]
  5080                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  5081                                  	
  5082                                  	; Calculating FAT size in sectors
  5083                                  	; (According to MS FAT32 FS Specification, 2000)
  5084                                  
  5085                                  	; DX_AX = partition (volume) size in sectors
  5086                                  	;mov	bx, [bp+11h]	; [BPB_RootEntCnt] = 512
  5087                                  	;add	bx, 15 ; bx = 527
  5088                                  	;shr	bx, 4 ; /16 = 527/16 = 32
  5089                                  	;	; ((32*BX)+511)/512
  5090                                  	;mov	[root_dir_secs], bx
  5091                                  	;add	bx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5092                                  	;sub	ax, bx
  5093                                  	;sbb	dx, 0
  5094                                  	;	; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  5095                                  	;	;	     		RootDirsectors)
  5096                                  	; 17/03/2021
  5097 00001495 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  5098 00001498 83C20F                  	add	dx, 15 ; DX = 527
  5099 0000149B C1EA04                  	shr	dx, 4 ; /16 = 527/16 = 32
  5100                                  		; ((32*DX)+511)/512
  5101 0000149E 8916[4667]              	mov	[root_dir_secs], dx
  5102 000014A2 03560E                  	add	dx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5103 000014A5 6629D0                  	sub	eax, edx
  5104                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  5105                                  		;	     		RootDirsectors)
  5106                                  	
  5107                                  	;;mov	bx, cx ; ch = 0
  5108                                  	;;shl	bx, 8 ; * 256
  5109                                  	;; 11/02/2019
  5110                                  	;mov	bh, cl
  5111                                  	;xor	bl, bl
  5112                                  	;mov	cl, 2 ; [BPB_NumFATs]
  5113                                  	;add	bx, cx	
  5114                                  	;	; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  5115                                  	;mov	cx, bx
  5116                                  	;dec	bx  ; TmpVal2-1
  5117                                  	;add	ax, bx
  5118                                  	;adc	dx, 0
  5119                                  	;call	div32
  5120                                  	;	; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  5121                                  	;; AX = FAT size in sectors
  5122                                  	;; DX = 0
  5123                                  	;mov	[bp+16h], ax	; [BPB_FATSz16]
  5124                                  	; 17/03/2021
  5125 000014A8 88CE                    	mov	dh, cl ; * 256
  5126                                  	;mov	dl, [bp+10h] ; [BPB_NumFATs] 
  5127 000014AA B202                    	mov	dl, 2 ; [BPB_NumFATs]
  5128                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs 
  5129 000014AC 6689D3                  	mov	ebx, edx
  5130 000014AF 4A                      	dec	dx ; TmpVal2-1
  5131 000014B0 6601D0                  	add	eax, edx
  5132 000014B3 31D2                    	xor	dx, dx
  5133 000014B5 66F7F3                  	div	ebx
  5134                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  5135                                  	; EAX = FAT size in sectors (<= 256)
  5136                                  	; * 2
  5137 000014B8 D1E0                    	shl	ax, 1
  5138                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  5139                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5140                                  	;add	cx, ax
  5141                                  	; 17/03/2021
  5142 000014BA 8B560E                  	mov	dx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5143 000014BD 01C2                    	add	dx, ax
  5144                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5145                                  	;add	cx, [root_dir_secs] ; + RootDirsectors
  5146                                  	;sub	bx, bx ; BX = 0
  5147 000014BF 0316[4667]              	add	dx, [root_dir_secs] ; + RootDirsectors
  5148                                  	; BX_CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5149                                  	;	  + RootDirSectors
  5150 000014C3 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  5151                                  	;sub	dx, dx 
  5152                                  	; DX = 0
  5153 000014C6 21C0                    	and	ax, ax
  5154 000014C8 7504                    	jnz	short FAT16_f_11
  5155                                  	;mov	ax, [bp+20h]	; [BPB_TotSec32]
  5156                                  	;mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  5157 000014CA 668B4620                	mov	eax, [bp+20h]	; [BPB_TotSec32]
  5158                                  FAT16_f_11:
  5159                                  	;sub	ax, cx
  5160                                  	;sbb	dx, bx
  5161                                  	; 17/03/2021
  5162                                  	; EAX = Total Sectors
  5163                                  	; EDX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5164                                  	;	+ RootDirSectors
  5165 000014CE 6629D0                  	sub	eax, edx
  5166                                  	;mov	[data_start], cx
  5167                                  	;mov	[data_start+2], bx
  5168 000014D1 668916[3A67]            	mov	[data_start], edx
  5169                                  	; DX_AX = Data sectors
  5170                                  	;mov	[data_sectors], ax
  5171                                  	;mov	[data_sectors+2], dx
  5172 000014D6 66A3[3E67]              	mov	[data_sectors], eax
  5173 000014DA 31D2                    	xor	dx, dx
  5174                                  	;mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  5175                                  	;xor	ch, ch
  5176                                  	;call	div32 ; DX_AX/CX
  5177                                  	;; AX = Count of clusters (rounded down)
  5178                                  	;; DX = 0
  5179 000014DC 8A5E0D                  	mov	bl, [bp+0Dh]	 ; [BPB_SecPerClus]
  5180 000014DF 30FF                    	xor	bh, bh
  5181 000014E1 66F7F3                  	div	ebx
  5182                                  	; AX = Count of clusters (rounded down)
  5183                                  	; (eax <= 65528)
  5184                                  
  5185                                  	;mov	[cluster_count], ax
  5186                                  	;mov	[cluster_count+2], dx
  5187 000014E4 66A3[4267]              	mov	[cluster_count], eax
  5188                                  
  5189 000014E8 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  5190 000014EB E88BFD                  	call	write_volume_name
  5191 000014EE 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  5192 000014F1 E8E4FD                  	call	write_volume_serial
  5193 000014F4 E8F8FE                  	call	write_cluster_count
  5194                                  
  5195 000014F7 E865FE                  	call	write_formatting_msg
  5196 000014FA B000                    	mov	al, 0
  5197 000014FC E8C2FE                  	call	write_format_percent_x
  5198                                  
  5199                                  	;mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  5200                                  	;mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  5201 000014FF 668B461C                	mov	eax, [bp+1Ch]	; [BPB_HiddSec]
  5202                                  
  5203                                  	;add	[data_start], ax
  5204                                  	;adc	[data_start+2], dx
  5205 00001503 660106[3A67]            	add	[data_start], eax
  5206                                  	;sub	dx, dx ; edx = 0
  5207                                  
  5208                                  	; DX_AX = FAT16 Boot Sector address
  5209 00001508 BB[8C34]                	mov	bx, TRDOS_FAT16_hd_bs
  5210                                  	; ES:BX = Boot Sector Buffer
  5211 0000150B E8FC04                  	call	write_hd_sector
  5212 0000150E 0F82C5FE                	jc	formatting_error
  5213 00001512 E872FE                  	call	write_format_percent
  5214                                  	;add	ax, 1
  5215                                  	;adc	dx, 0
  5216                                  	; 17/03/2021
  5217 00001515 6640                    	inc	eax
  5218                                  	; write remain part of reserved sectors
  5219 00001517 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  5220                                  	;sub	cx, 1
  5221                                  	;jna	short FAT16_f_13
  5222                                  	; 11/02/2019
  5223 0000151A 49                      	dec	cx
  5224 0000151B 7414                    	jz	short FAT16_f_13
  5225                                  FAT16_f_12:
  5226 0000151D 51                      	push	cx
  5227 0000151E BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5228 00001521 E8E604                  	call	write_hd_sector
  5229 00001524 0F82AFFE                	jc	formatting_error
  5230 00001528 E85CFE                  	call	write_format_percent
  5231                                  	;add	ax, 1
  5232                                  	;adc	dx, 0
  5233                                  	; 17/03/2021
  5234 0000152B 6640                    	inc	eax
  5235 0000152D 59                      	pop	cx
  5236 0000152E 49                      	dec	cx ; dec cl
  5237 0000152F 75EC                    	jnz	short FAT16_f_12
  5238                                  FAT16_f_13:
  5239                                  	; write FAT sectors
  5240                                  	;mov	cx, [data_start] ; lba/abs addr
  5241                                  	;mov	bx, [data_start+2] ; lba/abs addr
  5242                                  	; 17/03/2021	
  5243 00001531 668B16[3A67]            	mov	edx, [data_start]
  5244                                  
  5245                                  	; 11/02/2019
  5246                                  	;sub	cx, [root_dir_secs]
  5247                                  	;sbb	bx, 0
  5248                                  	; 17/03/2021	
  5249 00001536 8B1E[4667]              	mov	bx, [root_dir_secs]
  5250 0000153A 6629DA                  	sub	edx, ebx 
  5251                                  	;push	edx  ; *
  5252                                  
  5253                                  	;push	bx
  5254                                  	;push	cx
  5255 0000153D BB[3A65]                	mov	bx, HDFORMAT_FATBUFFER
  5256                                  	; ES:BX = FAT Sector Buffer
  5257 00001540 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  5258 00001543 B5FF                    	mov	ch, 0FFh
  5259 00001545 890F                    	mov	[bx], cx ; 0FFF8h
  5260 00001547 88E9                    	mov	cl, ch ; cx = 0FFFFh
  5261 00001549 894F02                  	mov	[bx+2], cx
  5262                                  	;inc	cx
  5263 0000154C E8BB04                  	call	write_hd_sector
  5264 0000154F 0F8284FE                	jc	formatting_error
  5265 00001553 E831FE                  	call	write_format_percent
  5266                                  	;mov	bx, HDFORMAT_FATBUFFER
  5267 00001556 B90000                  	mov	cx, 0
  5268 00001559 890F                    	mov	[bx], cx
  5269 0000155B 894F02                  	mov	[bx+2], cx
  5270 0000155E EB0D                    	jmp	short FAT16_f_15
  5271                                  FAT16_f_14:	
  5272                                  	;push	bx
  5273                                  	;push	cx
  5274                                  	; 17/03/2021
  5275                                  	; push	edx ; *
  5276 00001560 BB[3A65]                	mov	bx, HDFORMAT_FATBUFFER
  5277 00001563 E8A404                  	call	write_hd_sector
  5278 00001566 0F826DFE                	jc	formatting_error
  5279 0000156A E81AFE                  	call	write_format_percent
  5280                                  FAT16_f_15:	
  5281                                  	;pop	cx
  5282                                  	;pop	bx
  5283                                  	; 17/03/2021
  5284                                  	;pop	edx ; *
  5285                                  	;add	ax, 1
  5286                                  	;adc	dx, 0
  5287 0000156D 6640                    	inc	eax
  5288                                  	;cmp	dx, bx
  5289                                  	;jb	short FAT16_f_14
  5290                                  	;cmp	ax, cx
  5291                                  	;jb	short FAT16_f_14
  5292 0000156F 6639D0                  	cmp	eax, edx
  5293 00001572 72EC                    	jb	short FAT16_f_14
  5294                                  
  5295                                  	; write	root directory sectors
  5296                                  	; as empty sectors
  5297 00001574 8B0E[4667]              	mov	cx, [root_dir_secs]
  5298                                  FAT16_f_16:
  5299 00001578 51                      	push	cx
  5300 00001579 BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5301 0000157C E88B04                  	call	write_hd_sector
  5302 0000157F 0F8254FE                	jc	formatting_error
  5303 00001583 E801FE                  	call	write_format_percent
  5304                                  	;add	ax, 1
  5305                                  	;adc	dx, 0
  5306                                  	; 17/03/2021
  5307 00001586 6640                    	inc	eax
  5308 00001588 59                      	pop	cx
  5309 00001589 49                      	dec	cx
  5310 0000158A 75EC                    	jnz	short FAT16_f_16
  5311                                  
  5312                                  	; write DATA sectors 
  5313                                  	; (after root directory sectors)
  5314                                  	;mov	cx, [data_sectors]
  5315                                  	;mov	bx, [data_sectors+2]
  5316                                  	; 17/03/2021
  5317 0000158C 668B16[3E67]            	mov	edx, [data_sectors]
  5318                                  	; 11/02/2019
  5319 00001591 43                      	inc	bx ; 0 -> 1, 1-> 2
  5320                                  FAT16_f_17:	
  5321                                  	;push	bx
  5322                                  	;push	cx
  5323                                  	; 17/03/2021
  5324                                  	;push	edx ; **
  5325 00001592 BB[2661]                	mov	bx, HDFORMAT_SECBUFFER
  5326 00001595 E87204                  	call	write_hd_sector
  5327 00001598 0F823BFE                	jc	formatting_error
  5328 0000159C E8E8FD                  	call	write_format_percent
  5329                                  	; 17/03/2021
  5330 0000159F 665A                    	pop	edx ;**
  5331                                  	;pop	cx
  5332                                  	;pop	bx
  5333                                  	;add	ax, 1
  5334                                  	;adc	dx, 0
  5335 000015A1 6640                    	inc	eax
  5336                                  	;dec	cx
  5337                                  	;jnz	short FAT16_f_17
  5338                                  	;dec	bx
  5339                                  	;jnz	short FAT16_f_17
  5340                                  	; 17/03/2021
  5341 000015A3 664A                    	dec	edx
  5342 000015A5 75EB                    	jnz	short FAT16_f_17
  5343                                  
  5344                                  	; If there are, format remain sectors which are
  5345                                  	; at beyond of data clusters, with zero bytes.
  5346                                  	
  5347                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  5348                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  5349                                  	; 17/03/2021
  5350 000015A7 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  5351                                  	;movzx	ebx, word [bp+13h] ; [BPB_TotSec16]
  5352 000015AB 8B5E13                  	mov	bx, [bp+13h] ; [BPB_TotSec16]
  5353                                  
  5354                                  	;cmp	word [bp+13h], 0 ; [BPB_TotSec16]
  5355 000015AE 09DB                    	or	bx, bx	; 17/03/2021
  5356 000015B0 0F8498FC                	jz	FAT16_f_18
  5357                                  	;add	cx, [bp+13h]	; [BPB_TotSec16]
  5358                                  	;adc	bx, 0
  5359                                  	; 17/03/2021
  5360 000015B4 6601DA                  	add	edx, ebx
  5361 000015B7 E996FC                  	jmp	FAT16_f_19
  5362                                  
  5363                                  	; 17/03/2021 (fdisk4.s)
  5364                                  FAT12_hd_format:
  5365 000015BA BD[8C36]                	mov	bp, TRDOS_FAT12_hd_bs
  5366 000015BD 8D7E03                  	lea	di, [bp+3]
  5367 000015C0 BE[1061]                	mov	si, bs_oem_name
  5368 000015C3 B90400                  	mov	cx, 4
  5369 000015C6 F3A5                    	rep	movsw 
  5370 000015C8 A1[9E3C]                	mov	ax, [sectors]
  5371 000015CB 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  5372 000015CE A1[A03C]                	mov	ax, [heads]
  5373 000015D1 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  5374                                  
  5375                                  	;mov	ax, [pp_StartSector]
  5376                                  	;mov	[bp+1Ch], ax	; [BPB_HiddSec]
  5377                                  	;mov	ax, [pp_StartSector+2]
  5378                                  	;mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  5379                                  	; 17/03/2021
  5380 000015D4 66A1[C069]              	mov	eax, [pp_StartSector]
  5381 000015D8 6689461C                	mov	[bp+1Ch], eax	; [BPB_HiddSec]
  5382                                  
  5383                                  	;mov	ax, [pp_Sectors]
  5384 000015DC A1[F869]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  5385 000015DF 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  5386                                  
  5387                                  	; 11/02/2019
  5388 000015E2 31F6                    	xor	si, si ; reset (FAT size fix) flag
  5389 000015E4 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5390 000015E7 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  5391 000015EA 83C20F                  	add	dx, 15	; (16-1) (512-1)
  5392 000015ED C1EA04                  	shr	dx, 4	; /16  (*32/512)
  5393                                  	; AX = Root dir sectors
  5394                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5395 000015F0 01D1                    	add	cx, dx ; + RootDirsectors ; + 32
  5396 000015F2 890E[4667]              	mov	[root_dir_secs], cx ; = 33
  5397                                  
  5398                                  	; 11/02/2019
  5399                                  	;sub	ax, 33  ; 1 reserved sector, 32 root dir sectors
  5400                                  			; .. now AX has number of data sectors
  5401                                  			;	 		+ 2* (FAT sectors)
  5402 000015F6 29C8                    	sub	ax, cx
  5403                                  FAT12_f_10:	; 11/02/2019
  5404                                  	; Sectors per cluster calculation
  5405                                  	; (According to MS FAT32 FS specification.)
  5406                                  	;mov	cx, 1  ; 1 sector per cluster
  5407 000015F8 B101                    	mov	cl, 1  ; CH = 0
  5408                                  FAT12_f_0:
  5409 000015FA 3DF50F                  	cmp	ax, 4085 ; Max. cluster count for FAT12
  5410 000015FD 7206                    	jb	short FAT12_f_1
  5411 000015FF D0E1                    	shl	cl, 1 ; *2
  5412 00001601 D1E8                    	shr	ax, 1 ; /2
  5413 00001603 EBF5                    	jmp	short FAT12_f_0
  5414                                  FAT12_f_1:
  5415 00001605 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  5416                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  5417                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  5418                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  5419                                  	
  5420                                  	; Calculating FAT size in sectors
  5421                                  	; AX = partition (volume) size in sectors
  5422                                  	; CX = sectors per clusters
  5423 00001608 31D2                    	xor	dx, dx
  5424 0000160A F7F1                    	div	cx
  5425                                  	; AX = cluster count (only for FAT size calc)
  5426                                  	; DX = 0
  5427 0000160C 83C002                  	add	ax, 2  ; cluster 2 to ...
  5428 0000160F 89C2                    	mov	dx, ax
  5429 00001611 D1E2                    	shl	dx, 1
  5430 00001613 01D0                    	add	ax, dx ; *3
  5431 00001615 D1E8                    	shr	ax, 1  ; /2
  5432 00001617 83D000                  	adc	ax, 0  ; +0.5 -> +1
  5433                                  
  5434                                  	; AX = FAT bytes for 12 bit cluster numbers
  5435                                  	
  5436 0000161A B90002                  	mov	cx, 512		; [BPB_BytesPerSec]
  5437 0000161D 01C8                    	add	ax, cx		
  5438 0000161F 48                      	dec	ax		; [BPB_BytesPerSec] - 1
  5439 00001620 29D2                    	sub	dx, dx
  5440 00001622 F7F1                    	div	cx
  5441 00001624 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  5442                                  	; * 2
  5443 00001627 D1E0                    	shl	ax, 1
  5444                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  5445                                  
  5446                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5447                                  	;add	cx, ax
  5448                                  	;mov	ax, [bp+11h]	; [BPB_RootEntCnt] = 512
  5449                                  	;add	ax, 15	; (16-1) (512-1)
  5450                                  	;shr	ax, 4	; /16  (*32/512)
  5451                                  	;; AX = Root dir sectors
  5452                                  	;; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5453                                  	;add	cx, ax ; + RootDirsectors
  5454                                  	;mov	[root_dir_secs], ax
  5455                                  
  5456                                  	; 11/02/2019
  5457                                  	;mov	cx, 33
  5458 00001629 8B0E[4667]              	mov	cx, [root_dir_secs]
  5459 0000162D 034E0E                  	add	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5460                                  		; cx = root directory sectors + reserved sectors
  5461 00001630 01C1                    	add	cx, ax
  5462                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5463                                  	;	  + RootDirSectors
  5464                                  
  5465                                  	; 17/03/2021
  5466 00001632 6631C0                  	xor	eax, eax
  5467                                  
  5468 00001635 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  5469 00001638 29C8                    	sub	ax, cx
  5470                                  		 ; AX = data sectors
  5471                                  		 ; cH = 0
  5472                                  
  5473                                  	; 11/02/2019 - fix FAT size (better method)
  5474 0000163A 09F6                    	or	si, si
  5475 0000163C 7504                    	jnz	short FAT12_f_9
  5476                                  
  5477 0000163E 89C6                    	mov	si, ax  ; ax = data sectors
  5478 00001640 EBB6                    	jmp	short FAT12_f_10
  5479                                  
  5480                                  FAT12_f_9:
  5481 00001642 31D2                    	xor	dx, dx
  5482 00001644 890E[3A67]              	mov	[data_start], cx
  5483 00001648 8916[3C67]              	mov	[data_start+2], dx ; 0
  5484                                  	; DX_AX = Data sectors
  5485                                  	;mov	[data_sectors], ax
  5486                                  	;mov	[data_sectors+2], dx ; 0
  5487                                  	; 17/03/2021
  5488 0000164C 66A3[3E67]              	mov	[data_sectors], eax
  5489 00001650 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  5490 00001653 28ED                    	sub	ch, ch
  5491 00001655 F7F1                    	div	cx
  5492                                  	; AX = Count of clusters (rounded down)
  5493 00001657 29D2                    	sub	dx, dx ; 0
  5494 00001659 A3[4267]                	mov	[cluster_count], ax
  5495 0000165C 8916[4467]              	mov	[cluster_count+2], dx ; 0
  5496                                  
  5497 00001660 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  5498 00001663 E813FC                  	call	write_volume_name
  5499 00001666 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  5500 00001669 E86CFC                  	call	write_volume_serial
  5501 0000166C E880FD                  	call	write_cluster_count
  5502                                  
  5503 0000166F E8EDFC                  	call	write_formatting_msg
  5504 00001672 B000                    	mov	al, 0
  5505 00001674 E84AFD                  	call	write_format_percent_x
  5506                                  
  5507                                  	;mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  5508                                  	;mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  5509                                  	; 17/03/2021
  5510 00001677 668B461C                	mov	eax, [bp+1Ch]	; [BPB_HiddSec]
  5511                                  
  5512                                  	;add	[data_start], ax
  5513                                  	;adc	[data_start+2], dx
  5514                                  	; 17/03/2021
  5515 0000167B 660106[3A67]            	add	[data_start], eax
  5516                                  
  5517                                  	; DX_AX = FAT12 Boot Sector address
  5518 00001680 BB[8C36]                	mov	bx, TRDOS_FAT12_hd_bs
  5519                                  	; ES:BX = Boot Sector Buffer
  5520 00001683 E88403                  	call	write_hd_sector
  5521 00001686 0F824DFD                	jc	formatting_error
  5522 0000168A E8FAFC                  	call	write_format_percent
  5523                                  	;add	ax, 1
  5524                                  	;adc	dx, 0
  5525                                  	; 17/03/2021
  5526 0000168D 6640                    	inc	eax
  5527                                  	; write remain part of reserved sectors
  5528 0000168F 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  5529                                  	;sub	cx, 1
  5530                                  	;jna	short FAT12_f_3
  5531                                  	; 11/02/2019
  5532 00001692 49                      	dec	cx
  5533 00001693 7414                    	jz	short FAT12_f_3
  5534                                  FAT12_f_2:
  5535 00001695 51                      	push	cx
  5536 00001696 BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5537 00001699 E86E03                  	call	write_hd_sector
  5538 0000169C 0F8237FD                	jc	formatting_error
  5539 000016A0 E8E4FC                  	call	write_format_percent
  5540                                  	;add	ax, 1
  5541                                  	;adc	dx, 0
  5542                                  	; 17/03/2021
  5543 000016A3 6640                    	inc	eax ; next sector
  5544 000016A5 59                      	pop	cx
  5545 000016A6 49                      	dec	cx ; dec cl
  5546 000016A7 75EC                    	jnz	short FAT12_f_2
  5547                                  FAT12_f_3:
  5548                                  	; write FAT sectors
  5549                                  	;mov	cx, [data_start] ; lba/abs addr
  5550                                  	;mov	bx, [data_start+2] ; lba/abs addr
  5551                                  	; 17/03/2021
  5552 000016A9 668B16[3A67]            	mov	edx, [data_start] ; lba/abs addr
  5553                                  
  5554                                  	; 11/02/2019
  5555                                  	;sub	cx, [root_dir_secs]
  5556                                  	;sbb	bx, 0
  5557                                  	; 17/03/2021
  5558                                  	;movzx	ebx, word [root_dir_secs]
  5559 000016AE 8B1E[4667]              	mov	bx, [root_dir_secs]
  5560 000016B2 6629DA                  	sub	edx, ebx
  5561                                  	;push	edx ; ***
  5562                                  
  5563                                  	;push	bx
  5564                                  	;push	cx
  5565 000016B5 BB[3A65]                	mov	bx, HDFORMAT_FATBUFFER
  5566                                  	; ES:BX = FAT Sector Buffer
  5567 000016B8 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  5568 000016BB B5FF                    	mov	ch, 0FFh
  5569 000016BD 890F                    	mov	[bx], cx ; 0FFF8h
  5570 000016BF 886F02                  	mov	[bx+2], ch ; 0FFFFF8h
  5571                                  	;xor	cx, cx
  5572 000016C2 E84503                  	call	write_hd_sector
  5573 000016C5 0F820EFD                	jc	formatting_error
  5574 000016C9 E8BBFC                  	call	write_format_percent
  5575                                  	;mov	bx, HDFORMAT_FATBUFFER
  5576 000016CC B90000                  	mov	cx, 0
  5577 000016CF 890F                    	mov	[bx], cx
  5578 000016D1 884F02                  	mov	[bx+2], cl
  5579 000016D4 EB0D                    	jmp	short FAT12_f_5
  5580                                  FAT12_f_4:	
  5581                                  	;push	bx
  5582                                  	;push	cx	
  5583                                  	; 17/03/2021
  5584                                  	;push	edx ; ***
  5585 000016D6 BB[3A65]                	mov	bx, HDFORMAT_FATBUFFER
  5586 000016D9 E82E03                  	call	write_hd_sector
  5587 000016DC 0F82F7FC                	jc	formatting_error
  5588 000016E0 E8A4FC                  	call	write_format_percent
  5589                                  FAT12_f_5:	
  5590                                  	;pop	cx
  5591                                  	;pop	bx
  5592                                  	; 17/03/2021
  5593                                  	;pop	edx ; ***
  5594                                  	;
  5595                                  	;add	ax, 1
  5596                                  	;adc	dx, 0
  5597                                  	; 17/03/2021
  5598 000016E3 6640                    	inc	eax
  5599                                  	;cmp	dx, bx
  5600                                  	;jb	short FAT12_f_4
  5601                                  	;cmp	ax, cx
  5602                                  	;jb	short FAT12_f_4
  5603 000016E5 6639D0                  	cmp	eax, edx
  5604 000016E8 72EC                    	jb	short FAT12_f_4
  5605                                  
  5606                                  	; write	root directory sectors
  5607                                  	; as empty sectors
  5608 000016EA 8B0E[4667]              	mov	cx, [root_dir_secs]
  5609                                  FAT12_f_6:
  5610 000016EE 51                      	push	cx
  5611 000016EF BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5612 000016F2 E81503                  	call	write_hd_sector
  5613 000016F5 0F82DEFC                	jc	formatting_error
  5614 000016F9 E88BFC                  	call	write_format_percent
  5615                                  	;add	ax, 1
  5616                                  	;adc	dx, 0
  5617                                  	; 17/03/2021
  5618 000016FC 6640                    	inc	eax
  5619 000016FE 59                      	pop	cx
  5620 000016FF 49                      	dec	cx ; dec cl
  5621 00001700 75EC                    	jnz	short FAT12_f_6
  5622                                  
  5623                                  	; write DATA sectors 
  5624                                  	; (after root directory sectors)
  5625 00001702 8B0E[3E67]              	mov	cx, [data_sectors]
  5626                                  	;mov	bx, [data_sectors+2]
  5627                                  	;inc	bx ; 11/02/2019
  5628                                  FAT12_f_7:	
  5629                                  	;push	bx
  5630 00001706 51                      	push	cx	
  5631 00001707 BB[2661]                	mov	bx, HDFORMAT_SECBUFFER
  5632 0000170A E8FD02                  	call	write_hd_sector
  5633 0000170D 0F82C6FC                	jc	formatting_error
  5634 00001711 E873FC                  	call	write_format_percent
  5635 00001714 59                      	pop	cx
  5636                                  	;pop	bx
  5637                                  	;add	ax, 1
  5638                                  	;adc	dx, 0
  5639                                  	; 17/03/2021
  5640 00001715 6640                    	inc	eax
  5641 00001717 49                      	dec	cx
  5642 00001718 75EC                    	jnz	short FAT12_f_7
  5643                                  	;dec	bx
  5644                                  	;jnz	short FAT12_f_7
  5645                                  
  5646                                  	; If there are, format remain sectors which are
  5647                                  	; at beyond of data clusters, with zero bytes.
  5648                                  	
  5649                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  5650                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  5651                                  	; 17/03/2021
  5652 0000171A 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  5653                                  
  5654                                  	;add	cx, [bp+13h]	; [BPB_TotSec16]
  5655                                  	;adc	bx, 0
  5656                                  	; 17/03/2021
  5657                                  	;movzx	ebx, word [bp+13h] ; [BPB_TotSec16]
  5658 0000171E 8B5E13                  	mov	bx, [bp+13h]	; [BPB_TotSec16]
  5659 00001721 6601DA                  	add	edx, ebx
  5660                                  
  5661 00001724 E929FB                  	jmp	FAT12_f_8
  5662                                  
  5663                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5664                                  ; SINGLIX FS FORMATTING
  5665                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5666                                  
  5667                                  	; 20/03/2021
  5668                                  	; 19/03/2021 (fdisk4.s)
  5669                                  SINGLIX_hd_format:
  5670                                  	; 06/01/2018
  5671                                  	; 05/01/2018
  5672                                  	; If Sectors/Track = 17, use CHS+LBA type boot sector
  5673 00001727 8B1E[9E3C]              	mov	bx, [sectors]
  5674 0000172B 83FB11                  	cmp	bx, 17
  5675 0000172E 7711                    	ja	short SINGLIX_fs1_f_1
  5676                                  SINGLIX_fs1_f_0:
  5677 00001730 BD[8C38]                	mov	bp, TRDOS_TRFS1_chs_bs
  5678 00001733 887E2D                  	mov	[bp+45], bh ; 0 ; [bs_LBA_Ready] = 0
  5679 00001736 885E2E                  	mov	[bp+46], bl	; [bs_Disk_SecPerTrack]
  5680 00001739 A0[A03C]                	mov	al, [heads]
  5681 0000173C 88462F                  	mov	[bp+47], al	; [bs_Disk_Heads]
  5682 0000173F EB1C                    	jmp	short SINGLIX_fs1_f_3
  5683                                  SINGLIX_fs1_f_1:
  5684                                  	; Sectors per Track = 63
  5685                                  	; If disk capacity >= 63*16*1024 use LBA type boot sector
  5686                                  	; 19/03/2021 (32bit cylinder count <=267349)
  5687 00001741 803E[A43C]00            	cmp	byte [cylinders+2], 0
  5688 00001746 7712                    	ja	short SINGLIX_fs1_f_2
  5689 00001748 8B0E[A03C]              	mov	cx, [heads]
  5690 0000174C A1[A23C]                	mov	ax, [cylinders]
  5691 0000174F F7E1                    	mul	cx
  5692 00001751 21D2                    	and	dx, dx
  5693 00001753 7505                    	jnz	short SINGLIX_fs1_f_2
  5694 00001755 3D0040                  	cmp	ax, 16384
  5695 00001758 72D6                    	jb	short SINGLIX_fs1_f_0
  5696                                  SINGLIX_fs1_f_2:	
  5697 0000175A BD[8C3A]                	mov	bp, TRDOS_TRFS1_lba_bs
  5698                                  	;mov	byte [bp+45], 1 ; [bs_LBA_Ready] = 1
  5699                                  SINGLIX_fs1_f_3:	
  5700                                  	;mov	ax, [pp_Sectors]
  5701                                  	;mov	dx, [pp_Sectors+2]
  5702                                  	; 16/02/2019
  5703                                  	;mov	ax, [ppn_Sectors]
  5704                                  	;mov	dx, [ppn_Sectors+2]
  5705                                  
  5706                                  	; 19/03/2021
  5707 0000175D 66A1[F869]              	mov	eax, [ppn_Sectors]
  5708                                  	;mov	[bp+16], ax	; [bsVolumeSize]
  5709                                  	;mov	[bp+18], dx	; [bsVolumeSize+2]
  5710 00001761 66894610                	mov	[bp+16], eax	; [bsVolumeSize]
  5711                                  	;mov	cx, [pp_StartSector]
  5712                                  	;mov	bx, [pp_StartSector+2]
  5713 00001765 668B16[C069]            	mov	edx, [pp_StartSector] 
  5714                                  	;mov	[bp+12], cx	; [bsBeginSector]
  5715                                  	;mov	[bp+14], bx	; [bsBeginSector+2]
  5716 0000176A 6689560C                	mov	[bp+12], edx	; [bsBeginSector]
  5717                                  
  5718 0000176E C6462C80                	mov	byte [bp+44], 80h ; [bsDriveNumber]  ; hd0
  5719                                  
  5720                                  	; Prepare MAT
  5721                                  	;mov	[MAT_VolumeSize], ax ; Total Sectors of the FS
  5722                                  	;mov	[MAT_VolumeSize+2], dx
  5723                                  	; 19/03/2021
  5724 00001772 66A3[A067]              	mov	[MAT_VolumeSize], eax ; Total Sectors of the FS
  5725                                  	;mov	[MAT_BeginSector], cx ; Beginning Sector of the FS
  5726                                  	;mov	[MAT_BeginSector+2], bx
  5727 00001776 668916[A467]            	mov	[MAT_BeginSector], edx ; Beginning Sector of the FS
  5728                                  
  5729                                  	;mov	cx, [bp+24]	; [bsMATLocation]
  5730                                  	;mov	bx, [bp+26]	; [bsMATLocation+2]
  5731                                  	;add	cx, 1
  5732                                  	;adc	bx, 0
  5733                                  	; Note: (as Default) MAT Address = 1, DAT Address = 2
  5734                                  	;mov	cx, 2
  5735                                  	; 19/03/2021
  5736 0000177B 6631D2                  	xor	edx, edx
  5737 0000177E B202                    	mov	dl, 2
  5738                                  	
  5739                                  	;xor	bx, bx ; 0
  5740                                  	;mov	[bp+24], cx	; [bsMATLocation]
  5741                                  	;mov	[bp+26], bx	; [bsMATLocation+2]
  5742                                  	;mov	[DAT_Address], cx
  5743                                  	;;mov	[DAT_Address+2], bx
  5744                                  	; 19/03/2021
  5745                                  	;mov	[DAT_Address], dx
  5746 00001780 8816[A867]              	mov	[DAT_Address], dl
  5747                                  
  5748                                  	; DX_AX = FS1 Volume Size
  5749                                  	;add	ax, 7 ; 7 bits more (for round up)
  5750                                  	;adc	dx, 0
  5751                                  	; 19/03/2021
  5752                                  	; EAX = FS1 Volume Size	
  5753 00001784 6683C007                	add	eax, 7 ; 7 bits more (for round up)
  5754 00001788 30D2                    	xor	dl, dl ; edx = 0
  5755                                  	;mov	cx, 8 ;  1 DAT byte == 8 sectors
  5756                                  	;call	div32
  5757                                  	; DX_AX = DAT bytes
  5758                                  	; 19/03/2021
  5759 0000178A 6631C9                  	xor	ecx, ecx
  5760 0000178D B108                    	mov	cl, 8
  5761 0000178F 66F7F1                  	div	ecx
  5762                                  	; eax = DAT bytes
  5763                                  
  5764 00001792 B9FF01                  	mov	cx, 511
  5765                                  	;add	ax, cx
  5766                                  	;adc	dx, 0
  5767                                  	; 19/03/2021
  5768 00001795 6601C8                  	add	eax, ecx
  5769                                  	
  5770                                  	;inc	cx ; 512
  5771                                  	;call	div32
  5772                                  	; DX_AX = DAT sectors (DX must be 0 for volume sizes < 128GB)
  5773                                  	; 19/03/2021	
  5774 00001798 41                      	inc	cx  ; ecx = 512 
  5775 00001799 66F7F1                  	div	ecx	
  5776                                  
  5777                                  	;mov	[DAT_SectorCount], ax
  5778                                  	;mov	[DAT_SectorCount+2], dx ; 0
  5779                                  	; 20/03/2021
  5780 0000179C 66A3[AC67]              	mov	[DAT_SectorCount], eax
  5781                                  
  5782                                  	;add	ax, 2  ; BS + MAT
  5783                                  	;adc	dx, 0
  5784                                  	;mov	[bp+28], ax  ; [bsRootDirDT] ; RDT address (offset)
  5785                                  	;mov	[bp+30], dx
  5786                                  	; 20/03/2021
  5787 000017A0 6683C002                	add	eax, 2
  5788 000017A4 6689461C                	mov	[bp+28], eax  ; [bsRootDirDT] ; RDT address (offset)
  5789                                  
  5790                                  	; Free Sectors = Total Sectors - (BS+MAT+DATsects+RDT+4)
  5791                                  	;add	ax, 5 ; DATsects + (BS+MAT+RDT+4)
  5792                                  	;;mov	dx, ax ; ? ;
  5793                                  	;adc 	dx, 0
  5794                                  	; 20/03/2021
  5795 000017A8 6683C005                	add	eax, 5
  5796                                  	;mov	cx, [MAT_VolumeSize]
  5797                                  	;mov	bx, [MAT_VolumeSize+2]
  5798                                  	;sub	cx, ax
  5799                                  	;sbb	bx, 0
  5800                                  	;mov	[MAT_FreeSectors], cx
  5801                                  	;mov	[MAT_FreeSectors+2], bx
  5802                                  	;mov	[MAT_FirstFreeSector], ax
  5803                                  	;mov	[MAT_FirstFreesector+2], dx
  5804                                  	; 20/03/2021
  5805 000017AC 668B16[A067]            	mov	edx, [MAT_VolumeSize]
  5806 000017B1 6629C2                  	sub	edx, eax
  5807 000017B4 668916[B067]            	mov	[MAT_FreeSectors], edx
  5808 000017B9 66A3[B467]              	mov	[MAT_FirstFreeSector], eax
  5809                                   
  5810 000017BD BF[5067]                	mov	di, fs_volume_name
  5811 000017C0 E8AFFA                  	call	write_fs_volume_name
  5812 000017C3 BE[9067]                	mov	si, fs_volume_serial
  5813 000017C6 E80FFB                  	call	write_volume_serial
  5814                                  
  5815                                  	; Modify FS volume name
  5816                                  	; (Convert 20h tail bytes to 0)
  5817 000017C9 B94000                  	mov	cx, 64 
  5818 000017CC BE[5067]                	mov	si, fs_volume_name
  5819 000017CF 31DB                    	xor	bx, bx
  5820 000017D1 B0FF                    	mov	al, 0FFh
  5821                                  modify_fs_vname_1:	
  5822 000017D3 88C4                    	mov	ah, al
  5823 000017D5 AC                      	lodsb
  5824 000017D6 3C20                    	cmp	al, 20h
  5825 000017D8 7708                    	ja	short modify_fs_vname_2
  5826 000017DA 80FC20                  	cmp	ah, 20h
  5827 000017DD 7603                    	jna	short modify_fs_vname_2
  5828 000017DF 89F3                    	mov	bx, si
  5829 000017E1 4B                      	dec	bx
  5830                                  modify_fs_vname_2:
  5831 000017E2 E2EF                    	loop	modify_fs_vname_1
  5832 000017E4 09DB                    	or	bx, bx
  5833 000017E6 740B                    	jz	short modify_fs_vname_3
  5834 000017E8 89DF                    	mov	di, bx
  5835 000017EA B9[9067]                	mov	cx, fs_volume_name+64
  5836 000017ED 29D9                    	sub	cx, bx
  5837 000017EF 30C0                    	xor	al, al
  5838 000017F1 F3AA                    	rep	stosb 
  5839                                  
  5840                                  modify_fs_vname_3:
  5841 000017F3 E869FB                  	call	write_formatting_msg
  5842 000017F6 B000                    	mov	al, 0
  5843 000017F8 E8C6FB                  	call	write_format_percent_x
  5844                                  
  5845                                  	;mov	ax, [bp+12]	; [bsBeginSector]
  5846                                  	;mov	dx, [bp+14]	; [bsBeginSector+2]
  5847                                  	; 20/03/2021
  5848 000017FB 668B460C                	mov	eax, [bp+12]	; [bsBeginSector]
  5849                                  
  5850                                  	; DX_AX = TRFS1 Boot Sector address
  5851 000017FF 89EB                    	mov	bx, bp
  5852                                  	; ES:BX = Boot Sector Buffer
  5853 00001801 E80602                  	call	write_hd_sector
  5854 00001804 0F82CFFB                	jc	formatting_error
  5855                                  	
  5856                                  	;add	ax, 1
  5857                                  	;adc	dx, 0
  5858                                  	; 20/03/2021
  5859 00001808 6640                    	inc	eax
  5860                                  
  5861                                  	; DX_AX = MAT (DAT header) sector address
  5862 0000180A BB[9C67]                	mov	bx, FS_MAT_Buffer
  5863                                  	; 16/02/2019
  5864 0000180D C7074D41                	mov	word [bx],'MA'
  5865 00001811 C6470254                	mov	byte [bx+2],'T'
  5866 00001815 E8F201                  	call	write_hd_sector
  5867 00001818 0F82BBFB                	jc	formatting_error
  5868 0000181C E8ABFB                  	call	write_fs_format_percent
  5869                                  
  5870                                  	; Calculate DAT bits 
  5871                                  	; NOTE: 4096 bits per DAT sector
  5872                                  	;mov	ax, [MAT_FirstFreeSector]
  5873                                  	;mov	dx, [MAT_FirstFreeSector+2]
  5874                                  	;;xor	dx, dx
  5875                                  	; 20/03/2021
  5876 0000181F 66A1[B467]              	mov	eax, [MAT_FirstFreeSector]
  5877 00001823 6631D2                  	xor	edx, edx
  5878                                  
  5879                                  	;push	dx
  5880                                  	;push	ax
  5881                                  	; 20/03/2021
  5882 00001826 6650                    	push	eax
  5883 00001828 B90010                  	mov	cx, 4096
  5884                                  	;call	div32
  5885                                  	;20/03/2021
  5886 0000182B 66F7F1                  	div	ecx
  5887                                  	;mov	[DAT_FFBit], bx
  5888                                  	;mov	[DAT_FFSector], ax
  5889                                  	;mov	[DAT_FFSector+2], dx
  5890                                  	; 20/03/2021
  5891 0000182E 8916[9467]              	mov	[DAT_FFBit], dx
  5892 00001832 66A3[9667]              	mov	[DAT_FFSector], eax	
  5893                                  	;pop	ax
  5894                                  	;pop	dx
  5895                                  	;sub	ax, 1
  5896                                  	;sbb	dx, 0
  5897                                  	; 20/03/2021
  5898 00001836 6658                    	pop	eax
  5899 00001838 6648                    	dec	eax	
  5900                                  
  5901                                  	;add	ax, [MAT_FreeSectors]
  5902                                  	;adc	dx, [MAT_FreeSectors+2]
  5903                                  	;call	div32
  5904                                  	;mov	[DAT_LFBit], bx
  5905                                  	;mov	[DAT_LFSector], ax
  5906                                  	; 20/03/2021
  5907 0000183A 31D2                    	xor	dx, dx
  5908 0000183C 660306[B067]            	add	eax, [MAT_FreeSectors]
  5909 00001841 66F7F1                  	div	ecx
  5910 00001844 8916[9867]              	mov	[DAT_LFBit], dx
  5911 00001848 66A3[9A67]              	mov	[DAT_LFSector], eax
  5912                                  
  5913                                  	;xor	si, si ; 0
  5914                                  	; 20/03/2021
  5915 0000184C 6631F6                  	xor	esi, esi ; 0
  5916                                  SINGLIX_fs1_f_4:
  5917                                  	; calculate free bits for current DAT sector
  5918                                  	;			(to be written)
  5919 0000184F BF[B867]                	mov	di, FS_DAT_Buffer
  5920                                  
  5921                                  	; 20/03/2021
  5922                                  	;cmp	si, [DAT_FFSector]
  5923 00001852 663B36[9667]            	cmp	esi, [DAT_FFSector]
  5924 00001857 7433                    	je	short SINGLIX_fs1_f_7
  5925 00001859 724F                    	jb	short SINGLIX_fs1_f_9
  5926                                  	
  5927                                  	;cmp	si, [DAT_LFSector]
  5928 0000185B 663B36[9A67]            	cmp	esi, [DAT_LFSector]
  5929 00001860 7225                    	jb	short SINGLIX_fs1_f_6
  5930 00001862 7746                    	ja	short SINGLIX_fs1_f_9
  5931                                  
  5932                                  	; 20/03/2021
  5933 00001864 8B0E[9867]              	mov	cx, [DAT_LFBit]
  5934 00001868 88CC                    	mov	ah, cl
  5935 0000186A C1E903                   	shr	cx, 3 ; bit count to byte count
  5936 0000186D 7404                    	jz	short SINGLIX_fs1_f_5
  5937                                  	;Example:
  5938                                  	;last free sector = 47 -> byte 5, bit 7
  5939                                  	;last free sector = 48 -> byte 6, bit 0
  5940                                  	; (also previous sectors are free sectors)
  5941 0000186F B0FF                    	mov	al, 0FFh ; 20/03/2021
  5942                                  	;mov	cx, bx
  5943 00001871 F3AA                    	rep	stosb
  5944                                  	; 20/03/2021
  5945                                  	;mov	di, FS_DAT_Buffer
  5946                                  	;add	di, bx
  5947                                  SINGLIX_fs1_f_5:
  5948 00001873 80E407                  	and	ah, 7
  5949                                  	;mov	cl, ah
  5950                                  	;shl	al, cl
  5951                                  	;not	al
  5952                                  	; 20/03/2021
  5953 00001876 30C0                    	xor	al, al
  5954                                  SINGLIX_fs1_f_13:
  5955                                  	; 20/03/2021 
  5956                                  	; 0 -> 00000001b (last free bit is bit 0)
  5957                                  	; 1 -> 00000011b (last free bit is bit 1)
  5958                                  	; 7 -> 11111111b (last free bit is bit 7)
  5959 00001878 0C01                    	or	al, 1
  5960 0000187A 08E4                    	or	ah, ah
  5961 0000187C 7406                    	jz	short SINGLIX_fs1_f_14
  5962 0000187E D0E0                    	shl	al, 1
  5963 00001880 FECC                    	dec	ah
  5964 00001882 EBF4                    	jmp	short SINGLIX_fs1_f_13
  5965                                  SINGLIX_fs1_f_14:
  5966 00001884 AA                      	stosb
  5967                                  	;mov	cx, 511
  5968                                  	;sub	cx, bx
  5969                                  	;jna	short SINGLIX_fs1_f_9
  5970                                  	;mov	al, 0 ; out of volume bits (=0)
  5971                                  	;rep	stosb
  5972 00001885 EB23                    	jmp	short SINGLIX_fs1_f_9
  5973                                  SINGLIX_fs1_f_6:
  5974 00001887 B90002                  	mov	cx, 512
  5975 0000188A EB1A                    	jmp	short SINGLIX_fs1_f_8
  5976                                  SINGLIX_fs1_f_7:
  5977                                  	; 20/03/2021
  5978                                  	;Example:
  5979                                  	;first free sector = 23 -> byte 2, bit 7
  5980                                  	;first free sector = 24 -> byte 3, bit 0
  5981                                  	; (previous sectors are allocated sectors)
  5982 0000188C 8B1E[9467]              	mov	bx, [DAT_FFBit]
  5983 00001890 88D9                    	mov	cl, bl
  5984 00001892 80E107                  	and	cl, 7
  5985 00001895 C1EB03                  	shr	bx, 3 ; from bits to bytes
  5986 00001898 01DF                    	add	di, bx
  5987 0000189A B0FF                    	mov	al, 0FFh
  5988 0000189C D2E0                    	shl	al, cl
  5989 0000189E AA                      	stosb
  5990 0000189F B9FF01                  	mov	cx, 511
  5991 000018A2 29D9                    	sub	cx, bx
  5992 000018A4 7604                    	jna	short SINGLIX_fs1_f_9
  5993                                  SINGLIX_fs1_f_8:
  5994 000018A6 B0FF                    	mov	al, 0FFh ; Free sector bits (=1)
  5995 000018A8 F3AA                    	rep	stosb
  5996                                  SINGLIX_fs1_f_9:
  5997                                  	;mov	ax, [MAT_BeginSector]
  5998                                  	;mov	dx, [MAT_BeginSector+2]
  5999                                  	;;add	ax, [DAT_Address] ; = 2
  6000                                  	;;adc	dx, [DAT_Address+2]
  6001                                  	;add	ax, 2
  6002                                  	;adc	dx, 0
  6003                                  	;add	ax, si
  6004                                  	;adc	dx, 0
  6005                                  	; 20/03/2021
  6006 000018AA 66A1[A467]              	mov	eax, [MAT_BeginSector]
  6007 000018AE 6683C002                	add	eax, 2 ; [DAT_Address] = 2
  6008 000018B2 6601F0                  	add	eax, esi
  6009                                  
  6010                                  	; Write DAT sector(s)
  6011                                  	;; DX_AX = Disk Allocation Table sector address
  6012                                  	; EAX = Disk Allocation Table sector address
  6013 000018B5 BB[B867]                	mov	bx, FS_DAT_Buffer
  6014 000018B8 E84F01                  	call	write_hd_sector
  6015 000018BB 0F8218FB                	jc	formatting_error
  6016 000018BF E808FB                  	call	write_fs_format_percent
  6017                                  	; Clear DAT buffer again (for next stage)
  6018 000018C2 B90001                  	mov	cx, 256
  6019 000018C5 BF[B867]                	mov	di, FS_DAT_Buffer
  6020 000018C8 29C0                    	sub	ax, ax
  6021 000018CA F3AB                    	rep	stosw
  6022                                  
  6023                                  	;inc	si
  6024                                  	;
  6025                                  	;cmp	si, [DAT_SectorCount]
  6026                                  	;jna	SINGLIX_fs1_f_4
  6027                                  
  6028                                  	; 20/03/2021
  6029 000018CC 6646                    	inc	esi
  6030 000018CE 663B36[AC67]            	cmp	esi, [DAT_SectorCount]
  6031 000018D3 0F8678FF                	jna	SINGLIX_fs1_f_4
  6032                                  	
  6033                                  	; 20/03/2021
  6034 000018D7 6631F6                  	xor esi, esi
  6035                                  
  6036                                  	; ;;;
  6037                                  	
  6038                                  	; DAT sectors has been written..
  6039                                  	; Now, Root Directory Description Table is in order
  6040                                  
  6041 000018DA BF[B867]                	mov	di, FS_RDT_Buffer
  6042 000018DD B84444                  	mov	ax, 'DD' 
  6043 000018E0 AB                      	stosw
  6044 000018E1 30E4                    	xor	ah, ah
  6045 000018E3 B054                    	mov	al, 'T'
  6046 000018E5 AB                      	stosw
  6047 000018E6 B80002                  	mov	ax, 512 ; Sector size (Bytes per sector)
  6048 000018E9 AB                      	stosw
  6049 000018EA 31C0                    	xor	ax, ax ; RDT sequence number (= 0, section 1)
  6050 000018EC AB                      	stosw	
  6051                                  	; RDT address
  6052                                  	;mov	ax, [DAT_SectorCount]
  6053                                  	;mov	dx, [DAT_SectorCount+2]
  6054                                  	;add	ax, 2 ; BS + MAT
  6055                                  	;adc	dx, 0
  6056                                  	;stosw
  6057                                  	;mov	ax, dx
  6058                                  	;stosw
  6059                                  	; 20/03/2021
  6060 000018ED 66A1[AC67]              	mov	eax, [DAT_SectorCount]
  6061 000018F1 6683C002                	add	eax, 2 ; BS + MAT
  6062 000018F5 66AB                    	stosd
  6063                                  
  6064                                  	;sub	ax, ax ; Next RDT number
  6065                                  	;stosw
  6066                                  	;stosw
  6067                                  	; 20/03/2021
  6068 000018F7 6629C0                  	sub	eax, eax
  6069 000018FA 66AB                    	stosd
  6070                                  
  6071                                  	;mov	ax, 4 ; Sector count of this section
  6072                                  	;	      ; (4*512)/4 = 512 root dir entries
  6073                                  	;stosw
  6074                                  	; 20/03/2021
  6075 000018FC B004                    	mov	al, 4
  6076                                  	;stosw
  6077                                  	;xor	al, al
  6078                                  	;stosw
  6079 000018FE 66AB                    	stosd
  6080                                  
  6081                                  	; Volume beginning sector
  6082                                  	;mov	ax, [bp+12]	; [bsBeginSector]
  6083                                  	;mov	dx, [bp+14]	; [bsBeginSector+2]
  6084                                  	;stosw
  6085                                  	;mov	ax, dx
  6086                                  	;stosw
  6087                                  	; 20/03/2021
  6088 00001900 668B460C                	mov	eax, [bp+12]	; [bsBeginSector]
  6089 00001904 66AB                    	stosd
  6090                                  
  6091                                  	;xor	ax, ax
  6092                                  	;dec	ax ; 0FFFFh
  6093                                  	;; Parent Dir Serial (= FFFFFFFFh for root dir)
  6094                                  	;stosw
  6095                                  	;stosw
  6096                                  	; 20/03/2021
  6097 00001906 6631C0                  	xor	eax, eax ; 0
  6098 00001909 6648                    	dec	eax ; 0FFFFFFFFh
  6099                                  	; Parent Dir Serial (= FFFFFFFFh for root dir) 
  6100 0000190B 66AB                    	stosd
  6101 0000190D 6640                    	inc	eax
  6102                                  	; eax = 0
  6103                                  set_fs_volume_serial_number:
  6104 0000190F BE[9067]                	mov	si, fs_volume_serial
  6105 00001912 A5                      	movsw
  6106 00001913 A5                      	movsw
  6107                                  
  6108                                  	; 20/03/2021
  6109                                  	;sub	ax, ax
  6110                                  	;stosb	; sub directory level = 0
  6111                                  	;stosb	; 0, reserved
  6112 00001914 AB                      	stosw
  6113 00001915 B004                    	mov	al, 00000100b ;  (DOS) System attribute
  6114 00001917 AA                      	stosb	; (DOS) Basic attributes
  6115 00001918 28C0                    	sub	al, al ; Extended attributes (0 for TRDOS 386)
  6116 0000191A AA                      	stosb
  6117                                  	; 20/03/2021
  6118                                  	;sub	ax, ax ; reserved (8) bytes for TR-MULTIX
  6119 0000191B AB                      	stosw
  6120 0000191C AB                      	stosw
  6121 0000191D AB                      	stosw
  6122 0000191E AB                      	stosw
  6123 0000191F B85254                  	mov	ax, 'RT' ; TRFS Root directory signature
  6124 00001922 AB                      	stosw
  6125 00001923 31C0                    	xor	ax, ax ; Country (language, date, text format)
  6126                                  		       ; (0 = Default, 1 = USA, 90 = Turkiye)
  6127                                  	;stosb
  6128                                  	;stosb	; Time Zone (0 = GMT = default ; -11 to +12)
  6129 00001925 AB                      	stosw
  6130                                  
  6131 00001926 89FE                    	mov	si, di
  6132                                  	; get the date (from RTC)
  6133 00001928 B404                    	mov	ah, 4
  6134 0000192A CD1A                    	int	1Ah
  6135                                  	; Creating Date (of root directory)
  6136 0000192C 86E9                    	xchg	ch, cl ; 07/01/2018
  6137 0000192E 89C8                    	mov	ax, cx ; cl = century (BCD), ch = year (BCD)
  6138 00001930 AB                      	stosw
  6139 00001931 88F0                    	mov	al, dh  ; month (BCD)
  6140 00001933 AA                      	stosb
  6141 00001934 88D0                    	mov	al, dl  ; day (BCD)
  6142 00001936 AA                      	stosb
  6143                                  	; get the time (from RTC)
  6144 00001937 B402                    	mov	ah, 2
  6145 00001939 CD1A                    	int	1Ah
  6146                                  	; Creating Time (of root directory)
  6147 0000193B 86CD                    	xchg	cl, ch ; ch = hour (BCD), cl = minute (BSD)
  6148 0000193D 89C8                    	mov	ax, cx ; al = hour, ah = minute
  6149 0000193F AB                      	stosw
  6150 00001940 88F0                    	mov	al, dh ; seconds (BCD)
  6151 00001942 AA                      	stosb
  6152 00001943 88D0                    	mov	al, dl ; daylight savings time option
  6153 00001945 AA                      	stosb
  6154                                  	; Set Last Modification Date&Time
  6155 00001946 B90400                  	mov	cx, 4
  6156 00001949 F3A5                    	rep	movsw ; copy creating date&time values to
  6157                                  		; last modification date time values
  6158                                  		; (last modif date&time = creating date&time)
  6159                                  
  6160                                  set_fs_volume_name:
  6161 0000194B BE[5067]                	mov	si, fs_volume_name
  6162 0000194E B120                    	mov	cl, 32 
  6163 00001950 F3A5                    	rep	movsw
  6164                                  
  6165                                  	; Fill remain bytes (of this RDT) with zero
  6166 00001952 B9C000                  	mov	cx, (128+256)/2
  6167 00001955 31C0                    	xor	ax, ax
  6168 00001957 F3AB                    	rep	stosw
  6169                                  
  6170                                  	; RDT is ready here...
  6171                                  
  6172                                  	;mov	ax, [bp+28]	; [bsRootDirDT]
  6173                                  	;mov	dx, [bp+30]	; [bsRootDirDT+2]
  6174                                  	;;xor	dx, dx
  6175                                  	;add	ax, [bp+12]	; [bsBeginSector]
  6176                                  	;adc	dx, [bp+14]	; [bsBeginSector+2]
  6177                                  	; 20/03/2021
  6178 00001959 668B461C                	mov	eax, [bp+28]	; [bsRootDirDT]
  6179 0000195D 6603460C                	add	eax, [bp+12]	; [bsBeginSector]
  6180                                  
  6181                                  	; Write RDT sector
  6182                                  	;; DX_AX = Root Directory Description Table address
  6183                                  	; EAX = Root Directory Description Table address
  6184 00001961 BB[B867]                	mov	bx, FS_RDT_Buffer
  6185 00001964 E8A300                  	call	write_hd_sector
  6186 00001967 0F826CFA                	jc	formatting_error
  6187 0000196B E85CFA                  	call	write_fs_format_percent
  6188                                  
  6189                                  	;add	ax, 1
  6190                                  	;adc	dx, 0
  6191                                  	; 20/03/2021
  6192 0000196E 6640                    	inc	eax
  6193                                  
  6194                                  	; write root directory data sectors
  6195                                  	;mov	cx, 4
  6196                                  	; 20/03/2021
  6197 00001970 B104                    	mov	cl, 4
  6198                                  SINGLIX_fs1_f_10:
  6199 00001972 51                      	push	cx
  6200                                  	; Write root directory sector(s)
  6201                                  	; DX_AX = Root Directory Sector address
  6202 00001973 BB[3A65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  6203 00001976 E89100                  	call	write_hd_sector
  6204 00001979 0F825AFA                	jc	formatting_error
  6205 0000197D E84AFA                  	call	write_fs_format_percent
  6206                                  	;add	ax, 1
  6207                                  	;adc	dx, 0
  6208                                  	; 20/03/2021
  6209 00001980 6640                    	inc	eax
  6210 00001982 59                      	pop	cx
  6211 00001983 FEC9                    	dec	cl
  6212 00001985 75EB                    	jnz	short SINGLIX_fs1_f_10
  6213                                  
  6214                                  	; Fill remain sectors with 'F6h' bytes
  6215                                  	;mov	cx, [bp+16]	; [bsVolumeSize]
  6216                                  	;mov	bx, [bp+18]	; [bsVolumeSize+2]
  6217                                  	;add	cx, [bp+12]	; [bsBeginSector]
  6218                                  	;adc	bx, [bp+14]	; [bsBeginSector+2]
  6219                                  	; 20/03/2021
  6220 00001987 668B5610                	mov	edx, [bp+16]	; [bsVolumeSize]
  6221 0000198B 6603560C                	add	edx, [bp+12]	; [bsBeginSector]
  6222                                  
  6223                                  	; write DATA sectors 
  6224                                  	; (after root directory sectors)
  6225                                  SINGLIX_fs1_f_11:
  6226                                  	;push	bx
  6227                                  	;push	cx
  6228                                  	; 20/03/2021
  6229                                  	;push	edx ; *
  6230 0000198F BB[2661]                	mov	bx, HDFORMAT_SECBUFFER
  6231 00001992 E87500                  	call	write_hd_sector
  6232 00001995 0F823EFA                	jc	formatting_error
  6233 00001999 E8EBF9                  	call	write_format_percent
  6234                                  	;pop	cx
  6235                                  	;pop	bx
  6236                                  	; 20/03/2021
  6237                                  	;pop	edx ; *
  6238                                  	
  6239                                  	;add	ax, 1
  6240                                  	;adc	dx, 0
  6241                                  	; 20/03/2021
  6242 0000199C 6640                    	inc	eax	
  6243                                  
  6244                                  	;cmp	dx, bx
  6245                                  	;jb	short SINGLIX_fs1_f_11
  6246                                  	;ja	SINGLIX_fs1_f_12
  6247                                  	;cmp	ax, cx
  6248                                  	;jb	short SINGLIX_fs1_f_11
  6249                                  	; 20/03/2021
  6250 0000199E 6639D0                  	cmp	eax, edx
  6251 000019A1 72EC                    	jb	short SINGLIX_fs1_f_11
  6252                                  
  6253                                  	; 20/03/2021
  6254                                  	; (this may not be needed)
  6255                                  	; (but cleaering hw of 32 bit regs may be useful)) 
  6256 000019A3 6631D2                  	xor	edx, edx 
  6257 000019A6 6631C0                  	xor	eax, eax
  6258                                  
  6259 000019A9 E9BBF8                  	jmp	SINGLIX_fs1_f_12
  6260                                  
  6261                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6262                                  ; print messages
  6263                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6264                                  
  6265                                  print_msg:
  6266                                  
  6267                                  print_msg_LOOP:
  6268 000019AC AC                      	lodsb                           ; Load byte at DS:SI to AL
  6269 000019AD 20C0                    	and     al, al
  6270 000019AF 7409                    	jz      short print_msg_OK
  6271 000019B1 B40E                    	mov	ah, 0Eh
  6272 000019B3 BB0700                  	mov     bx, 07h
  6273 000019B6 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  6274                                  					; Write char as TTY
  6275                                  					; AL-char BH-page BL-color
  6276 000019B8 EBF2                    	jmp     short print_msg_LOOP
  6277                                  
  6278                                  print_msg_OK:
  6279 000019BA C3                      	retn
  6280                                  
  6281                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6282                                  ; reading a block (sector) on hard disk
  6283                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6284                                  ; 17/10/2020
  6285                                  
  6286                                  	; 09/03/2021 (fdisk4.s)
  6287                                  read_hd_sector:
  6288                                  
  6289                                  	; INPUT -> DX_AX = Logical Block Address
  6290                                  	; 	   ES:BX = Sector Buffer
  6291                                  	; OUTPUT ->
  6292                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  6293                                  	;	     ES:BX = Sector Buffer
  6294                                  	;  cf = 1 -> AH = Error Number
  6295                                  
  6296                                  	; 09/03/2021
  6297                                  	; INPUT -> EAX = Logical Block Address
  6298                                  	; 	   ES:BX = Sector buffer
  6299                                  
  6300                                  	;cmp	dx, [chs_limit+2]
  6301                                  	;ja	short read_lba_sector
  6302                                  	;jb	short read_chs_sector
  6303                                  	;cmp	ax, [chs_limit]
  6304                                  	;ja	short read_lba_sector
  6305                                  	;;jmp	short read_chs_sector
  6306                                  
  6307                                  	; 09/03/2021
  6308 000019BB 663B06[3265]            	cmp	eax, [chs_limit]
  6309 000019C0 7707                    	ja	short read_lba_sector
  6310                                  
  6311                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6312                                  ; reading a block (sector) by using CHS read (ROMBIOS) function
  6313                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6314                                  ; 17/10/2020
  6315                                  
  6316                                  read_chs_sector:
  6317                                  	; hdformat.s (25/09/2020)
  6318 000019C2 C606[2C65]02            	mov	byte [rw], 2 ; read
  6319 000019C7 EB4D                    	jmp	short chs_rw
  6320                                  
  6321                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6322                                  ; reading a block (sector) by using LBA read (ROMBIOS) function
  6323                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6324                                  ; 17/10/2020
  6325                                  
  6326                                  read_lba_sector:
  6327                                  	; hdformat.s (25/09/2020)
  6328 000019C9 C606[2C65]42            	mov	byte [rw], 42h
  6329 000019CE EB05                    	jmp	short lba_rw
  6330                                  
  6331                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6332                                  ; writing a block (sector) by using LBA write (ROMBIOS) function
  6333                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6334                                  ; 17/10/2020
  6335                                  
  6336                                  	; 18/10/2020 
  6337                                  write_lba_sector:
  6338                                  	; hdformat.s (25/09/2020)
  6339 000019D0 C606[2C65]43            	mov	byte [rw], 43h
  6340                                  	;jmp	short lba_rw
  6341                                  lba_rw:
  6342                                  	;mov	di, 5
  6343                                  	; 18/10/2020
  6344 000019D5 C606[2D65]05            	mov	byte [rcnt], 5  ; Retry count
  6345                                  lba_rw_1:
  6346                                  	;pusha			; db 60h
  6347 000019DA 60                      	db	60h
  6348                                  	;push 	0		; db 6Ah, 00h
  6349 000019DB 6A00                    	db	6Ah, 0
  6350                                  	;push	0		; db 6Ah, 00h
  6351 000019DD 6A00                    	db	6Ah, 0
  6352                                  	;push	dx
  6353                                  	;push	ax
  6354                                  	; 09/03/2021
  6355 000019DF 6650                    	push	eax
  6356 000019E1 06                      	push    es
  6357 000019E2 53                      	push    bx
  6358                                  	;push	1		; db 6Ah, 01h
  6359 000019E3 6A01                    	db	6Ah, 01h                     
  6360                                  	;push	10h		; db 6Ah, 10h
  6361 000019E5 6A10                    	db	6Ah, 10h
  6362                                  
  6363 000019E7 89E6                    	mov     si, sp
  6364 000019E9 8A16[2A65]              	mov     dl, [DrvNum]
  6365 000019ED 30C0                    	xor	al, al	; verify off 
  6366                                  lba_rw_2:
  6367 000019EF 8A26[2C65]              	mov     ah, [rw] ; 42h = LBA read, 43h = LBA write
  6368                                  	;xor	al, al	; verify off 
  6369 000019F3 CD13                    	int     13h
  6370                                  
  6371                                  	;mov	[error], ah
  6372 000019F5 7310                    	jnc     short lba_rw_3
  6373                                  
  6374                                  	;dec	di 
  6375                                  	; 18/10/2020
  6376 000019F7 FE0E[2D65]              	dec	byte [rcnt]
  6377 000019FB 740A                    	jz	short lba_rw_3 
  6378                                          
  6379 000019FD 30E4                    	xor	ah, ah
  6380                                  	;mov	dl, [DrvNum]
  6381 000019FF CD13                    	int	13h	; BIOS Service func (ah) = 0
  6382                                  			; Reset disk system
  6383                                  
  6384                                  	;mov	word [si+2], 1 ; set r/w count to 1 again
  6385 00001A01 C6440201                	mov	byte [si+2], 1
  6386                                  
  6387 00001A05 EBE8                    	jmp	short lba_rw_2
  6388                                  
  6389                                  lba_rw_3:
  6390                                  	;popa
  6391 00001A07 61                      	db	61h
  6392                                  	;popa
  6393 00001A08 61                      	db	61h
  6394 00001A09 C3                      	retn
  6395                                  
  6396                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6397                                  ; writing a block (sector) on hard disk
  6398                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6399                                  ; 17/10/2020
  6400                                  
  6401                                  	; 09/03/2021 (fdisk4.s)
  6402                                  write_hd_sector:
  6403                                  
  6404                                  	; INPUT -> DX_AX = Logical Block Address
  6405                                  	; 	   ES:BX = Sector Buffer
  6406                                  	; OUTPUT ->
  6407                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  6408                                  	;	     ES:BX = Sector Buffer
  6409                                  	;  cf = 1 -> AH = Error Number
  6410                                  
  6411                                  	; 09/03/2021
  6412                                  	; INPUT -> EAX = Logical Block Address
  6413                                  	; 	   ES:BX = Sector buffer
  6414                                  
  6415                                  	;cmp	dx, [chs_limit+2]
  6416                                  	;ja	short write_lba_sector
  6417                                  	;jb	short write_chs_sector
  6418                                  	;cmp	ax, [chs_limit]
  6419                                  	;ja	short write_lba_sector
  6420                                  	;;jmp	short write_chs_sector
  6421                                  
  6422                                  	; 09/03/2021
  6423 00001A0A 663B06[3265]            	cmp	eax, [chs_limit]
  6424 00001A0F 77B8                    	ja	short read_lba_sector
  6425                                  
  6426                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6427                                  ; writing a block (sector) by using CHS write (ROMBIOS) function
  6428                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6429                                  ; 17/10/2020
  6430                                  	
  6431                                  	; 18/10/2020
  6432                                  write_chs_sector:
  6433                                  	; hdformat.s (25/09/2020)
  6434 00001A11 C606[2C65]03            	mov	byte [rw], 3 ; write
  6435                                  	;jmp	short chs_rw
  6436                                  
  6437                                  	; 09/03/2021
  6438                                  chs_rw:
  6439 00001A16 56                      	push	si
  6440                                          ;push	cx
  6441                                  	; 09/03/2021
  6442 00001A17 6651                    	push	ecx
  6443                                  chs_rw_0:
  6444                                  	;mov	di, 5
  6445                                  	; 18/10/2020
  6446 00001A19 C606[2D65]05            	mov	byte [rcnt], 5  ; Retry count
  6447                                  chs_rw_1:               
  6448                                  	;push	dx	; Linear sector #
  6449                                  	;push	ax	; DX_AX = Linear address (sectors)
  6450                                  	;mov	cx, [sectors]
  6451                                  	;push	bx
  6452                                  	;
  6453                                  	;call	div32	; 32 bit divide
  6454                                  
  6455                                  	; 09/03/2021
  6456 00001A1E 6652                    	push	edx
  6457 00001A20 6650                    	push	eax
  6458 00001A22 6631D2                  	xor	edx, edx
  6459 00001A25 6631C9                  	xor	ecx, ecx
  6460 00001A28 8B0E[9E3C]              	mov	cx, [sectors]
  6461 00001A2C 66F7F1                  	div	ecx
  6462 00001A2F 42                      	inc	dx
  6463 00001A30 52                      	push	dx  ; sector (1 based)
  6464 00001A31 8B0E[A03C]              	mov	cx, [heads]
  6465 00001A35 66F7F1                  	div	ecx
  6466 00001A38 88D6                    	mov	dh, dl ; head
  6467 00001A3A 59                      	pop	cx
  6468                                  
  6469                                  	;mov	cx, bx	; Sector (zero based)
  6470                                  	;inc	cx	; To make it 1 based
  6471                                  	;push	cx
  6472                                  	;mov	cx, [heads]
  6473                                  	;call	div32	; Convert track to head & cyl
  6474                                  	;mov	dh, bl	; BX = Head (max. FFh)
  6475                                  	;pop	cx	; AX=Cyl, DH=Head, CX=Sector
  6476                                  	;pop	bx	; ES:BX = Buffer
  6477                                  
  6478 00001A3B 8A16[2A65]              	mov	dl, [DrvNum]
  6479 00001A3F 88C5                    	mov	ch, al
  6480 00001A41 D0CC                    	ror	ah, 1	; Rotate right
  6481 00001A43 D0CC                    	ror	ah, 1
  6482 00001A45 08E1                    	or	cl, ah
  6483                                  chs_rw_2:
  6484 00001A47 8A26[2C65]              	mov	ah, [rw] ; 02h = read, 03h = write
  6485 00001A4B B001                    	mov	al, 01h
  6486 00001A4D CD13                    	int	13h	; BIOS Service func (ah) = 2/3
  6487                                  			; Read/Write disk sectors
  6488                                  			; AL-sec num CH-track CL-sec
  6489                                  			; DH-head DL-drive ES:BX-buffer
  6490                                  			; CF-flag AH-status AL-sectors written/read
  6491                                  			; If CF = 1 then AH = Error code (>0)
  6492                                          
  6493 00001A4F 730C                    	jnc     short chs_rw_3
  6494                                  	;dec	di
  6495 00001A51 FE0E[2D65]              	dec	byte [rcnt] ; 18/10/2020
  6496 00001A55 7406                    	jz	short chs_rw_3 
  6497                                          
  6498 00001A57 30E4                    	xor	ah, ah
  6499                                  	;mov	dl, [DrvNum]
  6500 00001A59 CD13                    	int	13h	; BIOS Service func (ah) = 0
  6501                                  			; Reset disk system
  6502 00001A5B EBEA                    	jmp	short chs_rw_2
  6503                                  
  6504                                  chs_rw_3:
  6505                                  	;pop	ax
  6506                                  	;pop	dx
  6507                                  	;pop	cx
  6508                                  	; 09/03/2021
  6509 00001A5D 6658                    	pop	eax
  6510 00001A5F 665A                    	pop	edx
  6511 00001A61 6659                    	pop	ecx
  6512 00001A63 5E                      	pop	si
  6513 00001A64 C3                      	retn
  6514                                  	
  6515                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6516                                  ; convert byte to decimal number
  6517                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6518                                  
  6519                                  	; 16/03/2021 (fdisk4.s)
  6520                                  bin_to_decimal:
  6521                                  	; INPUT: DS:SI = Target location
  6522                                  	;        DX_AX = Binary Number (Integer)
  6523                                  	; OUTPUT: Decimal char at DS:SI
  6524                                  	; 	 SI decremented after every division
  6525                                  	; 	 till AX<10.
  6526                                  	; CX, DX, BX will be changed.
  6527                                  
  6528                                  	; 16/03/2021
  6529                                  	; INPUT:
  6530                                  	;	DS:SI = Target location
  6531                                  	;	EAX = Binary number
  6532                                  	; OUTPUT: Decimal char at DS:SI
  6533                                  	; 	SI decremented after every division
  6534                                  	; 	till EAX<10.
  6535                                  	;
  6536                                  	; Modified regaisters: ecx (=10), edx (<10)
  6537                                  
  6538                                  	;mov	cx, 10
  6539                                  	; 16/03/2021
  6540 00001A65 6631C9                  	xor	ecx, ecx
  6541 00001A68 B10A                    	mov	cl, 10
  6542 00001A6A 6631D2                  	xor	edx, edx
  6543                                  btd_0:
  6544                                  	;; DX_AX = Dividend
  6545                                  	;; CX = Divisor
  6546                                  	;call	div32
  6547                                  	;; DX_AX = Quotient
  6548                                  	;; BX = remainder
  6549                                  	;add	bl, '0'
  6550                                  	;mov	[si], bl
  6551                                  	;and	dx, dx
  6552                                  	;jz	short btd_2
  6553                                  	; 16/03/2021
  6554 00001A6D 66F7F1                  	div	ecx
  6555                                  		; eax = quotient
  6556                                  		; dl = remainder
  6557 00001A70 80C230                  	add	dl, '0'
  6558 00001A73 8814                    	mov	[si], dl
  6559 00001A75 6621C0                  	and	eax, eax
  6560 00001A78 7405                    	jz	short btd_1
  6561                                  ;btd_1:
  6562 00001A7A 4E                      	dec	si
  6563 00001A7B 30D2                    	xor	dl, dl ; 16/03/2021
  6564 00001A7D EBEE                    	jmp	short btd_0
  6565                                  ;btd_2:
  6566                                  	;or	ax, ax
  6567                                  	;jnz	short btd_1
  6568                                  btd_1:
  6569 00001A7F C3                      	retn
  6570                                  
  6571                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6572                                  ; convert byte to hexadecimal number
  6573                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6574                                  
  6575                                  byte_to_hex: ; 04/02/2019
  6576                                  bin_to_hex:
  6577                                  	; INPUT ->
  6578                                  	; 	AL = byte (binary number)
  6579                                  	; OUTPUT ->
  6580                                  	;	AX = hexadecimal string
  6581                                  	;
  6582 00001A80 53                      	push	bx
  6583 00001A81 31DB                    	xor	bx, bx
  6584 00001A83 88C3                    	mov	bl, al
  6585 00001A85 C0EB04                  	shr	bl, 4
  6586 00001A88 8A9F[8D3C]              	mov	bl, [bx+hexchrs]
  6587 00001A8C 86D8                    	xchg	bl, al
  6588 00001A8E 80E30F                  	and	bl, 0Fh
  6589 00001A91 8AA7[8D3C]              	mov	ah, [bx+hexchrs]
  6590 00001A95 5B                      	pop	bx	
  6591 00001A96 C3                      	retn
  6592                                  
  6593                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6594                                  ; read & write characters
  6595                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6596                                  
  6597                                  rw_char:
  6598                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  6599 00001A97 BE[B551]                	mov     si, StrVolumeName
  6600 00001A9A BB0700                  	mov     bx, 7
  6601 00001A9D B403                    	mov     ah, 3
  6602 00001A9F CD10                    	int     10h
  6603 00001AA1 8916[9C51]              	mov     [Cursor_Pos], dx
  6604                                  read_next_char:
  6605 00001AA5 30E4                    	xor     ah, ah
  6606 00001AA7 CD16                    	int     16h
  6607 00001AA9 20C0                    	and     al, al
  6608 00001AAB 7439                    	jz      short loc_arrow
  6609 00001AAD 3CE0                    	cmp     al, 0E0h
  6610 00001AAF 7435                    	je      short loc_arrow
  6611 00001AB1 3C08                    	cmp     al, 8
  6612 00001AB3 753D                    	jne     short char_return
  6613                                  loc_back:
  6614 00001AB5 B403                    	mov     ah, 3
  6615 00001AB7 CD10                    	int     10h
  6616 00001AB9 3A16[9C51]              	cmp     dl, byte [Cursor_Pos]
  6617 00001ABD 761F                    	jna     short loc_beep
  6618                                  prev_column:
  6619 00001ABF FECA                    	dec     dl
  6620                                  set_cursor_pos:
  6621 00001AC1 B402                    	mov     ah, 2
  6622 00001AC3 CD10                    	int     10h
  6623 00001AC5 88D3                    	mov     bl, dl
  6624 00001AC7 2A1E[9C51]              	sub     bl, byte [Cursor_Pos]
  6625 00001ACB B90100                  	mov     cx, 1
  6626 00001ACE B409                    	mov     ah, 9
  6627 00001AD0 B020                    	mov     al, 20h
  6628 00001AD2 8800                    	mov     [si+bx], al
  6629                                  loc_write_it:
  6630 00001AD4 B307                    	mov     bl, 7
  6631 00001AD6 CD10                    	int     10h
  6632 00001AD8 8B16[9C51]              	mov     dx, [Cursor_Pos]
  6633 00001ADC EBC7                    	jmp     short read_next_char
  6634                                  loc_beep:
  6635 00001ADE B40E                    	mov     ah, 0Eh
  6636 00001AE0 B007                    	mov     al, 7
  6637 00001AE2 CD10                    	int     10h
  6638 00001AE4 EBBF                    	jmp     short read_next_char
  6639                                  loc_arrow:    
  6640 00001AE6 80FC4B                  	cmp     ah, 4Bh
  6641 00001AE9 74CA                    	je      short loc_back
  6642 00001AEB 80FC53                  	cmp     ah, 53h
  6643 00001AEE 74C5                    	je      short loc_back
  6644 00001AF0 EBB3                    	jmp     short read_next_char
  6645                                  char_return:
  6646 00001AF2 B403                    	mov     ah, 3
  6647 00001AF4 CD10                    	int     10h
  6648                                  check_char_type:
  6649 00001AF6 3C20                    	cmp     al, 20h
  6650 00001AF8 7229                    	jb      short loc_escape
  6651 00001AFA 88D4                    	mov     ah, dl
  6652 00001AFC 2A26[9C51]              	sub     ah, byte [Cursor_Pos]
  6653                                  	;cmp	ah, 10 
  6654                                  	;ja	short loc_beep
  6655 00001B00 3A26[0F61]              	cmp     ah, [vname_length] ; 05/01/2018
  6656 00001B04 73D8                    	jnb	short loc_beep
  6657 00001B06 3C7A                    	cmp     al, 'z'
  6658 00001B08 779B                    	ja      short read_next_char
  6659 00001B0A 3C61                    	cmp     al, 'a'
  6660 00001B0C 7202                    	jb      short pass_capitalize
  6661 00001B0E 24DF                    	and     al, 0DFh
  6662                                  pass_capitalize:
  6663 00001B10 88E3                    	mov     bl, ah 
  6664 00001B12 30E4                    	xor     ah, ah
  6665 00001B14 8900                    	mov     [si+bx], ax
  6666 00001B16 B307                    	mov     bl, 7
  6667 00001B18 B40E                    	mov     ah, 0Eh
  6668 00001B1A CD10                    	int     10h
  6669 00001B1C EB87                    	jmp     short read_next_char
  6670                                  pass_escape:
  6671 00001B1E 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  6672 00001B20 7583                    	jne     short read_next_char
  6673                                  	;mov	ah, 0Eh
  6674                                  	;int	10h
  6675                                  	;mov	al, 0Ah
  6676                                  	;int	10h
  6677 00001B22 C3                      	retn
  6678                                  loc_escape:
  6679 00001B23 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  6680 00001B25 75F7                    	jne     short pass_escape
  6681 00001B27 F9                      	stc
  6682 00001B28 C3                      	retn
  6683                                  
  6684                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6685                                  ; display CHS table
  6686                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6687                                  
  6688                                  	; 09/03/2021 (fdisk4.s)
  6689                                  display_chs_table:
  6690                                  
  6691                                  	; 16/10/2020
  6692                                  	; 12/10/2020 (fdisk3)
  6693                                  	; 11/02/2019 (hdimage)
  6694                                  
  6695 00001B29 06                      	push	es
  6696 00001B2A BF00B8                  	mov	di, 0B800h
  6697 00001B2D 8EC7                    	mov	es, di
  6698 00001B2F BFA000                  	mov	di, 160 ; row 1
  6699 00001B32 B407                    	mov	ah, 07h
  6700 00001B34 B044                    	mov	al, 'D'
  6701 00001B36 AB                      	stosw
  6702 00001B37 B069                    	mov	al, 'i'
  6703 00001B39 AB                      	stosw
  6704 00001B3A B073                    	mov	al, 's'
  6705 00001B3C AB                      	stosw
  6706 00001B3D B06B                    	mov	al, 'k'
  6707 00001B3F AB                      	stosw
  6708 00001B40 B03A                    	mov	al, ':'
  6709 00001B42 AB                      	stosw
  6710 00001B43 B020                    	mov	al, ' '
  6711 00001B45 AB                      	stosw
  6712 00001B46 B068                    	mov	al, 'h'
  6713 00001B48 AB                      	stosw
  6714 00001B49 B064                    	mov	al, 'd'
  6715 00001B4B AB                      	stosw
  6716 00001B4C A0[2A65]                	mov	al, [DrvNum]
  6717 00001B4F 2C50                    	sub	al, 80h-'0'
  6718 00001B51 AB                      	stosw
  6719 00001B52 BF4001                  	mov	di, 320 ; row 2
  6720 00001B55 B95000                  	mov	cx, 80
  6721 00001B58 B82007                  	mov	ax, 0720h
  6722 00001B5B F3AB                    	rep	stosw
  6723 00001B5D B150                    	mov	cl, 80	; row 3
  6724 00001B5F B02D                    	mov	al, "-"
  6725 00001B61 F3AB                    	rep	stosw
  6726                                  	;mov	cl, 19
  6727 00001B63 B112                    	mov	cl, 18 ; 16/10/2020 ; row 4
  6728 00001B65 B020                    	mov	al, 20h
  6729 00001B67 F3AB                    	rep	stosw
  6730 00001B69 B043                    	mov	al, 'C'
  6731 00001B6B AB                      	stosw
  6732 00001B6C B079                    	mov	al, 'y'
  6733 00001B6E AB                      	stosw
  6734 00001B6F B06C                    	mov	al, 'l'
  6735 00001B71 AB                      	stosw
  6736 00001B72 B069                    	mov	al, 'i'
  6737 00001B74 AB                       	stosw
  6738 00001B75 B06E                    	mov	al, 'n'
  6739 00001B77 AB                      	stosw	
  6740 00001B78 B064                    	mov	al, 'd'
  6741 00001B7A AB                      	stosw
  6742 00001B7B B065                    	mov	al, 'e'
  6743 00001B7D AB                      	stosw
  6744 00001B7E B072                    	mov	al, 'r'
  6745 00001B80 AB                       	stosw
  6746 00001B81 B073                    	mov	al, 's'
  6747 00001B83 AB                       	stosw
  6748 00001B84 B03A                    	mov	al, ':'
  6749 00001B86 AB                      	stosw
  6750 00001B87 B020                    	mov	al, 20h
  6751 00001B89 AB                      	stosw
  6752                                  	;mov	[cylnumpos], di
  6753                                  	
  6754                                  	; 09/03/2021
  6755                                  	;mov	ax, [cylinders]
  6756                                  	;mov	dx, [cylinders+2] ; 16/10/2020
  6757 00001B8A 66A1[A23C]              	mov	eax, [cylinders]
  6758                                  
  6759                                  	;mov	cl, 4
  6760                                  	;mov	ch, 07h ; color
  6761 00001B8E E86600                  	call	write_number
  6762                                  	
  6763                                  	;mov	ax, 0720h
  6764 00001B91 B020                    	mov	al, 20h ; 16/10/2020
  6765 00001B93 AB                      	stosw
  6766 00001B94 AB                      	stosw
  6767 00001B95 B048                    	mov	al, 'H'
  6768 00001B97 AB                      	stosw
  6769 00001B98 B065                    	mov	al, 'e'
  6770 00001B9A AB                      	stosw
  6771 00001B9B B061                    	mov	al, 'a'
  6772 00001B9D AB                      	stosw
  6773 00001B9E B064                    	mov	al, 'd'
  6774 00001BA0 AB                       	stosw
  6775 00001BA1 B073                    	mov	al, 's'
  6776 00001BA3 AB                       	stosw
  6777 00001BA4 B03A                    	mov	al, ':'
  6778 00001BA6 AB                      	stosw
  6779 00001BA7 B020                    	mov	al, 20h
  6780 00001BA9 AB                      	stosw
  6781                                  	;mov	[hednumpos], di
  6782                                  	
  6783                                  	; 09/03/2021
  6784                                  	;mov	ax, [heads]
  6785                                  	;xor	dx, dx ; 16/10/2020
  6786                                  	;
  6787                                  	;movzx	eax, word [heads]
  6788                                  	; eax < 65536
  6789 00001BAA A1[A03C]                	mov	ax, [heads]
  6790                                  
  6791                                  	;mov	cl, 2
  6792                                  	;mov	ch, 07h ; color
  6793 00001BAD E84700                  	call	write_number
  6794                                  
  6795                                  	;mov	ax, 0720h
  6796 00001BB0 B020                    	mov	al, 20h ; 16/10/2020
  6797 00001BB2 AB                      	stosw
  6798 00001BB3 AB                      	stosw
  6799 00001BB4 B053                    	mov	al, 'S'
  6800 00001BB6 AB                      	stosw
  6801 00001BB7 B065                    	mov	al, 'e'
  6802 00001BB9 AB                      	stosw
  6803 00001BBA B063                    	mov	al, 'c'
  6804 00001BBC AB                      	stosw
  6805 00001BBD B074                    	mov	al, 't'
  6806 00001BBF AB                       	stosw
  6807 00001BC0 B06F                    	mov	al, 'o'
  6808 00001BC2 AB                      	stosw
  6809 00001BC3 B072                    	mov	al, 'r'
  6810 00001BC5 AB                       	stosw
  6811 00001BC6 B073                    	mov	al, 's'
  6812 00001BC8 AB                       	stosw
  6813 00001BC9 B03A                    	mov	al, ':'
  6814 00001BCB AB                      	stosw
  6815 00001BCC B020                    	mov	al, 20h
  6816 00001BCE AB                      	stosw
  6817                                  	;mov	[secnumpos], di
  6818                                  
  6819                                  	; 09/03/2021
  6820                                  	;mov	ax, [sectors]
  6821                                  	;sub	dx, dx ; 16/10/2020
  6822                                  	;
  6823                                  	;movzx	eax, [sectors]
  6824                                  	; eax < 65536
  6825 00001BCF A1[9E3C]                	mov	ax, [sectors]
  6826                                  
  6827                                  	;mov	cl, 2
  6828                                  	;mov	ch, 07h ; color
  6829 00001BD2 E82200                  	call	write_number
  6830                                  
  6831 00001BD5 B92003                  	mov	cx, 800 ; 16/10/2020 ; row 5
  6832 00001BD8 29F9                    	sub	cx, di
  6833 00001BDA D0E9                    	shr	cl, 1
  6834                                  	;mov	cl, 22
  6835                                  	;mov	ax, 0720h
  6836 00001BDC B020                    	mov	al, 20h ; 16/10/2020
  6837 00001BDE F3AB                    	rep	stosw
  6838                                  	
  6839 00001BE0 B150                    	mov	cl, 80 	; row 6
  6840 00001BE2 B02D                    	mov	al, "-"
  6841 00001BE4 F3AB                    	rep	stosw
  6842                                  
  6843 00001BE6 B150                    	mov	cl, 80	 ; row 7
  6844                                  	;mov	cl, 160	 ; row 7, 8
  6845 00001BE8 B020                    	mov	al, 20h
  6846 00001BEA F3AB                    	rep	stosw
  6847                                  
  6848 00001BEC BA0006                  	mov	dx, 0600h ; DH = row, DL = 0 column
  6849 00001BEF 31DB                    	xor	bx, bx ; BH = video page (0)
  6850 00001BF1 B402                    	mov	ah, 02h ; set cursor position
  6851 00001BF3 CD10                    	int	10h
  6852                                  
  6853 00001BF5 07                      	pop	es
  6854 00001BF6 C3                      	retn
  6855                                  
  6856                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6857                                  ; write decimal number
  6858                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6859                                  
  6860                                  ;write_number:
  6861                                  ;	; 12/10/2020
  6862                                  ;	mov	bx, 10
  6863                                  ;	mov	si, cx
  6864                                  ;wnum_1:
  6865                                  ;	xor	dx, dx
  6866                                  ;	div	bx
  6867                                  ;	push	dx
  6868                                  ;	dec	cl
  6869                                  ;	jnz	short wnum_1
  6870                                  ;	mov	cx, si
  6871                                  ;	mov	ah, ch	; color (07h or 0Fh)
  6872                                  ;	xor	ch, ch
  6873                                  ;wnum_2:
  6874                                  ;	pop	dx
  6875                                  ;	mov	al, dl
  6876                                  ;	add	al, '0'
  6877                                  ;	stosw
  6878                                  ;	loop	wnum_2
  6879                                  ;	retn
  6880                                  
  6881                                  ;write_number:
  6882                                  ;	; 16/10/2020
  6883                                  ;	; dx:ax = binary number
  6884                                  ;	; di = decimal number/string location
  6885                                  ;	; modified registers: ax, bx, cx, dx, bp, di
  6886                                  ;	mov	cx, 10
  6887                                  ;	mov	bp, sp
  6888                                  ;wnum_1:
  6889                                  ;	call	div32
  6890                                  ;	push	bx
  6891                                  ;	and	dx, dx
  6892                                  ;	jnz	short wnum_1
  6893                                  ;	or	ax, ax
  6894                                  ;	jnz	short wnum_1
  6895                                  ;wnum_2:	
  6896                                  ;	pop	ax
  6897                                  ;	add	al, '0'
  6898                                  ;	mov	ah, 07h ; color
  6899                                  ;	stosw
  6900                                  ;	cmp	bp, sp
  6901                                  ;	ja	short wnum_2
  6902                                  ;	retn
  6903                                  
  6904                                  write_number:
  6905                                  	; 21/03/2021
  6906                                  	; 09/03/2021 (fdisk4.s)
  6907                                  	; eax = binary number (must be <=
  6908                                  	; di = decimal number/string location
  6909                                  	; modified registers: eax, ecx, edx, bp, di
  6910 00001BF7 66B90A000000            	mov	ecx, 10
  6911 00001BFD 6631D2                  	xor	edx, edx
  6912 00001C00 89E5                    	mov	bp, sp
  6913                                  wnum_1:
  6914 00001C02 66F7F1                  	div	ecx
  6915 00001C05 52                      	push	dx ; <= 9
  6916                                  	; 21/03/2021
  6917 00001C06 6609C0                  	or	eax, eax
  6918 00001C09 7404                    	jz	short wnum_2
  6919 00001C0B 30D2                    	xor	dl, dl
  6920 00001C0D EBF3                    	jmp	short wnum_1
  6921                                  wnum_2:	
  6922 00001C0F 58                      	pop	ax
  6923 00001C10 0430                    	add	al, '0'
  6924 00001C12 B407                    	mov	ah, 07h ; color
  6925 00001C14 AB                      	stosw
  6926 00001C15 39E5                    	cmp	bp, sp
  6927 00001C17 77F6                    	ja	short wnum_2
  6928 00001C19 C3                      	retn
  6929                                  
  6930                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6931                                  ; partition size input
  6932                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6933                                  
  6934                                  	; 13/03/2021
  6935                                  	; 12/03/2021 (fdisk4.s, 2TB disk partitioning)
  6936                                  partition_size_input:
  6937                                  	; 23/10/2020 (fdisk3.s modification on hdimage.s source code)
  6938                                  
  6939                                  	; 13/03/2021
  6940 00001C1A 6631C9                  	xor	ecx, ecx
  6941 00001C1D 6631D2                  	xor	edx, edx
  6942                                  
  6943                                  	;mov	word [pSize_multiplier+2], 0
  6944 00001C20 890E[D269]              	mov	[pSize_multiplier+2], cx ; 0 ; 13/03/2021
  6945 00001C24 C606[D769]42            	mov	byte [msg_psize_unit+1], 'B'
  6946 00001C29 A0[D669]                	mov	al, [pSize_unit]
  6947 00001C2C 3C25                    	cmp	al, '%'
  6948 00001C2E 7522                    	jne	short psu_0
  6949                                  	; 08/02/2019
  6950                                  	; calculate sector count for max. available sectors percentage
  6951                                  	;mov	dx, [pp_Sectors+2] ; max. available sectors
  6952                                  	;mov	ax, [pp_Sectors]   ; for a new partition
  6953                                  	;;mov	dx, [total_sectors+2]
  6954                                  	;;mov	ax, [total_sectors]
  6955                                  	;mov	cx, 100
  6956                                  	;call	div32
  6957                                  	;mov	[pSize_multiplier], ax
  6958                                  	; 29/10/2020
  6959                                  	;mov	[pSize_multiplier+2], dx
  6960                                  	; 13/03/2021
  6961                                  	;;mov	ecx, 100
  6962                                  	;mov	cl, 100
  6963 00001C30 B163                    	mov	cl, 99
  6964 00001C32 66A1[C469]              	mov	eax, [pp_Sectors]  ; > 0
  6965 00001C36 6601C8                  	add	eax, ecx ; eax = eax + 99
  6966 00001C39 80D200                  	adc	dl, 0
  6967 00001C3C FEC1                    	inc	cl ; ecx = 100	
  6968 00001C3E 66F7F1                  	div	ecx
  6969 00001C41 66A3[D069]              	mov	[pSize_multiplier], eax	; >= 1
  6970                                  	;xor	eax, eax
  6971                                  	;xor	dl, dl
  6972                                  	
  6973                                  	;mov	ah, 0
  6974                                  	;mov	[msg_psize_unit+1], ah ; 0
  6975                                  	; 13/03/2021
  6976 00001C45 882E[D769]              	mov	[msg_psize_unit+1], ch ; 0
  6977                                  	;mov	byte [pSize_maxdigits], 2
  6978 00001C49 C606[D469]03            	mov	byte [pSize_maxdigits], 3 ; 29/10/2020
  6979 00001C4E B025                    	mov	al, '%'
  6980 00001C50 EB5D                    	jmp	short psu_6
  6981                                  psu_0:
  6982 00001C52 3C43                    	cmp	al, 'C'
  6983 00001C54 7517                    	jne	short psu_1
  6984 00001C56 A1[9E3C]                	mov	ax, [sectors]
  6985 00001C59 F726[A03C]              	mul	word [heads]
  6986 00001C5D A3[D069]                	mov	[pSize_multiplier], ax
  6987                                  	;;mov	byte [pSize_maxdigits], 4 
  6988                                  	;; <= 65535 cylinders
  6989                                  	;mov	byte [pSize_maxdigits], 5 ; 23/10/2020
  6990                                  	; 13/03/2021	
  6991 00001C60 C606[D469]06            	mov	byte [pSize_maxdigits], 6 ; <= 267349 cylinders
  6992                                  
  6993                                  	;sub	dh, dh
  6994 00001C65 8836[D769]              	mov	[msg_psize_unit+1], dh ; 0
  6995 00001C69 B043                    	mov	al, 'C'
  6996 00001C6B EB42                    	jmp	short psu_6
  6997                                  psu_1:
  6998 00001C6D 3C47                    	cmp	al, 'G'
  6999 00001C6F 7510                    	jne	short psu_2
  7000                                  	;mov	word [pSize_multiplier], 2*1024
  7001                                  	;mov	word [pSize_multiplier+2], 1024
  7002                                  	; 13/03/2021
  7003 00001C71 66C706[D069]000020-     	mov	dword [pSize_multiplier], 1024*1024*2
  7003 00001C79 00                 
  7004                                  
  7005                                  	;;mov	byte [pSize_maxdigits], 1
  7006                                  	;mov	byte [pSize_maxdigits], 3 ; <= 512 GB ; 23/10/2020
  7007                                  	; 12/03/2021
  7008 00001C7A C606[D469]04            	mov	byte [pSize_maxdigits], 4 ; <= 2048 GB
  7009 00001C7F EB2E                    	jmp	short psu_6
  7010                                  psu_2:
  7011 00001C81 3C4D                    	cmp	al, 'M'
  7012 00001C83 750D                    	jne	short psu_3
  7013 00001C85 C706[D069]0008          	mov	word [pSize_multiplier], 2*1024
  7014                                  	;mov	byte [pSize_maxdigits], 4
  7015                                  	; 13/03/2021
  7016                                  	; <= 2097152 MB 
  7017 00001C8B C606[D469]07            	mov	byte [pSize_maxdigits], 7 ; 23/10/2020
  7018 00001C90 EB1D                    	jmp	short psu_6
  7019                                  psu_3:
  7020 00001C92 3C4B                    	cmp	al, 'K'
  7021 00001C94 7508                    	jne	short psu_4
  7022 00001C96 C706[D069]0200          	mov	word [pSize_multiplier], 2
  7023 00001C9C EB0C                    	jmp	short psu_5
  7024                                  psu_4:
  7025                                  	; al = 'S'
  7026 00001C9E 30E4                    	xor	ah, ah
  7027 00001CA0 8826[D769]              	mov	[msg_psize_unit+1], ah ; 0
  7028 00001CA4 C706[D069]0100          	mov	word [pSize_multiplier], 1
  7029                                  psu_5:
  7030                                  	;mov	byte [pSize_maxdigits], 7
  7031                                  	; 13/03/2021
  7032                                  	; <= 2147483648 KB or <= 4294967296 sectors
  7033 00001CAA C606[D469]0A            	mov	byte [pSize_maxdigits], 10 ; 23/10/2020
  7034                                  psu_6:
  7035 00001CAF A2[944B]                	mov	[msg_partition_size_x], al
  7036 00001CB2 BE[804B]                	mov	si, msg_partition_size
  7037 00001CB5 E8F4FC                  	call	print_msg
  7038                                  
  7039 00001CB8 89E5                    	mov	bp, sp
  7040                                  	;xor	bx, bx
  7041                                  	;mov	[pSize_temp], bx ; 0
  7042                                  	;;mov	[pSize_temp+2], bx ; 0
  7043                                  	; 13/03/2021
  7044                                  	;xor	ebx, ebx
  7045                                  	;mov	[pSize_temp], ebx ; 0
  7046 00001CBA 31DB                    	xor	bx, bx
  7047                                  
  7048 00001CBC 881E[D569]              	mov	[pSize_digitpos], bl ; 0
  7049                                  	; bh = 0  ; video page
  7050 00001CC0 B403                    	mov     ah, 3	; get cursor pos
  7051 00001CC2 CD10                    	int     10h
  7052 00001CC4 8916[9C51]              	mov	[Cursor_Pos], dx
  7053                                  	; 09/02/2019
  7054 00001CC8 B307                    	mov     bl, 7   ; page 0, color 7 (light gray)
  7055                                  psu_7:
  7056 00001CCA 30E4                    	xor	ah, ah
  7057 00001CCC CD16                    	int	16h
  7058                                  
  7059 00001CCE 3C30                    	cmp	al, '0'
  7060 00001CD0 7223                    	jb	short psu_8
  7061 00001CD2 3C39                    	cmp	al, '9'
  7062 00001CD4 77F4                    	ja	short psu_7
  7063 00001CD6 8A1E[D569]              	mov	bl, [pSize_digitpos]
  7064 00001CDA 3A1E[D469]              	cmp	bl, [pSize_maxdigits]
  7065 00001CDE 73EA                    	jnb	short psu_7
  7066 00001CE0 FE06[D569]              	inc	byte [pSize_digitpos]
  7067 00001CE4 2C30                    	sub	al, '0'
  7068                                  	;xor	ah, ah  ; 13/03/2021 (AH will not be used)
  7069 00001CE6 50                      	push	ax	; (*)
  7070 00001CE7 0430                    	add	al, '0'
  7071 00001CE9 B40E                    	mov	ah, 0Eh	; write char as tty
  7072                                  	;mov	bx, 7   ; page 0, color 7 (light gray)
  7073 00001CEB CD10                    	int	10h
  7074 00001CED EBDB                    	jmp	short psu_7
  7075                                  
  7076                                  psu_8esc:
  7077                                  	; 29/10/2020 (ESCape)
  7078 00001CEF 89EC                    	mov	sp, bp ; clean stack
  7079                                  
  7080 00001CF1 08C0                    	or	al, al ; zf = 0
  7081 00001CF3 F9                      	stc
  7082 00001CF4 C3                      	retn	
  7083                                  psu_8:
  7084 00001CF5 20C0                    	and	al, al
  7085 00001CF7 0F848300                	jz	psu_15 ; check for left arrow key
  7086 00001CFB 3C1B                    	cmp	al, 27
  7087 00001CFD 74F0                    	je	short psu_8esc ; ESCAPE key ; 29/10/2020
  7088 00001CFF 7777                    	ja	psu_14 ; check for left arrow key
  7089 00001D01 3C0D                    	cmp	al, 13
  7090                                  	;je	short psu_9  ; ENTER key
  7091 00001D03 723D                    	jb	short psu_11 ; check for backspace key
  7092                                  	;jmp	short psu_7
  7093 00001D05 77C3                    	ja	short psu_7
  7094                                  psu_9:
  7095                                  	; 13/03/2021
  7096                                  	;xor	ax, ax
  7097                                  	;mov	[pSize_temp+2], ax ; 0 ; 08/02/2019
  7098                                  
  7099                                  	;cmp	byte [pSize_digitpos], al ; 0
  7100                                  	;jna	psu_16	
  7101                                  	; 13/03/2021
  7102 00001D07 383E[D569]              	cmp	byte [pSize_digitpos], bh ; 0
  7103 00001D0B 767E                    	jna	psu_16
  7104                                  
  7105                                  	;xor	bh, bh
  7106 00001D0D 8A1E[D569]              	mov	bl, [pSize_digitpos]
  7107 00001D11 FECB                    	dec	bl
  7108 00001D13 D0E3                    	shl	bl, 1
  7109 00001D15 01E3                    	add	bx, sp
  7110                                  	;mov	ax, [bx]
  7111                                  	;mov	[pSize_temp], ax
  7112                                  	;;mov	word [pSize_temp+2], 0
  7113                                  	; 13/03/2021
  7114 00001D17 8A0F                    	mov	cl, [bx]
  7115 00001D19 66890E[CC69]            	mov	[pSize_temp], ecx
  7116                                  	; 13/03/2021
  7117                                  	;mov	cx, 10
  7118 00001D1E B10A                    	mov	cl, 10
  7119                                  psu_10:
  7120 00001D20 FE0E[D569]              	dec	byte [pSize_digitpos]
  7121 00001D24 7465                    	jz	short psu_16
  7122                                  	
  7123                                  	;mov	ax, [pSize_temp]
  7124                                  	;mov	dx, [pSize_temp+2]
  7125                                  	;;mov	cx, 10
  7126                                  	;call	mul32
  7127                                  	;;mov	[pSize_temp], ax
  7128                                  	;;mov	[pSize_temp+2], dx
  7129                                  	; 13/03/2021
  7130 00001D26 66A1[CC69]              	mov	eax, [pSize_temp]
  7131 00001D2A 66F7E1                  	mul	ecx ; * 10
  7132                                  	;mov	[pSize_temp], eax
  7133                                  
  7134                                  	;xor	bh, bh
  7135 00001D2D 8A1E[D569]              	mov	bl, [pSize_digitpos]
  7136 00001D31 FECB                    	dec	bl
  7137 00001D33 D0E3                    	shl	bl, 1
  7138 00001D35 01E3                    	add	bx, sp ; (*)
  7139                                  	;mov	ax, [bx]
  7140                                  	;add	[pSize_temp], ax
  7141                                  	;adc	word [pSize_temp+2], 0
  7142                                  	
  7143                                  	;add	ax, [bx]
  7144                                  	;adc	dx, 0
  7145                                  	; 13/03/2021
  7146 00001D37 8A0F                    	mov	cl, [bx]
  7147 00001D39 6601C8                  	add	eax, ecx
  7148                                  	
  7149                                  	;mov	[pSize_temp], ax
  7150                                  	;mov	[pSize_temp+2], dx
  7151                                  	; 13/03/2021
  7152 00001D3C 66A3[CC69]              	mov	[pSize_temp], eax
  7153                                  
  7154 00001D40 EBDE                    	jmp	short psu_10
  7155                                  	
  7156                                  	; Left arrow, backspace, DEL key checking
  7157                                  psu_11:
  7158 00001D42 3C08                    	cmp	al, 8 ; backspace key
  7159 00001D44 7584                    	jne	psu_7
  7160                                  psu_12:
  7161                                  	;; bh = 0  ; video page
  7162                                  	;mov	ah, 3 ; get cursor pos
  7163                                  	;int	10h
  7164                                  	;cmp	dl, [Cursor_Pos]
  7165                                  	;jna	short psu_13
  7166                                  	;dec	dl
  7167                                  	;dec	byte [pSize_digitpos]
  7168                                  
  7169                                  	; 08/02/2019
  7170 00001D46 8B16[9C51]              	mov	dx, [Cursor_Pos]
  7171 00001D4A 8A1E[D569]              	mov	bl, [pSize_digitpos]
  7172 00001D4E 20DB                    	and	bl, bl
  7173 00001D50 741D                    	jz	short psu_13
  7174                                  
  7175 00001D52 FECB                    	dec	bl 
  7176 00001D54 881E[D569]              	mov	[pSize_digitpos], bl
  7177                                  	
  7178 00001D58 00DA                    	add	dl, bl
  7179                                  
  7180                                  	; bh = 0  ; video page
  7181 00001D5A B402                    	mov	ah, 2 ; set cursor pos
  7182 00001D5C CD10                    	int	10h
  7183                                  	;mov	bl, dl
  7184                                  	;sub	bl, [Cursor_Pos] 
  7185 00001D5E B90100                  	mov	cx, 1
  7186 00001D61 B409                    	mov	ah, 9 ; write char at current curs pos
  7187 00001D63 B020                    	mov	al, 20h ; space (blank)
  7188 00001D65 8800                    	mov	[si+bx], al
  7189                                  	; bh = 0 ; video page
  7190 00001D67 B307                    	mov	bl, 7 ; attribute/color (light gray)
  7191 00001D69 CD10                    	int	10h
  7192                                  
  7193                                  	; 09/02/2019
  7194 00001D6B 58                      	pop	ax ; remove last digit on top of stack 
  7195                                  		   ; set sp to correct position for BX (*)
  7196 00001D6C E95BFF                  	jmp	psu_7
  7197                                  psu_13:
  7198 00001D6F B40E                    	mov	ah, 0Eh
  7199 00001D71 B007                    	mov	al, 7
  7200                                  	;mov	bx, 7
  7201 00001D73 CD10                    	int	10h
  7202 00001D75 E952FF                  	jmp	psu_7
  7203                                  psu_14:
  7204 00001D78 3CE0                    	cmp	al, 0E0h
  7205 00001D7A 0F854CFF                	jne	psu_7
  7206                                  psu_15:    
  7207 00001D7E 80FC4B                  	cmp	ah, 4Bh ; left arrow
  7208 00001D81 74C3                    	je	short psu_12
  7209 00001D83 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  7210 00001D86 74BE                    	je	short psu_12
  7211 00001D88 E93FFF                  	jmp	psu_7
  7212                                  psu_16:
  7213 00001D8B 89EC                    	mov	sp, bp
  7214                                  
  7215                                  	; 29/10/2020
  7216 00001D8D 803E[D669]25            	cmp	byte [pSize_unit], '%'
  7217 00001D92 751E                    	jne	short psu_23
  7218                                  
  7219 00001D94 B86400                  	mov	ax, 100
  7220 00001D97 3906[CC69]              	cmp	word [pSize_temp], ax ; 100 ; % limit
  7221 00001D9B 7624                    	jna	short psu_17
  7222 00001D9D A3[CC69]                	mov	word [pSize_temp], ax
  7223                                  
  7224                                  	; (re)set asciiz number string to '100'
  7225                                  
  7226 00001DA0 28FF                    	sub	bh, bh ; 0 ; video page 0
  7227 00001DA2 8B16[9C51]              	mov	dx, [Cursor_Pos]
  7228 00001DA6 B402                    	mov	ah, 2 ; set cursor pos
  7229 00001DA8 CD10                    	int	10h
  7230                                  
  7231 00001DAA BE[2665]                	mov	si, msg_100
  7232 00001DAD E8FCFB                  	call	print_msg
  7233                                  
  7234 00001DB0 EB0F                    	jmp	short psu_17
  7235                                  psu_23:
  7236 00001DB2 803E[D669]53            	cmp	byte [pSize_unit], 'S'
  7237 00001DB7 7508                    	jne	short psu_17 
  7238                                  
  7239 00001DB9 BE[0461]                	mov	si, msg_sectors_crlf
  7240 00001DBC E8EDFB                  	call	print_msg
  7241                                  	;xor	bx, bx
  7242 00001DBF EB33                    	jmp	short psu_18
  7243                                  psu_17:
  7244 00001DC1 BE[D669]                	mov	si, msg_psize_unit
  7245 00001DC4 E8E5FB                  	call	print_msg
  7246                                  
  7247 00001DC7 BE[5852]                	mov	si, CRLF
  7248 00001DCA E8DFFB                  	call	print_msg
  7249                                  
  7250                                  	; 13/03/2021
  7251 00001DCD 66A1[CC69]              	mov	eax, [pSize_temp]
  7252 00001DD1 6621C0                  	and	eax, eax
  7253 00001DD4 7422                    	jz	short psu_21 ; 0%, ZERO !
  7254                                  
  7255 00001DD6 668B16[D069]            	mov	edx, [pSize_multiplier]
  7256                                  
  7257                                  	; 29/10/2020
  7258 00001DDB 803E[D669]25            	cmp	byte [pSize_unit], '%'
  7259 00001DE0 7512                    	jne	short psu_18
  7260                                  	
  7261                                  	;mov	cx, [pSize_temp]
  7262                                  	;
  7263                                  	;and	cx, cx
  7264                                  	;jz	short psu_21 ; 0%, ZERO !
  7265                                  	
  7266                                  	; 13/03/2021
  7267                                  	;mov	ax, [pSize_temp]
  7268                                  	;and	ax, ax
  7269                                  	;jz	short psu_21 ; 0%, ZERO !
  7270                                  	
  7271                                  	;cmp	cx, 100
  7272                                  	;jna	short psu_24
  7273                                  	; 13/03/2021
  7274                                  	;cmp	eax, 100
  7275 00001DE2 83F864                  	cmp	ax, 100
  7276 00001DE5 720D                    	jb	short psu_18 ; < 100
  7277 00001DE7 7403                    	je	short psu_19 ; = 100
  7278                                  
  7279                                  	; show 100% for 1 second (for >100%)
  7280 00001DE9 E80E00                  	call	wait1second ; 29/10/2020
  7281                                  	;mov	cx, 100
  7282                                  psu_19: 
  7283                                  	; 13/03/2021
  7284 00001DEC 66A1[C469]              	mov	eax, [pp_Sectors] ; 100%
  7285 00001DF0 6631D2                  	xor	edx, edx
  7286 00001DF3 C3                      	retn
  7287                                  
  7288                                  ;psu_24:
  7289                                  	;mov	ax, [pSize_multiplier]
  7290                                  	;mov	dx, [pSize_multiplier+2]
  7291                                  	;
  7292                                  	;;mov	cx, [pSize_temp]
  7293                                  	;;and	cx, cx
  7294                                  	;;jz	short psu_21 ; 0%, ZERO !
  7295                                  	;	
  7296                                  	;jmp	mul32
  7297                                  psu_18:
  7298                                  	; 13/03/2021
  7299                                  	; eax = [pSize_temp]
  7300                                  	; edx = [pSize_multiplier]
  7301 00001DF4 66F7E2                  	mul	edx
  7302                                  	; eax = partition size
  7303                                  	; edx = 0 
  7304 00001DF7 C3                      	retn
  7305                                  ;psu_18:
  7306                                  	;mov	ax, [pSize_temp]
  7307                                  	;mov	dx, [pSize_temp+2]
  7308                                  	;mov	cx, ax
  7309                                  	;or	cx, dx
  7310                                  	;;jz	short psu_20
  7311                                  	;jz	short psu_21 ; 08/02/2019
  7312                                  	; 13/03/2021
  7313                                  	;mov	eax, [pSize_temp]
  7314                                  	;or	eax, eax
  7315                                  	;jz	short psu_21	
  7316                                  
  7317                                  	;mov	cx, [pSize_multiplier]
  7318                                  	;cmp	byte [pSize_unit], 'C'
  7319                                  	;je	short psu_20 ; 09/02/2019
  7320                                  	;;jne	short psu_19
  7321                                  	;;call	mul32
  7322                                  	;; 08/02/2019
  7323                                  	;; dx:ax = requested partition size in sectors
  7324                                  	;;retn	
  7325                                  ;psu_19:
  7326                                  	;;mov	cx, [pSize_multiplier]
  7327                                  	;cmp	cx, 1
  7328                                  	;;jna	short psu_20
  7329                                  	;ja	short psu_19
  7330                                  	;; 09/02/2019
  7331                                  	;xor	bx, bx
  7332                                  	;retn
  7333                                  
  7334                                  	; 13/03/2021
  7335                                  	; edx = [pSize_multiplier]
  7336                                  	;mul	edx
  7337                                  	; eax = partition size
  7338                                  	; edx = 0 
  7339                                  	;retn
  7340                                  ;psu_19:
  7341                                  ;	call	mul32
  7342                                  ;	;and	bx, bx
  7343                                  ;	;jnz	short psu_22 ; 09/02/2019
  7344                                  ;	mov	cx, [pSize_multiplier+2]
  7345                                  ;	or	cx, cx
  7346                                  ;	;jz	short psu_20
  7347                                  ;	jz	short psu_22 ; 09/02/2019
  7348                                  ;psu_20:
  7349                                  ;	;call	mul32
  7350                                  ;	;retn
  7351                                  ;	jmp	mul32 ; 23/10/2020
  7352                                  
  7353                                  psu_21:
  7354                                  	; 13/03/2021
  7355                                  	;xor	edx, edx
  7356                                  	; zf = 1 ; 29/10/2020
  7357 00001DF8 F9                      	stc
  7358                                  psu_22:
  7359 00001DF9 C3                      	retn
  7360                                  
  7361                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7362                                  ; wait for 1 second
  7363                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7364                                  
  7365                                  	; 29/10/2020
  7366                                  wait1second:
  7367 00001DFA B402                    	mov	ah, 2
  7368 00001DFC CD1A                    	int	1Ah ; get time of day
  7369 00001DFE 720C                    	jc	short w1s_2
  7370                                  w1s_1:
  7371 00001E00 52                      	push	dx
  7372 00001E01 B402                    	mov	ah, 2
  7373 00001E03 CD1A                    	int	1Ah ; get time of day
  7374 00001E05 58                      	pop	ax
  7375 00001E06 7204                    	jc	short w1s_2
  7376 00001E08 38E6                    	cmp	dh, ah
  7377 00001E0A 74F4                    	je	short w1s_1 ; same second
  7378                                  w1s_2:
  7379 00001E0C C3                      	retn
  7380                                  
  7381                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7382                                  ; partition type input
  7383                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7384                                  
  7385                                  partition_type_input:
  7386 00001E0D BE[9A4B]                	mov	si, msg_partition_type	
  7387 00001E10 E899FB                  	call	print_msg
  7388                                  
  7389 00001E13 31DB                    	xor	bx, bx
  7390                                  
  7391 00001E15 881E[E669]              	mov	[pType_pos], bl ; 0
  7392 00001E19 891E[E769]              	mov	[pType_num], bx ; 0
  7393                                  
  7394                                  	; bh = 0  ; video page
  7395 00001E1D B403                    	mov     ah, 3 ; get cursor pos
  7396 00001E1F CD10                    	int     10h
  7397 00001E21 8916[9C51]              	mov	[Cursor_Pos], dx
  7398                                  ptu_0:
  7399 00001E25 30E4                    	xor	ah, ah
  7400 00001E27 CD16                    	int	16h
  7401                                  
  7402 00001E29 803E[E669]01            	cmp	byte [pType_pos], 1
  7403 00001E2E 773F                    	ja	short ptu_5
  7404                                  
  7405 00001E30 3C30                    	cmp	al, '0'
  7406 00001E32 723B                    	jb	short ptu_5
  7407 00001E34 3C39                    	cmp	al, '9'
  7408 00001E36 7707                    	ja	short ptu_1
  7409 00001E38 88C4                    	mov	ah, al
  7410 00001E3A 80EC30                  	sub	ah, '0'
  7411 00001E3D EB13                    	jmp	short ptu_2 
  7412                                  ptu_1:
  7413 00001E3F 3CE0                    	cmp     al, 0E0h
  7414 00001E41 7473                    	je	short ptu_9
  7415                                  
  7416 00001E43 24DF                    	and	al, 0DFh
  7417 00001E45 3C41                    	cmp	al, 'A'
  7418 00001E47 72DC                    	jb	short ptu_0
  7419 00001E49 3C46                    	cmp	al, 'F'
  7420 00001E4B 77D8                    	ja	short ptu_0
  7421 00001E4D 88C4                    	mov	ah, al
  7422 00001E4F 80EC37                  	sub	ah, 'A'-10
  7423                                  ptu_2:
  7424 00001E52 803E[E669]00            	cmp	byte [pType_pos], 0
  7425 00001E57 7606                    	jna	short ptu_3
  7426 00001E59 8826[E869]              	mov	[pType_num+1], ah
  7427 00001E5D EB04                    	jmp	short ptu_4 
  7428                                  ptu_3:
  7429 00001E5F 8826[E769]              	mov	[pType_num], ah
  7430                                  ptu_4:
  7431 00001E63 B40E                    	mov	ah, 0Eh
  7432 00001E65 B307                    	mov	bl, 7
  7433 00001E67 CD10                    	int	10h
  7434                                  
  7435 00001E69 FE06[E669]              	inc	byte [pType_pos]
  7436                                  
  7437 00001E6D EBB6                    	jmp	short ptu_0 
  7438                                  ptu_5:
  7439 00001E6F 20C0                    	and	al, al
  7440 00001E71 7443                    	jz	short ptu_9 ; check for left arrow key 
  7441 00001E73 3C1B                    	cmp	al, 27
  7442 00001E75 744C                    	je	short ptu_10 ; ESCAPE key
  7443 00001E77 77AC                    	ja	short ptu_0
  7444 00001E79 3C0D                    	cmp	al, 13
  7445 00001E7B 744A                    	je	short ptu_11 ; ENTER key
  7446 00001E7D 77A6                    	ja	short ptu_0
  7447                                  ptu_6:
  7448                                  	; Left arrow, backspace, DEL key checking
  7449                                  
  7450 00001E7F 3C08                    	cmp	al, 8 ; backspace key
  7451 00001E81 75A2                    	jne	short ptu_0
  7452                                  ptu_7:
  7453                                  	; bh = 0 ; video page
  7454 00001E83 B403                    	mov	ah, 3 ; get cursor pos
  7455 00001E85 CD10                    	int	10h
  7456 00001E87 3A16[9C51]              	cmp	dl, [Cursor_Pos]
  7457 00001E8B 7620                    	jna	short ptu_8
  7458 00001E8D FECA                    	dec	dl
  7459 00001E8F FE0E[E669]              	dec	byte [pType_pos]
  7460                                  	; bh = 0  ; video page
  7461 00001E93 B402                    	mov	ah, 2 ; set cursor pos
  7462 00001E95 CD10                    	int	10h
  7463 00001E97 88D3                    	mov	bl, dl
  7464 00001E99 2A1E[9C51]              	sub	bl, [Cursor_Pos] 
  7465 00001E9D B90100                  	mov	cx, 1
  7466 00001EA0 B409                    	mov	ah, 9 ; write char at current curs pos
  7467 00001EA2 B020                    	mov	al, 20h ; space (blank)
  7468 00001EA4 8800                    	mov	[si+bx], al
  7469                                  	; bh = 0 ; video page
  7470 00001EA6 B307                    	mov	bl, 7 ; attribute/color (light gray)
  7471 00001EA8 CD10                    	int	10h
  7472 00001EAA E978FF                  	jmp	ptu_0
  7473                                  ptu_8:
  7474 00001EAD B40E                    	mov	ah, 0Eh
  7475 00001EAF B007                    	mov	al, 7
  7476 00001EB1 CD10                    	int	10h
  7477 00001EB3 E96FFF                  	jmp	ptu_0
  7478                                  ptu_9:    
  7479 00001EB6 80FC4B                  	cmp	ah, 4Bh ; left arrow
  7480 00001EB9 74C8                    	je	short ptu_7
  7481 00001EBB 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  7482 00001EBE 74C3                    	je	short ptu_7
  7483 00001EC0 E962FF                  	jmp	ptu_0
  7484                                  
  7485                                  ptu_10: ; ESCAPE
  7486                                  	;mov	al, 0
  7487                                  	; 29/10/2020
  7488 00001EC3 28C0                    	sub	al, al ; 0
  7489                                  	; partition type is 0 (none)
  7490 00001EC5 EB12                    	jmp	short ptu_12
  7491                                  ptu_11: ; ENTER
  7492 00001EC7 A0[E769]                	mov	al, [pType_num]
  7493 00001ECA 803E[E669]01            	cmp	byte [pType_pos], 1
  7494 00001ECF 7608                    	jna	short ptu_12
  7495 00001ED1 B410                    	mov	ah, 16
  7496 00001ED3 F6E4                    	mul	ah
  7497 00001ED5 0206[E869]              	add	al, [pType_num+1]
  7498                                  ptu_12:
  7499 00001ED9 50                      	push	ax
  7500 00001EDA E8A3FB                  	call	bin_to_hex
  7501 00001EDD A3[B04B]                	mov	[msg_ptype_num], ax
  7502                                  	; bh = 0  ; video page
  7503 00001EE0 B402                    	mov	ah, 2 ; set cursor pos
  7504 00001EE2 8B16[9C51]              	mov	dx, [Cursor_Pos]
  7505 00001EE6 CD10                    	int	10h
  7506 00001EE8 BE[B04B]                	mov	si, msg_ptype_num 
  7507 00001EEB E8BEFA                  	call	print_msg
  7508 00001EEE 58                      	pop	ax
  7509 00001EEF C3                      	retn
  7510                                  
  7511                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7512                                  ; show selected partition
  7513                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7514                                  
  7515                                  	; 20/03/2021 (fdisk4.s)
  7516                                  show_selected_partition:
  7517                                  	; INPUT ->
  7518                                  	; 	DS:SI = Partition table row address
  7519                                  	
  7520                                  	; 2019 - 2020 (hdimage.s)
  7521                                  	;pt_s_offset	equ 7
  7522                                  	;pt_bh_offset	equ 11
  7523                                  	;pt_bs_offset	equ 15
  7524                                  	;pt_bc_offset	equ 19
  7525                                  	;pt_fs_offset	equ 23
  7526                                  	;pt_eh_offset	equ 27
  7527                                  	;pt_es_offset	equ 31
  7528                                  	;pt_ec_offset	equ 35
  7529                                  	;pt_rs_offset	equ 41
  7530                                  	;pt_ts_offset	equ 52
  7531                                  	;pt_fsn_offset	equ 63
  7532                                  
  7533                                  	; 24/10/2020 (fdisk3.s)
  7534                                  	pt_s_offset	equ 6
  7535                                  	pt_bh_offset	equ 10
  7536                                  	pt_bs_offset	equ 14
  7537                                  	pt_bc_offset	equ 18
  7538                                  	pt_fs_offset	equ 22
  7539                                  	pt_eh_offset	equ 26
  7540                                  	pt_es_offset	equ 30
  7541                                  	pt_ec_offset	equ 34
  7542                                  	pt_rs_offset	equ 40
  7543                                  	pt_ts_offset	equ 51
  7544                                  	pt_fsn_offset	equ 63
  7545                                  
  7546                                  	; 20/03/2021
  7547 00001EF0 6629C0                  	sub	eax, eax
  7548                                  
  7549                                  	; clear screen
  7550                                  	;mov	ax, 3 ; set video mode to 03h (80x25 text)
  7551 00001EF3 B003                    	mov	al, 3 ; 20/03/2021
  7552 00001EF5 CD10                    	int	10h	
  7553                                  
  7554 00001EF7 89F0                    	mov	ax, si
  7555 00001EF9 2D[9254]                	sub	ax, MasterBootBuff + pTableOffset ; + 446
  7556 00001EFC C0E804                  	shr	al, 4 ; from offset to partition number
  7557 00001EFF 0431                    	add	al, '1'  ; 1 based partition number (chr)
  7558                                  	; Write partition number to the header location
  7559 00001F01 A2[704D]                	mov	[msg_selected_partition+43], al ; '1' to '4'
  7560                                  	
  7561                                  	; Partition number will be used at formatting stage
  7562 00001F04 A2[3F50]                	mov	[partition_num_chr], al ; number + '0'
  7563                                  
  7564 00001F07 B268                    	mov	dl, 'h'
  7565 00001F09 8A04                    	mov	al, [si+ptBootable]
  7566 00001F0B E872FB                  	call	bin_to_hex
  7567 00001F0E A3[8B4E]                	mov	[pt_row+pt_s_offset], ax
  7568 00001F11 8816[8D4E]              	mov	[pt_row+pt_s_offset+2], dl ; 'h'
  7569 00001F15 8A4401                  	mov	al, [si+ptBeginHead]
  7570 00001F18 E865FB                  	call	bin_to_hex
  7571 00001F1B A3[8F4E]                	mov	[pt_row+pt_bh_offset], ax
  7572 00001F1E 8816[914E]              	mov	[pt_row+pt_bh_offset+2], dl ; 'h'
  7573 00001F22 8A4402                  	mov	al, [si+ptBeginSector]
  7574 00001F25 E858FB                  	call	bin_to_hex
  7575 00001F28 A3[934E]                	mov	[pt_row+pt_bs_offset], ax
  7576 00001F2B 8816[954E]              	mov	[pt_row+pt_bs_offset+2], dl ; 'h'
  7577 00001F2F 8A4403                  	mov	al, [si+ptBeginCylinder]
  7578 00001F32 E84BFB                  	call	bin_to_hex
  7579 00001F35 A3[974E]                	mov	[pt_row+pt_bc_offset], ax
  7580 00001F38 8816[994E]              	mov	[pt_row+pt_bc_offset+2], dl ; 'h'
  7581 00001F3C 8A4404                  	mov	al, [si+ptFileSystemID]
  7582                                   	; Partition type will be used at formatting stage
  7583 00001F3F A2[CA69]                	mov	[pp_type_user], al
  7584 00001F42 E83BFB                  	call	bin_to_hex
  7585 00001F45 A3[9B4E]                	mov	[pt_row+pt_fs_offset], ax
  7586 00001F48 8816[9D4E]              	mov	[pt_row+pt_fs_offset+2], dl ; 'h'
  7587 00001F4C 8A4405                  	mov	al, [si+ptEndHead]
  7588 00001F4F E82EFB                  	call	bin_to_hex
  7589 00001F52 A3[9F4E]                	mov	[pt_row+pt_eh_offset], ax
  7590 00001F55 8816[A14E]              	mov	[pt_row+pt_eh_offset+2], dl ; 'h'
  7591 00001F59 8A4406                  	mov	al, [si+ptEndSector]
  7592 00001F5C E821FB                  	call	bin_to_hex
  7593 00001F5F A3[A34E]                	mov	[pt_row+pt_es_offset], ax
  7594 00001F62 8816[A54E]              	mov	[pt_row+pt_es_offset+2], dl ; 'h'
  7595 00001F66 8A4407                  	mov	al, [si+ptEndCylinder]
  7596 00001F69 E814FB                  	call	bin_to_hex
  7597 00001F6C A3[A74E]                	mov	[pt_row+pt_ec_offset], ax
  7598 00001F6F 8816[A94E]              	mov	[pt_row+pt_ec_offset+2], dl ; 'h'
  7599 00001F73 8A4408                  	mov	al, [si+ptStartSector]
  7600 00001F76 E807FB                  	call	bin_to_hex
  7601 00001F79 A3[B34E]                	mov	[pt_row+pt_rs_offset+6], ax
  7602 00001F7C 8816[B54E]              	mov	[pt_row+pt_rs_offset+8], dl ; 'h'
  7603 00001F80 8A4409                  	mov	al, [si+ptStartSector+1]
  7604 00001F83 E8FAFA                  	call	bin_to_hex
  7605 00001F86 A3[B14E]                	mov	[pt_row+pt_rs_offset+4], ax
  7606 00001F89 8A440A                  	mov	al, [si+ptStartSector+2]
  7607 00001F8C E8F1FA                  	call	bin_to_hex
  7608 00001F8F A3[AF4E]                	mov	[pt_row+pt_rs_offset+2], ax
  7609 00001F92 8A440B                  	mov	al, [si+ptStartSector+3]
  7610 00001F95 E8E8FA                  	call	bin_to_hex
  7611 00001F98 A3[AD4E]                	mov	[pt_row+pt_rs_offset], ax
  7612 00001F9B 8A440C                  	mov	al, [si+ptSectors]
  7613 00001F9E E8DFFA                  	call	bin_to_hex
  7614 00001FA1 A3[BE4E]                	mov	[pt_row+pt_ts_offset+6], ax
  7615 00001FA4 8816[C04E]              	mov	[pt_row+pt_ts_offset+8], dl ; 'h'
  7616 00001FA8 8A440D                  	mov	al, [si+ptSectors+1]
  7617 00001FAB E8D2FA                  	call	bin_to_hex
  7618 00001FAE A3[BC4E]                	mov	[pt_row+pt_ts_offset+4], ax
  7619 00001FB1 8A440E                  	mov	al, [si+ptSectors+2]
  7620 00001FB4 E8C9FA                  	call	bin_to_hex
  7621 00001FB7 A3[BA4E]                	mov	[pt_row+pt_ts_offset+2], ax
  7622 00001FBA 8A440F                  	mov	al, [si+ptSectors+3]
  7623 00001FBD E8C0FA                  	call	bin_to_hex
  7624 00001FC0 A3[B84E]                	mov	[pt_row+pt_ts_offset], ax
  7625                                  
  7626 00001FC3 8A4404                  	mov	al, [si+ptFileSystemID]
  7627 00001FC6 BF[BE3D]                	mov	di, valid_partitions
  7628 00001FC9 B91300                  	mov	cx, 19
  7629 00001FCC F2AE                    	repnz	scasb
  7630 00001FCE 7405                    	jz	short ssp_1
  7631 00001FD0 B8[B03D]                	mov	ax, FS_OTHERS
  7632 00001FD3 EB0C                    	jmp	short ssp_2
  7633                                  ssp_1:
  7634 00001FD5 81EF[BF3D]              	sub	di, valid_partitions + 1
  7635 00001FD9 B80E00                  	mov	ax, 14
  7636 00001FDC F7E7                    	mul	di
  7637 00001FDE 05[A63C]                	add	ax, FileSys_Names
  7638                                  ssp_2:
  7639 00001FE1 96                      	xchg	ax, si 
  7640 00001FE2 B107                    	mov	cl, 7
  7641 00001FE4 BF[C44E]                	mov	di, pt_row + pt_fsn_offset
  7642 00001FE7 F3A5                    	rep	movsw
  7643 00001FE9 89C7                    	mov	di, ax ; partition table row address
  7644                                  
  7645 00001FEB BE[454D]                	mov	si, msg_selected_partition
  7646 00001FEE E8BBF9                  	call	print_msg
  7647                                  
  7648 00001FF1 BE[264F]                	mov	si, msg_boot_indicator
  7649 00001FF4 E8B5F9                  	call	print_msg
  7650 00001FF7 BE[9359]                	mov	si, msg_YES
  7651 00001FFA F60580                  	test	byte [di+ptBootable], 80h
  7652 00001FFD 7503                    	jnz	short ssp_3
  7653 00001FFF BE[9959]                	mov	si, msg_NO
  7654                                  ssp_3:
  7655 00002002 E8A7F9                  	call	print_msg
  7656                                  
  7657 00002005 BE[3E4F]                	mov	si, msg_starting_head
  7658 00002008 E8A1F9                  	call	print_msg
  7659 0000200B 8A4501                  	mov	al, [di+ptBeginHead]
  7660 0000200E E8AD00                  	call	write_byte_decimal
  7661 00002011 E898F9                  	call	print_msg
  7662 00002014 BE[564F]                	mov	si, msg_starting_sector
  7663 00002017 E892F9                  	call	print_msg
  7664 0000201A 8A4502                  	mov	al, [di+ptBeginSector]
  7665 0000201D 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  7666 0000201F 243F                    	and	al, 3Fh ; sector number, 1 to 63
  7667 00002021 E89A00                  	call	write_byte_decimal
  7668 00002024 E885F9                  	call	print_msg
  7669 00002027 BE[6E4F]                	mov	si, msg_starting_cylinder
  7670 0000202A E87FF9                  	call	print_msg
  7671 0000202D 8A4503                  	mov	al, [di+ptBeginCylinder] ; bits 0to7 of cyl
  7672 00002030 C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  7673 00002033 88D4                    	mov	ah, dl
  7674                                  	;xor	dx, dx
  7675                                  	; 20/03/2021
  7676                                  	; eax = binary number
  7677                                  	; 06/11/2020
  7678 00002035 BE[E369]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7679                                  	; dx_ax: binary number
  7680 00002038 E82AFA                  	call	bin_to_decimal
  7681                                  	; ds:si = decimal number text address
  7682 0000203B E86EF9                  	call	print_msg
  7683 0000203E BE[864F]                	mov	si, msg_system_id
  7684 00002041 E868F9                  	call	print_msg
  7685                                  	; Write file system name (again, copy)
  7686 00002044 BE[C44E]                	mov	si, pt_row + pt_fsn_offset
  7687                                  	;mov	cx, 14
  7688 00002047 B10E                    	mov	cl, 14
  7689 00002049 B40E                    	mov	ah, 0Eh ; write tty
  7690 0000204B BB0700                  	mov	bx, 7
  7691                                  ssp_4:	 
  7692 0000204E AC                      	lodsb
  7693 0000204F CD10                    	int	10h
  7694 00002051 E2FB                    	loop	ssp_4
  7695                                  
  7696 00002053 BE[9E4F]                	mov	si, msg_ending_head
  7697 00002056 E853F9                  	call	print_msg
  7698 00002059 8A4505                  	mov	al, [di+ptEndHead]
  7699 0000205C E85F00                  	call	write_byte_decimal
  7700 0000205F E84AF9                  	call	print_msg
  7701 00002062 BE[B64F]                	mov	si, msg_ending_sector
  7702 00002065 E844F9                  	call	print_msg
  7703 00002068 8A4506                  	mov	al, [di+ptEndSector]
  7704 0000206B 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  7705 0000206D 243F                    	and	al, 3Fh ; sector number, 1 to 63
  7706 0000206F E84C00                  	call	write_byte_decimal
  7707 00002072 E837F9                  	call	print_msg	
  7708 00002075 BE[CE4F]                	mov	si, msg_ending_cylinder
  7709 00002078 E831F9                  	call	print_msg
  7710 0000207B 8A4507                  	mov	al, [di+ptEndCylinder] ; bits 0to7 of cyl
  7711 0000207E C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  7712 00002081 88D4                    	mov	ah, dl
  7713                                  	;xor	dx, dx
  7714                                  	; 20/03/2021
  7715                                  	; eax = binary number
  7716                                  	; 06/11/2020
  7717 00002083 BE[E369]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7718                                  	; dx_ax: binary number
  7719 00002086 E8DCF9                  	call	bin_to_decimal
  7720                                  	; ds:si = decimal number text address
  7721 00002089 E820F9                  	call	print_msg
  7722                                  
  7723 0000208C BE[E64F]                	mov	si, msg_relative_sectors
  7724 0000208F E81AF9                  	call	print_msg
  7725                                  	;mov	ax, [di+ptStartSector]
  7726                                  	;mov	dx, [di+ptStartSector+2]
  7727                                  	; 20/03/2021
  7728 00002092 668B4508                	mov	eax, [di+ptStartSector]
  7729                                  
  7730                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  7731                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  7732                                  	; 06/11/2020
  7733 00002096 BE[E369]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7734                                  	; eax = binary number ; 20/03/2021
  7735 00002099 E8C9F9                  	call	bin_to_decimal
  7736 0000209C E80DF9                  	call	print_msg
  7737                                  
  7738 0000209F BE[0050]                	mov	si, msg_total_sectors
  7739 000020A2 E807F9                  	call	print_msg
  7740                                  	;mov	ax, [di+ptSectors]
  7741                                  	;mov	dx, [di+ptSectors+2]
  7742                                  	; 20/03/2021
  7743 000020A5 668B450C                	mov	eax, [di+ptSectors]
  7744                                  
  7745                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  7746                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  7747                                  	; 06/11/2020
  7748 000020A9 BE[E369]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7749                                  	; eax = binary number ; 20/03/2021
  7750 000020AC E8B6F9                  	call	bin_to_decimal	
  7751 000020AF E8FAF8                  	call	print_msg
  7752                                  
  7753                                  	; 24/02/2019
  7754 000020B2 BE[5852]                	mov	si, CRLF
  7755 000020B5 E8F4F8                  	call	print_msg
  7756                                  
  7757 000020B8 89FE                    	mov	si, di  ; partition table row address
  7758                                  
  7759                                  	; 20/03/2021
  7760                                  	; (clear hw of eax)
  7761 000020BA 6631C0                  	xor	eax, eax
  7762                                  
  7763 000020BD C3                      	retn
  7764                                  
  7765                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7766                                  ; write byte as descimal number
  7767                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7768                                  
  7769                                  write_byte_decimal:
  7770                                  	; INPUT ->
  7771                                  	;	AL = binary number
  7772                                  	; OUTPUT ->
  7773                                  	;	DS:SI = decimal number text address
  7774                                  	;	        (ASCIIZ string)
  7775                                  	;
  7776                                  	; (SI, AX, CX will be modified)
  7777                                  
  7778                                  	;mov	si, msg_partition_sectors + 8  ; max. 8 digits
  7779                                  	; 06/11/2020
  7780 000020BE BE[E469]                	mov	si, msg_partition_sectors + 11 ; max. 11 digits
  7781 000020C1 B10A                    	mov	cl, 10
  7782                                  wbd_loop:
  7783 000020C3 4E                      	dec	si
  7784 000020C4 30E4                    	xor	ah, ah
  7785 000020C6 F6F1                    	div	cl
  7786 000020C8 80C430                  	add	ah, '0'
  7787 000020CB 8824                    	mov	[si], ah
  7788 000020CD 20C0                    	and	al, al
  7789 000020CF 75F2                    	jnz	short wbd_loop
  7790 000020D1 C3                      	retn
  7791                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7792                                  ; init (MBR) partition table
  7793                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7794                                  ; 16/10/2020
  7795                                  
  7796                                  	; 09/03/2021
  7797                                  	; 03/02/2019
  7798                                  init_partition_table:
  7799                                  
  7800                                  	; INPUT -> none
  7801                                  	; OUTPUT -> none
  7802                                  
  7803                                  	; 15/10/2020
  7804                                  	; (If a partition row contains invalid/wrong/defective parameters)
  7805                                  	; (it's active partition flag/byte will be 0FFh, an invalid value!)
  7806                                  
  7807                                  	; 12/02/2019	
  7808                                  	;cmp	word [MBIDCode], 0AA55h
  7809                                  	;jne	ipt_stc ; invalid
  7810                                  
  7811                                  	; 15/02/2019
  7812                                  	; clear primary partition table structure/list
  7813                                  
  7814 000020D2 BF[726C]                	mov	di, part_table_boot_ind
  7815                                  	;mov	cx, 36 ; 18*4 = 72 bytes
  7816                                  	; 05/11/2020
  7817 000020D5 B92C00                  	mov	cx, 44 ; 22*4 = 88 bytes
  7818                                  	;xor	ax, ax ; 0
  7819 000020D8 6631C0                  	xor	eax, eax ; 09/03/2021
  7820 000020DB F3AB                    	rep	stosw
  7821                                  
  7822 000020DD A3[CA6C]                	mov	[pcount], ax ; reset (pcount & ppcount)
  7823 000020E0 A3[CC6C]                	mov	[apcount], ax ; reset (apcount & epnumber)
  7824                                  
  7825 000020E3 BE[9254]                	mov	si, MasterBootBuff+446 ; Partition table offset
  7826                                  	;mov	cx, 4
  7827 000020E6 B104                    	mov	cl, 4
  7828 000020E8 31FF                    	xor	di, di
  7829                                  ipt_0:
  7830 000020EA 8A6404                  	mov	ah, [si+ptFileSystemID]
  7831                                  
  7832 000020ED 20E4                    	and	ah, ah
  7833 000020EF 0F840D01                	jz	ipt_8 ; empty
  7834                                  
  7835 000020F3 FE06[CA6C]              	inc	byte [pcount] ; partition count
  7836                                  
  7837 000020F7 80FC01                  	cmp	ah, 1	; FAT12
  7838 000020FA 7442                    	je	short ipt_2
  7839 000020FC 80FC04                  	cmp	ah, 4	; FAT16
  7840 000020FF 743D                    	je	short ipt_2
  7841 00002101 723F                    	jb	short ipt_3	
  7842 00002103 80FC06                  	cmp	ah, 6	; FAT16 big
  7843 00002106 7436                    	je	short ipt_2
  7844 00002108 7715                    	ja	short ipt_1 ; EXTENDED
  7845                                  
  7846                                  	;cmp	ah, 5 ; EXTENDED
  7847                                  	;jne	short ipt_3
  7848                                  ipt_17:
  7849 0000210A 803E[CD6C]00            	cmp	byte [epnumber], 0
  7850                                  	;ja	short ipt_stc ; invalid  (more than 1 extended dos partition)
  7851 0000210F 7605                    	jna	short ipt_15
  7852                                  	
  7853 00002111 C685[726C]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  7854                                  				; Invalid/Defective partition flag
  7855                                  ipt_15:	
  7856 00002116 B005                    	mov	al, 5
  7857 00002118 28C8                    	sub	al, cl ; partition number 1 to 4
  7858 0000211A A2[CD6C]                	mov	byte [epnumber], al ; extended partition entry number (1 to 4)
  7859 0000211D EB23                    	jmp	short ipt_3
  7860                                  ipt_1:
  7861                                  	; 26/10/2020
  7862 0000211F 80FC07                  	cmp	ah, 07h ; NTFS (Windows FS)
  7863 00002122 741A                    	je	short ipt_2 ; accept NTFS as primary dos partition
  7864                                  			    ; (then, extended partition can be created)	
  7865                                  	; 24/10/2020
  7866 00002124 80FC0C                  	cmp	ah, 0Ch ; FAT32 (LBA)
  7867 00002127 7415                    	je	short ipt_2
  7868 00002129 7707                    	ja	short ipt_18
  7869                                  	; 16/10/2020
  7870 0000212B 80FC0B                  	cmp	ah, 0Bh ; FAT32 (CHS)
  7871                                  	;jne	short ipt_3
  7872                                  	; 24/10/2020
  7873 0000212E 740E                    	je	short ipt_2
  7874                                  	;jb	short ipt_3 ; non-dos partition (NTFS or unknown fs type)
  7875                                  	; 09/03/2021
  7876 00002130 EB10                    	jmp	short ipt_3 ; non-dos partition (unknown fs type)
  7877                                  ipt_18:
  7878 00002132 80FC0F                  	cmp	ah, 0Fh  ; EXTENDED (LBA)
  7879 00002135 74D3                    	je	short ipt_17
  7880 00002137 7709                    	ja	short ipt_3 ; non-dos partition 
  7881                                  			    ; (xenix/unix/linux/singlix/runix or unknown)
  7882 00002139 80FC0E                  	cmp	ah, 0Eh ; FAT16 (LBA)
  7883 0000213C 7504                    	jne	short ipt_3 ; 0Dh
  7884                                  	; FAT16 LBA (0Eh)
  7885                                  ipt_2:
  7886 0000213E FE06[CB6C]              	inc	byte [ppcount] ; primary dos partition count
  7887                                  ipt_3:
  7888 00002142 88A5[796C]              	mov	[part_table_sys_id+di], ah  ; Partition Type (FS type)
  7889                                  	
  7890 00002146 8A04                    	mov	al, [si+ptBootable]
  7891                                  
  7892 00002148 20C0                    	and	al, al
  7893 0000214A 7413                    	jz	short ipt_4
  7894                                  
  7895 0000214C 803E[CC6C]01            	cmp	byte [apcount], 1 ; check (previous) active partition count
  7896                                  	;jnb	short ipt_stc  ; invalid (if it is not zero here)
  7897 00002151 7304                    	jnb	short ipt_16
  7898                                  
  7899 00002153 3C80                    	cmp	al, 80h  ; active partition sign/flag?
  7900                                  	;jne	short ipt_stc  ; invalid flag
  7901 00002155 7404                    	je	short ipt_11
  7902                                  ipt_16:
  7903                                  	; 15/10/2020
  7904 00002157 B0FF                    	mov	al, 0FFh ; Invalid/Defective partition flag 
  7905 00002159 EB04                    	jmp	short ipt_4
  7906                                  ipt_11:
  7907 0000215B FE06[CC6C]              	inc	byte [apcount]  ; active partition count = 1
  7908                                  ipt_4:
  7909 0000215F 8885[726C]              	mov	[part_table_boot_ind+di], al
  7910                                  
  7911                                  	;mov	al, [heads]
  7912                                  ;ipt_4_fix:
  7913                                  	;dec	al
  7914 00002163 8A6401                  	mov	ah, [si+ptBeginHead]
  7915                                  	;cmp	al, ah
  7916                                  	;;jb	short ipt_retn ; invalid
  7917                                  	;jb	ipt_heads_fix ; 10/02/2019
  7918 00002166 88A5[736C]              	mov	[part_table_start_head+di], ah
  7919 0000216A 8A6405                  	mov	ah, [si+ptEndHead]
  7920                                  	;cmp	al, ah
  7921                                  	;;jb	short ipt_retn ; invalid
  7922                                  	;jb	short ipt_heads_fix ; 10/02/2019
  7923 0000216D 88A5[7A6C]              	mov	[part_table_end_head+di], ah
  7924                                  	;mov	al, [sectors]
  7925 00002171 8A7C02                  	mov	bh, [si+ptBeginSector]
  7926 00002174 88FC                    	mov	ah, bh
  7927 00002176 80E43F                  	and	ah, 3Fh ; 63
  7928                                  	;cmp	al, ah
  7929                                  	;jb	short ipt_retn ; invalid
  7930 00002179 88A5[746C]              	mov	[part_table_start_sector+di], ah
  7931 0000217D 8A7406                  	mov	dh, [si+ptEndSector]
  7932 00002180 88F4                    	mov	ah, dh
  7933 00002182 80E43F                  	and	ah, 3Fh ; 63
  7934                                  	;cmp	al, ah
  7935                                  	;jb	short ipt_retn ; invalid
  7936 00002185 88A5[7B6C]              	mov	[part_table_end_sector+di], ah
  7937 00002189 C0EF06                  	shr	bh, 6
  7938                                  	;mov	bl, [si+ptBeginCylinder]
  7939 0000218C 8A4403                  	mov	al, [si+ptBeginCylinder] ; 09/03/2021
  7940 0000218F 88FC                    	mov	ah, bh ; 09/03/2021
  7941                                  	;mov	ax, [cylinders]
  7942                                  	;dec	ax
  7943                                  	;cmp	ax, bx
  7944                                  	;jb	short ipt_retn ; invalid
  7945                                  	;mov	[part_table_start_cyl+di], bx
  7946 00002191 668985[756C]            	mov	[part_table_start_cyl+di], eax ; 09/03/2021
  7947 00002196 C0EE06                  	shr	dh, 6
  7948                                  	;mov	dl, [si+ptEndCylinder]
  7949 00002199 8A4407                  	mov	al, [si+ptEndCylinder] ; 09/03/2021
  7950 0000219C 88F4                    	mov	ah, dh	; 09/03/2021
  7951                                  	;cmp	ax, dx
  7952                                  	;jb	short ipt_retn ; invalid
  7953                                  	;mov	[part_table_end_cyl+di], dx
  7954 0000219E 668985[7C6C]            	mov	[part_table_end_cyl+di], eax ; 09/03/2021
  7955                                  
  7956                                  	;mov	ax, [si+ptStartSector]
  7957                                  	;mov	dx, [si+ptStartSector+2]
  7958 000021A3 668B4408                	mov	eax, [si+ptStartSector] ; 09/03/2021
  7959                                  
  7960                                  	;mov	[part_table_rel_sec_lw+di], ax
  7961                                  	;mov	[part_table_rel_sec_hw+di], dx
  7962 000021A7 668985[806C]            	mov	[part_table_rel_sec+di], eax ; 09/03/2021
  7963                                  
  7964                                  	;or	ax, dx
  7965                                  	;;jz	short ipt_stc ; invalid (start sector must not be zero)
  7966                                  	;jnz	short ipt_12
  7967                                  	; 09/03/2021
  7968 000021AC 6609C0                  	or	eax, eax
  7969 000021AF 7505                    	jnz	short ipt_12
  7970                                  	; 15/10/2020
  7971 000021B1 C685[726C]FF            	mov	byte [part_table_boot_ind+di], 0FFh
  7972                                  				; Invalid/Defective partition flag
  7973                                  ipt_12:
  7974                                  	;mov	ax, [si+ptSectors]
  7975                                  	;mov	dx, [si+ptSectors+2]
  7976 000021B6 668B440C                	mov	eax, [si+ptSectors] ; 09/03/2021
  7977                                  
  7978                                  	;mov	bx, dx
  7979                                  	;or	bx, ax
  7980                                  	;;jz	short ipt_stc	; invalid (zero size of partition)
  7981                                  	;jnz	short ipt_6 ; 10/02/2019
  7982                                  	; 09/03/2021
  7983 000021BA 6609C0                  	or 	eax, eax
  7984 000021BD 7505                    	jnz	short ipt_6
  7985                                  
  7986                                  	; 15/10/2020
  7987 000021BF C685[726C]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  7988                                  				; Invalid/Defective partition flag
  7989                                  
  7990                                  	;cmp	dx, [total_sectors+2]
  7991                                  	;ja	short ipt_stc	; invalid (partition size > disk capacity)
  7992                                  	;jb	short ipt_6
  7993                                  	;;cmp	ax, [total_sectors] ; (ax + 1) <= total sectors
  7994                                  	;jb	short ipt_6
  7995                                  	
  7996                                  ;ipt_stc:
  7997                                  ;	; invalid MBR data
  7998                                  ;	;stc
  7999                                  ;ipt_retn:
  8000                                  ;	retn
  8001                                  
  8002                                  ;ipt_heads_fix:
  8003                                  	; 10/02/2019
  8004                                  	; AL = [heads] - 1
  8005                                  
  8006                                  	;test	byte [cylinders], 1
  8007                                  	;jnz	short ipt_stc ; odd cylinder count (can not be shifted)
  8008                                  	
  8009                                  	;inc	al ; = [heads]
  8010                                  	;cmp	al, 8
  8011                                  	;ja	short ipt_stc ; this fix is needed for <= 16 heads (& 17 spt)
  8012                                  	;shl	al, 1
  8013                                  	;mov	[heads], al ; heads = heads*2
  8014                                  	;shr	word [cylinders], 1 ; cylinders = cylinders/2
  8015                                  	;jmp	ipt_4_fix
  8016                                  
  8017                                  ipt_6:
  8018                                  	;mov	[part_table_num_sec_lw+di], ax
  8019                                  	;mov	[part_table_num_sec_hw+di], dx
  8020                                  	; 09/03/2021
  8021 000021C4 668985[846C]            	mov	[part_table_num_sec+di], eax
  8022                                  
  8023                                  	;add	ax, [part_table_rel_sec_lw+di]
  8024                                  	;adc	dx, [part_table_rel_sec_hw+di]
  8025                                  	;;jc	short ipt_retn  ; invalid
  8026                                  	; 27/10/2020
  8027                                  	;jc	short ipt_13
  8028                                  	; 09/03/2021
  8029 000021C9 660385[806C]            	add	eax, [part_table_rel_sec+di]
  8030 000021CE 7207                    	jc	short ipt_13  ; invalid !
  8031                                  
  8032                                  	;cmp	dx, [total_sectors+2]
  8033                                  	;;ja	short ipt_stc	; invalid (partition end > disk capacity)
  8034                                  	;jb	short ipt_7
  8035                                  	; 27/10/2020
  8036                                  	;ja	short ipt_13
  8037                                  	;cmp	ax, [total_sectors] ; ax <= total sectors
  8038                                  	;;ja	short ipt_stc	; invalid (partition end > disk capacity)
  8039                                  	;jna	short ipt_7
  8040                                  	; 09/03/2011
  8041 000021D0 663B06[2E65]            	cmp	eax, [total_sectors]
  8042 000021D5 7605                    	jna	short ipt_7
  8043                                  ipt_13:
  8044                                  	; 15/10/2020
  8045 000021D7 C685[726C]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  8046                                  				; Invalid/Defective partition flag 
  8047                                  ipt_7:
  8048                                  	; 27/10/2020
  8049                                  	;mov	ax, 1022 ; CHS cylinder number limit
  8050                                  	;cmp	[part_table_start_cyl+di], ax
  8051                                  	;ja	short ipt_19 ; = 1023
  8052                                  	;inc	ax ; 1023
  8053                                  	;cmp	[part_table_end_cyl+di], ax
  8054                                  	;jb	short ipt_14  ; < 1023
  8055                                  	; 12/03/2021
  8056 000021DC 66B8FE030000            	mov	eax, 1022
  8057 000021E2 663985[756C]            	cmp	[part_table_start_cyl+di], eax
  8058 000021E7 7708                    	ja	short ipt_19 ; = 1023
  8059 000021E9 40                      	inc	ax
  8060 000021EA 663985[7C6C]            	cmp	[part_table_end_cyl+di], eax
  8061 000021EF 7203                    	jb	short ipt_14  ; < 1023
  8062                                  ipt_19:
  8063                                  	; 27/10/2020
  8064                                  	; set cylinder number if the partition's start or end sector is
  8065                                  	; at the beyond of chs limit 
  8066                                  	; ax = 1022 -> set start cylinder
  8067                                  	; ax = 1023 -> set end cylinder
  8068 000021F1 E82600                  	call	cylindernumberfix
  8069                                  ipt_14:
  8070 000021F4 83C610                  	add	si, 16
  8071 000021F7 E201                    	loop	ipt_5
  8072                                  	
  8073                                  	; OK!
  8074                                  
  8075                                  	;clc
  8076 000021F9 C3                      	retn
  8077                                  
  8078                                  ipt_5:
  8079                                  	;add	di, 18
  8080                                  	; 05/11/2020
  8081 000021FA 83C716                  	add	di, 22
  8082 000021FD E9EAFE                  	jmp	ipt_0
  8083                                  
  8084                                  ipt_8:
  8085                                  	; Empty partition table check (all of 16 bytes must be 0)
  8086 00002200 51                      	push	cx
  8087 00002201 56                      	push	si ; 16/10/2020
  8088                                  	;mov	cl, 8
  8089 00002202 B104                    	mov	cl, 4 ; 12/03/2021
  8090                                  ipt_9:
  8091                                  	;lodsw
  8092                                  	;or	ax, ax
  8093                                  	;jnz	short ipt_10
  8094                                  	; 12/03/2021
  8095 00002204 66AD                    	lodsd
  8096 00002206 6609C0                  	or	eax, eax
  8097 00002209 7507                    	jnz	short ipt_10
  8098 0000220B E2F7                    	loop	ipt_9
  8099 0000220D 59                      	pop	cx ; 16/10/2020  ; (discard si)
  8100 0000220E 59                      	pop	cx
  8101 0000220F E2E9                    	loop	ipt_5
  8102                                  	
  8103                                  	;clc
  8104 00002211 C3                      	retn
  8105                                  ipt_10:
  8106                                  	;pop	cx
  8107                                  	; invalid
  8108                                  	;stc
  8109                                  	; 27/10/2020
  8110                                  	; 15/10/2020
  8111                                  	;mov	byte [part_table_boot_ind+di], 0FFh
  8112                                  				; Invalid/Defective partition flag
  8113                                  	;retn
  8114                                  	; 16/10/2020
  8115                                  	; 31/10/2020
  8116                                  	;mov	byte [part_table_sys_id+di], 0	; Empty partition
  8117                                  	; 12/03/2021
  8118 00002212 6629C0                  	sub	eax, eax
  8119                                  	;
  8120 00002215 5E                      	pop	si
  8121 00002216 59                      	pop	cx
  8122 00002217 E93DFF                  	jmp	ipt_16
  8123                                  
  8124                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8125                                  ; set cylinder number to partition's start or end sector 
  8126                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8127                                  ; 27/10/2020
  8128                                  
  8129                                  	; 09/03/2021
  8130                                  	; 06/11/2020 (32 bit cylinder numbers, upto 267349)
  8131                                  cylindernumberfix:
  8132                                  	; ax = 1022 -> set start cylinder
  8133                                  	; ax = 1023 -> set end cylinder
  8134                                  	; di = partition table structure offset
  8135                                  
  8136                                  	;; modified registers: ax, dx, bx
  8137                                  	; modified registers: eax, edx ; 09/03/2021
  8138                                  	
  8139 0000221A 3DFF03                  	cmp	ax, 1023
  8140 0000221D 733D                    	jnb	short cnf_4 ; set end cylinder
  8141                                  	
  8142 0000221F 80BD[736C]FE            	cmp	byte [part_table_start_head+di], 0FEh ; 254
  8143 00002224 7536                    	jne	short cnf_4 ; no need to fix (start cyl) 
  8144                                  			; 30/10/2020
  8145                                  	; 28/10/2020
  8146 00002226 80BD[746C]3F            	cmp	byte [part_table_start_sector+di], 3Fh ; 63
  8147 0000222B 752F                    	jne	short cnf_4 ; no need to fix (start cyl)
  8148                                  			; 30/10/2020
  8149                                  
  8150                                  	;mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  8151                                  	;mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  8152                                  	;push	cx
  8153                                  	;mov	cx, [hs] ; [heads*spt]
  8154                                  	;call	div32
  8155                                  	;	; dx:ax = cylinder number, dx = 0, quotient	
  8156                                  	;	; bx = remainder
  8157                                  	;pop	cx
  8158                                  	;or 	dx, dx
  8159                                  	;jnz	short cnf_2 ; invalid
  8160                                  
  8161                                  	; 09/03/2021
  8162 0000222D 668B85[806C]            	mov	eax, [part_table_rel_sec+di]
  8163 00002232 6631D2                  	xor	edx, edx
  8164 00002235 66F736[EC69]            	div	dword [hs] ; [heads*spt] ; <= 16065
  8165                                  
  8166                                  	;cmp	ax, [part_table_start_cyl+di]
  8167                                  	; 09/03/2021
  8168 0000223A 663B85[756C]            	cmp	eax, [part_table_start_cyl+di]
  8169                                  	;je	short cnf_5
  8170 0000223F 7407                    	je	short cnf_1
  8171 00002241 7213                    	jb	short cnf_2 ; invalid
  8172                                  	;mov	[part_table_start_cyl+di], ax ; change it
  8173                                  	; 09/03/2021
  8174 00002243 668985[756C]            	mov	[part_table_start_cyl+di], eax ; change it
  8175                                  	;jmp	short cnf_5 
  8176                                  cnf_1:
  8177 00002248 80BD[7A6C]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  8178 0000224D 7507                    	jne	short cnf_2 ; no need to fix (also invalid)
  8179                                  	
  8180                                  	; 28/10/2020
  8181 0000224F 80BD[7B6C]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  8182 00002254 7414                    	je	short cnf_5 ; fix
  8183                                  	; no need to fix (also invalid)
  8184                                  cnf_2:
  8185 00002256 C685[726C]FF            	mov	byte [part_table_boot_ind+di], 0FFh ; invalid PTE
  8186                                  cnf_3:
  8187 0000225B C3                      	retn
  8188                                  cnf_4:
  8189 0000225C 80BD[7A6C]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  8190 00002261 75F8                    	jne	short cnf_3 ; no need to fix (end cyl)
  8191                                  	
  8192                                  	; 28/10/2020
  8193 00002263 80BD[7B6C]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  8194 00002268 75F1                    	jne	short cnf_3 ; no need to fix (end cyl)
  8195                                  cnf_5:
  8196                                  	;mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  8197                                  	;mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  8198                                  	;
  8199                                  	;add	ax, [part_table_num_sec_lw+di] ; number of sectors, lw 
  8200                                  	;adc	dx, [part_table_num_sec_hw+di] ; number of sectors, hw 
  8201                                  	;;jc	short cnf_2
  8202                                  
  8203                                  	; 09/03/2021
  8204 0000226A 668B85[806C]            	mov	eax, [part_table_rel_sec+di] ; start sector
  8205 0000226F 660385[846C]            	add	eax, [part_table_num_sec+di] ; number of sectors
  8206                                  	;jc	short cnf_2 
  8207                                  
  8208                                  	;sub	ax, 1
  8209                                  	;sbb	dx, 0
  8210                                  	;	; dx:ax = end sector
  8211                                  	;push	cx
  8212                                  	;mov	cx, [hs] ; [heads*spt]
  8213                                  	;call	div32
  8214                                  	;	; dx:ax = cylinder number, dx = 0, quotient
  8215                                  	;	; bx = remainder
  8216                                  	;pop	cx
  8217                                  	;or 	dx, dx
  8218                                  	;jnz	short cnf_2 ; invalid
  8219                                  
  8220                                  	; 09/03/2021
  8221 00002274 6648                    	dec	eax  ; end sector
  8222 00002276 6631D2                  	xor	edx, edx ; 12/03/2021
  8223 00002279 66F736[EC69]            	div	dword [hs]  ; [heads*spt] ; <= 16065
  8224                                  
  8225                                  	;cmp	ax, [part_table_end_cyl+di]
  8226                                  	; 09/03/2021
  8227 0000227E 663B85[7C6C]            	cmp	eax, [part_table_end_cyl+di]
  8228 00002283 74D6                    	je	short cnf_3 ; same cylinder number
  8229 00002285 72CF                    	jb	short cnf_2 ; invalid
  8230                                  	;mov	[part_table_end_cyl+di], ax ; change it
  8231                                  	; 09/03/2021
  8232 00002287 668985[7C6C]            	mov	[part_table_end_cyl+di], eax ; change it
  8233 0000228C C3                      	retn
  8234                                  
  8235                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8236                                  ; sort partition table in (ending) cylinder number order
  8237                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8238                                  ; 25/10/2020 (fdisk3.s)
  8239                                  
  8240                                  	; 10/03/2021 (fdisk4.s)
  8241                                  	; 02/02/2019 (hdimage.s)
  8242                                  	
  8243                                  sort_partition_table:
  8244                                  
  8245                                  	; INPUT -> none
  8246                                  	; OUTPUT -> none
  8247                                  
  8248 0000228D 31DB                    	xor	bx, bx
  8249                                  	;jmp	short sortpt_2 ; 25/10/2020
  8250                                  sortpt_1:
  8251 0000228F 889F[026A]              	mov	[bx+sort], bl ; 0
  8252 00002293 FEC3                    	inc	bl
  8253                                  sortpt_2:
  8254 00002295 80FB04                  	cmp	bl, 4 ; number of partition table entries to sort
  8255 00002298 72F5                    	jb	short sortpt_1
  8256                                  
  8257                                  	; Do a bubble sort
  8258                                  
  8259 0000229A EB04                    	jmp	short sortpt_4
  8260                                  sortpt_3:
  8261                                  	; Sort until we don't do a swap
  8262                                  
  8263 0000229C 08C9                    	or	cl, cl ; sort changed ?
  8264 0000229E 7454                    	jz	short sortpt_8 ; no
  8265                                  sortpt_4:
  8266 000022A0 30C9                    	xor	cl, cl
  8267                                  
  8268 000022A2 B301                    	mov	bl, 1
  8269                                  
  8270                                  	;mov	dl, 18  ; partition table structure size
  8271                                  	; 05/11/2020
  8272 000022A4 B216                    	mov	dl, 22
  8273 000022A6 EB07                    	jmp	short sortpt_6
  8274                                  sortpt_5:
  8275 000022A8 FEC3                    	inc	bl
  8276                                  
  8277 000022AA 80FB04                  	cmp	bl, 4
  8278 000022AD 73ED                    	jnb	short sortpt_3
  8279                                  
  8280                                  sortpt_6:
  8281 000022AF 8A87[026A]              	mov	al, [bx+sort]
  8282                                  
  8283 000022B3 F6E2                    	mul	dl
  8284                                  
  8285 000022B5 89C6                    	mov	si, ax
  8286                                  
  8287                                  	;mov	di, [part_table_end_cyl+si]
  8288                                  
  8289 000022B7 8A87[016A]              	mov	al, [bx+sort-1]
  8290                                  
  8291 000022BB F6E2                    	mul	dl ; * 22 ; 05/11/2020
  8292                                  
  8293                                  	;xchg	di, ax
  8294                                  	; 10/03/2021
  8295 000022BD 89C7                    	mov	di, ax
  8296 000022BF 668B84[7C6C]            	mov	eax, [part_table_end_cyl+si]
  8297                                  
  8298                                  	;cmp	[part_table_end_cyl+di], ax ; previous > current
  8299                                  	; 10/03/2021
  8300 000022C4 663985[7C6C]            	cmp	[part_table_end_cyl+di], eax ; previous > current
  8301 000022C9 771B                    	ja	short sortpt_7 ; swap order indicators
  8302                                  		; 31/10/2020
  8303                                  		; current end cyl >= previous end cyl
  8304                                  	; 31/10/2020
  8305 000022CB 72DB                    	jb	short sortpt_5  
  8306                                  		; current end cyl > previous end cyl
  8307                                  	
  8308                                  	;and	ax, ax ; cylinder 0 ?
  8309                                  	; 10/03/2021
  8310 000022CD 6621C0                  	and	eax, eax ; cylinder 0 ?
  8311 000022D0 75D6                    	jnz	short sortpt_5 ; no
  8312                                  		; current end cyl = previous end cyl, cyl > 0
  8313                                  	
  8314                                  	; current end cyl = previous end cyl = 0
  8315                                  
  8316                                  	; If current entry is empty partition entry
  8317                                  	; and previous entry is not empty partition entry
  8318                                  	; swap them.
  8319                                  	
  8320                                  	;mov	ax, [part_table_num_sec_hw+di] ; previous entry
  8321                                  	;or	ax, [part_table_num_sec_lw+di]
  8322                                  	;jz	short sortpt_5
  8323                                  	; 10/03/2021
  8324 000022D2 668B85[846C]            	mov	eax, [part_table_num_sec+di] 
  8325 000022D7 6609C0                  	or	eax, eax
  8326 000022DA 74CC                    	jz	short sortpt_5
  8327                                  
  8328                                  	;mov	ax, [part_table_num_sec_hw+si] ; current entry
  8329                                  	;or	ax, [part_table_num_sec_lw+si]
  8330                                  	;jnz	short sortpt_5
  8331                                  	; 10/03/2021
  8332 000022DC 668B84[846C]            	mov	eax, [part_table_num_sec+si]
  8333 000022E1 6609C0                  	or	eax, eax
  8334 000022E4 75C2                    	jnz	short sortpt_5
  8335                                  sortpt_7:
  8336                                  	; Swap the order indicators
  8337                                  
  8338 000022E6 8B87[016A]              	mov	ax, [bx+sort-1]
  8339 000022EA 86E0                    	xchg	ah, al
  8340 000022EC 8987[016A]              	mov	[bx+sort-1], ax
  8341                                  
  8342 000022F0 B101                    	mov	cl, 1 ; sort changed
  8343 000022F2 EBB4                    	jmp	short sortpt_5
  8344                                  
  8345                                  sortpt_8:
  8346                                  	; 30/10/2020
  8347                                  	;mov 	byte [p_sorted], 1 ; 04/02/2019
  8348                                  
  8349                                  	; 10/03/2021
  8350                                  	;xor	eax, eax
  8351                                  
  8352 000022F4 C3                      	retn
  8353                                  
  8354                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8355                                  ; find free space before/after/between partitions
  8356                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8357                                  ; 03/02/2019
  8358                                  
  8359                                  	; 12/03/2021
  8360                                  	; 11/03/2021 (fdisk4.s) -32 bit cylinder numbers-
  8361                                  	;
  8362                                  find_part_free_space:  ; find/calculate free space for partitions
  8363                                  	; 15/02/2019
  8364                                  
  8365                                  	; INPUT -> 
  8366                                  	;	AL = 0 -> calculate for primary/MBR partitions
  8367                                  	;	AL = 5 -> calculate for extended partition
  8368                                  	; OUTPUT ->
  8369                                  	;	CX = the largest free space/cylinders (between partitions)
  8370                                  	;	AX = Free space index (gap number) - from 0 to 4 -
  8371                                  	;	BX = Free space structure offset (for the largest free space)
  8372                                  	;
  8373                                  	;	22/02/2019
  8374                                  	;	[freespace_count] = number of free spaces/gaps
  8375                                  
  8376                                  	; 12/03/2021
  8377                                  	; OUTPUT:
  8378                                  	;   ECX = the largest free space/cylinders (between partitions)
  8379                                  	;    AX = Free space index (gap number) - from 0 to 4 -
  8380                                  	;    BX = Free space structure offset (for the largest free space)
  8381                                  	;   (EDX = 0)
  8382                                  
  8383 000022F5 A2[1C6C]                	mov	[p_type], al
  8384                                  
  8385                                  	; Sort the partition table
  8386                                  
  8387 000022F8 E892FF                  	call	sort_partition_table ; 16/02/2019
  8388                                  
  8389                                  	; Initialize free space to zero
  8390                                  
  8391                                  	; 15/02/2019
  8392 000022FB BF[266D]                	mov	di, fspc ; free_space.space
  8393 000022FE B92800                  	mov	cx, 5*8 ; (5*16/2)
  8394                                  	;mov	ecx, 5*8 ; 11/03/2021 
  8395                                  	;xor	ax, ax ; 0
  8396 00002301 6631C0                  	xor	eax, eax ; 11/03/2021
  8397 00002304 F3AB                    	rep	stosw
  8398                                  
  8399 00002306 A2[1A6C]                	mov	[freespace_count], al ; 0
  8400                                  	; 22/02/2019
  8401                                  	;mov	[last_found_partition], al ; 0
  8402                                  
  8403 00002309 A3[186C]                	mov	[_i_], ax ; 0
  8404                                  	;jmp	short fpfs_2
  8405                                  	; 31/10/020
  8406 0000230C EB0E                    	jmp	short fpfs_3
  8407                                  fpfs_1:	
  8408 0000230E FE06[186C]              	inc	byte [_i_]
  8409                                  ;;fpfs_2:
  8410 00002312 803E[186C]04            	cmp	byte [_i_], 4
  8411 00002317 7203                    	jb	short fpfs_3
  8412 00002319 E96201                  	jmp	fpfs_13
  8413                                  fpfs_3:
  8414                                  	; Find space between start of disk and first partition
  8415                                  
  8416                                  	;mov	ax, [_i_]
  8417 0000231C 8B1E[186C]              	mov	bx, [_i_] ; 31/10/2020
  8418                                  fpfs_2:
  8419                                  	;mov	bx, ax ; 31/10/2020
  8420                                  	;mov	al, [sort+bx]
  8421 00002320 8A8F[026A]              	mov	cl, [sort+bx] ; 15/02/2019
  8422                                  
  8423                                  	;;mov	cl, 18 ; partition table structure size = 18 bytes
  8424                                  	;mov	al, 18 ; 15/02/2019
  8425                                  	; 05/11/2020
  8426 00002324 B016                    	mov	al, 22 ; partition table structure size = 22 bytes
  8427 00002326 F6E1                    	mul	cl
  8428 00002328 89C3                    	mov	bx, ax
  8429                                  
  8430 0000232A 80BF[796C]00            	cmp	byte [part_table_sys_id+bx], 0
  8431 0000232F 74DD                    	je	short fpfs_1
  8432                                  
  8433 00002331 880E[1B6C]              	mov	[last_found_partition], cl ; 15/02/2019
  8434                                  
  8435                                  	;xor	cx, cx
  8436 00002335 30C9                    	xor	cl, cl ; 0
  8437                                  	;mov	al, 1 ; LBA = 1 (after MBR) ; ah = 0
  8438                                  	; 03/11/2020
  8439 00002337 A0[9E3C]                	mov	al, [sectors] ; 63 or 17 ; 03/11/2020	
  8440                                  
  8441 0000233A 803E[1C6C]05            	cmp	byte [p_type], 5  ; EXTENDED
  8442 0000233F 7506                    	jne	short fpfs_4
  8443                                  
  8444                                  	; This is a special case - the extended partition can not start
  8445                                  	; on cylinder 0 due to its architecture. Protect against that here
  8446                                  
  8447                                  	; 13/02/2019
  8448                                  	; LBA value of free space start
  8449                                  	;mov	al, [sectors] ; 03/11/2020
  8450 00002341 F626[A03C]              	mul	byte [heads]
  8451                                  		; ax = start sector (for Extended Partition)
  8452 00002345 FEC1                    	inc	cl ; 1 ; cx = start cylinder = 1
  8453                                  fpfs_4:
  8454                                  	; Found a partition, get the space
  8455                                  
  8456                                  	; 15/02/2019
  8457                                  	;mov	dx, [part_table_start_cyl+bx] 
  8458                                  	;	       ; Start cylinder of the 1st partition (as sorted)
  8459                                  	;cmp	dx, cx ; (cx=0 for primary partition, cx=1 for extd partition)
  8460                                  	;jna	fpfs_9 ; It is accepted as free (partition) space
  8461                                  	;	       ; if this space between masterboot sector and partition 1
  8462                                  	;	       ; has 1 cylinder (heads*spt) size at least.
  8463                                  	
  8464                                  	; 11/03/2021
  8465 00002347 668B97[756C]            	mov	edx, [part_table_start_cyl+bx]
  8466 0000234C 6639CA                  	cmp	edx, ecx
  8467 0000234F 0F86B400                	jna	fpfs_9
  8468                                  
  8469                                  	; 22/02/2019
  8470 00002353 31FF                    	xor	di, di  ; 0 ; Reset Free Space Table offset
  8471                                  
  8472 00002355 FE06[1A6C]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  8473                                  
  8474                                  	;mov	[free_space.start], cx ; 0 (for PP) or 1 (for EP)
  8475                                  	; 11/03/2021
  8476 00002359 66890E[2A6D]            	mov	[free_space.start], ecx	
  8477                                  
  8478                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  8479                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  8480                                  	;	if new partition will be selected as a primary dos partition.
  8481                                  	;	(But, start sector -LBA- will not be changed 
  8482                                  	;	 if it is a non-dos or user input type partition.. unless
  8483                                  	;	 cylinder boundary alignment option is used.)
  8484                                  	 	
  8485 0000235E A3[366D]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  8486                                  					     ; or 1 (for PP)
  8487                                  	;mov	[free_space.startsector+2], 0
  8488                                  
  8489                                  	; free space ends before start of next valid partition
  8490                                  	;mov	ax, dx	; start cylinder of partition 1 (as sorted)
  8491                                  	;sub	dx, cx	; cylinder count of free space 1 (gap 1)
  8492                                  	;dec	ax	; end cylinder of free space 1 (gap 1)
  8493                                  	;mov	[free_space.end], ax
  8494                                  	;mov	[free_space.space], dx
  8495                                  	; 11/03/2021
  8496 00002361 6689D0                  	mov	eax, edx
  8497 00002364 6629CA                  	sub	edx, ecx
  8498 00002367 6648                    	dec	eax
  8499 00002369 66A3[2E6D]              	mov	[free_space.end], eax
  8500 0000236D 668916[266D]            	mov	[free_space.space], edx
  8501                                  
  8502                                  	; save free space (1) as (non-aligned) sector count
  8503                                  	;mov	ax, [part_table_rel_sec_lw+bx]
  8504                                  	;mov	dx, [part_table_rel_sec_hw+bx]
  8505                                  	;sub	ax, [free_space.startsector]
  8506                                  	;sbb	dx, 0
  8507                                  	;mov	[free_space.sectors_unused], ax
  8508                                  	;mov	[free_space.sectors_unused+2], dx
  8509                                  	; 11/03/2021
  8510 00002372 668B87[806C]            	mov	eax, [part_table_rel_sec+bx]
  8511 00002377 662B06[366D]            	sub	eax, [free_space.startsector]
  8512 0000237C 66A3[326D]              	mov	[free_space.sectors_unused], eax
  8513                                  
  8514                                  	;mov	ax, [free_space.space]
  8515                                  
  8516                                  	;call	cylinders_to_sectors
  8517                                  
  8518                                  	;mov	[free_space.sectors_unused], ax
  8519                                  	;mov	[free_space.sectors_unused+2], dx
  8520                                  
  8521                                  	;mov	cx, [cylinders]		; Total (disk) cylinders -divisor-
  8522                                  	;mov	bx, [free_space.space]	; Partition cylinders -dividend-
  8523                                  	; 12/03/2021
  8524 00002380 66A1[266D]              	mov	eax, [free_space.space]
  8525                                  
  8526 00002384 E8E501                  	call	cylinders_to_percent
  8527                                  
  8528 00002387 A3[3A6D]                	mov	[free_space.percent_unused], ax
  8529                                  
  8530                                  	; 15/02/2019
  8531                                  	;mov	bl, [_i_]
  8532                                  	;xor	bh, bh
  8533                                  	;mov	al, [sort+bx]
  8534                                  
  8535                                  	;mov	[last_found_partition], al
  8536                                  
  8537                                  	; 31/10/2020
  8538 0000238A EB7B                    	jmp	fpfs_9
  8539                                  
  8540                                  	; Look for space between the rest of the partitions
  8541                                  
  8542                                  fpfs_7:
  8543                                  	; ah = 0
  8544                                  	;mov	al, [_i_]
  8545                                  	;;cbw
  8546                                  	;mov	bx, ax
  8547                                  	; 22/02/2019
  8548 0000238C 8B1E[186C]              	mov	bx, [_i_]
  8549                                  
  8550                                  	; 15/02/2019
  8551                                  	;mov	al, [sort+bx]
  8552 00002390 8A8F[026A]              	mov	cl, [sort+bx]
  8553                                  	;;mov	bl, 18
  8554                                  	;;mul	bl
  8555                                  	;mov	al, 18
  8556                                  	; 05/11/2020
  8557 00002394 B016                    	mov	al, 22
  8558 00002396 F6E1                    	mul	cl
  8559 00002398 89C6                    	mov	si, ax
  8560                                  	
  8561 0000239A 80BC[796C]00            	cmp	byte [part_table_sys_id+si], 0
  8562 0000239F 7466                    	je	short fpfs_9
  8563                                  
  8564                                  	; 15/02/2019
  8565 000023A1 860E[1B6C]              	xchg	[last_found_partition], cl
  8566                                  
  8567                                  	; Check to see if more than one partition on a cylinder
  8568                                  	; If so, leave the space at zero */
  8569                                  
  8570                                  	; NOTE:
  8571                                  	; If free space (gap) between partitions
  8572                                  	; has 1 cylinder (heads*spt) size at least..
  8573                                  	; ..It is accepted as valid free (partition) space.
  8574                                  
  8575                                  	;mov	al, 18 ; Partition tables/data structure size = 18 bytes
  8576                                  	; 05/11/2020
  8577 000023A5 B016                    	mov	al, 22 ; Partition tables/data structure size = 22 bytes
  8578 000023A7 F6E1                    	mul	cl
  8579 000023A9 89C3                    	mov	bx, ax  ; ah = 0
  8580                                  
  8581                                  	;mov	dx, [part_table_end_cyl+bx]   ; end cyl. of previous partition 
  8582                                  	;mov	ax, [part_table_start_cyl+si] ; start cyl. of current partition
  8583                                  	;
  8584                                  	;inc	dx  ; start cylinder of free space is after the end cylinder of
  8585                                  	;	    ; the previous partition (as sorted)
  8586                                  	;
  8587                                  	;cmp	ax, dx ; and it must be before than the next partition (as sorted)
  8588                                  	;jna	short fpfs_9 ; je short fpfs_9
  8589                                  	
  8590                                  	; 12/03/2021
  8591 000023AB 668B97[7C6C]            	mov	edx, [part_table_end_cyl+bx]   ; end cyl. of previous partition
  8592 000023B0 668B8C[756C]            	mov	ecx, [part_table_start_cyl+si] ; start cyl. of current partition
  8593                                  	
  8594 000023B5 6642                    	inc	edx ; start cylinder of free space is after the end cylinder of
  8595                                  		    ; the previous partition (as sorted)
  8596                                  	
  8597 000023B7 6639D1                  	cmp	ecx, edx ; and it must be before than the next partition (as sorted)
  8598 000023BA 764B                    	jna	short fpfs_9 ; je short fpfs_9
  8599                                  	
  8600                                  	; No, things are normal
  8601                                  	; Get space between the end of the last one and the start of the next one
  8602                                  
  8603                                  	; 22/02/2019
  8604                                  	;;add	di, 16
  8605                                  	;mov	di, [freespace_count]
  8606                                  	;shl	di, 4	; * 16 ; next entry offset (in free space table)
  8607                                  	; 12/03/2021
  8608 000023BC B016                    	mov	al, 22  ; ah = 0
  8609 000023BE F626[1A6C]              	mul	byte [freespace_count]
  8610 000023C2 89C7                    	mov	di, ax
  8611                                  
  8612 000023C4 FE06[1A6C]              	inc	byte [freespace_count]
  8613                                  
  8614                                  	;mov	cx, ax
  8615 000023C8 6689C8                  	mov	eax, ecx
  8616                                  	;sub	cx, dx
  8617 000023CB 6629D1                  	sub	ecx, edx
  8618                                  	;dec	ax
  8619 000023CE 6648                    	dec	eax
  8620                                  	;mov	[free_space.start+di], dx
  8621                                  	;mov	[free_space.end+di], ax
  8622                                  	;mov	[free_space.space+di], cx
  8623                                  
  8624 000023D0 668995[2A6D]            	mov	[free_space.start+di], edx
  8625 000023D5 668985[2E6D]            	mov	[free_space.end+di], eax
  8626 000023DA 66898D[266D]            	mov	[free_space.space+di], ecx
  8627                                  
  8628                                  	;mov	ax, [free_space.space+di]
  8629                                  	;call	cylinders_to_sectors
  8630                                  	;mov	[free_space.sectors_unused+di], ax
  8631                                  	;mov	[free_space.sectors_unused+2+di], dx
  8632                                  
  8633                                  	; calculate and save (non-aligned) free sector count between partitions
  8634                                  
  8635                                  	;mov	ax, [part_table_rel_sec_lw+bx]
  8636                                  	;mov	dx, [part_table_rel_sec_hw+bx]
  8637                                  	; 12/03/2021
  8638 000023DF 668B87[806C]            	mov	eax, [part_table_rel_sec+bx]
  8639                                  
  8640                                  	;add	ax, [part_table_num_sec_lw+bx]
  8641                                  	;adc	dx, [part_table_num_sec_hw+bx]
  8642 000023E4 660387[846C]            	add	eax, [part_table_num_sec+bx]
  8643                                  
  8644                                  	;mov	cx, [part_table_rel_sec_lw+si]
  8645                                  	;mov	bx, [part_table_rel_sec_hw+si]
  8646 000023E9 668B94[806C]            	mov	edx, [part_table_rel_sec+si]
  8647                                  
  8648                                  	;mov	[free_space.startsector+di], ax
  8649                                  	;mov	[free_space.startsector+2+di], dx
  8650 000023EE 668985[366D]            	mov	[free_space.startsector+di], eax
  8651                                  
  8652                                  	;sub	cx, ax
  8653                                  	;sbb	bx, dx
  8654 000023F3 6629C2                  	sub	edx, eax
  8655                                  
  8656                                  	;mov	[free_space.sectors_unused+di], cx
  8657                                  	;mov	[free_space.sectors_unused+2+di], bx
  8658 000023F6 668995[326D]            	mov	[free_space.sectors_unused+di], edx
  8659                                  
  8660                                  fpfs_8:
  8661                                  	; NOTE: Percentage is based on cylinder-boundary aligned partition size.
  8662                                  	; (total disk cylinders and partition's cylinder count are used for that)
  8663                                  
  8664                                  	;mov	cx, [cylinders] ; -divisor-
  8665                                  	;mov	bx, [free_space.space+di] ; -dividend-
  8666                                  	; 12/03/2021
  8667 000023FB 668B85[266D]            	mov	eax, [free_space.space+di]
  8668                                  
  8669 00002400 E86901                  	call	cylinders_to_percent
  8670                                  	
  8671 00002403 8985[3A6D]              	mov	[free_space.percent_unused+di], ax
  8672                                  	
  8673                                  	; ah = 0
  8674                                  
  8675                                  	; 15/02/2019
  8676                                  	;mov	bl, [_i_]
  8677                                  	;xor	bh, bh
  8678                                  	;mov	al, [sort+bx]
  8679                                  	;	
  8680                                  	;mov	[last_found_partition], al
  8681                                  
  8682                                  fpfs_9:
  8683 00002407 FE06[186C]              	inc	byte [_i_]
  8684                                  fpfs_10:
  8685 0000240B 803E[186C]04            	cmp	byte [_i_], 4
  8686 00002410 7303                    	jnb	short fpfs_11
  8687                                  
  8688 00002412 E977FF                  	jmp	fpfs_7
  8689                                  
  8690                                  fpfs_11:
  8691                                  	; Find the space between the last partition and the end of the disk
  8692                                  	; Make sure that freespace cannot become negative
  8693                                  
  8694 00002415 A0[1B6C]                	mov	al, [last_found_partition]
  8695                                  	;mov	cl, 18  ; Partition table structure size = 18 bytes
  8696                                  	; 05/11/2020
  8697 00002418 B116                    	mov	cl, 22  ; Partition table structure size = 22 bytes
  8698 0000241A F6E1                    	mul	cl
  8699 0000241C 89C3                    	mov	bx, ax
  8700                                  	;mov	cx, [cylinders]
  8701                                  	;dec	cx ; 15/02/2019 
  8702                                  	;	   ; (min. cylinder count = 1 for a valid/usable free space)
  8703                                  	;;mov	ax, [part_table_end_cyl+bx]
  8704                                  	; 12/03/2021
  8705 0000241E 668B0E[A23C]            	mov	ecx, [cylinders]
  8706 00002423 6649                    	dec	ecx 	
  8707                                  
  8708                                  	; 05/11/2020
  8709                                  	;cmp	[part_table_end_cyl+bx], cx
  8710                                  	;;cmp	ax, cx	; cx = end cylinder of the disk
  8711                                  	;jb	short fpfs_12
  8712                                  	; 12/03/2021
  8713 00002425 66398F[7C6C]            	cmp	[part_table_end_cyl+bx], ecx
  8714 0000242A 7203                    	jb	short fpfs_12
  8715                                  
  8716 0000242C E99E00                  	jmp	fpfs_15
  8717                                  fpfs_12:
  8718                                  	; 22/02/2019
  8719                                  	;mov	di, [freespace_count]
  8720                                  	;;shl	di, 4 ; * 16  ; next entry offset (in free space table)
  8721                                  	; 05/11/2020
  8722                                  	;mov	ax, 22
  8723                                  	;mul	word [freespace_count]
  8724                                  	;mov	di, ax
  8725                                  	; 12/03/2021
  8726 0000242F B016                    	mov	al, 22
  8727 00002431 F626[1A6C]              	mul	byte [freespace_count]
  8728 00002435 89C7                    	mov	di, ax
  8729                                  
  8730 00002437 FE06[1A6C]              	inc	byte [freespace_count]
  8731                                  
  8732                                  	;mov	[free_space.end+di], cx	; end cyl. of free space 5 (gap 5) 
  8733                                  	; 12/03/2021
  8734 0000243B 66898D[2E6D]            	mov	[free_space.end+di], ecx
  8735                                  
  8736                                  	; 05/11/2020
  8737                                  	;mov	ax, [part_table_end_cyl+bx]
  8738                                  	;mov	dx, cx	; cx = end cylinder of the disk
  8739                                  	;sub	dx, ax	; ax = end cylinder of the last partition
  8740                                  	;mov	[free_space.space+di], dx ; di = 4*22 ; 05/11/2020
  8741                                  	;inc	ax
  8742                                  	;mov	[free_space.start+di], ax
  8743                                  	; 12/03/2021
  8744 00002440 668B87[7C6C]            	mov	eax, [part_table_end_cyl+bx]
  8745                                  	; eax = end cylinder of the last partition
  8746                                  	; ecx = end cylinder of the disk
  8747 00002445 6629C1                  	sub	ecx, eax
  8748 00002448 66898D[266D]            	mov	[free_space.space+di], ecx ; di = 4*22
  8749 0000244D 6640                    	inc	eax
  8750 0000244F 668985[2A6D]            	mov	[free_space.start+di], eax
  8751                                  
  8752                                  	;inc	cx ; [cylinders]
  8753                                  	;mov	ax, [free_space.space+si]
  8754                                  	;call	cylinders_to_sectors
  8755                                  	;mov	[free_space.sectors_unused+di], ax
  8756                                  	;mov	[free_space.sectors_unused+2+di], dx
  8757                                  
  8758                                  	; calculate and save (non-aligned) free sector count
  8759                                  
  8760                                  	; 22/02/2019
  8761                                  	;mov	ax, [part_table_rel_sec_lw+bx]
  8762                                  	;mov	dx, [part_table_rel_sec_hw+bx]
  8763                                  	;add	ax, [part_table_num_sec_lw+bx]
  8764                                  	;adc	dx, [part_table_num_sec_hw+bx]
  8765                                  	; 12/03/2021
  8766 00002454 668B87[806C]            	mov	eax, [part_table_rel_sec+bx]
  8767 00002459 660387[846C]            	add	eax, [part_table_num_sec+bx]
  8768                                  
  8769                                  	;mov	[free_space.startsector+di], ax
  8770                                  	;mov	[free_space.startsector+2+di], dx
  8771 0000245E 668985[366D]            	mov	[free_space.startsector+di], eax
  8772                                  
  8773                                  	;mov	cx, [total_sectors]
  8774                                  	;mov	bx, [total_sectors+2]
  8775                                  	;sub	cx, ax
  8776                                  	;sbb	bx, dx
  8777                                  	; 12/03/2021
  8778 00002463 668B0E[2E65]            	mov	ecx, [total_sectors]
  8779 00002468 6629C1                  	sub	ecx, eax
  8780                                  
  8781                                  	;mov	[free_space.sectors_unused+di], cx
  8782                                  	;mov	[free_space.sectors_unused+2+di], bx
  8783 0000246B 66898D[326D]            	mov	[free_space.sectors_unused+di], ecx
  8784                                  
  8785                                  	;mov	cx, [cylinders]
  8786                                  	;mov	bx, [free_space.space+di]
  8787                                  	; 12/03/2021
  8788 00002470 668B85[266D]            	mov	eax, [free_space.space+di]
  8789 00002475 E8F400                  	call	cylinders_to_percent
  8790 00002478 8985[3A6D]              	mov	[free_space.percent_unused+di], ax
  8791 0000247C EB4F                    	jmp	short fpfs_15
  8792                                  
  8793                                  fpfs_13:
  8794                                  	; No partitions found, show entire space as free
  8795                                  
  8796                                  	; 22/02/2019
  8797 0000247E FE06[1A6C]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  8798                                  	
  8799                                  	; 15/02/2019
  8800                                  	;;sub	ax, ax
  8801                                  	;; ah = 0 ; 31/10/2020
  8802                                  	;sub	dx, dx
  8803                                  	; 12/03/2021
  8804 00002482 6629D2                  	sub	edx, edx
  8805                                  
  8806                                  	;;inc	al ; LBA = 1 (after MBR) ; ah = 0
  8807                                  	;mov	al, 1 ; 25/02/2019
  8808                                  	; 12/03/2021
  8809 00002485 6631C0                  	xor	eax, eax
  8810 00002488 FEC0                    	inc	al ; eax = 1
  8811                                  
  8812                                  	;This is a special case - the extended partition can not start
  8813                                  	;on cylinder 0 due to its architecture. Protect against that here
  8814                                  
  8815 0000248A 803E[1C6C]05            	cmp	byte [p_type], 5 ; EXTENDED
  8816 0000248F 7509                    	jne	short fpfs_14
  8817                                  
  8818 00002491 FEC2                    	inc	dl
  8819                                  
  8820                                  	; 15/02/2019
  8821                                  	; LBA value of free space start
  8822 00002493 A0[9E3C]                	mov	al, [sectors]
  8823 00002496 F626[A03C]              	mul	byte [heads]
  8824                                  		; ax = start sector (for Extended Partition)
  8825                                  fpfs_14:
  8826                                  	;mov	[free_space.start], dx ; 0 or 1
  8827                                  	; 12/03/2021
  8828 0000249A 668916[2A6D]            	mov	[free_space.start], edx ; 0 or 1
  8829                                  
  8830                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  8831                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  8832                                  	;	if new partition will be selected as a primary dos partition.
  8833                                  	 	
  8834                                  	;mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  8835                                  	;				     ; or 1 (for PP)
  8836                                  	;;mov	[free_space.startsector+2], 0
  8837                                  	; 12/03/2021
  8838 0000249F 66A3[366D]              	mov	[free_space.startsector], eax
  8839                                  
  8840                                  	;mov	ax, [cylinders] ; disk capacity 
  8841                                  	;mov	cx, ax
  8842                                  	;dec	ax
  8843                                  	;mov	[free_space.end], ax
  8844                                  	;sub	ax, dx
  8845                                  	;inc	ax
  8846                                  	;mov	[free_space.space], ax
  8847                                  	; 12/03/2021
  8848 000024A3 66A1[A23C]              	mov	eax, [cylinders] ; disk capacity 
  8849 000024A7 6648                    	dec	eax
  8850 000024A9 66A3[2E6D]              	mov	[free_space.end], eax
  8851 000024AD 6629D0                  	sub	eax, edx
  8852 000024B0 6640                    	inc	eax
  8853 000024B2 66A3[266D]              	mov	[free_space.space], eax
  8854                                  
  8855                                  	;mov	ax, [total_sectors]
  8856                                  	;mov	dx, [total_sectors+2]
  8857                                  	;sub	ax, [free_space.startsector]
  8858                                  	;sbb	dx, 0
  8859                                  	;mov	[free_space.sectors_unused], ax
  8860                                  	;mov	[free_space.sectors_unused+2], dx
  8861                                  	; 12/03/2021
  8862 000024B6 66A1[2E65]              	mov	eax, [total_sectors]
  8863 000024BA 662B06[366D]            	sub	eax, [free_space.startsector]
  8864 000024BF 66A3[326D]              	mov	[free_space.sectors_unused], eax
  8865                                  
  8866                                  	;;mov	cx, [cylinders]
  8867                                  	;mov	bx, [free_space.space]
  8868                                  	; 12/03/2021
  8869 000024C3 66A1[266D]              	mov	eax, [free_space.space]
  8870 000024C7 E8A200                  	call	cylinders_to_percent
  8871 000024CA A3[3A6D]                	mov	[free_space.percent_unused], ax
  8872                                  
  8873                                  fpfs_15:
  8874                                  	; Find largest free space
  8875                                  	;sub	cx, cx
  8876                                  	; 12/03/2021
  8877 000024CD 6629C9                  	sub	ecx, ecx
  8878 000024D0 6629C0                  	sub	eax, eax
  8879                                  
  8880                                  	; 22/02/2019
  8881                                  	;sub	ax, ax
  8882 000024D3 31DB                    	xor	bx, bx
  8883 000024D5 8A16[1A6C]              	mov	dl, [freespace_count]
  8884 000024D9 08D2                    	or	dl, dl
  8885 000024DB 7423                    	jz	short fpfs_19
  8886 000024DD 8816[186C]              	mov	[_i_], dl
  8887                                  fpfs_16:
  8888                                  	;mov	dx, [free_space.space+bx]
  8889                                  	; 12/03/2021
  8890 000024E1 668B97[266D]            	mov	edx, [free_space.space+bx]
  8891                                  	;cmp	dx, cx
  8892 000024E6 6639CA                  	cmp	edx, ecx
  8893 000024E9 7605                    	jbe	short fpfs_17
  8894                                  	; 22/02/2019
  8895                                  	;mov	cx, dx ; Largest free space
  8896                                  	; 12/03/2021
  8897 000024EB 6689D1                  	mov	ecx, edx ; Largest free space
  8898 000024EE 89D8                    	mov	ax, bx
  8899                                  fpfs_17:
  8900 000024F0 FE0E[186C]              	dec	byte [_i_]
  8901 000024F4 7405                    	jz	short fpfs_18
  8902                                  
  8903                                  	;add	bx, 16 ; Free space structure size
  8904                                  	; 12/03/2021
  8905 000024F6 83C316                  	add	bx, 22
  8906 000024F9 EBE6                    	jmp	short fpfs_16
  8907                                  fpfs_18:
  8908                                  	; 22/02/2019
  8909 000024FB 89C3                    	mov	bx, ax ; offset (from 0 to 64)
  8910                                  	; bx = offset (from 0 to 88) ; 12/03/2021
  8911 000024FD C0E804                  	shr	al, 4  ; index (from 0 to 4)
  8912                                  fpfs_19:
  8913 00002500 6631D2                  	xor	edx, edx ; 12/03/2021
  8914 00002503 C3                      	retn
  8915                                  
  8916                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8917                                  ; find enough free space
  8918                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8919                                  
  8920                                  ;	; 15/02/2019
  8921                                  ;find_enough_free_space:
  8922                                  ;	; Find enough free space
  8923                                  ;	;
  8924                                  ;	; INPUT:
  8925                                  ;	;	AX = Requested space (in cylinders)
  8926                                  ;	;	22/02/2019
  8927                                  ;	;	[freespace_count] = number of free spaces/gaps
  8928                                  ;	; OUTPUT:
  8929                                  ;	;	AX = Available space
  8930                                  	;	DX = Requested space
  8931                                  ;	;	If CF = 0 -> AX >= DX
  8932                                  ;	;	If CF = 1 -> AX < DX
  8933                                  ;	;	CX = Index of available space in free space structure
  8934                                  ;	;	     (GAP number, 0 to 4) - if AX > 0 -
  8935                                  ;
  8936                                  ;	mov	dx, ax ; 22/02/2019
  8937                                  ;	sub	ax, ax
  8938                                  ;	xor	bx, bx
  8939                                  ;	; 22/02/2019
  8940                                  ;	mov	ch, [freespace_count]
  8941                                  ;	mov	[_i_], ax ; 0
  8942                                  ;	jmp	short fefs_1
  8943                                  ;fefs_0:
  8944                                  ;	;mov	al, 16
  8945                                  ;	;mul	byte [_i_]
  8946                                  ;	;mov	bx, ax
  8947                                  ;	mov	bl, [_i_]
  8948                                  ;	shl	bl, 4 ; * 16
  8949                                  ;fefs_1:
  8950                                  ;	mov	ax, [free_space.space+bx]
  8951                                  ;	and	ax, ax
  8952                                  ;	jz	short fefs_2 ; not a free space
  8953                                  ;	mov	cl, [_i_] 
  8954                                  ;	cmp	ax, dx
  8955                                  ;	jnb	short fefs_3 ; enough space
  8956                                  ;fefs_2:
  8957                                  ;	; 22/02/2019
  8958                                  ;	inc	byte [_i_]
  8959                                  ;	cmp	byte [_i_], ch
  8960                                  ;	jb	short fefs_0
  8961                                  ;	sub	ch, ch
  8962                                  ;	stc
  8963                                  ;	retn
  8964                                  ;fefs_3:
  8965                                  ;	xor	ch, ch
  8966                                  ;	retn
  8967                                  
  8968                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8969                                  ; find enough free sectors
  8970                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8971                                  
  8972                                  	; 15/03/2021 (fdisk4.s)
  8973                                  	;	((32 bit registers, 32 bit cylinder numbers))
  8974                                  	; 15/02/2019
  8975                                  find_enough_free_sectors:
  8976                                  	; Find (first) enough free space in sectors
  8977                                  	;
  8978                                  	; INPUT:
  8979                                  	;	DX:AX = Requested space (as non-aligned free sectors)
  8980                                  	;	22/02/2019
  8981                                  	;	[freespace_count] = number of free spaces/gaps
  8982                                  	; OUTPUT:
  8983                                  	;	DX:AX = Available space
  8984                                  	;	If CF = 0 -> DX:AX >= Request
  8985                                  	;	If CF = 1 -> DX:AX < Request
  8986                                  	;	CX = Index of available space in free space structure
  8987                                  	;	     (GAP number, 0 to 4) - if DX:AX > 0 -
  8988                                  
  8989                                  	; 15/03/2021
  8990                                  	; INPUT:
  8991                                  	;	EAX = Requested space (as non-aligned free sectors)
  8992                                  	;	[freespace_count] = number of free spaces/gaps
  8993                                  	; OUTPUT:
  8994                                  	;	EAX = Available space
  8995                                  	;	If CF = 0 -> EAX >= Request
  8996                                  	;	If CF = 1 -> EAX < Request
  8997                                  	;	CX = Index of available space in free space structure
  8998                                  	;	     (GAP number, 0 to 4) - if EAX > 0 -
  8999                                  
  9000                                  	;xor	di, di
  9001                                  	;xor	si, si
  9002                                  	; 15/03/2021
  9003 00002504 6631D2                  	xor	edx, edx
  9004                                  
  9005 00002507 31DB                    	xor	bx, bx
  9006                                  	; 22/02/2019
  9007 00002509 8A2E[1A6C]              	mov	ch, [freespace_count]
  9008 0000250D 891E[186C]              	mov	[_i_], bx ; 0
  9009 00002511 EB07                    	jmp	short fefss_1
  9010                                  fefss_0:
  9011                                  	;mov	al, 16
  9012                                  	;mul	byte [_i_]
  9013                                  	;mov	bx, ax
  9014 00002513 8B1E[186C]              	mov	bx, [_i_]
  9015 00002517 C0E304                  	shl	bl, 4 ; * 16
  9016                                  fefss_1:
  9017 0000251A 81C3[326D]              	add	bx, free_space.sectors_unused
  9018                                  	;cmp	dx, [bx+2]
  9019                                  	;jb	short fefss_7
  9020                                  	;ja	short fefss_2
  9021                                  	;cmp	ax, [bx]
  9022                                  	;je	short fefss_8
  9023                                  	;jb	short fefss_7 ; 18/02/2019
  9024                                  	; 15/03/2021
  9025 0000251E 663B07                  	cmp	eax, [bx]
  9026 00002521 7426                    	je	short fefss_8 ; available space
  9027                                  			      ; = requested space
  9028 00002523 7221                    	jb	short fefss_7 ; > requested space
  9029                                  fefss_2:
  9030                                  	; 30/10/2020
  9031                                  	;;cmp	word [bx], 0
  9032                                  	;;jne	short fefss_3
  9033                                  	;;cmp	word [bx+2], 0
  9034                                  	;;je	short fefss_6
  9035                                  fefss_3:
  9036                                  	;cmp	di, [bx+2]
  9037                                  	;ja	short fefss_6
  9038                                  	;je	short fefss_4
  9039                                  	;mov	di, [bx+2]
  9040                                  	;jmp	short fefss_5
  9041                                  fefss_4:
  9042                                  	;cmp	si, [bx]
  9043                                  	;jnb	short fefss_6
  9044                                  	; 15/03/2021
  9045 00002525 66673B3B                	cmp	edi, [ebx]
  9046 00002529 7307                    	jnb	short fefss_6
  9047                                  fefss_5:
  9048                                  	;mov	si, [bx]
  9049                                  	; 15/03/2021
  9050 0000252B 668B17                  	mov	edx, [bx]
  9051                                  	; 22/02/2019
  9052 0000252E 8A0E[186C]              	mov	cl, [_i_]
  9053                                  fefss_6:
  9054 00002532 FE06[186C]              	inc	byte [_i_]
  9055 00002536 382E[186C]              	cmp	byte [_i_], ch ; [freespace_count]
  9056 0000253A 72D7                    	jb	short fefss_0
  9057                                  	
  9058                                  	;mov	ax, si
  9059                                  	;mov	dx, di
  9060                                  	; 15/03/2021
  9061 0000253C 6689D0                  	mov	eax, edx ; (max.) available space
  9062                                  			 ; (< requested space)
  9063 0000253F 6629D2                  	sub	edx, edx
  9064                                  	;
  9065 00002542 30ED                    	xor	ch, ch
  9066 00002544 F9                      	stc
  9067 00002545 C3                      	retn
  9068                                  fefss_7:
  9069                                  	;mov	ax, [bx]
  9070                                  	;mov	dx, [bx+2]
  9071                                  	; 15/03/2021
  9072 00002546 668B07                  	mov	eax, [bx] ; available space
  9073                                  			  ; (> requested space)
  9074                                  fefss_8:
  9075 00002549 8B0E[186C]              	mov	cx, [_i_]
  9076                                  	; 15/03/2021
  9077 0000254D 6631D2                  	xor	edx, edx
  9078                                  	;
  9079 00002550 C3                      	retn
  9080                                  
  9081                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9082                                  ; get first free partition table entry
  9083                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9084                                  
  9085                                  	; 16/02/2019
  9086                                  get_first_free_pte:
  9087                                  	; Find free partition table entry
  9088                                  	;
  9089                                  	; INPUT:
  9090                                  	;	none
  9091                                  	; OUTPUT:
  9092                                  	;	If CF = 0 -> CX = partition table entry number
  9093                                  	;	If CF = 1 -> there is not a free entry in partition table
  9094                                  
  9095 00002551 BE[9254]                	mov	si, MasterBootBuff+pTableOffset
  9096 00002554 31C9                    	xor	cx, cx
  9097                                  gffp_1:
  9098 00002556 8A4404                  	mov	al, [si+ptFileSystemID] ; 23/02/2019
  9099                                  
  9100 00002559 20C0                    	and	al, al
  9101 0000255B 740E                    	jz	short gffp_3 ; empty
  9102                                  
  9103 0000255D 80F903                  	cmp	cl, 3
  9104 00002560 7307                    	jnb	short gffp_2
  9105                                  
  9106 00002562 FEC1                    	inc	cl
  9107 00002564 83C610                  	add	si, 16 ; Partition table entry size
  9108 00002567 EBED                    	jmp	short gffp_1
  9109                                  gffp_2:
  9110                                  	; CL = 3
  9111 00002569 F9                      	stc
  9112 0000256A C3                      	retn
  9113                                  gffp_3:
  9114                                  	; CL = PTE number (0 to 3)
  9115 0000256B C3                      	retn 	
  9116                                  
  9117                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9118                                  ; convert cylinder count to sectors
  9119                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9120                                  ; 03/02/2019
  9121                                  
  9122                                  	; 15/03/2021 (fdisk4.s)
  9123                                  ;cylinders_to_sectors:
  9124                                  	; INPUT:
  9125                                  	;	ax = Cylinders (Total or partition's cylinder count)
  9126                                  	; OUTPUT:
  9127                                  	;	dx:ax = Sectors
  9128                                  
  9129                                  	; 15/03/2021
  9130                                  	; INPUT:
  9131                                  	;	eax = cylinders (Total or partition's cyl count)
  9132                                  	; OUTPUT:
  9133                                  	;	eax = sectors
  9134                                  
  9135                                  	;;mov	dx, [heads]
  9136                                  	;;mul	dx
  9137                                  	;; 30/10/2020
  9138                                  	;mul	word [heads]
  9139                                  	;; dx:ax = Number of tracks (cylinders*heads)
  9140                                  	;mov	cx, [sectors]
  9141                                  	;call	mul32
  9142                                  	;	; dx:ax = Number of sectors
  9143                                  	;retn
  9144                                  
  9145                                  	; 15/03/2021
  9146                                  	;mul	dword [hs] ; [heads] * [sectors]
  9147                                  	;; eax = number of sectors
  9148                                  	;retn
  9149                                  	
  9150                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9151                                  ; convert cylinder count to percent of disk size (total cylinders)
  9152                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9153                                  ; 03/02/2019
  9154                                  
  9155                                  	; 12/03/2021
  9156                                  	; 11/03/2021 (fdisk4.s) - 32 bit cylinder count-
  9157                                  	;
  9158                                  cylinders_to_percent:
  9159                                  
  9160                                  	; INPUT:
  9161                                  	;	bx = Number of cylinders (of partition) -dividend-
  9162                                  	;	cx = Total cylinders -divisor-
  9163                                  	; OUTPUT:
  9164                                  	;	ax = Percentage
  9165                                  
  9166                                  	;  if (cylinders_in == 0)
  9167                                  	;	 percentage_out = 0;
  9168                                  	;  else if (total_cylinders == 0)
  9169                                  	;           percentage_out = 0;
  9170                                  	;       else
  9171                                  
  9172                                  	; 11/03/2021
  9173                                  	; INPUT: dword [cylinders] ; number of total disk cylinders
  9174                                  	;	 eax = partition's cylinder count
  9175                                  	; OUTPUT: ax = pencentage
  9176                                  
  9177                                  	;or	bx, bx
  9178                                  	;jz	short ctpc_6 ; ax = 0 = percentage_out
  9179                                  	; 11/03/2021 
  9180 0000256C 6609C0                  	or	eax, eax
  9181 0000256F 742B                    	jz	short ctpc_6 ; ax = 0 = percentage_out 	
  9182                                  ctpc_1:
  9183                                  	;or	cx, cx
  9184                                  	;jz	short ctpc_6
  9185                                  
  9186 00002571 668B0E[A23C]            	mov	ecx, [cylinders]
  9187 00002576 6609C9                  	or	ecx, ecx
  9188 00002579 7421                    	jz	short ctpc_6
  9189                                  
  9190                                  	;mov	ax, 100
  9191                                  	;mul	bx ; [cylinders_in]
  9192                                  	;	; dx:ax = Dividend
  9193                                  	;	
  9194                                  	;mul	edx
  9195                                  	
  9196                                  	;call	div32 ; 100*cylinders_in / total_cylinders
  9197                                  	;	; DX:AX = Quotient
  9198                                  	;	; BX = Remainder
  9199                                  
  9200 0000257B 66BA64000000            	mov	edx, 100
  9201 00002581 66F7E2                  	mul	edx
  9202 00002584 66F7F1                  	div	ecx
  9203                                  
  9204                                  	; ax = percentage_out
  9205                                  
  9206                                  	; 12/03/2021
  9207 00002587 66D1E9                  	shr	ecx, 1
  9208                                  
  9209                                  	;cmp	bx, cx	; is remainder >= total_cylinders/2 ?
  9210                                  	;jb	short ctpc_5 ; No.
  9211                                  
  9212 0000258A 6639CA                  	cmp	edx, ecx ; is remainder >= total_cylinders/2 ?
  9213 0000258D 7201                    	jb	short ctpc_5 ; No.
  9214                                  ctpc_4:
  9215 0000258F 40                      	inc	ax
  9216                                  ctpc_5:
  9217                                  	; 12/03/2021
  9218 00002590 66BA64000000            	mov	edx, 100
  9219                                  	;cmp	ax, 100
  9220 00002596 39D0                    	cmp	ax, dx ; 100
  9221 00002598 7602                    	jbe	short ctpc_6
  9222                                  	;mov	ax, 100
  9223 0000259A 89D0                    	mov	ax, dx
  9224                                  ctpc_6:
  9225 0000259C C3                      	retn
  9226                                  
  9227                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9228                                  ; display partition table
  9229                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9230                                  ; 04/02/2019
  9231                                  
  9232                                  	; 12/03/2021
  9233                                  display_partition_table_x:
  9234 0000259D 66B805000000            	mov	eax, 5 ; display extended partition table
  9235 000025A3 EB03                    	jmp	short dpt_x
  9236                                  
  9237                                  	; 11/03/2021 (fdisk4.s)
  9238                                  display_partition_table:
  9239                                  
  9240                                  	; INPUT:
  9241                                  	;	al = 0 for MBR
  9242                                  	;	   = 5 for EBR (logical drives in extended partition)
  9243                                  	; OUTPUT:
  9244                                  	;	none
  9245                                  
  9246                                  ;pt_positions:
  9247                                  n_pos	equ 30 ; 1 byte	
  9248                                  
  9249                                  	; 12/03/2021
  9250 000025A5 6631C0                  	xor	eax, eax ; display primary partition table
  9251                                  dpt_x:
  9252 000025A8 A2[1D6C]                	mov	[_e_], al
  9253                                  
  9254                                  	; clear screen
  9255 000025AB B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  9256 000025AE CD10                    	int	10h
  9257                                  
  9258 000025B0 803E[1D6C]05            	cmp	byte [_e_], 5
  9259 000025B5 7507                    	jne	short dpt_1
  9260                                  dpt_0:
  9261 000025B7 BD[CE6C]                	mov	bp, ext_table_boot_ind
  9262 000025BA B045                    	mov	al, 'E'
  9263 000025BC EB05                    	jmp	short dpt_4
  9264                                  dpt_1:
  9265 000025BE BD[726C]                	mov	bp, part_table_boot_ind
  9266 000025C1 B04D                    	mov	al, 'M'
  9267                                  dpt_4:
  9268 000025C3 BE[2E55]                	mov	si, p_table_header
  9269 000025C6 88441E                  	mov	[si+n_pos], al
  9270 000025C9 E8E0F3                         	call 	print_msg
  9271                                     
  9272 000025CC 31DB                    	xor	bx, bx
  9273 000025CE 891E[186C]              	mov	[_i_], bx
  9274                                  dpt_5:
  9275 000025D2 FE06[186C]              	inc	byte [_i_]
  9276                                  
  9277                                  	; BX = partition entry (0 to 3)
  9278                                  	; BP = partition table structure address
  9279                                  
  9280 000025D6 E86400                  	call	display_pt_entry  ; display partition table row
  9281                                  
  9282 000025D9 8B1E[186C]              	mov	bx, [_i_]
  9283                                  	
  9284 000025DD 80FB04                  	cmp	bl, 4
  9285 000025E0 72F0                    	jb	short dpt_5
  9286                                  
  9287 000025E2 BE[6F56]                	mov	si, p_table_footer
  9288 000025E5 E8C4F3                         	call 	print_msg
  9289                                  
  9290                                  	; 27/02/2019
  9291 000025E8 BF[8452]                	mov	di, str_disk_sectors
  9292                                  
  9293 000025EB 803E[1D6C]05            	cmp	byte [_e_], 5
  9294 000025F0 741A                    	je	short dpt_9
  9295                                  
  9296                                  	; display total disk sectors
  9297                                  
  9298                                  	;mov	di, str_disk_sectors
  9299                                  
  9300                                  	;cmp	byte [di], '0'
  9301                                  	;jnb	short dpt_8
  9302                                  
  9303                                          ;mov	ax, [total_sectors]
  9304                                          ;mov	dx, [total_sectors+2]
  9305                                  	; 11/03/2021	
  9306 000025F2 66A1[2E65]              	mov	eax, [total_sectors]
  9307                                  	
  9308 000025F6 E81F00                  	call	dpt_10
  9309                                  dpt_8:
  9310 000025F9 BE[6E52]                	mov	si, msg_disk_sectors
  9311                                  dpt_11:
  9312 000025FC E8ADF3                  	call	print_msg
  9313                                  
  9314 000025FF BE[8452]                	mov	si, str_disk_sectors
  9315 00002602 E8A7F3                  	call	print_msg
  9316                                  
  9317 00002605 BE[5852]                	mov	si, CRLF
  9318 00002608 E8A1F3                  	call	print_msg
  9319                                  
  9320 0000260B C3                      	retn
  9321                                  
  9322                                  dpt_9:
  9323                                  	; display extended partition size
  9324                                  
  9325                                  	;mov	ax, [ep_Size]
  9326                                  	;mov	dx, [ep_Size+2]
  9327                                  	; 11/03/2021
  9328 0000260C 66A1[106C]              	mov	eax, [ep_Size]
  9329                                  
  9330 00002610 E80500                  	call	dpt_10
  9331                                  
  9332 00002613 BE[8F52]                	mov	si, msg_ep_size
  9333 00002616 EBE4                    	jmp	short dpt_11
  9334                                  
  9335                                  dpt_10:
  9336 00002618 89E6                    	mov	si, sp
  9337                                  	;mov	cx, 10
  9338                                  	; 11/03/2021
  9339 0000261A 66B90A000000            	mov	ecx, 10
  9340                                  dpt_6:
  9341                                  	;call	div32
  9342                                  	
  9343                                  	;add	bl, '0'
  9344                                  	;push	bx
  9345                                  	;and	ax, ax
  9346                                  	;jnz	short dpt_6
  9347                                  	;and	dx, dx
  9348                                  	;jnz	short dpt_6
  9349                                  
  9350 00002620 6631D2                  	xor	edx, edx
  9351 00002623 66F7F1                  	div	ecx
  9352                                  	; 21/03/2021
  9353 00002626 80C230                  	add	dl, '0' 
  9354 00002629 52                      	push	dx
  9355 0000262A 6621C0                  	and	eax, eax
  9356 0000262D 75F1                    	jnz	short dpt_6
  9357                                  
  9358 0000262F 29E6                    	sub	si, sp
  9359 00002631 D1EE                    	shr	si, 1
  9360                                  dpt_7:
  9361 00002633 58                      	pop	ax
  9362 00002634 AA                      	stosb
  9363 00002635 4E                      	dec	si
  9364 00002636 75FB                    	jnz	short dpt_7
  9365                                  
  9366                                  	;xor	al, al
  9367 00002638 6631C0                  	xor	eax, eax ; 11/03/2021
  9368 0000263B AA                      	stosb
  9369                                  
  9370                                  	; 27/02/2019
  9371 0000263C C3                      	retn
  9372                                  
  9373                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9374                                  ; display partition table entry/row
  9375                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9376                                  ; 04/02/2019
  9377                                  
  9378                                  ; 05/11/2020
  9379                                  
  9380                                  struc ptbl
  9381                                  
  9382 00000000 ??                      .boot_ind:	resb 1
  9383 00000001 ??                      .start_head:	resb 1
  9384 00000002 ??                      .start_sector:	resb 1
  9385                                  ;.start_cyl:	resw 1
  9386 00000003 ????????                .start_cyl:	resd 1
  9387 00000007 ??                      .sys_id:	resb 1
  9388 00000008 ??                      .end_head:	resb 1
  9389 00000009 ??                      .end_sector:	resb 1
  9390                                  ;.end_cyl:	resw 1
  9391 0000000A ????????                .end_cyl:	resd 1
  9392                                  ;.rel_sec_lw:	resw 1
  9393                                  ;.rel_sec_hw:	resw 1
  9394 0000000E ????????                .rel_sec:	resd 1
  9395                                  ;.num_sec_lw:	resw 1
  9396                                  ;.num_sec_hw:	resw 1
  9397 00000012 ????????                .num_sec:	resd 1
  9398                                  .size: ; 22 ; 05/11/2020
  9399                                  
  9400                                  endstruc
  9401                                  
  9402                                  	; 20/03/2021 (fdisk4.s)
  9403                                  display_pt_entry:
  9404                                  	; 24/10/2020 (fdisk3.s)
  9405                                  
  9406                                  	; INPUT:
  9407                                  	;	bl = partition entry
  9408                                  	;	bh = 0
  9409                                  	;	bp = partition table structure address
  9410                                  	; OUTPUT:
  9411                                  	;	none
  9412                                  
  9413                                  ; 24/10/2020 (fdisk3.s)
  9414                                  ;pt_positions:
  9415                                  p_pos	equ 3  ; 1 byte
  9416                                  s_pos	equ 6  ; 2+1 byte
  9417                                  bh_pos	equ 10 ; 2+1 bytes
  9418                                  bs_pos	equ 14 ; 2+1 bytes
  9419                                  bc_pos	equ 18 ; 2+1 bytes
  9420                                  fs_pos  equ 22 ; 2+1 bytes
  9421                                  eh_pos  equ 26 ; 2+1 bytes
  9422                                  es_pos	equ 30 ; 2+1 bytes
  9423                                  ec_pos	equ 34 ; 2+1 bytes
  9424                                  rs_pos	equ 42 ; 10 bytes
  9425                                  ns_pos	equ 53 ; 10 bytes
  9426                                  fsx_pos equ 64 ; 14 bytes
  9427                                  
  9428                                  ; 2019-2020 (hdimage.s)
  9429                                  ;;pt_positions:
  9430                                  ;p_pos	equ 7  ; 1 byte
  9431                                  ;s_pos	equ 9  ; 2+1 byte
  9432                                  ;bh_pos	equ 13 ; 2+1 bytes
  9433                                  ;bs_pos	equ 17 ; 2+1 bytes
  9434                                  ;bc_pos	equ 21 ; 2+1 bytes
  9435                                  ;fs_pos equ 25 ; 2+1 bytes
  9436                                  ;eh_pos equ 29 ; 2+1 bytes
  9437                                  ;es_pos	equ 33 ; 2+1 bytes
  9438                                  ;ec_pos	equ 37 ; 2+1 bytes
  9439                                  ;rs_pos	equ 42 ; 7 bytes
  9440                                  ;ns_pos	equ 52 ; 7 bytes
  9441                                  ;fsx_pos equ 61 ; 14 bytes
  9442                                  
  9443 0000263D 55                      	push	 bp ; 23/02/2019
  9444                                  
  9445 0000263E 08DB                    	or	bl, bl
  9446 00002640 7406                    	jz	short dpte_0
  9447                                  
  9448                                  	;xor	bh, bh
  9449 00002642 B016                    	mov	al, ptbl.size ; 22 ; 05/11/2020
  9450 00002644 F6E3                    	mul	bl
  9451 00002646 01C5                    	add	bp, ax
  9452                                  dpte_0:
  9453 00002648 807E0700                	cmp	byte [bp+ptbl.sys_id], 0
  9454 0000264C 0F861501                	jna	dpte_9
  9455                                  
  9456 00002650 B768                    	mov	bh, 'h'
  9457                                  
  9458 00002652 BE[206C]                	mov	si, pte_row
  9459                                  
  9460                                  	; clear partition table display buffer/row
  9461 00002655 89F7                    	mov	di, si
  9462 00002657 B92800                  	mov	cx, 40
  9463 0000265A B82020                  	mov	ax, 2020h
  9464 0000265D F3AB                    	rep	stosw
  9465                                  
  9466 0000265F 88D8                    	mov	al, bl
  9467 00002661 0431                    	add	al, '1'
  9468 00002663 884403                  	mov	[si+p_pos], al  ; partition number '1' to '4'
  9469                                  
  9470                                  	; partition status, type and CHS parameters
  9471                                  	; (as hexadecimal number)
  9472                                  
  9473                                  	;mov	al, [bp+ptbl.boot_ind]
  9474 00002666 8A4600                  	mov	al, [bp]
  9475 00002669 E814F4                  	call	byte_to_hex
  9476                                  
  9477 0000266C 894406                  	mov	[si+s_pos], ax
  9478 0000266F 887C08                  	mov	[si+s_pos+2], bh ; 'h'
  9479                                  
  9480 00002672 8A4601                  	mov	al, [bp+ptbl.start_head]
  9481 00002675 E808F4                  	call	byte_to_hex
  9482                                  
  9483 00002678 89440A                  	mov	[si+bh_pos], ax
  9484 0000267B 887C0C                  	mov	[si+bh_pos+2], bh ; 'h'
  9485                                  
  9486 0000267E 8B4E03                  	mov	cx, [bp+ptbl.start_cyl]
  9487                                  	; 28/10/2020
  9488 00002681 81F9FF03                	cmp	cx, 1023
  9489 00002685 7603                    	jna	short dpte_10 ; cyl number is in CHS limit
  9490 00002687 B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  9491                                  			 ; to correct display PTE (CHS bytes)
  9492                                  dpte_10:
  9493 0000268A C0E506                  	shl	ch, 6
  9494 0000268D 8A4602                  	mov	al, [bp+ptbl.start_sector]
  9495 00002690 08E8                    	or	al, ch
  9496 00002692 E8EBF3                  	call	byte_to_hex
  9497                                  
  9498 00002695 89440E                  	mov	[si+bs_pos], ax
  9499 00002698 887C10                  	mov	[si+bs_pos+2], bh ; 'h'
  9500                                  
  9501                                  	;mov	al, [bp+ptbl.start_cyl]
  9502 0000269B 88C8                    	mov	al, cl
  9503 0000269D E8E0F3                  	call	byte_to_hex
  9504                                  
  9505 000026A0 894412                  	mov	[si+bc_pos], ax
  9506 000026A3 887C14                  	mov	[si+bc_pos+2], bh ; 'h'
  9507                                  
  9508 000026A6 8A4607                  	mov	al, [bp+ptbl.sys_id]
  9509 000026A9 E8D4F3                  	call	byte_to_hex
  9510                                  
  9511 000026AC 894416                  	mov	[si+fs_pos], ax
  9512 000026AF 887C18                  	mov	[si+fs_pos+2], bh ; 'h'
  9513                                  
  9514 000026B2 8A4608                  	mov	al, [bp+ptbl.end_head]
  9515 000026B5 E8C8F3                  	call	byte_to_hex
  9516                                  
  9517 000026B8 89441A                  	mov	[si+eh_pos], ax
  9518 000026BB 887C1C                  	mov	[si+eh_pos+2], bh ; 'h'
  9519                                  
  9520 000026BE 8B4E0A                  	mov	cx, [bp+ptbl.end_cyl]
  9521                                  	; 28/10/2020
  9522 000026C1 81F9FF03                	cmp	cx, 1023
  9523 000026C5 7603                    	jna	short dpte_11 ; cyl number is in CHS limit
  9524 000026C7 B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  9525                                  			 ; to correct display PTE (CHS bytes)
  9526                                  dpte_11:
  9527 000026CA C0E506                  	shl	ch, 6
  9528 000026CD 8A4609                  	mov	al, [bp+ptbl.end_sector]
  9529 000026D0 08E8                    	or	al, ch
  9530 000026D2 E8ABF3                  	call	byte_to_hex
  9531                                  
  9532 000026D5 89441E                  	mov	[si+es_pos], ax
  9533 000026D8 887C20                  	mov	[si+es_pos+2], bh ; 'h'
  9534                                  
  9535                                  	;mov	al, [bp+ptbl.end_cyl]
  9536 000026DB 88C8                    	mov	al, cl
  9537 000026DD E8A0F3                  	call	byte_to_hex
  9538                                  
  9539 000026E0 894422                  	mov	[si+ec_pos], ax
  9540 000026E3 887C24                  	mov	[si+ec_pos+2], bh ; 'h'
  9541                                  
  9542                                  	; relative (start) sector address (lba)
  9543                                  	; (as decimal number)
  9544                                  
  9545                                  	;mov	ax, [bp+ptbl.rel_sec_lw]
  9546                                  	;mov	dx, [bp+ptbl.rel_sec_hw]
  9547                                  	; 20/03/2021
  9548 000026E6 668B460E                	mov	eax, [bp+ptbl.rel_sec] 
  9549                                  
  9550 000026EA 89E7                    	mov	di, sp
  9551                                  	; 20/03/2021
  9552                                  	;mov	cx, 10
  9553 000026EC 6631C9                  	xor	ecx, ecx
  9554 000026EF B10A                    	mov	cl, 10
  9555                                  dpte_1:
  9556                                  	;call	div32
  9557                                  	; 20/03/2021
  9558 000026F1 6631D2                  	xor	edx, edx
  9559 000026F4 66F7F1                  	div	ecx
  9560                                  
  9561                                  	;add	bl, '0'
  9562                                  	;push	bx
  9563                                  	; 20/03/2021
  9564 000026F7 80C230                  	add	dl, '0'
  9565 000026FA 52                      	push	dx ; ++*
  9566                                  
  9567                                  	;and	ax, ax
  9568                                  	;jnz	short dpte_1
  9569                                  	;and	dx, dx
  9570                                  	;jnz	short dpte_1
  9571                                  	; 20/03/2021
  9572 000026FB 6621C0                  	and	eax, eax
  9573 000026FE 75F1                    	jnz	short dpte_1
  9574                                  
  9575 00002700 8D5C31                  	lea	bx, [si+rs_pos+7]
  9576                                  
  9577 00002703 29E7                    	sub	di, sp
  9578 00002705 D1EF                    	shr	di, 1
  9579 00002707 29FB                    	sub	bx, di	
  9580                                  dpte_2:
  9581 00002709 58                      	pop	ax ; ++*
  9582 0000270A 8807                    	mov	[bx], al
  9583 0000270C 4F                      	dec	di
  9584 0000270D 7403                    	jz	short dpte_3
  9585                                  	
  9586 0000270F 43                      	inc	bx
  9587 00002710 EBF7                    	jmp	short dpte_2
  9588                                  
  9589                                  dpte_3:
  9590                                  	; number of sectors)
  9591                                  	; (as decimal number)
  9592                                  
  9593                                  	;mov	ax, [bp+ptbl.num_sec_lw]
  9594                                  	;mov	dx, [bp+ptbl.num_sec_hw]
  9595                                  	; 20/03/2021
  9596 00002712 668B4612                	mov	eax, [bp+ptbl.num_sec] 
  9597                                  
  9598 00002716 89E7                    	mov	di, sp
  9599                                  	;mov	cx, 10
  9600                                  dpte_4:
  9601                                  	;call	div32
  9602                                  	; 20/03/2021
  9603 00002718 31D2                    	xor	dx, dx
  9604 0000271A 66F7F1                  	div	ecx
  9605                                  	
  9606                                  	;add	bl, '0'
  9607                                  	;push	bx
  9608                                  	; 20/03/2021
  9609 0000271D 80C230                  	add	dl, '0'
  9610 00002720 52                      	push	dx ; ++**
  9611                                  
  9612                                  	;and	ax, ax
  9613                                  	;jnz	short dpte_4
  9614                                  	;and	dx, dx
  9615                                  	;jnz	short dpte_4
  9616                                  	; 20/03/2021
  9617 00002721 6621C0                  	and	eax, eax
  9618 00002724 75F2                    	jnz	short dpte_4
  9619                                  
  9620 00002726 8D5C3C                  	lea	bx, [si+ns_pos+7]
  9621                                  
  9622 00002729 29E7                    	sub	di, sp
  9623 0000272B D1EF                    	shr	di, 1
  9624 0000272D 29FB                    	sub	bx, di	
  9625                                  dpte_5:
  9626 0000272F 58                      	pop	ax ; ++**
  9627 00002730 8807                    	mov	[bx], al
  9628 00002732 4F                      	dec	di
  9629 00002733 7403                    	jz	short dpte_6
  9630                                  	
  9631 00002735 43                      	inc	bx
  9632 00002736 EBF7                    	jmp	short dpte_5
  9633                                  dpte_6:
  9634                                  	; set file system name
  9635                                  
  9636 00002738 8A4607                  	mov	al, [bp+ptbl.sys_id]
  9637 0000273B BF[BE3D]                	mov	di, valid_partitions
  9638 0000273E B91300                  	mov	cx, 19
  9639 00002741 F2AE                    	repnz	scasb
  9640 00002743 7405                    	jz	short dpte_7
  9641 00002745 B8[B03D]                	mov	ax, FS_OTHERS
  9642 00002748 EB0C                    	jmp	short dpte_8
  9643                                  dpte_7:
  9644 0000274A 81EF[BF3D]              	sub	di, valid_partitions + 1
  9645 0000274E B80E00                  	mov	ax, 14
  9646 00002751 F7E7                    	mul	di
  9647 00002753 05[A63C]                	add	ax, FileSys_Names
  9648                                  dpte_8:
  9649 00002756 8D7C40                  	lea	di, [si+fsx_pos]
  9650 00002759 89C6                    	mov	si, ax
  9651 0000275B B107                    	mov	cl, 7
  9652 0000275D F3A5                    	rep	movsw
  9653                                  
  9654 0000275F BE[206C]                	mov	si, pte_row
  9655 00002762 E847F2                  	call	print_msg
  9656                                  dpte_9:
  9657 00002765 5D                      	pop	bp ; 23/02/2019
  9658                                  	
  9659 00002766 C3                      	retn
  9660                                  
  9661                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9662                                  ; fix partition table
  9663                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9664                                  ; 24/02/2019
  9665                                  
  9666                                  partition_table_fix:
  9667                                  	; DELETE or EXIT option for Invalid Partition Table Entry
  9668                                  	; INPUT: 
  9669                                  	;	DS:SI = PTE address in MBR buffer
  9670                                  	
  9671 00002767 56                      	push	si  ; save PTE address
  9672                                  
  9673 00002768 89F0                    	mov	ax, si
  9674 0000276A 2D[9254]                	sub	ax, MasterBootBuff+446
  9675 0000276D C0E804                  	shr	al, 4 ; / 16 
  9676 00002770 0431                    	add	al, '1'
  9677 00002772 A2[905B]                	mov	[inv_pte_num], al
  9678                                  
  9679                                  	; DS:SI = PTE address in MBR buffer
  9680 00002775 E878F7                  	call	show_selected_partition
  9681                                  
  9682                                  	;mov	si, CRLF
  9683                                  	;call	print_msg
  9684                                  
  9685                                  	; Warning message...
  9686                                  
  9687 00002778 BE[6C5B]                	mov	si, msg_inv_pte
  9688 0000277B E82EF2                  	call	print_msg
  9689                                  
  9690 0000277E 5F                      	pop	di  ; restore PTE address
  9691                                  ptf_0:	
  9692 0000277F 30E4                    	xor	ah, ah
  9693 00002781 CD16                    	int	16h
  9694                                  
  9695 00002783 3C0D                    	cmp	al, 13
  9696 00002785 7406                    	je	short ptf_1
  9697                                  
  9698 00002787 3C1B                    	cmp	al, 27
  9699 00002789 75F4                    	jne	short ptf_0
  9700                                  
  9701 0000278B F9                      	stc
  9702 0000278C C3                      	retn
  9703                                  ptf_1:
  9704                                  	; Clear that (invalid) PTE
  9705 0000278D 31C0                    	xor	ax, ax	
  9706 0000278F B90800                  	mov	cx, 8
  9707 00002792 F3AB                    	rep	stosw
  9708                                  
  9709                                  	; Clear screen
  9710 00002794 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  9711 00002797 CD10                    	int	10h
  9712                                  
  9713 00002799 C3                      	retn
  9714                                  
  9715                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9716                                  ; display (& edit) EXTENDED (DOS) partition table
  9717                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9718                                  ; 28/02/2019
  9719                                  
  9720                                  display_extended_pt:
  9721                                  	; 12/03/2021
  9722                                  	;mov	al, 5 ; extended partition (logical drives)
  9723                                  	;call	display_partition_table
  9724 0000279A E800FE                  	call	display_partition_table_x
  9725                                  
  9726 0000279D BE[645D]                	mov	si, ebr_editing_options
  9727 000027A0 E809F2                  	call	print_msg
  9728                                  
  9729 000027A3 BE[195A]                	mov	si, enter_opt_num_cancel_msg
  9730 000027A6 E803F2                  	call	print_msg
  9731                                  
  9732 000027A9 BE[5852]                	mov	si, CRLF
  9733 000027AC E8FDF1                  	call	print_msg
  9734                                  dept_1:
  9735 000027AF 30E4                    	xor	ah, ah
  9736 000027B1 CD16                    	int	16h
  9737                                  
  9738 000027B3 3C30                    	cmp	al, '0'
  9739 000027B5 740C                    	je	short dept_2
  9740                                  
  9741 000027B7 3C31                    	cmp	al, '1'
  9742 000027B9 7464                    	je	short edit_ext_table_create
  9743 000027BB 3C32                    	cmp	al, '2'
  9744 000027BD 7407                    	je	short edit_ext_table_delete
  9745                                  		
  9746 000027BF 3C1B                    	cmp	al, 27 ; ESCape
  9747 000027C1 75EC                    	jne	short dept_1
  9748                                  dept_2:
  9749 000027C3 E90DDC                  	jmp	A_42
  9750                                  
  9751                                  edit_ext_table_delete:
  9752                                  	; 28/02/2019
  9753                                  	;mov	al, 5 ; extended partition (logical drives)
  9754                                  	;call	display_partition_table
  9755                                  	; 12/03/2021
  9756 000027C6 E8D4FD                  	call	display_partition_table_x
  9757                                  
  9758 000027C9 BE[E35D]                	mov	si, msg_delete_ldd_q
  9759 000027CC E8DDF1                  	call	print_msg
  9760                                  
  9761                                  	;mov	si, CRLF
  9762                                  	;call	print_msg
  9763                                  eetd_1:
  9764 000027CF 30E4                    	xor	ah, ah
  9765 000027D1 CD16                    	int	16h
  9766                                  
  9767 000027D3 3C1B                    	cmp	al, 27
  9768 000027D5 7410                    	je	short eetd_2
  9769                                  
  9770 000027D7 24DF                    	and	al, 0DFh
  9771 000027D9 3C59                    	cmp	al, 'Y'
  9772 000027DB 7412                    	je	short eetd_yes
  9773 000027DD 3C4E                    	cmp	al, 'N'
  9774 000027DF 75EE                    	jne	short eetd_1
  9775                                  eetd_no:
  9776 000027E1 BE[9959]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  9777 000027E4 E8C5F1                  	call	print_msg
  9778                                  eetd_2:	
  9779 000027E7 BE[5852]                	mov	si, CRLF  ; Next line
  9780 000027EA E8BFF1                  	call	print_msg
  9781 000027ED EBAB                    	jmp	short display_extended_pt
  9782                                  eetd_yes:
  9783 000027EF BE[9359]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  9784 000027F2 E8B7F1                  	call	print_msg
  9785 000027F5 BE[5852]                	mov	si, CRLF  ; Next line
  9786 000027F8 E8B1F1                  	call	print_msg
  9787 000027FB E8F905                  	call	delete_logical_drives
  9788 000027FE 803E[006A]00            	cmp	byte [ldrives], 0
  9789 00002803 7795                    	ja	short display_extended_pt
  9790 00002805 E9CBDB                  	jmp	A_42
  9791                                  
  9792                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9793                                  ; logical drive count limit error 
  9794                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9795                                  
  9796                                  eetc_2:
  9797 00002808 BE[495E]                	mov	si, msg_create_ldd_max_error
  9798                                  eetc_10:
  9799 0000280B E89EF1                  	call	print_msg
  9800 0000280E BE[B452]                	mov	si, msg_press_any_key
  9801 00002811 E898F1                  	call	print_msg
  9802 00002814 30E4                    	xor	ah, ah
  9803 00002816 CD16                    	int	16h
  9804 00002818 EB80                    	jmp	display_extended_pt
  9805                                  
  9806                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9807                                  ; no free space in extended partition
  9808                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9809                                  	
  9810                                  	; 05/03/2019
  9811                                  eetc_9:
  9812 0000281A BE[8260]                	mov	si, msg_c_ldd_nofspc_error
  9813 0000281D EBEC                    	jmp	short eetc_10
  9814                                  
  9815                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9816                                  ; create logical dos drive in EXTENDED (DOS) partition
  9817                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9818                                  ; 19/10/2020 (fdisk3.s) 
  9819                                  
  9820                                  	; 13/03/2021
  9821                                  	; 12/03/2021 (fdisk4.s)
  9822                                  edit_ext_table_create:	; 01/03/2019 (hdimage.s)
  9823                                  
  9824                                  ; Create Method: ; 04/03/2019
  9825                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  9826                                  ;LDD 2 <- LDD_START1, ebr 2nd entry <- EBR 1
  9827                                  ;LDD 3 <- LDD_START2, ebr 2nd entry <- EBR 2
  9828                                  ;LDD 4 <- LDD_START3, ebr 2nd entry <- EBR 3
  9829                                  
  9830                                  	; 01/03/2019
  9831 0000281F 803E[CD6C]00            	cmp	byte [epnumber], 0 ; check extended partition
  9832 00002824 0F86A8E4                	jna	B_07		; cancel with error message
  9833                                  
  9834                                  	; 05/03/2019
  9835 00002828 E89602                  	call	check_ext_free_space
  9836 0000282B 72ED                    	jc	eetc_9	; error, no free space in extented partition
  9837                                  
  9838                                  	; 30/10/2020
  9839                                  	;mov	[ep_free_sectors], ax
  9840                                  	;mov	[ep_free_sectors+2], dx
  9841                                  	; 12/03/2021
  9842 0000282D 66A3[B86D]              	mov	[ep_free_sectors], eax
  9843                                  
  9844 00002831 803E[006A]04            	cmp	byte [ldrives], 4
  9845 00002836 73D0                    	jnb	eetc_2	; error, write program limit message
  9846                                  
  9847                                  edit_ext_table_create_x: ; 02/03/2019
  9848                                  
  9849                                  	; Get logical drive size/cylinders (request) from user
  9850 00002838 E82903                  	call	get_ldd_size
  9851                                  	;cmp	word [lcylinders], 1 ; at least 1 cylinder
  9852                                  	;jb	display_extended_pt ; cancel
  9853                                  	; 13/03/2021
  9854 0000283B 66833E[BC6D]01          	cmp	dword [lcylinders], 1 ; at least 1 cylinder
  9855 00002841 0F8255FF                	jb	display_extended_pt ; cancel
  9856                                  
  9857                                  	; 03/03/2019
  9858 00002845 A0[006A]                	mov	al, [ldrives]
  9859                                  
  9860                                  	;cmp	byte [ldrives], 1
  9861                                  	;jnb	short eetc_3	; skip verify MBR extended partition
  9862                                  
  9863 00002848 20C0                    	and	al, al
  9864 0000284A 756C                    	jnz	short eetc_3
  9865                                  
  9866 0000284C 31ED                    	xor	bp, bp
  9867                                  
  9868                                  	; Read MBR at EBR buffer
  9869                                  	;xor	ah, ah ; 19/10/2020
  9870                                  	;xor	dx, dx
  9871                                  	; 09/03/2021
  9872 0000284E 6631C0                  	xor	eax, eax	
  9873                                  
  9874 00002851 BB[066A]                	mov	bx, ebr_buffer
  9875 00002854 E864F1                  	call	read_hd_sector
  9876 00002857 7219                    	jc	short eetc_0
  9877                                  
  9878                                  	;mov	al, [epnumber]
  9879                                  	;cbw
  9880                                  	;shl	al, 4 ; * 16
  9881                                  	; 13/03/2021
  9882                                  	; eax = 0
  9883 00002859 30ED                    	xor	ch, ch
  9884 0000285B 8A0E[CD6C]              	mov	cl, [epnumber]
  9885 0000285F C0E104                  	shl	cl, 4 ; * 16
  9886 00002862 BE[C46B]                	mov	si, ebr_buffer+446
  9887                                  	;add	si, ax
  9888 00002865 01CE                    	add	si, cx
  9889 00002867 BF[9254]                	mov	di, MasterBootBuff+446
  9890                                  	;add	di, ax
  9891 0000286A 01CF                    	add	di, cx
  9892                                  	;mov	cx, 8
  9893 0000286C B108                    	mov	cl, 8
  9894 0000286E F3A7                    	repe	cmpsw	; repeat comparising while cx > 0 and zf = 1
  9895 00002870 E30A                    	jcxz	eetc_1	; Extended partition entry is not changed 
  9896                                  	; Different PTE (means there is a new extended partition) 
  9897                                  eetc_0:
  9898                                  	; Write current MBR (with modified PT)
  9899 00002872 BB[D452]                	mov	bx, MasterBootBuff
  9900                                  	;xor	ax, ax
  9901                                  	;;xor	dx, dx
  9902                                  	; eax = 0 ; 13/03/2021
  9903 00002875 E892F1                  	call	write_hd_sector
  9904 00002878 0F82DDDE                	jc	print_error_code ; ! display error msg and then exit !
  9905                                  eetc_1:
  9906                                  	; clear	EBR buffer
  9907 0000287C BF[066A]                	mov	di, ebr_buffer
  9908                                  	;xor	ax, ax
  9909                                  	; eax = 0 ; 13/03/2021
  9910                                  	;mov	cx, 255
  9911 0000287F B1FF                    	mov	cl, 255 ; 13/03/2021
  9912 00002881 F3AB                    	rep	stosw
  9913 00002883 C70555AA                	mov	word [di], 0AA55h
  9914                                  
  9915                                  	; Set logical dos drive parameters in it's EBR
  9916 00002887 BF[C46B]                	mov	di, ebr_buffer+446
  9917                                  
  9918                                  	;mov	cx, [sectors]
  9919                                  	;sub	bx, bx ; 0
  9920                                  	; 13/03/2021
  9921 0000288A 660FB70E[9E3C]          	movzx	ecx, word [sectors]
  9922                                  
  9923                                  	;mov	ax, [ep_StartSector]
  9924                                  	;mov	dx, [ep_StartSector+2]
  9925                                  	; 13/03/2021
  9926 00002890 66A1[086C]              	mov	eax, [ep_StartSector]
  9927                                  
  9928                                  	; 03/03/2019
  9929                                  	; set partition start address & size
  9930                                  
  9931                                  	;mov	[ldd_start], ax
  9932                                  	;mov	[ldd_start+2], dx
  9933                                  	; 13/03/2021
  9934 00002894 66A3[986D]              	mov	[ldd_start], eax
  9935                                  
  9936                                  	; 01/11/2020
  9937                                  	;cmp	word [lcylinders], 65535
  9938                                  	;		; sign for using all of available sectors
  9939                                  	;jb	short eetc_11
  9940                                  	; 13/03/2021
  9941 00002898 66833E[BC6D]FF          	cmp	dword [lcylinders], 0FFFFFFFFh
  9942 0000289E 7206                    	jb	short eetc_11
  9943                                  
  9944                                  	;mov	ax, [ep_free_sectors]
  9945                                  	;mov	dx, [ep_free_sectors+2]
  9946                                  	; 13/03/2021
  9947 000028A0 66A1[B86D]              	mov	eax, [ep_free_sectors]
  9948                                  
  9949 000028A4 EB09                    	jmp	short eetc_12
  9950                                  eetc_11:
  9951                                  	;mov	al, [heads]
  9952                                  	;mul	byte [sectors]
  9953                                  	;mul	word [lcylinders]
  9954                                  	; 13/03/2021
  9955 000028A6 66A1[EC69]              	mov	eax, [hs] ; [heads] * [sectors]
  9956 000028AA 66F726[BC6D]            	mul	dword [lcylinders]
  9957                                  eetc_12:
  9958                                  	; 01/11/2020
  9959 000028AF 31ED                    	xor	bp, bp
  9960                                  	;mov	[ldd_size], ax
  9961                                  	;mov	[ldd_size+2], dx
  9962                                  	; 13/03/2021
  9963 000028B1 66A3[A86D]              	mov	[ldd_size], eax
  9964                                  
  9965                                  	; 1st ldd start sector is always 63 or 17 (= spt)
  9966                                  	;sub	ax, cx ; cx = 63 or 17, [sectors]
  9967                                  	;sbb	dx, bx ; sbb dx, 0
  9968                                  
  9969                                  	; 01/11/2020	
  9970 000028B5 E9B700                  	jmp	eetc_4
  9971                                  
  9972                                  	;mov	[di+ptStartSector], cx
  9973                                  	;mov	[di+ptStartSector+2], bx
  9974                                  	;
  9975                                  	;; 01/11/2020
  9976                                  	;mov	[di+ptSectors], ax
  9977                                  	;mov	[di+ptSectors+2], dx
  9978                                  	;
  9979                                  	;mov	cx, ax
  9980                                  	;mov	bx, dx
  9981                                  	;; cx:bx = volume size of logical -dos- drive
  9982                                  	;
  9983                                  	;pop	ax ; ldd's LBA
  9984                                  	;pop	dx
  9985                                  	;; dx:ax = start sector address of ldd
  9986                                  	;
  9987                                  	;; 01/11/2020
  9988                                  	;add	cx, ax
  9989                                  	;adc	bx, dx
  9990                                  	;sub	cx, 1
  9991                                  	;sbb	bx, 0
  9992                                  	;; bx:cx = end sector address of ldd
  9993                                  	;push	cx
  9994                                  	;push	bx
  9995                                  	;
  9996                                  	;jmp	eetc_4
  9997                                  
  9998                                  eetc_3:
  9999                                  	; [ldrives] >= 1
 10000                                  	; Read EBR
 10001                                  	;mov	al, [ldrives]
 10002 000028B8 30E4                    	xor	ah, ah ; 02/11/2020
 10003 000028BA C0E002                  	shl	al, 2
 10004 000028BD 89C5                    	mov	bp, ax
 10005                                  
 10006                                  	; 03/03/2019
 10007                                  	;mov	ax, [bp+ldd_start-4]
 10008                                  	;mov	dx, [bp+ldd_start-2]
 10009                                  	; 09/03/2021
 10010 000028BF 668B86[946D]            	mov	eax, [bp+ldd_start-4]
 10011                                  
 10012 000028C4 BB[066A]                	mov	bx, ebr_buffer
 10013 000028C7 E8F1F0                  	call	read_hd_sector
 10014 000028CA 0F828BDE                	jc	print_error_code ; ! display error msg and then exit !
 10015                                  
 10016                                  	; 04/03/2019
 10017 000028CE BE[D46B]                	mov	si, ebr_buffer+446+16 ; 2nd entry (next EBR)
 10018                                  	
 10019                                  	; 03/03/2019
 10020                                  	;mov	ax, [bp+ldd_start-4]
 10021                                  	;mov	dx, [bp+ldd_start-2]
 10022                                  	;add	ax, [bp+ldd_size-4]
 10023                                  	;adc	dx, [bp+ldd_size-2]
 10024                                  	; 13/03/2021
 10025 000028D1 668B86[946D]            	mov	eax, [bp+ldd_start-4]
 10026 000028D6 660386[A46D]            	add	eax, [bp+ldd_size-4]
 10027                                  
 10028                                  	;mov	cx, [ep_StartSector]
 10029                                  	;mov	bx, [ep_StartSector+2]
 10030                                  	; 13/03/2021
 10031 000028DB 668B16[086C]            	mov	edx, [ep_StartSector]
 10032                                  
 10033                                  	;mov	[bp+ldd_start], ax
 10034                                  	;mov	[bp+ldd_start+2], dx
 10035                                  	; 13/03/2021
 10036 000028E0 668986[986D]            	mov	[bp+ldd_start], eax
 10037                                  
 10038                                  	;push	dx ; ldd's start sector LBA
 10039                                  	;push	ax
 10040                                  	; 13/03/2021
 10041 000028E5 6650                    	push	eax ; *	
 10042                                  
 10043                                  	;sub	ax, cx
 10044                                  	;sbb	dx, bx
 10045                                  	;; dx:ax = offset from start of the ep start sector
 10046                                  	; 13/03/2021
 10047 000028E7 6629D0                  	sub	eax, edx
 10048                                  	; eax = offset from start of the ep start sector
 10049                                  
 10050                                  	;mov	[si+ptStartSector], ax
 10051                                  	;mov	[si+ptStartSector+2], dx
 10052                                  	; 13/03/2021
 10053 000028EA 66894408                	mov	[si+ptStartSector], eax
 10054                                  
 10055                                  	; 01/11/2020
 10056                                  	;cmp	word [lcylinders], 65535
 10057                                  	;		; sign for using all of available sectors
 10058                                  	;jb	short eetc_13
 10059                                  	; 13/03/2021
 10060 000028EE 66833E[BC6D]FF          	cmp	dword [lcylinders], 0FFFFFFFFh
 10061 000028F4 7206                    	jb	short eetc_13
 10062                                  
 10063                                  	;mov	ax, [ep_free_sectors]
 10064                                  	;mov	dx, [ep_free_sectors+2]
 10065                                  	; 13/03/2021
 10066 000028F6 66A1[B86D]              	mov	eax, [ep_free_sectors]
 10067                                  
 10068 000028FA EB09                    	jmp	short eetc_14
 10069                                  eetc_13:
 10070                                  	;mov	al, [heads]
 10071                                  	;mul	byte [sectors]
 10072                                  	;mul	word [lcylinders]
 10073                                  	; 13/03/2021
 10074 000028FC 66A1[EC69]              	mov	eax, [hs] ; [heads] * [sectors]
 10075 00002900 66F726[BC6D]            	mul	dword [lcylinders]
 10076                                  eetc_14:
 10077                                  	; 01/11/2020
 10078                                  	;mov	[bp+ldd_size], ax
 10079                                  	;mov	[bp+ldd_size+2], dx
 10080                                  	; 13/03/2021
 10081 00002905 668986[A86D]            	mov	[bp+ldd_size], eax
 10082                                  
 10083                                   	;mov	[si+ptSectors], ax
 10084                                  	;mov	[si+ptSectors+2], dx
 10085                                  	; 13/03/2021
 10086 0000290A 6689440C                	mov	[si+ptSectors], eax
 10087                                  
 10088                                  	; 01/11/2020
 10089                                  	;mov	cx, ax
 10090                                  	;mov	bx, dx
 10091                                  	;; cx:bx = volume size of logical -dos- drive
 10092                                  	; 13/03/2021
 10093 0000290E 6689C2                  	mov	edx, eax ; ldd's volume size
 10094                                  
 10095                                  	;pop	ax ; ldd's start sector LBA
 10096                                  	;pop	dx
 10097                                  	; 13/03/2021
 10098 00002911 6658                    	pop	eax ; *
 10099                                  
 10100                                  	; 01/11/2020
 10101                                  	;add	cx, ax
 10102                                  	;adc	bx, dx
 10103                                  	; 13/03/2021
 10104 00002913 6601C2                  	add	edx, eax ; ldd's start sector LBA
 10105                                  
 10106                                  	;sub	cx, 1
 10107                                  	;sbb	bx, 0
 10108                                  	;; bx:cx = end sector address of ldd
 10109                                  	; 13/03/2021
 10110 00002916 664A                    	dec	edx ; end sector address of ldd
 10111                                  
 10112                                  	;push	cx
 10113                                  	;push	bx
 10114                                  	; 13/03/2021
 10115 00002918 6652                    	push	edx ; **
 10116                                  
 10117                                  	; calculate CHS from LBA
 10118 0000291A E8D801                  	call	lba_to_chs
 10119                                  		; ax = cylinder
 10120                                  		; dl = sector
 10121                                  		; dh = head
 10122                                  
 10123 0000291D C60400                  	mov	byte [si+ptBootable], 0
 10124 00002920 887401                  	mov	[si+ptBeginHead], dh
 10125 00002923 884403                  	mov	[si+ptBeginCylinder], al
 10126 00002926 C0E406                  	shl	ah, 6
 10127 00002929 08E2                    	or	dl, ah
 10128 0000292B 885402                  	mov	[si+ptBeginSector], dl
 10129                                  
 10130                                   	;;mov	ax, [si+ptSectors]
 10131                                  	;;mov	dx, [si+ptSectors+2]
 10132                                   	;mov	ax, [bp+ldd_size]
 10133                                  	;mov	dx, [bp+ldd_size+2]
 10134                                  	;sub	ax, 1
 10135                                  	;sbb	dx, 0
 10136                                  	;add	ax, [bp+ldd_start]
 10137                                  	;adc	dx, [bp+ldd_start+2]
 10138                                  	;	; dx:ax = end sector
 10139                                  	
 10140                                  	; 01/11/2020
 10141                                  	;pop	ax
 10142                                  	;pop	dx
 10143                                  	;; dx:ax = end sector address of ldd
 10144                                  	; 13/03/2021
 10145 0000292E 6658                    	pop	eax ; **
 10146                                  
 10147 00002930 E8C201                  	call	lba_to_chs
 10148                                  		; ax = cylinder
 10149                                  		; dl = sector
 10150                                  		; dh = head
 10151                                  		; 24/10/2020
 10152                                  		; bl = Extended partition ID
 10153                                  
 10154                                  	; 13/03/2021
 10155 00002933 6631C9                  	xor	ecx, ecx
 10156                                  		
 10157                                  	;mov	byte [si+ptFileSystemID], 5 ; EXTENDED
 10158                                  	; 24/10/2020
 10159 00002936 885C04                  	mov	[si+ptFileSystemID], bl ; EXTENDED ; 05h or 0Fh
 10160                                  	;
 10161 00002939 887405                  	mov	[si+ptEndHead], dh
 10162 0000293C 884407                  	mov	[si+ptEndCylinder], al
 10163 0000293F C0E406                  	shl	ah, 6
 10164 00002942 08D4                    	or	ah, dl	
 10165 00002944 886406                  	mov	[si+ptEndSector], ah
 10166                                  
 10167                                  	; Write EBR
 10168                                  	;mov	ax, [bp+ldd_start-4]
 10169                                  	;mov	dx, [bp+ldd_start-2]
 10170                                  	; 13/03/2021
 10171 00002947 668B86[946D]            	mov	eax, [bp+ldd_start-4]
 10172                                  	
 10173 0000294C BB[066A]                	mov	bx, ebr_buffer
 10174 0000294F E8B8F0                  	call	write_hd_sector
 10175 00002952 0F8203DE                	jc	print_error_code ; ! display error msg and then exit !
 10176                                  
 10177                                  	; clear	EBR buffer
 10178 00002956 BF[066A]                	mov	di, ebr_buffer
 10179 00002959 31C0                    	xor	ax, ax
 10180                                  	;mov	cx, 255
 10181                                  	; 13/03/2021
 10182 0000295B B1FF                    	mov	cl, 255
 10183 0000295D F3AB                    	rep	stosw
 10184 0000295F C70555AA                	mov	word [di], 0AA55h
 10185                                  
 10186 00002963 BF[C46B]                	mov	di, ebr_buffer+446 ; 1st entry points to LDD
 10187                                  
 10188                                  	;mov	cx, [sectors]
 10189                                  	;sub	bx, bx ; 0
 10190                                  	; 13/03/2021
 10191 00002966 8A0E[9E3C]              	mov	cl, [sectors]
 10192                                  	; ecx = [sectors]
 10193                                  
 10194                                  	; 01/11/2020
 10195                                  	;mov	ax, [bp+ldd_size]
 10196                                  	;mov	dx, [bp+ldd_size+2]
 10197                                  	; 13/03/2021
 10198 0000296A 668B86[A86D]            	mov	eax, [bp+ldd_size]
 10199                                  
 10200                                  	;sub	ax, cx
 10201                                  	;sbb	dx, bx ; sbb dx, 0
 10202                                  eetc_4:
 10203                                  	;mov	[di+ptStartSector], cx
 10204                                  	;mov	[di+ptStartSector+2], bx
 10205                                  	; 13/03/2021
 10206 0000296F 66894D08                	mov	[di+ptStartSector], ecx
 10207                                  
 10208                                  	; 01/11/2020
 10209                                  	; 1st ldd start sector is always 63 or 17 (= spt)
 10210                                  	;sub	ax, cx ; cx = 63 or 17, [sectors]
 10211                                  	;sbb	dx, bx ; sbb dx, 0
 10212                                  	; 13/03/2021
 10213 00002973 6629C8                  	sub	eax, ecx
 10214                                  
 10215                                  	; 01/11/2020
 10216                                  	;mov	[di+ptSectors], ax
 10217                                  	;mov	[di+ptSectors+2], dx
 10218                                  	; 13/03/2021
 10219 00002976 6689450C                	mov	[di+ptSectors], eax
 10220                                  
 10221                                  	;mov	cx, [bp+ldd_size]
 10222                                  	;mov	bx, [bp+ldd_size+2]
 10223                                  	;; cx:bx = volume size of logical -dos- drive
 10224                                  	; 13/03/2021
 10225 0000297A 668B96[A86D]            	mov	edx, [bp+ldd_size]
 10226                                  
 10227                                  	;mov	ax, [bp+ldd_start]
 10228                                  	;mov	dx, [bp+ldd_start+2]
 10229                                  	;; dx:ax = start sector address of ldd (EBR addr)
 10230                                  	; 13/03/2021
 10231 0000297F 668B86[986D]            	mov	eax, [bp+ldd_start]
 10232                                  
 10233                                  	; 01/11/2020
 10234                                  	;add	cx, ax
 10235                                  	;adc	bx, dx
 10236                                  	;sub	cx, 1
 10237                                  	;sbb	bx, 0
 10238                                  	;; bx:cx = end sector address of ldd
 10239                                  	; 13/03/2021
 10240 00002984 6601C2                  	add	edx, eax
 10241 00002987 664A                    	dec	edx
 10242                                  
 10243                                  	;push	bx
 10244                                  	;push	cx
 10245                                  	; 13/03/2021
 10246 00002989 6652                    	push	edx ; ***
 10247                                  ;eetc_4:
 10248                                  	; 01/11/2020
 10249                                  	; stack = end sector address of ldd
 10250                                  	; dx:ax = start sector address of ldd
 10251                                  
 10252                                  	; calculate CHS from LBA
 10253                                  
 10254 0000298B E86701                  	call	lba_to_chs
 10255                                  		; ax = cylinder
 10256                                  		; dl = sector
 10257                                  		; dh = head
 10258                                  
 10259                                  	;mov	byte [di+ptBootable], 0
 10260 0000298E 887501                  	mov	[di+ptBeginHead], dh
 10261 00002991 884503                  	mov	[di+ptBeginCylinder], al
 10262                                  	;mov	bl, ah
 10263                                  	;shl	bl, 6
 10264                                  	;or	dl, bl
 10265                                  	; 01/11/2020
 10266 00002994 C0E406                  	shl	ah, 6
 10267 00002997 08E2                    	or	dl, ah
 10268 00002999 885502                  	mov	[di+ptBeginSector], dl
 10269                                  
 10270                                  	;add	ax, [lcylinders]
 10271                                  	;dec	ax ; end cylinder
 10272                                  	;mov	bx, ax
 10273                                  
 10274                                  	; 01/11/2020
 10275                                  	;pop	ax
 10276                                  	;pop	dx
 10277                                  	;; dx:ax = end sector address of ldd
 10278                                  	; 13/03/2021
 10279 0000299C 6658                    	pop	eax ; ***
 10280                                  
 10281 0000299E E85401                  	call	lba_to_chs
 10282                                  		; ax = cylinder number (0-1023)
 10283                                  		; dl = sector
 10284                                  		; dh = head
 10285                                  		; 01/11/2020
 10286                                  		; cx = cylinder number (0-65535)
 10287                                  		; 13/03/2021
 10288                                  		; ecx = cylinder number (0-267349)
 10289                                  
 10290                                  	;; 02/11/2020
 10291                                  	;;mov	[endcyl], cx ; 01/11/2020
 10292                                  	;xchg	[endcyl], cx 
 10293                                  		; cx = end cylinder of the ep
 10294                                  		; [endcyl] = end cylinder of the ldd
 10295                                  	; 13/03/2021
 10296 000029A1 66870E[C26D]            	xchg	[endcyl], ecx
 10297                                  
 10298                                  	;mov	[di+ptFileSystemID], 0
 10299                                  	;mov	cx, [heads]
 10300                                  	;dec	cl
 10301                                  	;mov	[di+ptEndHead], cl
 10302                                  	; 01/11/2020
 10303 000029A6 887505                  	mov	[di+ptEndHead], dh
 10304                                  
 10305 000029A9 884507                  	mov	[di+ptEndCylinder], al
 10306                                  	;mov	dx, [sectors]
 10307 000029AC C0E406                  	shl	ah, 6
 10308 000029AF 08D4                    	or	ah, dl
 10309 000029B1 886506                  	mov	[di+ptEndSector], ah
 10310                                  
 10311                                  	; 02/03/2019
 10312                                  	; Check unused space if it is 3rd LDD
 10313                                  	; (write message to add unused space.)
 10314                                  
 10315                                  	; 02/11/2020
 10316                                  	;cmp	byte [ldrives], 3
 10317                                  	;jb	eetc_7
 10318                                  
 10319                                  	; 01/11/2020
 10320                                  	;cmp	word [lcylinders], 65535  
 10321                                  	;		; sign for using all of available sectors
 10322                                  	;jnb	eetc_7	; no need to add unused sector 
 10323                                  	;		; (there are not any unused sectors)
 10324                                  	; 13/03/2021
 10325 000029B4 66833E[BC6D]FF          	cmp	dword [lcylinders], 0FFFFFFFFh
 10326 000029BA 0F83A200                	jnb	eetc_7	; no need to add unused sector
 10327                                  	
 10328                                  	; cx = cylinder number (0 to 65535)
 10329                                  	; 13/03/2021
 10330                                  	; ecx = cylinder number (0 to 267349)
 10331                                  
 10332                                  	; 02/11/2020
 10333 000029BE 803E[006A]03            	cmp	byte [ldrives], 3 ; is this logical drive 4 ?
 10334 000029C3 730B                    	jnb	short eetc_17
 10335                                  			; force to show unused space message
 10336                                  
 10337                                  	; 02/11/2020
 10338                                  	; (add unused space if cyl nums are same or diff is 1)
 10339                                  	;dec	cx  ; tolerate cylinder numbers n and n-1 
 10340                                  	;cmp	cx, [endcyl]
 10341                                  	;ja	eetc_7  ; the end cyl number of the last ldd
 10342                                  	;		; is 2 or more cyls less than
 10343                                  	;		; the end cyl number of the ep
 10344                                  	;		; (a next ldd can be added to
 10345                                  	;		; extd partition with 2 or more cyls)
 10346                                  	; 13/03/2021
 10347 000029C5 6649                    	dec	ecx
 10348 000029C7 663B0E[C26D]            	cmp	ecx, [endcyl]
 10349 000029CC 0F879000                	ja	eetc_7
 10350                                  eetc_17:
 10351                                  	; 02/11/2020
 10352 000029D0 A0[006A]                	mov	al, [ldrives]
 10353                                  	;add	al, '0'
 10354 000029D3 0431                    	add	al, '1'	; 03/11/2020
 10355 000029D5 A2[C15E]                	mov	[char_lddn], al
 10356                                  
 10357                                  	;mov	al, [sectors]
 10358                                  	;mov	bh, al
 10359                                  	;mov	bl, [heads]
 10360                                  	;dec	bl
 10361                                  	;mul	bl ; [sectors] * [heads] - 1
 10362                                  	; 13/03/2021
 10363 000029D8 66A1[EC69]              	mov	eax, [hs] ; [sectors] * [heads]
 10364 000029DC 6648                    	dec	eax ; [sectors] * [heads] - 1
 10365                                  	
 10366                                  	;push	ax
 10367                                  	; 13/03/2021
 10368 000029DE 6650                    	push	eax ; ****
 10369                                  
 10370                                  	;mov	al, bh  ; [sectors]
 10371                                  	;;mul	byte [heads]
 10372                                  	;inc	bl
 10373                                  	;mul	bl
 10374                                  	;	; ax = heads * sectors
 10375                                  	;;mul	cx ; * end cylinder
 10376                                  	;mul	word [endcyl] ; 02/11/2020
 10377                                  	;	; dx:ax = end cylinder * heads * sectors
 10378                                  	; 13/03/2021
 10379 000029E0 6640                    	inc	eax ; heads * sectors
 10380 000029E2 66F726[C26D]            	mul	dword [endcyl]
 10381                                  	; eax = ((cylinders-1) * heads * sectors)
 10382                                  	
 10383                                  	;pop	cx
 10384                                  	;add	ax, cx ; + (sectors * (heads - 1))
 10385                                  	;adc	dx, 0	
 10386                                  	; 13/03/2021
 10387 000029E7 665A                    	pop	edx ; ****
 10388 000029E9 6601D0                  	add	eax, edx ; + (sectors * (heads - 1))
 10389                                  
 10390                                  	; 03/03/2019
 10391                                  	;mov	cx, [sectors]
 10392                                  	;dec	cl  ; [sectors] - 1
 10393                                  	;add	ax, cx ; + (sectors - 1)
 10394                                  	;adc	dx, 0
 10395                                  	;	; DX:AX = end LBA
 10396                                  	; 13/03/2021
 10397 000029EC 6631D2                  	xor	edx, edx
 10398 000029EF 8A16[9E3C]              	mov	dl, [sectors]
 10399 000029F3 FECA                    	dec	dl ; [sectors] - 1
 10400 000029F5 6601D0                  	add	eax, edx  ; + (sectors - 1)
 10401                                  
 10402                                  	;mov	cx, [ep_EndSector]
 10403                                  	;mov	bx, [ep_EndSector+2]
 10404                                  	; 13/03/2021
 10405 000029F8 668B16[0C6C]            	mov	edx, [ep_EndSector]
 10406                                  
 10407                                  	;cmp	dx, bx
 10408                                  	;jne	short eetc_5
 10409                                  	;cmp	ax, cx
 10410                                  	;je	short eetc_7 ; 05/03/2019
 10411                                  	; 13/03/2021
 10412 000029FD 6639D0                  	cmp	eax, edx
 10413 00002A00 745E                    	je	short eetc_7
 10414                                  eetc_5:
 10415                                  	;push	bx
 10416 00002A02 BE[7E5E]                	mov	si, msg_c_ldd_unused_warning
 10417 00002A05 E8A4EF                  	call	print_msg
 10418                                  	;pop	bx
 10419                                  eetc_6:
 10420 00002A08 28E4                    	sub	ah, ah
 10421 00002A0A CD16                    	int	16h
 10422 00002A0C 3C0D                    	cmp	al, 13 ; ENTER
 10423 00002A0E 7450                    	je	short eetc_7 ; continue
 10424 00002A10 3C1B                    	cmp	al, 27 ; ESC
 10425 00002A12 75F4                    	jne	short eetc_6
 10426                                  
 10427                                  	; 03/03/2019
 10428                                  	; change end cylinder value
 10429 00002A14 A0[CD6C]                	mov	al, [epnumber]
 10430 00002A17 FEC8                    	dec	al
 10431                                  	;mov	ah, 18  ; primary partition table structure size
 10432                                  	; 05/11/2020
 10433 00002A19 B416                    	mov	ah, 22	; primary partition table structure size
 10434 00002A1B F6E4                    	mul	ah
 10435 00002A1D 89C6                    	mov	si, ax
 10436                                  	;mov	ax, [si+part_table_end_cyl]
 10437                                  	; 02/11/2020
 10438                                  	;mov	[endcyl], ax ; end cylinder of the ep
 10439                                  	; 13/03/2021
 10440 00002A1F 668B84[7C6C]            	mov	eax, [si+part_table_end_cyl]
 10441 00002A24 66A3[C26D]              	mov	[endcyl], eax ; end cylinder of the ep
 10442                                  eetc_19:
 10443                                  	; 03/11/2020
 10444                                  	;cmp	ax, 1023 ; overs CHS limit ?
 10445                                  	;jna	short eetc_20 ; no
 10446                                  	;mov	ax, 1023 ; 03FFh ; fix end CHS values of the PTE
 10447                                  	; 13/03/2021
 10448 00002A28 663DFF030000            	cmp	eax, 1023
 10449 00002A2E 7606                    	jna	short eetc_20
 10450 00002A30 66B8FF030000            	mov	eax, 1023
 10451                                  eetc_20:
 10452 00002A36 884507                  	mov	[di+ptEndCylinder], al
 10453 00002A39 8A84[7B6C]              	mov	al, [si+part_table_end_sector]
 10454 00002A3D C0E406                  	shl	ah, 6
 10455 00002A40 08C4                    	or	ah, al	
 10456 00002A42 886506                  	mov	[di+ptEndSector], ah
 10457 00002A45 8A84[7A6C]              	mov	al, [si+part_table_end_head]
 10458 00002A49 884505                  	mov	[di+ptEndHead], al
 10459                                  
 10460                                  	;mov	ax, cx
 10461                                  	;mov	dx, bx
 10462                                  	;add	ax, 1
 10463                                  	;adc	dx, 0
 10464                                  	;	; dx:ax = end of extd partition + 1
 10465                                  	; 13/03/2021
 10466 00002A4C 6689D0                  	mov	eax, edx
 10467 00002A4F 6648                    	dec	eax
 10468                                  
 10469                                  	; 02/11/2020
 10470                                  	;sub	ax, [bp+ldd_start]
 10471                                  	;sbb	dx, [bp+ldd_start+2]
 10472                                  	;sub	ax, [di+ptStartSector]
 10473                                  	;sbb	dx, [di+ptStartSector+2]
 10474                                  	;	; dx:ax = new sector count of the ldd
 10475                                  	; 13/03/2021
 10476 00002A51 662B86[986D]            	sub	eax, [bp+ldd_start]
 10477 00002A56 662B4508                	sub	eax, [di+ptStartSector]
 10478                                  
 10479                                  	;mov	[di+ptSectors], ax
 10480                                  	;mov	[di+ptSectors+2], dx
 10481                                  	; 13/03/2021
 10482 00002A5A 6689450C                	mov	[di+ptSectors], eax
 10483                                  	
 10484 00002A5E EB04                    	jmp	short eetc_8
 10485                                  eetc_7:
 10486                                  	;mov	ax, [di+ptSectors]
 10487                                  	;mov	dx, [di+ptSectors+2]
 10488                                  	; 13/03/2021
 10489 00002A60 668B450C                	mov	eax, [di+ptSectors]
 10490                                  eetc_8:
 10491                                  	; 13/03/2021
 10492                                  	;xor	edx, edx
 10493                                  	; 01/11/2020
 10494                                  	;cmp	word [endcyl], 1023
 10495                                  	;jna	short eetc_15
 10496                                  	; 13/03/2021
 10497 00002A64 66813E[C26D]FF0300-     	cmp	dword [endcyl], 1023
 10497 00002A6C 00                 
 10498 00002A6D 7605                    	jna	short eetc_15
 10499                                  
 10500                                  	; 25/10/2020
 10501                                  	;mov	cx, [bp+ldd_start]
 10502                                  	;mov	bx, [bp+ldd_start+2]
 10503                                  	;; 01/11/2020
 10504                                  	;add	cx, [bp+ldd_size]
 10505                                  	;adc	bx, [bp+ldd_size+2]
 10506                                  	;sub	cx, 1 ; *
 10507                                  	;sbb	bx, 0 ; *
 10508                                  	;cmp	bx, [chs_limit+2]
 10509                                  	;jb	short eetc_15
 10510                                  	;ja	short eetc_19
 10511                                  	;cmp	cx, [chs_limit]
 10512                                  	;jna	short eetc_15
 10513                                  ;eetc_19:
 10514 00002A6F E8D900                  	call	size_to_fat_type_lba ; 25/10/2020
 10515 00002A72 EB03                    	jmp	short eetc_16
 10516                                  eetc_15:
 10517                                  	; Get proper FAT type in [ldd_type]
 10518                                  	; by using DX:AX - size -
 10519 00002A74 E8B500                  	call	size_to_fat_type
 10520                                  eetc_16:
 10521 00002A77 884504                  	mov	[di+ptFileSystemID], al
 10522                                  
 10523                                  	; 13/03/2021
 10524                                  	; edx < 65536
 10525                                  
 10526                                  	; Write current EBR (with modified PT)
 10527                                  	;mov	ax, [bp+ldd_start]
 10528                                  	;mov	dx, [bp+ldd_start+2]
 10529 00002A7A 668B86[986D]            	mov	eax, [bp+ldd_start]
 10530                                  
 10531                                  	; 01/11/2020
 10532                                  	; ! safety ! (to protect MBR and primary partition)
 10533                                  ;eetc_16:
 10534                                  	;cmp	dx, [ep_StartSector+2]
 10535                                  	;jb	short eetc_18
 10536                                  	;ja	short eetc_17
 10537                                  	;cmp	ax, [ep_StartSector]
 10538                                  	;jna	short eetc_18
 10539                                  ;eetc_17:
 10540                                  	;mov	ah, 0FFh
 10541                                  	;jmp	print_error_code
 10542                                  ;eetc_18:
 10543                                  
 10544 00002A7F BB[066A]                	mov	bx, ebr_buffer
 10545 00002A82 E885EF                  	call	write_hd_sector
 10546 00002A85 0F82D0DC                	jc	print_error_code ; ! display error msg and then exit !
 10547                                  
 10548 00002A89 A0[006A]                	mov	al, [ldrives]
 10549                                  	;mov	ah, 18 ; extended partition table structure size
 10550                                  	; 05/11/2020
 10551 00002A8C B416                    	mov	ah, 22 ; extended partition table structure size
 10552 00002A8E F6E4                    	mul	ah
 10553                                  
 10554 00002A90 89C6                    	mov	si, ax
 10555 00002A92 81C6[CE6C]              	add	si, ext_table_boot_ind
 10556 00002A96 87F7                    	xchg	si, di
 10557                                  
 10558                                  	; set partition (logical -dos- drive) data
 10559 00002A98 A5                      	movsw	; boot indicator, beginning head
 10560 00002A99 AC                      	lodsb
 10561 00002A9A 88C4                    	mov	ah, al
 10562 00002A9C 243F                    	and	al, 3Fh
 10563 00002A9E AA                      	stosb	; beginning sector
 10564 00002A9F C0EC06                  	shr	ah, 6
 10565 00002AA2 AC                      	lodsb	; beginning cylinder
 10566 00002AA3 AB                      	stosw
 10567                                  	; 21/03/2021
 10568 00002AA4 31C0                    	xor	ax, ax
 10569 00002AA6 AB                      	stosw
 10570 00002AA7 A5                      	movsw	; partition id, end head
 10571 00002AA8 AC                      	lodsb
 10572 00002AA9 88C4                    	mov	ah, al
 10573 00002AAB 243F                    	and	al, 3Fh
 10574 00002AAD AA                      	stosb	; end sector
 10575 00002AAE C0EC06                  	shr	ah, 6
 10576 00002AB1 AC                      	lodsb	; end cylinder
 10577 00002AB2 AB                      	stosw
 10578                                  	; 21/03/2021
 10579 00002AB3 31C0                    	xor	ax, ax
 10580 00002AB5 AB                      	stosw
 10581                                  
 10582 00002AB6 A5                      	movsw	; copy start sector (LBA) and sector count
 10583 00002AB7 A5                      	movsw
 10584 00002AB8 A5                      	movsw
 10585 00002AB9 A5                      	movsw
 10586                                  
 10587 00002ABA FE06[006A]              	inc	byte [ldrives]
 10588                                  
 10589 00002ABE E9D9FC                  	jmp	display_extended_pt
 10590                                  
 10591                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10592                                  ; check free space in EXTENDED (DOS) partition
 10593                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10594                                  ; 05/03/2019
 10595                                  
 10596                                  	; 12/03/2021 (fdisk4.s, 32 bit registers)
 10597                                  check_ext_free_space:
 10598                                  	;mov	ax, [ep_Size]
 10599                                  	;mov	dx, [ep_Size+2]
 10600 00002AC1 66A1[106C]              	mov	eax, [ep_Size]
 10601                                  	; 12/03/2021
 10602 00002AC5 6631DB                  	xor	ebx, ebx
 10603 00002AC8 8A1E[006A]              	mov	bl, [ldrives]
 10604 00002ACC 20DB                    	and	bl, bl
 10605 00002ACE 7421                    	jz	short cefs_1
 10606 00002AD0 80FB04                  	cmp	bl, 4
 10607 00002AD3 7602                    	jna	short cefs_0
 10608 00002AD5 B304                    	mov	bl, 4
 10609                                  cefs_0:
 10610 00002AD7 FECB                    	dec	bl
 10611 00002AD9 C0E302                  	shl	bl, 2 ; * 4
 10612                                  	;xor	bh, bh
 10613                                  	;mov	si, bx
 10614                                  
 10615                                  	;mov	cx, [si+ldd_start]
 10616                                  	;mov	bx, [si+ldd_start+2]
 10617                                  	;add	cx, [si+ldd_size]
 10618                                  	;adc	bx, [si+ldd_size+2]
 10619                                  	; 12/03/2021
 10620 00002ADC 668B97[986D]            	mov	edx, [bx+ldd_start]
 10621 00002AE1 660397[A86D]            	add	edx, [bx+ldd_size]
 10622                                  
 10623                                  	;add	ax, [ep_StartSector]
 10624                                  	;adc	dx, [ep_StartSector+2]
 10625 00002AE6 660306[086C]            	add	eax, [ep_StartSector]
 10626                                  
 10627                                  	;sub	ax, cx
 10628                                  	;sbb	dx, bx
 10629                                  
 10630 00002AEB 6629D0                  	sub	eax, edx
 10631 00002AEE 7501                    	jnz	short cefs_1
 10632                                  	
 10633                                  	;or	ax, ax
 10634                                  	;jnz	short cefs_1
 10635                                  
 10636                                  	; cf = 0 if the result not negative
 10637                                  
 10638 00002AF0 F9                      	stc
 10639                                  
 10640                                  	; cf = 1 if the result is negative or zero
 10641                                  	 
 10642                                  	; If cf = 0 -> There is free space as in DX:AX
 10643                                  	; NOTE: This calculation is unsafe if
 10644                                  	; logical dos drive count > 4 !	
 10645                                  	; (But still meaningful for creating a new ldd.
 10646                                  	;  Because a new ldd will be created only
 10647                                  	;  if ldd count < 4.)
 10648                                  cefs_1:
 10649                                  	; 12/03/2021
 10650 00002AF1 6689DA                  	mov	edx, ebx ; edx < 65536
 10651                                  	; eax = free space (sectors)
 10652 00002AF4 C3                      	retn
 10653                                  
 10654                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10655                                  ; convert LBA to CHS parameters (in registers)
 10656                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10657                                  ; 24/10/2020
 10658                                  
 10659                                  	; 21/03/2021
 10660                                  	; 13/03/2021 (fdisk4.s)
 10661                                  	; 01/03/2019 (hdimage.s)
 10662                                  lba_to_chs:
 10663                                  	; INPUT:
 10664                                  	;	DX:AX = LBA address
 10665                                  	; OUTPUT:
 10666                                  	;	AX = cylinder
 10667                                  	;	DL = sector
 10668                                  	;	DH = head
 10669                                  	; 24/10/2020
 10670                                  	;	BL = extended partition ID (05h, 0Fh)
 10671                                  	;
 10672                                  	; (modified registers: ax, bx, cx, dx)
 10673                                  
 10674                                  	; 13/03/2021
 10675                                  	;
 10676                                  	; INPUT:
 10677                                  	;	EAX = LBA address
 10678                                  	; OUTPUT:
 10679                                  	;	EAX = cylinder (<= 1023)
 10680                                  	;	 DL = sector
 10681                                  	;	 DH = head
 10682                                  	;
 10683                                  	;	ECX = cylinder
 10684                                  
 10685                                  	;mov	cx, [sectors]
 10686                                  	;call	div32
 10687                                  	;inc	bl
 10688                                  	; 13/03/2021
 10689 00002AF5 6629D2                  	sub	edx, edx
 10690 00002AF8 660FB70E[9E3C]          	movzx	ecx, word [sectors]
 10691 00002AFE 66F7F1                  	div	ecx
 10692 00002B01 FEC2                    	inc	dl
 10693                                  
 10694                                  	;push	bx ; BL = sector
 10695                                  	;mov	cx, [heads]
 10696                                  	;call	div32
 10697                                  	;pop	dx  ; DL = sector
 10698                                  	;mov	dh, bl ; BL = head
 10699                                  	; 13/03/2021
 10700 00002B03 52                      	push	dx
 10701 00002B04 31D2                    	xor	dx, dx ; 21/03/2021
 10702 00002B06 8B0E[A03C]              	mov	cx, [heads]
 10703 00002B0A 66F7F1                  	div	ecx
 10704                                  	; dl = head
 10705 00002B0D 88D3                    	mov	bl, dl
 10706 00002B0F 5A                      	pop	dx ; dl = sector
 10707 00002B10 88DE                    	mov	dh, bl ; dh = head
 10708                                  
 10709                                  	; 24/10/2020
 10710                                  	; check cylinder number (CHS) limit
 10711                                  	;mov	bh, 05h ; ENTENTED (LBA)
 10712                                  	; 13/03/2021
 10713 00002B12 B305                    	mov	bl, 05h ; ENTENTED (LBA) 
 10714                                  
 10715                                  	;mov	cx, ax ; 01/11/2020
 10716                                  	; 13/03/2021
 10717 00002B14 6689C1                  	mov	ecx, eax
 10718                                  
 10719                                  	;cmp	ax, 1023
 10720                                  	; 13/03/2021
 10721 00002B17 663DFF030000            	cmp	eax, 1023
 10722 00002B1D 760C                    	jna	short lbatochs_ok
 10723                                  
 10724                                  	;mov	ax, 1023 ; BC/EC = 0FFh
 10725                                  	; 13/03/2021
 10726 00002B1F 66B8FF030000            	mov	eax, 1023
 10727 00002B25 B23F                    	mov	dl, 63  ; BS/ES = 0FFh
 10728 00002B27 B6FE                    	mov	dh, 254 ; BH/EH = 0FEh
 10729 00002B29 B30F                    	mov	bl, 0Fh ; EXTENDED (CHS)
 10730                                  lbatochs_ok:
 10731 00002B2B C3                      	retn
 10732                                  
 10733                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10734                                  ; specify FAT type by using partition/volume size (CHS)
 10735                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10736                                  ; 02/03/2019
 10737                                  
 10738                                  	; 13/03/2021 (fdisk4.s)
 10739                                  size_to_fat_type:
 10740                                  	; INPUT:
 10741                                  	;	DX:AX = DOS Partition Size in sectors
 10742                                  	; OUTPUT:
 10743                                  	;	AL = Partition type/ID (FAT type)
 10744                                  
 10745                                  	;or	dx, dx
 10746                                  	;jnz	short stft_2
 10747                                  
 10748                                  	; 13/03/2021
 10749 00002B2C 6689C2                  	mov	edx, eax
 10750 00002B2F 66C1EA10                	shr	edx, 16	
 10751 00002B33 750B                    	jnz	short stft_2
 10752                                  
 10753 00002B35 3DA87F                  	cmp	ax, 32680
 10754 00002B38 7703                    	ja	short stft_1
 10755                                  stft_0:	
 10756 00002B3A B001                    	mov	al, 1	; FAT12 file system
 10757 00002B3C C3                      	retn
 10758                                  stft_1:
 10759 00002B3D B004                    	mov	al, 4	; FAT16 (< 32MB)
 10760 00002B3F C3                      	retn	
 10761                                  stft_2:
 10762 00002B40 83FA10                  	cmp	dx, 10h
 10763 00002B43 7303                    	jnb	short stft_3 ; FAT32 (CHS) file system	
 10764                                  
 10765 00002B45 B006                    	mov	al, 6	; FAT16 (>= 32MB)
 10766 00002B47 C3                      	retn
 10767                                  stft_3:
 10768 00002B48 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
 10769 00002B4A C3                      	retn
 10770                                  
 10771                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10772                                  ; specify FAT type by using partition/volume size (LBA)
 10773                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10774                                  ; 25/10/2020
 10775                                  
 10776                                  	; 13/03/2021 (fdisk4.s)
 10777                                  size_to_fat_type_lba:
 10778                                  	; INPUT:
 10779                                  	;	DX:AX = DOS Partition Size in sectors
 10780                                  	; OUTPUT:
 10781                                  	;	AL = Partition type/ID (FAT type)
 10782                                  
 10783                                  	; 13/03/2021
 10784                                  	; eax = DOS Partition Size in sectors
 10785                                  
 10786                                  	;or	dx, dx
 10787                                  	;jz	short stft_4
 10788                                  
 10789                                  	; 13/03/2021
 10790 00002B4B 6689C2                  	mov	edx, eax
 10791 00002B4E 66C1EA10                	shr	edx, 16	
 10792 00002B52 7408                    	jz	short stft_4
 10793                                  
 10794 00002B54 83FA10                  	cmp	dx, 10h
 10795 00002B57 7208                    	jb	short stft_5 ; FAT16 (LBA) file system	
 10796                                  
 10797 00002B59 B00C                    	mov	al, 0Ch ; FAT32 file system (LBA)
 10798 00002B5B C3                      	retn
 10799                                  stft_4:
 10800 00002B5C 3DA87F                  	cmp	ax, 32680
 10801 00002B5F 76D9                    	jna	short stft_0  ; FAT12 file system
 10802                                  stft_5:	
 10803 00002B61 B00E                    	mov	al, 0Eh	; FAT16 file system (LBA)
 10804 00002B63 C3                      	retn
 10805                                  
 10806                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10807                                  ; get requested logical dos drive size (from user)
 10808                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10809                                  ; 02/03/2019
 10810                                  	
 10811                                  	; 13/03/2021
 10812                                  	; 12/03/2021 (fdisk4.s)
 10813                                  get_ldd_size:
 10814                                  	; INPUT -> none
 10815                                  	;
 10816                                  	; OUTPUT -> 
 10817                                  	;	[lcylinders] = cylinder count
 10818                                  	;
 10819                                  	; (Modified registers: ax, bx, cx, dx, si, di) 
 10820                                  
 10821 00002B64 B80300                  	mov	ax, 3 ; clear screen
 10822 00002B67 CD10                    	int	10h
 10823                                  
 10824 00002B69 BE[FD44]                	mov	si, msg_create_dos_partition_h
 10825 00002B6C E83DEE                  	call	print_msg
 10826                                  
 10827                                  	; 03/03/2019
 10828 00002B6F A0[006A]                	mov	al, [ldrives]
 10829 00002B72 08C0                    	or	al, al		; cmp byte [ldrives], 0
 10830 00002B74 7405                    	jz	short gldds_1	; jna short gldds_0
 10831                                  
 10832                                  	;push	ax ; *
 10833                                  
 10834                                  	;dec	al
 10835                                  	;mov	ah, 22 ; 05/11/2020
 10836                                  	;mul	ah
 10837                                  	
 10838                                  	;mov	di, ext_table_rel_sec_lw
 10839                                  	;add	di, ax
 10840                                  
 10841 00002B76 BE[114B]                	mov	si, msg_use_all_space
 10842                                  	; 01/11/2020
 10843                                  	;call	print_msg
 10844 00002B79 EB03                    	jmp	short gldds_2
 10845                                  
 10846                                  	; Calculate available space
 10847                                  
 10848                                  	;mov	ax, [ep_Size] ; ext part size in sectors
 10849                                  	;mov	dx, [ep_Size+2]
 10850                                  	
 10851                                  	; 04/03/2019
 10852                                  ;gldds_0:
 10853                                  	;mov	cx, [di]    ; start sector
 10854                                  	;mov	bx, [di+2]
 10855                                  	;add	cx, [di+4]  ; sectors
 10856                                  	;adc	bx, [di+6]
 10857                                  	;	; bx:cx = start of next ldd
 10858                                  	;sub	ax, cx
 10859                                  	;sbb	dx, bx
 10860                                  	;	; dx:ax = free space in sectors
 10861                                  	;
 10862                                  	;pop	cx ; *
 10863                                  	;dec	cl
 10864                                  	;jz	short gldds_2
 10865                                  	;sub	di, 22 ; 05/11/2020
 10866                                  	;push	cx ; *
 10867                                  	;jmp	short gldds_0
 10868                                  
 10869                                  	; 05/03/2019
 10870                                  	;call	check_ext_free_space
 10871                                  	;jc	short gldds_cancel
 10872                                  	
 10873                                  	; 01/11/2020
 10874                                  	; 30/10/2020
 10875                                  	;mov	ax, [ep_free_sectors]
 10876                                  	;mov	dx, [ep_free_sectors+2]
 10877                                  	
 10878                                  		; DX:AX = free sectors in extended partition
 10879                                  	;jmp	short gldds_2
 10880                                  gldds_1:
 10881 00002B7B BE[444B]                	mov	si, msg_use_entire_ep_space
 10882                                  	;call	print_msg
 10883                                  	
 10884                                  	; 01/11/2020
 10885                                  	; Calculate free space in extended partition
 10886                                  	;mov	ax, [ep_Size]
 10887                                  	;mov	dx, [ep_Size+2]
 10888                                  gldds_2:
 10889                                  	; 01/11/2020
 10890 00002B7E E82BEE                  	call	print_msg
 10891                                  
 10892                                  	; 13/03/2021
 10893                                  	;mov	al, [heads]
 10894                                  	;mul	byte [sectors]
 10895                                  	;;mov	cx, ax
 10896                                  	;; 12/03/2021
 10897                                  	;movzx	ecx, ax	
 10898                                  	
 10899                                  	;mov	ax, [ep_free_sectors]
 10900                                  	;mov	dx, [ep_free_sectors+2]
 10901                                  	; 12/03/2021
 10902 00002B81 66A1[B86D]              	mov	eax, [ep_free_sectors]
 10903                                  
 10904                                  	;; 01/11/2020
 10905                                  	;; this is needed for partition size input
 10906                                  	;; (maximum available sectors)
 10907                                  	;;mov	[pp_Sectors], ax
 10908                                  	;;mov	[pp_Sectors+2], dx
 10909                                  
 10910                                  	;; 01/11/2020
 10911                                  	;; subtrack start offset (which always equals to spt value)
 10912                                  	;;sub	ax, [sectors]
 10913                                  	;;sbb	dx, 0
 10914                                  
 10915                                  	;;mov	cx, ax
 10916                                  	;;mov	al, [heads]
 10917                                  	;;mul	byte [sectors]
 10918                                  	;;xchg	ax, cx
 10919                                  	;	; dx:ax = sectors
 10920                                  	;	; cx = heads*spt 
 10921                                  	;;call	div32
 10922                                  	;	; ax = cylinders
 10923                                  	;	; bx = remainder
 10924                                   	;	; dx = 0
 10925                                  	;;and	bx, bx
 10926                                  	;;jz	short gldds_3
 10927                                  	;;inc	ax
 10928                                  	; 01/11/2020
 10929                                  	;div	cx
 10930                                  	; 12/03/2021
 10931 00002B85 6631D2                  	xor	edx, edx
 10932                                  	;div	ecx
 10933                                  	; 13/03/2021
 10934 00002B88 66F736[EC69]            	div	dword [hs] ; heads*spt
 10935                                  
 10936                                  	;and	dx, dx
 10937                                  	;jz	short gldds_3
 10938                                  	;inc	ax
 10939                                  gldds_3:
 10940                                  	;mov	[lcylinders], ax ; <= 65535 (< 65535)
 10941                                  	; 12/03/2021
 10942 00002B8D 66A3[BC6D]              	mov	[lcylinders], eax ; <= 267369
 10943                                  gldds_getchar:
 10944 00002B91 30E4                    	xor	ah, ah
 10945 00002B93 CD16                    	int	16h
 10946                                  
 10947 00002B95 3C1B                    	cmp	al, 27 ; ESCAPE key
 10948 00002B97 7419                    	je	short gldds_cancel
 10949 00002B99 24DF                    	and	al, 0DFh
 10950 00002B9B 3C4E                    	cmp	al, 'N'
 10951 00002B9D 741D                    	je	short gldds_4
 10952 00002B9F 3C59                    	cmp	al, 'Y'
 10953 00002BA1 75EE                    	jne	short gldds_getchar
 10954                                  
 10955                                  	; 01/11/2020
 10956                                  	;mov	word [lcylinders], 65535 ; sign for all free sectors
 10957                                  	; 12/03/2021
 10958 00002BA3 66C706[BC6D]FFFFFF-     	mov	dword [lcylinders], 0FFFFFFFFh
 10958 00002BAB FF                 
 10959                                  				 ; sign for all free sectors
 10960 00002BAC BE[9259]                	mov	si, _msg_YES
 10961                                  	;call	print_msg
 10962                                  	;retn
 10963 00002BAF E9FAED                  	jmp	print_msg
 10964                                  
 10965                                  gldds_cancel:
 10966                                  	;mov	word [lcylinders], 0
 10967                                  	; 12/03/2021
 10968 00002BB2 66C706[BC6D]000000-     	mov	dword [lcylinders], 0
 10968 00002BBA 00                 
 10969                                  gldds_28:
 10970 00002BBB C3                      	retn
 10971                                  gldds_4:
 10972 00002BBC BE[9859]                	mov	si, _msg_NO
 10973 00002BBF E8EAED                  	call	print_msg
 10974                                  gldds_26:
 10975 00002BC2 B80300                  	mov	ax, 3 ; clear screen
 10976 00002BC5 CD10                    	int	10h
 10977                                  
 10978 00002BC7 BE[FD44]                	mov	si, msg_create_dos_partition_h
 10979 00002BCA E8DFED                  	call	print_msg
 10980                                  
 10981 00002BCD BE[045F]                	mov	si, msg_create_ldd_s
 10982 00002BD0 E8D9ED                  	call	print_msg
 10983 00002BD3 BE[CF4A]                	mov	si, msg_press_esc_to_cancel
 10984 00002BD6 E8D3ED                  	call	print_msg
 10985                                  gldds_25:
 10986 00002BD9 30E4                    	xor	ah, ah
 10987 00002BDB CD16                    	int	16h
 10988                                  
 10989 00002BDD 3C1B                    	cmp	al, 27 ; ESCAPE key
 10990 00002BDF 7502                    	jne	short gldds_5
 10991                                  
 10992 00002BE1 EBCF                    	jmp	short gldds_cancel
 10993                                  gldds_5:
 10994                                  	; 04/03/2019
 10995 00002BE3 3C20                    	cmp	al, 32 ; SPACE key
 10996 00002BE5 74D4                    	je	short gldds_28
 10997                                  	
 10998                                  	; 01/11/2020
 10999                                  	;mov	byte [pSize_unit], '%'
 11000 00002BE7 3C25                    	cmp	al, '%'
 11001 00002BE9 7416                    	je	short gldds_6
 11002                                  	;mov	byte [pSize_unit], 'M'
 11003 00002BEB 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
 11004                                  	;je	short gldds_6
 11005 00002BED 7504                    	jne	short gldds_29
 11006                                  	; 01/11/2020
 11007 00002BEF B04D                    	mov	al, 'M'
 11008 00002BF1 EB0E                    	jmp	short gldds_6
 11009                                  gldds_29:
 11010 00002BF3 24DF                    	and	al, 0DFh
 11011 00002BF5 3C4D                    	cmp	al, 'M'
 11012 00002BF7 7408                    	je	short gldds_6
 11013                                  	;mov	[pSize_unit], al
 11014 00002BF9 3C47                    	cmp	al, 'G'
 11015 00002BFB 7404                    	je	short gldds_6
 11016 00002BFD 3C43                    	cmp	al, 'C'
 11017 00002BFF 75D8                    	jne	short gldds_25
 11018                                  gldds_6:
 11019                                  	; 01/11/2020
 11020 00002C01 A2[D669]                	mov	[pSize_unit], al
 11021                                  
 11022                                  	; Set maximum sector count (all of extended partition)
 11023                                  	;mov	al, [sectors]
 11024                                  	;mul	byte [heads]
 11025                                  	;mul	word [lcylinders]
 11026                                  	; 01/11/2020	
 11027                                  	;mov	ax, [ep_free_sectors]
 11028                                  	;mov	dx, [ep_free_sectors+2]
 11029                                  	;mov	[pp_Sectors], ax
 11030                                  	;mov	[pp_Sectors+2], dx
 11031                                  	; 12/03/2021
 11032 00002C04 66A1[B86D]              	mov	eax, [ep_free_sectors]
 11033 00002C08 66A3[C469]              	mov	[pp_Sectors], eax
 11034                                  
 11035 00002C0C E80BF0                   	call	partition_size_input
 11036 00002C0F 72A1                    	jc	short gldds_cancel
 11037                                  		; DX:AX = Partition size in sectors
 11038                                  	;or	bx, bx
 11039                                  	;jnz	short gldds_cancel
 11040                                  
 11041                                  	; 01/11/2020
 11042                                  	;mov	[ppn_Sectors], ax
 11043                                  	;mov	[ppn_Sectors+2], dx
 11044                                  	; 12/03/2021
 11045 00002C11 66A3[F869]              	mov	[ppn_Sectors], eax ; edx = 0
 11046                                  		
 11047                                  	;mov	cx, ax
 11048                                  	;mov	al, [heads]
 11049                                  	;mul	byte [sectors]
 11050                                  	;xchg	ax, cx
 11051                                  	;	; dx:ax = sectors
 11052                                  	;	; cx = heads*spt 
 11053                                  	;call	div32
 11054                                  	;	; ax = cylinders
 11055                                  	;	; bx = remainder
 11056                                   	;	; dx = 0
 11057                                  	; 02/11/2020
 11058                                  	;and	bx, bx
 11059                                  	;jz	short gldds_7
 11060                                  	;inc	ax
 11061                                  
 11062                                  	; 13/03/2021
 11063                                  	; eax = partition size input, edx = 0
 11064 00002C15 66F736[EC69]            	div	dword [hs] ; heads*sectors  ; <= 16065
 11065                                  	; eax = cylinders, dx = remainder
 11066 00002C1A 09D2                    	or	dx, dx
 11067 00002C1C 7402                    	jz	short gldds_7
 11068 00002C1E 6640                    	inc	eax ; +1
 11069                                  gldds_7:
 11070                                  	;cmp	ax, [lcylinders]
 11071                                  	; 13/03/2021
 11072 00002C20 663B06[BC6D]            	cmp	eax, [lcylinders]
 11073 00002C25 7705                    	ja	short gldds_9
 11074                                  gldds_8:
 11075                                  	; OK
 11076                                  	;mov	[lcylinders], ax
 11077                                  	; 13/03/2021
 11078 00002C27 66A3[BC6D]              	mov	[lcylinders], eax
 11079 00002C2B C3                      	retn
 11080                                  
 11081                                  gldds_9:
 11082                                  	; Partition size limit message
 11083                                  	
 11084 00002C2C 803E[D669]43            	cmp	byte [pSize_unit], 'C'
 11085 00002C31 7415                    	je	short gldds_10
 11086                                  
 11087                                  	; Tolerate 1 cylinder if unit is not cylinder
 11088                                  	;dec	ax
 11089                                  	;cmp	ax, [lcylinders]
 11090                                  	;jna	short gldds_8
 11091                                  
 11092                                  	; 01/11/2020
 11093                                  	; Tolerate sectors if sectorcount doesn't over ep limit
 11094                                  	;mov	ax, [ppn_Sectors]
 11095                                  	;mov	dx, [ppn_Sectors+2]
 11096                                  	;cmp	dx, [ep_free_sectors+2]
 11097                                  	;ja	short gldds_10
 11098                                  	;jb	short gldds_30
 11099                                  	;cmp	ax, [ep_free_sectors]
 11100                                  	;ja	short gldds_10
 11101                                  	; 13/03/2021
 11102 00002C33 66A1[F869]              	mov	eax, [ppn_Sectors]
 11103 00002C37 663B06[B86D]            	cmp	eax, [ep_free_sectors]
 11104 00002C3C 770A                    	ja	short gldds_10
 11105                                  gldds_30:
 11106                                  	;mov	word [lcylinders], 65535 ; sign for all free sectors
 11107                                  	; 13/03/2021
 11108 00002C3E 66C706[BC6D]FFFFFF-     	mov	dword [lcylinders], 0FFFFFFFFh
 11108 00002C46 FF                 
 11109 00002C47 C3                      	retn
 11110                                  
 11111                                  gldds_10:
 11112                                  	; clear screen
 11113 00002C48 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
 11114 00002C4B CD10                      	int	10h
 11115                                  
 11116 00002C4D BE[FD44]                	mov	si, msg_create_dos_partition_h ; header
 11117 00002C50 E859ED                  	call	print_msg
 11118                                  
 11119 00002C53 BE[B15A]                	mov	si, msg_partition_size_limit
 11120 00002C56 E853ED                  	call	print_msg
 11121                                  
 11122 00002C59 803E[D669]4D            	cmp	byte [pSize_unit], 'M'
 11123 00002C5E 7414                    	je	short gldds_11
 11124                                  
 11125 00002C60 803E[D669]25            	cmp	byte [pSize_unit], '%'
 11126 00002C65 745E                    	je	short gldds_22
 11127                                  
 11128 00002C67 803E[D669]43            	cmp	byte [pSize_unit], 'C'
 11129 00002C6C 7506                    	jne	short gldds_11
 11130                                  
 11131                                  	;mov	ax, [lcylinders]
 11132                                  	; 13/03/2021
 11133 00002C6E 66A1[BC6D]              	mov	eax, [lcylinders]
 11134 00002C72 EB15                    	jmp	short gldds_12
 11135                                  gldds_11:
 11136                                  	; 'M'
 11137                                  	;mov	ax, [pp_Sectors]
 11138                                  	;mov	dx, [pp_Sectors+2]
 11139                                  	;mov	cx, 2*1024 ; sectors -> MB
 11140                                  	;call	div32
 11141                                  	;	; DX = 0 
 11142                                  	;	; AX = Available space in Megabytes
 11143                                  	; 13/03/2021
 11144 00002C74 31FF                    	xor	di, di ; (**)
 11145 00002C76 66A1[C469]              	mov	eax, [pp_Sectors]
 11146                                  	;xor	edx, edx
 11147 00002C7A 31D2                    	xor	dx, dx
 11148                                  	;mov	ecx, 2*1024
 11149 00002C7C B90008                  	mov	cx, 2*1024
 11150 00002C7F 66F7F1                  	div	ecx
 11151 00002C82 6683F801                	cmp	eax, 1
 11152 00002C86 7601                    	jna	short gldds_12
 11153 00002C88 47                      	inc	di ; (**)
 11154                                  gldds_12:
 11155 00002C89 B90A00                  	mov	cx, 10
 11156 00002C8C 89E5                    	mov	bp, sp
 11157                                  gldds_13:
 11158 00002C8E 31D2                    	xor	dx, dx
 11159                                  	;mov	cx, 10
 11160 00002C90 F7F1                    	div	cx
 11161 00002C92 52                      	push	dx ; *
 11162 00002C93 83F809                  	cmp	ax, 9
 11163 00002C96 77F6                    	ja	short gldds_13
 11164                                  gldds_14:
 11165 00002C98 BB0700                  	mov	bx, 07h
 11166 00002C9B 09C0                    	or	ax, ax
 11167 00002C9D 7501                    	jnz	short gldds_16
 11168                                  gldds_15:
 11169 00002C9F 58                      	pop	ax ; *
 11170                                  gldds_16:
 11171 00002CA0 0430                    	add	al, '0'
 11172                                  gldds_17:
 11173 00002CA2 B40E                    	mov	ah, 0Eh
 11174                                  	;mov	bx, 07h
 11175 00002CA4 CD10                    	int	10h  ; write character (as tty)
 11176                                  
 11177 00002CA6 39EC                    	cmp	sp, bp
 11178 00002CA8 72F5                    	jb	short gldds_15
 11179                                  
 11180 00002CAA 803E[D669]25            	cmp	byte [pSize_unit], '%'
 11181 00002CAF 7508                    	jne	short gldds_18
 11182                                  
 11183 00002CB1 3C25                    	cmp	al, '%'
 11184 00002CB3 743C                    	je	short gldds_21
 11185 00002CB5 B025                    	mov	al, '%'
 11186 00002CB7 EBE9                    	jmp	short gldds_17
 11187                                  gldds_18:
 11188 00002CB9 803E[D669]43            	cmp	byte [pSize_unit], 'C'
 11189 00002CBE 751D                    	jne	short gldds_19
 11190                                  
 11191 00002CC0 BE[4D5B]                	mov	si, msg_cylinders
 11192 00002CC3 EB29                    	jmp	short gldds_20
 11193                                  
 11194                                  gldds_22:
 11195                                  	; '%'
 11196                                  	; 01/11/2020
 11197                                  	;mov	dx, [ep_Size+2]
 11198                                  	;mov	ax, [ep_Size] ; *
 11199                                  	;and	dx, dx
 11200                                  	;jz	short gldds_33 ; dx = 0
 11201                                  	; 13/03/2021
 11202                                  	;mov	cx, 1
 11203                                  ;gldds_31:
 11204                                  	;shl	cx, 1
 11205                                  	;call	div32
 11206                                  	;or	dx, dx
 11207                                  	;jz	short gldds_32 ; *
 11208                                  	;mov	ax, [ep_Size]
 11209                                  	;mov	dx, [ep_Size+2]
 11210                                  	;jmp	short gldds_31
 11211                                  ;gldds_32:
 11212                                  	;mov	dx, [ep_free_sectors+2]
 11213                                  	; ep free sectors <= ep size
 11214                                  gldds_33:
 11215                                  	;push	ax ; * ; dx = 0 (ep size weight)
 11216                                  	;mov	ax, [ep_free_sectors]
 11217                                  	; 13/03/2021
 11218 00002CC5 66A1[B86D]              	mov	eax, [ep_free_sectors]
 11219                                  	;mov	ecx, 100
 11220 00002CC9 B96400                  	mov	cx, 100
 11221                                  	;and	dx, dx
 11222                                  	;jnz	short gldds_34
 11223                                  	;mul	cx
 11224                                  	;jmp	short gldds_35
 11225                                  ;gldds_34:
 11226                                  	;call	mul32
 11227                                  	;	; dx:ax = 100 * ep free sectors weight
 11228                                  	; 13/03/2021
 11229                                  	;xor	edx, edx
 11230 00002CCC 31D2                    	xor	dx, dx
 11231 00002CCE 66F7E1                  	mul	ecx ; 100 * ep free sectors
 11232                                  ;gldds_35:
 11233                                  	;pop	cx ; *
 11234                                  	;call	div32 ; 100 * ep free sectors / ep size
 11235                                  	;	; ax = % value (<= 100)
 11236 00002CD1 66F736[106C]            	div	dword [ep_Size]
 11237                                  	
 11238 00002CD6 09C0                    	or	ax, ax
 11239                                  	;jnz	short gldds_23
 11240 00002CD8 75AF                    	jnz	short gldds_12 ; 13/03/2021
 11241 00002CDA 40                      	inc	ax ; 0 -> 1
 11242                                  	; 13/03/2021
 11243 00002CDB EBAC                    	jmp	short gldds_12
 11244                                  
 11245                                  ;gldds_23:	
 11246                                  	;mov	bp, sp
 11247                                  	;mov	cx, 10
 11248                                  ;gldds_24:	
 11249                                  	;xor	dx, dx
 11250                                  	;div	cx
 11251                                  	;push	dx ; *
 11252                                  	;cmp	ax, 9
 11253                                  	;ja	short gldds_24
 11254                                  	;jmp	short gldds_14
 11255                                  	
 11256                                  gldds_19:
 11257 00002CDD BE[615B]                	mov	si, msg_megabytes
 11258 00002CE0 C606[6A5B]73            	mov	byte [msg_megabytes_s], 's'
 11259                                  	;cmp	di, 1
 11260                                  	;ja	short gldds_20
 11261                                  	; 13/03/2021
 11262 00002CE5 09FF                    	or	di, di ; (**)
 11263 00002CE7 7505                    	jnz	short  gldds_20
 11264                                  	; di = 0 -> 1 MB
 11265 00002CE9 C606[6A5B]00            	mov	byte [msg_megabytes_s], 0
 11266                                  gldds_20:
 11267 00002CEE E8BBEC                  	call	print_msg
 11268                                  gldds_21:
 11269 00002CF1 BE[FE5A]                	mov	si, msg_partition_size_limit_r
 11270 00002CF4 E8B5EC                  	call	print_msg
 11271                                  gldds_27:
 11272 00002CF7 30E4                    	xor	ah, ah
 11273 00002CF9 CD16                    	int	16h
 11274                                  	
 11275 00002CFB 3C1B                    	cmp	al, 27 ; ESCAPE key
 11276 00002CFD 0F84C1FE                	je	gldds_26
 11277 00002D01 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
 11278 00002D03 75F2                    	jne	short gldds_27
 11279                                  
 11280                                  	;mov	ax, [lcylinders]
 11281 00002D05 C3                      	retn
 11282                                  	
 11283                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11284                                  ; initialize extended (dos) partition table 
 11285                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11286                                  ; 18/10/2020 (fdisk3.s)
 11287                                  ; 26/02/2019 (hdimage.s)
 11288                                  
 11289                                  	; 09/03/2021
 11290                                  	; 05/11/2020 (fdisk4.s)
 11291                                  init_ext_partition_table:
 11292                                  
 11293                                  	; INPUT -> 
 11294                                  	;	[epnumber] = extended partition number
 11295                                  	;
 11296                                  	; OUTPUT -> none
 11297                                  
 11298                                  ; Display Method: ; 04/03/2019
 11299                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
 11300                                  ;LDD 2 <- LDD_START1, ebr 1st entry <- EBR 1
 11301                                  ;LDD 3 <- LDD_START2, ebr 1st entry <- EBR 2
 11302                                  ;LDD 4 <- LDD_START3, ebr 1st entry <- EBR 3
 11303                                  ;LDD 5 <- LDD_START3, ebr 2nd entry (LDD 5 is not displayed)
 11304                                  
 11305                                  	; 08/03/2019
 11306                                  
 11307                                  	; clear extended partition table structure/list
 11308                                  
 11309 00002D06 BF[CE6C]                	mov	di, ext_table_boot_ind
 11310 00002D09 89FE                    	mov	si, di ; 28/02/2019
 11311                                  	;mov	cx, 36 ; 18*4 = 72 bytes
 11312                                  	; 05/11/2020
 11313 00002D0B B92C00                  	mov	cx, 44 ; 22*4 = 84 bytes
 11314 00002D0E 31C0                    	xor	ax, ax ; 0
 11315 00002D10 F3AB                    	rep	stosw
 11316 00002D12 89F7                    	mov	di, si ; 28/02/2019
 11317                                  
 11318                                  	;mov	byte [ldrives], 0
 11319 00002D14 A2[006A]                	mov	[ldrives], al ; 0
 11320                                  
 11321                                  	;cmp	byte [epnumber], 1
 11322                                  	;jb	short iept_0
 11323                                  
 11324 00002D17 A0[CD6C]                	mov	al, [epnumber]
 11325 00002D1A FEC8                    	dec	al
 11326                                  	;mov	ah, 18 ; partition table structure size 
 11327                                  	; 05/11/2020
 11328 00002D1C B416                    	mov	ah, 22 ; partition table structure size
 11329 00002D1E F6E4                    	mul	ah
 11330                                  	;mov	si, part_table_rel_sec_lw
 11331 00002D20 BE[806C]                	mov	si, part_table_rel_sec ; 09/03/2021
 11332 00002D23 01C6                    	add	si, ax
 11333                                  
 11334                                  	; 02/11/2020
 11335                                  	;(save end cylinder for comparising later)
 11336 00002D25 8B44FE                  	mov	ax, [si-2] ; part_table_end_cyl 
 11337                                  			; 16 bit cylinder number
 11338 00002D28 A3[C26D]                	mov	[endcyl], ax
 11339                                  
 11340                                  	;mov	ax, [si]
 11341                                  	;mov	dx, [si+2]
 11342                                  	;mov	[ep_StartSector], ax
 11343                                  	;mov	[ep_StartSector+2], dx
 11344                                  	;mov	cx, [si+4]
 11345                                  	;mov	bx, [si+6]
 11346                                  	;mov	[ep_Size], cx
 11347                                  	;mov	[ep_Size+2], bx
 11348                                  	;sub	cx, 1
 11349                                  	;sbb	bx, 0
 11350                                  	;add	cx, ax
 11351                                  	;adc	bx, dx 
 11352                                  	;mov	[ep_EndSector], cx
 11353                                  	;mov	[ep_EndSector+2], bx
 11354                                  
 11355                                  	; 09/03/2021
 11356 00002D2B 668B04                  	mov	eax, [si]
 11357 00002D2E 66A3[086C]              	mov	[ep_StartSector], eax
 11358 00002D32 668B5404                	mov	edx, [si+4]
 11359 00002D36 668916[106C]            	mov	[ep_Size], edx
 11360 00002D3B 6601C2                  	add	edx, eax
 11361 00002D3E 664A                    	dec	edx
 11362 00002D40 668916[0C6C]            	mov	[ep_EndSector], edx
 11363 00002D45 6631D2                  	xor	edx, edx
 11364                                  
 11365                                  	; 27/02/2019
 11366                                  	;mov	[ldd_start], ax
 11367                                  	;mov	[ldd_start+2], dx
 11368                                  	; 09/03/2021
 11369 00002D48 66A3[986D]              	mov	[ldd_start], eax
 11370                                  
 11371                                  	; 03/03/2019
 11372                                  	;mov	word [ldd_size], 0
 11373                                  	;mov	word [ldd_size+2], 0
 11374                                  	
 11375 00002D4C BB[066A]                	mov	bx, ebr_buffer
 11376                                  	; dx:ax = Extended partition address
 11377                                  	; es:bx = Extended partition buffer
 11378                                  	; 09/03/2021
 11379                                  	; eax = Extended partition address 
 11380                                  	; es:bx = Extended partition buffer
 11381                                   
 11382 00002D4F E869EC                  	call	read_hd_sector
 11383 00002D52 7209                    	jc	short iept_0
 11384                                  
 11385                                  	; Check EBR if it is a valid boot record or not
 11386 00002D54 813E[046C]55AA          	cmp	word [ebr_buffer+510], 0AA55h
 11387 00002D5A 7402                    	je	short iept_1
 11388                                  iept_stc_retn:
 11389 00002D5C F9                      	stc
 11390                                  iept_0:
 11391 00002D5D C3                      	retn
 11392                                  iept_1:
 11393                                  	; Check PTE 1, if it is valid or not
 11394 00002D5E A0[C86B]                	mov	al, [ebr_buffer+446+ptFileSystemID]
 11395 00002D61 20C0                    	and	al, al
 11396 00002D63 74F7                    	jz	short iept_stc_retn ; empty pte, error
 11397 00002D65 3C05                    	cmp	al, 5
 11398 00002D67 74F3                    	je	short iept_stc_retn ; extended partition, error
 11399                                  	; 24/10/2020
 11400 00002D69 3C0F                    	cmp	al, 0Fh
 11401 00002D6B 74EF                    	je	short iept_stc_retn ; extended partition, error
 11402                                  
 11403                                  	;inc	byte [ldrives] ; logical (dos) drive count
 11404                                  
 11405 00002D6D BE[C46B]                	mov	si, ebr_buffer+446 ; Partition table offset
 11406 00002D70 B90400                  	mov	cx, 4
 11407                                  
 11408                                  	; set partition (logical -dos- drive) data
 11409 00002D73 A5                      	movsw	; boot indicator, beginning head
 11410 00002D74 AC                      	lodsb
 11411 00002D75 88C4                    	mov	ah, al
 11412 00002D77 243F                    	and	al, 3Fh
 11413 00002D79 AA                      	stosb	; beginning sector
 11414 00002D7A C0EC06                  	shr	ah, 6
 11415 00002D7D AC                      	lodsb	; beginning cylinder
 11416 00002D7E AB                      	stosw
 11417                                  	; 09/03/2021
 11418 00002D7F 31C0                    	xor	ax, ax
 11419 00002D81 AB                      	stosw
 11420                                  	;	
 11421 00002D82 A5                      	movsw	; partition id, end head
 11422 00002D83 AC                      	lodsb
 11423 00002D84 88C4                    	mov	ah, al
 11424 00002D86 243F                    	and	al, 3Fh
 11425 00002D88 AA                      	stosb	; end sector
 11426 00002D89 C0EC06                  	shr	ah, 6
 11427 00002D8C AC                      	lodsb	; end cylinder
 11428 00002D8D AB                      	stosw
 11429                                  	; 09/03/2021
 11430 00002D8E 31C0                    	xor	ax, ax
 11431 00002D90 AB                      	stosw
 11432                                  	;
 11433                                  
 11434                                  	; 04/03/2019
 11435 00002D91 8A1E[006A]              	mov	bl, [ldrives]
 11436                                  	;dec 	bl
 11437                                  	;jnz	short iept_2
 11438                                  
 11439                                  	; 05/03/2019
 11440 00002D95 08DB                    	or	bl, bl
 11441 00002D97 7511                    	jnz	short iept_2
 11442                                  
 11443                                  	;mov	ax, [si]   ; start sector of 1st LDD (offset)
 11444                                  	;mov	dx, [si+2]
 11445                                  	;add	ax, [si+4] ; size of 1st LDD (volume)
 11446                                  	;adc	dx, [si+6]
 11447                                  	; 09/03/2021
 11448 00002D99 668B04                  	mov	eax, [si]
 11449 00002D9C 66034404                	add	eax, [si+4]
 11450                                  
 11451                                  	;mov	[ldd_size], ax ; size of 1st LDD (partition)
 11452                                  	;mov	[ldd_size+2], dx
 11453                                  	; 09/03/2021
 11454 00002DA0 66A3[A86D]              	mov	[ldd_size], eax
 11455                                  
 11456                                  	; 05/03/2019
 11457 00002DA4 FE06[006A]              	inc	byte [ldrives] ; logical (dos) drive count
 11458 00002DA8 FEC3                    	inc	bl
 11459                                  iept_2:
 11460 00002DAA F3A5                    	rep	movsw ; copy start sector (LBA) and sector count
 11461                                  
 11462                                  	; get next extended partition (logical -dos- drive) data
 11463 00002DAC 8A4404                  	mov	al, [si+ptFileSystemID]
 11464 00002DAF 20C0                    	and	al, al ; EMPTY
 11465 00002DB1 74AA                    	jz	short iept_0 ; end of logical -dos- drive chain
 11466                                  
 11467 00002DB3 3C05                    	cmp	al, 5 ; EXTENDED
 11468                                  	;jne	short iept_stc_retn  ; 2nd PTE must have
 11469                                  	;			     ; extended partition ID
 11470 00002DB5 7404                    	je	short iept_4
 11471                                  	; 24/10/2020
 11472 00002DB7 3C0F                    	cmp	al, 0Fh ; EXTENDED (LBA)
 11473 00002DB9 75A1                    	jne	short iept_stc_retn  ; 2nd PTE must have
 11474                                  				     ; extended partition ID
 11475                                  iept_4:
 11476                                  	; 05/03/2019
 11477 00002DBB FE06[006A]              	inc	byte [ldrives] ; logical (dos) drive count
 11478                                  
 11479                                  	;cmp	byte [ldrives], al ; 5
 11480 00002DBF 80FB04                  	cmp	bl, 4 ; number of logical dos drives (till here)
 11481 00002DC2 7332                    	jnb	short iept_3
 11482                                  
 11483 00002DC4 83C608                  	add	si, 8
 11484                                  
 11485                                  	;lodsw	
 11486                                  	;mov	dx, ax	; start sector
 11487                                  	;lodsw
 11488                                  	;xchg	dx, ax	; start sector + 2
 11489                                  	; 09/03/2021
 11490 00002DC7 66AD                    	lodsd
 11491                                  	
 11492                                  	; 04/03/2019
 11493                                  	;add	ax, [ep_StartSector]
 11494                                  	;adc	dx, [ep_StartSector+2]
 11495                                  	; 09/03/2021
 11496 00002DC9 660306[086C]            	add	eax, [ep_StartSector]
 11497                                  
 11498 00002DCE 30FF                    	xor	bh, bh
 11499 00002DD0 C0E302                  	shl	bl, 2 ; *4
 11500                                  
 11501                                  	; 28/02/2019
 11502                                  	;mov	[bx+ldd_start], ax ; start of (next) LDD (partition)
 11503                                  	;mov	[bx+ldd_start+2], dx
 11504                                  	; 09/03/2021
 11505 00002DD3 668987[986D]            	mov	[bx+ldd_start], eax
 11506                                  
 11507                                  	; 03/03/2019
 11508                                  	; set partition size for logical dos drive
 11509                                  	;mov	cx, [si]
 11510                                  	;mov	[bx+ldd_size], cx
 11511                                  	;mov	cx, [si+2]
 11512                                  	;mov	[bx+ldd_size+2], cx
 11513                                  	; 09/03/2021
 11514 00002DD8 668B14                  	mov	edx, [si]
 11515 00002DDB 668997[A86D]            	mov	[bx+ldd_size], edx
 11516 00002DE0 6629D2                  	sub	edx, edx
 11517                                  
 11518 00002DE3 BB[066A]                	mov	bx, ebr_buffer
 11519                                  
 11520                                  	; dx:ax = Extended partition address
 11521                                  	; es:bx = Extended partition buffer
 11522                                  	; 09/03/2021
 11523                                  	; eax = Extended partition address
 11524                                   
 11525 00002DE6 E8D2EB                  	call	read_hd_sector
 11526 00002DE9 720B                    	jc	short iept_3 ; 03/03/2019
 11527                                  
 11528                                  	; Check EBR if it is valid or not
 11529 00002DEB 813E[046C]55AA          	cmp	word [ebr_buffer+510], 0AA55h
 11530 00002DF1 0F8469FF                	je	iept_1
 11531                                  
 11532 00002DF5 F9                      	stc
 11533                                  iept_3:	
 11534 00002DF6 C3                      	retn
 11535                                  
 11536                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11537                                  ; delete logical -dos- drives in extended partition
 11538                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11539                                  ; 18/10/2020 (fdisk3.s)
 11540                                  
 11541                                  	; 12/03/2021
 11542                                  	; 09/03/2021 (fdisk4.s)
 11543                                  delete_logical_drives:
 11544                                  		; 27/02/2019 (hdimage.s)
 11545                                  
 11546                                  ; Delete Method: ; 04/03/2019
 11547                                  ;LDD 5 <- LDD_START3, ebr 2nd entry
 11548                                  ;LDD 4 <- LDD_START2, ebr 2nd entry
 11549                                  ;LDD 3 <- LDD_START1, ebr 2nd entry
 11550                                  ;LDD 2 <- LDD_START0, ebr 2nd entry
 11551                                  ;LDD 1 <- LDD_START0, ebr 1st entry
 11552                                  
 11553                                  	;cmp	byte [ldrives], 0
 11554                                  	;jna	short dld_stc
 11555                                  
 11556                                  	;mov	al, 5 ; extended partition (logical drives)
 11557                                  	;call	display_partition_table
 11558                                  	; 12/03/2021
 11559 00002DF7 E8A3F7                  	call	display_partition_table_x
 11560                                  
 11561 00002DFA A0[006A]                	mov	al, [ldrives]
 11562 00002DFD 0430                    	add	al, '0'
 11563 00002DFF A2[D75C]                	mov	[lddp_num], al
 11564                                  
 11565 00002E02 BE[845C]                	mov	si, msg_delete_ldd
 11566 00002E05 E8A4EB                  	call	print_msg
 11567                                  
 11568 00002E08 BE[CF4A]                	mov	si, msg_press_esc_to_cancel
 11569 00002E0B E89EEB                  	call	print_msg
 11570                                  dld_0:
 11571 00002E0E 30E4                    	xor	ah, ah
 11572 00002E10 CD16                    	int	16h
 11573                                  
 11574 00002E12 80FC53                  	cmp	ah, 53h  ; DELETE or DEL key
 11575 00002E15 751C                    	jne	short dld_1
 11576                                  
 11577                                  	; Delete PTE 1 & PTE 2 on EBR 1
 11578 00002E17 30E4                    	xor	ah, ah
 11579 00002E19 A0[006A]                	mov	al, [ldrives]
 11580 00002E1C FEC8                    	dec	al
 11581 00002E1E 7518                    	jnz	short dld_2
 11582                                  
 11583 00002E20 BF[C46B]                	mov	di, ebr_buffer+446
 11584 00002E23 B91000                  	mov	cx, 16
 11585 00002E26 F3AB                    	rep	stosw
 11586                                  
 11587                                  	; 04/03/2019
 11588                                  	; Clear ldd data in extended partition table/structure
 11589 00002E28 BF[CE6C]                	mov	di, ext_table_boot_ind
 11590 00002E2B B109                    	mov	cl, 9
 11591 00002E2D F3AB                    	rep	stosw
 11592 00002E2F 31F6                    	xor	si, si
 11593 00002E31 EB3D                    	jmp	short dld_3
 11594                                  dld_1:	
 11595 00002E33 3C1B                    	cmp	al, 27 ; ESC key
 11596 00002E35 75D7                    	jne	short dld_0
 11597                                  dld_5:
 11598 00002E37 C3                      	retn
 11599                                  
 11600                                  ;dld_stc:
 11601                                  ;	stc
 11602                                  ;	retn
 11603                                  
 11604                                  dld_2:
 11605                                  	; 04/03/2019
 11606                                  	; Delete 2nd PTE on EBR 2 to 4
 11607 00002E38 FEC8                    	dec	al 
 11608 00002E3A C0E002                  	shl	al, 2 ; * 4
 11609 00002E3D 89C6                    	mov	si, ax
 11610                                  
 11611                                  	;mov	ax, [si+ldd_start]
 11612                                  	;mov	dx, [si+ldd_start+2]
 11613                                  	; 09/03/2021
 11614 00002E3F 668B84[986D]            	mov	eax, [si+ldd_start]
 11615                                  
 11616 00002E44 BB[066A]                	mov	bx, ebr_buffer
 11617 00002E47 E871EB                  	call	read_hd_sector
 11618 00002E4A 7235                    	jc	short dld_4
 11619                                  
 11620 00002E4C BF[D46B]                	mov	di, ebr_buffer+446+16
 11621 00002E4F B90800                  	mov	cx, 8
 11622 00002E52 29C0                    	sub	ax, ax
 11623 00002E54 F3AB                    	rep	stosw
 11624                                  
 11625                                  	; 04/03/2019
 11626                                  	;cmp	byte [ldrives], 5
 11627                                  	;jnb	short dld_3
 11628 00002E56 8A26[006A]              	mov	ah, [ldrives]
 11629 00002E5A 80FC05                  	cmp	ah, 5
 11630 00002E5D 7311                    	jnb	short dld_3
 11631                                  
 11632                                  	; Clear ldd data in extended partition table/structure
 11633                                  	;mov	ah, [ldrives]
 11634 00002E5F FECC                    	dec	ah
 11635                                  	;mov	al, 18
 11636                                  	; 05/11/2020
 11637 00002E61 B016                    	mov	al, 22
 11638 00002E63 F6E4                    	mul	ah
 11639 00002E65 BF[CE6C]                	mov	di, ext_table_boot_ind
 11640 00002E68 01C7                    	add	di, ax
 11641                                  	;;mov	cx, 9
 11642                                  	;mov	cl, 9
 11643                                  	; 05/11/2020
 11644 00002E6A B10B                    	mov	cl, 11
 11645                                  	;xor	ax, ax
 11646 00002E6C 30C0                    	xor	al, al
 11647 00002E6E F3AB                    	rep	stosw
 11648                                  dld_3:
 11649                                  	; Write changed EBR
 11650                                  	;mov	ax, [si+ldd_start]
 11651                                  	;mov	dx, [si+ldd_start+2]
 11652                                  	; 09/03/2021
 11653 00002E70 668B84[986D]            	mov	eax, [si+ldd_start]
 11654                                  
 11655 00002E75 BB[066A]                	mov	bx, ebr_buffer
 11656 00002E78 E88FEB                  	call	write_hd_sector
 11657 00002E7B 7204                    	jc	short dld_4
 11658                                  
 11659                                  	; 28/02/2019
 11660 00002E7D FE0E[006A]              	dec	byte [ldrives]
 11661                                  dld_4:
 11662 00002E81 803E[006A]00            	cmp	byte [ldrives], 0
 11663 00002E86 0F876DFF                	ja	delete_logical_drives
 11664                                  
 11665 00002E8A C3                      	retn
 11666                                  
 11667                                  ;=============================================================================
 11668                                  ;        	initialized data
 11669                                  ;=============================================================================
 11670                                  
 11671                                  ; 12/10/2020
 11672 00002E8B 00                      int13h_x:	db	0
 11673                                  
 11674                                  TRDOS386_MASTERBOOT_SECTOR:
 11675 00002E8C <bin 200h>              	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR	
 11676                                  
 11677                                  TRDOS_FAT_hd_bs:
 11678                                  	;incbin 'TRHDBS.BIN'
 11679                                  	; 04/05/2024
 11680                                  TRDOS_FAT32_hd_bs:
 11681                                  	;incbin	'FAT32_BS.BIN' ; 27/04/2024
 11682 0000308C <bin 400h>              	incbin	'RD5HDBS3.BIN' ; 29/04/2024
 11683                                  TRDOS_FAT16_hd_bs: 
 11684                                  	;incbin	'FAT16_BS.BIN' ; 26/12/2017
 11685 0000348C <bin 200h>              	incbin	'RD5HDBS2.BIN' ; 20/04/2024
 11686                                  TRDOS_FAT12_hd_bs: 
 11687                                  	;incbin	'FAT12_BS.BIN' ; 26/12/2017
 11688 0000368C <bin 200h>              	incbin	'RD5HDBS1.BIN' ; 20/04/2024
 11689                                  
 11690                                  TRDOS_TRFS1_chs_bs:
 11691 0000388C <bin 200h>              	incbin	'TRFS1CHS.BIN' ; Singlix FS1 (CHS+LBA Disk) BS
 11692                                  TRDOS_TRFS1_lba_bs:
 11693 00003A8C <bin 200h>              	incbin	'TRFS1LBA.BIN' ; Singlix FS1 (LBA Disk) BS
 11694                                  
 11695 00003C8C 00                      	db	0
 11696                                  
 11697                                  hexchrs:
 11698 00003C8D 303132333435363738-     	db	'0123456789ABCDEF'
 11698 00003C96 39414243444546     
 11699                                  
 11700                                  ; 05/11/2020
 11701 00003C9D 00                      	db	0
 11702                                  
 11703                                  align 2
 11704                                  
 11705                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
 11706                                  
 11707                                  sectors: ; sectors per track (63)
 11708 00003C9E 3F00                    	dw 63
 11709                                  heads:	 ; number of heads (16 or 32 or 64) 
 11710 00003CA0 1000                    	dw 16
 11711                                  cylinders: ; number of cylinders (16 to 1024)
 11712                                  	;dw 1024
 11713                                  	;dw 0 ; 16/10/2020 (double word)
 11714 00003CA2 00040000                	dd 1024 ; 05/11/2020 
 11715                                  
 11716                                  ; 05/11/2020
 11717                                  
 11718                                  ;random:
 11719                                  ;	db 0  ; random write to file (0 = sequental)
 11720                                  ;newdisk:
 11721                                  ;	db 0
 11722                                  
 11723                                  FileSys_Names: ; 2003-2017
 11724                                  ; (Valid FileSystems for TRDOS 386, SINGLIX, RETRO UNIX OS projects in 2017)
 11725 00003CA6 464154313220202020-     FS_FAT12:     db "FAT12         "  ; 01h = FAT12
 11725 00003CAF 2020202020         
 11726 00003CB4 58454E495820202020-     FS_XENIX:     db "XENIX         "  ; 02h , XENIX System V root
 11726 00003CBD 2020202020         
 11727 00003CC2 58454E495820757372-     FS_XENIX_USR: db "XENIX usr     "  ; 03h , XENIX System V user
 11727 00003CCB 2020202020         
 11728 00003CD0 464154313620283034-     FS_FAT16:     db "FAT16 (04h)   "  ; 04h = FAT16 < 32MB
 11728 00003CD9 6829202020         
 11729 00003CDE 455854454E44454420-     FS_EXT_CHS:   db "EXTENDED (CHS)"  ; 05h = Extended DOS Partition
 11729 00003CE7 2843485329         
 11730 00003CEC 464154313620283036-     FS_FAT16_BIG: db "FAT16 (06h)   "  ; 06h = FAT16 > 32MB, CHS mode
 11730 00003CF5 6829202020         
 11731 00003CFA 4E5446532020202020-     FS_NTFS:      db "NTFS          "  ; 07h , WINDOWS NTFS Partition
 11731 00003D03 2020202020         
 11732 00003D08 464154333220284348-     FS_FAT32_CHS: db "FAT32 (CHS)   "  ; 0Bh = FAT32, CHS mode
 11732 00003D11 5329202020         
 11733 00003D16 464154333220284C42-     FS_FAT32_LBA: db "FAT32 (LBA)   "  ; 0Ch = FAT32, LBA mode
 11733 00003D1F 4129202020         
 11734 00003D24 464154313620284C42-     FS_FAT16_LBA: db "FAT16 (LBA)   "  ; 0Eh = FAT16, LBA mode
 11734 00003D2D 4129202020         
 11735 00003D32 455854454E44454420-     FS_EXT_LBA:   db "EXTENDED (LBA)"  ; 0Fh = Extented Partition, LBA mode
 11735 00003D3B 284C424129         
 11736 00003D40 554E49582053595354-     FS_UNIX_SYSV: db "UNIX SYSTEM V "  ; 63h , SCO UNIX, UNIXWARE, OPENSERVER
 11736 00003D49 454D205620         
 11737 00003D4E 524554524F20554E49-     FS_RETROUNIX: db "RETRO UNIX    "  ; 71h , Retro UNIX 386 v2 Partition
 11737 00003D57 5820202020         
 11738 00003D5C 554E49582056372020-     FS_UNIX_V7:   db "UNIX V7       "  ; 72h , UNIX v7 x86 Partition  
 11738 00003D65 2020202020         
 11739 00003D6A 4C494E555820535741-     FS_LINUXSWAP: db "LINUX SWAP    "  ; 82h , LINUX SWAP Partition
 11739 00003D73 5020202020         
 11740 00003D78 4C494E555820202020-     FS_LINUX:     db "LINUX         "  ; 83h , LINUX NATIVE (ext2) Partition
 11740 00003D81 2020202020         
 11741 00003D86 4C494E555820455854-     FS_LINUXEXT:  db "LINUX EXTENDED"  ; 85h , LINUX EXTENDED Partition
 11741 00003D8F 454E444544         
 11742 00003D94 524444202020202020-     FS_TRDD:      db "RDD           "  ; A0h , (Random Data Disk) LBA
 11742 00003D9D 2020202020         
 11743 00003DA2 53494E474C49582046-     FS_TRFS:      db "SINGLIX FS1   "  ; A1h , (32 bit, 512 bytes per sector)
 11743 00003DAB 5331202020         
 11744 00003DB0 554E4B4E4F574E2046-     FS_OTHERS:    db "UNKNOWN FS    "  ; Another or Unknown File Systems
 11744 00003DB9 5320202020         
 11745                                   
 11746                                  valid_partitions: ; (*)
 11747 00003DBE 01020304050607          	      db 01h, 02h, 03h, 04h, 05h, 06h, 07h
 11748 00003DC5 0B0C0E0F637172          	      db 0Bh, 0Ch, 0Eh, 0Fh, 63h, 71h, 72h
 11749 00003DCC 828385A0A1              	      db 82h, 83h, 85h, 0A0h, 0A1h 			
 11750                                  
 11751                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11752                                  ;  messages
 11753                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11754                                  
 11755                                  CHS_msg: ; 80 bytes per row
 11756 00003DD1 507265737320274327-     db  "Press 'C' to set cylinders then press '+,-' keys to change number of cylinders. "
 11756 00003DDA 20746F207365742063-
 11756 00003DE3 796C696E6465727320-
 11756 00003DEC 7468656E2070726573-
 11756 00003DF5 7320272B2C2D27206B-
 11756 00003DFE 65797320746F206368-
 11756 00003E07 616E6765206E756D62-
 11756 00003E10 6572206F662063796C-
 11756 00003E19 696E646572732E20   
 11757 00003E21 507265737320274827-     db  "Press 'H' to set heads then press '+,-' keys to change number of heads.         "
 11757 00003E2A 20746F207365742068-
 11757 00003E33 65616473207468656E-
 11757 00003E3C 20707265737320272B-
 11757 00003E45 2C2D27206B65797320-
 11757 00003E4E 746F206368616E6765-
 11757 00003E57 206E756D626572206F-
 11757 00003E60 662068656164732E20-
 11757 00003E69 2020202020202020   
 11758 00003E71 507265737320275327-     db  "Press 'S' to set sectors then press '+,-' keys to change numb of sectors/track. "
 11758 00003E7A 20746F207365742073-
 11758 00003E83 6563746F7273207468-
 11758 00003E8C 656E20707265737320-
 11758 00003E95 272B2C2D27206B6579-
 11758 00003E9E 7320746F206368616E-
 11758 00003EA7 6765206E756D62206F-
 11758 00003EB0 6620736563746F7273-
 11758 00003EB9 2F747261636B2E20   
 11759 00003EC1 202020202020202020-     db  "                                                                                "
 11759 00003ECA 202020202020202020-
 11759 00003ED3 202020202020202020-
 11759 00003EDC 202020202020202020-
 11759 00003EE5 202020202020202020-
 11759 00003EEE 202020202020202020-
 11759 00003EF7 202020202020202020-
 11759 00003F00 202020202020202020-
 11759 00003F09 2020202020202020   
 11760 00003F11 202020202020202020-     db  "                                                                                "
 11760 00003F1A 202020202020202020-
 11760 00003F23 202020202020202020-
 11760 00003F2C 202020202020202020-
 11760 00003F35 202020202020202020-
 11760 00003F3E 202020202020202020-
 11760 00003F47 202020202020202020-
 11760 00003F50 202020202020202020-
 11760 00003F59 2020202020202020   
 11761 00003F61 507265737320454E54-     db  "Press ENTER to use current CHS values.                                          "
 11761 00003F6A 455220746F20757365-
 11761 00003F73 2063757272656E7420-
 11761 00003F7C 4348532076616C7565-
 11761 00003F85 732E20202020202020-
 11761 00003F8E 202020202020202020-
 11761 00003F97 202020202020202020-
 11761 00003FA0 202020202020202020-
 11761 00003FA9 2020202020202020   
 11762 00003FB1 202020202020202020-     db  "                                                                                "
 11762 00003FBA 202020202020202020-
 11762 00003FC3 202020202020202020-
 11762 00003FCC 202020202020202020-
 11762 00003FD5 202020202020202020-
 11762 00003FDE 202020202020202020-
 11762 00003FE7 202020202020202020-
 11762 00003FF0 202020202020202020-
 11762 00003FF9 2020202020202020   
 11763 00004001 507265737320455343-     db  "Press ESC to cancel.                                                            "
 11763 0000400A 20746F2063616E6365-
 11763 00004013 6C2E20202020202020-
 11763 0000401C 202020202020202020-
 11763 00004025 202020202020202020-
 11763 0000402E 202020202020202020-
 11763 00004037 202020202020202020-
 11763 00004040 202020202020202020-
 11763 00004049 2020202020202020   
 11764 00004051 202020202020202020-     db  "                                                                                "
 11764 0000405A 202020202020202020-
 11764 00004063 202020202020202020-
 11764 0000406C 202020202020202020-
 11764 00004075 202020202020202020-
 11764 0000407E 202020202020202020-
 11764 00004087 202020202020202020-
 11764 00004090 202020202020202020-
 11764 00004099 2020202020202020   
 11765 000040A1 00                      db  0
 11766                                  
 11767                                  TrDOS_Welcome:
 11768 000040A2 0D0A                    	db	0Dh, 0Ah
 11769                                  	;db	'TR-DOS 386 Fixed Disk Partitioning Utility'
 11770 000040A4 526574726F20444F53-     	db	'Retro DOS v5 Fixed Disk Partitioning Utility'
 11770 000040AD 207635204669786564-
 11770 000040B6 204469736B20506172-
 11770 000040BF 746974696F6E696E67-
 11770 000040C8 205574696C697479   
 11771 000040D0 0D0A                    	db	0Dh, 0Ah
 11772                                  	;db	"v2.1.240504 (c) Erdogan TAN 2021-2024"
 11773 000040D2 464449534B34207632-     	db	"FDISK4 v2.0.240504 (c) Erdogan TAN 2021-2024"
 11773 000040DB 2E302E323430353034-
 11773 000040E4 20286329204572646F-
 11773 000040ED 67616E2054414E2032-
 11773 000040F6 3032312D32303234   
 11774 000040FE 0D0A                    	db	0Dh,0Ah
 11775 00004100 0D0A                    	db	0Dh,0Ah
 11776 00004102 00                      	db	0
 11777                                  TrDOS_Usage:
 11778 00004103 55736167653A206664-     	db	'Usage: fdisk4r5 <hard disk name> '
 11778 0000410C 69736B347235203C68-
 11778 00004115 617264206469736B20-
 11778 0000411E 6E616D653E20       
 11779 00004124 0D0A                    	db	0Dh, 0Ah
 11780 00004126 0D0A                    	db	0Dh, 0Ah
 11781 00004128 48617264206469736B-     	db	"Hard disk names: "
 11781 00004131 206E616D65733A20   
 11782 00004139 0D0A                    	db	0Dh, 0Ah
 11783 0000413B 0D0A                    	db	0Dh, 0Ah
 11784 0000413D 20686430202E2E666F-     	db	" hd0 ..for 1st hard disk "
 11784 00004146 722031737420686172-
 11784 0000414F 64206469736B20     
 11785 00004156 0D0A                    	db	0Dh, 0Ah
 11786 00004158 20686431202E2E666F-     	db	" hd1 ..for 2nd hard disk "
 11786 00004161 7220326E6420686172-
 11786 0000416A 64206469736B20     
 11787 00004171 0D0A                    	db	0Dh, 0Ah
 11788 00004173 20686432202E2E666F-     	db	" hd2 ..for 3rd hard disk "
 11788 0000417C 722033726420686172-
 11788 00004185 64206469736B20     
 11789 0000418C 0D0A                    	db	0Dh, 0Ah
 11790 0000418E 20686433202E2E666F-     	db	" hd3 ..for 4th hard disk "
 11790 00004197 722034746820686172-
 11790 000041A0 64206469736B20     
 11791 000041A7 0D0A00                  	db	0Dh, 0Ah, 0
 11792                                  
 11793                                  TrDOS_Options:
 11794 000041AA 53656C656374206861-     	db	"Select hard disk number (1 to "
 11794 000041B3 7264206469736B206E-
 11794 000041BC 756D62657220283120-
 11794 000041C5 746F20             
 11795                                  TrDOS_dnmax:
 11796 000041C8 3429206F7220707265-     	db	"4) or press ESC to exit ..."
 11796 000041D1 73732045534320746F-
 11796 000041DA 2065786974202E2E2E 
 11797 000041E3 0D0A00                  	db	0Dh, 0Ah, 0
 11798                                  TrDOS_hdrow:
 11799 000041E6 0D0A                    	db	0Dh, 0Ah 
 11800 000041E8 28                      	db	"("
 11801                                  TrDOS_hdrow_n:
 11802 000041E9 3029206864              	db	"0) hd"
 11803                                  TrDOS_hdrow_i:
 11804 000041EE 30202D204361706163-     	db	"0 - Capacity : "
 11804 000041F7 697479203A20       
 11805 000041FD 00                      	db	0
 11806                                  TrDOS_hdrow_unit:
 11807 000041FE 474220                  	db	"GB "
 11808 00004201 0D0A00                  	db 	0Dh, 0Ah, 0
 11809                                  
 11810                                  TrDOS_hdrow_capacity:
 11811 00004204 303030302000            	db	"0000 ", 0
 11812 0000420A 00                      	db	0
 11813                                  
 11814                                  TrDOS_disksize:
 11815 0000420B 0D0A                    	db	0Dh, 0Ah
 11816 0000420D 4469736B2073697A65-     	db	"Disk size : "
 11816 00004216 203A20             
 11817 00004219 00                      	db	0
 11818                                  
 11819                                  ; 05/11/2020
 11820                                  ;msg_fdisk_capacity_err:
 11821                                  ;	db	0Dh, 0Ah
 11822                                  ;	db	"Huge disk !"
 11823                                  ;	db	0Dh, 0Ah
 11824                                  ;	db	"This FDISK version (v3) can work with disk sizes up to "
 11825                                  ;	db	0
 11826                                  
 11827                                  msg_any_key_esc_exit:
 11828 0000421A 0D0A                    	db	0Dh, 0Ah
 11829 0000421C 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
 11829 00004225 20746F206578697420-
 11829 0000422E 6F7220707265737320-
 11829 00004237 616E6F74686572206B-
 11829 00004240 657920746F20636F6E-
 11829 00004249 74696E75652E2E2E   
 11830 00004251 00                      	db	0
 11831                                  
 11832                                  msg_create_partition_h:
 11833 00004252 0D0A                    	db	0Dh, 0Ah
 11834 00004254 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11834 0000425D 2D2D2D2D2D2D2D2D2D-
 11834 00004266 2D2D2D2D2D2D2D2D2D-
 11834 0000426F 2D2D2D2D2D2D2D2D2D-
 11834 00004278 2D2D2D2D2D2D2D2D2D-
 11834 00004281 2D2D2D2D2D2D2D2D2D-
 11834 0000428A 2D2D2D2D2D2D2D2D2D-
 11834 00004293 2D2D2D2D2D2D2D2D2D-
 11834 0000429C 2D2D2D2D2D2D2D2D   
 11835 000042A4 202020202020202020-     	db	"                               Create Partition                                 "
 11835 000042AD 202020202020202020-
 11835 000042B6 202020202020202020-
 11835 000042BF 202020204372656174-
 11835 000042C8 652050617274697469-
 11835 000042D1 6F6E20202020202020-
 11835 000042DA 202020202020202020-
 11835 000042E3 202020202020202020-
 11835 000042EC 2020202020202020   
 11836 000042F4 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
 11836 000042FD 2D2D2D2D2D2D2D2D2D-
 11836 00004306 2D2D2D2D2D2D2D2D2D-
 11836 0000430F 2D2D2D2D2D2D2D2D2D-
 11836 00004318 2D2D2D2D2D2D2D2D2D-
 11836 00004321 2D2D2D2D2D2D2D2D2D-
 11836 0000432A 2D2D2D2D2D2D2D2D2D-
 11836 00004333 2D2D2D2D2D2D2D2D2D-
 11836 0000433C 2D2D2D2D2D2D2D2D   
 11837 00004344 0D0A00                  	db	0Dh, 0Ah, 0
 11838                                  msg_create_partition_m:
 11839 00004347 53656C65637420616E-     	db	"Select an option: "
 11839 00004350 206F7074696F6E3A20 
 11840 00004359 0D0A                    	db	0Dh, 0Ah
 11841 0000435B 0D0A                    	db	0Dh, 0Ah
 11842 0000435D 202031292043726561-     	db	"  1) Create DOS partition ", 0Dh, 0Ah
 11842 00004366 746520444F53207061-
 11842 0000436F 72746974696F6E200D-
 11842 00004378 0A                 
 11843 00004379 202032292043726561-     	db	"  2) Create SINGLIX FS partition ", 0Dh, 0Ah
 11843 00004382 74652053494E474C49-
 11843 0000438B 582046532070617274-
 11843 00004394 6974696F6E200D0A   
 11844 0000439C 202033292043726561-     	db	"  3) Create RETRO UNIX partition ", 0Dh, 0Ah
 11844 000043A5 746520524554524F20-
 11844 000043AE 554E49582070617274-
 11844 000043B7 6974696F6E200D0A   
 11845 000043BF 202034292043726561-     	db	"  4) Create another type of partition ", 0Dh, 0Ah
 11845 000043C8 746520616E6F746865-
 11845 000043D1 722074797065206F66-
 11845 000043DA 20706172746974696F-
 11845 000043E3 6E200D0A           
 11846 000043E7 0D0A                    	db	0Dh, 0Ah
 11847 000043E9 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
 11847 000043F2 206F72203020746F20-
 11847 000043FB 63616E63656C202E2E-
 11847 00004404 20                 
 11848 00004405 0D0A00                   	db 	0Dh, 0Ah, 0
 11849                                  
 11850                                  msg_create_primary_partition_h:
 11851 00004408 0D0A                    	db	0Dh, 0Ah
 11852 0000440A 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11852 00004413 2D2D2D2D2D2D2D2D2D-
 11852 0000441C 2D2D2D2D2D2D2D2D2D-
 11852 00004425 2D2D2D2D2D2D2D2D2D-
 11852 0000442E 2D2D2D2D2D2D2D2D2D-
 11852 00004437 2D2D2D2D2D2D2D2D2D-
 11852 00004440 2D2D2D2D2D2D2D2D2D-
 11852 00004449 2D2D2D2D2D2D2D2D2D-
 11852 00004452 2D2D2D2D2D2D2D2D   
 11853 0000445A 202020202020202020-     	db	"                          Create Primary DOS Partition                          "
 11853 00004463 202020202020202020-
 11853 0000446C 202020202020202043-
 11853 00004475 726561746520507269-
 11853 0000447E 6D61727920444F5320-
 11853 00004487 506172746974696F6E-
 11853 00004490 202020202020202020-
 11853 00004499 202020202020202020-
 11853 000044A2 2020202020202020   
 11854 000044AA 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11854 000044B3 2D2D2D2D2D2D2D2D2D-
 11854 000044BC 2D2D2D2D2D2D2D2D2D-
 11854 000044C5 2D2D2D2D2D2D2D2D2D-
 11854 000044CE 2D2D2D2D2D2D2D2D2D-
 11854 000044D7 2D2D2D2D2D2D2D2D2D-
 11854 000044E0 2D2D2D2D2D2D2D2D2D-
 11854 000044E9 2D2D2D2D2D2D2D2D2D-
 11854 000044F2 2D2D2D2D2D2D2D2D   
 11855 000044FA 0D0A00                  	db	0Dh, 0Ah, 0
 11856                                  
 11857                                  msg_create_dos_partition_h:
 11858 000044FD 0D0A                    	db	0Dh, 0Ah
 11859 000044FF 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11859 00004508 2D2D2D2D2D2D2D2D2D-
 11859 00004511 2D2D2D2D2D2D2D2D2D-
 11859 0000451A 2D2D2D2D2D2D2D2D2D-
 11859 00004523 2D2D2D2D2D2D2D2D2D-
 11859 0000452C 2D2D2D2D2D2D2D2D2D-
 11859 00004535 2D2D2D2D2D2D2D2D2D-
 11859 0000453E 2D2D2D2D2D2D2D2D2D-
 11859 00004547 2D2D2D2D2D2D2D2D   
 11860 0000454F 202020202020202020-     	db	"                   Create DOS Partition or Logical DOS Drive                    "
 11860 00004558 202020202020202020-
 11860 00004561 204372656174652044-
 11860 0000456A 4F5320506172746974-
 11860 00004573 696F6E206F72204C6F-
 11860 0000457C 676963616C20444F53-
 11860 00004585 204472697665202020-
 11860 0000458E 202020202020202020-
 11860 00004597 2020202020202020   
 11861 0000459F 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11861 000045A8 2D2D2D2D2D2D2D2D2D-
 11861 000045B1 2D2D2D2D2D2D2D2D2D-
 11861 000045BA 2D2D2D2D2D2D2D2D2D-
 11861 000045C3 2D2D2D2D2D2D2D2D2D-
 11861 000045CC 2D2D2D2D2D2D2D2D2D-
 11861 000045D5 2D2D2D2D2D2D2D2D2D-
 11861 000045DE 2D2D2D2D2D2D2D2D2D-
 11861 000045E7 2D2D2D2D2D2D2D2D   
 11862 000045EF 0D0A00                  	db	0Dh, 0Ah, 0
 11863                                  
 11864                                  msg_create_ext_partition_h:
 11865 000045F2 0D0A                    	db	0Dh, 0Ah
 11866 000045F4 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11866 000045FD 2D2D2D2D2D2D2D2D2D-
 11866 00004606 2D2D2D2D2D2D2D2D2D-
 11866 0000460F 2D2D2D2D2D2D2D2D2D-
 11866 00004618 2D2D2D2D2D2D2D2D2D-
 11866 00004621 2D2D2D2D2D2D2D2D2D-
 11866 0000462A 2D2D2D2D2D2D2D2D2D-
 11866 00004633 2D2D2D2D2D2D2D2D2D-
 11866 0000463C 2D2D2D2D2D2D2D2D   
 11867 00004644 202020202020202020-     	db	"                         Create Extended DOS Partition                          "
 11867 0000464D 202020202020202020-
 11867 00004656 202020202020204372-
 11867 0000465F 656174652045787465-
 11867 00004668 6E64656420444F5320-
 11867 00004671 506172746974696F6E-
 11867 0000467A 202020202020202020-
 11867 00004683 202020202020202020-
 11867 0000468C 2020202020202020   
 11868 00004694 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11868 0000469D 2D2D2D2D2D2D2D2D2D-
 11868 000046A6 2D2D2D2D2D2D2D2D2D-
 11868 000046AF 2D2D2D2D2D2D2D2D2D-
 11868 000046B8 2D2D2D2D2D2D2D2D2D-
 11868 000046C1 2D2D2D2D2D2D2D2D2D-
 11868 000046CA 2D2D2D2D2D2D2D2D2D-
 11868 000046D3 2D2D2D2D2D2D2D2D2D-
 11868 000046DC 2D2D2D2D2D2D2D2D   
 11869 000046E4 0D0A00                  	db	0Dh, 0Ah, 0
 11870                                  
 11871                                  msg_create_logical_drive_h:
 11872 000046E7 0D0A                    	db	0Dh, 0Ah
 11873 000046E9 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11873 000046F2 2D2D2D2D2D2D2D2D2D-
 11873 000046FB 2D2D2D2D2D2D2D2D2D-
 11873 00004704 2D2D2D2D2D2D2D2D2D-
 11873 0000470D 2D2D2D2D2D2D2D2D2D-
 11873 00004716 2D2D2D2D2D2D2D2D2D-
 11873 0000471F 2D2D2D2D2D2D2D2D2D-
 11873 00004728 2D2D2D2D2D2D2D2D2D-
 11873 00004731 2D2D2D2D2D2D2D2D   
 11874 00004739 202020202020202020-     	db	"                            Create Logical DOS Drive                            "
 11874 00004742 202020202020202020-
 11874 0000474B 202020202020202020-
 11874 00004754 20437265617465204C-
 11874 0000475D 6F676963616C20444F-
 11874 00004766 532044726976652020-
 11874 0000476F 202020202020202020-
 11874 00004778 202020202020202020-
 11874 00004781 2020202020202020   
 11875 00004789 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11875 00004792 2D2D2D2D2D2D2D2D2D-
 11875 0000479B 2D2D2D2D2D2D2D2D2D-
 11875 000047A4 2D2D2D2D2D2D2D2D2D-
 11875 000047AD 2D2D2D2D2D2D2D2D2D-
 11875 000047B6 2D2D2D2D2D2D2D2D2D-
 11875 000047BF 2D2D2D2D2D2D2D2D2D-
 11875 000047C8 2D2D2D2D2D2D2D2D2D-
 11875 000047D1 2D2D2D2D2D2D2D2D   
 11876 000047D9 0D0A00                  	db	0Dh, 0Ah, 0
 11877                                  
 11878                                  msg_create_nondos_partition_h:
 11879 000047DC 0D0A                    	db	0Dh, 0Ah
 11880 000047DE 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11880 000047E7 2D2D2D2D2D2D2D2D2D-
 11880 000047F0 2D2D2D2D2D2D2D2D2D-
 11880 000047F9 2D2D2D2D2D2D2D2D2D-
 11880 00004802 2D2D2D2D2D2D2D2D2D-
 11880 0000480B 2D2D2D2D2D2D2D2D2D-
 11880 00004814 2D2D2D2D2D2D2D2D2D-
 11880 0000481D 2D2D2D2D2D2D2D2D2D-
 11880 00004826 2D2D2D2D2D2D2D2D   
 11881 0000482E 202020202020202020-     	db	"                            Create NON-DOS Partition                            "
 11881 00004837 202020202020202020-
 11881 00004840 202020202020202020-
 11881 00004849 20437265617465204E-
 11881 00004852 4F4E2D444F53205061-
 11881 0000485B 72746974696F6E2020-
 11881 00004864 202020202020202020-
 11881 0000486D 202020202020202020-
 11881 00004876 2020202020202020   
 11882 0000487E 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11882 00004887 2D2D2D2D2D2D2D2D2D-
 11882 00004890 2D2D2D2D2D2D2D2D2D-
 11882 00004899 2D2D2D2D2D2D2D2D2D-
 11882 000048A2 2D2D2D2D2D2D2D2D2D-
 11882 000048AB 2D2D2D2D2D2D2D2D2D-
 11882 000048B4 2D2D2D2D2D2D2D2D2D-
 11882 000048BD 2D2D2D2D2D2D2D2D2D-
 11882 000048C6 2D2D2D2D2D2D2D2D   
 11883 000048CE 0D0A00                  	db	0Dh, 0Ah, 0
 11884                                  
 11885                                  msg_create_dos_partition_m:
 11886 000048D1 53656C65637420616E-     	db	"Select an option: "
 11886 000048DA 206F7074696F6E3A20 
 11887 000048E3 0D0A                    	db	0Dh, 0Ah
 11888 000048E5 0D0A                    	db	0Dh, 0Ah
 11889 000048E7 202031292043726561-     	db	"  1) Create Primary DOS partition ", 0Dh, 0Ah
 11889 000048F0 7465205072696D6172-
 11889 000048F9 7920444F5320706172-
 11889 00004902 746974696F6E200D0A 
 11890 0000490B 202032292043726561-     	db	"  2) Create Extended DOS partition ", 0Dh, 0Ah
 11890 00004914 746520457874656E64-
 11890 0000491D 656420444F53207061-
 11890 00004926 72746974696F6E200D-
 11890 0000492F 0A                 
 11891 00004930 202033292043726561-     	db	"  3) Create Logical DOS drive(s) in Extended DOS partition ", 0Dh, 0Ah
 11891 00004939 7465204C6F67696361-
 11891 00004942 6C20444F5320647269-
 11891 0000494B 766528732920696E20-
 11891 00004954 457874656E64656420-
 11891 0000495D 444F53207061727469-
 11891 00004966 74696F6E200D0A     
 11892 0000496D 0D0A                    	db	0Dh, 0Ah	
 11893 0000496F 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
 11893 00004978 206F72203020746F20-
 11893 00004981 63616E63656C202E2E-
 11893 0000498A 20                 
 11894 0000498B 0D0A00                   	db 	0Dh, 0Ah, 0
 11895                                  
 11896                                  msg_create_trdos_partition_s:
 11897 0000498E 53656C65637420616E-     	db	"Select an option to set partition size: "
 11897 00004997 206F7074696F6E2074-
 11897 000049A0 6F2073657420706172-
 11897 000049A9 746974696F6E207369-
 11897 000049B2 7A653A20           
 11898 000049B6 0D0A                    	db	0Dh, 0Ah
 11899 000049B8 0D0A                    	db	0Dh, 0Ah
 11900 000049BA 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah
 11900 000049C3 6E64657220636F756E-
 11900 000049CC 740D0A             
 11901 000049CF 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
 11901 000049D8 6D652070657263656E-
 11901 000049E1 746167652028232325-
 11901 000049EA 290D0A             
 11902 000049ED 202053292053656374-     	db	"  S) Sectors (number of 512 bytes)", 0Dh, 0Ah
 11902 000049F6 6F727320286E756D62-
 11902 000049FF 6572206F6620353132-
 11902 00004A08 206279746573290D0A 
 11903 00004A11 20204B29204B696C6F-     	db	"  K) Kilo bytes (KB, 2*K sectors)", 0Dh, 0Ah
 11903 00004A1A 20627974657320284B-
 11903 00004A23 422C20322A4B207365-
 11903 00004A2C 63746F7273290D0A   
 11904 00004A34 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
 11904 00004A3D 20627974657320284D-
 11904 00004A46 422C20322A31303234-
 11904 00004A4F 2A4D20736563746F72-
 11904 00004A58 73290D0A           
 11905 00004A5C 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
 11905 00004A65 206279746573202847-
 11905 00004A6E 422C20322A31303234-
 11905 00004A77 2A313032342A472073-
 11905 00004A80 6563746F7273290D0A 
 11906 00004A89 0D0A                    	db	0Dh, 0Ah	
 11907 00004A8B 507265737320535041-     	db	"Press SPACE to use whole disk or press ENTER to set sector count .. "
 11907 00004A94 434520746F20757365-
 11907 00004A9D 2077686F6C65206469-
 11907 00004AA6 736B206F7220707265-
 11907 00004AAF 737320454E54455220-
 11907 00004AB8 746F20736574207365-
 11907 00004AC1 63746F7220636F756E-
 11907 00004ACA 74202E2E20         
 11908                                  msg_press_esc_to_cancel:
 11909 00004ACF 0D0A                     	db	0Dh, 0Ah
 11910 00004AD1 285072657373204553-     	db	"(Press ESC to CANCEL) "
 11910 00004ADA 4320746F2043414E43-
 11910 00004AE3 454C2920           
 11911 00004AE7 0D0A00                  	db 	0Dh, 0Ah, 0
 11912                                  
 11913                                  msg_use_whole_disk:
 11914 00004AEA 446F20796F75207761-     	db	"Do you want to use WHOLE disk !? (Y/N)", 0
 11914 00004AF3 6E7420746F20757365-
 11914 00004AFC 2057484F4C45206469-
 11914 00004B05 736B20213F2028592F-
 11914 00004B0E 4E2900             
 11915                                  
 11916                                  msg_use_all_space:
 11917 00004B11 446F20796F75207761-     	db	"Do you want to use all of available space !? (Y/N)", 0
 11917 00004B1A 6E7420746F20757365-
 11917 00004B23 20616C6C206F662061-
 11917 00004B2C 7661696C61626C6520-
 11917 00004B35 737061636520213F20-
 11917 00004B3E 28592F4E2900       
 11918                                  
 11919                                  msg_use_entire_ep_space:
 11920 00004B44 446F20796F75207761-     	db	"Do you want to use entire extended partition space !? (Y/N)", 0
 11920 00004B4D 6E7420746F20757365-
 11920 00004B56 20656E746972652065-
 11920 00004B5F 7874656E6465642070-
 11920 00004B68 6172746974696F6E20-
 11920 00004B71 737061636520213F20-
 11920 00004B7A 28592F4E2900       
 11921                                  
 11922                                  msg_partition_size:
 11923 00004B80 0D0A                    	db	0Dh, 0Ah
 11924 00004B82 0D0A                    	db	0Dh, 0Ah
 11925 00004B84 506172746974696F6E-     	db	"Partition size ("
 11925 00004B8D 2073697A652028     
 11926                                  msg_partition_size_x:
 11927 00004B94 3F29203A20              	db	"?) : "
 11928 00004B99 00                      	db	0
 11929                                  
 11930                                  msg_partition_type:
 11931 00004B9A 0D0A                    	db	0Dh, 0Ah
 11932 00004B9C 0D0A                    	db	0Dh, 0Ah
 11933 00004B9E 506172746974696F6E-     	db	"Partition type : "
 11933 00004BA7 2074797065203A20   
 11934 00004BAF 00                      	db	0
 11935                                  
 11936                                  msg_ptype_num:
 11937 00004BB0 3030680D0A00            	db	"00h", 0Dh, 0Ah, 0
 11938                                  
 11939                                  msg_partition_type_error:
 11940 00004BB6 506172746974696F6E-     	db	"Partition size is not proper for selected partition type !"
 11940 00004BBF 2073697A6520697320-
 11940 00004BC8 6E6F742070726F7065-
 11940 00004BD1 7220666F722073656C-
 11940 00004BDA 656374656420706172-
 11940 00004BE3 746974696F6E207479-
 11940 00004BEC 70652021           
 11941 00004BF0 0D0A                    	db	0Dh, 0Ah
 11942                                  msg_any_key_to_retry:
 11943 00004BF2 28507265737320616E-     	db	"(Press any key to retry..)"
 11943 00004BFB 79206B657920746F20-
 11943 00004C04 72657472792E2E29   
 11944 00004C0C 0D0A00                  	db	0Dh, 0Ah, 0
 11945                                  
 11946                                  msg_partition_size_overs:
 11947 00004C0F 0D0A                    	db	0Dh, 0Ah
 11948 00004C11 506172746974696F6E-     	db	"Partition size overs the disk capacity !"
 11948 00004C1A 2073697A65206F7665-
 11948 00004C23 727320746865206469-
 11948 00004C2C 736B20636170616369-
 11948 00004C35 74792021           
 11949 00004C39 0D0A                    	db	0Dh, 0Ah
 11950 00004C3B 28507265737320454E-     	db	"(Press ENTER to use WHOLE disk or press ESC key to retry..)" 
 11950 00004C44 54455220746F207573-
 11950 00004C4D 652057484F4C452064-
 11950 00004C56 69736B206F72207072-
 11950 00004C5F 65737320455343206B-
 11950 00004C68 657920746F20726574-
 11950 00004C71 72792E2E29         
 11951 00004C76 0D0A00                  	db	0Dh, 0Ah, 0
 11952                                  
 11953                                  msg_ext_partition_error:
 11954 00004C79 457874656E64656420-     	db	"Extended partition must be created after primary partition !"
 11954 00004C82 706172746974696F6E-
 11954 00004C8B 206D75737420626520-
 11954 00004C94 637265617465642061-
 11954 00004C9D 66746572207072696D-
 11954 00004CA6 617279207061727469-
 11954 00004CAF 74696F6E2021       
 11955 00004CB5 0D0A00                  	db	0Dh, 0Ah,0
 11956                                  
 11957                                  msg_logical_drive_error:
 11958 00004CB8 5072696D6172792061-     	db	"Primary and extended partitions must be created before logical drive !"
 11958 00004CC1 6E6420657874656E64-
 11958 00004CCA 656420706172746974-
 11958 00004CD3 696F6E73206D757374-
 11958 00004CDC 206265206372656174-
 11958 00004CE5 6564206265666F7265-
 11958 00004CEE 206C6F676963616C20-
 11958 00004CF7 64726976652021     
 11959 00004CFE 0D0A00                  	db	0Dh, 0Ah,0
 11960                                  
 11961                                  msg_cylinder_boundary_set:
 11962 00004D01 0D0A                    	db	0Dh, 0Ah
 11963 00004D03 446F20796F75207761-     	db	"Do you want to adjust partition size to cylinder boundary ? (Y/N)"
 11963 00004D0C 6E7420746F2061646A-
 11963 00004D15 757374207061727469-
 11963 00004D1E 74696F6E2073697A65-
 11963 00004D27 20746F2063796C696E-
 11963 00004D30 64657220626F756E64-
 11963 00004D39 617279203F2028592F-
 11963 00004D42 4E29               
 11964 00004D44 00                      	db	0
 11965                                  
 11966                                  	; 2019 - 2020 (hdimage.s)
 11967                                  ;msg_selected_partition:
 11968                                  ;	db	"                                 PARTITION 0                                    "
 11969                                  ;	db	"================================================================================"
 11970                                  ;	db	"        S  BH  BS  BC  FS  EH  ES  EC    START SEC   SECTORS   FILE SYSTEM      "
 11971                                  ;	db	"--------------------------------------------------------------------------------"
 11972                                  ;pt_row: db	"                                                                                "
 11973                                  ;	db	"================================================================================"
 11974                                  ;	db	0
 11975                                  
 11976                                  	; 24/10/2020 (fdisk3.s)
 11977                                  msg_selected_partition:
 11978 00004D45 202020202020202020-     	db	"                                 PARTITION 0                                    "
 11978 00004D4E 202020202020202020-
 11978 00004D57 202020202020202020-
 11978 00004D60 202020202020504152-
 11978 00004D69 544954494F4E203020-
 11978 00004D72 202020202020202020-
 11978 00004D7B 202020202020202020-
 11978 00004D84 202020202020202020-
 11978 00004D8D 2020202020202020   
 11979 00004D95 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 11979 00004D9E 3D3D3D3D3D3D3D3D3D-
 11979 00004DA7 3D3D3D3D3D3D3D3D3D-
 11979 00004DB0 3D3D3D3D3D3D3D3D3D-
 11979 00004DB9 3D3D3D3D3D3D3D3D3D-
 11979 00004DC2 3D3D3D3D3D3D3D3D3D-
 11979 00004DCB 3D3D3D3D3D3D3D3D3D-
 11979 00004DD4 3D3D3D3D3D3D3D3D3D-
 11979 00004DDD 3D3D3D3D3D3D3D3D   
 11980 00004DE5 202020202020205320-     	db	"       S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS   FILE SYSTEM      "
 11980 00004DEE 204248202042532020-
 11980 00004DF7 424320204653202045-
 11980 00004E00 482020455320204543-
 11980 00004E09 202020535441525420-
 11980 00004E12 534543542020202053-
 11980 00004E1B 4543544F5253202020-
 11980 00004E24 46494C452053595354-
 11980 00004E2D 454D202020202020   
 11981 00004E35 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11981 00004E3E 2D2D2D2D2D2D2D2D2D-
 11981 00004E47 2D2D2D2D2D2D2D2D2D-
 11981 00004E50 2D2D2D2D2D2D2D2D2D-
 11981 00004E59 2D2D2D2D2D2D2D2D2D-
 11981 00004E62 2D2D2D2D2D2D2D2D2D-
 11981 00004E6B 2D2D2D2D2D2D2D2D2D-
 11981 00004E74 2D2D2D2D2D2D2D2D2D-
 11981 00004E7D 2D2D2D2D2D2D2D2D   
 11982 00004E85 202020202020202020-     pt_row:	db	"                                                                                "
 11982 00004E8E 202020202020202020-
 11982 00004E97 202020202020202020-
 11982 00004EA0 202020202020202020-
 11982 00004EA9 202020202020202020-
 11982 00004EB2 202020202020202020-
 11982 00004EBB 202020202020202020-
 11982 00004EC4 202020202020202020-
 11982 00004ECD 2020202020202020   
 11983 00004ED5 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 11983 00004EDE 3D3D3D3D3D3D3D3D3D-
 11983 00004EE7 3D3D3D3D3D3D3D3D3D-
 11983 00004EF0 3D3D3D3D3D3D3D3D3D-
 11983 00004EF9 3D3D3D3D3D3D3D3D3D-
 11983 00004F02 3D3D3D3D3D3D3D3D3D-
 11983 00004F0B 3D3D3D3D3D3D3D3D3D-
 11983 00004F14 3D3D3D3D3D3D3D3D3D-
 11983 00004F1D 3D3D3D3D3D3D3D3D   
 11984 00004F25 00                      	db	0
 11985                                  msg_boot_indicator:
 11986 00004F26 0D0A                    	db	0Dh, 0Ah
 11987 00004F28 20202020426F6F7420-     	db	"    Boot Indicator : ", 0 ; "YES", "NO"
 11987 00004F31 496E64696361746F72-
 11987 00004F3A 203A2000           
 11988                                  msg_starting_head:
 11989 00004F3E 0D0A                    	db	0Dh, 0Ah
 11990 00004F40 202020202053746172-     	db 	"     Starting Head : ", 0
 11990 00004F49 74696E672048656164-
 11990 00004F52 203A2000           
 11991                                  msg_starting_sector:
 11992 00004F56 0D0A                    	db	0Dh, 0Ah
 11993 00004F58 202020537461727469-     	db	"   Starting Sector : ", 0
 11993 00004F61 6E6720536563746F72-
 11993 00004F6A 203A2000           
 11994                                  msg_starting_cylinder:
 11995 00004F6E 0D0A                    	db	0Dh, 0Ah
 11996 00004F70 205374617274696E67-     	db	" Starting Cylinder : ", 0
 11996 00004F79 2043796C696E646572-
 11996 00004F82 203A2000           
 11997                                  msg_system_id:
 11998 00004F86 0D0A                    	db	0Dh, 0Ah
 11999 00004F88 202020202020202020-     	db	"         System ID : ", 0
 11999 00004F91 53797374656D204944-
 11999 00004F9A 203A2000           
 12000                                  msg_ending_head:
 12001 00004F9E 0D0A                    	db	0Dh, 0Ah
 12002 00004FA0 20202020202020456E-     	db 	"       Ending Head : ", 0
 12002 00004FA9 64696E672048656164-
 12002 00004FB2 203A2000           
 12003                                  msg_ending_sector:
 12004 00004FB6 0D0A                    	db	0Dh, 0Ah
 12005 00004FB8 2020202020456E6469-     	db	"     Ending Sector : ", 0
 12005 00004FC1 6E6720536563746F72-
 12005 00004FCA 203A2000           
 12006                                  msg_ending_cylinder:
 12007 00004FCE 0D0A                    	db	0Dh, 0Ah
 12008 00004FD0 202020456E64696E67-     	db	"   Ending Cylinder : ", 0
 12008 00004FD9 2043796C696E646572-
 12008 00004FE2 203A2000           
 12009                                  msg_relative_sectors:
 12010 00004FE6 0D0A                    	db	0Dh, 0Ah
 12011 00004FE8 0D0A                    	db	0Dh, 0Ah
 12012 00004FEA 202052656C61746976-     	db	"  Relative Sectors : ", 0
 12012 00004FF3 6520536563746F7273-
 12012 00004FFC 203A2000           
 12013                                  msg_total_sectors:
 12014 00005000 0D0A                    	db	0Dh, 0Ah
 12015 00005002 2020202020546F7461-     	db	"     Total Sectors : ", 0
 12015 0000500B 6C20536563746F7273-
 12015 00005014 203A2000           
 12016                                  
 12017                                  msg_format_stage:
 12018 00005018 0D0A                    	db	0Dh, 0Ah
 12019 0000501A 507265737320454E54-     	db	"Press ENTER to FORMAT disk partition "
 12019 00005023 455220746F20464F52-
 12019 0000502C 4D4154206469736B20-
 12019 00005035 706172746974696F6E-
 12019 0000503E 20                 
 12020                                  partition_num_chr:
 12021 0000503F 30                      	db	"0"
 12022 00005040 206F72207072657373-     	db	" or press ESC to EXIT.."
 12022 00005049 2045534320746F2045-
 12022 00005052 5849542E2E         
 12023 00005057 00                      	db	0
 12024                                  msg_partition_edit:
 12025 00005058 0D0A                    	db	0Dh, 0Ah
 12026 0000505A 2E2E206F7220707265-     	db	".. or press SPACE to EDIT partition table."
 12026 00005063 737320535041434520-
 12026 0000506C 746F20454449542070-
 12026 00005075 6172746974696F6E20-
 12026 0000507E 7461626C652E       
 12027 00005084 0D0A00                  	db	0Dh, 0Ah, 0
 12028                                  
 12029                                  msg_edit_or_exit:
 12030 00005087 0D0A                    	db 	0Dh, 0Ah
 12031 00005089 507265737320454E54-     	db	"Press ENTER to continue or press ESC to exit.."
 12031 00005092 455220746F20636F6E-
 12031 0000509B 74696E7565206F7220-
 12031 000050A4 707265737320455343-
 12031 000050AD 20746F20657869742E-
 12031 000050B6 2E                 
 12032 000050B7 00                      	db	0
 12033                                  
 12034                                  msg_overwrite_question1:
 12035 000050B8 0D0A                    	db	0Dh, 0Ah
 12036 000050BA 446F20796F75207761-     	db	'Do you want to overwrite '
 12036 000050C3 6E7420746F206F7665-
 12036 000050CC 72777269746520     
 12037 000050D3 27                      	db	27h
 12038 000050D4 00                      	db	0
 12039                                  
 12040                                  msg_overwrite_question2: 
 12041 000050D5 27                      	db	27h
 12042 000050D6 2066696C6520            	db	' file '
 12043 000050DC 00                      	db	0
 12044                                  
 12045                                  msg_format_question:
 12046 000050DD 0D0A                    	db	0Dh, 0Ah
 12047 000050DF 446F20796F75207761-     	db	"Do you want to format partition "
 12047 000050E8 6E7420746F20666F72-
 12047 000050F1 6D6174207061727469-
 12047 000050FA 74696F6E20         
 12048                                  partition_num_txt:
 12049 000050FF 3020                    	db	 "0 "
 12050                                  msg_yes_no:
 12051 00005101 285965732F4E6F293F-     	db	'(Yes/No)? ', 0
 12051 0000510A 2000               
 12052                                  
 12053                                  msg_writing_mbr:
 12054 0000510C 57726974696E67206D-     	db	"Writing masterboot sector...", 0
 12054 00005115 6173746572626F6F74-
 12054 0000511E 20736563746F722E2E-
 12054 00005127 2E00               
 12055                                  
 12056                                  msg_writing_disk_sectors:
 12057 00005129 57726974696E672064-     	db	"Writing disk sector: ", 0
 12057 00005132 69736B20736563746F-
 12057 0000513B 723A2000           
 12058                                  
 12059                                  Msg_Writing_Boot_Sector:
 12060 0000513F 57726974696E672074-     	db	"Writing trdos boot sector...", 0
 12060 00005148 72646F7320626F6F74-
 12060 00005151 20736563746F722E2E-
 12060 0000515A 2E00               
 12061                                  
 12062                                  Msg_Writing_Root_Dir:
 12063 0000515C 57726974696E672072-     	db	"Writing root directory sectors...", 0
 12063 00005165 6F6F74206469726563-
 12063 0000516E 746F72792073656374-
 12063 00005177 6F72732E2E2E00     
 12064                                  
 12065                                  Msg_Writing_Data_Sectors:
 12066 0000517E 57726974696E672064-     	db	"Writing data sector: ", 0
 12066 00005187 61746120736563746F-
 12066 00005190 723A2000           
 12067                                  
 12068                                  Sector_Str:
 12069 00005194 3030303030303000        	db	"0000000", 0
 12070                                  Cursor_Pos:
 12071 0000519C 0000                    	dw	0
 12072                                  
 12073                                  Msg_Writing_FAT_Sectors:
 12074 0000519E 57726974696E672046-     	db	"Writing FAT sectors...", 0
 12074 000051A7 415420736563746F72-
 12074 000051B0 732E2E2E00         
 12075                                  
 12076                                  StrVolumeName:
 12077                                  	;times 	12 db  0
 12078 000051B5 00<rep 41h>             	times	65 db 0  ; 05/01/2018 (fs1 volume name)	
 12079                                  
 12080                                  Msg_Volume_Name:
 12081 000051F6 0D0A                    	db	0Dh, 0Ah
 12082 000051F8 0D0A                    	db	0Dh, 0Ah
 12083 000051FA 566F6C756D65204E61-     	db	"Volume Name: ", 0
 12083 00005203 6D653A2000         
 12084                                  
 12085                                  Msg_Volume_Serial:
 12086 00005208 566F6C756D65205365-     	db	"Volume Serial No: "
 12086 00005211 7269616C204E6F3A20 
 12087                                  Vol_Serial1:
 12088 0000521A 30303030                	db	"0000"
 12089 0000521E 2D                      	db	"-"
 12090                                  Vol_Serial2:
 12091 0000521F 30303030                	db	"0000"
 12092 00005223 0D0A00                  	db	0Dh, 0Ah, 0
 12093                                  
 12094                                  msg_cluster_count:
 12095 00005226 436C75737465722043-     	db	"Cluster Count: ", 0
 12095 0000522F 6F756E743A2000     
 12096                                  cluster_count_str:
 12097 00005236 30303030303030          	db	"0000000"
 12098 0000523D 0D0A00                  	db	0Dh, 0Ah, 0
 12099                                  msg_formatting:
 12100 00005240 466F726D617474696E-     	db	"Formatting ", 0
 12100 00005249 672000             
 12101                                  format_percent_str:
 12102 0000524C 30303025                	db	"000%"
 12103 00005250 00                      	db	0
 12104                                  
 12105                                  Msg_3dot_OK:
 12106 00005251 2E2E2E                  	db	"..."
 12107                                  Msg_OK:
 12108 00005254 204F4B2E                	db	' OK.'
 12109                                  CRLF:
 12110 00005258 0D0A00                  	db	0Dh, 0Ah, 0
 12111                                  
 12112                                  Msg_Error:
 12113 0000525B 0D0A                    	db	0Dh, 0Ah
 12114 0000525D 4572726F72202120        	db	'Error ! '
 12115 00005265 28                      	db	'('
 12116                                  error_code:
 12117 00005266 3030                    	dw	3030h
 12118 00005268 68                      	db	'h'
 12119 00005269 2920                    	db	') '
 12120 0000526B 0D0A                    	db	0Dh, 0Ah
 12121 0000526D 00                      	db	0
 12122                                  
 12123                                  msg_disk_sectors:
 12124 0000526E 546F74616C20446973-     	db	"Total Disk Sectors : ", 0
 12124 00005277 6B20536563746F7273-
 12124 00005280 203A2000           
 12125                                  
 12126                                  str_disk_sectors:
 12127                                  	;times	8 db 0
 12128 00005284 00<rep Bh>              	times	11 db 0 ; 27/10/2020
 12129                                  
 12130                                  msg_ep_size:
 12131 0000528F 457874656E64656420-     	db	"Extended Partition Size in Sectors: ", 0
 12131 00005298 506172746974696F6E-
 12131 000052A1 2053697A6520696E20-
 12131 000052AA 536563746F72733A20-
 12131 000052B3 00                 
 12132                                  
 12133                                  msg_press_any_key:
 12134 000052B4 0D0A                    	db	0Dh, 0Ah
 12135 000052B6 50726573732061206B-     	db	"Press a key to continue..."
 12135 000052BF 657920746F20636F6E-
 12135 000052C8 74696E75652E2E2E   
 12136 000052D0 0D0A00                  	db	0Dh, 0Ah, 0
 12137                                  
 12138 000052D3 90                      align 2
 12139                                  
 12140                                  ; Masterboot sector
 12141                                  
 12142                                  MasterBootBuff:
 12143                                  MasterBootCode: 
 12144 000052D4 00<rep 1BEh>            	times	446 db 0
 12145                                  PartitionTable:
 12146 00005492 00<rep 40h>             	times	64 db 0
 12147                                  MBIDCode:
 12148 000054D2 0000                    	dw	0
 12149                                  
 12150                                  PTable_Buffer:
 12151 000054D4 00<rep 40h>             	times	64 db 0
 12152                                   
 12153 00005514 286329204572646F67-     	db	'(c) Erdogan TAN 2019-2024'
 12153 0000551D 616E2054414E203230-
 12153 00005526 31392D32303234     
 12154                                  
 12155                                  ; 05/11/2020
 12156 0000552D 00                      	db	0
 12157                                  
 12158                                  	; 2019 - 2020 (hdimage.s)
 12159                                  ;p_table_header:
 12160                                  ;	db	"                              ?BR PARTITION TABLE                               "
 12161                                  ;	db	"================================================================================"
 12162                                  ;	db	"       P  S  BH  BS  BC  FS  EH  ES  EC  START SEC  SECTORS  FILE SYSTEM        "
 12163                                  ;	db	"--------------------------------------------------------------------------------"
 12164                                  ;	db	0
 12165                                  ;p_table_footer:
 12166                                  ;	db	"================================================================================"
 12167                                  ;	db	0Dh, 0Ah, 0
 12168                                  
 12169                                  	; 24/10/2020 (fdisk3.s)
 12170                                  p_table_header:
 12171 0000552E 202020202020202020-     	db	"                              ?BR PARTITION TABLE                               "
 12171 00005537 202020202020202020-
 12171 00005540 202020202020202020-
 12171 00005549 2020203F4252205041-
 12171 00005552 52544954494F4E2054-
 12171 0000555B 41424C452020202020-
 12171 00005564 202020202020202020-
 12171 0000556D 202020202020202020-
 12171 00005576 2020202020202020   
 12172 0000557E 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 12172 00005587 3D3D3D3D3D3D3D3D3D-
 12172 00005590 3D3D3D3D3D3D3D3D3D-
 12172 00005599 3D3D3D3D3D3D3D3D3D-
 12172 000055A2 3D3D3D3D3D3D3D3D3D-
 12172 000055AB 3D3D3D3D3D3D3D3D3D-
 12172 000055B4 3D3D3D3D3D3D3D3D3D-
 12172 000055BD 3D3D3D3D3D3D3D3D3D-
 12172 000055C6 3D3D3D3D3D3D3D3D   
 12173 000055CE 202020502020205320-     	db	"   P   S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS    FILE SYSTEM     "
 12173 000055D7 204248202042532020-
 12173 000055E0 424320204653202045-
 12173 000055E9 482020455320204543-
 12173 000055F2 202020535441525420-
 12173 000055FB 534543542020202053-
 12173 00005604 4543544F5253202020-
 12173 0000560D 2046494C4520535953-
 12173 00005616 54454D2020202020   
 12174 0000561E 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 12174 00005627 2D2D2D2D2D2D2D2D2D-
 12174 00005630 2D2D2D2D2D2D2D2D2D-
 12174 00005639 2D2D2D2D2D2D2D2D2D-
 12174 00005642 2D2D2D2D2D2D2D2D2D-
 12174 0000564B 2D2D2D2D2D2D2D2D2D-
 12174 00005654 2D2D2D2D2D2D2D2D2D-
 12174 0000565D 2D2D2D2D2D2D2D2D2D-
 12174 00005666 2D2D2D2D2D2D2D2D   
 12175 0000566E 00                      	db	0
 12176                                  p_table_footer:
 12177 0000566F 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 12177 00005678 3D3D3D3D3D3D3D3D3D-
 12177 00005681 3D3D3D3D3D3D3D3D3D-
 12177 0000568A 3D3D3D3D3D3D3D3D3D-
 12177 00005693 3D3D3D3D3D3D3D3D3D-
 12177 0000569C 3D3D3D3D3D3D3D3D3D-
 12177 000056A5 3D3D3D3D3D3D3D3D3D-
 12177 000056AE 3D3D3D3D3D3D3D3D3D-
 12177 000056B7 3D3D3D3D3D3D3D3D   
 12178 000056BF 0D0A00                  	db	0Dh, 0Ah, 0
 12179                                  
 12180                                  mbr_editing_options:
 12181 000056C2 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 12182 000056C6 4D4252205061727469-     	db	"MBR Partition Table Editing Options:"
 12182 000056CF 74696F6E205461626C-
 12182 000056D8 652045646974696E67-
 12182 000056E1 204F7074696F6E733A 
 12183 000056EA 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12184 000056EE 20202020202020312E-     	db	"       1. Create Partition", 0Dh, 0Ah
 12184 000056F7 204372656174652050-
 12184 00005700 6172746974696F6E0D-
 12184 00005709 0A                 
 12185 0000570A 20202020202020322E-     	db	"       2. Set Active Partition", 0Dh, 0Ah
 12185 00005713 205365742041637469-
 12185 0000571C 766520506172746974-
 12185 00005725 696F6E0D0A         
 12186 0000572A 20202020202020332E-     	db	"       3. Delete Partition", 0Dh, 0Ah  
 12186 00005733 2044656C6574652050-
 12186 0000573C 6172746974696F6E0D-
 12186 00005745 0A                 
 12187 00005746 20202020202020342E-     	db	"       4. Write Current Partition Table", 0Dh, 0Ah, 0
 12187 0000574F 205772697465204375-
 12187 00005758 7272656E7420506172-
 12187 00005761 746974696F6E205461-
 12187 0000576A 626C650D0A00       
 12188                                  
 12189                                  enter_option_number_msg:
 12190 00005770 0D0A                    	db	0Dh, 0Ah
 12191 00005772 456E74657220746865-     	db	"Enter the option number or press ESC to exit ...", 0Dh, 0Ah
 12191 0000577B 206F7074696F6E206E-
 12191 00005784 756D626572206F7220-
 12191 0000578D 707265737320455343-
 12191 00005796 20746F206578697420-
 12191 0000579F 2E2E2E0D0A         
 12192                                  	;db	0Dh, 0Ah, 0
 12193 000057A4 00                      	db	0 
 12194                                  
 12195                                  msg_zero_partition_size:  ; 19/02/2019
 12196 000057A5 0D0A                    	db	0Dh, 0Ah
 12197 000057A7 506172746974696F6E-     	db	"Partition size input must not be ZERO !", 0Dh, 0Ah
 12197 000057B0 2073697A6520696E70-
 12197 000057B9 7574206D757374206E-
 12197 000057C2 6F74206265205A4552-
 12197 000057CB 4F20210D0A         
 12198 000057D0 285072657373204553-     	db	"(Press ESC to exit or press another key to retry..)", 0Dh, 0Ah
 12198 000057D9 4320746F2065786974-
 12198 000057E2 206F72207072657373-
 12198 000057EB 20616E6F7468657220-
 12198 000057F4 6B657920746F207265-
 12198 000057FD 7472792E2E290D0A   
 12199 00005805 00                      	db	0 
 12200                                  
 12201                                  msg_empty_pt:
 12202 00005806 0D0A                    	db	0Dh, 0Ah
 12203 00005808 456D70747920706172-     	db	"Empty partition table !", 0Dh, 0Ah
 12203 00005811 746974696F6E207461-
 12203 0000581A 626C6520210D0A     
 12204 00005821 28412076616C696420-     	db	"(A valid partition must be created at first..)", 0Dh, 0Ah
 12204 0000582A 706172746974696F6E-
 12204 00005833 206D75737420626520-
 12204 0000583C 637265617465642061-
 12204 00005845 742066697273742E2E-
 12204 0000584E 290D0A             
 12205 00005851 00                      	db	0
 12206                                  
 12207                                  msg_full_pt:
 12208 00005852 0D0A                    	db	0Dh, 0Ah
 12209 00005854 546865726520697320-     	db	"There is not a free partition table entry ", 0
 12209 0000585D 6E6F74206120667265-
 12209 00005866 652070617274697469-
 12209 0000586F 6F6E207461626C6520-
 12209 00005878 656E7472792000     
 12210                                  msg_to_create_new_p: 
 12211 0000587F 746F20637265617465-     	db	"to create a new partition !", 0Dh, 0Ah
 12211 00005888 2061206E6577207061-
 12211 00005891 72746974696F6E2021-
 12211 0000589A 0D0A               
 12212 0000589C 00                      	db	0
 12213                                  msg_no_free_space:
 12214 0000589D 0D0A                    	db	0Dh, 0Ah
 12215 0000589F 546865726520697320-     	db	"There is not (enough) free space ", 0
 12215 000058A8 6E6F742028656E6F75-
 12215 000058B1 676829206672656520-
 12215 000058BA 73706163652000     
 12216                                  
 12217                                  msg_enter_pn_to_del:
 12218 000058C1 0D0A                    	db	0Dh, 0Ah
 12219 000058C3 456E74657220706172-     	db	"Enter partition number to delete: "
 12219 000058CC 746974696F6E206E75-
 12219 000058D5 6D62657220746F2064-
 12219 000058DE 656C6574653A20     
 12220                                  chr_del_pnum1:
 12221 000058E5 00                      	db	0
 12222 000058E6 0D0A00                  	db	0Dh, 0Ah, 0
 12223                                  
 12224                                  msg_delete_partition_q:
 12225 000058E9 0D0A                    	db 	0Dh, 0Ah
 12226 000058EB 5741524E494E472120-     	db 	"WARNING! All of data in the selected partition will be lost", 0Dh, 0Ah
 12226 000058F4 416C6C206F66206461-
 12226 000058FD 746120696E20746865-
 12226 00005906 2073656C6563746564-
 12226 0000590F 20706172746974696F-
 12226 00005918 6E2077696C6C206265-
 12226 00005921 206C6F73740D0A     
 12227 00005928 202020202020202020-     	db	"         after you write changed partition table to disk !!", 0Dh, 0Ah
 12227 00005931 616674657220796F75-
 12227 0000593A 207772697465206368-
 12227 00005943 616E67656420706172-
 12227 0000594C 746974696F6E207461-
 12227 00005955 626C6520746F206469-
 12227 0000595E 736B2021210D0A     
 12228 00005965 0D0A                    	db	0Dh, 0Ah
 12229 00005967 446F20796F75207761-     	db	"Do you want to delete PARTITION "
 12229 00005970 6E7420746F2064656C-
 12229 00005979 657465205041525449-
 12229 00005982 54494F4E20         
 12230                                  chr_del_pnum2:
 12231 00005987 30                      	db	'0'
 12232 00005988 203F2028592F4E2920-     	db	' ? (Y/N) ', 0
 12232 00005991 00                 
 12233                                  
 12234                                  _msg_YES:
 12235 00005992 20                      	db	 20h
 12236                                  msg_YES:
 12237 00005993 5945532000              	db	'YES ', 0
 12238                                  _msg_NO:
 12239 00005998 20                      	db	20h
 12240                                  msg_NO:
 12241 00005999 4E4F2000                	db	'NO ', 0
 12242                                  
 12243                                  ; 11/02/2019
 12244                                  msg_write_masterboot_sector:
 12245 0000599D 0D0A                    	db	0Dh, 0Ah 
 12246 0000599F 577269746520437572-     	db	"Write Current Partition Table:"
 12246 000059A8 72656E742050617274-
 12246 000059B1 6974696F6E20546162-
 12246 000059BA 6C653A             
 12247 000059BD 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12248 000059C1 20312E205772697465-     	db	" 1. Write Partition Table only", 0Dh, 0Ah
 12248 000059CA 20506172746974696F-
 12248 000059D3 6E205461626C65206F-
 12248 000059DC 6E6C790D0A         
 12249 000059E1 20322E205772697465-     	db	" 2. Write Partition Table and Singlix Master Boot Code", 0Dh, 0Ah
 12249 000059EA 20506172746974696F-
 12249 000059F3 6E205461626C652061-
 12249 000059FC 6E642053696E676C69-
 12249 00005A05 78204D617374657220-
 12249 00005A0E 426F6F7420436F6465-
 12249 00005A17 0D0A               
 12250                                  enter_opt_num_cancel_msg:
 12251 00005A19 0D0A                    	db	0Dh, 0Ah
 12252 00005A1B 456E74657220746865-     	db	"Enter the option number or press ESC to cancel ...", 0
 12252 00005A24 206F7074696F6E206E-
 12252 00005A2D 756D626572206F7220-
 12252 00005A36 707265737320455343-
 12252 00005A3F 20746F2063616E6365-
 12252 00005A48 6C202E2E2E00       
 12253                                  
 12254                                  msg_writing_ptable:
 12255 00005A4E 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12256 00005A52 57726974696E672070-     	db	"Writing partition table on disk ... ", 0
 12256 00005A5B 6172746974696F6E20-
 12256 00005A64 7461626C65206F6E20-
 12256 00005A6D 6469736B202E2E2E20-
 12256 00005A76 00                 
 12257                                  _msg_OK:
 12258                                  	;db	7
 12259 00005A77 0D0A                    	db	0Dh, 0Ah
 12260 00005A79 4F4B2021                	db	"OK !"
 12261 00005A7D 0D0A00                  	db	0Dh, 0Ah, 0
 12262                                  
 12263                                  option_input:
 12264 00005A80 205B205D00              	db	' [ ]', 0
 12265                                  
 12266                                  msg_enter_pn_to_act:
 12267 00005A85 0D0A                    	db	0Dh, 0Ah
 12268 00005A87 456E74657220706172-     	db	"Enter partition number to set as active: ", 0
 12268 00005A90 746974696F6E206E75-
 12268 00005A99 6D62657220746F2073-
 12268 00005AA2 657420617320616374-
 12268 00005AAB 6976653A2000       
 12269                                  
 12270                                  ; 04/05/2024
 12271                                  ;trdos386_disk_chs_header:
 12272                                  ;	db	0Dh, 0Ah
 12273                                  ;	db	"                     TRDOS 386 (SINGLIX) HARD DISK IMAGE                        "
 12274                                  ;	db 	0
 12275                                  
 12276                                  ;disk_chs_header:
 12277                                  ;	db	0Dh, 0Ah
 12278                                  ;	db	"                                HARD DISK IMAGE                                 "
 12279                                  ;	db 	0
 12280                                  
 12281                                  msg_partition_size_limit:
 12282 00005AB1 0D0A                    	db	0Dh, 0Ah
 12283 00005AB3 506172746974696F6E-     	db	"Partition size overs available free space !"
 12283 00005ABC 2073697A65206F7665-
 12283 00005AC5 727320617661696C61-
 12283 00005ACE 626C65206672656520-
 12283 00005AD7 73706163652021     
 12284 00005ADE 0D0A                    	db	0Dh, 0Ah
 12285 00005AE0 4D61782E2061766169-     	db 	"Max. available free space is ", 0
 12285 00005AE9 6C61626C6520667265-
 12285 00005AF2 652073706163652069-
 12285 00005AFB 732000             
 12286                                  
 12287                                  msg_partition_size_limit_r:
 12288 00005AFE 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12289 00005B02 28507265737320454E-     	db	"(Press ENTER to use all of available space or press ESC key to retry..) "
 12289 00005B0B 54455220746F207573-
 12289 00005B14 6520616C6C206F6620-
 12289 00005B1D 617661696C61626C65-
 12289 00005B26 207370616365206F72-
 12289 00005B2F 207072657373204553-
 12289 00005B38 43206B657920746F20-
 12289 00005B41 72657472792E2E2920 
 12290 00005B4A 000A00                  	db	0D, 0Ah, 0
 12291                                  
 12292                                  msg_cylinders:
 12293 00005B4D 2063796C696E646572-     	db	" cylinders", 0
 12293 00005B56 7300               
 12294                                  msg_sectors:
 12295 00005B58 20736563746F727300      	db	" sectors", 0
 12296                                  
 12297                                  ; 02/03/2019
 12298                                  msg_megabytes:
 12299 00005B61 206D65676162797465      	db	" megabyte"
 12300                                  msg_megabytes_s:
 12301 00005B6A 0000                    	db	0, 0
 12302                                  
 12303                                  msg_inv_pte:
 12304 00005B6C 0D0A                    	db	0Dh, 0Ah
 12305 00005B6E 496E76616C69642070-     	db	"Invalid partition table entry ! (P"
 12305 00005B77 6172746974696F6E20-
 12305 00005B80 7461626C6520656E74-
 12305 00005B89 72792021202850     
 12306 00005B90 3F290D0A                inv_pte_num: db	"?)", 0Dh, 0Ah
 12307 00005B94 28507265737320454E-     	db	"(Press ENTER to DELETE or press ESC to EXIT..)"
 12307 00005B9D 54455220746F204445-
 12307 00005BA6 4C455445206F722070-
 12307 00005BAF 726573732045534320-
 12307 00005BB8 746F20455849542E2E-
 12307 00005BC1 29                 
 12308 00005BC2 0D0A00                  	db	0Dh, 0Ah, 0
 12309                                  
 12310                                  msg_ext_partition_exists:
 12311 00005BC5 457874656E64656420-     	db	"Extended partition already exists !"
 12311 00005BCE 706172746974696F6E-
 12311 00005BD7 20616C726561647920-
 12311 00005BE0 6578697374732021   
 12312 00005BE8 0D0A00                  	db	0Dh, 0Ah, 0
 12313                                  
 12314                                  msg_defective_pt:
 12315 00005BEB 0D0A                    	db	0Dh, 0Ah
 12316 00005BED 446566656374697665-     	db	"Defective partition table !", 0
 12316 00005BF6 20706172746974696F-
 12316 00005BFF 6E207461626C652021-
 12316 00005C08 00                 
 12317                                  
 12318                                  ; 27/02/2019
 12319                                  msg_ext_part_del_error:
 12320 00005C09 0D0A                    	db	0Dh, 0Ah
 12321 00005C0B 457874656E64656420-     	db	"Extended partition must be deleted after logical drive(s) !"
 12321 00005C14 706172746974696F6E-
 12321 00005C1D 206D75737420626520-
 12321 00005C26 64656C657465642061-
 12321 00005C2F 66746572206C6F6769-
 12321 00005C38 63616C206472697665-
 12321 00005C41 2873292021         
 12322 00005C46 0D0A00                  	db	0Dh, 0Ah, 0
 12323                                  
 12324                                  msg_cancel_continue:
 12325 00005C49 285072657373204553-     	db	"(Press ESC to cancel or press another key to continue..)"
 12325 00005C52 4320746F2063616E63-
 12325 00005C5B 656C206F7220707265-
 12325 00005C64 737320616E6F746865-
 12325 00005C6D 72206B657920746F20-
 12325 00005C76 636F6E74696E75652E-
 12325 00005C7F 2E29               
 12326 00005C81 0D0A00                  	db	0Dh, 0Ah, 0
 12327                                  
 12328                                  msg_delete_ldd:
 12329 00005C84 0D0A                    	db	0Dh, 0Ah
 12330 00005C86 0D0A                    	db	0Dh, 0Ah
 12331 00005C88 44656C657465204C6F-     	db	"Delete Logical (DOS) Drive:"
 12331 00005C91 676963616C2028444F-
 12331 00005C9A 53292044726976653A 
 12332 00005CA3 0D0A                    	db	0Dh, 0Ah
 12333 00005CA5 50726573732044454C-     	db	"Press DELETE key to delete logical disk partition "
 12333 00005CAE 455445206B65792074-
 12333 00005CB7 6F2064656C65746520-
 12333 00005CC0 6C6F676963616C2064-
 12333 00005CC9 69736B207061727469-
 12333 00005CD2 74696F6E20         
 12334 00005CD7 3F2E                    lddp_num: db	"?."
 12335 00005CD9 0D0A00                  	db	0Dh, 0Ah, 0
 12336                                  
 12337                                  msg_delete_ext_part:
 12338 00005CDC 0D0A                    	db	0Dh, 0Ah
 12339 00005CDE 0D0A                    	db	0Dh, 0Ah
 12340 00005CE0 44656C657465204578-     	db	"Delete Extended (DOS) Partition:"
 12340 00005CE9 74656E646564202844-
 12340 00005CF2 4F5329205061727469-
 12340 00005CFB 74696F6E3A         
 12341 00005D00 0D0A                    	db	0Dh, 0Ah
 12342 00005D02 507265737320454E54-     	db	"Press ENTER to delete or press ESC to cancel.."
 12342 00005D0B 455220746F2064656C-
 12342 00005D14 657465206F72207072-
 12342 00005D1D 657373204553432074-
 12342 00005D26 6F2063616E63656C2E-
 12342 00005D2F 2E                 
 12343 00005D30 0D0A00                  	db	0Dh, 0Ah, 0
 12344                                  
 12345                                  str_display_ebr_pt:
 12346 00005D33 285072657373205350-     	db	"(Press SPACE to edit EXTENDED Partition Table)", 0Dh, 0Ah, 0
 12346 00005D3C 41434520746F206564-
 12346 00005D45 697420455854454E44-
 12346 00005D4E 454420506172746974-
 12346 00005D57 696F6E205461626C65-
 12346 00005D60 290D0A00           
 12347                                  
 12348                                  ebr_editing_options:
 12349 00005D64 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 12350 00005D68 457874656E64656420-     	db	"Extended Partition Table Editing Options:" 
 12350 00005D71 506172746974696F6E-
 12350 00005D7A 205461626C65204564-
 12350 00005D83 6974696E67204F7074-
 12350 00005D8C 696F6E733A         
 12351 00005D91 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12352 00005D95 20202020202020312E-     	db	"       1. Create Logical DOS Drive", 0Dh, 0Ah
 12352 00005D9E 20437265617465204C-
 12352 00005DA7 6F676963616C20444F-
 12352 00005DB0 532044726976650D0A 
 12353 00005DB9 20202020202020322E-     	db	"       2. Delete Logical (DOS) Drive(s)",0Dh, 0Ah, 0
 12353 00005DC2 2044656C657465204C-
 12353 00005DCB 6F676963616C202844-
 12353 00005DD4 4F5329204472697665-
 12353 00005DDD 2873290D0A00       
 12354                                  
 12355                                  msg_delete_ldd_q:
 12356 00005DE3 0D0A                    	db 	0Dh, 0Ah
 12357 00005DE5 5741524E494E47210D-     	db 	"WARNING!", 0Dh, 0Ah 
 12357 00005DEE 0A                 
 12358 00005DEF 416C6C206F66206461-     	db	"All of data in logical (DOS) drive(s) will be lost !!", 0Dh, 0Ah
 12358 00005DF8 746120696E206C6F67-
 12358 00005E01 6963616C2028444F53-
 12358 00005E0A 292064726976652873-
 12358 00005E13 292077696C6C206265-
 12358 00005E1C 206C6F73742021210D-
 12358 00005E25 0A                 
 12359 00005E26 0D0A                    	db	0Dh, 0Ah
 12360 00005E28 446F20796F75207761-     	db	"Do you want to continue ? (Y/N) ", 0
 12360 00005E31 6E7420746F20636F6E-
 12360 00005E3A 74696E7565203F2028-
 12360 00005E43 592F4E292000       
 12361                                  
 12362                                  msg_create_ldd_max_error:
 12363 00005E49 0D0A                    	db	0Dh, 0Ah
 12364 00005E4B 50726F6772616D206C-     	db	"Program limit for logical dos drive count is 4 !"
 12364 00005E54 696D697420666F7220-
 12364 00005E5D 6C6F676963616C2064-
 12364 00005E66 6F7320647269766520-
 12364 00005E6F 636F756E7420697320-
 12364 00005E78 342021             
 12365 00005E7B 0D0A00                  	db 	0Dh, 0Ah, 0
 12366                                  
 12367                                  msg_c_ldd_unused_warning:
 12368 00005E7E 0D0A                    	db	0Dh, 0Ah
 12369 00005E80 546865726520697320-     	db	"There is unused extended partition space after logical dos drive "
 12369 00005E89 756E75736564206578-
 12369 00005E92 74656E646564207061-
 12369 00005E9B 72746974696F6E2073-
 12369 00005EA4 706163652061667465-
 12369 00005EAD 72206C6F676963616C-
 12369 00005EB6 20646F732064726976-
 12369 00005EBF 6520               
 12370                                  char_lddn:
 12371 00005EC1 342021                  	db	"4 !"
 12372 00005EC4 0D0A                    	db 	0Dh, 0Ah
 12373 00005EC6 285072657373204553-     	db	"(Press ESC to add unused space or press ENTER to continue.)"	 
 12373 00005ECF 4320746F2061646420-
 12373 00005ED8 756E75736564207370-
 12373 00005EE1 616365206F72207072-
 12373 00005EEA 65737320454E544552-
 12373 00005EF3 20746F20636F6E7469-
 12373 00005EFC 6E75652E29         
 12374 00005F01 0D0A00                  	db 	0Dh, 0Ah, 0
 12375                                  
 12376                                  msg_create_ldd_s:
 12377 00005F04 53656C65637420616E-     	db	"Select an option to set logical dos drive size: "
 12377 00005F0D 206F7074696F6E2074-
 12377 00005F16 6F20736574206C6F67-
 12377 00005F1F 6963616C20646F7320-
 12377 00005F28 64726976652073697A-
 12377 00005F31 653A20             
 12378 00005F34 0D0A                    	db	0Dh, 0Ah
 12379 00005F36 0D0A                    	db	0Dh, 0Ah
 12380 00005F38 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah
 12380 00005F41 6E64657220636F756E-
 12380 00005F4A 740D0A             
 12381 00005F4D 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
 12381 00005F56 6D652070657263656E-
 12381 00005F5F 746167652028232325-
 12381 00005F68 290D0A             
 12382 00005F6B 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
 12382 00005F74 20627974657320284D-
 12382 00005F7D 422C20322A31303234-
 12382 00005F86 2A4D20736563746F72-
 12382 00005F8F 73290D0A           
 12383 00005F93 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
 12383 00005F9C 206279746573202847-
 12383 00005FA5 422C20322A31303234-
 12383 00005FAE 2A313032342A472073-
 12383 00005FB7 6563746F7273290D0A 
 12384 00005FC0 0D0A                    	db	0Dh, 0Ah	
 12385 00005FC2 507265737320535041-     	db	"Press SPACE to use entire space or press ENTER to set Megabytes .. ", 0
 12385 00005FCB 434520746F20757365-
 12385 00005FD4 20656E746972652073-
 12385 00005FDD 70616365206F722070-
 12385 00005FE6 7265737320454E5445-
 12385 00005FEF 5220746F2073657420-
 12385 00005FF8 4D6567616279746573-
 12385 00006001 202E2E2000         
 12386                                  
 12387                                  msg_c_part_error:
 12388 00006006 0D0A                    	db 	0Dh, 0Ah
 12389                                  	;db	"No free space for a new primary partition", 0Dh, 0Ah, 0
 12390                                  	; 21/03/2021
 12391 00006008 4E6F20667265652073-     	db	"No free space for a new primary partition !", 0Dh, 0Ah, 0
 12391 00006011 7061636520666F7220-
 12391 0000601A 61206E657720707269-
 12391 00006023 6D6172792070617274-
 12391 0000602C 6974696F6E20210D0A-
 12391 00006035 00                 
 12392                                  
 12393                                  ; 21/03/2021
 12394                                  ;msg_c_ldd_error: 
 12395                                  ;	db	"and logical dos drives over program limit (4) !", 0Dh, 0Ah, 0
 12396                                  
 12397                                  msg_c_ldd_q:
 12398 00006036 0D0A                    	db	0Dh, 0Ah
 12399 00006038 446F20796F75207761-     	db	"Do you want to create logical dos drive in extended dos partition "
 12399 00006041 6E7420746F20637265-
 12399 0000604A 617465206C6F676963-
 12399 00006053 616C20646F73206472-
 12399 0000605C 69766520696E206578-
 12399 00006065 74656E64656420646F-
 12399 0000606E 732070617274697469-
 12399 00006077 6F6E20             
 12400 0000607A 3F2028592F4E2900        	db	'? (Y/N)', 0
 12401                                  
 12402                                  msg_c_ldd_nofspc_error:
 12403 00006082 0D0A                    	db 	0Dh, 0Ah
 12404 00006084 4E6F20667265652073-     	db	"No free space for a new logical dos drive !", 0Dh, 0Ah, 0
 12404 0000608D 7061636520666F7220-
 12404 00006096 61206E6577206C6F67-
 12404 0000609F 6963616C20646F7320-
 12404 000060A8 647269766520210D0A-
 12404 000060B1 00                 
 12405                                  
 12406                                  	; 12/10/2020
 12407                                  msg_drv_not_ready:
 12408 000060B2 0D0A                    	db	0Dh, 0Ah
 12409 000060B4 4469736B2064726976-     	db	"Disk drive not ready or read error ! "
 12409 000060BD 65206E6F7420726561-
 12409 000060C6 6479206F7220726561-
 12409 000060CF 64206572726F722021-
 12409 000060D8 20                 
 12410 000060D9 0D0A00                  	db	0Dh, 0Ah, 0
 12411                                  
 12412                                  msg_not_any_disks:
 12413 000060DC 0D0A                    	db	0Dh, 0Ah
 12414 000060DE 546865726520697320-     	db	"There is not a hard disk (ready) ! "
 12414 000060E7 6E6F74206120686172-
 12414 000060F0 64206469736B202872-
 12414 000060F9 6561647929202120   
 12415 00006101 0D0A00                  	db	0Dh, 0Ah, 0
 12416                                  
 12417                                  align 4
 12418                                  
 12419                                  msg_sectors_crlf:
 12420 00006104 20736563746F72          	db	" sector"
 12421                                  msg_sectors_crlf_s:
 12422 0000610B 73                      	db	"s"
 12423 0000610C 0D0A00                  	db	0Dh, 0Ah, 0
 12424                                  
 12425                                  vname_length:
 12426 0000610F 00                      	db	0 ; 05/01/2018
 12427                                  
 12428                                  bs_oem_name:
 12429                                  	;db	'TRDOS2.0', 0
 12430                                  	; 04/05/2024
 12431 00006110 524554524F444F5300      	db	'RETRODOS', 0
 12432 00006119 90                      align 2
 12433                                  
 12434                                  no_name:
 12435 0000611A 4E4F204E414D452020-     	db 	'NO NAME    ', 0
 12435 00006123 202000             
 12436                                  
 12437                                  align 2
 12438                                  
 12439                                  FDFORMAT_SECBUFFER:
 12440                                  HDFORMAT_SECBUFFER:
 12441 00006126 F6<rep 200h>            	times	512 db 0F6h
 12442                                  HDFORMAT_FSINFO_BUFF:
 12443 00006326 52526141                	dd	41615252h  ; FSI_LeadSig
 12444 0000632A 00<rep 1E0h>            	times	480 db 0   ; FSI_Reserved1
 12445 0000650A 72724161                	dd	61417272h  ; FSI_StrucSig
 12446 0000650E FFFFFFFF                	dd	0FFFFFFFFh ; FSI_Free_Count
 12447 00006512 02000000                	dd	000000002h ; FSI_Nxt_Free
 12448 00006516 00<rep Ch>              	times	12 db 0	   ; FSI_Reserved2
 12449 00006522 000055AA                	dd	0AA550000h ; FSI_TrailSig
 12450                                  
 12451                                  ; 29/10/2020
 12452                                  msg_100:
 12453 00006526 31303000                	db	'100', 0
 12454                                  
 12455                                  SizeOfFile equ $-100
 12456                                  
 12457                                  ; 03/02/2019
 12458                                  
 12459                                  ;=============================================================================
 12460                                  ;        	uninitialized data
 12461                                  ;=============================================================================
 12462                                  
 12463                                  bss_start:
 12464                                  
 12465                                  ABSOLUTE bss_start
 12466                                  
 12467                                  ; 12/10/2020
 12468 0000652A ??                      DrvNum:	resb 1
 12469 0000652B ??                      hdc:	resb 1
 12470                                  ;hs:	resw 1 ; (bios/dos virtual) head*sectors ; 16/10/2020
 12471 0000652C ??                      rw:	resb 1 
 12472 0000652D ??                      rcnt:	resb 1 ; 18/10/2020
 12473                                  total_sectors:
 12474 0000652E ????????                disksize: resd 1
 12475 00006532 ????????                chs_limit: resd 1
 12476                                  
 12477                                  ; 16/10/2020
 12478                                  ;lba_cyls: resd 1  ; cylinder count calculated from LBA sectors
 12479 00006536 ????                    lba_chs_remain: resw 1	 ; remain sectors after the last cylinder
 12480                                  
 12481                                  alignb 2
 12482 00006538 ????                    old_sp:	resw 1
 12483                                  
 12484                                  HDFORMAT_FATBUFFER:
 12485                                  HDFORMAT_EMPTY_BUFF:
 12486 0000653A <res 200h>              	resb 512
 12487                                  
 12488 0000673A ????????                data_start: resd 1
 12489 0000673E ????????                data_sectors: resd 1
 12490 00006742 ????????                cluster_count: resd 1
 12491 00006746 ????                    root_dir_secs: resw 1
 12492                                  format_percent: ;resw 1
 12493 00006748 ????????                		resd 1 ; 16/03/2021
 12494 0000674C ??                      prev_percent:	resb 1
 12495 0000674D ??                      rsvdbyte:	resb 1
 12496                                  
 12497 0000674E ????                    alignb 4
 12498                                  
 12499                                  ; 05/01/2018
 12500 00006750 <res 40h>               fs_volume_name: resb 64
 12501 00006790 ????????                fs_volume_serial: resd 1
 12502 00006794 ????                    DAT_FFBit:	resw 1
 12503 00006796 ????                    DAT_FFSector:	resw 1
 12504                                  		;resw 1
 12505 00006798 ????                    DAT_LFBit:	resw 1
 12506 0000679A ????                    DAT_LFSector:	resw 1
 12507                                  		;resw 1
 12508                                  
 12509                                  ;alignb 4
 12510                                  
 12511                                  FS_MAT_Buffer: ; TRFS1 Master Allocation Table (05/01/2018)
 12512 0000679C ??????                  MAT_Sign:		resb    3	; Offset 0  ; 'MAT'
 12513 0000679F ??                      MAT_Version:		resb 	1	; 	 3  ; 0	
 12514 000067A0 ????????                MAT_VolumeSize:		resd	1	;	 4  ; FS1 Volume Size
 12515 000067A4 ????????                MAT_BeginSector:	resd	1	;	 8  ; FS1 Start Sector
 12516 000067A8 ????????                DAT_Address:		resd	1	;	12  ; Offset (=2)
 12517 000067AC ????????                DAT_SectorCount:	resd	1	;	16  
 12518 000067B0 ????????                MAT_FreeSectors:	resd 	1	; 	20
 12519 000067B4 ????????                MAT_FirstFreeSector:	resd	1	;	24
 12520                                  ;MAT_OS_Reserved:
 12521                                  ;	 		resb	9
 12522                                  ;MAT_Unused:
 12523                                  ;			resb	112
 12524                                  FS_DAT_Buffer: ; TRFS1 Disk Allocation Table (05/01/2018)
 12525                                  FS_RDT_Buffer: ; TRFS1 Root Directory Description Table (05/01/2018)
 12526 000067B8 <res 200h>              			resb	512
 12527                                  ;alignb 4
 12528                                  
 12529                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
 12530                                  
 12531                                  ;total_sectors: resd 1
 12532 000069B8 ????????                pType:	       resb 4
 12533 000069BC ????????                file_size:     resd 1
 12534 000069C0 ????????                pp_StartSector: resd 1
 12535 000069C4 ????????                pp_Sectors:	resd 1
 12536 000069C8 ??                      wholedisk:	resb 1
 12537 000069C9 ??                      pp_type: resb 1 ; Primary partition type (for this program)
 12538 000069CA ??                      pp_type_user: resb 1
 12539 000069CB ??                      chs_focus: resb 1
 12540 000069CC ????????                pSize_temp: resd 1
 12541 000069D0 ????????                pSize_multiplier: resd 1
 12542 000069D4 ??                      pSize_maxdigits: resb 1
 12543 000069D5 ??                      pSize_digitpos: resb 1
 12544                                  msg_psize_unit:
 12545 000069D6 ????                    pSize_unit:	resw 1
 12546 000069D8 ??                      		resb 1
 12547                                  ; 06/11/2020
 12548                                  ;reserved_bytes: resb 3 ; for 11 bytes of numbers
 12549                                  msg_partition_sectors:
 12550                                  		;resb 8
 12551 000069D9 <res Bh>                		resb 11 ; 06/11/2020
 12552 000069E4 ??                      		resb 1
 12553 000069E5 ??                      format_q:	resb 1 ; 03/02/2018
 12554                                  
 12555                                  ;alignb 2
 12556 000069E6 ??                      pType_pos:	resb 1
 12557 000069E7 ??                      pType_num:	resb 1
 12558 000069E8 ??                      		resb 1
 12559                                  ;cylinder_boundary:
 12560 000069E9 ??                      		resb 1
 12561                                  ; 05/11/2020
 12562                                  
 12563                                  alignb 2
 12564                                  
 12565 000069EA ??                      GetChar:	resb 1 ; 11/02/2019
 12566 000069EB ??                      		resb 1 ; 06/11/2020
 12567                                  
 12568                                  hs: ; 17/10/2020 ; (bios/dos virtual) head*sectors
 12569 000069EC ????                    min_sectors:	resw 1 ; 08/02/2019
 12570 000069EE ????                    		resw 1 ; 06/11/2020
 12571 000069F0 ????                    pp_StartCylinder: resw 1
 12572 000069F2 ????                    		resw 1 ; 06/11/2020
 12573 000069F4 ????                    pp_EndCylinder:	resw 1
 12574 000069F6 ????                    		resw 1 ; 06/11/2020
 12575                                  
 12576 000069F8 ????????                ppn_Sectors:	resd 1 ; 09/02/2019
 12577                                  
 12578 000069FC ????                    input_col:	resw 1
 12579 000069FE ??                      No:		resb 1
 12580 000069FF ??                      Yes:		resb 1
 12581                                  
 12582                                  ; 26/02/2019
 12583 00006A00 ??                      ldrives:	resb 1
 12584                                  
 12585                                  ;sort_1:	resb 1
 12586 00006A01 ??                      		resb 1 ; 23/10/2020
 12587 00006A02 ????????                sort:		resb 4
 12588                                  
 12589                                  ;max_sector:	resb 8
 12590                                  ebr_buffer:		; 26/02/2019
 12591 00006A06 <res 200h>              boot_record:	resb 512
 12592                                  
 12593 00006C06 ??                      valid_input:	resb 1
 12594 00006C07 ??                      		resb 1
 12595                                  
 12596                                  ; 26/02/2019
 12597 00006C08 ????????                ep_StartSector:	resd 1
 12598 00006C0C ????????                ep_EndSector:	resd 1
 12599 00006C10 ????????                ep_Size:	resd 1
 12600                                  
 12601                                  ; 10/02/2019
 12602 00006C14 ????????                valid_ppnums:	resb 4
 12603                                  
 12604 00006C18 ????                    _i_:	resw 1
 12605                                  
 12606                                  freespace_count: ; resw 1 
 12607 00006C1A ??                      		resb 1 ; 12/03/2021
 12608                                  
 12609 00006C1B ??                      last_found_partition: resb 1
 12610 00006C1C ??                      p_type: resb 1
 12611                                  
 12612                                  ; 30/10/2020
 12613                                  ;p_sorted:
 12614                                  ;	resb 1
 12615                                  ;ep_sorted:
 12616                                  ;	resb 1
 12617                                  
 12618 00006C1D ??                      _e_:	resb 1
 12619                                  
 12620                                  act_part_num:
 12621                                  cre_part_num:
 12622 00006C1E ??                      del_part_num: resb 1 ; 10/02/2019
 12623                                  
 12624 00006C1F ??                      alignb 2
 12625                                  
 12626 00006C20 <res 50h>               pte_row: resb 80
 12627                                  
 12628 00006C70 ??                      _zero_:	resb 1
 12629                                  
 12630                                  ;alignb 2
 12631                                  
 12632 00006C71 ??                      	resb 1
 12633                                  
 12634                                  bss_clear_end: ; 15/02/2019
 12635                                  
 12636                                  ; 05/11/2020
 12637                                  
 12638                                  ; PARTITION DATA STRUCTURE
 12639                                  ; 4 partitions
 12640                                  ; 22 byte partition data structure per partition
 12641                                  ; 88 bytes (4*22)
 12642                                  
 12643 00006C72 ??                      part_table_boot_ind:	 resb 1
 12644 00006C73 ??                      part_table_start_head:	 resb 1
 12645 00006C74 ??                      part_table_start_sector: resb 1
 12646                                  ;part_table_start_cyl:	 resw 1
 12647 00006C75 ????????                part_table_start_cyl:	 resd 1
 12648 00006C79 ??                      part_table_sys_id:	 resb 1
 12649 00006C7A ??                      part_table_end_head:	 resb 1
 12650 00006C7B ??                      part_table_end_sector:	 resb 1
 12651                                  ;part_table_end_cyl:	 resw 1
 12652 00006C7C ????????                part_table_end_cyl:	 resd 1
 12653                                  ;part_table_rel_sec_lw:	 resw 1
 12654                                  ;part_table_rel_sec_hw:	 resw 1
 12655 00006C80 ????????                part_table_rel_sec:	 resd 1
 12656                                  ;part_table_num_sec_lw:	 resw 1
 12657                                  ;part_table_num_sec_hw:	 resw 1
 12658 00006C84 ????????                part_table_num_sec:	 resd 1
 12659                                  
 12660 00006C88 <res 42h>               			resb 66 ; 3*22 bytes
 12661                                  
 12662 00006CCA ??                      pcount:		resb 1
 12663 00006CCB ??                      ppcount:	resb 1
 12664 00006CCC ??                      apcount:	resb 1
 12665 00006CCD ??                      epnumber:	resb 1
 12666                                  
 12667                                  ; 05/11/2020
 12668                                  
 12669                                  ; LOGICAL PARTITION DATA STRUCTURE
 12670                                  ; (for logical partitions in extended partition)
 12671                                  
 12672                                  ; 1 extended partition
 12673                                  ; 4 logical drives (22 bytes)
 12674                                  ; 88 bytes (4*22)
 12675                                  
 12676 00006CCE ??                      ext_table_boot_ind:	resb 1
 12677 00006CCF ??                      ext_table_start_head:	resb 1
 12678 00006CD0 ??                      ext_table_start_sector: resb 1
 12679                                  ;ext_table_start_cyl:	resw 1
 12680 00006CD1 ????????                ext_table_start_cyl:	resd 1
 12681 00006CD5 ??                      ext_table_sys_id:	resb 1
 12682 00006CD6 ??                      ext_table_end_head:	resb 1
 12683 00006CD7 ??                      ext_table_end_sector:	resb 1
 12684                                  ;ext_table_end_cyl:	resw 1
 12685 00006CD8 ????????                ext_table_end_cyl:	resd 1
 12686                                  ;ext_table_rel_sec_lw:	resw 1
 12687                                  ;ext_table_rel_sec_hw:	resw 1
 12688 00006CDC ????????                ext_table_rel_sec:	resd 1
 12689                                  ;ext_table_num_sec_lw:	resw 1
 12690                                  ;ext_table_num_sec_hw:	resw 1
 12691 00006CE0 ????????                ext_table_num_sec:	resd 1
 12692                                  
 12693 00006CE4 <res 42h>               			resb 66 ; 3*22 bytes
 12694                                  ; 05/11/2020
 12695                                  
 12696                                  fspc:		; 5*11 words (for free space calculations)
 12697                                  
 12698                                  ; Space 1 - unused cylinders before partition 0
 12699                                  ; Space 2 - unused cylinders between partition 0 & 1
 12700                                  ; Space 3 - unused cylinders between partition 1 & 2
 12701                                  ; Space 4 - unused cylinders between partition 2 & 3
 12702                                  ; Space 5 - unused cylinders after partition 3
 12703                                  
 12704 00006D26 ????????                free_space.space:   	   resd 1
 12705 00006D2A ????????                free_space.start:   	   resd 1
 12706 00006D2E ????????                free_space.end:	   	   resd 1
 12707 00006D32 ????????                free_space.sectors_unused: resd 1
 12708 00006D36 ????????                free_space.startsector:   resd 1 ; 13/02/2019
 12709 00006D3A ????                    free_space.percent_unused: resw 1
 12710                                  
 12711 00006D3C <res 58h>               		resw   4*11 ; 4*22 bytes ; 05/11/2020
 12712                                  
 12713                                  ; 05/11/2020
 12714                                  ;c_cylinder:	resd 1
 12715                                  ; 18/02/2019
 12716                                  ;c_cylinder:	resw 1
 12717 00006D94 ????                    c_fspc_offset:	resw 1
 12718 00006D96 ??                      cylinder_boundary: resb 1
 12719                                  ;c_gap:		resb 1
 12720 00006D97 ??                      		resb 1
 12721                                  
 12722                                  ; 27/02/2019
 12723 00006D98 <res 10h>               ldd_start:	resd 4
 12724                                  ; 03/03/2019
 12725 00006DA8 <res 10h>               ldd_size:	resd 4
 12726                                  ; 30/10/2020
 12727 00006DB8 ????????                ep_free_sectors: resd 1
 12728                                  
 12729                                  ; 05/11/2020
 12730 00006DBC ????????                lcylinders:	resd 1
 12731                                  ; 25/02/2019
 12732 00006DC0 ????                    pte_address:	resw 1
 12733                                  ; 02/03/2019
 12734                                  ;lcylinders:	resw 1
 12735                                  ; 01/11/2020
 12736 00006DC2 ????                    endcyl:		resw 1
 12737 00006DC4 ????                    		resw 1 ; 13/03/2021
 12738                                  
 12739                                  ;bss_clear_end: ; 18/02/2019
 12740                                  
 12741                                  ; 11/10/2020
 12742                                  ;gdp_buffer:	resb 30 ; buffer for int 13h, ah = 48h
 12743 00006DC6 <res 1Ah>               gdp_buffer:	resb 26 ; buffer for int 13h, ah = 48h
 12744                                  
 12745                                  bss_end:
