     1                                  ; ****************************************************************************
     2                                  ; FDISK4R5.ASM (FDISK4R5.COM) - Retro DOS v5 Hard Disk Partitioning Utility
     3                                  ; fdisk4.s						(for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; 32 bit cylinder numbers modification on fdisk3.s (2TB hardisk partitioning)
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Last Update: 15/07/2024
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Beginning: 05/11/2020
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Assembler: NASM version 2.15
    12                                  ; ----------------------------------------------------------------------------
    13                                  ; Modified from 'FDISK4.ASM' (FDISK4.COM) source code by Erdogan Tan
    14                                  ; (04/05/2024) - TRDOS 386 v2 fixed disk partitioning utility -
    15                                  ; ****************************************************************************
    16                                  ; nasm fdisk4r5.s -l fdisk4r5.txt -o FDISK4R5.COM -Z error.txt
    17                                  
    18                                  ; Masterboot / Partition Table at Beginning+1BEh
    19                                  ptBootable      equ 0
    20                                  ptBeginHead     equ 1
    21                                  ptBeginSector   equ 2
    22                                  ptBeginCylinder equ 3
    23                                  ptFileSystemID	equ 4
    24                                  ptEndHead       equ 5
    25                                  ptEndSector     equ 6
    26                                  ptEndCylinder   equ 7
    27                                  ptStartSector   equ 8
    28                                  ptSectors       equ 12
    29                                  
    30                                  ; BIOS Disk Parameters
    31                                  DPDiskNumber  equ 0h
    32                                  DPDType       equ 1h
    33                                  DPReturn      equ 2h
    34                                  DPHeads       equ 3h
    35                                  DPCylinders   equ 4h
    36                                  DPSecPerTrack equ 6h
    37                                  DPDisks       equ 7h
    38                                  DPTableOff    equ 8h
    39                                  DPTableSeg    equ 0Ah
    40                                  DPNumOfSecs   equ 0Ch
    41                                  
    42                                  ; BIOS INT 13h Extensions (LBA extensions)
    43                                  ; Just After DP Data (DPDiskNumber+)
    44                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    45                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    46                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    47                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    48                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    49                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    50                                                          ; C1= Selected Cylinder Number
    51                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    52                                                          ; H1= Selected Head Number
    53                                                          ; S0= Maximum Sector Number
    54                                                          ; S1= Selected Sector Number
    55                                                          ; QUAD WORD
    56                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    57                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    58                                                               ; TR-DOS will not use 64 bit Flat Address
    59                                  
    60                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    61                                  ; Just After DP Data (DPDiskNumber+)
    62                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
    63                                  GDP_48h_InfoFlag equ 22h ; Word
    64                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
    65                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
    66                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
    67                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
    68                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
    69                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
    70                                  
    71                                  pTableOffset equ 1BEh ; 446
    72                                  
    73                                  	; Convert LBA to CHS
    74                                  	; 08/02/2019
    75                                  
    76                                  	; LBA = ((C1*H0+H1)*S0)+S1-1
    77                                  	;
    78                                  	; C1 = Selected Cylinder Number
    79                                  	; H0 = Number of Heads (Maximum Head Number + 1)
    80                                  	; H1 = Selected Head Number
    81                                  	; S0 = Maximum Sector Number
    82                                  	; S1 = Selected Sector Number
    83                                  	;
    84                                  	; Phoenix, Enchanced Disk Drive Specicifications, v1.1, Page 8)
    85                                  
    86                                  [BITS 16]
    87                                  [ORG 100h]
    88                                  
    89                                  ; Note: 80386 cpu is required (this program will not run on 80286 systems)
    90                                  
    91                                  	; Detect 80386 cpu (386+)
    92                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    93                                  ; detect 386+ cpu
    94                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    95                                  ; 06/11/2020
    96                                  	; (https://forum.osdev.org/viewtopic.php?p=36822)
    97                                  	; (ogotay)
    98                                  
    99 00000000 9C                      	pushf
   100 00000001 B4D0                    	mov	ah, 0D0h
   101 00000003 50                      	push	ax
   102 00000004 9D                      	popf
   103 00000005 9C                      	pushf
   104 00000006 58                      	pop	ax
   105 00000007 9D                      	popf
   106 00000008 80FC50                  	cmp	ah, 50h
   107 0000000B 7408                    	je	short _386_ok
   108                                  	
   109                                  	; Write program message and terminate
   110                                  
   111 0000000D BE[B640]                	mov	si, TrDOS_Welcome
   112 00000010 E8AC19                  	call	print_msg
   113                                  	
   114 00000013 CD20                    	int	20h
   115                                  
   116                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   117                                  _386_ok:
   118                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   119                                  
   120                                  	;cli
   121                                  	;cld
   122                                  	;push	cs
   123                                  	;pop	ss
   124                                  	;mov	sp, 0FFFEh
   125                                  	;sti
   126                                  	
   127                                  	;mov	bx, SizeOfFile+100
   128                                  	
   129 00000015 BB[F46D]                	mov	bx, bss_end
   130                                  
   131 00000018 83C30F                          add	bx, 15
   132 0000001B D1EB                            shr	bx, 1
   133 0000001D D1EB                            shr	bx, 1
   134 0000001F D1EB                    	shr	bx, 1
   135 00000021 D1EB                    	shr	bx, 1
   136 00000023 B44A                            mov	ah, 4Ah ; modify memory allocation
   137                                          ;push	cs
   138                                          ;pop	es
   139 00000025 CD21                            int	21h
   140                                  
   141                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   142                                  ; clear BSS
   143                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   144                                  ; 03/02/2019
   145                                  
   146                                  	;mov	cx, bss_end
   147 00000027 B9[866C]                	mov	cx, bss_clear_end ; 15/02/2019
   148                                  
   149 0000002A BF[3E65]                	mov	di, bss_start
   150 0000002D 29F9                    	sub	cx, di
   151 0000002F 41                      	inc	cx
   152 00000030 D1E9                    	shr	cx, 1
   153 00000032 31C0                    	xor	ax, ax
   154 00000034 F3AB                    	rep	stosw 
   155                                  
   156                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   157                                  ; display program name & version
   158                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   159                                  
   160 00000036 BE[B640]                	mov	si, TrDOS_Welcome
   161 00000039 E88319                  	call	print_msg
   162                                  
   163                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   164                                  ; get hard disk name
   165                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   166                                  ; 11/10/2020
   167                                  
   168 0000003C BE8000                  	mov	si, 80h			; PSP command tail
   169 0000003F AC                       	lodsb
   170 00000040 08C0                    	or	al, al 			; command tail length
   171 00000042 7431                    	jz	short A_05		; jump if zero
   172                                  A_01:
   173 00000044 AC                      	lodsb
   174 00000045 3C20                    	cmp	al, ' '			; is it SPACE ?
   175 00000047 74FB                    	je	short A_01
   176 00000049 722A                    	jb	short A_05
   177                                  	
   178                                  	; check disk name
   179                                  
   180 0000004B 3C68                    	cmp	al, 'h'
   181 0000004D 751B                    	jne	short A_03
   182 0000004F 803C64                  	cmp	byte [si], 'd'
   183 00000052 7516                    	jne	short A_03
   184 00000054 46                      	inc	si
   185 00000055 AC                      	lodsb
   186 00000056 3C30                    	cmp	al, '0'
   187 00000058 7406                    	je	short A_02
   188 0000005A 720E                    	jb	short A_03
   189 0000005C 3C33                    	cmp	al, '3'
   190 0000005E 770A                    	ja	short A_03
   191                                  A_02:
   192 00000060 803C20                  	cmp	byte [si], ' '
   193 00000063 720B                    	jb	short A_04
   194 00000065 7703                    	ja	short A_03
   195 00000067 46                      	inc	si
   196 00000068 EBF6                    	jmp	short A_02
   197                                  A_03:
   198 0000006A BE[1741]                	mov	si, TrDOS_Usage
   199 0000006D E90207                  	jmp	_p_exit
   200                                  A_04:
   201 00000070 0450                    	add	al, 80h - '0'
   202 00000072 A2[3E65]                	mov	[DrvNum], al	; 80h .. 83h
   203                                  
   204                                  A_05:
   205                                  
   206                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   207                                  ; get hard disk parameters 
   208                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   209                                  ; 11/10/2020
   210                                  
   211                                  	; check bios int 13h extensions
   212 00000075 B441                    	mov	ah, 41h
   213 00000077 BBAA55                  	mov	bx, 55AAh
   214 0000007A B280                    	mov	dl, 80h
   215 0000007C CD13                    	int	13h
   216 0000007E 720B                    	jc	short A_06
   217 00000080 81FB55AA                	cmp	bx, 0AA55h
   218 00000084 7505                    	jne	short A_06
   219                                  
   220 00000086 C606[9E2E]01            	mov	byte [int13h_x], 1
   221                                  A_06:
   222                                  	;mov	dl, 80h	 ; hd0
   223 0000008B B408                    	mov	ah, 08h  ; return disk parameters
   224 0000008D CD13                    	int	13h	
   225 0000008F 7313                    	jnc	short A_10
   226                                  A_07:
   227 00000091 803E[3E65]80            	cmp 	byte [DrvNum], 80h  ; hard disk name option ?
   228 00000096 7206                    	jb	short A_09 ; no, default
   229                                  A_08:
   230 00000098 BE[C660]                	mov	si, msg_drv_not_ready ; drive not ready
   231 0000009B E9D406                  	jmp	_p_exit
   232                                  A_09:
   233 0000009E BE[F060]                	mov	si, msg_not_any_disks ; there is not a hard disk
   234 000000A1 E9CE06                  	jmp	_p_exit
   235                                  A_10:
   236 000000A4 08E4                    	or	ah, ah	 ; ah = 0 ?
   237 000000A6 75E9                    	jnz	short A_07  ; no, there is an error !
   238                                  	
   239 000000A8 8816[3F65]              	mov	[hdc], dl ; number of hard disks
   240                                  
   241 000000AC A0[3E65]                	mov	al, [DrvNum]
   242                                  
   243 000000AF 3C80                    	cmp	al, 80h
   244 000000B1 7308                    	jnb	short A_11 ; option
   245                                  	; default
   246 000000B3 C606[3E65]80            	mov	byte [DrvNum], 80h
   247 000000B8 E98D00                  	jmp	A_14
   248                                  A_11:
   249                                  	; hard disk name option
   250 000000BB 80C27F                  	add	dl, 7Fh
   251                                  
   252 000000BE 38D0                    	cmp	al, dl
   253 000000C0 77D6                    	ja	short A_08
   254                                  
   255 000000C2 80FA80                  	cmp	dl, 80h
   256 000000C5 760C                    	jna	short A_13 ; hd0 parameters are ready 
   257                                  A_12:
   258 000000C7 88C2                    	mov	dl, al ; [DrvNum]
   259                                  
   260 000000C9 B408                    	mov	ah, 08h  ; return (get) disk parameters
   261 000000CB CD13                    	int	13h	
   262 000000CD 72C2                    	jc	short A_07
   263 000000CF 08E4                    	or	ah, ah
   264 000000D1 75BE                    	jnz	short A_07
   265                                  A_13:
   266 000000D3 88C8                    	mov	al, cl
   267 000000D5 243F                    	and	al, 3Fh ; 63
   268 000000D7 C0E906                  	shr	cl, 6
   269 000000DA 86E9                    	xchg	ch, cl
   270 000000DC 41                      	inc	cx
   271 000000DD 41                      	inc	cx ; 15/10/2020 ; BIOS BugFix
   272                                  				; (for reserved last cylinder)
   273 000000DE 890E[B63C]              	mov	[cylinders], cx
   274                                  	;mov	word [cylinders+2], 0 ; 16/10/2020
   275 000000E2 FEC6                    	inc	dh
   276 000000E4 8836[B43C]              	mov	[heads], dh
   277 000000E8 A2[B23C]                	mov	[sectors], al
   278 000000EB F6E6                    	mul	dh
   279 000000ED A3[006A]                	mov	[hs], ax ; heads*sectors ; 15/10/2020
   280 000000F0 F7E1                    	mul	cx
   281 000000F2 A3[4265]                	mov	[disksize], ax
   282 000000F5 8916[4465]              	mov	[disksize+2], dx
   283 000000F9 83E801                  	sub	ax, 1	; 17/10/2020
   284 000000FC 83DA00                  	sbb	dx, 0
   285 000000FF A3[4665]                	mov	[chs_limit], ax
   286 00000102 8916[4865]              	mov	[chs_limit+2], dx
   287                                  
   288 00000106 803E[9E2E]01            	cmp	byte [int13h_x], 1
   289 0000010B 0F82D500                	jb	A_20
   290                                  
   291 0000010F BE[DA6D]                	mov	si, gdp_buffer
   292                                  	;mov	word [si], 30 ; buffer length (minimum)
   293 00000112 C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   294 00000116 B448                    	mov	ah, 48h
   295 00000118 8A16[3E65]              	mov	dl, [DrvNum]
   296 0000011C CD13                    	int	13h
   297 0000011E 0F82C200                	jc	A_20
   298 00000122 20E4                    	and	ah, ah
   299 00000124 0F85BC00                	jnz	A_20
   300                                  
   301                                  	; 06/11/2020
   302                                  	; number of physical sectors
   303                                  	;mov	ax, [si+16]
   304                                  	;mov	dx, [si+18]
   305                                  	;mov	[disksize], ax
   306                                  	;mov	[disksize+2], dx
   307                                  	
   308 00000128 668B4410                	mov	eax, [si+16]
   309 0000012C 66A3[4265]              	mov	[disksize], eax
   310 00000130 6631D2                  	xor	edx, edx
   311                                  
   312                                  	; 15/10/2020
   313                                  	;mov	cx, [hs]
   314                                  	;call	div32
   315                                  	;; 16/10/2020
   316                                  	;;mov	[lba_cyls], ax
   317                                  	;;mov	[lba_cyls+2], dx
   318                                  	;mov	[cylinders], ax
   319                                  	;mov	[cylinders+2], dx
   320                                  	;mov	[lba_chs_remain], bx
   321                                  
   322                                  	; 06/11/2020
   323 00000133 66F736[006A]            	div 	dword [hs]
   324 00000138 66A3[B63C]              	mov	[cylinders], eax
   325 0000013C 8916[4A65]              	mov	[lba_chs_remain], dx
   326                                  	; reset
   327 00000140 6631C0                  	xor	eax, eax
   328                                  	;xor	edx, edx
   329 00000143 31D2                    	xor	dx, dx
   330                                  
   331 00000145 E99C00                  	jmp	A_20
   332                                  A_14:
   333 00000148 80FA01                  	cmp	dl, 1
   334 0000014B 7686                    	jna	short A_13 ; [DrvNum] = 80h
   335                                  
   336 0000014D 80C230                  	add	dl, '0' ; '2' to '4'
   337 00000150 8816[DC41]              	mov	byte [TrDOS_dnmax], dl
   338                                  
   339 00000154 BE[BE41]                	mov	si, TrDOS_Options
   340 00000157 E86518                  	call	print_msg
   341                                  
   342                                  	; check bios int 13h extensions
   343 0000015A 803E[9E2E]01            	cmp	byte [int13h_x], 1
   344 0000015F 732D                    	jnb	short A_16
   345                                  A_15:
   346 00000161 8A16[3E65]              	mov	dl, [DrvNum]
   347 00000165 B408                    	mov	ah, 08h  ; return disk parameters
   348 00000167 CD13                    	int	13h	
   349 00000169 724D                    	jc	short A_17
   350 0000016B 08E4                    	or	ah, ah
   351 0000016D 7549                    	jnz	short A_17
   352                                  
   353 0000016F 88C8                    	mov	al, cl
   354 00000171 243F                    	and	al, 3Fh ; 63
   355 00000173 C0E906                  	shr	cl, 6
   356 00000176 86E9                    	xchg	ch, cl
   357 00000178 41                      	inc	cx
   358 00000179 FEC6                    	inc	dh
   359 0000017B F6E6                    	mul	dh
   360 0000017D F7E1                    	mul	cx
   361                                  
   362                                  	; dx:ax = disk size
   363                                  
   364 0000017F E85602                  	call	display_hd_row
   365                                  
   366 00000182 FE0E[3F65]              	dec	byte [hdc]
   367 00000186 7430                    	jz	short A_17
   368 00000188 FE06[3E65]              	inc	byte [DrvNum]
   369 0000018C EBD3                    	jmp	short A_15
   370                                  A_16:
   371 0000018E BE[DA6D]                	mov	si, gdp_buffer
   372                                  	;mov	word [si], 30 ; buffer length (minimum)
   373 00000191 C7041A00                	mov	word [si], 26 ; buffer length (minimum)
   374 00000195 B448                    	mov	ah, 48h
   375 00000197 8A16[3E65]              	mov	dl, [DrvNum]
   376 0000019B CD13                    	int	13h
   377 0000019D 72C2                    	jc	short A_15
   378 0000019F 20E4                    	and	ah, ah
   379 000001A1 75BE                    	jnz	short A_15
   380                                  
   381                                  	; number of phsical sectors
   382 000001A3 8B4410                  	mov	ax, [si+16]
   383 000001A6 8B5412                  	mov	dx, [si+18]
   384                                  
   385                                  	; dx:ax = disk size
   386                                  
   387 000001A9 E82C02                  	call	display_hd_row
   388                                  
   389 000001AC FE0E[3F65]              	dec	byte [hdc]
   390 000001B0 7406                    	jz	short A_17
   391 000001B2 FE06[3E65]              	inc	byte [DrvNum]
   392 000001B6 EBD6                    	jmp	short A_16
   393                                  A_17:
   394 000001B8 BE[6C52]                	mov	si, CRLF
   395 000001BB E80118                  	call	print_msg
   396                                  
   397                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   398                                  ; hard disk number input (getchar)
   399                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   400                                  ; 11/10/2020
   401                                  	
   402                                  A_18:
   403 000001BE 31C0                    	xor	ax, ax
   404 000001C0 CD16                    	int	16h			; wait for keyboard command
   405                                  
   406 000001C2 83F800                  	cmp	ax, 0			; CTRL+BREAK
   407 000001C5 761A                    	jna	short A_19
   408                                  
   409 000001C7 3C03                    	cmp	al, 'C'-40h		; 3
   410 000001C9 7416                    	je	short A_19             	; CTRL+C
   411 000001CB 3C1B                    	cmp	al, 27			; ESCape
   412 000001CD 7412                    	je	short A_19
   413                                  
   414 000001CF 3C31                    	cmp	al, '1'			; "(1) hd0" 
   415 000001D1 72EB                    	jb	short A_18		; retry
   416 000001D3 3A06[DC41]              	cmp	al, [TrDOS_dnmax]	; ('2' to '4')
   417 000001D7 77E5                    	ja	short A_18		; retry
   418 000001D9 044F                    	add	al, 80h-'1'		; bios disk num (80h-83h)
   419 000001DB A2[3E65]                	mov	[DrvNum], al
   420 000001DE E9E6FE                  	jmp	A_12			; get disk parameters
   421                                  A_19:
   422 000001E1 E99105                  	jmp	_exit			; Exit
   423                                  
   424                                  A_20:
   425                                  
   426                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   427                                  ; read masterboot sector
   428                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   429                                  ; 12/10/2020
   430                                  
   431 000001E4 BB[E852]                	mov	bx, MasterBootBuff
   432 000001E7 B90100                  	mov	cx, 1	; cylinder = 0
   433                                  			; sector = 1
   434 000001EA B600                    	mov	dh, 0	; head = 0
   435 000001EC 8A16[3E65]              	mov	dl, [DrvNum]
   436 000001F0 B80102                  	mov	ax, 0201h ; read one sector
   437 000001F3 CD13                    	int	13h
   438 000001F5 7306                    	jnc	short A_21
   439                                  
   440 000001F7 BE[C660]                	mov	si, msg_drv_not_ready ; drive not ready
   441 000001FA E98000                  	jmp	A_26
   442                                  A_21:
   443                                  
   444                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   445                                  ; display CHS values and disk size (LBA) and partition table
   446                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   447                                  ; 12/10/2020
   448                                  
   449 000001FD B80300                  	mov	ax, 3  ; clear screen
   450 00000200 CD10                    	int	10h
   451                                  
   452 00000202 E8E01E                  	call	init_partition_table ; 13/10/2020
   453                                  
   454 00000205 E83419                  	call	display_chs_table
   455                                  
   456 00000208 A1[4265]                	mov	ax, [disksize]
   457 0000020B 8B16[4465]              	mov	dx, [disksize+2]
   458                                  
   459 0000020F 81FA0001                	cmp	dx, 256 ; >= 8GB
   460 00000213 7315                    	jnb	short A_22
   461                                  
   462                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   463                                  	;div	cx
   464                                  
   465                                  	; shift dx:ax to 8 bits right (/256)
   466 00000215 88E0                    	mov	al, ah
   467 00000217 88D4                    	mov	ah, dl
   468 00000219 C1E803                  	shr	ax, 3 ; /8 
   469                                  		; result = (dx:ax)/2048
   470                                  
   471                                  	; ax =  0 to 8191
   472                                  
   473 0000021C C606[1242]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   474 00000221 EB11                    	jmp	short A_23
   475                                  
   476                                  
   477                                  A_29:	; 16/10/2020
   478 00000223 E85425                  	call	partition_table_fix
   479 00000226 73D5                    	jnc	short A_21
   480                                  
   481 00000228 CD20                    	int	20h
   482                                  ;here:	
   483                                  	;jmp	short here
   484                                  
   485                                  A_22:
   486                                  	; 1024 MB = 1GB (2097152 sectors)
   487                                  	; DX/32 --> GB
   488 0000022A 89D0                    	mov	ax, dx
   489 0000022C C1E805                  	shr	ax, 5 ; /32
   490                                  
   491                                  	; ax = 8 to 2047
   492 0000022F C606[1242]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   493                                  A_23:
   494                                  	;xor	dx, dx
   495 00000234 BE[1842]                	mov	si, TrDOS_hdrow_capacity
   496 00000237 E8DD01                  	call	convert_to_decimal
   497                                  
   498 0000023A BE[1F42]                	mov	si, TrDOS_disksize
   499 0000023D E87F17                  	call	print_msg
   500                                  
   501 00000240 BE[1842]                	mov	si, TrDOS_hdrow_capacity
   502 00000243 E87917                  	call	print_msg
   503                                  
   504 00000246 BE[1242]                	mov	si, TrDOS_hdrow_unit
   505 00000249 E87317                  	call	print_msg
   506                                  
   507                                  	; 05/11/2020
   508                                  	; fdisk4 can be used for 2TB hard disks 
   509                                  	;	(because of 32 bit virtual cylinder number)
   510                                   	; (fdisk3 limit is 502GB disks size and 65535 cylinders)
   511                                  
   512                                  	;; 16/10/2020
   513                                  	;;cmp	word [lba_cyls+2], 0
   514                                  	;cmp	word [cylinders+2], 0
   515                                  	;ja	short A_27  ; Huge disk ! number of (lba) cylinders > 65335
   516                                  	;		    ; Current FDISK version (v3) can not be used !
   517                                  
   518 0000024C BE[6C52]                	mov	si, CRLF
   519 0000024F E86D17                  	call	print_msg
   520                                  
   521 00000252 E87C23                  	call	dpt_1
   522                                  
   523 00000255 BE[6C52]                	mov	si, CRLF
   524 00000258 E86417                  	call	print_msg
   525                                  
   526                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   527                                  ; display edit or exit option, getchar
   528                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   529                                  
   530 0000025B BE[9B50]                	mov	si, msg_edit_or_exit
   531 0000025E E85E17                  	call	print_msg
   532                                  A_24:
   533 00000261 30E4                    	xor	ah, ah
   534 00000263 CD16                    	int	16h
   535                                  
   536 00000265 3C0D                    	cmp	al, 13 ; CR (ENTER) key
   537 00000267 7419                    	je	short A_28 
   538                                  
   539 00000269 3C1B                    	cmp	al, 27 ; ESCape key
   540 0000026B 740D                    	je	short A_25
   541                                  
   542 0000026D 3C20                    	cmp	al, 32 ; SPACE key
   543 0000026F 7411                    	je	short A_28
   544                                  
   545 00000271 3C03                    	cmp	al, 3 ; CTRL+C
   546 00000273 7405                    	je	short A_25
   547                                  
   548 00000275 83F800                  	cmp	ax, 0 ; CTRL+BREAK
   549 00000278 77E7                    	ja	short A_24
   550                                  A_25:
   551 0000027A BE[6C52]                	mov	si, CRLF
   552                                  A_26:
   553 0000027D E83F17                  	call	print_msg
   554                                  
   555 00000280 CD20                    	int	20h
   556                                  ;here:
   557                                  ;	jmp	short here
   558                                  
   559                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   560                                  ; display fdisk program disk capacity limit message and then exit
   561                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   562                                  	; 05/11/2020 
   563                                  	; (fdisk4 is proper for -upto- 2TB hard disks)
   564                                  ;A_27:
   565                                  	;; 16/10/2020
   566                                  	;; 15/10/2020
   567                                  	;; Display FDISK (v3) capacity limit (error) message
   568                                  	;
   569                                  	;mov	ax, 65535
   570                                  	;mul	word [hs]
   571                                  	;	; 1024 MB = 1GB (2097152 sectors)
   572                                  	;; DX/32 --> GB 
   573                                  	;mov	ax, dx
   574                                  	;shr	ax, 5 ; /32
   575                                  	;
   576                                  	;; ax = 8 to 2047
   577                                  	;mov	byte [TrDOS_hdrow_unit], 'G'
   578                                  	;mov	byte [TrDOS_hdrow_unit+1], 'B'
   579                                  	;mov	byte [TrDOS_hdrow_unit+2], '.'
   580                                  	;
   581                                  	;;xor	dx, dx
   582                                  	;mov	si, TrDOS_hdrow_capacity
   583                                  	;call	convert_to_decimal
   584                                  	;
   585                                  	;mov	si, msg_fdisk_capacity_err
   586                                  	;call 	print_msg
   587                                  	;
   588                                  	;mov	si, TrDOS_hdrow_capacity
   589                                  	;call	print_msg
   590                                  	;
   591                                  	;mov	si, TrDOS_hdrow_unit
   592                                  	;call	print_msg
   593                                  	;	
   594                                  	;jmp	_exit
   595                                  
   596                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   597                                  ; check defective pte and then init extended partition table(s)
   598                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   599                                  
   600                                  A_28:
   601 00000282 E8AF01                  	call	check_defective_partition
   602 00000285 729C                    	jc	A_29 ; ds:si -> defective pte
   603                                  
   604                                  	; 17/10/2020
   605                                  	; 26/02/2019
   606 00000287 803E[E16C]00            	cmp	byte [epnumber], 0
   607 0000028C 7603                    	jna	short A_30
   608                                  
   609 0000028E E8882A                  	call	init_ext_partition_table
   610                                  A_30:
   611                                  	; 17/10/2020
   612                                  	; 04/02/2019
   613                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   614                                  	; 12/03/2021
   615                                  	;xor	eax, eax
   616 00000291 E82423                  	call	display_partition_table
   617                                  
   618                                  	; 17/10/2020
   619 00000294 803E[DE6C]00            	cmp	byte [pcount], 0
   620 00000299 0F86E300                	jna	A_38 ; empty partition table
   621                                  
   622                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   623                                  ; check CHS parms against start sector address and partition size 
   624                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   625                                  
   626                                  A_31:
   627                                  	; Check disk parameters with current CHS settings
   628 0000029D 31DB                    	xor	bx, bx
   629 0000029F 31C9                    	xor	cx, cx
   630                                  A_32:
   631                                  	; 17/10/2020
   632 000002A1 80BF[8D6C]00            	cmp	byte [part_table_sys_id+bx], 0
   633 000002A6 7670                    	jna	short A_33
   634                                  
   635                                  	; 27/10/2020
   636                                  	;mov	ax, [sectors]
   637                                  	;mul	word [heads]
   638                                  	; dx = 0, ax = heads*sectors
   639                                  
   640                                  	; 06/11/2020
   641                                  	;mov	dx, [part_table_start_cyl+bx]
   642 000002A8 668B87[896C]            	mov	eax, [part_table_start_cyl+bx] ; 10/03/2021
   643                                  	; 27/10/2020
   644                                  	;cmp	ax, 1023 ; fixed cylinder number (> 1023)
   645                                  			 ; (partition's start sector is used for fixing)
   646 000002AD 663DFF030000            	cmp	eax, 1023 ; 06/11/2020 
   647 000002B3 7763                    	ja	short A_33 ; no need to check CHS parms here
   648                                  			; (also, CHS to LBA calculation is not applicable)
   649                                  	;mov	dx, [hs] ; heads*sectors
   650                                  	;
   651                                  	;mul	dx
   652                                  	;	; dx:ax = cylinder*heads*spt
   653                                  	
   654                                  	; 10/03/2021
   655 000002B5 66F726[006A]            	mul	dword [hs]
   656 000002BA 6689C6                  	mov	esi, eax
   657                                  
   658                                  	;mov	si, ax
   659                                  	;mov	di, dx
   660                                  
   661 000002BD 6631C0                  	xor	eax, eax
   662 000002C0 8A87[876C]              	mov	al, [part_table_start_head+bx]
   663 000002C4 F626[B23C]              	mul	byte [sectors]
   664                                  	;add	si, ax
   665                                  	;adc	di, 0
   666                                  		; di:si = (cylinder*heads*spt) + head*spt
   667                                  	; 10/03/2021
   668 000002C8 6601C6                  	add	esi, eax
   669                                  
   670 000002CB 8A87[886C]              	mov	al, [part_table_start_sector+bx]
   671 000002CF 30E4                    	xor	ah, ah
   672 000002D1 FEC8                    	dec	al ; 1 -> 0
   673                                  	;add	si, ax
   674                                  	;adc	di, 0
   675                                  		; di:si = (cylinder*heads*spt) + head*spt + sector - 1
   676                                  		; (start sector as converted to LBA)
   677                                  
   678                                  	; 10/03/2021
   679 000002D3 6601F0                  	add	eax, esi
   680                                  	;xor	esi, esi
   681                                  
   682                                  	; 07/11/2020
   683                                  	;;cmp	di, [part_table_rel_sec_hw+bx]
   684                                  	;cmp	di, [bx+part_table_rel_sec+2]
   685                                  	;jne	short A_34 ; Invalid !
   686                                  
   687                                  	;;cmp	si, [part_table_rel_sec_lw+bx]
   688                                  	;cmp	si, [bx+part_table_rel_sec]
   689                                  	;jne	short A_34 ; Invalid !
   690                                  		; di:si = partition's start sector (LBA)
   691                                  
   692 000002D6 663B87[946C]            	cmp	eax, [part_table_rel_sec+bx]
   693 000002DB 7548                    	jne	short A_34 ; Invalid ! 
   694                                  
   695                                  	; 27/10/2020
   696                                  	;mov	ax, [sectors]
   697                                  	;mul	word [heads]
   698                                  	; dx = 0, ax = heads*sectors
   699                                  
   700                                  	; 10/03/2021
   701 000002DD 668B87[906C]            	mov	eax, [part_table_end_cyl+bx]
   702 000002E2 663DFF030000            	cmp	eax, 1023
   703                                  	; 27/10/2020
   704                                  	;cmp	ax, 1023 ; fixed cylinder number (> 1023)
   705                                  			 ; (partition's end sector is used for fixing)
   706 000002E8 772E                    	ja	short A_33 ; no need to check CHS parms here
   707                                  			; (also, CHS to LBA calculation is not applicable)
   708                                  	;mov	ax, [hs] ; heads*sectors
   709                                  	;
   710                                  	;mul	dx
   711                                  	;	; dx:ax = cylinder*heads*spt
   712                                  	;mov	si, ax
   713                                  	;mov	di, dx
   714                                  	
   715 000002EA 66F726[006A]            	mul	dword [hs]
   716 000002EF 6689C6                  	mov	esi, eax 
   717                                  	
   718 000002F2 6631C0                  	xor	eax, eax
   719 000002F5 8A87[8E6C]              	mov	al, [part_table_end_head+bx]
   720 000002F9 F626[B23C]              	mul	byte [sectors]
   721                                  	;add	si, ax
   722                                  	;adc	di, 0
   723                                  		; di:si = (cylinder*heads*spt) + head*spt
   724                                  	; 10/03/2021
   725 000002FD 6601C6                  	add	esi, eax
   726                                  
   727 00000300 8A87[8F6C]              	mov	al, [part_table_end_sector+bx]
   728 00000304 30E4                    	xor	ah, ah
   729                                  	;dec	al ; 63 -> 62
   730                                  	;add	si, ax
   731                                  	;adc	di, 0
   732                                  		; di:si = (cylinder*heads*spt) + head*spt + sector
   733                                  		; (end sector + 1 as converted to LBA)
   734                                  	; 10/03/2021
   735 00000306 6601C6                  	add	esi, eax
   736                                  
   737                                  	;mov	ax, [part_table_num_sec_lw+bx]
   738                                  	;mov	dx, [part_table_num_sec_hw+bx]
   739                                  	;
   740                                  	;add	ax, [part_table_rel_sec_lw+bx]
   741                                  	;adc	dx, [part_table_rel_sec_hw+bx]
   742                                  	;	; dx:ax = partition's end sector (LBA) + 1
   743                                  
   744                                  	; 10/03/2021
   745 00000309 668B87[986C]            	mov	eax, [part_table_num_sec+bx]
   746 0000030E 660387[946C]            	add	eax, [part_table_rel_sec+bx]
   747                                  
   748 00000313 6639C6                  	cmp	esi, eax
   749 00000316 750D                    	jne	short A_34 ; Invalid !
   750                                  
   751                                  	;cmp	ax, si
   752                                  	;jne	short A_34 ; Invalid !
   753                                  
   754                                  	;cmp	dx, di
   755                                  	;jne	short A_34 ; Invalid !
   756                                  A_33:
   757 00000318 FEC1                    	inc	cl
   758                                  
   759 0000031A 80F904                  	cmp	cl, 4
   760 0000031D 7311                    	jnb	short A_35
   761                                  
   762                                  	;add	bx, 18 ; partition table structure size
   763                                  	; 05/11/2020
   764 0000031F 83C316                  	add	bx, 22 ; partition table structure size	
   765                                  
   766 00000322 E97CFF                  	jmp	A_32
   767                                  A_34:
   768                                  	;mov	si, msg_defective_pt
   769                                  	; 10/03/2021
   770 00000325 66BE[FF5B0000]          	mov	esi, msg_defective_pt
   771 0000032B E89116                  	call	print_msg
   772 0000032E EB50                    	jmp	short A_38
   773                                  
   774                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   775                                  ; sort MBR partitions
   776                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   777                                  
   778                                  A_35:
   779                                  	; 10/03/2021
   780 00000330 6631F6                  	xor	esi, esi
   781                                  	; 06/11/2020
   782 00000333 6631D2                  	xor	edx, edx
   783                                  
   784                                  	; LBA and CHS values of all partitions are OK (here)
   785                                  
   786                                  	; sort MBR (primary) partitions
   787                                  
   788 00000336 E8671F                  	call	sort_partition_table
   789                                  
   790                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   791                                  ; Check partition (start, size) overlaps after sorting 
   792                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   793                                  
   794                                  	; Checking partition overlaps (via start and end cylinders)
   795                                  
   796 00000339 31DB                    	xor	bx, bx
   797                                  	;mov	dx, 18
   798                                  	; 05/11/2020
   799 0000033B BA1600                  	mov	dx, 22
   800                                  A_36:
   801 0000033E FEC3                    	inc	bl
   802                                  
   803 00000340 8A87[166A]              	mov	al, [bx+sort]
   804 00000344 F6E2                    	mul	dl
   805 00000346 89C6                    	mov	si, ax	; current
   806                                  
   807 00000348 80BC[8D6C]00            	cmp	byte [part_table_sys_id+si], 0
   808 0000034D 762C                    	jna	short A_37
   809                                  
   810 0000034F 8A87[156A]              	mov	al, [bx+sort-1]
   811 00000353 F6E2                    	mul	dl
   812 00000355 89C7                    	mov	di, ax  ; previous
   813                                  
   814                                  	;mov	ax, [part_table_end_cyl+di]
   815                                  	;cmp	ax, [part_table_start_cyl+si]
   816                                  	;jb	short A_37
   817                                  	; 29/10/2020
   818                                  	;ja	short A_34 ; overlap !
   819                                  	; 10/03/2021
   820 00000357 668B85[906C]            	mov	eax, [part_table_end_cyl+di]
   821 0000035C 663B84[896C]            	cmp	eax, [part_table_start_cyl+si]
   822 00000361 7218                    	jb	short A_37
   823 00000363 77C0                    	ja	short A_34 ; overlap !
   824                                  
   825                                  	; 17/10/2020
   826                                  	;and	ax, ax
   827                                  	;jnz	short A_34 ; overlap error (except empty entries)
   828                                  
   829                                  	; 29/10/2020
   830                                  	; same cylinder
   831                                  	; check end-start sectors for overlap
   832                                  
   833                                  	;and	ax, ax
   834                                  	;jz	short A_37 ; empty pt entries
   835                                  			; (previous pte is empty)
   836                                  	; 10/03/2021
   837 00000365 6621C0                  	and	eax, eax
   838 00000368 7411                    	jz	short A_37 ; empty pt entries
   839                                  			; (previous pte is empty)
   840                                  
   841                                  	;mov	ax, [part_table_rel_sec_lw+di] ; previous
   842                                  	;mov	dx, [part_table_rel_sec_hw+di]
   843                                  	;add	ax, [part_table_num_sec_lw+di]
   844                                  	;adc	dx, [part_table_num_sec_hw+di]
   845                                  	;;jc	short A_34
   846                                  	;	 ; dx:ax = end sector + 1
   847                                  	; 10/03/2021	
   848 0000036A 668B85[946C]            	mov	eax, [part_table_rel_sec+di] ; previous
   849 0000036F 660385[986C]            	add	eax, [part_table_num_sec+di]
   850                                  
   851                                  	;cmp	dx, [part_table_rel_sec_hw+si] ; current
   852                                  	;jb	short A_37
   853                                  	;ja	short A_34 ; overlap error !
   854                                  	;cmp	ax, [part_table_rel_sec_lw+si]
   855                                  	;jnb	short A_34 ; overlap error !
   856                                  	; 10/03/2021
   857 00000374 663B84[946C]            	cmp	eax, [part_table_rel_sec+si] ; current
   858 00000379 73AA                    	jnb	short A_34 ; overlap error !
   859                                   A_37:
   860 0000037B 80FB03                  	cmp	bl, 3
   861 0000037E 72BE                    	jb	short A_36
   862                                  
   863                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   864                                  ; display partition table editing options
   865                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   866                                  
   867                                  A_38:
   868 00000380 BE[D656]                	mov	si, mbr_editing_options
   869 00000383 E83916                  	call	print_msg
   870                                  
   871 00000386 BE[8457]                	mov	si, enter_option_number_msg
   872 00000389 E83316                  	call	print_msg
   873                                  
   874 0000038C 803E[146A]00            	cmp	byte [ldrives], 0
   875 00000391 760C                    	jna	short A_39
   876                                  
   877 00000393 BE[6C52]                	mov	si, CRLF
   878 00000396 E82616                  	call	print_msg
   879                                  
   880 00000399 BE[475D]                	mov	si, str_display_ebr_pt
   881 0000039C E82016                  	call	print_msg
   882                                  A_39:	
   883                                  	;mov	si, CRLF
   884                                  	;call	print_msg
   885                                  
   886                                  A_40:
   887 0000039F 30E4                    	xor	ah, ah
   888 000003A1 CD16                    	int	16h
   889                                  
   890 000003A3 3C30                    	cmp	al, '0'
   891 000003A5 742A                    	je	short A_41
   892                                  
   893 000003A7 3C31                    	cmp	al, '1'
   894 000003A9 0F84A600                	je	create_partition
   895 000003AD 3C32                    	cmp	al, '2'
   896 000003AF 0F842F01                	je	activate_partition
   897 000003B3 3C33                    	cmp	al, '3'
   898 000003B5 0F84C801                	je	delete_partition
   899 000003B9 3C34                    	cmp	al, '4'
   900 000003BB 0F84CB02                	je	write_pt_mbr
   901                                  	
   902 000003BF 3C1B                    	cmp	al, 27 ; ESCape
   903 000003C1 740E                    	je	short A_41
   904                                  
   905                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   906                                  ; display (EPT) logical drives/partitions if 'SPACE' is pressed
   907                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   908                                  
   909                                  	; 28/02/2019
   910 000003C3 803E[146A]00            	cmp	byte [ldrives], 0
   911 000003C8 76D5                    	jna	short A_40
   912                                  
   913 000003CA 3C20                    	cmp	al, 20h ; SPACE
   914 000003CC 75D1                    	jne	short A_40
   915                                  
   916 000003CE E9DC23                  	jmp	display_extended_pt
   917                                  
   918                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   919                                  ; exit if ESC key or '0' is pressed
   920                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   921                                  
   922                                  A_41:
   923                                  	; terminate
   924 000003D1 CD20                    	int	20h
   925                                  
   926                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   927                                  ; display partition table again
   928                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   929                                  
   930                                  A_42:
   931                                  	; 24/02/2019
   932                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
   933                                  	; 12/03/2021
   934                                  	;xor	eax, eax
   935 000003D3 E8E221                  	call	display_partition_table
   936 000003D6 EBA8                    	jmp	short A_38
   937                                  
   938                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   939                                  ; display a row for hard disk name, number and capacity 
   940                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   941                                  ; 11/10/2020
   942                                  
   943                                  display_hd_row:
   944                                  	; dx:ax = disk size
   945                                  
   946 000003D8 81FA0001                	cmp	dx, 256 ; >= 8GB
   947 000003DC 730E                    	jnb	short dhdr_1
   948                                  
   949                                  	;mov	cx, 2048 ; /2048 (2048 sectors = 1 MB)
   950                                  	;div	cx
   951                                  
   952                                  	; shift dx:ax to 8 bits right (/256)
   953 000003DE 88E0                    	mov	al, ah
   954 000003E0 88D4                    	mov	ah, dl
   955 000003E2 C1E803                  	shr	ax, 3 ; /8 
   956                                  		; result = (dx:ax)/2048
   957                                  
   958                                  	; ax =  0 to 8191
   959                                  
   960 000003E5 C606[1242]4D            	mov	byte [TrDOS_hdrow_unit], 'M'
   961 000003EA EB0A                    	jmp	short dhdr_2
   962                                  	
   963                                  dhdr_1:
   964                                  	; 1024 MB = 1GB (2097152 sectors)
   965                                  	; DX/32 --> GB 
   966 000003EC 89D0                    	mov	ax, dx
   967 000003EE C1E805                  	shr	ax, 5 ; /32
   968                                  
   969                                  	; ax = 8 to 2047
   970 000003F1 C606[1242]47            	mov	byte [TrDOS_hdrow_unit], 'G'
   971                                  dhdr_2:
   972                                  	;xor	dx, dx
   973 000003F6 BE[1842]                	mov	si, TrDOS_hdrow_capacity
   974 000003F9 E81B00                  	call	convert_to_decimal
   975                                  
   976 000003FC FE06[FD41]              	inc	byte [TrDOS_hdrow_n] ; next number for "(#)"
   977                                  	
   978 00000400 BE[FA41]                	mov	si, TrDOS_hdrow
   979 00000403 E8B915                  	call	print_msg
   980 00000406 BE[1842]                	mov	si, TrDOS_hdrow_capacity ; db "#### ", 0
   981 00000409 E8B315                  	call	print_msg
   982 0000040C BE[1242]                	mov	si, TrDOS_hdrow_unit ; "GB" or "MB"
   983 0000040F E8AD15                  	call	print_msg
   984                                  
   985 00000412 FE06[0242]              	inc	byte [TrDOS_hdrow_i] ; next number for "hd#"
   986                                  
   987 00000416 C3                      	retn	
   988                                  
   989                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   990                                  ; convert binary number to decimal character string
   991                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   992                                  ; 11/10/2020
   993                                  
   994                                  convert_to_decimal:
   995                                  	; ax = binary number
   996                                  	; si = decimal string start addr (max. 5 digits + space)
   997 00000417 B90A00                  	mov	cx, 10
   998 0000041A 89E5                    	mov	bp, sp
   999                                  ctd_1:
  1000 0000041C 31D2                    	xor	dx, dx
  1001 0000041E F7F1                    	div	cx
  1002 00000420 52                      	push	dx ; 0 to 9
  1003 00000421 09C0                    	or	ax, ax
  1004 00000423 75F7                    	jnz	short ctd_1
  1005                                  ctd_2:
  1006 00000425 58                      	pop	ax
  1007 00000426 0430                    	add	al, '0'
  1008 00000428 8804                    	mov	[si], al
  1009 0000042A 46                      	inc	si
  1010 0000042B 39E5                    	cmp	bp, sp
  1011 0000042D 77F6                    	ja	short ctd_2
  1012                                  	;mov	byte [si], 20h ; space before size unit char
  1013                                  	;inc	si 
  1014                                  	;mov	byte [si], 0 ; ASCIIZ string terminator (Z)
  1015 0000042F C7042000                	mov	word [si], 20h
  1016 00000433 C3                      	retn
  1017                                  
  1018                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1019                                  ; check defective partition signature 
  1020                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1021                                  ; 16/10/2020
  1022                                  
  1023                                  check_defective_partition:
  1024 00000434 BB[866C]                	mov	bx, part_table_boot_ind
  1025 00000437 31F6                    	xor	si, si 
  1026                                  chk_dp_1:
  1027 00000439 803FFF                  	cmp	byte [bx], 0FFh ; invalid/defective/partition sign
  1028 0000043C 7509                    	jne	short chk_dp_2
  1029 0000043E C1E604                  	shl	si, 4 ; * 16
  1030 00000441 81C6[A654]              	add	si, MasterBootBuff+446
  1031 00000445 F9                      	stc
  1032 00000446 C3                      	retn
  1033                                  chk_dp_2:
  1034                                  	;cmp	bx, part_table_boot_ind+(22*4) ; 05/11/2020
  1035 00000447 83FE03                  	cmp	si, 3
  1036 0000044A 7306                    	jnb	short chk_dp_3
  1037                                  	;add	bx, 18
  1038                                  	; 05/11/2020
  1039 0000044C 83C316                  	add	bx, 22
  1040 0000044F 46                      	inc	si
  1041 00000450 EBE7                    	jmp	short chk_dp_1 
  1042                                  chk_dp_3:
  1043                                  	;sub	si, si
  1044 00000452 C3                      	retn
  1045                                  
  1046                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1047                                  ; create a disk partition (on MBR partition table)
  1048                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1049                                  ; 18/10/2020
  1050                                  
  1051                                  	; 12/03/2021
  1052                                  	; 11/03/2021 (fdisk4.s)
  1053                                  create_partition:
  1054                                  	; 19/10/2020
  1055                                  	; 10/02/2019 (hdimage.s)
  1056 00000453 31C0                    	xor	ax, ax
  1057                                  	;xor	eax, eax ; 12/03/2021
  1058 00000455 A2[DC69]                	mov	byte [wholedisk], al ; 0 ; Reset wholedisk flag
  1059                                  
  1060                                  	; 19/10/2020
  1061 00000458 3806[DE6C]              	cmp	byte [pcount], al ; 0 ; number of (valid) partitions
  1062 0000045C 761C                    	jna	short cp_1
  1063                                  ;cp_0:
  1064 0000045E 803E[DE6C]04            	cmp	byte [pcount], 4
  1065 00000463 7318                    	jnb	short cp_2 ; full pt !
  1066                                  
  1067                                  	; al = 0
  1068 00000465 E8A01E                  	call	find_part_free_space
  1069                                  		 ; Following values are for the max. free space on disk
  1070                                  
  1071                                  	;and	cx, cx
  1072                                  	; 12/03/2021
  1073 00000468 6621C9                  	and	ecx, ecx
  1074 0000046B 7421                    	jz	short cp_3 ; there is not free space on disk
  1075                                  
  1076                                  	;mov	[c_cylinders], cx  ; count of free cylinders in the gap
  1077 0000046D 891E[A86D]              	mov	[c_fspc_offset], bx  ; offset from beginning of 'fspc:'
  1078                                  	;mov	[c_gap], al ; gap (space index) number of this free space
  1079                                  	;		    ; 0 -> before partition 1 (as PTE)
  1080                                  	;		    ; 1-2-3 -> between partitions 1 to 4
  1081                                  	;		    ; 4 -> after partition 4 (as PTE)
  1082                                  
  1083                                  	; Start to job with non-aligned (full) free sectors of this max. space
  1084                                  	
  1085                                  	;mov	ax, [free_space.sectors_unused+bx]
  1086                                  	;mov	dx, [free_space.sectors_unused+2+bx]
  1087                                  	; 12/03/2021
  1088 00000471 668B87[466D]            	mov	eax, [free_space.sectors_unused+bx]
  1089                                  
  1090                                  	;mov	[pp_Sectors], ax
  1091                                  	;mov	[pp_Sectors+2], dx
  1092                                  	; 12/03/2021
  1093 00000476 66A3[D869]              	mov	[pp_Sectors], eax
  1094                                  cp_1:
  1095 0000047A E9C807                  	jmp	B_01 ; New/Empty disk, create partition menu
  1096                                  ;cp_2:
  1097                                  	; 13/02/2019
  1098                                  	; There is not a free pt entry to create a new partition
  1099                                  
  1100                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1101                                  	; 12/03/2021
  1102                                  	;xor	eax, eax
  1103                                  cp_2:
  1104 0000047D E83821                  	call	display_partition_table
  1105                                  
  1106 00000480 BE[6658]                	mov	si, msg_full_pt
  1107 00000483 E83915                  	call	print_msg
  1108 00000486 BE[9358]                	mov	si, msg_to_create_new_p
  1109 00000489 E83315                  	call	print_msg
  1110                                  
  1111 0000048C EB64                    	jmp	ap_0
  1112                                  cp_3:
  1113                                  	; 19/10/2020
  1114 0000048E 803E[E16C]00            	cmp	byte [epnumber], 0
  1115 00000493 7708                    	ja	short create_logical_drives
  1116                                  ;cp_4:
  1117                                  	; 15/02/2019
  1118                                  	; There is not (enough) free space to create a new partition
  1119                                  
  1120 00000495 BE[B158]                	mov	si, msg_no_free_space
  1121 00000498 E82415                  	call	print_msg
  1122 0000049B EB55                    	jmp	ap_0
  1123                                  
  1124                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1125                                  ; create logical -dos- drives
  1126                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1127                                  ; 19/10/2020
  1128                                  
  1129                                  	; 12/03/2021 (fdisk4.s)
  1130                                  create_logical_drives:
  1131                                  	; 05/03/2019
  1132 0000049D E83426                  	call	check_ext_free_space
  1133 000004A0 7238                    	jc	short cld_5
  1134                                  cld_1:
  1135                                  	; 05/03/2019
  1136 000004A2 803E[146A]04            	cmp	byte [ldrives], 4
  1137 000004A7 7203                    	jb	short cld_2
  1138 000004A9 E96F23                  	jmp	eetc_2
  1139                                  cld_2:
  1140                                  	; 01/11/2020
  1141                                  	;mov	[ep_free_sectors], ax
  1142                                  	;mov	[ep_free_sectors+2], dx
  1143                                  	; 12/03/2021
  1144 000004AC 66A3[CC6D]              	mov	[ep_free_sectors], eax
  1145                                  
  1146 000004B0 BE[4A60]                	mov	si, msg_c_ldd_q
  1147 000004B3 E80915                  	call	print_msg
  1148                                  cld_3:	
  1149 000004B6 28E4                    	sub	ah, ah
  1150 000004B8 CD16                    	int	16h
  1151                                  
  1152 000004BA 3C1B                    	cmp	al, 27 ; ESCAPE key
  1153                                  	;je	cp_esc
  1154 000004BC 7419                    	je	short cld_6 ; 19/10/2020
  1155 000004BE 24DF                    	and	al, 0DFh
  1156 000004C0 3C4E                    	cmp	al, 'N'
  1157 000004C2 740D                    	je	short cld_4
  1158 000004C4 3C59                    	cmp	al, 'Y'
  1159 000004C6 75EE                    	jne	short cld_3
  1160 000004C8 BE[A659]                	mov	si, _msg_YES
  1161 000004CB E8F114                  	call	print_msg
  1162                                  
  1163 000004CE E97A23                  	jmp	edit_ext_table_create_x
  1164                                  cld_4:	
  1165 000004D1 BE[AC59]                	mov	si, _msg_NO
  1166 000004D4 E8E814                  	call	print_msg
  1167                                  cld_6:
  1168                                  	;jmp	cp_esc
  1169                                  	; 19/10/2020
  1170 000004D7 E9F9FE                  	jmp	A_42
  1171                                  cld_5:	
  1172 000004DA BE[1A60]                	mov	si, msg_c_part_error
  1173 000004DD E8DF14                  	call	print_msg
  1174                                  
  1175                                  	; 21/03/2021
  1176                                  	;cmp	byte [ldrives], 3
  1177                                  	;;jna	short cld_2
  1178                                  	; 21/03/2021
  1179                                  	;jna	short ap_0
  1180                                  
  1181                                  	;mov	si, msg_c_ldd_error
  1182                                  	;call	print_msg
  1183                                  
  1184 000004E0 EB10                    	jmp	short ap_0
  1185                                  
  1186                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1187                                  ; set active partition
  1188                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1189                                  ; 19/10/2020 
  1190                                  	
  1191                                  activate_partition:
  1192                                  	; 12/02/2019
  1193                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1194                                  	; 12/03/2021
  1195                                  	;xor	eax, eax
  1196 000004E2 E8D320                  	call	display_partition_table
  1197                                  
  1198 000004E5 803E[DE6C]00            	cmp	byte [pcount], 0
  1199 000004EA 7713                    	ja	short ap_1
  1200                                  
  1201 000004EC BE[1A58]                	mov	si, msg_empty_pt
  1202 000004EF E8CD14                  	call	print_msg
  1203                                  ap_0:
  1204 000004F2 BE[C852]                	mov	si, msg_press_any_key
  1205 000004F5 E8C714                  	call	print_msg
  1206                                  
  1207 000004F8 30E4                    	xor	ah, ah
  1208 000004FA CD16                    	int	16h
  1209                                  ap_5:
  1210                                  	;jmp	ap_esc
  1211                                  	; 19/10/2020
  1212 000004FC E9D4FE                  	jmp	A_42
  1213                                  
  1214                                  ap_1:
  1215                                  	; Set valid_ppnums (MBR partition IDs) list
  1216 000004FF BE[A654]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1217 00000502 BB[286C]                	mov	bx, valid_ppnums
  1218 00000505 B104                    	mov	cl, 4
  1219                                  ap_2:
  1220 00000507 8A4404                  	mov	al, [si+ptFileSystemID]
  1221 0000050A 8807                    	mov	[bx], al
  1222 0000050C FEC9                    	dec	cl
  1223 0000050E 7406                    	jz	short ap_3
  1224 00000510 43                      	inc	bx
  1225 00000511 83C610                  	add	si, 16
  1226 00000514 EBF1                    	jmp	short ap_2
  1227                                  ap_3:
  1228 00000516 BE[995A]                	mov	si, msg_enter_pn_to_act
  1229 00000519 E8A314                  	call	print_msg
  1230                                  ap_getchar:
  1231 0000051C 30E4                    	xor	ah, ah
  1232 0000051E CD16                    	int	16h
  1233                                  	
  1234                                  	; 19/10/2020
  1235 00000520 3C1B                    	cmp	al, 27
  1236                                  	;je	ap_esc
  1237 00000522 74D8                    	je	short ap_5
  1238                                  
  1239                                  	;cmp	al, '0'
  1240                                  	;;je	ap_esc
  1241                                  	;je	short ap_5
  1242                                  
  1243 00000524 3C31                    	cmp	al, '1'
  1244 00000526 72F4                    	jb	short ap_getchar
  1245 00000528 3C34                    	cmp	al, '4'
  1246 0000052A 77F0                    	ja	short ap_getchar
  1247                                  
  1248 0000052C 30E4                    	xor	ah, ah
  1249 0000052E 89C2                    	mov	dx, ax
  1250                                  	
  1251 00000530 80EA31                  	sub	dl, '1'
  1252 00000533 89D6                    	mov	si, dx
  1253 00000535 38A4[286C]              	cmp	byte [si+valid_ppnums], ah  ; 0
  1254 00000539 76E1                    	jna	short ap_getchar ; Empty partition table entry, it is not shown
  1255                                  
  1256 0000053B BB0700                  	mov	bx, 07h
  1257 0000053E B409                    	mov	ah, 09h
  1258 00000540 B90100                  	mov	cx, 1
  1259 00000543 CD10                    	int	10h
  1260                                  
  1261 00000545 BE[A654]                	mov	si, MasterBootBuff+pTableOffset
  1262 00000548 BF[866C]                	mov	di, part_table_boot_ind ; (**)
  1263                                  
  1264                                  	; Clear all of possible active partition flags
  1265 0000054B 8834                    	mov	[si], dh ; 0
  1266 0000054D 887410                  	mov	[si+16], dh ; 0
  1267 00000550 887420                  	mov	[si+32], dh ; 0
  1268 00000553 887430                  	mov	[si+48], dh ; 0
  1269                                  
  1270                                  	; 09/03/2021
  1271                                  	; This may not be needed !?
  1272                                  	; (**) (Primary partitions structure/list)
  1273 00000556 8835                    	mov	[di], dh ; 0
  1274 00000558 887516                  	mov	[di+22], dh ; 0
  1275 0000055B 88752C                  	mov	[di+44], dh ; 0
  1276 0000055E 887542                  	mov	[di+66], dh ; 0
  1277                                  
  1278 00000561 20D2                    	and 	dl, dl
  1279 00000563 740D                    	jz	short ap_4
  1280                                  
  1281 00000565 89D0                    	mov	ax, dx
  1282                                  
  1283 00000567 C0E004                  	shl	al, 4 ; * 16
  1284 0000056A 01C6                    	add	si, ax
  1285                                  
  1286                                  	;mov	al, 18
  1287                                  	; 05/11/2020
  1288 0000056C B016                    	mov	al, 22
  1289 0000056E F6E2                    	mul	dl ; 1 to 3
  1290 00000570 01C7                    	add	di, ax
  1291                                  ap_4:
  1292                                  	; Then	set active partition as requested by user
  1293 00000572 C60480                  	mov	byte [si], 80h
  1294 00000575 C60580                  	mov	byte [di], 80h ; (**)
  1295                                  
  1296 00000578 BE[6C52]                	mov	si, CRLF ; Next line
  1297 0000057B E84114                  	call	print_msg
  1298                                  
  1299                                  	; NOTE: Only the MBR buffer has been changed
  1300                                  	; (Masterboot sector will not be updated unless/till
  1301                                  	;  MBR partition table -and MBR code- will be written
  1302                                  	;  to disk image as result of 'write part. table' command.)
  1303                                  
  1304                                  	;; wait for 1 second
  1305                                  	;mov	ah, 02h
  1306                                  	;int	1Ah
  1307                                  	;mov	[GetChar], dh
  1308                                  ;ap_wait:
  1309                                  	;mov	ah, 02h
  1310                                  	;int	1Ah
  1311                                  	;cmp	dh, [GetChar]
  1312                                  	;je	short ap_wait
  1313                                  
  1314                                  	; 17/10/2020 
  1315 0000057E E952FE                  	jmp	A_42 ; display partition table again
  1316                                  
  1317                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1318                                  ; delete selected partition
  1319                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1320                                  ; 19/10/2020
  1321                                  
  1322                                  delete_partition:
  1323                                  	; 10/02/2019
  1324                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1325                                  	; 12/03/2021
  1326                                  	;xor	eax, eax
  1327 00000581 E83420                  	call	display_partition_table
  1328                                  
  1329 00000584 803E[DE6C]00            	cmp	byte [pcount], 0
  1330 00000589 7712                    	ja	short dp_1
  1331                                  
  1332 0000058B BE[1A58]                	mov	si, msg_empty_pt
  1333 0000058E E82E14                  	call	print_msg
  1334                                  
  1335 00000591 BE[C852]                	mov	si, msg_press_any_key
  1336 00000594 E82814                  	call	print_msg
  1337                                  
  1338 00000597 30E4                    	xor	ah, ah
  1339 00000599 CD16                    	int	16h
  1340                                  
  1341 0000059B EB73                    	jmp	short dp_esc
  1342                                  
  1343                                  dp_1:
  1344                                  	; Set valid_ppnums (MBR partition IDs) list
  1345 0000059D BE[A654]                	mov	si, MasterBootBuff+pTableOffset ; MasterBootBuff+446
  1346 000005A0 BB[286C]                	mov	bx, valid_ppnums
  1347 000005A3 B104                    	mov	cl, 4
  1348                                  dp_2:
  1349 000005A5 8A4404                  	mov	al, [si+ptFileSystemID]
  1350 000005A8 8807                    	mov	[bx], al
  1351 000005AA FEC9                    	dec	cl
  1352 000005AC 7406                    	jz	short dp_3
  1353 000005AE 43                      	inc	bx
  1354 000005AF 83C610                  	add	si, 16
  1355 000005B2 EBF1                    	jmp	short dp_2
  1356                                  dp_3:
  1357 000005B4 BE[D558]                	mov	si, msg_enter_pn_to_del
  1358 000005B7 E80514                  	call	print_msg
  1359                                  dp_getchar1:
  1360 000005BA 30E4                    	xor	ah, ah
  1361 000005BC CD16                    	int	16h
  1362                                  	
  1363                                  	; 19/10/2020
  1364 000005BE 3C1B                    	cmp	al, 27
  1365 000005C0 744E                    	je	short dp_esc
  1366 000005C2 3C30                    	cmp	al, '0'
  1367 000005C4 744A                    	je	short dp_esc
  1368                                  	;cmp	al, '1'
  1369 000005C6 72F2                    	jb	short dp_getchar1
  1370 000005C8 3C34                    	cmp	al, '4'
  1371 000005CA 77EE                    	ja	short dp_getchar1
  1372                                  
  1373 000005CC 30FF                    	xor	bh, bh
  1374 000005CE 88C3                    	mov	bl, al
  1375                                  	;dec	bl
  1376 000005D0 80EB31                  	sub	bl, '1'
  1377 000005D3 38BF[286C]              	cmp	byte [bx+valid_ppnums], bh ; 0 ; 12/02/2019
  1378 000005D7 76E1                    	jna	short dp_getchar1  ; Empty partition table entry, it is not shown
  1379                                  	
  1380 000005D9 881E[326C]              	mov	[del_part_num], bl ; Selected partition number to be deleted.
  1381 000005DD A2[F958]                	mov	[chr_del_pnum1], al ; Partition number for "Enter ..." text
  1382 000005E0 A2[9B59]                	mov	[chr_del_pnum2], al ; Partition number for "Do you want ..." text
  1383                                  
  1384 000005E3 BE[F958]                	mov	si, chr_del_pnum1 ; write partition number (user input)
  1385 000005E6 E8D613                  	call	print_msg
  1386                                  
  1387                                  	;xor	al, al
  1388 000005E9 A2[F958]                	mov	[chr_del_pnum1], al ; 0 ; reset
  1389                                  
  1390 000005EC BE[FD58]                	mov	si, msg_delete_partition_q ; question for deleting (with warning)
  1391 000005EF E8CD13                  	call	print_msg
  1392                                  
  1393                                  dp_getchar2:
  1394 000005F2 30E4                    	xor	ah, ah
  1395 000005F4 CD16                    	int	16h
  1396                                  
  1397 000005F6 3C1B                    	cmp	al, 27
  1398 000005F8 7416                    	je	short dp_esc
  1399                                  
  1400 000005FA 24DF                    	and	al, 0DFh
  1401 000005FC 3C59                    	cmp	al, 'Y'
  1402 000005FE 7413                    	je	short dp_yes
  1403 00000600 3C4E                    	cmp	al, 'N'
  1404 00000602 75EE                    	jne	short dp_getchar2
  1405                                  dp_no:
  1406 00000604 BE[AD59]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  1407 00000607 E8B513                  	call	print_msg
  1408                                  	
  1409 0000060A BE[6C52]                	mov	si, CRLF  ; Next line
  1410 0000060D E8AF13                  	call	print_msg
  1411                                  	
  1412                                  	;jmp	short dp_esc
  1413                                  
  1414                                  ;cp_esc:
  1415                                  ;ap_esc:
  1416                                  ;wptmbr_esc:
  1417                                  dp_esc:
  1418                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1419                                  	;call	display_partition_table
  1420                                  	;jmp	A_38 ; 17/10/2020
  1421                                  
  1422                                  	; 19/10/2020
  1423 00000610 E9C0FD                  	jmp	A_42
  1424                                  
  1425                                  dp_yes:
  1426 00000613 BE[A759]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  1427 00000616 E8A613                  	call	print_msg
  1428                                  
  1429 00000619 BF[A654]                	mov	di, MasterBootBuff+pTableOffset
  1430 0000061C A0[326C]                	mov	al, [del_part_num]
  1431 0000061F 20C0                    	and 	al, al
  1432 00000621 7406                    	jz	short dp_4
  1433 00000623 98                      	cbw
  1434                                  	;xor	ah, ah
  1435 00000624 C0E004                  	shl	al, 4 ; * 16
  1436 00000627 01C7                    	add	di, ax
  1437                                  dp_4:
  1438 00000629 BE[6C52]                	mov	si, CRLF ; Next line
  1439 0000062C E89013                  	call	print_msg
  1440                                  
  1441                                  	; 27/02/2019
  1442 0000062F 807D0405                	cmp	byte [di+ptFileSystemID], 05h ; EXTENDED (CHS)
  1443                                  	;jne	short dp_5
  1444 00000633 7406                    	je	short dp_6
  1445                                  	; 24/10/2020
  1446 00000635 807D040F                	cmp	byte [di+ptFileSystemID], 0Fh ; EXTENDED (LBA)
  1447 00000639 7545                    	jne	short dp_5
  1448                                  dp_6:
  1449 0000063B 3806[146A]              	cmp	byte [ldrives], al ; 0
  1450 0000063F 763F                    	jna	short dp_5
  1451                                  
  1452 00000641 BE[1D5C]                	mov	si, msg_ext_part_del_error
  1453 00000644 E87813                  	call	print_msg
  1454 00000647 BE[5D5C]                	mov	si, msg_cancel_continue
  1455 0000064A E87213                  	call	print_msg
  1456                                       	
  1457 0000064D 30E4                    	xor	ah, ah
  1458 0000064F CD16                    	int	16h
  1459                                  	
  1460 00000651 3C1B                    	cmp	al, 27 ; ESCape
  1461 00000653 74BB                    	je	short dp_esc
  1462                                  
  1463 00000655 E8B227                  	call	delete_logical_drives
  1464                                  	
  1465                                  	; 28/02/2019
  1466 00000658 803E[146A]01            	cmp	byte [ldrives], 1
  1467 0000065D 73B1                    	jnb	short dp_esc
  1468                                  
  1469                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1470                                  	; 12/03/2021
  1471                                  	;xor	eax, eax
  1472 0000065F E8561F                  	call	display_partition_table
  1473                                  
  1474 00000662 BE[F05C]                	mov	si, msg_delete_ext_part
  1475 00000665 E85713                  	call	print_msg
  1476                                  
  1477                                  dp_ask_again:
  1478 00000668 28E4                    	sub	ah, ah
  1479 0000066A CD16                    	int	16h
  1480                                  
  1481 0000066C 3C1B                    	cmp	al, 27 ; ESCape
  1482 0000066E 74A0                    	je	short dp_esc
  1483                                  
  1484 00000670 3C0D                    	cmp	al, 13 ; ENTER/CR
  1485 00000672 75F4                    	jne	short dp_ask_again
  1486                                  
  1487 00000674 BF[A654]                	mov	di, MasterBootBuff+pTableOffset
  1488 00000677 A0[326C]                	mov	al, [del_part_num]
  1489 0000067A 98                      	cbw
  1490 0000067B C0E004                  	shl	al, 4 ; * 16
  1491 0000067E 01C7                    	add	di, ax
  1492                                  dp_5:
  1493 00000680 31C0                    	xor	ax, ax
  1494                                  
  1495                                  	; clear partition table entry in MBR buffer
  1496 00000682 B90800                  	mov	cx, 8
  1497 00000685 F3AB                    	rep	stosw
  1498                                  	
  1499                                  	; NOTE: Only the MBR buffer will be cleared
  1500                                  	; (Masterboot sector will not be updated unless/till
  1501                                  	;  MBR partition table -and MBR code- will be written
  1502                                  	;  to disk image as result of 'write part. table' command.)
  1503                                  
  1504 00000687 E973FB                  	jmp	A_21 ; 17/10/2020
  1505                                   	 
  1506                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1507                                  ; write partition table (and MBR code) onto disk
  1508                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1509                                  ; 18/10/2020
  1510                                  
  1511                                  	; 13/03/2021 (fdisk4.s)	
  1512                                  write_pt_mbr:
  1513                                  	; 18/10/2020 (fdisk3.s)
  1514                                  	; 11/02/2019 (hdimage.s)
  1515                                  	;xor	al, al  ; MBR/PRIMARY PARTITIONS
  1516                                  	; 12/03/2021
  1517                                  	;xor	eax, eax
  1518 0000068A E82B1F                  	call	display_partition_table
  1519                                  
  1520 0000068D BE[B159]                	mov	si, msg_write_masterboot_sector
  1521 00000690 E82C13                  	call	print_msg
  1522                                  
  1523 00000693 A2[FE69]                	mov	[GetChar], al ; 0
  1524                                  
  1525 00000696 BE[945A]                	mov	si, option_input
  1526 00000699 E82313                  	call	print_msg
  1527                                  
  1528 0000069C B403                    	mov	ah, 3
  1529                                  	;mov	bx, 7
  1530 0000069E CD10                    	int	10h ; Return Cursor Position
  1531                                  	; DL = Column
  1532                                  	
  1533 000006A0 FECA                    	dec	dl ; previous char ; ']'
  1534 000006A2 FECA                    	dec	dl ; previous char ; '[ ]'
  1535                                  
  1536 000006A4 B402                    	mov	ah, 2
  1537                                  	;mov	bx, 7
  1538 000006A6 CD10                    	int	10h ; Set Cursor Position
  1539                                  
  1540                                  	; write char at current cursor position
  1541                                  
  1542 000006A8 B030                    	mov	al, '0' ; Write default char
  1543                                  
  1544                                  	;;mov	bx, 07h
  1545 000006AA B409                    	mov	ah, 09h
  1546 000006AC B90100                  	mov	cx, 1
  1547 000006AF CD10                    	int	10h
  1548                                  
  1549                                  wptmbr_getchar:
  1550 000006B1 30E4                    	xor	ah, ah
  1551 000006B3 CD16                    	int	16h
  1552                                  
  1553 000006B5 3C1B                    	cmp	al, 1Bh ; 27
  1554                                  	;je	wptmbr_esc ; 19/10/2020
  1555 000006B7 0F8418FD                	je	A_42
  1556                                  
  1557 000006BB 3C0D                    	cmp	al, 0Dh ; 13
  1558 000006BD 7414                    	je	short wptmbr_1
  1559                                                  
  1560 000006BF 3C31                    	cmp	al, '1'
  1561 000006C1 72EE                    	jb	short wptmbr_getchar
  1562                                  
  1563 000006C3 3C32                    	cmp	al, '2'
  1564 000006C5 77EA                    	ja 	short wptmbr_getchar
  1565                                  
  1566 000006C7 A2[FE69]                	mov	[GetChar], al
  1567                                  
  1568                                  	;;mov	bx, 07h
  1569 000006CA B409                    	mov	ah, 09h
  1570 000006CC B90100                  	mov	cx, 1
  1571 000006CF CD10                    	int	10h
  1572 000006D1 EBDE                    	jmp	short wptmbr_getchar
  1573                                  
  1574                                  wptmbr_1:
  1575 000006D3 803E[FE69]00            	cmp	byte [GetChar], 0
  1576 000006D8 76D7                    	jna	short wptmbr_getchar
  1577                                  
  1578 000006DA BE[625A]                	mov	si, msg_writing_ptable
  1579 000006DD E8DF12                  	call	print_msg
  1580                                  
  1581 000006E0 803E[FE69]32            	cmp	byte [GetChar], '2'
  1582 000006E5 7523                    	jne	short wptmbr_2 ; Do not write Singlix MBR code
  1583                                  
  1584                                  	; Write CHS parameters in Singlix (FS specific) MBR
  1585                                  	
  1586 000006E7 BE[9F2E]                	mov	si, TRDOS386_MASTERBOOT_SECTOR
  1587 000006EA B9DF00                  	mov	cx, 446/2 ; Copy Singlix FS 1 MBR code
  1588                                  			  ; except Partition Table
  1589 000006ED BF[E852]                	mov	di, MasterBootBuff
  1590 000006F0 F3A5                    	rep	movsw
  1591                                  	
  1592                                  	; This (Below) is not needed; because, if MBR magicword
  1593                                  	; would not be 0AA55h, we would not be able to come here!
  1594                                  	;;add	di, 64  ; skip partition table	
  1595                                  	;;mov	ax, 0AA55h
  1596                                  	;;stosw
  1597                                  	;mov 	word [MBIDCode], 0AA55h
  1598                                  
  1599                                  	; 12/02/2019
  1600                                  	; Copy CHS parameters to Singlix MBR (on disk)
  1601                                  	
  1602                                  	; 13/03/2021
  1603                                  	;mov	di, MasterBootBuff+420
  1604 000006F2 BF[8B54]                	mov	di, MasterBootBuff+419
  1605                                  	
  1606                                  	; (if disk size > 512 GB, number of cylinders will be > 65535)
  1607 000006F5 A0[B83C]                	mov	al, [cylinders+2]
  1608 000006F8 AA                      	stosb
  1609                                  	;
  1610 000006F9 A1[B63C]                	mov	ax, [cylinders]
  1611 000006FC AB                      	stosw 			; cylinders
  1612 000006FD A1[B43C]                	mov	ax, [heads]
  1613 00000700 AB                      	stosw 			; heads
  1614 00000701 A1[B23C]                	mov	ax, [sectors]
  1615 00000704 AB                      	stosw 			; sectors
  1616                                  
  1617                                  	; 13/03/2021
  1618                                  	; copy 32 bit disk size (total LBA sectors) to MBR offset 426
  1619 00000705 BE[4265]                	mov	si, disksize
  1620 00000708 A5                      	movsw
  1621 00000709 A5                      	movsw
  1622                                  
  1623                                  wptmbr_2:
  1624                                  	;xor	ax, ax ; 0
  1625                                  	;xor	dx, dx ; 0
  1626                                  	;; DX_AX = Masterboot Sector = 0
  1627                                  	;mov	bx, MasterBootBuff
  1628                                  	;; ES:BX = Sector Buffer
  1629                                  	;call	write_hd_sector
  1630                                  	;jc	short print_error_code
  1631                                  			; ! display error msg and then exit !
  1632                                  
  1633 0000070A C606[4165]05            	mov	byte [rcnt], 5  ; retry count
  1634                                  
  1635 0000070F BB[E852]                	mov	bx, MasterBootBuff
  1636                                  
  1637 00000712 B90100                  	mov	cx, 1	; cylinder = 0
  1638                                  			; sector = 1
  1639 00000715 B600                    	mov	dh, 0	; head = 0
  1640 00000717 8A16[3E65]              	mov	dl, [DrvNum]
  1641                                  wptmbr_3:
  1642 0000071B B80103                  	mov	ax, 0301h ; write one sector
  1643 0000071E CD13                    	int	13h	
  1644 00000720 730C                    	jnc     short wptmbr_4
  1645                                               
  1646 00000722 FE0E[4165]              	dec	byte [rcnt]
  1647 00000726 7431                    	jz	short print_error_code
  1648                                          
  1649 00000728 30E4                    	xor	ah, ah
  1650                                  	;mov	dl, [DrvNum]
  1651 0000072A CD13                    	int	13h	; BIOS Service func (ah) = 0
  1652                                  			; Reset disk system
  1653 0000072C EBED                    	jmp	short wptmbr_3
  1654                                  
  1655                                  wptmbr_4:
  1656 0000072E BE[8B5A]                	mov	si, _msg_OK
  1657 00000731 E88B12                  	call	print_msg
  1658                                  
  1659                                  	; wait for 1 second
  1660 00000734 B402                    	mov	ah, 02h
  1661 00000736 CD1A                    	int	1Ah
  1662 00000738 8836[FE69]              	mov	[GetChar], dh
  1663                                  wptmbr_wait:
  1664 0000073C B402                    	mov	ah, 02h
  1665 0000073E CD1A                    	int	1Ah
  1666 00000740 3A36[FE69]              	cmp	dh, [GetChar]
  1667 00000744 74F6                    	je	short wptmbr_wait
  1668                                  	
  1669 00000746 BE[C852]                	mov	si, msg_press_any_key
  1670 00000749 E87312                  	call	print_msg
  1671                                                  
  1672 0000074C 30E4                    	xor	ah, ah	; "Press any key to continue"
  1673 0000074E CD16                    	int	16h
  1674                                  
  1675 00000750 BE[6C52]                	mov	si, CRLF
  1676 00000753 E86912                  	call	print_msg
  1677                                  
  1678                                  	;jmp	wptmbr_esc
  1679                                  	; 19/10/2020
  1680 00000756 E97AFC                  	jmp	A_42
  1681                                  
  1682                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1683                                  ; print error message and exit
  1684                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1685                                  ; 18/10/2020 (fdisk3.s)
  1686                                  	
  1687                                  print_error_code:
  1688                                  	; 25/02/2019 (hdimage.s)
  1689                                  
  1690 00000759 88E0                    	mov	al, ah	; error code
  1691 0000075B E83513                  	call	bin_to_hex
  1692 0000075E A3[7A52]                	mov 	[error_code], ax
  1693                                  
  1694 00000761 BE[6C52]                	mov	si, CRLF
  1695 00000764 E85812                  	call	print_msg
  1696                                  
  1697 00000767 BE[6F52]                	mov	si, Msg_Error
  1698 0000076A E85212                  	call	print_msg
  1699                                  	
  1700 0000076D CD20                    	int	20h	; Exit
  1701                                  
  1702                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1703                                  ; exit, print_msg & exit
  1704                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1705                                  ; 19/10/2020
  1706                                  
  1707                                  _crlf_exit:
  1708 0000076F BE[6C52]                	mov	si, CRLF
  1709                                  _p_exit:
  1710                                  	; 11/10/2020
  1711 00000772 E84A12                  	call	print_msg
  1712                                  _exit:
  1713 00000775 B8004C                  	mov	ax, 4C00h		; terminate
  1714 00000778 CD21                    	int	21h
  1715                                  
  1716                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1717                                  ; display create partition menu & get partition type input
  1718                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1719                                  ; 19/10/2020
  1720                                  
  1721                                  create_partition_input:
  1722                                  	; 15/02/2019
  1723                                  	; clear screen
  1724 0000077A B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1725 0000077D CD10                    	int	10h
  1726                                  	
  1727 0000077F BE[6642]                	mov	si, msg_create_partition_h ; header
  1728 00000782 E83A12                  	call	print_msg
  1729 00000785 BE[5B43]                	mov	si, msg_create_partition_m ; menu
  1730 00000788 E83412                  	call	print_msg
  1731                                  cpi_1:
  1732 0000078B 30E4                    	xor	ah, ah
  1733 0000078D CD16                    	int	16h
  1734 0000078F 3C1B                    	cmp	al, 27 ; ESC key
  1735 00000791 7445                    	je	short cpi_4  ; 25/02/2019
  1736 00000793 3C30                    	cmp	al, '0'
  1737 00000795 7441                    	je	short cpi_4  ; 25/02/2019
  1738 00000797 72F2                    	jb	short cpi_1
  1739 00000799 3C34                    	cmp	al, '4'
  1740 0000079B 77EE                    	ja	short cpi_1
  1741                                  
  1742 0000079D 30E4                    	xor	ah, ah
  1743 0000079F 2C30                    	sub	al, '0'
  1744                                  
  1745                                  	;mov	[pp_type], al
  1746                                  
  1747                                  	;mov	byte [pp_type_user], 0
  1748                                  
  1749 000007A1 3C01                    	cmp	al, 1 ; DOS partition
  1750 000007A3 7536                    	jne	short cpi_5 ; ah = 0 
  1751                                  			    ; (al = 2 -> singlix, al = 3 -> retro unix)
  1752                                  cpi_2:
  1753                                  	; clear screen
  1754 000007A5 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1755 000007A8 CD10                    	int	10h
  1756                                  	
  1757 000007AA BE[1145]                	mov	si, msg_create_dos_partition_h ; header
  1758 000007AD E80F12                  	call	print_msg
  1759 000007B0 BE[E548]                	mov	si, msg_create_dos_partition_m ; menu
  1760 000007B3 E80912                  	call	print_msg
  1761                                  cpi_3:
  1762 000007B6 30E4                    	xor	ah, ah
  1763 000007B8 CD16                    	int	16h
  1764 000007BA 3C1B                    	cmp	al, 27 ; ESC key
  1765 000007BC 741A                    	je	short cpi_4
  1766 000007BE 3C30                    	cmp	al, '0'
  1767 000007C0 7416                    	je	short cpi_4
  1768 000007C2 72F2                    	jb	short cpi_3
  1769 000007C4 3C33                    	cmp	al, '3'
  1770 000007C6 77EE                    	ja	short cpi_3
  1771                                  	
  1772 000007C8 30E4                    	xor	ah, ah
  1773 000007CA 2C30                    	sub	al, '0'
  1774 000007CC 3C01                    	cmp	al, 1
  1775 000007CE 7424                    	je	short cpi_6  ;	ah = 0 (al = primary dos partition)
  1776                                  
  1777                                  	;mov	byte [pp_type], 5
  1778                                  
  1779 000007D0 3C02                    	cmp	al, 2
  1780 000007D2 7621                    	jna	short cpi_7
  1781                                  
  1782 000007D4 B80600                  	mov	ax, 6	; ah = 0 (al = logical dos drive/partition)
  1783 000007D7 C3                      	retn
  1784                                  
  1785                                  cpi_4:
  1786 000007D8 31C0                    	xor	ax, ax	; ah = 0 (al = 0 -> ESCape/Cancel)
  1787 000007DA C3                      	retn
  1788                                  cpi_5:
  1789 000007DB 3C04                    	cmp	al, 4	 ; option num. for partition type (user) input
  1790 000007DD 7515                    	jne	short cpi_6
  1791                                  
  1792 000007DF E83E16                  	call	partition_type_input
  1793                                  	
  1794                                  	; 29/10/2020
  1795 000007E2 08C0                    	or	al, al
  1796                                  	;jz	short cpi_6 ; invalid (zero) input or ESC key
  1797 000007E4 74F2                    	jz	short cpi_4
  1798                                  
  1799 000007E6 B404                    	mov	ah, 4 ; user/another type partition flag
  1800                                  	; al = Partition ID
  1801 000007E8 50                      	push	ax
  1802 000007E9 BE[C852]                	mov	si, msg_press_any_key 
  1803 000007EC E8D011                  	call	print_msg
  1804 000007EF 28E4                    	sub	ah, ah
  1805 000007F1 CD16                    	int	16h
  1806 000007F3 58                      	pop	ax
  1807                                  cpi_6:
  1808 000007F4 C3                      	retn
  1809                                  cpi_7:
  1810 000007F5 B80500                  	mov	ax, 5	; ah = 0 (al = extended dos partition)
  1811 000007F8 C3                      	retn
  1812                                  
  1813                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1814                                  ; create primary (dos or non-dos) partition
  1815                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1816                                  ; 19/10/2020 
  1817                                  ;	(This procedure must be called after 'find_part_free_space')
  1818                                  
  1819                                  	; 14/03/2021 (fdisk4.s)
  1820                                  create_primary_partition:  
  1821                                  	; 16/02/2019
  1822                                  
  1823                                  	; INPUT:
  1824                                  	;	none 
  1825                                  	;  (CHS parameters and free space calculation result will be used.) 
  1826                                  	;
  1827                                  	; OUTPUT:
  1828                                  	;	Partition table in MBR buffer will be updated.
  1829                                  	;
  1830                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  1831                                  
  1832                                  	; Create primary dos or non-dos partition,
  1833                                  	; make partition table entry
  1834                                  
  1835                                  	; 19/10/2020
  1836 000007F9 803E[DE6C]00            	cmp	byte [pcount], 0  ; count of (valid) partitions
  1837 000007FE 770B                    	ja	short cpp_0
  1838                                  
  1839                                  	; cylinder = 0, head = 1, sector = 1
  1840                                  	; LBA = (((cylinder*heads)+head)*sectors)+sector-1
  1841                                  
  1842 00000800 BE[A654]                	mov	si, MasterBootBuff+pTableOffset
  1843                                  
  1844                                  	;mov	ax, [sectors] ; LBA = 17 or 63
  1845                                  	; 07/11/2020
  1846 00000803 660FB606[B23C]          	movzx	eax, byte [sectors]
  1847                                  	;xor	dx, dx
  1848 00000809 EB4F                    	jmp	short cpp_4
  1849                                  cpp_0:
  1850                                  	; 16/02/2019
  1851 0000080B E8561D                  	call	get_first_free_pte
  1852                                  		 ; CX = First free PTE number, 0 to 3 
  1853                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  1854                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  1855                                   	 	 ; SI = PTE address/offset in MBR buffer
  1856                                  
  1857                                  	;mov	si, MasterBootBuff+pTableOffset
  1858                                  	;shl	cl, 4 ; * 16
  1859                                  	;add	si, cx
  1860                                  
  1861                                  	; 18/02/2019
  1862 0000080E 8B3E[A86D]              	mov	di, [c_fspc_offset]
  1863                                  	;mov	bx, [di+free_space.start]
  1864                                  	;mov	al, [heads]
  1865                                  	;; 07/11/2020
  1866                                  	;movzx	eax, byte [heads]
  1867                                  	;mul	byte [sectors]
  1868                                  	;;mul	bx
  1869                                  	;	; DX:AX = LBA of start cylinder, head 0, sector 1
  1870                                  	; 14/03/2021
  1871 00000812 66A1[006A]              	mov	eax, [hs] ; [heads] * [sectors]
  1872                                  	; 07/11/2020
  1873 00000816 668B9D[3E6D]            	mov	ebx, [di+free_space.start]
  1874 0000081B 66F7E3                  	mul	ebx
  1875                                  	;	; EAX =  LBA of start cylinder, head 0, sector 1
  1876                                  	
  1877 0000081E 8A0E[AA6D]              	mov	cl, [cylinder_boundary]
  1878                                  
  1879                                  	;cmp	cl, 0 ; Default (partition size unit is one of C, G, M)
  1880                                  		      ; boundary alignment is forced as default
  1881                                  	;je	short cpp_4
  1882                                  
  1883                                  	; 20/02/2019
  1884                                  	;and	cl, cl
  1885                                  	;jz 	short cpp_1
  1886                                  
  1887 00000822 80F959                  	cmp	cl, 'Y'
  1888 00000825 7433                    	je	short cpp_4 ; cylinder boundary option (answer) = YES
  1889                                  
  1890 00000827 80F94E                  	cmp	cl, 'N'
  1891 0000082A 7507                    	jne	short cpp_1 ; cylinder boundary option (answer) = YES/NO
  1892                                  
  1893                                  	; cylinder boundary option (answer) = NO 
  1894                                  	;mov	ax, [di+free_space.startsector]
  1895                                  	;mov	dx, [di+free_space.startsector+2]
  1896                                  	; 07/11/2020
  1897 0000082C 668B85[4A6D]            	mov	eax, [di+free_space.startsector]
  1898 00000831 EB27                    	jmp	short cpp_4
  1899                                  cpp_1:
  1900                                  	;cmp	cl, 27 ; ESCape
  1901                                  	;jne	short cpp_4 ; 'Y'
  1902                                  
  1903                                  	; check	cylinder boundary alignment of the start sector
  1904                                  
  1905                                  	; if start sector is not aligned, end sector must not be aligned
  1906                                  	; (this rule is valid for ESCape key from the user) 
  1907                                  
  1908 00000833 C606[AA6D]59            	mov	byte [cylinder_boundary], 'Y' ; YES for end sector check
  1909                                  
  1910                                  	;mov	cx, [di+free_space.startsector]
  1911                                  
  1912                                  	;or	bx, bx
  1913                                  
  1914                                  	;mov	bx, [di+free_space.startsector+2]
  1915                                  
  1916                                  	;jnz	short cpp_2 ; start cylinder > 0
  1917                                  
  1918                                  	;and	bx, bx
  1919                                  	;jnz	short cpp_3
  1920                                  
  1921 00000838 668B8D[4A6D]            	mov	ecx, [di+free_space.startsector]
  1922 0000083D 6609DB                  	or	ebx, ebx
  1923 00000840 750B                    	jnz	short cpp_2 ; start cylinder > 0
  1924                                  
  1925                                  	; 07/11/2020
  1926 00000842 8A1E[B23C]              	mov	bl, [sectors]
  1927                                  	;cmp	cx, [sectors]
  1928                                  	;je	short cpp_4 ; start sector is as aligned 
  1929 00000846 6639D9                  	cmp	ecx, ebx 
  1930 00000849 740F                    	je	short cpp_4 ; start sector is as aligned 
  1931 0000084B EB05                    	jmp	short cpp_3
  1932                                  cpp_2:
  1933                                  	;cmp	ax, cx
  1934                                  	;jne	short cpp_3
  1935                                  	;cmp	dx, bx
  1936                                  	;je	short cpp_4
  1937                                  	; 07/11/2020
  1938 0000084D 6639C8                  	cmp	eax, ecx
  1939 00000850 7408                    	je	short cpp_4
  1940                                  cpp_3:
  1941                                  	;mov	ax, cx
  1942                                  	;mov	dx, bx
  1943                                  	; 07/11/2020
  1944 00000852 6689C8                  	mov	eax, ecx 
  1945 00000855 C606[AA6D]4E            	mov	byte [cylinder_boundary], 'N'
  1946                                  cpp_4:
  1947                                  	;mov	[si+ptStartSector], ax
  1948                                  	;mov	[si+ptStartSector+2], dx
  1949                                  	; 07/11/2020
  1950 0000085A 66894408                	mov	[si+ptStartSector], eax
  1951                                  
  1952                                  	; save start sector (for partition formatting procedure)
  1953                                  	;mov	[pp_StartSector], ax
  1954                                  	;mov	[pp_StartSector+2], dx
  1955 0000085E 66A3[D469]              	mov	[pp_StartSector], eax
  1956                                  
  1957                                  	; 14/03/2021
  1958 00000862 668B0E[0C6A]            	mov	ecx, [ppn_Sectors]
  1959                                  
  1960                                  	; 19/10/2020
  1961 00000867 803E[DE6C]00            	cmp	byte [pcount], 0
  1962 0000086C 7752                    	ja	short cpp_5
  1963                                  
  1964                                  	; 07/11/2020
  1965                                  	;;xor	cx, cx
  1966                                  	;xor	ecx, ecx
  1967                                  	;mov	[si+ptBeginCylinder], cx ; 0
  1968                                  	;inc	cl  ; 1
  1969                                  	;mov	[si+ptBeginSector], cl ; 1
  1970                                  	;mov	[si+ptBeginHead], cl ; 1
  1971                                  	; 14/03/2021
  1972 0000086E C744030000              	mov	word [si+ptBeginCylinder], 0
  1973 00000873 C6440201                	mov	byte [si+ptBeginSector], 1
  1974 00000877 C6440101                	mov	byte [si+ptBeginHead], 1
  1975                                  
  1976                                  	; set active partition flag
  1977                                  	;mov	byte [si+ptBootable], 80h ; bootable/active partition
  1978 0000087B C60480                  	mov	byte [si], 80h ; bootable/active partition
  1979                                  
  1980                                  	; 18/02/2019
  1981                                  
  1982                                  	;;mov	cx, [ppn_Sectors]
  1983                                  	;;mov	bx, [ppn_Sectors+2]
  1984                                  	; 07/11/2020
  1985                                  	;mov	ecx, [ppn_sectors]
  1986                                  
  1987 0000087E 803E[DC69]00            	cmp	byte [wholedisk], 0
  1988 00000883 0F864101                	jna	cpp_12
  1989                                  
  1990                                  	; 26/10/2020
  1991                                  	;add	ax, cx
  1992                                  	;adc	dx, bx
  1993                                  	;sub	ax, 1
  1994                                  	;sbb	dx, 0 
  1995                                  	; 07/11/2020
  1996 00000887 6601C8                  	add	eax, ecx
  1997 0000088A 6648                    	dec	eax  ; sub eax, 1
  1998                                  
  1999                                  	; 24/10/2020
  2000                                  	;cmp	dx, [chs_limit+2]
  2001                                  	;jb	short cpp_17
  2002                                  	;ja	short cpp_16
  2003                                  	;cmp	ax, [chs_limit]
  2004                                  	;jna	short cpp_17
  2005                                  	; 07/11/2020
  2006 0000088C 663B06[4665]            	cmp	eax, [chs_limit]
  2007 00000891 760F                    	jna	short cpp_17
  2008                                  cpp_16:
  2009 00000893 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2010 00000897 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2011 0000089B C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2012 0000089F E9BA01                  	jmp	cpp_15
  2013                                  cpp_17:
  2014 000008A2 A0[B43C]                	mov	al, [heads]
  2015 000008A5 FEC8                    	dec	al
  2016 000008A7 884405                  	mov	[si+ptEndHead], al
  2017 000008AA A0[B23C]                	mov	al, [sectors]
  2018 000008AD 884406                  	mov	[si+ptEndSector], al
  2019 000008B0 A1[B63C]                	mov	ax, [cylinders]
  2020 000008B3 48                      	dec	ax
  2021 000008B4 884407                  	mov	[si+ptEndCylinder], al
  2022 000008B7 C0E406                  	shl	ah, 6
  2023 000008BA 086406                  	or	[si+ptEndSector], ah
  2024                                  
  2025                                  	;jmp	cpp_16
  2026 000008BD E99C01                  	jmp	cpp_15 ; 06/03/2019
  2027                                  cpp_5:
  2028                                  	; 14/03/2021
  2029                                  	; eax = start sector
  2030                                  
  2031                                  	; 18/02/2019
  2032 000008C0 803E[AA6D]59            	cmp	byte [cylinder_boundary], 'Y'
  2033 000008C5 7535                    	jne	short cpp_7
  2034                                  
  2035 000008C7 30DB                    	xor	bl, bl ; head  = 0
  2036                                  
  2037                                  	; 14/03/2021
  2038                                  	;mov	cx, [di+free_space.start]
  2039 000008C9 668B8D[3E6D]            	mov	ecx, [di+free_space.start]
  2040                                  	; ecx = start cylinder
  2041                                  
  2042                                  	; 06/03/2019
  2043                                  	;or	ax, ax
  2044                                  	;jnz	short cpp_6
  2045                                  
  2046                                  	;and	cx, cx  ; start cylinder = 0 ?
  2047                                  	;jnz	short cpp_6
  2048                                  
  2049                                  	;or	ax, cx
  2050                                  	;;jnz	short cpp_6
  2051                                  	;jz	short cpp_24 ; 31/10/2020
  2052                                  	; 14/03/2021
  2053 000008CE 6609C8                  	or	eax, ecx
  2054 000008D1 7409                    	jz	short cpp_24 ; cyl = 0, sector = 0
  2055                                  
  2056                                  	; 31/10/2020
  2057                                  	;mov	al, [sectors]
  2058                                  	;mul	byte [heads]
  2059                                  	;mul	cx
  2060                                  	;; dx:ax = LBA sector address
  2061                                  	;; bl = head = 0
  2062                                  	;; cx = cylinder number
  2063                                  	; 14/03/2021
  2064 000008D3 66A1[006A]              	mov	eax, [hs] ; [heads] * [sectors]
  2065 000008D7 66F7E1                  	mul	ecx 	
  2066                                  		; eax = LBA sector address
  2067                                  		; ecx = cylinder number
  2068                                  		; bl = head = 0
  2069                                   
  2070 000008DA EB05                    	jmp	short cpp_6
  2071                                  cpp_24:
  2072                                  	; 14/03/2021
  2073                                  	;mov	ax, [sectors]
  2074 000008DC A0[B23C]                	mov	al, [sectors]
  2075                                  
  2076                                  	; cylinder 0, head 1, sector 1 (LBA = 17 or 63)
  2077 000008DF FEC3                    	inc	bl  ; head = 1
  2078                                  	; 14/03/2021
  2079                                  	;xor	dx, dx ; 0
  2080                                  cpp_6:
  2081                                  	; 31/10/2020
  2082                                  	;mov	[si+ptStartSector], ax
  2083                                  	;mov	[si+ptStartSector+2], dx
  2084                                  	; 14/03/2021
  2085 000008E1 66894408                	mov	[si+ptStartSector], eax
  2086                                  
  2087                                  	;mov	[pp_StartSector], ax
  2088                                  	;mov	[pp_StartSector+2], dx
  2089                                  	; 14/03/2021
  2090 000008E5 66A3[D469]              	mov	[pp_StartSector], eax
  2091                                  
  2092                                  	;or	cx, cx  ; start cylinder ?
  2093                                  	;jnz	short cpp_25 ; > 0
  2094                                  	; 14/03/2021
  2095 000008E9 6609C9                  	or	ecx, ecx  ; start cylinder ?
  2096 000008EC 7505                    	jnz	short cpp_25 ; > 0
  2097                                  
  2098                                  	;and	bl, bl  ; head = 0 ?
  2099                                  	;jz	short cpp_25
  2100                                  
  2101                                  	; cylinder = 0, head = 1, dx:ax = [sectors]
  2102                                  
  2103                                  	;;sub	[pp_Sectors], ax
  2104                                  	;;sbb	[pp_Sectors+2], cx ; 0
  2105                                  
  2106                                  	;sub	[ppn_Sectors], ax
  2107                                  	;sbb	[ppn_Sectors+2], cx ; 0
  2108                                  	; 14/03/2021
  2109 000008EE 662906[0C6A]            	sub	[ppn_Sectors], eax
  2110                                  cpp_25:
  2111                                  	; 14/03/2021
  2112                                  	;mov	ax, cx
  2113 000008F3 6689C8                  	mov	eax, ecx
  2114                                  
  2115                                  	; 29/10/2020
  2116 000008F6 C6440201                	mov	byte [si+ptBeginSector], 1 ; sector = 1	
  2117 000008FA EB1E                    	jmp	short cpp_8
  2118                                  cpp_7:
  2119                                  	; 18/02/2019
  2120                                  
  2121                                  	; [wholedisk] = 0
  2122                                  
  2123                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  2124                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  2125                                  	; if it is 65536 sectors.)
  2126                                  	
  2127 000008FC E86E01                  	call	fix_32mb_dos_psize
  2128                                  		; bx:cx = [ppn_sectors] = partition size
  2129                                  		; dx:ax = start sector's LBA
  2130                                  
  2131                                  	;cylinder = LBA / (heads_per_cylinder * sectors_per_track)
  2132                                  	;temp = LBA % (heads_per_cylinder * sectors_per_track)
  2133                                  	;head = temp / sectors_per_track
  2134                                  	;sector = temp % sectors_per_track + 1
  2135                                  	
  2136                                  	; Convert LBA sector address to CHS parameters
  2137                                  	;mov	cx, [sectors]
  2138                                  	;call	div32
  2139                                  	;; BX = Sector number - 1
  2140                                  	;inc	bl ; sector number (1 based)
  2141                                  	;mov	[si+ptBeginSector], bl
  2142                                  	
  2143                                  	; 14/03/2021
  2144                                  	; eax = start sector address (LBA)
  2145                                  
  2146                                  	; 07/11/2020
  2147 000008FF 6629D2                  	sub	edx, edx ; 14/03/2021
  2148                                  	;movzx	ecx, byte [sectors]
  2149 00000902 6631C9                  	xor	ecx, ecx
  2150 00000905 8A0E[B23C]              	mov	cl, [sectors]
  2151 00000909 66F7F1                  	div	ecx
  2152 0000090C FEC2                    	inc	dl ; sector number (1 based)
  2153 0000090E 885402                  	mov	[si+ptBeginSector], dl
  2154                                  	; eax = cylinders * heads + head
  2155                                  
  2156                                  	;; DX_AX = cylinders * heads + head
  2157                                  	;mov	cx, [heads]
  2158                                  	;call	div32
  2159                                  	;; ax = cylinder
  2160                                  	;; bl = head
  2161                                  
  2162                                  	; 07/11/2020
  2163                                  	;sub	edx, edx
  2164                                  	;sub	dx, dx
  2165 00000911 28D2                    	sub	dl, dl
  2166                                  	;movzx	ecx, byte [heads]
  2167 00000913 8A0E[B43C]              	mov	cl, [heads]
  2168 00000917 66F7F1                  	div	ecx
  2169                                  	; eax = cylinder
  2170                                  	; dl = head
  2171                                  cpp_8:
  2172                                  	;; 24/10/2020
  2173                                  	;;mov	bh, 1  ; [si+ptBeginSector]
  2174                                  	;cmp	ax, 1023  ; CHS limit
  2175                                  	;jna	short cpp_18	
  2176                                  	; 07/11/2020
  2177 0000091A 663DFF030000            	cmp	eax, 1023
  2178 00000920 760C                    	jna	short cpp_18
  2179                                  
  2180                                  	; > CHS limit
  2181                                  	;mov	ax, 1023 ; cylinder
  2182                                  	;mov	bl, 0FEh ; 254 (head)
  2183                                  	;mov	bh, 3Fh ; 63 (sector)
  2184                                  	; 07/11/2020
  2185 00000922 66B8FF030000            	mov	eax, 1023
  2186 00000928 B2FE                    	mov	dl, 0FEh ; 254
  2187                                  	; 26/10/2020
  2188 0000092A C644023F                	mov	byte [si+ptBeginSector], 3Fh
  2189                                  cpp_18:
  2190                                  	; 07/11/2020
  2191                                  	; DL = Head number
  2192 0000092E 885401                  	mov	[si+ptBeginHead], dl
  2193                                  
  2194                                  	;; BL = Head number
  2195                                  	;mov	[si+ptBeginHead], bl
  2196                                  	; AX = Cylinder number
  2197                                  	;and	ax, 1023
  2198 00000931 884403                  	mov	[si+ptBeginCylinder], al
  2199 00000934 C0E406                  	shl	ah, 6
  2200                                  	; 24/10/2020
  2201                                  	;or	ah, bh	; bh = sector number
  2202                                  	; 26/10/2020
  2203 00000937 086402                  	or	[si+ptBeginSector], ah
  2204                                  	;mov	[si+ptBeginSector], ah
  2205                                  
  2206                                  	; clear active partition flag (for now)
  2207                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  2208 0000093A C60400                  	mov	byte [si], 0 ; not bootable/active partition
  2209                                  
  2210                                  	;mov	di, [c_fspc_offset]
  2211                                  
  2212 0000093D 803E[AA6D]59            	cmp	byte [cylinder_boundary], 'Y'
  2213 00000942 757B                    	jne	cpp_11
  2214                                  
  2215                                  	;mov	cl, [heads]
  2216                                  	;mov	al, [sectors]
  2217                                  	;mov	ch, al
  2218                                  	;mul	cl	
  2219                                  	;; ax = heads*sectors
  2220                                  	; 14/03/2021
  2221                                  	;mov	eax, [hs] ; heads * spt
  2222                                  
  2223                                  	;mov	bx, [di+free_space.end]	; end cylinder of the partition
  2224                                  	; 14/03/2021
  2225                                  	;mov	ebx, [di+free_space.end]
  2226 00000944 668B85[426D]            	mov	eax, [di+free_space.end]
  2227                                  
  2228 00000949 803E[DC69]00            	cmp	byte [wholedisk], 0 ; entire free space ?
  2229 0000094E 771C                    	ja	short cpp_10
  2230                                  
  2231                                  	;mov	bx, ax
  2232                                  	;mov	ax, [ppn_Sectors]
  2233                                  	;mov	dx, [ppn_Sectors+2]
  2234                                  	;add	ax, [pp_StartSector]
  2235                                  	;adc	dx, [pp_StartSector+2]
  2236                                  	;sub	ax, 1
  2237                                  	;sbb	dx, 0
  2238                                  	;	; dx:ax = end sector
  2239                                  	;div	bx
  2240                                  	;	; ax = cylinder number
  2241                                  	; 14/03/2021
  2242                                  	;mov	ebx, eax
  2243 00000950 66A1[0C6A]              	mov	eax, [ppn_Sectors]
  2244 00000954 660306[D469]            	add	eax, [pp_StartSector]
  2245 00000959 6648                    	dec	eax
  2246 0000095B 6631D2                  	xor	edx, edx
  2247                                  	;div	ebx
  2248 0000095E 66F736[006A]            	div	dword [hs] ; heads * spt
  2249                                  		; eax = (end) cylinder number
  2250                                  
  2251                                  	; 31/10/2020
  2252                                  	;and	dx, dx
  2253                                  	;jz	short cpp_9
  2254                                  	;inc	ax ; + 1 (because of remainder > 0)
  2255                                  cpp_9:	
  2256                                  	;xchg	ax, bx
  2257                                  	;	; bx = end cylinder
  2258                                  	;	; ax = heads*sectors
  2259                                  	; 14/03/2021
  2260                                  	;xchg	eax, ebx
  2261                                  
  2262                                  	; free space limit check
  2263                                  	;cmp	bx, [di+free_space.end]
  2264                                  	;jna	short cpp_10 ; ok
  2265                                  	;; end cylinder is out of free space
  2266                                  	;dec	bx  ; decrease end cylinder number
  2267                                  	; 14/03/2021
  2268 00000963 663B85[426D]            	cmp	eax, [di+free_space.end]
  2269 00000968 7602                    	jna	short cpp_10 ; ok
  2270 0000096A 6648                    	dec	eax
  2271                                  cpp_10: 
  2272 0000096C 6650                    	push	eax ; * ; end cylinder
  2273                                  	;mul	bx
  2274                                  	;	 ; dx:ax = (end cylinder)*heads*sectors
  2275                                  	; 14/03/2021
  2276 0000096E 66F726[006A]            	mul	dword [hs] ; heads * spt
  2277                                  		; eax = (end cylinder)*heads*sectors
  2278                                  		; edx = 0
  2279 00000973 665A                    	pop	edx ; * ; end cylinder
  2280                                  
  2281                                  	;push	dx ; **
  2282                                  	;push	ax ; *
  2283                                  	; 14/03/2021
  2284 00000975 6650                    	push	eax ; **
  2285                                  
  2286 00000977 6631C0                  	xor	eax, eax ; clear high word of eax
  2287 0000097A A0[B23C]                	mov	al, [sectors]
  2288 0000097D 8A26[B43C]              	mov	ah, [heads]
  2289                                  
  2290                                  	; 24/10/2020
  2291                                  	;cmp	bx, 1023  ; CHS limit
  2292                                  	;jna	short cpp_19	
  2293                                  	;; > CHS limit
  2294                                  	;mov	bx, 1023 ; cylinder
  2295                                  	;;mov	cl, 0FFh ; 255 (head+1)
  2296                                  	;;mov	ch, 3Fh ; 63 (sector)
  2297                                  	;mov	cx, 3FFFh
  2298                                  	; 14/03/2021
  2299 00000981 6681FAFF030000          	cmp	edx, 1023  ; CHS limit
  2300 00000988 7609                    	jna	short cpp_19	
  2301                                  	; > CHS limit
  2302 0000098A 66BAFF030000            	mov	edx, 1023 ; cylinder
  2303 00000990 B83FFF                  	mov	ax, 0FF3Fh ; heads = 255, sector = 63
  2304                                  cpp_19:
  2305                                  	;dec	cl ; heads - 1 = end head
  2306                                  	; 14/03/2021
  2307 00000993 FECC                    	dec	ah ; heads - 1 = end head
  2308                                  
  2309                                  	; 14/03/2021
  2310                                  	; al = sectors (spt), ah = end head
  2311                                  
  2312                                  	;mov	[si+ptEndHead], cl
  2313                                  	; 14/03/2021
  2314 00000995 886405                  	mov	[si+ptEndHead], ah
  2315                                  
  2316                                  	;; 26/10/2020
  2317                                  	;;mov	al, [sectors]
  2318                                  	;; 31/10/2020
  2319                                  	;mov	al, ch
  2320                                  	;mov	[si+ptEndCylinder], bl
  2321                                  	;;mov	bl, al
  2322                                  	;;shl	bh, 6 ; shift high bytes (2 bits) of end cyl num
  2323                                  	;;	      ; to 6 bits left	
  2324                                  	;;or	bh, bl ; combine high bits of end cyl num and end sector
  2325                                  	;shl	bh, 6
  2326                                  	;or	bh, ch ; ch = end sector (= sectors)
  2327                                  	;mov	[si+ptEndSector], bh
  2328                                  	; 14/03/2021
  2329 00000998 885407                  	mov	[si+ptEndCylinder], dl
  2330 0000099B C0E606                  	shl	dh, 6
  2331 0000099E 08C6                    	or	dh, al ; or dh, byte [sectors]
  2332 000009A0 887406                  	mov	[si+ptEndSector], dh
  2333                                  
  2334                                  	; 24/10/2020
  2335                                  	;;mov	bl, [sectors]
  2336                                  	;;xor	bh, bh ; clear bh
  2337                                  	;mov	bx, [sectors] ; 17 or 63
  2338                                  	;dec	bl ; sectors - 1 ; 22/02/2019
  2339                                  	; 14/03/2021
  2340 000009A3 88C2                    	mov	dl, al ; sectors (spt)
  2341 000009A5 30F6                    	xor	dh, dh
  2342 000009A7 FECA                    	dec	dl
  2343                                  	; edx = sectors - 1
  2344                                  
  2345                                  	;mul	cl ; sectors * [end head]
  2346                                  	; 14/03/2021
  2347 000009A9 F6E4                    	mul	ah 
  2348                                  		; eax = sectors * [end head]
  2349                                  	
  2350                                  	;pop	dx ; *
  2351                                  	;; 22/02/2019
  2352                                  	;xor	cx, cx
  2353                                  	;add	ax, dx
  2354                                  	;pop	dx ; **
  2355                                  	;adc	dx, cx ; 0
  2356                                  	;add	ax, bx
  2357                                  	;adc	dx, cx ; 0
  2358                                  	;; dx:ax = ((([end cylinder]*heads)+[end head])*sectors)+sectors-1
  2359                                  	; 14/03/2021
  2360 000009AB 6601D0                  	add	eax, edx ; ([end head]*sectors)+sectors-1
  2361 000009AE 665A                    	pop	edx ; (end cylinder)*heads*sectors
  2362 000009B0 6601D0                  	add	eax, edx
  2363                                  	; eax = (([end cylinder]*heads)+[end head])*sectors)+sectors-1
  2364                                  
  2365                                  	; calculate aligned partition size in sectors
  2366                                  	;mov	cx, ax
  2367                                  	;mov	bx, dx
  2368                                  	;add	cx, 1
  2369                                  	;adc	bx, 0	
  2370                                  	;sub	cx, [si+ptStartSector]
  2371                                  	;sbb	bx, [si+ptStartSector+2]
  2372                                  	;	; bx:cx = partition size
  2373                                  	;;mov	[ppn_Sectors], cx
  2374                                  	;;mov	[ppn_Sectors+2], bx
  2375                                  	;;jmp	cpp_16
  2376                                  	; 14/03/2021
  2377 000009B3 6689C1                  	mov	ecx, eax
  2378 000009B6 6641                    	inc	ecx
  2379 000009B8 662B4C08                	sub	ecx, [si+ptStartSector]
  2380                                  		; ecx = partition size in sectors
  2381                                  
  2382 000009BC E99D00                  	jmp	cpp_15 ; 06/03/2019
  2383                                  cpp_11:
  2384                                  	; 20/02/2019
  2385                                  	;mov	cx, [ppn_Sectors]
  2386                                  	;mov	bx, [ppn_Sectors+2]
  2387                                  	; 14/03/2021
  2388 000009BF 668B0E[0C6A]            	mov	ecx, [ppn_Sectors] 
  2389                                  
  2390                                  	;;;mov	ax, [di+free_space.startsector]
  2391                                  	;;;mov	ax, [di+free_space.startsector+2]
  2392                                  	;;mov	ax, [si+ptStartSector]
  2393                                  	;;mov	dx, [si+ptStartSector+2]
  2394                                  	;mov	ax, [pp_StartSector]
  2395                                  	;mov	dx, [pp_StartSector+2]
  2396                                  	; 14/03/2021
  2397 000009C4 66A1[D469]              	mov	eax, [pp_StartSector]
  2398                                  cpp_12:	
  2399                                  	; 18/02/2019
  2400                                  
  2401                                  	; [wholedisk] = 0
  2402                                  
  2403                                  	; Fix partition size for MSDOS 3.3 (Retro DOS 3.0) compatibility.
  2404                                  	; (DOS partition size will be changed -down- to 65535 sectors,
  2405                                  	; if it is 65536 sectors.)
  2406                                  
  2407 000009C8 E8A200                  	call	fix_32mb_dos_psize
  2408                                  		; bx:cx = [ppn_sectors] = partition size
  2409                                  		; dx:ax = start sector's LBA
  2410                                  
  2411                                  	;add	ax, cx
  2412                                  	;adc	dx, bx
  2413                                  	; 14/03/2021
  2414 000009CB 6601C8                  	add	eax, ecx
  2415                                  	
  2416                                  	; Convert LBA sector address to CHS parameters
  2417                                  	;sub	ax, 1 ; locate on to end sector of the partition
  2418                                  	;sbb	dx, 0
  2419                                  	; 14/03/2021
  2420 000009CE 6648                    	dec	eax ; end sector of the partition
  2421                                  
  2422                                  	; 06/03/2019
  2423 000009D0 803E[AA6D]59            	cmp	byte [cylinder_boundary],'Y'
  2424                                  	;jne	short cpp_15
  2425 000009D5 7545                    	jne	short cpp_14
  2426                                  
  2427                                  	;mov	cx, ax
  2428                                  	;mov	al, [heads]
  2429                                  	;mul	byte [sectors]
  2430                                  	;mov	di, ax ; [heads]*[sectors]
  2431                                  	;xchg	ax, cx
  2432                                  	;	; cx = heads*spt
  2433                                  	;
  2434                                  	;call	div32
  2435                                  	;	; dx = 0
  2436                                  	;	; ax = end cylinder
  2437                                  	;	; bx = remainder
  2438                                  	; 14/03/2021
  2439 000009D7 6631D2                  	xor	edx, edx
  2440 000009DA 66F736[006A]            	div	dword [hs] ; heads*spt
  2441                                  		; eax = end cylinder
  2442                                  		; dx = remainder
  2443                                  
  2444                                  	;and	bx, bx
  2445                                  	;jz	short cpp_13
  2446                                  	;inc	ax
  2447                                  ;cpp_13:
  2448                                  	;cmp	ax, [cylinders]
  2449                                  	;jb	short cpp_14
  2450                                  	;dec	ax
  2451                                  ;cpp_14:
  2452                                  
  2453                                  	; 26/10/2020
  2454                                  	;cmp	ax, 1023
  2455                                  	;jna	short cpp_20
  2456                                  	; 14/03/2021
  2457 000009DF 663DFF030000            	cmp	eax, 1023
  2458 000009E5 760E                    	jna	short cpp_20
  2459                                  	
  2460 000009E7 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2461 000009EB C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2462 000009EF C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2463 000009F3 EB16                    	jmp	short cpp_21
  2464                                  cpp_20:
  2465                                  	;mov	bx, [heads]
  2466 000009F5 8A1E[B43C]              	mov	bl, [heads]
  2467 000009F9 FECB                    	dec	bl
  2468 000009FB 885C05                  	mov	[si+ptEndHead], bl
  2469                                  	;;mov	cx, [sectors]
  2470                                  	;mov	cl, [sectors]
  2471                                  	;mov	dl, ah
  2472                                  	;shl	dl, 6
  2473                                  	;or	dl, cl
  2474                                  	;mov	[si+ptEndSector], dl
  2475                                  	; 14/03/2021
  2476 000009FE C0E406                  	shl	ah, 6
  2477 00000A01 0A26[B23C]              	or	ah, [sectors]
  2478 00000A05 886406                  	mov	[si+ptEndSector], ah
  2479 00000A08 884407                  	mov	[si+ptEndCylinder], al	
  2480                                  	;mul	di ; [cylinders]*[heads]*[sectors]
  2481                                  	;;sub	di, cx ; ([heads] - 1) * [sectors]
  2482                                  	;add	ax, di
  2483                                  	;adc	dx, 0
  2484                                  	;;add	ax, cx
  2485                                  	;;adc	dx, 0
  2486                                  cpp_21:
  2487                                  	;inc	ax
  2488                                  	;mul	di  ; result = start LBA of next cylinder
  2489                                  	;; dx:ax = end sector LBA + 1 (as cyl. boundary aligned)
  2490                                  	; 14/03/2021
  2491 00000A0B 6640                    	inc	eax ; end sector address + 1
  2492 00000A0D 66F726[006A]            	mul	dword [hs] ; heads*spt
  2493                                  	
  2494                                  	;sub	ax, [pp_StartSector]
  2495                                  	;sbb	dx, [pp_StartSector+2]
  2496                                  	; 14/03/2021
  2497 00000A12 662B06[D469]            	sub	eax, [pp_StartSector]
  2498                                  
  2499                                  	;mov	cx, ax
  2500                                  	;mov	bx, dx
  2501                                  	;;jmp	short cpp_16
  2502                                  	; 14/03/2021
  2503 00000A17 6689C1                  	mov	ecx, eax ; partition size
  2504                                  
  2505 00000A1A EB40                    	jmp	short cpp_15
  2506                                  ;cpp_15:
  2507                                  cpp_14:
  2508                                  	; 14/03/2021
  2509                                  	; eax =  end sector
  2510                                  
  2511                                  	;mov	cx, [sectors]
  2512                                  	;call	div32
  2513                                  	;; BX = Sector number - 1
  2514                                  	;inc	bl ; sector number (1 based)
  2515                                  	;mov	[si+ptEndSector], bl
  2516                                  	;; DX_AX = cylinders * heads + head
  2517                                  	; 14/03/2021
  2518                                  	;xor	edx, edx
  2519 00000A1C 31D2                    	xor	dx, dx
  2520 00000A1E 660FB61E[B23C]          	movzx	ebx, byte [sectors]
  2521 00000A24 66F7F3                  	div	ebx
  2522                                  		 ; dl = sector number - 1
  2523 00000A27 FEC2                    	inc	dl ; sector number
  2524 00000A29 885406                  	mov	[si+ptEndSector], dl
  2525                                  
  2526                                  	;mov	cx, [heads]
  2527                                  	;call	div32
  2528                                  	;; BX = Head number
  2529                                  	;mov	[si+ptEndHead], bl
  2530                                  	;; AX = Cylinder number
  2531                                  	;;and	ax, 1023
  2532                                  	; 14/03/2021
  2533                                  	;xor	dx, dx
  2534 00000A2C 30D2                    	xor	dl, dl
  2535 00000A2E 8A1E[B43C]              	mov	bl, [heads]
  2536 00000A32 66F7F3                  	div	ebx
  2537                                  		; eax = cylinder number
  2538                                  		; dl = head number
  2539 00000A35 885405                  	mov	[si+ptEndHead], dl
  2540                                  
  2541                                  	; 26/10/2020
  2542                                  	;cmp	ax, 1023
  2543                                  	;jna	short cpp_22
  2544                                  	; 14/03/2021
  2545 00000A38 663DFF030000            	cmp	eax, 1023
  2546 00000A3E 760E                    	jna	short cpp_22
  2547                                  	
  2548 00000A40 C64405FE                	mov	byte [si+ptEndHead], 0FEh
  2549 00000A44 C64406FF                	mov	byte [si+ptEndSector], 0FFh
  2550 00000A48 C64407FF                	mov	byte [si+ptEndCylinder], 0FFh
  2551 00000A4C EB09                    	jmp	short cpp_23
  2552                                  cpp_22:
  2553 00000A4E 884407                  	mov	[si+ptEndCylinder], al
  2554                                  	; 18/02/2019
  2555 00000A51 C0E406                  	shl	ah, 6
  2556 00000A54 086406                  	or	[si+ptEndSector], ah
  2557                                  cpp_23:
  2558                                  	;mov	cx, [ppn_Sectors]
  2559                                  	;mov	bx, [ppn_Sectors+2]
  2560                                  	; 14/03/2021
  2561 00000A57 668B0E[0C6A]            	mov	ecx, [ppn_Sectors]
  2562                                  ;cpp_16:
  2563                                  cpp_15:
  2564                                  	;mov	[si+ptSectors], cx
  2565                                  	;mov	[si+ptSectors+2], bx
  2566                                  	; 14/03/2021
  2567 00000A5C 66894C0C                	mov	[si+ptSectors], ecx
  2568                                  
  2569                                  	; set partition ID after checking DOS FAT limits
  2570 00000A60 E8E500                  	call	set_partition_id
  2571                                  	; al = partition ID
  2572                                  
  2573                                  	; 14/03/2021
  2574                                  	; clear -specially- high word of ecx
  2575 00000A63 6631C9                  	xor	ecx, ecx ; (this may not be needed!?)
  2576                                  
  2577 00000A66 A2[DD69]                	mov	[pp_type], al
  2578                                  
  2579 00000A69 884404                  	mov	[si+ptFileSystemID], al
  2580                                  
  2581 00000A6C C3                      	retn
  2582                                  
  2583                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2584                                  ; decrease DOS partition size when it is (exact) 65536 sectors
  2585                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2586                                  ; 07/11/2020 (fdisk4)
  2587                                  ; 18/02/2019
  2588                                  
  2589                                  fix_32mb_dos_psize:	; call this if [wholedisk] = 0
  2590                                  
  2591                                  ; Purpose: 
  2592                                  ;	If a DOS partition's size is 65536 sectors
  2593                                  ;	MSDOS 3.3 can not use it. (FAT 16 partition ID = 06h)
  2594                                  ;	Decreasing partition size to 65535 sectors will ensure
  2595                                  ;	MSDOS 3.3 compatibility (FAT 16 partition ID will be 04h).
  2596                                  
  2597                                  	; INPUT:
  2598                                  	;    BX:CX = partition size in sectors
  2599                                  	;    [pp_type] = partition type dos, non-dos, user input
  2600                                  	;
  2601                                  	; OUTPUT:
  2602                                  	;    Partition size will be changed to 65535 sectors, if
  2603                                  	;    	- partition size is 65536 sectors and
  2604                                  	; 	- [pp_type] is 1 (DOS)
  2605                                  	;
  2606                                  	;    [ppn_Sectors] = 65535 (if it will be changed)
  2607                                  	;
  2608                                  	; (Modified registers: cx, bx) 
  2609                                  
  2610                                  	;mov	cx, [ppn_Sectors]
  2611                                  	;mov	bx, [ppn_Sectors+2]
  2612                                  
  2613 00000A6D 803E[DD69]01            	cmp	byte [pp_type], 1 ;  DOS partition
  2614 00000A72 7514                    	jne	short psfx_0  ; non-dos partition or user input
  2615                                  			      ; nothing to do !
  2616                                  	; 07/11/2020
  2617                                  	;or	cx, cx
  2618 00000A74 7512                    	jnz	short psfx_0 ; <> 65536 sectors
  2619                                  	;cmp	bx, 1
  2620 00000A76 7510                    	jne	short psfx_0
  2621                                  	;dec	bx
  2622                                  	;;mov	[wholedisk], bx ; 0
  2623                                  	;dec	cx  ; bx:cx = 65535
  2624                                  	;mov	[ppn_Sectors], cx
  2625                                  	;mov	[ppn_Sectors+2], bx
  2626                                  
  2627                                  	; 07/11/2020 (fdisk4)
  2628 00000A78 6681F900000100          	cmp	ecx, 65536
  2629 00000A7F 7507                    	jne	short psfx_0
  2630 00000A81 6649                    	dec	ecx  ; 65535
  2631 00000A83 66890E[0C6A]            	mov	[ppn_Sectors], ecx
  2632                                  psfx_0:
  2633 00000A88 C3                      	retn
  2634                                  
  2635                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2636                                  ; create extended dos partition
  2637                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2638                                  ; 24/10/2020 (fdisk3.s)
  2639                                  
  2640                                  ; 16/02/2019 (hdimage.s) 
  2641                                  ;	(This procedure must be called after 'find_part_free_space')
  2642                                  
  2643                                  	; 15/03/2021 (fdisk4.s)
  2644                                  create_extended_partition:  
  2645                                  	; 15/02/2019
  2646                                  
  2647                                  	; INPUT:
  2648                                  	;	none 
  2649                                  	;  (CHS parameters and free space calculation result will be used.)
  2650                                  	;
  2651                                  	; OUTPUT:
  2652                                  	;	Partition table in MBR buffer will be updated.
  2653                                  	;
  2654                                  	; (Modified registers: ax, bx, cx, dx, si, di)
  2655                                  
  2656                                  	; Create extended dos partition, make partition table entry
  2657                                  	; (Extended partition will be created on cylinder bounds.)
  2658                                  
  2659                                  	; 16/02/2019
  2660 00000A89 E8D81A                  	call	get_first_free_pte
  2661                                  		 ; CX = First free PTE number, 0 to 3 
  2662                                  		 ;    (CX = 3 if there is not a free PTE, and CF = 1)
  2663                                  		 ;    ((But CF = 1 is not possible here because pcount < 4))
  2664                                   	 	 ; SI = PTE addres/offset in MBR buffer
  2665                                  
  2666                                  	;mov	si, MasterBootBuff+pTableOffset
  2667                                  	;shl	cl, 4 ; * 16
  2668                                  	;add	si, cx
  2669                                  	
  2670                                  	;mov	bx, [c_fspc_offset]
  2671                                  	; 15/03/2021
  2672 00000A8C 8B3E[A86D]              	mov	di, [c_fspc_offset]
  2673                                  
  2674                                  	;mov	ax, [bx+free_space.start]
  2675                                  	; 15/03/2021
  2676 00000A90 668B85[3E6D]            	mov	eax, [di+free_space.start]
  2677                                  
  2678                                  	; 24/10/2020
  2679                                  	;mov	di, ax ; 15/03/2021
  2680                                  
  2681                                  	;mov	cx, 1
  2682 00000A95 B101                    	mov	cl, 1 ; head (ch) = 0, sector (cl) = 1
  2683                                  
  2684                                  	; 15/03/2021
  2685 00000A97 6689C3                  	mov	ebx, eax
  2686                                  
  2687                                  	;cmp	ax, 1023
  2688                                  	;jna	short cep_4
  2689                                  	; 15/03/2021
  2690 00000A9A 663DFF030000            	cmp	eax, 1023
  2691 00000AA0 7609                    	jna	short cep_4
  2692                                  
  2693                                  	; partition start  > CHS limit
  2694                                  	;mov	ax, 1023
  2695                                  	; 15/03/2021
  2696 00000AA2 66B8FF030000            	mov	eax, 1023
  2697                                  
  2698                                  	;mov	ch, 254
  2699                                  	;mov	cl, 63
  2700 00000AA8 B93FFE                  	mov	cx, 0FE3Fh
  2701                                  cep_4:	
  2702                                  	;mov	byte [si+ptBootable], 0 ; not bootable/active partition
  2703                                  	;mov	[si], ch ; 0 ; not bootable/active partition
  2704                                  	; 26/10/2020
  2705 00000AAB C60400                  	mov	byte [si], 0
  2706 00000AAE 886C01                  	mov	[si+ptBeginHead], ch
  2707 00000AB1 C0E406                  	shl	ah, 6
  2708 00000AB4 08E1                    	or	cl, ah
  2709 00000AB6 884C02                  	mov	[si+ptBeginSector], cl ; Sector 1
  2710 00000AB9 884403                  	mov	[si+ptBeginCylinder], al
  2711                                  
  2712                                  	;mov	al, [heads]
  2713                                  	;mul	byte [sectors]
  2714                                  	;	; ax = heads*sectors
  2715                                  	;mul	di  ; AX * cylinder count before start cylinder
  2716                                  	;	; DX:AX = LBA of cylinder DI, head 0, sector 1 
  2717                                  	; 15/03/2021
  2718                                  	; eax = start cylinder
  2719 00000ABC 6689D8                  	mov	eax, ebx
  2720 00000ABF 66F726[006A]            	mul	dword [hs] ; heads * sectors
  2721                                  		; eax = start sector, edx = 0
  2722                                  	
  2723                                  	;mov	[si+ptStartSector], ax
  2724                                  	;mov	[si+ptStartSector+2], dx
  2725                                  	; 15/03/2021
  2726 00000AC4 66894408                	mov	[si+ptStartSector], eax
  2727                                  
  2728                                  	; This is not needed for extended partition.
  2729                                  	; 16/02/2019
  2730                                  	;mov	[pp_StartSector], ax
  2731                                  	;mov	[pp_StartSector+2], dx
  2732                                  	; 15/03/2021
  2733                                  	;mov	[pp_StartSector], eax
  2734                                  
  2735                                  	; 16/02/2019
  2736 00000AC8 803E[DC69]00            	cmp	byte [wholedisk], 0
  2737 00000ACD 7719                    	ja	short cep_2 ; all of free space will be used
  2738                                  			    ; ([bx+free_space.end] will be end cyl)
  2739                                  
  2740                                  	; calculate cylinder count (from partition size input)
  2741                                  	;mov	al, [heads]
  2742                                  	;mul	byte [sectors]
  2743                                  	;mov	cx, ax
  2744                                  	;mov	ax, [ppn_Sectors]
  2745                                  	;mov	dx, [ppn_Sectors+2]
  2746                                  	;call	div32
  2747                                  	;	; ax = cylinders
  2748                                  	;	; bx = remainder
  2749                                  	;and	bx, bx
  2750                                  	;jz	short cep_1
  2751                                  	;inc	ax  ; round up
  2752                                  	; 15/03/2021
  2753                                  	; edx = 0
  2754 00000ACF 66A1[0C6A]              	mov	eax, [ppn_Sectors]
  2755 00000AD3 66F736[006A]            	div	dword [hs] ; heads * spt
  2756                                  		; eax = cylinders, dx = remainder
  2757 00000AD8 21D2                    	and	dx, dx
  2758 00000ADA 7402                    	jz	short cep_1
  2759 00000ADC 6640                    	inc	eax ; round up
  2760                                  cep_1:
  2761                                  	; 15/03/2021
  2762                                  	; EBX = extended partition's start cylinder
  2763                                   	; 16/02/2019
  2764                                  	; DI  = extended partition's start cylinder
  2765                                  	;mov	dx, ax ; cylinder count
  2766                                  	;add	dx, di ; result is end cyl + 1
  2767                                  	;dec	dx ; decrease number for current end cylinder
  2768                                  	;mov	bx, [c_fspc_offset]
  2769                                  	;cmp	dx, [bx+free_space.end]
  2770                                  	;jna	short cep_3
  2771                                  	; 24/10/2020
  2772                                  	;;dec	ax ; decrease cylinder count down to the limit
  2773                                  	;dec	dx ; decrease end cylinder down to the limit
  2774                                  	; 15/03/2021	
  2775 00000ADE 6689C2                  	mov	edx, eax ; cylinder count
  2776 00000AE1 6601DA                  	add	edx, ebx ; result is end cyl + 1
  2777 00000AE4 664A                    	dec	edx ; end cylinder
  2778                                  	;mov	di, [c_fspc_offset]
  2779                                  
  2780 00000AE6 EB05                    	jmp	short cep_3
  2781                                  cep_2:
  2782                                  	; 15/03/2021
  2783                                  	; DI = [c_fspc_offset]
  2784                                  
  2785                                  	;mov	dx, [bx+free_space.end]
  2786                                  	;;mov	ax, [bx+free_space.space]
  2787                                  	; 15/03/2021
  2788 00000AE8 668B97[426D]            	mov	edx, [bx+free_space.end]
  2789                                  cep_3:
  2790                                  	; 15/03/2021
  2791 00000AED 6631DB                  	xor	ebx, ebx
  2792                                  
  2793                                  	; 24/10/2020
  2794                                  	;mov	ax, dx ; end cylinder
  2795                                  	;mov	bl, 05h	; Extended Partition ID (CHS)
  2796                                  	;cmp	ax, 1023
  2797                                  	;jna	short cep_5
  2798                                  	; 15/03/2021
  2799 00000AF0 6689D0                  	mov	eax, edx ; end cylinder
  2800 00000AF3 B305                    	mov	bl, 05h ; Extended Partition ID (CHS)
  2801 00000AF5 663DFF030000            	cmp	eax, 1023
  2802 00000AFB 760D                    	jna	short cep_5
  2803                                  
  2804                                  	; partition end > CHS limit
  2805                                  	;mov	ax, 1023
  2806                                  	; 15/03/2021
  2807 00000AFD 66B8FF030000            	mov	eax, 1023
  2808                                  
  2809                                  	;mov	ch, 254
  2810                                  	;mov	cl, 63
  2811 00000B03 B93FFE                  	mov	cx, 0FE3Fh
  2812 00000B06 B30F                    	mov	bl, 0Fh	; Extended Partition ID (LBA)
  2813 00000B08 EB0A                    	jmp	short cep_6
  2814                                  cep_5:
  2815 00000B0A 8A2E[B43C]              	mov	ch, [heads]
  2816 00000B0E FECD                    	dec	ch 
  2817 00000B10 8A0E[B23C]              	mov	cl, [sectors]
  2818                                  cep_6:
  2819 00000B14 886C05                  	mov	[si+ptEndHead], ch
  2820                                  	; 24/10/2020
  2821                                  	; ax = (chs limit compatible) end cylinder (<= 1023)
  2822                                  	; 23/02/2019
  2823                                  	;mov	bl, dh
  2824                                  	;shl	bl, 6
  2825                                  	;or	bl, cl
  2826 00000B17 C0E406                  	shl	ah, 6
  2827                                  	;or	cl, ah
  2828                                  	;;mov	[si+ptEndSector], bl
  2829                                  	;mov	[si+ptEndSector], cl
  2830                                  	; 15/03/2021
  2831 00000B1A 08CC                    	or	ah, cl
  2832 00000B1C 886406                  	mov	[si+ptEndSector], ah
  2833                                  	;mov	[si+ptEndCylinder], dl
  2834 00000B1F 884407                  	mov	[si+ptEndCylinder], al
  2835                                  	; dx = (lba compatible) end cylinder (up to 65535)
  2836                                  
  2837                                  	;mov	al, [heads]
  2838                                  	; 26/10/2020
  2839                                  	;;;mul	cl
  2840                                  	;;mul	byte [sectors]
  2841                                  	;mov	ch, [heads]
  2842                                  	;mov	al, [sectors]
  2843                                  	;mul	ch	
  2844                                  	;; ax = heads*sectors
  2845                                  	;mul	dx ; AX * cylinder count before end cylinder
  2846                                  	;	; DX:AX = LBA of cylinder DX, head 0, sector 1
  2847                                  	; 15/03/2021
  2848                                  	; edx = end cylinder
  2849 00000B22 66A1[006A]              	mov	eax, [hs] ; [heads] * [sectors]
  2850 00000B26 66F7E2                  	mul	edx
  2851                                  		; eax = LBA of end cylinder, head 0, sector 1
  2852                                  		; edx = 0
  2853                                  	;push	dx
  2854                                  	;push	ax
  2855                                  	; 15/03/2021
  2856 00000B29 6650                    	push	eax ; (end cylinder)*heads*sectors
  2857                                  	
  2858 00000B2B 88E8                    	mov	al, ch
  2859 00000B2D FEC8                    	dec	al ; 26/10/2020 ; [heads] - 1
  2860                                  	;mov	cx, [sectors]  ; 63 or 17
  2861                                  	; cl = sectors ; 15/03/2021
  2862 00000B2F F6E1                    	mul	cl
  2863                                  		; ax = (heads-1)*sectors
  2864                                  	; 15/03/2021
  2865 00000B31 89C2                    	mov	dx, ax ; (heads-1)*sectors
  2866                                  	
  2867                                  	;pop	dx
  2868                                  	;add	ax, dx
  2869                                  	;pop	dx
  2870                                  	;adc	dx, 0
  2871                                  	;	; dx:ax = ((end cylinder)*heads)+(heads-1)*sectors
  2872                                  	;add	ax, cx
  2873                                  	;adc	dx, 0
  2874                                  	; dx:ax = (((end cylinder)*heads)+(heads-1))*sectors) + sectors
  2875                                  	; dx:ax = LBA of the partition's end sector + 1
  2876                                  
  2877                                  	; 15/03/2021
  2878 00000B33 30ED                    	xor	ch, ch
  2879 00000B35 01CA                    	add	dx, cx ; ((heads-1)*sectors)+sectors
  2880 00000B37 6658                    	pop	eax ; ((end cylinder)*heads)*sectors
  2881 00000B39 6601D0                  	add	eax, edx
  2882                                  	; eax = (((end cylinder)*heads)+(heads-1))*sectors)+sectors
  2883                                  
  2884                                  	;sub	ax, [si+ptStartSector]
  2885                                  	;sbb	dx, [si+ptStartSector+2]
  2886                                  	; 15/03/2021
  2887 00000B3C 662B4408                	sub	eax, [si+ptStartSector]
  2888                                  	
  2889                                  	;mov	[si+ptSectors], ax
  2890                                  	;mov	[si+ptSectors+2], dx
  2891                                  	; 15/03/2021
  2892 00000B40 6689440C                	mov	[si+ptSectors], eax
  2893                                  
  2894                                  	;mov	[pp_type], al
  2895                                  
  2896                                  	;mov	byte [si+ptFileSystemID], 5
  2897                                  	; 24/10/2020
  2898 00000B44 885C04                  	mov	 [si+ptFileSystemID], bl ; 05h or 0Fh
  2899                                  	
  2900 00000B47 C3                      	retn
  2901                                  
  2902                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2903                                  ; set DOS (and non-dos) partition ID according to partition size
  2904                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2905                                  ; 23/10/2020
  2906                                  
  2907                                  	; 15/03/2021
  2908                                  set_partition_id: 
  2909                                  	; 07/11/2020 (fdisk4.s, 32 bit registers)
  2910                                  	; 23/10/2020 (fdisk3.s)
  2911                                  	; input:
  2912                                  	;   si = partition table offset
  2913                                  	;   bx:cx = partition size
  2914                                  
  2915                                  	; 18/02/2019 (hdimage.s)
  2916                                  	;mov	cx, [ppn_Sectors]
  2917                                  	;mov	bx, [ppn_Sectors+2]
  2918                                  
  2919 00000B48 A0[DD69]                	mov	al, [pp_type]
  2920                                  
  2921                                  	;cmp	byte [pp_type], 1
  2922 00000B4B 3C01                    	cmp	al, 1 ; primary DOS (FAT12, FAT16, FAT32)
  2923 00000B4D 7525                    	jne	short spid_2 ; singlix, runix or user type
  2924                                  
  2925                                  	;mov	al, 1	; FAT12
  2926                                  
  2927                                  	;or	bx, bx
  2928                                  	;jnz	short spid_1
  2929                                  	; 15/03/2021
  2930 00000B4F 6681F900000100          	cmp	ecx, 65536 ; >= 32 MB
  2931 00000B56 730D                    	jnb	short spid_1	
  2932                                  
  2933                                  	;cmp	cx, 32680
  2934                                  	;;jna	short spid_8	; FAT12 file system
  2935                                  	;jna	short spid_19 ; 23/10/2020
  2936                                  	; 07/11/2020
  2937 00000B58 6681F9A87F0000          	cmp	ecx, 32680
  2938 00000B5F 7620                    	jna	short spid_19
  2939                                  
  2940 00000B61 B004                    	mov	al, 4	; FAT16 (< 32MB)
  2941                                  
  2942 00000B63 EB46                    	jmp	short spid_8	; FAT16 (CHS) file system
  2943                                  
  2944                                  spid_1:
  2945 00000B65 B00B                    	mov	al, 0Bh ; FAT32 (CHS)
  2946                                  
  2947                                  	;cmp	bx, 10h
  2948                                  	; 07/11/2020
  2949 00000B67 6681F900001000          	cmp	ecx, 100000h ; 512 MB 
  2950 00000B6E 733B                    	jnb	short spid_8	; FAT32 (CHS) file system
  2951                                  
  2952 00000B70 B006                    	mov	al, 6	; FAT16 (>= 32MB)
  2953                                  
  2954 00000B72 EB37                    	jmp	short spid_8	; FAT16 big (CHS) file system
  2955                                  
  2956                                  spid_2:
  2957                                  	;cmp	byte [pp_type], 2 ; Singlix FS
  2958 00000B74 3C02                    	cmp	al, 2
  2959 00000B76 7503                    	jne	short spid_3
  2960 00000B78 B0A1                    	mov	al, 0A1h
  2961                                  	;jmp	short spid_8
  2962 00000B7A C3                      	retn	; 23/10/2020
  2963                                  spid_3:
  2964                                  	;cmp	byte [pp_type], 3 ; Retro Unix FS
  2965 00000B7B 3C03                    	cmp	al, 3
  2966 00000B7D 7503                    	jne	short spid_4
  2967 00000B7F B071                    	mov	al, 71h	
  2968                                  	;jmp	short spid_8
  2969                                  spid_19:
  2970 00000B81 C3                      	retn
  2971                                  
  2972                                  spid_4:
  2973                                  	; another partition type (user input)
  2974                                  	
  2975                                  	; [pp_type] = 4
  2976                                  
  2977 00000B82 A0[DE69]                	mov	al, [pp_type_user]
  2978                                  
  2979                                  	; Check FAT12 fs size validation
  2980                                  
  2981 00000B85 3C01                    	cmp	al, 1 ; FAT12
  2982 00000B87 7737                    	ja	short spid_9
  2983                                  
  2984                                  	;and	bx, bx
  2985                                  	;jnz	short spid_6
  2986                                  
  2987                                  	;cmp	cx, 32680
  2988                                  	;;jna	short spid_8
  2989                                  	;jna	short spid_19 ; 23/10/2020
  2990                                  
  2991                                  	; 07/11/2020
  2992 00000B89 6681F900000100          	cmp	ecx, 65536
  2993 00000B90 730A                    	jnb	short spid_6
  2994 00000B92 81F9A87F                	cmp	cx, 32680
  2995 00000B96 76E9                    	jna	short spid_19
  2996                                  spid_5:
  2997 00000B98 B004                    	mov	al, 4 ; FAT16 (<= 32MB)
  2998 00000B9A EB0F                    	jmp	short spid_8
  2999                                  spid_6:
  3000                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  3001                                  	;cmp	bx, 40h ; 2GB (64*32MB)
  3002                                  	;jnb	short spid_7
  3003                                  	; 15/03/2021
  3004 00000B9C 6681F900004000          	cmp	ecx, 400000h ; 2GB (64K*64 sectors)
  3005 00000BA3 7304                    	jnb	short spid_7
  3006                                  
  3007 00000BA5 B006                    	mov	al, 6
  3008 00000BA7 EB02                    	jmp	short spid_8
  3009                                  spid_7:
  3010 00000BA9 B00B                    	mov	al, 0Bh ; FAT32 (CHS) partition
  3011                                  spid_8:
  3012                                  	; 23/10/2020
  3013                                  	; check the partition's end sector against CHS limit and
  3014                                  	; convert partition ID if the partition overs CHS limit
  3015                                  	;cmp	al, 1 ; FAT12 fs
  3016                                  	;je	short spid_19 ; nothing to do (for FAT12 fs)
  3017                                  	;add	cx, [si+ptStartSector]
  3018                                  	;adc	bx, [si+ptStartSector+2]
  3019                                  	; 15/03/2021
  3020 00000BAB 66034C08                	add	ecx, [si+ptStartSector]
  3021                                  	
  3022                                  	;cmp	bx, [chs_limit+2]
  3023                                  	;jb	short spid_19 ; partition's end sector is in CHS limit
  3024                                  	;ja	short spid_17 ; out of CHS limit
  3025                                  	;cmp	cx, [chs_limit]
  3026                                  	;jna	short spid_19 ; partition's end sector is in CHS limit
  3027                                  	; 07/11/2020
  3028 00000BAF 663B0E[4665]            	cmp	ecx, [chs_limit]
  3029 00000BB4 76CB                    	jna	short spid_19 ; partition's end sector is in CHS limit
  3030                                  spid_17:
  3031                                  	; out of CHS limit, partition ID conversion is needed
  3032 00000BB6 3C0B                    	cmp	al, 0Bh	; FAT32 CHS
  3033 00000BB8 7203                    	jb	short spid_18
  3034 00000BBA B00C                    	mov	al, 0Ch	; FAT 32 LBA
  3035 00000BBC C3                      	retn
  3036                                  spid_18:
  3037 00000BBD B00E                    	mov	al, 0Eh ; FAT16 LBA
  3038 00000BBF C3                      	retn
  3039                                  spid_9:
  3040 00000BC0 3C04                    	cmp	al, 4 ; FAT16 (< 32 MB)
  3041 00000BC2 7511                    	jne	short spid_10
  3042                                  
  3043                                  	;or	bx, bx
  3044                                  	;jnz	short spid_6
  3045                                  	; 15/03/2021
  3046 00000BC4 6681F900000100          	cmp	ecx, 65536
  3047 00000BCB 73CF                    	jnb	short spid_6
  3048 00000BCD 81F93610                	cmp	cx, 4150 ; 4085 + 32 + 32 + 1
  3049 00000BD1 7220                    	jb	short spid_12
  3050                                  	
  3051                                  	;retn	; FAT16 (< 32 MB) partition
  3052 00000BD3 EBD6                    	jmp	short spid_8  ; 23/10/2020
  3053                                  
  3054                                  spid_10:
  3055 00000BD5 3C06                    	cmp	al, 6 ; FAT 16 big partition
  3056 00000BD7 751D                    	jne	short spid_13 ; Extended partition or another type
  3057                                  	
  3058                                  	;and	bx, bx
  3059                                  	;jz	short spid_11
  3060                                  	; 07/11/2020
  3061 00000BD9 6681F900000100          	cmp	ecx, 65536
  3062 00000BE0 720B                    	jb	short spid_11
  3063                                  
  3064                                  	;;cmp	bx, 10h	; 512MB (16*32MB)
  3065                                  	;cmp	bx, 40h ; 2GB (64*32MB)
  3066                                  	;jnb	short spid_7
  3067                                  	; 15/03/2021
  3068 00000BE2 6681F900004000          	cmp	ecx, 400000h ; 2GB (64K*64 sectors)
  3069 00000BE9 73BE                    	jnb	short spid_7
  3070                                  
  3071                                  	;retn
  3072 00000BEB EBBE                    	jmp	short spid_8 ; 23/10/2020
  3073                                  
  3074                                  spid_11:
  3075                                  	;cmp	ax, 4150 ; 4085 + 32 + 32 + 1
  3076 00000BED 81F93610                	cmp	cx, 4150 ; 14/09/2020 (BugFix)
  3077 00000BF1 73A5                    	jnb	short spid_5
  3078                                  spid_12:
  3079 00000BF3 B001                    	mov	al, 1 ;  FAT12 partition
  3080                                  spid_16:
  3081 00000BF5 C3                      	retn
  3082                                  spid_13:
  3083                                  	; 14/09/2020
  3084 00000BF6 3C0B                    	cmp	al, 0Bh ; FAT 32 (CHS) partition
  3085 00000BF8 7432                    	je	short spid_15 ; FAT 32 CHS
  3086 00000BFA 3C0C                    	cmp	al, 0Ch	 
  3087 00000BFC 7515                    	jne	short spid_14
  3088                                  	; FAT 32 LBA
  3089                                  	;and	bx, bx	; < 33 MB
  3090                                  	;jz	short spid_11 ; force to FAT 16 CHS or FAT 12
  3091                                  	;cmp	bx, 10h ; 512 MB
  3092                                  	;;jnb	short spid_8  ; OK, FAT 32 LBA has been confirmed
  3093                                  	;jnb	short spid_16 ; 23/10/2020
  3094                                  	; 15/03/2021
  3095 00000BFE 6681F900000100          	cmp	ecx, 65536
  3096 00000C05 72E6                    	jb	short  spid_11 ; force to FAT 16 CHS or FAT 12
  3097 00000C07 6681F900001000          	cmp	ecx, 100000h ; 512MB
  3098 00000C0E 73E5                    	jnb	short spid_16  ; OK
  3099                                  	; < 512MB
  3100 00000C10 B00E                    	mov	al, 0Eh ; force to FAT 16 LBA
  3101 00000C12 C3                      	retn
  3102                                  spid_14:
  3103                                  	; 14/09/2020
  3104 00000C13 3C0E                    	cmp	al, 0Eh
  3105                                  	;jne	short spid_8 ; non-dos or extended partition
  3106 00000C15 75DE                    	jne	short spid_16 ; 23/10/2020
  3107                                  	; FAT 16 LBA
  3108                                  	;or	bx, bx
  3109                                  	;jz	short spid_11
  3110                                  	; 15/03/2021
  3111 00000C17 6681F900000100          	cmp	ecx, 65536
  3112 00000C1E 72CD                    	jb	short spid_11
  3113                                  	; 23/10/2020
  3114                                  	;cmp	bx, 20h ; 1 GB
  3115                                  	;jb	short spid_16
  3116                                  	; 15/03/2021
  3117                                  	;((this 1GB limit may be 2GB))
  3118 00000C20 6681F900002000          	cmp	ecx, 200000h ; 1GB
  3119 00000C27 72CC                    	jb	short spid_16
  3120 00000C29 B00C                    	mov	al, 0Ch	; FAT 32 LBA
  3121 00000C2B C3                      	retn
  3122                                  spid_15:
  3123                                  	; Minimum size of FAT 32 FS = 65525 + 512 + 512 + 32
  3124                                   	; >= 66581 sectors (or >= 65525 data clusters)
  3125                                  	;cmp	bx, 1
  3126                                  	;jb	short spid_11  ; invalid! (< 32 MB)
  3127                                  	;ja	short spid_8
  3128                                  	;cmp	cx, 1045
  3129                                  	;;jb	short spid_16  ; invalid! (< 33 MB)
  3130                                  	;;retn
  3131                                  	;;jmp	short spid_8 ; 23/10/2020
  3132                                  	;jnb	short spid_8
  3133                                  	; 15/03/2021
  3134 00000C2C 6681F915040100          	cmp	ecx, 66581
  3135 00000C33 0F8374FF                	jnb	spid_8   ; OK (>= 33MB)
  3136 00000C37 6681F900000100          	cmp	ecx, 65536
  3137 00000C3E 72AD                    	jb	short spid_11  ; invalid! (< 32MB)
  3138                                  ;spid_16:
  3139 00000C40 B006                    	mov	al, 6
  3140                                  	;retn
  3141 00000C42 E966FF                  	jmp	spid_8 ; 23/10/2020
  3142                                  
  3143                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3144                                  ; 32 bit division by using 16 bit registers
  3145                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3146                                  
  3147                                  	; 06/11/2020 (fdisk4)
  3148                                  	; 32 bit division (80386 div instruction for 32 bit regs)
  3149                                  	; will be used instead of div32 procedure for 16 bit regs
  3150                                  ;div32:
  3151                                  	;; DX_AX/CX
  3152                                  	;; Result: DX_AX, BX (remainder)
  3153                                  	;mov	bx, ax
  3154                                  	;;or	dx, ax ; * DX_AX = 0 ?
  3155                                  	;;jz	short div32_retn ; yes, do not divide!
  3156                                  	;mov	ax, dx
  3157                                          ;xor	dx, dx
  3158                                          ;div	cx	; at first, divide DX
  3159                                  	;		; remainder is in DX 
  3160                                  	;xchg	ax, bx	; now quotient is in BX
  3161                                    	;		; and initial AX value is in AX
  3162                                  	;div	cx	; now, DX_AX has been divided and
  3163                                  	;		; AX has quotient
  3164                                  	;		; DX has remainder
  3165                                  	;xchg	dx, bx	; finally, BX has remainder
  3166                                  ;;div32_retn:
  3167                                          ;retn
  3168                                  
  3169                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3170                                  ; 32 bit multiplication by using 16 bit registers
  3171                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3172                                  
  3173                                  	; 06/11/2020 (fdisk4)
  3174                                  	; 32 bit multiplication (80386 mul instruction)
  3175                                  	; will be used instead of mul32 procedure for 16 bit regs
  3176                                  ;mul32:
  3177                                  	;; DX_AX*CX
  3178                                  	;; Result: BX_DX_AX 
  3179                                  	;push	cx
  3180                                  	;mov	bx, dx
  3181                                  	;mul	cx
  3182                                   	;xchg	ax, bx
  3183                                  	;push	dx
  3184                                  	;mul	cx 
  3185                                  	;pop	cx 
  3186                                  	;add	ax, cx 
  3187                                  	;adc	dx, 0
  3188                                  	;xchg	bx, ax
  3189                                  	;xchg	dx, bx
  3190                                  	;pop	cx
  3191                                  	;retn
  3192                                  
  3193                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3194                                  ; creeate new partition input menu
  3195                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3196                                  
  3197                                  B_01:
  3198                                  	; 06/03/2019
  3199 00000C45 C606[EA69]4D            	mov	byte [pSize_unit], 'M' ; default (for 'whole' disk/space)
  3200                                  	; 15/02/2019
  3201 00000C4A E82DFB                  	call	create_partition_input
  3202                                  B_02:		
  3203 00000C4D 21C0                    	and	ax, ax
  3204                                  	;jz	_crlf_exit ; 0 = none or not a valid input
  3205 00000C4F 0F8480F7                	jz	A_42 ; 25/02/2019
  3206                                  
  3207                                  	;or	ah, ah
  3208                                  	;jz	short B_03
  3209                                  
  3210                                  	; 23/02/2019
  3211 00000C53 80FC04                  	cmp	ah, 4  ; user's partition type input ?
  3212 00000C56 7505                    	jne	short B_03 ; no
  3213                                  
  3214                                  	; 29/10/2020
  3215                                  	; (ah = 0)
  3216                                  	;or	al, al
  3217                                  	;jz	A_42  ; invalid partition type input
  3218                                  	;	      ; or ESC key has been pressed
  3219                                  
  3220                                  	; user type input
  3221 00000C58 A2[DE69]                	mov	[pp_type_user], al
  3222 00000C5B 88E0                    	mov	al, ah ; mov al, 4
  3223                                  B_03:
  3224 00000C5D A2[DD69]                	mov	[pp_type], al
  3225                                  
  3226                                  	; clear screen
  3227 00000C60 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3228 00000C63 CD10                    	int	10h
  3229                                  
  3230 00000C65 A0[DD69]                	mov	al, [pp_type]
  3231 00000C68 3C01                    	cmp	al, 1
  3232 00000C6A 7705                    	ja	short B_04
  3233                                  
  3234 00000C6C BE[1145]                	mov	si,  msg_create_dos_partition_h ; header
  3235 00000C6F EB70                    	jmp	short B_09
  3236                                  B_04:
  3237 00000C71 3C05                    	cmp	al, 5
  3238 00000C73 7269                    	jb	short B_08
  3239                                  	;ja	short B_07
  3240 00000C75 7741                    	ja	short B_58 ; 26/10/2020
  3241                                  
  3242                                  	; 23/02/2019
  3243 00000C77 BE[0646]                	mov	si, msg_create_ext_partition_h
  3244 00000C7A E8420D                  	call	print_msg
  3245                                  
  3246                                  	; 24/02/2019
  3247 00000C7D 803E[E16C]00            	cmp	byte [epnumber], 0
  3248 00000C82 7613                    	jna	short B_05
  3249                                  
  3250 00000C84 BE[D95B]                	mov	si, msg_ext_partition_exists
  3251 00000C87 E8350D                  	call 	print_msg
  3252                                  
  3253 00000C8A BE[C852]                	mov	si, msg_press_any_key
  3254 00000C8D E82F0D                  	call	print_msg
  3255                                  
  3256 00000C90 30E4                    	xor	ah, ah
  3257 00000C92 CD16                    	int	16h
  3258                                  
  3259 00000C94 E93CF7                  	jmp	A_42
  3260                                  B_05:
  3261 00000C97 803E[DF6C]00            	cmp	byte [ppcount], 0  ; primary partition count
  3262 00000C9C 7746                    	ja	short B_10
  3263                                  
  3264                                  	; 09/02/2019
  3265 00000C9E BE[8D4C]                	mov	si, msg_ext_partition_error
  3266 00000CA1 E81B0D                  	call	print_msg
  3267                                  B_06:	
  3268 00000CA4 BE[C852]                	mov	si, msg_press_any_key
  3269 00000CA7 E8150D                  	call	print_msg
  3270                                  
  3271 00000CAA 30E4                    	xor	ah, ah
  3272 00000CAC CD16                    	int	16h
  3273                                  
  3274 00000CAE C606[DD69]01            	mov	byte [pp_type], 1
  3275                                  
  3276 00000CB3 E8EFFA                  	call	cpi_2 ; 15/02/2019
  3277 00000CB6 EB95                    	jmp	short B_02
  3278                                  
  3279                                  B_58:
  3280                                  	; 26/10/2020
  3281 00000CB8 803E[3E65]80            	cmp	byte [DrvNum], 80h ; hd0 ?
  3282 00000CBD 7707                    	ja	short B_59 ; Do not check primary dos partition count
  3283                                  	; The second hard disk may contain extended partition without
  3284                                  	; a primary dos partition
  3285 00000CBF 803E[DF6C]00            	cmp	byte [ppcount], 0  ; primary dos partition count
  3286 00000CC4 760A                    	jna	short B_07
  3287                                  B_59:
  3288 00000CC6 803E[E16C]00            	cmp	byte [epnumber], 0
  3289                                  			; is there an extended partition ?
  3290 00000CCB 7603                    	jna	short B_07 ; no
  3291 00000CCD E9CDF7                  	jmp	create_logical_drives
  3292                                  B_07:
  3293 00000CD0 BE[FB46]                	mov	si, msg_create_logical_drive_h
  3294 00000CD3 E8E90C                  	call	print_msg
  3295                                  
  3296 00000CD6 BE[CC4C]                	mov	si, msg_logical_drive_error
  3297 00000CD9 E8E30C                  	call	print_msg
  3298 00000CDC EBC6                    	jmp	short B_06
  3299                                  
  3300                                  ;	mov	si, msg_use_entire_ep_space
  3301                                  ;	jmp	short B_12
  3302                                  	
  3303                                  B_08:
  3304 00000CDE BE[F047]                	mov	si, msg_create_nondos_partition_h
  3305                                  B_09:
  3306 00000CE1 E8DB0C                  	call	print_msg
  3307                                  B_10:
  3308                                  	; 15/02/2019
  3309                                  	;cmp	byte [newdisk], 0
  3310                                  	;ja	short B_11
  3311                                  
  3312 00000CE4 803E[DE6C]00            	cmp	byte [pcount], 0 ; (valid) partition count
  3313 00000CE9 7605                    	jna	short B_11
  3314                                  
  3315 00000CEB BE[254B]                	mov	si, msg_use_all_space
  3316 00000CEE EB03                    	jmp	short B_12
  3317                                  B_11:
  3318 00000CF0 BE[FE4A]                	mov	si, msg_use_whole_disk ; partition size: whole disk
  3319                                  B_12:
  3320 00000CF3 E8C90C                  	call	print_msg
  3321                                  B_13:
  3322 00000CF6 30E4                    	xor	ah, ah
  3323 00000CF8 CD16                    	int	16h
  3324                                  
  3325 00000CFA 3C1B                    	cmp	al, 27 ; ESCAPE key
  3326                                  	;;je	_crlf_exit
  3327 00000CFC 0F84D3F6                	je	A_42 ; 25/02/2019
  3328 00000D00 24DF                    	and	al, 0DFh
  3329 00000D02 3C4E                    	cmp	al, 'N'
  3330 00000D04 740D                    	je	short B_14  ;02/03/2019
  3331 00000D06 3C59                    	cmp	al, 'Y'
  3332 00000D08 75EC                    	jne	short B_13
  3333                                  	
  3334 00000D0A FE06[DC69]              	inc	byte [wholedisk]
  3335                                  	
  3336                                  	; 02/03/2019
  3337 00000D0E BE[A659]                	mov	si, _msg_YES
  3338                                  	;call	print_msg
  3339 00000D11 EB03                    	jmp	short B_15
  3340                                  B_14:
  3341 00000D13 BE[AC59]                	mov	si, _msg_NO
  3342                                  B_15:	; 06/03/2019
  3343 00000D16 E8A60C                  	call	print_msg
  3344                                  
  3345                                  	; 15/02/2019
  3346 00000D19 29DB                    	sub	bx, bx
  3347                                  	;cmp	byte [newdisk], bl ; 0
  3348                                  	;ja	short B_16 ; 23/02/2019
  3349                                  	; 19/10/2020
  3350                                  	;cmp	byte [pcount], 0
  3351                                  	; 03/11/2020
  3352 00000D1B 381E[DE6C]              	cmp	byte [pcount], bl ; 0
  3353 00000D1F 7608                    	jna	short B_16 ; [pcount] = 0 (newdisk, empty pt)
  3354 00000D21 381E[DC69]              	cmp	byte [wholedisk], bl ; 0
  3355 00000D25 0F87FE00                	ja	B_27 ; 23/02/2019
  3356                                  B_16:
  3357                                  	; 08/02/2019
  3358                                  	;;sub	bx, bx
  3359                                  	;mov	ax, [total_sectors]
  3360                                  	;mov	dx, [total_sectors+2]
  3361                                  	;sub	ax, [sectors]
  3362                                  	;sbb	dx, bx ; sbb dx, 0
  3363                                  	;
  3364                                  	;mov	[pp_Sectors], ax   ; = [total_sectors] - [sectors]
  3365                                  	;mov	[pp_Sectors+2], dx ; = [total_sectors+2] - carry bit
  3366                                  	; 21/03/2021
  3367 00000D29 66A1[4265]              	mov	eax, [total_sectors]
  3368 00000D2D 660FB716[B23C]          	movzx	edx, word [sectors]
  3369 00000D33 6629D0                  	sub	eax, edx
  3370 00000D36 66A3[D869]              	mov	[pp_Sectors], eax  ; = [total_sectors] - [sectors]
  3371                                  B_17:
  3372 00000D3A 381E[DC69]              	cmp	byte [wholedisk], bl ; 0
  3373 00000D3E 0F87E900                	ja	B_28 ; 09/02/2019
  3374                                  B_18:
  3375                                  	; clear screen
  3376 00000D42 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3377 00000D45 CD10                    	int	10h
  3378                                  
  3379                                  	; 04/11/2020
  3380 00000D47 803E[DD69]01            	cmp	byte [pp_type], 1 ; primary dos partition ?
  3381 00000D4C 7405                    	je	short B_61
  3382                                  	; "Create Partition"
  3383 00000D4E BE[6642]                	mov	si, msg_create_partition_h
  3384 00000D51 EB03                    	jmp	short B_62
  3385                                  B_61:
  3386                                  	; "Create DOS partition"
  3387 00000D53 BE[1145]                	mov	si, msg_create_dos_partition_h ; header
  3388                                  B_62:
  3389 00000D56 E8660C                  	call	print_msg
  3390 00000D59 BE[A249]                	mov	si, msg_create_trdos_partition_s ; size options
  3391 00000D5C E8600C                  	call	print_msg	
  3392                                  B_19:	
  3393 00000D5F 30E4                    	xor	ah, ah
  3394 00000D61 CD16                    	int	16h
  3395                                  
  3396                                  	; 24/02/2019
  3397 00000D63 3C1B                    	cmp	al, 27	; ESCAPE key
  3398 00000D65 0F846AF6                	je	A_42	; Cancel
  3399                                  
  3400 00000D69 3C20                    	cmp	al, 32	; SPACE key
  3401 00000D6B 751E                    	jne	short B_21
  3402                                  
  3403                                  		; Entire space
  3404                                  	;mov	ax, [pp_Sectors]
  3405                                  	;mov	dx, [pp_Sectors+2]
  3406                                  	; 15/03/2021
  3407 00000D6D 66A1[D869]              	mov	eax, [pp_Sectors]
  3408                                  
  3409 00000D71 C606[DC69]01            	mov 	byte [wholedisk], 1 ; 09/02/2019
  3410 00000D76 EB55                    	jmp	short B_23
  3411                                  
  3412                                  B_60:	; 31/10/2020
  3413 00000D78 75C8                    	jnz	short B_18  ; ESCape (return to options menu)
  3414                                  	; partition size input is ZERO !
  3415                                  B_20:
  3416                                  	; ZERO partition size message
  3417 00000D7A BE[B957]                	mov	si, msg_zero_partition_size
  3418 00000D7D E83F0C                  	call	print_msg
  3419                                  	
  3420 00000D80 30E4                    	xor	ah, ah
  3421 00000D82 CD16                    	int	16h
  3422 00000D84 3C1B                    	cmp	al, 27 ; ESCAPE key
  3423 00000D86 75BA                    	jne	short B_18 ; Retry
  3424                                  
  3425                                  	; 19/10/2020
  3426 00000D88 E9E4F9                  	jmp	_crlf_exit ; exit
  3427                                  
  3428                                  B_21:
  3429 00000D8B C606[EA69]25            	mov	byte [pSize_unit], '%'
  3430 00000D90 3C25                    	cmp	al, '%'
  3431 00000D92 7422                    	je	short B_22
  3432 00000D94 C606[EA69]53            	mov	byte [pSize_unit], 'S'
  3433 00000D99 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
  3434 00000D9B 7419                    	je	short B_22
  3435 00000D9D 24DF                    	and	al, 0DFh
  3436 00000D9F 3C53                    	cmp	al, 'S'
  3437 00000DA1 7413                    	je	short B_22
  3438 00000DA3 A2[EA69]                	mov	[pSize_unit], al
  3439 00000DA6 3C4B                    	cmp	al, 'K'
  3440 00000DA8 740C                    	je	short B_22
  3441 00000DAA 3C4D                    	cmp	al, 'M'
  3442 00000DAC 7408                    	je	short B_22
  3443 00000DAE 3C47                    	cmp	al, 'G'
  3444 00000DB0 7404                    	je	short B_22
  3445 00000DB2 3C43                    	cmp	al, 'C'
  3446 00000DB4 75A9                    	jne	short B_19
  3447                                  B_22:
  3448 00000DB6 C606[1F61]73            	mov	byte [msg_sectors_crlf_s], 's' ; " sectors"
  3449                                  
  3450 00000DBB E86F0E                  	call	partition_size_input
  3451                                  	;jc	_crlf_exit ; exit if partition size input is 0
  3452                                  	;jc	short B_20
  3453                                  	; 29/10/2020
  3454                                  	;jnc	short B_60
  3455                                  	;jz	short B_20 ; partition size input is ZERO !
  3456                                  	;jmp	short B_18 ; ESCape (return to options menu)
  3457                                  	; 31/10/2020
  3458 00000DBE 72B8                    	jc	short B_60 ; ESC or zero partition size
  3459                                  ;B_60:
  3460                                  	; 13/03/2021
  3461                                  	;and	bx, bx ; bx_dx_ax = partition size
  3462                                  	;;jnz	short B_29
  3463                                  	;; 23/02/2019 
  3464                                  	;jnz	short B_24 ; invalid! (use maximum available sectors)
  3465                                  	;; 08/02/2019
  3466                                  	;or	dx, dx
  3467                                  	;jnz	short B_23 ; proper size (for now)
  3468                                  	
  3469                                  	; 13/03/2021
  3470                                  	;or	edx, edx
  3471                                  	;jnz	short B_24 ; invalid! (use maximum available sectors)
  3472                                  
  3473                                  	;mov	bx, [min_sectors] ; minimum sectors
  3474                                  	;cmp	bx, ax
  3475                                  	;jna	short B_23 ; proper size (for now)
  3476                                  	; 13/03/2021
  3477 00000DC0 668B16[006A]            	mov	edx, [min_sectors]
  3478 00000DC5 6639D0                  	cmp	eax, edx
  3479 00000DC8 7303                    	jnb	short B_23 ; proper size (for now)
  3480                                  	
  3481                                  	; invalid! (use minimum sectors or sectors per cylinder)
  3482                                  	;mov	ax, bx
  3483                                  	; 13/03/2021
  3484 00000DCA 6689D0                  	mov	eax, edx
  3485                                  B_23:
  3486                                  	; 09/02/2019
  3487                                  	; save dx,ax
  3488                                  	;mov	[ppn_Sectors+2], dx 
  3489                                  	;mov	[ppn_Sectors], ax
  3490                                  	; 13/03/2021
  3491 00000DCD 66A3[0C6A]              	mov	[ppn_Sectors], eax
  3492                                  
  3493                                  	; write partition size
  3494                                  	;push	dx
  3495                                  	;push	ax
  3496                                  	; 06/11/2020
  3497 00000DD1 BE[F769]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  3498 00000DD4 E8A10C                  	call	bin_to_decimal
  3499                                  	; ds:si = beginning of decimal number text
  3500 00000DD7 E8E50B                  	call	print_msg
  3501 00000DDA BE[1861]                	mov	si, msg_sectors_crlf
  3502 00000DDD E8DF0B                  	call	print_msg
  3503                                  	;pop	ax
  3504                                  	;pop	dx
  3505                                  
  3506 00000DE0 803E[DC69]00            	cmp	byte [wholedisk], 0
  3507 00000DE5 7748                    	ja	short B_29 ; 09/02/2019
  3508                                  
  3509                                  	; 15/03/2021
  3510                                  	;sub	eax, eax ; no need to clear hw of eax here
  3511                                  
  3512                                  	; restore ax,dx
  3513                                  	;mov	ax, [ppn_Sectors]
  3514                                  	;mov	dx, [ppn_Sectors+2]
  3515                                  
  3516                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3517                                  ; select whole disk
  3518                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3519                                  
  3520                                  	; 15/03/2021
  3521 00000DE7 66A1[0C6A]              	mov	eax, [ppn_Sectors]
  3522                                  
  3523                                  	; select whole disk 
  3524                                  	;   if partition size > disk size
  3525                                  	;cmp	dx, [pp_Sectors+2]
  3526                                  	;ja	short B_24
  3527                                  	;jb	short B_29
  3528                                  	;cmp	ax, [pp_Sectors]
  3529                                  	;jna	short B_29
  3530                                  	; 15/03/2021
  3531 00000DEB 663B06[D869]            	cmp	eax, [pp_Sectors]
  3532 00000DF0 763D                    	jna	short B_29
  3533                                  B_24:
  3534                                  	;cmp	byte [newdisk], 0
  3535                                  	;jna	short B_30
  3536                                  	; 19/10/2020
  3537 00000DF2 803E[DE6C]00            	cmp	byte [pcount], 0
  3538 00000DF7 775B                    	ja	short B_30
  3539                                  
  3540                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3541                                  ; "use whole disk or go to back" question
  3542                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3543                                  
  3544 00000DF9 BE[234C]                	mov	si, msg_partition_size_overs
  3545                                  B_25:
  3546 00000DFC E8C00B                  	call	print_msg
  3547                                  B_26:
  3548 00000DFF 30E4                    	xor	ah, ah
  3549 00000E01 CD16                    	int	16h
  3550                                  	
  3551 00000E03 3C1B                    	cmp	al, 27 ; ESCAPE key
  3552                                  	;je	B_01
  3553 00000E05 0F8439FF                	je	B_18 ; 09/02/2019
  3554 00000E09 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
  3555 00000E0B 75F2                    	jne	short B_26
  3556                                  
  3557 00000E0D FE06[DC69]              	inc	byte [wholedisk]
  3558                                  
  3559                                  	; 24/02/2019
  3560                                  	;cmp	byte [newdisk], 0
  3561                                  	;ja	short B_27
  3562 00000E11 803E[DE6C]00            	cmp	byte [pcount], 0  ; (valid) partition count
  3563 00000E16 760F                    	jna	short B_27 ; no
  3564                                  
  3565 00000E18 8B1E[A86D]              	mov	bx, [c_fspc_offset]
  3566                                  	;mov	ax, [free_space.sectors_unused+bx]
  3567                                  	;mov	dx, [free_space.sectors_unused+bx+2]
  3568                                  	;mov	[pp_Sectors], ax
  3569                                  	;mov	[pp_Sectors+2], dx
  3570                                  	; 15/03/2021
  3571 00000E1C 668B87[466D]            	mov	eax, [free_space.sectors_unused+bx]
  3572 00000E21 66A3[D869]              	mov	[pp_Sectors], eax
  3573                                  
  3574 00000E25 EB04                    	jmp	short B_28 
  3575                                  B_27:
  3576                                  	; 09/02/2019
  3577                                  	;mov	dx, [pp_Sectors+2]
  3578                                  	;mov	ax, [pp_Sectors]
  3579                                  	; 15/03/2021
  3580 00000E27 66A1[D869]              	mov	eax, [pp_Sectors]
  3581                                  B_28:
  3582                                  	;mov	[ppn_Sectors+2], dx
  3583                                  	;mov	[ppn_Sectors], ax
  3584                                  	; 15/03/2021
  3585 00000E2B 66A3[0C6A]              	mov	[ppn_Sectors], eax
  3586                                  B_29:
  3587 00000E2F 803E[DD69]05            	cmp	byte [pp_type], 5
  3588 00000E34 0F852C01                	jne	B_51
  3589                                  
  3590 00000E38 803E[DF6C]00            	cmp	byte [ppcount], 0  ; primary partition count
  3591 00000E3D 0F87C700                	ja	B_45
  3592                                  
  3593 00000E41 BE[8D4C]                	mov	si, msg_ext_partition_error
  3594 00000E44 E8780B                  	call	print_msg
  3595 00000E47 BE[064C]                	mov	si, msg_any_key_to_retry
  3596 00000E4A E8720B                  	call	print_msg
  3597                                  
  3598                                  	; 09/02/2019
  3599 00000E4D 30E4                    	xor	ah, ah
  3600 00000E4F CD16                    	int	16h
  3601                                  
  3602                                  	;jmp	B_01
  3603 00000E51 E951F9                  	jmp	cpi_2
  3604                                  
  3605                                  B_30:
  3606                                  	; clear screen
  3607 00000E54 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  3608 00000E57 CD10                    	int	10h
  3609                                  
  3610 00000E59 BE[1145]                	mov	si, msg_create_dos_partition_h ; header
  3611 00000E5C E8600B                  	call	print_msg
  3612                                  
  3613 00000E5F BE[C55A]                	mov	si, msg_partition_size_limit
  3614 00000E62 E85A0B                  	call	print_msg
  3615                                  
  3616 00000E65 8B1E[A86D]              	mov	bx, [c_fspc_offset]
  3617                                  
  3618 00000E69 803E[EA69]53            	cmp	byte [pSize_unit], 'S'
  3619 00000E6E 7415                    	je	short B_31
  3620 00000E70 803E[EA69]4B            	cmp	byte [pSize_unit], 'K'
  3621 00000E75 740E                    	je	short B_31
  3622                                  
  3623 00000E77 803E[EA69]25            	cmp	byte [pSize_unit], '%'
  3624 00000E7C 746D                    	je	short B_41
  3625                                  
  3626 00000E7E 803E[EA69]43            	cmp	byte [pSize_unit], 'C'
  3627 00000E83 747D                    	je	B_44
  3628                                  B_31:
  3629                                  	; 'S', 'K'
  3630 00000E85 81C3[466D]              	add	bx, free_space.sectors_unused
  3631                                  	;mov	ax, [bx]
  3632                                  	;mov	dx, [bx+2]
  3633                                  B_42:
  3634                                  	; 15/03/2021	
  3635 00000E89 668B07                  	mov	eax, [bx]
  3636 00000E8C 6631D2                  	xor	edx, edx
  3637 00000E8F 6631C9                  	xor	ecx, ecx
  3638 00000E92 B10A                    	mov	cl, 10 
  3639                                  	
  3640                                  	;mov	cx, 10
  3641 00000E94 89E5                    	mov	bp, sp
  3642                                  ;B_32:
  3643                                  	;call	div32
  3644                                  	;push	bx
  3645                                  	;or	dx, dx
  3646                                  	;jnz	short B_32
  3647                                  	;cmp	ax, 9
  3648                                  	;ja	short B_32
  3649                                  B_32:
  3650                                  	; 15/03/2021
  3651 00000E96 66F7F1                  	div	ecx
  3652 00000E99 52                      	push	dx
  3653 00000E9A 6683F809                	cmp	eax, 9
  3654 00000E9E 7604                    	jna	short B_33
  3655 00000EA0 28D2                    	sub	dl, dl
  3656                                  	; edx = 0
  3657 00000EA2 EBF2                    	jmp	short B_32
  3658                                  B_33:
  3659 00000EA4 BB0700                  	mov	bx, 07h
  3660                                  	;or	ax, ax
  3661                                  	;jnz	short B_35
  3662                                  	; 15/03/2021
  3663 00000EA7 08C0                    	or	al, al
  3664 00000EA9 7501                    	jnz	short B_35
  3665                                  B_34:
  3666 00000EAB 58                      	pop	ax
  3667                                  B_35:
  3668 00000EAC 0430                    	add	al, '0'
  3669                                  B_36:
  3670 00000EAE B40E                    	mov	ah, 0Eh
  3671                                  	;mov	bx, 07h
  3672 00000EB0 CD10                    	int	10h	; write character (as tty)
  3673                                  
  3674 00000EB2 39EC                    	cmp	sp, bp
  3675 00000EB4 72F5                    	jb	short B_34
  3676                                  
  3677 00000EB6 803E[EA69]53            	cmp	byte [pSize_unit], 'S'
  3678 00000EBB 7422                    	je	short B_38
  3679 00000EBD 803E[EA69]4B            	cmp	byte [pSize_unit], 'K'
  3680 00000EC2 741B                    	je	short B_38
  3681                                  
  3682 00000EC4 803E[EA69]25            	cmp	byte [pSize_unit], '%'
  3683 00000EC9 7508                    	jne	short B_37
  3684                                  
  3685                                  	; 24/02/2019
  3686 00000ECB 3C25                    	cmp	al, '%'
  3687 00000ECD 7416                    	je	short B_40
  3688 00000ECF B025                    	mov	al, '%'
  3689 00000ED1 EBDB                    	jmp	short B_36 
  3690                                  B_37:
  3691 00000ED3 803E[EA69]43            	cmp	byte [pSize_unit], 'C'
  3692 00000ED8 7505                    	jne	short B_38
  3693                                  
  3694 00000EDA BE[615B]                	mov	si, msg_cylinders
  3695 00000EDD EB03                    	jmp	short B_39
  3696                                  B_38:
  3697 00000EDF BE[6C5B]                	mov	si, msg_sectors
  3698                                  B_39:
  3699 00000EE2 E8DA0A                  	call	print_msg
  3700                                  B_40:
  3701 00000EE5 BE[125B]                	mov	si, msg_partition_size_limit_r
  3702                                  	;call	print_msg
  3703                                  
  3704 00000EE8 E911FF                  	jmp	B_25
  3705                                  
  3706                                  B_41:
  3707                                  	; '%'
  3708 00000EEB 81C3[4E6D]              	add	bx, free_space.percent_unused
  3709 00000EEF 8B07                    	mov	ax, [bx]
  3710                                  ;B_42:	
  3711 00000EF1 89E5                    	mov	bp, sp
  3712 00000EF3 B90A00                  	mov	cx, 10
  3713                                  B_43:	
  3714 00000EF6 31D2                    	xor	dx, dx
  3715 00000EF8 F7F1                    	div	cx
  3716 00000EFA 52                      	push	dx
  3717 00000EFB 83F809                  	cmp	ax, 9
  3718 00000EFE 77F6                    	ja	short B_43
  3719 00000F00 EBA2                    	jmp	short B_33
  3720                                  B_44:
  3721                                  	; 'C'
  3722 00000F02 81C3[3A6D]              	add	bx, free_space.space
  3723                                  	;mov	ax, [bx]
  3724                                  	;jmp	short B_42
  3725                                  	; 15/03/2021
  3726 00000F06 EB81                    	jmp	short B_42
  3727                                  
  3728                                  B_45:
  3729                                  	; 23/02/2019
  3730 00000F08 8B1E[A86D]              	mov	bx, [c_fspc_offset]
  3731                                  	;mov	ax, [bx+free_space.start]
  3732                                  	; 15/03/2021
  3733 00000F0C 668B87[3E6D]            	mov	eax, [bx+free_space.start]
  3734                                  
  3735                                  	; set free space start cylinder to 1 if it is 0
  3736                                  	;or	ax, ax
  3737                                  	;jnz	short B_46
  3738                                  	; 15/03/2021
  3739 00000F11 6609C0                  	or	eax, eax
  3740 00000F14 7510                    	jnz	short B_46
  3741                                  
  3742 00000F16 B005                    	mov	al, 5	; Get free space for extended partition
  3743 00000F18 E8ED13                  	call	find_part_free_space
  3744                                  
  3745 00000F1B 891E[A86D]              	mov	[c_fspc_offset], bx
  3746                                  
  3747                                  	; 19/10/2020
  3748                                  	;and	cx, cx
  3749                                  	; 15/03/2021
  3750 00000F1F 6621C9                  	and	ecx, ecx
  3751 00000F22 0F8468F5                	jz	cp_3	; there is not free space on disk
  3752                                  B_46:
  3753                                  	; 15/03/2021
  3754                                  	;sub	eax, eax ; no need to clear hw of eax here
  3755                                  
  3756                                  	; 24/02/2019
  3757 00000F26 E81100                  	call	partition_size_fixup_x
  3758 00000F29 0F8227FF                	jc	B_30
  3759                                  
  3760                                  	; 16/02/2019
  3761 00000F2D E859FB                  	call	create_extended_partition 
  3762                                  			; must be called after 'find_part_free_space'.
  3763                                  	; 24/02/2019
  3764 00000F30 E8D00F                  	call	show_selected_partition
  3765 00000F33 E9AE00                  	jmp	C_02
  3766                                  
  3767                                  partition_size_fixup:
  3768                                  	; 24/02/2019
  3769 00000F36 8B1E[A86D]              	mov	bx, [c_fspc_offset]
  3770                                  partition_size_fixup_x:
  3771                                  	; 19/10/2020
  3772                                  
  3773                                  	;cmp	byte [newdisk], 0
  3774                                  	;ja	short B_50
  3775                                  
  3776 00000F3A 803E[DE6C]00            	cmp	byte [pcount], 0 ; (valid) partition count
  3777 00000F3F 7622                    	jna	short B_50
  3778                                  
  3779 00000F41 81C3[466D]              	add	bx, free_space.sectors_unused
  3780                                  	;mov	ax, [bx]
  3781                                  	;mov	dx, [bx+2]
  3782                                  	; 15/03/2021
  3783 00000F45 668B07                  	mov	eax, [bx]
  3784                                  
  3785                                  	;cmp	dx, [ppn_Sectors+2]
  3786                                  	;jb	short B_50 ; 24/02/2019
  3787                                  	;ja	short B_47
  3788                                  	;cmp	ax, [ppn_Sectors]
  3789                                  	;jb	short B_50 ; 24/02/2019
  3790                                  	;je	short B_49
  3791                                  	; 15/03/2021
  3792 00000F48 663B06[0C6A]            	cmp	eax, [ppn_Sectors]
  3793 00000F4D 7214                    	jb	short B_50
  3794 00000F4F 740E                    	je	short B_49
  3795                                  B_47:
  3796                                  	; 19/02/2019
  3797                                  	;mov	ax, [ppn_Sectors]
  3798                                  B_48:
  3799                                  	;mov	dx, [ppn_Sectors+2]
  3800                                  	; 15/03/2021
  3801 00000F51 66A1[0C6A]              	mov	eax, [ppn_Sectors] 
  3802                                  
  3803                                  	; 18/02/2019
  3804                                  
  3805                                  	; check for best fit
  3806                                  	; (leave max. available space to next time if 
  3807                                  	;  another space/gap fits to partition size request)
  3808                                  
  3809 00000F55 E8BF15                  	call	find_enough_free_sectors
  3810                                  		; CX = Free space index (0 to 4)
  3811                                  		; DX:AX = First available space which fits to request
  3812                                  	; 15/03/2021
  3813                                  	; eax = First available space which fits to request
  3814                                  	
  3815                                  	;mov	bx, cx
  3816                                  	;shl	bl, 4 ; * 16  ; * Free space structure size
  3817                                  	;mov	[c_fspc_offset], bx
  3818                                  	
  3819                                  	; 22/02/2019
  3820 00000F58 C0E104                  	shl	cl, 4
  3821 00000F5B 890E[A86D]              	mov	[c_fspc_offset], cx
  3822                                  
  3823                                  	;add	bx, free_space.sectors_unused
  3824                                  	;mov	ax, [bx]
  3825                                  	;mov	dx, [bx+2]
  3826                                  B_49:		
  3827                                  	; Save max. available space
  3828                                  	;mov	[pp_Sectors], ax
  3829                                  	;mov	[pp_Sectors+2], dx
  3830                                  	; 15/03/2021
  3831 00000F5F 66A3[D869]              	mov	[pp_Sectors], eax
  3832                                  B_50:
  3833 00000F63 C3                      	retn
  3834                                  B_51:
  3835                                  	; 24/02/2019
  3836 00000F64 E8CFFF                  	call	partition_size_fixup
  3837 00000F67 0F82E9FE                	jc	B_30
  3838                                  
  3839                                  	; 16/02/2019
  3840                                  	; Force cylinder boundary alignment except
  3841                                  	;   sectors ('S') and kilobytes ('K') as sizing unit.
  3842                                  
  3843 00000F6B C606[AA6D]59            	mov	byte [cylinder_boundary], 'Y' ; Default
  3844                                  				; sizing unit is one of
  3845                                  				; 'cylinders','megabytes','gigabytes'
  3846                                  				; and boundary alignment is yes for them.
  3847 00000F70 A0[EA69]                	mov	al, [pSize_unit]
  3848                                  
  3849                                  	;cmp	byte [pSize_unit], 'S' ; Sectors
  3850 00000F73 3C53                    	cmp	al, 'S'
  3851 00000F75 7404                    	je	short B_52
  3852                                  
  3853                                  	;cmp	byte [pSize_unit], 'K' ; Kilobytes
  3854 00000F77 3C4B                    	cmp	al, 'K'
  3855 00000F79 752F                    	jne	short B_56
  3856                                  B_52:
  3857                                  	; Sizing unit is one of 'sectors' and/or 'kilobytes'
  3858                                  	; and bound aligment will be applied if the answer will be yes.
  3859                                  
  3860 00000F7B BE[154D]                	mov	si, msg_cylinder_boundary_set
  3861 00000F7E E83E0A                  	call	print_msg
  3862                                  B_53:
  3863 00000F81 30E4                    	xor	ah, ah
  3864 00000F83 CD16                    	int	16h
  3865                                  	; Cylinder boundary adjusting
  3866 00000F85 3C0D                    	cmp	al, 13 ; ENTER key
  3867 00000F87 74F2                    	je	short B_52
  3868 00000F89 3C1B                    	cmp	al, 27 ; ESCAPE key
  3869 00000F8B 741A                    	je	short B_55	; Align end of the partition only
  3870                                  				; if start of the partition is aligned
  3871                                  				; or it starts at cyl 0, head 1, sect 17 or 63.
  3872                                  				; (End of the partition will be extended to
  3873                                  				; end sector of it's last cylinder if the size
  3874                                  				; will not over [pp_Sectors] value.)
  3875 00000F8D 24DF                    	and	al, 0DFh
  3876                                  
  3877                                  	; 22/02/2019
  3878 00000F8F 3C59                    	cmp	al, 'Y'
  3879 00000F91 7508                    	jne	short B_54
  3880                                  
  3881 00000F93 BE[A659]                	mov	si, _msg_YES
  3882 00000F96 E8260A                  	call	print_msg
  3883                                  
  3884                                  	;mov	al, 'Y'
  3885                                  	;jmp	short B_55
  3886 00000F99 EB0F                    	jmp	short B_56
  3887                                  B_54:
  3888 00000F9B 3C4E                    	cmp	al, 'N'
  3889 00000F9D 75E2                    	jne	short B_53
  3890                                  
  3891 00000F9F BE[AC59]                	mov	si, _msg_NO
  3892 00000FA2 E81A0A                  	call	print_msg
  3893                                  
  3894 00000FA5 B04E                    	mov	al, 'N'
  3895                                  		; do not align partition to cylinder boundary
  3896                                  B_55:
  3897 00000FA7 A2[AA6D]                	mov	[cylinder_boundary], al
  3898                                  B_56:
  3899 00000FAA E84CF8                  	call	create_primary_partition
  3900                                  	
  3901                                  	; 18/02/2019
  3902                                  	;cmp	byte [newdisk], 0
  3903                                  	;jna	short B_57
  3904                                  
  3905                                  	; 19/10/2020
  3906 00000FAD 803E[DE6C]00            	cmp	byte [pcount], 0
  3907 00000FB2 770D                    	ja	short B_57
  3908                                  
  3909                                  	;xor	ax, ax ; 0
  3910                                  	;xor	dx, dx ; 0
  3911                                  	; 09/03/2021
  3912 00000FB4 6631C0                  	xor	eax, eax
  3913                                  
  3914                                  	; DX_AX = Masterboot Sector = 0
  3915                                  
  3916 00000FB7 BB[E852]                	mov	bx, MasterBootBuff
  3917                                  
  3918                                  	; ES:BX = Sector Buffer
  3919                                  	; 09/03/2021
  3920                                  	; EAX = Masterboot Sector = 0
  3921                                  
  3922 00000FBA E8600A                  	call	write_hd_sector
  3923 00000FBD 0F8298F7                	jc	print_error_code ; 18/10/2020
  3924                                  B_57:
  3925                                  	; DS:SI = Partition Table Entry address
  3926                                  	; 25/02/2019
  3927 00000FC1 8936[D46D]              	mov	[pte_address], si  ; save PTE address
  3928 00000FC5 E83B0F                  	call	show_selected_partition
  3929                                  
  3930                                  	;jmp	C_01
  3931                                  
  3932                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3933                                  ; format question
  3934                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3935                                  
  3936                                  C_01:
  3937                                  	;mov	si, CRLF
  3938                                  	;call	print_msg
  3939                                  
  3940 00000FC8 C606[F969]01            	mov	byte [format_q], 1
  3941                                  
  3942 00000FCD A0[DD69]                	mov	al, [pp_type]
  3943 00000FD0 3C01                    	cmp	al, 1		; FAT12 (CHS)
  3944 00000FD2 741D                    	je	short C_03
  3945 00000FD4 3C04                    	cmp	al, 4		; FAT16 CHS
  3946 00000FD6 7419                    	je	short C_03
  3947 00000FD8 3C06                    	cmp	al, 6		; FAT16 BIG CHS
  3948 00000FDA 7415                    	je	short C_03
  3949 00000FDC 3C0B                    	cmp	al, 0Bh		; FAT32 CHS
  3950 00000FDE 7411                    	je	short C_03
  3951 00000FE0 3CA1                    	cmp	al, 0A1h	; SINGLIX FS1
  3952 00000FE2 740D                    	je	short C_03
  3953                                  
  3954                                  	;cmp	al, 71h
  3955                                  	;je	short C_03	; RETRO UNIX 386
  3956                                  
  3957                                  	;dec	byte [format_q] ; 0
  3958                                  C_02:
  3959 00000FE4 C606[F969]00            	mov	byte [format_q], 0 ; 24/02/2019
  3960                                  
  3961                                  	; NON-DOS partition!
  3962                                  	; Ask for editing PT or exit (continue without formatting)
  3963 00000FE9 BE[9B50]                	mov	si, msg_edit_or_exit
  3964 00000FEC E8D009                  	call	print_msg
  3965 00000FEF EB06                    	jmp	short C_04
  3966                                  C_03:
  3967                                  	; Ask for formatting, editing PT or exit
  3968 00000FF1 BE[2C50]                	mov	si, msg_format_stage
  3969 00000FF4 E8C809                  	call	print_msg
  3970                                  C_04:
  3971 00000FF7 BE[6C50]                	mov	si, msg_partition_edit
  3972 00000FFA E8C209                  	call	print_msg
  3973                                  C_05:
  3974 00000FFD 28E4                    	sub	ah, ah
  3975 00000FFF CD16                    	int	16h
  3976                                  
  3977 00001001 3C0D                    	cmp	al, 13
  3978 00001003 7434                    	je	short C_08
  3979                                  
  3980                                  	;; 07/03/2019
  3981 00001005 3C20                    	cmp	al, 20h ; SPACE
  3982                                  	;je	A_21 ; edit partition table option is selected
  3983 00001007 7503                    	jne	short C_06
  3984                                  	; 19/10/2020	
  3985 00001009 E9F1F1                  	jmp	A_21
  3986                                  C_06:
  3987 0000100C 3C1B                    	cmp	al, 27 ; ESCAPE
  3988 0000100E 75ED                    	jne	short C_05
  3989                                  	
  3990                                  	; 19/010/2020
  3991 00001010 E962F7                  	jmp	_exit
  3992                                  
  3993                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3994                                  ; save MBR then exit
  3995                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  3996                                  
  3997                                  save_mbr_exit:
  3998                                  	; 24/02/2019
  3999 00001013 E8CF10                  	call	init_partition_table
  4000                                  	; 12/03/2021
  4001                                  	;xor	eax, eax
  4002 00001016 E89F15                  	call	display_partition_table
  4003                                  
  4004 00001019 BE[6C52]                	mov	si, CRLF
  4005 0000101C E8A009                  	call	print_msg
  4006                                  
  4007 0000101F BE[2051]                	mov	si, msg_writing_mbr
  4008 00001022 E89A09                  	call	print_msg
  4009                                  
  4010                                  	;xor	ax, ax ; 0
  4011                                  	;xor	dx, dx ; 0
  4012                                  	; 09/03/2021
  4013 00001025 6631C0                  	xor	eax, eax
  4014                                  
  4015                                  	; DX_AX = Masterboot Sector = 0
  4016                                  
  4017 00001028 BB[E852]                	mov	bx, MasterBootBuff
  4018                                  
  4019                                  	; ES:BX = Sector Buffer
  4020                                  	; 09/03/2021
  4021                                  	; EAX = Masterboot Sector = 0
  4022                                  
  4023 0000102B E8EF09                  	call	write_hd_sector
  4024 0000102E 7303                    	jnc	short C_07
  4025 00001030 E926F7                  	jmp	print_error_code ; 18/10/2020
  4026                                  
  4027                                  C_07:
  4028 00001033 BE[6852]                	mov	si, Msg_OK
  4029                                  	;call	print_msg
  4030                                  	; 19/10/2020
  4031                                  	;jmp	_exit
  4032 00001036 E939F7                  	jmp	_p_exit
  4033                                  
  4034                                  C_08:
  4035 00001039 803E[F969]01            	cmp	byte [format_q], 1
  4036 0000103E 72D3                    	jb	short save_mbr_exit
  4037                                  
  4038                                  	; 25/02/2019
  4039                                  	; Write MBR without writing message
  4040                                  	
  4041                                  	; NOTE: This may be second time of MBR writing...
  4042                                  	;	but, if partition table is modified,
  4043                                  	;	we need to write MBR to disk, here.
  4044                                  	;
  4045                                  	; (Otherwise.. the last created partition would not be recorded.)
  4046                                  
  4047                                  	;xor	ax, ax ; 0
  4048                                  	;xor	dx, dx ; 0
  4049                                  	; 09/03/2021
  4050 00001040 6631C0                  	xor	eax, eax
  4051                                  
  4052                                  	; DX_AX = Masterboot Sector = 0
  4053                                  
  4054 00001043 BB[E852]                	mov	bx, MasterBootBuff
  4055                                  
  4056                                  	; ES:BX = Sector Buffer
  4057                                  	; 09/03/2021
  4058                                  	; EAX = Masterboot Sector = 0
  4059                                  
  4060 00001046 E8D409                  	call	write_hd_sector
  4061 00001049 0F820CF7                	jc	print_error_code ; 18/10/2020
  4062                                  
  4063                                  	;; clear screen
  4064                                  	;mov	ax, 3 ; set video mode to 03h (80x25 text)
  4065                                  	;int	10h
  4066                                  
  4067                                  	; 25/02/2019
  4068 0000104D 8B36[D46D]              	mov	si, [pte_address]
  4069                                  
  4070                                  	; 18/02/2019
  4071 00001051 E8AF0E                  	call	show_selected_partition	
  4072                                  
  4073 00001054 A0[5350]                	mov	al, [partition_num_chr]
  4074 00001057 A2[1351]                	mov	[partition_num_txt], al
  4075                                  
  4076 0000105A BE[F150]                	mov	si, msg_format_question
  4077 0000105D E85F09                  	call	print_msg
  4078                                  C_09:
  4079 00001060 30E4                    	xor	ah, ah
  4080 00001062 CD16                    	int	16h
  4081                                  
  4082 00001064 3C1B                    	cmp	al, 1Bh ; ESCAPE
  4083 00001066 74A4                    	je	short C_06
  4084                                  
  4085 00001068 24DF                    	and	al, 0DFh ; capitalization
  4086 0000106A 3C59                    	cmp	al, 'Y'
  4087 0000106C 740C                    	je	short C_10
  4088 0000106E 3C4E                    	cmp	al, 'N'
  4089 00001070 75EE                    	jne	short C_09
  4090 00001072 BE[AC59]                	mov	si, _msg_NO 
  4091 00001075 E84709                  	call	print_msg
  4092                                  	;jmp	short C_06
  4093                                  	; 24/02/2019
  4094 00001078 EB99                    	jmp	short save_mbr_exit 
  4095                                  C_10:
  4096 0000107A BE[A659]                	mov	si, _msg_YES
  4097 0000107D E83F09                  	call	print_msg
  4098                                  
  4099                                  	; [pp_StartSector] = partition's start sector
  4100                                  	; [pp_Sectors] = partition size including start & end sector
  4101                                  	; [partition_num_chr] = partition number + '0'
  4102                                  	; [pp_type] = partition type (for TRDOS 386 boot sector)
  4103                                  
  4104 00001080 8926[4C65]              	mov	[old_sp], sp
  4105                                  
  4106                                  	; 16/03/2021
  4107 00001084 6631D2                  	xor	edx, edx ; (this may not be necessary)
  4108 00001087 6631DB                  	xor	ebx, ebx ; (this may not be necessary)
  4109 0000108A 6631C9                  	xor	ecx, ecx ; (this may not be necessary)
  4110                                  
  4111 0000108D 8A16[DD69]              	mov	dl, [pp_type]
  4112                                  	; DL = partition type (file system ID)
  4113                                  	;dec	dl
  4114                                  	;jz	FAT12_hd_format
  4115 00001091 80FA01                  	cmp	dl, 1 ; 14/09/2020 (BugFix)
  4116 00001094 0F862C05                	jna	FAT12_hd_format
  4117                                  	;cmp	dl, 4
  4118                                  	;je	FAT16_hd_format
  4119                                  	;cmp	dl, 6
  4120                                  	;je	FAT16_hd_format
  4121 00001098 80FA0B                  	cmp	dl, 0Bh 
  4122 0000109B 0F826303                	jb	FAT16_hd_format
  4123                                  	;je	short FAT32_hd_format
  4124                                  	;cmp	dl, 0Ch ; 14/09/2020
  4125 0000109F 0F879706                	ja	SINGLIX_hd_format
  4126                                  
  4127                                  	;cmp	dl, 0A1h
  4128                                  	;je	SINGLIX_hd_format
  4129                                  	;jb	RUNIX386_hd_format ; dl = 071h
  4130                                  
  4131                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4132                                  ; FAT32 FORMATTING
  4133                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4134                                  	
  4135                                  	; 16/03/2021 (fdisk4.s)
  4136                                  	; 08/02/2019 (Modified for -only- FAT32 CHS partitions)
  4137                                  FAT32_hd_format:
  4138                                  	;mov	ax, 000Ch ; db 0Ch, 00h ; 'or al, 0'
  4139                                  	;cmp	dl, al ; 0Ch
  4140                                  	;je	short FAT32_lbAx_format
  4141                                  	;mov	ax, 0C00Bh ; db 0Bh, 0C0h ; 'or ax, ax'
  4142                                  ;FAT32_lba_format:
  4143                                  	; Put TRDOS 386 FAT32 partition magic word 
  4144                                  	; at offset 5Ah, in TRDOS386 FAT32 boot sector 0.
  4145 000010A3 BD[9F30]                	mov	bp, TRDOS_FAT32_hd_bs
  4146 000010A6 8D7E03                  	lea	di, [bp+3]
  4147 000010A9 BE[2461]                	mov	si, bs_oem_name
  4148 000010AC B90400                  	mov	cx, 4
  4149 000010AF F3A5                    	rep	movsw 
  4150                                  	;mov	[bp+5Ah], ax	; [loc_5A]
  4151 000010B1 C7465A0BC0              	mov	word [bp+5Ah], 0C00Bh ; 08/02/2019
  4152 000010B6 A1[B23C]                	mov	ax, [sectors]
  4153 000010B9 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4154 000010BC A1[B43C]                	mov	ax, [heads]
  4155 000010BF 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4156                                  	; 16/03/2021
  4157                                  	;mov	ax, [pp_StartSector]
  4158                                  	;mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4159                                  	;mov	ax, [pp_StartSector+2]
  4160                                  	;mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4161 000010C2 66A1[D469]              	mov	eax, [pp_StartSector]
  4162 000010C6 6689461C                	mov	[bp+1Ch], eax	; [BPB_HiddSec]
  4163                                  	;;mov	ax, [pp_Sectors]
  4164                                  	;mov	ax, [ppn_Sectors] ; 16/02/2019
  4165                                  	;mov	[bp+20h], ax	; [BPB_TotSec32]
  4166                                  	;;mov	dx, [pp_Sectors+2]
  4167                                  	;mov	dx, [ppn_Sectors+2] ; 16/02/2019
  4168                                  	;mov	[bp+22h], dx	; [BPB_TotSec32+2]
  4169 000010CA 66A1[0C6A]              	mov	eax, [ppn_Sectors]
  4170 000010CE 66894620                	mov	[bp+20h], eax	; [BPB_TotSec32]
  4171                                  	
  4172                                  	; Sectors per cluster calculation
  4173                                  	; (According to MS FAT32 FS specification.)
  4174 000010D2 B108                    	mov	cl, 8  ; 8 sectors per cluster
  4175                                  	;cmp	dx, 8  ; >= 532480 sectors
  4176                                  	;ja	short FAT32_f_2 ; 8 sectors per cluster
  4177                                  	;jb	short FAT32_f_1 ; 1 sector per cluster
  4178                                  	;cmp	ax, 2000h ; dx_ax = (8*65536)+8192
  4179                                  	;jnb	short FAT32_f_2 ; 12/09/2020 (BugFix)
  4180                                  	; 16/03/2021
  4181 000010D4 663D00200800            	cmp	eax, 532480
  4182 000010DA 7302                    	jnb	short FAT32_f_2
  4183                                  FAT32_f_1:
  4184 000010DC B101                    	mov	cl, 1	; 1 sector per cluster
  4185                                  FAT32_f_2:
  4186 000010DE 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  4187                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  4188                                  	;mov	word [bp+0Eh], 32 ; [BPB_RsvdSecCnt]
  4189                                  
  4190                                  	; Calculating FAT size in sectors
  4191                                  	; (According to MS FAT32 FS Specification, 2000)
  4192                                  
  4193                                  	; DX_AX = partition (volume) size in sectors
  4194                                  	;sub	ax, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  4195                                  	;sbb	dx, 0
  4196                                  	;	; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  4197                                  	;	;	     		RootDirsectors)
  4198                                  	;	; RootDirSectors = 0 (for FAT32 FS)
  4199                                  	; 16/03/2021
  4200                                  	;xor	edx, edx
  4201 000010E1 8B560E                  	mov	dx, [bp+0Eh] ; [BPB_RsvdSecCnt] ; 2 bytes
  4202 000010E4 6629D0                  	sub	eax, edx ; sub eax, 32
  4203                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  4204                                  		;	     		RootDirsectors)
  4205                                  		; RootDirSectors = 0 (for FAT32 FS)
  4206                                  
  4207                                  	;mov	bx, cx ; ch = 0
  4208                                  	;shl	bx, 8 ; * 256
  4209                                  	;mov	cl, [bp+10h] ; [BPB_NumFATs] 
  4210                                  	;add	bx, cx	
  4211                                  	;	; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  4212                                  	;shr	bx, 1
  4213                                  	;	; TmpVal2 = TmpVal2/2
  4214                                  	;mov	cx, bx
  4215                                  	;dec	bx  ; TmpVal2-1
  4216                                  	;add	ax, bx
  4217                                  	;adc	dx, 0
  4218                                  	;call	div32
  4219                                  	;	; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  4220                                  	; DX_AX = FAT size in sectors
  4221                                  	; 16/03/2021
  4222 000010E7 88CE                    	mov	dh, cl ; * 256
  4223 000010E9 8A5610                  	mov	dl, [bp+10h] ; [BPB_NumFATs]
  4224                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  4225 000010EC D1EA                    	shr	dx, 1
  4226                                  		; TmpVal2 = TmpVal2/2
  4227 000010EE 6689D1                  	mov	ecx, edx
  4228 000010F1 4A                      	dec	dx ; TmpVal2-1
  4229 000010F2 6601D0                  	add	eax, edx
  4230                                  	;xor	edx, edx
  4231 000010F5 31D2                    	xor	dx, dx
  4232 000010F7 66F7F1                  	div	ecx
  4233                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  4234                                  	; EAX = FAT size in sectors
  4235                                  
  4236                                  	;mov	[bp+24h], ax	; [BPB_FATSz32]
  4237                                  	;mov	[bp+26h], dx	; [BPB_FATSz32+2]
  4238                                  	;; * 2
  4239                                  	;mov	bx, dx
  4240                                  	;add	ax, ax
  4241                                  	;adc	bx, dx
  4242                                  	;; BX_AX = [BPB_NumFATs] * [BPB_FATSz32]
  4243                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  4244                                  	;add	cx, ax
  4245                                  	;adc	bx, 0
  4246                                  	;; BX_CX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  4247                                  	;mov	ax, [bp+20h]	; [BPB_TotSec32]
  4248                                  	;mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  4249                                  	;sub	ax, cx
  4250                                  	;sbb	dx, bx
  4251                                  	;mov	[data_start], cx
  4252                                  	;mov	[data_start+2], bx
  4253                                  	;; DX_AX = Data sectors
  4254                                  	;mov	[data_sectors], ax
  4255                                  	;mov	[data_sectors+2], dx
  4256                                  	;mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4257                                  	;xor	ch, ch
  4258                                  	;call	div32 ; DX_AX/CX
  4259                                  	;; DX_AX = Count of clusters (rounded down)
  4260                                  	;mov	[cluster_count], ax
  4261                                  	;mov	[cluster_count+2], dx
  4262                                  	; 16/03/2021
  4263 000010FA 66894624                	mov	[bp+24h], eax	; [BPB_FATSz32]
  4264                                  	; * 2
  4265 000010FE 66D1E0                  	shl	eax, 1
  4266                                  	;add	eax, eax
  4267                                  	;EAX = [BPB_NumFATs] * [BPB_FATSz32] ; 2 * FATsz
  4268 00001101 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  4269 00001104 6601C1                  	add	ecx, eax
  4270                                  	;ECX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  4271 00001107 668B4620                	mov	eax, [bp+20h]	; [BPB_TotSec32]
  4272 0000110B 6629C8                  	sub	eax, ecx
  4273 0000110E 66890E[4E67]            	mov	[data_start], ecx
  4274                                  	;EAX = Data sectors
  4275 00001113 66A3[5267]              	mov	[data_sectors], eax
  4276 00001117 660FB64E0D              	movzx	ecx, byte [bp+0Dh] ; [BPB_SecPerClus]
  4277 0000111C 6629D2                  	sub	edx, edx
  4278 0000111F 66F7F1                  	div	ecx
  4279                                  	;EAX = Count of clusters (rounded down)
  4280 00001122 66A3[5667]              	mov	[cluster_count], eax
  4281 00001126 30D2                    	xor	dl, dl
  4282                                  	
  4283 00001128 8D7E47                  	lea	di, [bp+71] ; [BS_VolLab]
  4284 0000112B E84B01                  	call	write_volume_name
  4285 0000112E 8D7643                  	lea	si, [bp+67] ; [BS_VolID]
  4286 00001131 E8A401                  	call	write_volume_serial
  4287 00001134 E8B802                  	call	write_cluster_count
  4288                                  
  4289 00001137 E82502                  	call	write_formatting_msg
  4290 0000113A B000                    	mov	al, 0
  4291 0000113C E88202                  	call	write_format_percent_x
  4292                                  
  4293                                  	;mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  4294                                  	;mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4295                                  	;add	[data_start], ax
  4296                                  	;adc	[data_start+2], dx
  4297                                  	; 16/03/2021
  4298 0000113F 668B461C                	mov	eax, [bp+1Ch]	; [BPB_HiddSec]
  4299 00001143 660106[4E67]            	add	[data_start], eax 
  4300                                  FAT32_f_3:
  4301                                  	;; DX_AX = FAT32 Boot Sector address
  4302                                  	; 16/03/2021
  4303                                  	; EAX = FAT32 Boot Sector address
  4304 00001148 BB[9F30]                	mov	bx, TRDOS_FAT32_hd_bs
  4305                                  	; ES:BX = Boot Sector 1 Buffer
  4306 0000114B E8CF08                  	call	write_hd_sector
  4307 0000114E 0F828502                	jc	formatting_error
  4308 00001152 E83202                  	call	write_format_percent
  4309                                  	;add	ax, 1
  4310                                  	;adc	dx, 0
  4311                                  	; 16/03/2021
  4312 00001155 6640                    	inc	eax
  4313 00001157 BB[3A63]                	mov	bx, HDFORMAT_FSINFO_BUFF
  4314                                  	; ES:BX = FS INFO Sector Buffer (= BS+1)
  4315 0000115A E8C008                  	call	write_hd_sector
  4316 0000115D 0F827602                	jc	formatting_error
  4317 00001161 E82302                  	call	write_format_percent
  4318                                  	;add	ax, 1
  4319                                  	;adc	dx, 0
  4320                                  	; 16/03/2021
  4321 00001164 6640                    	inc	eax
  4322 00001166 BB[9F32]                	mov	bx, TRDOS_FAT32_hd_bs + 512
  4323                                  	; ES:BX = Boot Sector 2 Buffer
  4324 00001169 E8B108                  	call	write_hd_sector
  4325 0000116C 0F826702                	jc	formatting_error
  4326 00001170 E81402                  	call	write_format_percent
  4327 00001173 B90300                  	mov	cx, 3
  4328                                  FAT32_f_4:
  4329 00001176 51                      	push	cx
  4330                                  	;add	ax, 1
  4331                                  	;adc	dx, 0
  4332                                  	; 16/03/2021
  4333 00001177 6640                    	inc	eax
  4334 00001179 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4335 0000117C E89E08                  	call	write_hd_sector
  4336 0000117F 0F825402                	jc	formatting_error
  4337 00001183 E80102                  	call	write_format_percent
  4338 00001186 59                      	pop	cx
  4339 00001187 FEC9                    	dec	cl
  4340 00001189 75EB                    	jnz	short FAT32_f_4
  4341                                  	;add	ax, 1
  4342                                  	;adc	dx, 0
  4343                                  	; 16/03/2021
  4344 0000118B 6640                    	inc	eax
  4345                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4346                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4347                                  	;add	cx, 12
  4348                                  	;adc	bx, 0
  4349                                  	; 16/03/2021
  4350 0000118D 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  4351 00001191 6683C20C                	add	edx, 12
  4352                                  	; write BACKUP sectors
  4353                                  	; (6,7,8 boot+fsi and 9,10,11 empty sectors)
  4354                                  	;cmp	dx, bx
  4355                                  	;jb	short FAT32_f_3
  4356                                  	;cmp	ax, cx
  4357                                  	;jb	short FAT32_f_3
  4358                                  	; 16/03/2021
  4359 00001195 6639D0                  	cmp	eax, edx
  4360 00001198 72AE                    	jb	short FAT32_f_3	
  4361                                  
  4362                                  	; write remain part of reserved sectors
  4363 0000119A 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt]
  4364 0000119D 83E90C                  	sub	cx, 12
  4365 000011A0 7614                    	jna	short FAT32_f_6
  4366                                  FAT32_f_5:
  4367 000011A2 51                      	push	cx
  4368 000011A3 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4369 000011A6 E87408                  	call	write_hd_sector
  4370 000011A9 0F822A02                	jc	formatting_error
  4371 000011AD E8D701                  	call	write_format_percent
  4372                                  	;add	ax, 1
  4373                                  	;adc	dx, 0
  4374                                  	; 16/03/2021
  4375 000011B0 6640                    	inc	eax
  4376 000011B2 59                      	pop	cx
  4377 000011B3 49                      	dec	cx
  4378 000011B4 75EC                    	jnz	short FAT32_f_5
  4379                                  FAT32_f_6:
  4380                                  	; write FAT sectors
  4381                                  	;mov	cx, [data_start] ; lba/abs addr
  4382                                  	;mov	bx, [data_start+2] ; lba/abs addr
  4383                                  	;push	bx
  4384                                  	;push	cx
  4385                                  	; 16/03/2021
  4386 000011B6 668B16[4E67]            	mov	edx, [data_start]
  4387                                  	;push	edx ; *
  4388                                  	; eax = sector address
  4389 000011BB BB[4E65]                	mov	bx, HDFORMAT_FATBUFFER
  4390                                  	; ES:BX = FAT Sector Buffer
  4391 000011BE 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  4392 000011C1 B5FF                    	mov	ch, 0FFh
  4393 000011C3 890F                    	mov	[bx], cx
  4394 000011C5 88E9                    	mov	cl, ch ; cx = 0FFFFh
  4395 000011C7 894F02                  	mov	[bx+2], cx
  4396 000011CA 894F04                  	mov	[bx+4], cx
  4397 000011CD 894F06                  	mov	[bx+6], cx
  4398                                  	; Root dir cluster number = 2
  4399                                  	; 0FFFFFFFh = end of cluster chain
  4400 000011D0 894F08                  	mov	[bx+8], cx  ; 0FFFFh
  4401 000011D3 80E50F                  	and	ch, 0Fh
  4402 000011D6 894F0A                  	mov	[bx+10], cx ; 0FFFh
  4403                                  	;inc	cx
  4404 000011D9 E84108                  	call	write_hd_sector
  4405 000011DC 0F82F701                	jc	formatting_error
  4406 000011E0 E8A401                  	call	write_format_percent
  4407                                  	;mov	bx, HDFORMAT_FATBUFFER
  4408 000011E3 B90000                  	mov	cx, 0
  4409 000011E6 890F                    	mov	[bx], cx
  4410 000011E8 894F02                  	mov	[bx+2], cx
  4411 000011EB 894F04                  	mov	[bx+4], cx
  4412 000011EE 894F06                  	mov	[bx+6], cx
  4413 000011F1 894F08                  	mov	[bx+8], cx
  4414 000011F4 894F0A                  	mov	[bx+10], cx
  4415 000011F7 EB0D                    	jmp	short FAT32_f_8
  4416                                  FAT32_f_7:	
  4417                                  	;push	bx
  4418                                  	;push	cx
  4419                                  	; 16/03/2021
  4420                                  	;push	edx ; *
  4421 000011F9 BB[4E65]                	mov	bx, HDFORMAT_FATBUFFER
  4422 000011FC E81E08                  	call	write_hd_sector
  4423 000011FF 0F82D401                	jc	formatting_error
  4424 00001203 E88101                  	call	write_format_percent
  4425                                  FAT32_f_8:	
  4426                                  	;pop	cx
  4427                                  	;pop	bx
  4428                                  	;add	ax, 1
  4429                                  	;adc	dx, 0
  4430                                  	;cmp	dx, bx
  4431                                  	;jb	short FAT32_f_7
  4432                                  	;cmp	ax, cx
  4433                                  	;jb	short FAT32_f_7
  4434                                  	; 16/03/2021
  4435                                  	;pop	edx ; *
  4436 00001206 6640                    	inc	eax ; next sector
  4437 00001208 6639D0                  	cmp	eax, edx
  4438 0000120B 72EC                    	jb	short FAT32_f_7
  4439                                  	
  4440                                  	; write	root directory (1st cluster)
  4441                                  	; as empty sectors
  4442 0000120D 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  4443 00001210 30ED                    	xor	ch, ch
  4444 00001212 290E[5267]              	sub	[data_sectors], cx
  4445 00001216 831E[5467]00            	sbb	word [data_sectors+2], 0
  4446                                  FAT32_f_9:
  4447 0000121B 51                      	push	cx
  4448 0000121C BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4449 0000121F E8FB07                  	call	write_hd_sector
  4450 00001222 0F82B101                	jc	formatting_error
  4451 00001226 E85E01                  	call	write_format_percent
  4452                                  	;add	ax, 1
  4453                                  	;adc	dx, 0
  4454                                  	; 16/03/2021
  4455 00001229 6640                    	inc	eax
  4456 0000122B 59                      	pop	cx
  4457 0000122C FEC9                    	dec	cl
  4458 0000122E 75EB                    	jnz	short FAT32_f_9
  4459                                  
  4460                                  	; write DATA sectors 
  4461                                  	; (after root directory 1st cluster)
  4462                                  	;mov	cx, [data_sectors]
  4463                                  	;mov	bx, [data_sectors+2] 
  4464                                  	;		; NOTE: Partition size must be >= 512 MB
  4465                                  	;		;	for FAT32 FS  ((BX >= 15))
  4466                                  	; 16/03/2021
  4467 00001230 668B16[5267]            	mov	edx, [data_sectors]
  4468                                  FAT32_f_10:	
  4469                                  	;push	bx
  4470                                  	;push	cx
  4471                                  	; 16/03/2021
  4472                                  	;push	edx
  4473 00001235 BB[3A61]                	mov	bx, HDFORMAT_SECBUFFER
  4474 00001238 E8E207                  	call	write_hd_sector
  4475 0000123B 0F829801                	jc	formatting_error
  4476 0000123F E84501                  	call	write_format_percent
  4477                                  	;pop	edx
  4478                                  	;pop	cx
  4479                                  	;pop	bx
  4480                                  	;add	ax, 1
  4481                                  	;adc	dx, 0
  4482 00001242 6640                    	inc	eax
  4483                                  	;dec	cx
  4484                                  	;jnz	short FAT32_f_10
  4485                                  	;dec	bx
  4486                                  	;jnz	short FAT32_f_10
  4487                                  	; 16/03/2021
  4488 00001244 664A                    	dec	edx
  4489 00001246 75ED                    	jnz	short FAT32_f_10
  4490                                  
  4491                                  	; If there are, format remain sectors which are
  4492                                  	; at beyond of data clusters, with zero bytes.
  4493                                  	
  4494                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  4495                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  4496                                  	; 16/03/2021
  4497 00001248 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  4498                                  FAT16_f_18:	
  4499                                  	;add	cx, [bp+20h]	; [BPB_TotSec32]
  4500                                  	;adc	bx, [bp+22h]	; [BPB_TotSec32+2]
  4501                                  	; 16/03/2021
  4502 0000124C 66035620                	add	edx, [bp+20h]	; [BPB_TotSec32]
  4503                                  FAT16_f_19:
  4504                                  FAT12_f_8:
  4505                                  	; are there remain sectors (in partition) ?
  4506                                  	;sub	cx, ax
  4507                                  	;sbb	bx, dx
  4508                                  	; 11/02/2019
  4509                                  	; BX must be 0 (Because, 1 cluster <= 32KB. So, 
  4510                                  	;	        remain sectors must not be more than 32K)
  4511                                  	;jnz	short FAT32_f_12 ; There is a wrong thing !!!
  4512                                  	;			 ; If BX is not zero,	
  4513                                  	;			 ; it is better to skip this stage...)
  4514                                  	;or	cx, cx
  4515                                  	;jz	short FAT32_f_12 ; no.. 
  4516                                  	;			 ; (good! FAT contains all data sectors)
  4517                                  	; 16/03/2021
  4518 00001250 6629C2                  	sub	edx, eax
  4519 00001253 7612                    	jna	short FAT32_f_12
  4520                                  FAT32_f_11:
  4521                                  	;push	cx
  4522                                  	; 16/03/2021
  4523                                  	;push	dx ; edx <= 32K
  4524 00001255 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  4525 00001258 E8C207                  	call	write_hd_sector
  4526 0000125B 0F827801                	jc	formatting_error
  4527 0000125F E82501                  	call	write_format_percent
  4528                                  	; 16/03/2021
  4529                                  	;pop	dx ; edx <= 32K
  4530                                  	;pop	cx
  4531                                  	;add	ax, 1
  4532                                  	;adc	dx, 0
  4533                                  	; 16/03/2021
  4534 00001262 6640                    	inc	eax
  4535                                  	;dec	cx
  4536 00001264 4A                      	dec	dx 
  4537 00001265 75EE                    	jnz	short FAT32_f_11
  4538                                  
  4539                                  FAT32_f_12:
  4540                                  SINGLIX_fs1_f_12:
  4541                                  	; End of FAT format routine...
  4542                                  end_of_formatting:
  4543 00001267 B064                    	mov	al, 100
  4544 00001269 E85501                  	call	write_format_percent_x
  4545                                  	;mov	si, CRLF
  4546                                  	;call	print_msg
  4547 0000126C BE[6852]                	mov	si, Msg_OK
  4548                                  	;call	print_msg
  4549                                  	;jmp	_exit
  4550                                  	; 19/10/2020
  4551 0000126F E900F5                  	jmp	_p_exit
  4552                                  
  4553                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4554                                  ; set & write volume name
  4555                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4556                                  
  4557                                  write_fs_volume_name:
  4558 00001272 C606[2361]40            	mov	byte [vname_length], 64
  4559 00001277 EB05                    	jmp	short svn_fs
  4560                                  
  4561                                  write_volume_name:
  4562 00001279 C606[2361]0B            	mov	byte [vname_length], 11
  4563                                  svn_fs:
  4564                                  	; DI = (BS) Volume Label address
  4565 0000127E BE[0A52]                	mov	si, Msg_Volume_Name
  4566 00001281 E83B07                  	call	print_msg
  4567                                  
  4568                                  	; get cursor position
  4569                                  	; bh = 0  ; video page
  4570 00001284 B403                    	mov     ah, 3 ; get cursor pos
  4571 00001286 CD10                    	int     10h
  4572 00001288 8916[B051]              	mov	[Cursor_Pos], dx
  4573                                  
  4574 0000128C E81B08                  	call	rw_char
  4575 0000128F 7207                    	jc	short svn_1
  4576                                  svn_0:
  4577 00001291 AC                      	lodsb
  4578 00001292 3C20                    	cmp	al, 20h
  4579 00001294 7706                    	ja	short svn_2
  4580 00001296 74F9                    	je	short svn_0
  4581                                  svn_1:
  4582 00001298 BE[2E61]                	mov	si, no_name
  4583 0000129B AC                      	lodsb
  4584                                  svn_2:
  4585                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
  4586                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
  4587 0000129C 89FB                    	mov	bx, di ; *
  4588 0000129E 30ED                    	xor	ch, ch
  4589 000012A0 8A0E[2361]              	mov	cl, [vname_length] ; 11
  4590 000012A4 EB05                    	jmp	short svn_4
  4591                                  svn_3:
  4592 000012A6 AC                      	lodsb
  4593 000012A7 3C20                    	cmp	al, 20h
  4594 000012A9 7226                    	jb	short svn_6
  4595                                  svn_4:
  4596 000012AB AA                      	stosb
  4597 000012AC E2F8                    	loop	svn_3
  4598                                  svn_5:
  4599 000012AE 8A0E[2361]              	mov	cl, [vname_length] ; 11
  4600 000012B2 89DE                    	mov	si, bx ; *
  4601 000012B4 BF[C951]                	mov	di, StrVolumeName
  4602 000012B7 F3A4                    	rep	movsb
  4603                                  	;mov	byte [di], 0
  4604                                  
  4605 000012B9 8B16[B051]              	mov	dx, [Cursor_Pos]
  4606 000012BD BB0700                  	mov	bx, 7
  4607 000012C0 B402                    	mov	ah, 2
  4608 000012C2 CD10                    	int	10h  ; Set Cursor Position
  4609                                  
  4610 000012C4 BE[C951]                	mov	si, StrVolumeName
  4611 000012C7 E8F506                  	call	print_msg
  4612 000012CA BE[6C52]                	mov	si, CRLF
  4613 000012CD E8EF06                  	call	print_msg
  4614 000012D0 C3                      	retn
  4615                                  svn_6:
  4616 000012D1 B020                    	mov	al, 20h
  4617                                  svn_7:
  4618 000012D3 AA                      	stosb
  4619 000012D4 E2FD                    	loop	svn_7
  4620 000012D6 EBD6                    	jmp	short svn_5
  4621                                  
  4622                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4623                                  ; set & write volume serial number (volume ID)
  4624                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4625                                  
  4626                                  write_volume_serial:
  4627                                  	; SI = (BS) Volume Serial Number (binary) address
  4628                                  
  4629                                  	;xor	ax, ax
  4630                                  	;int	1Ah			; get time of day
  4631                                  
  4632                                  	;mov	[si], dx
  4633                                  	;mov	[si+2], cx		; set unique volume ID
  4634                                  
  4635                                  	;mov	ah, 02h			; Return Current Time
  4636                                  	;int	1Ah
  4637                                  	;xchg	ch, cl
  4638                                  	;xchg	dh, dl
  4639                                  
  4640                                  	;add	cx, dx
  4641                                  	;add	[si+2], cx
  4642                                                 
  4643                                  	;mov	ah, 04h			; Return Current Date
  4644                                  	;int	1Ah
  4645                                  
  4646                                  	;xchg	ch,cl
  4647                                  	;xchg	dh,dl
  4648                                  
  4649                                  	;add	cx, dx
  4650                                  	;add	[si+2], cx
  4651                                  
  4652                                  	; According to Microsoft DOS 6.0 serial number
  4653                                  	; production method...
  4654                                  	; < Create unique 32 bit serial number >
  4655                                  
  4656                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
  4657                                  	; (20/04/1987)
  4658                                  	;
  4659                                  	;  Get date (INT 21h, AH=2Bh)
  4660                                  	;  Get time (INT 21h, AH=2Ch)
  4661                                  	;  Serial_ID+0 = DX reg date + DX reg time
  4662                                  	;  Serial_ID+2 = CX reg date + CX reg time
  4663                                  	;  Serial_Num_Low = Serial_ID+2
  4664                                  	;  Serial_Num_High = Serial_ID+0
  4665                                  
  4666 000012D8 B404                    	mov	ah, 04h		; Return Current Date
  4667 000012DA CD1A                    	int	1Ah
  4668                                  
  4669                                  	; DL = Day (BCD)	(20h)
  4670                                  	; DH = Month (BCD)	(12h)
  4671                                  	; CH = Century (BCD)	(20h)
  4672                                  	; CL = Year (BCD) 	(17h)
  4673                                  
  4674 000012DC 88D0                    	mov	al, dl
  4675 000012DE E87100                  	call	bcd_to_bin
  4676 000012E1 88C2                    	mov	dl, al 
  4677 000012E3 88F0                    	mov	al, dh
  4678 000012E5 E86A00                  	call	bcd_to_bin
  4679 000012E8 88C6                    	mov	dh, al 
  4680 000012EA 88C8                    	mov	al, cl
  4681 000012EC E86300                  	call	bcd_to_bin
  4682 000012EF 88C1                    	mov	cl, al 
  4683 000012F1 88E8                    	mov	al, ch
  4684 000012F3 E85C00                  	call	bcd_to_bin
  4685 000012F6 88C5                    	mov	ch, al
  4686                                  
  4687                                  	; DH = Month (1-10)
  4688                                  	; DL = Day (1-31)
  4689                                  	; CX = Year (1900-2099)
  4690                                  
  4691 000012F8 52                      	push	dx 
  4692 000012F9 51                      	push	cx
  4693                                  
  4694 000012FA B402                    	mov	ah, 02h		; Return Current Time
  4695 000012FC CD1A                    	int	1Ah
  4696                                  	
  4697                                  	; DH = Seconds (BCD)	(59h)
  4698                                  	; CL = Minutes (BCD)	(59h)
  4699                                  	; CH = Hours (BCD)	(23h)
  4700                                  	; DL = Daylight savings time option (1=yes)
  4701                                  
  4702 000012FE 88F0                    	mov	al, dh
  4703 00001300 E84F00                  	call	bcd_to_bin
  4704 00001303 88C6                    	mov	dh, al 
  4705 00001305 88C8                    	mov	al, cl
  4706 00001307 E84800                  	call	bcd_to_bin
  4707 0000130A 88C1                    	mov	cl, al 
  4708 0000130C 88E8                    	mov	al, ch
  4709 0000130E E84100                  	call	bcd_to_bin
  4710 00001311 88C5                    	mov	ch, al 
  4711                                  
  4712                                  	; CH = Hour (0-23)
  4713                                  	; CL = Minutes (0-59)
  4714                                  	; DH = Seconds (0-59)
  4715                                  	; ((DL = Hundredths (0-99) - MSDOS!))
  4716                                  	; DL = 0 or 1 (here!)
  4717                                  
  4718 00001313 89C8                    	mov	ax, cx
  4719 00001315 59                      	pop	cx
  4720 00001316 01C8                    	add	ax, cx
  4721                                  
  4722 00001318 894402                  	mov	[si+2], ax
  4723                                  
  4724 0000131B 89D0                    	mov	ax, dx
  4725 0000131D 5A                      	pop	dx
  4726 0000131E 01D0                    	add	ax, dx
  4727                                  
  4728 00001320 8904                    	mov	[si], ax
  4729                                  
  4730 00001322 30E4                    	xor	ah, ah		; Read time counter
  4731 00001324 CD1A                    	int	1Ah
  4732                                  
  4733                                  	; CX = High word of clock count
  4734                                  	; DX = Low word of clock count
  4735                                  	; AL = 0 if 24 hours has not passed, else 1
  4736                                  
  4737                                  	; NOTES: 
  4738                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
  4739                                  	;
  4740                                     	; Following formulas convert the clock count to
  4741                                          ; the time of day:
  4742                                   	;	Hour      = Clock / 65543 (1007h)
  4743                                  	;	Remainder = Clock MOD 65543
  4744                                   	;
  4745                                  	;	Minutes   = Remainder / 1092 (444h)
  4746                                  	;	Remainder = Remainder MOD 1092
  4747                                  	;
  4748                                  	;	Second    = Remainder / 18.21
  4749                                  	;	Remainder = Remainder MOD 18.21
  4750                                  	;
  4751                                  	;	Hundredths = CINT(Remainder * 100)
  4752                                  
  4753 00001326 0014                    	add	[si], dl
  4754                                  
  4755                                  	; SI = Volume serial number address (4 bytes)
  4756 00001328 8A04                    	mov	al, [si]
  4757 0000132A E86607                  	call	bin_to_hex
  4758 0000132D A3[3552]                	mov	[Vol_Serial2+2], ax
  4759 00001330 8A4401                  	mov	al, [si+1]
  4760 00001333 E85D07                  	call	bin_to_hex
  4761 00001336 A3[3352]                	mov	[Vol_Serial2], ax
  4762 00001339 8A4402                  	mov	al, [si+2]
  4763 0000133C E85407                  	call	bin_to_hex
  4764 0000133F A3[3052]                	mov	[Vol_Serial1+2], ax
  4765 00001342 8A4403                  	mov	al, [si+3]
  4766 00001345 E84B07                  	call	bin_to_hex
  4767 00001348 A3[2E52]                	mov	[Vol_Serial1], ax
  4768                                  
  4769 0000134B BE[1C52]                	mov	si, Msg_Volume_Serial
  4770 0000134E E86E06                  	call	print_msg
  4771                                  
  4772 00001351 C3                      	retn
  4773                                  
  4774                                  bcd_to_bin:
  4775 00001352 53                      	push	bx
  4776 00001353 D410                    	db	0D4h, 10h ; Undocumented inst. AAM
  4777                                  			  ; AH = AL / 10h
  4778                                  			  ; AL = AL MOD 10h
  4779 00001355 88C3                    	mov	bl, al
  4780 00001357 B00A                    	mov	al, 10
  4781 00001359 F6E4                    	mul	ah
  4782 0000135B 00D8                    	add	al, bl
  4783 0000135D 5B                      	pop	bx
  4784 0000135E C3                      	retn
  4785                                  
  4786                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4787                                  ; write formatting percentage
  4788                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4789                                  
  4790                                  	; 16/03/2021 (fdisk4.s)
  4791                                  write_formatting_msg:
  4792                                  	;;mov	ax, [pp_Sectors]
  4793                                  	;;mov	dx, [pp_Sectors+2]
  4794                                  	;; 16/02/2019
  4795                                  	;mov	ax, [ppn_Sectors]
  4796                                  	;mov	dx, [ppn_Sectors+2]
  4797                                  	; 16/03/2021
  4798 0000135F 66A1[0C6A]              	mov	eax, [ppn_Sectors] 
  4799                                  
  4800                                  	;; DX_AX = Total sectors for percentage
  4801                                  	;mov	cx, 100	
  4802                                  	;call	div32
  4803                                  	;mov	[format_percent], ax
  4804                                  	; 16/03/2021
  4805 00001363 6631D2                  	xor	edx, edx
  4806 00001366 66B964000000            	mov	ecx, 100
  4807 0000136C 66F7F1                  	div	ecx
  4808 0000136F 66A3[5C67]              	mov	[format_percent], eax
  4809                                  	
  4810 00001373 BE[5452]                	mov	si, msg_formatting
  4811 00001376 E84606                  	call	print_msg
  4812                                  
  4813                                  	; get cursor position
  4814                                  	; bh = 0  ; video page
  4815 00001379 B403                    	mov     ah, 3 ; get cursor pos
  4816 0000137B CD10                    	int     10h
  4817 0000137D 8916[B051]              	mov	[Cursor_Pos], dx
  4818                                  
  4819 00001381 C606[6067]FF            	mov	byte [prev_percent], 255
  4820                                  
  4821 00001386 C3                      	retn
  4822                                  
  4823                                  	; 16/03/2021 (fdisk4.s)
  4824                                  write_format_percent:
  4825                                  	; DX_AX = Current sector (which has been written)
  4826                                  
  4827                                  	; 16/03/2021
  4828                                  	; EAX = current sector (which has been written)
  4829                                  
  4830                                  	;push	ax
  4831                                  	;push	dx
  4832                                  	; 16/03/2021
  4833 00001387 6650                    	push	eax
  4834 00001389 6652                    	push	edx
  4835 0000138B 53                      	push	bx
  4836 0000138C 51                      	push	cx
  4837 0000138D 56                      	push	si
  4838                                  
  4839                                  	;sub	ax, [bp+1Ch]	; [BPB_HiddSec]
  4840                                  	;sbb	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  4841                                  	; 16/03/2021
  4842 0000138E 662B461C                	sub	eax, [bp+1Ch]	; [BPB_HiddSec]
  4843                                  wpc_t:
  4844                                  	;mov	cx, [format_percent]
  4845                                  	;call	div32
  4846                                  	; 16/03/2021
  4847 00001392 6629D2                  	sub	edx, edx
  4848 00001395 66F736[5C67]            	div	dword [format_percent]
  4849                                  	; AL = percentage value between 1 to 100
  4850                                  wpc_x:
  4851 0000139A 3A06[6067]              	cmp	al, [prev_percent]
  4852 0000139E 7419                    	je	short wpc_y
  4853 000013A0 A2[6067]                	mov	[prev_percent], al
  4854 000013A3 8B16[B051]              	mov	dx, [Cursor_Pos]
  4855 000013A7 BB0700                  	mov	bx, 7
  4856 000013AA B402                    	mov	ah, 2
  4857 000013AC CD10                    	int	10h  ; Set Cursor Position
  4858                                  	;;xor	dx, dx
  4859                                  	;xor	edx, edx ; 16/03/2021
  4860 000013AE 30E4                    	xor	ah, ah
  4861                                  	;mov	al, [prev_percent]
  4862 000013B0 BE[6252]                	mov	si, format_percent_str + 2
  4863 000013B3 E8C206                  	call	bin_to_decimal
  4864 000013B6 E80606                  	call	print_msg
  4865                                  wpc_y:
  4866 000013B9 5E                      	pop	si
  4867 000013BA 59                      	pop	cx
  4868 000013BB 5B                      	pop	bx
  4869                                  	; 16/03/2021
  4870 000013BC 665A                    	pop	edx
  4871 000013BE 6658                    	pop	eax
  4872                                  	;pop	dx
  4873                                  	;pop	ax
  4874 000013C0 C3                      	retn
  4875                                  
  4876                                  write_format_percent_x:
  4877                                  	; AL = % number
  4878                                  
  4879                                  	;push	ax
  4880                                  	;push	dx
  4881                                  	; 16/03/2021
  4882 000013C1 6650                    	push	eax
  4883 000013C3 6652                    	push	edx
  4884 000013C5 53                      	push	bx
  4885 000013C6 51                      	push	cx
  4886 000013C7 56                      	push	si
  4887                                  
  4888 000013C8 EBD0                    	jmp	short wpc_x
  4889                                  
  4890                                  write_fs_format_percent:
  4891                                  	; DX_AX = Current sector (which has been written)
  4892                                  	; 16/03/2021
  4893                                  	; EAX = Current sector
  4894                                  
  4895                                  	;push	ax
  4896                                  	;push	dx
  4897                                  	; 16/03/2021
  4898 000013CA 6650                    	push	eax
  4899 000013CC 6652                    	push	edx
  4900 000013CE 53                      	push	bx
  4901 000013CF 51                      	push	cx
  4902 000013D0 56                      	push	si
  4903                                  
  4904                                  	;sub	ax, [bp+0Ch]	; [bsBeginSector]
  4905                                  	;sbb	dx, [bp+0Eh]	; [bsBeginSector+2]
  4906                                  	; 16/03/2021
  4907 000013D1 662B460C                	sub	eax, [bp+0Ch]	; [bsBeginSector]
  4908                                  
  4909 000013D5 EBBB                    	jmp	short wpc_t
  4910                                  	
  4911                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4912                                  ; format error 
  4913                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4914                                  
  4915                                  formatting_error:
  4916 000013D7 8B26[4C65]              	mov	sp, [old_sp]
  4917                                  
  4918 000013DB 88E0                    	mov	al, ah ;  error code
  4919 000013DD E8B306                  	call	bin_to_hex
  4920 000013E0 A3[7A52]                	mov 	[error_code], ax
  4921                                  
  4922 000013E3 BE[6C52]                	mov	si, CRLF
  4923 000013E6 E8D605                  	call	print_msg
  4924                                  
  4925 000013E9 BE[6F52]                	mov	si, Msg_Error
  4926                                  	;call	print_msg
  4927                                  	;jmp	_exit
  4928                                  	; 19/10/2020
  4929 000013EC E983F3                  	jmp	_p_exit
  4930                                  
  4931                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4932                                  ; write cluster count
  4933                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4934                                  
  4935                                  write_cluster_count:
  4936 000013EF BE[3A52]                	mov	si, msg_cluster_count
  4937 000013F2 E8CA05                  	call	print_msg
  4938                                  	;mov	ax, [cluster_count]
  4939                                  	;mov	dx, [cluster_count+2]
  4940                                  	; 16/03/2021
  4941 000013F5 66A1[5667]              	mov	eax, [cluster_count]
  4942 000013F9 BE[5052]                	mov	si, cluster_count_str+6
  4943 000013FC E87906                  	call	bin_to_decimal
  4944                                  	;call	print_msg
  4945                                  	;retn
  4946                                  	; 19/10/2020
  4947 000013FF E9BD05                  	jmp	print_msg 
  4948                                  
  4949                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4950                                  ; FAT16 FORMATTING
  4951                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  4952                                  	
  4953                                  	; 17/03/2021 (fdisk4.s)
  4954                                  	; 08/02/2019 (Modified for -only- FAT16 CHS partitions) 
  4955                                  FAT16_hd_format:
  4956                                  ; 04/05/2024 (Retro DOS v5 modification)
  4957                                  ; DL = Partition (FS) ID
  4958                                  ;	mov	ax, 0706h ; db 06h, 07h ; 'push es, pop es'
  4959                                  ;	cmp	dl, al ; 06h ; Big CHS partition (>= 32MB)
  4960                                  ;	je	short FAT16_big_chs_format
  4961                                  ;	;mov	ax, 070Eh ; db 0Eh, 07h	; 'push cs, pop es'
  4962                                  ;	;cmp	dl, al ; 0Eh ; LBA partition
  4963                                  ;	;je	short FAT16_lba_format
  4964                                  ;FAT16_chs_format:  
  4965                                  ;	; Partition Type: 04h, CHS (<32 MB) partition
  4966                                  ;	mov	ax, 0004h ; db 04h, 00h ; 'add al, 0'
  4967                                  ;FAT16_big_chs_format:
  4968                                  ;;;
  4969                                  ;;FAT16_lba_format:
  4970                                  	; Put TRDOS 386 FAT16 partition magic word 
  4971                                  	; at offset 3Eh, in TRDOS386 FAT16 boot sector.
  4972 00001402 BD[9F34]                	mov	bp, TRDOS_FAT16_hd_bs
  4973 00001405 8D7E03                  	lea	di, [bp+3]
  4974 00001408 BE[2461]                	mov	si, bs_oem_name
  4975 0000140B B90400                  	mov	cx, 4
  4976 0000140E F3A5                    	rep	movsw 
  4977                                  
  4978                                  	;mov	[bp+3Eh], ax	; [loc_3E]
  4979                                  	; 04/05/2024 (Retro DOS v5 modification)
  4980 00001410 80FA06                  	cmp	dl, 6
  4981 00001413 7404                    	je	short FAT16_f_x ; skip ; db 'RDv5 FAT16 06h', 0
  4982                                  	; dl = 04h or 0Eh
  4983 00001415 8896CE01                	mov	[bp+1CEh], dl	; Retro DOS v5 boot sect off 1CEh
  4984                                  				; (see: 'rd5hdbs.txt' for 1CEh)
  4985                                  FAT16_f_x: 
  4986 00001419 A1[B23C]                	mov	ax, [sectors]
  4987 0000141C 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  4988 0000141F A1[B43C]                	mov	ax, [heads]
  4989 00001422 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  4990 00001425 A1[D469]                	mov	ax, [pp_StartSector]
  4991 00001428 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  4992 0000142B A1[D669]                	mov	ax, [pp_StartSector+2]
  4993 0000142E 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  4994                                  	
  4995                                  	;;mov	ax, [pp_Sectors]
  4996                                  	;mov	ax, [ppn_Sectors] ; 16/02/2019
  4997                                  	;;mov	dx, [pp_Sectors+2]
  4998                                  	;mov	dx, [ppn_Sectors+2] ; 16/02/2019
  4999                                  	;and	dx, dx
  5000                                  	;jnz	short FAT16_f_0
  5001                                  	; 17/03/2021
  5002 00001431 66A1[0C6A]              	mov	eax, [ppn_Sectors]
  5003 00001435 663D00000100            	cmp	eax, 65536
  5004 0000143B 7305                    	jnb	short FAT16_f_0
  5005                                  
  5006 0000143D 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  5007                                  	; CX = 0
  5008                                  	;mov	[bp+20h], cx	; [BPB_TotSec32] =  0
  5009                                  	;mov	[bp+22h], cx	; [BPB_TotSec32+2] = 0
  5010 00001440 EB04                    	jmp	short FAT16_f_1
  5011                                  FAT16_f_0:
  5012                                  	;mov	[bp+20h], ax	; [BPB_TotSec32]
  5013                                  	;;;mov	dx, [pp_Sectors+2]
  5014                                  	;;mov	dx, [ppn_Sectors+2] ; 16/02/2019 
  5015                                  	;mov	[bp+22h], dx	; [BPB_TotSec32+2]
  5016                                  	;; CX = 0
  5017                                  	;;mov	[bp+13h], cx ; [BPB_TotSec16] = 0
  5018                                  	; 17/03/2021
  5019 00001442 66894620                	mov	[bp+20h], eax	; [BPB_TotSec32]
  5020                                  FAT16_f_1:
  5021                                  	; Sectors per cluster calculation
  5022                                  	; (According to MS FAT32 FS specification.)
  5023 00001446 B102                    	mov	cl, 2  ; 2 sectors per cluster
  5024                                  	; 17/03/2021
  5025 00001448 6689C2                  	mov	edx, eax
  5026 0000144B 66C1EA10                	shr	edx, 16
  5027 0000144F 7507                    	jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  5028                                  	;or	dx, dx
  5029                                  	;jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  5030 00001451 3DA87F                  	cmp	ax, 32680
  5031 00001454 763C                    	jna	short FAT16_f_10 ; 2 sectors, <=16MB
  5032                                  	; > 16MB
  5033 00001456 EB38                    	jmp	short FAT16_f_9 ; 4 sectors per cluster
  5034                                  FAT16_f_2:
  5035 00001458 83FA04                  	cmp	dx, 4  ; >= 262144 sectors ; >=128MB
  5036 0000145B 7708                    	ja	short FAT16_f_3 ; >4 sectors per cluster
  5037 0000145D 7231                    	jb	short FAT16_f_9 ; 4 sectors per cluster	
  5038 0000145F 09C0                    	or	ax, ax ; dx_ax = (4*65536)+0
  5039 00001461 742D                    	jz	short FAT16_f_9 ; 4 sectors per cluster
  5040 00001463 EB29                    	jmp	short FAT16_f_8 ; 8 sectors per cluster
  5041                                  FAT16_f_3:
  5042 00001465 83FA08                  	cmp	dx, 8  ; >= 524288 sectors ; >=256MB
  5043 00001468 7708                    	ja	short FAT16_f_4 ; >8 sectors per cluster
  5044 0000146A 7222                    	jb	short FAT16_f_8 ; 8 sectors per cluster	
  5045 0000146C 21C0                    	and	ax, ax ; dx_ax = (8*65536)+0
  5046 0000146E 741E                    	jz	short FAT16_f_8 ; 8 sectors per cluster
  5047 00001470 EB1A                    	jmp	short FAT16_f_7 ; 16 sectors per cluster
  5048                                  FAT16_f_4:
  5049 00001472 83FA10                  	cmp	dx, 16 ; >= 1048576 sectors ; >=512MB
  5050 00001475 7708                    	ja	short FAT16_f_5 ; >16 sectors per cluster
  5051 00001477 7213                    	jb	short FAT16_f_7 ; 16 sectors per cluster
  5052 00001479 21C0                    	and	ax, ax ; dx_ax = (16*65536)+0
  5053 0000147B 740F                    	jz	short FAT16_f_7 ; 16 sectors per cluster
  5054 0000147D EB0B                    	jmp	short FAT16_f_6 ; 32 sectors per cluster
  5055                                  FAT16_f_5:
  5056 0000147F 83FA20                  	cmp	dx, 32 ; >= 2097152 sectors ; >=1GB
  5057 00001482 7206                    	jb	short FAT16_f_6 ; 32 sectors per cluster
  5058 00001484 09C0                    	or	ax, ax		; dx_ax = (32*65536)+0
  5059 00001486 7402                    	jz	short FAT16_f_6 ; 32 sectors per cluster
  5060                                  	; >1GB (<=2GB)
  5061                                  	; 64 sectors per cluster
  5062 00001488 D0E1                    	shl	cl, 1
  5063                                  FAT16_f_6:
  5064                                  	; 32 sectors per cluster (for <= 2GB volumes)
  5065 0000148A D0E1                    	shl	cl, 1
  5066                                  FAT16_f_7:
  5067                                  	; 16 sectors per cluster (for <= 1GB volumes)
  5068 0000148C D0E1                    	shl	cl, 1
  5069                                  FAT16_f_8:
  5070                                  	; 8 sectors per cluster (for <= 512MB volumes)
  5071 0000148E D0E1                    	shl	cl, 1
  5072                                  FAT16_f_9:
  5073                                  	; 4 sectors per cluster (for <= 256MB volumes)
  5074 00001490 D0E1                    	shl	cl, 1
  5075                                  FAT16_f_10:	
  5076                                  	; 2 sectors per cluster (for <= 128MB volumes)
  5077 00001492 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  5078                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  5079                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt]
  5080                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  5081                                  	
  5082                                  	; Calculating FAT size in sectors
  5083                                  	; (According to MS FAT32 FS Specification, 2000)
  5084                                  
  5085                                  	; DX_AX = partition (volume) size in sectors
  5086                                  	;mov	bx, [bp+11h]	; [BPB_RootEntCnt] = 512
  5087                                  	;add	bx, 15 ; bx = 527
  5088                                  	;shr	bx, 4 ; /16 = 527/16 = 32
  5089                                  	;	; ((32*BX)+511)/512
  5090                                  	;mov	[root_dir_secs], bx
  5091                                  	;add	bx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5092                                  	;sub	ax, bx
  5093                                  	;sbb	dx, 0
  5094                                  	;	; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  5095                                  	;	;	     		RootDirsectors)
  5096                                  	; 17/03/2021
  5097 00001495 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  5098 00001498 83C20F                  	add	dx, 15 ; DX = 527
  5099 0000149B C1EA04                  	shr	dx, 4 ; /16 = 527/16 = 32
  5100                                  		; ((32*DX)+511)/512
  5101 0000149E 8916[5A67]              	mov	[root_dir_secs], dx
  5102 000014A2 03560E                  	add	dx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5103 000014A5 6629D0                  	sub	eax, edx
  5104                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  5105                                  		;	     		RootDirsectors)
  5106                                  	
  5107                                  	;;mov	bx, cx ; ch = 0
  5108                                  	;;shl	bx, 8 ; * 256
  5109                                  	;; 11/02/2019
  5110                                  	;mov	bh, cl
  5111                                  	;xor	bl, bl
  5112                                  	;mov	cl, 2 ; [BPB_NumFATs]
  5113                                  	;add	bx, cx	
  5114                                  	;	; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  5115                                  	;mov	cx, bx
  5116                                  	;dec	bx  ; TmpVal2-1
  5117                                  	;add	ax, bx
  5118                                  	;adc	dx, 0
  5119                                  	;call	div32
  5120                                  	;	; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  5121                                  	;; AX = FAT size in sectors
  5122                                  	;; DX = 0
  5123                                  	;mov	[bp+16h], ax	; [BPB_FATSz16]
  5124                                  	; 17/03/2021
  5125 000014A8 88CE                    	mov	dh, cl ; * 256
  5126                                  	;mov	dl, [bp+10h] ; [BPB_NumFATs] 
  5127 000014AA B202                    	mov	dl, 2 ; [BPB_NumFATs]
  5128                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs 
  5129 000014AC 6689D3                  	mov	ebx, edx
  5130 000014AF 4A                      	dec	dx ; TmpVal2-1
  5131 000014B0 6601D0                  	add	eax, edx
  5132 000014B3 31D2                    	xor	dx, dx
  5133 000014B5 66F7F3                  	div	ebx
  5134                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  5135                                  	; EAX = FAT size in sectors (<= 256)
  5136                                  	; * 2
  5137 000014B8 D1E0                    	shl	ax, 1
  5138                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  5139                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5140                                  	;add	cx, ax
  5141                                  	; 17/03/2021
  5142 000014BA 8B560E                  	mov	dx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5143 000014BD 01C2                    	add	dx, ax
  5144                                  
  5145                                  	; 15/07/2024 (bugfix)
  5146 000014BF 895642                  	mov	[bp+42h], dx	; bsRootDirStart
  5147 000014C2 A1[5A67]                	mov	ax, [root_dir_secs]
  5148 000014C5 894644                  	mov	[bp+44h], ax	; bsRootDirSects
  5149                                  	;mov	word [bp+46h], 16 ; bsDirEntsPerSec	
  5150                                  
  5151                                  	; EDX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5152                                  	;; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5153                                  	;add	cx, [root_dir_secs] ; + RootDirsectors
  5154                                  	;sub	bx, bx ; BX = 0
  5155                                  	; 15/07/2024
  5156                                  	;add	dx, [root_dir_secs] ; + RootDirsectors
  5157 000014C8 01C2                    	add	dx, ax
  5158                                  
  5159                                  	; 15/07/2024 (bugfix)
  5160 000014CA 895640                  	mov	 [bp+40h], dx	; bsDataStart
  5161                                  
  5162                                  	; EDX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5163                                  	;	+ RootDirSectors
  5164                                  	;; BX_CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5165                                  	;	  + RootDirSectors
  5166 000014CD 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  5167                                  	;sub	dx, dx 
  5168                                  	; DX = 0
  5169 000014D0 21C0                    	and	ax, ax
  5170 000014D2 7504                    	jnz	short FAT16_f_11
  5171                                  	;mov	ax, [bp+20h]	; [BPB_TotSec32]
  5172                                  	;mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  5173 000014D4 668B4620                	mov	eax, [bp+20h]	; [BPB_TotSec32]
  5174                                  FAT16_f_11:
  5175                                  	;sub	ax, cx
  5176                                  	;sbb	dx, bx
  5177                                  	; 17/03/2021
  5178                                  	; EAX = Total Sectors
  5179                                  	; EDX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5180                                  	;	+ RootDirSectors
  5181 000014D8 6629D0                  	sub	eax, edx
  5182                                  	;mov	[data_start], cx
  5183                                  	;mov	[data_start+2], bx
  5184 000014DB 668916[4E67]            	mov	[data_start], edx
  5185                                  	; DX_AX = Data sectors
  5186                                  	;mov	[data_sectors], ax
  5187                                  	;mov	[data_sectors+2], dx
  5188 000014E0 66A3[5267]              	mov	[data_sectors], eax
  5189 000014E4 31D2                    	xor	dx, dx
  5190                                  	;mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  5191                                  	;xor	ch, ch
  5192                                  	;call	div32 ; DX_AX/CX
  5193                                  	;; AX = Count of clusters (rounded down)
  5194                                  	;; DX = 0
  5195 000014E6 8A5E0D                  	mov	bl, [bp+0Dh]	 ; [BPB_SecPerClus]
  5196 000014E9 30FF                    	xor	bh, bh
  5197 000014EB 66F7F3                  	div	ebx
  5198                                  	; AX = Count of clusters (rounded down)
  5199                                  	; (eax <= 65528)
  5200                                  
  5201                                  	;mov	[cluster_count], ax
  5202                                  	;mov	[cluster_count+2], dx
  5203 000014EE 66A3[5667]              	mov	[cluster_count], eax
  5204                                  
  5205 000014F2 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  5206 000014F5 E881FD                  	call	write_volume_name
  5207 000014F8 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  5208 000014FB E8DAFD                  	call	write_volume_serial
  5209 000014FE E8EEFE                  	call	write_cluster_count
  5210                                  
  5211 00001501 E85BFE                  	call	write_formatting_msg
  5212 00001504 B000                    	mov	al, 0
  5213 00001506 E8B8FE                  	call	write_format_percent_x
  5214                                  
  5215                                  	;mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  5216                                  	;mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  5217 00001509 668B461C                	mov	eax, [bp+1Ch]	; [BPB_HiddSec]
  5218                                  
  5219                                  	;add	[data_start], ax
  5220                                  	;adc	[data_start+2], dx
  5221 0000150D 660106[4E67]            	add	[data_start], eax
  5222                                  	;sub	dx, dx ; edx = 0
  5223                                  
  5224                                  	; DX_AX = FAT16 Boot Sector address
  5225 00001512 BB[9F34]                	mov	bx, TRDOS_FAT16_hd_bs
  5226                                  	; ES:BX = Boot Sector Buffer
  5227 00001515 E80505                  	call	write_hd_sector
  5228 00001518 0F82BBFE                	jc	formatting_error
  5229 0000151C E868FE                  	call	write_format_percent
  5230                                  	;add	ax, 1
  5231                                  	;adc	dx, 0
  5232                                  	; 17/03/2021
  5233 0000151F 6640                    	inc	eax
  5234                                  	; write remain part of reserved sectors
  5235 00001521 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  5236                                  	;sub	cx, 1
  5237                                  	;jna	short FAT16_f_13
  5238                                  	; 11/02/2019
  5239 00001524 49                      	dec	cx
  5240 00001525 7414                    	jz	short FAT16_f_13
  5241                                  FAT16_f_12:
  5242 00001527 51                      	push	cx
  5243 00001528 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5244 0000152B E8EF04                  	call	write_hd_sector
  5245 0000152E 0F82A5FE                	jc	formatting_error
  5246 00001532 E852FE                  	call	write_format_percent
  5247                                  	;add	ax, 1
  5248                                  	;adc	dx, 0
  5249                                  	; 17/03/2021
  5250 00001535 6640                    	inc	eax
  5251 00001537 59                      	pop	cx
  5252 00001538 49                      	dec	cx ; dec cl
  5253 00001539 75EC                    	jnz	short FAT16_f_12
  5254                                  FAT16_f_13:
  5255                                  	; write FAT sectors
  5256                                  	;mov	cx, [data_start] ; lba/abs addr
  5257                                  	;mov	bx, [data_start+2] ; lba/abs addr
  5258                                  	; 17/03/2021	
  5259 0000153B 668B16[4E67]            	mov	edx, [data_start]
  5260                                  
  5261                                  	; 11/02/2019
  5262                                  	;sub	cx, [root_dir_secs]
  5263                                  	;sbb	bx, 0
  5264                                  	; 17/03/2021	
  5265 00001540 8B1E[5A67]              	mov	bx, [root_dir_secs]
  5266 00001544 6629DA                  	sub	edx, ebx 
  5267                                  	;push	edx  ; *
  5268                                  
  5269                                  	;push	bx
  5270                                  	;push	cx
  5271 00001547 BB[4E65]                	mov	bx, HDFORMAT_FATBUFFER
  5272                                  	; ES:BX = FAT Sector Buffer
  5273 0000154A 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  5274 0000154D B5FF                    	mov	ch, 0FFh
  5275 0000154F 890F                    	mov	[bx], cx ; 0FFF8h
  5276 00001551 88E9                    	mov	cl, ch ; cx = 0FFFFh
  5277 00001553 894F02                  	mov	[bx+2], cx
  5278                                  	;inc	cx
  5279 00001556 E8C404                  	call	write_hd_sector
  5280 00001559 0F827AFE                	jc	formatting_error
  5281 0000155D E827FE                  	call	write_format_percent
  5282                                  	;mov	bx, HDFORMAT_FATBUFFER
  5283 00001560 B90000                  	mov	cx, 0
  5284 00001563 890F                    	mov	[bx], cx
  5285 00001565 894F02                  	mov	[bx+2], cx
  5286 00001568 EB0D                    	jmp	short FAT16_f_15
  5287                                  FAT16_f_14:	
  5288                                  	;push	bx
  5289                                  	;push	cx
  5290                                  	; 17/03/2021
  5291                                  	; push	edx ; *
  5292 0000156A BB[4E65]                	mov	bx, HDFORMAT_FATBUFFER
  5293 0000156D E8AD04                  	call	write_hd_sector
  5294 00001570 0F8263FE                	jc	formatting_error
  5295 00001574 E810FE                  	call	write_format_percent
  5296                                  FAT16_f_15:	
  5297                                  	;pop	cx
  5298                                  	;pop	bx
  5299                                  	; 17/03/2021
  5300                                  	;pop	edx ; *
  5301                                  	;add	ax, 1
  5302                                  	;adc	dx, 0
  5303 00001577 6640                    	inc	eax
  5304                                  	;cmp	dx, bx
  5305                                  	;jb	short FAT16_f_14
  5306                                  	;cmp	ax, cx
  5307                                  	;jb	short FAT16_f_14
  5308 00001579 6639D0                  	cmp	eax, edx
  5309 0000157C 72EC                    	jb	short FAT16_f_14
  5310                                  
  5311                                  	; write	root directory sectors
  5312                                  	; as empty sectors
  5313 0000157E 8B0E[5A67]              	mov	cx, [root_dir_secs]
  5314                                  FAT16_f_16:
  5315 00001582 51                      	push	cx
  5316 00001583 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5317 00001586 E89404                  	call	write_hd_sector
  5318 00001589 0F824AFE                	jc	formatting_error
  5319 0000158D E8F7FD                  	call	write_format_percent
  5320                                  	;add	ax, 1
  5321                                  	;adc	dx, 0
  5322                                  	; 17/03/2021
  5323 00001590 6640                    	inc	eax
  5324 00001592 59                      	pop	cx
  5325 00001593 49                      	dec	cx
  5326 00001594 75EC                    	jnz	short FAT16_f_16
  5327                                  
  5328                                  	; write DATA sectors 
  5329                                  	; (after root directory sectors)
  5330                                  	;mov	cx, [data_sectors]
  5331                                  	;mov	bx, [data_sectors+2]
  5332                                  	; 17/03/2021
  5333 00001596 668B16[5267]            	mov	edx, [data_sectors]
  5334                                  	; 11/02/2019
  5335 0000159B 43                      	inc	bx ; 0 -> 1, 1-> 2
  5336                                  FAT16_f_17:	
  5337                                  	;push	bx
  5338                                  	;push	cx
  5339                                  	; 17/03/2021
  5340                                  	;push	edx ; **
  5341 0000159C BB[3A61]                	mov	bx, HDFORMAT_SECBUFFER
  5342 0000159F E87B04                  	call	write_hd_sector
  5343 000015A2 0F8231FE                	jc	formatting_error
  5344 000015A6 E8DEFD                  	call	write_format_percent
  5345                                  	; 17/03/2021
  5346 000015A9 665A                    	pop	edx ;**
  5347                                  	;pop	cx
  5348                                  	;pop	bx
  5349                                  	;add	ax, 1
  5350                                  	;adc	dx, 0
  5351 000015AB 6640                    	inc	eax
  5352                                  	;dec	cx
  5353                                  	;jnz	short FAT16_f_17
  5354                                  	;dec	bx
  5355                                  	;jnz	short FAT16_f_17
  5356                                  	; 17/03/2021
  5357 000015AD 664A                    	dec	edx
  5358 000015AF 75EB                    	jnz	short FAT16_f_17
  5359                                  
  5360                                  	; If there are, format remain sectors which are
  5361                                  	; at beyond of data clusters, with zero bytes.
  5362                                  	
  5363                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  5364                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  5365                                  	; 17/03/2021
  5366 000015B1 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  5367                                  	;movzx	ebx, word [bp+13h] ; [BPB_TotSec16]
  5368 000015B5 8B5E13                  	mov	bx, [bp+13h] ; [BPB_TotSec16]
  5369                                  
  5370                                  	;cmp	word [bp+13h], 0 ; [BPB_TotSec16]
  5371 000015B8 09DB                    	or	bx, bx	; 17/03/2021
  5372 000015BA 0F848EFC                	jz	FAT16_f_18
  5373                                  	;add	cx, [bp+13h]	; [BPB_TotSec16]
  5374                                  	;adc	bx, 0
  5375                                  	; 17/03/2021
  5376 000015BE 6601DA                  	add	edx, ebx
  5377 000015C1 E98CFC                  	jmp	FAT16_f_19
  5378                                  
  5379                                  	; 17/03/2021 (fdisk4.s)
  5380                                  FAT12_hd_format:
  5381 000015C4 BD[9F36]                	mov	bp, TRDOS_FAT12_hd_bs
  5382 000015C7 8D7E03                  	lea	di, [bp+3]
  5383 000015CA BE[2461]                	mov	si, bs_oem_name
  5384 000015CD B90400                  	mov	cx, 4
  5385 000015D0 F3A5                    	rep	movsw 
  5386 000015D2 A1[B23C]                	mov	ax, [sectors]
  5387 000015D5 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  5388 000015D8 A1[B43C]                	mov	ax, [heads]
  5389 000015DB 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  5390                                  
  5391                                  	;mov	ax, [pp_StartSector]
  5392                                  	;mov	[bp+1Ch], ax	; [BPB_HiddSec]
  5393                                  	;mov	ax, [pp_StartSector+2]
  5394                                  	;mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  5395                                  	; 17/03/2021
  5396 000015DE 66A1[D469]              	mov	eax, [pp_StartSector]
  5397 000015E2 6689461C                	mov	[bp+1Ch], eax	; [BPB_HiddSec]
  5398                                  
  5399                                  	;mov	ax, [pp_Sectors]
  5400 000015E6 A1[0C6A]                	mov	ax, [ppn_Sectors] ; 16/02/2019
  5401 000015E9 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  5402                                  
  5403                                  	; 11/02/2019
  5404 000015EC 31F6                    	xor	si, si ; reset (FAT size fix) flag
  5405 000015EE 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5406 000015F1 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  5407 000015F4 83C20F                  	add	dx, 15	; (16-1) (512-1)
  5408 000015F7 C1EA04                  	shr	dx, 4	; /16  (*32/512)
  5409                                  	; AX = Root dir sectors
  5410                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5411 000015FA 01D1                    	add	cx, dx ; + RootDirsectors ; + 32
  5412 000015FC 890E[5A67]              	mov	[root_dir_secs], cx ; = 33
  5413                                  
  5414                                  	; 11/02/2019
  5415                                  	;sub	ax, 33  ; 1 reserved sector, 32 root dir sectors
  5416                                  			; .. now AX has number of data sectors
  5417                                  			;	 		+ 2* (FAT sectors)
  5418 00001600 29C8                    	sub	ax, cx
  5419                                  FAT12_f_10:	; 11/02/2019
  5420                                  	; Sectors per cluster calculation
  5421                                  	; (According to MS FAT32 FS specification.)
  5422                                  	;mov	cx, 1  ; 1 sector per cluster
  5423 00001602 B101                    	mov	cl, 1  ; CH = 0
  5424                                  FAT12_f_0:
  5425 00001604 3DF50F                  	cmp	ax, 4085 ; Max. cluster count for FAT12
  5426 00001607 7206                    	jb	short FAT12_f_1
  5427 00001609 D0E1                    	shl	cl, 1 ; *2
  5428 0000160B D1E8                    	shr	ax, 1 ; /2
  5429 0000160D EBF5                    	jmp	short FAT12_f_0
  5430                                  FAT12_f_1:
  5431 0000160F 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  5432                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  5433                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  5434                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  5435                                  	
  5436                                  	; Calculating FAT size in sectors
  5437                                  	; AX = partition (volume) size in sectors
  5438                                  	; CX = sectors per clusters
  5439 00001612 31D2                    	xor	dx, dx
  5440 00001614 F7F1                    	div	cx
  5441                                  	; AX = cluster count (only for FAT size calc)
  5442                                  	; DX = 0
  5443 00001616 83C002                  	add	ax, 2  ; cluster 2 to ...
  5444 00001619 89C2                    	mov	dx, ax
  5445 0000161B D1E2                    	shl	dx, 1
  5446 0000161D 01D0                    	add	ax, dx ; *3
  5447 0000161F D1E8                    	shr	ax, 1  ; /2
  5448 00001621 83D000                  	adc	ax, 0  ; +0.5 -> +1
  5449                                  
  5450                                  	; AX = FAT bytes for 12 bit cluster numbers
  5451                                  	
  5452 00001624 B90002                  	mov	cx, 512		; [BPB_BytesPerSec]
  5453 00001627 01C8                    	add	ax, cx		
  5454 00001629 48                      	dec	ax		; [BPB_BytesPerSec] - 1
  5455 0000162A 29D2                    	sub	dx, dx
  5456 0000162C F7F1                    	div	cx
  5457 0000162E 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  5458                                  	; * 2
  5459 00001631 D1E0                    	shl	ax, 1
  5460                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  5461                                  
  5462                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5463                                  	;add	cx, ax
  5464                                  	;mov	ax, [bp+11h]	; [BPB_RootEntCnt] = 512
  5465                                  	;add	ax, 15	; (16-1) (512-1)
  5466                                  	;shr	ax, 4	; /16  (*32/512)
  5467                                  	;; AX = Root dir sectors
  5468                                  	;; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5469                                  	;add	cx, ax ; + RootDirsectors
  5470                                  	;mov	[root_dir_secs], ax
  5471                                  
  5472                                  	; 11/02/2019
  5473                                  	;mov	cx, 33
  5474 00001633 8B0E[5A67]              	mov	cx, [root_dir_secs]
  5475                                  
  5476                                  	; 15/07/2024 (bugfix)
  5477                                  	; ax = 2 * FAT size (in sectors)
  5478 00001637 03460E                  	add	ax, [bp+0Eh] ; total FAT sectors + reserved sectors
  5479 0000163A 894642                  	mov	[bp+42h], ax	; bsRootDirStart
  5480 0000163D 894E44                  	mov	[bp+44h], cx	; bsRootDirSects
  5481                                  	;mov	word [bp+46h], 16 ; bsDirEntsPerSec
  5482                                  
  5483                                  	; 15/07/2024
  5484                                  	;add	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  5485                                  		; cx = root directory sectors + reserved sectors
  5486 00001640 01C1                    	add	cx, ax
  5487                                  
  5488                                  	; 15/07/2024 (bugfix)
  5489 00001642 894E40                  	mov	 [bp+40h], cx	; bsDataStart
  5490                                  
  5491                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  5492                                  	;	  + RootDirSectors
  5493                                  
  5494                                  	; 17/03/2021
  5495 00001645 6631C0                  	xor	eax, eax
  5496                                  
  5497 00001648 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  5498 0000164B 29C8                    	sub	ax, cx
  5499                                  		 ; AX = data sectors
  5500                                  		 ; cH = 0
  5501                                  
  5502                                  	; 11/02/2019 - fix FAT size (better method)
  5503 0000164D 09F6                    	or	si, si
  5504 0000164F 7504                    	jnz	short FAT12_f_9
  5505                                  
  5506 00001651 89C6                    	mov	si, ax  ; ax = data sectors
  5507 00001653 EBAD                    	jmp	short FAT12_f_10
  5508                                  
  5509                                  FAT12_f_9:
  5510 00001655 31D2                    	xor	dx, dx
  5511 00001657 890E[4E67]              	mov	[data_start], cx
  5512 0000165B 8916[5067]              	mov	[data_start+2], dx ; 0
  5513                                  	; DX_AX = Data sectors
  5514                                  	;mov	[data_sectors], ax
  5515                                  	;mov	[data_sectors+2], dx ; 0
  5516                                  	; 17/03/2021
  5517 0000165F 66A3[5267]              	mov	[data_sectors], eax
  5518 00001663 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  5519 00001666 28ED                    	sub	ch, ch
  5520 00001668 F7F1                    	div	cx
  5521                                  	; AX = Count of clusters (rounded down)
  5522 0000166A 29D2                    	sub	dx, dx ; 0
  5523 0000166C A3[5667]                	mov	[cluster_count], ax
  5524 0000166F 8916[5867]              	mov	[cluster_count+2], dx ; 0
  5525                                  
  5526 00001673 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  5527 00001676 E800FC                  	call	write_volume_name
  5528 00001679 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  5529 0000167C E859FC                  	call	write_volume_serial
  5530 0000167F E86DFD                  	call	write_cluster_count
  5531                                  
  5532 00001682 E8DAFC                  	call	write_formatting_msg
  5533 00001685 B000                    	mov	al, 0
  5534 00001687 E837FD                  	call	write_format_percent_x
  5535                                  
  5536                                  	;mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  5537                                  	;mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  5538                                  	; 17/03/2021
  5539 0000168A 668B461C                	mov	eax, [bp+1Ch]	; [BPB_HiddSec]
  5540                                  
  5541                                  	;add	[data_start], ax
  5542                                  	;adc	[data_start+2], dx
  5543                                  	; 17/03/2021
  5544 0000168E 660106[4E67]            	add	[data_start], eax
  5545                                  
  5546                                  	; DX_AX = FAT12 Boot Sector address
  5547 00001693 BB[9F36]                	mov	bx, TRDOS_FAT12_hd_bs
  5548                                  	; ES:BX = Boot Sector Buffer
  5549 00001696 E88403                  	call	write_hd_sector
  5550 00001699 0F823AFD                	jc	formatting_error
  5551 0000169D E8E7FC                  	call	write_format_percent
  5552                                  	;add	ax, 1
  5553                                  	;adc	dx, 0
  5554                                  	; 17/03/2021
  5555 000016A0 6640                    	inc	eax
  5556                                  	; write remain part of reserved sectors
  5557 000016A2 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  5558                                  	;sub	cx, 1
  5559                                  	;jna	short FAT12_f_3
  5560                                  	; 11/02/2019
  5561 000016A5 49                      	dec	cx
  5562 000016A6 7414                    	jz	short FAT12_f_3
  5563                                  FAT12_f_2:
  5564 000016A8 51                      	push	cx
  5565 000016A9 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5566 000016AC E86E03                  	call	write_hd_sector
  5567 000016AF 0F8224FD                	jc	formatting_error
  5568 000016B3 E8D1FC                  	call	write_format_percent
  5569                                  	;add	ax, 1
  5570                                  	;adc	dx, 0
  5571                                  	; 17/03/2021
  5572 000016B6 6640                    	inc	eax ; next sector
  5573 000016B8 59                      	pop	cx
  5574 000016B9 49                      	dec	cx ; dec cl
  5575 000016BA 75EC                    	jnz	short FAT12_f_2
  5576                                  FAT12_f_3:
  5577                                  	; write FAT sectors
  5578                                  	;mov	cx, [data_start] ; lba/abs addr
  5579                                  	;mov	bx, [data_start+2] ; lba/abs addr
  5580                                  	; 17/03/2021
  5581 000016BC 668B16[4E67]            	mov	edx, [data_start] ; lba/abs addr
  5582                                  
  5583                                  	; 11/02/2019
  5584                                  	;sub	cx, [root_dir_secs]
  5585                                  	;sbb	bx, 0
  5586                                  	; 17/03/2021
  5587                                  	;movzx	ebx, word [root_dir_secs]
  5588 000016C1 8B1E[5A67]              	mov	bx, [root_dir_secs]
  5589 000016C5 6629DA                  	sub	edx, ebx
  5590                                  	;push	edx ; ***
  5591                                  
  5592                                  	;push	bx
  5593                                  	;push	cx
  5594 000016C8 BB[4E65]                	mov	bx, HDFORMAT_FATBUFFER
  5595                                  	; ES:BX = FAT Sector Buffer
  5596 000016CB 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  5597 000016CE B5FF                    	mov	ch, 0FFh
  5598 000016D0 890F                    	mov	[bx], cx ; 0FFF8h
  5599 000016D2 886F02                  	mov	[bx+2], ch ; 0FFFFF8h
  5600                                  	;xor	cx, cx
  5601 000016D5 E84503                  	call	write_hd_sector
  5602 000016D8 0F82FBFC                	jc	formatting_error
  5603 000016DC E8A8FC                  	call	write_format_percent
  5604                                  	;mov	bx, HDFORMAT_FATBUFFER
  5605 000016DF B90000                  	mov	cx, 0
  5606 000016E2 890F                    	mov	[bx], cx
  5607 000016E4 884F02                  	mov	[bx+2], cl
  5608 000016E7 EB0D                    	jmp	short FAT12_f_5
  5609                                  FAT12_f_4:	
  5610                                  	;push	bx
  5611                                  	;push	cx	
  5612                                  	; 17/03/2021
  5613                                  	;push	edx ; ***
  5614 000016E9 BB[4E65]                	mov	bx, HDFORMAT_FATBUFFER
  5615 000016EC E82E03                  	call	write_hd_sector
  5616 000016EF 0F82E4FC                	jc	formatting_error
  5617 000016F3 E891FC                  	call	write_format_percent
  5618                                  FAT12_f_5:	
  5619                                  	;pop	cx
  5620                                  	;pop	bx
  5621                                  	; 17/03/2021
  5622                                  	;pop	edx ; ***
  5623                                  	;
  5624                                  	;add	ax, 1
  5625                                  	;adc	dx, 0
  5626                                  	; 17/03/2021
  5627 000016F6 6640                    	inc	eax
  5628                                  	;cmp	dx, bx
  5629                                  	;jb	short FAT12_f_4
  5630                                  	;cmp	ax, cx
  5631                                  	;jb	short FAT12_f_4
  5632 000016F8 6639D0                  	cmp	eax, edx
  5633 000016FB 72EC                    	jb	short FAT12_f_4
  5634                                  
  5635                                  	; write	root directory sectors
  5636                                  	; as empty sectors
  5637 000016FD 8B0E[5A67]              	mov	cx, [root_dir_secs]
  5638                                  FAT12_f_6:
  5639 00001701 51                      	push	cx
  5640 00001702 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  5641 00001705 E81503                  	call	write_hd_sector
  5642 00001708 0F82CBFC                	jc	formatting_error
  5643 0000170C E878FC                  	call	write_format_percent
  5644                                  	;add	ax, 1
  5645                                  	;adc	dx, 0
  5646                                  	; 17/03/2021
  5647 0000170F 6640                    	inc	eax
  5648 00001711 59                      	pop	cx
  5649 00001712 49                      	dec	cx ; dec cl
  5650 00001713 75EC                    	jnz	short FAT12_f_6
  5651                                  
  5652                                  	; write DATA sectors 
  5653                                  	; (after root directory sectors)
  5654 00001715 8B0E[5267]              	mov	cx, [data_sectors]
  5655                                  	;mov	bx, [data_sectors+2]
  5656                                  	;inc	bx ; 11/02/2019
  5657                                  FAT12_f_7:	
  5658                                  	;push	bx
  5659 00001719 51                      	push	cx	
  5660 0000171A BB[3A61]                	mov	bx, HDFORMAT_SECBUFFER
  5661 0000171D E8FD02                  	call	write_hd_sector
  5662 00001720 0F82B3FC                	jc	formatting_error
  5663 00001724 E860FC                  	call	write_format_percent
  5664 00001727 59                      	pop	cx
  5665                                  	;pop	bx
  5666                                  	;add	ax, 1
  5667                                  	;adc	dx, 0
  5668                                  	; 17/03/2021
  5669 00001728 6640                    	inc	eax
  5670 0000172A 49                      	dec	cx
  5671 0000172B 75EC                    	jnz	short FAT12_f_7
  5672                                  	;dec	bx
  5673                                  	;jnz	short FAT12_f_7
  5674                                  
  5675                                  	; If there are, format remain sectors which are
  5676                                  	; at beyond of data clusters, with zero bytes.
  5677                                  	
  5678                                  	;mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  5679                                  	;mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  5680                                  	; 17/03/2021
  5681 0000172D 668B561C                	mov	edx, [bp+1Ch]	; [BPB_HiddSec]
  5682                                  
  5683                                  	;add	cx, [bp+13h]	; [BPB_TotSec16]
  5684                                  	;adc	bx, 0
  5685                                  	; 17/03/2021
  5686                                  	;movzx	ebx, word [bp+13h] ; [BPB_TotSec16]
  5687 00001731 8B5E13                  	mov	bx, [bp+13h]	; [BPB_TotSec16]
  5688 00001734 6601DA                  	add	edx, ebx
  5689                                  
  5690 00001737 E916FB                  	jmp	FAT12_f_8
  5691                                  
  5692                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5693                                  ; SINGLIX FS FORMATTING
  5694                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  5695                                  
  5696                                  	; 20/03/2021
  5697                                  	; 19/03/2021 (fdisk4.s)
  5698                                  SINGLIX_hd_format:
  5699                                  	; 06/01/2018
  5700                                  	; 05/01/2018
  5701                                  	; If Sectors/Track = 17, use CHS+LBA type boot sector
  5702 0000173A 8B1E[B23C]              	mov	bx, [sectors]
  5703 0000173E 83FB11                  	cmp	bx, 17
  5704 00001741 7711                    	ja	short SINGLIX_fs1_f_1
  5705                                  SINGLIX_fs1_f_0:
  5706 00001743 BD[9F38]                	mov	bp, TRDOS_TRFS1_chs_bs
  5707 00001746 887E2D                  	mov	[bp+45], bh ; 0 ; [bs_LBA_Ready] = 0
  5708 00001749 885E2E                  	mov	[bp+46], bl	; [bs_Disk_SecPerTrack]
  5709 0000174C A0[B43C]                	mov	al, [heads]
  5710 0000174F 88462F                  	mov	[bp+47], al	; [bs_Disk_Heads]
  5711 00001752 EB1C                    	jmp	short SINGLIX_fs1_f_3
  5712                                  SINGLIX_fs1_f_1:
  5713                                  	; Sectors per Track = 63
  5714                                  	; If disk capacity >= 63*16*1024 use LBA type boot sector
  5715                                  	; 19/03/2021 (32bit cylinder count <=267349)
  5716 00001754 803E[B83C]00            	cmp	byte [cylinders+2], 0
  5717 00001759 7712                    	ja	short SINGLIX_fs1_f_2
  5718 0000175B 8B0E[B43C]              	mov	cx, [heads]
  5719 0000175F A1[B63C]                	mov	ax, [cylinders]
  5720 00001762 F7E1                    	mul	cx
  5721 00001764 21D2                    	and	dx, dx
  5722 00001766 7505                    	jnz	short SINGLIX_fs1_f_2
  5723 00001768 3D0040                  	cmp	ax, 16384
  5724 0000176B 72D6                    	jb	short SINGLIX_fs1_f_0
  5725                                  SINGLIX_fs1_f_2:	
  5726 0000176D BD[9F3A]                	mov	bp, TRDOS_TRFS1_lba_bs
  5727                                  	;mov	byte [bp+45], 1 ; [bs_LBA_Ready] = 1
  5728                                  SINGLIX_fs1_f_3:	
  5729                                  	;mov	ax, [pp_Sectors]
  5730                                  	;mov	dx, [pp_Sectors+2]
  5731                                  	; 16/02/2019
  5732                                  	;mov	ax, [ppn_Sectors]
  5733                                  	;mov	dx, [ppn_Sectors+2]
  5734                                  
  5735                                  	; 19/03/2021
  5736 00001770 66A1[0C6A]              	mov	eax, [ppn_Sectors]
  5737                                  	;mov	[bp+16], ax	; [bsVolumeSize]
  5738                                  	;mov	[bp+18], dx	; [bsVolumeSize+2]
  5739 00001774 66894610                	mov	[bp+16], eax	; [bsVolumeSize]
  5740                                  	;mov	cx, [pp_StartSector]
  5741                                  	;mov	bx, [pp_StartSector+2]
  5742 00001778 668B16[D469]            	mov	edx, [pp_StartSector] 
  5743                                  	;mov	[bp+12], cx	; [bsBeginSector]
  5744                                  	;mov	[bp+14], bx	; [bsBeginSector+2]
  5745 0000177D 6689560C                	mov	[bp+12], edx	; [bsBeginSector]
  5746                                  
  5747 00001781 C6462C80                	mov	byte [bp+44], 80h ; [bsDriveNumber]  ; hd0
  5748                                  
  5749                                  	; Prepare MAT
  5750                                  	;mov	[MAT_VolumeSize], ax ; Total Sectors of the FS
  5751                                  	;mov	[MAT_VolumeSize+2], dx
  5752                                  	; 19/03/2021
  5753 00001785 66A3[B467]              	mov	[MAT_VolumeSize], eax ; Total Sectors of the FS
  5754                                  	;mov	[MAT_BeginSector], cx ; Beginning Sector of the FS
  5755                                  	;mov	[MAT_BeginSector+2], bx
  5756 00001789 668916[B867]            	mov	[MAT_BeginSector], edx ; Beginning Sector of the FS
  5757                                  
  5758                                  	;mov	cx, [bp+24]	; [bsMATLocation]
  5759                                  	;mov	bx, [bp+26]	; [bsMATLocation+2]
  5760                                  	;add	cx, 1
  5761                                  	;adc	bx, 0
  5762                                  	; Note: (as Default) MAT Address = 1, DAT Address = 2
  5763                                  	;mov	cx, 2
  5764                                  	; 19/03/2021
  5765 0000178E 6631D2                  	xor	edx, edx
  5766 00001791 B202                    	mov	dl, 2
  5767                                  	
  5768                                  	;xor	bx, bx ; 0
  5769                                  	;mov	[bp+24], cx	; [bsMATLocation]
  5770                                  	;mov	[bp+26], bx	; [bsMATLocation+2]
  5771                                  	;mov	[DAT_Address], cx
  5772                                  	;;mov	[DAT_Address+2], bx
  5773                                  	; 19/03/2021
  5774                                  	;mov	[DAT_Address], dx
  5775 00001793 8816[BC67]              	mov	[DAT_Address], dl
  5776                                  
  5777                                  	; DX_AX = FS1 Volume Size
  5778                                  	;add	ax, 7 ; 7 bits more (for round up)
  5779                                  	;adc	dx, 0
  5780                                  	; 19/03/2021
  5781                                  	; EAX = FS1 Volume Size	
  5782 00001797 6683C007                	add	eax, 7 ; 7 bits more (for round up)
  5783 0000179B 30D2                    	xor	dl, dl ; edx = 0
  5784                                  	;mov	cx, 8 ;  1 DAT byte == 8 sectors
  5785                                  	;call	div32
  5786                                  	; DX_AX = DAT bytes
  5787                                  	; 19/03/2021
  5788 0000179D 6631C9                  	xor	ecx, ecx
  5789 000017A0 B108                    	mov	cl, 8
  5790 000017A2 66F7F1                  	div	ecx
  5791                                  	; eax = DAT bytes
  5792                                  
  5793 000017A5 B9FF01                  	mov	cx, 511
  5794                                  	;add	ax, cx
  5795                                  	;adc	dx, 0
  5796                                  	; 19/03/2021
  5797 000017A8 6601C8                  	add	eax, ecx
  5798                                  	
  5799                                  	;inc	cx ; 512
  5800                                  	;call	div32
  5801                                  	; DX_AX = DAT sectors (DX must be 0 for volume sizes < 128GB)
  5802                                  	; 19/03/2021	
  5803 000017AB 41                      	inc	cx  ; ecx = 512 
  5804 000017AC 66F7F1                  	div	ecx	
  5805                                  
  5806                                  	;mov	[DAT_SectorCount], ax
  5807                                  	;mov	[DAT_SectorCount+2], dx ; 0
  5808                                  	; 20/03/2021
  5809 000017AF 66A3[C067]              	mov	[DAT_SectorCount], eax
  5810                                  
  5811                                  	;add	ax, 2  ; BS + MAT
  5812                                  	;adc	dx, 0
  5813                                  	;mov	[bp+28], ax  ; [bsRootDirDT] ; RDT address (offset)
  5814                                  	;mov	[bp+30], dx
  5815                                  	; 20/03/2021
  5816 000017B3 6683C002                	add	eax, 2
  5817 000017B7 6689461C                	mov	[bp+28], eax  ; [bsRootDirDT] ; RDT address (offset)
  5818                                  
  5819                                  	; Free Sectors = Total Sectors - (BS+MAT+DATsects+RDT+4)
  5820                                  	;add	ax, 5 ; DATsects + (BS+MAT+RDT+4)
  5821                                  	;;mov	dx, ax ; ? ;
  5822                                  	;adc 	dx, 0
  5823                                  	; 20/03/2021
  5824 000017BB 6683C005                	add	eax, 5
  5825                                  	;mov	cx, [MAT_VolumeSize]
  5826                                  	;mov	bx, [MAT_VolumeSize+2]
  5827                                  	;sub	cx, ax
  5828                                  	;sbb	bx, 0
  5829                                  	;mov	[MAT_FreeSectors], cx
  5830                                  	;mov	[MAT_FreeSectors+2], bx
  5831                                  	;mov	[MAT_FirstFreeSector], ax
  5832                                  	;mov	[MAT_FirstFreesector+2], dx
  5833                                  	; 20/03/2021
  5834 000017BF 668B16[B467]            	mov	edx, [MAT_VolumeSize]
  5835 000017C4 6629C2                  	sub	edx, eax
  5836 000017C7 668916[C467]            	mov	[MAT_FreeSectors], edx
  5837 000017CC 66A3[C867]              	mov	[MAT_FirstFreeSector], eax
  5838                                   
  5839 000017D0 BF[6467]                	mov	di, fs_volume_name
  5840 000017D3 E89CFA                  	call	write_fs_volume_name
  5841 000017D6 BE[A467]                	mov	si, fs_volume_serial
  5842 000017D9 E8FCFA                  	call	write_volume_serial
  5843                                  
  5844                                  	; Modify FS volume name
  5845                                  	; (Convert 20h tail bytes to 0)
  5846 000017DC B94000                  	mov	cx, 64 
  5847 000017DF BE[6467]                	mov	si, fs_volume_name
  5848 000017E2 31DB                    	xor	bx, bx
  5849 000017E4 B0FF                    	mov	al, 0FFh
  5850                                  modify_fs_vname_1:	
  5851 000017E6 88C4                    	mov	ah, al
  5852 000017E8 AC                      	lodsb
  5853 000017E9 3C20                    	cmp	al, 20h
  5854 000017EB 7708                    	ja	short modify_fs_vname_2
  5855 000017ED 80FC20                  	cmp	ah, 20h
  5856 000017F0 7603                    	jna	short modify_fs_vname_2
  5857 000017F2 89F3                    	mov	bx, si
  5858 000017F4 4B                      	dec	bx
  5859                                  modify_fs_vname_2:
  5860 000017F5 E2EF                    	loop	modify_fs_vname_1
  5861 000017F7 09DB                    	or	bx, bx
  5862 000017F9 740B                    	jz	short modify_fs_vname_3
  5863 000017FB 89DF                    	mov	di, bx
  5864 000017FD B9[A467]                	mov	cx, fs_volume_name+64
  5865 00001800 29D9                    	sub	cx, bx
  5866 00001802 30C0                    	xor	al, al
  5867 00001804 F3AA                    	rep	stosb 
  5868                                  
  5869                                  modify_fs_vname_3:
  5870 00001806 E856FB                  	call	write_formatting_msg
  5871 00001809 B000                    	mov	al, 0
  5872 0000180B E8B3FB                  	call	write_format_percent_x
  5873                                  
  5874                                  	;mov	ax, [bp+12]	; [bsBeginSector]
  5875                                  	;mov	dx, [bp+14]	; [bsBeginSector+2]
  5876                                  	; 20/03/2021
  5877 0000180E 668B460C                	mov	eax, [bp+12]	; [bsBeginSector]
  5878                                  
  5879                                  	; DX_AX = TRFS1 Boot Sector address
  5880 00001812 89EB                    	mov	bx, bp
  5881                                  	; ES:BX = Boot Sector Buffer
  5882 00001814 E80602                  	call	write_hd_sector
  5883 00001817 0F82BCFB                	jc	formatting_error
  5884                                  	
  5885                                  	;add	ax, 1
  5886                                  	;adc	dx, 0
  5887                                  	; 20/03/2021
  5888 0000181B 6640                    	inc	eax
  5889                                  
  5890                                  	; DX_AX = MAT (DAT header) sector address
  5891 0000181D BB[B067]                	mov	bx, FS_MAT_Buffer
  5892                                  	; 16/02/2019
  5893 00001820 C7074D41                	mov	word [bx],'MA'
  5894 00001824 C6470254                	mov	byte [bx+2],'T'
  5895 00001828 E8F201                  	call	write_hd_sector
  5896 0000182B 0F82A8FB                	jc	formatting_error
  5897 0000182F E898FB                  	call	write_fs_format_percent
  5898                                  
  5899                                  	; Calculate DAT bits 
  5900                                  	; NOTE: 4096 bits per DAT sector
  5901                                  	;mov	ax, [MAT_FirstFreeSector]
  5902                                  	;mov	dx, [MAT_FirstFreeSector+2]
  5903                                  	;;xor	dx, dx
  5904                                  	; 20/03/2021
  5905 00001832 66A1[C867]              	mov	eax, [MAT_FirstFreeSector]
  5906 00001836 6631D2                  	xor	edx, edx
  5907                                  
  5908                                  	;push	dx
  5909                                  	;push	ax
  5910                                  	; 20/03/2021
  5911 00001839 6650                    	push	eax
  5912 0000183B B90010                  	mov	cx, 4096
  5913                                  	;call	div32
  5914                                  	;20/03/2021
  5915 0000183E 66F7F1                  	div	ecx
  5916                                  	;mov	[DAT_FFBit], bx
  5917                                  	;mov	[DAT_FFSector], ax
  5918                                  	;mov	[DAT_FFSector+2], dx
  5919                                  	; 20/03/2021
  5920 00001841 8916[A867]              	mov	[DAT_FFBit], dx
  5921 00001845 66A3[AA67]              	mov	[DAT_FFSector], eax	
  5922                                  	;pop	ax
  5923                                  	;pop	dx
  5924                                  	;sub	ax, 1
  5925                                  	;sbb	dx, 0
  5926                                  	; 20/03/2021
  5927 00001849 6658                    	pop	eax
  5928 0000184B 6648                    	dec	eax	
  5929                                  
  5930                                  	;add	ax, [MAT_FreeSectors]
  5931                                  	;adc	dx, [MAT_FreeSectors+2]
  5932                                  	;call	div32
  5933                                  	;mov	[DAT_LFBit], bx
  5934                                  	;mov	[DAT_LFSector], ax
  5935                                  	; 20/03/2021
  5936 0000184D 31D2                    	xor	dx, dx
  5937 0000184F 660306[C467]            	add	eax, [MAT_FreeSectors]
  5938 00001854 66F7F1                  	div	ecx
  5939 00001857 8916[AC67]              	mov	[DAT_LFBit], dx
  5940 0000185B 66A3[AE67]              	mov	[DAT_LFSector], eax
  5941                                  
  5942                                  	;xor	si, si ; 0
  5943                                  	; 20/03/2021
  5944 0000185F 6631F6                  	xor	esi, esi ; 0
  5945                                  SINGLIX_fs1_f_4:
  5946                                  	; calculate free bits for current DAT sector
  5947                                  	;			(to be written)
  5948 00001862 BF[CC67]                	mov	di, FS_DAT_Buffer
  5949                                  
  5950                                  	; 20/03/2021
  5951                                  	;cmp	si, [DAT_FFSector]
  5952 00001865 663B36[AA67]            	cmp	esi, [DAT_FFSector]
  5953 0000186A 7433                    	je	short SINGLIX_fs1_f_7
  5954 0000186C 724F                    	jb	short SINGLIX_fs1_f_9
  5955                                  	
  5956                                  	;cmp	si, [DAT_LFSector]
  5957 0000186E 663B36[AE67]            	cmp	esi, [DAT_LFSector]
  5958 00001873 7225                    	jb	short SINGLIX_fs1_f_6
  5959 00001875 7746                    	ja	short SINGLIX_fs1_f_9
  5960                                  
  5961                                  	; 20/03/2021
  5962 00001877 8B0E[AC67]              	mov	cx, [DAT_LFBit]
  5963 0000187B 88CC                    	mov	ah, cl
  5964 0000187D C1E903                   	shr	cx, 3 ; bit count to byte count
  5965 00001880 7404                    	jz	short SINGLIX_fs1_f_5
  5966                                  	;Example:
  5967                                  	;last free sector = 47 -> byte 5, bit 7
  5968                                  	;last free sector = 48 -> byte 6, bit 0
  5969                                  	; (also previous sectors are free sectors)
  5970 00001882 B0FF                    	mov	al, 0FFh ; 20/03/2021
  5971                                  	;mov	cx, bx
  5972 00001884 F3AA                    	rep	stosb
  5973                                  	; 20/03/2021
  5974                                  	;mov	di, FS_DAT_Buffer
  5975                                  	;add	di, bx
  5976                                  SINGLIX_fs1_f_5:
  5977 00001886 80E407                  	and	ah, 7
  5978                                  	;mov	cl, ah
  5979                                  	;shl	al, cl
  5980                                  	;not	al
  5981                                  	; 20/03/2021
  5982 00001889 30C0                    	xor	al, al
  5983                                  SINGLIX_fs1_f_13:
  5984                                  	; 20/03/2021 
  5985                                  	; 0 -> 00000001b (last free bit is bit 0)
  5986                                  	; 1 -> 00000011b (last free bit is bit 1)
  5987                                  	; 7 -> 11111111b (last free bit is bit 7)
  5988 0000188B 0C01                    	or	al, 1
  5989 0000188D 08E4                    	or	ah, ah
  5990 0000188F 7406                    	jz	short SINGLIX_fs1_f_14
  5991 00001891 D0E0                    	shl	al, 1
  5992 00001893 FECC                    	dec	ah
  5993 00001895 EBF4                    	jmp	short SINGLIX_fs1_f_13
  5994                                  SINGLIX_fs1_f_14:
  5995 00001897 AA                      	stosb
  5996                                  	;mov	cx, 511
  5997                                  	;sub	cx, bx
  5998                                  	;jna	short SINGLIX_fs1_f_9
  5999                                  	;mov	al, 0 ; out of volume bits (=0)
  6000                                  	;rep	stosb
  6001 00001898 EB23                    	jmp	short SINGLIX_fs1_f_9
  6002                                  SINGLIX_fs1_f_6:
  6003 0000189A B90002                  	mov	cx, 512
  6004 0000189D EB1A                    	jmp	short SINGLIX_fs1_f_8
  6005                                  SINGLIX_fs1_f_7:
  6006                                  	; 20/03/2021
  6007                                  	;Example:
  6008                                  	;first free sector = 23 -> byte 2, bit 7
  6009                                  	;first free sector = 24 -> byte 3, bit 0
  6010                                  	; (previous sectors are allocated sectors)
  6011 0000189F 8B1E[A867]              	mov	bx, [DAT_FFBit]
  6012 000018A3 88D9                    	mov	cl, bl
  6013 000018A5 80E107                  	and	cl, 7
  6014 000018A8 C1EB03                  	shr	bx, 3 ; from bits to bytes
  6015 000018AB 01DF                    	add	di, bx
  6016 000018AD B0FF                    	mov	al, 0FFh
  6017 000018AF D2E0                    	shl	al, cl
  6018 000018B1 AA                      	stosb
  6019 000018B2 B9FF01                  	mov	cx, 511
  6020 000018B5 29D9                    	sub	cx, bx
  6021 000018B7 7604                    	jna	short SINGLIX_fs1_f_9
  6022                                  SINGLIX_fs1_f_8:
  6023 000018B9 B0FF                    	mov	al, 0FFh ; Free sector bits (=1)
  6024 000018BB F3AA                    	rep	stosb
  6025                                  SINGLIX_fs1_f_9:
  6026                                  	;mov	ax, [MAT_BeginSector]
  6027                                  	;mov	dx, [MAT_BeginSector+2]
  6028                                  	;;add	ax, [DAT_Address] ; = 2
  6029                                  	;;adc	dx, [DAT_Address+2]
  6030                                  	;add	ax, 2
  6031                                  	;adc	dx, 0
  6032                                  	;add	ax, si
  6033                                  	;adc	dx, 0
  6034                                  	; 20/03/2021
  6035 000018BD 66A1[B867]              	mov	eax, [MAT_BeginSector]
  6036 000018C1 6683C002                	add	eax, 2 ; [DAT_Address] = 2
  6037 000018C5 6601F0                  	add	eax, esi
  6038                                  
  6039                                  	; Write DAT sector(s)
  6040                                  	;; DX_AX = Disk Allocation Table sector address
  6041                                  	; EAX = Disk Allocation Table sector address
  6042 000018C8 BB[CC67]                	mov	bx, FS_DAT_Buffer
  6043 000018CB E84F01                  	call	write_hd_sector
  6044 000018CE 0F8205FB                	jc	formatting_error
  6045 000018D2 E8F5FA                  	call	write_fs_format_percent
  6046                                  	; Clear DAT buffer again (for next stage)
  6047 000018D5 B90001                  	mov	cx, 256
  6048 000018D8 BF[CC67]                	mov	di, FS_DAT_Buffer
  6049 000018DB 29C0                    	sub	ax, ax
  6050 000018DD F3AB                    	rep	stosw
  6051                                  
  6052                                  	;inc	si
  6053                                  	;
  6054                                  	;cmp	si, [DAT_SectorCount]
  6055                                  	;jna	SINGLIX_fs1_f_4
  6056                                  
  6057                                  	; 20/03/2021
  6058 000018DF 6646                    	inc	esi
  6059 000018E1 663B36[C067]            	cmp	esi, [DAT_SectorCount]
  6060 000018E6 0F8678FF                	jna	SINGLIX_fs1_f_4
  6061                                  	
  6062                                  	; 20/03/2021
  6063 000018EA 6631F6                  	xor esi, esi
  6064                                  
  6065                                  	; ;;;
  6066                                  	
  6067                                  	; DAT sectors has been written..
  6068                                  	; Now, Root Directory Description Table is in order
  6069                                  
  6070 000018ED BF[CC67]                	mov	di, FS_RDT_Buffer
  6071 000018F0 B84444                  	mov	ax, 'DD' 
  6072 000018F3 AB                      	stosw
  6073 000018F4 30E4                    	xor	ah, ah
  6074 000018F6 B054                    	mov	al, 'T'
  6075 000018F8 AB                      	stosw
  6076 000018F9 B80002                  	mov	ax, 512 ; Sector size (Bytes per sector)
  6077 000018FC AB                      	stosw
  6078 000018FD 31C0                    	xor	ax, ax ; RDT sequence number (= 0, section 1)
  6079 000018FF AB                      	stosw	
  6080                                  	; RDT address
  6081                                  	;mov	ax, [DAT_SectorCount]
  6082                                  	;mov	dx, [DAT_SectorCount+2]
  6083                                  	;add	ax, 2 ; BS + MAT
  6084                                  	;adc	dx, 0
  6085                                  	;stosw
  6086                                  	;mov	ax, dx
  6087                                  	;stosw
  6088                                  	; 20/03/2021
  6089 00001900 66A1[C067]              	mov	eax, [DAT_SectorCount]
  6090 00001904 6683C002                	add	eax, 2 ; BS + MAT
  6091 00001908 66AB                    	stosd
  6092                                  
  6093                                  	;sub	ax, ax ; Next RDT number
  6094                                  	;stosw
  6095                                  	;stosw
  6096                                  	; 20/03/2021
  6097 0000190A 6629C0                  	sub	eax, eax
  6098 0000190D 66AB                    	stosd
  6099                                  
  6100                                  	;mov	ax, 4 ; Sector count of this section
  6101                                  	;	      ; (4*512)/4 = 512 root dir entries
  6102                                  	;stosw
  6103                                  	; 20/03/2021
  6104 0000190F B004                    	mov	al, 4
  6105                                  	;stosw
  6106                                  	;xor	al, al
  6107                                  	;stosw
  6108 00001911 66AB                    	stosd
  6109                                  
  6110                                  	; Volume beginning sector
  6111                                  	;mov	ax, [bp+12]	; [bsBeginSector]
  6112                                  	;mov	dx, [bp+14]	; [bsBeginSector+2]
  6113                                  	;stosw
  6114                                  	;mov	ax, dx
  6115                                  	;stosw
  6116                                  	; 20/03/2021
  6117 00001913 668B460C                	mov	eax, [bp+12]	; [bsBeginSector]
  6118 00001917 66AB                    	stosd
  6119                                  
  6120                                  	;xor	ax, ax
  6121                                  	;dec	ax ; 0FFFFh
  6122                                  	;; Parent Dir Serial (= FFFFFFFFh for root dir)
  6123                                  	;stosw
  6124                                  	;stosw
  6125                                  	; 20/03/2021
  6126 00001919 6631C0                  	xor	eax, eax ; 0
  6127 0000191C 6648                    	dec	eax ; 0FFFFFFFFh
  6128                                  	; Parent Dir Serial (= FFFFFFFFh for root dir) 
  6129 0000191E 66AB                    	stosd
  6130 00001920 6640                    	inc	eax
  6131                                  	; eax = 0
  6132                                  set_fs_volume_serial_number:
  6133 00001922 BE[A467]                	mov	si, fs_volume_serial
  6134 00001925 A5                      	movsw
  6135 00001926 A5                      	movsw
  6136                                  
  6137                                  	; 20/03/2021
  6138                                  	;sub	ax, ax
  6139                                  	;stosb	; sub directory level = 0
  6140                                  	;stosb	; 0, reserved
  6141 00001927 AB                      	stosw
  6142 00001928 B004                    	mov	al, 00000100b ;  (DOS) System attribute
  6143 0000192A AA                      	stosb	; (DOS) Basic attributes
  6144 0000192B 28C0                    	sub	al, al ; Extended attributes (0 for TRDOS 386)
  6145 0000192D AA                      	stosb
  6146                                  	; 20/03/2021
  6147                                  	;sub	ax, ax ; reserved (8) bytes for TR-MULTIX
  6148 0000192E AB                      	stosw
  6149 0000192F AB                      	stosw
  6150 00001930 AB                      	stosw
  6151 00001931 AB                      	stosw
  6152 00001932 B85254                  	mov	ax, 'RT' ; TRFS Root directory signature
  6153 00001935 AB                      	stosw
  6154 00001936 31C0                    	xor	ax, ax ; Country (language, date, text format)
  6155                                  		       ; (0 = Default, 1 = USA, 90 = Turkiye)
  6156                                  	;stosb
  6157                                  	;stosb	; Time Zone (0 = GMT = default ; -11 to +12)
  6158 00001938 AB                      	stosw
  6159                                  
  6160 00001939 89FE                    	mov	si, di
  6161                                  	; get the date (from RTC)
  6162 0000193B B404                    	mov	ah, 4
  6163 0000193D CD1A                    	int	1Ah
  6164                                  	; Creating Date (of root directory)
  6165 0000193F 86E9                    	xchg	ch, cl ; 07/01/2018
  6166 00001941 89C8                    	mov	ax, cx ; cl = century (BCD), ch = year (BCD)
  6167 00001943 AB                      	stosw
  6168 00001944 88F0                    	mov	al, dh  ; month (BCD)
  6169 00001946 AA                      	stosb
  6170 00001947 88D0                    	mov	al, dl  ; day (BCD)
  6171 00001949 AA                      	stosb
  6172                                  	; get the time (from RTC)
  6173 0000194A B402                    	mov	ah, 2
  6174 0000194C CD1A                    	int	1Ah
  6175                                  	; Creating Time (of root directory)
  6176 0000194E 86CD                    	xchg	cl, ch ; ch = hour (BCD), cl = minute (BSD)
  6177 00001950 89C8                    	mov	ax, cx ; al = hour, ah = minute
  6178 00001952 AB                      	stosw
  6179 00001953 88F0                    	mov	al, dh ; seconds (BCD)
  6180 00001955 AA                      	stosb
  6181 00001956 88D0                    	mov	al, dl ; daylight savings time option
  6182 00001958 AA                      	stosb
  6183                                  	; Set Last Modification Date&Time
  6184 00001959 B90400                  	mov	cx, 4
  6185 0000195C F3A5                    	rep	movsw ; copy creating date&time values to
  6186                                  		; last modification date time values
  6187                                  		; (last modif date&time = creating date&time)
  6188                                  
  6189                                  set_fs_volume_name:
  6190 0000195E BE[6467]                	mov	si, fs_volume_name
  6191 00001961 B120                    	mov	cl, 32 
  6192 00001963 F3A5                    	rep	movsw
  6193                                  
  6194                                  	; Fill remain bytes (of this RDT) with zero
  6195 00001965 B9C000                  	mov	cx, (128+256)/2
  6196 00001968 31C0                    	xor	ax, ax
  6197 0000196A F3AB                    	rep	stosw
  6198                                  
  6199                                  	; RDT is ready here...
  6200                                  
  6201                                  	;mov	ax, [bp+28]	; [bsRootDirDT]
  6202                                  	;mov	dx, [bp+30]	; [bsRootDirDT+2]
  6203                                  	;;xor	dx, dx
  6204                                  	;add	ax, [bp+12]	; [bsBeginSector]
  6205                                  	;adc	dx, [bp+14]	; [bsBeginSector+2]
  6206                                  	; 20/03/2021
  6207 0000196C 668B461C                	mov	eax, [bp+28]	; [bsRootDirDT]
  6208 00001970 6603460C                	add	eax, [bp+12]	; [bsBeginSector]
  6209                                  
  6210                                  	; Write RDT sector
  6211                                  	;; DX_AX = Root Directory Description Table address
  6212                                  	; EAX = Root Directory Description Table address
  6213 00001974 BB[CC67]                	mov	bx, FS_RDT_Buffer
  6214 00001977 E8A300                  	call	write_hd_sector
  6215 0000197A 0F8259FA                	jc	formatting_error
  6216 0000197E E849FA                  	call	write_fs_format_percent
  6217                                  
  6218                                  	;add	ax, 1
  6219                                  	;adc	dx, 0
  6220                                  	; 20/03/2021
  6221 00001981 6640                    	inc	eax
  6222                                  
  6223                                  	; write root directory data sectors
  6224                                  	;mov	cx, 4
  6225                                  	; 20/03/2021
  6226 00001983 B104                    	mov	cl, 4
  6227                                  SINGLIX_fs1_f_10:
  6228 00001985 51                      	push	cx
  6229                                  	; Write root directory sector(s)
  6230                                  	; DX_AX = Root Directory Sector address
  6231 00001986 BB[4E65]                	mov	bx, HDFORMAT_EMPTY_BUFF
  6232 00001989 E89100                  	call	write_hd_sector
  6233 0000198C 0F8247FA                	jc	formatting_error
  6234 00001990 E837FA                  	call	write_fs_format_percent
  6235                                  	;add	ax, 1
  6236                                  	;adc	dx, 0
  6237                                  	; 20/03/2021
  6238 00001993 6640                    	inc	eax
  6239 00001995 59                      	pop	cx
  6240 00001996 FEC9                    	dec	cl
  6241 00001998 75EB                    	jnz	short SINGLIX_fs1_f_10
  6242                                  
  6243                                  	; Fill remain sectors with 'F6h' bytes
  6244                                  	;mov	cx, [bp+16]	; [bsVolumeSize]
  6245                                  	;mov	bx, [bp+18]	; [bsVolumeSize+2]
  6246                                  	;add	cx, [bp+12]	; [bsBeginSector]
  6247                                  	;adc	bx, [bp+14]	; [bsBeginSector+2]
  6248                                  	; 20/03/2021
  6249 0000199A 668B5610                	mov	edx, [bp+16]	; [bsVolumeSize]
  6250 0000199E 6603560C                	add	edx, [bp+12]	; [bsBeginSector]
  6251                                  
  6252                                  	; write DATA sectors 
  6253                                  	; (after root directory sectors)
  6254                                  SINGLIX_fs1_f_11:
  6255                                  	;push	bx
  6256                                  	;push	cx
  6257                                  	; 20/03/2021
  6258                                  	;push	edx ; *
  6259 000019A2 BB[3A61]                	mov	bx, HDFORMAT_SECBUFFER
  6260 000019A5 E87500                  	call	write_hd_sector
  6261 000019A8 0F822BFA                	jc	formatting_error
  6262 000019AC E8D8F9                  	call	write_format_percent
  6263                                  	;pop	cx
  6264                                  	;pop	bx
  6265                                  	; 20/03/2021
  6266                                  	;pop	edx ; *
  6267                                  	
  6268                                  	;add	ax, 1
  6269                                  	;adc	dx, 0
  6270                                  	; 20/03/2021
  6271 000019AF 6640                    	inc	eax	
  6272                                  
  6273                                  	;cmp	dx, bx
  6274                                  	;jb	short SINGLIX_fs1_f_11
  6275                                  	;ja	SINGLIX_fs1_f_12
  6276                                  	;cmp	ax, cx
  6277                                  	;jb	short SINGLIX_fs1_f_11
  6278                                  	; 20/03/2021
  6279 000019B1 6639D0                  	cmp	eax, edx
  6280 000019B4 72EC                    	jb	short SINGLIX_fs1_f_11
  6281                                  
  6282                                  	; 20/03/2021
  6283                                  	; (this may not be needed)
  6284                                  	; (but cleaering hw of 32 bit regs may be useful)) 
  6285 000019B6 6631D2                  	xor	edx, edx 
  6286 000019B9 6631C0                  	xor	eax, eax
  6287                                  
  6288 000019BC E9A8F8                  	jmp	SINGLIX_fs1_f_12
  6289                                  
  6290                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6291                                  ; print messages
  6292                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6293                                  
  6294                                  print_msg:
  6295                                  
  6296                                  print_msg_LOOP:
  6297 000019BF AC                      	lodsb                           ; Load byte at DS:SI to AL
  6298 000019C0 20C0                    	and     al, al
  6299 000019C2 7409                    	jz      short print_msg_OK
  6300 000019C4 B40E                    	mov	ah, 0Eh
  6301 000019C6 BB0700                  	mov     bx, 07h
  6302 000019C9 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  6303                                  					; Write char as TTY
  6304                                  					; AL-char BH-page BL-color
  6305 000019CB EBF2                    	jmp     short print_msg_LOOP
  6306                                  
  6307                                  print_msg_OK:
  6308 000019CD C3                      	retn
  6309                                  
  6310                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6311                                  ; reading a block (sector) on hard disk
  6312                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6313                                  ; 17/10/2020
  6314                                  
  6315                                  	; 09/03/2021 (fdisk4.s)
  6316                                  read_hd_sector:
  6317                                  
  6318                                  	; INPUT -> DX_AX = Logical Block Address
  6319                                  	; 	   ES:BX = Sector Buffer
  6320                                  	; OUTPUT ->
  6321                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  6322                                  	;	     ES:BX = Sector Buffer
  6323                                  	;  cf = 1 -> AH = Error Number
  6324                                  
  6325                                  	; 09/03/2021
  6326                                  	; INPUT -> EAX = Logical Block Address
  6327                                  	; 	   ES:BX = Sector buffer
  6328                                  
  6329                                  	;cmp	dx, [chs_limit+2]
  6330                                  	;ja	short read_lba_sector
  6331                                  	;jb	short read_chs_sector
  6332                                  	;cmp	ax, [chs_limit]
  6333                                  	;ja	short read_lba_sector
  6334                                  	;;jmp	short read_chs_sector
  6335                                  
  6336                                  	; 09/03/2021
  6337 000019CE 663B06[4665]            	cmp	eax, [chs_limit]
  6338 000019D3 7707                    	ja	short read_lba_sector
  6339                                  
  6340                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6341                                  ; reading a block (sector) by using CHS read (ROMBIOS) function
  6342                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6343                                  ; 17/10/2020
  6344                                  
  6345                                  read_chs_sector:
  6346                                  	; hdformat.s (25/09/2020)
  6347 000019D5 C606[4065]02            	mov	byte [rw], 2 ; read
  6348 000019DA EB4D                    	jmp	short chs_rw
  6349                                  
  6350                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6351                                  ; reading a block (sector) by using LBA read (ROMBIOS) function
  6352                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6353                                  ; 17/10/2020
  6354                                  
  6355                                  read_lba_sector:
  6356                                  	; hdformat.s (25/09/2020)
  6357 000019DC C606[4065]42            	mov	byte [rw], 42h
  6358 000019E1 EB05                    	jmp	short lba_rw
  6359                                  
  6360                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6361                                  ; writing a block (sector) by using LBA write (ROMBIOS) function
  6362                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6363                                  ; 17/10/2020
  6364                                  
  6365                                  	; 18/10/2020 
  6366                                  write_lba_sector:
  6367                                  	; hdformat.s (25/09/2020)
  6368 000019E3 C606[4065]43            	mov	byte [rw], 43h
  6369                                  	;jmp	short lba_rw
  6370                                  lba_rw:
  6371                                  	;mov	di, 5
  6372                                  	; 18/10/2020
  6373 000019E8 C606[4165]05            	mov	byte [rcnt], 5  ; Retry count
  6374                                  lba_rw_1:
  6375                                  	;pusha			; db 60h
  6376 000019ED 60                      	db	60h
  6377                                  	;push 	0		; db 6Ah, 00h
  6378 000019EE 6A00                    	db	6Ah, 0
  6379                                  	;push	0		; db 6Ah, 00h
  6380 000019F0 6A00                    	db	6Ah, 0
  6381                                  	;push	dx
  6382                                  	;push	ax
  6383                                  	; 09/03/2021
  6384 000019F2 6650                    	push	eax
  6385 000019F4 06                      	push    es
  6386 000019F5 53                      	push    bx
  6387                                  	;push	1		; db 6Ah, 01h
  6388 000019F6 6A01                    	db	6Ah, 01h                     
  6389                                  	;push	10h		; db 6Ah, 10h
  6390 000019F8 6A10                    	db	6Ah, 10h
  6391                                  
  6392 000019FA 89E6                    	mov     si, sp
  6393 000019FC 8A16[3E65]              	mov     dl, [DrvNum]
  6394 00001A00 30C0                    	xor	al, al	; verify off 
  6395                                  lba_rw_2:
  6396 00001A02 8A26[4065]              	mov     ah, [rw] ; 42h = LBA read, 43h = LBA write
  6397                                  	;xor	al, al	; verify off 
  6398 00001A06 CD13                    	int     13h
  6399                                  
  6400                                  	;mov	[error], ah
  6401 00001A08 7310                    	jnc     short lba_rw_3
  6402                                  
  6403                                  	;dec	di 
  6404                                  	; 18/10/2020
  6405 00001A0A FE0E[4165]              	dec	byte [rcnt]
  6406 00001A0E 740A                    	jz	short lba_rw_3 
  6407                                          
  6408 00001A10 30E4                    	xor	ah, ah
  6409                                  	;mov	dl, [DrvNum]
  6410 00001A12 CD13                    	int	13h	; BIOS Service func (ah) = 0
  6411                                  			; Reset disk system
  6412                                  
  6413                                  	;mov	word [si+2], 1 ; set r/w count to 1 again
  6414 00001A14 C6440201                	mov	byte [si+2], 1
  6415                                  
  6416 00001A18 EBE8                    	jmp	short lba_rw_2
  6417                                  
  6418                                  lba_rw_3:
  6419                                  	;popa
  6420 00001A1A 61                      	db	61h
  6421                                  	;popa
  6422 00001A1B 61                      	db	61h
  6423 00001A1C C3                      	retn
  6424                                  
  6425                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6426                                  ; writing a block (sector) on hard disk
  6427                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6428                                  ; 17/10/2020
  6429                                  
  6430                                  	; 09/03/2021 (fdisk4.s)
  6431                                  write_hd_sector:
  6432                                  
  6433                                  	; INPUT -> DX_AX = Logical Block Address
  6434                                  	; 	   ES:BX = Sector Buffer
  6435                                  	; OUTPUT ->
  6436                                  	;  cf = 0 -> DX_AX = Logical Block Adress
  6437                                  	;	     ES:BX = Sector Buffer
  6438                                  	;  cf = 1 -> AH = Error Number
  6439                                  
  6440                                  	; 09/03/2021
  6441                                  	; INPUT -> EAX = Logical Block Address
  6442                                  	; 	   ES:BX = Sector buffer
  6443                                  
  6444                                  	;cmp	dx, [chs_limit+2]
  6445                                  	;ja	short write_lba_sector
  6446                                  	;jb	short write_chs_sector
  6447                                  	;cmp	ax, [chs_limit]
  6448                                  	;ja	short write_lba_sector
  6449                                  	;;jmp	short write_chs_sector
  6450                                  
  6451                                  	; 09/03/2021
  6452 00001A1D 663B06[4665]            	cmp	eax, [chs_limit]
  6453 00001A22 77B8                    	ja	short read_lba_sector
  6454                                  
  6455                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6456                                  ; writing a block (sector) by using CHS write (ROMBIOS) function
  6457                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6458                                  ; 17/10/2020
  6459                                  	
  6460                                  	; 18/10/2020
  6461                                  write_chs_sector:
  6462                                  	; hdformat.s (25/09/2020)
  6463 00001A24 C606[4065]03            	mov	byte [rw], 3 ; write
  6464                                  	;jmp	short chs_rw
  6465                                  
  6466                                  	; 09/03/2021
  6467                                  chs_rw:
  6468 00001A29 56                      	push	si
  6469                                          ;push	cx
  6470                                  	; 09/03/2021
  6471 00001A2A 6651                    	push	ecx
  6472                                  chs_rw_0:
  6473                                  	;mov	di, 5
  6474                                  	; 18/10/2020
  6475 00001A2C C606[4165]05            	mov	byte [rcnt], 5  ; Retry count
  6476                                  chs_rw_1:               
  6477                                  	;push	dx	; Linear sector #
  6478                                  	;push	ax	; DX_AX = Linear address (sectors)
  6479                                  	;mov	cx, [sectors]
  6480                                  	;push	bx
  6481                                  	;
  6482                                  	;call	div32	; 32 bit divide
  6483                                  
  6484                                  	; 09/03/2021
  6485 00001A31 6652                    	push	edx
  6486 00001A33 6650                    	push	eax
  6487 00001A35 6631D2                  	xor	edx, edx
  6488 00001A38 6631C9                  	xor	ecx, ecx
  6489 00001A3B 8B0E[B23C]              	mov	cx, [sectors]
  6490 00001A3F 66F7F1                  	div	ecx
  6491 00001A42 42                      	inc	dx
  6492 00001A43 52                      	push	dx  ; sector (1 based)
  6493 00001A44 8B0E[B43C]              	mov	cx, [heads]
  6494 00001A48 66F7F1                  	div	ecx
  6495 00001A4B 88D6                    	mov	dh, dl ; head
  6496 00001A4D 59                      	pop	cx
  6497                                  
  6498                                  	;mov	cx, bx	; Sector (zero based)
  6499                                  	;inc	cx	; To make it 1 based
  6500                                  	;push	cx
  6501                                  	;mov	cx, [heads]
  6502                                  	;call	div32	; Convert track to head & cyl
  6503                                  	;mov	dh, bl	; BX = Head (max. FFh)
  6504                                  	;pop	cx	; AX=Cyl, DH=Head, CX=Sector
  6505                                  	;pop	bx	; ES:BX = Buffer
  6506                                  
  6507 00001A4E 8A16[3E65]              	mov	dl, [DrvNum]
  6508 00001A52 88C5                    	mov	ch, al
  6509 00001A54 D0CC                    	ror	ah, 1	; Rotate right
  6510 00001A56 D0CC                    	ror	ah, 1
  6511 00001A58 08E1                    	or	cl, ah
  6512                                  chs_rw_2:
  6513 00001A5A 8A26[4065]              	mov	ah, [rw] ; 02h = read, 03h = write
  6514 00001A5E B001                    	mov	al, 01h
  6515 00001A60 CD13                    	int	13h	; BIOS Service func (ah) = 2/3
  6516                                  			; Read/Write disk sectors
  6517                                  			; AL-sec num CH-track CL-sec
  6518                                  			; DH-head DL-drive ES:BX-buffer
  6519                                  			; CF-flag AH-status AL-sectors written/read
  6520                                  			; If CF = 1 then AH = Error code (>0)
  6521                                          
  6522 00001A62 730C                    	jnc     short chs_rw_3
  6523                                  	;dec	di
  6524 00001A64 FE0E[4165]              	dec	byte [rcnt] ; 18/10/2020
  6525 00001A68 7406                    	jz	short chs_rw_3 
  6526                                          
  6527 00001A6A 30E4                    	xor	ah, ah
  6528                                  	;mov	dl, [DrvNum]
  6529 00001A6C CD13                    	int	13h	; BIOS Service func (ah) = 0
  6530                                  			; Reset disk system
  6531 00001A6E EBEA                    	jmp	short chs_rw_2
  6532                                  
  6533                                  chs_rw_3:
  6534                                  	;pop	ax
  6535                                  	;pop	dx
  6536                                  	;pop	cx
  6537                                  	; 09/03/2021
  6538 00001A70 6658                    	pop	eax
  6539 00001A72 665A                    	pop	edx
  6540 00001A74 6659                    	pop	ecx
  6541 00001A76 5E                      	pop	si
  6542 00001A77 C3                      	retn
  6543                                  	
  6544                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6545                                  ; convert byte to decimal number
  6546                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6547                                  
  6548                                  	; 16/03/2021 (fdisk4.s)
  6549                                  bin_to_decimal:
  6550                                  	; INPUT: DS:SI = Target location
  6551                                  	;        DX_AX = Binary Number (Integer)
  6552                                  	; OUTPUT: Decimal char at DS:SI
  6553                                  	; 	 SI decremented after every division
  6554                                  	; 	 till AX<10.
  6555                                  	; CX, DX, BX will be changed.
  6556                                  
  6557                                  	; 16/03/2021
  6558                                  	; INPUT:
  6559                                  	;	DS:SI = Target location
  6560                                  	;	EAX = Binary number
  6561                                  	; OUTPUT: Decimal char at DS:SI
  6562                                  	; 	SI decremented after every division
  6563                                  	; 	till EAX<10.
  6564                                  	;
  6565                                  	; Modified regaisters: ecx (=10), edx (<10)
  6566                                  
  6567                                  	;mov	cx, 10
  6568                                  	; 16/03/2021
  6569 00001A78 6631C9                  	xor	ecx, ecx
  6570 00001A7B B10A                    	mov	cl, 10
  6571 00001A7D 6631D2                  	xor	edx, edx
  6572                                  btd_0:
  6573                                  	;; DX_AX = Dividend
  6574                                  	;; CX = Divisor
  6575                                  	;call	div32
  6576                                  	;; DX_AX = Quotient
  6577                                  	;; BX = remainder
  6578                                  	;add	bl, '0'
  6579                                  	;mov	[si], bl
  6580                                  	;and	dx, dx
  6581                                  	;jz	short btd_2
  6582                                  	; 16/03/2021
  6583 00001A80 66F7F1                  	div	ecx
  6584                                  		; eax = quotient
  6585                                  		; dl = remainder
  6586 00001A83 80C230                  	add	dl, '0'
  6587 00001A86 8814                    	mov	[si], dl
  6588 00001A88 6621C0                  	and	eax, eax
  6589 00001A8B 7405                    	jz	short btd_1
  6590                                  ;btd_1:
  6591 00001A8D 4E                      	dec	si
  6592 00001A8E 30D2                    	xor	dl, dl ; 16/03/2021
  6593 00001A90 EBEE                    	jmp	short btd_0
  6594                                  ;btd_2:
  6595                                  	;or	ax, ax
  6596                                  	;jnz	short btd_1
  6597                                  btd_1:
  6598 00001A92 C3                      	retn
  6599                                  
  6600                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6601                                  ; convert byte to hexadecimal number
  6602                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6603                                  
  6604                                  byte_to_hex: ; 04/02/2019
  6605                                  bin_to_hex:
  6606                                  	; INPUT ->
  6607                                  	; 	AL = byte (binary number)
  6608                                  	; OUTPUT ->
  6609                                  	;	AX = hexadecimal string
  6610                                  	;
  6611 00001A93 53                      	push	bx
  6612 00001A94 31DB                    	xor	bx, bx
  6613 00001A96 88C3                    	mov	bl, al
  6614 00001A98 C0EB04                  	shr	bl, 4
  6615 00001A9B 8A9F[A03C]              	mov	bl, [bx+hexchrs]
  6616 00001A9F 86D8                    	xchg	bl, al
  6617 00001AA1 80E30F                  	and	bl, 0Fh
  6618 00001AA4 8AA7[A03C]              	mov	ah, [bx+hexchrs]
  6619 00001AA8 5B                      	pop	bx	
  6620 00001AA9 C3                      	retn
  6621                                  
  6622                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6623                                  ; read & write characters
  6624                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6625                                  
  6626                                  rw_char:
  6627                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  6628 00001AAA BE[C951]                	mov     si, StrVolumeName
  6629 00001AAD BB0700                  	mov     bx, 7
  6630 00001AB0 B403                    	mov     ah, 3
  6631 00001AB2 CD10                    	int     10h
  6632 00001AB4 8916[B051]              	mov     [Cursor_Pos], dx
  6633                                  read_next_char:
  6634 00001AB8 30E4                    	xor     ah, ah
  6635 00001ABA CD16                    	int     16h
  6636 00001ABC 20C0                    	and     al, al
  6637 00001ABE 7439                    	jz      short loc_arrow
  6638 00001AC0 3CE0                    	cmp     al, 0E0h
  6639 00001AC2 7435                    	je      short loc_arrow
  6640 00001AC4 3C08                    	cmp     al, 8
  6641 00001AC6 753D                    	jne     short char_return
  6642                                  loc_back:
  6643 00001AC8 B403                    	mov     ah, 3
  6644 00001ACA CD10                    	int     10h
  6645 00001ACC 3A16[B051]              	cmp     dl, byte [Cursor_Pos]
  6646 00001AD0 761F                    	jna     short loc_beep
  6647                                  prev_column:
  6648 00001AD2 FECA                    	dec     dl
  6649                                  set_cursor_pos:
  6650 00001AD4 B402                    	mov     ah, 2
  6651 00001AD6 CD10                    	int     10h
  6652 00001AD8 88D3                    	mov     bl, dl
  6653 00001ADA 2A1E[B051]              	sub     bl, byte [Cursor_Pos]
  6654 00001ADE B90100                  	mov     cx, 1
  6655 00001AE1 B409                    	mov     ah, 9
  6656 00001AE3 B020                    	mov     al, 20h
  6657 00001AE5 8800                    	mov     [si+bx], al
  6658                                  loc_write_it:
  6659 00001AE7 B307                    	mov     bl, 7
  6660 00001AE9 CD10                    	int     10h
  6661 00001AEB 8B16[B051]              	mov     dx, [Cursor_Pos]
  6662 00001AEF EBC7                    	jmp     short read_next_char
  6663                                  loc_beep:
  6664 00001AF1 B40E                    	mov     ah, 0Eh
  6665 00001AF3 B007                    	mov     al, 7
  6666 00001AF5 CD10                    	int     10h
  6667 00001AF7 EBBF                    	jmp     short read_next_char
  6668                                  loc_arrow:    
  6669 00001AF9 80FC4B                  	cmp     ah, 4Bh
  6670 00001AFC 74CA                    	je      short loc_back
  6671 00001AFE 80FC53                  	cmp     ah, 53h
  6672 00001B01 74C5                    	je      short loc_back
  6673 00001B03 EBB3                    	jmp     short read_next_char
  6674                                  char_return:
  6675 00001B05 B403                    	mov     ah, 3
  6676 00001B07 CD10                    	int     10h
  6677                                  check_char_type:
  6678 00001B09 3C20                    	cmp     al, 20h
  6679 00001B0B 7229                    	jb      short loc_escape
  6680 00001B0D 88D4                    	mov     ah, dl
  6681 00001B0F 2A26[B051]              	sub     ah, byte [Cursor_Pos]
  6682                                  	;cmp	ah, 10 
  6683                                  	;ja	short loc_beep
  6684 00001B13 3A26[2361]              	cmp     ah, [vname_length] ; 05/01/2018
  6685 00001B17 73D8                    	jnb	short loc_beep
  6686 00001B19 3C7A                    	cmp     al, 'z'
  6687 00001B1B 779B                    	ja      short read_next_char
  6688 00001B1D 3C61                    	cmp     al, 'a'
  6689 00001B1F 7202                    	jb      short pass_capitalize
  6690 00001B21 24DF                    	and     al, 0DFh
  6691                                  pass_capitalize:
  6692 00001B23 88E3                    	mov     bl, ah 
  6693 00001B25 30E4                    	xor     ah, ah
  6694 00001B27 8900                    	mov     [si+bx], ax
  6695 00001B29 B307                    	mov     bl, 7
  6696 00001B2B B40E                    	mov     ah, 0Eh
  6697 00001B2D CD10                    	int     10h
  6698 00001B2F EB87                    	jmp     short read_next_char
  6699                                  pass_escape:
  6700 00001B31 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  6701 00001B33 7583                    	jne     short read_next_char
  6702                                  	;mov	ah, 0Eh
  6703                                  	;int	10h
  6704                                  	;mov	al, 0Ah
  6705                                  	;int	10h
  6706 00001B35 C3                      	retn
  6707                                  loc_escape:
  6708 00001B36 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  6709 00001B38 75F7                    	jne     short pass_escape
  6710 00001B3A F9                      	stc
  6711 00001B3B C3                      	retn
  6712                                  
  6713                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6714                                  ; display CHS table
  6715                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6716                                  
  6717                                  	; 09/03/2021 (fdisk4.s)
  6718                                  display_chs_table:
  6719                                  
  6720                                  	; 16/10/2020
  6721                                  	; 12/10/2020 (fdisk3)
  6722                                  	; 11/02/2019 (hdimage)
  6723                                  
  6724 00001B3C 06                      	push	es
  6725 00001B3D BF00B8                  	mov	di, 0B800h
  6726 00001B40 8EC7                    	mov	es, di
  6727 00001B42 BFA000                  	mov	di, 160 ; row 1
  6728 00001B45 B407                    	mov	ah, 07h
  6729 00001B47 B044                    	mov	al, 'D'
  6730 00001B49 AB                      	stosw
  6731 00001B4A B069                    	mov	al, 'i'
  6732 00001B4C AB                      	stosw
  6733 00001B4D B073                    	mov	al, 's'
  6734 00001B4F AB                      	stosw
  6735 00001B50 B06B                    	mov	al, 'k'
  6736 00001B52 AB                      	stosw
  6737 00001B53 B03A                    	mov	al, ':'
  6738 00001B55 AB                      	stosw
  6739 00001B56 B020                    	mov	al, ' '
  6740 00001B58 AB                      	stosw
  6741 00001B59 B068                    	mov	al, 'h'
  6742 00001B5B AB                      	stosw
  6743 00001B5C B064                    	mov	al, 'd'
  6744 00001B5E AB                      	stosw
  6745 00001B5F A0[3E65]                	mov	al, [DrvNum]
  6746 00001B62 2C50                    	sub	al, 80h-'0'
  6747 00001B64 AB                      	stosw
  6748 00001B65 BF4001                  	mov	di, 320 ; row 2
  6749 00001B68 B95000                  	mov	cx, 80
  6750 00001B6B B82007                  	mov	ax, 0720h
  6751 00001B6E F3AB                    	rep	stosw
  6752 00001B70 B150                    	mov	cl, 80	; row 3
  6753 00001B72 B02D                    	mov	al, "-"
  6754 00001B74 F3AB                    	rep	stosw
  6755                                  	;mov	cl, 19
  6756 00001B76 B112                    	mov	cl, 18 ; 16/10/2020 ; row 4
  6757 00001B78 B020                    	mov	al, 20h
  6758 00001B7A F3AB                    	rep	stosw
  6759 00001B7C B043                    	mov	al, 'C'
  6760 00001B7E AB                      	stosw
  6761 00001B7F B079                    	mov	al, 'y'
  6762 00001B81 AB                      	stosw
  6763 00001B82 B06C                    	mov	al, 'l'
  6764 00001B84 AB                      	stosw
  6765 00001B85 B069                    	mov	al, 'i'
  6766 00001B87 AB                       	stosw
  6767 00001B88 B06E                    	mov	al, 'n'
  6768 00001B8A AB                      	stosw	
  6769 00001B8B B064                    	mov	al, 'd'
  6770 00001B8D AB                      	stosw
  6771 00001B8E B065                    	mov	al, 'e'
  6772 00001B90 AB                      	stosw
  6773 00001B91 B072                    	mov	al, 'r'
  6774 00001B93 AB                       	stosw
  6775 00001B94 B073                    	mov	al, 's'
  6776 00001B96 AB                       	stosw
  6777 00001B97 B03A                    	mov	al, ':'
  6778 00001B99 AB                      	stosw
  6779 00001B9A B020                    	mov	al, 20h
  6780 00001B9C AB                      	stosw
  6781                                  	;mov	[cylnumpos], di
  6782                                  	
  6783                                  	; 09/03/2021
  6784                                  	;mov	ax, [cylinders]
  6785                                  	;mov	dx, [cylinders+2] ; 16/10/2020
  6786 00001B9D 66A1[B63C]              	mov	eax, [cylinders]
  6787                                  
  6788                                  	;mov	cl, 4
  6789                                  	;mov	ch, 07h ; color
  6790 00001BA1 E86600                  	call	write_number
  6791                                  	
  6792                                  	;mov	ax, 0720h
  6793 00001BA4 B020                    	mov	al, 20h ; 16/10/2020
  6794 00001BA6 AB                      	stosw
  6795 00001BA7 AB                      	stosw
  6796 00001BA8 B048                    	mov	al, 'H'
  6797 00001BAA AB                      	stosw
  6798 00001BAB B065                    	mov	al, 'e'
  6799 00001BAD AB                      	stosw
  6800 00001BAE B061                    	mov	al, 'a'
  6801 00001BB0 AB                      	stosw
  6802 00001BB1 B064                    	mov	al, 'd'
  6803 00001BB3 AB                       	stosw
  6804 00001BB4 B073                    	mov	al, 's'
  6805 00001BB6 AB                       	stosw
  6806 00001BB7 B03A                    	mov	al, ':'
  6807 00001BB9 AB                      	stosw
  6808 00001BBA B020                    	mov	al, 20h
  6809 00001BBC AB                      	stosw
  6810                                  	;mov	[hednumpos], di
  6811                                  	
  6812                                  	; 09/03/2021
  6813                                  	;mov	ax, [heads]
  6814                                  	;xor	dx, dx ; 16/10/2020
  6815                                  	;
  6816                                  	;movzx	eax, word [heads]
  6817                                  	; eax < 65536
  6818 00001BBD A1[B43C]                	mov	ax, [heads]
  6819                                  
  6820                                  	;mov	cl, 2
  6821                                  	;mov	ch, 07h ; color
  6822 00001BC0 E84700                  	call	write_number
  6823                                  
  6824                                  	;mov	ax, 0720h
  6825 00001BC3 B020                    	mov	al, 20h ; 16/10/2020
  6826 00001BC5 AB                      	stosw
  6827 00001BC6 AB                      	stosw
  6828 00001BC7 B053                    	mov	al, 'S'
  6829 00001BC9 AB                      	stosw
  6830 00001BCA B065                    	mov	al, 'e'
  6831 00001BCC AB                      	stosw
  6832 00001BCD B063                    	mov	al, 'c'
  6833 00001BCF AB                      	stosw
  6834 00001BD0 B074                    	mov	al, 't'
  6835 00001BD2 AB                       	stosw
  6836 00001BD3 B06F                    	mov	al, 'o'
  6837 00001BD5 AB                      	stosw
  6838 00001BD6 B072                    	mov	al, 'r'
  6839 00001BD8 AB                       	stosw
  6840 00001BD9 B073                    	mov	al, 's'
  6841 00001BDB AB                       	stosw
  6842 00001BDC B03A                    	mov	al, ':'
  6843 00001BDE AB                      	stosw
  6844 00001BDF B020                    	mov	al, 20h
  6845 00001BE1 AB                      	stosw
  6846                                  	;mov	[secnumpos], di
  6847                                  
  6848                                  	; 09/03/2021
  6849                                  	;mov	ax, [sectors]
  6850                                  	;sub	dx, dx ; 16/10/2020
  6851                                  	;
  6852                                  	;movzx	eax, [sectors]
  6853                                  	; eax < 65536
  6854 00001BE2 A1[B23C]                	mov	ax, [sectors]
  6855                                  
  6856                                  	;mov	cl, 2
  6857                                  	;mov	ch, 07h ; color
  6858 00001BE5 E82200                  	call	write_number
  6859                                  
  6860 00001BE8 B92003                  	mov	cx, 800 ; 16/10/2020 ; row 5
  6861 00001BEB 29F9                    	sub	cx, di
  6862 00001BED D0E9                    	shr	cl, 1
  6863                                  	;mov	cl, 22
  6864                                  	;mov	ax, 0720h
  6865 00001BEF B020                    	mov	al, 20h ; 16/10/2020
  6866 00001BF1 F3AB                    	rep	stosw
  6867                                  	
  6868 00001BF3 B150                    	mov	cl, 80 	; row 6
  6869 00001BF5 B02D                    	mov	al, "-"
  6870 00001BF7 F3AB                    	rep	stosw
  6871                                  
  6872 00001BF9 B150                    	mov	cl, 80	 ; row 7
  6873                                  	;mov	cl, 160	 ; row 7, 8
  6874 00001BFB B020                    	mov	al, 20h
  6875 00001BFD F3AB                    	rep	stosw
  6876                                  
  6877 00001BFF BA0006                  	mov	dx, 0600h ; DH = row, DL = 0 column
  6878 00001C02 31DB                    	xor	bx, bx ; BH = video page (0)
  6879 00001C04 B402                    	mov	ah, 02h ; set cursor position
  6880 00001C06 CD10                    	int	10h
  6881                                  
  6882 00001C08 07                      	pop	es
  6883 00001C09 C3                      	retn
  6884                                  
  6885                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6886                                  ; write decimal number
  6887                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6888                                  
  6889                                  ;write_number:
  6890                                  ;	; 12/10/2020
  6891                                  ;	mov	bx, 10
  6892                                  ;	mov	si, cx
  6893                                  ;wnum_1:
  6894                                  ;	xor	dx, dx
  6895                                  ;	div	bx
  6896                                  ;	push	dx
  6897                                  ;	dec	cl
  6898                                  ;	jnz	short wnum_1
  6899                                  ;	mov	cx, si
  6900                                  ;	mov	ah, ch	; color (07h or 0Fh)
  6901                                  ;	xor	ch, ch
  6902                                  ;wnum_2:
  6903                                  ;	pop	dx
  6904                                  ;	mov	al, dl
  6905                                  ;	add	al, '0'
  6906                                  ;	stosw
  6907                                  ;	loop	wnum_2
  6908                                  ;	retn
  6909                                  
  6910                                  ;write_number:
  6911                                  ;	; 16/10/2020
  6912                                  ;	; dx:ax = binary number
  6913                                  ;	; di = decimal number/string location
  6914                                  ;	; modified registers: ax, bx, cx, dx, bp, di
  6915                                  ;	mov	cx, 10
  6916                                  ;	mov	bp, sp
  6917                                  ;wnum_1:
  6918                                  ;	call	div32
  6919                                  ;	push	bx
  6920                                  ;	and	dx, dx
  6921                                  ;	jnz	short wnum_1
  6922                                  ;	or	ax, ax
  6923                                  ;	jnz	short wnum_1
  6924                                  ;wnum_2:	
  6925                                  ;	pop	ax
  6926                                  ;	add	al, '0'
  6927                                  ;	mov	ah, 07h ; color
  6928                                  ;	stosw
  6929                                  ;	cmp	bp, sp
  6930                                  ;	ja	short wnum_2
  6931                                  ;	retn
  6932                                  
  6933                                  write_number:
  6934                                  	; 21/03/2021
  6935                                  	; 09/03/2021 (fdisk4.s)
  6936                                  	; eax = binary number (must be <=
  6937                                  	; di = decimal number/string location
  6938                                  	; modified registers: eax, ecx, edx, bp, di
  6939 00001C0A 66B90A000000            	mov	ecx, 10
  6940 00001C10 6631D2                  	xor	edx, edx
  6941 00001C13 89E5                    	mov	bp, sp
  6942                                  wnum_1:
  6943 00001C15 66F7F1                  	div	ecx
  6944 00001C18 52                      	push	dx ; <= 9
  6945                                  	; 21/03/2021
  6946 00001C19 6609C0                  	or	eax, eax
  6947 00001C1C 7404                    	jz	short wnum_2
  6948 00001C1E 30D2                    	xor	dl, dl
  6949 00001C20 EBF3                    	jmp	short wnum_1
  6950                                  wnum_2:	
  6951 00001C22 58                      	pop	ax
  6952 00001C23 0430                    	add	al, '0'
  6953 00001C25 B407                    	mov	ah, 07h ; color
  6954 00001C27 AB                      	stosw
  6955 00001C28 39E5                    	cmp	bp, sp
  6956 00001C2A 77F6                    	ja	short wnum_2
  6957 00001C2C C3                      	retn
  6958                                  
  6959                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6960                                  ; partition size input
  6961                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  6962                                  
  6963                                  	; 13/03/2021
  6964                                  	; 12/03/2021 (fdisk4.s, 2TB disk partitioning)
  6965                                  partition_size_input:
  6966                                  	; 23/10/2020 (fdisk3.s modification on hdimage.s source code)
  6967                                  
  6968                                  	; 13/03/2021
  6969 00001C2D 6631C9                  	xor	ecx, ecx
  6970 00001C30 6631D2                  	xor	edx, edx
  6971                                  
  6972                                  	;mov	word [pSize_multiplier+2], 0
  6973 00001C33 890E[E669]              	mov	[pSize_multiplier+2], cx ; 0 ; 13/03/2021
  6974 00001C37 C606[EB69]42            	mov	byte [msg_psize_unit+1], 'B'
  6975 00001C3C A0[EA69]                	mov	al, [pSize_unit]
  6976 00001C3F 3C25                    	cmp	al, '%'
  6977 00001C41 7522                    	jne	short psu_0
  6978                                  	; 08/02/2019
  6979                                  	; calculate sector count for max. available sectors percentage
  6980                                  	;mov	dx, [pp_Sectors+2] ; max. available sectors
  6981                                  	;mov	ax, [pp_Sectors]   ; for a new partition
  6982                                  	;;mov	dx, [total_sectors+2]
  6983                                  	;;mov	ax, [total_sectors]
  6984                                  	;mov	cx, 100
  6985                                  	;call	div32
  6986                                  	;mov	[pSize_multiplier], ax
  6987                                  	; 29/10/2020
  6988                                  	;mov	[pSize_multiplier+2], dx
  6989                                  	; 13/03/2021
  6990                                  	;;mov	ecx, 100
  6991                                  	;mov	cl, 100
  6992 00001C43 B163                    	mov	cl, 99
  6993 00001C45 66A1[D869]              	mov	eax, [pp_Sectors]  ; > 0
  6994 00001C49 6601C8                  	add	eax, ecx ; eax = eax + 99
  6995 00001C4C 80D200                  	adc	dl, 0
  6996 00001C4F FEC1                    	inc	cl ; ecx = 100	
  6997 00001C51 66F7F1                  	div	ecx
  6998 00001C54 66A3[E469]              	mov	[pSize_multiplier], eax	; >= 1
  6999                                  	;xor	eax, eax
  7000                                  	;xor	dl, dl
  7001                                  	
  7002                                  	;mov	ah, 0
  7003                                  	;mov	[msg_psize_unit+1], ah ; 0
  7004                                  	; 13/03/2021
  7005 00001C58 882E[EB69]              	mov	[msg_psize_unit+1], ch ; 0
  7006                                  	;mov	byte [pSize_maxdigits], 2
  7007 00001C5C C606[E869]03            	mov	byte [pSize_maxdigits], 3 ; 29/10/2020
  7008 00001C61 B025                    	mov	al, '%'
  7009 00001C63 EB5D                    	jmp	short psu_6
  7010                                  psu_0:
  7011 00001C65 3C43                    	cmp	al, 'C'
  7012 00001C67 7517                    	jne	short psu_1
  7013 00001C69 A1[B23C]                	mov	ax, [sectors]
  7014 00001C6C F726[B43C]              	mul	word [heads]
  7015 00001C70 A3[E469]                	mov	[pSize_multiplier], ax
  7016                                  	;;mov	byte [pSize_maxdigits], 4 
  7017                                  	;; <= 65535 cylinders
  7018                                  	;mov	byte [pSize_maxdigits], 5 ; 23/10/2020
  7019                                  	; 13/03/2021	
  7020 00001C73 C606[E869]06            	mov	byte [pSize_maxdigits], 6 ; <= 267349 cylinders
  7021                                  
  7022                                  	;sub	dh, dh
  7023 00001C78 8836[EB69]              	mov	[msg_psize_unit+1], dh ; 0
  7024 00001C7C B043                    	mov	al, 'C'
  7025 00001C7E EB42                    	jmp	short psu_6
  7026                                  psu_1:
  7027 00001C80 3C47                    	cmp	al, 'G'
  7028 00001C82 7510                    	jne	short psu_2
  7029                                  	;mov	word [pSize_multiplier], 2*1024
  7030                                  	;mov	word [pSize_multiplier+2], 1024
  7031                                  	; 13/03/2021
  7032 00001C84 66C706[E469]000020-     	mov	dword [pSize_multiplier], 1024*1024*2
  7032 00001C8C 00                 
  7033                                  
  7034                                  	;;mov	byte [pSize_maxdigits], 1
  7035                                  	;mov	byte [pSize_maxdigits], 3 ; <= 512 GB ; 23/10/2020
  7036                                  	; 12/03/2021
  7037 00001C8D C606[E869]04            	mov	byte [pSize_maxdigits], 4 ; <= 2048 GB
  7038 00001C92 EB2E                    	jmp	short psu_6
  7039                                  psu_2:
  7040 00001C94 3C4D                    	cmp	al, 'M'
  7041 00001C96 750D                    	jne	short psu_3
  7042 00001C98 C706[E469]0008          	mov	word [pSize_multiplier], 2*1024
  7043                                  	;mov	byte [pSize_maxdigits], 4
  7044                                  	; 13/03/2021
  7045                                  	; <= 2097152 MB 
  7046 00001C9E C606[E869]07            	mov	byte [pSize_maxdigits], 7 ; 23/10/2020
  7047 00001CA3 EB1D                    	jmp	short psu_6
  7048                                  psu_3:
  7049 00001CA5 3C4B                    	cmp	al, 'K'
  7050 00001CA7 7508                    	jne	short psu_4
  7051 00001CA9 C706[E469]0200          	mov	word [pSize_multiplier], 2
  7052 00001CAF EB0C                    	jmp	short psu_5
  7053                                  psu_4:
  7054                                  	; al = 'S'
  7055 00001CB1 30E4                    	xor	ah, ah
  7056 00001CB3 8826[EB69]              	mov	[msg_psize_unit+1], ah ; 0
  7057 00001CB7 C706[E469]0100          	mov	word [pSize_multiplier], 1
  7058                                  psu_5:
  7059                                  	;mov	byte [pSize_maxdigits], 7
  7060                                  	; 13/03/2021
  7061                                  	; <= 2147483648 KB or <= 4294967296 sectors
  7062 00001CBD C606[E869]0A            	mov	byte [pSize_maxdigits], 10 ; 23/10/2020
  7063                                  psu_6:
  7064 00001CC2 A2[A84B]                	mov	[msg_partition_size_x], al
  7065 00001CC5 BE[944B]                	mov	si, msg_partition_size
  7066 00001CC8 E8F4FC                  	call	print_msg
  7067                                  
  7068 00001CCB 89E5                    	mov	bp, sp
  7069                                  	;xor	bx, bx
  7070                                  	;mov	[pSize_temp], bx ; 0
  7071                                  	;;mov	[pSize_temp+2], bx ; 0
  7072                                  	; 13/03/2021
  7073                                  	;xor	ebx, ebx
  7074                                  	;mov	[pSize_temp], ebx ; 0
  7075 00001CCD 31DB                    	xor	bx, bx
  7076                                  
  7077 00001CCF 881E[E969]              	mov	[pSize_digitpos], bl ; 0
  7078                                  	; bh = 0  ; video page
  7079 00001CD3 B403                    	mov     ah, 3	; get cursor pos
  7080 00001CD5 CD10                    	int     10h
  7081 00001CD7 8916[B051]              	mov	[Cursor_Pos], dx
  7082                                  	; 09/02/2019
  7083 00001CDB B307                    	mov     bl, 7   ; page 0, color 7 (light gray)
  7084                                  psu_7:
  7085 00001CDD 30E4                    	xor	ah, ah
  7086 00001CDF CD16                    	int	16h
  7087                                  
  7088 00001CE1 3C30                    	cmp	al, '0'
  7089 00001CE3 7223                    	jb	short psu_8
  7090 00001CE5 3C39                    	cmp	al, '9'
  7091 00001CE7 77F4                    	ja	short psu_7
  7092 00001CE9 8A1E[E969]              	mov	bl, [pSize_digitpos]
  7093 00001CED 3A1E[E869]              	cmp	bl, [pSize_maxdigits]
  7094 00001CF1 73EA                    	jnb	short psu_7
  7095 00001CF3 FE06[E969]              	inc	byte [pSize_digitpos]
  7096 00001CF7 2C30                    	sub	al, '0'
  7097                                  	;xor	ah, ah  ; 13/03/2021 (AH will not be used)
  7098 00001CF9 50                      	push	ax	; (*)
  7099 00001CFA 0430                    	add	al, '0'
  7100 00001CFC B40E                    	mov	ah, 0Eh	; write char as tty
  7101                                  	;mov	bx, 7   ; page 0, color 7 (light gray)
  7102 00001CFE CD10                    	int	10h
  7103 00001D00 EBDB                    	jmp	short psu_7
  7104                                  
  7105                                  psu_8esc:
  7106                                  	; 29/10/2020 (ESCape)
  7107 00001D02 89EC                    	mov	sp, bp ; clean stack
  7108                                  
  7109 00001D04 08C0                    	or	al, al ; zf = 0
  7110 00001D06 F9                      	stc
  7111 00001D07 C3                      	retn	
  7112                                  psu_8:
  7113 00001D08 20C0                    	and	al, al
  7114 00001D0A 0F848300                	jz	psu_15 ; check for left arrow key
  7115 00001D0E 3C1B                    	cmp	al, 27
  7116 00001D10 74F0                    	je	short psu_8esc ; ESCAPE key ; 29/10/2020
  7117 00001D12 7777                    	ja	psu_14 ; check for left arrow key
  7118 00001D14 3C0D                    	cmp	al, 13
  7119                                  	;je	short psu_9  ; ENTER key
  7120 00001D16 723D                    	jb	short psu_11 ; check for backspace key
  7121                                  	;jmp	short psu_7
  7122 00001D18 77C3                    	ja	short psu_7
  7123                                  psu_9:
  7124                                  	; 13/03/2021
  7125                                  	;xor	ax, ax
  7126                                  	;mov	[pSize_temp+2], ax ; 0 ; 08/02/2019
  7127                                  
  7128                                  	;cmp	byte [pSize_digitpos], al ; 0
  7129                                  	;jna	psu_16	
  7130                                  	; 13/03/2021
  7131 00001D1A 383E[E969]              	cmp	byte [pSize_digitpos], bh ; 0
  7132 00001D1E 767E                    	jna	psu_16
  7133                                  
  7134                                  	;xor	bh, bh
  7135 00001D20 8A1E[E969]              	mov	bl, [pSize_digitpos]
  7136 00001D24 FECB                    	dec	bl
  7137 00001D26 D0E3                    	shl	bl, 1
  7138 00001D28 01E3                    	add	bx, sp
  7139                                  	;mov	ax, [bx]
  7140                                  	;mov	[pSize_temp], ax
  7141                                  	;;mov	word [pSize_temp+2], 0
  7142                                  	; 13/03/2021
  7143 00001D2A 8A0F                    	mov	cl, [bx]
  7144 00001D2C 66890E[E069]            	mov	[pSize_temp], ecx
  7145                                  	; 13/03/2021
  7146                                  	;mov	cx, 10
  7147 00001D31 B10A                    	mov	cl, 10
  7148                                  psu_10:
  7149 00001D33 FE0E[E969]              	dec	byte [pSize_digitpos]
  7150 00001D37 7465                    	jz	short psu_16
  7151                                  	
  7152                                  	;mov	ax, [pSize_temp]
  7153                                  	;mov	dx, [pSize_temp+2]
  7154                                  	;;mov	cx, 10
  7155                                  	;call	mul32
  7156                                  	;;mov	[pSize_temp], ax
  7157                                  	;;mov	[pSize_temp+2], dx
  7158                                  	; 13/03/2021
  7159 00001D39 66A1[E069]              	mov	eax, [pSize_temp]
  7160 00001D3D 66F7E1                  	mul	ecx ; * 10
  7161                                  	;mov	[pSize_temp], eax
  7162                                  
  7163                                  	;xor	bh, bh
  7164 00001D40 8A1E[E969]              	mov	bl, [pSize_digitpos]
  7165 00001D44 FECB                    	dec	bl
  7166 00001D46 D0E3                    	shl	bl, 1
  7167 00001D48 01E3                    	add	bx, sp ; (*)
  7168                                  	;mov	ax, [bx]
  7169                                  	;add	[pSize_temp], ax
  7170                                  	;adc	word [pSize_temp+2], 0
  7171                                  	
  7172                                  	;add	ax, [bx]
  7173                                  	;adc	dx, 0
  7174                                  	; 13/03/2021
  7175 00001D4A 8A0F                    	mov	cl, [bx]
  7176 00001D4C 6601C8                  	add	eax, ecx
  7177                                  	
  7178                                  	;mov	[pSize_temp], ax
  7179                                  	;mov	[pSize_temp+2], dx
  7180                                  	; 13/03/2021
  7181 00001D4F 66A3[E069]              	mov	[pSize_temp], eax
  7182                                  
  7183 00001D53 EBDE                    	jmp	short psu_10
  7184                                  	
  7185                                  	; Left arrow, backspace, DEL key checking
  7186                                  psu_11:
  7187 00001D55 3C08                    	cmp	al, 8 ; backspace key
  7188 00001D57 7584                    	jne	psu_7
  7189                                  psu_12:
  7190                                  	;; bh = 0  ; video page
  7191                                  	;mov	ah, 3 ; get cursor pos
  7192                                  	;int	10h
  7193                                  	;cmp	dl, [Cursor_Pos]
  7194                                  	;jna	short psu_13
  7195                                  	;dec	dl
  7196                                  	;dec	byte [pSize_digitpos]
  7197                                  
  7198                                  	; 08/02/2019
  7199 00001D59 8B16[B051]              	mov	dx, [Cursor_Pos]
  7200 00001D5D 8A1E[E969]              	mov	bl, [pSize_digitpos]
  7201 00001D61 20DB                    	and	bl, bl
  7202 00001D63 741D                    	jz	short psu_13
  7203                                  
  7204 00001D65 FECB                    	dec	bl 
  7205 00001D67 881E[E969]              	mov	[pSize_digitpos], bl
  7206                                  	
  7207 00001D6B 00DA                    	add	dl, bl
  7208                                  
  7209                                  	; bh = 0  ; video page
  7210 00001D6D B402                    	mov	ah, 2 ; set cursor pos
  7211 00001D6F CD10                    	int	10h
  7212                                  	;mov	bl, dl
  7213                                  	;sub	bl, [Cursor_Pos] 
  7214 00001D71 B90100                  	mov	cx, 1
  7215 00001D74 B409                    	mov	ah, 9 ; write char at current curs pos
  7216 00001D76 B020                    	mov	al, 20h ; space (blank)
  7217 00001D78 8800                    	mov	[si+bx], al
  7218                                  	; bh = 0 ; video page
  7219 00001D7A B307                    	mov	bl, 7 ; attribute/color (light gray)
  7220 00001D7C CD10                    	int	10h
  7221                                  
  7222                                  	; 09/02/2019
  7223 00001D7E 58                      	pop	ax ; remove last digit on top of stack 
  7224                                  		   ; set sp to correct position for BX (*)
  7225 00001D7F E95BFF                  	jmp	psu_7
  7226                                  psu_13:
  7227 00001D82 B40E                    	mov	ah, 0Eh
  7228 00001D84 B007                    	mov	al, 7
  7229                                  	;mov	bx, 7
  7230 00001D86 CD10                    	int	10h
  7231 00001D88 E952FF                  	jmp	psu_7
  7232                                  psu_14:
  7233 00001D8B 3CE0                    	cmp	al, 0E0h
  7234 00001D8D 0F854CFF                	jne	psu_7
  7235                                  psu_15:    
  7236 00001D91 80FC4B                  	cmp	ah, 4Bh ; left arrow
  7237 00001D94 74C3                    	je	short psu_12
  7238 00001D96 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  7239 00001D99 74BE                    	je	short psu_12
  7240 00001D9B E93FFF                  	jmp	psu_7
  7241                                  psu_16:
  7242 00001D9E 89EC                    	mov	sp, bp
  7243                                  
  7244                                  	; 29/10/2020
  7245 00001DA0 803E[EA69]25            	cmp	byte [pSize_unit], '%'
  7246 00001DA5 751E                    	jne	short psu_23
  7247                                  
  7248 00001DA7 B86400                  	mov	ax, 100
  7249 00001DAA 3906[E069]              	cmp	word [pSize_temp], ax ; 100 ; % limit
  7250 00001DAE 7624                    	jna	short psu_17
  7251 00001DB0 A3[E069]                	mov	word [pSize_temp], ax
  7252                                  
  7253                                  	; (re)set asciiz number string to '100'
  7254                                  
  7255 00001DB3 28FF                    	sub	bh, bh ; 0 ; video page 0
  7256 00001DB5 8B16[B051]              	mov	dx, [Cursor_Pos]
  7257 00001DB9 B402                    	mov	ah, 2 ; set cursor pos
  7258 00001DBB CD10                    	int	10h
  7259                                  
  7260 00001DBD BE[3A65]                	mov	si, msg_100
  7261 00001DC0 E8FCFB                  	call	print_msg
  7262                                  
  7263 00001DC3 EB0F                    	jmp	short psu_17
  7264                                  psu_23:
  7265 00001DC5 803E[EA69]53            	cmp	byte [pSize_unit], 'S'
  7266 00001DCA 7508                    	jne	short psu_17 
  7267                                  
  7268 00001DCC BE[1861]                	mov	si, msg_sectors_crlf
  7269 00001DCF E8EDFB                  	call	print_msg
  7270                                  	;xor	bx, bx
  7271 00001DD2 EB33                    	jmp	short psu_18
  7272                                  psu_17:
  7273 00001DD4 BE[EA69]                	mov	si, msg_psize_unit
  7274 00001DD7 E8E5FB                  	call	print_msg
  7275                                  
  7276 00001DDA BE[6C52]                	mov	si, CRLF
  7277 00001DDD E8DFFB                  	call	print_msg
  7278                                  
  7279                                  	; 13/03/2021
  7280 00001DE0 66A1[E069]              	mov	eax, [pSize_temp]
  7281 00001DE4 6621C0                  	and	eax, eax
  7282 00001DE7 7422                    	jz	short psu_21 ; 0%, ZERO !
  7283                                  
  7284 00001DE9 668B16[E469]            	mov	edx, [pSize_multiplier]
  7285                                  
  7286                                  	; 29/10/2020
  7287 00001DEE 803E[EA69]25            	cmp	byte [pSize_unit], '%'
  7288 00001DF3 7512                    	jne	short psu_18
  7289                                  	
  7290                                  	;mov	cx, [pSize_temp]
  7291                                  	;
  7292                                  	;and	cx, cx
  7293                                  	;jz	short psu_21 ; 0%, ZERO !
  7294                                  	
  7295                                  	; 13/03/2021
  7296                                  	;mov	ax, [pSize_temp]
  7297                                  	;and	ax, ax
  7298                                  	;jz	short psu_21 ; 0%, ZERO !
  7299                                  	
  7300                                  	;cmp	cx, 100
  7301                                  	;jna	short psu_24
  7302                                  	; 13/03/2021
  7303                                  	;cmp	eax, 100
  7304 00001DF5 83F864                  	cmp	ax, 100
  7305 00001DF8 720D                    	jb	short psu_18 ; < 100
  7306 00001DFA 7403                    	je	short psu_19 ; = 100
  7307                                  
  7308                                  	; show 100% for 1 second (for >100%)
  7309 00001DFC E80E00                  	call	wait1second ; 29/10/2020
  7310                                  	;mov	cx, 100
  7311                                  psu_19: 
  7312                                  	; 13/03/2021
  7313 00001DFF 66A1[D869]              	mov	eax, [pp_Sectors] ; 100%
  7314 00001E03 6631D2                  	xor	edx, edx
  7315 00001E06 C3                      	retn
  7316                                  
  7317                                  ;psu_24:
  7318                                  	;mov	ax, [pSize_multiplier]
  7319                                  	;mov	dx, [pSize_multiplier+2]
  7320                                  	;
  7321                                  	;;mov	cx, [pSize_temp]
  7322                                  	;;and	cx, cx
  7323                                  	;;jz	short psu_21 ; 0%, ZERO !
  7324                                  	;	
  7325                                  	;jmp	mul32
  7326                                  psu_18:
  7327                                  	; 13/03/2021
  7328                                  	; eax = [pSize_temp]
  7329                                  	; edx = [pSize_multiplier]
  7330 00001E07 66F7E2                  	mul	edx
  7331                                  	; eax = partition size
  7332                                  	; edx = 0 
  7333 00001E0A C3                      	retn
  7334                                  ;psu_18:
  7335                                  	;mov	ax, [pSize_temp]
  7336                                  	;mov	dx, [pSize_temp+2]
  7337                                  	;mov	cx, ax
  7338                                  	;or	cx, dx
  7339                                  	;;jz	short psu_20
  7340                                  	;jz	short psu_21 ; 08/02/2019
  7341                                  	; 13/03/2021
  7342                                  	;mov	eax, [pSize_temp]
  7343                                  	;or	eax, eax
  7344                                  	;jz	short psu_21	
  7345                                  
  7346                                  	;mov	cx, [pSize_multiplier]
  7347                                  	;cmp	byte [pSize_unit], 'C'
  7348                                  	;je	short psu_20 ; 09/02/2019
  7349                                  	;;jne	short psu_19
  7350                                  	;;call	mul32
  7351                                  	;; 08/02/2019
  7352                                  	;; dx:ax = requested partition size in sectors
  7353                                  	;;retn	
  7354                                  ;psu_19:
  7355                                  	;;mov	cx, [pSize_multiplier]
  7356                                  	;cmp	cx, 1
  7357                                  	;;jna	short psu_20
  7358                                  	;ja	short psu_19
  7359                                  	;; 09/02/2019
  7360                                  	;xor	bx, bx
  7361                                  	;retn
  7362                                  
  7363                                  	; 13/03/2021
  7364                                  	; edx = [pSize_multiplier]
  7365                                  	;mul	edx
  7366                                  	; eax = partition size
  7367                                  	; edx = 0 
  7368                                  	;retn
  7369                                  ;psu_19:
  7370                                  ;	call	mul32
  7371                                  ;	;and	bx, bx
  7372                                  ;	;jnz	short psu_22 ; 09/02/2019
  7373                                  ;	mov	cx, [pSize_multiplier+2]
  7374                                  ;	or	cx, cx
  7375                                  ;	;jz	short psu_20
  7376                                  ;	jz	short psu_22 ; 09/02/2019
  7377                                  ;psu_20:
  7378                                  ;	;call	mul32
  7379                                  ;	;retn
  7380                                  ;	jmp	mul32 ; 23/10/2020
  7381                                  
  7382                                  psu_21:
  7383                                  	; 13/03/2021
  7384                                  	;xor	edx, edx
  7385                                  	; zf = 1 ; 29/10/2020
  7386 00001E0B F9                      	stc
  7387                                  psu_22:
  7388 00001E0C C3                      	retn
  7389                                  
  7390                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7391                                  ; wait for 1 second
  7392                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7393                                  
  7394                                  	; 29/10/2020
  7395                                  wait1second:
  7396 00001E0D B402                    	mov	ah, 2
  7397 00001E0F CD1A                    	int	1Ah ; get time of day
  7398 00001E11 720C                    	jc	short w1s_2
  7399                                  w1s_1:
  7400 00001E13 52                      	push	dx
  7401 00001E14 B402                    	mov	ah, 2
  7402 00001E16 CD1A                    	int	1Ah ; get time of day
  7403 00001E18 58                      	pop	ax
  7404 00001E19 7204                    	jc	short w1s_2
  7405 00001E1B 38E6                    	cmp	dh, ah
  7406 00001E1D 74F4                    	je	short w1s_1 ; same second
  7407                                  w1s_2:
  7408 00001E1F C3                      	retn
  7409                                  
  7410                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7411                                  ; partition type input
  7412                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7413                                  
  7414                                  partition_type_input:
  7415 00001E20 BE[AE4B]                	mov	si, msg_partition_type	
  7416 00001E23 E899FB                  	call	print_msg
  7417                                  
  7418 00001E26 31DB                    	xor	bx, bx
  7419                                  
  7420 00001E28 881E[FA69]              	mov	[pType_pos], bl ; 0
  7421 00001E2C 891E[FB69]              	mov	[pType_num], bx ; 0
  7422                                  
  7423                                  	; bh = 0  ; video page
  7424 00001E30 B403                    	mov     ah, 3 ; get cursor pos
  7425 00001E32 CD10                    	int     10h
  7426 00001E34 8916[B051]              	mov	[Cursor_Pos], dx
  7427                                  ptu_0:
  7428 00001E38 30E4                    	xor	ah, ah
  7429 00001E3A CD16                    	int	16h
  7430                                  
  7431 00001E3C 803E[FA69]01            	cmp	byte [pType_pos], 1
  7432 00001E41 773F                    	ja	short ptu_5
  7433                                  
  7434 00001E43 3C30                    	cmp	al, '0'
  7435 00001E45 723B                    	jb	short ptu_5
  7436 00001E47 3C39                    	cmp	al, '9'
  7437 00001E49 7707                    	ja	short ptu_1
  7438 00001E4B 88C4                    	mov	ah, al
  7439 00001E4D 80EC30                  	sub	ah, '0'
  7440 00001E50 EB13                    	jmp	short ptu_2 
  7441                                  ptu_1:
  7442 00001E52 3CE0                    	cmp     al, 0E0h
  7443 00001E54 7473                    	je	short ptu_9
  7444                                  
  7445 00001E56 24DF                    	and	al, 0DFh
  7446 00001E58 3C41                    	cmp	al, 'A'
  7447 00001E5A 72DC                    	jb	short ptu_0
  7448 00001E5C 3C46                    	cmp	al, 'F'
  7449 00001E5E 77D8                    	ja	short ptu_0
  7450 00001E60 88C4                    	mov	ah, al
  7451 00001E62 80EC37                  	sub	ah, 'A'-10
  7452                                  ptu_2:
  7453 00001E65 803E[FA69]00            	cmp	byte [pType_pos], 0
  7454 00001E6A 7606                    	jna	short ptu_3
  7455 00001E6C 8826[FC69]              	mov	[pType_num+1], ah
  7456 00001E70 EB04                    	jmp	short ptu_4 
  7457                                  ptu_3:
  7458 00001E72 8826[FB69]              	mov	[pType_num], ah
  7459                                  ptu_4:
  7460 00001E76 B40E                    	mov	ah, 0Eh
  7461 00001E78 B307                    	mov	bl, 7
  7462 00001E7A CD10                    	int	10h
  7463                                  
  7464 00001E7C FE06[FA69]              	inc	byte [pType_pos]
  7465                                  
  7466 00001E80 EBB6                    	jmp	short ptu_0 
  7467                                  ptu_5:
  7468 00001E82 20C0                    	and	al, al
  7469 00001E84 7443                    	jz	short ptu_9 ; check for left arrow key 
  7470 00001E86 3C1B                    	cmp	al, 27
  7471 00001E88 744C                    	je	short ptu_10 ; ESCAPE key
  7472 00001E8A 77AC                    	ja	short ptu_0
  7473 00001E8C 3C0D                    	cmp	al, 13
  7474 00001E8E 744A                    	je	short ptu_11 ; ENTER key
  7475 00001E90 77A6                    	ja	short ptu_0
  7476                                  ptu_6:
  7477                                  	; Left arrow, backspace, DEL key checking
  7478                                  
  7479 00001E92 3C08                    	cmp	al, 8 ; backspace key
  7480 00001E94 75A2                    	jne	short ptu_0
  7481                                  ptu_7:
  7482                                  	; bh = 0 ; video page
  7483 00001E96 B403                    	mov	ah, 3 ; get cursor pos
  7484 00001E98 CD10                    	int	10h
  7485 00001E9A 3A16[B051]              	cmp	dl, [Cursor_Pos]
  7486 00001E9E 7620                    	jna	short ptu_8
  7487 00001EA0 FECA                    	dec	dl
  7488 00001EA2 FE0E[FA69]              	dec	byte [pType_pos]
  7489                                  	; bh = 0  ; video page
  7490 00001EA6 B402                    	mov	ah, 2 ; set cursor pos
  7491 00001EA8 CD10                    	int	10h
  7492 00001EAA 88D3                    	mov	bl, dl
  7493 00001EAC 2A1E[B051]              	sub	bl, [Cursor_Pos] 
  7494 00001EB0 B90100                  	mov	cx, 1
  7495 00001EB3 B409                    	mov	ah, 9 ; write char at current curs pos
  7496 00001EB5 B020                    	mov	al, 20h ; space (blank)
  7497 00001EB7 8800                    	mov	[si+bx], al
  7498                                  	; bh = 0 ; video page
  7499 00001EB9 B307                    	mov	bl, 7 ; attribute/color (light gray)
  7500 00001EBB CD10                    	int	10h
  7501 00001EBD E978FF                  	jmp	ptu_0
  7502                                  ptu_8:
  7503 00001EC0 B40E                    	mov	ah, 0Eh
  7504 00001EC2 B007                    	mov	al, 7
  7505 00001EC4 CD10                    	int	10h
  7506 00001EC6 E96FFF                  	jmp	ptu_0
  7507                                  ptu_9:    
  7508 00001EC9 80FC4B                  	cmp	ah, 4Bh ; left arrow
  7509 00001ECC 74C8                    	je	short ptu_7
  7510 00001ECE 80FC53                  	cmp	ah, 53h ; DEL key (backspace)
  7511 00001ED1 74C3                    	je	short ptu_7
  7512 00001ED3 E962FF                  	jmp	ptu_0
  7513                                  
  7514                                  ptu_10: ; ESCAPE
  7515                                  	;mov	al, 0
  7516                                  	; 29/10/2020
  7517 00001ED6 28C0                    	sub	al, al ; 0
  7518                                  	; partition type is 0 (none)
  7519 00001ED8 EB12                    	jmp	short ptu_12
  7520                                  ptu_11: ; ENTER
  7521 00001EDA A0[FB69]                	mov	al, [pType_num]
  7522 00001EDD 803E[FA69]01            	cmp	byte [pType_pos], 1
  7523 00001EE2 7608                    	jna	short ptu_12
  7524 00001EE4 B410                    	mov	ah, 16
  7525 00001EE6 F6E4                    	mul	ah
  7526 00001EE8 0206[FC69]              	add	al, [pType_num+1]
  7527                                  ptu_12:
  7528 00001EEC 50                      	push	ax
  7529 00001EED E8A3FB                  	call	bin_to_hex
  7530 00001EF0 A3[C44B]                	mov	[msg_ptype_num], ax
  7531                                  	; bh = 0  ; video page
  7532 00001EF3 B402                    	mov	ah, 2 ; set cursor pos
  7533 00001EF5 8B16[B051]              	mov	dx, [Cursor_Pos]
  7534 00001EF9 CD10                    	int	10h
  7535 00001EFB BE[C44B]                	mov	si, msg_ptype_num 
  7536 00001EFE E8BEFA                  	call	print_msg
  7537 00001F01 58                      	pop	ax
  7538 00001F02 C3                      	retn
  7539                                  
  7540                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7541                                  ; show selected partition
  7542                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7543                                  
  7544                                  	; 20/03/2021 (fdisk4.s)
  7545                                  show_selected_partition:
  7546                                  	; INPUT ->
  7547                                  	; 	DS:SI = Partition table row address
  7548                                  	
  7549                                  	; 2019 - 2020 (hdimage.s)
  7550                                  	;pt_s_offset	equ 7
  7551                                  	;pt_bh_offset	equ 11
  7552                                  	;pt_bs_offset	equ 15
  7553                                  	;pt_bc_offset	equ 19
  7554                                  	;pt_fs_offset	equ 23
  7555                                  	;pt_eh_offset	equ 27
  7556                                  	;pt_es_offset	equ 31
  7557                                  	;pt_ec_offset	equ 35
  7558                                  	;pt_rs_offset	equ 41
  7559                                  	;pt_ts_offset	equ 52
  7560                                  	;pt_fsn_offset	equ 63
  7561                                  
  7562                                  	; 24/10/2020 (fdisk3.s)
  7563                                  	pt_s_offset	equ 6
  7564                                  	pt_bh_offset	equ 10
  7565                                  	pt_bs_offset	equ 14
  7566                                  	pt_bc_offset	equ 18
  7567                                  	pt_fs_offset	equ 22
  7568                                  	pt_eh_offset	equ 26
  7569                                  	pt_es_offset	equ 30
  7570                                  	pt_ec_offset	equ 34
  7571                                  	pt_rs_offset	equ 40
  7572                                  	pt_ts_offset	equ 51
  7573                                  	pt_fsn_offset	equ 63
  7574                                  
  7575                                  	; 20/03/2021
  7576 00001F03 6629C0                  	sub	eax, eax
  7577                                  
  7578                                  	; clear screen
  7579                                  	;mov	ax, 3 ; set video mode to 03h (80x25 text)
  7580 00001F06 B003                    	mov	al, 3 ; 20/03/2021
  7581 00001F08 CD10                    	int	10h	
  7582                                  
  7583 00001F0A 89F0                    	mov	ax, si
  7584 00001F0C 2D[A654]                	sub	ax, MasterBootBuff + pTableOffset ; + 446
  7585 00001F0F C0E804                  	shr	al, 4 ; from offset to partition number
  7586 00001F12 0431                    	add	al, '1'  ; 1 based partition number (chr)
  7587                                  	; Write partition number to the header location
  7588 00001F14 A2[844D]                	mov	[msg_selected_partition+43], al ; '1' to '4'
  7589                                  	
  7590                                  	; Partition number will be used at formatting stage
  7591 00001F17 A2[5350]                	mov	[partition_num_chr], al ; number + '0'
  7592                                  
  7593 00001F1A B268                    	mov	dl, 'h'
  7594 00001F1C 8A04                    	mov	al, [si+ptBootable]
  7595 00001F1E E872FB                  	call	bin_to_hex
  7596 00001F21 A3[9F4E]                	mov	[pt_row+pt_s_offset], ax
  7597 00001F24 8816[A14E]              	mov	[pt_row+pt_s_offset+2], dl ; 'h'
  7598 00001F28 8A4401                  	mov	al, [si+ptBeginHead]
  7599 00001F2B E865FB                  	call	bin_to_hex
  7600 00001F2E A3[A34E]                	mov	[pt_row+pt_bh_offset], ax
  7601 00001F31 8816[A54E]              	mov	[pt_row+pt_bh_offset+2], dl ; 'h'
  7602 00001F35 8A4402                  	mov	al, [si+ptBeginSector]
  7603 00001F38 E858FB                  	call	bin_to_hex
  7604 00001F3B A3[A74E]                	mov	[pt_row+pt_bs_offset], ax
  7605 00001F3E 8816[A94E]              	mov	[pt_row+pt_bs_offset+2], dl ; 'h'
  7606 00001F42 8A4403                  	mov	al, [si+ptBeginCylinder]
  7607 00001F45 E84BFB                  	call	bin_to_hex
  7608 00001F48 A3[AB4E]                	mov	[pt_row+pt_bc_offset], ax
  7609 00001F4B 8816[AD4E]              	mov	[pt_row+pt_bc_offset+2], dl ; 'h'
  7610 00001F4F 8A4404                  	mov	al, [si+ptFileSystemID]
  7611                                   	; Partition type will be used at formatting stage
  7612 00001F52 A2[DE69]                	mov	[pp_type_user], al
  7613 00001F55 E83BFB                  	call	bin_to_hex
  7614 00001F58 A3[AF4E]                	mov	[pt_row+pt_fs_offset], ax
  7615 00001F5B 8816[B14E]              	mov	[pt_row+pt_fs_offset+2], dl ; 'h'
  7616 00001F5F 8A4405                  	mov	al, [si+ptEndHead]
  7617 00001F62 E82EFB                  	call	bin_to_hex
  7618 00001F65 A3[B34E]                	mov	[pt_row+pt_eh_offset], ax
  7619 00001F68 8816[B54E]              	mov	[pt_row+pt_eh_offset+2], dl ; 'h'
  7620 00001F6C 8A4406                  	mov	al, [si+ptEndSector]
  7621 00001F6F E821FB                  	call	bin_to_hex
  7622 00001F72 A3[B74E]                	mov	[pt_row+pt_es_offset], ax
  7623 00001F75 8816[B94E]              	mov	[pt_row+pt_es_offset+2], dl ; 'h'
  7624 00001F79 8A4407                  	mov	al, [si+ptEndCylinder]
  7625 00001F7C E814FB                  	call	bin_to_hex
  7626 00001F7F A3[BB4E]                	mov	[pt_row+pt_ec_offset], ax
  7627 00001F82 8816[BD4E]              	mov	[pt_row+pt_ec_offset+2], dl ; 'h'
  7628 00001F86 8A4408                  	mov	al, [si+ptStartSector]
  7629 00001F89 E807FB                  	call	bin_to_hex
  7630 00001F8C A3[C74E]                	mov	[pt_row+pt_rs_offset+6], ax
  7631 00001F8F 8816[C94E]              	mov	[pt_row+pt_rs_offset+8], dl ; 'h'
  7632 00001F93 8A4409                  	mov	al, [si+ptStartSector+1]
  7633 00001F96 E8FAFA                  	call	bin_to_hex
  7634 00001F99 A3[C54E]                	mov	[pt_row+pt_rs_offset+4], ax
  7635 00001F9C 8A440A                  	mov	al, [si+ptStartSector+2]
  7636 00001F9F E8F1FA                  	call	bin_to_hex
  7637 00001FA2 A3[C34E]                	mov	[pt_row+pt_rs_offset+2], ax
  7638 00001FA5 8A440B                  	mov	al, [si+ptStartSector+3]
  7639 00001FA8 E8E8FA                  	call	bin_to_hex
  7640 00001FAB A3[C14E]                	mov	[pt_row+pt_rs_offset], ax
  7641 00001FAE 8A440C                  	mov	al, [si+ptSectors]
  7642 00001FB1 E8DFFA                  	call	bin_to_hex
  7643 00001FB4 A3[D24E]                	mov	[pt_row+pt_ts_offset+6], ax
  7644 00001FB7 8816[D44E]              	mov	[pt_row+pt_ts_offset+8], dl ; 'h'
  7645 00001FBB 8A440D                  	mov	al, [si+ptSectors+1]
  7646 00001FBE E8D2FA                  	call	bin_to_hex
  7647 00001FC1 A3[D04E]                	mov	[pt_row+pt_ts_offset+4], ax
  7648 00001FC4 8A440E                  	mov	al, [si+ptSectors+2]
  7649 00001FC7 E8C9FA                  	call	bin_to_hex
  7650 00001FCA A3[CE4E]                	mov	[pt_row+pt_ts_offset+2], ax
  7651 00001FCD 8A440F                  	mov	al, [si+ptSectors+3]
  7652 00001FD0 E8C0FA                  	call	bin_to_hex
  7653 00001FD3 A3[CC4E]                	mov	[pt_row+pt_ts_offset], ax
  7654                                  
  7655 00001FD6 8A4404                  	mov	al, [si+ptFileSystemID]
  7656 00001FD9 BF[D23D]                	mov	di, valid_partitions
  7657 00001FDC B91300                  	mov	cx, 19
  7658 00001FDF F2AE                    	repnz	scasb
  7659 00001FE1 7405                    	jz	short ssp_1
  7660 00001FE3 B8[C43D]                	mov	ax, FS_OTHERS
  7661 00001FE6 EB0C                    	jmp	short ssp_2
  7662                                  ssp_1:
  7663 00001FE8 81EF[D33D]              	sub	di, valid_partitions + 1
  7664 00001FEC B80E00                  	mov	ax, 14
  7665 00001FEF F7E7                    	mul	di
  7666 00001FF1 05[BA3C]                	add	ax, FileSys_Names
  7667                                  ssp_2:
  7668 00001FF4 96                      	xchg	ax, si 
  7669 00001FF5 B107                    	mov	cl, 7
  7670 00001FF7 BF[D84E]                	mov	di, pt_row + pt_fsn_offset
  7671 00001FFA F3A5                    	rep	movsw
  7672 00001FFC 89C7                    	mov	di, ax ; partition table row address
  7673                                  
  7674 00001FFE BE[594D]                	mov	si, msg_selected_partition
  7675 00002001 E8BBF9                  	call	print_msg
  7676                                  
  7677 00002004 BE[3A4F]                	mov	si, msg_boot_indicator
  7678 00002007 E8B5F9                  	call	print_msg
  7679 0000200A BE[A759]                	mov	si, msg_YES
  7680 0000200D F60580                  	test	byte [di+ptBootable], 80h
  7681 00002010 7503                    	jnz	short ssp_3
  7682 00002012 BE[AD59]                	mov	si, msg_NO
  7683                                  ssp_3:
  7684 00002015 E8A7F9                  	call	print_msg
  7685                                  
  7686 00002018 BE[524F]                	mov	si, msg_starting_head
  7687 0000201B E8A1F9                  	call	print_msg
  7688 0000201E 8A4501                  	mov	al, [di+ptBeginHead]
  7689 00002021 E8AD00                  	call	write_byte_decimal
  7690 00002024 E898F9                  	call	print_msg
  7691 00002027 BE[6A4F]                	mov	si, msg_starting_sector
  7692 0000202A E892F9                  	call	print_msg
  7693 0000202D 8A4502                  	mov	al, [di+ptBeginSector]
  7694 00002030 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  7695 00002032 243F                    	and	al, 3Fh ; sector number, 1 to 63
  7696 00002034 E89A00                  	call	write_byte_decimal
  7697 00002037 E885F9                  	call	print_msg
  7698 0000203A BE[824F]                	mov	si, msg_starting_cylinder
  7699 0000203D E87FF9                  	call	print_msg
  7700 00002040 8A4503                  	mov	al, [di+ptBeginCylinder] ; bits 0to7 of cyl
  7701 00002043 C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  7702 00002046 88D4                    	mov	ah, dl
  7703                                  	;xor	dx, dx
  7704                                  	; 20/03/2021
  7705                                  	; eax = binary number
  7706                                  	; 06/11/2020
  7707 00002048 BE[F769]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7708                                  	; dx_ax: binary number
  7709 0000204B E82AFA                  	call	bin_to_decimal
  7710                                  	; ds:si = decimal number text address
  7711 0000204E E86EF9                  	call	print_msg
  7712 00002051 BE[9A4F]                	mov	si, msg_system_id
  7713 00002054 E868F9                  	call	print_msg
  7714                                  	; Write file system name (again, copy)
  7715 00002057 BE[D84E]                	mov	si, pt_row + pt_fsn_offset
  7716                                  	;mov	cx, 14
  7717 0000205A B10E                    	mov	cl, 14
  7718 0000205C B40E                    	mov	ah, 0Eh ; write tty
  7719 0000205E BB0700                  	mov	bx, 7
  7720                                  ssp_4:	 
  7721 00002061 AC                      	lodsb
  7722 00002062 CD10                    	int	10h
  7723 00002064 E2FB                    	loop	ssp_4
  7724                                  
  7725 00002066 BE[B24F]                	mov	si, msg_ending_head
  7726 00002069 E853F9                  	call	print_msg
  7727 0000206C 8A4505                  	mov	al, [di+ptEndHead]
  7728 0000206F E85F00                  	call	write_byte_decimal
  7729 00002072 E84AF9                  	call	print_msg
  7730 00002075 BE[CA4F]                	mov	si, msg_ending_sector
  7731 00002078 E844F9                  	call	print_msg
  7732 0000207B 8A4506                  	mov	al, [di+ptEndSector]
  7733 0000207E 88C2                    	mov	dl, al  ; bits 7&8 are bits 8&9 of cyl
  7734 00002080 243F                    	and	al, 3Fh ; sector number, 1 to 63
  7735 00002082 E84C00                  	call	write_byte_decimal
  7736 00002085 E837F9                  	call	print_msg	
  7737 00002088 BE[E24F]                	mov	si, msg_ending_cylinder
  7738 0000208B E831F9                  	call	print_msg
  7739 0000208E 8A4507                  	mov	al, [di+ptEndCylinder] ; bits 0to7 of cyl
  7740 00002091 C0EA06                  	shr	dl, 6 ; bits 8&9 of cyl
  7741 00002094 88D4                    	mov	ah, dl
  7742                                  	;xor	dx, dx
  7743                                  	; 20/03/2021
  7744                                  	; eax = binary number
  7745                                  	; 06/11/2020
  7746 00002096 BE[F769]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7747                                  	; dx_ax: binary number
  7748 00002099 E8DCF9                  	call	bin_to_decimal
  7749                                  	; ds:si = decimal number text address
  7750 0000209C E820F9                  	call	print_msg
  7751                                  
  7752 0000209F BE[FA4F]                	mov	si, msg_relative_sectors
  7753 000020A2 E81AF9                  	call	print_msg
  7754                                  	;mov	ax, [di+ptStartSector]
  7755                                  	;mov	dx, [di+ptStartSector+2]
  7756                                  	; 20/03/2021
  7757 000020A5 668B4508                	mov	eax, [di+ptStartSector]
  7758                                  
  7759                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  7760                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  7761                                  	; 06/11/2020
  7762 000020A9 BE[F769]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7763                                  	; eax = binary number ; 20/03/2021
  7764 000020AC E8C9F9                  	call	bin_to_decimal
  7765 000020AF E80DF9                  	call	print_msg
  7766                                  
  7767 000020B2 BE[1450]                	mov	si, msg_total_sectors
  7768 000020B5 E807F9                  	call	print_msg
  7769                                  	;mov	ax, [di+ptSectors]
  7770                                  	;mov	dx, [di+ptSectors+2]
  7771                                  	; 20/03/2021
  7772 000020B8 668B450C                	mov	eax, [di+ptSectors]
  7773                                  
  7774                                  	;;mov	si, msg_partition_sectors + 7 ; max. 8 digits
  7775                                  	;mov	si, reserved_bytes + 10 ; max. 11 digits
  7776                                  	; 06/11/2020
  7777 000020BC BE[F769]                	mov	si, msg_partition_sectors + 10 ; max. 11 digits
  7778                                  	; eax = binary number ; 20/03/2021
  7779 000020BF E8B6F9                  	call	bin_to_decimal	
  7780 000020C2 E8FAF8                  	call	print_msg
  7781                                  
  7782                                  	; 24/02/2019
  7783 000020C5 BE[6C52]                	mov	si, CRLF
  7784 000020C8 E8F4F8                  	call	print_msg
  7785                                  
  7786 000020CB 89FE                    	mov	si, di  ; partition table row address
  7787                                  
  7788                                  	; 20/03/2021
  7789                                  	; (clear hw of eax)
  7790 000020CD 6631C0                  	xor	eax, eax
  7791                                  
  7792 000020D0 C3                      	retn
  7793                                  
  7794                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7795                                  ; write byte as descimal number
  7796                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7797                                  
  7798                                  write_byte_decimal:
  7799                                  	; INPUT ->
  7800                                  	;	AL = binary number
  7801                                  	; OUTPUT ->
  7802                                  	;	DS:SI = decimal number text address
  7803                                  	;	        (ASCIIZ string)
  7804                                  	;
  7805                                  	; (SI, AX, CX will be modified)
  7806                                  
  7807                                  	;mov	si, msg_partition_sectors + 8  ; max. 8 digits
  7808                                  	; 06/11/2020
  7809 000020D1 BE[F869]                	mov	si, msg_partition_sectors + 11 ; max. 11 digits
  7810 000020D4 B10A                    	mov	cl, 10
  7811                                  wbd_loop:
  7812 000020D6 4E                      	dec	si
  7813 000020D7 30E4                    	xor	ah, ah
  7814 000020D9 F6F1                    	div	cl
  7815 000020DB 80C430                  	add	ah, '0'
  7816 000020DE 8824                    	mov	[si], ah
  7817 000020E0 20C0                    	and	al, al
  7818 000020E2 75F2                    	jnz	short wbd_loop
  7819 000020E4 C3                      	retn
  7820                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7821                                  ; init (MBR) partition table
  7822                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  7823                                  ; 16/10/2020
  7824                                  
  7825                                  	; 09/03/2021
  7826                                  	; 03/02/2019
  7827                                  init_partition_table:
  7828                                  
  7829                                  	; INPUT -> none
  7830                                  	; OUTPUT -> none
  7831                                  
  7832                                  	; 15/10/2020
  7833                                  	; (If a partition row contains invalid/wrong/defective parameters)
  7834                                  	; (it's active partition flag/byte will be 0FFh, an invalid value!)
  7835                                  
  7836                                  	; 12/02/2019	
  7837                                  	;cmp	word [MBIDCode], 0AA55h
  7838                                  	;jne	ipt_stc ; invalid
  7839                                  
  7840                                  	; 15/02/2019
  7841                                  	; clear primary partition table structure/list
  7842                                  
  7843 000020E5 BF[866C]                	mov	di, part_table_boot_ind
  7844                                  	;mov	cx, 36 ; 18*4 = 72 bytes
  7845                                  	; 05/11/2020
  7846 000020E8 B92C00                  	mov	cx, 44 ; 22*4 = 88 bytes
  7847                                  	;xor	ax, ax ; 0
  7848 000020EB 6631C0                  	xor	eax, eax ; 09/03/2021
  7849 000020EE F3AB                    	rep	stosw
  7850                                  
  7851 000020F0 A3[DE6C]                	mov	[pcount], ax ; reset (pcount & ppcount)
  7852 000020F3 A3[E06C]                	mov	[apcount], ax ; reset (apcount & epnumber)
  7853                                  
  7854 000020F6 BE[A654]                	mov	si, MasterBootBuff+446 ; Partition table offset
  7855                                  	;mov	cx, 4
  7856 000020F9 B104                    	mov	cl, 4
  7857 000020FB 31FF                    	xor	di, di
  7858                                  ipt_0:
  7859 000020FD 8A6404                  	mov	ah, [si+ptFileSystemID]
  7860                                  
  7861 00002100 20E4                    	and	ah, ah
  7862 00002102 0F840D01                	jz	ipt_8 ; empty
  7863                                  
  7864 00002106 FE06[DE6C]              	inc	byte [pcount] ; partition count
  7865                                  
  7866 0000210A 80FC01                  	cmp	ah, 1	; FAT12
  7867 0000210D 7442                    	je	short ipt_2
  7868 0000210F 80FC04                  	cmp	ah, 4	; FAT16
  7869 00002112 743D                    	je	short ipt_2
  7870 00002114 723F                    	jb	short ipt_3	
  7871 00002116 80FC06                  	cmp	ah, 6	; FAT16 big
  7872 00002119 7436                    	je	short ipt_2
  7873 0000211B 7715                    	ja	short ipt_1 ; EXTENDED
  7874                                  
  7875                                  	;cmp	ah, 5 ; EXTENDED
  7876                                  	;jne	short ipt_3
  7877                                  ipt_17:
  7878 0000211D 803E[E16C]00            	cmp	byte [epnumber], 0
  7879                                  	;ja	short ipt_stc ; invalid  (more than 1 extended dos partition)
  7880 00002122 7605                    	jna	short ipt_15
  7881                                  	
  7882 00002124 C685[866C]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  7883                                  				; Invalid/Defective partition flag
  7884                                  ipt_15:	
  7885 00002129 B005                    	mov	al, 5
  7886 0000212B 28C8                    	sub	al, cl ; partition number 1 to 4
  7887 0000212D A2[E16C]                	mov	byte [epnumber], al ; extended partition entry number (1 to 4)
  7888 00002130 EB23                    	jmp	short ipt_3
  7889                                  ipt_1:
  7890                                  	; 26/10/2020
  7891 00002132 80FC07                  	cmp	ah, 07h ; NTFS (Windows FS)
  7892 00002135 741A                    	je	short ipt_2 ; accept NTFS as primary dos partition
  7893                                  			    ; (then, extended partition can be created)	
  7894                                  	; 24/10/2020
  7895 00002137 80FC0C                  	cmp	ah, 0Ch ; FAT32 (LBA)
  7896 0000213A 7415                    	je	short ipt_2
  7897 0000213C 7707                    	ja	short ipt_18
  7898                                  	; 16/10/2020
  7899 0000213E 80FC0B                  	cmp	ah, 0Bh ; FAT32 (CHS)
  7900                                  	;jne	short ipt_3
  7901                                  	; 24/10/2020
  7902 00002141 740E                    	je	short ipt_2
  7903                                  	;jb	short ipt_3 ; non-dos partition (NTFS or unknown fs type)
  7904                                  	; 09/03/2021
  7905 00002143 EB10                    	jmp	short ipt_3 ; non-dos partition (unknown fs type)
  7906                                  ipt_18:
  7907 00002145 80FC0F                  	cmp	ah, 0Fh  ; EXTENDED (LBA)
  7908 00002148 74D3                    	je	short ipt_17
  7909 0000214A 7709                    	ja	short ipt_3 ; non-dos partition 
  7910                                  			    ; (xenix/unix/linux/singlix/runix or unknown)
  7911 0000214C 80FC0E                  	cmp	ah, 0Eh ; FAT16 (LBA)
  7912 0000214F 7504                    	jne	short ipt_3 ; 0Dh
  7913                                  	; FAT16 LBA (0Eh)
  7914                                  ipt_2:
  7915 00002151 FE06[DF6C]              	inc	byte [ppcount] ; primary dos partition count
  7916                                  ipt_3:
  7917 00002155 88A5[8D6C]              	mov	[part_table_sys_id+di], ah  ; Partition Type (FS type)
  7918                                  	
  7919 00002159 8A04                    	mov	al, [si+ptBootable]
  7920                                  
  7921 0000215B 20C0                    	and	al, al
  7922 0000215D 7413                    	jz	short ipt_4
  7923                                  
  7924 0000215F 803E[E06C]01            	cmp	byte [apcount], 1 ; check (previous) active partition count
  7925                                  	;jnb	short ipt_stc  ; invalid (if it is not zero here)
  7926 00002164 7304                    	jnb	short ipt_16
  7927                                  
  7928 00002166 3C80                    	cmp	al, 80h  ; active partition sign/flag?
  7929                                  	;jne	short ipt_stc  ; invalid flag
  7930 00002168 7404                    	je	short ipt_11
  7931                                  ipt_16:
  7932                                  	; 15/10/2020
  7933 0000216A B0FF                    	mov	al, 0FFh ; Invalid/Defective partition flag 
  7934 0000216C EB04                    	jmp	short ipt_4
  7935                                  ipt_11:
  7936 0000216E FE06[E06C]              	inc	byte [apcount]  ; active partition count = 1
  7937                                  ipt_4:
  7938 00002172 8885[866C]              	mov	[part_table_boot_ind+di], al
  7939                                  
  7940                                  	;mov	al, [heads]
  7941                                  ;ipt_4_fix:
  7942                                  	;dec	al
  7943 00002176 8A6401                  	mov	ah, [si+ptBeginHead]
  7944                                  	;cmp	al, ah
  7945                                  	;;jb	short ipt_retn ; invalid
  7946                                  	;jb	ipt_heads_fix ; 10/02/2019
  7947 00002179 88A5[876C]              	mov	[part_table_start_head+di], ah
  7948 0000217D 8A6405                  	mov	ah, [si+ptEndHead]
  7949                                  	;cmp	al, ah
  7950                                  	;;jb	short ipt_retn ; invalid
  7951                                  	;jb	short ipt_heads_fix ; 10/02/2019
  7952 00002180 88A5[8E6C]              	mov	[part_table_end_head+di], ah
  7953                                  	;mov	al, [sectors]
  7954 00002184 8A7C02                  	mov	bh, [si+ptBeginSector]
  7955 00002187 88FC                    	mov	ah, bh
  7956 00002189 80E43F                  	and	ah, 3Fh ; 63
  7957                                  	;cmp	al, ah
  7958                                  	;jb	short ipt_retn ; invalid
  7959 0000218C 88A5[886C]              	mov	[part_table_start_sector+di], ah
  7960 00002190 8A7406                  	mov	dh, [si+ptEndSector]
  7961 00002193 88F4                    	mov	ah, dh
  7962 00002195 80E43F                  	and	ah, 3Fh ; 63
  7963                                  	;cmp	al, ah
  7964                                  	;jb	short ipt_retn ; invalid
  7965 00002198 88A5[8F6C]              	mov	[part_table_end_sector+di], ah
  7966 0000219C C0EF06                  	shr	bh, 6
  7967                                  	;mov	bl, [si+ptBeginCylinder]
  7968 0000219F 8A4403                  	mov	al, [si+ptBeginCylinder] ; 09/03/2021
  7969 000021A2 88FC                    	mov	ah, bh ; 09/03/2021
  7970                                  	;mov	ax, [cylinders]
  7971                                  	;dec	ax
  7972                                  	;cmp	ax, bx
  7973                                  	;jb	short ipt_retn ; invalid
  7974                                  	;mov	[part_table_start_cyl+di], bx
  7975 000021A4 668985[896C]            	mov	[part_table_start_cyl+di], eax ; 09/03/2021
  7976 000021A9 C0EE06                  	shr	dh, 6
  7977                                  	;mov	dl, [si+ptEndCylinder]
  7978 000021AC 8A4407                  	mov	al, [si+ptEndCylinder] ; 09/03/2021
  7979 000021AF 88F4                    	mov	ah, dh	; 09/03/2021
  7980                                  	;cmp	ax, dx
  7981                                  	;jb	short ipt_retn ; invalid
  7982                                  	;mov	[part_table_end_cyl+di], dx
  7983 000021B1 668985[906C]            	mov	[part_table_end_cyl+di], eax ; 09/03/2021
  7984                                  
  7985                                  	;mov	ax, [si+ptStartSector]
  7986                                  	;mov	dx, [si+ptStartSector+2]
  7987 000021B6 668B4408                	mov	eax, [si+ptStartSector] ; 09/03/2021
  7988                                  
  7989                                  	;mov	[part_table_rel_sec_lw+di], ax
  7990                                  	;mov	[part_table_rel_sec_hw+di], dx
  7991 000021BA 668985[946C]            	mov	[part_table_rel_sec+di], eax ; 09/03/2021
  7992                                  
  7993                                  	;or	ax, dx
  7994                                  	;;jz	short ipt_stc ; invalid (start sector must not be zero)
  7995                                  	;jnz	short ipt_12
  7996                                  	; 09/03/2021
  7997 000021BF 6609C0                  	or	eax, eax
  7998 000021C2 7505                    	jnz	short ipt_12
  7999                                  	; 15/10/2020
  8000 000021C4 C685[866C]FF            	mov	byte [part_table_boot_ind+di], 0FFh
  8001                                  				; Invalid/Defective partition flag
  8002                                  ipt_12:
  8003                                  	;mov	ax, [si+ptSectors]
  8004                                  	;mov	dx, [si+ptSectors+2]
  8005 000021C9 668B440C                	mov	eax, [si+ptSectors] ; 09/03/2021
  8006                                  
  8007                                  	;mov	bx, dx
  8008                                  	;or	bx, ax
  8009                                  	;;jz	short ipt_stc	; invalid (zero size of partition)
  8010                                  	;jnz	short ipt_6 ; 10/02/2019
  8011                                  	; 09/03/2021
  8012 000021CD 6609C0                  	or 	eax, eax
  8013 000021D0 7505                    	jnz	short ipt_6
  8014                                  
  8015                                  	; 15/10/2020
  8016 000021D2 C685[866C]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  8017                                  				; Invalid/Defective partition flag
  8018                                  
  8019                                  	;cmp	dx, [total_sectors+2]
  8020                                  	;ja	short ipt_stc	; invalid (partition size > disk capacity)
  8021                                  	;jb	short ipt_6
  8022                                  	;;cmp	ax, [total_sectors] ; (ax + 1) <= total sectors
  8023                                  	;jb	short ipt_6
  8024                                  	
  8025                                  ;ipt_stc:
  8026                                  ;	; invalid MBR data
  8027                                  ;	;stc
  8028                                  ;ipt_retn:
  8029                                  ;	retn
  8030                                  
  8031                                  ;ipt_heads_fix:
  8032                                  	; 10/02/2019
  8033                                  	; AL = [heads] - 1
  8034                                  
  8035                                  	;test	byte [cylinders], 1
  8036                                  	;jnz	short ipt_stc ; odd cylinder count (can not be shifted)
  8037                                  	
  8038                                  	;inc	al ; = [heads]
  8039                                  	;cmp	al, 8
  8040                                  	;ja	short ipt_stc ; this fix is needed for <= 16 heads (& 17 spt)
  8041                                  	;shl	al, 1
  8042                                  	;mov	[heads], al ; heads = heads*2
  8043                                  	;shr	word [cylinders], 1 ; cylinders = cylinders/2
  8044                                  	;jmp	ipt_4_fix
  8045                                  
  8046                                  ipt_6:
  8047                                  	;mov	[part_table_num_sec_lw+di], ax
  8048                                  	;mov	[part_table_num_sec_hw+di], dx
  8049                                  	; 09/03/2021
  8050 000021D7 668985[986C]            	mov	[part_table_num_sec+di], eax
  8051                                  
  8052                                  	;add	ax, [part_table_rel_sec_lw+di]
  8053                                  	;adc	dx, [part_table_rel_sec_hw+di]
  8054                                  	;;jc	short ipt_retn  ; invalid
  8055                                  	; 27/10/2020
  8056                                  	;jc	short ipt_13
  8057                                  	; 09/03/2021
  8058 000021DC 660385[946C]            	add	eax, [part_table_rel_sec+di]
  8059 000021E1 7207                    	jc	short ipt_13  ; invalid !
  8060                                  
  8061                                  	;cmp	dx, [total_sectors+2]
  8062                                  	;;ja	short ipt_stc	; invalid (partition end > disk capacity)
  8063                                  	;jb	short ipt_7
  8064                                  	; 27/10/2020
  8065                                  	;ja	short ipt_13
  8066                                  	;cmp	ax, [total_sectors] ; ax <= total sectors
  8067                                  	;;ja	short ipt_stc	; invalid (partition end > disk capacity)
  8068                                  	;jna	short ipt_7
  8069                                  	; 09/03/2011
  8070 000021E3 663B06[4265]            	cmp	eax, [total_sectors]
  8071 000021E8 7605                    	jna	short ipt_7
  8072                                  ipt_13:
  8073                                  	; 15/10/2020
  8074 000021EA C685[866C]FF            	mov	byte [part_table_boot_ind+di], 0FFh 
  8075                                  				; Invalid/Defective partition flag 
  8076                                  ipt_7:
  8077                                  	; 27/10/2020
  8078                                  	;mov	ax, 1022 ; CHS cylinder number limit
  8079                                  	;cmp	[part_table_start_cyl+di], ax
  8080                                  	;ja	short ipt_19 ; = 1023
  8081                                  	;inc	ax ; 1023
  8082                                  	;cmp	[part_table_end_cyl+di], ax
  8083                                  	;jb	short ipt_14  ; < 1023
  8084                                  	; 12/03/2021
  8085 000021EF 66B8FE030000            	mov	eax, 1022
  8086 000021F5 663985[896C]            	cmp	[part_table_start_cyl+di], eax
  8087 000021FA 7708                    	ja	short ipt_19 ; = 1023
  8088 000021FC 40                      	inc	ax
  8089 000021FD 663985[906C]            	cmp	[part_table_end_cyl+di], eax
  8090 00002202 7203                    	jb	short ipt_14  ; < 1023
  8091                                  ipt_19:
  8092                                  	; 27/10/2020
  8093                                  	; set cylinder number if the partition's start or end sector is
  8094                                  	; at the beyond of chs limit 
  8095                                  	; ax = 1022 -> set start cylinder
  8096                                  	; ax = 1023 -> set end cylinder
  8097 00002204 E82600                  	call	cylindernumberfix
  8098                                  ipt_14:
  8099 00002207 83C610                  	add	si, 16
  8100 0000220A E201                    	loop	ipt_5
  8101                                  	
  8102                                  	; OK!
  8103                                  
  8104                                  	;clc
  8105 0000220C C3                      	retn
  8106                                  
  8107                                  ipt_5:
  8108                                  	;add	di, 18
  8109                                  	; 05/11/2020
  8110 0000220D 83C716                  	add	di, 22
  8111 00002210 E9EAFE                  	jmp	ipt_0
  8112                                  
  8113                                  ipt_8:
  8114                                  	; Empty partition table check (all of 16 bytes must be 0)
  8115 00002213 51                      	push	cx
  8116 00002214 56                      	push	si ; 16/10/2020
  8117                                  	;mov	cl, 8
  8118 00002215 B104                    	mov	cl, 4 ; 12/03/2021
  8119                                  ipt_9:
  8120                                  	;lodsw
  8121                                  	;or	ax, ax
  8122                                  	;jnz	short ipt_10
  8123                                  	; 12/03/2021
  8124 00002217 66AD                    	lodsd
  8125 00002219 6609C0                  	or	eax, eax
  8126 0000221C 7507                    	jnz	short ipt_10
  8127 0000221E E2F7                    	loop	ipt_9
  8128 00002220 59                      	pop	cx ; 16/10/2020  ; (discard si)
  8129 00002221 59                      	pop	cx
  8130 00002222 E2E9                    	loop	ipt_5
  8131                                  	
  8132                                  	;clc
  8133 00002224 C3                      	retn
  8134                                  ipt_10:
  8135                                  	;pop	cx
  8136                                  	; invalid
  8137                                  	;stc
  8138                                  	; 27/10/2020
  8139                                  	; 15/10/2020
  8140                                  	;mov	byte [part_table_boot_ind+di], 0FFh
  8141                                  				; Invalid/Defective partition flag
  8142                                  	;retn
  8143                                  	; 16/10/2020
  8144                                  	; 31/10/2020
  8145                                  	;mov	byte [part_table_sys_id+di], 0	; Empty partition
  8146                                  	; 12/03/2021
  8147 00002225 6629C0                  	sub	eax, eax
  8148                                  	;
  8149 00002228 5E                      	pop	si
  8150 00002229 59                      	pop	cx
  8151 0000222A E93DFF                  	jmp	ipt_16
  8152                                  
  8153                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8154                                  ; set cylinder number to partition's start or end sector 
  8155                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8156                                  ; 27/10/2020
  8157                                  
  8158                                  	; 09/03/2021
  8159                                  	; 06/11/2020 (32 bit cylinder numbers, upto 267349)
  8160                                  cylindernumberfix:
  8161                                  	; ax = 1022 -> set start cylinder
  8162                                  	; ax = 1023 -> set end cylinder
  8163                                  	; di = partition table structure offset
  8164                                  
  8165                                  	;; modified registers: ax, dx, bx
  8166                                  	; modified registers: eax, edx ; 09/03/2021
  8167                                  	
  8168 0000222D 3DFF03                  	cmp	ax, 1023
  8169 00002230 733D                    	jnb	short cnf_4 ; set end cylinder
  8170                                  	
  8171 00002232 80BD[876C]FE            	cmp	byte [part_table_start_head+di], 0FEh ; 254
  8172 00002237 7536                    	jne	short cnf_4 ; no need to fix (start cyl) 
  8173                                  			; 30/10/2020
  8174                                  	; 28/10/2020
  8175 00002239 80BD[886C]3F            	cmp	byte [part_table_start_sector+di], 3Fh ; 63
  8176 0000223E 752F                    	jne	short cnf_4 ; no need to fix (start cyl)
  8177                                  			; 30/10/2020
  8178                                  
  8179                                  	;mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  8180                                  	;mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  8181                                  	;push	cx
  8182                                  	;mov	cx, [hs] ; [heads*spt]
  8183                                  	;call	div32
  8184                                  	;	; dx:ax = cylinder number, dx = 0, quotient	
  8185                                  	;	; bx = remainder
  8186                                  	;pop	cx
  8187                                  	;or 	dx, dx
  8188                                  	;jnz	short cnf_2 ; invalid
  8189                                  
  8190                                  	; 09/03/2021
  8191 00002240 668B85[946C]            	mov	eax, [part_table_rel_sec+di]
  8192 00002245 6631D2                  	xor	edx, edx
  8193 00002248 66F736[006A]            	div	dword [hs] ; [heads*spt] ; <= 16065
  8194                                  
  8195                                  	;cmp	ax, [part_table_start_cyl+di]
  8196                                  	; 09/03/2021
  8197 0000224D 663B85[896C]            	cmp	eax, [part_table_start_cyl+di]
  8198                                  	;je	short cnf_5
  8199 00002252 7407                    	je	short cnf_1
  8200 00002254 7213                    	jb	short cnf_2 ; invalid
  8201                                  	;mov	[part_table_start_cyl+di], ax ; change it
  8202                                  	; 09/03/2021
  8203 00002256 668985[896C]            	mov	[part_table_start_cyl+di], eax ; change it
  8204                                  	;jmp	short cnf_5 
  8205                                  cnf_1:
  8206 0000225B 80BD[8E6C]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  8207 00002260 7507                    	jne	short cnf_2 ; no need to fix (also invalid)
  8208                                  	
  8209                                  	; 28/10/2020
  8210 00002262 80BD[8F6C]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  8211 00002267 7414                    	je	short cnf_5 ; fix
  8212                                  	; no need to fix (also invalid)
  8213                                  cnf_2:
  8214 00002269 C685[866C]FF            	mov	byte [part_table_boot_ind+di], 0FFh ; invalid PTE
  8215                                  cnf_3:
  8216 0000226E C3                      	retn
  8217                                  cnf_4:
  8218 0000226F 80BD[8E6C]FE            	cmp	byte [part_table_end_head+di], 0FEh ; 254
  8219 00002274 75F8                    	jne	short cnf_3 ; no need to fix (end cyl)
  8220                                  	
  8221                                  	; 28/10/2020
  8222 00002276 80BD[8F6C]3F            	cmp	byte [part_table_end_sector+di], 3Fh ; 63
  8223 0000227B 75F1                    	jne	short cnf_3 ; no need to fix (end cyl)
  8224                                  cnf_5:
  8225                                  	;mov	ax, [part_table_rel_sec_lw+di] ; start sector, lw
  8226                                  	;mov	dx, [part_table_rel_sec_hw+di] ; start sector, hw
  8227                                  	;
  8228                                  	;add	ax, [part_table_num_sec_lw+di] ; number of sectors, lw 
  8229                                  	;adc	dx, [part_table_num_sec_hw+di] ; number of sectors, hw 
  8230                                  	;;jc	short cnf_2
  8231                                  
  8232                                  	; 09/03/2021
  8233 0000227D 668B85[946C]            	mov	eax, [part_table_rel_sec+di] ; start sector
  8234 00002282 660385[986C]            	add	eax, [part_table_num_sec+di] ; number of sectors
  8235                                  	;jc	short cnf_2 
  8236                                  
  8237                                  	;sub	ax, 1
  8238                                  	;sbb	dx, 0
  8239                                  	;	; dx:ax = end sector
  8240                                  	;push	cx
  8241                                  	;mov	cx, [hs] ; [heads*spt]
  8242                                  	;call	div32
  8243                                  	;	; dx:ax = cylinder number, dx = 0, quotient
  8244                                  	;	; bx = remainder
  8245                                  	;pop	cx
  8246                                  	;or 	dx, dx
  8247                                  	;jnz	short cnf_2 ; invalid
  8248                                  
  8249                                  	; 09/03/2021
  8250 00002287 6648                    	dec	eax  ; end sector
  8251 00002289 6631D2                  	xor	edx, edx ; 12/03/2021
  8252 0000228C 66F736[006A]            	div	dword [hs]  ; [heads*spt] ; <= 16065
  8253                                  
  8254                                  	;cmp	ax, [part_table_end_cyl+di]
  8255                                  	; 09/03/2021
  8256 00002291 663B85[906C]            	cmp	eax, [part_table_end_cyl+di]
  8257 00002296 74D6                    	je	short cnf_3 ; same cylinder number
  8258 00002298 72CF                    	jb	short cnf_2 ; invalid
  8259                                  	;mov	[part_table_end_cyl+di], ax ; change it
  8260                                  	; 09/03/2021
  8261 0000229A 668985[906C]            	mov	[part_table_end_cyl+di], eax ; change it
  8262 0000229F C3                      	retn
  8263                                  
  8264                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8265                                  ; sort partition table in (ending) cylinder number order
  8266                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8267                                  ; 25/10/2020 (fdisk3.s)
  8268                                  
  8269                                  	; 10/03/2021 (fdisk4.s)
  8270                                  	; 02/02/2019 (hdimage.s)
  8271                                  	
  8272                                  sort_partition_table:
  8273                                  
  8274                                  	; INPUT -> none
  8275                                  	; OUTPUT -> none
  8276                                  
  8277 000022A0 31DB                    	xor	bx, bx
  8278                                  	;jmp	short sortpt_2 ; 25/10/2020
  8279                                  sortpt_1:
  8280 000022A2 889F[166A]              	mov	[bx+sort], bl ; 0
  8281 000022A6 FEC3                    	inc	bl
  8282                                  sortpt_2:
  8283 000022A8 80FB04                  	cmp	bl, 4 ; number of partition table entries to sort
  8284 000022AB 72F5                    	jb	short sortpt_1
  8285                                  
  8286                                  	; Do a bubble sort
  8287                                  
  8288 000022AD EB04                    	jmp	short sortpt_4
  8289                                  sortpt_3:
  8290                                  	; Sort until we don't do a swap
  8291                                  
  8292 000022AF 08C9                    	or	cl, cl ; sort changed ?
  8293 000022B1 7454                    	jz	short sortpt_8 ; no
  8294                                  sortpt_4:
  8295 000022B3 30C9                    	xor	cl, cl
  8296                                  
  8297 000022B5 B301                    	mov	bl, 1
  8298                                  
  8299                                  	;mov	dl, 18  ; partition table structure size
  8300                                  	; 05/11/2020
  8301 000022B7 B216                    	mov	dl, 22
  8302 000022B9 EB07                    	jmp	short sortpt_6
  8303                                  sortpt_5:
  8304 000022BB FEC3                    	inc	bl
  8305                                  
  8306 000022BD 80FB04                  	cmp	bl, 4
  8307 000022C0 73ED                    	jnb	short sortpt_3
  8308                                  
  8309                                  sortpt_6:
  8310 000022C2 8A87[166A]              	mov	al, [bx+sort]
  8311                                  
  8312 000022C6 F6E2                    	mul	dl
  8313                                  
  8314 000022C8 89C6                    	mov	si, ax
  8315                                  
  8316                                  	;mov	di, [part_table_end_cyl+si]
  8317                                  
  8318 000022CA 8A87[156A]              	mov	al, [bx+sort-1]
  8319                                  
  8320 000022CE F6E2                    	mul	dl ; * 22 ; 05/11/2020
  8321                                  
  8322                                  	;xchg	di, ax
  8323                                  	; 10/03/2021
  8324 000022D0 89C7                    	mov	di, ax
  8325 000022D2 668B84[906C]            	mov	eax, [part_table_end_cyl+si]
  8326                                  
  8327                                  	;cmp	[part_table_end_cyl+di], ax ; previous > current
  8328                                  	; 10/03/2021
  8329 000022D7 663985[906C]            	cmp	[part_table_end_cyl+di], eax ; previous > current
  8330 000022DC 771B                    	ja	short sortpt_7 ; swap order indicators
  8331                                  		; 31/10/2020
  8332                                  		; current end cyl >= previous end cyl
  8333                                  	; 31/10/2020
  8334 000022DE 72DB                    	jb	short sortpt_5  
  8335                                  		; current end cyl > previous end cyl
  8336                                  	
  8337                                  	;and	ax, ax ; cylinder 0 ?
  8338                                  	; 10/03/2021
  8339 000022E0 6621C0                  	and	eax, eax ; cylinder 0 ?
  8340 000022E3 75D6                    	jnz	short sortpt_5 ; no
  8341                                  		; current end cyl = previous end cyl, cyl > 0
  8342                                  	
  8343                                  	; current end cyl = previous end cyl = 0
  8344                                  
  8345                                  	; If current entry is empty partition entry
  8346                                  	; and previous entry is not empty partition entry
  8347                                  	; swap them.
  8348                                  	
  8349                                  	;mov	ax, [part_table_num_sec_hw+di] ; previous entry
  8350                                  	;or	ax, [part_table_num_sec_lw+di]
  8351                                  	;jz	short sortpt_5
  8352                                  	; 10/03/2021
  8353 000022E5 668B85[986C]            	mov	eax, [part_table_num_sec+di] 
  8354 000022EA 6609C0                  	or	eax, eax
  8355 000022ED 74CC                    	jz	short sortpt_5
  8356                                  
  8357                                  	;mov	ax, [part_table_num_sec_hw+si] ; current entry
  8358                                  	;or	ax, [part_table_num_sec_lw+si]
  8359                                  	;jnz	short sortpt_5
  8360                                  	; 10/03/2021
  8361 000022EF 668B84[986C]            	mov	eax, [part_table_num_sec+si]
  8362 000022F4 6609C0                  	or	eax, eax
  8363 000022F7 75C2                    	jnz	short sortpt_5
  8364                                  sortpt_7:
  8365                                  	; Swap the order indicators
  8366                                  
  8367 000022F9 8B87[156A]              	mov	ax, [bx+sort-1]
  8368 000022FD 86E0                    	xchg	ah, al
  8369 000022FF 8987[156A]              	mov	[bx+sort-1], ax
  8370                                  
  8371 00002303 B101                    	mov	cl, 1 ; sort changed
  8372 00002305 EBB4                    	jmp	short sortpt_5
  8373                                  
  8374                                  sortpt_8:
  8375                                  	; 30/10/2020
  8376                                  	;mov 	byte [p_sorted], 1 ; 04/02/2019
  8377                                  
  8378                                  	; 10/03/2021
  8379                                  	;xor	eax, eax
  8380                                  
  8381 00002307 C3                      	retn
  8382                                  
  8383                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8384                                  ; find free space before/after/between partitions
  8385                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8386                                  ; 03/02/2019
  8387                                  
  8388                                  	; 12/03/2021
  8389                                  	; 11/03/2021 (fdisk4.s) -32 bit cylinder numbers-
  8390                                  	;
  8391                                  find_part_free_space:  ; find/calculate free space for partitions
  8392                                  	; 15/02/2019
  8393                                  
  8394                                  	; INPUT -> 
  8395                                  	;	AL = 0 -> calculate for primary/MBR partitions
  8396                                  	;	AL = 5 -> calculate for extended partition
  8397                                  	; OUTPUT ->
  8398                                  	;	CX = the largest free space/cylinders (between partitions)
  8399                                  	;	AX = Free space index (gap number) - from 0 to 4 -
  8400                                  	;	BX = Free space structure offset (for the largest free space)
  8401                                  	;
  8402                                  	;	22/02/2019
  8403                                  	;	[freespace_count] = number of free spaces/gaps
  8404                                  
  8405                                  	; 12/03/2021
  8406                                  	; OUTPUT:
  8407                                  	;   ECX = the largest free space/cylinders (between partitions)
  8408                                  	;    AX = Free space index (gap number) - from 0 to 4 -
  8409                                  	;    BX = Free space structure offset (for the largest free space)
  8410                                  	;   (EDX = 0)
  8411                                  
  8412 00002308 A2[306C]                	mov	[p_type], al
  8413                                  
  8414                                  	; Sort the partition table
  8415                                  
  8416 0000230B E892FF                  	call	sort_partition_table ; 16/02/2019
  8417                                  
  8418                                  	; Initialize free space to zero
  8419                                  
  8420                                  	; 15/02/2019
  8421 0000230E BF[3A6D]                	mov	di, fspc ; free_space.space
  8422 00002311 B92800                  	mov	cx, 5*8 ; (5*16/2)
  8423                                  	;mov	ecx, 5*8 ; 11/03/2021 
  8424                                  	;xor	ax, ax ; 0
  8425 00002314 6631C0                  	xor	eax, eax ; 11/03/2021
  8426 00002317 F3AB                    	rep	stosw
  8427                                  
  8428 00002319 A2[2E6C]                	mov	[freespace_count], al ; 0
  8429                                  	; 22/02/2019
  8430                                  	;mov	[last_found_partition], al ; 0
  8431                                  
  8432 0000231C A3[2C6C]                	mov	[_i_], ax ; 0
  8433                                  	;jmp	short fpfs_2
  8434                                  	; 31/10/020
  8435 0000231F EB0E                    	jmp	short fpfs_3
  8436                                  fpfs_1:	
  8437 00002321 FE06[2C6C]              	inc	byte [_i_]
  8438                                  ;;fpfs_2:
  8439 00002325 803E[2C6C]04            	cmp	byte [_i_], 4
  8440 0000232A 7203                    	jb	short fpfs_3
  8441 0000232C E96201                  	jmp	fpfs_13
  8442                                  fpfs_3:
  8443                                  	; Find space between start of disk and first partition
  8444                                  
  8445                                  	;mov	ax, [_i_]
  8446 0000232F 8B1E[2C6C]              	mov	bx, [_i_] ; 31/10/2020
  8447                                  fpfs_2:
  8448                                  	;mov	bx, ax ; 31/10/2020
  8449                                  	;mov	al, [sort+bx]
  8450 00002333 8A8F[166A]              	mov	cl, [sort+bx] ; 15/02/2019
  8451                                  
  8452                                  	;;mov	cl, 18 ; partition table structure size = 18 bytes
  8453                                  	;mov	al, 18 ; 15/02/2019
  8454                                  	; 05/11/2020
  8455 00002337 B016                    	mov	al, 22 ; partition table structure size = 22 bytes
  8456 00002339 F6E1                    	mul	cl
  8457 0000233B 89C3                    	mov	bx, ax
  8458                                  
  8459 0000233D 80BF[8D6C]00            	cmp	byte [part_table_sys_id+bx], 0
  8460 00002342 74DD                    	je	short fpfs_1
  8461                                  
  8462 00002344 880E[2F6C]              	mov	[last_found_partition], cl ; 15/02/2019
  8463                                  
  8464                                  	;xor	cx, cx
  8465 00002348 30C9                    	xor	cl, cl ; 0
  8466                                  	;mov	al, 1 ; LBA = 1 (after MBR) ; ah = 0
  8467                                  	; 03/11/2020
  8468 0000234A A0[B23C]                	mov	al, [sectors] ; 63 or 17 ; 03/11/2020	
  8469                                  
  8470 0000234D 803E[306C]05            	cmp	byte [p_type], 5  ; EXTENDED
  8471 00002352 7506                    	jne	short fpfs_4
  8472                                  
  8473                                  	; This is a special case - the extended partition can not start
  8474                                  	; on cylinder 0 due to its architecture. Protect against that here
  8475                                  
  8476                                  	; 13/02/2019
  8477                                  	; LBA value of free space start
  8478                                  	;mov	al, [sectors] ; 03/11/2020
  8479 00002354 F626[B43C]              	mul	byte [heads]
  8480                                  		; ax = start sector (for Extended Partition)
  8481 00002358 FEC1                    	inc	cl ; 1 ; cx = start cylinder = 1
  8482                                  fpfs_4:
  8483                                  	; Found a partition, get the space
  8484                                  
  8485                                  	; 15/02/2019
  8486                                  	;mov	dx, [part_table_start_cyl+bx] 
  8487                                  	;	       ; Start cylinder of the 1st partition (as sorted)
  8488                                  	;cmp	dx, cx ; (cx=0 for primary partition, cx=1 for extd partition)
  8489                                  	;jna	fpfs_9 ; It is accepted as free (partition) space
  8490                                  	;	       ; if this space between masterboot sector and partition 1
  8491                                  	;	       ; has 1 cylinder (heads*spt) size at least.
  8492                                  	
  8493                                  	; 11/03/2021
  8494 0000235A 668B97[896C]            	mov	edx, [part_table_start_cyl+bx]
  8495 0000235F 6639CA                  	cmp	edx, ecx
  8496 00002362 0F86B400                	jna	fpfs_9
  8497                                  
  8498                                  	; 22/02/2019
  8499 00002366 31FF                    	xor	di, di  ; 0 ; Reset Free Space Table offset
  8500                                  
  8501 00002368 FE06[2E6C]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  8502                                  
  8503                                  	;mov	[free_space.start], cx ; 0 (for PP) or 1 (for EP)
  8504                                  	; 11/03/2021
  8505 0000236C 66890E[3E6D]            	mov	[free_space.start], ecx	
  8506                                  
  8507                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  8508                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  8509                                  	;	if new partition will be selected as a primary dos partition.
  8510                                  	;	(But, start sector -LBA- will not be changed 
  8511                                  	;	 if it is a non-dos or user input type partition.. unless
  8512                                  	;	 cylinder boundary alignment option is used.)
  8513                                  	 	
  8514 00002371 A3[4A6D]                	mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  8515                                  					     ; or 1 (for PP)
  8516                                  	;mov	[free_space.startsector+2], 0
  8517                                  
  8518                                  	; free space ends before start of next valid partition
  8519                                  	;mov	ax, dx	; start cylinder of partition 1 (as sorted)
  8520                                  	;sub	dx, cx	; cylinder count of free space 1 (gap 1)
  8521                                  	;dec	ax	; end cylinder of free space 1 (gap 1)
  8522                                  	;mov	[free_space.end], ax
  8523                                  	;mov	[free_space.space], dx
  8524                                  	; 11/03/2021
  8525 00002374 6689D0                  	mov	eax, edx
  8526 00002377 6629CA                  	sub	edx, ecx
  8527 0000237A 6648                    	dec	eax
  8528 0000237C 66A3[426D]              	mov	[free_space.end], eax
  8529 00002380 668916[3A6D]            	mov	[free_space.space], edx
  8530                                  
  8531                                  	; save free space (1) as (non-aligned) sector count
  8532                                  	;mov	ax, [part_table_rel_sec_lw+bx]
  8533                                  	;mov	dx, [part_table_rel_sec_hw+bx]
  8534                                  	;sub	ax, [free_space.startsector]
  8535                                  	;sbb	dx, 0
  8536                                  	;mov	[free_space.sectors_unused], ax
  8537                                  	;mov	[free_space.sectors_unused+2], dx
  8538                                  	; 11/03/2021
  8539 00002385 668B87[946C]            	mov	eax, [part_table_rel_sec+bx]
  8540 0000238A 662B06[4A6D]            	sub	eax, [free_space.startsector]
  8541 0000238F 66A3[466D]              	mov	[free_space.sectors_unused], eax
  8542                                  
  8543                                  	;mov	ax, [free_space.space]
  8544                                  
  8545                                  	;call	cylinders_to_sectors
  8546                                  
  8547                                  	;mov	[free_space.sectors_unused], ax
  8548                                  	;mov	[free_space.sectors_unused+2], dx
  8549                                  
  8550                                  	;mov	cx, [cylinders]		; Total (disk) cylinders -divisor-
  8551                                  	;mov	bx, [free_space.space]	; Partition cylinders -dividend-
  8552                                  	; 12/03/2021
  8553 00002393 66A1[3A6D]              	mov	eax, [free_space.space]
  8554                                  
  8555 00002397 E8E501                  	call	cylinders_to_percent
  8556                                  
  8557 0000239A A3[4E6D]                	mov	[free_space.percent_unused], ax
  8558                                  
  8559                                  	; 15/02/2019
  8560                                  	;mov	bl, [_i_]
  8561                                  	;xor	bh, bh
  8562                                  	;mov	al, [sort+bx]
  8563                                  
  8564                                  	;mov	[last_found_partition], al
  8565                                  
  8566                                  	; 31/10/2020
  8567 0000239D EB7B                    	jmp	fpfs_9
  8568                                  
  8569                                  	; Look for space between the rest of the partitions
  8570                                  
  8571                                  fpfs_7:
  8572                                  	; ah = 0
  8573                                  	;mov	al, [_i_]
  8574                                  	;;cbw
  8575                                  	;mov	bx, ax
  8576                                  	; 22/02/2019
  8577 0000239F 8B1E[2C6C]              	mov	bx, [_i_]
  8578                                  
  8579                                  	; 15/02/2019
  8580                                  	;mov	al, [sort+bx]
  8581 000023A3 8A8F[166A]              	mov	cl, [sort+bx]
  8582                                  	;;mov	bl, 18
  8583                                  	;;mul	bl
  8584                                  	;mov	al, 18
  8585                                  	; 05/11/2020
  8586 000023A7 B016                    	mov	al, 22
  8587 000023A9 F6E1                    	mul	cl
  8588 000023AB 89C6                    	mov	si, ax
  8589                                  	
  8590 000023AD 80BC[8D6C]00            	cmp	byte [part_table_sys_id+si], 0
  8591 000023B2 7466                    	je	short fpfs_9
  8592                                  
  8593                                  	; 15/02/2019
  8594 000023B4 860E[2F6C]              	xchg	[last_found_partition], cl
  8595                                  
  8596                                  	; Check to see if more than one partition on a cylinder
  8597                                  	; If so, leave the space at zero */
  8598                                  
  8599                                  	; NOTE:
  8600                                  	; If free space (gap) between partitions
  8601                                  	; has 1 cylinder (heads*spt) size at least..
  8602                                  	; ..It is accepted as valid free (partition) space.
  8603                                  
  8604                                  	;mov	al, 18 ; Partition tables/data structure size = 18 bytes
  8605                                  	; 05/11/2020
  8606 000023B8 B016                    	mov	al, 22 ; Partition tables/data structure size = 22 bytes
  8607 000023BA F6E1                    	mul	cl
  8608 000023BC 89C3                    	mov	bx, ax  ; ah = 0
  8609                                  
  8610                                  	;mov	dx, [part_table_end_cyl+bx]   ; end cyl. of previous partition 
  8611                                  	;mov	ax, [part_table_start_cyl+si] ; start cyl. of current partition
  8612                                  	;
  8613                                  	;inc	dx  ; start cylinder of free space is after the end cylinder of
  8614                                  	;	    ; the previous partition (as sorted)
  8615                                  	;
  8616                                  	;cmp	ax, dx ; and it must be before than the next partition (as sorted)
  8617                                  	;jna	short fpfs_9 ; je short fpfs_9
  8618                                  	
  8619                                  	; 12/03/2021
  8620 000023BE 668B97[906C]            	mov	edx, [part_table_end_cyl+bx]   ; end cyl. of previous partition
  8621 000023C3 668B8C[896C]            	mov	ecx, [part_table_start_cyl+si] ; start cyl. of current partition
  8622                                  	
  8623 000023C8 6642                    	inc	edx ; start cylinder of free space is after the end cylinder of
  8624                                  		    ; the previous partition (as sorted)
  8625                                  	
  8626 000023CA 6639D1                  	cmp	ecx, edx ; and it must be before than the next partition (as sorted)
  8627 000023CD 764B                    	jna	short fpfs_9 ; je short fpfs_9
  8628                                  	
  8629                                  	; No, things are normal
  8630                                  	; Get space between the end of the last one and the start of the next one
  8631                                  
  8632                                  	; 22/02/2019
  8633                                  	;;add	di, 16
  8634                                  	;mov	di, [freespace_count]
  8635                                  	;shl	di, 4	; * 16 ; next entry offset (in free space table)
  8636                                  	; 12/03/2021
  8637 000023CF B016                    	mov	al, 22  ; ah = 0
  8638 000023D1 F626[2E6C]              	mul	byte [freespace_count]
  8639 000023D5 89C7                    	mov	di, ax
  8640                                  
  8641 000023D7 FE06[2E6C]              	inc	byte [freespace_count]
  8642                                  
  8643                                  	;mov	cx, ax
  8644 000023DB 6689C8                  	mov	eax, ecx
  8645                                  	;sub	cx, dx
  8646 000023DE 6629D1                  	sub	ecx, edx
  8647                                  	;dec	ax
  8648 000023E1 6648                    	dec	eax
  8649                                  	;mov	[free_space.start+di], dx
  8650                                  	;mov	[free_space.end+di], ax
  8651                                  	;mov	[free_space.space+di], cx
  8652                                  
  8653 000023E3 668995[3E6D]            	mov	[free_space.start+di], edx
  8654 000023E8 668985[426D]            	mov	[free_space.end+di], eax
  8655 000023ED 66898D[3A6D]            	mov	[free_space.space+di], ecx
  8656                                  
  8657                                  	;mov	ax, [free_space.space+di]
  8658                                  	;call	cylinders_to_sectors
  8659                                  	;mov	[free_space.sectors_unused+di], ax
  8660                                  	;mov	[free_space.sectors_unused+2+di], dx
  8661                                  
  8662                                  	; calculate and save (non-aligned) free sector count between partitions
  8663                                  
  8664                                  	;mov	ax, [part_table_rel_sec_lw+bx]
  8665                                  	;mov	dx, [part_table_rel_sec_hw+bx]
  8666                                  	; 12/03/2021
  8667 000023F2 668B87[946C]            	mov	eax, [part_table_rel_sec+bx]
  8668                                  
  8669                                  	;add	ax, [part_table_num_sec_lw+bx]
  8670                                  	;adc	dx, [part_table_num_sec_hw+bx]
  8671 000023F7 660387[986C]            	add	eax, [part_table_num_sec+bx]
  8672                                  
  8673                                  	;mov	cx, [part_table_rel_sec_lw+si]
  8674                                  	;mov	bx, [part_table_rel_sec_hw+si]
  8675 000023FC 668B94[946C]            	mov	edx, [part_table_rel_sec+si]
  8676                                  
  8677                                  	;mov	[free_space.startsector+di], ax
  8678                                  	;mov	[free_space.startsector+2+di], dx
  8679 00002401 668985[4A6D]            	mov	[free_space.startsector+di], eax
  8680                                  
  8681                                  	;sub	cx, ax
  8682                                  	;sbb	bx, dx
  8683 00002406 6629C2                  	sub	edx, eax
  8684                                  
  8685                                  	;mov	[free_space.sectors_unused+di], cx
  8686                                  	;mov	[free_space.sectors_unused+2+di], bx
  8687 00002409 668995[466D]            	mov	[free_space.sectors_unused+di], edx
  8688                                  
  8689                                  fpfs_8:
  8690                                  	; NOTE: Percentage is based on cylinder-boundary aligned partition size.
  8691                                  	; (total disk cylinders and partition's cylinder count are used for that)
  8692                                  
  8693                                  	;mov	cx, [cylinders] ; -divisor-
  8694                                  	;mov	bx, [free_space.space+di] ; -dividend-
  8695                                  	; 12/03/2021
  8696 0000240E 668B85[3A6D]            	mov	eax, [free_space.space+di]
  8697                                  
  8698 00002413 E86901                  	call	cylinders_to_percent
  8699                                  	
  8700 00002416 8985[4E6D]              	mov	[free_space.percent_unused+di], ax
  8701                                  	
  8702                                  	; ah = 0
  8703                                  
  8704                                  	; 15/02/2019
  8705                                  	;mov	bl, [_i_]
  8706                                  	;xor	bh, bh
  8707                                  	;mov	al, [sort+bx]
  8708                                  	;	
  8709                                  	;mov	[last_found_partition], al
  8710                                  
  8711                                  fpfs_9:
  8712 0000241A FE06[2C6C]              	inc	byte [_i_]
  8713                                  fpfs_10:
  8714 0000241E 803E[2C6C]04            	cmp	byte [_i_], 4
  8715 00002423 7303                    	jnb	short fpfs_11
  8716                                  
  8717 00002425 E977FF                  	jmp	fpfs_7
  8718                                  
  8719                                  fpfs_11:
  8720                                  	; Find the space between the last partition and the end of the disk
  8721                                  	; Make sure that freespace cannot become negative
  8722                                  
  8723 00002428 A0[2F6C]                	mov	al, [last_found_partition]
  8724                                  	;mov	cl, 18  ; Partition table structure size = 18 bytes
  8725                                  	; 05/11/2020
  8726 0000242B B116                    	mov	cl, 22  ; Partition table structure size = 22 bytes
  8727 0000242D F6E1                    	mul	cl
  8728 0000242F 89C3                    	mov	bx, ax
  8729                                  	;mov	cx, [cylinders]
  8730                                  	;dec	cx ; 15/02/2019 
  8731                                  	;	   ; (min. cylinder count = 1 for a valid/usable free space)
  8732                                  	;;mov	ax, [part_table_end_cyl+bx]
  8733                                  	; 12/03/2021
  8734 00002431 668B0E[B63C]            	mov	ecx, [cylinders]
  8735 00002436 6649                    	dec	ecx 	
  8736                                  
  8737                                  	; 05/11/2020
  8738                                  	;cmp	[part_table_end_cyl+bx], cx
  8739                                  	;;cmp	ax, cx	; cx = end cylinder of the disk
  8740                                  	;jb	short fpfs_12
  8741                                  	; 12/03/2021
  8742 00002438 66398F[906C]            	cmp	[part_table_end_cyl+bx], ecx
  8743 0000243D 7203                    	jb	short fpfs_12
  8744                                  
  8745 0000243F E99E00                  	jmp	fpfs_15
  8746                                  fpfs_12:
  8747                                  	; 22/02/2019
  8748                                  	;mov	di, [freespace_count]
  8749                                  	;;shl	di, 4 ; * 16  ; next entry offset (in free space table)
  8750                                  	; 05/11/2020
  8751                                  	;mov	ax, 22
  8752                                  	;mul	word [freespace_count]
  8753                                  	;mov	di, ax
  8754                                  	; 12/03/2021
  8755 00002442 B016                    	mov	al, 22
  8756 00002444 F626[2E6C]              	mul	byte [freespace_count]
  8757 00002448 89C7                    	mov	di, ax
  8758                                  
  8759 0000244A FE06[2E6C]              	inc	byte [freespace_count]
  8760                                  
  8761                                  	;mov	[free_space.end+di], cx	; end cyl. of free space 5 (gap 5) 
  8762                                  	; 12/03/2021
  8763 0000244E 66898D[426D]            	mov	[free_space.end+di], ecx
  8764                                  
  8765                                  	; 05/11/2020
  8766                                  	;mov	ax, [part_table_end_cyl+bx]
  8767                                  	;mov	dx, cx	; cx = end cylinder of the disk
  8768                                  	;sub	dx, ax	; ax = end cylinder of the last partition
  8769                                  	;mov	[free_space.space+di], dx ; di = 4*22 ; 05/11/2020
  8770                                  	;inc	ax
  8771                                  	;mov	[free_space.start+di], ax
  8772                                  	; 12/03/2021
  8773 00002453 668B87[906C]            	mov	eax, [part_table_end_cyl+bx]
  8774                                  	; eax = end cylinder of the last partition
  8775                                  	; ecx = end cylinder of the disk
  8776 00002458 6629C1                  	sub	ecx, eax
  8777 0000245B 66898D[3A6D]            	mov	[free_space.space+di], ecx ; di = 4*22
  8778 00002460 6640                    	inc	eax
  8779 00002462 668985[3E6D]            	mov	[free_space.start+di], eax
  8780                                  
  8781                                  	;inc	cx ; [cylinders]
  8782                                  	;mov	ax, [free_space.space+si]
  8783                                  	;call	cylinders_to_sectors
  8784                                  	;mov	[free_space.sectors_unused+di], ax
  8785                                  	;mov	[free_space.sectors_unused+2+di], dx
  8786                                  
  8787                                  	; calculate and save (non-aligned) free sector count
  8788                                  
  8789                                  	; 22/02/2019
  8790                                  	;mov	ax, [part_table_rel_sec_lw+bx]
  8791                                  	;mov	dx, [part_table_rel_sec_hw+bx]
  8792                                  	;add	ax, [part_table_num_sec_lw+bx]
  8793                                  	;adc	dx, [part_table_num_sec_hw+bx]
  8794                                  	; 12/03/2021
  8795 00002467 668B87[946C]            	mov	eax, [part_table_rel_sec+bx]
  8796 0000246C 660387[986C]            	add	eax, [part_table_num_sec+bx]
  8797                                  
  8798                                  	;mov	[free_space.startsector+di], ax
  8799                                  	;mov	[free_space.startsector+2+di], dx
  8800 00002471 668985[4A6D]            	mov	[free_space.startsector+di], eax
  8801                                  
  8802                                  	;mov	cx, [total_sectors]
  8803                                  	;mov	bx, [total_sectors+2]
  8804                                  	;sub	cx, ax
  8805                                  	;sbb	bx, dx
  8806                                  	; 12/03/2021
  8807 00002476 668B0E[4265]            	mov	ecx, [total_sectors]
  8808 0000247B 6629C1                  	sub	ecx, eax
  8809                                  
  8810                                  	;mov	[free_space.sectors_unused+di], cx
  8811                                  	;mov	[free_space.sectors_unused+2+di], bx
  8812 0000247E 66898D[466D]            	mov	[free_space.sectors_unused+di], ecx
  8813                                  
  8814                                  	;mov	cx, [cylinders]
  8815                                  	;mov	bx, [free_space.space+di]
  8816                                  	; 12/03/2021
  8817 00002483 668B85[3A6D]            	mov	eax, [free_space.space+di]
  8818 00002488 E8F400                  	call	cylinders_to_percent
  8819 0000248B 8985[4E6D]              	mov	[free_space.percent_unused+di], ax
  8820 0000248F EB4F                    	jmp	short fpfs_15
  8821                                  
  8822                                  fpfs_13:
  8823                                  	; No partitions found, show entire space as free
  8824                                  
  8825                                  	; 22/02/2019
  8826 00002491 FE06[2E6C]              	inc	byte [freespace_count]	; mov byte [freespace_count], 1
  8827                                  	
  8828                                  	; 15/02/2019
  8829                                  	;;sub	ax, ax
  8830                                  	;; ah = 0 ; 31/10/2020
  8831                                  	;sub	dx, dx
  8832                                  	; 12/03/2021
  8833 00002495 6629D2                  	sub	edx, edx
  8834                                  
  8835                                  	;;inc	al ; LBA = 1 (after MBR) ; ah = 0
  8836                                  	;mov	al, 1 ; 25/02/2019
  8837                                  	; 12/03/2021
  8838 00002498 6631C0                  	xor	eax, eax
  8839 0000249B FEC0                    	inc	al ; eax = 1
  8840                                  
  8841                                  	;This is a special case - the extended partition can not start
  8842                                  	;on cylinder 0 due to its architecture. Protect against that here
  8843                                  
  8844 0000249D 803E[306C]05            	cmp	byte [p_type], 5 ; EXTENDED
  8845 000024A2 7509                    	jne	short fpfs_14
  8846                                  
  8847 000024A4 FEC2                    	inc	dl
  8848                                  
  8849                                  	; 15/02/2019
  8850                                  	; LBA value of free space start
  8851 000024A6 A0[B23C]                	mov	al, [sectors]
  8852 000024A9 F626[B43C]              	mul	byte [heads]
  8853                                  		; ax = start sector (for Extended Partition)
  8854                                  fpfs_14:
  8855                                  	;mov	[free_space.start], dx ; 0 or 1
  8856                                  	; 12/03/2021
  8857 000024AD 668916[3E6D]            	mov	[free_space.start], edx ; 0 or 1
  8858                                  
  8859                                  	; non-aligned address of start sector (for the 1st partition as sorted)
  8860                                  	; NOTE: later, start sector will be moved to (chs) head 1 and sector 1
  8861                                  	;	if new partition will be selected as a primary dos partition.
  8862                                  	 	
  8863                                  	;mov	[free_space.startsector], ax ; = [sectors]*[heads] (for EP)
  8864                                  	;				     ; or 1 (for PP)
  8865                                  	;;mov	[free_space.startsector+2], 0
  8866                                  	; 12/03/2021
  8867 000024B2 66A3[4A6D]              	mov	[free_space.startsector], eax
  8868                                  
  8869                                  	;mov	ax, [cylinders] ; disk capacity 
  8870                                  	;mov	cx, ax
  8871                                  	;dec	ax
  8872                                  	;mov	[free_space.end], ax
  8873                                  	;sub	ax, dx
  8874                                  	;inc	ax
  8875                                  	;mov	[free_space.space], ax
  8876                                  	; 12/03/2021
  8877 000024B6 66A1[B63C]              	mov	eax, [cylinders] ; disk capacity 
  8878 000024BA 6648                    	dec	eax
  8879 000024BC 66A3[426D]              	mov	[free_space.end], eax
  8880 000024C0 6629D0                  	sub	eax, edx
  8881 000024C3 6640                    	inc	eax
  8882 000024C5 66A3[3A6D]              	mov	[free_space.space], eax
  8883                                  
  8884                                  	;mov	ax, [total_sectors]
  8885                                  	;mov	dx, [total_sectors+2]
  8886                                  	;sub	ax, [free_space.startsector]
  8887                                  	;sbb	dx, 0
  8888                                  	;mov	[free_space.sectors_unused], ax
  8889                                  	;mov	[free_space.sectors_unused+2], dx
  8890                                  	; 12/03/2021
  8891 000024C9 66A1[4265]              	mov	eax, [total_sectors]
  8892 000024CD 662B06[4A6D]            	sub	eax, [free_space.startsector]
  8893 000024D2 66A3[466D]              	mov	[free_space.sectors_unused], eax
  8894                                  
  8895                                  	;;mov	cx, [cylinders]
  8896                                  	;mov	bx, [free_space.space]
  8897                                  	; 12/03/2021
  8898 000024D6 66A1[3A6D]              	mov	eax, [free_space.space]
  8899 000024DA E8A200                  	call	cylinders_to_percent
  8900 000024DD A3[4E6D]                	mov	[free_space.percent_unused], ax
  8901                                  
  8902                                  fpfs_15:
  8903                                  	; Find largest free space
  8904                                  	;sub	cx, cx
  8905                                  	; 12/03/2021
  8906 000024E0 6629C9                  	sub	ecx, ecx
  8907 000024E3 6629C0                  	sub	eax, eax
  8908                                  
  8909                                  	; 22/02/2019
  8910                                  	;sub	ax, ax
  8911 000024E6 31DB                    	xor	bx, bx
  8912 000024E8 8A16[2E6C]              	mov	dl, [freespace_count]
  8913 000024EC 08D2                    	or	dl, dl
  8914 000024EE 7423                    	jz	short fpfs_19
  8915 000024F0 8816[2C6C]              	mov	[_i_], dl
  8916                                  fpfs_16:
  8917                                  	;mov	dx, [free_space.space+bx]
  8918                                  	; 12/03/2021
  8919 000024F4 668B97[3A6D]            	mov	edx, [free_space.space+bx]
  8920                                  	;cmp	dx, cx
  8921 000024F9 6639CA                  	cmp	edx, ecx
  8922 000024FC 7605                    	jbe	short fpfs_17
  8923                                  	; 22/02/2019
  8924                                  	;mov	cx, dx ; Largest free space
  8925                                  	; 12/03/2021
  8926 000024FE 6689D1                  	mov	ecx, edx ; Largest free space
  8927 00002501 89D8                    	mov	ax, bx
  8928                                  fpfs_17:
  8929 00002503 FE0E[2C6C]              	dec	byte [_i_]
  8930 00002507 7405                    	jz	short fpfs_18
  8931                                  
  8932                                  	;add	bx, 16 ; Free space structure size
  8933                                  	; 12/03/2021
  8934 00002509 83C316                  	add	bx, 22
  8935 0000250C EBE6                    	jmp	short fpfs_16
  8936                                  fpfs_18:
  8937                                  	; 22/02/2019
  8938 0000250E 89C3                    	mov	bx, ax ; offset (from 0 to 64)
  8939                                  	; bx = offset (from 0 to 88) ; 12/03/2021
  8940 00002510 C0E804                  	shr	al, 4  ; index (from 0 to 4)
  8941                                  fpfs_19:
  8942 00002513 6631D2                  	xor	edx, edx ; 12/03/2021
  8943 00002516 C3                      	retn
  8944                                  
  8945                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8946                                  ; find enough free space
  8947                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8948                                  
  8949                                  ;	; 15/02/2019
  8950                                  ;find_enough_free_space:
  8951                                  ;	; Find enough free space
  8952                                  ;	;
  8953                                  ;	; INPUT:
  8954                                  ;	;	AX = Requested space (in cylinders)
  8955                                  ;	;	22/02/2019
  8956                                  ;	;	[freespace_count] = number of free spaces/gaps
  8957                                  ;	; OUTPUT:
  8958                                  ;	;	AX = Available space
  8959                                  	;	DX = Requested space
  8960                                  ;	;	If CF = 0 -> AX >= DX
  8961                                  ;	;	If CF = 1 -> AX < DX
  8962                                  ;	;	CX = Index of available space in free space structure
  8963                                  ;	;	     (GAP number, 0 to 4) - if AX > 0 -
  8964                                  ;
  8965                                  ;	mov	dx, ax ; 22/02/2019
  8966                                  ;	sub	ax, ax
  8967                                  ;	xor	bx, bx
  8968                                  ;	; 22/02/2019
  8969                                  ;	mov	ch, [freespace_count]
  8970                                  ;	mov	[_i_], ax ; 0
  8971                                  ;	jmp	short fefs_1
  8972                                  ;fefs_0:
  8973                                  ;	;mov	al, 16
  8974                                  ;	;mul	byte [_i_]
  8975                                  ;	;mov	bx, ax
  8976                                  ;	mov	bl, [_i_]
  8977                                  ;	shl	bl, 4 ; * 16
  8978                                  ;fefs_1:
  8979                                  ;	mov	ax, [free_space.space+bx]
  8980                                  ;	and	ax, ax
  8981                                  ;	jz	short fefs_2 ; not a free space
  8982                                  ;	mov	cl, [_i_] 
  8983                                  ;	cmp	ax, dx
  8984                                  ;	jnb	short fefs_3 ; enough space
  8985                                  ;fefs_2:
  8986                                  ;	; 22/02/2019
  8987                                  ;	inc	byte [_i_]
  8988                                  ;	cmp	byte [_i_], ch
  8989                                  ;	jb	short fefs_0
  8990                                  ;	sub	ch, ch
  8991                                  ;	stc
  8992                                  ;	retn
  8993                                  ;fefs_3:
  8994                                  ;	xor	ch, ch
  8995                                  ;	retn
  8996                                  
  8997                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  8998                                  ; find enough free sectors
  8999                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9000                                  
  9001                                  	; 15/03/2021 (fdisk4.s)
  9002                                  	;	((32 bit registers, 32 bit cylinder numbers))
  9003                                  	; 15/02/2019
  9004                                  find_enough_free_sectors:
  9005                                  	; Find (first) enough free space in sectors
  9006                                  	;
  9007                                  	; INPUT:
  9008                                  	;	DX:AX = Requested space (as non-aligned free sectors)
  9009                                  	;	22/02/2019
  9010                                  	;	[freespace_count] = number of free spaces/gaps
  9011                                  	; OUTPUT:
  9012                                  	;	DX:AX = Available space
  9013                                  	;	If CF = 0 -> DX:AX >= Request
  9014                                  	;	If CF = 1 -> DX:AX < Request
  9015                                  	;	CX = Index of available space in free space structure
  9016                                  	;	     (GAP number, 0 to 4) - if DX:AX > 0 -
  9017                                  
  9018                                  	; 15/03/2021
  9019                                  	; INPUT:
  9020                                  	;	EAX = Requested space (as non-aligned free sectors)
  9021                                  	;	[freespace_count] = number of free spaces/gaps
  9022                                  	; OUTPUT:
  9023                                  	;	EAX = Available space
  9024                                  	;	If CF = 0 -> EAX >= Request
  9025                                  	;	If CF = 1 -> EAX < Request
  9026                                  	;	CX = Index of available space in free space structure
  9027                                  	;	     (GAP number, 0 to 4) - if EAX > 0 -
  9028                                  
  9029                                  	;xor	di, di
  9030                                  	;xor	si, si
  9031                                  	; 15/03/2021
  9032 00002517 6631D2                  	xor	edx, edx
  9033                                  
  9034 0000251A 31DB                    	xor	bx, bx
  9035                                  	; 22/02/2019
  9036 0000251C 8A2E[2E6C]              	mov	ch, [freespace_count]
  9037 00002520 891E[2C6C]              	mov	[_i_], bx ; 0
  9038 00002524 EB07                    	jmp	short fefss_1
  9039                                  fefss_0:
  9040                                  	;mov	al, 16
  9041                                  	;mul	byte [_i_]
  9042                                  	;mov	bx, ax
  9043 00002526 8B1E[2C6C]              	mov	bx, [_i_]
  9044 0000252A C0E304                  	shl	bl, 4 ; * 16
  9045                                  fefss_1:
  9046 0000252D 81C3[466D]              	add	bx, free_space.sectors_unused
  9047                                  	;cmp	dx, [bx+2]
  9048                                  	;jb	short fefss_7
  9049                                  	;ja	short fefss_2
  9050                                  	;cmp	ax, [bx]
  9051                                  	;je	short fefss_8
  9052                                  	;jb	short fefss_7 ; 18/02/2019
  9053                                  	; 15/03/2021
  9054 00002531 663B07                  	cmp	eax, [bx]
  9055 00002534 7426                    	je	short fefss_8 ; available space
  9056                                  			      ; = requested space
  9057 00002536 7221                    	jb	short fefss_7 ; > requested space
  9058                                  fefss_2:
  9059                                  	; 30/10/2020
  9060                                  	;;cmp	word [bx], 0
  9061                                  	;;jne	short fefss_3
  9062                                  	;;cmp	word [bx+2], 0
  9063                                  	;;je	short fefss_6
  9064                                  fefss_3:
  9065                                  	;cmp	di, [bx+2]
  9066                                  	;ja	short fefss_6
  9067                                  	;je	short fefss_4
  9068                                  	;mov	di, [bx+2]
  9069                                  	;jmp	short fefss_5
  9070                                  fefss_4:
  9071                                  	;cmp	si, [bx]
  9072                                  	;jnb	short fefss_6
  9073                                  	; 15/03/2021
  9074 00002538 66673B3B                	cmp	edi, [ebx]
  9075 0000253C 7307                    	jnb	short fefss_6
  9076                                  fefss_5:
  9077                                  	;mov	si, [bx]
  9078                                  	; 15/03/2021
  9079 0000253E 668B17                  	mov	edx, [bx]
  9080                                  	; 22/02/2019
  9081 00002541 8A0E[2C6C]              	mov	cl, [_i_]
  9082                                  fefss_6:
  9083 00002545 FE06[2C6C]              	inc	byte [_i_]
  9084 00002549 382E[2C6C]              	cmp	byte [_i_], ch ; [freespace_count]
  9085 0000254D 72D7                    	jb	short fefss_0
  9086                                  	
  9087                                  	;mov	ax, si
  9088                                  	;mov	dx, di
  9089                                  	; 15/03/2021
  9090 0000254F 6689D0                  	mov	eax, edx ; (max.) available space
  9091                                  			 ; (< requested space)
  9092 00002552 6629D2                  	sub	edx, edx
  9093                                  	;
  9094 00002555 30ED                    	xor	ch, ch
  9095 00002557 F9                      	stc
  9096 00002558 C3                      	retn
  9097                                  fefss_7:
  9098                                  	;mov	ax, [bx]
  9099                                  	;mov	dx, [bx+2]
  9100                                  	; 15/03/2021
  9101 00002559 668B07                  	mov	eax, [bx] ; available space
  9102                                  			  ; (> requested space)
  9103                                  fefss_8:
  9104 0000255C 8B0E[2C6C]              	mov	cx, [_i_]
  9105                                  	; 15/03/2021
  9106 00002560 6631D2                  	xor	edx, edx
  9107                                  	;
  9108 00002563 C3                      	retn
  9109                                  
  9110                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9111                                  ; get first free partition table entry
  9112                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9113                                  
  9114                                  	; 16/02/2019
  9115                                  get_first_free_pte:
  9116                                  	; Find free partition table entry
  9117                                  	;
  9118                                  	; INPUT:
  9119                                  	;	none
  9120                                  	; OUTPUT:
  9121                                  	;	If CF = 0 -> CX = partition table entry number
  9122                                  	;	If CF = 1 -> there is not a free entry in partition table
  9123                                  
  9124 00002564 BE[A654]                	mov	si, MasterBootBuff+pTableOffset
  9125 00002567 31C9                    	xor	cx, cx
  9126                                  gffp_1:
  9127 00002569 8A4404                  	mov	al, [si+ptFileSystemID] ; 23/02/2019
  9128                                  
  9129 0000256C 20C0                    	and	al, al
  9130 0000256E 740E                    	jz	short gffp_3 ; empty
  9131                                  
  9132 00002570 80F903                  	cmp	cl, 3
  9133 00002573 7307                    	jnb	short gffp_2
  9134                                  
  9135 00002575 FEC1                    	inc	cl
  9136 00002577 83C610                  	add	si, 16 ; Partition table entry size
  9137 0000257A EBED                    	jmp	short gffp_1
  9138                                  gffp_2:
  9139                                  	; CL = 3
  9140 0000257C F9                      	stc
  9141 0000257D C3                      	retn
  9142                                  gffp_3:
  9143                                  	; CL = PTE number (0 to 3)
  9144 0000257E C3                      	retn 	
  9145                                  
  9146                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9147                                  ; convert cylinder count to sectors
  9148                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9149                                  ; 03/02/2019
  9150                                  
  9151                                  	; 15/03/2021 (fdisk4.s)
  9152                                  ;cylinders_to_sectors:
  9153                                  	; INPUT:
  9154                                  	;	ax = Cylinders (Total or partition's cylinder count)
  9155                                  	; OUTPUT:
  9156                                  	;	dx:ax = Sectors
  9157                                  
  9158                                  	; 15/03/2021
  9159                                  	; INPUT:
  9160                                  	;	eax = cylinders (Total or partition's cyl count)
  9161                                  	; OUTPUT:
  9162                                  	;	eax = sectors
  9163                                  
  9164                                  	;;mov	dx, [heads]
  9165                                  	;;mul	dx
  9166                                  	;; 30/10/2020
  9167                                  	;mul	word [heads]
  9168                                  	;; dx:ax = Number of tracks (cylinders*heads)
  9169                                  	;mov	cx, [sectors]
  9170                                  	;call	mul32
  9171                                  	;	; dx:ax = Number of sectors
  9172                                  	;retn
  9173                                  
  9174                                  	; 15/03/2021
  9175                                  	;mul	dword [hs] ; [heads] * [sectors]
  9176                                  	;; eax = number of sectors
  9177                                  	;retn
  9178                                  	
  9179                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9180                                  ; convert cylinder count to percent of disk size (total cylinders)
  9181                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9182                                  ; 03/02/2019
  9183                                  
  9184                                  	; 12/03/2021
  9185                                  	; 11/03/2021 (fdisk4.s) - 32 bit cylinder count-
  9186                                  	;
  9187                                  cylinders_to_percent:
  9188                                  
  9189                                  	; INPUT:
  9190                                  	;	bx = Number of cylinders (of partition) -dividend-
  9191                                  	;	cx = Total cylinders -divisor-
  9192                                  	; OUTPUT:
  9193                                  	;	ax = Percentage
  9194                                  
  9195                                  	;  if (cylinders_in == 0)
  9196                                  	;	 percentage_out = 0;
  9197                                  	;  else if (total_cylinders == 0)
  9198                                  	;           percentage_out = 0;
  9199                                  	;       else
  9200                                  
  9201                                  	; 11/03/2021
  9202                                  	; INPUT: dword [cylinders] ; number of total disk cylinders
  9203                                  	;	 eax = partition's cylinder count
  9204                                  	; OUTPUT: ax = pencentage
  9205                                  
  9206                                  	;or	bx, bx
  9207                                  	;jz	short ctpc_6 ; ax = 0 = percentage_out
  9208                                  	; 11/03/2021 
  9209 0000257F 6609C0                  	or	eax, eax
  9210 00002582 742B                    	jz	short ctpc_6 ; ax = 0 = percentage_out 	
  9211                                  ctpc_1:
  9212                                  	;or	cx, cx
  9213                                  	;jz	short ctpc_6
  9214                                  
  9215 00002584 668B0E[B63C]            	mov	ecx, [cylinders]
  9216 00002589 6609C9                  	or	ecx, ecx
  9217 0000258C 7421                    	jz	short ctpc_6
  9218                                  
  9219                                  	;mov	ax, 100
  9220                                  	;mul	bx ; [cylinders_in]
  9221                                  	;	; dx:ax = Dividend
  9222                                  	;	
  9223                                  	;mul	edx
  9224                                  	
  9225                                  	;call	div32 ; 100*cylinders_in / total_cylinders
  9226                                  	;	; DX:AX = Quotient
  9227                                  	;	; BX = Remainder
  9228                                  
  9229 0000258E 66BA64000000            	mov	edx, 100
  9230 00002594 66F7E2                  	mul	edx
  9231 00002597 66F7F1                  	div	ecx
  9232                                  
  9233                                  	; ax = percentage_out
  9234                                  
  9235                                  	; 12/03/2021
  9236 0000259A 66D1E9                  	shr	ecx, 1
  9237                                  
  9238                                  	;cmp	bx, cx	; is remainder >= total_cylinders/2 ?
  9239                                  	;jb	short ctpc_5 ; No.
  9240                                  
  9241 0000259D 6639CA                  	cmp	edx, ecx ; is remainder >= total_cylinders/2 ?
  9242 000025A0 7201                    	jb	short ctpc_5 ; No.
  9243                                  ctpc_4:
  9244 000025A2 40                      	inc	ax
  9245                                  ctpc_5:
  9246                                  	; 12/03/2021
  9247 000025A3 66BA64000000            	mov	edx, 100
  9248                                  	;cmp	ax, 100
  9249 000025A9 39D0                    	cmp	ax, dx ; 100
  9250 000025AB 7602                    	jbe	short ctpc_6
  9251                                  	;mov	ax, 100
  9252 000025AD 89D0                    	mov	ax, dx
  9253                                  ctpc_6:
  9254 000025AF C3                      	retn
  9255                                  
  9256                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9257                                  ; display partition table
  9258                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9259                                  ; 04/02/2019
  9260                                  
  9261                                  	; 12/03/2021
  9262                                  display_partition_table_x:
  9263 000025B0 66B805000000            	mov	eax, 5 ; display extended partition table
  9264 000025B6 EB03                    	jmp	short dpt_x
  9265                                  
  9266                                  	; 11/03/2021 (fdisk4.s)
  9267                                  display_partition_table:
  9268                                  
  9269                                  	; INPUT:
  9270                                  	;	al = 0 for MBR
  9271                                  	;	   = 5 for EBR (logical drives in extended partition)
  9272                                  	; OUTPUT:
  9273                                  	;	none
  9274                                  
  9275                                  ;pt_positions:
  9276                                  n_pos	equ 30 ; 1 byte	
  9277                                  
  9278                                  	; 12/03/2021
  9279 000025B8 6631C0                  	xor	eax, eax ; display primary partition table
  9280                                  dpt_x:
  9281 000025BB A2[316C]                	mov	[_e_], al
  9282                                  
  9283                                  	; clear screen
  9284 000025BE B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  9285 000025C1 CD10                    	int	10h
  9286                                  
  9287 000025C3 803E[316C]05            	cmp	byte [_e_], 5
  9288 000025C8 7507                    	jne	short dpt_1
  9289                                  dpt_0:
  9290 000025CA BD[E26C]                	mov	bp, ext_table_boot_ind
  9291 000025CD B045                    	mov	al, 'E'
  9292 000025CF EB05                    	jmp	short dpt_4
  9293                                  dpt_1:
  9294 000025D1 BD[866C]                	mov	bp, part_table_boot_ind
  9295 000025D4 B04D                    	mov	al, 'M'
  9296                                  dpt_4:
  9297 000025D6 BE[4255]                	mov	si, p_table_header
  9298 000025D9 88441E                  	mov	[si+n_pos], al
  9299 000025DC E8E0F3                         	call 	print_msg
  9300                                     
  9301 000025DF 31DB                    	xor	bx, bx
  9302 000025E1 891E[2C6C]              	mov	[_i_], bx
  9303                                  dpt_5:
  9304 000025E5 FE06[2C6C]              	inc	byte [_i_]
  9305                                  
  9306                                  	; BX = partition entry (0 to 3)
  9307                                  	; BP = partition table structure address
  9308                                  
  9309 000025E9 E86400                  	call	display_pt_entry  ; display partition table row
  9310                                  
  9311 000025EC 8B1E[2C6C]              	mov	bx, [_i_]
  9312                                  	
  9313 000025F0 80FB04                  	cmp	bl, 4
  9314 000025F3 72F0                    	jb	short dpt_5
  9315                                  
  9316 000025F5 BE[8356]                	mov	si, p_table_footer
  9317 000025F8 E8C4F3                         	call 	print_msg
  9318                                  
  9319                                  	; 27/02/2019
  9320 000025FB BF[9852]                	mov	di, str_disk_sectors
  9321                                  
  9322 000025FE 803E[316C]05            	cmp	byte [_e_], 5
  9323 00002603 741A                    	je	short dpt_9
  9324                                  
  9325                                  	; display total disk sectors
  9326                                  
  9327                                  	;mov	di, str_disk_sectors
  9328                                  
  9329                                  	;cmp	byte [di], '0'
  9330                                  	;jnb	short dpt_8
  9331                                  
  9332                                          ;mov	ax, [total_sectors]
  9333                                          ;mov	dx, [total_sectors+2]
  9334                                  	; 11/03/2021	
  9335 00002605 66A1[4265]              	mov	eax, [total_sectors]
  9336                                  	
  9337 00002609 E81F00                  	call	dpt_10
  9338                                  dpt_8:
  9339 0000260C BE[8252]                	mov	si, msg_disk_sectors
  9340                                  dpt_11:
  9341 0000260F E8ADF3                  	call	print_msg
  9342                                  
  9343 00002612 BE[9852]                	mov	si, str_disk_sectors
  9344 00002615 E8A7F3                  	call	print_msg
  9345                                  
  9346 00002618 BE[6C52]                	mov	si, CRLF
  9347 0000261B E8A1F3                  	call	print_msg
  9348                                  
  9349 0000261E C3                      	retn
  9350                                  
  9351                                  dpt_9:
  9352                                  	; display extended partition size
  9353                                  
  9354                                  	;mov	ax, [ep_Size]
  9355                                  	;mov	dx, [ep_Size+2]
  9356                                  	; 11/03/2021
  9357 0000261F 66A1[246C]              	mov	eax, [ep_Size]
  9358                                  
  9359 00002623 E80500                  	call	dpt_10
  9360                                  
  9361 00002626 BE[A352]                	mov	si, msg_ep_size
  9362 00002629 EBE4                    	jmp	short dpt_11
  9363                                  
  9364                                  dpt_10:
  9365 0000262B 89E6                    	mov	si, sp
  9366                                  	;mov	cx, 10
  9367                                  	; 11/03/2021
  9368 0000262D 66B90A000000            	mov	ecx, 10
  9369                                  dpt_6:
  9370                                  	;call	div32
  9371                                  	
  9372                                  	;add	bl, '0'
  9373                                  	;push	bx
  9374                                  	;and	ax, ax
  9375                                  	;jnz	short dpt_6
  9376                                  	;and	dx, dx
  9377                                  	;jnz	short dpt_6
  9378                                  
  9379 00002633 6631D2                  	xor	edx, edx
  9380 00002636 66F7F1                  	div	ecx
  9381                                  	; 21/03/2021
  9382 00002639 80C230                  	add	dl, '0' 
  9383 0000263C 52                      	push	dx
  9384 0000263D 6621C0                  	and	eax, eax
  9385 00002640 75F1                    	jnz	short dpt_6
  9386                                  
  9387 00002642 29E6                    	sub	si, sp
  9388 00002644 D1EE                    	shr	si, 1
  9389                                  dpt_7:
  9390 00002646 58                      	pop	ax
  9391 00002647 AA                      	stosb
  9392 00002648 4E                      	dec	si
  9393 00002649 75FB                    	jnz	short dpt_7
  9394                                  
  9395                                  	;xor	al, al
  9396 0000264B 6631C0                  	xor	eax, eax ; 11/03/2021
  9397 0000264E AA                      	stosb
  9398                                  
  9399                                  	; 27/02/2019
  9400 0000264F C3                      	retn
  9401                                  
  9402                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9403                                  ; display partition table entry/row
  9404                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9405                                  ; 04/02/2019
  9406                                  
  9407                                  ; 05/11/2020
  9408                                  
  9409                                  struc ptbl
  9410                                  
  9411 00000000 ??                      .boot_ind:	resb 1
  9412 00000001 ??                      .start_head:	resb 1
  9413 00000002 ??                      .start_sector:	resb 1
  9414                                  ;.start_cyl:	resw 1
  9415 00000003 ????????                .start_cyl:	resd 1
  9416 00000007 ??                      .sys_id:	resb 1
  9417 00000008 ??                      .end_head:	resb 1
  9418 00000009 ??                      .end_sector:	resb 1
  9419                                  ;.end_cyl:	resw 1
  9420 0000000A ????????                .end_cyl:	resd 1
  9421                                  ;.rel_sec_lw:	resw 1
  9422                                  ;.rel_sec_hw:	resw 1
  9423 0000000E ????????                .rel_sec:	resd 1
  9424                                  ;.num_sec_lw:	resw 1
  9425                                  ;.num_sec_hw:	resw 1
  9426 00000012 ????????                .num_sec:	resd 1
  9427                                  .size: ; 22 ; 05/11/2020
  9428                                  
  9429                                  endstruc
  9430                                  
  9431                                  	; 20/03/2021 (fdisk4.s)
  9432                                  display_pt_entry:
  9433                                  	; 24/10/2020 (fdisk3.s)
  9434                                  
  9435                                  	; INPUT:
  9436                                  	;	bl = partition entry
  9437                                  	;	bh = 0
  9438                                  	;	bp = partition table structure address
  9439                                  	; OUTPUT:
  9440                                  	;	none
  9441                                  
  9442                                  ; 24/10/2020 (fdisk3.s)
  9443                                  ;pt_positions:
  9444                                  p_pos	equ 3  ; 1 byte
  9445                                  s_pos	equ 6  ; 2+1 byte
  9446                                  bh_pos	equ 10 ; 2+1 bytes
  9447                                  bs_pos	equ 14 ; 2+1 bytes
  9448                                  bc_pos	equ 18 ; 2+1 bytes
  9449                                  fs_pos  equ 22 ; 2+1 bytes
  9450                                  eh_pos  equ 26 ; 2+1 bytes
  9451                                  es_pos	equ 30 ; 2+1 bytes
  9452                                  ec_pos	equ 34 ; 2+1 bytes
  9453                                  rs_pos	equ 42 ; 10 bytes
  9454                                  ns_pos	equ 53 ; 10 bytes
  9455                                  fsx_pos equ 64 ; 14 bytes
  9456                                  
  9457                                  ; 2019-2020 (hdimage.s)
  9458                                  ;;pt_positions:
  9459                                  ;p_pos	equ 7  ; 1 byte
  9460                                  ;s_pos	equ 9  ; 2+1 byte
  9461                                  ;bh_pos	equ 13 ; 2+1 bytes
  9462                                  ;bs_pos	equ 17 ; 2+1 bytes
  9463                                  ;bc_pos	equ 21 ; 2+1 bytes
  9464                                  ;fs_pos equ 25 ; 2+1 bytes
  9465                                  ;eh_pos equ 29 ; 2+1 bytes
  9466                                  ;es_pos	equ 33 ; 2+1 bytes
  9467                                  ;ec_pos	equ 37 ; 2+1 bytes
  9468                                  ;rs_pos	equ 42 ; 7 bytes
  9469                                  ;ns_pos	equ 52 ; 7 bytes
  9470                                  ;fsx_pos equ 61 ; 14 bytes
  9471                                  
  9472 00002650 55                      	push	 bp ; 23/02/2019
  9473                                  
  9474 00002651 08DB                    	or	bl, bl
  9475 00002653 7406                    	jz	short dpte_0
  9476                                  
  9477                                  	;xor	bh, bh
  9478 00002655 B016                    	mov	al, ptbl.size ; 22 ; 05/11/2020
  9479 00002657 F6E3                    	mul	bl
  9480 00002659 01C5                    	add	bp, ax
  9481                                  dpte_0:
  9482 0000265B 807E0700                	cmp	byte [bp+ptbl.sys_id], 0
  9483 0000265F 0F861501                	jna	dpte_9
  9484                                  
  9485 00002663 B768                    	mov	bh, 'h'
  9486                                  
  9487 00002665 BE[346C]                	mov	si, pte_row
  9488                                  
  9489                                  	; clear partition table display buffer/row
  9490 00002668 89F7                    	mov	di, si
  9491 0000266A B92800                  	mov	cx, 40
  9492 0000266D B82020                  	mov	ax, 2020h
  9493 00002670 F3AB                    	rep	stosw
  9494                                  
  9495 00002672 88D8                    	mov	al, bl
  9496 00002674 0431                    	add	al, '1'
  9497 00002676 884403                  	mov	[si+p_pos], al  ; partition number '1' to '4'
  9498                                  
  9499                                  	; partition status, type and CHS parameters
  9500                                  	; (as hexadecimal number)
  9501                                  
  9502                                  	;mov	al, [bp+ptbl.boot_ind]
  9503 00002679 8A4600                  	mov	al, [bp]
  9504 0000267C E814F4                  	call	byte_to_hex
  9505                                  
  9506 0000267F 894406                  	mov	[si+s_pos], ax
  9507 00002682 887C08                  	mov	[si+s_pos+2], bh ; 'h'
  9508                                  
  9509 00002685 8A4601                  	mov	al, [bp+ptbl.start_head]
  9510 00002688 E808F4                  	call	byte_to_hex
  9511                                  
  9512 0000268B 89440A                  	mov	[si+bh_pos], ax
  9513 0000268E 887C0C                  	mov	[si+bh_pos+2], bh ; 'h'
  9514                                  
  9515 00002691 8B4E03                  	mov	cx, [bp+ptbl.start_cyl]
  9516                                  	; 28/10/2020
  9517 00002694 81F9FF03                	cmp	cx, 1023
  9518 00002698 7603                    	jna	short dpte_10 ; cyl number is in CHS limit
  9519 0000269A B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  9520                                  			 ; to correct display PTE (CHS bytes)
  9521                                  dpte_10:
  9522 0000269D C0E506                  	shl	ch, 6
  9523 000026A0 8A4602                  	mov	al, [bp+ptbl.start_sector]
  9524 000026A3 08E8                    	or	al, ch
  9525 000026A5 E8EBF3                  	call	byte_to_hex
  9526                                  
  9527 000026A8 89440E                  	mov	[si+bs_pos], ax
  9528 000026AB 887C10                  	mov	[si+bs_pos+2], bh ; 'h'
  9529                                  
  9530                                  	;mov	al, [bp+ptbl.start_cyl]
  9531 000026AE 88C8                    	mov	al, cl
  9532 000026B0 E8E0F3                  	call	byte_to_hex
  9533                                  
  9534 000026B3 894412                  	mov	[si+bc_pos], ax
  9535 000026B6 887C14                  	mov	[si+bc_pos+2], bh ; 'h'
  9536                                  
  9537 000026B9 8A4607                  	mov	al, [bp+ptbl.sys_id]
  9538 000026BC E8D4F3                  	call	byte_to_hex
  9539                                  
  9540 000026BF 894416                  	mov	[si+fs_pos], ax
  9541 000026C2 887C18                  	mov	[si+fs_pos+2], bh ; 'h'
  9542                                  
  9543 000026C5 8A4608                  	mov	al, [bp+ptbl.end_head]
  9544 000026C8 E8C8F3                  	call	byte_to_hex
  9545                                  
  9546 000026CB 89441A                  	mov	[si+eh_pos], ax
  9547 000026CE 887C1C                  	mov	[si+eh_pos+2], bh ; 'h'
  9548                                  
  9549 000026D1 8B4E0A                  	mov	cx, [bp+ptbl.end_cyl]
  9550                                  	; 28/10/2020
  9551 000026D4 81F9FF03                	cmp	cx, 1023
  9552 000026D8 7603                    	jna	short dpte_11 ; cyl number is in CHS limit
  9553 000026DA B9FF03                  	mov	cx, 1023 ; fix cylinder number (to it's PTE value)
  9554                                  			 ; to correct display PTE (CHS bytes)
  9555                                  dpte_11:
  9556 000026DD C0E506                  	shl	ch, 6
  9557 000026E0 8A4609                  	mov	al, [bp+ptbl.end_sector]
  9558 000026E3 08E8                    	or	al, ch
  9559 000026E5 E8ABF3                  	call	byte_to_hex
  9560                                  
  9561 000026E8 89441E                  	mov	[si+es_pos], ax
  9562 000026EB 887C20                  	mov	[si+es_pos+2], bh ; 'h'
  9563                                  
  9564                                  	;mov	al, [bp+ptbl.end_cyl]
  9565 000026EE 88C8                    	mov	al, cl
  9566 000026F0 E8A0F3                  	call	byte_to_hex
  9567                                  
  9568 000026F3 894422                  	mov	[si+ec_pos], ax
  9569 000026F6 887C24                  	mov	[si+ec_pos+2], bh ; 'h'
  9570                                  
  9571                                  	; relative (start) sector address (lba)
  9572                                  	; (as decimal number)
  9573                                  
  9574                                  	;mov	ax, [bp+ptbl.rel_sec_lw]
  9575                                  	;mov	dx, [bp+ptbl.rel_sec_hw]
  9576                                  	; 20/03/2021
  9577 000026F9 668B460E                	mov	eax, [bp+ptbl.rel_sec] 
  9578                                  
  9579 000026FD 89E7                    	mov	di, sp
  9580                                  	; 20/03/2021
  9581                                  	;mov	cx, 10
  9582 000026FF 6631C9                  	xor	ecx, ecx
  9583 00002702 B10A                    	mov	cl, 10
  9584                                  dpte_1:
  9585                                  	;call	div32
  9586                                  	; 20/03/2021
  9587 00002704 6631D2                  	xor	edx, edx
  9588 00002707 66F7F1                  	div	ecx
  9589                                  
  9590                                  	;add	bl, '0'
  9591                                  	;push	bx
  9592                                  	; 20/03/2021
  9593 0000270A 80C230                  	add	dl, '0'
  9594 0000270D 52                      	push	dx ; ++*
  9595                                  
  9596                                  	;and	ax, ax
  9597                                  	;jnz	short dpte_1
  9598                                  	;and	dx, dx
  9599                                  	;jnz	short dpte_1
  9600                                  	; 20/03/2021
  9601 0000270E 6621C0                  	and	eax, eax
  9602 00002711 75F1                    	jnz	short dpte_1
  9603                                  
  9604 00002713 8D5C31                  	lea	bx, [si+rs_pos+7]
  9605                                  
  9606 00002716 29E7                    	sub	di, sp
  9607 00002718 D1EF                    	shr	di, 1
  9608 0000271A 29FB                    	sub	bx, di	
  9609                                  dpte_2:
  9610 0000271C 58                      	pop	ax ; ++*
  9611 0000271D 8807                    	mov	[bx], al
  9612 0000271F 4F                      	dec	di
  9613 00002720 7403                    	jz	short dpte_3
  9614                                  	
  9615 00002722 43                      	inc	bx
  9616 00002723 EBF7                    	jmp	short dpte_2
  9617                                  
  9618                                  dpte_3:
  9619                                  	; number of sectors)
  9620                                  	; (as decimal number)
  9621                                  
  9622                                  	;mov	ax, [bp+ptbl.num_sec_lw]
  9623                                  	;mov	dx, [bp+ptbl.num_sec_hw]
  9624                                  	; 20/03/2021
  9625 00002725 668B4612                	mov	eax, [bp+ptbl.num_sec] 
  9626                                  
  9627 00002729 89E7                    	mov	di, sp
  9628                                  	;mov	cx, 10
  9629                                  dpte_4:
  9630                                  	;call	div32
  9631                                  	; 20/03/2021
  9632 0000272B 31D2                    	xor	dx, dx
  9633 0000272D 66F7F1                  	div	ecx
  9634                                  	
  9635                                  	;add	bl, '0'
  9636                                  	;push	bx
  9637                                  	; 20/03/2021
  9638 00002730 80C230                  	add	dl, '0'
  9639 00002733 52                      	push	dx ; ++**
  9640                                  
  9641                                  	;and	ax, ax
  9642                                  	;jnz	short dpte_4
  9643                                  	;and	dx, dx
  9644                                  	;jnz	short dpte_4
  9645                                  	; 20/03/2021
  9646 00002734 6621C0                  	and	eax, eax
  9647 00002737 75F2                    	jnz	short dpte_4
  9648                                  
  9649 00002739 8D5C3C                  	lea	bx, [si+ns_pos+7]
  9650                                  
  9651 0000273C 29E7                    	sub	di, sp
  9652 0000273E D1EF                    	shr	di, 1
  9653 00002740 29FB                    	sub	bx, di	
  9654                                  dpte_5:
  9655 00002742 58                      	pop	ax ; ++**
  9656 00002743 8807                    	mov	[bx], al
  9657 00002745 4F                      	dec	di
  9658 00002746 7403                    	jz	short dpte_6
  9659                                  	
  9660 00002748 43                      	inc	bx
  9661 00002749 EBF7                    	jmp	short dpte_5
  9662                                  dpte_6:
  9663                                  	; set file system name
  9664                                  
  9665 0000274B 8A4607                  	mov	al, [bp+ptbl.sys_id]
  9666 0000274E BF[D23D]                	mov	di, valid_partitions
  9667 00002751 B91300                  	mov	cx, 19
  9668 00002754 F2AE                    	repnz	scasb
  9669 00002756 7405                    	jz	short dpte_7
  9670 00002758 B8[C43D]                	mov	ax, FS_OTHERS
  9671 0000275B EB0C                    	jmp	short dpte_8
  9672                                  dpte_7:
  9673 0000275D 81EF[D33D]              	sub	di, valid_partitions + 1
  9674 00002761 B80E00                  	mov	ax, 14
  9675 00002764 F7E7                    	mul	di
  9676 00002766 05[BA3C]                	add	ax, FileSys_Names
  9677                                  dpte_8:
  9678 00002769 8D7C40                  	lea	di, [si+fsx_pos]
  9679 0000276C 89C6                    	mov	si, ax
  9680 0000276E B107                    	mov	cl, 7
  9681 00002770 F3A5                    	rep	movsw
  9682                                  
  9683 00002772 BE[346C]                	mov	si, pte_row
  9684 00002775 E847F2                  	call	print_msg
  9685                                  dpte_9:
  9686 00002778 5D                      	pop	bp ; 23/02/2019
  9687                                  	
  9688 00002779 C3                      	retn
  9689                                  
  9690                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9691                                  ; fix partition table
  9692                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9693                                  ; 24/02/2019
  9694                                  
  9695                                  partition_table_fix:
  9696                                  	; DELETE or EXIT option for Invalid Partition Table Entry
  9697                                  	; INPUT: 
  9698                                  	;	DS:SI = PTE address in MBR buffer
  9699                                  	
  9700 0000277A 56                      	push	si  ; save PTE address
  9701                                  
  9702 0000277B 89F0                    	mov	ax, si
  9703 0000277D 2D[A654]                	sub	ax, MasterBootBuff+446
  9704 00002780 C0E804                  	shr	al, 4 ; / 16 
  9705 00002783 0431                    	add	al, '1'
  9706 00002785 A2[A45B]                	mov	[inv_pte_num], al
  9707                                  
  9708                                  	; DS:SI = PTE address in MBR buffer
  9709 00002788 E878F7                  	call	show_selected_partition
  9710                                  
  9711                                  	;mov	si, CRLF
  9712                                  	;call	print_msg
  9713                                  
  9714                                  	; Warning message...
  9715                                  
  9716 0000278B BE[805B]                	mov	si, msg_inv_pte
  9717 0000278E E82EF2                  	call	print_msg
  9718                                  
  9719 00002791 5F                      	pop	di  ; restore PTE address
  9720                                  ptf_0:	
  9721 00002792 30E4                    	xor	ah, ah
  9722 00002794 CD16                    	int	16h
  9723                                  
  9724 00002796 3C0D                    	cmp	al, 13
  9725 00002798 7406                    	je	short ptf_1
  9726                                  
  9727 0000279A 3C1B                    	cmp	al, 27
  9728 0000279C 75F4                    	jne	short ptf_0
  9729                                  
  9730 0000279E F9                      	stc
  9731 0000279F C3                      	retn
  9732                                  ptf_1:
  9733                                  	; Clear that (invalid) PTE
  9734 000027A0 31C0                    	xor	ax, ax	
  9735 000027A2 B90800                  	mov	cx, 8
  9736 000027A5 F3AB                    	rep	stosw
  9737                                  
  9738                                  	; Clear screen
  9739 000027A7 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  9740 000027AA CD10                    	int	10h
  9741                                  
  9742 000027AC C3                      	retn
  9743                                  
  9744                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9745                                  ; display (& edit) EXTENDED (DOS) partition table
  9746                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9747                                  ; 28/02/2019
  9748                                  
  9749                                  display_extended_pt:
  9750                                  	; 12/03/2021
  9751                                  	;mov	al, 5 ; extended partition (logical drives)
  9752                                  	;call	display_partition_table
  9753 000027AD E800FE                  	call	display_partition_table_x
  9754                                  
  9755 000027B0 BE[785D]                	mov	si, ebr_editing_options
  9756 000027B3 E809F2                  	call	print_msg
  9757                                  
  9758 000027B6 BE[2D5A]                	mov	si, enter_opt_num_cancel_msg
  9759 000027B9 E803F2                  	call	print_msg
  9760                                  
  9761 000027BC BE[6C52]                	mov	si, CRLF
  9762 000027BF E8FDF1                  	call	print_msg
  9763                                  dept_1:
  9764 000027C2 30E4                    	xor	ah, ah
  9765 000027C4 CD16                    	int	16h
  9766                                  
  9767 000027C6 3C30                    	cmp	al, '0'
  9768 000027C8 740C                    	je	short dept_2
  9769                                  
  9770 000027CA 3C31                    	cmp	al, '1'
  9771 000027CC 7464                    	je	short edit_ext_table_create
  9772 000027CE 3C32                    	cmp	al, '2'
  9773 000027D0 7407                    	je	short edit_ext_table_delete
  9774                                  		
  9775 000027D2 3C1B                    	cmp	al, 27 ; ESCape
  9776 000027D4 75EC                    	jne	short dept_1
  9777                                  dept_2:
  9778 000027D6 E9FADB                  	jmp	A_42
  9779                                  
  9780                                  edit_ext_table_delete:
  9781                                  	; 28/02/2019
  9782                                  	;mov	al, 5 ; extended partition (logical drives)
  9783                                  	;call	display_partition_table
  9784                                  	; 12/03/2021
  9785 000027D9 E8D4FD                  	call	display_partition_table_x
  9786                                  
  9787 000027DC BE[F75D]                	mov	si, msg_delete_ldd_q
  9788 000027DF E8DDF1                  	call	print_msg
  9789                                  
  9790                                  	;mov	si, CRLF
  9791                                  	;call	print_msg
  9792                                  eetd_1:
  9793 000027E2 30E4                    	xor	ah, ah
  9794 000027E4 CD16                    	int	16h
  9795                                  
  9796 000027E6 3C1B                    	cmp	al, 27
  9797 000027E8 7410                    	je	short eetd_2
  9798                                  
  9799 000027EA 24DF                    	and	al, 0DFh
  9800 000027EC 3C59                    	cmp	al, 'Y'
  9801 000027EE 7412                    	je	short eetd_yes
  9802 000027F0 3C4E                    	cmp	al, 'N'
  9803 000027F2 75EE                    	jne	short eetd_1
  9804                                  eetd_no:
  9805 000027F4 BE[AD59]                	mov	si, msg_NO ;  Write 'NO' (it may be shown for a moment)
  9806 000027F7 E8C5F1                  	call	print_msg
  9807                                  eetd_2:	
  9808 000027FA BE[6C52]                	mov	si, CRLF  ; Next line
  9809 000027FD E8BFF1                  	call	print_msg
  9810 00002800 EBAB                    	jmp	short display_extended_pt
  9811                                  eetd_yes:
  9812 00002802 BE[A759]                	mov	si, msg_YES ;  Write 'YES' (it may be shown for a moment)
  9813 00002805 E8B7F1                  	call	print_msg
  9814 00002808 BE[6C52]                	mov	si, CRLF  ; Next line
  9815 0000280B E8B1F1                  	call	print_msg
  9816 0000280E E8F905                  	call	delete_logical_drives
  9817 00002811 803E[146A]00            	cmp	byte [ldrives], 0
  9818 00002816 7795                    	ja	short display_extended_pt
  9819 00002818 E9B8DB                  	jmp	A_42
  9820                                  
  9821                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9822                                  ; logical drive count limit error 
  9823                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9824                                  
  9825                                  eetc_2:
  9826 0000281B BE[5D5E]                	mov	si, msg_create_ldd_max_error
  9827                                  eetc_10:
  9828 0000281E E89EF1                  	call	print_msg
  9829 00002821 BE[C852]                	mov	si, msg_press_any_key
  9830 00002824 E898F1                  	call	print_msg
  9831 00002827 30E4                    	xor	ah, ah
  9832 00002829 CD16                    	int	16h
  9833 0000282B EB80                    	jmp	display_extended_pt
  9834                                  
  9835                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9836                                  ; no free space in extended partition
  9837                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9838                                  	
  9839                                  	; 05/03/2019
  9840                                  eetc_9:
  9841 0000282D BE[9660]                	mov	si, msg_c_ldd_nofspc_error
  9842 00002830 EBEC                    	jmp	short eetc_10
  9843                                  
  9844                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9845                                  ; create logical dos drive in EXTENDED (DOS) partition
  9846                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  9847                                  ; 19/10/2020 (fdisk3.s) 
  9848                                  
  9849                                  	; 13/03/2021
  9850                                  	; 12/03/2021 (fdisk4.s)
  9851                                  edit_ext_table_create:	; 01/03/2019 (hdimage.s)
  9852                                  
  9853                                  ; Create Method: ; 04/03/2019
  9854                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
  9855                                  ;LDD 2 <- LDD_START1, ebr 2nd entry <- EBR 1
  9856                                  ;LDD 3 <- LDD_START2, ebr 2nd entry <- EBR 2
  9857                                  ;LDD 4 <- LDD_START3, ebr 2nd entry <- EBR 3
  9858                                  
  9859                                  	; 01/03/2019
  9860 00002832 803E[E16C]00            	cmp	byte [epnumber], 0 ; check extended partition
  9861 00002837 0F8695E4                	jna	B_07		; cancel with error message
  9862                                  
  9863                                  	; 05/03/2019
  9864 0000283B E89602                  	call	check_ext_free_space
  9865 0000283E 72ED                    	jc	eetc_9	; error, no free space in extented partition
  9866                                  
  9867                                  	; 30/10/2020
  9868                                  	;mov	[ep_free_sectors], ax
  9869                                  	;mov	[ep_free_sectors+2], dx
  9870                                  	; 12/03/2021
  9871 00002840 66A3[CC6D]              	mov	[ep_free_sectors], eax
  9872                                  
  9873 00002844 803E[146A]04            	cmp	byte [ldrives], 4
  9874 00002849 73D0                    	jnb	eetc_2	; error, write program limit message
  9875                                  
  9876                                  edit_ext_table_create_x: ; 02/03/2019
  9877                                  
  9878                                  	; Get logical drive size/cylinders (request) from user
  9879 0000284B E82903                  	call	get_ldd_size
  9880                                  	;cmp	word [lcylinders], 1 ; at least 1 cylinder
  9881                                  	;jb	display_extended_pt ; cancel
  9882                                  	; 13/03/2021
  9883 0000284E 66833E[D06D]01          	cmp	dword [lcylinders], 1 ; at least 1 cylinder
  9884 00002854 0F8255FF                	jb	display_extended_pt ; cancel
  9885                                  
  9886                                  	; 03/03/2019
  9887 00002858 A0[146A]                	mov	al, [ldrives]
  9888                                  
  9889                                  	;cmp	byte [ldrives], 1
  9890                                  	;jnb	short eetc_3	; skip verify MBR extended partition
  9891                                  
  9892 0000285B 20C0                    	and	al, al
  9893 0000285D 756C                    	jnz	short eetc_3
  9894                                  
  9895 0000285F 31ED                    	xor	bp, bp
  9896                                  
  9897                                  	; Read MBR at EBR buffer
  9898                                  	;xor	ah, ah ; 19/10/2020
  9899                                  	;xor	dx, dx
  9900                                  	; 09/03/2021
  9901 00002861 6631C0                  	xor	eax, eax	
  9902                                  
  9903 00002864 BB[1A6A]                	mov	bx, ebr_buffer
  9904 00002867 E864F1                  	call	read_hd_sector
  9905 0000286A 7219                    	jc	short eetc_0
  9906                                  
  9907                                  	;mov	al, [epnumber]
  9908                                  	;cbw
  9909                                  	;shl	al, 4 ; * 16
  9910                                  	; 13/03/2021
  9911                                  	; eax = 0
  9912 0000286C 30ED                    	xor	ch, ch
  9913 0000286E 8A0E[E16C]              	mov	cl, [epnumber]
  9914 00002872 C0E104                  	shl	cl, 4 ; * 16
  9915 00002875 BE[D86B]                	mov	si, ebr_buffer+446
  9916                                  	;add	si, ax
  9917 00002878 01CE                    	add	si, cx
  9918 0000287A BF[A654]                	mov	di, MasterBootBuff+446
  9919                                  	;add	di, ax
  9920 0000287D 01CF                    	add	di, cx
  9921                                  	;mov	cx, 8
  9922 0000287F B108                    	mov	cl, 8
  9923 00002881 F3A7                    	repe	cmpsw	; repeat comparising while cx > 0 and zf = 1
  9924 00002883 E30A                    	jcxz	eetc_1	; Extended partition entry is not changed 
  9925                                  	; Different PTE (means there is a new extended partition) 
  9926                                  eetc_0:
  9927                                  	; Write current MBR (with modified PT)
  9928 00002885 BB[E852]                	mov	bx, MasterBootBuff
  9929                                  	;xor	ax, ax
  9930                                  	;;xor	dx, dx
  9931                                  	; eax = 0 ; 13/03/2021
  9932 00002888 E892F1                  	call	write_hd_sector
  9933 0000288B 0F82CADE                	jc	print_error_code ; ! display error msg and then exit !
  9934                                  eetc_1:
  9935                                  	; clear	EBR buffer
  9936 0000288F BF[1A6A]                	mov	di, ebr_buffer
  9937                                  	;xor	ax, ax
  9938                                  	; eax = 0 ; 13/03/2021
  9939                                  	;mov	cx, 255
  9940 00002892 B1FF                    	mov	cl, 255 ; 13/03/2021
  9941 00002894 F3AB                    	rep	stosw
  9942 00002896 C70555AA                	mov	word [di], 0AA55h
  9943                                  
  9944                                  	; Set logical dos drive parameters in it's EBR
  9945 0000289A BF[D86B]                	mov	di, ebr_buffer+446
  9946                                  
  9947                                  	;mov	cx, [sectors]
  9948                                  	;sub	bx, bx ; 0
  9949                                  	; 13/03/2021
  9950 0000289D 660FB70E[B23C]          	movzx	ecx, word [sectors]
  9951                                  
  9952                                  	;mov	ax, [ep_StartSector]
  9953                                  	;mov	dx, [ep_StartSector+2]
  9954                                  	; 13/03/2021
  9955 000028A3 66A1[1C6C]              	mov	eax, [ep_StartSector]
  9956                                  
  9957                                  	; 03/03/2019
  9958                                  	; set partition start address & size
  9959                                  
  9960                                  	;mov	[ldd_start], ax
  9961                                  	;mov	[ldd_start+2], dx
  9962                                  	; 13/03/2021
  9963 000028A7 66A3[AC6D]              	mov	[ldd_start], eax
  9964                                  
  9965                                  	; 01/11/2020
  9966                                  	;cmp	word [lcylinders], 65535
  9967                                  	;		; sign for using all of available sectors
  9968                                  	;jb	short eetc_11
  9969                                  	; 13/03/2021
  9970 000028AB 66833E[D06D]FF          	cmp	dword [lcylinders], 0FFFFFFFFh
  9971 000028B1 7206                    	jb	short eetc_11
  9972                                  
  9973                                  	;mov	ax, [ep_free_sectors]
  9974                                  	;mov	dx, [ep_free_sectors+2]
  9975                                  	; 13/03/2021
  9976 000028B3 66A1[CC6D]              	mov	eax, [ep_free_sectors]
  9977                                  
  9978 000028B7 EB09                    	jmp	short eetc_12
  9979                                  eetc_11:
  9980                                  	;mov	al, [heads]
  9981                                  	;mul	byte [sectors]
  9982                                  	;mul	word [lcylinders]
  9983                                  	; 13/03/2021
  9984 000028B9 66A1[006A]              	mov	eax, [hs] ; [heads] * [sectors]
  9985 000028BD 66F726[D06D]            	mul	dword [lcylinders]
  9986                                  eetc_12:
  9987                                  	; 01/11/2020
  9988 000028C2 31ED                    	xor	bp, bp
  9989                                  	;mov	[ldd_size], ax
  9990                                  	;mov	[ldd_size+2], dx
  9991                                  	; 13/03/2021
  9992 000028C4 66A3[BC6D]              	mov	[ldd_size], eax
  9993                                  
  9994                                  	; 1st ldd start sector is always 63 or 17 (= spt)
  9995                                  	;sub	ax, cx ; cx = 63 or 17, [sectors]
  9996                                  	;sbb	dx, bx ; sbb dx, 0
  9997                                  
  9998                                  	; 01/11/2020	
  9999 000028C8 E9B700                  	jmp	eetc_4
 10000                                  
 10001                                  	;mov	[di+ptStartSector], cx
 10002                                  	;mov	[di+ptStartSector+2], bx
 10003                                  	;
 10004                                  	;; 01/11/2020
 10005                                  	;mov	[di+ptSectors], ax
 10006                                  	;mov	[di+ptSectors+2], dx
 10007                                  	;
 10008                                  	;mov	cx, ax
 10009                                  	;mov	bx, dx
 10010                                  	;; cx:bx = volume size of logical -dos- drive
 10011                                  	;
 10012                                  	;pop	ax ; ldd's LBA
 10013                                  	;pop	dx
 10014                                  	;; dx:ax = start sector address of ldd
 10015                                  	;
 10016                                  	;; 01/11/2020
 10017                                  	;add	cx, ax
 10018                                  	;adc	bx, dx
 10019                                  	;sub	cx, 1
 10020                                  	;sbb	bx, 0
 10021                                  	;; bx:cx = end sector address of ldd
 10022                                  	;push	cx
 10023                                  	;push	bx
 10024                                  	;
 10025                                  	;jmp	eetc_4
 10026                                  
 10027                                  eetc_3:
 10028                                  	; [ldrives] >= 1
 10029                                  	; Read EBR
 10030                                  	;mov	al, [ldrives]
 10031 000028CB 30E4                    	xor	ah, ah ; 02/11/2020
 10032 000028CD C0E002                  	shl	al, 2
 10033 000028D0 89C5                    	mov	bp, ax
 10034                                  
 10035                                  	; 03/03/2019
 10036                                  	;mov	ax, [bp+ldd_start-4]
 10037                                  	;mov	dx, [bp+ldd_start-2]
 10038                                  	; 09/03/2021
 10039 000028D2 668B86[A86D]            	mov	eax, [bp+ldd_start-4]
 10040                                  
 10041 000028D7 BB[1A6A]                	mov	bx, ebr_buffer
 10042 000028DA E8F1F0                  	call	read_hd_sector
 10043 000028DD 0F8278DE                	jc	print_error_code ; ! display error msg and then exit !
 10044                                  
 10045                                  	; 04/03/2019
 10046 000028E1 BE[E86B]                	mov	si, ebr_buffer+446+16 ; 2nd entry (next EBR)
 10047                                  	
 10048                                  	; 03/03/2019
 10049                                  	;mov	ax, [bp+ldd_start-4]
 10050                                  	;mov	dx, [bp+ldd_start-2]
 10051                                  	;add	ax, [bp+ldd_size-4]
 10052                                  	;adc	dx, [bp+ldd_size-2]
 10053                                  	; 13/03/2021
 10054 000028E4 668B86[A86D]            	mov	eax, [bp+ldd_start-4]
 10055 000028E9 660386[B86D]            	add	eax, [bp+ldd_size-4]
 10056                                  
 10057                                  	;mov	cx, [ep_StartSector]
 10058                                  	;mov	bx, [ep_StartSector+2]
 10059                                  	; 13/03/2021
 10060 000028EE 668B16[1C6C]            	mov	edx, [ep_StartSector]
 10061                                  
 10062                                  	;mov	[bp+ldd_start], ax
 10063                                  	;mov	[bp+ldd_start+2], dx
 10064                                  	; 13/03/2021
 10065 000028F3 668986[AC6D]            	mov	[bp+ldd_start], eax
 10066                                  
 10067                                  	;push	dx ; ldd's start sector LBA
 10068                                  	;push	ax
 10069                                  	; 13/03/2021
 10070 000028F8 6650                    	push	eax ; *	
 10071                                  
 10072                                  	;sub	ax, cx
 10073                                  	;sbb	dx, bx
 10074                                  	;; dx:ax = offset from start of the ep start sector
 10075                                  	; 13/03/2021
 10076 000028FA 6629D0                  	sub	eax, edx
 10077                                  	; eax = offset from start of the ep start sector
 10078                                  
 10079                                  	;mov	[si+ptStartSector], ax
 10080                                  	;mov	[si+ptStartSector+2], dx
 10081                                  	; 13/03/2021
 10082 000028FD 66894408                	mov	[si+ptStartSector], eax
 10083                                  
 10084                                  	; 01/11/2020
 10085                                  	;cmp	word [lcylinders], 65535
 10086                                  	;		; sign for using all of available sectors
 10087                                  	;jb	short eetc_13
 10088                                  	; 13/03/2021
 10089 00002901 66833E[D06D]FF          	cmp	dword [lcylinders], 0FFFFFFFFh
 10090 00002907 7206                    	jb	short eetc_13
 10091                                  
 10092                                  	;mov	ax, [ep_free_sectors]
 10093                                  	;mov	dx, [ep_free_sectors+2]
 10094                                  	; 13/03/2021
 10095 00002909 66A1[CC6D]              	mov	eax, [ep_free_sectors]
 10096                                  
 10097 0000290D EB09                    	jmp	short eetc_14
 10098                                  eetc_13:
 10099                                  	;mov	al, [heads]
 10100                                  	;mul	byte [sectors]
 10101                                  	;mul	word [lcylinders]
 10102                                  	; 13/03/2021
 10103 0000290F 66A1[006A]              	mov	eax, [hs] ; [heads] * [sectors]
 10104 00002913 66F726[D06D]            	mul	dword [lcylinders]
 10105                                  eetc_14:
 10106                                  	; 01/11/2020
 10107                                  	;mov	[bp+ldd_size], ax
 10108                                  	;mov	[bp+ldd_size+2], dx
 10109                                  	; 13/03/2021
 10110 00002918 668986[BC6D]            	mov	[bp+ldd_size], eax
 10111                                  
 10112                                   	;mov	[si+ptSectors], ax
 10113                                  	;mov	[si+ptSectors+2], dx
 10114                                  	; 13/03/2021
 10115 0000291D 6689440C                	mov	[si+ptSectors], eax
 10116                                  
 10117                                  	; 01/11/2020
 10118                                  	;mov	cx, ax
 10119                                  	;mov	bx, dx
 10120                                  	;; cx:bx = volume size of logical -dos- drive
 10121                                  	; 13/03/2021
 10122 00002921 6689C2                  	mov	edx, eax ; ldd's volume size
 10123                                  
 10124                                  	;pop	ax ; ldd's start sector LBA
 10125                                  	;pop	dx
 10126                                  	; 13/03/2021
 10127 00002924 6658                    	pop	eax ; *
 10128                                  
 10129                                  	; 01/11/2020
 10130                                  	;add	cx, ax
 10131                                  	;adc	bx, dx
 10132                                  	; 13/03/2021
 10133 00002926 6601C2                  	add	edx, eax ; ldd's start sector LBA
 10134                                  
 10135                                  	;sub	cx, 1
 10136                                  	;sbb	bx, 0
 10137                                  	;; bx:cx = end sector address of ldd
 10138                                  	; 13/03/2021
 10139 00002929 664A                    	dec	edx ; end sector address of ldd
 10140                                  
 10141                                  	;push	cx
 10142                                  	;push	bx
 10143                                  	; 13/03/2021
 10144 0000292B 6652                    	push	edx ; **
 10145                                  
 10146                                  	; calculate CHS from LBA
 10147 0000292D E8D801                  	call	lba_to_chs
 10148                                  		; ax = cylinder
 10149                                  		; dl = sector
 10150                                  		; dh = head
 10151                                  
 10152 00002930 C60400                  	mov	byte [si+ptBootable], 0
 10153 00002933 887401                  	mov	[si+ptBeginHead], dh
 10154 00002936 884403                  	mov	[si+ptBeginCylinder], al
 10155 00002939 C0E406                  	shl	ah, 6
 10156 0000293C 08E2                    	or	dl, ah
 10157 0000293E 885402                  	mov	[si+ptBeginSector], dl
 10158                                  
 10159                                   	;;mov	ax, [si+ptSectors]
 10160                                  	;;mov	dx, [si+ptSectors+2]
 10161                                   	;mov	ax, [bp+ldd_size]
 10162                                  	;mov	dx, [bp+ldd_size+2]
 10163                                  	;sub	ax, 1
 10164                                  	;sbb	dx, 0
 10165                                  	;add	ax, [bp+ldd_start]
 10166                                  	;adc	dx, [bp+ldd_start+2]
 10167                                  	;	; dx:ax = end sector
 10168                                  	
 10169                                  	; 01/11/2020
 10170                                  	;pop	ax
 10171                                  	;pop	dx
 10172                                  	;; dx:ax = end sector address of ldd
 10173                                  	; 13/03/2021
 10174 00002941 6658                    	pop	eax ; **
 10175                                  
 10176 00002943 E8C201                  	call	lba_to_chs
 10177                                  		; ax = cylinder
 10178                                  		; dl = sector
 10179                                  		; dh = head
 10180                                  		; 24/10/2020
 10181                                  		; bl = Extended partition ID
 10182                                  
 10183                                  	; 13/03/2021
 10184 00002946 6631C9                  	xor	ecx, ecx
 10185                                  		
 10186                                  	;mov	byte [si+ptFileSystemID], 5 ; EXTENDED
 10187                                  	; 24/10/2020
 10188 00002949 885C04                  	mov	[si+ptFileSystemID], bl ; EXTENDED ; 05h or 0Fh
 10189                                  	;
 10190 0000294C 887405                  	mov	[si+ptEndHead], dh
 10191 0000294F 884407                  	mov	[si+ptEndCylinder], al
 10192 00002952 C0E406                  	shl	ah, 6
 10193 00002955 08D4                    	or	ah, dl	
 10194 00002957 886406                  	mov	[si+ptEndSector], ah
 10195                                  
 10196                                  	; Write EBR
 10197                                  	;mov	ax, [bp+ldd_start-4]
 10198                                  	;mov	dx, [bp+ldd_start-2]
 10199                                  	; 13/03/2021
 10200 0000295A 668B86[A86D]            	mov	eax, [bp+ldd_start-4]
 10201                                  	
 10202 0000295F BB[1A6A]                	mov	bx, ebr_buffer
 10203 00002962 E8B8F0                  	call	write_hd_sector
 10204 00002965 0F82F0DD                	jc	print_error_code ; ! display error msg and then exit !
 10205                                  
 10206                                  	; clear	EBR buffer
 10207 00002969 BF[1A6A]                	mov	di, ebr_buffer
 10208 0000296C 31C0                    	xor	ax, ax
 10209                                  	;mov	cx, 255
 10210                                  	; 13/03/2021
 10211 0000296E B1FF                    	mov	cl, 255
 10212 00002970 F3AB                    	rep	stosw
 10213 00002972 C70555AA                	mov	word [di], 0AA55h
 10214                                  
 10215 00002976 BF[D86B]                	mov	di, ebr_buffer+446 ; 1st entry points to LDD
 10216                                  
 10217                                  	;mov	cx, [sectors]
 10218                                  	;sub	bx, bx ; 0
 10219                                  	; 13/03/2021
 10220 00002979 8A0E[B23C]              	mov	cl, [sectors]
 10221                                  	; ecx = [sectors]
 10222                                  
 10223                                  	; 01/11/2020
 10224                                  	;mov	ax, [bp+ldd_size]
 10225                                  	;mov	dx, [bp+ldd_size+2]
 10226                                  	; 13/03/2021
 10227 0000297D 668B86[BC6D]            	mov	eax, [bp+ldd_size]
 10228                                  
 10229                                  	;sub	ax, cx
 10230                                  	;sbb	dx, bx ; sbb dx, 0
 10231                                  eetc_4:
 10232                                  	;mov	[di+ptStartSector], cx
 10233                                  	;mov	[di+ptStartSector+2], bx
 10234                                  	; 13/03/2021
 10235 00002982 66894D08                	mov	[di+ptStartSector], ecx
 10236                                  
 10237                                  	; 01/11/2020
 10238                                  	; 1st ldd start sector is always 63 or 17 (= spt)
 10239                                  	;sub	ax, cx ; cx = 63 or 17, [sectors]
 10240                                  	;sbb	dx, bx ; sbb dx, 0
 10241                                  	; 13/03/2021
 10242 00002986 6629C8                  	sub	eax, ecx
 10243                                  
 10244                                  	; 01/11/2020
 10245                                  	;mov	[di+ptSectors], ax
 10246                                  	;mov	[di+ptSectors+2], dx
 10247                                  	; 13/03/2021
 10248 00002989 6689450C                	mov	[di+ptSectors], eax
 10249                                  
 10250                                  	;mov	cx, [bp+ldd_size]
 10251                                  	;mov	bx, [bp+ldd_size+2]
 10252                                  	;; cx:bx = volume size of logical -dos- drive
 10253                                  	; 13/03/2021
 10254 0000298D 668B96[BC6D]            	mov	edx, [bp+ldd_size]
 10255                                  
 10256                                  	;mov	ax, [bp+ldd_start]
 10257                                  	;mov	dx, [bp+ldd_start+2]
 10258                                  	;; dx:ax = start sector address of ldd (EBR addr)
 10259                                  	; 13/03/2021
 10260 00002992 668B86[AC6D]            	mov	eax, [bp+ldd_start]
 10261                                  
 10262                                  	; 01/11/2020
 10263                                  	;add	cx, ax
 10264                                  	;adc	bx, dx
 10265                                  	;sub	cx, 1
 10266                                  	;sbb	bx, 0
 10267                                  	;; bx:cx = end sector address of ldd
 10268                                  	; 13/03/2021
 10269 00002997 6601C2                  	add	edx, eax
 10270 0000299A 664A                    	dec	edx
 10271                                  
 10272                                  	;push	bx
 10273                                  	;push	cx
 10274                                  	; 13/03/2021
 10275 0000299C 6652                    	push	edx ; ***
 10276                                  ;eetc_4:
 10277                                  	; 01/11/2020
 10278                                  	; stack = end sector address of ldd
 10279                                  	; dx:ax = start sector address of ldd
 10280                                  
 10281                                  	; calculate CHS from LBA
 10282                                  
 10283 0000299E E86701                  	call	lba_to_chs
 10284                                  		; ax = cylinder
 10285                                  		; dl = sector
 10286                                  		; dh = head
 10287                                  
 10288                                  	;mov	byte [di+ptBootable], 0
 10289 000029A1 887501                  	mov	[di+ptBeginHead], dh
 10290 000029A4 884503                  	mov	[di+ptBeginCylinder], al
 10291                                  	;mov	bl, ah
 10292                                  	;shl	bl, 6
 10293                                  	;or	dl, bl
 10294                                  	; 01/11/2020
 10295 000029A7 C0E406                  	shl	ah, 6
 10296 000029AA 08E2                    	or	dl, ah
 10297 000029AC 885502                  	mov	[di+ptBeginSector], dl
 10298                                  
 10299                                  	;add	ax, [lcylinders]
 10300                                  	;dec	ax ; end cylinder
 10301                                  	;mov	bx, ax
 10302                                  
 10303                                  	; 01/11/2020
 10304                                  	;pop	ax
 10305                                  	;pop	dx
 10306                                  	;; dx:ax = end sector address of ldd
 10307                                  	; 13/03/2021
 10308 000029AF 6658                    	pop	eax ; ***
 10309                                  
 10310 000029B1 E85401                  	call	lba_to_chs
 10311                                  		; ax = cylinder number (0-1023)
 10312                                  		; dl = sector
 10313                                  		; dh = head
 10314                                  		; 01/11/2020
 10315                                  		; cx = cylinder number (0-65535)
 10316                                  		; 13/03/2021
 10317                                  		; ecx = cylinder number (0-267349)
 10318                                  
 10319                                  	;; 02/11/2020
 10320                                  	;;mov	[endcyl], cx ; 01/11/2020
 10321                                  	;xchg	[endcyl], cx 
 10322                                  		; cx = end cylinder of the ep
 10323                                  		; [endcyl] = end cylinder of the ldd
 10324                                  	; 13/03/2021
 10325 000029B4 66870E[D66D]            	xchg	[endcyl], ecx
 10326                                  
 10327                                  	;mov	[di+ptFileSystemID], 0
 10328                                  	;mov	cx, [heads]
 10329                                  	;dec	cl
 10330                                  	;mov	[di+ptEndHead], cl
 10331                                  	; 01/11/2020
 10332 000029B9 887505                  	mov	[di+ptEndHead], dh
 10333                                  
 10334 000029BC 884507                  	mov	[di+ptEndCylinder], al
 10335                                  	;mov	dx, [sectors]
 10336 000029BF C0E406                  	shl	ah, 6
 10337 000029C2 08D4                    	or	ah, dl
 10338 000029C4 886506                  	mov	[di+ptEndSector], ah
 10339                                  
 10340                                  	; 02/03/2019
 10341                                  	; Check unused space if it is 3rd LDD
 10342                                  	; (write message to add unused space.)
 10343                                  
 10344                                  	; 02/11/2020
 10345                                  	;cmp	byte [ldrives], 3
 10346                                  	;jb	eetc_7
 10347                                  
 10348                                  	; 01/11/2020
 10349                                  	;cmp	word [lcylinders], 65535  
 10350                                  	;		; sign for using all of available sectors
 10351                                  	;jnb	eetc_7	; no need to add unused sector 
 10352                                  	;		; (there are not any unused sectors)
 10353                                  	; 13/03/2021
 10354 000029C7 66833E[D06D]FF          	cmp	dword [lcylinders], 0FFFFFFFFh
 10355 000029CD 0F83A200                	jnb	eetc_7	; no need to add unused sector
 10356                                  	
 10357                                  	; cx = cylinder number (0 to 65535)
 10358                                  	; 13/03/2021
 10359                                  	; ecx = cylinder number (0 to 267349)
 10360                                  
 10361                                  	; 02/11/2020
 10362 000029D1 803E[146A]03            	cmp	byte [ldrives], 3 ; is this logical drive 4 ?
 10363 000029D6 730B                    	jnb	short eetc_17
 10364                                  			; force to show unused space message
 10365                                  
 10366                                  	; 02/11/2020
 10367                                  	; (add unused space if cyl nums are same or diff is 1)
 10368                                  	;dec	cx  ; tolerate cylinder numbers n and n-1 
 10369                                  	;cmp	cx, [endcyl]
 10370                                  	;ja	eetc_7  ; the end cyl number of the last ldd
 10371                                  	;		; is 2 or more cyls less than
 10372                                  	;		; the end cyl number of the ep
 10373                                  	;		; (a next ldd can be added to
 10374                                  	;		; extd partition with 2 or more cyls)
 10375                                  	; 13/03/2021
 10376 000029D8 6649                    	dec	ecx
 10377 000029DA 663B0E[D66D]            	cmp	ecx, [endcyl]
 10378 000029DF 0F879000                	ja	eetc_7
 10379                                  eetc_17:
 10380                                  	; 02/11/2020
 10381 000029E3 A0[146A]                	mov	al, [ldrives]
 10382                                  	;add	al, '0'
 10383 000029E6 0431                    	add	al, '1'	; 03/11/2020
 10384 000029E8 A2[D55E]                	mov	[char_lddn], al
 10385                                  
 10386                                  	;mov	al, [sectors]
 10387                                  	;mov	bh, al
 10388                                  	;mov	bl, [heads]
 10389                                  	;dec	bl
 10390                                  	;mul	bl ; [sectors] * [heads] - 1
 10391                                  	; 13/03/2021
 10392 000029EB 66A1[006A]              	mov	eax, [hs] ; [sectors] * [heads]
 10393 000029EF 6648                    	dec	eax ; [sectors] * [heads] - 1
 10394                                  	
 10395                                  	;push	ax
 10396                                  	; 13/03/2021
 10397 000029F1 6650                    	push	eax ; ****
 10398                                  
 10399                                  	;mov	al, bh  ; [sectors]
 10400                                  	;;mul	byte [heads]
 10401                                  	;inc	bl
 10402                                  	;mul	bl
 10403                                  	;	; ax = heads * sectors
 10404                                  	;;mul	cx ; * end cylinder
 10405                                  	;mul	word [endcyl] ; 02/11/2020
 10406                                  	;	; dx:ax = end cylinder * heads * sectors
 10407                                  	; 13/03/2021
 10408 000029F3 6640                    	inc	eax ; heads * sectors
 10409 000029F5 66F726[D66D]            	mul	dword [endcyl]
 10410                                  	; eax = ((cylinders-1) * heads * sectors)
 10411                                  	
 10412                                  	;pop	cx
 10413                                  	;add	ax, cx ; + (sectors * (heads - 1))
 10414                                  	;adc	dx, 0	
 10415                                  	; 13/03/2021
 10416 000029FA 665A                    	pop	edx ; ****
 10417 000029FC 6601D0                  	add	eax, edx ; + (sectors * (heads - 1))
 10418                                  
 10419                                  	; 03/03/2019
 10420                                  	;mov	cx, [sectors]
 10421                                  	;dec	cl  ; [sectors] - 1
 10422                                  	;add	ax, cx ; + (sectors - 1)
 10423                                  	;adc	dx, 0
 10424                                  	;	; DX:AX = end LBA
 10425                                  	; 13/03/2021
 10426 000029FF 6631D2                  	xor	edx, edx
 10427 00002A02 8A16[B23C]              	mov	dl, [sectors]
 10428 00002A06 FECA                    	dec	dl ; [sectors] - 1
 10429 00002A08 6601D0                  	add	eax, edx  ; + (sectors - 1)
 10430                                  
 10431                                  	;mov	cx, [ep_EndSector]
 10432                                  	;mov	bx, [ep_EndSector+2]
 10433                                  	; 13/03/2021
 10434 00002A0B 668B16[206C]            	mov	edx, [ep_EndSector]
 10435                                  
 10436                                  	;cmp	dx, bx
 10437                                  	;jne	short eetc_5
 10438                                  	;cmp	ax, cx
 10439                                  	;je	short eetc_7 ; 05/03/2019
 10440                                  	; 13/03/2021
 10441 00002A10 6639D0                  	cmp	eax, edx
 10442 00002A13 745E                    	je	short eetc_7
 10443                                  eetc_5:
 10444                                  	;push	bx
 10445 00002A15 BE[925E]                	mov	si, msg_c_ldd_unused_warning
 10446 00002A18 E8A4EF                  	call	print_msg
 10447                                  	;pop	bx
 10448                                  eetc_6:
 10449 00002A1B 28E4                    	sub	ah, ah
 10450 00002A1D CD16                    	int	16h
 10451 00002A1F 3C0D                    	cmp	al, 13 ; ENTER
 10452 00002A21 7450                    	je	short eetc_7 ; continue
 10453 00002A23 3C1B                    	cmp	al, 27 ; ESC
 10454 00002A25 75F4                    	jne	short eetc_6
 10455                                  
 10456                                  	; 03/03/2019
 10457                                  	; change end cylinder value
 10458 00002A27 A0[E16C]                	mov	al, [epnumber]
 10459 00002A2A FEC8                    	dec	al
 10460                                  	;mov	ah, 18  ; primary partition table structure size
 10461                                  	; 05/11/2020
 10462 00002A2C B416                    	mov	ah, 22	; primary partition table structure size
 10463 00002A2E F6E4                    	mul	ah
 10464 00002A30 89C6                    	mov	si, ax
 10465                                  	;mov	ax, [si+part_table_end_cyl]
 10466                                  	; 02/11/2020
 10467                                  	;mov	[endcyl], ax ; end cylinder of the ep
 10468                                  	; 13/03/2021
 10469 00002A32 668B84[906C]            	mov	eax, [si+part_table_end_cyl]
 10470 00002A37 66A3[D66D]              	mov	[endcyl], eax ; end cylinder of the ep
 10471                                  eetc_19:
 10472                                  	; 03/11/2020
 10473                                  	;cmp	ax, 1023 ; overs CHS limit ?
 10474                                  	;jna	short eetc_20 ; no
 10475                                  	;mov	ax, 1023 ; 03FFh ; fix end CHS values of the PTE
 10476                                  	; 13/03/2021
 10477 00002A3B 663DFF030000            	cmp	eax, 1023
 10478 00002A41 7606                    	jna	short eetc_20
 10479 00002A43 66B8FF030000            	mov	eax, 1023
 10480                                  eetc_20:
 10481 00002A49 884507                  	mov	[di+ptEndCylinder], al
 10482 00002A4C 8A84[8F6C]              	mov	al, [si+part_table_end_sector]
 10483 00002A50 C0E406                  	shl	ah, 6
 10484 00002A53 08C4                    	or	ah, al	
 10485 00002A55 886506                  	mov	[di+ptEndSector], ah
 10486 00002A58 8A84[8E6C]              	mov	al, [si+part_table_end_head]
 10487 00002A5C 884505                  	mov	[di+ptEndHead], al
 10488                                  
 10489                                  	;mov	ax, cx
 10490                                  	;mov	dx, bx
 10491                                  	;add	ax, 1
 10492                                  	;adc	dx, 0
 10493                                  	;	; dx:ax = end of extd partition + 1
 10494                                  	; 13/03/2021
 10495 00002A5F 6689D0                  	mov	eax, edx
 10496 00002A62 6648                    	dec	eax
 10497                                  
 10498                                  	; 02/11/2020
 10499                                  	;sub	ax, [bp+ldd_start]
 10500                                  	;sbb	dx, [bp+ldd_start+2]
 10501                                  	;sub	ax, [di+ptStartSector]
 10502                                  	;sbb	dx, [di+ptStartSector+2]
 10503                                  	;	; dx:ax = new sector count of the ldd
 10504                                  	; 13/03/2021
 10505 00002A64 662B86[AC6D]            	sub	eax, [bp+ldd_start]
 10506 00002A69 662B4508                	sub	eax, [di+ptStartSector]
 10507                                  
 10508                                  	;mov	[di+ptSectors], ax
 10509                                  	;mov	[di+ptSectors+2], dx
 10510                                  	; 13/03/2021
 10511 00002A6D 6689450C                	mov	[di+ptSectors], eax
 10512                                  	
 10513 00002A71 EB04                    	jmp	short eetc_8
 10514                                  eetc_7:
 10515                                  	;mov	ax, [di+ptSectors]
 10516                                  	;mov	dx, [di+ptSectors+2]
 10517                                  	; 13/03/2021
 10518 00002A73 668B450C                	mov	eax, [di+ptSectors]
 10519                                  eetc_8:
 10520                                  	; 13/03/2021
 10521                                  	;xor	edx, edx
 10522                                  	; 01/11/2020
 10523                                  	;cmp	word [endcyl], 1023
 10524                                  	;jna	short eetc_15
 10525                                  	; 13/03/2021
 10526 00002A77 66813E[D66D]FF0300-     	cmp	dword [endcyl], 1023
 10526 00002A7F 00                 
 10527 00002A80 7605                    	jna	short eetc_15
 10528                                  
 10529                                  	; 25/10/2020
 10530                                  	;mov	cx, [bp+ldd_start]
 10531                                  	;mov	bx, [bp+ldd_start+2]
 10532                                  	;; 01/11/2020
 10533                                  	;add	cx, [bp+ldd_size]
 10534                                  	;adc	bx, [bp+ldd_size+2]
 10535                                  	;sub	cx, 1 ; *
 10536                                  	;sbb	bx, 0 ; *
 10537                                  	;cmp	bx, [chs_limit+2]
 10538                                  	;jb	short eetc_15
 10539                                  	;ja	short eetc_19
 10540                                  	;cmp	cx, [chs_limit]
 10541                                  	;jna	short eetc_15
 10542                                  ;eetc_19:
 10543 00002A82 E8D900                  	call	size_to_fat_type_lba ; 25/10/2020
 10544 00002A85 EB03                    	jmp	short eetc_16
 10545                                  eetc_15:
 10546                                  	; Get proper FAT type in [ldd_type]
 10547                                  	; by using DX:AX - size -
 10548 00002A87 E8B500                  	call	size_to_fat_type
 10549                                  eetc_16:
 10550 00002A8A 884504                  	mov	[di+ptFileSystemID], al
 10551                                  
 10552                                  	; 13/03/2021
 10553                                  	; edx < 65536
 10554                                  
 10555                                  	; Write current EBR (with modified PT)
 10556                                  	;mov	ax, [bp+ldd_start]
 10557                                  	;mov	dx, [bp+ldd_start+2]
 10558 00002A8D 668B86[AC6D]            	mov	eax, [bp+ldd_start]
 10559                                  
 10560                                  	; 01/11/2020
 10561                                  	; ! safety ! (to protect MBR and primary partition)
 10562                                  ;eetc_16:
 10563                                  	;cmp	dx, [ep_StartSector+2]
 10564                                  	;jb	short eetc_18
 10565                                  	;ja	short eetc_17
 10566                                  	;cmp	ax, [ep_StartSector]
 10567                                  	;jna	short eetc_18
 10568                                  ;eetc_17:
 10569                                  	;mov	ah, 0FFh
 10570                                  	;jmp	print_error_code
 10571                                  ;eetc_18:
 10572                                  
 10573 00002A92 BB[1A6A]                	mov	bx, ebr_buffer
 10574 00002A95 E885EF                  	call	write_hd_sector
 10575 00002A98 0F82BDDC                	jc	print_error_code ; ! display error msg and then exit !
 10576                                  
 10577 00002A9C A0[146A]                	mov	al, [ldrives]
 10578                                  	;mov	ah, 18 ; extended partition table structure size
 10579                                  	; 05/11/2020
 10580 00002A9F B416                    	mov	ah, 22 ; extended partition table structure size
 10581 00002AA1 F6E4                    	mul	ah
 10582                                  
 10583 00002AA3 89C6                    	mov	si, ax
 10584 00002AA5 81C6[E26C]              	add	si, ext_table_boot_ind
 10585 00002AA9 87F7                    	xchg	si, di
 10586                                  
 10587                                  	; set partition (logical -dos- drive) data
 10588 00002AAB A5                      	movsw	; boot indicator, beginning head
 10589 00002AAC AC                      	lodsb
 10590 00002AAD 88C4                    	mov	ah, al
 10591 00002AAF 243F                    	and	al, 3Fh
 10592 00002AB1 AA                      	stosb	; beginning sector
 10593 00002AB2 C0EC06                  	shr	ah, 6
 10594 00002AB5 AC                      	lodsb	; beginning cylinder
 10595 00002AB6 AB                      	stosw
 10596                                  	; 21/03/2021
 10597 00002AB7 31C0                    	xor	ax, ax
 10598 00002AB9 AB                      	stosw
 10599 00002ABA A5                      	movsw	; partition id, end head
 10600 00002ABB AC                      	lodsb
 10601 00002ABC 88C4                    	mov	ah, al
 10602 00002ABE 243F                    	and	al, 3Fh
 10603 00002AC0 AA                      	stosb	; end sector
 10604 00002AC1 C0EC06                  	shr	ah, 6
 10605 00002AC4 AC                      	lodsb	; end cylinder
 10606 00002AC5 AB                      	stosw
 10607                                  	; 21/03/2021
 10608 00002AC6 31C0                    	xor	ax, ax
 10609 00002AC8 AB                      	stosw
 10610                                  
 10611 00002AC9 A5                      	movsw	; copy start sector (LBA) and sector count
 10612 00002ACA A5                      	movsw
 10613 00002ACB A5                      	movsw
 10614 00002ACC A5                      	movsw
 10615                                  
 10616 00002ACD FE06[146A]              	inc	byte [ldrives]
 10617                                  
 10618 00002AD1 E9D9FC                  	jmp	display_extended_pt
 10619                                  
 10620                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10621                                  ; check free space in EXTENDED (DOS) partition
 10622                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10623                                  ; 05/03/2019
 10624                                  
 10625                                  	; 12/03/2021 (fdisk4.s, 32 bit registers)
 10626                                  check_ext_free_space:
 10627                                  	;mov	ax, [ep_Size]
 10628                                  	;mov	dx, [ep_Size+2]
 10629 00002AD4 66A1[246C]              	mov	eax, [ep_Size]
 10630                                  	; 12/03/2021
 10631 00002AD8 6631DB                  	xor	ebx, ebx
 10632 00002ADB 8A1E[146A]              	mov	bl, [ldrives]
 10633 00002ADF 20DB                    	and	bl, bl
 10634 00002AE1 7421                    	jz	short cefs_1
 10635 00002AE3 80FB04                  	cmp	bl, 4
 10636 00002AE6 7602                    	jna	short cefs_0
 10637 00002AE8 B304                    	mov	bl, 4
 10638                                  cefs_0:
 10639 00002AEA FECB                    	dec	bl
 10640 00002AEC C0E302                  	shl	bl, 2 ; * 4
 10641                                  	;xor	bh, bh
 10642                                  	;mov	si, bx
 10643                                  
 10644                                  	;mov	cx, [si+ldd_start]
 10645                                  	;mov	bx, [si+ldd_start+2]
 10646                                  	;add	cx, [si+ldd_size]
 10647                                  	;adc	bx, [si+ldd_size+2]
 10648                                  	; 12/03/2021
 10649 00002AEF 668B97[AC6D]            	mov	edx, [bx+ldd_start]
 10650 00002AF4 660397[BC6D]            	add	edx, [bx+ldd_size]
 10651                                  
 10652                                  	;add	ax, [ep_StartSector]
 10653                                  	;adc	dx, [ep_StartSector+2]
 10654 00002AF9 660306[1C6C]            	add	eax, [ep_StartSector]
 10655                                  
 10656                                  	;sub	ax, cx
 10657                                  	;sbb	dx, bx
 10658                                  
 10659 00002AFE 6629D0                  	sub	eax, edx
 10660 00002B01 7501                    	jnz	short cefs_1
 10661                                  	
 10662                                  	;or	ax, ax
 10663                                  	;jnz	short cefs_1
 10664                                  
 10665                                  	; cf = 0 if the result not negative
 10666                                  
 10667 00002B03 F9                      	stc
 10668                                  
 10669                                  	; cf = 1 if the result is negative or zero
 10670                                  	 
 10671                                  	; If cf = 0 -> There is free space as in DX:AX
 10672                                  	; NOTE: This calculation is unsafe if
 10673                                  	; logical dos drive count > 4 !	
 10674                                  	; (But still meaningful for creating a new ldd.
 10675                                  	;  Because a new ldd will be created only
 10676                                  	;  if ldd count < 4.)
 10677                                  cefs_1:
 10678                                  	; 12/03/2021
 10679 00002B04 6689DA                  	mov	edx, ebx ; edx < 65536
 10680                                  	; eax = free space (sectors)
 10681 00002B07 C3                      	retn
 10682                                  
 10683                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10684                                  ; convert LBA to CHS parameters (in registers)
 10685                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10686                                  ; 24/10/2020
 10687                                  
 10688                                  	; 21/03/2021
 10689                                  	; 13/03/2021 (fdisk4.s)
 10690                                  	; 01/03/2019 (hdimage.s)
 10691                                  lba_to_chs:
 10692                                  	; INPUT:
 10693                                  	;	DX:AX = LBA address
 10694                                  	; OUTPUT:
 10695                                  	;	AX = cylinder
 10696                                  	;	DL = sector
 10697                                  	;	DH = head
 10698                                  	; 24/10/2020
 10699                                  	;	BL = extended partition ID (05h, 0Fh)
 10700                                  	;
 10701                                  	; (modified registers: ax, bx, cx, dx)
 10702                                  
 10703                                  	; 13/03/2021
 10704                                  	;
 10705                                  	; INPUT:
 10706                                  	;	EAX = LBA address
 10707                                  	; OUTPUT:
 10708                                  	;	EAX = cylinder (<= 1023)
 10709                                  	;	 DL = sector
 10710                                  	;	 DH = head
 10711                                  	;
 10712                                  	;	ECX = cylinder
 10713                                  
 10714                                  	;mov	cx, [sectors]
 10715                                  	;call	div32
 10716                                  	;inc	bl
 10717                                  	; 13/03/2021
 10718 00002B08 6629D2                  	sub	edx, edx
 10719 00002B0B 660FB70E[B23C]          	movzx	ecx, word [sectors]
 10720 00002B11 66F7F1                  	div	ecx
 10721 00002B14 FEC2                    	inc	dl
 10722                                  
 10723                                  	;push	bx ; BL = sector
 10724                                  	;mov	cx, [heads]
 10725                                  	;call	div32
 10726                                  	;pop	dx  ; DL = sector
 10727                                  	;mov	dh, bl ; BL = head
 10728                                  	; 13/03/2021
 10729 00002B16 52                      	push	dx
 10730 00002B17 31D2                    	xor	dx, dx ; 21/03/2021
 10731 00002B19 8B0E[B43C]              	mov	cx, [heads]
 10732 00002B1D 66F7F1                  	div	ecx
 10733                                  	; dl = head
 10734 00002B20 88D3                    	mov	bl, dl
 10735 00002B22 5A                      	pop	dx ; dl = sector
 10736 00002B23 88DE                    	mov	dh, bl ; dh = head
 10737                                  
 10738                                  	; 24/10/2020
 10739                                  	; check cylinder number (CHS) limit
 10740                                  	;mov	bh, 05h ; ENTENTED (LBA)
 10741                                  	; 13/03/2021
 10742 00002B25 B305                    	mov	bl, 05h ; ENTENTED (LBA) 
 10743                                  
 10744                                  	;mov	cx, ax ; 01/11/2020
 10745                                  	; 13/03/2021
 10746 00002B27 6689C1                  	mov	ecx, eax
 10747                                  
 10748                                  	;cmp	ax, 1023
 10749                                  	; 13/03/2021
 10750 00002B2A 663DFF030000            	cmp	eax, 1023
 10751 00002B30 760C                    	jna	short lbatochs_ok
 10752                                  
 10753                                  	;mov	ax, 1023 ; BC/EC = 0FFh
 10754                                  	; 13/03/2021
 10755 00002B32 66B8FF030000            	mov	eax, 1023
 10756 00002B38 B23F                    	mov	dl, 63  ; BS/ES = 0FFh
 10757 00002B3A B6FE                    	mov	dh, 254 ; BH/EH = 0FEh
 10758 00002B3C B30F                    	mov	bl, 0Fh ; EXTENDED (CHS)
 10759                                  lbatochs_ok:
 10760 00002B3E C3                      	retn
 10761                                  
 10762                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10763                                  ; specify FAT type by using partition/volume size (CHS)
 10764                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10765                                  ; 02/03/2019
 10766                                  
 10767                                  	; 13/03/2021 (fdisk4.s)
 10768                                  size_to_fat_type:
 10769                                  	; INPUT:
 10770                                  	;	DX:AX = DOS Partition Size in sectors
 10771                                  	; OUTPUT:
 10772                                  	;	AL = Partition type/ID (FAT type)
 10773                                  
 10774                                  	;or	dx, dx
 10775                                  	;jnz	short stft_2
 10776                                  
 10777                                  	; 13/03/2021
 10778 00002B3F 6689C2                  	mov	edx, eax
 10779 00002B42 66C1EA10                	shr	edx, 16	
 10780 00002B46 750B                    	jnz	short stft_2
 10781                                  
 10782 00002B48 3DA87F                  	cmp	ax, 32680
 10783 00002B4B 7703                    	ja	short stft_1
 10784                                  stft_0:	
 10785 00002B4D B001                    	mov	al, 1	; FAT12 file system
 10786 00002B4F C3                      	retn
 10787                                  stft_1:
 10788 00002B50 B004                    	mov	al, 4	; FAT16 (< 32MB)
 10789 00002B52 C3                      	retn	
 10790                                  stft_2:
 10791 00002B53 83FA10                  	cmp	dx, 10h
 10792 00002B56 7303                    	jnb	short stft_3 ; FAT32 (CHS) file system	
 10793                                  
 10794 00002B58 B006                    	mov	al, 6	; FAT16 (>= 32MB)
 10795 00002B5A C3                      	retn
 10796                                  stft_3:
 10797 00002B5B B00B                    	mov	al, 0Bh ; FAT32 (CHS)
 10798 00002B5D C3                      	retn
 10799                                  
 10800                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10801                                  ; specify FAT type by using partition/volume size (LBA)
 10802                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10803                                  ; 25/10/2020
 10804                                  
 10805                                  	; 13/03/2021 (fdisk4.s)
 10806                                  size_to_fat_type_lba:
 10807                                  	; INPUT:
 10808                                  	;	DX:AX = DOS Partition Size in sectors
 10809                                  	; OUTPUT:
 10810                                  	;	AL = Partition type/ID (FAT type)
 10811                                  
 10812                                  	; 13/03/2021
 10813                                  	; eax = DOS Partition Size in sectors
 10814                                  
 10815                                  	;or	dx, dx
 10816                                  	;jz	short stft_4
 10817                                  
 10818                                  	; 13/03/2021
 10819 00002B5E 6689C2                  	mov	edx, eax
 10820 00002B61 66C1EA10                	shr	edx, 16	
 10821 00002B65 7408                    	jz	short stft_4
 10822                                  
 10823 00002B67 83FA10                  	cmp	dx, 10h
 10824 00002B6A 7208                    	jb	short stft_5 ; FAT16 (LBA) file system	
 10825                                  
 10826 00002B6C B00C                    	mov	al, 0Ch ; FAT32 file system (LBA)
 10827 00002B6E C3                      	retn
 10828                                  stft_4:
 10829 00002B6F 3DA87F                  	cmp	ax, 32680
 10830 00002B72 76D9                    	jna	short stft_0  ; FAT12 file system
 10831                                  stft_5:	
 10832 00002B74 B00E                    	mov	al, 0Eh	; FAT16 file system (LBA)
 10833 00002B76 C3                      	retn
 10834                                  
 10835                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10836                                  ; get requested logical dos drive size (from user)
 10837                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 10838                                  ; 02/03/2019
 10839                                  	
 10840                                  	; 13/03/2021
 10841                                  	; 12/03/2021 (fdisk4.s)
 10842                                  get_ldd_size:
 10843                                  	; INPUT -> none
 10844                                  	;
 10845                                  	; OUTPUT -> 
 10846                                  	;	[lcylinders] = cylinder count
 10847                                  	;
 10848                                  	; (Modified registers: ax, bx, cx, dx, si, di) 
 10849                                  
 10850 00002B77 B80300                  	mov	ax, 3 ; clear screen
 10851 00002B7A CD10                    	int	10h
 10852                                  
 10853 00002B7C BE[1145]                	mov	si, msg_create_dos_partition_h
 10854 00002B7F E83DEE                  	call	print_msg
 10855                                  
 10856                                  	; 03/03/2019
 10857 00002B82 A0[146A]                	mov	al, [ldrives]
 10858 00002B85 08C0                    	or	al, al		; cmp byte [ldrives], 0
 10859 00002B87 7405                    	jz	short gldds_1	; jna short gldds_0
 10860                                  
 10861                                  	;push	ax ; *
 10862                                  
 10863                                  	;dec	al
 10864                                  	;mov	ah, 22 ; 05/11/2020
 10865                                  	;mul	ah
 10866                                  	
 10867                                  	;mov	di, ext_table_rel_sec_lw
 10868                                  	;add	di, ax
 10869                                  
 10870 00002B89 BE[254B]                	mov	si, msg_use_all_space
 10871                                  	; 01/11/2020
 10872                                  	;call	print_msg
 10873 00002B8C EB03                    	jmp	short gldds_2
 10874                                  
 10875                                  	; Calculate available space
 10876                                  
 10877                                  	;mov	ax, [ep_Size] ; ext part size in sectors
 10878                                  	;mov	dx, [ep_Size+2]
 10879                                  	
 10880                                  	; 04/03/2019
 10881                                  ;gldds_0:
 10882                                  	;mov	cx, [di]    ; start sector
 10883                                  	;mov	bx, [di+2]
 10884                                  	;add	cx, [di+4]  ; sectors
 10885                                  	;adc	bx, [di+6]
 10886                                  	;	; bx:cx = start of next ldd
 10887                                  	;sub	ax, cx
 10888                                  	;sbb	dx, bx
 10889                                  	;	; dx:ax = free space in sectors
 10890                                  	;
 10891                                  	;pop	cx ; *
 10892                                  	;dec	cl
 10893                                  	;jz	short gldds_2
 10894                                  	;sub	di, 22 ; 05/11/2020
 10895                                  	;push	cx ; *
 10896                                  	;jmp	short gldds_0
 10897                                  
 10898                                  	; 05/03/2019
 10899                                  	;call	check_ext_free_space
 10900                                  	;jc	short gldds_cancel
 10901                                  	
 10902                                  	; 01/11/2020
 10903                                  	; 30/10/2020
 10904                                  	;mov	ax, [ep_free_sectors]
 10905                                  	;mov	dx, [ep_free_sectors+2]
 10906                                  	
 10907                                  		; DX:AX = free sectors in extended partition
 10908                                  	;jmp	short gldds_2
 10909                                  gldds_1:
 10910 00002B8E BE[584B]                	mov	si, msg_use_entire_ep_space
 10911                                  	;call	print_msg
 10912                                  	
 10913                                  	; 01/11/2020
 10914                                  	; Calculate free space in extended partition
 10915                                  	;mov	ax, [ep_Size]
 10916                                  	;mov	dx, [ep_Size+2]
 10917                                  gldds_2:
 10918                                  	; 01/11/2020
 10919 00002B91 E82BEE                  	call	print_msg
 10920                                  
 10921                                  	; 13/03/2021
 10922                                  	;mov	al, [heads]
 10923                                  	;mul	byte [sectors]
 10924                                  	;;mov	cx, ax
 10925                                  	;; 12/03/2021
 10926                                  	;movzx	ecx, ax	
 10927                                  	
 10928                                  	;mov	ax, [ep_free_sectors]
 10929                                  	;mov	dx, [ep_free_sectors+2]
 10930                                  	; 12/03/2021
 10931 00002B94 66A1[CC6D]              	mov	eax, [ep_free_sectors]
 10932                                  
 10933                                  	;; 01/11/2020
 10934                                  	;; this is needed for partition size input
 10935                                  	;; (maximum available sectors)
 10936                                  	;;mov	[pp_Sectors], ax
 10937                                  	;;mov	[pp_Sectors+2], dx
 10938                                  
 10939                                  	;; 01/11/2020
 10940                                  	;; subtrack start offset (which always equals to spt value)
 10941                                  	;;sub	ax, [sectors]
 10942                                  	;;sbb	dx, 0
 10943                                  
 10944                                  	;;mov	cx, ax
 10945                                  	;;mov	al, [heads]
 10946                                  	;;mul	byte [sectors]
 10947                                  	;;xchg	ax, cx
 10948                                  	;	; dx:ax = sectors
 10949                                  	;	; cx = heads*spt 
 10950                                  	;;call	div32
 10951                                  	;	; ax = cylinders
 10952                                  	;	; bx = remainder
 10953                                   	;	; dx = 0
 10954                                  	;;and	bx, bx
 10955                                  	;;jz	short gldds_3
 10956                                  	;;inc	ax
 10957                                  	; 01/11/2020
 10958                                  	;div	cx
 10959                                  	; 12/03/2021
 10960 00002B98 6631D2                  	xor	edx, edx
 10961                                  	;div	ecx
 10962                                  	; 13/03/2021
 10963 00002B9B 66F736[006A]            	div	dword [hs] ; heads*spt
 10964                                  
 10965                                  	;and	dx, dx
 10966                                  	;jz	short gldds_3
 10967                                  	;inc	ax
 10968                                  gldds_3:
 10969                                  	;mov	[lcylinders], ax ; <= 65535 (< 65535)
 10970                                  	; 12/03/2021
 10971 00002BA0 66A3[D06D]              	mov	[lcylinders], eax ; <= 267369
 10972                                  gldds_getchar:
 10973 00002BA4 30E4                    	xor	ah, ah
 10974 00002BA6 CD16                    	int	16h
 10975                                  
 10976 00002BA8 3C1B                    	cmp	al, 27 ; ESCAPE key
 10977 00002BAA 7419                    	je	short gldds_cancel
 10978 00002BAC 24DF                    	and	al, 0DFh
 10979 00002BAE 3C4E                    	cmp	al, 'N'
 10980 00002BB0 741D                    	je	short gldds_4
 10981 00002BB2 3C59                    	cmp	al, 'Y'
 10982 00002BB4 75EE                    	jne	short gldds_getchar
 10983                                  
 10984                                  	; 01/11/2020
 10985                                  	;mov	word [lcylinders], 65535 ; sign for all free sectors
 10986                                  	; 12/03/2021
 10987 00002BB6 66C706[D06D]FFFFFF-     	mov	dword [lcylinders], 0FFFFFFFFh
 10987 00002BBE FF                 
 10988                                  				 ; sign for all free sectors
 10989 00002BBF BE[A659]                	mov	si, _msg_YES
 10990                                  	;call	print_msg
 10991                                  	;retn
 10992 00002BC2 E9FAED                  	jmp	print_msg
 10993                                  
 10994                                  gldds_cancel:
 10995                                  	;mov	word [lcylinders], 0
 10996                                  	; 12/03/2021
 10997 00002BC5 66C706[D06D]000000-     	mov	dword [lcylinders], 0
 10997 00002BCD 00                 
 10998                                  gldds_28:
 10999 00002BCE C3                      	retn
 11000                                  gldds_4:
 11001 00002BCF BE[AC59]                	mov	si, _msg_NO
 11002 00002BD2 E8EAED                  	call	print_msg
 11003                                  gldds_26:
 11004 00002BD5 B80300                  	mov	ax, 3 ; clear screen
 11005 00002BD8 CD10                    	int	10h
 11006                                  
 11007 00002BDA BE[1145]                	mov	si, msg_create_dos_partition_h
 11008 00002BDD E8DFED                  	call	print_msg
 11009                                  
 11010 00002BE0 BE[185F]                	mov	si, msg_create_ldd_s
 11011 00002BE3 E8D9ED                  	call	print_msg
 11012 00002BE6 BE[E34A]                	mov	si, msg_press_esc_to_cancel
 11013 00002BE9 E8D3ED                  	call	print_msg
 11014                                  gldds_25:
 11015 00002BEC 30E4                    	xor	ah, ah
 11016 00002BEE CD16                    	int	16h
 11017                                  
 11018 00002BF0 3C1B                    	cmp	al, 27 ; ESCAPE key
 11019 00002BF2 7502                    	jne	short gldds_5
 11020                                  
 11021 00002BF4 EBCF                    	jmp	short gldds_cancel
 11022                                  gldds_5:
 11023                                  	; 04/03/2019
 11024 00002BF6 3C20                    	cmp	al, 32 ; SPACE key
 11025 00002BF8 74D4                    	je	short gldds_28
 11026                                  	
 11027                                  	; 01/11/2020
 11028                                  	;mov	byte [pSize_unit], '%'
 11029 00002BFA 3C25                    	cmp	al, '%'
 11030 00002BFC 7416                    	je	short gldds_6
 11031                                  	;mov	byte [pSize_unit], 'M'
 11032 00002BFE 3C0D                    	cmp	al, 13 ; 0Dh, Carriage Return key
 11033                                  	;je	short gldds_6
 11034 00002C00 7504                    	jne	short gldds_29
 11035                                  	; 01/11/2020
 11036 00002C02 B04D                    	mov	al, 'M'
 11037 00002C04 EB0E                    	jmp	short gldds_6
 11038                                  gldds_29:
 11039 00002C06 24DF                    	and	al, 0DFh
 11040 00002C08 3C4D                    	cmp	al, 'M'
 11041 00002C0A 7408                    	je	short gldds_6
 11042                                  	;mov	[pSize_unit], al
 11043 00002C0C 3C47                    	cmp	al, 'G'
 11044 00002C0E 7404                    	je	short gldds_6
 11045 00002C10 3C43                    	cmp	al, 'C'
 11046 00002C12 75D8                    	jne	short gldds_25
 11047                                  gldds_6:
 11048                                  	; 01/11/2020
 11049 00002C14 A2[EA69]                	mov	[pSize_unit], al
 11050                                  
 11051                                  	; Set maximum sector count (all of extended partition)
 11052                                  	;mov	al, [sectors]
 11053                                  	;mul	byte [heads]
 11054                                  	;mul	word [lcylinders]
 11055                                  	; 01/11/2020	
 11056                                  	;mov	ax, [ep_free_sectors]
 11057                                  	;mov	dx, [ep_free_sectors+2]
 11058                                  	;mov	[pp_Sectors], ax
 11059                                  	;mov	[pp_Sectors+2], dx
 11060                                  	; 12/03/2021
 11061 00002C17 66A1[CC6D]              	mov	eax, [ep_free_sectors]
 11062 00002C1B 66A3[D869]              	mov	[pp_Sectors], eax
 11063                                  
 11064 00002C1F E80BF0                   	call	partition_size_input
 11065 00002C22 72A1                    	jc	short gldds_cancel
 11066                                  		; DX:AX = Partition size in sectors
 11067                                  	;or	bx, bx
 11068                                  	;jnz	short gldds_cancel
 11069                                  
 11070                                  	; 01/11/2020
 11071                                  	;mov	[ppn_Sectors], ax
 11072                                  	;mov	[ppn_Sectors+2], dx
 11073                                  	; 12/03/2021
 11074 00002C24 66A3[0C6A]              	mov	[ppn_Sectors], eax ; edx = 0
 11075                                  		
 11076                                  	;mov	cx, ax
 11077                                  	;mov	al, [heads]
 11078                                  	;mul	byte [sectors]
 11079                                  	;xchg	ax, cx
 11080                                  	;	; dx:ax = sectors
 11081                                  	;	; cx = heads*spt 
 11082                                  	;call	div32
 11083                                  	;	; ax = cylinders
 11084                                  	;	; bx = remainder
 11085                                   	;	; dx = 0
 11086                                  	; 02/11/2020
 11087                                  	;and	bx, bx
 11088                                  	;jz	short gldds_7
 11089                                  	;inc	ax
 11090                                  
 11091                                  	; 13/03/2021
 11092                                  	; eax = partition size input, edx = 0
 11093 00002C28 66F736[006A]            	div	dword [hs] ; heads*sectors  ; <= 16065
 11094                                  	; eax = cylinders, dx = remainder
 11095 00002C2D 09D2                    	or	dx, dx
 11096 00002C2F 7402                    	jz	short gldds_7
 11097 00002C31 6640                    	inc	eax ; +1
 11098                                  gldds_7:
 11099                                  	;cmp	ax, [lcylinders]
 11100                                  	; 13/03/2021
 11101 00002C33 663B06[D06D]            	cmp	eax, [lcylinders]
 11102 00002C38 7705                    	ja	short gldds_9
 11103                                  gldds_8:
 11104                                  	; OK
 11105                                  	;mov	[lcylinders], ax
 11106                                  	; 13/03/2021
 11107 00002C3A 66A3[D06D]              	mov	[lcylinders], eax
 11108 00002C3E C3                      	retn
 11109                                  
 11110                                  gldds_9:
 11111                                  	; Partition size limit message
 11112                                  	
 11113 00002C3F 803E[EA69]43            	cmp	byte [pSize_unit], 'C'
 11114 00002C44 7415                    	je	short gldds_10
 11115                                  
 11116                                  	; Tolerate 1 cylinder if unit is not cylinder
 11117                                  	;dec	ax
 11118                                  	;cmp	ax, [lcylinders]
 11119                                  	;jna	short gldds_8
 11120                                  
 11121                                  	; 01/11/2020
 11122                                  	; Tolerate sectors if sectorcount doesn't over ep limit
 11123                                  	;mov	ax, [ppn_Sectors]
 11124                                  	;mov	dx, [ppn_Sectors+2]
 11125                                  	;cmp	dx, [ep_free_sectors+2]
 11126                                  	;ja	short gldds_10
 11127                                  	;jb	short gldds_30
 11128                                  	;cmp	ax, [ep_free_sectors]
 11129                                  	;ja	short gldds_10
 11130                                  	; 13/03/2021
 11131 00002C46 66A1[0C6A]              	mov	eax, [ppn_Sectors]
 11132 00002C4A 663B06[CC6D]            	cmp	eax, [ep_free_sectors]
 11133 00002C4F 770A                    	ja	short gldds_10
 11134                                  gldds_30:
 11135                                  	;mov	word [lcylinders], 65535 ; sign for all free sectors
 11136                                  	; 13/03/2021
 11137 00002C51 66C706[D06D]FFFFFF-     	mov	dword [lcylinders], 0FFFFFFFFh
 11137 00002C59 FF                 
 11138 00002C5A C3                      	retn
 11139                                  
 11140                                  gldds_10:
 11141                                  	; clear screen
 11142 00002C5B B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
 11143 00002C5E CD10                      	int	10h
 11144                                  
 11145 00002C60 BE[1145]                	mov	si, msg_create_dos_partition_h ; header
 11146 00002C63 E859ED                  	call	print_msg
 11147                                  
 11148 00002C66 BE[C55A]                	mov	si, msg_partition_size_limit
 11149 00002C69 E853ED                  	call	print_msg
 11150                                  
 11151 00002C6C 803E[EA69]4D            	cmp	byte [pSize_unit], 'M'
 11152 00002C71 7414                    	je	short gldds_11
 11153                                  
 11154 00002C73 803E[EA69]25            	cmp	byte [pSize_unit], '%'
 11155 00002C78 745E                    	je	short gldds_22
 11156                                  
 11157 00002C7A 803E[EA69]43            	cmp	byte [pSize_unit], 'C'
 11158 00002C7F 7506                    	jne	short gldds_11
 11159                                  
 11160                                  	;mov	ax, [lcylinders]
 11161                                  	; 13/03/2021
 11162 00002C81 66A1[D06D]              	mov	eax, [lcylinders]
 11163 00002C85 EB15                    	jmp	short gldds_12
 11164                                  gldds_11:
 11165                                  	; 'M'
 11166                                  	;mov	ax, [pp_Sectors]
 11167                                  	;mov	dx, [pp_Sectors+2]
 11168                                  	;mov	cx, 2*1024 ; sectors -> MB
 11169                                  	;call	div32
 11170                                  	;	; DX = 0 
 11171                                  	;	; AX = Available space in Megabytes
 11172                                  	; 13/03/2021
 11173 00002C87 31FF                    	xor	di, di ; (**)
 11174 00002C89 66A1[D869]              	mov	eax, [pp_Sectors]
 11175                                  	;xor	edx, edx
 11176 00002C8D 31D2                    	xor	dx, dx
 11177                                  	;mov	ecx, 2*1024
 11178 00002C8F B90008                  	mov	cx, 2*1024
 11179 00002C92 66F7F1                  	div	ecx
 11180 00002C95 6683F801                	cmp	eax, 1
 11181 00002C99 7601                    	jna	short gldds_12
 11182 00002C9B 47                      	inc	di ; (**)
 11183                                  gldds_12:
 11184 00002C9C B90A00                  	mov	cx, 10
 11185 00002C9F 89E5                    	mov	bp, sp
 11186                                  gldds_13:
 11187 00002CA1 31D2                    	xor	dx, dx
 11188                                  	;mov	cx, 10
 11189 00002CA3 F7F1                    	div	cx
 11190 00002CA5 52                      	push	dx ; *
 11191 00002CA6 83F809                  	cmp	ax, 9
 11192 00002CA9 77F6                    	ja	short gldds_13
 11193                                  gldds_14:
 11194 00002CAB BB0700                  	mov	bx, 07h
 11195 00002CAE 09C0                    	or	ax, ax
 11196 00002CB0 7501                    	jnz	short gldds_16
 11197                                  gldds_15:
 11198 00002CB2 58                      	pop	ax ; *
 11199                                  gldds_16:
 11200 00002CB3 0430                    	add	al, '0'
 11201                                  gldds_17:
 11202 00002CB5 B40E                    	mov	ah, 0Eh
 11203                                  	;mov	bx, 07h
 11204 00002CB7 CD10                    	int	10h  ; write character (as tty)
 11205                                  
 11206 00002CB9 39EC                    	cmp	sp, bp
 11207 00002CBB 72F5                    	jb	short gldds_15
 11208                                  
 11209 00002CBD 803E[EA69]25            	cmp	byte [pSize_unit], '%'
 11210 00002CC2 7508                    	jne	short gldds_18
 11211                                  
 11212 00002CC4 3C25                    	cmp	al, '%'
 11213 00002CC6 743C                    	je	short gldds_21
 11214 00002CC8 B025                    	mov	al, '%'
 11215 00002CCA EBE9                    	jmp	short gldds_17
 11216                                  gldds_18:
 11217 00002CCC 803E[EA69]43            	cmp	byte [pSize_unit], 'C'
 11218 00002CD1 751D                    	jne	short gldds_19
 11219                                  
 11220 00002CD3 BE[615B]                	mov	si, msg_cylinders
 11221 00002CD6 EB29                    	jmp	short gldds_20
 11222                                  
 11223                                  gldds_22:
 11224                                  	; '%'
 11225                                  	; 01/11/2020
 11226                                  	;mov	dx, [ep_Size+2]
 11227                                  	;mov	ax, [ep_Size] ; *
 11228                                  	;and	dx, dx
 11229                                  	;jz	short gldds_33 ; dx = 0
 11230                                  	; 13/03/2021
 11231                                  	;mov	cx, 1
 11232                                  ;gldds_31:
 11233                                  	;shl	cx, 1
 11234                                  	;call	div32
 11235                                  	;or	dx, dx
 11236                                  	;jz	short gldds_32 ; *
 11237                                  	;mov	ax, [ep_Size]
 11238                                  	;mov	dx, [ep_Size+2]
 11239                                  	;jmp	short gldds_31
 11240                                  ;gldds_32:
 11241                                  	;mov	dx, [ep_free_sectors+2]
 11242                                  	; ep free sectors <= ep size
 11243                                  gldds_33:
 11244                                  	;push	ax ; * ; dx = 0 (ep size weight)
 11245                                  	;mov	ax, [ep_free_sectors]
 11246                                  	; 13/03/2021
 11247 00002CD8 66A1[CC6D]              	mov	eax, [ep_free_sectors]
 11248                                  	;mov	ecx, 100
 11249 00002CDC B96400                  	mov	cx, 100
 11250                                  	;and	dx, dx
 11251                                  	;jnz	short gldds_34
 11252                                  	;mul	cx
 11253                                  	;jmp	short gldds_35
 11254                                  ;gldds_34:
 11255                                  	;call	mul32
 11256                                  	;	; dx:ax = 100 * ep free sectors weight
 11257                                  	; 13/03/2021
 11258                                  	;xor	edx, edx
 11259 00002CDF 31D2                    	xor	dx, dx
 11260 00002CE1 66F7E1                  	mul	ecx ; 100 * ep free sectors
 11261                                  ;gldds_35:
 11262                                  	;pop	cx ; *
 11263                                  	;call	div32 ; 100 * ep free sectors / ep size
 11264                                  	;	; ax = % value (<= 100)
 11265 00002CE4 66F736[246C]            	div	dword [ep_Size]
 11266                                  	
 11267 00002CE9 09C0                    	or	ax, ax
 11268                                  	;jnz	short gldds_23
 11269 00002CEB 75AF                    	jnz	short gldds_12 ; 13/03/2021
 11270 00002CED 40                      	inc	ax ; 0 -> 1
 11271                                  	; 13/03/2021
 11272 00002CEE EBAC                    	jmp	short gldds_12
 11273                                  
 11274                                  ;gldds_23:	
 11275                                  	;mov	bp, sp
 11276                                  	;mov	cx, 10
 11277                                  ;gldds_24:	
 11278                                  	;xor	dx, dx
 11279                                  	;div	cx
 11280                                  	;push	dx ; *
 11281                                  	;cmp	ax, 9
 11282                                  	;ja	short gldds_24
 11283                                  	;jmp	short gldds_14
 11284                                  	
 11285                                  gldds_19:
 11286 00002CF0 BE[755B]                	mov	si, msg_megabytes
 11287 00002CF3 C606[7E5B]73            	mov	byte [msg_megabytes_s], 's'
 11288                                  	;cmp	di, 1
 11289                                  	;ja	short gldds_20
 11290                                  	; 13/03/2021
 11291 00002CF8 09FF                    	or	di, di ; (**)
 11292 00002CFA 7505                    	jnz	short  gldds_20
 11293                                  	; di = 0 -> 1 MB
 11294 00002CFC C606[7E5B]00            	mov	byte [msg_megabytes_s], 0
 11295                                  gldds_20:
 11296 00002D01 E8BBEC                  	call	print_msg
 11297                                  gldds_21:
 11298 00002D04 BE[125B]                	mov	si, msg_partition_size_limit_r
 11299 00002D07 E8B5EC                  	call	print_msg
 11300                                  gldds_27:
 11301 00002D0A 30E4                    	xor	ah, ah
 11302 00002D0C CD16                    	int	16h
 11303                                  	
 11304 00002D0E 3C1B                    	cmp	al, 27 ; ESCAPE key
 11305 00002D10 0F84C1FE                	je	gldds_26
 11306 00002D14 3C0D                    	cmp	al, 13 ; ENTER (Carriage Return) key
 11307 00002D16 75F2                    	jne	short gldds_27
 11308                                  
 11309                                  	;mov	ax, [lcylinders]
 11310 00002D18 C3                      	retn
 11311                                  	
 11312                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11313                                  ; initialize extended (dos) partition table 
 11314                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11315                                  ; 18/10/2020 (fdisk3.s)
 11316                                  ; 26/02/2019 (hdimage.s)
 11317                                  
 11318                                  	; 09/03/2021
 11319                                  	; 05/11/2020 (fdisk4.s)
 11320                                  init_ext_partition_table:
 11321                                  
 11322                                  	; INPUT -> 
 11323                                  	;	[epnumber] = extended partition number
 11324                                  	;
 11325                                  	; OUTPUT -> none
 11326                                  
 11327                                  ; Display Method: ; 04/03/2019
 11328                                  ;LDD 1 <- LDD_START0, ebr 1st entry <- MBR (extended partition) - EBR 0
 11329                                  ;LDD 2 <- LDD_START1, ebr 1st entry <- EBR 1
 11330                                  ;LDD 3 <- LDD_START2, ebr 1st entry <- EBR 2
 11331                                  ;LDD 4 <- LDD_START3, ebr 1st entry <- EBR 3
 11332                                  ;LDD 5 <- LDD_START3, ebr 2nd entry (LDD 5 is not displayed)
 11333                                  
 11334                                  	; 08/03/2019
 11335                                  
 11336                                  	; clear extended partition table structure/list
 11337                                  
 11338 00002D19 BF[E26C]                	mov	di, ext_table_boot_ind
 11339 00002D1C 89FE                    	mov	si, di ; 28/02/2019
 11340                                  	;mov	cx, 36 ; 18*4 = 72 bytes
 11341                                  	; 05/11/2020
 11342 00002D1E B92C00                  	mov	cx, 44 ; 22*4 = 84 bytes
 11343 00002D21 31C0                    	xor	ax, ax ; 0
 11344 00002D23 F3AB                    	rep	stosw
 11345 00002D25 89F7                    	mov	di, si ; 28/02/2019
 11346                                  
 11347                                  	;mov	byte [ldrives], 0
 11348 00002D27 A2[146A]                	mov	[ldrives], al ; 0
 11349                                  
 11350                                  	;cmp	byte [epnumber], 1
 11351                                  	;jb	short iept_0
 11352                                  
 11353 00002D2A A0[E16C]                	mov	al, [epnumber]
 11354 00002D2D FEC8                    	dec	al
 11355                                  	;mov	ah, 18 ; partition table structure size 
 11356                                  	; 05/11/2020
 11357 00002D2F B416                    	mov	ah, 22 ; partition table structure size
 11358 00002D31 F6E4                    	mul	ah
 11359                                  	;mov	si, part_table_rel_sec_lw
 11360 00002D33 BE[946C]                	mov	si, part_table_rel_sec ; 09/03/2021
 11361 00002D36 01C6                    	add	si, ax
 11362                                  
 11363                                  	; 02/11/2020
 11364                                  	;(save end cylinder for comparising later)
 11365 00002D38 8B44FE                  	mov	ax, [si-2] ; part_table_end_cyl 
 11366                                  			; 16 bit cylinder number
 11367 00002D3B A3[D66D]                	mov	[endcyl], ax
 11368                                  
 11369                                  	;mov	ax, [si]
 11370                                  	;mov	dx, [si+2]
 11371                                  	;mov	[ep_StartSector], ax
 11372                                  	;mov	[ep_StartSector+2], dx
 11373                                  	;mov	cx, [si+4]
 11374                                  	;mov	bx, [si+6]
 11375                                  	;mov	[ep_Size], cx
 11376                                  	;mov	[ep_Size+2], bx
 11377                                  	;sub	cx, 1
 11378                                  	;sbb	bx, 0
 11379                                  	;add	cx, ax
 11380                                  	;adc	bx, dx 
 11381                                  	;mov	[ep_EndSector], cx
 11382                                  	;mov	[ep_EndSector+2], bx
 11383                                  
 11384                                  	; 09/03/2021
 11385 00002D3E 668B04                  	mov	eax, [si]
 11386 00002D41 66A3[1C6C]              	mov	[ep_StartSector], eax
 11387 00002D45 668B5404                	mov	edx, [si+4]
 11388 00002D49 668916[246C]            	mov	[ep_Size], edx
 11389 00002D4E 6601C2                  	add	edx, eax
 11390 00002D51 664A                    	dec	edx
 11391 00002D53 668916[206C]            	mov	[ep_EndSector], edx
 11392 00002D58 6631D2                  	xor	edx, edx
 11393                                  
 11394                                  	; 27/02/2019
 11395                                  	;mov	[ldd_start], ax
 11396                                  	;mov	[ldd_start+2], dx
 11397                                  	; 09/03/2021
 11398 00002D5B 66A3[AC6D]              	mov	[ldd_start], eax
 11399                                  
 11400                                  	; 03/03/2019
 11401                                  	;mov	word [ldd_size], 0
 11402                                  	;mov	word [ldd_size+2], 0
 11403                                  	
 11404 00002D5F BB[1A6A]                	mov	bx, ebr_buffer
 11405                                  	; dx:ax = Extended partition address
 11406                                  	; es:bx = Extended partition buffer
 11407                                  	; 09/03/2021
 11408                                  	; eax = Extended partition address 
 11409                                  	; es:bx = Extended partition buffer
 11410                                   
 11411 00002D62 E869EC                  	call	read_hd_sector
 11412 00002D65 7209                    	jc	short iept_0
 11413                                  
 11414                                  	; Check EBR if it is a valid boot record or not
 11415 00002D67 813E[186C]55AA          	cmp	word [ebr_buffer+510], 0AA55h
 11416 00002D6D 7402                    	je	short iept_1
 11417                                  iept_stc_retn:
 11418 00002D6F F9                      	stc
 11419                                  iept_0:
 11420 00002D70 C3                      	retn
 11421                                  iept_1:
 11422                                  	; Check PTE 1, if it is valid or not
 11423 00002D71 A0[DC6B]                	mov	al, [ebr_buffer+446+ptFileSystemID]
 11424 00002D74 20C0                    	and	al, al
 11425 00002D76 74F7                    	jz	short iept_stc_retn ; empty pte, error
 11426 00002D78 3C05                    	cmp	al, 5
 11427 00002D7A 74F3                    	je	short iept_stc_retn ; extended partition, error
 11428                                  	; 24/10/2020
 11429 00002D7C 3C0F                    	cmp	al, 0Fh
 11430 00002D7E 74EF                    	je	short iept_stc_retn ; extended partition, error
 11431                                  
 11432                                  	;inc	byte [ldrives] ; logical (dos) drive count
 11433                                  
 11434 00002D80 BE[D86B]                	mov	si, ebr_buffer+446 ; Partition table offset
 11435 00002D83 B90400                  	mov	cx, 4
 11436                                  
 11437                                  	; set partition (logical -dos- drive) data
 11438 00002D86 A5                      	movsw	; boot indicator, beginning head
 11439 00002D87 AC                      	lodsb
 11440 00002D88 88C4                    	mov	ah, al
 11441 00002D8A 243F                    	and	al, 3Fh
 11442 00002D8C AA                      	stosb	; beginning sector
 11443 00002D8D C0EC06                  	shr	ah, 6
 11444 00002D90 AC                      	lodsb	; beginning cylinder
 11445 00002D91 AB                      	stosw
 11446                                  	; 09/03/2021
 11447 00002D92 31C0                    	xor	ax, ax
 11448 00002D94 AB                      	stosw
 11449                                  	;	
 11450 00002D95 A5                      	movsw	; partition id, end head
 11451 00002D96 AC                      	lodsb
 11452 00002D97 88C4                    	mov	ah, al
 11453 00002D99 243F                    	and	al, 3Fh
 11454 00002D9B AA                      	stosb	; end sector
 11455 00002D9C C0EC06                  	shr	ah, 6
 11456 00002D9F AC                      	lodsb	; end cylinder
 11457 00002DA0 AB                      	stosw
 11458                                  	; 09/03/2021
 11459 00002DA1 31C0                    	xor	ax, ax
 11460 00002DA3 AB                      	stosw
 11461                                  	;
 11462                                  
 11463                                  	; 04/03/2019
 11464 00002DA4 8A1E[146A]              	mov	bl, [ldrives]
 11465                                  	;dec 	bl
 11466                                  	;jnz	short iept_2
 11467                                  
 11468                                  	; 05/03/2019
 11469 00002DA8 08DB                    	or	bl, bl
 11470 00002DAA 7511                    	jnz	short iept_2
 11471                                  
 11472                                  	;mov	ax, [si]   ; start sector of 1st LDD (offset)
 11473                                  	;mov	dx, [si+2]
 11474                                  	;add	ax, [si+4] ; size of 1st LDD (volume)
 11475                                  	;adc	dx, [si+6]
 11476                                  	; 09/03/2021
 11477 00002DAC 668B04                  	mov	eax, [si]
 11478 00002DAF 66034404                	add	eax, [si+4]
 11479                                  
 11480                                  	;mov	[ldd_size], ax ; size of 1st LDD (partition)
 11481                                  	;mov	[ldd_size+2], dx
 11482                                  	; 09/03/2021
 11483 00002DB3 66A3[BC6D]              	mov	[ldd_size], eax
 11484                                  
 11485                                  	; 05/03/2019
 11486 00002DB7 FE06[146A]              	inc	byte [ldrives] ; logical (dos) drive count
 11487 00002DBB FEC3                    	inc	bl
 11488                                  iept_2:
 11489 00002DBD F3A5                    	rep	movsw ; copy start sector (LBA) and sector count
 11490                                  
 11491                                  	; get next extended partition (logical -dos- drive) data
 11492 00002DBF 8A4404                  	mov	al, [si+ptFileSystemID]
 11493 00002DC2 20C0                    	and	al, al ; EMPTY
 11494 00002DC4 74AA                    	jz	short iept_0 ; end of logical -dos- drive chain
 11495                                  
 11496 00002DC6 3C05                    	cmp	al, 5 ; EXTENDED
 11497                                  	;jne	short iept_stc_retn  ; 2nd PTE must have
 11498                                  	;			     ; extended partition ID
 11499 00002DC8 7404                    	je	short iept_4
 11500                                  	; 24/10/2020
 11501 00002DCA 3C0F                    	cmp	al, 0Fh ; EXTENDED (LBA)
 11502 00002DCC 75A1                    	jne	short iept_stc_retn  ; 2nd PTE must have
 11503                                  				     ; extended partition ID
 11504                                  iept_4:
 11505                                  	; 05/03/2019
 11506 00002DCE FE06[146A]              	inc	byte [ldrives] ; logical (dos) drive count
 11507                                  
 11508                                  	;cmp	byte [ldrives], al ; 5
 11509 00002DD2 80FB04                  	cmp	bl, 4 ; number of logical dos drives (till here)
 11510 00002DD5 7332                    	jnb	short iept_3
 11511                                  
 11512 00002DD7 83C608                  	add	si, 8
 11513                                  
 11514                                  	;lodsw	
 11515                                  	;mov	dx, ax	; start sector
 11516                                  	;lodsw
 11517                                  	;xchg	dx, ax	; start sector + 2
 11518                                  	; 09/03/2021
 11519 00002DDA 66AD                    	lodsd
 11520                                  	
 11521                                  	; 04/03/2019
 11522                                  	;add	ax, [ep_StartSector]
 11523                                  	;adc	dx, [ep_StartSector+2]
 11524                                  	; 09/03/2021
 11525 00002DDC 660306[1C6C]            	add	eax, [ep_StartSector]
 11526                                  
 11527 00002DE1 30FF                    	xor	bh, bh
 11528 00002DE3 C0E302                  	shl	bl, 2 ; *4
 11529                                  
 11530                                  	; 28/02/2019
 11531                                  	;mov	[bx+ldd_start], ax ; start of (next) LDD (partition)
 11532                                  	;mov	[bx+ldd_start+2], dx
 11533                                  	; 09/03/2021
 11534 00002DE6 668987[AC6D]            	mov	[bx+ldd_start], eax
 11535                                  
 11536                                  	; 03/03/2019
 11537                                  	; set partition size for logical dos drive
 11538                                  	;mov	cx, [si]
 11539                                  	;mov	[bx+ldd_size], cx
 11540                                  	;mov	cx, [si+2]
 11541                                  	;mov	[bx+ldd_size+2], cx
 11542                                  	; 09/03/2021
 11543 00002DEB 668B14                  	mov	edx, [si]
 11544 00002DEE 668997[BC6D]            	mov	[bx+ldd_size], edx
 11545 00002DF3 6629D2                  	sub	edx, edx
 11546                                  
 11547 00002DF6 BB[1A6A]                	mov	bx, ebr_buffer
 11548                                  
 11549                                  	; dx:ax = Extended partition address
 11550                                  	; es:bx = Extended partition buffer
 11551                                  	; 09/03/2021
 11552                                  	; eax = Extended partition address
 11553                                   
 11554 00002DF9 E8D2EB                  	call	read_hd_sector
 11555 00002DFC 720B                    	jc	short iept_3 ; 03/03/2019
 11556                                  
 11557                                  	; Check EBR if it is valid or not
 11558 00002DFE 813E[186C]55AA          	cmp	word [ebr_buffer+510], 0AA55h
 11559 00002E04 0F8469FF                	je	iept_1
 11560                                  
 11561 00002E08 F9                      	stc
 11562                                  iept_3:	
 11563 00002E09 C3                      	retn
 11564                                  
 11565                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11566                                  ; delete logical -dos- drives in extended partition
 11567                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11568                                  ; 18/10/2020 (fdisk3.s)
 11569                                  
 11570                                  	; 12/03/2021
 11571                                  	; 09/03/2021 (fdisk4.s)
 11572                                  delete_logical_drives:
 11573                                  		; 27/02/2019 (hdimage.s)
 11574                                  
 11575                                  ; Delete Method: ; 04/03/2019
 11576                                  ;LDD 5 <- LDD_START3, ebr 2nd entry
 11577                                  ;LDD 4 <- LDD_START2, ebr 2nd entry
 11578                                  ;LDD 3 <- LDD_START1, ebr 2nd entry
 11579                                  ;LDD 2 <- LDD_START0, ebr 2nd entry
 11580                                  ;LDD 1 <- LDD_START0, ebr 1st entry
 11581                                  
 11582                                  	;cmp	byte [ldrives], 0
 11583                                  	;jna	short dld_stc
 11584                                  
 11585                                  	;mov	al, 5 ; extended partition (logical drives)
 11586                                  	;call	display_partition_table
 11587                                  	; 12/03/2021
 11588 00002E0A E8A3F7                  	call	display_partition_table_x
 11589                                  
 11590 00002E0D A0[146A]                	mov	al, [ldrives]
 11591 00002E10 0430                    	add	al, '0'
 11592 00002E12 A2[EB5C]                	mov	[lddp_num], al
 11593                                  
 11594 00002E15 BE[985C]                	mov	si, msg_delete_ldd
 11595 00002E18 E8A4EB                  	call	print_msg
 11596                                  
 11597 00002E1B BE[E34A]                	mov	si, msg_press_esc_to_cancel
 11598 00002E1E E89EEB                  	call	print_msg
 11599                                  dld_0:
 11600 00002E21 30E4                    	xor	ah, ah
 11601 00002E23 CD16                    	int	16h
 11602                                  
 11603 00002E25 80FC53                  	cmp	ah, 53h  ; DELETE or DEL key
 11604 00002E28 751C                    	jne	short dld_1
 11605                                  
 11606                                  	; Delete PTE 1 & PTE 2 on EBR 1
 11607 00002E2A 30E4                    	xor	ah, ah
 11608 00002E2C A0[146A]                	mov	al, [ldrives]
 11609 00002E2F FEC8                    	dec	al
 11610 00002E31 7518                    	jnz	short dld_2
 11611                                  
 11612 00002E33 BF[D86B]                	mov	di, ebr_buffer+446
 11613 00002E36 B91000                  	mov	cx, 16
 11614 00002E39 F3AB                    	rep	stosw
 11615                                  
 11616                                  	; 04/03/2019
 11617                                  	; Clear ldd data in extended partition table/structure
 11618 00002E3B BF[E26C]                	mov	di, ext_table_boot_ind
 11619 00002E3E B109                    	mov	cl, 9
 11620 00002E40 F3AB                    	rep	stosw
 11621 00002E42 31F6                    	xor	si, si
 11622 00002E44 EB3D                    	jmp	short dld_3
 11623                                  dld_1:	
 11624 00002E46 3C1B                    	cmp	al, 27 ; ESC key
 11625 00002E48 75D7                    	jne	short dld_0
 11626                                  dld_5:
 11627 00002E4A C3                      	retn
 11628                                  
 11629                                  ;dld_stc:
 11630                                  ;	stc
 11631                                  ;	retn
 11632                                  
 11633                                  dld_2:
 11634                                  	; 04/03/2019
 11635                                  	; Delete 2nd PTE on EBR 2 to 4
 11636 00002E4B FEC8                    	dec	al 
 11637 00002E4D C0E002                  	shl	al, 2 ; * 4
 11638 00002E50 89C6                    	mov	si, ax
 11639                                  
 11640                                  	;mov	ax, [si+ldd_start]
 11641                                  	;mov	dx, [si+ldd_start+2]
 11642                                  	; 09/03/2021
 11643 00002E52 668B84[AC6D]            	mov	eax, [si+ldd_start]
 11644                                  
 11645 00002E57 BB[1A6A]                	mov	bx, ebr_buffer
 11646 00002E5A E871EB                  	call	read_hd_sector
 11647 00002E5D 7235                    	jc	short dld_4
 11648                                  
 11649 00002E5F BF[E86B]                	mov	di, ebr_buffer+446+16
 11650 00002E62 B90800                  	mov	cx, 8
 11651 00002E65 29C0                    	sub	ax, ax
 11652 00002E67 F3AB                    	rep	stosw
 11653                                  
 11654                                  	; 04/03/2019
 11655                                  	;cmp	byte [ldrives], 5
 11656                                  	;jnb	short dld_3
 11657 00002E69 8A26[146A]              	mov	ah, [ldrives]
 11658 00002E6D 80FC05                  	cmp	ah, 5
 11659 00002E70 7311                    	jnb	short dld_3
 11660                                  
 11661                                  	; Clear ldd data in extended partition table/structure
 11662                                  	;mov	ah, [ldrives]
 11663 00002E72 FECC                    	dec	ah
 11664                                  	;mov	al, 18
 11665                                  	; 05/11/2020
 11666 00002E74 B016                    	mov	al, 22
 11667 00002E76 F6E4                    	mul	ah
 11668 00002E78 BF[E26C]                	mov	di, ext_table_boot_ind
 11669 00002E7B 01C7                    	add	di, ax
 11670                                  	;;mov	cx, 9
 11671                                  	;mov	cl, 9
 11672                                  	; 05/11/2020
 11673 00002E7D B10B                    	mov	cl, 11
 11674                                  	;xor	ax, ax
 11675 00002E7F 30C0                    	xor	al, al
 11676 00002E81 F3AB                    	rep	stosw
 11677                                  dld_3:
 11678                                  	; Write changed EBR
 11679                                  	;mov	ax, [si+ldd_start]
 11680                                  	;mov	dx, [si+ldd_start+2]
 11681                                  	; 09/03/2021
 11682 00002E83 668B84[AC6D]            	mov	eax, [si+ldd_start]
 11683                                  
 11684 00002E88 BB[1A6A]                	mov	bx, ebr_buffer
 11685 00002E8B E88FEB                  	call	write_hd_sector
 11686 00002E8E 7204                    	jc	short dld_4
 11687                                  
 11688                                  	; 28/02/2019
 11689 00002E90 FE0E[146A]              	dec	byte [ldrives]
 11690                                  dld_4:
 11691 00002E94 803E[146A]00            	cmp	byte [ldrives], 0
 11692 00002E99 0F876DFF                	ja	delete_logical_drives
 11693                                  
 11694 00002E9D C3                      	retn
 11695                                  
 11696                                  ;=============================================================================
 11697                                  ;        	initialized data
 11698                                  ;=============================================================================
 11699                                  
 11700                                  ; 12/10/2020
 11701 00002E9E 00                      int13h_x:	db	0
 11702                                  
 11703                                  TRDOS386_MASTERBOOT_SECTOR:
 11704 00002E9F <bin 200h>              	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR	
 11705                                  
 11706                                  TRDOS_FAT_hd_bs:
 11707                                  	;incbin 'TRHDBS.BIN'
 11708                                  	; 04/05/2024
 11709                                  TRDOS_FAT32_hd_bs:
 11710                                  	;incbin	'FAT32_BS.BIN' ; 27/04/2024
 11711 0000309F <bin 400h>              	incbin	'RD5HDBS3.BIN' ; 29/04/2024
 11712                                  TRDOS_FAT16_hd_bs: 
 11713                                  	;incbin	'FAT16_BS.BIN' ; 26/12/2017
 11714 0000349F <bin 200h>              	incbin	'RD5HDBS2.BIN' ; 20/04/2024
 11715                                  TRDOS_FAT12_hd_bs: 
 11716                                  	;incbin	'FAT12_BS.BIN' ; 26/12/2017
 11717 0000369F <bin 200h>              	incbin	'RD5HDBS1.BIN' ; 20/04/2024
 11718                                  
 11719                                  TRDOS_TRFS1_chs_bs:
 11720 0000389F <bin 200h>              	incbin	'TRFS1CHS.BIN' ; Singlix FS1 (CHS+LBA Disk) BS
 11721                                  TRDOS_TRFS1_lba_bs:
 11722 00003A9F <bin 200h>              	incbin	'TRFS1LBA.BIN' ; Singlix FS1 (LBA Disk) BS
 11723                                  
 11724 00003C9F 00                      	db	0
 11725                                  
 11726                                  hexchrs:
 11727 00003CA0 303132333435363738-     	db	'0123456789ABCDEF'
 11727 00003CA9 39414243444546     
 11728                                  
 11729                                  ; 05/11/2020
 11730 00003CB0 00                      	db	0
 11731                                  
 11732 00003CB1 90                      align 2
 11733                                  
 11734                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
 11735                                  
 11736                                  sectors: ; sectors per track (63)
 11737 00003CB2 3F00                    	dw 63
 11738                                  heads:	 ; number of heads (16 or 32 or 64) 
 11739 00003CB4 1000                    	dw 16
 11740                                  cylinders: ; number of cylinders (16 to 1024)
 11741                                  	;dw 1024
 11742                                  	;dw 0 ; 16/10/2020 (double word)
 11743 00003CB6 00040000                	dd 1024 ; 05/11/2020 
 11744                                  
 11745                                  ; 05/11/2020
 11746                                  
 11747                                  ;random:
 11748                                  ;	db 0  ; random write to file (0 = sequental)
 11749                                  ;newdisk:
 11750                                  ;	db 0
 11751                                  
 11752                                  FileSys_Names: ; 2003-2017
 11753                                  ; (Valid FileSystems for TRDOS 386, SINGLIX, RETRO UNIX OS projects in 2017)
 11754 00003CBA 464154313220202020-     FS_FAT12:     db "FAT12         "  ; 01h = FAT12
 11754 00003CC3 2020202020         
 11755 00003CC8 58454E495820202020-     FS_XENIX:     db "XENIX         "  ; 02h , XENIX System V root
 11755 00003CD1 2020202020         
 11756 00003CD6 58454E495820757372-     FS_XENIX_USR: db "XENIX usr     "  ; 03h , XENIX System V user
 11756 00003CDF 2020202020         
 11757 00003CE4 464154313620283034-     FS_FAT16:     db "FAT16 (04h)   "  ; 04h = FAT16 < 32MB
 11757 00003CED 6829202020         
 11758 00003CF2 455854454E44454420-     FS_EXT_CHS:   db "EXTENDED (CHS)"  ; 05h = Extended DOS Partition
 11758 00003CFB 2843485329         
 11759 00003D00 464154313620283036-     FS_FAT16_BIG: db "FAT16 (06h)   "  ; 06h = FAT16 > 32MB, CHS mode
 11759 00003D09 6829202020         
 11760 00003D0E 4E5446532020202020-     FS_NTFS:      db "NTFS          "  ; 07h , WINDOWS NTFS Partition
 11760 00003D17 2020202020         
 11761 00003D1C 464154333220284348-     FS_FAT32_CHS: db "FAT32 (CHS)   "  ; 0Bh = FAT32, CHS mode
 11761 00003D25 5329202020         
 11762 00003D2A 464154333220284C42-     FS_FAT32_LBA: db "FAT32 (LBA)   "  ; 0Ch = FAT32, LBA mode
 11762 00003D33 4129202020         
 11763 00003D38 464154313620284C42-     FS_FAT16_LBA: db "FAT16 (LBA)   "  ; 0Eh = FAT16, LBA mode
 11763 00003D41 4129202020         
 11764 00003D46 455854454E44454420-     FS_EXT_LBA:   db "EXTENDED (LBA)"  ; 0Fh = Extented Partition, LBA mode
 11764 00003D4F 284C424129         
 11765 00003D54 554E49582053595354-     FS_UNIX_SYSV: db "UNIX SYSTEM V "  ; 63h , SCO UNIX, UNIXWARE, OPENSERVER
 11765 00003D5D 454D205620         
 11766 00003D62 524554524F20554E49-     FS_RETROUNIX: db "RETRO UNIX    "  ; 71h , Retro UNIX 386 v2 Partition
 11766 00003D6B 5820202020         
 11767 00003D70 554E49582056372020-     FS_UNIX_V7:   db "UNIX V7       "  ; 72h , UNIX v7 x86 Partition  
 11767 00003D79 2020202020         
 11768 00003D7E 4C494E555820535741-     FS_LINUXSWAP: db "LINUX SWAP    "  ; 82h , LINUX SWAP Partition
 11768 00003D87 5020202020         
 11769 00003D8C 4C494E555820202020-     FS_LINUX:     db "LINUX         "  ; 83h , LINUX NATIVE (ext2) Partition
 11769 00003D95 2020202020         
 11770 00003D9A 4C494E555820455854-     FS_LINUXEXT:  db "LINUX EXTENDED"  ; 85h , LINUX EXTENDED Partition
 11770 00003DA3 454E444544         
 11771 00003DA8 524444202020202020-     FS_TRDD:      db "RDD           "  ; A0h , (Random Data Disk) LBA
 11771 00003DB1 2020202020         
 11772 00003DB6 53494E474C49582046-     FS_TRFS:      db "SINGLIX FS1   "  ; A1h , (32 bit, 512 bytes per sector)
 11772 00003DBF 5331202020         
 11773 00003DC4 554E4B4E4F574E2046-     FS_OTHERS:    db "UNKNOWN FS    "  ; Another or Unknown File Systems
 11773 00003DCD 5320202020         
 11774                                   
 11775                                  valid_partitions: ; (*)
 11776 00003DD2 01020304050607          	      db 01h, 02h, 03h, 04h, 05h, 06h, 07h
 11777 00003DD9 0B0C0E0F637172          	      db 0Bh, 0Ch, 0Eh, 0Fh, 63h, 71h, 72h
 11778 00003DE0 828385A0A1              	      db 82h, 83h, 85h, 0A0h, 0A1h 			
 11779                                  
 11780                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11781                                  ;  messages
 11782                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 11783                                  
 11784                                  CHS_msg: ; 80 bytes per row
 11785 00003DE5 507265737320274327-     db  "Press 'C' to set cylinders then press '+,-' keys to change number of cylinders. "
 11785 00003DEE 20746F207365742063-
 11785 00003DF7 796C696E6465727320-
 11785 00003E00 7468656E2070726573-
 11785 00003E09 7320272B2C2D27206B-
 11785 00003E12 65797320746F206368-
 11785 00003E1B 616E6765206E756D62-
 11785 00003E24 6572206F662063796C-
 11785 00003E2D 696E646572732E20   
 11786 00003E35 507265737320274827-     db  "Press 'H' to set heads then press '+,-' keys to change number of heads.         "
 11786 00003E3E 20746F207365742068-
 11786 00003E47 65616473207468656E-
 11786 00003E50 20707265737320272B-
 11786 00003E59 2C2D27206B65797320-
 11786 00003E62 746F206368616E6765-
 11786 00003E6B 206E756D626572206F-
 11786 00003E74 662068656164732E20-
 11786 00003E7D 2020202020202020   
 11787 00003E85 507265737320275327-     db  "Press 'S' to set sectors then press '+,-' keys to change numb of sectors/track. "
 11787 00003E8E 20746F207365742073-
 11787 00003E97 6563746F7273207468-
 11787 00003EA0 656E20707265737320-
 11787 00003EA9 272B2C2D27206B6579-
 11787 00003EB2 7320746F206368616E-
 11787 00003EBB 6765206E756D62206F-
 11787 00003EC4 6620736563746F7273-
 11787 00003ECD 2F747261636B2E20   
 11788 00003ED5 202020202020202020-     db  "                                                                                "
 11788 00003EDE 202020202020202020-
 11788 00003EE7 202020202020202020-
 11788 00003EF0 202020202020202020-
 11788 00003EF9 202020202020202020-
 11788 00003F02 202020202020202020-
 11788 00003F0B 202020202020202020-
 11788 00003F14 202020202020202020-
 11788 00003F1D 2020202020202020   
 11789 00003F25 202020202020202020-     db  "                                                                                "
 11789 00003F2E 202020202020202020-
 11789 00003F37 202020202020202020-
 11789 00003F40 202020202020202020-
 11789 00003F49 202020202020202020-
 11789 00003F52 202020202020202020-
 11789 00003F5B 202020202020202020-
 11789 00003F64 202020202020202020-
 11789 00003F6D 2020202020202020   
 11790 00003F75 507265737320454E54-     db  "Press ENTER to use current CHS values.                                          "
 11790 00003F7E 455220746F20757365-
 11790 00003F87 2063757272656E7420-
 11790 00003F90 4348532076616C7565-
 11790 00003F99 732E20202020202020-
 11790 00003FA2 202020202020202020-
 11790 00003FAB 202020202020202020-
 11790 00003FB4 202020202020202020-
 11790 00003FBD 2020202020202020   
 11791 00003FC5 202020202020202020-     db  "                                                                                "
 11791 00003FCE 202020202020202020-
 11791 00003FD7 202020202020202020-
 11791 00003FE0 202020202020202020-
 11791 00003FE9 202020202020202020-
 11791 00003FF2 202020202020202020-
 11791 00003FFB 202020202020202020-
 11791 00004004 202020202020202020-
 11791 0000400D 2020202020202020   
 11792 00004015 507265737320455343-     db  "Press ESC to cancel.                                                            "
 11792 0000401E 20746F2063616E6365-
 11792 00004027 6C2E20202020202020-
 11792 00004030 202020202020202020-
 11792 00004039 202020202020202020-
 11792 00004042 202020202020202020-
 11792 0000404B 202020202020202020-
 11792 00004054 202020202020202020-
 11792 0000405D 2020202020202020   
 11793 00004065 202020202020202020-     db  "                                                                                "
 11793 0000406E 202020202020202020-
 11793 00004077 202020202020202020-
 11793 00004080 202020202020202020-
 11793 00004089 202020202020202020-
 11793 00004092 202020202020202020-
 11793 0000409B 202020202020202020-
 11793 000040A4 202020202020202020-
 11793 000040AD 2020202020202020   
 11794 000040B5 00                      db  0
 11795                                  
 11796                                  TrDOS_Welcome:
 11797 000040B6 0D0A                    	db	0Dh, 0Ah
 11798                                  	;db	'TR-DOS 386 Fixed Disk Partitioning Utility'
 11799 000040B8 526574726F20444F53-     	db	'Retro DOS v5 Fixed Disk Partitioning Utility'
 11799 000040C1 207635204669786564-
 11799 000040CA 204469736B20506172-
 11799 000040D3 746974696F6E696E67-
 11799 000040DC 205574696C697479   
 11800 000040E4 0D0A                    	db	0Dh, 0Ah
 11801                                  	;db	"v2.1.240504 (c) Erdogan TAN 2021-2024"
 11802 000040E6 464449534B34207632-     	db	"FDISK4 v2.0.240715 (c) Erdogan TAN 2021-2024"
 11802 000040EF 2E302E323430373135-
 11802 000040F8 20286329204572646F-
 11802 00004101 67616E2054414E2032-
 11802 0000410A 3032312D32303234   
 11803 00004112 0D0A                    	db	0Dh,0Ah
 11804 00004114 0D0A                    	db	0Dh,0Ah
 11805 00004116 00                      	db	0
 11806                                  TrDOS_Usage:
 11807 00004117 55736167653A206664-     	db	'Usage: fdisk4r5 <hard disk name> '
 11807 00004120 69736B347235203C68-
 11807 00004129 617264206469736B20-
 11807 00004132 6E616D653E20       
 11808 00004138 0D0A                    	db	0Dh, 0Ah
 11809 0000413A 0D0A                    	db	0Dh, 0Ah
 11810 0000413C 48617264206469736B-     	db	"Hard disk names: "
 11810 00004145 206E616D65733A20   
 11811 0000414D 0D0A                    	db	0Dh, 0Ah
 11812 0000414F 0D0A                    	db	0Dh, 0Ah
 11813 00004151 20686430202E2E666F-     	db	" hd0 ..for 1st hard disk "
 11813 0000415A 722031737420686172-
 11813 00004163 64206469736B20     
 11814 0000416A 0D0A                    	db	0Dh, 0Ah
 11815 0000416C 20686431202E2E666F-     	db	" hd1 ..for 2nd hard disk "
 11815 00004175 7220326E6420686172-
 11815 0000417E 64206469736B20     
 11816 00004185 0D0A                    	db	0Dh, 0Ah
 11817 00004187 20686432202E2E666F-     	db	" hd2 ..for 3rd hard disk "
 11817 00004190 722033726420686172-
 11817 00004199 64206469736B20     
 11818 000041A0 0D0A                    	db	0Dh, 0Ah
 11819 000041A2 20686433202E2E666F-     	db	" hd3 ..for 4th hard disk "
 11819 000041AB 722034746820686172-
 11819 000041B4 64206469736B20     
 11820 000041BB 0D0A00                  	db	0Dh, 0Ah, 0
 11821                                  
 11822                                  TrDOS_Options:
 11823 000041BE 53656C656374206861-     	db	"Select hard disk number (1 to "
 11823 000041C7 7264206469736B206E-
 11823 000041D0 756D62657220283120-
 11823 000041D9 746F20             
 11824                                  TrDOS_dnmax:
 11825 000041DC 3429206F7220707265-     	db	"4) or press ESC to exit ..."
 11825 000041E5 73732045534320746F-
 11825 000041EE 2065786974202E2E2E 
 11826 000041F7 0D0A00                  	db	0Dh, 0Ah, 0
 11827                                  TrDOS_hdrow:
 11828 000041FA 0D0A                    	db	0Dh, 0Ah 
 11829 000041FC 28                      	db	"("
 11830                                  TrDOS_hdrow_n:
 11831 000041FD 3029206864              	db	"0) hd"
 11832                                  TrDOS_hdrow_i:
 11833 00004202 30202D204361706163-     	db	"0 - Capacity : "
 11833 0000420B 697479203A20       
 11834 00004211 00                      	db	0
 11835                                  TrDOS_hdrow_unit:
 11836 00004212 474220                  	db	"GB "
 11837 00004215 0D0A00                  	db 	0Dh, 0Ah, 0
 11838                                  
 11839                                  TrDOS_hdrow_capacity:
 11840 00004218 303030302000            	db	"0000 ", 0
 11841 0000421E 00                      	db	0
 11842                                  
 11843                                  TrDOS_disksize:
 11844 0000421F 0D0A                    	db	0Dh, 0Ah
 11845 00004221 4469736B2073697A65-     	db	"Disk size : "
 11845 0000422A 203A20             
 11846 0000422D 00                      	db	0
 11847                                  
 11848                                  ; 05/11/2020
 11849                                  ;msg_fdisk_capacity_err:
 11850                                  ;	db	0Dh, 0Ah
 11851                                  ;	db	"Huge disk !"
 11852                                  ;	db	0Dh, 0Ah
 11853                                  ;	db	"This FDISK version (v3) can work with disk sizes up to "
 11854                                  ;	db	0
 11855                                  
 11856                                  msg_any_key_esc_exit:
 11857 0000422E 0D0A                    	db	0Dh, 0Ah
 11858 00004230 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
 11858 00004239 20746F206578697420-
 11858 00004242 6F7220707265737320-
 11858 0000424B 616E6F74686572206B-
 11858 00004254 657920746F20636F6E-
 11858 0000425D 74696E75652E2E2E   
 11859 00004265 00                      	db	0
 11860                                  
 11861                                  msg_create_partition_h:
 11862 00004266 0D0A                    	db	0Dh, 0Ah
 11863 00004268 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11863 00004271 2D2D2D2D2D2D2D2D2D-
 11863 0000427A 2D2D2D2D2D2D2D2D2D-
 11863 00004283 2D2D2D2D2D2D2D2D2D-
 11863 0000428C 2D2D2D2D2D2D2D2D2D-
 11863 00004295 2D2D2D2D2D2D2D2D2D-
 11863 0000429E 2D2D2D2D2D2D2D2D2D-
 11863 000042A7 2D2D2D2D2D2D2D2D2D-
 11863 000042B0 2D2D2D2D2D2D2D2D   
 11864 000042B8 202020202020202020-     	db	"                               Create Partition                                 "
 11864 000042C1 202020202020202020-
 11864 000042CA 202020202020202020-
 11864 000042D3 202020204372656174-
 11864 000042DC 652050617274697469-
 11864 000042E5 6F6E20202020202020-
 11864 000042EE 202020202020202020-
 11864 000042F7 202020202020202020-
 11864 00004300 2020202020202020   
 11865 00004308 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
 11865 00004311 2D2D2D2D2D2D2D2D2D-
 11865 0000431A 2D2D2D2D2D2D2D2D2D-
 11865 00004323 2D2D2D2D2D2D2D2D2D-
 11865 0000432C 2D2D2D2D2D2D2D2D2D-
 11865 00004335 2D2D2D2D2D2D2D2D2D-
 11865 0000433E 2D2D2D2D2D2D2D2D2D-
 11865 00004347 2D2D2D2D2D2D2D2D2D-
 11865 00004350 2D2D2D2D2D2D2D2D   
 11866 00004358 0D0A00                  	db	0Dh, 0Ah, 0
 11867                                  msg_create_partition_m:
 11868 0000435B 53656C65637420616E-     	db	"Select an option: "
 11868 00004364 206F7074696F6E3A20 
 11869 0000436D 0D0A                    	db	0Dh, 0Ah
 11870 0000436F 0D0A                    	db	0Dh, 0Ah
 11871 00004371 202031292043726561-     	db	"  1) Create DOS partition ", 0Dh, 0Ah
 11871 0000437A 746520444F53207061-
 11871 00004383 72746974696F6E200D-
 11871 0000438C 0A                 
 11872 0000438D 202032292043726561-     	db	"  2) Create SINGLIX FS partition ", 0Dh, 0Ah
 11872 00004396 74652053494E474C49-
 11872 0000439F 582046532070617274-
 11872 000043A8 6974696F6E200D0A   
 11873 000043B0 202033292043726561-     	db	"  3) Create RETRO UNIX partition ", 0Dh, 0Ah
 11873 000043B9 746520524554524F20-
 11873 000043C2 554E49582070617274-
 11873 000043CB 6974696F6E200D0A   
 11874 000043D3 202034292043726561-     	db	"  4) Create another type of partition ", 0Dh, 0Ah
 11874 000043DC 746520616E6F746865-
 11874 000043E5 722074797065206F66-
 11874 000043EE 20706172746974696F-
 11874 000043F7 6E200D0A           
 11875 000043FB 0D0A                    	db	0Dh, 0Ah
 11876 000043FD 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
 11876 00004406 206F72203020746F20-
 11876 0000440F 63616E63656C202E2E-
 11876 00004418 20                 
 11877 00004419 0D0A00                   	db 	0Dh, 0Ah, 0
 11878                                  
 11879                                  msg_create_primary_partition_h:
 11880 0000441C 0D0A                    	db	0Dh, 0Ah
 11881 0000441E 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11881 00004427 2D2D2D2D2D2D2D2D2D-
 11881 00004430 2D2D2D2D2D2D2D2D2D-
 11881 00004439 2D2D2D2D2D2D2D2D2D-
 11881 00004442 2D2D2D2D2D2D2D2D2D-
 11881 0000444B 2D2D2D2D2D2D2D2D2D-
 11881 00004454 2D2D2D2D2D2D2D2D2D-
 11881 0000445D 2D2D2D2D2D2D2D2D2D-
 11881 00004466 2D2D2D2D2D2D2D2D   
 11882 0000446E 202020202020202020-     	db	"                          Create Primary DOS Partition                          "
 11882 00004477 202020202020202020-
 11882 00004480 202020202020202043-
 11882 00004489 726561746520507269-
 11882 00004492 6D61727920444F5320-
 11882 0000449B 506172746974696F6E-
 11882 000044A4 202020202020202020-
 11882 000044AD 202020202020202020-
 11882 000044B6 2020202020202020   
 11883 000044BE 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11883 000044C7 2D2D2D2D2D2D2D2D2D-
 11883 000044D0 2D2D2D2D2D2D2D2D2D-
 11883 000044D9 2D2D2D2D2D2D2D2D2D-
 11883 000044E2 2D2D2D2D2D2D2D2D2D-
 11883 000044EB 2D2D2D2D2D2D2D2D2D-
 11883 000044F4 2D2D2D2D2D2D2D2D2D-
 11883 000044FD 2D2D2D2D2D2D2D2D2D-
 11883 00004506 2D2D2D2D2D2D2D2D   
 11884 0000450E 0D0A00                  	db	0Dh, 0Ah, 0
 11885                                  
 11886                                  msg_create_dos_partition_h:
 11887 00004511 0D0A                    	db	0Dh, 0Ah
 11888 00004513 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11888 0000451C 2D2D2D2D2D2D2D2D2D-
 11888 00004525 2D2D2D2D2D2D2D2D2D-
 11888 0000452E 2D2D2D2D2D2D2D2D2D-
 11888 00004537 2D2D2D2D2D2D2D2D2D-
 11888 00004540 2D2D2D2D2D2D2D2D2D-
 11888 00004549 2D2D2D2D2D2D2D2D2D-
 11888 00004552 2D2D2D2D2D2D2D2D2D-
 11888 0000455B 2D2D2D2D2D2D2D2D   
 11889 00004563 202020202020202020-     	db	"                   Create DOS Partition or Logical DOS Drive                    "
 11889 0000456C 202020202020202020-
 11889 00004575 204372656174652044-
 11889 0000457E 4F5320506172746974-
 11889 00004587 696F6E206F72204C6F-
 11889 00004590 676963616C20444F53-
 11889 00004599 204472697665202020-
 11889 000045A2 202020202020202020-
 11889 000045AB 2020202020202020   
 11890 000045B3 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11890 000045BC 2D2D2D2D2D2D2D2D2D-
 11890 000045C5 2D2D2D2D2D2D2D2D2D-
 11890 000045CE 2D2D2D2D2D2D2D2D2D-
 11890 000045D7 2D2D2D2D2D2D2D2D2D-
 11890 000045E0 2D2D2D2D2D2D2D2D2D-
 11890 000045E9 2D2D2D2D2D2D2D2D2D-
 11890 000045F2 2D2D2D2D2D2D2D2D2D-
 11890 000045FB 2D2D2D2D2D2D2D2D   
 11891 00004603 0D0A00                  	db	0Dh, 0Ah, 0
 11892                                  
 11893                                  msg_create_ext_partition_h:
 11894 00004606 0D0A                    	db	0Dh, 0Ah
 11895 00004608 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11895 00004611 2D2D2D2D2D2D2D2D2D-
 11895 0000461A 2D2D2D2D2D2D2D2D2D-
 11895 00004623 2D2D2D2D2D2D2D2D2D-
 11895 0000462C 2D2D2D2D2D2D2D2D2D-
 11895 00004635 2D2D2D2D2D2D2D2D2D-
 11895 0000463E 2D2D2D2D2D2D2D2D2D-
 11895 00004647 2D2D2D2D2D2D2D2D2D-
 11895 00004650 2D2D2D2D2D2D2D2D   
 11896 00004658 202020202020202020-     	db	"                         Create Extended DOS Partition                          "
 11896 00004661 202020202020202020-
 11896 0000466A 202020202020204372-
 11896 00004673 656174652045787465-
 11896 0000467C 6E64656420444F5320-
 11896 00004685 506172746974696F6E-
 11896 0000468E 202020202020202020-
 11896 00004697 202020202020202020-
 11896 000046A0 2020202020202020   
 11897 000046A8 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11897 000046B1 2D2D2D2D2D2D2D2D2D-
 11897 000046BA 2D2D2D2D2D2D2D2D2D-
 11897 000046C3 2D2D2D2D2D2D2D2D2D-
 11897 000046CC 2D2D2D2D2D2D2D2D2D-
 11897 000046D5 2D2D2D2D2D2D2D2D2D-
 11897 000046DE 2D2D2D2D2D2D2D2D2D-
 11897 000046E7 2D2D2D2D2D2D2D2D2D-
 11897 000046F0 2D2D2D2D2D2D2D2D   
 11898 000046F8 0D0A00                  	db	0Dh, 0Ah, 0
 11899                                  
 11900                                  msg_create_logical_drive_h:
 11901 000046FB 0D0A                    	db	0Dh, 0Ah
 11902 000046FD 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11902 00004706 2D2D2D2D2D2D2D2D2D-
 11902 0000470F 2D2D2D2D2D2D2D2D2D-
 11902 00004718 2D2D2D2D2D2D2D2D2D-
 11902 00004721 2D2D2D2D2D2D2D2D2D-
 11902 0000472A 2D2D2D2D2D2D2D2D2D-
 11902 00004733 2D2D2D2D2D2D2D2D2D-
 11902 0000473C 2D2D2D2D2D2D2D2D2D-
 11902 00004745 2D2D2D2D2D2D2D2D   
 11903 0000474D 202020202020202020-     	db	"                            Create Logical DOS Drive                            "
 11903 00004756 202020202020202020-
 11903 0000475F 202020202020202020-
 11903 00004768 20437265617465204C-
 11903 00004771 6F676963616C20444F-
 11903 0000477A 532044726976652020-
 11903 00004783 202020202020202020-
 11903 0000478C 202020202020202020-
 11903 00004795 2020202020202020   
 11904 0000479D 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11904 000047A6 2D2D2D2D2D2D2D2D2D-
 11904 000047AF 2D2D2D2D2D2D2D2D2D-
 11904 000047B8 2D2D2D2D2D2D2D2D2D-
 11904 000047C1 2D2D2D2D2D2D2D2D2D-
 11904 000047CA 2D2D2D2D2D2D2D2D2D-
 11904 000047D3 2D2D2D2D2D2D2D2D2D-
 11904 000047DC 2D2D2D2D2D2D2D2D2D-
 11904 000047E5 2D2D2D2D2D2D2D2D   
 11905 000047ED 0D0A00                  	db	0Dh, 0Ah, 0
 11906                                  
 11907                                  msg_create_nondos_partition_h:
 11908 000047F0 0D0A                    	db	0Dh, 0Ah
 11909 000047F2 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11909 000047FB 2D2D2D2D2D2D2D2D2D-
 11909 00004804 2D2D2D2D2D2D2D2D2D-
 11909 0000480D 2D2D2D2D2D2D2D2D2D-
 11909 00004816 2D2D2D2D2D2D2D2D2D-
 11909 0000481F 2D2D2D2D2D2D2D2D2D-
 11909 00004828 2D2D2D2D2D2D2D2D2D-
 11909 00004831 2D2D2D2D2D2D2D2D2D-
 11909 0000483A 2D2D2D2D2D2D2D2D   
 11910 00004842 202020202020202020-     	db	"                            Create NON-DOS Partition                            "
 11910 0000484B 202020202020202020-
 11910 00004854 202020202020202020-
 11910 0000485D 20437265617465204E-
 11910 00004866 4F4E2D444F53205061-
 11910 0000486F 72746974696F6E2020-
 11910 00004878 202020202020202020-
 11910 00004881 202020202020202020-
 11910 0000488A 2020202020202020   
 11911 00004892 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 11911 0000489B 2D2D2D2D2D2D2D2D2D-
 11911 000048A4 2D2D2D2D2D2D2D2D2D-
 11911 000048AD 2D2D2D2D2D2D2D2D2D-
 11911 000048B6 2D2D2D2D2D2D2D2D2D-
 11911 000048BF 2D2D2D2D2D2D2D2D2D-
 11911 000048C8 2D2D2D2D2D2D2D2D2D-
 11911 000048D1 2D2D2D2D2D2D2D2D2D-
 11911 000048DA 2D2D2D2D2D2D2D2D   
 11912 000048E2 0D0A00                  	db	0Dh, 0Ah, 0
 11913                                  
 11914                                  msg_create_dos_partition_m:
 11915 000048E5 53656C65637420616E-     	db	"Select an option: "
 11915 000048EE 206F7074696F6E3A20 
 11916 000048F7 0D0A                    	db	0Dh, 0Ah
 11917 000048F9 0D0A                    	db	0Dh, 0Ah
 11918 000048FB 202031292043726561-     	db	"  1) Create Primary DOS partition ", 0Dh, 0Ah
 11918 00004904 7465205072696D6172-
 11918 0000490D 7920444F5320706172-
 11918 00004916 746974696F6E200D0A 
 11919 0000491F 202032292043726561-     	db	"  2) Create Extended DOS partition ", 0Dh, 0Ah
 11919 00004928 746520457874656E64-
 11919 00004931 656420444F53207061-
 11919 0000493A 72746974696F6E200D-
 11919 00004943 0A                 
 11920 00004944 202033292043726561-     	db	"  3) Create Logical DOS drive(s) in Extended DOS partition ", 0Dh, 0Ah
 11920 0000494D 7465204C6F67696361-
 11920 00004956 6C20444F5320647269-
 11920 0000495F 766528732920696E20-
 11920 00004968 457874656E64656420-
 11920 00004971 444F53207061727469-
 11920 0000497A 74696F6E200D0A     
 11921 00004981 0D0A                    	db	0Dh, 0Ah	
 11922 00004983 507265737320455343-     	db	"Press ESC or 0 to cancel .. "
 11922 0000498C 206F72203020746F20-
 11922 00004995 63616E63656C202E2E-
 11922 0000499E 20                 
 11923 0000499F 0D0A00                   	db 	0Dh, 0Ah, 0
 11924                                  
 11925                                  msg_create_trdos_partition_s:
 11926 000049A2 53656C65637420616E-     	db	"Select an option to set partition size: "
 11926 000049AB 206F7074696F6E2074-
 11926 000049B4 6F2073657420706172-
 11926 000049BD 746974696F6E207369-
 11926 000049C6 7A653A20           
 11927 000049CA 0D0A                    	db	0Dh, 0Ah
 11928 000049CC 0D0A                    	db	0Dh, 0Ah
 11929 000049CE 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah
 11929 000049D7 6E64657220636F756E-
 11929 000049E0 740D0A             
 11930 000049E3 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
 11930 000049EC 6D652070657263656E-
 11930 000049F5 746167652028232325-
 11930 000049FE 290D0A             
 11931 00004A01 202053292053656374-     	db	"  S) Sectors (number of 512 bytes)", 0Dh, 0Ah
 11931 00004A0A 6F727320286E756D62-
 11931 00004A13 6572206F6620353132-
 11931 00004A1C 206279746573290D0A 
 11932 00004A25 20204B29204B696C6F-     	db	"  K) Kilo bytes (KB, 2*K sectors)", 0Dh, 0Ah
 11932 00004A2E 20627974657320284B-
 11932 00004A37 422C20322A4B207365-
 11932 00004A40 63746F7273290D0A   
 11933 00004A48 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
 11933 00004A51 20627974657320284D-
 11933 00004A5A 422C20322A31303234-
 11933 00004A63 2A4D20736563746F72-
 11933 00004A6C 73290D0A           
 11934 00004A70 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
 11934 00004A79 206279746573202847-
 11934 00004A82 422C20322A31303234-
 11934 00004A8B 2A313032342A472073-
 11934 00004A94 6563746F7273290D0A 
 11935 00004A9D 0D0A                    	db	0Dh, 0Ah	
 11936 00004A9F 507265737320535041-     	db	"Press SPACE to use whole disk or press ENTER to set sector count .. "
 11936 00004AA8 434520746F20757365-
 11936 00004AB1 2077686F6C65206469-
 11936 00004ABA 736B206F7220707265-
 11936 00004AC3 737320454E54455220-
 11936 00004ACC 746F20736574207365-
 11936 00004AD5 63746F7220636F756E-
 11936 00004ADE 74202E2E20         
 11937                                  msg_press_esc_to_cancel:
 11938 00004AE3 0D0A                     	db	0Dh, 0Ah
 11939 00004AE5 285072657373204553-     	db	"(Press ESC to CANCEL) "
 11939 00004AEE 4320746F2043414E43-
 11939 00004AF7 454C2920           
 11940 00004AFB 0D0A00                  	db 	0Dh, 0Ah, 0
 11941                                  
 11942                                  msg_use_whole_disk:
 11943 00004AFE 446F20796F75207761-     	db	"Do you want to use WHOLE disk !? (Y/N)", 0
 11943 00004B07 6E7420746F20757365-
 11943 00004B10 2057484F4C45206469-
 11943 00004B19 736B20213F2028592F-
 11943 00004B22 4E2900             
 11944                                  
 11945                                  msg_use_all_space:
 11946 00004B25 446F20796F75207761-     	db	"Do you want to use all of available space !? (Y/N)", 0
 11946 00004B2E 6E7420746F20757365-
 11946 00004B37 20616C6C206F662061-
 11946 00004B40 7661696C61626C6520-
 11946 00004B49 737061636520213F20-
 11946 00004B52 28592F4E2900       
 11947                                  
 11948                                  msg_use_entire_ep_space:
 11949 00004B58 446F20796F75207761-     	db	"Do you want to use entire extended partition space !? (Y/N)", 0
 11949 00004B61 6E7420746F20757365-
 11949 00004B6A 20656E746972652065-
 11949 00004B73 7874656E6465642070-
 11949 00004B7C 6172746974696F6E20-
 11949 00004B85 737061636520213F20-
 11949 00004B8E 28592F4E2900       
 11950                                  
 11951                                  msg_partition_size:
 11952 00004B94 0D0A                    	db	0Dh, 0Ah
 11953 00004B96 0D0A                    	db	0Dh, 0Ah
 11954 00004B98 506172746974696F6E-     	db	"Partition size ("
 11954 00004BA1 2073697A652028     
 11955                                  msg_partition_size_x:
 11956 00004BA8 3F29203A20              	db	"?) : "
 11957 00004BAD 00                      	db	0
 11958                                  
 11959                                  msg_partition_type:
 11960 00004BAE 0D0A                    	db	0Dh, 0Ah
 11961 00004BB0 0D0A                    	db	0Dh, 0Ah
 11962 00004BB2 506172746974696F6E-     	db	"Partition type : "
 11962 00004BBB 2074797065203A20   
 11963 00004BC3 00                      	db	0
 11964                                  
 11965                                  msg_ptype_num:
 11966 00004BC4 3030680D0A00            	db	"00h", 0Dh, 0Ah, 0
 11967                                  
 11968                                  msg_partition_type_error:
 11969 00004BCA 506172746974696F6E-     	db	"Partition size is not proper for selected partition type !"
 11969 00004BD3 2073697A6520697320-
 11969 00004BDC 6E6F742070726F7065-
 11969 00004BE5 7220666F722073656C-
 11969 00004BEE 656374656420706172-
 11969 00004BF7 746974696F6E207479-
 11969 00004C00 70652021           
 11970 00004C04 0D0A                    	db	0Dh, 0Ah
 11971                                  msg_any_key_to_retry:
 11972 00004C06 28507265737320616E-     	db	"(Press any key to retry..)"
 11972 00004C0F 79206B657920746F20-
 11972 00004C18 72657472792E2E29   
 11973 00004C20 0D0A00                  	db	0Dh, 0Ah, 0
 11974                                  
 11975                                  msg_partition_size_overs:
 11976 00004C23 0D0A                    	db	0Dh, 0Ah
 11977 00004C25 506172746974696F6E-     	db	"Partition size overs the disk capacity !"
 11977 00004C2E 2073697A65206F7665-
 11977 00004C37 727320746865206469-
 11977 00004C40 736B20636170616369-
 11977 00004C49 74792021           
 11978 00004C4D 0D0A                    	db	0Dh, 0Ah
 11979 00004C4F 28507265737320454E-     	db	"(Press ENTER to use WHOLE disk or press ESC key to retry..)" 
 11979 00004C58 54455220746F207573-
 11979 00004C61 652057484F4C452064-
 11979 00004C6A 69736B206F72207072-
 11979 00004C73 65737320455343206B-
 11979 00004C7C 657920746F20726574-
 11979 00004C85 72792E2E29         
 11980 00004C8A 0D0A00                  	db	0Dh, 0Ah, 0
 11981                                  
 11982                                  msg_ext_partition_error:
 11983 00004C8D 457874656E64656420-     	db	"Extended partition must be created after primary partition !"
 11983 00004C96 706172746974696F6E-
 11983 00004C9F 206D75737420626520-
 11983 00004CA8 637265617465642061-
 11983 00004CB1 66746572207072696D-
 11983 00004CBA 617279207061727469-
 11983 00004CC3 74696F6E2021       
 11984 00004CC9 0D0A00                  	db	0Dh, 0Ah,0
 11985                                  
 11986                                  msg_logical_drive_error:
 11987 00004CCC 5072696D6172792061-     	db	"Primary and extended partitions must be created before logical drive !"
 11987 00004CD5 6E6420657874656E64-
 11987 00004CDE 656420706172746974-
 11987 00004CE7 696F6E73206D757374-
 11987 00004CF0 206265206372656174-
 11987 00004CF9 6564206265666F7265-
 11987 00004D02 206C6F676963616C20-
 11987 00004D0B 64726976652021     
 11988 00004D12 0D0A00                  	db	0Dh, 0Ah,0
 11989                                  
 11990                                  msg_cylinder_boundary_set:
 11991 00004D15 0D0A                    	db	0Dh, 0Ah
 11992 00004D17 446F20796F75207761-     	db	"Do you want to adjust partition size to cylinder boundary ? (Y/N)"
 11992 00004D20 6E7420746F2061646A-
 11992 00004D29 757374207061727469-
 11992 00004D32 74696F6E2073697A65-
 11992 00004D3B 20746F2063796C696E-
 11992 00004D44 64657220626F756E64-
 11992 00004D4D 617279203F2028592F-
 11992 00004D56 4E29               
 11993 00004D58 00                      	db	0
 11994                                  
 11995                                  	; 2019 - 2020 (hdimage.s)
 11996                                  ;msg_selected_partition:
 11997                                  ;	db	"                                 PARTITION 0                                    "
 11998                                  ;	db	"================================================================================"
 11999                                  ;	db	"        S  BH  BS  BC  FS  EH  ES  EC    START SEC   SECTORS   FILE SYSTEM      "
 12000                                  ;	db	"--------------------------------------------------------------------------------"
 12001                                  ;pt_row: db	"                                                                                "
 12002                                  ;	db	"================================================================================"
 12003                                  ;	db	0
 12004                                  
 12005                                  	; 24/10/2020 (fdisk3.s)
 12006                                  msg_selected_partition:
 12007 00004D59 202020202020202020-     	db	"                                 PARTITION 0                                    "
 12007 00004D62 202020202020202020-
 12007 00004D6B 202020202020202020-
 12007 00004D74 202020202020504152-
 12007 00004D7D 544954494F4E203020-
 12007 00004D86 202020202020202020-
 12007 00004D8F 202020202020202020-
 12007 00004D98 202020202020202020-
 12007 00004DA1 2020202020202020   
 12008 00004DA9 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 12008 00004DB2 3D3D3D3D3D3D3D3D3D-
 12008 00004DBB 3D3D3D3D3D3D3D3D3D-
 12008 00004DC4 3D3D3D3D3D3D3D3D3D-
 12008 00004DCD 3D3D3D3D3D3D3D3D3D-
 12008 00004DD6 3D3D3D3D3D3D3D3D3D-
 12008 00004DDF 3D3D3D3D3D3D3D3D3D-
 12008 00004DE8 3D3D3D3D3D3D3D3D3D-
 12008 00004DF1 3D3D3D3D3D3D3D3D   
 12009 00004DF9 202020202020205320-     	db	"       S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS   FILE SYSTEM      "
 12009 00004E02 204248202042532020-
 12009 00004E0B 424320204653202045-
 12009 00004E14 482020455320204543-
 12009 00004E1D 202020535441525420-
 12009 00004E26 534543542020202053-
 12009 00004E2F 4543544F5253202020-
 12009 00004E38 46494C452053595354-
 12009 00004E41 454D202020202020   
 12010 00004E49 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 12010 00004E52 2D2D2D2D2D2D2D2D2D-
 12010 00004E5B 2D2D2D2D2D2D2D2D2D-
 12010 00004E64 2D2D2D2D2D2D2D2D2D-
 12010 00004E6D 2D2D2D2D2D2D2D2D2D-
 12010 00004E76 2D2D2D2D2D2D2D2D2D-
 12010 00004E7F 2D2D2D2D2D2D2D2D2D-
 12010 00004E88 2D2D2D2D2D2D2D2D2D-
 12010 00004E91 2D2D2D2D2D2D2D2D   
 12011 00004E99 202020202020202020-     pt_row:	db	"                                                                                "
 12011 00004EA2 202020202020202020-
 12011 00004EAB 202020202020202020-
 12011 00004EB4 202020202020202020-
 12011 00004EBD 202020202020202020-
 12011 00004EC6 202020202020202020-
 12011 00004ECF 202020202020202020-
 12011 00004ED8 202020202020202020-
 12011 00004EE1 2020202020202020   
 12012 00004EE9 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 12012 00004EF2 3D3D3D3D3D3D3D3D3D-
 12012 00004EFB 3D3D3D3D3D3D3D3D3D-
 12012 00004F04 3D3D3D3D3D3D3D3D3D-
 12012 00004F0D 3D3D3D3D3D3D3D3D3D-
 12012 00004F16 3D3D3D3D3D3D3D3D3D-
 12012 00004F1F 3D3D3D3D3D3D3D3D3D-
 12012 00004F28 3D3D3D3D3D3D3D3D3D-
 12012 00004F31 3D3D3D3D3D3D3D3D   
 12013 00004F39 00                      	db	0
 12014                                  msg_boot_indicator:
 12015 00004F3A 0D0A                    	db	0Dh, 0Ah
 12016 00004F3C 20202020426F6F7420-     	db	"    Boot Indicator : ", 0 ; "YES", "NO"
 12016 00004F45 496E64696361746F72-
 12016 00004F4E 203A2000           
 12017                                  msg_starting_head:
 12018 00004F52 0D0A                    	db	0Dh, 0Ah
 12019 00004F54 202020202053746172-     	db 	"     Starting Head : ", 0
 12019 00004F5D 74696E672048656164-
 12019 00004F66 203A2000           
 12020                                  msg_starting_sector:
 12021 00004F6A 0D0A                    	db	0Dh, 0Ah
 12022 00004F6C 202020537461727469-     	db	"   Starting Sector : ", 0
 12022 00004F75 6E6720536563746F72-
 12022 00004F7E 203A2000           
 12023                                  msg_starting_cylinder:
 12024 00004F82 0D0A                    	db	0Dh, 0Ah
 12025 00004F84 205374617274696E67-     	db	" Starting Cylinder : ", 0
 12025 00004F8D 2043796C696E646572-
 12025 00004F96 203A2000           
 12026                                  msg_system_id:
 12027 00004F9A 0D0A                    	db	0Dh, 0Ah
 12028 00004F9C 202020202020202020-     	db	"         System ID : ", 0
 12028 00004FA5 53797374656D204944-
 12028 00004FAE 203A2000           
 12029                                  msg_ending_head:
 12030 00004FB2 0D0A                    	db	0Dh, 0Ah
 12031 00004FB4 20202020202020456E-     	db 	"       Ending Head : ", 0
 12031 00004FBD 64696E672048656164-
 12031 00004FC6 203A2000           
 12032                                  msg_ending_sector:
 12033 00004FCA 0D0A                    	db	0Dh, 0Ah
 12034 00004FCC 2020202020456E6469-     	db	"     Ending Sector : ", 0
 12034 00004FD5 6E6720536563746F72-
 12034 00004FDE 203A2000           
 12035                                  msg_ending_cylinder:
 12036 00004FE2 0D0A                    	db	0Dh, 0Ah
 12037 00004FE4 202020456E64696E67-     	db	"   Ending Cylinder : ", 0
 12037 00004FED 2043796C696E646572-
 12037 00004FF6 203A2000           
 12038                                  msg_relative_sectors:
 12039 00004FFA 0D0A                    	db	0Dh, 0Ah
 12040 00004FFC 0D0A                    	db	0Dh, 0Ah
 12041 00004FFE 202052656C61746976-     	db	"  Relative Sectors : ", 0
 12041 00005007 6520536563746F7273-
 12041 00005010 203A2000           
 12042                                  msg_total_sectors:
 12043 00005014 0D0A                    	db	0Dh, 0Ah
 12044 00005016 2020202020546F7461-     	db	"     Total Sectors : ", 0
 12044 0000501F 6C20536563746F7273-
 12044 00005028 203A2000           
 12045                                  
 12046                                  msg_format_stage:
 12047 0000502C 0D0A                    	db	0Dh, 0Ah
 12048 0000502E 507265737320454E54-     	db	"Press ENTER to FORMAT disk partition "
 12048 00005037 455220746F20464F52-
 12048 00005040 4D4154206469736B20-
 12048 00005049 706172746974696F6E-
 12048 00005052 20                 
 12049                                  partition_num_chr:
 12050 00005053 30                      	db	"0"
 12051 00005054 206F72207072657373-     	db	" or press ESC to EXIT.."
 12051 0000505D 2045534320746F2045-
 12051 00005066 5849542E2E         
 12052 0000506B 00                      	db	0
 12053                                  msg_partition_edit:
 12054 0000506C 0D0A                    	db	0Dh, 0Ah
 12055 0000506E 2E2E206F7220707265-     	db	".. or press SPACE to EDIT partition table."
 12055 00005077 737320535041434520-
 12055 00005080 746F20454449542070-
 12055 00005089 6172746974696F6E20-
 12055 00005092 7461626C652E       
 12056 00005098 0D0A00                  	db	0Dh, 0Ah, 0
 12057                                  
 12058                                  msg_edit_or_exit:
 12059 0000509B 0D0A                    	db 	0Dh, 0Ah
 12060 0000509D 507265737320454E54-     	db	"Press ENTER to continue or press ESC to exit.."
 12060 000050A6 455220746F20636F6E-
 12060 000050AF 74696E7565206F7220-
 12060 000050B8 707265737320455343-
 12060 000050C1 20746F20657869742E-
 12060 000050CA 2E                 
 12061 000050CB 00                      	db	0
 12062                                  
 12063                                  msg_overwrite_question1:
 12064 000050CC 0D0A                    	db	0Dh, 0Ah
 12065 000050CE 446F20796F75207761-     	db	'Do you want to overwrite '
 12065 000050D7 6E7420746F206F7665-
 12065 000050E0 72777269746520     
 12066 000050E7 27                      	db	27h
 12067 000050E8 00                      	db	0
 12068                                  
 12069                                  msg_overwrite_question2: 
 12070 000050E9 27                      	db	27h
 12071 000050EA 2066696C6520            	db	' file '
 12072 000050F0 00                      	db	0
 12073                                  
 12074                                  msg_format_question:
 12075 000050F1 0D0A                    	db	0Dh, 0Ah
 12076 000050F3 446F20796F75207761-     	db	"Do you want to format partition "
 12076 000050FC 6E7420746F20666F72-
 12076 00005105 6D6174207061727469-
 12076 0000510E 74696F6E20         
 12077                                  partition_num_txt:
 12078 00005113 3020                    	db	 "0 "
 12079                                  msg_yes_no:
 12080 00005115 285965732F4E6F293F-     	db	'(Yes/No)? ', 0
 12080 0000511E 2000               
 12081                                  
 12082                                  msg_writing_mbr:
 12083 00005120 57726974696E67206D-     	db	"Writing masterboot sector...", 0
 12083 00005129 6173746572626F6F74-
 12083 00005132 20736563746F722E2E-
 12083 0000513B 2E00               
 12084                                  
 12085                                  msg_writing_disk_sectors:
 12086 0000513D 57726974696E672064-     	db	"Writing disk sector: ", 0
 12086 00005146 69736B20736563746F-
 12086 0000514F 723A2000           
 12087                                  
 12088                                  Msg_Writing_Boot_Sector:
 12089 00005153 57726974696E672074-     	db	"Writing trdos boot sector...", 0
 12089 0000515C 72646F7320626F6F74-
 12089 00005165 20736563746F722E2E-
 12089 0000516E 2E00               
 12090                                  
 12091                                  Msg_Writing_Root_Dir:
 12092 00005170 57726974696E672072-     	db	"Writing root directory sectors...", 0
 12092 00005179 6F6F74206469726563-
 12092 00005182 746F72792073656374-
 12092 0000518B 6F72732E2E2E00     
 12093                                  
 12094                                  Msg_Writing_Data_Sectors:
 12095 00005192 57726974696E672064-     	db	"Writing data sector: ", 0
 12095 0000519B 61746120736563746F-
 12095 000051A4 723A2000           
 12096                                  
 12097                                  Sector_Str:
 12098 000051A8 3030303030303000        	db	"0000000", 0
 12099                                  Cursor_Pos:
 12100 000051B0 0000                    	dw	0
 12101                                  
 12102                                  Msg_Writing_FAT_Sectors:
 12103 000051B2 57726974696E672046-     	db	"Writing FAT sectors...", 0
 12103 000051BB 415420736563746F72-
 12103 000051C4 732E2E2E00         
 12104                                  
 12105                                  StrVolumeName:
 12106                                  	;times 	12 db  0
 12107 000051C9 00<rep 41h>             	times	65 db 0  ; 05/01/2018 (fs1 volume name)	
 12108                                  
 12109                                  Msg_Volume_Name:
 12110 0000520A 0D0A                    	db	0Dh, 0Ah
 12111 0000520C 0D0A                    	db	0Dh, 0Ah
 12112 0000520E 566F6C756D65204E61-     	db	"Volume Name: ", 0
 12112 00005217 6D653A2000         
 12113                                  
 12114                                  Msg_Volume_Serial:
 12115 0000521C 566F6C756D65205365-     	db	"Volume Serial No: "
 12115 00005225 7269616C204E6F3A20 
 12116                                  Vol_Serial1:
 12117 0000522E 30303030                	db	"0000"
 12118 00005232 2D                      	db	"-"
 12119                                  Vol_Serial2:
 12120 00005233 30303030                	db	"0000"
 12121 00005237 0D0A00                  	db	0Dh, 0Ah, 0
 12122                                  
 12123                                  msg_cluster_count:
 12124 0000523A 436C75737465722043-     	db	"Cluster Count: ", 0
 12124 00005243 6F756E743A2000     
 12125                                  cluster_count_str:
 12126 0000524A 30303030303030          	db	"0000000"
 12127 00005251 0D0A00                  	db	0Dh, 0Ah, 0
 12128                                  msg_formatting:
 12129 00005254 466F726D617474696E-     	db	"Formatting ", 0
 12129 0000525D 672000             
 12130                                  format_percent_str:
 12131 00005260 30303025                	db	"000%"
 12132 00005264 00                      	db	0
 12133                                  
 12134                                  Msg_3dot_OK:
 12135 00005265 2E2E2E                  	db	"..."
 12136                                  Msg_OK:
 12137 00005268 204F4B2E                	db	' OK.'
 12138                                  CRLF:
 12139 0000526C 0D0A00                  	db	0Dh, 0Ah, 0
 12140                                  
 12141                                  Msg_Error:
 12142 0000526F 0D0A                    	db	0Dh, 0Ah
 12143 00005271 4572726F72202120        	db	'Error ! '
 12144 00005279 28                      	db	'('
 12145                                  error_code:
 12146 0000527A 3030                    	dw	3030h
 12147 0000527C 68                      	db	'h'
 12148 0000527D 2920                    	db	') '
 12149 0000527F 0D0A                    	db	0Dh, 0Ah
 12150 00005281 00                      	db	0
 12151                                  
 12152                                  msg_disk_sectors:
 12153 00005282 546F74616C20446973-     	db	"Total Disk Sectors : ", 0
 12153 0000528B 6B20536563746F7273-
 12153 00005294 203A2000           
 12154                                  
 12155                                  str_disk_sectors:
 12156                                  	;times	8 db 0
 12157 00005298 00<rep Bh>              	times	11 db 0 ; 27/10/2020
 12158                                  
 12159                                  msg_ep_size:
 12160 000052A3 457874656E64656420-     	db	"Extended Partition Size in Sectors: ", 0
 12160 000052AC 506172746974696F6E-
 12160 000052B5 2053697A6520696E20-
 12160 000052BE 536563746F72733A20-
 12160 000052C7 00                 
 12161                                  
 12162                                  msg_press_any_key:
 12163 000052C8 0D0A                    	db	0Dh, 0Ah
 12164 000052CA 50726573732061206B-     	db	"Press a key to continue..."
 12164 000052D3 657920746F20636F6E-
 12164 000052DC 74696E75652E2E2E   
 12165 000052E4 0D0A00                  	db	0Dh, 0Ah, 0
 12166                                  
 12167 000052E7 90                      align 2
 12168                                  
 12169                                  ; Masterboot sector
 12170                                  
 12171                                  MasterBootBuff:
 12172                                  MasterBootCode: 
 12173 000052E8 00<rep 1BEh>            	times	446 db 0
 12174                                  PartitionTable:
 12175 000054A6 00<rep 40h>             	times	64 db 0
 12176                                  MBIDCode:
 12177 000054E6 0000                    	dw	0
 12178                                  
 12179                                  PTable_Buffer:
 12180 000054E8 00<rep 40h>             	times	64 db 0
 12181                                   
 12182 00005528 286329204572646F67-     	db	'(c) Erdogan TAN 2019-2024'
 12182 00005531 616E2054414E203230-
 12182 0000553A 31392D32303234     
 12183                                  
 12184                                  ; 05/11/2020
 12185 00005541 00                      	db	0
 12186                                  
 12187                                  	; 2019 - 2020 (hdimage.s)
 12188                                  ;p_table_header:
 12189                                  ;	db	"                              ?BR PARTITION TABLE                               "
 12190                                  ;	db	"================================================================================"
 12191                                  ;	db	"       P  S  BH  BS  BC  FS  EH  ES  EC  START SEC  SECTORS  FILE SYSTEM        "
 12192                                  ;	db	"--------------------------------------------------------------------------------"
 12193                                  ;	db	0
 12194                                  ;p_table_footer:
 12195                                  ;	db	"================================================================================"
 12196                                  ;	db	0Dh, 0Ah, 0
 12197                                  
 12198                                  	; 24/10/2020 (fdisk3.s)
 12199                                  p_table_header:
 12200 00005542 202020202020202020-     	db	"                              ?BR PARTITION TABLE                               "
 12200 0000554B 202020202020202020-
 12200 00005554 202020202020202020-
 12200 0000555D 2020203F4252205041-
 12200 00005566 52544954494F4E2054-
 12200 0000556F 41424C452020202020-
 12200 00005578 202020202020202020-
 12200 00005581 202020202020202020-
 12200 0000558A 2020202020202020   
 12201 00005592 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 12201 0000559B 3D3D3D3D3D3D3D3D3D-
 12201 000055A4 3D3D3D3D3D3D3D3D3D-
 12201 000055AD 3D3D3D3D3D3D3D3D3D-
 12201 000055B6 3D3D3D3D3D3D3D3D3D-
 12201 000055BF 3D3D3D3D3D3D3D3D3D-
 12201 000055C8 3D3D3D3D3D3D3D3D3D-
 12201 000055D1 3D3D3D3D3D3D3D3D3D-
 12201 000055DA 3D3D3D3D3D3D3D3D   
 12202 000055E2 202020502020205320-     	db	"   P   S  BH  BS  BC  FS  EH  ES  EC   START SECT    SECTORS    FILE SYSTEM     "
 12202 000055EB 204248202042532020-
 12202 000055F4 424320204653202045-
 12202 000055FD 482020455320204543-
 12202 00005606 202020535441525420-
 12202 0000560F 534543542020202053-
 12202 00005618 4543544F5253202020-
 12202 00005621 2046494C4520535953-
 12202 0000562A 54454D2020202020   
 12203 00005632 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
 12203 0000563B 2D2D2D2D2D2D2D2D2D-
 12203 00005644 2D2D2D2D2D2D2D2D2D-
 12203 0000564D 2D2D2D2D2D2D2D2D2D-
 12203 00005656 2D2D2D2D2D2D2D2D2D-
 12203 0000565F 2D2D2D2D2D2D2D2D2D-
 12203 00005668 2D2D2D2D2D2D2D2D2D-
 12203 00005671 2D2D2D2D2D2D2D2D2D-
 12203 0000567A 2D2D2D2D2D2D2D2D   
 12204 00005682 00                      	db	0
 12205                                  p_table_footer:
 12206 00005683 3D3D3D3D3D3D3D3D3D-     	db	"================================================================================"
 12206 0000568C 3D3D3D3D3D3D3D3D3D-
 12206 00005695 3D3D3D3D3D3D3D3D3D-
 12206 0000569E 3D3D3D3D3D3D3D3D3D-
 12206 000056A7 3D3D3D3D3D3D3D3D3D-
 12206 000056B0 3D3D3D3D3D3D3D3D3D-
 12206 000056B9 3D3D3D3D3D3D3D3D3D-
 12206 000056C2 3D3D3D3D3D3D3D3D3D-
 12206 000056CB 3D3D3D3D3D3D3D3D   
 12207 000056D3 0D0A00                  	db	0Dh, 0Ah, 0
 12208                                  
 12209                                  mbr_editing_options:
 12210 000056D6 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 12211 000056DA 4D4252205061727469-     	db	"MBR Partition Table Editing Options:"
 12211 000056E3 74696F6E205461626C-
 12211 000056EC 652045646974696E67-
 12211 000056F5 204F7074696F6E733A 
 12212 000056FE 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12213 00005702 20202020202020312E-     	db	"       1. Create Partition", 0Dh, 0Ah
 12213 0000570B 204372656174652050-
 12213 00005714 6172746974696F6E0D-
 12213 0000571D 0A                 
 12214 0000571E 20202020202020322E-     	db	"       2. Set Active Partition", 0Dh, 0Ah
 12214 00005727 205365742041637469-
 12214 00005730 766520506172746974-
 12214 00005739 696F6E0D0A         
 12215 0000573E 20202020202020332E-     	db	"       3. Delete Partition", 0Dh, 0Ah  
 12215 00005747 2044656C6574652050-
 12215 00005750 6172746974696F6E0D-
 12215 00005759 0A                 
 12216 0000575A 20202020202020342E-     	db	"       4. Write Current Partition Table", 0Dh, 0Ah, 0
 12216 00005763 205772697465204375-
 12216 0000576C 7272656E7420506172-
 12216 00005775 746974696F6E205461-
 12216 0000577E 626C650D0A00       
 12217                                  
 12218                                  enter_option_number_msg:
 12219 00005784 0D0A                    	db	0Dh, 0Ah
 12220 00005786 456E74657220746865-     	db	"Enter the option number or press ESC to exit ...", 0Dh, 0Ah
 12220 0000578F 206F7074696F6E206E-
 12220 00005798 756D626572206F7220-
 12220 000057A1 707265737320455343-
 12220 000057AA 20746F206578697420-
 12220 000057B3 2E2E2E0D0A         
 12221                                  	;db	0Dh, 0Ah, 0
 12222 000057B8 00                      	db	0 
 12223                                  
 12224                                  msg_zero_partition_size:  ; 19/02/2019
 12225 000057B9 0D0A                    	db	0Dh, 0Ah
 12226 000057BB 506172746974696F6E-     	db	"Partition size input must not be ZERO !", 0Dh, 0Ah
 12226 000057C4 2073697A6520696E70-
 12226 000057CD 7574206D757374206E-
 12226 000057D6 6F74206265205A4552-
 12226 000057DF 4F20210D0A         
 12227 000057E4 285072657373204553-     	db	"(Press ESC to exit or press another key to retry..)", 0Dh, 0Ah
 12227 000057ED 4320746F2065786974-
 12227 000057F6 206F72207072657373-
 12227 000057FF 20616E6F7468657220-
 12227 00005808 6B657920746F207265-
 12227 00005811 7472792E2E290D0A   
 12228 00005819 00                      	db	0 
 12229                                  
 12230                                  msg_empty_pt:
 12231 0000581A 0D0A                    	db	0Dh, 0Ah
 12232 0000581C 456D70747920706172-     	db	"Empty partition table !", 0Dh, 0Ah
 12232 00005825 746974696F6E207461-
 12232 0000582E 626C6520210D0A     
 12233 00005835 28412076616C696420-     	db	"(A valid partition must be created at first..)", 0Dh, 0Ah
 12233 0000583E 706172746974696F6E-
 12233 00005847 206D75737420626520-
 12233 00005850 637265617465642061-
 12233 00005859 742066697273742E2E-
 12233 00005862 290D0A             
 12234 00005865 00                      	db	0
 12235                                  
 12236                                  msg_full_pt:
 12237 00005866 0D0A                    	db	0Dh, 0Ah
 12238 00005868 546865726520697320-     	db	"There is not a free partition table entry ", 0
 12238 00005871 6E6F74206120667265-
 12238 0000587A 652070617274697469-
 12238 00005883 6F6E207461626C6520-
 12238 0000588C 656E7472792000     
 12239                                  msg_to_create_new_p: 
 12240 00005893 746F20637265617465-     	db	"to create a new partition !", 0Dh, 0Ah
 12240 0000589C 2061206E6577207061-
 12240 000058A5 72746974696F6E2021-
 12240 000058AE 0D0A               
 12241 000058B0 00                      	db	0
 12242                                  msg_no_free_space:
 12243 000058B1 0D0A                    	db	0Dh, 0Ah
 12244 000058B3 546865726520697320-     	db	"There is not (enough) free space ", 0
 12244 000058BC 6E6F742028656E6F75-
 12244 000058C5 676829206672656520-
 12244 000058CE 73706163652000     
 12245                                  
 12246                                  msg_enter_pn_to_del:
 12247 000058D5 0D0A                    	db	0Dh, 0Ah
 12248 000058D7 456E74657220706172-     	db	"Enter partition number to delete: "
 12248 000058E0 746974696F6E206E75-
 12248 000058E9 6D62657220746F2064-
 12248 000058F2 656C6574653A20     
 12249                                  chr_del_pnum1:
 12250 000058F9 00                      	db	0
 12251 000058FA 0D0A00                  	db	0Dh, 0Ah, 0
 12252                                  
 12253                                  msg_delete_partition_q:
 12254 000058FD 0D0A                    	db 	0Dh, 0Ah
 12255 000058FF 5741524E494E472120-     	db 	"WARNING! All of data in the selected partition will be lost", 0Dh, 0Ah
 12255 00005908 416C6C206F66206461-
 12255 00005911 746120696E20746865-
 12255 0000591A 2073656C6563746564-
 12255 00005923 20706172746974696F-
 12255 0000592C 6E2077696C6C206265-
 12255 00005935 206C6F73740D0A     
 12256 0000593C 202020202020202020-     	db	"         after you write changed partition table to disk !!", 0Dh, 0Ah
 12256 00005945 616674657220796F75-
 12256 0000594E 207772697465206368-
 12256 00005957 616E67656420706172-
 12256 00005960 746974696F6E207461-
 12256 00005969 626C6520746F206469-
 12256 00005972 736B2021210D0A     
 12257 00005979 0D0A                    	db	0Dh, 0Ah
 12258 0000597B 446F20796F75207761-     	db	"Do you want to delete PARTITION "
 12258 00005984 6E7420746F2064656C-
 12258 0000598D 657465205041525449-
 12258 00005996 54494F4E20         
 12259                                  chr_del_pnum2:
 12260 0000599B 30                      	db	'0'
 12261 0000599C 203F2028592F4E2920-     	db	' ? (Y/N) ', 0
 12261 000059A5 00                 
 12262                                  
 12263                                  _msg_YES:
 12264 000059A6 20                      	db	 20h
 12265                                  msg_YES:
 12266 000059A7 5945532000              	db	'YES ', 0
 12267                                  _msg_NO:
 12268 000059AC 20                      	db	20h
 12269                                  msg_NO:
 12270 000059AD 4E4F2000                	db	'NO ', 0
 12271                                  
 12272                                  ; 11/02/2019
 12273                                  msg_write_masterboot_sector:
 12274 000059B1 0D0A                    	db	0Dh, 0Ah 
 12275 000059B3 577269746520437572-     	db	"Write Current Partition Table:"
 12275 000059BC 72656E742050617274-
 12275 000059C5 6974696F6E20546162-
 12275 000059CE 6C653A             
 12276 000059D1 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12277 000059D5 20312E205772697465-     	db	" 1. Write Partition Table only", 0Dh, 0Ah
 12277 000059DE 20506172746974696F-
 12277 000059E7 6E205461626C65206F-
 12277 000059F0 6E6C790D0A         
 12278 000059F5 20322E205772697465-     	db	" 2. Write Partition Table and Singlix Master Boot Code", 0Dh, 0Ah
 12278 000059FE 20506172746974696F-
 12278 00005A07 6E205461626C652061-
 12278 00005A10 6E642053696E676C69-
 12278 00005A19 78204D617374657220-
 12278 00005A22 426F6F7420436F6465-
 12278 00005A2B 0D0A               
 12279                                  enter_opt_num_cancel_msg:
 12280 00005A2D 0D0A                    	db	0Dh, 0Ah
 12281 00005A2F 456E74657220746865-     	db	"Enter the option number or press ESC to cancel ...", 0
 12281 00005A38 206F7074696F6E206E-
 12281 00005A41 756D626572206F7220-
 12281 00005A4A 707265737320455343-
 12281 00005A53 20746F2063616E6365-
 12281 00005A5C 6C202E2E2E00       
 12282                                  
 12283                                  msg_writing_ptable:
 12284 00005A62 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12285 00005A66 57726974696E672070-     	db	"Writing partition table on disk ... ", 0
 12285 00005A6F 6172746974696F6E20-
 12285 00005A78 7461626C65206F6E20-
 12285 00005A81 6469736B202E2E2E20-
 12285 00005A8A 00                 
 12286                                  _msg_OK:
 12287                                  	;db	7
 12288 00005A8B 0D0A                    	db	0Dh, 0Ah
 12289 00005A8D 4F4B2021                	db	"OK !"
 12290 00005A91 0D0A00                  	db	0Dh, 0Ah, 0
 12291                                  
 12292                                  option_input:
 12293 00005A94 205B205D00              	db	' [ ]', 0
 12294                                  
 12295                                  msg_enter_pn_to_act:
 12296 00005A99 0D0A                    	db	0Dh, 0Ah
 12297 00005A9B 456E74657220706172-     	db	"Enter partition number to set as active: ", 0
 12297 00005AA4 746974696F6E206E75-
 12297 00005AAD 6D62657220746F2073-
 12297 00005AB6 657420617320616374-
 12297 00005ABF 6976653A2000       
 12298                                  
 12299                                  ; 04/05/2024
 12300                                  ;trdos386_disk_chs_header:
 12301                                  ;	db	0Dh, 0Ah
 12302                                  ;	db	"                     TRDOS 386 (SINGLIX) HARD DISK IMAGE                        "
 12303                                  ;	db 	0
 12304                                  
 12305                                  ;disk_chs_header:
 12306                                  ;	db	0Dh, 0Ah
 12307                                  ;	db	"                                HARD DISK IMAGE                                 "
 12308                                  ;	db 	0
 12309                                  
 12310                                  msg_partition_size_limit:
 12311 00005AC5 0D0A                    	db	0Dh, 0Ah
 12312 00005AC7 506172746974696F6E-     	db	"Partition size overs available free space !"
 12312 00005AD0 2073697A65206F7665-
 12312 00005AD9 727320617661696C61-
 12312 00005AE2 626C65206672656520-
 12312 00005AEB 73706163652021     
 12313 00005AF2 0D0A                    	db	0Dh, 0Ah
 12314 00005AF4 4D61782E2061766169-     	db 	"Max. available free space is ", 0
 12314 00005AFD 6C61626C6520667265-
 12314 00005B06 652073706163652069-
 12314 00005B0F 732000             
 12315                                  
 12316                                  msg_partition_size_limit_r:
 12317 00005B12 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12318 00005B16 28507265737320454E-     	db	"(Press ENTER to use all of available space or press ESC key to retry..) "
 12318 00005B1F 54455220746F207573-
 12318 00005B28 6520616C6C206F6620-
 12318 00005B31 617661696C61626C65-
 12318 00005B3A 207370616365206F72-
 12318 00005B43 207072657373204553-
 12318 00005B4C 43206B657920746F20-
 12318 00005B55 72657472792E2E2920 
 12319 00005B5E 000A00                  	db	0D, 0Ah, 0
 12320                                  
 12321                                  msg_cylinders:
 12322 00005B61 2063796C696E646572-     	db	" cylinders", 0
 12322 00005B6A 7300               
 12323                                  msg_sectors:
 12324 00005B6C 20736563746F727300      	db	" sectors", 0
 12325                                  
 12326                                  ; 02/03/2019
 12327                                  msg_megabytes:
 12328 00005B75 206D65676162797465      	db	" megabyte"
 12329                                  msg_megabytes_s:
 12330 00005B7E 0000                    	db	0, 0
 12331                                  
 12332                                  msg_inv_pte:
 12333 00005B80 0D0A                    	db	0Dh, 0Ah
 12334 00005B82 496E76616C69642070-     	db	"Invalid partition table entry ! (P"
 12334 00005B8B 6172746974696F6E20-
 12334 00005B94 7461626C6520656E74-
 12334 00005B9D 72792021202850     
 12335 00005BA4 3F290D0A                inv_pte_num: db	"?)", 0Dh, 0Ah
 12336 00005BA8 28507265737320454E-     	db	"(Press ENTER to DELETE or press ESC to EXIT..)"
 12336 00005BB1 54455220746F204445-
 12336 00005BBA 4C455445206F722070-
 12336 00005BC3 726573732045534320-
 12336 00005BCC 746F20455849542E2E-
 12336 00005BD5 29                 
 12337 00005BD6 0D0A00                  	db	0Dh, 0Ah, 0
 12338                                  
 12339                                  msg_ext_partition_exists:
 12340 00005BD9 457874656E64656420-     	db	"Extended partition already exists !"
 12340 00005BE2 706172746974696F6E-
 12340 00005BEB 20616C726561647920-
 12340 00005BF4 6578697374732021   
 12341 00005BFC 0D0A00                  	db	0Dh, 0Ah, 0
 12342                                  
 12343                                  msg_defective_pt:
 12344 00005BFF 0D0A                    	db	0Dh, 0Ah
 12345 00005C01 446566656374697665-     	db	"Defective partition table !", 0
 12345 00005C0A 20706172746974696F-
 12345 00005C13 6E207461626C652021-
 12345 00005C1C 00                 
 12346                                  
 12347                                  ; 27/02/2019
 12348                                  msg_ext_part_del_error:
 12349 00005C1D 0D0A                    	db	0Dh, 0Ah
 12350 00005C1F 457874656E64656420-     	db	"Extended partition must be deleted after logical drive(s) !"
 12350 00005C28 706172746974696F6E-
 12350 00005C31 206D75737420626520-
 12350 00005C3A 64656C657465642061-
 12350 00005C43 66746572206C6F6769-
 12350 00005C4C 63616C206472697665-
 12350 00005C55 2873292021         
 12351 00005C5A 0D0A00                  	db	0Dh, 0Ah, 0
 12352                                  
 12353                                  msg_cancel_continue:
 12354 00005C5D 285072657373204553-     	db	"(Press ESC to cancel or press another key to continue..)"
 12354 00005C66 4320746F2063616E63-
 12354 00005C6F 656C206F7220707265-
 12354 00005C78 737320616E6F746865-
 12354 00005C81 72206B657920746F20-
 12354 00005C8A 636F6E74696E75652E-
 12354 00005C93 2E29               
 12355 00005C95 0D0A00                  	db	0Dh, 0Ah, 0
 12356                                  
 12357                                  msg_delete_ldd:
 12358 00005C98 0D0A                    	db	0Dh, 0Ah
 12359 00005C9A 0D0A                    	db	0Dh, 0Ah
 12360 00005C9C 44656C657465204C6F-     	db	"Delete Logical (DOS) Drive:"
 12360 00005CA5 676963616C2028444F-
 12360 00005CAE 53292044726976653A 
 12361 00005CB7 0D0A                    	db	0Dh, 0Ah
 12362 00005CB9 50726573732044454C-     	db	"Press DELETE key to delete logical disk partition "
 12362 00005CC2 455445206B65792074-
 12362 00005CCB 6F2064656C65746520-
 12362 00005CD4 6C6F676963616C2064-
 12362 00005CDD 69736B207061727469-
 12362 00005CE6 74696F6E20         
 12363 00005CEB 3F2E                    lddp_num: db	"?."
 12364 00005CED 0D0A00                  	db	0Dh, 0Ah, 0
 12365                                  
 12366                                  msg_delete_ext_part:
 12367 00005CF0 0D0A                    	db	0Dh, 0Ah
 12368 00005CF2 0D0A                    	db	0Dh, 0Ah
 12369 00005CF4 44656C657465204578-     	db	"Delete Extended (DOS) Partition:"
 12369 00005CFD 74656E646564202844-
 12369 00005D06 4F5329205061727469-
 12369 00005D0F 74696F6E3A         
 12370 00005D14 0D0A                    	db	0Dh, 0Ah
 12371 00005D16 507265737320454E54-     	db	"Press ENTER to delete or press ESC to cancel.."
 12371 00005D1F 455220746F2064656C-
 12371 00005D28 657465206F72207072-
 12371 00005D31 657373204553432074-
 12371 00005D3A 6F2063616E63656C2E-
 12371 00005D43 2E                 
 12372 00005D44 0D0A00                  	db	0Dh, 0Ah, 0
 12373                                  
 12374                                  str_display_ebr_pt:
 12375 00005D47 285072657373205350-     	db	"(Press SPACE to edit EXTENDED Partition Table)", 0Dh, 0Ah, 0
 12375 00005D50 41434520746F206564-
 12375 00005D59 697420455854454E44-
 12375 00005D62 454420506172746974-
 12375 00005D6B 696F6E205461626C65-
 12375 00005D74 290D0A00           
 12376                                  
 12377                                  ebr_editing_options:
 12378 00005D78 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah 
 12379 00005D7C 457874656E64656420-     	db	"Extended Partition Table Editing Options:" 
 12379 00005D85 506172746974696F6E-
 12379 00005D8E 205461626C65204564-
 12379 00005D97 6974696E67204F7074-
 12379 00005DA0 696F6E733A         
 12380 00005DA5 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
 12381 00005DA9 20202020202020312E-     	db	"       1. Create Logical DOS Drive", 0Dh, 0Ah
 12381 00005DB2 20437265617465204C-
 12381 00005DBB 6F676963616C20444F-
 12381 00005DC4 532044726976650D0A 
 12382 00005DCD 20202020202020322E-     	db	"       2. Delete Logical (DOS) Drive(s)",0Dh, 0Ah, 0
 12382 00005DD6 2044656C657465204C-
 12382 00005DDF 6F676963616C202844-
 12382 00005DE8 4F5329204472697665-
 12382 00005DF1 2873290D0A00       
 12383                                  
 12384                                  msg_delete_ldd_q:
 12385 00005DF7 0D0A                    	db 	0Dh, 0Ah
 12386 00005DF9 5741524E494E47210D-     	db 	"WARNING!", 0Dh, 0Ah 
 12386 00005E02 0A                 
 12387 00005E03 416C6C206F66206461-     	db	"All of data in logical (DOS) drive(s) will be lost !!", 0Dh, 0Ah
 12387 00005E0C 746120696E206C6F67-
 12387 00005E15 6963616C2028444F53-
 12387 00005E1E 292064726976652873-
 12387 00005E27 292077696C6C206265-
 12387 00005E30 206C6F73742021210D-
 12387 00005E39 0A                 
 12388 00005E3A 0D0A                    	db	0Dh, 0Ah
 12389 00005E3C 446F20796F75207761-     	db	"Do you want to continue ? (Y/N) ", 0
 12389 00005E45 6E7420746F20636F6E-
 12389 00005E4E 74696E7565203F2028-
 12389 00005E57 592F4E292000       
 12390                                  
 12391                                  msg_create_ldd_max_error:
 12392 00005E5D 0D0A                    	db	0Dh, 0Ah
 12393 00005E5F 50726F6772616D206C-     	db	"Program limit for logical dos drive count is 4 !"
 12393 00005E68 696D697420666F7220-
 12393 00005E71 6C6F676963616C2064-
 12393 00005E7A 6F7320647269766520-
 12393 00005E83 636F756E7420697320-
 12393 00005E8C 342021             
 12394 00005E8F 0D0A00                  	db 	0Dh, 0Ah, 0
 12395                                  
 12396                                  msg_c_ldd_unused_warning:
 12397 00005E92 0D0A                    	db	0Dh, 0Ah
 12398 00005E94 546865726520697320-     	db	"There is unused extended partition space after logical dos drive "
 12398 00005E9D 756E75736564206578-
 12398 00005EA6 74656E646564207061-
 12398 00005EAF 72746974696F6E2073-
 12398 00005EB8 706163652061667465-
 12398 00005EC1 72206C6F676963616C-
 12398 00005ECA 20646F732064726976-
 12398 00005ED3 6520               
 12399                                  char_lddn:
 12400 00005ED5 342021                  	db	"4 !"
 12401 00005ED8 0D0A                    	db 	0Dh, 0Ah
 12402 00005EDA 285072657373204553-     	db	"(Press ESC to add unused space or press ENTER to continue.)"	 
 12402 00005EE3 4320746F2061646420-
 12402 00005EEC 756E75736564207370-
 12402 00005EF5 616365206F72207072-
 12402 00005EFE 65737320454E544552-
 12402 00005F07 20746F20636F6E7469-
 12402 00005F10 6E75652E29         
 12403 00005F15 0D0A00                  	db 	0Dh, 0Ah, 0
 12404                                  
 12405                                  msg_create_ldd_s:
 12406 00005F18 53656C65637420616E-     	db	"Select an option to set logical dos drive size: "
 12406 00005F21 206F7074696F6E2074-
 12406 00005F2A 6F20736574206C6F67-
 12406 00005F33 6963616C20646F7320-
 12406 00005F3C 64726976652073697A-
 12406 00005F45 653A20             
 12407 00005F48 0D0A                    	db	0Dh, 0Ah
 12408 00005F4A 0D0A                    	db	0Dh, 0Ah
 12409 00005F4C 202043292043796C69-     	db	"  C) Cylinder count", 0Dh, 0Ah
 12409 00005F55 6E64657220636F756E-
 12409 00005F5E 740D0A             
 12410 00005F61 2020252920566F6C75-     	db	"  %) Volume percentage (##%)", 0Dh, 0Ah
 12410 00005F6A 6D652070657263656E-
 12410 00005F73 746167652028232325-
 12410 00005F7C 290D0A             
 12411 00005F7F 20204D29204D656761-     	db	"  M) Mega bytes (MB, 2*1024*M sectors)", 0Dh, 0Ah
 12411 00005F88 20627974657320284D-
 12411 00005F91 422C20322A31303234-
 12411 00005F9A 2A4D20736563746F72-
 12411 00005FA3 73290D0A           
 12412 00005FA7 202047292047696761-     	db	"  G) Giga bytes (GB, 2*1024*1024*G sectors)", 0Dh, 0Ah
 12412 00005FB0 206279746573202847-
 12412 00005FB9 422C20322A31303234-
 12412 00005FC2 2A313032342A472073-
 12412 00005FCB 6563746F7273290D0A 
 12413 00005FD4 0D0A                    	db	0Dh, 0Ah	
 12414 00005FD6 507265737320535041-     	db	"Press SPACE to use entire space or press ENTER to set Megabytes .. ", 0
 12414 00005FDF 434520746F20757365-
 12414 00005FE8 20656E746972652073-
 12414 00005FF1 70616365206F722070-
 12414 00005FFA 7265737320454E5445-
 12414 00006003 5220746F2073657420-
 12414 0000600C 4D6567616279746573-
 12414 00006015 202E2E2000         
 12415                                  
 12416                                  msg_c_part_error:
 12417 0000601A 0D0A                    	db 	0Dh, 0Ah
 12418                                  	;db	"No free space for a new primary partition", 0Dh, 0Ah, 0
 12419                                  	; 21/03/2021
 12420 0000601C 4E6F20667265652073-     	db	"No free space for a new primary partition !", 0Dh, 0Ah, 0
 12420 00006025 7061636520666F7220-
 12420 0000602E 61206E657720707269-
 12420 00006037 6D6172792070617274-
 12420 00006040 6974696F6E20210D0A-
 12420 00006049 00                 
 12421                                  
 12422                                  ; 21/03/2021
 12423                                  ;msg_c_ldd_error: 
 12424                                  ;	db	"and logical dos drives over program limit (4) !", 0Dh, 0Ah, 0
 12425                                  
 12426                                  msg_c_ldd_q:
 12427 0000604A 0D0A                    	db	0Dh, 0Ah
 12428 0000604C 446F20796F75207761-     	db	"Do you want to create logical dos drive in extended dos partition "
 12428 00006055 6E7420746F20637265-
 12428 0000605E 617465206C6F676963-
 12428 00006067 616C20646F73206472-
 12428 00006070 69766520696E206578-
 12428 00006079 74656E64656420646F-
 12428 00006082 732070617274697469-
 12428 0000608B 6F6E20             
 12429 0000608E 3F2028592F4E2900        	db	'? (Y/N)', 0
 12430                                  
 12431                                  msg_c_ldd_nofspc_error:
 12432 00006096 0D0A                    	db 	0Dh, 0Ah
 12433 00006098 4E6F20667265652073-     	db	"No free space for a new logical dos drive !", 0Dh, 0Ah, 0
 12433 000060A1 7061636520666F7220-
 12433 000060AA 61206E6577206C6F67-
 12433 000060B3 6963616C20646F7320-
 12433 000060BC 647269766520210D0A-
 12433 000060C5 00                 
 12434                                  
 12435                                  	; 12/10/2020
 12436                                  msg_drv_not_ready:
 12437 000060C6 0D0A                    	db	0Dh, 0Ah
 12438 000060C8 4469736B2064726976-     	db	"Disk drive not ready or read error ! "
 12438 000060D1 65206E6F7420726561-
 12438 000060DA 6479206F7220726561-
 12438 000060E3 64206572726F722021-
 12438 000060EC 20                 
 12439 000060ED 0D0A00                  	db	0Dh, 0Ah, 0
 12440                                  
 12441                                  msg_not_any_disks:
 12442 000060F0 0D0A                    	db	0Dh, 0Ah
 12443 000060F2 546865726520697320-     	db	"There is not a hard disk (ready) ! "
 12443 000060FB 6E6F74206120686172-
 12443 00006104 64206469736B202872-
 12443 0000610D 6561647929202120   
 12444 00006115 0D0A00                  	db	0Dh, 0Ah, 0
 12445                                  
 12446                                  align 4
 12447                                  
 12448                                  msg_sectors_crlf:
 12449 00006118 20736563746F72          	db	" sector"
 12450                                  msg_sectors_crlf_s:
 12451 0000611F 73                      	db	"s"
 12452 00006120 0D0A00                  	db	0Dh, 0Ah, 0
 12453                                  
 12454                                  vname_length:
 12455 00006123 00                      	db	0 ; 05/01/2018
 12456                                  
 12457                                  bs_oem_name:
 12458                                  	;db	'TRDOS2.0', 0
 12459                                  	; 04/05/2024
 12460 00006124 524554524F444F5300      	db	'RETRODOS', 0
 12461 0000612D 90                      align 2
 12462                                  
 12463                                  no_name:
 12464 0000612E 4E4F204E414D452020-     	db 	'NO NAME    ', 0
 12464 00006137 202000             
 12465                                  
 12466                                  align 2
 12467                                  
 12468                                  FDFORMAT_SECBUFFER:
 12469                                  HDFORMAT_SECBUFFER:
 12470 0000613A F6<rep 200h>            	times	512 db 0F6h
 12471                                  HDFORMAT_FSINFO_BUFF:
 12472 0000633A 52526141                	dd	41615252h  ; FSI_LeadSig
 12473 0000633E 00<rep 1E0h>            	times	480 db 0   ; FSI_Reserved1
 12474 0000651E 72724161                	dd	61417272h  ; FSI_StrucSig
 12475 00006522 FFFFFFFF                	dd	0FFFFFFFFh ; FSI_Free_Count
 12476 00006526 02000000                	dd	000000002h ; FSI_Nxt_Free
 12477 0000652A 00<rep Ch>              	times	12 db 0	   ; FSI_Reserved2
 12478 00006536 000055AA                	dd	0AA550000h ; FSI_TrailSig
 12479                                  
 12480                                  ; 29/10/2020
 12481                                  msg_100:
 12482 0000653A 31303000                	db	'100', 0
 12483                                  
 12484                                  SizeOfFile equ $-100
 12485                                  
 12486                                  ; 03/02/2019
 12487                                  
 12488                                  ;=============================================================================
 12489                                  ;        	uninitialized data
 12490                                  ;=============================================================================
 12491                                  
 12492                                  bss_start:
 12493                                  
 12494                                  ABSOLUTE bss_start
 12495                                  
 12496                                  ; 12/10/2020
 12497 0000653E ??                      DrvNum:	resb 1
 12498 0000653F ??                      hdc:	resb 1
 12499                                  ;hs:	resw 1 ; (bios/dos virtual) head*sectors ; 16/10/2020
 12500 00006540 ??                      rw:	resb 1 
 12501 00006541 ??                      rcnt:	resb 1 ; 18/10/2020
 12502                                  total_sectors:
 12503 00006542 ????????                disksize: resd 1
 12504 00006546 ????????                chs_limit: resd 1
 12505                                  
 12506                                  ; 16/10/2020
 12507                                  ;lba_cyls: resd 1  ; cylinder count calculated from LBA sectors
 12508 0000654A ????                    lba_chs_remain: resw 1	 ; remain sectors after the last cylinder
 12509                                  
 12510                                  alignb 2
 12511 0000654C ????                    old_sp:	resw 1
 12512                                  
 12513                                  HDFORMAT_FATBUFFER:
 12514                                  HDFORMAT_EMPTY_BUFF:
 12515 0000654E <res 200h>              	resb 512
 12516                                  
 12517 0000674E ????????                data_start: resd 1
 12518 00006752 ????????                data_sectors: resd 1
 12519 00006756 ????????                cluster_count: resd 1
 12520 0000675A ????                    root_dir_secs: resw 1
 12521                                  format_percent: ;resw 1
 12522 0000675C ????????                		resd 1 ; 16/03/2021
 12523 00006760 ??                      prev_percent:	resb 1
 12524 00006761 ??                      rsvdbyte:	resb 1
 12525                                  
 12526 00006762 ????                    alignb 4
 12527                                  
 12528                                  ; 05/01/2018
 12529 00006764 <res 40h>               fs_volume_name: resb 64
 12530 000067A4 ????????                fs_volume_serial: resd 1
 12531 000067A8 ????                    DAT_FFBit:	resw 1
 12532 000067AA ????                    DAT_FFSector:	resw 1
 12533                                  		;resw 1
 12534 000067AC ????                    DAT_LFBit:	resw 1
 12535 000067AE ????                    DAT_LFSector:	resw 1
 12536                                  		;resw 1
 12537                                  
 12538                                  ;alignb 4
 12539                                  
 12540                                  FS_MAT_Buffer: ; TRFS1 Master Allocation Table (05/01/2018)
 12541 000067B0 ??????                  MAT_Sign:		resb    3	; Offset 0  ; 'MAT'
 12542 000067B3 ??                      MAT_Version:		resb 	1	; 	 3  ; 0	
 12543 000067B4 ????????                MAT_VolumeSize:		resd	1	;	 4  ; FS1 Volume Size
 12544 000067B8 ????????                MAT_BeginSector:	resd	1	;	 8  ; FS1 Start Sector
 12545 000067BC ????????                DAT_Address:		resd	1	;	12  ; Offset (=2)
 12546 000067C0 ????????                DAT_SectorCount:	resd	1	;	16  
 12547 000067C4 ????????                MAT_FreeSectors:	resd 	1	; 	20
 12548 000067C8 ????????                MAT_FirstFreeSector:	resd	1	;	24
 12549                                  ;MAT_OS_Reserved:
 12550                                  ;	 		resb	9
 12551                                  ;MAT_Unused:
 12552                                  ;			resb	112
 12553                                  FS_DAT_Buffer: ; TRFS1 Disk Allocation Table (05/01/2018)
 12554                                  FS_RDT_Buffer: ; TRFS1 Root Directory Description Table (05/01/2018)
 12555 000067CC <res 200h>              			resb	512
 12556                                  ;alignb 4
 12557                                  
 12558                                  ; (TR-DOS 386 compatible) Hard Disk (image) parameters
 12559                                  
 12560                                  ;total_sectors: resd 1
 12561 000069CC ????????                pType:	       resb 4
 12562 000069D0 ????????                file_size:     resd 1
 12563 000069D4 ????????                pp_StartSector: resd 1
 12564 000069D8 ????????                pp_Sectors:	resd 1
 12565 000069DC ??                      wholedisk:	resb 1
 12566 000069DD ??                      pp_type: resb 1 ; Primary partition type (for this program)
 12567 000069DE ??                      pp_type_user: resb 1
 12568 000069DF ??                      chs_focus: resb 1
 12569 000069E0 ????????                pSize_temp: resd 1
 12570 000069E4 ????????                pSize_multiplier: resd 1
 12571 000069E8 ??                      pSize_maxdigits: resb 1
 12572 000069E9 ??                      pSize_digitpos: resb 1
 12573                                  msg_psize_unit:
 12574 000069EA ????                    pSize_unit:	resw 1
 12575 000069EC ??                      		resb 1
 12576                                  ; 06/11/2020
 12577                                  ;reserved_bytes: resb 3 ; for 11 bytes of numbers
 12578                                  msg_partition_sectors:
 12579                                  		;resb 8
 12580 000069ED <res Bh>                		resb 11 ; 06/11/2020
 12581 000069F8 ??                      		resb 1
 12582 000069F9 ??                      format_q:	resb 1 ; 03/02/2018
 12583                                  
 12584                                  ;alignb 2
 12585 000069FA ??                      pType_pos:	resb 1
 12586 000069FB ??                      pType_num:	resb 1
 12587 000069FC ??                      		resb 1
 12588                                  ;cylinder_boundary:
 12589 000069FD ??                      		resb 1
 12590                                  ; 05/11/2020
 12591                                  
 12592                                  alignb 2
 12593                                  
 12594 000069FE ??                      GetChar:	resb 1 ; 11/02/2019
 12595 000069FF ??                      		resb 1 ; 06/11/2020
 12596                                  
 12597                                  hs: ; 17/10/2020 ; (bios/dos virtual) head*sectors
 12598 00006A00 ????                    min_sectors:	resw 1 ; 08/02/2019
 12599 00006A02 ????                    		resw 1 ; 06/11/2020
 12600 00006A04 ????                    pp_StartCylinder: resw 1
 12601 00006A06 ????                    		resw 1 ; 06/11/2020
 12602 00006A08 ????                    pp_EndCylinder:	resw 1
 12603 00006A0A ????                    		resw 1 ; 06/11/2020
 12604                                  
 12605 00006A0C ????????                ppn_Sectors:	resd 1 ; 09/02/2019
 12606                                  
 12607 00006A10 ????                    input_col:	resw 1
 12608 00006A12 ??                      No:		resb 1
 12609 00006A13 ??                      Yes:		resb 1
 12610                                  
 12611                                  ; 26/02/2019
 12612 00006A14 ??                      ldrives:	resb 1
 12613                                  
 12614                                  ;sort_1:	resb 1
 12615 00006A15 ??                      		resb 1 ; 23/10/2020
 12616 00006A16 ????????                sort:		resb 4
 12617                                  
 12618                                  ;max_sector:	resb 8
 12619                                  ebr_buffer:		; 26/02/2019
 12620 00006A1A <res 200h>              boot_record:	resb 512
 12621                                  
 12622 00006C1A ??                      valid_input:	resb 1
 12623 00006C1B ??                      		resb 1
 12624                                  
 12625                                  ; 26/02/2019
 12626 00006C1C ????????                ep_StartSector:	resd 1
 12627 00006C20 ????????                ep_EndSector:	resd 1
 12628 00006C24 ????????                ep_Size:	resd 1
 12629                                  
 12630                                  ; 10/02/2019
 12631 00006C28 ????????                valid_ppnums:	resb 4
 12632                                  
 12633 00006C2C ????                    _i_:	resw 1
 12634                                  
 12635                                  freespace_count: ; resw 1 
 12636 00006C2E ??                      		resb 1 ; 12/03/2021
 12637                                  
 12638 00006C2F ??                      last_found_partition: resb 1
 12639 00006C30 ??                      p_type: resb 1
 12640                                  
 12641                                  ; 30/10/2020
 12642                                  ;p_sorted:
 12643                                  ;	resb 1
 12644                                  ;ep_sorted:
 12645                                  ;	resb 1
 12646                                  
 12647 00006C31 ??                      _e_:	resb 1
 12648                                  
 12649                                  act_part_num:
 12650                                  cre_part_num:
 12651 00006C32 ??                      del_part_num: resb 1 ; 10/02/2019
 12652                                  
 12653 00006C33 ??                      alignb 2
 12654                                  
 12655 00006C34 <res 50h>               pte_row: resb 80
 12656                                  
 12657 00006C84 ??                      _zero_:	resb 1
 12658                                  
 12659                                  ;alignb 2
 12660                                  
 12661 00006C85 ??                      	resb 1
 12662                                  
 12663                                  bss_clear_end: ; 15/02/2019
 12664                                  
 12665                                  ; 05/11/2020
 12666                                  
 12667                                  ; PARTITION DATA STRUCTURE
 12668                                  ; 4 partitions
 12669                                  ; 22 byte partition data structure per partition
 12670                                  ; 88 bytes (4*22)
 12671                                  
 12672 00006C86 ??                      part_table_boot_ind:	 resb 1
 12673 00006C87 ??                      part_table_start_head:	 resb 1
 12674 00006C88 ??                      part_table_start_sector: resb 1
 12675                                  ;part_table_start_cyl:	 resw 1
 12676 00006C89 ????????                part_table_start_cyl:	 resd 1
 12677 00006C8D ??                      part_table_sys_id:	 resb 1
 12678 00006C8E ??                      part_table_end_head:	 resb 1
 12679 00006C8F ??                      part_table_end_sector:	 resb 1
 12680                                  ;part_table_end_cyl:	 resw 1
 12681 00006C90 ????????                part_table_end_cyl:	 resd 1
 12682                                  ;part_table_rel_sec_lw:	 resw 1
 12683                                  ;part_table_rel_sec_hw:	 resw 1
 12684 00006C94 ????????                part_table_rel_sec:	 resd 1
 12685                                  ;part_table_num_sec_lw:	 resw 1
 12686                                  ;part_table_num_sec_hw:	 resw 1
 12687 00006C98 ????????                part_table_num_sec:	 resd 1
 12688                                  
 12689 00006C9C <res 42h>               			resb 66 ; 3*22 bytes
 12690                                  
 12691 00006CDE ??                      pcount:		resb 1
 12692 00006CDF ??                      ppcount:	resb 1
 12693 00006CE0 ??                      apcount:	resb 1
 12694 00006CE1 ??                      epnumber:	resb 1
 12695                                  
 12696                                  ; 05/11/2020
 12697                                  
 12698                                  ; LOGICAL PARTITION DATA STRUCTURE
 12699                                  ; (for logical partitions in extended partition)
 12700                                  
 12701                                  ; 1 extended partition
 12702                                  ; 4 logical drives (22 bytes)
 12703                                  ; 88 bytes (4*22)
 12704                                  
 12705 00006CE2 ??                      ext_table_boot_ind:	resb 1
 12706 00006CE3 ??                      ext_table_start_head:	resb 1
 12707 00006CE4 ??                      ext_table_start_sector: resb 1
 12708                                  ;ext_table_start_cyl:	resw 1
 12709 00006CE5 ????????                ext_table_start_cyl:	resd 1
 12710 00006CE9 ??                      ext_table_sys_id:	resb 1
 12711 00006CEA ??                      ext_table_end_head:	resb 1
 12712 00006CEB ??                      ext_table_end_sector:	resb 1
 12713                                  ;ext_table_end_cyl:	resw 1
 12714 00006CEC ????????                ext_table_end_cyl:	resd 1
 12715                                  ;ext_table_rel_sec_lw:	resw 1
 12716                                  ;ext_table_rel_sec_hw:	resw 1
 12717 00006CF0 ????????                ext_table_rel_sec:	resd 1
 12718                                  ;ext_table_num_sec_lw:	resw 1
 12719                                  ;ext_table_num_sec_hw:	resw 1
 12720 00006CF4 ????????                ext_table_num_sec:	resd 1
 12721                                  
 12722 00006CF8 <res 42h>               			resb 66 ; 3*22 bytes
 12723                                  ; 05/11/2020
 12724                                  
 12725                                  fspc:		; 5*11 words (for free space calculations)
 12726                                  
 12727                                  ; Space 1 - unused cylinders before partition 0
 12728                                  ; Space 2 - unused cylinders between partition 0 & 1
 12729                                  ; Space 3 - unused cylinders between partition 1 & 2
 12730                                  ; Space 4 - unused cylinders between partition 2 & 3
 12731                                  ; Space 5 - unused cylinders after partition 3
 12732                                  
 12733 00006D3A ????????                free_space.space:   	   resd 1
 12734 00006D3E ????????                free_space.start:   	   resd 1
 12735 00006D42 ????????                free_space.end:	   	   resd 1
 12736 00006D46 ????????                free_space.sectors_unused: resd 1
 12737 00006D4A ????????                free_space.startsector:   resd 1 ; 13/02/2019
 12738 00006D4E ????                    free_space.percent_unused: resw 1
 12739                                  
 12740 00006D50 <res 58h>               		resw   4*11 ; 4*22 bytes ; 05/11/2020
 12741                                  
 12742                                  ; 05/11/2020
 12743                                  ;c_cylinder:	resd 1
 12744                                  ; 18/02/2019
 12745                                  ;c_cylinder:	resw 1
 12746 00006DA8 ????                    c_fspc_offset:	resw 1
 12747 00006DAA ??                      cylinder_boundary: resb 1
 12748                                  ;c_gap:		resb 1
 12749 00006DAB ??                      		resb 1
 12750                                  
 12751                                  ; 27/02/2019
 12752 00006DAC <res 10h>               ldd_start:	resd 4
 12753                                  ; 03/03/2019
 12754 00006DBC <res 10h>               ldd_size:	resd 4
 12755                                  ; 30/10/2020
 12756 00006DCC ????????                ep_free_sectors: resd 1
 12757                                  
 12758                                  ; 05/11/2020
 12759 00006DD0 ????????                lcylinders:	resd 1
 12760                                  ; 25/02/2019
 12761 00006DD4 ????                    pte_address:	resw 1
 12762                                  ; 02/03/2019
 12763                                  ;lcylinders:	resw 1
 12764                                  ; 01/11/2020
 12765 00006DD6 ????                    endcyl:		resw 1
 12766 00006DD8 ????                    		resw 1 ; 13/03/2021
 12767                                  
 12768                                  ;bss_clear_end: ; 18/02/2019
 12769                                  
 12770                                  ; 11/10/2020
 12771                                  ;gdp_buffer:	resb 30 ; buffer for int 13h, ah = 48h
 12772 00006DDA <res 1Ah>               gdp_buffer:	resb 26 ; buffer for int 13h, ah = 48h
 12773                                  
 12774                                  bss_end:
