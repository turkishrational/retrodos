     1                                  ; ****************************************************************************
     2                                  ; COMMAND.COM (PCDOS 7.1 Command Interpreter) - RETRO DOS v5.0 by ERDOGAN TAN
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 13/03/2025 (Previous: 15/08/2024)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 18/07/2024 (v7.1) - ((Previous: 19/06/2023 COMMAND.COM v6.22))
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ; ----------------------------------------------------------------------------
    10                                  ;	    ((nasm command7.s -l command7.txt -o COMMAND.COM)) 	
    11                                  ; ****************************************************************************
    12                                  ; Modified from 'command6.s' 
    13                                  ;		(Retro DOS 4.2 - MSDOS 6.22 COMMAND.COM) source code
    14                                  ; 		in NASM syntax (by Erdogan Tan), 19/06/2023
    15                                  ; ----------------------------------------------------------------------------
    16                                  ; Labels and comments etc. are based on MSDOS 6.0 COMMAND.COM source code.
    17                                  ; However, this source code is mainly developed from the source code of
    18                                  ; Retro DOS v4.2 COMMAND.COM and PCDOS 7.1 COMMAND.COM disassembly.
    19                                  ; ----------------------------------------------------------------------------
    20                                  ; MSDOS 6.0 source files:
    21                                  ;;============================================================================
    22                                  ;; This PCDOS source code is verified & modified by using IDA Pro Disassembler
    23                                  ;;============================================================================
    24                                  ;
    25                                  ; COMMAND.COM v6.0 source files:
    26                                  ;      command1.asm, command2.asm, rucode.asm, stub.asm, rdata.asm, init.asm,
    27                                  ;      iparse.asm, uinit.asm, tcode.asm, tbatch.asm, tbatch2.asm, tfor.asm,
    28                                  ;      dir.asm, cratio.asm, tcmd1b.asm, tcmd2a.asm, tcmd2b.asm, tenv.asm,
    29                                  ;      tenv2.asm, tmisc1.asm, tmisc2.asm, tpipe.asm, parse2.asm, path1.asm,
    30                                  ;      path2.asm, tucode.asm, copy.asm, copypr1.asm, copypr2.asm, cparse.asm,
    31                                  ;      tparse.asm, tprintf.asm, loadhi.asm, tdata.asm, tspc.asm
    32                                  ;
    33                                  ; COMMAND.COM v2.11 source files:
    34                                  ;      COMMAND.ASM (+ DOSYM.ASM,DEVSYM.ASM,COMSW.ASM,COMEQU.ASM,IFEQU.ASM)
    35                                  ;      RUCODE.ASM, RDATA.ASM, INIT.ASM, UINIT.ASM
    36                                  ;      TCODE.ASM, TCODE2.ASM, TCODE3.ASM, TCODE4.ASM, TCODE5.ASM,
    37                                  ;      TUCODE.ASM, COPY.ASM, COPYPROC.ASM, CPARSE.ASM, TDATA.ASM, TSPC.ASM
    38                                  ;
    39                                  ; ----------------------------------------------------------------------------
    40                                  ; 09/01/2023 - COMMAND.COM v5.0 (Multi Section Binary File Format)
    41                                  
    42                                  ;============================================================================
    43                                  ; MSDOS 6.22 COMMAND.COM, DISASSEMBLED by Erdogan Tan, 17/05/2023-05/06/2023
    44                                  ;============================================================================
    45                                  
    46                                  ; -=========================================================================¬
    47                                  ; ¦     This file is generated by The Interactive Disassembler (IDA)        ¦
    48                                  ; ¦     Copyright (c) 2010 by Hex-Rays SA, <support@hex-rays.com>           ¦
    49                                  ; ¦                      Licensed to: Freeware version                      ¦
    50                                  ; L=========================================================================-
    51                                  ;
    52                                  ; Input MD5   : FAF051453F215165981F10BD73071D88
    53                                  ;
    54                                  ; File Name   : C:\Users\Erdo­an\Desktop\COMMAND.COM
    55                                  ; Format      : MS-DOS COM-file
    56                                  ; Base Address: 0h Range: 100h-D675h Loaded length: D575h
    57                                  
    58                                  ;============================================================================
    59                                  ; SYSCALL.INC, MSDOS 6.0, 1991
    60                                  ;============================================================================
    61                                  ; 21/09/2018 - Retro DOS v3.0
    62                                  
    63                                  ;	SCCSID = @(#)syscall.asm	1.1 85/04/10
    64                                  ;BREAK <system call definitions>
    65                                  
    66                                  ;
    67                                  ;	Microsoft Confidential
    68                                  ;	Copyright (C) Microsoft Corporation 1991
    69                                  ;	All Rights Reserved.
    70                                  ;
    71                                  
    72                                  ;SUBTTL	system call definitions
    73                                  ;PAGE
    74                                  
    75                                  Abort				EQU 0	;  0	  0
    76                                  STD_CON_INPUT			EQU 1	;  1	  1
    77                                  Std_Con_Output			EQU 2	;  2	  2
    78                                  Std_Aux_Input			EQU 3	;  3	  3
    79                                  Std_Aux_Output			EQU 4	;  4	  4
    80                                  Std_Printer_Output		EQU 5	;  5	  5
    81                                  Raw_Con_IO			EQU 6	;  6	  6
    82                                  RAW_CON_INPUT			EQU 7	;  7	  7
    83                                  Std_Con_Input_No_Echo		EQU 8	;  8	  8
    84                                  STD_CON_STRING_OUTPUT		EQU 9	;  9	  9
    85                                  Std_Con_String_Input		EQU 10	; 10	  A
    86                                  Std_Con_Input_Status		EQU 11	; 11	  B
    87                                  STD_CON_INPUT_FLUSH		EQU 12	; 12	  C
    88                                  DISK_RESET			EQU 13	; 13	  D
    89                                  Set_Default_Drive		EQU 14	; 14	  E
    90                                  FCB_Open			EQU 15	; 15	  F
    91                                  FCB_Close			EQU 16	; 16	 10
    92                                  Dir_Search_First		EQU 17	; 17	 11
    93                                  Dir_Search_Next 		EQU 18	; 18	 12
    94                                  FCB_Delete			EQU 19	; 19	 13
    95                                  FCB_Seq_Read			EQU 20	; 20	 14
    96                                  FCB_Seq_Write			EQU 21	; 21	 15
    97                                  FCB_Create			EQU 22	; 22	 16
    98                                  FCB_Rename			EQU 23	; 23	 17
    99                                  GET_DEFAULT_DRIVE		EQU 25	; 25	 19
   100                                  Set_DMA 			EQU 26	; 26	 1A
   101                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   102                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   103                                  ;									   ;
   104                                  Get_Default_DPB 		EQU 31	; 31	 1F
   105                                  ;									   ;
   106                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   107                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   108                                  FCB_Random_Read 		EQU 33	; 33	 21
   109                                  FCB_Random_Write		EQU 34	; 34	 22
   110                                  Get_FCB_File_Length		EQU 35	; 35	 23
   111                                  Get_FCB_Position		EQU 36	; 36	 24
   112                                  SET_INTERRUPT_VECTOR		EQU 37	; 37	 25
   113                                  Create_Process_Data_Block	EQU 38	; 38	 26
   114                                  FCB_Random_Read_Block		EQU 39	; 39	 27
   115                                  FCB_Random_Write_Block		EQU 40	; 40	 28
   116                                  Parse_File_Descriptor		EQU 41	; 41	 29
   117                                  Get_Date			EQU 42	; 42	 2A
   118                                  Set_Date			EQU 43	; 43	 2B
   119                                  Get_Time			EQU 44	; 44	 2C
   120                                  Set_Time			EQU 45	; 45	 2D
   121                                  SET_VERIFY_ON_WRITE		EQU 46	; 46	 2E
   122                                  ; Extended functionality group
   123                                  Get_DMA 			EQU 47	; 47	 2F
   124                                  GET_VERSION			EQU 48	; 48	 30
   125                                  Keep_Process			EQU 49	; 49	 31
   126                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   127                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   128                                  ;									   ;
   129                                  Get_DPB 			EQU 50	; 50	 32
   130                                  ;									   ;
   131                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   132                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   133                                  Set_CTRL_C_Trapping		EQU 51	; 51	 33
   134                                  Get_InDOS_Flag			EQU 52	; 52	 34
   135                                  Get_Interrupt_Vector		EQU 53	; 53	 35
   136                                  Get_Drive_Freespace		EQU 54	; 54	 36
   137                                  CHAR_OPER			EQU 55	; 55	 37
   138                                  International			EQU 56	; 56	 38
   139                                  ;   Directory Group
   140                                  MKDir				EQU 57	; 57	 39
   141                                  RMDir				EQU 58	; 58	 3A
   142                                  CHDir				EQU 59	; 59	 3B
   143                                  ;   File Group
   144                                  Creat				EQU 60	; 60	 3C
   145                                  OPEN				EQU 61	; 61	 3D
   146                                  CLOSE				EQU 62	; 62	 3E
   147                                  READ				EQU 63	; 63	 3F
   148                                  Write				EQU 64	; 64	 40
   149                                  Unlink				EQU 65	; 65	 41
   150                                  LSEEK				EQU 66	; 66	 42
   151                                  CHMod				EQU 67	; 67	 43
   152                                  IOCTL				EQU 68	; 68	 44
   153                                  XDUP				EQU 69	; 69	 45
   154                                  XDup2				EQU 70	; 70	 46
   155                                  Current_Dir			EQU 71	; 71	 47
   156                                  ;    Memory Group
   157                                  ALLOC				EQU 72	; 72	 48
   158                                  DEALLOC				EQU 73	; 73	 49
   159                                  SETBLOCK			EQU 74	; 74	 4A
   160                                  ;    Process Group
   161                                  Exec				EQU 75	; 75	 4B
   162                                  EXIT				EQU 76	; 76	 4C
   163                                  WAITPROCESS			EQU 77	; 77	 4D
   164                                  Find_First			EQU 78	; 78	 4E
   165                                  ;   Special Group
   166                                  Find_Next			EQU 79	; 79	 4F
   167                                  ; SPECIAL SYSTEM GROUP
   168                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   169                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   170                                  ;									   ;
   171                                  SET_CURRENT_PDB 		EQU 80	; 80	 50
   172                                  GET_CURRENT_PDB 		EQU 81	; 81	 51
   173                                  Get_In_Vars			EQU 82	; 82	 52
   174                                  SetDPB				EQU 83	; 83	 53
   175                                  ;									   ;
   176                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   177                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   178                                  Get_Verify_On_Write		EQU 84	; 84	 54
   179                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   180                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   181                                  ;									   ;
   182                                  Dup_PDB 			EQU 85	; 85	 55
   183                                  ;									   ;
   184                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   185                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   186                                  Rename				EQU 86	; 86	 56
   187                                  File_Times			EQU 87	; 87	 57
   188                                  AllocOper			EQU 88	; 88	 58
   189                                  ; Network extention system calls
   190                                  GetExtendedError		EQU 89	; 89	 59
   191                                  CreateTempFile			EQU 90	; 90	 5A
   192                                  CreateNewFile			EQU 91	; 91	 5B
   193                                  LockOper			EQU 92	; 92	 5C Lock and Unlock
   194                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   195                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   196                                  ;									   ;
   197                                  ServerCall			EQU 93	; 93	 5D CommitAll, ServerDOSCall,
   198                                  					;	    CloseByName, CloseUser,
   199                                  					;	    CloseUserProcess,
   200                                  					;	    GetOpenFileList
   201                                  ;									   ;
   202                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   203                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   204                                  UserOper			EQU 94	; 94	 5E Get and Set
   205                                  AssignOper			EQU 95	; 95	 5F On, Off, Get, Set, Cancel
   206                                  xNameTrans			EQU 96	; 96	 60
   207                                  PathParse			EQU 97	; 97	 61
   208                                  GetCurrentPSP			EQU 98	; 98	 62
   209                                  Hongeul 			EQU 99	; 99	 63
   210                                  ECS_CALL			EQU 99	; 99	 63  ;; DBCS support
   211                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   212                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   213                                  ;									   ;
   214                                  Set_Printer_Flag		EQU 100 ; 100	 64
   215                                  ;									   ;
   216                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   217                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   218                                  GetExtCntry			EQU 101 ; 101	 65
   219                                  GetSetCdPg			EQU 102 ; 102	 66
   220                                  ExtHandle			EQU 103 ; 103	 67
   221                                  Commit				EQU 104 ; 104	 68
   222                                  GetSetMediaID			EQU 105 ; 105	 69
   223                                  IFS_IOCTL			EQU 107 ; 107	 6B
   224                                  ExtOpen 			EQU 108 ; 108	 6C
   225                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   226                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   227                                  ;                                                                          ;
   228                                  ;ifdef ROMEXEC
   229                                  ;ROM_FIND_FIRST			EQU 109 ; 109    6D
   230                                  ;ROM_FIND_NEXT			EQU 110 ; 110    6E
   231                                  ;ROM_EXCLUDE			EQU 111 ; 111	 6F		; M035
   232                                  ;endif
   233                                  ;                                                                          ;
   234                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   235                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   236                                  ;
   237                                  ;
   238                                  Set_Oem_Handler 		EQU 248 ; 248	 F8
   239                                  OEM_C1				EQU 249 ; 249	 F9
   240                                  OEM_C2				EQU 250 ; 250	 FA
   241                                  OEM_C3				EQU 251 ; 251	 FB
   242                                  OEM_C4				EQU 252 ; 252	 FC
   243                                  OEM_C5				EQU 253 ; 253	 FD
   244                                  OEM_C6				EQU 254 ; 254	 FE
   245                                  OEM_C7				EQU 255 ; 255	 FF
   246                                  
   247                                  ;============================================================================
   248                                  ; DOSSYM.INC, MSDOS 6.0, 1991
   249                                  ;============================================================================
   250                                  ; 21/09/2018 - Retro DOS v3.0
   251                                  
   252                                  ;BREAK <Control character definitions>
   253                                  
   254                                  c_DEL	    EQU     7Fh 	;    ASCII rubout or delete previous char
   255                                  c_BS	    EQU     08h 	; ^H ASCII backspace
   256                                  c_CR	    EQU     0Dh 	; ^M ASCII carriage return
   257                                  c_LF	    EQU     0Ah 	; ^J ASCII linefeed
   258                                  c_ETB	    EQU     17h 	; ^W ASCII end of transmission
   259                                  c_NAK	    EQU     15h 	; ^U ASCII negative acknowledge
   260                                  c_ETX	    EQU     03h 	; ^C ASCII end of text
   261                                  c_HT	    EQU     09h 	; ^I ASCII tab
   262                                  
   263                                  ;============================================================================
   264                                  ; DIRENT.INC, MSDOS 6.0, 1991
   265                                  ;============================================================================
   266                                  ; 21/09/2018 - Retro DOS v3.0
   267                                  
   268                                  ;Break <Directory entry>
   269                                  
   270                                  ;	NOTE:  These offsets are also used in the DTA for
   271                                  ;	extended FCB SearchFirst/Next. DIR_NAME lines up
   272                                  ;	with the FCB filename field, and the rest of the
   273                                  ;	DIR_ENTRY fields follow. -DavidOls
   274                                  
   275                                  ;**	DIRENT.INC - FAT Directory Entry Definition
   276                                  ;
   277                                  ;	+---------------------------+
   278                                  ;	|  (12 BYTE) filename/ext   |	    0	    0
   279                                  ;	+---------------------------+
   280                                  ;	|     (BYTE) attributes     |	    11	    B
   281                                  ;	+---------------------------+
   282                                  ;	|    (10 BYTE) reserved     |	    12	    C
   283                                  ;	+---------------------------+
   284                                  ;	| (WORD) time of last write |	    22	    16
   285                                  ;	+---------------------------+
   286                                  ;	| (WORD) date of last write |	    24	    18
   287                                  ;	+---------------------------+
   288                                  ;	|   (WORD) First cluster    |	    26	    1A
   289                                  ;	+---------------------------+
   290                                  ;	|     (DWORD) file size     |	    28	    1C
   291                                  ;	+---------------------------+
   292                                  ;
   293                                  ;   First byte of filename  = E5 -> free directory entry
   294                                  ;			    = 00 -> end of allocated directory
   295                                  ;   Time:   Bits 0-4=seconds/2, bits 5-10=minute, 11-15=hour
   296                                  ;   Date:   Bits 0-4=day, bits 5-8=month, bits 9-15=year-1980
   297                                  ;
   298                                  
   299                                  STRUC DIR_ENTRY
   300 00000000 <res Bh>                .DIR_NAME:	RESB  11	; file name
   301 0000000B ??                      .DIR_ATTR:	RESB  1		; attribute bits
   302 0000000C ????                    .DIR_CODEPG:	RESW  1		; code page DOS 4.00
   303 0000000E ????                    .DIR_EXTCLUSTER: RESW 1		; extended attribute starting cluster
   304 00000010 ??                      .DIR_ATTR2:	RESB  1		; reserved
   305 00000011 ??????????              .DIR_PAD:	RESB  5		; reserved for expansion
   306 00000016 ????                    .DIR_TIME:	RESW  1		; time of last write
   307 00000018 ????                    .DIR_DATE:	RESW  1		; date of last write
   308 0000001A ????                    .DIR_FIRST:	RESW  1		; first allocation unit of file
   309 0000001C ????                    .DIR_SIZE_L:	RESW  1		; low 16 bits of file size
   310 0000001E ????                    .DIR_SIZE_H:	RESW  1		; high 16 bits of file size
   311                                  .size:
   312                                  
   313                                  ;	    Caution: An extended FCB SearchFirst/Next on a network
   314                                  ;	    drive under Novell Netware 286 or 386 returns the time/date
   315                                  ;	    in the SIZE fields for subdirectory files. Ordinarily,
   316                                  ;	    this field is zero for subdirectory files.
   317                                  
   318                                  ENDSTRUC
   319                                  
   320                                  ATTR_READ_ONLY	equ	 1h
   321                                  ATTR_HIDDEN	equ	 2h
   322                                  ATTR_SYSTEM	equ	 4h
   323                                  ATTR_VOLUME_ID	equ	 8h
   324                                  ATTR_DIRECTORY	equ	10h
   325                                  ATTR_ARCHIVE	equ	20h
   326                                  ATTR_DEVICE	equ	40h	; This is a VERY special bit.
   327                                  				;   NO directory entry on a disk EVER
   328                                  				;   has this bit set. It is set non-zero
   329                                  				;   when a device is found by GETPATH
   330                                  
   331                                  ATTR_ALL	equ	ATTR_HIDDEN+ATTR_SYSTEM+ATTR_DIRECTORY
   332                                  				; OR of hard attributes for FINDENTRY
   333                                  
   334                                  ATTR_IGNORE	equ	ATTR_READ_ONLY+ATTR_ARCHIVE+ATTR_DEVICE
   335                                  				; ignore this(ese) attribute(s) during
   336                                  				; search first/next
   337                                  
   338                                  ATTR_CHANGEABLE equ	ATTR_READ_ONLY+ATTR_HIDDEN+ATTR_SYSTEM+ATTR_ARCHIVE
   339                                  				; changeable via CHMOD
   340                                  
   341                                  DIRFREE 	equ	0E5h	; stored in dir_name[0] to indicate free slot
   342                                  
   343                                  ;============================================================================
   344                                  ; ERROR.INC, MSDOS 6.0, 1991
   345                                  ;============================================================================
   346                                  ; 21/09/2018 - Retro DOS v3.0
   347                                  
   348                                  ;**	ERROR.INC - DOS Error Codes
   349                                  ;
   350                                  ;    The newer (DOS 2.0 and above) "XENIX-style" calls
   351                                  ;    return error codes through AX.	If an error occurred then
   352                                  ;    the carry bit will be set and the error code is in AX.	If no error
   353                                  ;    occurred then the carry bit is reset and AX contains returned info.
   354                                  ;
   355                                  ;    Since the set of error codes is being extended as we extend the operating
   356                                  ;    system, we have provided a means for applications to ask the system for a
   357                                  ;    recommended course of action when they receive an error.
   358                                  ;
   359                                  ;    The GetExtendedError system call returns a universal error, an error
   360                                  ;    location and a recommended course of action.	The universal error code is
   361                                  ;    a symptom of the error REGARDLESS of the context in which GetExtendedError
   362                                  ;    is issued.
   363                                  
   364                                  
   365                                  ;	2.0 error codes
   366                                  
   367                                  error_invalid_function		EQU	1
   368                                  ERROR_FILE_NOT_FOUND		EQU	2
   369                                  ERROR_PATH_NOT_FOUND		EQU	3
   370                                  ERROR_TOO_MANY_OPEN_FILES	EQU	4
   371                                  ERROR_ACCESS_DENIED		EQU	5
   372                                  error_invalid_handle		EQU	6
   373                                  error_arena_trashed		EQU	7
   374                                  ERROR_NOT_ENOUGH_MEMORY 	EQU	8
   375                                  error_invalid_block		EQU	9
   376                                  error_bad_environment		EQU	10
   377                                  ERROR_BAD_FORMAT		EQU	11
   378                                  error_invalid_access		EQU	12
   379                                  ERROR_INVALID_DATA		EQU	13
   380                                  ;**** reserved			EQU	14	; *****
   381                                  error_invalid_drive		EQU	15
   382                                  error_current_directory 	EQU	16
   383                                  error_not_same_device		EQU	17
   384                                  ERROR_NO_MORE_FILES		EQU	18
   385                                  
   386                                  ;	These are the universal int 24 mappings for the old INT 24 set of errors
   387                                  
   388                                  ERROR_WRITE_PROTECT		EQU	19
   389                                  error_bad_unit			EQU	20
   390                                  error_not_ready 		EQU	21
   391                                  error_bad_command		EQU	22
   392                                  error_CRC			EQU	23
   393                                  error_bad_length		EQU	24
   394                                  error_Seek			EQU	25
   395                                  error_not_DOS_disk		EQU	26
   396                                  error_sector_not_found		EQU	27
   397                                  error_out_of_paper		EQU	28
   398                                  error_write_fault		EQU	29
   399                                  error_read_fault		EQU	30
   400                                  ERROR_GEN_FAILURE		EQU	31
   401                                  
   402                                  ;	the new 3.0 error codes reported through INT 24
   403                                  
   404                                  error_sharing_violation 	EQU	32
   405                                  error_lock_violation		EQU	33
   406                                  error_wrong_disk		EQU	34
   407                                  ERROR_FCB_UNAVAILABLE		EQU	35
   408                                  ERROR_SHARING_BUFFER_EXCEEDED	EQU	36
   409                                  error_Code_Page_Mismatched	EQU	37    ; DOS 4.00	;AN000;
   410                                  error_handle_EOF		EQU	38    ; DOS 4.00	;AN000;
   411                                  ERROR_HANDLE_DISK_FULL		EQU	39    ; DOS 4.00	;AN000;
   412                                  
   413                                  ;	New OEM network-related errors are 50-79
   414                                  
   415                                  error_not_supported		EQU	50
   416                                  
   417                                  error_net_access_denied		EQU	65	;M028
   418                                  
   419                                  ;	End of INT 24 reportable errors
   420                                  
   421                                  error_file_exists		EQU	80
   422                                  error_DUP_FCB			EQU	81	; *****
   423                                  error_cannot_make		EQU	82
   424                                  error_FAIL_I24			EQU	83
   425                                  
   426                                  ;	New 3.0 network related error codes
   427                                  
   428                                  error_out_of_structures 	EQU	84
   429                                  error_Already_assigned		EQU	85
   430                                  error_invalid_password		EQU	86
   431                                  error_invalid_parameter 	EQU	87
   432                                  error_NET_write_fault		EQU	88
   433                                  error_sys_comp_not_loaded	EQU	90    ; DOS 4.00	;AN000;
   434                                  
   435                                  ;============================================================================
   436                                  ; DEVSYM.INC, MSDOS 6.0, 1991
   437                                  ;============================================================================
   438                                  ; 22/09/2018 - Retro DOS v3.0
   439                                  
   440                                  ;**	DevSym.inc - Device Symbols
   441                                  
   442                                  ;	THE DEVICE TABLE LIST HAS THE FORM:
   443                                  
   444                                  STRUC SYSDEV
   445 00000000 ????????                .NEXT:	RESD 1			;POINTER TO NEXT DEVICE HEADER
   446 00000004 ????                    .ATT:	RESW 1			;ATTRIBUTES OF THE DEVICE
   447 00000006 ????                    .STRAT:	RESW 1			;STRATEGY ENTRY POINT
   448 00000008 ????                    .INT:	RESW 1			;INTERRUPT ENTRY POINT
   449 0000000A ????????????????        .NAME:	RESB 8			;NAME OF DEVICE (ONLY FIRST BYTE USED FOR BLOCK)
   450                                  .size:
   451                                  ENDSTRUC
   452                                  
   453                                  ; 24/09/2018
   454                                  DEVTYP	EQU   8000H	; BIT 15 - 1  IF CHAR, 0 IF BLOCK
   455                                  
   456                                  ;============================================================================
   457                                  ; CURDIR.INC, MSDOS 6.0, 1991
   458                                  ;============================================================================
   459                                  ; 21/09/2018 - Retro DOS v3.0
   460                                  
   461                                  DIRSTRLEN	EQU	64+3	; Max length in bytes of directory strings
   462                                  
   463                                  ;============================================================================
   464                                  ; COMEQU.ASM, MSDOS 6.0, 1991
   465                                  ;============================================================================
   466                                  ; 21/09/2018 - Retro DOS v3.0
   467                                  
   468                                  ;/*
   469                                  ; *                      Microsoft Confidential
   470                                  ; *                      Copyright (C) Microsoft Corporation 1991
   471                                  ; *                      All Rights Reserved.
   472                                  ; */
   473                                  ;	SCCSID = @(#)comequ.asm 1.1 85/05/14
   474                                  ;	SCCSID = @(#)comequ.asm 1.1 85/05/14
   475                                  ;*************************************
   476                                  ; COMMAND EQUs which are not switch dependant
   477                                  
   478                                  ;		include	curdir.inc	; to get DIRSTRLEN
   479                                  ;		Note dossym.inc must already have been included!
   480                                  
   481                                  GET_COMMAND_STATE	equ	5500h	; check for existing COMMAND
   482                                  GET_ROMCOMMAND_STATE	equ	5501h	; check for existing ROM COMMAND
   483                                  
   484                                  SYM		EQU	">"
   485                                  
   486                                  LINESPERPAGE	EQU	25		;AC000; default lines per page
   487                                  
   488                                  NORMPERLIN	EQU	1
   489                                  WIDEPERLIN	EQU	5
   490                                  COMBUFLEN	EQU	128		; Length of commmand buffer
   491                                  BatLen		EQU	32		; buffer for batch files
   492                                  YES_ECHO	EQU	1		; echo line
   493                                  NO_ECHO 	EQU	0		; don't echo line
   494                                  No_Echo_Char	EQU	"@"             ; don't echo line if this is first char
   495                                  call_in_progress EQU	1		; indicate we're in the CALL command
   496                                  length_call	EQU	4		; length of CALL
   497                                  max_nest	EQU    10		; max # levels of batch nesting allowed
   498                                  FAIL_ALLOWED	EQU    00001000b	; critical error
   499                                  RETRY_ALLOWED	EQU    00010000b	; critical error
   500                                  IGNORE_ALLOWED	EQU    00100000b	; critical error
   501                                  nullcommand	EQU     1		; no command on command line
   502                                  END_OF_LINE	EQU    -1		;AN000; end of line return from parser
   503                                  END_OF_LINE_OUT EQU	0		;AN000; end of line for output
   504                                  END_OF_LINE_IN	EQU	0Dh		;AN000; end of line for input
   505                                  result_number	EQU	1		;AN000; number returned from parser
   506                                  result_string	EQU	3		;AN000; string returned from parser
   507                                  RESULT_FILESPEC EQU	5		;AN000; filespec returned from parser
   508                                  result_drive	EQU	6		;AN000; drive returned from parser
   509                                  result_date	EQU	7		;AN000; date returned from parser
   510                                  result_time	EQU	8		;AN000; time returned from parser
   511                                  RESULT_NO_ERROR EQU	0		;AN000; no error returned from parser
   512                                  no_cont_flag	EQU	0		;AN000; no control flags for message
   513                                  util_msg_class	EQU	-1		;AN000; message class for utility
   514                                  ext_msg_class	EQU	1		;AN000; message class for extended error
   515                                  parse_msg_class EQU	2		;AN000; message class for parse error
   516                                  crit_msg_class	EQU	3		;AN000; message class for critical error
   517                                  ext_crlf_class	EQU	081h		;AN054; message class for extended error with no CRLF
   518                                  colon_char	EQU	":"             ;AN000; colon character
   519                                  crt_ioctl_ln	EQU	14		;AN000; default length of data for display ioctl
   520                                  text_mode	EQU	1		;AN000; text mode return from ioctl
   521                                  get_generic	EQU	07Fh		;AN000; generic ioctl - get device info
   522                                  set_crit_dev	EQU	0100H		;AN000; device attribute for critical error on I/0
   523                                  mult_ansi	EQU	01Ah		;AC064; multiplex for ansi.sys
   524                                  mult_shell_get	EQU	01902h		;AC065; multiplex for Shell - get next command
   525                                  mult_shell_brk	EQU	01903h		;AN000; multiplex for Shell - ^C batch check
   526                                  shell_action	equ	0FFh		;AN000; SHELL - return for taking SHELL specific action
   527                                  bat_not_open	EQU	-1		;AN000; batch handle will be set to this if not open
   528                                  bat_open_handle EQU	19		;AN000; handle will be in this position in JFN table
   529                                  Ptr_seg_pos	equ	7		;AN000; Offset from start of message block for subst segment
   530                                  Ptr_off_pos	equ	5		;AN000; Offset from start of message block for subst offset
   531                                  %define Parm_off_pos	word [2]	;AN000; Offset from start of subst list for subst offset
   532                                  parm_block_size equ	11		;AN000; size of message subst block
   533                                  blank		equ	" "             ;AN000; blank character
   534                                  no_subst	equ	0		;AN000; no substitutions for messages
   535                                  one_subst	equ	1		;AN000; one substitution for messages
   536                                  no_handle_out	equ	-1		;AN000; use function 1 thru 12 for message retriever
   537                                  res_subst	equ	2		;AN000; offset from start of message definition to number of subst
   538                                  read_open_mode	equ   0000000000000000b ;AN024; extended open mode for read
   539                                  deny_write	equ   0000000000100000b	; deny write sharing mode ;M031
   540                                  deny_none	equ   0000000001000000b	; deny none sharing mode ;Myyy	
   541                                  read_open_flag	equ   0000000100000001b ;AN000; extended open flags for read
   542                                  write_open_mode equ   0000000000000001b ;AN024; extended open mode for read
   543                                  write_open_flag equ   0000000100000001b ;AN000; extended open flags for read
   544                                  creat_open_flag equ   0000000100010010b ;AN000; extended open flags for read
   545                                  capital_A	equ	'A'             ;AC000;
   546                                  vbar		equ	'|'             ;AC000;
   547                                  labracket	equ	'<'             ;AC000;
   548                                  rabracket	equ	'>'             ;AC000;
   549                                  dollar		equ	'$'             ;AC000;
   550                                  lparen		equ	'('             ;AC000;
   551                                  rparen		equ	')'             ;AC000;
   552                                  nullrparen	equ	29h		;AC000;
   553                                  in_word 	equ	4E49h		;AC000; 'NI'  ('IN' backwards)
   554                                  do_word 	equ	4F44h		;AC000; 'OD'  ('DO' backwards)
   555                                  star		equ	'*'             ;AC000;
   556                                  plus_chr	equ	'+'             ;AC000;
   557                                  small_a 	equ	'a'             ;AC000;
   558                                  small_z 	equ	'z'             ;AC000;
   559                                  dot_chr 	equ	'.'             ;AC000;
   560                                  tab_chr 	equ	9		;AN032;
   561                                  equal_chr	equ	'='             ;AN032;
   562                                  semicolon	equ	';'             ;AN049;
   563                                  dot_qmark	equ	2e3fh		;AC000; '.?'
   564                                  dot_colon	equ	2e3ah		;AC000; '.:'
   565                                  capital_n	equ	0		;AC000; result from Y/N call if N entered
   566                                  capital_y	equ	1		;AC000; result from Y/N call if Y entered
   567                                  AppendInstall	equ	0B700H		;AN020; append install check
   568                                  AppendDOS	equ	0B702H		;AN020; append DOS version check
   569                                  AppendGetState	equ	0B706H		;AN020; append get current state
   570                                  AppendSetState	equ	0B707H		;AN020; append set current state
   571                                  AppendTruename	equ	0B711H		;AN042; Get file's real location for Batch
   572                                  search_attr	equ	ATTR_READ_ONLY+ATTR_HIDDEN+ATTR_DIRECTORY  ;AC042;
   573                                  
   574                                  ;*************************************
   575                                  ;* PARSE ERROR MESSAGES
   576                                  ;*************************************
   577                                  
   578                                  MoreArgs_Ptr	equ	1		;AN000;"Too many parameters" message number
   579                                  LessArgs_Ptr	equ	2		;AN000;"Required parameter missing" message number
   580                                  BadSwt_Ptr	equ	3		;AN000;"Invalid switch" message number
   581                                  BadParm_Ptr	equ	10		;AN000;"Invalid parameter" message number
   582                                  
   583                                  ;*************************************
   584                                  ;* EQUATES FOR MESSAGE RETRIEVER
   585                                  ;*************************************
   586                                  
   587                                  GET_EXTENDED_MSG	EQU	0	;AN000;  get extended message address
   588                                  SET_EXTENDED_MSG	EQU	1	;AN000;  set extended message address
   589                                  GET_PARSE_MSG		EQU	2	;AN000;  get parse message address
   590                                  SET_PARSE_MSG		EQU	3	;AN000;  set parse message address
   591                                  GET_CRITICAL_MSG	EQU	4	;AN000;  get critical message address
   592                                  SET_CRITICAL_MSG	EQU	5	;AN000;  set critical message address
   593                                  MESSAGE_2F		EQU	46	;AN000;  minor code for message retriever
   594                                  
   595                                  ;*********************************
   596                                  ;* EQUATES FOR INT 10H
   597                                  ;*********************************
   598                                  
   599                                  VIDEO_IO_INT		EQU	10H	;AN000;  equate for int 10h
   600                                  SET_VIDEO_MODE		EQU	0	;AN000;  set video mode
   601                                  SET_CURSOR_POSITION	EQU	2	;AN000;  set new cursor position
   602                                  SCROLL_VIDEO_PAGE	EQU	6	;AN000;  scroll active page up
   603                                  VIDEO_ATTRIBUTE 	EQU	7	;AN000;  attribute to be used on blank line
   604                                  SET_COLOR_PALETTE	EQU	11	;AN000;  set color for video
   605                                  GET_VIDEO_STATE 	EQU	15	;AN000;  get current video state
   606                                  VIDEO_ALPHA		EQU	3	;AN000;  alpha video is 3 or below
   607                                  VIDEO_BW		EQU	7	;AN000;  mode for 80X25 black & white
   608                                  
   609                                  AltPipeChr	equ	"|"             ; alternate pipe character
   610                                  
   611                                  FCB		equ	5Ch
   612                                  
   613                                  STRUC VARSTRUC
   614 00000000 ??                      .ISDIR:		RESB	1
   615 00000001 ??                      .SIZ:		RESB	1
   616 00000002 ????                    .TTAIL:		RESW	1
   617 00000004 ??                      .INFO:		RESB	1
   618 00000005 <res 57h>               .BUF:		RESB	DIRSTRLEN + 20
   619                                  .size:
   620                                  ENDSTRUC
   621                                  ;
   622                                  ; Flags for internal command parsing
   623                                  ;
   624                                  fCheckDrive	equ	00000001b	; validate drive letter
   625                                  fSwitchAllowed	equ	00000010b	; switches allowed
   626                                  fLimitHelp	equ	00000100b	; /? must appear alone
   627                                  
   628                                  ;
   629                                  ; Test switches
   630                                  ;
   631                                  fParse		EQU	0001h		; display results of parseline
   632                                  
   633                                  ;
   634                                  ; Batch segment structure
   635                                  ;
   636                                  ;   BYTE    type of segment
   637                                  ;   BYTE    echo state of parent on entry to batch file
   638                                  ;   WORD    segment of last batch file
   639                                  ;   WORD    segment for FOR command
   640                                  ;   BYTE    FOR flag state on entry to batch file
   641                                  ;   DWORD   offset for next line
   642                                  ;   10 WORD pointers to parameters. -1 is empty parameter
   643                                  ;   ASCIZ   file name (with . and ..)
   644                                  ;   BYTES   CR-terminated parameters
   645                                  ;   BYTE    0 flag to indicate end of parameters
   646                                  ;
   647                                  
   648                                  BATCHTYPE   equ 0
   649                                  
   650                                  STRUC BATCHSEGMENT
   651 00000000 ??                      .BatType:	RESB	1		; signature
   652 00000001 ??                      .BatEchoFlag:	RESB	1		; G state of echo
   653                                  ; MSDOS 5.0 (& 6.0) - 11/01/2023
   654 00000002 ??                      .BatchEOF:	RESB	1		; records if EOF reached on file
   655 00000003 ????                    .BatLast: 	RESW	1		; G segment of last batch file
   656 00000005 ????                    .BatForPtr:	RESW	1		; G segment for FOR command
   657 00000007 ??                      .BatForFlag:	RESB	1		; G state of FOR
   658 00000008 ????????                .BatSeek:	RESD	1		; lseek position of next char
   659 0000000C <res 14h>               .BatParm:	RESW	10		; pointers to parameters
   660 00000020 ??                      .BatFile:	RESB	1		; beginning of batch file name
   661                                  .SIZE:
   662                                  ENDSTRUC
   663                                  
   664                                  ANULL		equ	0		; terminates an argv string
   665                                  ARGMAX		equ	64		; max args on a command line
   666                                  ;ARGBLEN 	equ	2*128		; 1char each plus term NUL
   667                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM ;*
   668                                  ARGBLEN 	equ	2*64
   669                                  tplen		equ	64		; max size of one argument
   670                                  arg_cnt_error	equ	1		; number of args > MAXARG
   671                                  arg_buf_ovflow	equ	2		; overflowed argbuffer
   672                                  
   673                                  STRUC ARGV_ELE				; elements in the argv array
   674 00000000 ????                    .argpointer:	RESW	1		; pointer to the argstring
   675 00000002 ??                      .argflags:	RESB	1		; cparse flags for this argstring
   676 00000003 ????                    .argstartel:	RESW	1		; the result of cparse's [STARTEL]
   677 00000005 ????                    .arglen:	RESW	1		; cparse's char count + one (for null)
   678 00000007 ????                    .argsw_word:	RESW	1		; any switches after this? what kinds?
   679 00000009 ????                    .arg_ocomptr:	RESW	1		; pointer into original command string
   680                                  .SIZE:	; 11 ; 27/07/2024
   681                                  ENDSTRUC
   682                                  
   683                                  STRUC ARG_UNIT
   684 00000000 <res 2C0h>              .argv:		RESB	ARGMAX * ARGV_ELE.SIZE ; 704 ; 27/07/2024
   685 000002C0 ????                    .argvcnt:	RESW	1		; number of arguments
   686 000002C2 ????                    .argswinfo:	RESW	1		; Switch information for entire line
   687 000002C4 <res 100h>              .argbuf:	RESW	ARGBLEN		; storage for argv strings
   688 000003C4 <res 80h>               .argforcombuf:	RESB	COMBUFLEN	; Original for loop command string
   689                                  .SIZE:	; 1092 ; 27/07/2024 ; (it was 1348 in MSDOS 5.0-6.22 COMMAND.COM) ;*
   690                                  ENDSTRUC
   691                                  
   692                                  ; Equates for initialization
   693                                  ;
   694                                  INITINIT	equ	01h		; initialization in progress
   695                                  INITSPECIAL	equ	02h		; in initialization time/date routine
   696                                  INITCTRLC	equ	04h		; already in ^C handler
   697                                  
   698                                  ;============================================================================
   699                                  ;  INTNAT.INC, MSDOS 6.0, 1991
   700                                  ;============================================================================
   701                                  ; 16/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM 
   702                                  
   703                                  ; Current structure of the data returned by the international call
   704                                  
   705                                  struc INTERNAT_BLOCK
   706 00000000 ????                    .date_tim_format: resw 1		; 0-USA, 1-EUR, 2-JAP
   707 00000002 ??????????              .currency_sym:	resb 5			; Currency Symbol 5 bytes
   708 00000007 ????                    .thous_sep:	resb 2			; Thousands separator 2 bytes
   709 00000009 ????                    .decimal_sep:	resb 2			; Decimal separator 2 bytes
   710 0000000B ????                    .date_sep:	resb 2			; Date separator 2 bytes
   711 0000000D ????                    .time_sep:	resb 2			; Decimal separator 2 bytes
   712 0000000F ??                      .bit_field:	resb 1			; Bit values
   713                                  					;   Bit 0 = 0 if currency symbol first
   714                                  					;	  = 1 if currency symbol last
   715                                  					;   Bit 1 = 0 if No space after currency symbol
   716                                  					;	  = 1 if space after currency symbol
   717                                  .currency_cents:
   718 00000010 ??                      		resb 1			; Number of places after currency dec point
   719 00000011 ??                      .time_24:	resb 1			; 1 if 24 hour time, 0 if 12 hour time
   720 00000012 ????????                .map_call:	resw 2			; Address of case mapping call (DWORD)
   721                                  					; THIS IS TWO WORDS SO IT CAN BE INITIALIZED
   722                                  					;  in pieces.
   723 00000016 ??                      .data_sep:	resb 1			; Data list separator character
   724 00000017 ??                      		resb 1
   725                                  endstruc
   726                                  
   727                                  ; Max size of the block returned by the INTERNATIONAL call
   728                                  
   729                                  internat_block_max equ 32
   730                                  
   731                                  ;============================================================================
   732                                  ; FIND.INC (MSDOS 3.3, 1987) - REDIRSYM.INC (MSDOS 6.0, 1991) 
   733                                  ;============================================================================
   734                                  ; 13/10/2018 - Retro DOS v3.0
   735                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM 
   736                                  
   737                                  ;Break	<find first/next buffer>
   738                                  
   739                                  	; MSDOS 3.3 & MSDOS 6.0
   740                                  
   741                                  struc FIND_BUF
   742 00000000 ??                      .DRIVE:	    resb 1	; drive of search
   743 00000001 <res Bh>                .NAME:	    resb 11	; formatted name
   744 0000000C ??                      .SATTR:	    resb 1	; attribute of search
   745 0000000D ????                    .LASTENT:   resw 1	; LastEnt
   746 0000000F ????                    .DIRSTART:  resw 1	; DirStart
   747 00000011 ????????                .NETID:	    resb 4	; Reserved for NET
   748 00000015 ??                      .ATTR:	    resb 1	; attribute found
   749 00000016 ????                    .TIMR:	    resw 1	; time
   750 00000018 ????                    .DATE:	    resw 1	; date
   751 0000001A ????                    .SIZE_L:    resw 1	; low(size)
   752 0000001C ????                    .SIZE_H:    resw 1	; high(size)
   753 0000001E <res Dh>                .PNAME:	    resb 13	; packed name
   754                                  .size:
   755                                  endstruc
   756                                  
   757                                  ;=============================================================================
   758                                  ; PDB.INC, MSDOS 6.0, 1991
   759                                  ;=============================================================================
   760                                  ; 24/09/2018 - Retro DOS v3.0 (08/07/2018, 'msdos3.s')
   761                                  
   762                                  ;**	Process data block (otherwise known as program header)
   763                                  
   764                                  ;	These offset are documented in the MSDOS Encyclopedia, so nothing
   765                                  ;	can be rearranged here, ever. Reserved areas are probably safe
   766                                  ;	for use.
   767                                  
   768                                  FILPERPROC	EQU     20
   769                                  
   770                                  struc PDB	; Process_data_block
   771 00000000 ????                    .EXIT_CALL:	resw 1   	; INT int_abort system terminate
   772 00000002 ????                    .BLOCK_LEN:	resw 1		; size of execution block
   773 00000004 ??                                      resb 1
   774 00000005 ??????????              .CPM_CALL:	resb 5		; ancient call to system
   775 0000000A ????????                .EXIT:		resd 1		; pointer to exit routine
   776 0000000E ????????                .CTRL_C:	resd 1		; pointer to ^C routine
   777 00000012 ????????                .FATAL_ABORT:	resd 1		; pointer to fatal error
   778 00000016 ????                    .PARENT_PID:	resw 1		; PID of parent (terminate PID)
   779 00000018 <res 14h>               .JFN_TABLE:     resb FILPERPROC ; indices into system table
   780 0000002C ????                    .ENVIRON:	resw 1		; seg addr of environment
   781 0000002E ????????                .USER_STACK:	resd 1		; stack of self during system calls
   782 00000032 ????                    .JFN_Length:	resw 1		; number of handles allowed
   783 00000034 ????????                .JFN_Pointer:	resd 1		; pointer to JFN table
   784 00000038 ????????                .Next_PDB:	resd 1		; pointer to nested PDB's
   785 0000003C ??                      .InterCon:	resb 1	; MSDOS 6.0 ; *** jh-3/28/90 *** 
   786 0000003D ??                      .Append:	resb 1	; MSDOS 6.0 ; *** Not sure if still used ***
   787 0000003E ????                    .Novell_Used:	resb 2	; MSDOS 6.0 ; Novell shell (redir) uses these
   788 00000040 ????                    .Version:	resw 1	; MSDOS 6.0 ; DOS version reported to this app
   789 00000042 <res Eh>                .PAD1:		resb 14 ; 0Eh
   790 00000050 ??????????              .CALL_SYSTEM:	resb 5		; portable method of system call
   791 00000055 ??????????????          .PAD2:		resb 7		; reserved so FCB 1 can be used as
   792                                  				;  an extended FCB
   793                                  ;endstruc 	; MSDOS 3.3
   794                                  	  	; MSDOS 6.0
   795 0000005C <res 10h>               .FCB1:		resb 16 ; 10h	; default FCB 1
   796 0000006C <res 10h>               .FCB2:		resb 16 ; 10h	; default FCB 2
   797 0000007C ????????                .PAD3:		resb 4		; not sure if this is used by PDB_FCB2
   798 00000080 <res 80h>               .TAIL:		resb 128	; command tail and default DTA
   799                                  endstruc
   800                                  
   801                                  ;=============================================================================
   802                                  ; VERSIONA.INC, MSDOS 6.0, 1991
   803                                  ;=============================================================================
   804                                  ; 24/09/2018 - Retro DOS v3.0
   805                                  
   806                                  ;major_version	equ 6		; Major DOS version
   807                                  ;minor_version	equ 0		; Minor DOS Version
   808                                  
   809                                  ;expected_version    equ     (MINOR_VERSION SHL 8)+MAJOR_VERSION
   810                                  
   811                                  ; MSDOS 3.3 COMMAND.COM
   812                                  ;MAJOR_VERSION	EQU 3
   813                                  ;MINOR_VERSION	EQU 30
   814                                  
   815                                  ; 09/01/2023 - Retro DOS v4.0 (& v4.1)
   816                                  ;MAJOR_VERSION	EQU 5
   817                                  ;MINOR_VERSION	EQU 0
   818                                  
   819                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
   820                                  ;MAJOR_VERSION	EQU 6		; Major DOS version
   821                                  ;MINOR_VERSION	EQU 22		; Minor DOS version
   822                                  
   823                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
   824                                  MAJOR_VERSION	EQU 7		; Major DOS version
   825                                  MINOR_VERSION	EQU 10		; Minor DOS version
   826                                  
   827                                  EXPECTED_VERSION EQU (MINOR_VERSION<<8)+MAJOR_VERSION	
   828                                  
   829                                  ;-----------------------------------------------------------------------------
   830                                  ; 21/09/2018
   831                                  ;-----------------------------------------------------------------------------
   832                                  ; Retro DOS v3.0 NOTE:  
   833                                  ;	Following source code is as disassembled code of MSDOS 3.3 COMMAND.COM
   834                                  ;	with minor modifications which are done by me (Erdogan Tan).
   835                                  ;	.. but comments and descriptions are from MSDOS 6.0 COMMAND.COM
   836                                  ;	source code files (written by using MASM syntax).
   837                                  ;-----------------------------------------------------------------------------
   838                                  ; All of this Retro DOS 3.0 (2018) source code has been written by using
   839                                  ; NASM (2.11) x86 assembly language/compiler syntax.	
   840                                  ;----------------------------------------------------------------------------- 	
   841                                  
   842                                  ;=============================================================================
   843                                  ; COMMAND1.ASM, MSDOS 6.0, 1991
   844                                  ;=============================================================================
   845                                  ; 21/09/2018 - Retro DOS v3.0
   846                                  
   847                                  ;	page ,132
   848                                  ;	title	COMMAND - resident code for COMMAND.COM
   849                                  ;	name	COMMAND
   850                                  
   851                                  ;/*
   852                                  ; *                      Microsoft Confidential
   853                                  ; *                      Copyright (C) Microsoft Corporation 1991
   854                                  ; *                      All Rights Reserved.
   855                                  ; */
   856                                  
   857                                  ;*****************************************************************************
   858                                  ;
   859                                  ; MODULE:	       COMMAND.COM
   860                                  ;
   861                                  ; DESCRIPTIVE NAME:    Default DOS command interpreter
   862                                  ;
   863                                  ; FUNCTION:	       This version of COMMAND is divided into three distinct
   864                                  ;		       parts.  First is the resident portion, which includes
   865                                  ;		       handlers for interrupts	23H (Cntrl-C), 24H (fatal
   866                                  ;		       error), and 2EH (command line execute); it also has
   867                                  ;		       code to test and, if necessary, reload the transient
   868                                  ;		       portion. Following the resident is the init code, which
   869                                  ;		       is overwritten after use.  Then comes the transient
   870                                  ;		       portion, which includes all command processing (whether
   871                                  ;		       internal or external).  The transient portion loads at
   872                                  ;		       the end of physical memory, and it may be overlayed by
   873                                  ;		       programs that need as much memory as possible. When the
   874                                  ;		       resident portion of command regains control from a user
   875                                  ;		       program, a check sum is performed on the transient
   876                                  ;		       portion to see if it must be reloaded.  Thus programs
   877                                  ;		       which do not need maximum memory will save the time
   878                                  ;		       required to reload COMMAND when they terminate.
   879                                  ;
   880                                  ; ENTRY POINT:	       PROGSTART
   881                                  ;
   882                                  ; INPUT:	       command line at offset 81H
   883                                  ;
   884                                  ; EXIT_NORMAL:	       No exit from root level command processor.  Can exit
   885                                  ;		       from a secondary command processor via the EXIT
   886                                  ;		       internal command.
   887                                  ;
   888                                  ; EXIT_ERROR:	       Exit to prior command processor if possible, otherwise
   889                                  ;		       hang the system.
   890                                  ;
   891                                  ; INTERNAL REFERENCES:
   892                                  ;
   893                                  ;     ROUTINES:        See the COMMAND Subroutine Description Document
   894                                  ;		       (COMMAND.DOC)
   895                                  ;
   896                                  ;     DATA AREAS:      See the COMMAND Subroutine Description Document
   897                                  ;		       (COMMAND.DOC)
   898                                  ;
   899                                  ; EXTERNAL REFERENCES:
   900                                  ;
   901                                  ;      ROUTINES:       none
   902                                  ;
   903                                  ;      DATA AREAS:     none
   904                                  ;
   905                                  ;*****************************************************************************
   906                                  ;
   907                                  ;			      REVISION HISTORY
   908                                  ;			      ----------------
   909                                  ;
   910                                  ; DOS 1.00 to DOS 3.30
   911                                  ; --------------------------
   912                                  ; SEE REVISION LOG IN COPY.ASM ALSO
   913                                  ;
   914                                  ; REV 1.17
   915                                  ;    05/19/82  Fixed bug in BADEXE error (relocation error must return to
   916                                  ;	       resident since the EXELOAD may have overwritten the transient.
   917                                  ;
   918                                  ; REV 1.18
   919                                  ;    05/21/82  IBM version always looks on drive A
   920                                  ;	       MSVER always looks on default drive
   921                                  ;
   922                                  ; REV 1.19
   923                                  ;    06/03/82  Drive spec now entered in command line
   924                                  ;    06/07/82  Added VER command (print DOS version number) and VOL command
   925                                  ;	       (print volume label)
   926                                  ;
   927                                  ; REV 1.20
   928                                  ;    06/09/82  Prints "directory" after directories
   929                                  ;    06/13/82  MKDIR, CHDIR, PWD, RMDIR added
   930                                  ;
   931                                  ; REV 1.50
   932                                  ;	       Some code for new 2.0 DOS, sort of HACKey.  Not enough time to
   933                                  ;	       do it right.
   934                                  ;
   935                                  ; REV 1.70
   936                                  ;	       EXEC used to fork off new processes
   937                                  ;
   938                                  ; REV 1.80
   939                                  ;	       C switch for single command execution
   940                                  ;
   941                                  ; REV 1.90
   942                                  ;	       Batch uses XENIX
   943                                  ;
   944                                  ; Rev 2.00
   945                                  ;	       Lots of neato stuff
   946                                  ;	       IBM 2.00 level
   947                                  ;
   948                                  ; Rev 2.01
   949                                  ;	       'D' switch for date time suppression
   950                                  ;
   951                                  ; Rev 2.02
   952                                  ;	       Default userpath is NUL rather than BIN
   953                                  ;		       same as IBM
   954                                  ;	       COMMAND split into pieces
   955                                  ;
   956                                  ; Rev 2.10
   957                                  ;	       INTERNATIONAL SUPPORT
   958                                  ;
   959                                  ; Rev 2.50
   960                                  ;	       all the 2.x new stuff -MU
   961                                  ;
   962                                  ; Rev 3.30     (Ellen G)
   963                                  ;	       CALL internal command (TBATCH2.ASM)
   964                                  ;	       CHCP internal command (TCMD2B.ASM)
   965                                  ;	       INT 24H support of abort, retry, ignore, and fail prompt
   966                                  ;	       @ sign suppression of batch file line
   967                                  ;	       Replaceable environment value support in batch files
   968                                  ;	       INT 2FH calls for APPEND
   969                                  ;	       Lots of PTR fixes!
   970                                  ;
   971                                  ; Beyond 3.30 to forever  (Ellen G)
   972                                  ; ----------------------
   973                                  ;
   974                                  ; A000 DOS 4.00  -	Use SYSPARSE for internal commands
   975                                  ;			Use Message Retriever services
   976                                  ;			/MSG switch for resident extended error msg
   977                                  ;			Convert to new capitalization support
   978                                  ;			Better error recovery on CHCP command
   979                                  ;			Code page file tag support
   980                                  ;			TRUENAME internal command
   981                                  ;			Extended screen line support
   982                                  ;			/P switch on DEL/ERASE command
   983                                  ;			Improved file redirection error recovery
   984                                  ;	(removed)	Improved batch file performance
   985                                  ;			Unconditional DBCS support
   986                                  ;			Volume serial number support
   987                                  ;	(removed)	COMMENT=?? support
   988                                  ;
   989                                  ; A001	PTM P20 	Move system_cpage from TDATA to TSPC
   990                                  ;
   991                                  ; A002	PTM P74 	Fix PRESCAN so that redirection symbols do not
   992                                  ;			require delimiters.
   993                                  ;
   994                                  ; A003	PTM P5,P9,P111	Included in A000 development
   995                                  ;
   996                                  ; A004	PTM P86 	Fix IF command to turn off piping before
   997                                  ;			executing
   998                                  ;
   999                                  ; A005	DCR D17 	If user specifies an extension on the command
  1000                                  ;			line search for that extension only.
  1001                                  ;
  1002                                  ; A006	DCR D15 	New message for MkDir - "Directory already
  1003                                  ;			exists"
  1004                                  ;
  1005                                  ; A007	DCR D2		Change CTTY so that a write is done before XDUP
  1006                                  ;
  1007                                  ; A008	PTM P182	Change COPY to set default if invalid function
  1008                                  ;			returned from code page call.
  1009                                  ;
  1010                                  ; A009	PTM P179	Add CRLF to invalid disk change message
  1011                                  ;
  1012                                  ; A010	DCR D43 	Allow APPEND to do a far call to SYSPARSE in
  1013                                  ;			transient COMMAND.
  1014                                  ;
  1015                                  ; A011	DCR D130	Change redirection to overwrite an EOF mark
  1016                                  ;			before appending to a file.
  1017                                  ;
  1018                                  ; A012	PTM P189	Fix redirection error recovery.
  1019                                  ;
  1020                                  ; A013	PTM P330	Change date format
  1021                                  ;
  1022                                  ; A014	PTM P455	Fix echo parsing
  1023                                  ;
  1024                                  ; A015	PTM P517	Fix DIR problem with * vs *.
  1025                                  ;
  1026                                  ; A016	PTM P354	Fix extended error message addressing
  1027                                  ;
  1028                                  ; A017	PTM P448	Fix appending to 0 length files
  1029                                  ;
  1030                                  ; A018	PTM P566,P3903	Fix parse error messages to print out parameter
  1031                                  ;			the parser fails on. Fail on duplicate switches.
  1032                                  ;
  1033                                  ; A019	PTM P542	Fix device name to be printed correctly during
  1034                                  ;			critical error
  1035                                  ;
  1036                                  ; A020	DCR D43 	Set append state off while in DIR
  1037                                  ;
  1038                                  ; A021	PTM P709	Fix CTTY printing ascii characters.
  1039                                  ;
  1040                                  ; A022	DCR D209	Enhanced error recovery
  1041                                  ;
  1042                                  ; A023	PTM P911	Fix ANSI.SYS IOCTL structure.
  1043                                  ;
  1044                                  ; A024	PTM P899	Fix EXTOPEN open modes.
  1045                                  ;
  1046                                  ; A025	PTM P922	Fix messages and optimize PARSE switches
  1047                                  ;
  1048                                  ; A026	DCR D191	Change redirection error recovery support.
  1049                                  ;
  1050                                  ; A027	PTM P991	Fix so that KAUTOBAT & AUTOEXEC are terminated
  1051                                  ;			with a carriage return.
  1052                                  ;
  1053                                  ; A028	PTM P1076	Print a blank line before printing invalid
  1054                                  ;			date and invalid time messages.
  1055                                  ;
  1056                                  ; A029	PTM P1084	Eliminate calls to parse_check_eol in DATE
  1057                                  ;			and TIME.
  1058                                  ;
  1059                                  ; A030	DCR D201	New extended attribute format.
  1060                                  ;
  1061                                  ; A031	PTM P1149	Fix DATE/TIME add blank before prompt.
  1062                                  ;
  1063                                  ; A032	PTM P931	Fix =ON, =OFF for BREAK, VERIFY, ECHO
  1064                                  ;
  1065                                  ; A033	PTM P1298	Fix problem with system crashes on ECHO >""
  1066                                  ;
  1067                                  ; A034	PTM P1387	Fix COPY D:fname+,, to work
  1068                                  ;
  1069                                  ; A035	PTM P1407	Fix so that >> (appending) to a device does
  1070                                  ;			do a read to determine eof.
  1071                                  ;
  1072                                  ; A036	PTM P1406	Use 69h instead of 44h to get volume serial
  1073                                  ;			so that ASSIGN works correctly.
  1074                                  ;
  1075                                  ; A037	PTM P1335	Fix COMMAND /C with FOR
  1076                                  ;
  1077                                  ; A038	PTM P1635	Fix COPY so that it doesn't accept /V /V
  1078                                  ;
  1079                                  ; A039	DCR D284	Change invalid code page tag from -1 to 0.
  1080                                  ;
  1081                                  ; A040	PTM P1787	Fix redirection to cause error when no file is
  1082                                  ;			specified.
  1083                                  ;
  1084                                  ; A041	PTM P1705	Close redirected files after internal APPEND
  1085                                  ;			executes.
  1086                                  ;
  1087                                  ; A042	PTM P1276	Fix problem of APPEND paths changes in batch
  1088                                  ;			files causing loss of batch file.
  1089                                  ;
  1090                                  ; A043	PTM P2208	Make sure redirection is not set up twice for
  1091                                  ;			CALL'ed batch files.
  1092                                  ;
  1093                                  ; A044	PTM P2315	Set switch on PARSE so that 0ah is not used
  1094                                  ;			as an end of line character
  1095                                  ;
  1096                                  ; A045	PTM P2560	Make sure we don't lose parse, critical error,
  1097                                  ;			and extended message pointers when we EXIT if
  1098                                  ;			COMMAND /P is the top level process.
  1099                                  ;
  1100                                  ; A046	PTM P2690	Change COPY message "fn File not found" to
  1101                                  ;			"File not found - fn"
  1102                                  ;
  1103                                  ; A047	PTM P2819	Fix transient reload prompt message
  1104                                  ;
  1105                                  ; A048	PTM P2824	Fix COPY path to be upper cased.  This was broken
  1106                                  ;			when DBCS code was added.
  1107                                  ;
  1108                                  ; A049	PTM P2891	Fix PATH so that it doesn't accept extra characters
  1109                                  ;			on line.
  1110                                  ;
  1111                                  ; A050	PTM P3030	Fix TYPE to work properly on files > 64K
  1112                                  ;
  1113                                  ; A051	PTM P3011	Fix DIR header to be compatible with prior releases.
  1114                                  ;
  1115                                  ; A052	PTM P3063,P3228 Fix COPY message for invalid filename on target.
  1116                                  ;
  1117                                  ; A053	PTM P2865	Fix DIR to work in 40 column mode.
  1118                                  ;
  1119                                  ; A054	PTM P3407	Code reduction and critical error on single line
  1120                                  ;	PTM P3672	(Change to single parser exported under P3407)
  1121                                  ;
  1122                                  ; A055	PTM P3282	Reset message service variables in INT 23h to fix
  1123                                  ;			problems with breaking out of INT 24h
  1124                                  ;
  1125                                  ; A056	PTM P3389	Fix problem of environment overlaying transient.
  1126                                  ;
  1127                                  ; A057	PTM P3384	Fix COMMAND /C so that it works if there is no space
  1128                                  ;			before the "string".  EX: COMMAND /CDIR
  1129                                  ;
  1130                                  ; A058	PTM P3493	Fix DBCS so that CPARSE eats second character of
  1131                                  ;			DBCS switch.
  1132                                  ;
  1133                                  ; A059	PTM P3394	Change the TIME command to right align the display of
  1134                                  ;			the time.
  1135                                  ;
  1136                                  ; A060	PTM P3672	Code reduction - change PARSE and EXTENDED ERROR
  1137                                  ;			messages to be disk based.  Only keep them if /MSG
  1138                                  ;			is used.
  1139                                  ;
  1140                                  ; A061	PTM P3928	Fix so that transient doesn't reload when breaking
  1141                                  ;			out of internal commands, due to substitution blocks
  1142                                  ;			not being reset.
  1143                                  ;
  1144                                  ; A062	PTM P4079	Fix segment override for fetching address of environment
  1145                                  ;			of parent copy of COMMAND when no COMSPEC exists in
  1146                                  ;			secondary copy of environment.	Change default slash in
  1147                                  ;			default comspec string to backslash.
  1148                                  ;
  1149                                  ; A063	PTM P4140	REDIRECTOR and IFSFUNC changed interface for getting
  1150                                  ;			text for critical error messages.
  1151                                  ;
  1152                                  ; A064	PTM P4934	Multiplex number for ANSI.SYS changed due to conflict
  1153                                  ;	5/20/88 	with Microsoft product already shipped.
  1154                                  ;
  1155                                  ; A065	PTM P4935	Multiplex number for SHELL changed due to conflict
  1156                                  ;	 5/20/88	with Microsoft product already shipped.
  1157                                  ;
  1158                                  ; A066	PTM P4961	DIR /W /P scrolled first line off the screen in some
  1159                                  ;	 5/24/88	cases; where the listing would barely fit without the
  1160                                  ;			header and space remaining.
  1161                                  ;
  1162                                  ; A067	PTM P5011	For /E: values of 993 to 1024 the COMSPEC was getting
  1163                                  ;	 6/6/88 	trashed.  Turns out that the SETBLOCK for the new
  1164                                  ;			environment was putting a "Z block" marker in the old
  1165                                  ;			environment.  The fix is to move to the old environment
  1166                                  ;			to the new environment before doing the SETBLOCK.
  1167                                  ;
  1168                                  ; A068  PTM P5568       IR79754 APPEND /x:on not working properly with DIR/VOL
  1169                                  ;        09/19/88       because the check for APPEND needed to be performed
  1170                                  ;                       before the DIR's findfirst.
  1171                                  ;
  1172                                  ; A069  PTM P5726       IR80540 COMSPEC_flag not properly initialized and
  1173                                  ;        10/30/88       executed.  Causing AUSTIN problem testing LAN/DW4 re-
  1174                                  ;                       loading trans w/new comspec with no user change comspec.
  1175                                  ;
  1176                                  ; A070  PTM P5734       IR80484 Batch file causes sys workspace to be corrupted.
  1177                                  ;        11/05/88       Expansion of environment variables into batch line of
  1178                                  ;                       128 chars was not being counted and "%" which should be
  1179                                  ;                       ignored were being counted.
  1180                                  ;
  1181                                  ; A071  PTM P5854       IR82061 Invalid COMMAND.COM when Word Perfect, Prompt
  1182                                  ;        03/02/89       used.  Comspec_flag was not in protected data file be-
  1183                                  ;                       ing included in checksum and was being overwritten by
  1184                                  ;                       WP.  Moved var from Tspc to Tdata so Trans would reload.
  1185                                  ;                       Also removed fix A069 (because flag now protected).
  1186                                  ;
  1187                                  ; C001  VERSION 4.1     Add new internal command - SERVICE - to display the DOS
  1188                                  ;        07/25/89       version and CSD version in U.S. date format.  Files
  1189                                  ;                       changed - TRANMSG,.SKL,COMMAND1,TDATA,TCMD2A,USA.MSG
  1190                                  ;
  1191                                  ;***********************************************************************************
  1192                                  
  1193                                  ;
  1194                                  ;	Revision History
  1195                                  ;	================
  1196                                  ;
  1197                                  ;	M021	SR	08/23/90	Fixed Ctrl-C handler to handle Ctrl-C
  1198                                  ;					at init time (date/time prompt)
  1199                                  ;
  1200                                  
  1201                                  ;
  1202                                  ;.xcref
  1203                                  ;.xlist
  1204                                  ;	include dossym.inc		; basic DOS symbol set
  1205                                  ;	include syscall.inc		; DOS function names
  1206                                  ;	include comsw.asm		; build version info
  1207                                  ;	include comequ.asm		; common command.com symbols
  1208                                  ;	include resmsg.equ		; resident message names
  1209                                  ;
  1210                                  ;	include comseg.asm		;segment ordering
  1211                                  ;.list
  1212                                  ;.cref
  1213                                  
  1214                                  ;CODERES segment public byte
  1215                                  ;CODERES ends
  1216                                  ;
  1217                                  ;DATARES 	segment public byte
  1218                                  ;		extrn	AccDen:byte
  1219                                  ;		extrn	Batch:word
  1220                                  ;		extrn	EchoFlag:byte
  1221                                  ;		extrn	ExeBad:byte
  1222                                  ;		extrn	ExecEMes:byte
  1223                                  ;		extrn	ExecErrSubst:byte
  1224                                  ;		extrn	ExtCom:byte
  1225                                  ;		extrn	ForFlag:byte
  1226                                  ;		extrn	IfFlag:byte
  1227                                  ;		extrn	InitFlag:BYTE
  1228                                  ;		extrn	Nest:word
  1229                                  ;		extrn	PipeFlag:byte
  1230                                  ;		extrn	RBadNam:byte
  1231                                  ;		extrn	RetCode:word
  1232                                  ;		extrn	SingleCom:word
  1233                                  ;		extrn	TooBig:byte
  1234                                  ;
  1235                                  ;		extrn	OldDS:word
  1236                                  ;
  1237                                  ;DATARES 	ends
  1238                                  ;
  1239                                  ;
  1240                                  ;INIT		segment public para
  1241                                  ;		extrn	ConProc:near
  1242                                  ;		extrn	Init_Contc_SpecialCase:near
  1243                                  ;INIT		ends
  1244                                  
  1245                                  ; 09/01/2023 - Erdogan Tan - Istanbul
  1246                                  ; --------------------------------------
  1247                                  ; 'command5.s' source code reference(s):
  1248                                  
  1249                                  ;	1) MSDOS 6.0 COMMAND.COM source files
  1250                                  ;	2) Disassembled MSDOS 5.0 COMMAND.COM - 11/11/1991 - 47845 bytes  
  1251                                  ;	   (Disassembler: HEX-RAYS IDA Pro Freeware Version 5.0)
  1252                                  ; ----------------------------------------------------------------------				 	 	
  1253                                  
  1254                                  ; -----------------------------------------------------------------------------
  1255                                  ; START OF RESIDENT PORTION
  1256                                  ; -----------------------------------------------------------------------------
  1257                                  ; SEGMENT - DATARES
  1258                                  ; -----------------------------------------------------------------------------
  1259                                  
  1260                                  section .RESGROUP ; vstart=100h  ; 09/01/2023 - Retro DOS v4.0 (& v4.1) 
  1261                                  
  1262                                  ; 09/01/2023 - Retro DOS v4.0 (Modified COMMAND.COM v5.0)
  1263                                  
  1264                                  ;==============================================================================
  1265                                  ; STUB.ASM - MSDOS 6.0 - 1991
  1266                                  ;==============================================================================
  1267                                  
  1268                                  ;This file contains the low memory stub for command.com which hooks all the
  1269                                  ;entry points into the resident command.com and directs the calls to the
  1270                                  ;appropriate routines in the resident code which may be located in HIMEM. 
  1271                                  ;
  1272                                  ;The stub has been made part of the resident data and will always
  1273                                  ;be duplicated on every invocation of command.com. However, the only stubs
  1274                                  ;that actually hook the interrupt vectors belong to either the first 
  1275                                  ;command.com or to any other command.com executed with the /p switch. 
  1276                                  ;
  1277                                  ;The stub also keeps track of the current active data segment. The 
  1278                                  ;INIT code of each command.com updates this variable via an int 2fh mechanism
  1279                                  ;with its own data segment. The INIT code also updates a pointer in its data
  1280                                  ;segment to the previous resident data segment. Whenever a command.com exits,
  1281                                  ;the exit code picks up the previous data segment pointer from the current
  1282                                  ;data segment and patches it into the CurResDataSeg variable in the stub.
  1283                                  ;
  1284                                  ;Right now the stub does not bother about A20 switching. We assume
  1285                                  ;A20 is always on. It just does a far jump to the resident code with the 
  1286                                  ;value of the current data segment in one of the registers. A20 toggle 
  1287                                  ;support maybe added as a future enhancement, if the need is felt.
  1288                                  
  1289                                  	; 09/01/2023 - Retro DOS v4.0 (& v4.1)
  1290                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  1291                                  
  1292                                  	; 18/07/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
  1293                                  
  1294                                  	[ORG 100H]
  1295                                  
  1296                                  	; 21/09/2018 - Retro DOS v3.0
  1297                                  StartCode:
  1298 00000000 E98D15                  	jmp	ConProc	; 10/01/2023 
  1299                                  
  1300                                  	; 09/01/2023
  1301                                  
  1302                                  ; Make following table word-aligned, and at the same time, provide a
  1303                                  ; signature that sysinit can use to (attempt to) validate the interpreter
  1304                                  
  1305                                  	;db	0	; MSDOS 5.0 COMMAND.COM - DATARES:0103h
  1306                                  	;db	7Ah	; PCDOS 7.10 (7.1) COMMAND.COM ; 18/07/2024
  1307 00000003 7A                      	db      ((MAJOR_VERSION&0Fh)<<4)|(MINOR_VERSION&0Fh)
  1308                                  
  1309                                  word_104:
  1310 00000004 0000                    	dw	0	; PCDOS 7.1 COMMAND.COM - DATARES:0104h
  1311                                  ;RESGROUP:0106h
  1312 00000006 000000000000000000-     	db	0Ch dup(0), 0Dh
  1312 0000000F 0000000D           
  1313                                  ;RESGROUP:0113h
  1314                                  a@Ibm12_01_2003:
  1315 00000013 402349424D3A31322E-     	db '@#IBM:12.01.2003.build_1.32#@ COMMAND.COM(USA)',0
  1315 0000001C 30312E323030332E62-
  1315 00000025 75696C645F312E3332-
  1315 0000002E 234020434F4D4D414E-
  1315 00000037 442E434F4D28555341-
  1315 00000040 2900               
  1316                                  ;RESGROUP:0142h:
  1317 00000042 000000000000000000-     	db 22h dup(0), 1Ah, 0
  1317 0000004B 000000000000000000-
  1317 00000054 000000000000000000-
  1317 0000005D 000000000000001A00 
  1318                                  
  1319                                  ;All the entry points declared below are patched in at INIT time with the
  1320                                  ;proper segment and offset values after the resident code segment has been
  1321                                  ;moved to its final location
  1322                                  
  1323                                  ;!!!WARNING!!!
  1324                                  ; All the dword ptrs from Int2f_Entry till MsgRetrv_Entry should be contiguous
  1325                                  ;because the init routine 'Patch_stub' (in init.asm) relies on this to patch
  1326                                  ;in the correct segments and offsets
  1327                                  
  1328                                  Int2f_Entry:
  1329 00000066 [A014]                  	dw	MsgInt2fHandler		; Address of int 2fh handler
  1330 00000068 0000                    	dw	0
  1331                                  Int2e_Entry:
  1332 0000006A [860E]                  	dw	Int_2e			; Address of int 2eh handler
  1333 0000006C 0000                    	dw	0
  1334                                  Ctrlc_Entry:
  1335 0000006E [430D]                  	dw	ContC			; Address of Ctrl-C handler
  1336 00000070 0000                    	dw	0
  1337                                  CritErr_Entry:
  1338 00000072 [8B11]                  	dw	DSKERR			; Address of critical error handler
  1339 00000074 0000                    	dw	0
  1340                                  
  1341                                  Exec_Entry:
  1342 00000076 00000000                	dd	0			; Entry from transient to Ext_Exec
  1343                                  RemCheck_Entry:
  1344 0000007A 00000000                	dd	0			; Entry from transient to TRemCheck
  1345                                  TrnLodCom1_Entry:
  1346 0000007E 00000000                	dd	0			; Entry from transient to LodCom1
  1347                                  LodCom_Entry:
  1348 00000082 00000000                	dd	0			; Entry after exit from command.com
  1349                                  MsgRetrv_Entry:
  1350 00000086 00000000                	dd	0			; Entry from external to MsgRetriever
  1351                                  HeadFix_Entry:
  1352 0000008A 00000000                	dd	0			; Entry from trans to HeadFix
  1353                                  UMBOff_Entry:
  1354 0000008E 00000000                	dd	0			; Entry from here to UMBOff routine; M003
  1355                                  XMMCallAddr:
  1356 00000092 00000000                	dd	0			; Call address for XMM functions
  1357                                  ComInHMA:
  1358 00000096 00                      	db	0			; Flags if command.com in HMA
  1359                                  
  1360                                  ; 18/07/2024 (PCDOS 7.1 COMMAND.COM - RESGROUP:0197h)
  1361                                  
  1362                                  Int2f_Trap:
  1363                                  	;sti	; 19/04/2023 (MSDOS 5.0 COMMAND.COM - RESGROUP:0135h)
  1364 00000097 E86400                  	call	CheckA20
  1365 0000009A 1E                      	push	ds			; push current ds value
  1366 0000009B 0E                      	push	cs			; push resident data segment value
  1367                                  	;jmp	cs:Int2f_Entry
  1368 0000009C 2EFF2E[6600]            	jmp	far [cs:Int2f_Entry]
  1369                                  
  1370                                  Int2e_Trap:
  1371 000000A1 FB                      	sti
  1372 000000A2 E85900                  	call	CheckA20
  1373 000000A5 1E                      	push	ds			; push current ds value
  1374 000000A6 0E                      	push	cs			; push resident data segment value
  1375                                  	;jmp	cs:Int2e_Entry
  1376 000000A7 2EFF2E[6A00]            	jmp	far [cs:Int2e_Entry]
  1377                                  
  1378                                  Ctrlc_Trap:
  1379 000000AC FB                      	sti
  1380 000000AD E84E00                  	call	CheckA20
  1381 000000B0 1E                      	push	ds			; push current ds value
  1382 000000B1 0E                      	push	cs			; push resident data segment value
  1383                                  	;jmp	cs:Ctrlc_Entry
  1384 000000B2 2EFF2E[6E00]            	jmp	far [cs:Ctrlc_Entry]
  1385                                  
  1386                                  CritErr_Trap:
  1387 000000B7 FB                      	sti
  1388 000000B8 E84300                  	call	CheckA20
  1389 000000BB 1E                      	push	ds			; push current ds value
  1390 000000BC 0E                      	push	cs			; push resident data segment value
  1391                                  	;jmp	cs:CritErr_Entry
  1392 000000BD 2EFF2E[7200]            	jmp	far [cs:CritErr_Entry]
  1393                                  
  1394                                  Exec_Trap:
  1395 000000C2 E83900                  	call	CheckA20
  1396 000000C5 1E                      	push	ds			; push current ds value
  1397 000000C6 0E                      	push	cs			; push resident data segment value
  1398                                  	;jmp	cs:Exec_Entry
  1399 000000C7 2EFF2E[7600]            	jmp	far [cs:Exec_Entry]
  1400                                  
  1401                                  RemCheck_Trap:
  1402 000000CC E82F00                  	call	CheckA20
  1403 000000CF 1E                      	push	ds			; push current ds value
  1404 000000D0 0E                      	push	cs			; push resident data segment value
  1405                                  	;jmp	cs:RemCheck_Entry
  1406 000000D1 2EFF2E[7A00]            	jmp	far [cs:RemCheck_Entry]
  1407                                  
  1408                                  TrnLodCom1_Trap:
  1409 000000D6 E82500                  	call	CheckA20
  1410 000000D9 1E                      	push	ds			; push current ds value
  1411 000000DA 0E                      	push	cs			; push resident data segment value
  1412                                  	;jmp	cs:TrnLodCom1_Entry
  1413 000000DB 2EFF2E[7E00]            	jmp	far [cs:TrnLodCom1_Entry]
  1414                                  
  1415                                  LodCom_Trap:
  1416 000000E0 E81B00                  	call	CheckA20
  1417 000000E3 1E                      	push	ds			; push current ds value
  1418 000000E4 0E                      	push	cs			; push resident data segment value
  1419                                  	;jmp	cs:LodCom_Entry
  1420 000000E5 2EFF2E[8200]            	jmp	far [cs:LodCom_Entry]
  1421                                  
  1422                                  MsgRetrv_Trap:
  1423 000000EA E81100                  	call	CheckA20
  1424 000000ED 1E                      	push	ds			; push current ds value
  1425 000000EE 0E                      	push	cs			; push resident data segment value
  1426                                  	;jmp	cs:MsgRetrv_Entry
  1427 000000EF 2EFF2E[8600]            	jmp	far [cs:MsgRetrv_Entry]
  1428                                  
  1429                                  HeadFix_Trap:
  1430 000000F4 E80700                  	call	CheckA20
  1431 000000F7 1E                      	push	ds			; push current ds value
  1432 000000F8 0E                      	push	cs			; push resident data segment value
  1433                                  	;jmp	cs:HeadFix_Entry
  1434 000000F9 2EFF2E[8A00]            	jmp	far [cs:HeadFix_Entry]
  1435                                  
  1436                                  ; ----------------------------------------------------------------------------
  1437                                  
  1438                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  1439                                  %if 0
  1440                                  	; 09/01/2023
  1441                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:019Dh
  1442                                  
  1443                                  	; 05/06/2023
  1444                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:019Ch
  1445                                  CheckA20:
  1446                                  	pushf				; save current flags
  1447                                  	cmp	byte [cs:ComInHMA],0	; is resident in HMA?
  1448                                  	jz	short A20_on		; no, jump to resident
  1449                                  
  1450                                  	call	QueryA20
  1451                                  	jnc	short A20_on		; A20 is on, jump to resident
  1452                                  
  1453                                  	call	EnableA20		; turn A20 on
  1454                                  A20_on:
  1455                                  	popf				; flags have to be unchanged
  1456                                  	retn
  1457                                  %else
  1458                                  	; 18/07/2024
  1459                                  	XMM_QUERY_A20 equ 7 ; 09/01/2023
  1460                                  	XMM_LOCAL_ENABLE_A20 equ 5
  1461                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:01FFh
  1462                                  CheckA20:
  1463 000000FE 9C                      	pushf				; save current flags
  1464 000000FF 2E803E[9600]00          	cmp	byte [cs:ComInHMA],0	; is resident in HMA?
  1465 00000105 741A                    	jz	short A20_on		; no, jump to resident
  1466                                  	; 18/07/2024
  1467 00000107 50                      	push	ax
  1468 00000108 53                      	push	bx
  1469                                  QueryA20:
  1470                                  	;mov	ah,7
  1471 00000109 B407                    	mov	ah,XMM_QUERY_A20
  1472                                  	;call	cs:XMMCallAddr
  1473 0000010B 2EFF1E[9200]            	call	far [cs:XMMCallAddr]
  1474 00000110 09C0                    	or	ax,ax
  1475                                  	; 16/04/2023
  1476 00000112 750B                    	jnz	short QA20_ON		; A20 is on, jump to resident
  1477                                  	; 18/07/2024
  1478                                  EnableA20:
  1479                                  	;mov	ah,5
  1480 00000114 B405                    	mov	ah,XMM_LOCAL_ENABLE_A20	; turn A20 on
  1481                                  	;call	cs:XMMCallAddr
  1482 00000116 2EFF1E[9200]            	call	far [cs:XMMCallAddr]
  1483 0000011B 09C0                    	or	ax,ax
  1484 0000011D 7404                    	jz	short XMMerror		; AX = 0 fatal error
  1485                                  QA20_ON:
  1486 0000011F 5B                      	pop	bx
  1487 00000120 58                      	pop	ax
  1488                                  A20_on:
  1489 00000121 9D                      	popf				; flags have to be unchanged
  1490 00000122 C3                      	retn
  1491                                  ;If we get an error, we just loop forever
  1492                                  XMMerror:
  1493 00000123 EBFE                    	jmp	short XMMerror
  1494                                  %endif
  1495                                  
  1496                                  ; ----------------------------------------------------------------------------
  1497                                  
  1498                                  ; M005; This is a far jump to the actual int 2fh entry point. The renormalized
  1499                                  ; M005; int 2fh cs:ip points here. We hardcode a far jump here to the int 2fh
  1500                                  ; M005; handler. Note that we have to hardcode a jump and we cannot use any
  1501                                  ; M005; pointers because our cs is going to be different. The segment to
  1502                                  ; M005; jump to is patched in at init time. (in init.asm)
  1503                                  
  1504                                  Carousel_i2f_Hook:			; M005
  1505 00000125 EA                      	db	0EAh			; far jump opcode; M005
  1506 00000126 [9700]                  	dw	Int2f_Trap ; DATARES	; int 2fh offset ; M005
  1507                                  int2fh_segm:	; 22/07/2024
  1508 00000128 0000                    	dw	0			; int 2fh segment; M005
  1509                                  
  1510                                  ; ----------------------------------------------------------------------------
  1511                                  
  1512                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  1513                                  %if 0
  1514                                  	XMM_QUERY_A20 equ 7 ; 09/01/2023
  1515                                  QueryA20:
  1516                                  	push	bx
  1517                                  	push	ax
  1518                                  	;mov	ah,7
  1519                                  	mov	ah,XMM_QUERY_A20
  1520                                  	;call	cs:XMMCallAddr
  1521                                  	call	far [cs:XMMCallAddr]
  1522                                  	or	ax,ax
  1523                                  	pop	ax
  1524                                  	pop	bx
  1525                                  	; 16/04/2023
  1526                                  	jnz	short QA20_ON	; cf = 0	; AX = 1 => ON
  1527                                  	stc					; OFF
  1528                                  	;retn
  1529                                  QA20_ON:
  1530                                  	;clc					; ON
  1531                                  	retn
  1532                                  %endif
  1533                                  
  1534                                  ; ----------------------------------------------------------------------------
  1535                                  
  1536                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  1537                                  %if 0
  1538                                  	XMM_LOCAL_ENABLE_A20 equ 5
  1539                                  EnableA20:
  1540                                  	push	bx
  1541                                  	push	ax
  1542                                  	;mov	ah,5
  1543                                  	mov	ah,XMM_LOCAL_ENABLE_A20
  1544                                  	;call	cs:XMMCallAddr
  1545                                  	call	far [cs:XMMCallAddr]
  1546                                  	or	ax,ax
  1547                                  	jz	short XMMerror			; AX = 0 fatal error
  1548                                  	pop	ax
  1549                                  	pop	bx
  1550                                  	retn
  1551                                  ;If we get an error, we just loop forever
  1552                                  XMMerror:
  1553                                  	jmp	short XMMerror
  1554                                  %endif
  1555                                  
  1556                                  ; -----------------------------------------------------------------------------
  1557                                  
  1558                                  ; 05/06/2023
  1559                                  ;HV_Extern	equ	1
  1560                                  ;HV_LoadHigh	equ	1
  1561                                  ;HV_Stub	equ	1
  1562                                  ;	include	highvar.inc	; Make high-memory variables external here
  1563                                  ;	include	highexit.inc	; And add code for UnHideUMBs
  1564                                  
  1565                                  ;==============================================================================
  1566                                  ; HIGHEXIT.INC, MSDOS 6.0, 1992
  1567                                  ;==============================================================================
  1568                                  ; 05/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
  1569                                  
  1570                                  DOS_STRATEGY_GET equ  5800h	; Int 21h, Func 58h, Svc 0 = get alloc strategy
  1571                                  DOS_STRATEGY_SET equ  5801h	; Int 21h, Func 58h, Svc 1 = set alloc strategy
  1572                                  DOS_UMBLINK_GET	equ   5802h	; Int 21h, Func 58h, Svc 2 = get link state
  1573                                  DOS_UMBLINK_SET	equ   5803h	; Int 21h, Func 58h, Svc 3 = set link state
  1574                                  DOS_GET_LISTS	equ     52h	; Int 21h, Func 52h = get list of lists
  1575                                  
  1576                                  UMB_HeadIdx	equ     8Ch	; Offset from ES (after func52h) to get UMBHead
  1577                                  
  1578                                  	; 05/06/2023
  1579                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:01D9h
  1580                                  
  1581                                  ; -----------------------------------------------------------------------------
  1582                                  ;*** UnHideUMBs - Marks HIDDEN elements as FREE
  1583                                  ; -----------------------------------------------------------------------------
  1584                                  ; ENTRY:  None; perhaps, earlier, HideUMBs was called... if not, we have
  1585                                  ;               very little to do, as no elelments will be marked as HIDDEN.
  1586                                  ; EXIT:   Sets InHigh to zero; carry clear if HideUMBs was called earlier.
  1587                                  ; ERROR:  None
  1588                                  ; USES:   fInHigh (from highvar.inc), carry flag
  1589                                  ; -----------------------------------------------------------------------------
  1590                                  
  1591                                  UnHideUMBs:
  1592 0000012A 50                      	push	ax		; Save ax for what we're about to do
  1593                                  
  1594                                  ; -----------------------------------------------------------------------------
  1595                                  ; BUGBUG t-richj 11-8-92: The following six lines were commented out for a good
  1596                                  ;    length of time. Those six constitute a check of whether or not we should
  1597                                  ;    indeed clean up the upper-memory chain; without such a check, COMMAND.COM
  1598                                  ;    will destroy the current link-state and memory-allocation strategy after
  1599                                  ;    every command execution.
  1600                                  ; -----------------------------------------------------------------------------
  1601                                  
  1602                                  	; 05/06/2023
  1603                                  	;getdata al,fInHigh	; Get InHigh from data segment
  1604                                  	;
  1605                                  	;push	ds
  1606 0000012B A0[3005]                	mov	al,[fInHigh]
  1607                                  	;pop	ds
  1608                                  
  1609                                  	;or	al, al
  1610                                  	;jnz	short uhu10	; If didn't call loadhigh/devicehigh earlier,
  1611                                  
  1612                                  	;pop	ax		; then there's nothing to do here... so
  1613                                  	;stc			; restore everything and return.  Just like
  1614                                  	;retn			; that.
  1615                                  
  1616                                  	; 05/06/2023
  1617 0000012E 3C01                    	cmp	al,1
  1618 00000130 720F                    	jb	short uhu20	; cf=1
  1619                                  uhu10:	
  1620 00000132 E8A000                  	call	linkumb		; Make sure UMBs are linked in.
  1621 00000135 E82000                  	call	FreeUMBs
  1622                                  
  1623                                  	;putdata fInHigh, 0	; We're leaving, so update fInHigh.
  1624                                  	;
  1625                                  	;push	es
  1626                                  	;mov	byte [es:fInHigh],0
  1627                                  	;pop	es
  1628                                  	; 05/06/2023
  1629 00000138 C606[3005]00            	mov	byte [fInHigh],0
  1630                                  
  1631 0000013D E80300                  	call	he_unlink	; Unlink UMBs
  1632                                  
  1633                                  	;pop	ax
  1634                                  	;clc
  1635                                  	;retn
  1636                                  
  1637 00000140 F8                      	clc
  1638                                  uhu20:
  1639 00000141 58                      	pop	ax
  1640 00000142 C3                      	retn
  1641                                  
  1642                                  ; -----------------------------------------------------------------------------
  1643                                  ;*** he_unlink - unlinks UMBs if fm_umb is set to 0
  1644                                  ; -----------------------------------------------------------------------------
  1645                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
  1646                                  ; EXIT:     None
  1647                                  ; ERROR:    None
  1648                                  ; USES:     AX, BX
  1649                                  ; -----------------------------------------------------------------------------
  1650                                  
  1651                                  	; 05/06/2023
  1652                                  he_unlink:
  1653 00000143 30FF                    	xor	bh, bh
  1654                                  	
  1655                                  	;getdata bl,fm_umb		; Restore original link-state
  1656                                  	;
  1657                                  	;push	ds
  1658 00000145 8A1E[3505]              	mov     bl,[fm_umb]
  1659                                  	;pop	ds
  1660                                  
  1661 00000149 B80358                  	mov	ax,DOS_UMBLINK_SET ; 5803h
  1662 0000014C CD21                    	int	21h
  1663                                  
  1664                                  	;xor	bh, bh
  1665                                  	
  1666                                  	;getdata bl,fm_strat		; Restore original mem-alloc strategy
  1667                                  	;push	ds
  1668 0000014E 8A1E[3605]              	mov     bl,[fm_strat]
  1669                                  	;pop	ds
  1670                                  
  1671 00000152 B80158                  	mov	ax,DOS_STRATEGY_SET ; 5801h
  1672 00000155 CD21                    	int	21h
  1673                                  
  1674 00000157 C3                      	retn
  1675                                  
  1676                                  ; -----------------------------------------------------------------------------
  1677                                  ;*** freeUMBs - frees all HIDDEN memory elements in upper-memory.
  1678                                  ; -----------------------------------------------------------------------------
  1679                                  ; ENTRY:    None
  1680                                  ; EXIT:     None; HIDDEN memory elements returned to FREE
  1681                                  ; ERROR:    None (ignore CF)
  1682                                  ; USES:     Flags
  1683                                  ; -----------------------------------------------------------------------------
  1684                                  
  1685                                  	; 05/06/2023
  1686                                  arena_signature_end equ 5Ah ; 'Z'
  1687                                  arena_signature equ 0
  1688                                  arena_size equ 3
  1689                                  
  1690                                  FreeUMBs:
  1691 00000158 50                      	push	ax
  1692 00000159 06                      	push	es
  1693                                  
  1694 0000015A E86900                  	call	HeadUmb		; Returns with carry if err, else ES == MCB
  1695 0000015D 721C                    	jc	short fusX
  1696                                  fus10:
  1697 0000015F 8EC0                    	mov	es,ax		; Prepare for the loop; ES = current MCB addr.
  1698 00000161 E81A00                  	call	isHideMCB	; Returns with ZF set if owner is 0
  1699 00000164 7503                    	jnz	short fus20
  1700 00000166 E84200                  	call	freeMCB
  1701                                  fus20:	
  1702 00000169 26A00000                	mov	al,[es:arena_signature] ; mov al,[es:0]
  1703 0000016D 3C5A                    	cmp	al,arena_signature_end ; 'Z' ; 5Ah
  1704 0000016F 740A                    	jz	short fusX	; That means this was the last MCB--that's it.
  1705                                  
  1706 00000171 8CC0                    	mov	ax,es
  1707 00000173 2603060300              	add	ax,[es:arena_size] ; add ax,[es:3]
  1708 00000178 40                      	inc	ax
  1709                                  	;mov	es,ax		; Go on forward.
  1710                                  	;jmp	short fus10
  1711                                  	; 18/07/2024
  1712 00000179 EBE4                    	jmp	short fus10
  1713                                  fusX:
  1714 0000017B 07                      	pop	es
  1715 0000017C 58                      	pop	ax
  1716 0000017D C3                      	retn
  1717                                  
  1718                                  ; -----------------------------------------------------------------------------
  1719                                  ;*** isHideMCB - returns with ZF set if current MCB (ES:0) is HIDDEN
  1720                                  ; -----------------------------------------------------------------------------
  1721                                  ; ENTRY:    ES:0 should point to an MCB
  1722                                  ; EXIT:     ZF set if MCB is hidden, else !ZF
  1723                                  ; ERROR:    None
  1724                                  ; USES:     Flags
  1725                                  ; -----------------------------------------------------------------------------
  1726                                  
  1727                                  	; 05/06/2023
  1728                                  SystemPSPOwner	equ 8
  1729                                  arena_owner	equ 1
  1730                                  arena_name	equ 8
  1731                                  
  1732                                  isHideMCB:
  1733 0000017E 50                      	push	ax
  1734                                  
  1735 0000017F 26833E010008            	cmp	word [es:arena_owner],SystemPSPOwner ; If the owner's SYSTEM
  1736 00000185 7522                    	jne	short ihm_x			     ; then check for HIDDEN
  1737                                  
  1738 00000187 26A10800                	mov	ax,[es:arena_name]   ; [es:8]
  1739 0000018B 3D4849                  	cmp	ax,'HI' ; 4948h
  1740 0000018E 7519                    	jne	short ihm_x
  1741 00000190 26A10A00                	mov	ax,[es:arena_name+2] ; [es:10]
  1742 00000194 3D4444                  	cmp	ax,'DD' ; 4444h
  1743 00000197 7510                    	jne	short ihm_x
  1744 00000199 26A10C00                	mov	ax,[es:arena_name+4] ; [es:12]
  1745 0000019D 3D454E                  	cmp	ax,'EN' ; 4E45h
  1746 000001A0 7507                    	jne	short ihm_x
  1747 000001A2 26A10E00                	mov	ax,[es:arena_name+6] ; [es:14]
  1748 000001A6 3D2020                  	cmp	ax,'  ' ; 2020h
  1749                                  ihm_x:
  1750 000001A9 58                      	pop	ax
  1751 000001AA C3                      	retn
  1752                                  
  1753                                  ; -----------------------------------------------------------------------------
  1754                                  ;*** freeMCB - marks as free the MCB at ES:0
  1755                                  ; -----------------------------------------------------------------------------
  1756                                  ; ENTRY:    ES:0 should point to an MCB
  1757                                  ; EXIT:     None; MCB free'd
  1758                                  ; ERROR:    None
  1759                                  ; USES:     AX
  1760                                  ; -----------------------------------------------------------------------------
  1761                                  
  1762                                  	; 05/06/2023
  1763                                  freeMCB:
  1764 000001AB 26C70601000000          	mov	word [es:arena_owner],0	; [es:1]
  1765 000001B2 B82020                  	mov	ax,'  '
  1766 000001B5 26A30800                	mov	[es:arena_name+0],ax	; [es:8]
  1767 000001B9 26A30A00                	mov	[es:arena_name+2],ax
  1768 000001BD 26A30C00                	mov	[es:arena_name+4],ax
  1769 000001C1 26A30E00                	mov	[es:arena_name+6],ax	; [es:14]
  1770 000001C5 C3                      	retn
  1771                                  
  1772                                  ; -----------------------------------------------------------------------------
  1773                                  ;*** HeadUmb - returns in AX the address of the first UMB block (0x9FFF)
  1774                                  ; -----------------------------------------------------------------------------
  1775                                  ; ENTRY:  Nothing
  1776                                  ; EXIT:   AX contains 0x9FFF for most systems
  1777                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
  1778                                  ; USES:   Flags, AX
  1779                                  ; -----------------------------------------------------------------------------
  1780                                  
  1781                                  	; 05/06/2023
  1782                                  HeadUmb:
  1783                                  	; 18/07/2024 - PCDOS 7.1 - RESGROUP:02CDh
  1784                                  	;push	si
  1785                                  	;push	ds
  1786 000001C6 06                      	push	es
  1787                                  
  1788 000001C7 B452                    	mov	ah,DOS_GET_LISTS	; Call int 21h, function 52h...
  1789 000001C9 CD21                    	int	21h	; DOS - 2+ internal - GET LIST OF LISTS
  1790                                  			; Return: ES:BX -> DOS list of lists
  1791                                  
  1792 000001CB 26A18C00                	mov	ax,[es:UMB_HeadIdx]	; And read what's in ES:008Ch
  1793 000001CF 83F8FF                  	cmp	ax,0FFFFh
  1794                                  	;je	short xhu_e		; If it's 0xFFFF, it's an error...
  1795                                  	;clc				; Else, it isn't.
  1796                                  	;jmp	short xhu_x
  1797                                  ;xhu_e:
  1798                                  	;stc
  1799                                  	; 05/06/2023
  1800 000001D2 F5                      	cmc	; cf=0 -> cf=1
  1801                                  ;xhu_x:
  1802 000001D3 07                      	pop	es
  1803                                  	; 18/07/2024
  1804                                  	;pop	ds
  1805                                  	;pop	si
  1806 000001D4 C3                      	retn
  1807                                  
  1808                                  ; -----------------------------------------------------------------------------
  1809                                  ;*** linkumb - links UMBs not already linked in; updates fm_umb as needed
  1810                                  ; -----------------------------------------------------------------------------
  1811                                  ; ENTRY:    None
  1812                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
  1813                                  ; ERROR:    None
  1814                                  ; USES:     AX, BX, fm_umb
  1815                                  ; -----------------------------------------------------------------------------
  1816                                  
  1817                                  	; 05/06/2023
  1818                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:029Dh
  1819                                  linkumb:
  1820 000001D5 B80258                  	mov	ax,DOS_UMBLINK_GET ; 5802h
  1821 000001D8 CD21                    	int	21h			; Current link-state is now in al
  1822                                  
  1823 000001DA 08C0                    	or	al,al			; BUGBUG: proper check?
  1824 000001DC 7508                    	jnz	short lumbX		; Jumps if UMBs already linked in
  1825                                  
  1826 000001DE B80358                  	mov	ax,DOS_UMBLINK_SET ; 5803h
  1827 000001E1 BB0100                  	mov	bx,1
  1828 000001E4 CD21                    	int	21h
  1829                                  lumbX:
  1830 000001E6 C3                      	retn
  1831                                  
  1832                                  ;==============================================================================
  1833                                  ; STUB.ASM, MSDOS 6.0, 1991
  1834                                  ;==============================================================================
  1835                                  ; 05/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
  1836                                  
  1837                                  	; 09/01/2023 - Retro DOS v4.0 (& 4.1)
  1838                                  	; 05/06/2023 - Retro DOS 4.2
  1839                                  
  1840                                  ;The Exec call has to be issued from the data segment. The reason for this 
  1841                                  ;is TSRs. When a TSR does a call to terminate and stay resident, the call
  1842                                  ;returns with all registers preserved and so all our segment registers are
  1843                                  ;still set up. However, if the TSR unloads itself later on, it still 
  1844                                  ;comes back here. In this case the segment registers and the stack are
  1845                                  ;not set up and random things can happen. The only way to setup all the 
  1846                                  ;registers is to use the cs value and this can only be done when we are in
  1847                                  ;the data segment ourselves. So, this piece of code had to be moved from
  1848                                  ;the code segment to the data segment.
  1849                                  
  1850                                  	; MSDOS 6.22 COMMAND.COM RESGROUP:02AFh
  1851                                  Issue_Exec_Call:
  1852 000001E7 CD21                    	int 	21h
  1853                                  
  1854                                  ;We disable interrupts while changing the stack because there is a bug in 
  1855                                  ;some old 8088 processors where interrupts are let through while ss & sp
  1856                                  ;are being changed.
  1857                                  
  1858 000001E9 FA                      	cli
  1859 000001EA 0E                      	push	cs
  1860 000001EB 17                      	pop	ss
  1861                                  
  1862                                  	;;;mov	sp,53Eh ; MSDOS 5.0 COMMAND.COM RESGROUP:01DFh
  1863                                  	;;mov	sp,60Ah	; MSDOS 6.22 COMMAND.COM RESGROUP:02B4h
  1864                                  	;mov	sp,637h ; PCDOS 7.1 COMMAND.COM RESGROUP:02F8h
  1865                                  	;mov	sp,offset DATARES:RStack ; stack is set up
  1866 000001EC BC[2E05]                	mov	sp,RStack		; stack is set up
  1867                                  
  1868                                  ; 05/06/2023	
  1869                                  %if 0	
  1870                                  	; 20/04/2023
  1871                                  	;sti
  1872                                  	;push	cs
  1873                                  	;pop	ds			; ds = DATARES
  1874                                  
  1875                                  ; M009; Restore UMB state to that before Exec
  1876                                  
  1877                                  	;pushf				;    This call frees HIDDEN umb's,
  1878                                  	;call	UnHideUMBs		; <- restores the memory-allocation
  1879                                  	;popf				;    strategy and link state, as app.
  1880                                  
  1881                                  	; 09/01/2023 - Retro DOS v4.0
  1882                                  	; MSDOS 5.0 COMMAND.COM RESGROUP:01E2h
  1883                                  	; ----------------------
  1884                                  	sti
  1885                                  	push    cs
  1886                                  	pop     ds
  1887                                  	pushf
  1888                                  	;mov	al,[cs:fInHigh]
  1889                                  	; 18/04/2023
  1890                                  	mov	al,[fInHigh]
  1891                                  	test	al,80h
  1892                                  	jz      short uhu10
  1893                                  	and     al,7Fh
  1894                                  	;;call	cs:UMBOff_Entry
  1895                                  	;call	far [cs:UMBOff_Entry]
  1896                                  	call	far [UMBOff_Entry]
  1897                                  uhu10:
  1898                                  	;and	byte [cs:fInHigh],7Fh
  1899                                  	; 18/04/2023
  1900                                  	and	byte [fInHigh],7Fh
  1901                                  	popf
  1902                                  	; ----------------------
  1903                                  
  1904                                  %endif
  1905                                  	; 05/06/2023 - Retro DOS 4.2
  1906                                  	; MSDOS 6.22 COMMAND.COM RESGROUP:02B7h
  1907 000001EF FB                      	sti
  1908 000001F0 0E                      	push	cs
  1909 000001F1 1F                      	pop	ds			; ds = DATARES
  1910                                  
  1911                                  ; M009; Restore UMB state to that before Exec
  1912                                  
  1913 000001F2 9C                      	pushf				;    This call frees HIDDEN umb's,
  1914 000001F3 E834FF                  	call	UnHideUMBs		; <- restores the memory-allocation
  1915 000001F6 9D                      	popf				;    strategy and link state, as app
  1916                                  
  1917                                  ;We now jump to the stub trap which returns us to the resident code. All
  1918                                  ;flags are preserved by the stub code.
  1919                                  
  1920 000001F7 E9C8FE                  	jmp	Exec_Trap
  1921                                  
  1922                                  ;==============================================================================
  1923                                  ; RDATA.ASM, MSDOS 6.0, 1992
  1924                                  ;==============================================================================
  1925                                  ; 09/01/2023 - Retro DOS v4.0 (& v4.1)
  1926                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  1927                                  
  1928                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:02C2h (DATARES:02C2h) (*)
  1929                                  ; -----------------------------------------------------------------------------
  1930 000001FA 636F78                  cox_location:	db 'cox' ; (*)	
  1931 000001FD 0000                    cox_Y_option:	dw 0     ; (*)
  1932                                  ; -----------------------------------------------------------------------------
  1933                                  
  1934                                  ;***	Message substitution blocks
  1935                                  
  1936                                  ; 09/01/2023 - MSDOS 5.0 COMMAND.COM RESGROUP:01FFh (DATARES:01FFh)
  1937                                  
  1938                                  ;BlkDevErrSubst	label	byte
  1939                                  ;BlkDevErrRw	subst	<STRING,>		; "reading" or "writing"
  1940                                  ;		subst	<CHAR,DATARES:DrvLet>	; block device drive letter
  1941                                  
  1942 000001FF 02                      BlkDevErrSubst: db	2
  1943 00000200 0000                    BlkDevErrRw:	dw	0
  1944 00000202 01                      		db	1
  1945 00000203 [0502]                  		dw	DrvLet
  1946                                  
  1947 00000205 41                      DrvLet:		db	'A'			; drive letter
  1948                                  
  1949                                  
  1950                                  ;CharDevErrSubst label	byte
  1951                                  ;CharDevErrRw	subst	<STRING,>		 ; "reading" or "writing"
  1952                                  ;CharDevErrDev	subst	<STRING,DATARES:DevName> ; character device name
  1953                                  
  1954 00000206 02                      CharDevErrSubst: db	2
  1955 00000207 0000                    CharDevErrRw:	dw	0
  1956 00000209 02                      		db	2
  1957 0000020A [1802]                  		dw	DevName
  1958                                  
  1959                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM - RESGROUP:0318h
  1960                                  ;DevName:	times 8 db 0  ; db 8 dup (?),0	; device name, asciiz
  1961                                  ;		db	0
  1962                                  
  1963                                  ;NeedVolSubst	label	byte
  1964                                  ;		subst	<STRING,DATARES:VolName> ; volume name
  1965                                  ;		subst	<HEX,DATARES:VolSer+2>	 ; hi word of serial #
  1966                                  ;		subst	<HEX,DATARES:VolSer>	 ; lo word of serial #
  1967                                  
  1968 0000020C 02                      NeedVolSubst:	db	2
  1969 0000020D [1502]                  		dw	VolName
  1970 0000020F 03                      		db	3
  1971 00000210 [2302]                  		dw	VolSer+2
  1972 00000212 03                      		db	3
  1973 00000213 [2102]                  		dw	VolSer
  1974                                  
  1975                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM - RESGROUP:0321h
  1976                                  	; NOTE:	VolName and VolSer must be adjacent
  1977                                  ;VolName:	times 11 db 0 ; db 11 dup (?),0	; volume name
  1978                                  		; 18/07/2024
  1979 00000215 000000                  VolName:	db	3 dup(0)
  1980 00000218 0000000000000000        DevName:	db	8 dup(0)
  1981                                  	
  1982 00000220 00                      		db	0
  1983 00000221 00000000                VolSer:		dd	0			; volume serial #
  1984                                  
  1985 00000225 00                      CDevAt:		db	0
  1986                                  
  1987                                  ;BadFatSubst	label	byte
  1988                                  ;		subst	<CHAR,DATARES:DrvLet>	; drive letter
  1989                                  
  1990 00000226 01                      BadFatSubst:	db	1
  1991 00000227 [0502]                  		dw	DrvLet
  1992                                  
  1993                                  ;PutBackSubst	label	byte
  1994                                  ;PutBackComSpec	subst	<STRING,>		  ; comspec string
  1995                                  ;		subst	<CHAR,DATARES:PutBackDrv> ; drive to put it in
  1996                                  
  1997 00000229 02                      PutBackSubst:	db	2
  1998 0000022A 0000                    PutBackComSpec:	dw	0
  1999 0000022C 01                      		db	1
  2000 0000022D [2F02]                  		dw	PutBackDrv
  2001                                  
  2002 0000022F 20                      PutBackDrv:	db	' '	; db 20h	; drive letter
  2003                                  
  2004                                  ;ExecErrSubst	subst	<STRING,DATARES:SafePathBuffer>
  2005                                  
  2006 00000230 02                      ExecErrSubst:	db	2
  2007 00000231 [5E04]                  		dw	SafePathBuffer
  2008                                  
  2009 00000233 00000000                NeedVol:	dd	0	; ptr to volume name from get ext err
  2010 00000237 00                      ErrType: 	db	0	; critical error message style, 0=old, 1=new
  2011                                  
  2012 00000238 00000000                Int_2e_Ret:	dd	0	; magic command executer return address
  2013 0000023C 0000                    Save_Pdb:	dw	0
  2014 0000023E 0000                    Parent:		dw	0
  2015 00000240 00000000                OldTerm:	dd	0
  2016 00000244 0000                    ErrCd_24:	dw	0
  2017 00000246 0000                    Handle01:	dw	0
  2018 00000248 00                      Loading:	db	0
  2019 00000249 0000                    Batch:		dw	0	; assume no batch mode initially
  2020                                  
  2021                                  ;;;;SR;
  2022                                  ;;;; This flag has been added for a gross hack introduced in batch processing. 
  2023                                  ;;;;We use it to indicate that this batch file has no CR-LF before EOF and that
  2024                                  ;;;;we need to fake the CR-LF for the line to be properly processed
  2025                                  ;;;;
  2026                                  ;;;BatchEOF:	db	0
  2027                                  
  2028                                  	; Bugbug: ComSpec should be 64+3+12+1?
  2029                                  	; What's this comspec_end about?
  2030                                  ; 21/07/2024
  2031                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0364h
  2032 0000024B 00<rep 40h>             ComSpec:	times 64 db 0 ; db 64 dup (0)
  2033 0000028B 0000                    ComSpec_End:	dw	0
  2034                                  
  2035                                  ;Trans		label	dword
  2036                                  ;		dw	TRANGROUP:Command
  2037                                  
  2038                                  Trans:		;dw	12Ch
  2039                                  		; MSDOS 5.0 COMMAND.COM RESGROUP:0296h (DATARES:0296h)
  2040 0000028D [2E01]                  		dw	COMMAND ; 16/04/2023
  2041 0000028F 0000                    TrnSeg:		dw	0
  2042                                  
  2043 00000291 00                      TrnMvFlg:	db	0	; set if transient portion has been moved
  2044                                  
  2045 00000292 00                      In_Batch:	db	0	; set if we are in batch processing mode
  2046 00000293 00                      Batch_Abort:	db	0	; set if user wants to abort from batch mode
  2047                                  
  2048 00000294 00                      ComDrv:		db	0	; drive spec to load autoexec and command
  2049 00000295 0000                    MemSiz:		dw	0
  2050 00000297 0000                    Sum:		dw	0
  2051 00000299 01                      ExtCom:		db	1	; for init, pretend just did an external
  2052 0000029A 0000                    RetCode: 	dw	0
  2053 0000029C 00                      Crit_Err_Info:	db	0	; hold critical error flags for r,i,f
  2054                                  
  2055                                  
  2056                                  ; The echo flag needs to be pushed and popped around pipes and batch files.
  2057                                  ; We implement this as a bit queue that is shr/shl for push and pop.
  2058                                  
  2059 0000029D 01                      EchoFlag:	db	00000001b ; low bit true => echo commands
  2060 0000029E 01                      Suppress:	db	1	; used for echo, 1=echo line
  2061 0000029F 0000                    Io_Save: 	dw	0
  2062 000002A1 00                      RestDir: 	db	0
  2063 000002A2 00                      PermCom: 	db	0	; true => permanent command
  2064                                  ; 05/06/2023
  2065 000002A3 FFFF                    SemiPermCom:	dw      -1	; MSDOS 6.0 COMMAND.COM 
  2066                                  				; true => semi-permanent command (/K)
  2067 000002A5 0000                    SingleCom:	dw	0	; true => single command version
  2068 000002A7 FFFF                    VerVal:		dw	-1
  2069 000002A9 00                      fFail:		db	0	; true => fail all int 24s
  2070 000002AA 00                      IfFlag:		db	0	; true => IF statement in progress
  2071                                  
  2072 000002AB 00                      ForFlag: 	db	0	; true => FOR statement in progress
  2073 000002AC 0000                    ForPtr:		dw	0
  2074                                  
  2075 000002AE 0000                    Nest:		dw	0	; nested batch file counter
  2076 000002B0 00                      Call_Flag:	db	0	; no CALL (batch command) in progress
  2077 000002B1 00                      Call_Batch_Flag: db	0
  2078 000002B2 0000                    Next_Batch:	dw	0	; address of next batch segment
  2079 000002B4 00                      NullFlag:	db	0	; flag if no command on command line
  2080 000002B5 00<rep 5h>              FUCase_Addr:	times 5 db 0 ; db 5 dup (0)
  2081                                  				; buffer for file ucase address
  2082                                  ; Bugbug: don't need crit_msg_ anymore?
  2083                                  
  2084                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
  2085                                  %if 0
  2086                                  Crit_Msg_Off:	dw	0	; saved critical error message offset
  2087                                  Crit_Msg_Seg:	dw	0	; saved critical error message segment
  2088                                  %endif
  2089                                  
  2090 000002BA 0000                    Dbcs_Vector_Addr: dw	0	; DBCS vector offset
  2091 000002BC 0000                    		 dw	0	; DBCS vector segment
  2092 000002BE 0000                    Append_State:	dw	0	; current state of append
  2093                                  				;  (if Append_Flag is set)
  2094 000002C0 00                      Append_Flag:	db	0	; set if append state is valid
  2095 000002C1 00                      Re_Out_App:	db	0
  2096 000002C2 00<rep 50h>             Re_OutStr:	times 64+3+13 db 0 ; db 64+3+13 dup (?)
  2097                                  
  2098                                  ; We flag the state of COMMAND in order to correctly handle the ^Cs at
  2099                                  ; various times. Here is the breakdown:
  2100                                  ;
  2101                                  ;   INITINIT	We are in the init code.
  2102                                  ;   INITSPECIAL We are in the date/time prompt
  2103                                  ;   INITCTRLC	We are handling a ^C already.
  2104                                  ;
  2105                                  ; If we get a ^C in the initialization but not in the date/time prompt, we
  2106                                  ; ignore the ^C. This is so the system calls work on nested commands.
  2107                                  ;
  2108                                  ; If we are in the date/time prompt at initialization, we stuff the user's
  2109                                  ; input buffer with a CR to pretend an empty response.
  2110                                  ;
  2111                                  ; If we are already handling a ^C, we set the carry bit and return to the user
  2112                                  ; (ourselves). We can then detect the carry set and properly retry the
  2113                                  ; operation.
  2114                                  
  2115                                  InitFlag:	;db	1
  2116 00000312 01                      		db	INITINIT
  2117                                  
  2118                                  ; Note: these two bytes are referenced as a word
  2119 00000313 00                      PipeFlag:	db	0
  2120 00000314 00                      PipeFiles:	db	0
  2121                                  
  2122                                  ; (rdata.asm, msdos 6.0, 1992)
  2123                                  ; ----------------------------------------------------------------------------
  2124                                  ; 09/01/2023 - MSDOS 5.0 COMMAND.COM RESGROUP:0320h (DATARES:0320h)
  2125                                  
  2126                                  ;;SR
  2127                                  ;; Pipe1 & Pipe2 now need to store full-fledged pathnames
  2128                                  ;;
  2129                                  ;
  2130                                  ;; Bugbug: can we find any way around maintaining these
  2131                                  ;; large buffers?
  2132                                  ;
  2133                                  ;Pipe1		db	67+12 dup (?)
  2134                                  ;Pipe2		db	67+12 dup (?)
  2135                                  ;
  2136                                  ;PipePtr 	dw	?
  2137                                  ;
  2138                                  ;PipeStr 	db	129 dup (?)
  2139                                  ;
  2140                                  ;EndPipe	label	byte	; marks end of buffers; M004
  2141                                  ;
  2142                                  ;;SR;
  2143                                  ;; We can move our EndInit code into above buffers. This way, the code will
  2144                                  ;;automatically be discarded after init.
  2145                                  ;;
  2146                                  ;; M004; We overlap our code with the Pipe buffers located above by changing
  2147                                  ;; M004; the origin.
  2148                                  ;;
  2149                                  ;	ORG	Pipe1	; M004
  2150                                  ;
  2151                                  ;; Bugbug: really need a procedure header for EndInit, describing
  2152                                  ;; what it expects, what it does.
  2153                                  ;
  2154                                  
  2155                                  ; 09/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  2156                                  
  2157                                  Pipe1	equ	EndInit
  2158                                  Pipe2	equ	Pipe1+67+12
  2159                                  PipePtr	equ	Pipe2+67+12
  2160                                  PipeStr	equ	PipePtr+2
  2161                                  EndPipe	equ	PipeStr+129	; EndInit+289
  2162                                  
  2163                                  ; Bugbug: really need a procedure header for EndInit, describing
  2164                                  ; what it expects, what it does.
  2165                                  
  2166                                  ; MSDOS 5.0 COMMAND.COM - RESGROUP:0320h
  2167                                  
  2168                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM (compatible with MSDOS 6.22)
  2169                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:03EAh 
  2170                                  
  2171                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  2172                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:041Eh
  2173                                  
  2174                                  EndInit:
  2175 00000315 1E                      	push	ds
  2176 00000316 06                      	push	es		; save segments
  2177                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM (ds=cs=RESGROUP)
  2178                                  	;push	cs
  2179                                  	;pop	ds
  2180                                  	;assume	ds:RESGROUP
  2181                                  
  2182                                  ; M004; Save size of transient here before INIT segment is deallocated
  2183                                  
  2184 00000317 8B16[9220]              	mov	dx,[TrnSize]		; M004
  2185                                  ;M027
  2186                                  ; These variables are also defined in the INIT segment and need to be saved
  2187                                  ;before we resize
  2188                                  ;
  2189 0000031B A1[8620]                	mov	ax,[OldEnv]	; Old Environment seg ;M027
  2190 0000031E 8B1E[8220]              	mov	bx,[EnvSiz]	; Size of new environment ;M027
  2191 00000322 8B0E[8820]              	mov	cx,[UsedEnv]	; Size of old environment ;M027
  2192 00000326 50                      	push	ax		; Save all these values ;M027
  2193 00000327 53                      	push	bx		; M027
  2194 00000328 51                      	push	cx		; M027
  2195                                  
  2196                                  
  2197                                  ; Bugbug: push ds, pop es here.
  2198                                  	;mov	bx,ds
  2199                                  	;mov	es,bx		; es = RESGROUP
  2200                                  	; 09/01/2023
  2201 00000329 1E                      	push	ds
  2202 0000032A 07                      	pop	es
  2203                                  
  2204                                  ;ResSize is the actual size to be retained -- only data for HIMEM COMMAND, 
  2205                                  ; code + data for low COMMAND
  2206                                  
  2207 0000032B 8B1E[B404]              	mov	bx,[ResSize]	; Total size of resident
  2208 0000032F B44A                    	mov	ah,4Ah	; SETBLOCK
  2209                                  
  2210                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2211                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:043Ah
  2212                                  %if 1
  2213 00000331 803E[0E04]02            	cmp	byte [COMMAND_HIGH],2
  2214 00000336 7517                    	jne	short set_block
  2215                                  
  2216 00000338 31DB                    	xor	bx,bx		; low memory first
  2217 0000033A B80158                  	mov	ax,5801h	; set allocation strategy
  2218 0000033D CD21                    	int     21h     ; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2219                                  			; AL = function code: set allocation strategy
  2220 0000033F 8B0E7E00                	mov	cx,[7Eh]	; environment segment
  2221 00000343 E308                    	jcxz	skip_dealloc_env_seg
  2222 00000345 06                      	push	es
  2223 00000346 8EC1                    	mov	es,cx
  2224 00000348 B449                    	mov	ah,49h
  2225 0000034A CD21                    	int	21h 	; DOS - 2+ - FREE MEMORY
  2226                                  			; ES = segment address of area to be freed
  2227 0000034C 07                      	pop     es
  2228                                  skip_dealloc_env_seg:
  2229 0000034D B449                    	mov	ah,49h	; DEALLOC
  2230                                  set_block:	
  2231                                  %endif
  2232                                  	;mov	ah,SETBLOCK
  2233 0000034F CD21                    	int	21h		; Set block to resident size
  2234                                  
  2235                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
  2236                                  		; ES = segment address of block to change
  2237                                  		; BX = new size in paragraphs
  2238                                  
  2239                                  ;We check if this is for autoexec.bat (PermCom = 1). If so, we then
  2240                                  ;allocate a new batch segment, copy the old one into new batchseg and free
  2241                                  ;the old batchseg. Remember that the old batchseg was allocated on top of the
  2242                                  ;transient and we will leave a big hole if TSRs are loaded by autoexec.bat
  2243                                  ;
  2244                                  ; Bugbug: also describe why we alloc & copy batch seg BEFORE environment.
  2245                                  	
  2246 00000351 803E[A202]01            	cmp	byte [PermCom],1 ; permanent command.com?
  2247 00000356 7530                    	jne	short adjust_env ; no, do not free batchseg
  2248                                  
  2249 00000358 833E[4902]00            	cmp	word [Batch],0	 ; was there a valid batchseg?
  2250 0000035D 7429                    	je	short adjust_env ; no, dont juggle
  2251                                  
  2252                                  	;mov	bx,((SIZE BatchSegment) + 15 + 1 + 0Fh)/16 ; batchseg size
  2253                                  	; 21/01/2023
  2254 0000035F BB0400                  	mov	bx,((BATCHSEGMENT.SIZE)+16+0Fh)/16 ; (33+16+15)/16
  2255                                  	;mov	bx,4	; 09/01/2023
  2256                                  			; (MSDOS 5.0 COMMAND COM RESGROUP:0350h)
  2257 00000362 B448                    	mov	ah,48h
  2258                                  	;mov	ah,ALLOC
  2259 00000364 CD21                    	int	21h
  2260                                  
  2261                                  		; DOS - 2+ - ALLOCATE MEMORY
  2262                                  		; BX = number of 16-byte paragraphs desired
  2263                                  
  2264                                  ; Bugbug: I just had a thought. If DOS or SHARE or somebody leaves
  2265                                  ; a hole, the batch segment COULD already be in the ideal place. We
  2266                                  ; could be making it worse! We're second-guessing where memory
  2267                                  ; allocations go, which might not be such a great idea. Is there
  2268                                  ; a strategy, short of doing something even worse like diddling
  2269                                  ; arena headers, where we can minimize the possibility of fragmentation
  2270                                  ; under all cases? Hmm..
  2271                                  	
  2272 00000366 7220                    	jc	short adjust_env ; no memory, use old batchseg
  2273                                  
  2274 00000368 8EC0                    	mov	es,ax		 ; es = New batch segment
  2275 0000036A 31FF                    	xor	di,di
  2276 0000036C 31F6                    	xor	si,si
  2277                                  
  2278 0000036E 1E                      	push	ds
  2279 0000036F 8E1E[4902]              	mov	ds,[Batch]	 ; ds = Old Batch Segment
  2280                                  	;assume	ds:nothing
  2281                                  	;mov	cx,SIZE BatchSegment
  2282                                  	; 23/01/2023
  2283                                  	;mov	cx,BATCHSEGMENT.SIZE
  2284                                  	;;mov	cx,33	; 09/01/2023
  2285                                  	;		; (MSDOS 5.0 COMMAND COM RESGROUP:0364h)
  2286                                  	;
  2287                                  	;add	cx,16		 ; for the filename
  2288                                  	; 20/04/2023
  2289 00000373 B93100                  	mov	cx,BATCHSEGMENT.SIZE+16
  2290                                  
  2291                                  	; Bugbug: 16? Shouldn't this be a common equate or something?
  2292                                  	; It's sure be bad if we copied more bytes than the batch segment
  2293                                  	; holds!
  2294                                  	
  2295 00000376 FC                      	cld
  2296 00000377 F3A4                    	rep	movsb
  2297 00000379 1F                      	pop	ds
  2298                                  	;assume	ds:RESGROUP
  2299                                  
  2300 0000037A 8CC1                    	mov	cx,es		; save new batch segment 
  2301 0000037C 8E06[4902]              	mov	es,[Batch]
  2302 00000380 B449                    	mov	ah,49h
  2303                                  	;mov	ah,DEALLOC
  2304 00000382 CD21                    	int	21h		; free the old batch segment
  2305                                  
  2306                                  	; Bugbug: should we check for error?
  2307                                  
  2308 00000384 890E[4902]              	mov	[Batch],cx	; store new batch segment address
  2309                                  
  2310                                  adjust_env:
  2311                                  
  2312                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2313                                  ; PCDOS 7.1 COMMAND.COM
  2314                                  %if 1
  2315 00000388 BB8000                  	mov     bx,80h		; first fit, try high then low memory
  2316 0000038B B80158                  	mov     ax,5801h
  2317 0000038E CD21                    	int     21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2318                                  			; AL = function code: set allocation strategy
  2319                                  %endif
  2320 00000390 59                      	pop	cx		; cx = size of old env ;M027
  2321 00000391 5B                      	pop	bx		; bx = size of new env needed ;M027
  2322 00000392 5D                      	pop	bp		; bp = old env seg ;M027
  2323                                  
  2324                                  ;Allocate the correct size for the environment
  2325                                  
  2326 00000393 B448                    	mov	ah,48h
  2327                                  	;mov	ah,ALLOC
  2328 00000395 CD21                    	int	21h		; get memory
  2329 00000397 7272                    	jc	short nomem_err	; out of memory,signal error
  2330                                  	
  2331                                  	; Bugbug: why not continue, leaving environment where it is?
  2332                                  
  2333 00000399 A3[3A04]                	mov	[EnvirSeg],ax	; Store new environment segment
  2334                                  	;;mov	[ds:2Ch],ax
  2335                                  	;mov	[2Ch],ax
  2336                                  	;mov	[PDB_Environ],ax ; Put new env seg in PSP
  2337 0000039C A32C00                  	mov	[PDB.ENVIRON],ax
  2338 0000039F 8EC0                    	mov	es,ax		; es = address of allocated memory
  2339                                  	;assume	es:nothing
  2340                                  
  2341                                  ;Copy the environment to the newly allocated segment
  2342                                  
  2343 000003A1 1E                      	push	ds
  2344 000003A2 8EDD                    	mov	ds,bp		; ds = Old environment segment
  2345                                  	;assume	ds:nothing
  2346                                  
  2347 000003A4 31F6                    	xor	si,si
  2348 000003A6 89F7                    	mov	di,si		; Start transfer from 0
  2349                                  
  2350 000003A8 FC                      	cld
  2351 000003A9 F3A4                    	rep	movsb		; Do the copy
  2352                                  
  2353 000003AB 1F                      	pop	ds		; ds = RESGROUP
  2354                                  	;assume	ds:RESGROUP
  2355                                  
  2356                                  ; We have to free the old environment block if it was allocated by INIT
  2357                                  
  2358                                  ; Bugbug: is this only for the case when we were NOT passed an environment,
  2359                                  ; or does it also apply to passed environments?
  2360                                  
  2361                                  ;M036
  2362                                  ; Free up old env segment always because this is a copy passed by Exec and
  2363                                  ; takes up memory that is never used
  2364                                  
  2365                                  ;M044
  2366                                  ; Go back to the old strategy of not freeing the environment. Freeing it leaves
  2367                                  ; a hole behind that Ventura does not like. Basically, Ventura gives strange
  2368                                  ; errors if it gets a memory alloc that it is below its load segment. The
  2369                                  ; freed environment creates a large enough hole for some of its allocs to fit
  2370                                  ; in
  2371                                  
  2372                                  	;cmp	byte [AllocedEnv],0 ; has env been allocated by INIT?
  2373                                          ;je	short no_free	    ; no, do not free it
  2374                                  	; 21/01/2023
  2375                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:0398h
  2376 000003AC 803E[5420]00            	cmp	byte [AllocedEnv],0 ; flag - old environment segment
  2377                                  	; !!!! ; 15/08/2024
  2378                                  	;jne	short no_free	; MSDOS 5.0 COMMAND.COM - RESGROUP:039Dh
  2379                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:04C0h
  2380 000003B1 7406                    	je	short no_free	; MSDOS 6.22 COMMAND.COM - RESGROUP:0467h
  2381                                  
  2382 000003B3 8EC5                    	mov	es,bp
  2383 000003B5 B449                    	mov	ah,49h
  2384                                  	;mov	ah,DEALLOC
  2385 000003B7 CD21                    	int	21h		    ; Free it
  2386                                  no_free:
  2387                                  
  2388                                  ; M004; Start of changes
  2389                                  
  2390                                  ; Move the transient now. We will allocate the biggest block available
  2391                                  ; now and move the transient to the top of the block. We will then
  2392                                  ; deallocate this block. When the resident starts executing, it will
  2393                                  ; hopefully allocate this block again and find the transient intact.
  2394                                  
  2395                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2396                                  ; PCDOS 7.1 COMMAND.COM
  2397                                  %if 1
  2398 000003B9 31DB                    	xor	bx,bx	; low memory first fit
  2399 000003BB B80158                  	mov	ax,5801h
  2400 000003BE CD21                    	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2401                                  			; AL = function code: set allocation strategy
  2402 000003C0 31DB                    	xor	bx,bx	; remove UMBs from DOS memory chain
  2403 000003C2 B80358                  	mov	ax,5803h ; set UMB link state
  2404 000003C5 CD21                    	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2405                                  			; AL = function code: (DOS 5beta) set UMB link state
  2406                                  %endif
  2407 000003C7 C606[9102]01            	mov	byte [TrnMvFlg],1 ; Indicate that transient has been moved
  2408 000003CC 06                      	push	es
  2409                                  	;;mov	si,offset ResGroup:TranStart
  2410                                  	; 09/01/2023
  2411                                  	;;mov	si,2320h	; MSDOS 5.0 COMMAND.COM RESGROUP:03ABh
  2412                                  	; 05/06/2023
  2413                                  	;mov	si,26E0h	; MSDOS 6.22 COMMAND.COM RESGROUP:0475h
  2414                                  	; 19/07/2024
  2415                                  	;mov	si,2890h	; PCDOS 7.1 COMMAND.COM RESGROUP:04DDh
  2416 000003CD BED027                  	mov	si,TRANSTART	; (End of the resident portion)
  2417                                  	;mov	di,0
  2418 000003D0 31FF                    	xor	di,di ; 0
  2419                                  	;;mov	cx,offset TranGroup:TranSpaceEnd ; size to move
  2420                                  	;mov	cx,98C5h
  2421                                  	; 05/06/2023 - MSDOS 6.22 COMMAND.COM RESGROUP:047Bh
  2422                                  	;mov	cx,0AF95h	; TRANSIENT portion size
  2423                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  2424                                  	;mov	cx,0AA9Ah
  2425 000003D2 B90BA6                  	mov	cx,TRANSPACEEND
  2426                                  	
  2427                                  ; Find the largest block available
  2428                                  
  2429 000003D5 BBFFFF                  	mov	bx,0FFFFh
  2430 000003D8 B448                    	mov	ah,48h
  2431                                  	;mov	ah,ALLOC
  2432 000003DA CD21                    	int	21h
  2433                                  
  2434                                  ; dx = size of transient saved previously 
  2435                                  
  2436 000003DC 39D3                    	cmp	bx,dx		; enough memory?
  2437 000003DE 722B                    	jb	short nomem_err	; not enough memory for transient
  2438                                  
  2439 000003E0 B448                    	mov	ah,48h
  2440                                  	;mov	ah,ALLOC
  2441 000003E2 CD21                    	int	21h		; get the largest block
  2442 000003E4 7225                    	jc	short nomem_err	; something is really screwed up
  2443                                  
  2444 000003E6 50                      	push	ax		; save memory address
  2445 000003E7 01D8                    	add	ax,bx		; ax = top of my memory block
  2446 000003E9 29D0                    	sub	ax,dx		; less size of transient
  2447 000003EB A3[8F02]                	mov	[TrnSeg],ax	; save transient segment
  2448 000003EE 8EC0                    	mov	es,ax		;
  2449 000003F0 58                      	pop	ax		; restore our seg addr
  2450                                  
  2451                                  ; Everything is set for a move. We need to move in the reverse direction to
  2452                                  ; make sure we dont overwrite ourselves while copying
  2453                                  
  2454 000003F1 01CE                    	add	si,cx
  2455 000003F3 4E                      	dec	si
  2456 000003F4 01CF                    	add	di,cx
  2457 000003F6 4F                      	dec	di
  2458 000003F7 FD                      	std
  2459 000003F8 F3A4                    	rep	movsb
  2460 000003FA FC                      	cld
  2461                                  
  2462                                  ; Now we have to free up this block so that resident can get hold of it
  2463                                  
  2464 000003FB 8EC0                    	mov	es,ax
  2465 000003FD B449                    	mov	ah,49h
  2466                                  	;mov	ah,DEALLOC
  2467 000003FF CD21                    	int	21h		; release the memory block
  2468                                  
  2469                                  ; M004; End of changes
  2470                                  
  2471                                  	;mov	InitFlag,FALSE	; indicate INIT is done
  2472                                  	; 09/01/2023
  2473 00000401 C606[1203]00            	mov	byte [InitFlag],0
  2474                                  
  2475 00000406 07                      	pop	es
  2476 00000407 1F                      	pop	ds
  2477                                  	;assume	ds:nothing
  2478                                  	
  2479                                  	; Bugbug: did we need to save & restore seg reg's during EndInit?
  2480                                  	
  2481 00000408 E9D5FC                  	jmp	LodCom_Trap	; allocate transient
  2482                                  
  2483                                  nomem_err:
  2484                                  
  2485                                  ;We call the error routine which will never return. It will either exit
  2486                                  ;with an error ( if not the first COMMAND ) or just hang after an error
  2487                                  ;message ( if first COMMAND )
  2488                                  
  2489 0000040B E9B21B                  	jmp	Alloc_error
  2490                                  
  2491                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2492                                  ; ---------------------------------------
  2493                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0520h
  2494                                  %if 1
  2495                                  COMMAND_HIGH:
  2496 0000040E 00                      	db	0	; load high status of COMMAND.COM (/H switch)
  2497                                  %endif
  2498                                  ; ---------------------------------------
  2499                                  
  2500                                  ;EndCodeInit:	; label	byte		; M004
  2501                                  
  2502                                  	; 16/04/2023
  2503                                  	EndCodeInit equ $
  2504                                  
  2505                                  ;; M004; Check if the EndInit code will fit into the Pipe buffers above.
  2506                                  ;; M004; If not, we signal an assembly error
  2507                                  ;
  2508                                  ;IF2
  2509                                  ;	IF ($ GT EndPipe)
  2510                                  ;		.err
  2511                                  ;		%out	"ENDINIT CODE TOO BIG"
  2512                                  ;	ENDIF
  2513                                  ;ENDIF
  2514                                  
  2515                                  ;; M004; Set the origin back to what it was at the end of the buffers
  2516                                  ;;
  2517                                  ;		ORG	EndPipe		; M004
  2518                                  
  2519                                  ; 09/01/2023
  2520                                  ; MSDOS 5.0 COMMAND.COM - CODERES:03EDh
  2521                                  ; 05/06/2023
  2522                                  ; MSDOS 6.22 COMMAND.COM - CODERES:04B7h
  2523                                  ;	times 84 db 0	; db (EndPipe-EndCodeInit) dup(0)
  2524                                  
  2525                                  ; 16/04/2023
  2526                                  	FillBytes equ EndPipe - EndCodeInit
  2527                                  
  2528                                  ;%if EndCodeInit<EndPipe ; if (EndCodeInit < (EndInit+289))
  2529                                  ; 16/04/2023
  2530                                  %if FillBytes>0
  2531                                  	;times EndPipe - EndCodeInit db 0
  2532 0000040F 00<rep 27h>             	times FillBytes db 0   
  2533                                  %endif
  2534                                  
  2535                                  ; 09/01/2023 - Retrodos v4.0 (& v4.1)
  2536                                  ; MSDOS 5.0 COMMAND.COM - CODERES:0441h ; EndInit+289 
  2537                                  
  2538                                  ; 05/06/2023 - Retrodos v4.2
  2539                                  ; MSDOS 6.22 COMMAND.COM - CODERES:050Bh ; EndInit+289
  2540                                  
  2541                                  ; 19/07/2024 - Retrodos v5.0 COMMAND.COM
  2542                                  ; PCDOS 7.1 COMMAND.COM - CODERES:053Fh ; EndInit+289
  2543                                  
  2544                                  ;InPipePtr	dw	offset DATARES:Pipe1	; 320h
  2545                                  ;OutPipePtr	dw	offset DATARES:Pipe2	; 36Fh
  2546                                  
  2547 00000436 [1503]                  InPipePtr:	dw	Pipe1 ;; 320h for MSDOS 5.0 COMMAND.COM
  2548                                  			      ; 3EAh for MSDOS 6.22 COMMAND.COM
  2549                                  		 ; 19/07/2024 ; 41Eh for PCDOS 7.1 COMMAND.COM
  2550 00000438 [6403]                  OutPipePtr:	dw	Pipe2 ;; 36Fh for MSDOS 5.0 COMMAND.COM
  2551                                  			      ; 439h for MSDOS 6.22 COMMAND.COM
  2552                                  		 ; 19/07/2024 ; 46Dh for PCDOS 7.1 COMMAND.COM
  2553                                  
  2554                                  Exec_Block:	; label	byte	; the data block for exec calls
  2555 0000043A 0000                    EnvirSeg:	dw	0
  2556                                  Com_Ptr:	; label	dword
  2557 0000043C 8000                    		dw	80h	; point at unformatted parameters
  2558 0000043E 0000                    		dw	0
  2559                                  Com_Fcb1:	; label	dword
  2560 00000440 5C00                    		dw	5Ch
  2561 00000442 0000                    		dw	0
  2562                                  Com_Fcb2:	; label	dword
  2563 00000444 6C00                    		dw	6Ch
  2564 00000446 0000                    		dw	0
  2565                                  
  2566                                  ; variables passed to transient
  2567                                  TranVars:	; label	byte
  2568                                  		;dw	offset DATARES:HeadFix_Trap
  2569 00000448 [F400]                  		dw	HeadFix_Trap
  2570 0000044A 0000                    MySeg:		dw	0	; put our own segment here
  2571 0000044C 0000                    LTpa:		dw	0	; will store tpa segment here
  2572 0000044E 2F                      RSwitChar:	db	"/"
  2573 0000044F 5C                      RDirChar:	db	"\"
  2574                                  		;dw	offset DATARES:Issue_Exec_Call
  2575 00000450 [E701]                  		dw	Issue_Exec_Call
  2576 00000452 0000                    MySeg1:		dw	0
  2577                                  		;dw	offset DATARES:RemCheck_Trap
  2578 00000454 [CC00]                  		dw	RemCheck_Trap
  2579 00000456 0000                    MySeg2:		dw	0
  2580                                  
  2581                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2582                                  ; PCDOS 7.1 COMMAND.COM
  2583                                  %if 0
  2584                                  ResTest: 	dw	0
  2585                                  %endif
  2586                                  
  2587                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0561h
  2588                                  
  2589 00000458 0000                    Res_Tpa:	dw	0	; original tpa (not rounded to 64k)
  2590                                  
  2591                                  ; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
  2592 0000045A 0000                    Y_Flag:		dw	0
  2593                                  
  2594                                  TranVarEnd:	; label	byte
  2595                                  
  2596 0000045C 0000                    OldErrNo:	dw	0
  2597                                  
  2598                                  ;* NOTE: MsgBuffer and SafePathBuffer use the same memory.
  2599                                  ;  MsgBuffer is only used while a command is being executed.
  2600                                  ;  SafePathBuffer is no longer needed, since it is used for
  2601                                  ;  unsuccessful program launches.
  2602                                  
  2603                                  MsgBuffer:	; label	byte	; buffer for messages from disk
  2604                                  SafePathBuffer: ; label	byte	; resident pathname for EXEC
  2605                                  	;Bugbug: Why so big a buffer?
  2606                                  		;db	64+3+13 dup (0)	; path + 'd:\' 'file.ext' + null
  2607 0000045E 00<rep 50h>             		times	64+3+13 db 0		
  2608                                  
  2609                                  LENMSGORPATHBUF	equ $ - MsgBuffer
  2610                                  
  2611 000004AE 00000000                Int2fHandler:	dd	0	; address of next int 2f handler
  2612 000004B2 0000                    ResMsgEnd:	dw	0	; holds offset of msg end (end of resident)
  2613                                  
  2614                                  ;SR;
  2615                                  ; The three vars below have been added for a pure COMMAND.COM
  2616                                  
  2617 000004B4 0000                    ResSize:	dw	0
  2618                                  
  2619                                  ;SR;
  2620                                  ; Moved the stack here from the code segment
  2621                                  ;
  2622                                  ; bugbug: Why this odd stack size? And what should stack size be?
  2623                                  	
  2624                                  		;db	(80h - 3) dup (?)
  2625                                  ;align 2
  2626                                  		;times	124 db 0
  2627                                  		; 19/07/2024 - PCDOS 7.1 COMMAND.COM - RESGROUP:05BFh
  2628 000004B6 00<rep 78h>             		times	120 db 0
  2629                                  
  2630                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2631                                  align 2	
  2632                                  		
  2633                                  ; MSDOS 5.0 COMMAND.COM - RESGROUP:053Eh (offset RStack)
  2634                                  ; 05/06/2023
  2635                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:060Ah (offset RStack)
  2636                                  ; 19/07/2024
  2637                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0637h (offset RStack)
  2638                                  
  2639                                  RStack:		; label	word
  2640 0000052E 0000                    OldDS:		dw	0	; keeps old ds value when jumping to
  2641                                  				; resident code segments
  2642                                  ;LoadHiFlg	db	0	; Flag set to 1 if UMB loading enabled ; M003
  2643                                  
  2644                                  ; include highvar.inc		; Add variables for 6.0 loadhigh functionality
  2645                                  ; -------------------------------
  2646                                  
  2647                                  ; fInHigh  - Is set to 1 during HideUMBs(), and back to zero in UnHideUMBs().
  2648                                  ; fUmbTiny - Is set to 1 if the user has specified /S on the command line.
  2649                                  ; SegLoad  - Segment address for first UMB specified; set automatically.
  2650                                  ; UmbLoad  - The load UMB number; for example, this is 3 if the user has
  2651                                  ;            given a command-line like "/L:3,500;4"
  2652                                  ; UmbUsed  - An array of characters, each of which is 1 iff the UMB
  2653                                  ;            matching its index number was specified on the command-line;
  2654                                  ;            for example, after "/L:3,500;4;7", UmbUsed[3], [4] and [7]
  2655                                  ;            will be set to 1. All others will be set to 0.
  2656                                  ; UmbSize  - An array of words, each of which is interpereted as a size
  2657                                  ;            specified by the user for a UMB (in the above example, all
  2658                                  ;            elements would be zero save UmbSize[3], which would be 500.
  2659                                  ; fm_umb   - Set to the old UMB link-state (0x80 or 0x00)
  2660                                  ; fm_strat - Set to the old memory-allocation strategy (0$00000???)
  2661                                  ; fm_argc  - Number of arguments received by ParseVar() (see ParseVar()
  2662                                  ;            for details).
  2663                                  
  2664                                  ; - MSDOS 6.0 COMMAND.COM -
  2665                                  ;; To keep track of which UMBs were specified on the DH/LH command lines, and
  2666                                  ;; to keep track of the minimum sizes given for each, there're two arrays kept
  2667                                  ;; in { IO.SYS: sysinitseg / COMMAND.COM: DATARES }... each is MAXUMB elements
  2668                                  ;; big. 16 should be around 14 too many for most users, so there's no expected
  2669                                  ;; space problem (it's just such a nice round number, eh?).
  2670                                  
  2671                                  ; 05/06/2023
  2672                                  MAXUMB	equ	16
  2673                                  
  2674                                  ; 10/01/2023 - Retro DOS v4.0 COMMAND.COM
  2675                                  ; MSDOS 5.0 COMMAND.COM RESGROUP:0540h (DATARES:0540h)
  2676                                  
  2677 00000530 00                      fInHigh:	db	0
  2678                                  
  2679                                  ; MSDOS 6.0 COMMAND.COM
  2680                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  2681                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:060Dh (DATARES:060Dh)
  2682                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2683                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:063Ah (DATARES:063Ah)
  2684                                  
  2685 00000531 00                      fUmbTiny:	db	0
  2686 00000532 0000                    SegLoad:	dw	0
  2687 00000534 00                      UmbLoad:	db	0
  2688                                  
  2689                                  ; 19/07/2024
  2690                                  ; PCDOS 7.1 COMMAND.COM
  2691                                  %if 0
  2692                                  UmbUsed:	times MAXUMB db 0 ; db MAXUMB dup (?)
  2693                                  UmbSize:	times MAXUMB dw 0 ; dw MAXUMB dup (?)
  2694                                  %else
  2695                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2696                                  	UmbUsed equ MsgBuffer	; 16 bytes
  2697                                  	UmbSize equ UmbUsed+MAXUMB ; UmbUsed+16; 16 words
  2698                                  %endif
  2699                                  
  2700 00000535 00                      fm_umb:		db	0
  2701 00000536 00                      fm_strat:	db	0
  2702 00000537 00                      fm_argc:	db	0
  2703                                  
  2704                                  ; UmbLoad is set to UNSPECIFED, below, until /L:umb is read; at which point
  2705                                  ; UmbLoad is set to the UMB number given.
  2706                                  
  2707                                  ;*** MESSAGES
  2708                                  ;    and other translatable text
  2709                                  
  2710                                  ; include comrmsg.inc	; M00
  2711                                  ; ------------------------------
  2712                                  
  2713                                  ; 10/01/2023 - Retro DOS v4.0 COMMAND.COM
  2714                                  ; MSDOS 5.0 COMMAND.COM RESGROUP:0541h (DATARES:0541h)
  2715                                  
  2716                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  2717                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0644h (DATARES:0644h)
  2718                                  
  2719                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2720                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0641h (DATARES:0641h)
  2721                                  
  2722 00000538 41                      ABORT_CHAR:	db 'A'
  2723 00000539 52                      RETRY_CHAR:	db 'R'
  2724 0000053A 49                      IGNORE_CHAR:	db 'I'
  2725 0000053B 46                      FAIL_CHAR:	db 'F'
  2726 0000053C 59                      YES_CHAR:	db 'Y'
  2727 0000053D 4E                      NO_CHAR:	db 'N'
  2728 0000053E 05                      REQ_ABORT:	db 5
  2729 0000053F 41626F7274              		db 'Abort'
  2730 00000544 07                      REQ_RETRY:	db 7
  2731 00000545 2C205265747279          		db ', Retry'
  2732 0000054C 08                      REQ_IGNORE:	db 8
  2733 0000054D 2C2049676E6F7265        		db ', Ignore'
  2734 00000555 06                      REQ_FAIL:	db 6
  2735 00000556 2C204661696C            		db ', Fail'
  2736 0000055C 01                      REQ_END:	db 1
  2737 0000055D 3F                      		db '?'
  2738 0000055E 08                      MREAD:		db 8
  2739 0000055F 72656164696E6700        		db 'reading', 0
  2740 00000567 08                      MWRITE:		db 8
  2741 00000568 77726974696E6700        		db 'writing', 0
  2742 00000570 0E                      MDRIVE:		db 14
  2743 00000571 202531206472697665-     		db ' %1 drive %2',0Dh,0Ah
  2743 0000057A 2025320D0A         
  2744 0000057F 0F                      MDEVICE:	db 15
  2745 00000580 202531206465766963-     		db ' %1 device %2',0Dh,0Ah
  2745 00000589 652025320D0A       
  2746 0000058F 26                      MVOLSERIAL:	db 38
  2747 00000590 506C6561736520696E-     		db 'Please insert volume %1 serial %2-%3',0Dh,0Ah
  2747 00000599 7365727420766F6C75-
  2747 000005A2 6D6520253120736572-
  2747 000005AB 69616C2025322D2533-
  2747 000005B4 0D0A               
  2748 000005B6 25                      BADFATMSG:	db 37
  2749 000005B7 46696C6520616C6C6F-     		db 'File allocation table bad, drive %1',0Dh,0Ah
  2749 000005C0 636174696F6E207461-
  2749 000005C9 626C65206261642C20-
  2749 000005D2 64726976652025310D-
  2749 000005DB 0A                 
  2750 000005DC 15                      COMBAD:		db 21
  2751 000005DD 496E76616C69642043-     		db 'Invalid COMMAND.COM',0Dh,0Ah
  2751 000005E6 4F4D4D414E442E434F-
  2751 000005EF 4D0D0A             
  2752 000005F2 21                      PUTBACKMSG:	db 33
  2753 000005F3 496E73657274206469-     		db 'Insert disk with %1 in drive %2',0Dh,0Ah
  2753 000005FC 736B20776974682025-
  2753 00000605 3120696E2064726976-
  2753 0000060E 652025320D0A       
  2754 00000614 21                      PROMPT:		db 33
  2755 00000615 507265737320616E79-     		db 'Press any key to continue . . .',0Dh,0Ah
  2755 0000061E 206B657920746F2063-
  2755 00000627 6F6E74696E7565202E-
  2755 00000630 202E202E0D0A       
  2756 00000636 1C                      ENDBATMES:	db 28
  2757 00000637 0D0A                    		db 0Dh,0Ah
  2758 00000639 5465726D696E617465-     		db 'Terminate batch job (Y/N)?'
  2758 00000642 206261746368206A6F-
  2758 0000064B 622028592F4E293F   
  2759 00000653 13                      EXECEMES:	db 19
  2760 00000654 43616E6E6F74206578-     		db 'Cannot execute %1',0Dh,0Ah
  2760 0000065D 65637574652025310D-
  2760 00000666 0A                 
  2761 00000667 13                      EXEBAD:		db 19
  2762 00000668 4572726F7220696E20-     		db 'Error in EXE file',0Dh,0Ah
  2762 00000671 4558452066696C650D-
  2762 0000067A 0A                 
  2763 0000067B 22                      TOOBIG:		db 34
  2764 0000067C 50726F6772616D2074-     		db 'Program too big to fit in memory',0Dh,0Ah
  2764 00000685 6F6F2062696720746F-
  2764 0000068E 2066697420696E206D-
  2764 00000697 656D6F72790D0A     
  2765 0000069E 16                      NOHANDMES:	db 22
  2766 0000069F 0D0A                    		db 0Dh,0Ah
  2767 000006A1 4E6F20667265652066-     		db 'No free file handles'
  2767 000006AA 696C652068616E646C-
  2767 000006B3 6573               
  2768 000006B5 1A                      RBADNAM:	db 26
  2769 000006B6 42616420436F6D6D61-     		db 'Bad Command or file name',0Dh,0Ah
  2769 000006BF 6E64206F722066696C-
  2769 000006C8 65206E616D650D0A   
  2770                                  ACCDENIED:	; 14/01/2023
  2771                                  		; 10/01/2023
  2772                                  ACCDEN:		;db 14
  2773                                  		;db 'Access denied '
  2774                                  		; 19/07/2024 - PCDOS 7.1
  2775 000006D0 0D                      		db 13
  2776 000006D1 416363657373206465-     		db 'Access denied'
  2776 000006DA 6E696564           
  2777 000006DE 19                      BMEMMES:	db 25
  2778 000006DF 0D0A4D656D6F727920-     		db 0Dh,0Ah,'Memory allocation error'
  2778 000006E8 616C6C6F636174696F-
  2778 000006F1 6E206572726F72     
  2779 000006F8 26                      HALTMES:	db 38
  2780 000006F9 0D0A                    		db 0Dh,0Ah
  2781 000006FB 43616E6E6F74206C6F-     		db 'Cannot load COMMAND, system halted',0Dh,0Ah
  2781 00000704 616420434F4D4D414E-
  2781 0000070D 442C2073797374656D-
  2781 00000716 2068616C7465640D0A 
  2782 0000071F 21                      FRETMES:	db 33
  2783 00000720 0D0A                    		db 0Dh,0Ah,
  2784 00000722 43616E6E6F74207374-     		db 'Cannot start COMMAND, exiting',0Dh,0Ah
  2784 0000072B 61727420434F4D4D41-
  2784 00000734 4E442C206578697469-
  2784 0000073D 6E670D0A           
  2785                                  ; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  2786                                  %if 0
  2787                                  ;%if 1  ; 20/07/2024 - Retro DOS v5.1 COMMAND.COM
  2788                                  PATRICIDE:	db 46
  2789                                  		db 0Dh,0Ah
  2790                                  		db 'Top level process aborted, cannot continue'
  2791                                  		db 0Dh,0Ah
  2792                                  %endif
  2793 00000741 02                      NEWLINE:	db 2
  2794 00000742 0D0A                    		db 0Dh, 0Ah
  2795                                  
  2796                                  ; 10/01/2023
  2797                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:077Dh
  2798                                  ; 05/06/2023
  2799                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0880h
  2800                                  
  2801                                  ; 19/07/2024
  2802                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0832h
  2803                                  
  2804 00000744 [280C]                  MsgPtrLists:	dw EXTMSGPTRS		; extended error messages
  2805 00000746 0100                    		dw 1
  2806 00000748 [E309]                  		dw PARSMSGPTRS		; parse	error messages
  2807 0000074A 0100                    		dw 1
  2808 0000074C [280C]                  		dw EXTMSGPTRS		; critical error messages
  2809 0000074E 0100                    		dw 1
  2810 00000750 0000                    		dw 0			; File system error messages
  2811 00000752 0000                    		dw 0			; are not supported.
  2812 00000754 [EA00]                  		dw MsgRetrv_Trap	; disk retriever routine
  2813 00000756 0000                    MySeg3:		dw 0			; segment of retriever routine
  2814                                  
  2815                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0791h
  2816                                  ; 05/06/2023
  2817                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0894h
  2818                                  
  2819                                  ; 19/07/2024
  2820                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0846h
  2821                                  
  2822 00000758 13                      CRMSG0:		db 19
  2823 00000759 57726974652070726F-     		db 'Write protect error'
  2823 00000762 74656374206572726F-
  2823 0000076B 72                 
  2824 0000076C 0C                      CRMSG1:		db 12
  2825 0000076D 496E76616C69642075-     		db 'Invalid unit'
  2825 00000776 6E6974             
  2826 00000779 09                      CRMSG2:		db 9
  2827 0000077A 4E6F74207265616479      		db 'Not ready'
  2828 00000783 16                      CRMSG3:		db 22
  2829 00000784 496E76616C69642064-     		db 'Invalid device request'
  2829 0000078D 657669636520726571-
  2829 00000796 75657374           
  2830 0000079A 0A                      CRMSG4:		db 10
  2831 0000079B 44617461206572726F-     		db 'Data error'
  2831 000007A4 72                 
  2832 000007A5 21                      CRMSG5:		db 33
  2833 000007A6 496E76616C69642064-     		db 'Invalid device request parameters'
  2833 000007AF 657669636520726571-
  2833 000007B8 756573742070617261-
  2833 000007C1 6D6574657273       
  2834 000007C7 0A                      CRMSG6:		db 10
  2835 000007C8 5365656B206572726F-     		db 'Seek error'
  2835 000007D1 72                 
  2836 000007D2 12                      CRMSG7:		db 18
  2837 000007D3 496E76616C6964206D-     		db 'Invalid media type'
  2837 000007DC 656469612074797065 
  2838 000007E5 10                      CRMSG8:		db 16
  2839 000007E6 536563746F72206E6F-     		db 'Sector not found'
  2839 000007EF 7420666F756E64     
  2840 000007F6 1A                      CRMSG9:		db 26
  2841 000007F7 5072696E746572206F-     		db 'Printer out of paper error'
  2841 00000800 7574206F6620706170-
  2841 00000809 6572206572726F72   
  2842 00000811 11                      CRMSG10:	db 17
  2843 00000812 577269746520666175-     		db 'Write fault error'
  2843 0000081B 6C74206572726F72   
  2844 00000823 10                      CRMSG11:	db 16
  2845 00000824 52656164206661756C-     		db 'Read fault error'
  2845 0000082D 74206572726F72     
  2846 00000834 0F                      CRMSG12:	db 15
  2847 00000835 47656E6572616C2066-     		db 'General failure'
  2847 0000083E 61696C757265       
  2848 00000844 11                      CRMSG13:	db 17
  2849 00000845 53686172696E672076-     		db 'Sharing violation'
  2849 0000084E 696F6C6174696F6E   
  2850 00000856 0E                      CRMSG14:	db 14
  2851 00000857 4C6F636B2076696F6C-     		db 'Lock violation'
  2851 00000860 6174696F6E         
  2852 00000865 13                      CRMSG15:	db 19
  2853 00000866 496E76616C69642064-     		db 'Invalid disk change'
  2853 0000086F 69736B206368616E67-
  2853 00000878 65                 
  2854 00000879 0F                      CRMSG16:	db 15
  2855 0000087A 46434220756E617661-     		db 'FCB unavailable'
  2855 00000883 696C61626C65       
  2856 00000889 19                      CRMSG17:	db 25
  2857 0000088A 53797374656D207265-     		db 'System resource exhausted'
  2857 00000893 736F75726365206578-
  2857 0000089C 68617573746564     
  2858 000008A3 12                      CRMSG18:	db 18
  2859 000008A4 436F64652070616765-     		db 'Code page mismatch'
  2859 000008AD 206D69736D61746368 
  2860 000008B6 0C                      CRMSG19:	db 12
  2861 000008B7 4F7574206F6620696E-     		db 'Out of input'
  2861 000008C0 707574             
  2862 000008C3 17                      CRMSG20:	db 23
  2863 000008C4 496E73756666696369-     		db 'Insufficient disk space'
  2863 000008CD 656E74206469736B20-
  2863 000008D6 7370616365         
  2864                                  
  2865                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0914h
  2866                                  ; 05/06/2023
  2867                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0A17h
  2868                                  
  2869                                  ; 19/07/2024
  2870                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:09C9h
  2871                                  
  2872 000008DB [5807]                  CRITMSGPTRS:	dw CRMSG0
  2873 000008DD [6C07]                  		dw CRMSG1
  2874 000008DF [7907]                  		dw CRMSG2
  2875 000008E1 [8307]                  		dw CRMSG3
  2876 000008E3 [9A07]                  		dw CRMSG4
  2877 000008E5 [A507]                  		dw CRMSG5
  2878 000008E7 [C707]                  		dw CRMSG6
  2879 000008E9 [D207]                  		dw CRMSG7
  2880 000008EB [E507]                  		dw CRMSG8
  2881 000008ED [F607]                  		dw CRMSG9
  2882 000008EF [1108]                  		dw CRMSG10
  2883 000008F1 [2308]                  		dw CRMSG11
  2884 000008F3 [3408]                  		dw CRMSG12
  2885 000008F5 [4408]                  		dw CRMSG13
  2886 000008F7 [5608]                  		dw CRMSG14
  2887 000008F9 [6508]                  		dw CRMSG15
  2888 000008FB [7908]                  		dw CRMSG16
  2889 000008FD [8908]                  		dw CRMSG17
  2890 000008FF [A308]                  		dw CRMSG18
  2891 00000901 [B608]                  		dw CRMSG19
  2892 00000903 [C308]                  		dw CRMSG20
  2893                                  
  2894                                  		; 14/01/2023
  2895                                  ;DataresEnd:	;; MSDOS 5.0 COMMAND.COM - DATARES:093Eh (RESGROUP:093Eh)
  2896                                  		; 05/06/2023
  2897                                  DataresEnd:	; MSDOS 6.22 COMMAND.COM - DATARES:0A41h (RESGROUP:0A41h)
  2898                                  
  2899 00000905 13                      PAERRMSG0:	db 19
  2900 00000906 546F6F206D616E7920-     		db 'Too many parameters'
  2900 0000090F 706172616D65746572-
  2900 00000918 73                 
  2901 00000919 1A                      PAERRMSG1:	db 26
  2902 0000091A 526571756972656420-     		db 'Required parameter missing'
  2902 00000923 706172616D65746572-
  2902 0000092C 206D697373696E67   
  2903 00000934 0E                      PAERRMSG2:	db 14
  2904 00000935 496E76616C69642073-     		db 'Invalid switch'
  2904 0000093E 7769746368         
  2905 00000943 0F                      PAERRMSG3:	db 15
  2906 00000944 496E76616C6964206B-     		db 'Invalid keyword'
  2906 0000094D 6579776F7264       
  2907 00000953 01                      PAERRMSG4:	db 1
  2908 00000954 20                      		db 20h
  2909 00000955 24                      PAERRMSG5:	db 36
  2910 00000956 506172616D65746572-     		db 'Parameter value not in allowed range'
  2910 0000095F 2076616C7565206E6F-
  2910 00000968 7420696E20616C6C6F-
  2910 00000971 7765642072616E6765 
  2911                                  PAERRMSG6:	; 10/01/2023
  2912 0000097A 1B                      PAERRMSG7:	db 27
  2913 0000097B 506172616D65746572-     		db 'Parameter value not allowed'
  2913 00000984 2076616C7565206E6F-
  2913 0000098D 7420616C6C6F776564 
  2914                                  ;PAERRMSG7:	db 27
  2915                                  ;		db 'Parameter value not allowed'
  2916 00000996 1C                      PAERRMSG8:	db 28
  2917 00000997 506172616D65746572-     		db 'Parameter format not correct'
  2917 000009A0 20666F726D6174206E-
  2917 000009A9 6F7420636F72726563-
  2917 000009B2 74                 
  2918 000009B3 11                      PAERRMSG9:	db 17
  2919 000009B4 496E76616C69642070-     		db 'Invalid parameter'
  2919 000009BD 6172616D65746572   
  2920 000009C5 1D                      PAERRMSG10:	db 29
  2921 000009C6 496E76616C69642070-     		db 'Invalid parameter combination'
  2921 000009CF 6172616D6574657220-
  2921 000009D8 636F6D62696E617469-
  2921 000009E1 6F6E               
  2922                                  
  2923                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0A38h
  2924                                  ; 05/06/2023
  2925                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0B3Bh
  2926                                  
  2927                                  ; 19/07/2024
  2928                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0AD1h
  2929                                  
  2930 000009E3 [0509]                  PARSMSGPTRS:	dw PAERRMSG0
  2931 000009E5 [1909]                  		dw PAERRMSG1
  2932 000009E7 [3409]                  		dw PAERRMSG2
  2933 000009E9 [4309]                  		dw PAERRMSG3
  2934 000009EB [5309]                  		dw PAERRMSG4
  2935 000009ED [5509]                  		dw PAERRMSG5
  2936 000009EF [7A09]                  		dw PAERRMSG6
  2937 000009F1 [7A09]                  		dw PAERRMSG7
  2938 000009F3 [9609]                  		dw PAERRMSG8
  2939 000009F5 [B309]                  		dw PAERRMSG9
  2940 000009F7 [C509]                  		dw PAERRMSG10
  2941                                  ; 21/04/2023
  2942                                  NUMPARSMSGS equ ($-PARSMSGPTRS)>>1 ; 14/01/2023
  2943                                  
  2944 000009F9 10                      INVLFUNCT:	db 16
  2945 000009FA 496E76616C69642066-     		db 'Invalid function'
  2945 00000A03 756E6374696F6E     
  2946 00000A0A 0E                      FNOTFOUND:	db 14
  2947 00000A0B 46696C65206E6F7420-     		db 'File not found'
  2947 00000A14 666F756E64         
  2948 00000A19 0E                      PNOTFOUND:	db 14
  2949 00000A1A 50617468206E6F7420-     		db 'Path not found'
  2949 00000A23 666F756E64         
  2950 00000A28 13                      TOOMANYOF:	db 19
  2951 00000A29 546F6F206D616E7920-     		db 'Too many open files'
  2951 00000A32 6F70656E2066696C65-
  2951 00000A3B 73                 
  2952                                  ; 14/01/2023
  2953                                  ;ACCDEN:	; 10/01/2023
  2954                                  ;ACCDENIED:	db 14
  2955                                  ;		db 'Access denied '
  2956 00000A3C 0E                      INVHANDLE:	db 14
  2957 00000A3D 496E76616C69642068-     		db 'Invalid handle'
  2957 00000A46 616E646C65         
  2958 00000A4B 1F                      MEMCBDEST:	db 31
  2959 00000A4C 4D656D6F727920636F-     		db 'Memory control blocks destroyed'
  2959 00000A55 6E74726F6C20626C6F-
  2959 00000A5E 636B73206465737472-
  2959 00000A67 6F796564           
  2960 00000A6B 13                      INSUFFMEM:	db 19
  2961 00000A6C 496E73756666696369-     		db 'Insufficient memory'
  2961 00000A75 656E74206D656D6F72-
  2961 00000A7E 79                 
  2962 00000A7F 1C                      INVMEMBLA:	db 28
  2963 00000A80 496E76616C6964206D-     		db 'Invalid memory block address'
  2963 00000A89 656D6F727920626C6F-
  2963 00000A92 636B20616464726573-
  2963 00000A9B 73                 
  2964 00000A9C 13                      INVENVIRO:	db 19
  2965 00000A9D 496E76616C69642045-     		db 'Invalid Environment'
  2965 00000AA6 6E7669726F6E6D656E-
  2965 00000AAF 74                 
  2966 00000AB0 0E                      INVFORMAT:	db 14
  2967 00000AB1 496E76616C69642066-     		db 'Invalid format'
  2967 00000ABA 6F726D6174         
  2968 00000ABF 1A                      INVFNPARM:	db 26
  2969 00000AC0 496E76616C69642066-     		db 'Invalid function parameter'
  2969 00000AC9 756E6374696F6E2070-
  2969 00000AD2 6172616D65746572   
  2970 00000ADA 0C                      INVLDDATA:	db 12
  2971 00000ADB 496E76616C69642064-     		db 'Invalid data'
  2971 00000AE4 617461             
  2972 00000AE7 1B                      INVDRVSPC:	db 27
  2973 00000AE8 496E76616C69642064-     		db 'Invalid drive specification'
  2973 00000AF1 726976652073706563-
  2973 00000AFA 696669636174696F6E 
  2974 00000B03 23                      ATRCURDIR:	db 35
  2975 00000B04 417474656D70742074-     		db 'Attempt to remove current directory'
  2975 00000B0D 6F2072656D6F766520-
  2975 00000B16 63757272656E742064-
  2975 00000B1F 69726563746F7279   
  2976 00000B27 0F                      NOTSAMDEV:	db 15
  2977 00000B28 4E6F742073616D6520-     		db 'Not same device'
  2977 00000B31 646576696365       
  2978 00000B37 0D                      NOMOREFIL:	db 13
  2979 00000B38 4E6F206D6F72652066-     		db 'No more files'
  2979 00000B41 696C6573           
  2980 00000B45 0B                      FILEXISTS:	db 11
  2981 00000B46 46696C652065786973-     		db 'File exists'
  2981 00000B4F 7473               
  2982 00000B51 1B                      CANTMKDIR:	db 27
  2983 00000B52 43616E6E6F74206D61-     		db 'Cannot make directory entry'
  2983 00000B5B 6B6520646972656374-
  2983 00000B64 6F727920656E747279 
  2984 00000B6D 0E                      FAILINT24:	db 14
  2985 00000B6E 4661696C206F6E2049-     		db 'Fail on INT 24'
  2985 00000B77 4E54203234         
  2986 00000B7C 15                      TOOMANYRD:	db 21
  2987 00000B7D 546F6F206D616E7920-     		db 'Too many redirections'
  2987 00000B86 726564697265637469-
  2987 00000B8F 6F6E73             
  2988 00000B92 15                      DUPLREDIR:	db 21
  2989 00000B93 4475706C6963617465-     		db 'Duplicate redirection'
  2989 00000B9C 207265646972656374-
  2989 00000BA5 696F6E             
  2990 00000BA8 10                      INVPASSWD:	db 16
  2991 00000BA9 496E76616C69642070-     		db 'Invalid password'
  2991 00000BB2 617373776F7264     
  2992 00000BB9 11                      INVLDPARM:	db 17
  2993 00000BBA 496E76616C69642070-     		db 'Invalid parameter'
  2993 00000BC3 6172616D65746572   
  2994 00000BCB 12                      NETDATFAU:	db 18
  2995 00000BCC 4E6574776F726B2064-     		db 'Network data fault'
  2995 00000BD5 617461206661756C74 
  2996 00000BDE 21                      FNOSUPNET:	db 33
  2997 00000BDF 46756E6374696F6E20-     		db 'Function not supported by network'
  2997 00000BE8 6E6F7420737570706F-
  2997 00000BF1 72746564206279206E-
  2997 00000BFA 6574776F726B       
  2998 00000C00 27                      RSCNOTINS:	db 39
  2999 00000C01 526571756972656420-     		db 'Required system component not installed'
  2999 00000C0A 73797374656D20636F-
  2999 00000C13 6D706F6E656E74206E-
  2999 00000C1C 6F7420696E7374616C-
  2999 00000C25 6C6564             
  3000                                  
  3001                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0C8Ch
  3002                                  ; 05/06/2023
  3003                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0D8Fh
  3004                                  
  3005                                  ; 19/07/2024
  3006                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0D24h
  3007                                  
  3008 00000C28 [F909]                  EXTMSGPTRS:	dw INVLFUNCT
  3009 00000C2A [0A0A]                  		dw FNOTFOUND
  3010 00000C2C [190A]                  		dw PNOTFOUND
  3011 00000C2E [280A]                  		dw TOOMANYOF
  3012 00000C30 [D006]                  		dw ACCDENIED
  3013 00000C32 [3C0A]                  		dw INVHANDLE
  3014 00000C34 [4B0A]                  		dw MEMCBDEST
  3015 00000C36 [6B0A]                  		dw INSUFFMEM
  3016 00000C38 [7F0A]                  		dw INVMEMBLA
  3017 00000C3A [9C0A]                  		dw INVENVIRO
  3018 00000C3C [B00A]                  		dw INVFORMAT
  3019 00000C3E [BF0A]                  		dw INVFNPARM
  3020 00000C40 [DA0A]                  		dw INVLDDATA
  3021 00000C42 0000                    		dw 0
  3022 00000C44 [E70A]                  		dw INVDRVSPC
  3023 00000C46 [030B]                  		dw ATRCURDIR
  3024 00000C48 [270B]                  		dw NOTSAMDEV
  3025 00000C4A [370B]                  		dw NOMOREFIL
  3026 00000C4C [5807]                  		dw CRMSG0
  3027 00000C4E [6C07]                  		dw CRMSG1
  3028 00000C50 [7907]                  		dw CRMSG2
  3029 00000C52 [8307]                  		dw CRMSG3
  3030 00000C54 [9A07]                  		dw CRMSG4
  3031 00000C56 [A507]                  		dw CRMSG5
  3032 00000C58 [C707]                  		dw CRMSG6
  3033 00000C5A [D207]                  		dw CRMSG7
  3034 00000C5C [E507]                  		dw CRMSG8
  3035 00000C5E [F607]                  		dw CRMSG9
  3036 00000C60 [1108]                  		dw CRMSG10
  3037 00000C62 [2308]                  		dw CRMSG11
  3038 00000C64 [3408]                  		dw CRMSG12
  3039 00000C66 [4408]                  		dw CRMSG13
  3040 00000C68 [5608]                  		dw CRMSG14
  3041 00000C6A [6508]                  		dw CRMSG15
  3042 00000C6C [7908]                  		dw CRMSG16
  3043 00000C6E [8908]                  		dw CRMSG17
  3044 00000C70 [A308]                  		dw CRMSG18
  3045 00000C72 [B608]                  		dw CRMSG19
  3046 00000C74 [C308]                  		dw CRMSG20
  3047 00000C76 0000<rep 28h>           		times 40 dw 0	; db 80 dup(0)
  3048 00000CC6 [450B]                  		dw FILEXISTS
  3049 00000CC8 0000                    		dw 0
  3050 00000CCA [510B]                  		dw CANTMKDIR
  3051 00000CCC [6D0B]                  		dw FAILINT24
  3052 00000CCE [7C0B]                  		dw TOOMANYRD
  3053 00000CD0 [920B]                  		dw DUPLREDIR
  3054 00000CD2 [A80B]                  		dw INVPASSWD
  3055 00000CD4 [B90B]                  		dw INVLDPARM
  3056 00000CD6 [CB0B]                  		dw NETDATFAU
  3057 00000CD8 [DE0B]                  		dw FNOSUPNET
  3058 00000CDA [000C]                  		dw RSCNOTINS
  3059                                  ; ----------------------------------------------------------------------------
  3060                                  	; 17/04/2023
  3061                                  ExtMsgEnd:
  3062                                  
  3063                                  ; 21/04/2023
  3064                                  NUMEXTMSGS equ ($-EXTMSGPTRS)>>1 ; 14/01/2023
  3065                                  
  3066                                  ; ----------------------------------------------------------------------------
  3067                                  ; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  3068                                  %if 1	;  20/07/2024
  3069 00000CDC 2E                      PATRICIDE:	db 46
  3070 00000CDD 0D0A                    		db 0Dh,0Ah
  3071 00000CDF 546F70206C6576656C-     		db 'Top level process aborted, cannot continue'
  3071 00000CE8 2070726F6365737320-
  3071 00000CF1 61626F727465642C20-
  3071 00000CFA 63616E6E6F7420636F-
  3071 00000D03 6E74696E7565       
  3072 00000D09 0D0A                    		db 0Dh,0Ah
  3073                                  %endif
  3074                                  
  3075                                  ; ----------------------------------------------------------------------------
  3076                                  
  3077                                  ; 20/04/2023
  3078                                  
  3079 00000D0B 90<rep 5h>              align 16
  3080                                  
  3081                                  ; ----------------------------------------------------------------------------
  3082                                  
  3083                                  ; 10/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  3084                                  ;; MSDOS 5.0 COMMAND.COM - RESGROUP:0D40h (CODERES:0000h)
  3085                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  3086                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:0E50h (CODERES:0000h)
  3087                                  
  3088                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3089                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0E10h (CODERES:0000h)
  3090                                  
  3091                                  ; ----------------------------------------------------------------------------
  3092                                  ; SEGMENT - CODERES
  3093                                  ; ----------------------------------------------------------------------------
  3094                                  
  3095                                  ; 11/01/2023
  3096                                  RCODE_START:	
  3097                                  
  3098                                  ; ----------------------------------------------------------------------------
  3099                                  ;***	EXEC error handling
  3100                                  ;
  3101                                  ;	COMMAND has issued an EXEC system call and it has returned an error.
  3102                                  ;	We examine the error code and select an appropriate message.
  3103                                  ; --------------------------
  3104                                  ;	Bugbug:	optimize reg usage in following code? Careful of DX!
  3105                                  ;	Condense the error scan?
  3106                                  ;	RBADNAM is checked by transient, no need here?
  3107                                  ;	Move below Ext_Exec.
  3108                                  ; ----------------------------------------------------------------------------
  3109                                  
  3110                                  Exec_Err:
  3111                                  ;SR;
  3112                                  ; ds,es are setup when the transient jumps to Ext_Exec. So segment regs are
  3113                                  ; in order here
  3114                                  
  3115                                  ;	Bugbug:	can we use byte compares here?
  3116                                  ;	Might be able to use byte msg#s, too.
  3117                                  
  3118                                  ;	Store errors in a 3 or 4 byte table. Msg #s in another.
  3119                                  ;	Speed not high priority here.
  3120                                  
  3121                                  ;	Move this to transient.
  3122                                  
  3123                                  	; 10/01/2023
  3124                                  
  3125                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3126                                  ;if 0	; PCDOS 7.1 COMMAND.COM doesn't use 'RBADNAM' error msg here 
  3127                                  %if 1	; Retro DOS v5.0 COMMAND.COM (and MSDOS 6.22 COMMAND.COM)
  3128                                  	;mov	bx,RBADNAM	; offset DATARES:RBadNam
  3129 00000D10 BA[B506]                	mov	dx,RBADNAM
  3130 00000D13 3C02                    	cmp	al,ERROR_FILE_NOT_FOUND ; 2
  3131 00000D15 741B                    	je	short GotExecEMes		; bad command
  3132                                  %endif
  3133                                  	;mov	bx,TOOBIG	; offset DATARES:TooBig
  3134 00000D17 BA[7B06]                	mov	dx,TOOBIG
  3135 00000D1A 3C08                    	cmp	al,ERROR_NOT_ENOUGH_MEMORY ; 8
  3136 00000D1C 7414                    	je	short GotExecEMes		; file not found
  3137                                  	;mov	bx,EXEBAD	; offset DATARES:ExeBad
  3138 00000D1E BA[6706]                	mov	dx,EXEBAD
  3139 00000D21 3C0B                    	cmp	al,ERROR_BAD_FORMAT ; 11 ; 0Bh
  3140 00000D23 740D                    	je	short GotExecEMes		; bad exe file
  3141                                  	;mov	bx,ACCDEN	; offset DATARES:AccDen
  3142 00000D25 BA[D006]                	mov	dx,ACCDEN
  3143 00000D28 3C05                    	cmp	al,ERROR_ACCESS_DENIED ; 5
  3144 00000D2A 7406                    	je	short GotExecEMes		; access denied
  3145                                  
  3146                                  Default_Message:
  3147                                  	;mov	bx,EXECEMES	; offset DATARES:ExecEMes
  3148 00000D2C BA[5306]                	mov	dx,EXECEMES
  3149                                  						; default message
  3150 00000D2F BE[3002]                	mov	si,ExecErrSubst ; offset DATARES:ExecErrSubst
  3151                                  						; get address of subst block
  3152                                  GotExecEMes:
  3153                                  	;mov	dx,bx				; DX = ptr to msg
  3154 00000D32 E8A606                  	call	RPrint ; invoke	RPrint
  3155 00000D35 EB09                    	jmp	short NoExec
  3156                                  
  3157                                  ; ----------------------------------------------------------------------------
  3158                                  ;***	EXEC call
  3159                                  ;
  3160                                  ;	The transient has set up everything for an EXEC system call.
  3161                                  ;	For cleanliness, we issue the EXEC here in the resident 
  3162                                  ;	so that we may be able to recover cleanly upon success.
  3163                                  ;
  3164                                  ;	CS,DS,ES,SS = DATARES seg addr
  3165                                  ; ----------------------------------------------------------------------------
  3166                                  
  3167                                  Ext_Exec:
  3168                                  ;SR;
  3169                                  ; The words put on the stack by the stub will be popped off when we finally
  3170                                  ;jump to LodCom (by LodCom).
  3171                                  
  3172                                  	; 10/01/2023
  3173                                  	;int	21h			; do the exec
  3174                                  	; 10/01/2023 - MSDOS 5.0 COMMAND.COM - RESGROUP:0D69h (CODERES:0029h)
  3175                                  Exec_Ret:
  3176 00000D37 72D7                    	jc	short Exec_Err		; exec failed
  3177                                  
  3178                                  ;	The exec has completed. Retrieve the exit code.
  3179                                  
  3180                                  Exec_Wait:
  3181 00000D39 B44D                    	mov	ah,4Dh
  3182                                  	;mov	ah,WAITPROCESS ; 4Dh	; get errorlevel
  3183 00000D3B CD21                    	int	21h			; get the return code
  3184                                  	;mov	[cs:RetCode],ax
  3185                                  	; 11/01/2023
  3186 00000D3D A3[9A02]                	mov	[RetCode],ax
  3187                                  
  3188                                  ;	See if we can reload the transient. The external command
  3189                                  ;	may have overwritten part of the transient.
  3190                                  
  3191                                  NoExec:
  3192                                  ;SR;
  3193                                  ; ds = es = ss = DATARES when we jump to LodCom
  3194                                  ;
  3195 00000D40 E97A01                  	jmp	LodCom
  3196                                  
  3197                                  ; ----------------------------------------------------------------------------
  3198                                  ;***	Int 23 (ctrl-c) handler
  3199                                  ;
  3200                                  ;	This is the default system INT 23 handler. All processes
  3201                                  ;	(including COMMAND) get it by default. There are some
  3202                                  ;	games that are played: We ignore ^C during most of the
  3203                                  ;	INIT code. This is because we may perform an ALLOC and
  3204                                  ;	diddle the header! Also, if we are prompting for date/time
  3205                                  ;	in the init code, we are to treat ^C as empty responses.
  3206                                  ; ---------------------------
  3207                                  ;	Bugbug:	put init ctrl-c handling in init module.
  3208                                  ; ----------------------------------------------------------------------------
  3209                                  
  3210                                  ;SR;
  3211                                  ;The stub has pushed the previous ds and DATARES onto the stack. We get
  3212                                  ;both these values off the stack now
  3213                                  ;
  3214                                  ;ContC	proc	far
  3215                                  
  3216                                  ;	assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  3217                                  
  3218                                  	; 11/01/2023 - Retro DOS v5.40 COMMAND.COM
  3219                                  	; MSDOS 5.0 COMMAND.COM RESGROUP:0D75h (CODERES:0035h)
  3220                                  ContC:
  3221 00000D43 1F                      	pop	ds			; ds = DATARES
  3222                                  ;	assume	ds:DATARES
  3223                                  ;;	pop	word [OldDS]		; OldDS = old ds
  3224                                  
  3225 00000D44 F606[1203]01            	test	byte [InitFlag],INITINIT ; 1
  3226                                  	;test	byte [cs:INITFLAG],INITINIT ; 1	; in initialization?
  3227 00000D49 740D                    	jz	short NotAtInit		; no
  3228 00000D4B F606[1203]02            	test	byte [InitFlag],INITSPECIAL ; 2 
  3229                                  	;test	byte [cs:INITFLAG],INITSPECIAL ; 2 ; doing special stuff?
  3230 00000D50 7404                    	jz	short CmdIret		; no, ignore ^C
  3231 00000D52 1F                      	pop	ds			; restore before jumping; M021
  3232                                  	;jmp	RESGROUP:Init_ContC_SpecialCase ; Yes, go handle it
  3233 00000D53 E9E90F                  	jmp	init_contc_specialcase
  3234                                  CmdIret:
  3235                                  ;SR;
  3236                                  ; Restore ds to its previous value
  3237                                  ;
  3238                                  
  3239                                  ;;	mov	ds,[OLdDS]		;
  3240 00000D56 1F                      	pop	ds
  3241 00000D57 CF                      	iret				; yes, ignore the ^C
  3242                                  
  3243                                  NotAtInit:
  3244 00000D58 F606[1203]04            	test	byte [InitFlag],INITCTRLC ; 4
  3245                                  	;test	byte [cs:INITFLAG],INITCTRLC ; 4 ; are we already in a ^C?
  3246 00000D5D 7411                    	jz	short NotInit 		; nope too.
  3247                                  
  3248                                  ;*	We are interrupting ourselves in this ^C handler. We need
  3249                                  ;	to set carry and return to the user sans flags only if the
  3250                                  ;	system call was a 1-12 one. Otherwise, we ignore the ^C.
  3251                                  
  3252                                  	;cmp	ah,1
  3253                                  	;jb	short CmdIret
  3254                                  	; 19/07/2024
  3255 00000D5F 84E4                    	test	ah,ah
  3256 00000D61 74F3                    	jz	short CmdIret
  3257                                  
  3258 00000D63 80FC0C                  	cmp	ah,12
  3259 00000D66 77EE                    	ja	short CmdIret
  3260                                  
  3261 00000D68 1F                      	pop	ds			;restore ds to old value
  3262 00000D69 83C406                  	add	sp,6			; remove int frame
  3263 00000D6C F9                      	stc
  3264                                  
  3265                                  ;;	mov	ds,[OldDS]		;restore ds to its old value
  3266 00000D6D CA0200                  	retf	2			; remove those flags...
  3267                                  
  3268                                  NotInit:
  3269                                  
  3270                                  ;*	We have now received a ^C for some process (maybe ourselves
  3271                                  ;	but not at INIT).
  3272                                  ;	
  3273                                  ;	Note that we are running on the user's stack!!! Bad news if
  3274                                  ;	any of the system calls below go and issue another INT
  3275                                  ;	24... Massive stack overflow! Another bad point is that
  3276                                  ;	SavHand will save an already saved handle, thus losing a
  3277                                  ;	possible redirection...
  3278                                  ;	
  3279                                  ;	All we need to do is set the flag to indicate nested ^C. 
  3280                                  ;	The above code will correctly flag the ^C diring the
  3281                                  ;	message output and prompting while ignoring the ^C the rest
  3282                                  ;	of the time.
  3283                                  ;	
  3284                                  ;	Clean up: flush disk. If we are in the middle of a batch
  3285                                  ;	file, we ask if he wants to terminate it. If he does, then
  3286                                  ;	we turn off all internal flags and let the DOS abort.
  3287                                  
  3288 00000D70 800E[1203]04            	or	byte [InitFlag],INITCTRLC ; 4
  3289                                  	;or	byte [cs:INITFLAG],INITCTRLC ; 4 ; nested ^c is on
  3290 00000D75 FB                      	sti
  3291                                  
  3292                                  ;	push	cs			; el yucko! change the user's ds!!
  3293                                  ;	pop	ds
  3294                                  
  3295                                  ;	assume	ds:RESGROUP
  3296                                  
  3297 00000D76 58                      	pop	ax			; discard the old ds value
  3298                                  
  3299 00000D77 A1[A502]                	mov	ax,[SingleCom]
  3300 00000D7A 09C0                    	or	ax,ax
  3301 00000D7C 7506                    	jnz	short NoReset
  3302 00000D7E 50                      	push	ax
  3303 00000D7F B40D                    	mov	ah,DISK_RESET ; 0Dh
  3304 00000D81 CD21                    	int	21h			; reset disks in case files were open
  3305 00000D83 58                      	pop	ax
  3306                                  
  3307                                  NoReset:
  3308                                  
  3309                                  ;	In the generalized version of FOR, PIPE and BATCH, we would
  3310                                  ;	walk the entire active list and free each segment. Here,
  3311                                  ;	we just free the single batch segment.
  3312                                  
  3313 00000D84 F706[4902]FFFF          	test	word [Batch],-1 ; 0FFFFh
  3314 00000D8A 7452                    	jz	short ContCTerm
  3315 00000D8C 09C0                    	or	ax,ax
  3316 00000D8E 754E                    	jnz	short ContCTerm
  3317 00000D90 E89402                  	call	SavHand
  3318 00000D93 E8D903                  	call	AskEnd			; ask if user wants to end batch
  3319                                  
  3320                                  ;	If the carry flag is clear, we do NOT free up the batch file
  3321                                  
  3322 00000D96 7340                    	jnc	short ContBatch
  3323 00000D98 8A0E[9D02]              	mov	cl,[EchoFlag]		; get current echo flag
  3324 00000D9C 53                      	push	bx
  3325                                  
  3326                                  ClearBatch:
  3327 00000D9D 8E06[4902]              	mov	es,[Batch]		; get batch segment
  3328                                  	;mov	di,20h
  3329 00000DA1 8B3E2000                	mov	di,[BATCHSEGMENT.BatFile] ; get offset of batch file name
  3330                                  	; MSDOS 5.0 & MSDOS 6.0 (ES:5)
  3331                                  	;mov	bx,es:BatForPtr		; get old FOR segment
  3332 00000DA5 268B1E0500              	mov	bx,[es:BATCHSEGMENT.BatForPtr] ; [es:5]
  3333                                  	; MSDOS 3.3 ([ES:4])
  3334                                  	;mov	bx,[es:BATCHSEGMENT.BatForPtr] ; [es:4] ; get old FOR segment
  3335                                  	;
  3336                                  	; 19/07/2024
  3337                                  	;cmp	bx,0			; is a FOR in progress
  3338                                  	;je	short No_Bat_For	; no - don't deallocate
  3339 00000DAA 85DB                    	test	bx,bx
  3340 00000DAC 7408                    	jz	short No_Bat_For
  3341                                  
  3342 00000DAE 06                      	push	es			;
  3343 00000DAF 8EC3                    	mov	es,bx			; yes - free it up...
  3344 00000DB1 B449                    	mov	ah,49h
  3345                                  	;mov	ah,DEALLOC ; 49h	;
  3346 00000DB3 CD21                    	int	21h			;
  3347 00000DB5 07                      	pop	es			; restore to batch segment
  3348                                  
  3349                                  No_Bat_For:
  3350                                  	;mov	cl,[es:1]
  3351 00000DB6 268A0E0100              	mov	cl,[es:BATCHSEGMENT.BatEchoFlag] ; get old echo flag
  3352                                  	;mov	bx,[es:3]
  3353 00000DBB 268B1E0300              	mov	bx,[es:BATCHSEGMENT.BatLast] ; get old batch segment
  3354 00000DC0 B449                    	mov	ah,49h
  3355                                  	;mov	ah,DEALLOC ; 49h	; free it up...
  3356 00000DC2 CD21                    	int	21h
  3357 00000DC4 891E[4902]              	mov	[Batch],bx		; get ready to deallocate next batch
  3358 00000DC8 FF0E[AE02]              	dec	word [Nest]		; is there another batch file?
  3359 00000DCC 75CF                    	jnz	short ClearBatch	; keep going until no batch file
  3360                                  
  3361                                  ;	We are terminating a batch file; restore the echo status
  3362                                  
  3363                                  ;Shell_Bat_Cont: 			; continue batch for SHELL
  3364 00000DCE 5B                      	pop	bx
  3365 00000DCF 880E[9D02]              	mov	[EchoFlag],cl		; reset echo status
  3366                                  	; 29/05/2018
  3367 00000DD3 C606[1303]00            	mov	byte [PipeFlag],0	; turn off pipeflag
  3368                                  
  3369                                  ContBatch:
  3370 00000DD8 E8FD05                  	call	crlf			; print out crlf before returning
  3371 00000DDB E87302                  	call	RestHand
  3372                                  
  3373                                  ;	Yes, we are terminating. Turn off flags and allow the DOS to abort.
  3374                                  
  3375                                  ContCTerm:
  3376 00000DDE 31C0                    	xor	ax,ax			; indicate no read
  3377 00000DE0 89C5                    	mov	bp,ax
  3378                                  
  3379                                  ;	The following resetting of the state flags is good for the
  3380                                  ;	generalized batch processing.
  3381                                  
  3382 00000DE2 A2[AA02]                	mov	[IfFlag],al		; turn off iffing
  3383 00000DE5 A2[AB02]                	mov	[ForFlag],al		; turn off for processing
  3384 00000DE8 E81C00                  	call	ResPipeOff
  3385 00000DEB 3906[A502]              	cmp	[SingleCom],ax		; see if we need to set SingleCom
  3386 00000DEF 7406                    	jz	short NoSetSing
  3387 00000DF1 C706[A502]FFFF          	mov	word [SingleCom],-1	; cause termination on 
  3388                                  					;  pipe, batch, for
  3389                                  NoSetSing:
  3390                                  
  3391                                  ;	If we are doing an internal command, go through the reload process.
  3392                                  ;	If we are doing an external, let DOS abort the process.
  3393                                  ;	In both cases, we are now done with the ^C processing.
  3394                                  
  3395 00000DF7 8026[1203]FB            	and	byte [InitFlag],~INITCTRLC ; 0FBh
  3396 00000DFC 3806[9902]              	cmp	[ExtCom],al
  3397 00000E00 7503                    	jnz	short DoDAb		; internal ^c
  3398 00000E02 E94701                  	jmp	LodCom1
  3399                                  DoDAb:
  3400 00000E05 F9                      	stc				; tell dos to abort
  3401                                  
  3402                                  ;SR;
  3403                                  ;We dont need to restore ds here because we are forcing DOS to do an abort
  3404                                  ;by setting carry and leaving flags on the stack
  3405                                  
  3406 00000E06 CB                      	retf				; Leave flags on stack
  3407                                  
  3408                                  ;ContC	endp
  3409                                  
  3410                                  ;SR;
  3411                                  ;ds = DATARES on entry. This routine is called from DskErr and LodCom1 and
  3412                                  ;both have ds = DATARES
  3413                                  
  3414                                  	; 11/01/2023
  3415                                  ResPipeOff:
  3416 00000E07 50                      	push	ax
  3417 00000E08 31C0                    	xor	ax,ax
  3418                                  	;xchg	al,[cs:PIPEFLAG]
  3419 00000E0A 8606[1303]              	xchg	al,[PipeFlag]
  3420 00000E0E 08C0                    	or	al,al
  3421 00000E10 7404                    	jz	short NoPipePop
  3422                                  	;shr	byte [cs:ECHOFLAG],1
  3423 00000E12 D02E[9D02]              	shr	byte [EchoFlag],1
  3424                                  NoPipePop:
  3425 00000E16 58                      	pop	ax
  3426 00000E17 C3                      	retn
  3427                                  
  3428                                  ;CODERES ends
  3429                                  
  3430                                  ;=============================================================================
  3431                                  ; COMMAND2.ASM, MSDOS 6.0, 1991
  3432                                  ;=============================================================================
  3433                                  ; 21/09/2018 - Retro DOS v3.0
  3434                                  
  3435                                  ;	title	COMMAND2 - resident code for COMMAND.COM part II
  3436                                  ;	name	COMMAND2
  3437                                  
  3438                                  ;/*
  3439                                  ; *                      Microsoft Confidential
  3440                                  ; *                      Copyright (C) Microsoft Corporation 1991
  3441                                  ; *                      All Rights Reserved.
  3442                                  ; */
  3443                                  
  3444                                  ;
  3445                                  ;	Revision History
  3446                                  ;	================
  3447                                  ;
  3448                                  ; M038	SR  11/5/90	Changed stuff for Novell RPL. These guys cannot
  3449                                  ;			reserve memory by changing int 12h and then give it
  3450                                  ;			back to DOS by changing arenas in autoexec.bat.
  3451                                  ;			This makes command.com reload transient and this
  3452                                  ;			cannot be done at this stage.
  3453                                  ;
  3454                                  
  3455                                  ;CODERES segment public byte
  3456                                  
  3457                                  ;*	If we cannot allocate enough memory for the transient or there
  3458                                  ;	was some other allocation error, we display a message and
  3459                                  ;	then die.
  3460                                  
  3461                                  ;SR;
  3462                                  ; We will have to make sure that at this entry point and at FatalC, 
  3463                                  ;ds = DATARES. All jumps to these points are made from only within this file
  3464                                  ;and so we should be able to do this
  3465                                  
  3466                                  ; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  3467                                  ; MSDOS 5.0 COMMAND.COM - RESGROUP:0E4Bh (CODERES:010Bh)
  3468                                  
  3469                                  	;assume	ds:DATARES
  3470                                  BadMemErr:
  3471 00000E18 BA[DE06]                	mov	dx,BMEMMES			; DX = ptr to msg
  3472                                  FatalC:
  3473                                  	; 12/01/2023
  3474                                  ;;	push	cs
  3475                                  ;;	pop	ds
  3476                                  ;;	assume	ds:ResGroup
  3477                                  ;	invoke	RPrint
  3478                                  
  3479                                  	; 12/01/2023
  3480                                  	; MSDOS 5.0 (& MSDOS 6.0-6.22)
  3481 00000E1B E8BD05                  	call	RPrint
  3482                                  
  3483                                  	; MSDOS 3.3
  3484                                  	;call	RDISPMSG
  3485                                  
  3486                                  ;	If this is NOT a permanent (top-level) COMMAND, then we exit;
  3487                                  ;	we can't do anything else!
  3488                                  
  3489 00000E1E 803E[A202]00            	cmp	byte [PermCom],0
  3490 00000E23 7410                    	je	short FatalRet
  3491                                  
  3492                                  ;	We are a permanent command. If we are in the process of the
  3493                                  ;	magic interrupt (Singlecom) then exit too.
  3494                                  
  3495 00000E25 833E[A502]00            	cmp	word [SingleCom],0		; if PermCom and SingleCom
  3496 00000E2A 7509                    	jne	short FatalRet			; must take int_2e exit
  3497                                  
  3498                                  ;	Permanent command. We can't do ANYthing except halt.
  3499                                  
  3500 00000E2C BA[F806]                	mov	dx,HALTMES			; DX = ptr to msg
  3501                                  	;invoke	RPrint
  3502                                  	; 12/01/2023	
  3503                                  	; MSDOS 5.0 (& MSDOS 6.0-6.22)
  3504 00000E2F E8A905                  	call	RPrint	
  3505                                  	; MSDOS 3.3
  3506                                  	;call	RDISPMSG
  3507 00000E32 FB                      	sti
  3508                                  Stall:
  3509 00000E33 EBFE                    	jmp	short Stall			; crash the system nicely
  3510                                  
  3511                                  FatalRet:
  3512 00000E35 BA[1F07]                	mov	dx,FRETMES			; DX = ptr to msg
  3513                                  	;call	RDISPMSG
  3514                                  	; 12/01/2023	
  3515 00000E38 E8A005                  	call	RPrint	
  3516                                  FatalRet2:
  3517 00000E3B 803E[A202]00            	cmp	byte [PermCom],0		; if we get here and PermCom,
  3518 00000E40 7519                    	jne	short Ret_2e			; must be int_2e
  3519                                  
  3520                                  ;	Bugbug:	this is where we'd want to unhook int 2F, *if* we
  3521                                  ;	were a non-permanent COMMAND that had hooked it! (Just in 
  3522                                  ;	case we decide to do that.)
  3523                                  
  3524 00000E42 A1[3E02]                	mov	ax,[Parent]
  3525                                  	;mov	[16h],ax
  3526 00000E45 A31600                  	mov	[PDB.PARENT_PID],ax	; mov [cs:16h],ax
  3527 00000E48 A1[4002]                	mov	ax,[OldTerm]
  3528                                  	;mov	[0Ah],ax
  3529 00000E4B A30A00                  	mov	[PDB.EXIT],ax		; mov [cs:0Ah],ax
  3530 00000E4E A1[4202]                	mov	ax,[OldTerm+2]
  3531                                  	;mov	[0Ch],ax
  3532 00000E51 A30C00                  	mov	[PDB.EXIT+2],ax 	; mov [cs:0Ch],ax
  3533                                  	;mov	ax,4C00h
  3534                                  	;;mov	ax,(EXIT<<8) ; 4C00h	; return to lower level
  3535                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  3536 00000E54 B44C                    	mov	ah,4Ch ; EXIT
  3537 00000E56 A0[9A02]                	mov	al,[RetCode] 
  3538 00000E59 CD21                    	int	21h
  3539                                  Ret_2e:
  3540                                  ;SR;
  3541                                  ; We will ensure that ds = DATARES for all entries to this place
  3542                                  ;
  3543                                  
  3544                                  ;;	push	cs
  3545                                  ;;	pop	ds
  3546                                  ;;	assume	ds:resgroup,es:nothing,ss:nothing
  3547                                    	
  3548                                  ;	assume	ds:DATARES
  3549                                  
  3550                                  	;PUSH	CS
  3551                                  	;POP	DS
  3552                                  
  3553 00000E5B C706[A502]0000          	mov	word [SingleCom],0	; turn off SingleCom
  3554 00000E61 8E06[5804]              	mov	es,[Res_Tpa]
  3555                                  	;mov	ah,49h	; 12/01/2023
  3556 00000E65 B449                    	mov	ah,DEALLOC
  3557 00000E67 CD21                    	int	21h			; free up space used by transient
  3558 00000E69 8B1E[3C02]              	mov	bx,[Save_Pdb]
  3559 00000E6D B450                    	mov	ah,50h
  3560                                  	;mov	ah,SET_CURRENT_PDB ; 50h
  3561 00000E6F CD21                    	int	21h			; current process is user
  3562 00000E71 A1[9A02]                	mov	ax,[RetCode]
  3563 00000E74 803E[9902]00            	cmp	byte [ExtCom],0
  3564 00000E79 7502                    	jne	short GotECode
  3565 00000E7B 31C0                    	xor	ax,ax			; internals always return 0
  3566                                  GotECode:
  3567 00000E7D C606[9902]01            	mov	byte [ExtCom],1		; force external
  3568                                  
  3569                                  ;SR; This is actually returning to the caller. However, the old code had
  3570                                  ;ds = RESGROUP so I guess we can keep ds = DATARES for us.
  3571                                  ;Yes, int 2eh can corrupt all registers so we are ok.
  3572                                  
  3573                                  	; 12/01/2023
  3574 00000E82 FF2E[3802]              	jmp	far [Int_2e_Ret]	; "iret"
  3575                                  
  3576                                  ;***	Int_2e, magic command executer
  3577                                  
  3578                                  Int_2e:
  3579                                  	;assume	ds:NOTHING,es:NOTHING,ss:NOTHING
  3580                                  ;SR;
  3581                                  ;We are going to come here from the stub with the old ds and DATARES value
  3582                                  ;pushed on the stack in that order. Pick up this stuff off the stack
  3583                                  
  3584                                  	; 12/01/2023 - Retro DOS v4.0 COMMAND.COM
  3585                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:0EB7h (CODERES:0177h)
  3586                                  
  3587 00000E86 1F                      	pop	ds			; ds = DATARES
  3588                                  	;assume	ds:DATARES
  3589 00000E87 58                      	pop	ax
  3590                                  ;	;pop	ds:OldDS 		; Save old value of ds
  3591                                  
  3592                                  	;pop	word [cs:Int_2e_Ret]
  3593                                  	;pop	word [cs:Int_2e_Ret+2]	; store return address
  3594                                  	;pop	ax			; chuck flags
  3595 00000E88 8F06[3802]              	pop	word [Int_2e_Ret]
  3596 00000E8C 8F06[3A02]              	pop	word [Int_2e_Ret+2]
  3597                                  	
  3598 00000E90 83C402                  	add	sp,2
  3599                                  
  3600                                  ;;	push	cs
  3601                                  ;;	pop	es
  3602                                  
  3603 00000E93 1E                      	push	ds
  3604 00000E94 07                      	pop	es			; es = DATARES
  3605                                  ;	;mov	ds,OldDS
  3606 00000E95 8ED8                    	mov	ds,ax
  3607                                  	;assume	ds:nothing		; ds = old value
  3608                                  
  3609 00000E97 BF8000                  	mov	di,80h
  3610 00000E9A B94000                  	mov	cx,64
  3611                                  ;	Bugbug:	cld
  3612 00000E9D F3A5                    	rep	movsw
  3613 00000E9F B451                    	mov	ah,51h
  3614                                  	;mov	ah,GET_CURRENT_PDB ; 51h
  3615 00000EA1 CD21                    	int	21h			; get user's header
  3616                                  	; 12/01/2023
  3617 00000EA3 26891E[3C02]            	mov	[es:Save_Pdb],bx
  3618                                  	;mov	[cs:Save_Pdb],bx
  3619 00000EA8 B450                    	mov	ah,50h
  3620                                  	;mov	ah,SET_CURRENT_PDB ; 50h
  3621                                  
  3622                                  ;;	mov	bx,cs
  3623                                  ;SR;
  3624                                  ;Set ds = DATARES because BadMemErr expects this
  3625                                  
  3626                                  	; 12/01/2023
  3627 00000EAA 06                      	push	es
  3628 00000EAB 1F                      	pop	ds
  3629                                  	;assume	ds:DATARES
  3630                                  
  3631 00000EAC 8CDB                    	mov	bx,ds			; es = our PSP now
  3632                                  	;mov	bx,cs
  3633                                  
  3634 00000EAE CD21                    	int	21h			; current process is me
  3635                                  	;mov	word [cs:SingleCom],81h
  3636                                  	;mov	byte [cs:ExtCom],1	; make sure this case forced
  3637                                  	; 12/01/2023
  3638 00000EB0 C706[A502]8100          	mov	word [SingleCom],81h
  3639 00000EB6 C606[9902]01            	mov	byte [ExtCom],1		; make sure this case forced
  3640                                  
  3641                                  ;SR;
  3642                                  ;We can enter LodCom directly after a command shell is terminated or we
  3643                                  ;can fall thru from above. When we enter directly from the stub, the stack
  3644                                  ;has the old ds value and the data seg value on the stack, so that ds can
  3645                                  ;be properly set. To fake this, we push dummy values here.
  3646                                  
  3647                                  	; 12/01/2023
  3648 00000EBB 1E                      	push	ds			; old value of ds
  3649 00000EBC 1E                      	push	ds			; data seg value, ds = DATARES
  3650                                  LodCom: 				; termination handler
  3651 00000EBD 1F                      	pop	ds			; ds = DATARES
  3652                                  	;assume	ds:DATARES
  3653 00000EBE 83C402                  	add	sp,2
  3654                                  ;	;pop	OldDS			; store old ds
  3655                                  	;cmp	ExtCom,0
  3656 00000EC1 803E[9902]00            	cmp	byte [ExtCom],0
  3657                                  	;cmp	byte [cs:ExtCom],0
  3658                                  	;jne	short @f	 	; internal cmd - memory allocated
  3659                                  	; 16/04/2023
  3660 00000EC6 7503                    	jne	short LodCom0 ; 24/09/2018
  3661 00000EC8 E98100                  	jmp	LodCom1
  3662                                  	;je	short LodCom1 ; 25/09/2018	
  3663                                  ;@@:
  3664                                  LodCom0: ; 24/09/2018
  3665 00000ECB BBFFFF                  	mov	bx,0FFFFh
  3666 00000ECE B448                    	mov	ah,48h	; 12/01/2023
  3667                                  	;mov	ah,ALLOC ; 48h	
  3668 00000ED0 CD21                    	int	21h		; DOS - 2+ - ALLOCATE MEMORY
  3669                                  				; BX = number of 16-byte paragraphs desired
  3670 00000ED2 E80A00                  	call	SetSize
  3671 00000ED5 83C020                  	add	ax,20h
  3672 00000ED8 39C3                    	cmp	bx,ax
  3673 00000EDA 730B                    	jnb	short MemOk		; > 512 byte buffer - good enough
  3674                                  BadMemErrJ:
  3675 00000EDC E939FF                  	jmp	BadMemErr		; not enough memory
  3676                                  
  3677                                  ;***	SetSize - get transient size in paragraphs
  3678                                  
  3679                                  SetSize:
  3680                                  	; 12/01/2023
  3681                                  	;;;mov	ax,offset TRANGROUP:TranSpaceEnd + 15
  3682                                  	;;mov	ax,98D4h		; MSDOS 5.0 COMMAND.COM
  3683                                  	; 05/06/2023
  3684                                  	;mov	ax,0AFA4h		; MSDOS 6.22 COMMAND.COM
  3685 00000EDF B81AA6                  	mov	ax,TRANSPACEEND+15	; mov AX,4D6Bh ; MSDOS 3.3
  3686 00000EE2 B104                    	mov	cl,4
  3687 00000EE4 D3E8                    	shr	ax,cl
  3688 00000EE6 C3                      	retn
  3689                                  
  3690                                  MemOk:
  3691                                  	;assume	ds:DATARES		;we have set ds = DATARES 
  3692                                  
  3693 00000EE7 B448                    	mov	ah,48h
  3694                                  	;mov	ah,ALLOC  ; 48h
  3695 00000EE9 CD21                    	int	21h
  3696 00000EEB 72EF                    	jc	short BadMemErrJ	; memory arenas probably trashed
  3697                                  	;mov	byte [cs:ExtCom],0
  3698                                  	;mov	[cs:Res_Tpa],ax
  3699                                  	; 12/01/2023
  3700 00000EED C606[9902]00            	mov	byte [ExtCom],0		; flag not to alloc again
  3701 00000EF2 A3[5804]                	mov	[Res_Tpa],ax		; save current tpa segment
  3702                                  
  3703 00000EF5 2500F0                  	and	ax,0F000h
  3704 00000EF8 050010                  	add	ax,1000h		; round up to next 64k boundary
  3705 00000EFB 7212                    	jc	short Bad_Tpa		; memory wrap if carry set
  3706                                  
  3707                                  ;	Make sure that new boundary is within allocated range
  3708                                  
  3709                                  	;mov	dx,[cs:Res_Tpa]
  3710                                  	; 12/01/2023
  3711 00000EFD 8B16[5804]              	mov	dx,[Res_Tpa]
  3712 00000F01 01DA                    	add	dx,bx			; compute maximum address
  3713 00000F03 39C2                    	cmp	dx,ax			; is 64k address out of range?
  3714 00000F05 7608                    	jbe	short Bad_Tpa
  3715                                  
  3716                                  ;	Must have 64K of usable space.
  3717                                  
  3718 00000F07 29C2                    	sub	dx,ax			; compute the usable space
  3719 00000F09 81FA0010                	cmp	dx,1000h		; is space >= 64k ?
  3720 00000F0D 7303                    	jae	short LTpaSet
  3721                                  Bad_Tpa:
  3722                                  	;mov	ax,[cs:Res_Tpa]
  3723                                  	; 12/01/2023
  3724 00000F0F A1[5804]                	mov	ax,[Res_Tpa]
  3725                                  LTpaSet:
  3726                                  	;mov	[cs:LTPA],ax
  3727                                  	;mov	ax,[cs:Res_Tpa]
  3728                                  	; 12/01/2023
  3729 00000F12 A3[4C04]                	mov	[LTpa],ax		; usable tpa is 64k buffer aligned
  3730 00000F15 A1[5804]                	mov	ax,[Res_Tpa]		; actual tpa is buffer allocated
  3731 00000F18 01C3                    	add	bx,ax
  3732                                  	;mov	[cs:MemSiz],bx
  3733 00000F1A 891E[9502]              	mov	[MemSiz],bx
  3734 00000F1E E8BEFF                  	call	SetSize
  3735 00000F21 29C3                    	sub	bx,ax
  3736                                  
  3737                                  	; MSDOS 6.0
  3738                                  
  3739                                  ;M038; Start of changes
  3740                                  ;Changes for Novell RPL. These guys reserve memory for themselves by
  3741                                  ;reducing int 12h size and add this memory to the system at autoexec time by
  3742                                  ;running a program that changes arenas. This changes the largest block that
  3743                                  ;command.com gets and so changes the transient segment. So, command.com does
  3744                                  ;a checksum at the wrong address and thinks that the transient is destroyed
  3745                                  ;and tries to reload it. At this point, no Comspec is defined and so the
  3746                                  ;reload fails, hanging the system. To get around this we just copy the
  3747                                  ;transient from the previous address to the new address(if changed) and
  3748                                  ;then let command.com do the checksum. So, if the transient area is not
  3749                                  ;corrupted, there will not be any reload. In Novell's case, the transient
  3750                                  ;is not really corrupted and so this should work.
  3751                                  
  3752                                  	; 12/01/2023
  3753                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:0F5Ah (CODERES:021Ah)
  3754                                  
  3755 00000F23 3B1E[8F02]              	cmp	bx,[TrnSeg]		; Segment still the same?
  3756 00000F27 7423                    	je	short LodCom1		; yes, dont copy
  3757                                  
  3758                                  ;Check if the new segment is above or below the current move. If the new
  3759                                  ;segment is above (i.e new block is larger than previous block), then we
  3760                                  ;have to move in the reverse direction
  3761                                  
  3762                                  	;;mov	cx,98C5h
  3763                                  	; 05/06/2023
  3764                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:106Ah (CODERES:021Ah)
  3765                                  	;mov	cx,0AF95h
  3766                                  	;;mov	cx,0AA9Ah ; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  3767 00000F29 B90BA6                  	mov	cx,TRANSPACEEND		; cx = length to move
  3768 00000F2C 7707                    	ja	short mov_down		; new seg > old seg, reverse move
  3769 00000F2E 31F6                    	xor	si,si			; normal move
  3770 00000F30 89F7                    	mov	di,si
  3771 00000F32 FC                      	cld
  3772 00000F33 EB06                    	jmp	short copy_trans
  3773                                  mov_down:
  3774 00000F35 89CE                    	mov	si,cx			; reverse move, start from end
  3775 00000F37 4E                      	dec	si
  3776 00000F38 89F7                    	mov	di,si
  3777 00000F3A FD                      	std
  3778                                  copy_trans:
  3779 00000F3B 1E                      	push	ds
  3780 00000F3C 06                      	push	es
  3781 00000F3D 8EC3                    	mov	es,bx			; dest segment
  3782 00000F3F 8E1E[8F02]              	mov	ds,[TrnSeg]		; source segment
  3783                                  	;assume	ds:nothing
  3784                                  
  3785 00000F43 F3A4                    	rep	movsb			; copy transient
  3786 00000F45 FC                      	cld
  3787 00000F46 07                      	pop	es
  3788 00000F47 1F                      	pop	ds
  3789                                  	;assume	ds:DATARES
  3790                                  
  3791                                  ;M038; End of changes
  3792                                  
  3793                                  	;mov	[cs:TrnSeg],bx		; new location of transient
  3794                                  	; 12/01/2023
  3795 00000F48 891E[8F02]              	mov	[TrnSeg],bx
  3796                                  
  3797                                  LodCom1:
  3798                                  ;;	mov	ax,cs
  3799                                  ;;	mov	ss,ax
  3800                                  ;SR; At this point ds = DATARES which is where the stack is located
  3801                                  
  3802                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  3803                                  	; MSDOS 5.0 (& MSDOS 6.0-6.22)
  3804 00000F4C 8CD8                    	mov	ax,ds
  3805 00000F4E 8ED0                    	mov	ss,ax
  3806                                  	;assume	ss:DATARES
  3807                                  	;;;mov	sp,offset DATARES:RStack
  3808                                  	;;mov	sp,53Eh
  3809                                  	; 05/06/2023
  3810                                  	;;mov	sp,60Ah ; MSDOS 6.22 COMMAND.COM
  3811                                  	;mov	sp,637h ; PCDOS 7.1 COMMAND.COM ; 19/07/2024
  3812 00000F50 BC[2E05]                	mov	sp,RStack
  3813                                  
  3814                                  ;;	mov	ds,ax
  3815                                  
  3816                                  	;assume	ds:DATARES
  3817                                  	
  3818                                  	; MSDOS 3.3
  3819                                  	;mov	ax,cs
  3820                                  	;mov	ss,ax
  3821                                  	;mov	sp,RSTACK
  3822                                  	;mov	ds,ax
  3823                                  
  3824 00000F53 E88500                  	call	HeadFix			; close files, restore stdin, stdout
  3825 00000F56 31ED                    	xor	bp,bp			; flag command ok
  3826 00000F58 B8FFFF                  	mov	ax,-1
  3827 00000F5B 8706[A702]              	xchg	ax,[VerVal]
  3828 00000F5F 83F8FF                  	cmp	ax,-1
  3829 00000F62 7404                    	je	short NoSetVer
  3830 00000F64 B42E                    	mov	ah,2Eh
  3831                                  	;mov	ah,SET_VERIFY_ON_WRITE ; 2Eh ; AL has correct value
  3832 00000F66 CD21                    	int	21h 		; DOS - SET VERIFY FLAG
  3833                                  				; DL = 00h, AL = 01h VERIFY on / 00h VERIFY off
  3834                                  NoSetVer:
  3835 00000F68 833E[A502]FF            	cmp	word [SingleCom],-1
  3836 00000F6D 7503                    	jne	short NoSng
  3837 00000F6F E9C9FE                  	jmp	FatalRet2		; we have finished the single command
  3838                                  NoSng:
  3839 00000F72 E88101                  	call	ChkSum			; check the transient
  3840                                  	;cmp	dx,[Sum]
  3841                                  	;je	short HavCom		; transient ok
  3842                                  
  3843                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3844                                  %if 0
  3845                                  	; 12/01/2023
  3846                                  	jz	short HavCom
  3847                                  
  3848                                  %else	; PCDOS 7.1 COMMAND.COM
  3849 00000F75 7505                    	jnz	short Bogus_Com
  3850 00000F77 E8A701                  	call	chk_transient
  3851 00000F7A 7417                    	jz	short HavCom
  3852                                  %endif
  3853                                  
  3854                                  Bogus_Com:
  3855 00000F7C C606[4802]01            	mov	byte [Loading],1	; flag DskErr routine
  3856 00000F81 E82801                  	call	LoadCom
  3857                                  ChkSame:
  3858 00000F84 E86F01                  	call	ChkSum
  3859                                  	;cmp	dx,[Sum]
  3860                                  	;je	short HavCom		; same command
  3861                                  
  3862                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3863                                  %if 0
  3864                                  	; 12/01/2023
  3865                                  	jz	short HavCom
  3866                                  
  3867                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3868                                  %else	; PCDOS 7.1 COMMAND.COM
  3869 00000F87 7505                    	jnz	short Also_Bogus
  3870 00000F89 E89501                  	call	chk_transient
  3871 00000F8C 7405                    	jz	short HavCom
  3872                                  %endif
  3873                                  Also_Bogus:
  3874 00000F8E E85D01                  	call	WrongCom
  3875 00000F91 EBF1                    	jmp	short ChkSame
  3876                                  
  3877                                  	; 12/01/2023
  3878                                  ;HavCom:
  3879                                  ;	; 25/09/2018
  3880                                  ;	mov     ax,(CHAR_OPER*256) ; 3700h
  3881                                  ;	int     21h	; DOS - 2+ internal - GET SWITCHAR/AVAILDEV
  3882                                  ;			; Return: AL = FFh unsupported subfunction
  3883                                  ;			; DL = current switch character
  3884                                  ;	mov     [RSWITCHAR],dl
  3885                                  ;	cmp     dl,'/'
  3886                                  ;	jnz     short USESLASH
  3887                                  ;	;mov	cl,'\'
  3888                                  ;	;mov	[RDIRCHAR],cl
  3889                                  ;	mov	byte [RDIRCHAR],'\'
  3890                                  ;USESLASH:
  3891                                  
  3892                                  HavCom:
  3893                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM	
  3894 00000F93 C606[4802]00            	mov	byte [Loading],0		; flag to DskErr
  3895                                  	;;;mov	si,offset DATARES:TranVars
  3896                                  	;;mov	si,453h		; MSDOS 5.0 COMMAND.COM
  3897                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  3898                                  	;mov	si,51Dh		; MSDOS 6.22 COMMAND.COM
  3899                                  	; 19/07/2024
  3900                                  	;mov	si,551h		; PCDOS 7.1 COMMAND.COM
  3901 00000F98 BE[4804]                	mov	si,TranVars
  3902                                  	;;;mov	di,offset TRANGROUP:HeadCall
  3903                                  	;;mov	di,8D75h	; MSDOS 5.0 COMMAND.COM
  3904                                  	; 05/06/2023
  3905                                  	;mov	di,0A303h	; MSDOS 6.22 COMMAND.COM
  3906                                  	; 19/07/2024
  3907                                  	;mov	di,0A082h	; PCDOS 7.1 COMMAND.COM
  3908 00000F9B BF[F39B]                	mov	di,HEADCALL
  3909 00000F9E 8E06[8F02]              	mov	es,[TrnSeg]
  3910 00000FA2 FC                      	cld
  3911                                  	;;;mov	cx,467h		; MSDOS 5.0 COMMAND.COM	
  3912                                  	;;mov	cx,533h		; MSDOS 6.22 COMMAND.COM	
  3913                                  	;mov	cx,565h		; PCDOS 7.1 COMMAND.COM
  3914 00000FA3 B9[5C04]                	mov	cx,TranVarEnd
  3915 00000FA6 29F1                    	sub	cx,si
  3916 00000FA8 F3A4                    	rep	movsb			; transfer info to transient
  3917 00000FAA A1[9502]                	mov	ax,[MemSiz]
  3918 00000FAD A30200                  	mov	[PDB.BLOCK_LEN],ax ; mov [ds:2],ax ; adjust my own header
  3919                                  
  3920                                  ;***	TJmp - jump-off to transient
  3921                                  ;
  3922                                  ;	Public label so debugger can find this spot.
  3923                                  
  3924                                  TJmp:	; 12/01/2023
  3925 00000FB0 FF2E[8D02]              	jmp	far [Trans]		; jmp dword ptr Trans
  3926                                  
  3927                                  ;***	TRemCheck - far version of RemCheck for transient
  3928                                  
  3929                                  TRemCheck:
  3930                                  	; 12/01/2023
  3931 00000FB4 1F                      	pop	ds			; ds = DATARES
  3932 00000FB5 83C402                  	add	sp,2			; discard old value of ds
  3933                                  
  3934 00000FB8 E80100                  	call	RemCheck
  3935 00000FBB CB                      	retf
  3936                                  
  3937                                  ;***	RemCheck
  3938                                  ;
  3939                                  ;	ENTRY	AL = drive (0=default, 1=A, ...)
  3940                                  ;
  3941                                  ;	EXIT	ZR set if removeable media
  3942                                  ;		ZR clear if fixed media
  3943                                  ;
  3944                                  ;	USED	none
  3945                                  
  3946                                  	; 12/01/2023
  3947                                  RemCheck:
  3948 00000FBC 50                      	push	ax
  3949 00000FBD 53                      	push	bx
  3950 00000FBE 89C3                    	mov	bx,ax
  3951 00000FC0 B80844                  	mov	ax,4408h
  3952                                  	;mov	ax,(IOCTL<<8)+8 ; 4408h
  3953 00000FC3 CD21                    	int	21h		; DOS - 2+ - IOCTL -
  3954 00000FC5 7304                    	jnc	short rcCont		
  3955                                  
  3956                                  ;	If an error occurred, assume the media is non-removable.
  3957                                  ;	AX contains the non-zero error code from the int 21, so
  3958                                  ;	'or ax,ax; sets non-zero. This behavior makes network drives
  3959                                  ;	appear to be non-removable.				
  3960                                  					
  3961 00000FC7 09C0                    	or	ax,ax			
  3962 00000FC9 EB05                    	jmp	short ResRegs
  3963                                  rcCont:
  3964 00000FCB 83E001                  	and	ax,1
  3965 00000FCE F7D0                    	not	ax
  3966                                  ResRegs:
  3967 00000FD0 5B                      	pop	bx
  3968 00000FD1 58                      	pop	ax
  3969 00000FD2 C3                      	retn
  3970                                  
  3971                                  ;***	THeadFix
  3972                                  ;
  3973                                  ;	Far version of HeadFix, called from transient.
  3974                                  
  3975                                  THeadFix:
  3976                                  	; 12/01/2023
  3977 00000FD3 1F                      	pop	ds			; ds = DATARES
  3978 00000FD4 83C402                  	add	sp,2			; discard old ds value on stack
  3979                                  
  3980 00000FD7 E80100                  	call	HeadFix
  3981 00000FDA CB                      	retf
  3982                                  
  3983                                  ;***	HeadFix
  3984                                  
  3985                                  	; 12/01/2023
  3986                                  HeadFix:
  3987 00000FDB E85001                  	call	SetVect			; set vectors to our values
  3988                                  
  3989                                  ;	Clean up header
  3990                                  
  3991                                  ;	Bugbug:	optimize:
  3992                                  ;	mov	word ptr ds:Pdb_Jfn_Table,cx  instead of separate bytes
  3993                                  
  3994 00000FDE 31DB                    	xor	bx,bx			; BX = handle = 0
  3995 00000FE0 8B0E[9F02]              	mov	cx,[Io_Save]		; CX = original stdin, stdout
  3996                                  	;mov	dx,[18h] 
  3997 00000FE4 8B161800                	mov	dx,[PDB.JFN_TABLE]	; DX = current stdin, stdout
  3998 00000FE8 38D1                    	cmp	cl,dl
  3999 00000FEA 7407                    	je	short Chk1		; stdin matches
  4000                                  
  4001                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4002                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4003                                  	mov	ah,3Eh
  4004                                  	;mov	ah,CLOSE  ; 3Eh
  4005                                  	int	21h			; close stdin
  4006                                  %else
  4007                                  	;mov	ah,3Eh
  4008                                  	;call	int21h
  4009                                  	; 19/07/2024
  4010 00000FEC E86E01                  	call	int21h_close
  4011                                  %endif
  4012                                  	;mov	[18h],cl
  4013 00000FEF 880E1800                	mov	[PDB.JFN_TABLE],cl	; restore stdin
  4014                                  Chk1:
  4015 00000FF3 43                      	inc	bx			; BX = handle = 1
  4016 00000FF4 38F5                    	cmp	ch,dh			
  4017 00000FF6 7407                    	je	short ChkOtherHand	; stdout matches
  4018                                  
  4019                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4020                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4021                                  	mov	ah,3Eh
  4022                                  	;mov	ah,CLOSE  ; 3Eh
  4023                                  	int	21h			; close stdout
  4024                                  %else
  4025                                  	;mov	ah,3Eh
  4026                                  	;call	int21h
  4027                                  	; 19/07/2024
  4028 00000FF8 E86201                  	call	int21h_close
  4029                                  %endif
  4030                                  	;mov	[19h],ch
  4031 00000FFB 882E1900                	mov	[PDB.JFN_TABLE+1],ch	; restore stdout
  4032                                  ChkOtherHand:
  4033 00000FFF 83C304                  	add	bx,4			; skip handles 2,3,4
  4034 00001002 B90F00                  	mov	cx,FILPERPROC-5	; 15	; CX = # handles to close
  4035                                  					; (handles 0-4 already done)
  4036                                  CloseLoop:
  4037                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4038                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4039                                  	mov	ah,3Eh
  4040                                  	;mov	ah,CLOSE  ; 3Eh
  4041                                  	int	21h			; close file
  4042                                  %else
  4043                                  	;cmp	byte [bx+18h],0FFh
  4044 00001005 807F18FF                	cmp	byte [bx+PDB.JFN_TABLE],0FFh
  4045 00001009 7403                    	je	short CloseLoopNxt
  4046                                  
  4047                                  	;mov	ah,3Eh
  4048                                  	;call	int21h
  4049                                  	; 19/07/2024
  4050 0000100B E84F01                  	call	int21h_close
  4051                                  CloseLoopNxt:
  4052                                  %endif
  4053 0000100E 43                      	inc	bx			; BX = next handle
  4054 0000100F E2F4                    	loop	CloseLoop
  4055                                  
  4056                                  	; MSDOS 6.0
  4057                                  ;	Bugbug:	since this is for transient code, move it there
  4058                                  	
  4059                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4060                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:103Dh)
  4061                                  	; 19/07/2024
  4062                                  	; (PCDOS 7.1 COMMAND.COM - RESGROUP:1119h)
  4063                                  
  4064                                  ;	M012: remove this CS -> DS. Must've been missed during
  4065                                  ;	purification.
  4066                                  ;;	push	ds			; save data segment
  4067                                  ;;	push	cs			; get local segment into DS
  4068                                  ;;	pop	ds			;
  4069 00001011 803E[C002]FF            	cmp	byte [Append_Flag],-1	; do we need to reset APPEND?
  4070 00001016 750E                    	jne	short Append_Fix_End	; no - just exit
  4071 00001018 B807B7                  	mov	ax,0B707h
  4072                                  	;mov	ax,AppendSetState	; set the state of Append
  4073 0000101B 8B1E[BE02]              	mov	bx,[Append_State] 	; back to the original state
  4074 0000101F CD2F                    	int	2Fh			;
  4075 00001021 C606[C002]00            	mov	byte [Append_Flag],0	; set append flag to invalid
  4076                                  Append_Fix_End: 			;
  4077                                  ;;	pop	ds			; get data segment back
  4078 00001026 C3                      	retn
  4079                                  
  4080                                  	; MSDOS 3.3
  4081                                  	;retn
  4082                                  
  4083                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4084                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:112Fh
  4085                                  
  4086                                  ;***	SavHand - save current program's stdin/out & set to our stderr
  4087                                  ;
  4088                                  ;	ENTRY	nothing
  4089                                  ;
  4090                                  ;	EXIT	nothing
  4091                                  ;
  4092                                  ;	USED	flags
  4093                                  ;
  4094                                  ;	EFFECTS
  4095                                  ;	  Handle01 = current program's stdin,stdout JFN entries
  4096                                  ;	  current program's stdin,stdout set to our stderr
  4097                                  ;
  4098                                  
  4099                                  ;SR;
  4100                                  ; Changed ds = DATARES. We need it to access our JFN_Table
  4101                                  ; Called from ContC ( ds = DATARES ) and DskErr ( ds = DATARES ).
  4102                                  
  4103                                  SavHand:
  4104                                  	;assume	ds:DATARES,es:NOTHING,ss:NOTHING
  4105                                  
  4106                                  	; 12/01/2023
  4107                                  	;push	ds ; MSDOS 3.3
  4108                                  
  4109 00001027 53                      	push	bx			;preserve registers
  4110 00001028 50                      	push	ax
  4111                                  	; 12/01/2023
  4112 00001029 06                      	push	es
  4113 0000102A 1E                      	push	ds			; save DATARES value
  4114                                  
  4115 0000102B B451                    	mov	ah,51h
  4116                                  	;mov	ah,GET_CURRENT_PDB ; 51h
  4117                                  
  4118                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4119                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4120                                  	int	21h			; BX = user's header seg addr
  4121                                  %else
  4122 0000102D E82F01                  	call	int21h
  4123                                  %endif
  4124 00001030 8EDB                    	mov	ds,bx			; DS = user's header seg addr
  4125                                  	;lds	bx,[34h]	
  4126 00001032 C51E3400                	lds	bx,[PDB.JFN_Pointer]	; DS:BX = ptr to JFN table
  4127 00001036 8B07                    	mov	ax,[bx]			; AX = stdin,stdout JFN's
  4128                                  	; 12/01/2023
  4129 00001038 07                      	pop	es			; es = DATARES
  4130 00001039 06                      	push	es			; save it back on stack
  4131 0000103A 26A3[4602]              	mov	[es:Handle01],ax	; save user's stdin, stdout
  4132                                  	;mov	[cs:HANDLE01],ax
  4133                                  
  4134                                  ;SR;
  4135                                  ; Use es to address Handle01 & our JFN_Table
  4136                                  
  4137                                  	; 12/01/2023
  4138                                  	;mov	al,[es:1Ah]
  4139 0000103E 26A01A00                	mov	al,[es:PDB.JFN_TABLE+2] ; AL = COMMAND stderr
  4140                                  	;mov	al,[cs:PDB.JFN_TABLE+2] ; mov al,[cs:1Ah]
  4141 00001042 88C4                    	mov	ah,al			; AH = COMMAND stderr
  4142 00001044 8907                    	mov	[bx],ax			; set user's stdin/out to our stderr
  4143                                  	; 12/01/2023
  4144 00001046 1F                      	pop	ds			; restore registers
  4145 00001047 07                      	pop	es
  4146 00001048 58                      	pop	ax
  4147 00001049 5B                      	pop	bx
  4148                                  	;pop	ds ; MSDOS 3.3
  4149 0000104A C3                      	retn
  4150                                  
  4151                                  	;assume	ds:DATARES
  4152                                  GetComDsk2:
  4153 0000104B E81F00                  	call	GetComDsk
  4154 0000104E E9FBFE                  	jmp	LodCom1			; memory already allocated
  4155                                  
  4156                                  RestHand:
  4157 00001051 1E                      	push	ds
  4158 00001052 53                      	push	bx			; restore stdin, stdout to user
  4159 00001053 50                      	push	ax
  4160                                  	; 12/01/2023
  4161 00001054 B451                    	mov	ah,51h
  4162                                  	;mov	ah,GET_CURRENT_PDB ; 51h
  4163 00001056 CD21                    	int	21h			; point to user's header
  4164 00001058 A1[4602]                	mov	ax,[Handle01]
  4165 0000105B 8EDB                    	mov	ds,bx
  4166                                  	;assume ds:NOTHING
  4167                                  	;lds	bx,[34h] 
  4168 0000105D C51E3400                	lds	bx,[PDB.JFN_Pointer]	; DS:BX = ptr to jfn table
  4169 00001061 8907                    	mov	[bx],ax			; stuff his old 0 and 1
  4170 00001063 58                      	pop	ax
  4171 00001064 5B                      	pop	bx
  4172 00001065 1F                      	pop	ds
  4173 00001066 C3                      	retn
  4174                                  
  4175                                  	;assume ds:DATARES,ss:DATARES
  4176                                  Hopeless:
  4177 00001067 BA[DC05]                	mov	dx,COMBAD
  4178 0000106A E9AEFD                  	jmp	FatalC
  4179                                  
  4180                                  GetComDsk:
  4181 0000106D A0[9402]                	mov	al,[ComDrv]
  4182 00001070 E849FF                  	call	RemCheck
  4183 00001073 75F2                    	jnz	short Hopeless		; non-removable media
  4184                                  GetComDsk3:
  4185 00001075 81FA[DC05]              	cmp	dx,COMBAD		; cmp dx,offset DATARES:ComBad
  4186 00001079 7503                    	jne	short GetComDsk4
  4187                                  	;;mov	dx,offset DATARES:ComBad ; DX = ptr to msg
  4188                                  	; 12/01/2023
  4189                                  	;;mov	dx,COMBAD ; (MSDOS 5.0 COMMAND.COM - RESGROUP:10A6h)
  4190                                  	; 05/06/2023
  4191                                  	;mov	dx,COMBAD ; (MSDOS 6.22 COMMAND.COM - RESGROUP:11B6h)
  4192                                  	;invoke	RPrint			; say COMMAND is invalid
  4193 0000107B E85D03                  	call	RPrint
  4194                                  	;call	RDISPMSG
  4195                                  
  4196                                  GetComDsk4:
  4197                                  
  4198                                  ;	Bugbug:	there's always a drive here? No need to check?
  4199                                  
  4200 0000107E 803E[2F02]00            	cmp	byte [PutBackDrv],0	; is there a drive in the comspec?
  4201 00001083 750A                    	jne	short Users_Drive	; yes - use it
  4202 00001085 B419                    	mov	ah,19h
  4203                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h ; use default drive
  4204                                  
  4205                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4206                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4207                                  	int	21h			; BX = user's header seg addr
  4208                                  %else
  4209 00001087 E8D500                  	call	int21h
  4210                                  %endif
  4211 0000108A 0441                    	add	al,"A"                  ; convert to ascii
  4212 0000108C A2[2F02]                	mov	[PutBackDrv],al		; put in message to print out
  4213                                  
  4214                                  Users_Drive:
  4215                                  	; 12/01/2023
  4216                                  	; MSDOS 6.0
  4217 0000108F BA[F205]                	mov	dx,PUTBACKMSG		; prompt for diskette
  4218                                  	;mov	si,offset DATARES:PutBackSubst
  4219                                  	;invoke	RPrint
  4220 00001092 BE[2902]                	mov	si,PutBackSubst		; containing COMMAND
  4221 00001095 E84303                  	call	RPrint
  4222                                  	;mov	dx,offset DATARES:Prompt
  4223                                  	;invoke	RPrint
  4224 00001098 BA[1406]                	mov	dx,PROMPT		; "Press any key"
  4225 0000109B E83D03                  	call	RPrint
  4226                                  
  4227                                  	; MSDOS 3.3
  4228                                  	;mov	dx,PUTBACKMSG		; prompt for diskette
  4229                                  	;call	RDISPMSG
  4230                                  	;mov	dx,[PUTBACKSUBSTPTR]
  4231                                  	;mov	si,[COMSPEC_END]
  4232                                  	;mov	byte [si+1],'$'
  4233                                  	;call	RDISPMSG
  4234                                  	;mov	byte [si+1],0
  4235                                  	;mov	dx,PROMPT
  4236                                  	;call	RDISPMSG
  4237                                  
  4238                                  	;call	GetRawFlushedByte
  4239                                  	;retn
  4240                                  	; 12/01/2023
  4241                                  	;jmp	short GetRawFlushedByte
  4242                                  
  4243                                  ;***	GetRawFlushedByte - flush world and get raw input
  4244                                  
  4245                                  GetRawFlushedByte:
  4246                                  	; 12/01/2023
  4247 0000109E B8070C                  	mov	ax,0C07h
  4248                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) | RAW_CON_INPUT ; 0C07h
  4249 000010A1 CD21                    	int	21h			; get char without testing or echo
  4250 000010A3 B8000C                  	mov	ax,0C00h
  4251                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) + 0 ; 0C00h
  4252 000010A6 CD21                    	int	21h
  4253                                  
  4254                                  ;	Bugbug:	get rid of this return and the following retz.
  4255                                  
  4256                                  LoadCom_retn:
  4257 000010A8 C3                      	retn
  4258                                  
  4259                                  	; 21/04/2023
  4260                                  TryDoOpen:
  4261 000010A9 E8C1FF                  	call	GetComDsk
  4262                                  	;jmp	short LoadCom
  4263                                  
  4264                                  ;***	LoadCom - load in transient
  4265                                  
  4266                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4267                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:10DAh - CODERES:039Ah)
  4268                                  
  4269                                  LoadCom:
  4270                                  	;assume	ds:DATARES
  4271                                  	
  4272 000010AC 45                      	inc	bp				; flag command read
  4273                                  
  4274 000010AD BA[4B02]                	mov	dx,ComSpec
  4275 000010B0 B8003D                  	mov	ax,3D00h
  4276                                  	;mov	ax,OPEN<<8	; 3D00h
  4277 000010B3 CD21                    	int	21h				; open command.com
  4278 000010B5 730B                    	jnc	short ReadCom
  4279                                  	;cmp	ax,4
  4280 000010B7 83F804                  	cmp	ax,ERROR_TOO_MANY_OPEN_FILES
  4281 000010BA 75ED                    	jnz	short TryDoOpen
  4282 000010BC BA[9E06]                	mov	dx,NOHANDMES
  4283 000010BF E959FD                  	jmp	FatalC				; will never find a handle
  4284                                  
  4285                                  	; 21/04/2023
  4286                                  ;TryDoOpen:
  4287                                  	;call	GetComDsk
  4288                                  	;jmp	short LoadCom
  4289                                  
  4290                                  ReadCom:
  4291 000010C2 89C3                    	mov	bx,ax				; BX = handle
  4292                                  	;mov	dx,offset RESGROUP:TranStart
  4293                                  	; 05/06/2023
  4294                                  	;mov	dx,26E0h ; MSDOS 6.22 COMMAND.COM
  4295                                  	; 19/07/2024
  4296                                  	;mov	dx,2980h ; PCDOS 7.1 COMMAND.COM
  4297 000010C4 BAD027                  	mov	dx,TRANSTART
  4298 000010C7 31C9                    	xor	cx,cx				; CX:DX = seek loc
  4299 000010C9 B80042                  	mov	ax,4200h
  4300                                  	;mov	ax,LSEEK<<8	; 4200h
  4301 000010CC CD21                    	int	21h
  4302 000010CE 7210                    	jc	short WrongCom1
  4303                                  	; 12/01/2023
  4304                                  	;;mov	cx,offset TRANGROUP:TranSpaceEnd - 100h
  4305                                  	;mov	cx,97C5h		 ; MSDOS 5.0 COMMAND.COM
  4306                                  	; 05/06/2023
  4307                                  	;mov	cx,0AE95h		 ; MSDOS 6.22 COMMAND.COM
  4308                                  	; 19/07/2024
  4309                                  	;mov	cx,0A99Ah ; PCDOS 7.1 COMMAND.COM
  4310 000010D0 B90BA5                  	mov	cx,TRANSPACEEND-100h ; 4C5Ch (for original MSDOS 3.3!)
  4311 000010D3 1E                      	push	ds
  4312 000010D4 8E1E[8F02]              	mov	ds,[TrnSeg]
  4313                                  	;assume	ds:NOTHING
  4314 000010D8 BA0001                  	mov	dx,100h
  4315 000010DB B43F                    	mov	ah,3Fh
  4316                                  	;mov	ah,READ	; 3Fh
  4317 000010DD CD21                    	int     21h	; DOS - 2+ - READ FROM FILE WITH HANDLE
  4318                                  			; BX = file handle, CX = number of bytes to read
  4319                                  			; DS:DX -> buffer
  4320 000010DF 1F                      	pop	ds
  4321                                  	;assume	ds:DATARES
  4322                                  WrongCom1:
  4323 000010E0 9C                      	pushf
  4324 000010E1 50                      	push	ax
  4325 000010E2 B43E                    	mov	ah,3Eh
  4326                                  	;mov	ah,CLOSE ; 3Eh
  4327 000010E4 CD21                    	int	21h			; close command.com
  4328 000010E6 58                      	pop	ax
  4329 000010E7 9D                      	popf
  4330 000010E8 7204                    	jc	short WrongCom		; error on read
  4331 000010EA 39C8                    	cmp	ax,cx
  4332                                  	;retz				; size matched
  4333 000010EC 74BA                    	jz	short LoadCom_retn
  4334                                  WrongCom:
  4335 000010EE BA[DC05]                	mov	dx,COMBAD
  4336 000010F1 E879FF                  	call	GetComDsk
  4337 000010F4 EBB6                    	jmp	short LoadCom		; try again
  4338                                  
  4339                                  ;***	ChkSum - compute transient checksum
  4340                                  
  4341                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4342                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1129h
  4343                                  	
  4344                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  4345                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1239h
  4346                                  
  4347                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4348                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1207h
  4349                                  ChkSum:
  4350 000010F6 1E                      	push	ds
  4351 000010F7 8E1E[8F02]              	mov	ds,[TrnSeg]
  4352 000010FB BE0001                  	mov	si,100h
  4353                                  	;;;mov	cx,offset TRANGROUP:TranDataEnd - 100h
  4354                                  	;;mov	cx,87C2h ; MSDOS 5.0
  4355                                  	; 05/06/2023
  4356                                  	;mov	cx,9D53h ; MSDOS 6.22
  4357                                  	; 19/07/2024
  4358                                  	;mov	cx,9B47h ; PCDOS 7.1 COMMAND.COM
  4359 000010FE B9[B896]                	mov	cx,TRANDATAEND-100h ; 3E44h (for original MSDOS 3.3!)
  4360                                  Check_Sum:
  4361 00001101 FC                      	cld
  4362 00001102 D1E9                    	shr	cx,1
  4363 00001104 31D2                    	xor	dx,dx
  4364                                  
  4365                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4366                                  %if 1  ; PCDOS 7.1 COMMAND.COM
  4367 00001106 C606[D58F]FF            	mov	byte [msg_disp_class],0FFh
  4368 0000110B 8916[D78F]              	mov     [extend_buf_ptr],dx ; 0
  4369 0000110F 8816[D98F]              	mov     [extend_buf_sub],dl ; 0
  4370                                  %endif	
  4371                                  
  4372                                  Chk:
  4373 00001113 AD                      	lodsw
  4374 00001114 01C2                    	add	dx,ax
  4375 00001116 83D200                  	adc	dx,0
  4376 00001119 E2F8                    	loop	Chk
  4377                                  
  4378                                  	; 04/05/2023
  4379 0000111B 1F                      	pop	ds
  4380                                  
  4381                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4382 0000111C 3B16[9702]              	cmp	dx,[Sum]
  4383                                  
  4384                                  	;pop	ds ; 04/05/2023
  4385 00001120 C3                      	retn
  4386                                  
  4387                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4388                                  ; ---------------------------------------
  4389                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:122Eh
  4390                                  %if 1
  4391                                  chk_transient:	; check transient portion is valid or not
  4392 00001121 1E                      	push    ds
  4393 00001122 8E1E[8F02]              	mov     ds,[TrnSeg]
  4394 00001126 813E[0401]9090          	cmp	word [TCOMMAND],9090h ; nop, nop
  4395 0000112C 1F                      	pop     ds
  4396 0000112D C3                      	retn
  4397                                  %endif
  4398                                  ; ---------------------------------------
  4399                                  
  4400                                  ;***	SetVect - set interrupt vectors
  4401                                  
  4402                                  SetVect:
  4403                                  
  4404                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4405                                  ; PCDOS 7.1 COMMAND.COM
  4406                                  %if 0
  4407                                  	;mov	dx,offset DATARES:LodCom_Trap 
  4408                                  	; 12/01/2023
  4409                                  	mov	dx,LodCom_Trap
  4410                                  	;mov	dx,LODCOM ; MSDOS 3.3
  4411                                  	mov	[PDB.EXIT],dx	; mov ds:0Ah,dx
  4412                                  	mov	[PDB.EXIT+2],ds ; mov ds:0Ch,ds
  4413                                  
  4414                                  	mov	ax,2522h
  4415                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8) | 22h  ; 2522h
  4416                                  	int	21h
  4417                                  	;mov	dx,offset DATARES:Ctrlc_Trap
  4418                                  	mov	dx,Ctrlc_Trap
  4419                                  	;mov	dx,CONTC ; MSDOS 3.3
  4420                                  	inc	al	; 23h
  4421                                  	int	21h
  4422                                  	;mov	dx,offset DATARES:CritErr_Trap
  4423                                  	mov	dx,CritErr_Trap
  4424                                  	;mov	dx,CRITERR ; MSDOS 3.3
  4425                                  	inc	al	; 24h
  4426                                  	int	21h
  4427                                  	retn
  4428                                  %else
  4429                                  	; PCDOS 7.1 COMMAND.COM
  4430                                  	;mov	dx,LodCom_Trap
  4431                                  	;mov	[PDB.EXIT],dx	; mov ds:0Ah,dx
  4432                                  	;mov	[PDB.EXIT+2],ds ; mov ds:0Ch,ds
  4433                                  
  4434                                  	;push	es
  4435                                  	;push	bx
  4436                                  	;xor	bx,bx
  4437                                  	;mov	es,bx
  4438                                  	;mov 	bl,88h		; INT 22h vector
  4439                                  	;cli
  4440                                  	;mov	[es:bx],dx
  4441                                  	;mov	[es:bx+2],ds
  4442                                  	;mov	dx,Ctrlc_Trap
  4443                                  	;mov	bl,8Ch		; INT 23h vector
  4444                                  	;mov	[es:bx],dx
  4445                                  	;mov	[es:bx+2],ds
  4446                                  	;mov	dx,CritErr_Trap
  4447                                  	;mov	bl,90h		; INT 24h vector
  4448                                  	;mov 	[es:bx],dx
  4449                                  	;mov	[es:bx+2],ds
  4450                                  	;sti
  4451                                  	;pop	bx
  4452                                  	;pop	es
  4453                                  	;retn
  4454                                  
  4455                                  	; 19/07/2024
  4456                                  	; Retro DOS v5.0 COMMAND.COM
  4457                                  
  4458 0000112E 06                      	push	es
  4459                                  	;push	di
  4460 0000112F 31FF                    	xor	di,di
  4461 00001131 8EC7                    	mov	es,di
  4462 00001133 BF8800                  	mov	di,88h
  4463 00001136 1E                      	push	ds
  4464 00001137 1E                      	push	ds
  4465 00001138 1E                      	push	ds
  4466 00001139 B8[E000]                	mov	ax,LodCom_Trap
  4467 0000113C A30A00                  	mov	[PDB.EXIT],ax	; mov ds:0Ah,ax
  4468 0000113F 8C1E0C00                	mov	[PDB.EXIT+2],ds ; mov ds:0Ch,ds
  4469 00001143 FA                      	cli	
  4470 00001144 AB                      	stosw
  4471 00001145 58                      	pop	ax	; segment (ds)
  4472 00001146 AB                      	stosw
  4473 00001147 B8[AC00]                	mov	ax,Ctrlc_Trap
  4474 0000114A AB                      	stosw
  4475 0000114B 58                      	pop	ax	; segment (ds)
  4476 0000114C AB                      	stosw
  4477 0000114D B8[B700]                	mov	ax,CritErr_Trap
  4478 00001150 AB                      	stosw
  4479 00001151 58                      	pop	ax	; segment (ds)
  4480 00001152 AB                      	stosw
  4481 00001153 FB                      	sti
  4482                                  	;pop	di
  4483 00001154 07                      	pop	es
  4484 00001155 C3                      	retn
  4485                                  %endif
  4486                                  
  4487                                  ; ----------------------
  4488                                  	; MSDOS 6.0
  4489                                  ;;SR;
  4490                                  ;We have this to take care of the extra values pushed on the stack by
  4491                                  ;the stub before jumping to LodCom1. We set up ds here and then jump to
  4492                                  ;Lodcom1
  4493                                  
  4494                                  ;public	TrnLodCom1
  4495                                  	; 12/01/2023
  4496                                  TrnLodCom1:
  4497 00001156 1F                      	pop	ds			; ds = DATARES
  4498 00001157 83C402                  	add	sp,2
  4499                                  ;	pop	ds:OldDS
  4500 0000115A E9EFFD                  	jmp	LodCom1
  4501                                  ; ----------------------
  4502                                  
  4503                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4504                                  ; ---------------------------------------
  4505                                  %if 1	; PCDOS 7.1 COMMAND.COM
  4506                                  int21h_close:
  4507 0000115D B43E                    	mov	ah,3Eh ; CLOSE file
  4508                                  int21h:
  4509                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1272h
  4510 0000115F 06                      	push	es
  4511 00001160 53                      	push	bx
  4512 00001161 31DB                    	xor	bx,bx
  4513 00001163 8EC3                    	mov	es,bx ; 0
  4514 00001165 5B                      	pop	bx
  4515 00001166 9C                      	pushf			; Int 21h simulation (ES=0)
  4516 00001167 FA                      	cli
  4517                                  	;call	dword ptr es:84h
  4518 00001168 26FF1E8400              	call	far [es:84h]	; INT 21h handler
  4519 0000116D 07                      	pop	es
  4520 0000116E C3                      	retn
  4521                                  %endif
  4522                                  ; ---------------------------------------
  4523                                  
  4524                                  ;=============================================================================
  4525                                  ; RUCODE.ASM, MSDOS 6.0, 1991
  4526                                  ;=============================================================================
  4527                                  ; 22/09/2018 - Retro DOS v3.0
  4528                                  
  4529                                  ;	title	Localizable code for resident COMMAND
  4530                                  
  4531                                  	;assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  4532                                  
  4533                                  ; ----------------------------------------------------------------------------
  4534                                  ;***	AskEnd - ask user to confirm batch file termination
  4535                                  ;
  4536                                  ;	Confirm with user before freeing batch ...
  4537                                  ;
  4538                                  ;	ENTRY	nothing
  4539                                  ;
  4540                                  ;	EXIT	CY = set if batch termination is confirmed
  4541                                  ;
  4542                                  ;		CY = clear if batch should continue
  4543                                  ;
  4544                                  ;	USED	AX,DX,...
  4545                                  ;
  4546                                  ;	Bugbug:	move this to transient, copy to batch segment.
  4547                                  ;	Bugbug:	or move it to command1 1st.
  4548                                  ;
  4549                                  ;	Bugbug: No_Char and Yes_Char should be constants.
  4550                                  ; ----------------------------------------------------------------------------
  4551                                  
  4552                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4553                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1169h (CODERES:0429h)
  4554                                  
  4555                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  4556                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1279h (CODERES:0429h)
  4557                                  
  4558                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4559                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1289h
  4560                                  AskEnd:
  4561                                  	;assume	ds:DATARES
  4562                                  
  4563 0000116F BA[3606]                	mov	dx,ENDBATMES			; DX = message #
  4564 00001172 E86602                  	call	RPrint
  4565                                  	;call	RDISPMSG  ; MSDOS 3.3
  4566 00001175 B8010C                  	mov	ax,0C01h
  4567                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) + STD_CON_INPUT  ;0C01h
  4568 00001178 CD21                    	int     21h             ; DOS - CLEAR KEYBOARD BUFFER
  4569                                  				; AL must be 01h, 06h, 07h, 08h, or 0Ah.
  4570 0000117A E8F702                  	call	CharToUpper			; change to upper case
  4571 0000117D 3A06[3D05]              	cmp	al,[NO_CHAR]
  4572 00001181 7407                    	je	short aeRet			; answer is no (CY is clear)
  4573 00001183 3A06[3C05]              	cmp	al,[YES_CHAR]
  4574 00001187 75E6                    	jne	short AskEnd			; invalid response, try again
  4575 00001189 F9                      	stc					; answer is yes
  4576                                  aeRet:	
  4577 0000118A C3                      	retn
  4578                                  
  4579                                  ; ----------------------------------------------------------------------------
  4580                                  ;***	DskErr - critical error handler
  4581                                  ;
  4582                                  ;	Default critical error handler unless user intercepts int 24h.
  4583                                  ;
  4584                                  ;	ENTRY	int 24h
  4585                                  ;
  4586                                  ;	EXIT
  4587                                  ;
  4588                                  ;	USED
  4589                                  ;
  4590                                  ;	EFFECTS
  4591                                  ; ----------------------------------------------------------------------------
  4592                                  
  4593                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4594                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1185h (CODERES:0445h)
  4595                                  
  4596                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4597                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:12A5h
  4598                                  
  4599                                  ;SR; 
  4600                                  ;The stub is going to push the old ds value and the resident data segment
  4601                                  ;onto the stack in that order. Get it off the stack
  4602                                  
  4603                                  ;DskErr	proc	far
  4604                                  DSKERR:
  4605                                  	;assume	ds:NOTHING,es:NOTHING,ss:NOTHING
  4606                                  	; 12/01/2023
  4607 0000118B 1F                      	pop	ds			; ds = DATARES
  4608                                  	;assume ds:DATARES
  4609 0000118C 8F06[2E05]              	pop	word [OldDS]		; save old ds value
  4610                                  
  4611                                  ;CRITERR: ; MSDOS 3.3
  4612 00001190 FB                      	sti
  4613                                  	; 12/01/2023
  4614                                  	;push	ds ; 25/09/2018
  4615 00001191 06                      	push	es
  4616 00001192 56                      	push	si
  4617 00001193 51                      	push	cx
  4618 00001194 57                      	push	di
  4619 00001195 51                      	push	cx
  4620 00001196 50                      	push	ax
  4621                                  
  4622 00001197 1E                      	push	ds			;save our data segment
  4623                                  	;push	cs ; 25/09/2018
  4624 00001198 07                      	pop	es			;es = DATARES
  4625                                  
  4626 00001199 8EDD                    	mov	ds,bp
  4627                                  	;assume	ds:nothing
  4628                                  
  4629                                  	;mov	ax,[si].SDEVATT
  4630 0000119B 8B4404                  	mov	ax,[si+SYSDEV.ATT] ; mov ax,[si+4]	
  4631 0000119E 268826[2502]            	mov	[es:CDevAt],ah
  4632                                  
  4633                                  	;push	cs
  4634                                  	;pop	es
  4635                                  
  4636 000011A3 BF[1802]                	mov	di,DevName
  4637 000011A6 B90800                  	mov	cx,8
  4638                                  	;add	si,SDEVNAME  ; add si,10
  4639 000011A9 83C60A                  	add	si,SYSDEV.NAME	; save device name (even for block device)
  4640                                  				
  4641 000011AC FC                      	cld
  4642 000011AD F3A4                    	rep	movsb
  4643 000011AF 58                      	pop	ax
  4644 000011B0 59                      	pop	cx
  4645 000011B1 5F                      	pop	di
  4646                                  
  4647                                  ;	Stack still contains DS and ES.
  4648                                  
  4649                                  ;SR;
  4650                                  ;We need ds = DATARES for SavHand
  4651                                  
  4652                                  	 ;12/01/2023
  4653 000011B2 06                      	push	es
  4654 000011B3 1F                      	pop	ds
  4655                                  	;assume	ds:DATARES
  4656                                  
  4657                                  	;invoke	SavHand		; save user's stdin/out, set to our stderr
  4658 000011B4 E870FE                  	call	SavHand
  4659                                  
  4660                                  	; 12/01/2023
  4661                                  	; 25/09/2018
  4662                                  	;;push	cs
  4663                                  	;push	es
  4664                                  	;pop	ds		; set up local data segment
  4665                                  	;assume	ds:resgroup
  4666                                  
  4667 000011B7 52                      	push	dx
  4668 000011B8 E81D02                  	call	crlf
  4669 000011BB 5A                      	pop	dx
  4670                                  
  4671                                  ;	Bugbug:	rename Crit_Err_Info to CritErrAH?
  4672                                  
  4673 000011BC 8826[9C02]              	mov	[Crit_Err_Info],ah	; save critical error flags
  4674                                  
  4675                                  ;	Compute and save ASCII drive letter (nonsense for char devices)
  4676                                  
  4677 000011C0 0441                    	add	al,'A'
  4678 000011C2 A2[0502]                	mov	[DrvLet],al
  4679                                  
  4680                                  ;	Bugbug:	These labels are awful. Change, especially 'NoHardE'.
  4681                                  
  4682 000011C5 F6C480                  	test	ah,80h
  4683 000011C8 740A                    	jz	short NoHardE		; it's a disk-device error
  4684 000011CA F606[2502]80            	test	byte [CDevAt],DEVTYP>>8 ; 80h
  4685 000011CF 7503                    	jnz	short NoHardE		; it's a character device
  4686 000011D1 E9F701                  	jmp	FatErr			; it's a FAT error
  4687                                  
  4688                                  NoHardE:
  4689 000011D4 BE[5E05]                	mov	si,MREAD		; SI = "read" msg #
  4690 000011D7 F6C401                  	test	ah,1
  4691 000011DA 7403                    	jz	short SavMes		; it's a read error
  4692 000011DC BE[6705]                	mov	si,MWRITE		; SI = "write" msg #
  4693                                  SavMes:
  4694 000011DF 893E[5C04]              	mov	[OldErrNo],di		; save critical error code
  4695                                  
  4696                                  ;	Bugbug:	don't need to save/restore all here?
  4697                                  
  4698 000011E3 06                      	push	es
  4699                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  4700                                  	;push	ds			; GetExtendedError likes to STOMP
  4701                                  	; 12/01/2023
  4702                                  	; (all registers are changed -in dos service- except bp) *
  4703                                  	;push	bp
  4704                                  	; 19/07/2024
  4705                                  	;push	si
  4706                                  	;push	dx
  4707 000011E4 51                      	push	cx
  4708 000011E5 53                      	push	bx
  4709                                  	; 05/06/2023
  4710 000011E6 B459                    	mov	ah,59h ; *
  4711                                  	;mov	ah,GetExtendedError ; 59h ; get extended error info
  4712 000011E8 CD21                    	int	21h
  4713 000011EA 5B                      	pop	bx
  4714 000011EB 59                      	pop	cx
  4715                                  	; 19/07/2024
  4716                                  	;pop	dx
  4717                                  	;pop	si
  4718                                  	; 12/01/2023
  4719                                  	;pop	bp
  4720                                  	; 19/07/2024
  4721                                  	;pop	ds
  4722 000011EC 893E[3302]              	mov	[NeedVol],di		; save possible ptr to volume label
  4723 000011F0 8C06[3502]              	mov	[NeedVol+2],es
  4724 000011F4 07                      	pop	es
  4725                                  
  4726                                  ;	Bugbug:	AX has extended error code, so no need to zero AH?
  4727                                  
  4728                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  4729                                  	;xor	ah,ah
  4730 000011F5 89C7                    	mov	di,ax			; DI = error code
  4731                                  
  4732                                  ; Bugbug: somewhat obsolete documentation?
  4733                                  ;
  4734                                  ; DI is now the correct error code. Classify things to see what we are
  4735                                  ; allowed to report. We convert DI into a 0-based index into a message table.
  4736                                  ; This presumes that the int 24 errors (oldstyle) and new errors (sharing and
  4737                                  ; the like) are contiguous.
  4738                                  
  4739                                  ;	Bugbug:	simplify following code by cmp'ing instead of sub'ing.
  4740                                  ;	Check use of ErrCd_24, though.
  4741                                  
  4742 000011F7 83EF13                  	sub	di,ERROR_WRITE_PROTECT ; 13h
  4743 000011FA 7303                    	jae	short HavCod
  4744                                  
  4745                                  ;	Bugbug:	wouldn't it be better to display the original error msg,
  4746                                  ;	even though it's not a critical error?
  4747                                  
  4748 000011FC BF0C00                  	mov	di,ERROR_GEN_FAILURE - ERROR_WRITE_PROTECT ; mov di,0Ch
  4749                                  
  4750                                  ; DI now has the mapped error code. Old style errors are:
  4751                                  ;   FOOBAR <read|writ>ing drive ZZ.
  4752                                  ; New style errors are:
  4753                                  ;   FOOBAR
  4754                                  ; We need to figure out which the particular error belongs to.
  4755                                  
  4756                                  HavCod:
  4757 000011FF C606[3702]00            	mov	byte [ErrType],0	; assume old style
  4758 00001204 83FF10                  	cmp	di,ERROR_FCB_UNAVAILABLE - ERROR_WRITE_PROTECT  ; cmp di,10h
  4759 00001207 7405                    	je	short SetStyle
  4760 00001209 83FF11                  	cmp	di,ERROR_SHARING_BUFFER_EXCEEDED - ERROR_WRITE_PROTECT ; cmp di,11h
  4761 0000120C 7504                    	jne	short GotStyle
  4762                                  
  4763                                  SetStyle:
  4764                                  ;	Bugbug:	use INC
  4765                                  	;mov	byte [ErrType],1		; must be new type
  4766 0000120E FE06[3702]              	inc	byte [ErrType] ; Retro DOS v3.0 COMMAND.COM - 22/09/2018
  4767                                  
  4768                                  GotStyle:
  4769 00001212 893E[4402]              	mov	[ErrCd_24],di
  4770                                  	; 12/01/2023
  4771                                  	; 25/09/2018
  4772                                  	; MSDOS 6.0
  4773 00001216 83FF14                  	cmp	di,ERROR_HANDLE_DISK_FULL - ERROR_WRITE_PROTECT ; cmp di,14h
  4774                                  	; MSDOS 3.3
  4775                                  	;cmp	di,ERROR_SHARING_BUFFER_EXCEEDED - ERROR_WRITE_PROTECT ; cmp di,11h
  4776                                  
  4777                                  						; If the error message is unknown
  4778 00001219 7641                    	jbe	short NormalError		;  redirector, continue. Otherwise,
  4779                                  
  4780                                  ; We do not know how to handle this error. Ask IFSFUNC if she knows
  4781                                  ; how to handle things
  4782                                  
  4783                                  ;input to IFSFUNC:    AL=1
  4784                                  ;		      BX=extended error number
  4785                                  ;
  4786                                  ;output from IFSFUNC: AL=error type (0 or 1)
  4787                                  ;			 0=<message> error (read/writ)ing (drive/device) xxx
  4788                                  ;			   Abort, Retry, Ignore
  4789                                  ;			 1=<message>
  4790                                  ;			   Abort, Retry, Ignore
  4791                                  ;		      ES:DI=pointer to message text
  4792                                  ;		      carry set=>no message
  4793                                  
  4794 0000121B 89C7                    	mov	di,ax			; retrieve correct extended error...
  4795 0000121D B80005                  	mov	ax,0500h		; is the redir there?
  4796 00001220 CD2F                    	int	2Fh	; Multiplex - DOS 3+ CRITICAL ERROR HANDLER - INSTALLATION CHECK
  4797                                  			; Return: AL = 00h not installed, OK to install
  4798                                  			; 01h not installed, can't install
  4799                                  			; FFh installed
  4800 00001222 3CFF                    	cmp	al,0FFh
  4801 00001224 7529                    	jne	short NoHandler		; no, go to NoHandler
  4802                                  
  4803                                  	; 12/01/2023
  4804                                  	; MSDOS 6.0
  4805 00001226 53                      	push	bx
  4806 00001227 89FB                    	mov	bx,di			; get ErrType and ptr to error msg
  4807 00001229 B80105                  	mov	ax,0501h
  4808 0000122C CD2F                    	int	2Fh	; Multiplex - DOS 3+ CRITICAL ERROR HANDLER -
  4809 0000122E 5B                      	pop	bx 
  4810 0000122F 721E                    	jc	short NoHandler
  4811                                  	
  4812                                  	; MSDOS 3.3
  4813                                  	;mov     ax,di
  4814                                  	;mov     ah,5
  4815                                  	;int     2Fh	; Multiplex - DOS 3+ CRITICAL ERROR HANDLER -
  4816                                  	;jc      short NOHANDLER
  4817                                  
  4818                                  ;	Bugbug:	need to record error type?
  4819                                  
  4820 00001231 A2[3702]                	mov	[ErrType],al
  4821                                  
  4822 00001234 1E                      	push	ds
  4823 00001235 06                      	push	es
  4824 00001236 1F                      	pop	ds
  4825 00001237 89FA                    	mov	dx,di
  4826 00001239 B9FFFF                  	mov	cx,-1			; find end of msg
  4827 0000123C 30C0                    	xor	al,al
  4828                                  
  4829 0000123E FC                      	cld
  4830 0000123F F2AE                    	repnz	scasb
  4831                                  
  4832                                  ;	Bugbug:	we can do better than this.
  4833                                  
  4834                                  	;mov	byte [di-1],'$'
  4835                                  	; 19/07/2024
  4836 00001241 4F                      	dec	di
  4837 00001242 C60524                  	mov	byte [di],'$'
  4838                                  
  4839                                  	;CALL	RDISPMSG ; MSDOS 3.3
  4840                                  	
  4841 00001245 B409                    	mov	ah,STD_CON_STRING_OUTPUT ; 9	; print the message
  4842 00001247 CD21                    	int	21h
  4843                                  
  4844                                  	;mov	byte [di-1],0			; restore terminal byte
  4845                                  	; 19/07/2024
  4846 00001249 C60500                  	mov	byte [di],0
  4847                                  
  4848 0000124C 1F                      	pop	ds				; clean up and continue
  4849 0000124D EB15                    	jmp	short CheckErrType
  4850                                  
  4851                                  ;*	Redir isn't available or doesn't recognize the error.
  4852                                  ;	Restore regs to unextended error.
  4853                                  
  4854                                  NoHandler:
  4855 0000124F C606[3702]00            	mov	byte [ErrType],0
  4856                                  ;	Bugbug:	won't this break, since we add error_write_protect back in?
  4857 00001254 8B3E[5C04]              	mov	di,[OldErrNo]
  4858 00001258 893E[4402]              	mov	[ErrCd_24],di
  4859                                  
  4860                                  NormalError:
  4861                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4862                                  	; MSDOS 6.0
  4863 0000125C 83C713                  	add	di,ERROR_WRITE_PROTECT
  4864 0000125F 87D7                    	xchg	di,dx			; may need dx later
  4865 00001261 E89001                  	call	RPrintCrit		; print error type
  4866                                  
  4867                                  	; MSDOS 3.3
  4868                                  	;shl     di,1
  4869                                  	;mov     di,[CRMSGTBL+di]
  4870                                  	;xchg    di,dx
  4871                                  	;call    RDISPMSG
  4872                                  
  4873                                  CheckErrType:
  4874 00001264 803E[3702]00            	cmp	byte [ErrType],0	; Check error style...
  4875 00001269 7405                    	je	short ContOld
  4876 0000126B E86A01                  	call	crlf			; if new style then done printing
  4877 0000126E EB31                    	jmp	short Ask
  4878                                  
  4879                                  ContOld:
  4880                                  	; 12/01/2023
  4881                                  	; MSDOS 6.0
  4882 00001270 46                      	inc	si			; DS:SI = ptr to asciiz string
  4883                                  
  4884                                  ;	Bugbug:	combine some of the following two sections?
  4885                                  
  4886                                  	; 12/01/2023
  4887 00001271 F606[2502]80            	test	byte [CDevAt],DEVTYP>>8 ; 80h
  4888                                  	;test	byte [CDevAt],DEVTYP shr 8 ; 80h
  4889 00001276 740F                    	jz	short BlkErr
  4890                                  	;;mov	dx,offset DATARES:CharDevErr	; DX = ptr to device message
  4891                                  	;mov	dx,ChardevErr
  4892 00001278 BA[7F05]                	mov	dx,MDEVICE
  4893                                  	;mov	[CharDevErrRw.SubstPtr],si	; point to read/write string
  4894 0000127B 8936[0702]              	mov	[CharDevErrRw],si
  4895                                  	;mov	si,offset DATARES:CharDevErrSubst; SI = ptr to subst block
  4896 0000127F BE[0602]                	mov	si,CharDevErrSubst
  4897                                  
  4898 00001282 E85601                  	call	RPrint				; print the message
  4899 00001285 EB1A                    	jmp	short Ask			; don't ralph on command
  4900                                  
  4901                                  	; 12/01/2023
  4902                                  	; MSDOS 3.3
  4903                                  	;mov	dx,ERRMES
  4904                                  	;call	RDISPMSG
  4905                                  	;mov	dx,si
  4906                                  	;call	RDISPMSG
  4907                                  	;
  4908                                  	;test	byte [CDevAt],80h
  4909                                  	;jz	short BLKERR
  4910                                  	;mov	dx,CHARDEVERR	; " device "
  4911                                  	;mov	ah,STD_CON_STRING_OUTPUT ; 9
  4912                                  	;int	21h		; DOS - PRINT STRING
  4913                                  	;			; DS:DX -> string terminated by "$"
  4914                                  	;jmp	short ASK
  4915                                  
  4916                                  BlkErr:
  4917                                  	; 12/01/2023
  4918                                  	; MSDOS 6.0
  4919                                  	;;mov	dx,offset DATARES:BlkDevErr	; DX = error msg #
  4920                                  	;mov	dx,BlkDevErr
  4921 00001287 BA[7005]                	mov	dx,MDRIVE
  4922                                  	;mov	[BlkDevErrRw.SubstPtr],si	; "reading","writing" ptr
  4923 0000128A 8936[0002]              	mov	[BlkDevErrRw],si
  4924                                  	;mov	si,offset DATARES:BlkDevErrSubst ; SI = ptr to subst block
  4925 0000128E BE[FF01]                	mov	si,BlkDevErrSubst
  4926 00001291 E84701                  	call	RPrint
  4927                                  
  4928                                  	; MSDOS 3.3
  4929                                  	;mov	dx,BLKDEVERR
  4930                                  	;call	RDISPMSG
  4931                                  
  4932 00001294 803E[4802]00            	cmp	byte [Loading],0
  4933 00001299 7406                    	jz	short Ask
  4934 0000129B E8B3FD                  	call	RestHand
  4935 0000129E E9AAFD                  	jmp	GetComDsk2		; if error loading COMMAND, re-prompt
  4936                                  Ask:
  4937 000012A1 833E[4402]0F            	cmp	word [ErrCd_24],15	; error 15 has an extra message
  4938 000012A6 751E                    	jne	short Not15		; not error 15
  4939                                  
  4940                                  ;*	For error 15, tell the user which volume/serial # are needed.
  4941                                  
  4942 000012A8 51                      	push	cx
  4943                                  
  4944                                  ;	Bugbug:	does this push/pop need to be done?
  4945                                  
  4946 000012A9 1E                      	push	ds
  4947 000012AA 07                      	pop	es
  4948 000012AB C536[3302]              	lds	si,[NeedVol]
  4949                                  	;assume	ds:NOTHING
  4950 000012AF 57                      	push	di
  4951 000012B0 BF[1502]                	mov	di,VolName
  4952                                  	; 12/01/2023
  4953                                  	; MSDOS 6.0
  4954 000012B3 B91000                  	mov	cx,16			; copy volume name & serial #
  4955                                  	; MSDOS 3.3
  4956                                  	;mov	cx,11			; copy volume name
  4957 000012B6 FC                      	cld
  4958 000012B7 F3A4                    	rep	movsb
  4959 000012B9 5F                      	pop	di
  4960 000012BA 06                      	push	es
  4961 000012BB 1F                      	pop	ds
  4962 000012BC 59                      	pop	cx
  4963                                  	;assume	ds:DATARES
  4964                                  	; 12/01/2023
  4965                                  	; MSDOS 6.0
  4966                                  	;mov	dx,offset DATARES:NeedVolMsg	; DX = ptr to msg
  4967                                  	;mov	si,offset DATARES:NeedVolSubst	; DS:SI = ptr to subst block
  4968                                  	;mov	dx,NeedVolMsg
  4969 000012BD BA[8F05]                	mov	dx,MVOLSERIAL
  4970 000012C0 BE[0C02]                	mov	si,NeedVolSubst
  4971 000012C3 E81501                  	call	RPrint
  4972                                  
  4973                                  	; MSDOS 3.3
  4974                                  	;mov	dx,NEEDVOLMSG
  4975                                  	;mov	ah,STD_CON_STRING_OUTPUT ; 9
  4976                                  	;int	21h		; DOS - PRINT STRING
  4977                                  	;			; DS:DX -> string terminated by "$"
  4978                                  Not15:
  4979                                  ;*	Print abort, retry, ignore, fail message.
  4980                                  ;	Print only options that are valid.
  4981                                  
  4982                                  ;	Bugbug:	sizzle this.
  4983                                  
  4984                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4985 000012C6 BA[3E05]                	mov	dx,REQ_ABORT
  4986 000012C9 E80F01                  	call	RPrint
  4987                                  	;call	RDISPMSG
  4988 000012CC F606[9C02]10            	test	byte [Crit_Err_Info],RETRY_ALLOWED  ; 10h
  4989 000012D1 7406                    	jz	short Try_Ignore
  4990 000012D3 BA[4405]                	mov	dx,REQ_RETRY
  4991 000012D6 E80201                  	call	RPrint
  4992                                  	;call	RDISPMSG
  4993                                  Try_Ignore:
  4994 000012D9 F606[9C02]20            	test	byte [Crit_Err_Info],IGNORE_ALLOWED ; 20h
  4995 000012DE 7406                    	jz	short Try_Fail
  4996 000012E0 BA[4C05]                	mov	dx,REQ_IGNORE
  4997 000012E3 E8F500                  	call	RPrint
  4998                                  	;call	RDISPMSG
  4999                                  Try_Fail:
  5000 000012E6 F606[9C02]08            	test	byte [Crit_Err_Info],FAIL_ALLOWED   ; 08h
  5001 000012EB 7406                    	jz	short Term_Question
  5002 000012ED BA[5505]                	mov	dx,REQ_FAIL
  5003 000012F0 E8E800                  	call	RPrint
  5004                                  	;call	RDISPMSG
  5005                                  Term_Question:
  5006 000012F3 BA[5C05]                	mov	dx,REQ_END
  5007 000012F6 E8E200                  	call	RPrint
  5008                                  	;call	RDISPMSG
  5009                                  
  5010                                  ;	If the /f switch was given, we fail all requests.
  5011                                  
  5012 000012F9 F606[A902]FF            	test	byte [fFail],-1
  5013 000012FE 741B                    	jz	short DoPrompt
  5014 00001300 B403                    	mov	ah,3				; signal fail
  5015 00001302 E9B700                  	jmp	EExit
  5016                                  
  5017                                  	; 16/04/2023
  5018                                  Abort_Process:
  5019 00001305 F606[1203]01            	test	byte [InitFlag],INITINIT ; 1	; COMMAND init interrupted?
  5020 0000130A 746C                    	jz	short AbortCont			; no, handle it normally
  5021 0000130C 803E[A202]00            	cmp	byte [PermCom],0		; are we top level process?
  5022 00001311 745A                    	jz	short JustExit			; yes, just exit
  5023                                  
  5024 00001313 BA[DC0C]                	mov	dx,PATRICIDE			; no, load ptr to error msg
  5025                                  	; 12/01/2023
  5026 00001316 E8C200                  	call	RPrint				; print it
  5027                                  	;call	RDISPMSG
  5028                                  DeadInTheWater:
  5029 00001319 EBFE                    	jmp	short DeadInTheWater		; loop until the user reboots
  5030                                  
  5031                                  DoPrompt:
  5032                                  	; 12/01/2023
  5033 0000131B B8010C                  	mov	ax,0C01h
  5034                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) + STD_CON_INPUT ; 0C01h
  5035 0000131E CD21                    	int	21h				; get response
  5036                                  
  5037                                  ; 21/07/2024 - PCDOS 7.1 COMMAND.COM
  5038                                  %if 1
  5039                                  ;ifdef DBCS
  5040                                  	;invoke	TestKanjR			; 3/3/KK
  5041 00001320 E85A01                  	call	ITestKanj
  5042 00001323 740A                    	jz	short NotKanj			; 3/3/KK
  5043                                   
  5044                                  	;mov	ax,(STD_CON_INPUT shl 8) ; eat the 2nd byte of ECS code  3/3/KK
  5045 00001325 B80001                  	mov	ax,0100h
  5046 00001328 CD21                    	int	21h				; 3/3/KK
  5047 0000132A E8AB00                  	call	crlf				; 3/3/KK
  5048                                  	;jmp	short Ask			; 3/3/KK
  5049                                  	; 22/07/2024
  5050 0000132D EB3B                    	jmp	short AskJ
  5051                                  NotKanj:
  5052                                  ;endif
  5053                                  %endif
  5054 0000132F E8A600                  	call	crlf
  5055 00001332 E83F01                  	call	CharToUpper			; convert to upper case
  5056 00001335 B400                    	mov	ah,0				; return code for ignore
  5057 00001337 F606[9C02]20            	test	byte [Crit_Err_Info],IGNORE_ALLOWED ; 20h ; is ignore allowed?
  5058 0000133C 7406                    	jz	short User_Retry
  5059 0000133E 3A06[3A05]              	cmp	al,[IGNORE_CHAR]		; ignore?
  5060                                  	;jz	short EExitJ
  5061                                  	; 16/04/2023
  5062 00001342 7478                    	jz	short EExit
  5063                                  
  5064                                  ;	Bugbug:	optimize following code.
  5065                                  
  5066                                  User_Retry:
  5067 00001344 FEC4                    	inc	ah				; return code for retry
  5068 00001346 F606[9C02]10            	test	byte [Crit_Err_Info],RETRY_ALLOWED ; 10h ; is retry allowed?
  5069 0000134B 7406                    	jz	short User_Abort
  5070 0000134D 3A06[3905]              	cmp	al,[RETRY_CHAR]			; retry?
  5071                                  	;jz	short EExitJ
  5072                                  	; 16/04/2023
  5073 00001351 7469                    	jz	short EExit
  5074                                  User_Abort:
  5075 00001353 FEC4                    	inc	ah				; return code for abort
  5076                                  						;  (abort always allowed)
  5077 00001355 3A06[3805]              	cmp	al,[ABORT_CHAR]			; abort?
  5078 00001359 74AA                    	jz	short Abort_Process		; exit user program
  5079 0000135B FEC4                    	inc	ah				; return code for fail
  5080 0000135D F606[9C02]08            	test	byte [Crit_Err_Info],FAIL_ALLOWED ; 08h ; is fail allowed?
  5081 00001362 7406                    	jz	short AskJ
  5082 00001364 3A06[3B05]              	cmp	al,[FAIL_CHAR]			; fail?
  5083                                  	;jz	short EExitJ
  5084                                  	; 16/04/2023
  5085 00001368 7452                    	jz	short EExit
  5086                                  AskJ:
  5087 0000136A E934FF                  	jmp	Ask
  5088                                  
  5089                                  	; 12/01/2023
  5090                                  ;EExitJ:
  5091                                  	;jmp	short EExit
  5092                                  
  5093                                  JustExit:
  5094                                  	;assume	ds:DATARES
  5095                                  	; 12/01/2023
  5096 0000136D A1[3E02]                	mov	ax,[Parent]			; load real parent pid
  5097                                  	;mov	[16h],ax
  5098 00001370 A31600                  	mov	[PDB.PARENT_PID],ax		; put it back where it belongs
  5099 00001373 B8FF4C                  	mov	ax,4CFFh
  5100                                  	;mov	ax,(EXIT<<8) | 255 ; 4CFFh
  5101 00001376 CD21                    	int     21h             ; DOS - 2+ - QUIT WITH EXIT CODE (EXIT)
  5102                                  				; AL = exit code
  5103                                  AbortCont:
  5104 00001378 F606[9202]FF            	test	byte [In_Batch],-1		; Are we accessing a batch file?
  5105 0000137D 7405                    	jz	short Not_Batch_Abort
  5106 0000137F C606[9302]01            	mov	byte [Batch_Abort],1		; set flag for abort
  5107                                  
  5108                                  Not_Batch_Abort:
  5109 00001384 8A16[1303]              	mov	dl,[PipeFlag]
  5110 00001388 E87CFA                  	call	ResPipeOff
  5111 0000138B 08D2                    	or	dl,dl
  5112 0000138D 740D                    	je	short CheckForA
  5113 0000138F 833E[A502]00            	cmp	word [SingleCom],0
  5114 00001394 7406                    	je	short CheckForA
  5115 00001396 C706[A502]FFFF          	mov	word [SingleCom],-1		; make sure SingleCom exits
  5116                                  
  5117                                  CheckForA:
  5118 0000139C 833E[4402]00            	cmp	word [ErrCd_24],0		; write protect?
  5119 000013A1 7407                    	je	short abortfor
  5120 000013A3 833E[4402]02            	cmp	word [ErrCd_24],2		; drive not ready?
  5121 000013A8 7512                    	jne	short EExit			; don't abort the FOR
  5122                                  
  5123                                  abortfor:
  5124 000013AA C606[AB02]00            	mov	byte [ForFlag],0		; abort a FOR in progress
  5125 000013AF 833E[A502]00            	cmp	word [SingleCom],0
  5126 000013B4 7406                    	je	short EExit
  5127 000013B6 C706[A502]FFFF          	mov	word [SingleCom],-1		; make sure SingleCom exits
  5128                                  
  5129                                  EExit:
  5130 000013BC 88E0                    	mov	al,ah
  5131 000013BE 89FA                    	mov	dx,di
  5132                                  RestHd:
  5133 000013C0 E88EFC                  	call    RestHand
  5134 000013C3 59                      	pop	cx
  5135 000013C4 5E                      	pop	si				; restore registers
  5136 000013C5 07                      	pop	es
  5137                                  
  5138                                  	; 12/01/2023	
  5139                                  	; MSDOS 6.0
  5140                                  ;;	pop	ds
  5141                                  ;SR;
  5142                                  ;ds has to be got from the variable we saved it in
  5143                                  
  5144 000013C6 8E1E[2E05]               	mov	ds,[OldDS]			; restore old value of ds
  5145                                  
  5146                                  ;	pop	ds
  5147                                  ;	assume	ds:nothing
  5148                                  
  5149                                  	; MSDOS 3.3
  5150                                  	;pop	ds
  5151                                  
  5152 000013CA CF                      	iret
  5153                                  
  5154                                  FatErr:
  5155                                  	; 12/01/2023
  5156                                  	; MSDOS 6.0
  5157                                  	;mov	dx,offset DATARES:BadFatMsg
  5158                                  	;mov	si,offset DATARES:BadFatSubst
  5159 000013CB BA[B605]                	mov	dx,BADFATMSG
  5160 000013CE BE[2602]                	mov	si,BadFatSubst
  5161 000013D1 E80700                  	call	RPrint
  5162                                  
  5163                                  	; MSDOS 3.3
  5164                                  	;mov	dx,BADFATMSG
  5165                                  	;call	RDISPMSG
  5166                                  	;mov	dx,BLKDEVERR
  5167                                  	;call	RDISPMSG
  5168                                  
  5169 000013D4 B002                    	mov	al,2				; abort
  5170 000013D6 EBE8                    	jmp	short RestHd
  5171                                  
  5172                                  ;DskErr	endp
  5173                                  
  5174                                  	; MSDOS 6.0
  5175                                  ; ----------------------------------------------------------------------------
  5176                                  ;***	RPrint - print message
  5177                                  ;***	Crlf - display cr/lf
  5178                                  ;
  5179                                  ;	ENTRY	DS:DX = ptr to count byte, followed by message text
  5180                                  ;		DS:SI = ptr to 1st substitution block for this msg, if any
  5181                                  ;		variable fields related to substitution blocks are set
  5182                                  ;
  5183                                  ;	EXIT	nothing
  5184                                  ;
  5185                                  ;	USED	flags
  5186                                  ;
  5187                                  ;	EFFECTS
  5188                                  ;	  Message is displayed on stdout.
  5189                                  ;
  5190                                  ;	NOTE
  5191                                  ;	  Number of substitutions (%1, %2,...) in message text must not
  5192                                  ;	  be greater than number of substition blocks present.
  5193                                  ; ----------------------------------------------------------------------------
  5194                                  
  5195                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5196                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:13D1h (CODERES:0691h)
  5197                                  
  5198                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
  5199                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:14F6h
  5200                                  crlf: 
  5201                                  	;mov	dx,offset DATARES:Newlin ; cheap newline
  5202                                  	; 14/01/2023
  5203 000013D8 BA[4107]                	mov	dx,NEWLINE
  5204                                  
  5205                                  ;RPrint	proc
  5206                                  ;
  5207                                  ;	assume	ds:DATARES,ss:DATARES
  5208                                  ;
  5209                                  	; 14/01/2023
  5210                                  RPrint:
  5211                                  
  5212                                  ;	Bugbug:	do we need to save all reg's?
  5213                                  
  5214 000013DB 56                      	push	si			; preserve registers
  5215 000013DC 50                      	push	ax
  5216 000013DD 53                      	push	bx
  5217 000013DE 51                      	push	cx
  5218 000013DF 52                      	push	dx
  5219                                  
  5220 000013E0 89F3                    	mov	bx,si			; DS:BX = ptr to subst block
  5221 000013E2 89D6                    	mov	si,dx			; DS:SI = ptr to count byte
  5222 000013E4 AC                      	lodsb				; AL = message length
  5223                                  					; DS:SI = ptr to message text
  5224 000013E5 31C9                    	xor	cx,cx
  5225 000013E7 88C1                    	mov	cl,al			; CX = message length
  5226 000013E9 E303                    	jcxz	rpRet
  5227                                  
  5228 000013EB E81900                  	call	RDispMsg
  5229                                  
  5230 000013EE 5A                      rpRet:	pop	dx
  5231 000013EF 59                      	pop	cx
  5232 000013F0 5B                      	pop	bx
  5233 000013F1 58                      	pop	ax
  5234 000013F2 5E                      	pop	si
  5235 000013F3 C3                      	retn
  5236                                  
  5237                                  ;RPrint	endp
  5238                                  
  5239                                  	; 14/01/2023
  5240                                  ;	; MSDOS 3.3
  5241                                  ;CRLF:
  5242                                  ;	mov     dx,NEWLIN
  5243                                  ;
  5244                                  ;RDISPMSG: ; Display message/text
  5245                                  ;	; DS:DX = ($ terminated) Message/Text address 
  5246                                  ;	push    ax
  5247                                  ;	mov     ah,STD_CON_STRING_OUTPUT ; 9
  5248                                  ;	clc
  5249                                  ;	int     21h             ; DOS - PRINT STRING
  5250                                  ;				; DS:DX -> string terminated by "$"
  5251                                  ;	pop     ax
  5252                                  ;	retn
  5253                                  
  5254                                  
  5255                                  	; MSDOS 6.0
  5256                                  ; ----------------------------------------------------------------------------
  5257                                  ;***	RPrintCrit - print critical error message
  5258                                  ;
  5259                                  ;	ENTRY	DX = extended error # (19-39)
  5260                                  ;
  5261                                  ;	EXIT	nothing
  5262                                  ;
  5263                                  ;	USED	flags
  5264                                  ;
  5265                                  ;	EFFECTS
  5266                                  ;	  Message is displayed on stdout
  5267                                  ; ----------------------------------------------------------------------------
  5268                                  
  5269                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5270                                  
  5271                                  ;RPrintCrit	proc
  5272                                  ;	assume	ds:DATARES,ss:DATARES
  5273                                  
  5274                                  	; 14/01/2023
  5275                                  RPrintCrit:
  5276 000013F4 52                      	push	dx			; preserve DX
  5277 000013F5 87D3                    	xchg	bx,dx			; BX = extended error #
  5278                                  					; DX = saved BX
  5279 000013F7 83EB13                  	sub	bx,19			; BX = critical error index, from 0
  5280 000013FA D1E3                    	shl	bx,1			; BX = offset in word table
  5281 000013FC 8B9F[DB08]              	mov	bx,[bx+CRITMSGPTRS]	; BX = ptr to error msg
  5282 00001400 87D3                    	xchg	bx,dx			; DX = ptr to error msg
  5283                                  					; BX = restored
  5284 00001402 E8D6FF                  	call	RPrint			; print the message
  5285 00001405 5A                      	pop	dx			; restore DX
  5286 00001406 C3                      	retn
  5287                                  
  5288                                  ;RPrintCrit	endp
  5289                                  
  5290                                  ; ----------------------------------------------------------------------------
  5291                                  ;***	RDispMsg - display message
  5292                                  ;
  5293                                  ;	Display message, with substitutions, for RPrint.
  5294                                  ;
  5295                                  ;	ENTRY	DS:SI = ptr to message text
  5296                                  ;		CX = message length
  5297                                  ;		DS:BX = ptr to substitution block, if any
  5298                                  ;
  5299                                  ;	EXIT	nothing
  5300                                  ;
  5301                                  ;	USED	AX,CX,DX,SI
  5302                                  ; ----------------------------------------------------------------------------
  5303                                  
  5304                                  ;RDispMsg	proc
  5305                                  ;	assume	ds:DATARES,ss:DATARES
  5306                                  
  5307                                  RDispMsg:
  5308                                  	; 14/01/2023
  5309                                  rdNextChar:
  5310 00001407 AC                      	lodsb				; AL = next char
  5311 00001408 3C25                    	cmp	al,'%'
  5312 0000140A 7511                    	jne	short rdOutChar		; not a substitution
  5313 0000140C 8A14                    	mov	dl,[si]			; DL = possible '1' - '9'
  5314 0000140E 80EA31                  	sub	dl,'1'			; DL = 0 - 8 = '1' - '9'
  5315 00001411 80FA09                  	cmp	dl,9
  5316 00001414 7307                    	jae	short rdOutChar		; not a substitution
  5317                                  
  5318                                  ;*	A substitution code %1 - %9 has been encountered.
  5319                                  ;	DL = 0-8, indicating %1-%9
  5320                                  ;	DS:BX = ptr to substitution block
  5321                                  
  5322 00001416 E80D00                  	call	SubstMsg		; display the substitution
  5323 00001419 46                      	inc	si			; SI = ptr past %n
  5324 0000141A 49                      	dec	cx			; count extra character in %n
  5325 0000141B EB06                    	jmp	short rdCharDone
  5326                                  
  5327                                  ;*	Normal character output.
  5328                                  
  5329                                  rdOutChar:
  5330 0000141D 88C2                    	mov	dl,al			; DL = char
  5331 0000141F B402                    	mov	ah,2			; AH = DOS Character Output code
  5332 00001421 CD21                    	int	21h			; call DOS
  5333                                  rdCharDone:
  5334 00001423 E2E2                    	loop	rdNextChar
  5335 00001425 C3                      	retn
  5336                                  
  5337                                  ;RDispMsg	endp
  5338                                  
  5339                                  ; ----------------------------------------------------------------------------
  5340                                  ;***	SubstMsg - display message substitution
  5341                                  ;
  5342                                  ;	Display a substitution string within a message.
  5343                                  ;	Substitution can be a char, an ASCIIZ string, or
  5344                                  ;	a word to be displayed as hex digits.
  5345                                  ;
  5346                                  ;	ENTRY	DL = substitution index 0-8 (for codes %1-%9)
  5347                                  ;		DS:BX = ptr to substitution block
  5348                                  ;
  5349                                  ;	EXIT	nothing
  5350                                  ;
  5351                                  ;	USED	AX,DX
  5352                                  ; ----------------------------------------------------------------------------
  5353                                  
  5354                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5355                                  
  5356                                  ;SubstMsg	proc
  5357                                  ;	assume	ds:DATARES,ss:DATARES
  5358                                  	
  5359                                  	; 14/01/2023
  5360                                  SubstMsg:
  5361 00001426 53                      	push	bx			; preserve BX
  5362 00001427 51                      	push	cx			; preserve CX
  5363                                  
  5364                                  	;mov	al,size SUBST		; AL = size of substitution block
  5365 00001428 B003                    	mov	al,3
  5366 0000142A F6E2                    	mul	dl			; AX = offset of desired subst block
  5367 0000142C 01C3                    	add	bx,ax			; DS:BX = ptr to desired subst block
  5368                                  
  5369                                  	;mov	al,[bx].SubstType	; AX = substitution type flag
  5370 0000142E 8A07                    	mov	al,[bx]
  5371                                  	;mov	bx,[bx].SubstPtr	; BX = ptr to char, str, or hex value
  5372 00001430 8B5F01                  	mov	bx,[bx+1]
  5373                                  
  5374                                  ;	AL = 1, 2, or 3 for char, string, or hex type
  5375                                  
  5376 00001433 FEC8                    	dec	al
  5377 00001435 7428                    	jz	short smChar
  5378 00001437 FEC8                    	dec	al
  5379 00001439 742C                    	jz	short smStr
  5380                                  
  5381                                  ;*	Hex number substitution.
  5382                                  
  5383                                  	;mov	ax,ds:[bx]		; AX = word value
  5384 0000143B 8B07                    	mov	ax,[bx]
  5385 0000143D B90400                  	mov	cx,4			; CX = # digits to display
  5386                                  smDigit:
  5387 00001440 D1C0                    	rol	ax,1
  5388 00001442 D1C0                    	rol	ax,1
  5389 00001444 D1C0                    	rol	ax,1
  5390 00001446 D1C0                    	rol	ax,1			; AL<3:0> = next digit
  5391                                  
  5392 00001448 50                      	push	ax			; save other digits
  5393 00001449 240F                    	and	al,0Fh			; AL = binary digit
  5394 0000144B 0430                    	add	al,'0'			; AL = ascii digit if 0-9
  5395 0000144D 3C39                    	cmp	al,'9'
  5396 0000144F 7602                    	jbe	short smDigit09		; it's 0-9
  5397                                  	;add	al,7
  5398 00001451 0407                    	add	al,('A' - '0') - 10	; AL = ascii digit A-F
  5399                                  smDigit09:
  5400 00001453 88C2                    	mov	dl,al			; DL = ascii digit
  5401 00001455 B402                    	mov	ah,2
  5402 00001457 CD21                    	int	21h			; output the ascii digit
  5403 00001459 58                      	pop	ax			; restore all digits
  5404                                  
  5405 0000145A E2E4                    	loop	smDigit
  5406                                  	;jmp	short smRet
  5407                                  	; 14/01/2023
  5408                                  smRet:	
  5409 0000145C 59                      	pop	cx
  5410 0000145D 5B                      	pop	bx
  5411 0000145E C3                      	retn
  5412                                  
  5413                                  ;*	Char substitution.
  5414                                  
  5415                                  smChar:
  5416                                  	;mov	dl,ds:[bx]		; DL = char to output
  5417 0000145F 8A17                    	mov	dl,[bx]
  5418 00001461 B402                    	mov	ah,2
  5419 00001463 CD21                    	int	21h
  5420 00001465 EBF5                    	jmp	short smRet
  5421                                  
  5422                                  ;*	String substitution.
  5423                                  
  5424                                  smStr:
  5425                                  	;mov	dl,ds:[bx]		; DL = next char
  5426 00001467 8A17                    	mov	dl,[bx]
  5427 00001469 08D2                    	or	dl,dl
  5428 0000146B 74EF                    	jz	short smRet		; null char - we're done
  5429 0000146D B402                    	mov	ah,2
  5430 0000146F CD21                    	int	21h			; display char
  5431 00001471 43                      	inc	bx			; DS:BX = ptr to next char
  5432 00001472 EBF3                    	jmp	short smStr
  5433                                  
  5434                                  ;smRet:	pop	cx
  5435                                  ;	pop	bx
  5436                                  ;	retn
  5437                                  
  5438                                  ;SubstMsg	endp
  5439                                  
  5440                                  	; MSDOS 6.0
  5441                                  ; ----------------------------------------------------------------------------
  5442                                  ;***	CharToUpper - convert character to uppercase
  5443                                  ;
  5444                                  ;	ENTRY	AL = char
  5445                                  ;
  5446                                  ;	EXIT	AL = uppercase char
  5447                                  ;
  5448                                  ;	USED	AX
  5449                                  ; ----------------------------------------------------------------------------
  5450                                  
  5451                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5452                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  5453                                  
  5454                                  ;CharToUpper	proc
  5455                                  ;	assume	ds:DATARES
  5456                                  CharToUpper:
  5457 00001474 50                      	push	ax		; put char on stack as arg to int 2F
  5458 00001475 B81312                  	mov	ax,1213h	; AX = DOS int 2F 'Convert Char to Uppercase'
  5459 00001478 CD2F                    	int	2Fh
  5460 0000147A 44                      	inc	sp		; throw away old char on stack
  5461 0000147B 44                      	inc	sp
  5462 0000147C C3                      	retn
  5463                                  
  5464                                  ;CharToUpper	endp
  5465                                  
  5466                                  	; 14/01/2023
  5467                                  ;	; MSDOS 3.3
  5468                                  ;CHARTOUPPER:
  5469                                  ;	cmp	al,80h
  5470                                  ;	jb	short CHARTOUPPER1
  5471                                  ;	sub	al,80h
  5472                                  ;	push	ds
  5473                                  ;	push	bx
  5474                                  ;	lds	bx,[UPPERCASETBL]
  5475                                  ;	add	bx,2
  5476                                  ;	xlat
  5477                                  ;	pop	bx
  5478                                  ;	pop	ds
  5479                                  ;	jmp	short CHARTOUPPER_RETN
  5480                                  ;CHARTOUPPER1:
  5481                                  ;	cmp	al,'a'
  5482                                  ;	jb	short CHARTOUPPER_RETN
  5483                                  ;	cmp	al,'z'
  5484                                  ;	ja	short CHARTOUPPER_RETN
  5485                                  ;	sub	al,20h
  5486                                  ;CHARTOUPPER_RETN:
  5487                                  ;	retn
  5488                                  
  5489                                  ; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
  5490                                  ; ----------------------------------------------------------------------------
  5491                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:159Dh
  5492                                  
  5493                                  ;ifdef	DBCS
  5494                                  %if 1
  5495                                  
  5496                                  ;***	ITestKanj - DBCS lead byte check
  5497                                  
  5498                                  ITestKanj:
  5499                                  TestKanjR:				; 3/3/KK
  5500 0000147D 1E                      	push	ds
  5501 0000147E 56                      	push	si
  5502 0000147F 50                      	push	ax
  5503 00001480 C536[BA02]              	lds	si,[Dbcs_Vector_Addr]
  5504                                  ktLop:
  5505 00001484 833C00                  	cmp	word [si],0		; end of Lead Byte Table
  5506 00001487 740C                    	je	short NotLead
  5507                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
  5508                                  	;pop	ax
  5509                                  	;push	ax
  5510 00001489 3A04                    	cmp	al,[si]
  5511 0000148B 7208                    	jb	short NotLead
  5512 0000148D 46                      	inc	si
  5513 0000148E 3A04                    	cmp	al,[si]
  5514 00001490 7607                    	jbe	short IsLead
  5515 00001492 46                      	inc	si
  5516 00001493 EBEF                    	jmp	short ktLop		; try another range
  5517                                  NotLead:
  5518 00001495 31C0                    	xor	ax,ax			; set zero
  5519 00001497 EB03                    	jmp	short ktRet
  5520                                  IsLead:
  5521 00001499 31C0                    	xor	ax,ax			; reset zero
  5522 0000149B 40                      	inc	ax
  5523                                  ktRet:
  5524 0000149C 58                      	pop	ax
  5525 0000149D 5E                      	pop	si
  5526 0000149E 1F                      	pop	ds
  5527 0000149F C3                      	retn
  5528                                  
  5529                                  %endif
  5530                                  ;endif
  5531                                  
  5532                                  ; ----------------------------------------------------------------------------
  5533                                  
  5534                                  ;public	EndCode
  5535                                  ;EndCode label byte
  5536                                  
  5537                                  	; MSDOS 6.0
  5538                                  ; ----------------------------------------------------------------------------
  5539                                  ;***	MsgInt2fHandler - int 2f handler for message retrieval
  5540                                  ;
  5541                                  ;	ENTRY	If we handle it -
  5542                                  ;		  AX = ((MULTDOS shl 8) or MESSAGE_2F) = 122Eh
  5543                                  ;		  DL = operation =
  5544                                  ;		     0 = get extended error messages
  5545                                  ;		     1 = set extended error messages
  5546                                  ;		     2 = get parse error messages
  5547                                  ;		     3 = set parse error messages
  5548                                  ;		     4 = get critical error messages
  5549                                  ;		     5 = set critical error messages
  5550                                  ;		     6 = get file system error messages
  5551                                  ;		     7 = set file system error messages
  5552                                  ;		     8 = get disk retriever routine
  5553                                  ;		     9 = set disk retriever routine
  5554                                  ;		  ES:DI = address for 'set' operations
  5555                                  ;
  5556                                  ;	EXIT	ES:DI = ptr to list of message ptrs, for 'get' operations
  5557                                  ;
  5558                                  ;	NOTE
  5559                                  ;	  This handler replaces the one that used to reside in DOS.
  5560                                  ;	  'Set' operations are ignored.
  5561                                  ;	  'File system error messages' are not supported.
  5562                                  ; ----------------------------------------------------------------------------
  5563                                  
  5564                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5565                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1478h (CODERES:0738h)
  5566                                  
  5567                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  5568                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1588h (CODERES:0738h)
  5569                                  
  5570                                  ;SR;
  5571                                  ;At the int 2fh entry point we push the old ds value and the resident data
  5572                                  ;segment address. Get them off the stack
  5573                                  
  5574                                  ;MsgInt2fHandler proc	far
  5575                                  ;	assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  5576                                  
  5577                                  	; 14/01/2023
  5578                                  MsgInt2fHandler:
  5579 000014A0 1F                      	pop	ds			; ds = DATARES
  5580                                  	;assume	ds:DATARES
  5581                                  ;	pop	word [OldDS]		; save old value of ds
  5582                                  
  5583 000014A1 3D2E12                  	cmp	ax,122Eh
  5584                                  	;cmp	ax,(MULTDOS<<8)|MESSAGE_2F
  5585                                  	;;cmp	ax,(MULTDOS shl 8) or MESSAGE_2F
  5586 000014A4 742A                    	je	short miOurs		; it's ours
  5587                                  
  5588                                  ;ifndef ROMDOS
  5589                                  	;cmp	ax,5500h
  5590 000014A6 3D0055                  	cmp	ax,GET_COMMAND_STATE	; is it first COMMAND query?
  5591                                  ;else
  5592                                  ;	cmp	ax,GET_ROMCOMMAND_STATE	; is it first ROM COMMAND query?
  5593                                  ;endif	;ROMDOS
  5594 000014A9 741C                    	je	short fcOurs
  5595                                  
  5596                                  ;SR;
  5597                                  ;We cannot do a far jump any more because cs cannot be used. Push the cs:ip
  5598                                  ;onto the stack and do a far return to jump to the next 2fh handler. 
  5599                                  ;Our old ds is on the stack. We need to restore it but we cannot lose the
  5600                                  ;current value of ds as it points at the data segment. So we do some kinky
  5601                                  ;stack manipulations.
  5602                                  
  5603 000014AB 50                      	push	ax
  5604 000014AC 50                      	push	ax			; create 2 words on stack for retf
  5605                                  
  5606 000014AD 55                      	push	bp
  5607 000014AE 50                      	push	ax
  5608                                  
  5609 000014AF 89E5                    	mov	bp,sp			; bp can be used to address stack
  5610                                  
  5611                                  ;Swap the old ds value with the second dummy word on the stack. Now, we can
  5612                                  ;do a 'pop ds' at the end to restore our ds
  5613                                  
  5614 000014B1 8B4608                  	mov	ax,[bp+8]		; ax = old ds value
  5615 000014B4 894604                  	mov	[bp+4],ax
  5616                                  	
  5617                                  	;mov	ax,word ptr ds:Int2fHandler+2
  5618 000014B7 A1[B004]                	mov	ax,[Int2fHandler+2]
  5619 000014BA 894608                  	mov	[bp+8],ax		; put segment address
  5620                                  	;mov	ax,word ptr ds:Int2fHandler
  5621 000014BD A1[AE04]                	mov	ax,[Int2fHandler]
  5622 000014C0 894606                  	mov	[bp+6],ax		; put offset address
  5623                                  
  5624 000014C3 58                      	pop	ax
  5625 000014C4 5D                      	pop	bp
  5626 000014C5 1F                      	pop	ds
  5627                                  
  5628 000014C6 CB                      	retf				; chain on to next handler
  5629                                  
  5630                                  ;;	jmp	Int2fHandler		; hand off to next 2f handler
  5631                                  
  5632                                  fcOurs:
  5633                                  
  5634                                  ;We have to clear ax, and return in ds:si a pointer to the stub jump table
  5635                                  
  5636 000014C7 58                      	pop	ax			; discard ds currently on stack
  5637 000014C8 1E                      	push	ds			; store our data segment
  5638                                  
  5639                                  	;mov	si,offset DATARES:Int2f_Entry ; start of table
  5640 000014C9 BE[6600]                	mov	si,Int2f_Entry
  5641                                  
  5642 000014CC 31C0                    	xor	ax,ax			; indicate COMMAND present
  5643 000014CE EB11                    	jmp	short miRet		; return to caller
  5644                                  
  5645                                  miOurs:
  5646 000014D0 F6C201                  	test	dl,1
  5647 000014D3 750C                    	jnz	short miRet		; ignore 'set' operations
  5648                                  
  5649 000014D5 53                      	push	bx			; preserve BX
  5650 000014D6 89D3                    	mov	bx,dx
  5651 000014D8 30FF                    	xor	bh,bh			; BX = index in word table
  5652 000014DA D1E3                    	shl	bx,1			; BX = index in dword table
  5653                                  	;les	di,MsgPtrLists[bx]	; ES:DI = ptr to msg ptr list
  5654 000014DC C4BF[4407]              	les	di,[bx+MsgPtrLists]
  5655 000014E0 5B                      	pop	bx			; restore BX
  5656                                  miRet:
  5657                                  ;	mov	ds,[OldDS]		; restore ds
  5658 000014E1 1F                      	pop	ds
  5659                                  	;assume	ds:nothing
  5660                                  
  5661 000014E2 CF                      	iret
  5662                                  
  5663                                  ;MsgInt2fHandler endp
  5664                                  
  5665                                  	; MSDOS 6.0
  5666                                  ; ----------------------------------------------------------------------------
  5667                                  ;***	MsgRetriever - message retrieval routine for utilities
  5668                                  ;
  5669                                  ;	Address of this routine is passed to utility programs via 
  5670                                  ;	message services int 2f. We try to find the desired message
  5671                                  ;	in memory or in our disk image.
  5672                                  ;
  5673                                  ;	ENTRY	AX = message #
  5674                                  ;		DI = offset in RESGROUP of msg ptr list
  5675                                  ;		ComSpec = asciiz pathname to our disk image
  5676                                  ;
  5677                                  ;	EXIT	CY clear for success
  5678                                  ;		ES:DI = ptr to count byte, followed by message text
  5679                                  ;
  5680                                  ;		CY set for failure
  5681                                  ;		ES,DI undefined
  5682                                  ;
  5683                                  ;	USED	flags
  5684                                  ;
  5685                                  ;	NOTE
  5686                                  ;	  The message # in AX is used to compute an offset into
  5687                                  ;	  the message ptr list pointed to by DI. The lists must
  5688                                  ;	  start with message # 1 and proceed through consecutive
  5689                                  ;	  message #'s.  
  5690                                  ;
  5691                                  ;	  It is assumed that the msg ptr list is either ParsMsgPtrs or
  5692                                  ;	  ExtMsgPtrs. We use NUMPARSEMSGS and NUMEXTMSGS to check for
  5693                                  ;	  valid message #.  ;M033
  5694                                  ;
  5695                                  ;	  List positions with no corresponding message text are
  5696                                  ;	  indicated by null pointers, which this routine detects.
  5697                                  ; ----------------------------------------------------------------------------
  5698                                  
  5699                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5700                                  
  5701                                  ;SR; This routine will be called directly by the utilities. So, we have
  5702                                  ; trap for it in the stub. The stub pushes the old value of ds and the 
  5703                                  ; DATARES value on the stack. We get them off the stack to setup ds here
  5704                                  
  5705                                  ;MsgRetriever	proc	far
  5706                                  ;	assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  5707                                  
  5708                                  	; 14/01/2023
  5709                                  MsgRetriever:
  5710 000014E3 1F                      	pop	ds			; ds = DATARES
  5711                                  	;assume	ds:DATARES
  5712                                  ;	pop	word [OldDS]		; save old ds
  5713                                  
  5714 000014E4 50                      	push	ax			; preserve registers
  5715 000014E5 53                      	push	bx
  5716 000014E6 51                      	push	cx
  5717 000014E7 52                      	push	dx
  5718 000014E8 56                      	push	si
  5719                                  
  5720                                  ;;	push	ds
  5721                                  ;;	push	cs
  5722                                  ;;	pop	ds			; DS = DATARES seg addr
  5723                                  ;;	assume	ds:RESGROUP
  5724                                  ;;	push	cs
  5725                                  
  5726 000014E9 1E                      	push	ds			; get es from ds
  5727 000014EA 07                      	pop	es			; ES = DATARES seg addr
  5728                                  
  5729                                  ;	Begin modification M033.
  5730                                  
  5731                                  ;	Make sure msg # is valid.
  5732                                  ;	Assume msg ptr list is either ParsMsgPtrs or ExtMsgPtrs.
  5733                                  
  5734                                  	;mov	bx,11
  5735 000014EB BB0B00                  	mov	bx,NUMPARSMSGS		; BX = # parse error msgs in list
  5736                                  	;cmp	di,offset DATARES:ParsMsgPtrs
  5737 000014EE 81FF[E309]              	cmp	di,PARSMSGPTRS
  5738 000014F2 7403                    	je	short chkmsgnum		; it's ParsMsgPtrs
  5739                                  	;mov	bx,90
  5740 000014F4 BB5A00                  	mov	bx,NUMEXTMSGS		; BX = # extended error msgs in list
  5741                                  chkmsgnum:
  5742 000014F7 39C3                    	cmp	bx,ax
  5743 000014F9 725A                    	jc	short mrRet		; msg # too high, return carry
  5744                                  
  5745                                  ;	Msg # is valid.
  5746                                  
  5747                                  ;	End modification M033.
  5748                                  
  5749 000014FB 48                      	dec	ax
  5750 000014FC D1E0                    	shl	ax,1			; AX = offset into msg ptr list
  5751 000014FE 01C7                    	add	di,ax			; DI = ptr to msg ptr
  5752                                  
  5753 00001500 81FF[B204]              	cmp	di,ResMsgEnd
  5754 00001504 7247                    	jb	short mrInMem		; ptr (and message) in memory
  5755                                  
  5756                                  ;*	Retrieve message from disk (or ROM) image.
  5757                                  ;	Read once to get the ptr to the message, then again for the message.
  5758                                  
  5759                                  ;ifndef	ROMDOS
  5760                                  	; 14/01/2023
  5761                                  	;mov	si,offset DATARES:ComSpec	; DS:SI = ptr to pathname
  5762 00001506 BE[4B02]                	mov	si,ComSpec
  5763 00001509 BA0100                  	mov	dx,1 ; EXT_EXISTS_OPEN		; DX = 'open existing file'
  5764 0000150C BB0020                  	mov	bx,2000h ; INT_24_ERROR		; BX = 'fail on crit error'
  5765 0000150F B8006C                  	mov	ax,6C00h
  5766                                  	;mov	ax,ExtOpen shl 8		; AX = 'Extended Open File'
  5767 00001512 CD21                    	int	21h				; call DOS
  5768 00001514 723F                    	jc	short mrRet			; return failure
  5769                                  
  5770 00001516 89C3                    	mov	bx,ax				; BX = file handle
  5771 00001518 89FA                    	mov	dx,di				; DX = ptr to msg ptr
  5772 0000151A 31F6                    	xor	si,si				; SI = read count
  5773                                  mrRead:
  5774 0000151C 81EA0001                	sub	dx,100h				; DX = LSW of file offset
  5775 00001520 31C9                    	xor	cx,cx				; CX = MSW of file offset
  5776 00001522 B80042                  	mov	ax,4200h
  5777                                  	;mov	ax,LSEEK shl 8			; AX = 'Set File Pointer'
  5778 00001525 CD21                    	int	21h				; call DOS
  5779 00001527 721A                    	jc	short mrCloseFile		; handle error
  5780                                  
  5781                                  	;mov	dx,offset DATARES:MsgBuffer	; DS:DX = input buffer
  5782 00001529 BA[5E04]                	mov	dx,MsgBuffer
  5783 0000152C B94000                  	mov	cx,64				; CX = # bytes to read
  5784 0000152F B43F                    	mov	ah,3Fh
  5785                                  	;mov	ah,READ				; AH = 'Read File'
  5786 00001531 CD21                    	int	21h				; call DOS
  5787 00001533 720E                    	jc	short mrCloseFile		; handle error
  5788                                  
  5789 00001535 09F6                    	or	si,si				; (CY cleared)
  5790 00001537 750A                    	jnz	short mrCloseFile		; 2nd time thru - we're done
  5791 00001539 46                      	inc	si				; mark one read done
  5792 0000153A 8B16[5E04]              	mov	dx,[MsgBuffer]			; DX = ptr to message
  5793 0000153E 09D2                    	or	dx,dx
  5794 00001540 75DA                    	jnz	short mrRead			; go read the message
  5795 00001542 F9                      	stc					; null ptr found- no msg
  5796                                  
  5797                                  mrCloseFile:
  5798 00001543 9C                      	pushf				; save success/failure (CY)
  5799 00001544 B43E                    	mov	ah,3Eh
  5800                                  	;mov	ah,CLOSE		; AH = 'Close File'
  5801 00001546 CD21                    	int	21h			; call DOS
  5802                                  ;	Bugbug: should we avoid this popf?
  5803 00001548 9D                      	popf				; CY = success/failure
  5804 00001549 89D7                    	mov	di,dx			; ES:DI = ptr to msg, if successful
  5805 0000154B EB08                    	jmp	short mrRet		; we're done
  5806                                  
  5807                                  ;else	;ROMDOS
  5808                                  ;
  5809                                  ;;	DI = ptr to msg ptr
  5810                                  ;
  5811                                  ;	mov	si,di			; SI = ptr to msg ptr
  5812                                  ;	sub	si,100h			; SI = offset into image of msg ptr
  5813                                  ;	mov	cx,2			; CX = # bytes to copy from image
  5814                                  ;
  5815                                  ;;	ASSUME ES:NOTHING is still in effect.
  5816                                  ;
  5817                                  ;	push	ds
  5818                                  ;	pop	es				; ES = DATARES seg addr
  5819                                  ;	mov	di,offset DATARES:MsgBuffer	; ES:DI = ptr to buffer
  5820                                  ;	invoke	LoadFromROM			; copy msg ptr from ROM
  5821                                  ;	mov	si,word ptr MsgBuffer		; SI = ptr to message
  5822                                  ;	or	si,si
  5823                                  ;	jz	mrNoMsg			; null ptr- no message text
  5824                                  ;
  5825                                  ;	sub	si,100h			; SI = offset into image of msg
  5826                                  ;	mov	cx,64			; CX = # bytes to copy from image
  5827                                  ;	mov	di,offset DATARES:MsgBuffer
  5828                                  ;	invoke	LoadFromROM
  5829                                  ;	clc					; success
  5830                                  ;	mov	di,offset DATARES:MsgBuffer	; ES:DI = ptr to msg
  5831                                  ;	jmp	short mrRet
  5832                                  ;
  5833                                  ;mrNoMsg:
  5834                                  ;	stc
  5835                                  ;	jmp	short mrRet
  5836                                  ;
  5837                                  ;;;	mov	ax,COMMAND_SEG-10h	; AX = seg addr of COMMAND image
  5838                                  ;;;	mov	es,ax			; ES:DI = ptr to msg ptr in image
  5839                                  ;	assume	es:NOTHING
  5840                                  ;
  5841                                  ;endif	;ROMDOS
  5842                                  
  5843                                  ;*	Message ptr is in memory.
  5844                                  ;	If ptr is in memory, assume message is in memory (/msg).
  5845                                  
  5846                                  mrInMem:
  5847                                  	; 14/01/2023
  5848 0000154D 268B3D                  	mov	di,[es:di]		; ES:DI = ptr to msg
  5849 00001550 09FF                    	or	di,di			; (CY cleared)
  5850 00001552 7501                    	jnz	short mrRet		; found message
  5851 00001554 F9                      	stc				; null ptr found - no message
  5852                                  mrRet:	
  5853 00001555 5E                      	pop	si			; restore all registers
  5854 00001556 5A                      	pop	dx
  5855 00001557 59                      	pop	cx
  5856 00001558 5B                      	pop	bx
  5857 00001559 58                      	pop	ax
  5858                                  
  5859                                  ;	mov	ds,[OldDS]		; restore ds
  5860 0000155A 1F                      	pop	ds
  5861                                  	;assume	ds:nothing
  5862                                  
  5863 0000155B CB                      	retf	; 21/04/2023
  5864                                  
  5865                                  ;MsgRetriever endp
  5866                                  
  5867                                  ; M003; Start of changes for UMB support
  5868                                  
  5869                                  ; ----------------------------------------------------------------------------
  5870                                  ;***	Lh_OffUnlink -- Restore allocation strat and link state
  5871                                  ;
  5872                                  ;	ENTRY	al = Saved alloc strat and link state
  5873                                  ;			b0 = 1 if alloc strat to restore is HighFirst
  5874                                  ;			b1 = 1 if link state to restore is Linked
  5875                                  ;
  5876                                  ;	EXIT	None
  5877                                  ;
  5878                                  ;	USED	ax, bx, cx
  5879                                  ; ----------------------------------------------------------------------------
  5880                                  
  5881                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5882                                  
  5883                                  ;public	Lh_OffUnlink
  5884                                  Lh_OffUnlink:	; proc	far
  5885                                  	; 14/01/2023
  5886 0000155C 88C5                    	mov	ch,al
  5887 0000155E 88C1                    	mov	cl,al
  5888                                  	;;mov	ax,(ALLOCOPER shl 8) OR 0
  5889                                  	;mov	ax,(ALLOCOPER<<8)
  5890 00001560 B80058                  	mov	ax,5800h
  5891 00001563 CD21                    	int	21h
  5892 00001565 89C3                    	mov	bx,ax
  5893 00001567 D0C9                    	ror	cl,1				; b7 = HighFirst bit
  5894 00001569 80E180                  	and	cl,80h				; mask off b6-b0
  5895 0000156C 80E37F                  	and	bl,7fh				; mask off HighFirst bit
  5896 0000156F 08CB                    	or	bl,cl				; set HighFirst bit state
  5897                                  	;;mov	ax,(ALLOCOPER shl 8) OR 1
  5898                                  	;mov	ax,(ALLOCOPER<<8)|1
  5899 00001571 B80158                  	mov	ax,5801h
  5900 00001574 CD21                    	int	21h				; set alloc strat
  5901                                  
  5902 00001576 88EB                    	mov	bl,ch
  5903 00001578 D0EB                    	shr	bl,1
  5904 0000157A 30FF                    	xor	bh,bh				; bx = linkstate
  5905                                  	;mov	ax,(ALLOCOPER shl 8) OR 3
  5906                                  	;mov	ax,(ALLOCOPER<<8)|3
  5907 0000157C B80358                  	mov	ax,5803h
  5908 0000157F CD21                    	int	21h				; set linkstate
  5909                                  
  5910 00001581 CB                      	retf
  5911                                  
  5912                                  ;Lh_OffUnlink endp
  5913                                  
  5914                                  ; M003; End of changes for UMB support
  5915                                  ;public	EndCode
  5916                                  ; 14/01/2023
  5917                                  ;EndCode: ; label byte
  5918                                  ; 06/06/2023
  5919                                  ; 16/04/2023
  5920                                  ; 14/08/2024
  5921                                  ;EndCode equ ($-StartCode)+100h
  5922                                  
  5923                                  ; 06/06/2023
  5924                                  ;EndCode equ $-StartCode
  5925                                  
  5926                                  ; 14/08/2024
  5927                                  EndCode:
  5928                                  ENDCODE equ ($-StartCode)+100h
  5929                                  
  5930                                  ;CODERES ends
  5931                                  ;	end
  5932                                  
  5933                                  ; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5934                                  
  5935                                  	;times	(((EndCode+15)>>4)<<4)-EndCode db 0
  5936                                  	; 14/08/2024
  5937 00001582 00<rep Eh>              	times	(((ENDCODE+15)>>4)<<4)-ENDCODE db 0
  5938                                  
  5939                                  ;align 16
  5940                                  
  5941                                  ;=============================================================================
  5942                                  ; INIT.ASM, MSDOS 6.0 (COMMAND.COM), 1991
  5943                                  ;=============================================================================
  5944                                  ; 22/09/2018 - Retro DOS v3.0 ('command3.s')
  5945                                  
  5946                                  ; INIT.ASM (MSDOS 2.11 COMMAND.COM, Retro DOS v2.0, 30/04/2018)
  5947                                  
  5948                                  ;TITLE   COMMAND Initialization
  5949                                  
  5950                                  ;ENVIRONSIZ EQU  0A0H		; Must agree with values in ENVIRONMENT segment
  5951                                  ;ENVIRONSIZ2 EQU 092H
  5952                                  ;MAX_COMSPEC EQU ENVIRONSIZ2 ; = 146  ; 22/09/2018
  5953                                  
  5954                                  ; UINIT.ASM, MSDOS 6.0, 1991
  5955                                  ; 23/09/2018
  5956                                  ENVBIG	EQU 32768		;AN000; maximum environment size
  5957                                  ; 14/01/2023
  5958                                  ;ENVSML	EQU 160			;AN000; minimum environment size
  5959                                  
  5960                                  ; ----------------------------------------------------------------------------
  5961                                  
  5962                                  ; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5963                                  
  5964                                  ; 06/06/2023
  5965                                  ; (MSDOS 5.0 COMMAND.COM -initial- Environment Structure size)
  5966                                  ;ENVIRONSIZ equ 160
  5967                                  
  5968                                  ENVSML	equ 256	; minimum environment size
  5969                                  ;MAX_COMSPEC equ ENVIRONSIZ - Env_ComSpec
  5970                                  MAX_COMSPEC equ 146
  5971                                  ECOMSPEC equ 14
  5972                                  
  5973                                  ; 14/01/2023
  5974                                  TAB_CHAR equ 09h
  5975                                  SPACE_CHAR equ 20h	
  5976                                  
  5977                                  ; 06/06/2023
  5978                                  ; (MSDOS 6.22 COMMAND.COM -initial- Environment Structure size)
  5979                                  ;ENVIRONSIZ equ 180	; SIZE Environment
  5980                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  5981                                  ; (PCDOS 7.1 COMMAND.COM -initial- Environment Structure size)
  5982                                  ENVIRONSIZ equ 166	; SIZE Environment 
  5983                                  
  5984                                  ;----------------------------------------------------
  5985                                  ; MSDOS 6.0 - ENVDATA.ASM - 1991
  5986                                  ;----------------------------------------------------
  5987                                  ;Environment Struc	; Default COMMAND environment
  5988                                  ;
  5989                                  ;Env_PathString  db	"path="
  5990                                  ;Env_PathSpec	 db	"c:\msdos"
  5991                                  ;                db	0
  5992                                  ;Env_PrmptString db	"prompt="
  5993                                  ;Env_PrmptSpec   db	"$p$g"
  5994                                  ;                db	0
  5995                                  ;Env_ComString   db	"comspec="
  5996                                  ;Env_ComSpec     db	"\command.com"
  5997                                  ;		 db	134 dup (0)
  5998                                  ;
  5999                                  ;Environment ends
  6000                                  ;----------------------------------------------------
  6001                                  
  6002                                  ;-----------------------------------------------------------------------------
  6003                                  
  6004                                  ;-----------------------------------------------------------------------------
  6005                                  ; START OF INIT PORTION
  6006                                  ; This code is deallocated after initialization.
  6007                                  ;-----------------------------------------------------------------------------
  6008                                  
  6009                                  ;INIT	SEGMENT PUBLIC PARA
  6010                                  
  6011                                  ; 	EXTRN   HEADER:BYTE
  6012                                  ;	EXTRN   BADCOMLKMES:BYTE
  6013                                  
  6014                                  ;	PUBLIC  CONPROC
  6015                                  
  6016                                  ;ASSUME  CS:RESGROUP,DS:RESGROUP,ES:RESGROUP,SS:RESGROUP
  6017                                  
  6018                                          ;ORG 0
  6019                                  ;ZERO = $
  6020                                  	; 23/09/2018
  6021                                  ZERO equ $	; Offset 0E30h for original MSDOS 3.3 COMMAND.COM
  6022                                  
  6023                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  6024                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1560h (CODERES:0820h)
  6025                                  
  6026                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6027                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1670h (CODERES:0820h)
  6028                                  ConProc:
  6029                                  	;mov	sp,offset ResGroup:RStack	; must be first instruction
  6030 00001590 BC[2E05]                	mov	sp,RStack
  6031                                  
  6032                                  ; We need to set the PSP to us right at start because Carousel needs
  6033                                  ; to be lied to and it does not set PSP when it transfers control to
  6034                                  ; us after loading us as an overlay. By setting PSP, we ensure that
  6035                                  ; command.com is also not lied to.
  6036                                  
  6037                                  	; 14/01/2023
  6038                                  	; MSDOS 6.0
  6039 00001593 B450                            mov	ah,50h
  6040                                  	;mov	ah,SET_CURRENT_PDB
  6041 00001595 8CC3                            mov	bx,es
  6042 00001597 CD21                            int	21h
  6043                                  
  6044                                  	; 14/01/2023
  6045                                  	;mov	ah,30h 
  6046                                  	;;mov	ax,GET_VERSION<<8 ; 3000h
  6047                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6048 00001599 B80030                  	mov	ax,3000h
  6049 0000159C CD21                    	int	21h
  6050                                  	;;;cmp	ax,EXPECTED_VERSION ; 1E03h
  6051                                  	;;cmp	ax,5
  6052                                  	;cmp	ax,EXPECTED_VERSION ; 0005h
  6053                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6054 0000159E 3D070A                  	cmp	ax,EXPECTED_VERSION ; 1606h
  6055                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  6056                                  	;cmp	ax,0A07h
  6057 000015A1 7411                    	je	short okdos			; DOS version is ok
  6058                                  
  6059 000015A3 BA[6321]                	mov	dx,BADVERMSG			; DX = ptr to msg
  6060 000015A6 E832FE                  	call	RPrint
  6061                                  
  6062                                  	; MSDOS 3.3
  6063                                  	;mov	ah,STD_CON_STRING_OUTPUT ; 9
  6064                                  	;int	21h             ; DOS - PRINT STRING
  6065                                  				; DS:DX -> string terminated by "$"
  6066 000015A9 8CC0                    	mov	ax,es
  6067 000015AB 2639061600              	cmp	[es:PDB.PARENT_PID],ax
  6068                                  	;cmp	[es:16h],ax			; if COMMAND is own parent,
  6069                                  Here:	
  6070 000015B0 74FE                    	jz	short Here			;  loop forever
  6071                                  	
  6072 000015B2 CD20                    	int	20h				; otherwise, exit
  6073                                  okdos:
  6074                                  	; 23/09/2018
  6075                                  
  6076                                  ;  Calculate and save the end of the INIT segment (which is also
  6077                                  ;  the beginning of TRANGROUP).
  6078                                  
  6079                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  6080                                  	; MSDOS 3.3
  6081                                  	;mov	ah,65h
  6082                                  	;mov	al,2
  6083                                  	;mov	dx,-1
  6084                                  	;mov	bx,-1
  6085                                  	;mov	cx,5
  6086                                  	;mov	di,UCASE_ADDR
  6087                                  	;int	21h	; AH = 65h : GET EXTENDED COUNTRY INFORMATION (DOS 3.3+)
  6088                                  	;		; AL = 02h : Get pointer to character translation table
  6089                                  	;		; BX = code page (-1 = current global code page)
  6090                                  	;		; DX = country ID (-1 = current country)
  6091                                  	;		; CX = amount of data to return
  6092                                  	;; ES:DI = pointer to output buffer
  6093                                  	;; Buffer offset :
  6094                                  	;;	00h -  byte,  country Id
  6095                                  	;;  	01h -  dword, pointer to uppercase table	
  6096                                  
  6097                                  	; 14/01/2023
  6098                                  	; MSDOS 6.0 (& MSDOS 3.3)
  6099                                    	;mov	dx,232Fh     ; MSDOS 5.0 COMMAND.COM
  6100                                  	; 06/06/2023
  6101                                  	;mov	dx,26EFh     ; MSDOS 6.22 COMMAND.COM
  6102                                  	; 18/07/2024
  6103                                  	;mov	dx,289Fh     ; PCDOS 7.1 COMMAND.COM
  6104 000015B4 BADF27                  	mov	dx,TRANSTART+15			; get end of init code
  6105                                  	; 27/09/2018
  6106                                  	;mov	dx,TRANSTART ; (paragraph aligned address)
  6107 000015B7 B104                    	mov	cl,4				; change to paragraphs
  6108 000015B9 D3EA                            shr	dx,cl				;
  6109 000015BB 8CC8                            mov     ax,cs                           ; get current segment
  6110 000015BD 01D0                            add     ax,dx                           ; calculate segment of end of init
  6111 000015BF A3[9020]                        mov     [initend],ax			; save this
  6112                                  
  6113                                  	; 14/01/2023
  6114                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1591h 
  6115                                  
  6116                                  ;  Check for /? on the command line. If found, display help text and exit.
  6117                                  ;  NOTE: this routine may terminate the program, never returning.
  6118                                  
  6119 000015C2 E8EA07                  	call	CheckHelp
  6120                                  
  6121                                  ; We have to patch the segment values for the various interrupt entry points.
  6122                                  ; This is because we need to have the default addresses of the handlers in our
  6123                                  ; stub before the relocation is done. These values will then be changed once
  6124                                  ; the resident is relocated
  6125                                  
  6126 000015C5 E8160A                  	call	patch_segs
  6127                                  
  6128                                  ;  Turn APPEND off during initialization processing
  6129                                  
  6130                                  	; 14/01/2023
  6131 000015C8 B800B7                  	mov     ax,0B700h
  6132                                  	;mov	ax,APPENDINSTALL                ; see if append installed
  6133 000015CB CD2F                    	int	2Fh				;
  6134                                  	;cmp	al,0				; append installed?
  6135 000015CD 08C0                    	or	al,al
  6136 000015CF 7418                    	jz	short set_msg_addr		; no - continue
  6137                                  	
  6138 000015D1 B802B7                  	mov	ax,0B702h
  6139                                  	;mov	ax,APPENDDOS			; see if append DOS version right
  6140 000015D4 CD2F                    	int	2Fh				;
  6141                                  	;cmp	ax,-1				; append version correct?
  6142                                  	;jne	short set_msg_addr		; no - continue
  6143 000015D6 40                      	inc	ax ; -1 -> 0
  6144 000015D7 7510                    	jnz	short set_msg_addr        
  6145                                  	
  6146 000015D9 B806B7                  	mov     ax,0B706h
  6147                                  	;mov	ax,APPENDGETSTATE               ; Get the state of Append
  6148 000015DC CD2F                    	int	2Fh				;
  6149 000015DE 891E[BE02]                      mov     [Append_State],bx		; save append state
  6150                                         
  6151 000015E2 31DB                    	xor	bx,bx                           ; clear out state
  6152 000015E4 B807B7                  	mov	ax,0B707h
  6153                                  	;mov	ax,APPENDSETSTATE               ; Set the state of Append
  6154 000015E7 CD2F                    	int	2Fh				; set everything off
  6155                                  
  6156                                  set_msg_addr:
  6157                                  	; 14/01/2023
  6158                                  	;;mov	di,offset resgroup:DataresEnd 	; get address of resident end
  6159                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:15BAh) 
  6160                                  	;mov	di,093Eh  ; mov di,PAERRMSG0 ; MSDOS 5.0 COMMAND.COM
  6161                                  	; 06/06/2023
  6162                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:16CBh) 
  6163                                  	;mov	di,0A41h  ; mov di,PAERRMSG0 ; MSDOS 6.22 COMMAND.COM
  6164                                  	; 18/07/2024
  6165                                  	;mov	di,9F3h   ; mov di,PAERRMSG0 ; PCDOS 7.1 COMMAND.COM	
  6166 000015E9 BF[0509]                	mov	di,DataresEnd
  6167 000015EC 893E[B204]              	mov	[ResMsgEnd],di			; save it
  6168                                  
  6169 000015F0 E8FD09                          call    get_XMMAddr                     ; get XMM call address
  6170                                  
  6171                                  ; Check if this is the first instance of command.com. If not, we just exit
  6172                                  ; this routine without moving any code.
  6173                                  ; After the int 2fh, ds:si points at the resident jump table in the previous
  6174                                  ; stub. We just have to copy this over
  6175                                  	
  6176                                  ;ifndef ROMDOS
  6177 000015F3 B80055                  	mov	ax,5500h
  6178                                  	;mov	ax,GET_COMMAND_STATE	
  6179                                  ;else
  6180                                  ;	mov	ax,GET_ROMCOMMAND_STATE	
  6181                                  ;endif ; ROMDOS
  6182                                  
  6183 000015F6 CD2F                    	int	2Fh	;  (Int 2Fh/AX=5500h - DOS 5+ - COMMAND.COM INTERFACE)
  6184                                  	;assume	ds:nothing
  6185                                  
  6186                                  	; 03/05/2023
  6187                                  	; Return:
  6188                                  	;   AX = 0000h if an instance of COMMAND.COM is already running
  6189                                  	;   DS:SI -> entry point table
  6190                                  
  6191                                  	; (si = offset Int2f_Entry)  ; (('MsgInt2fHandler:', 'fcOurs:'))
  6192                                  
  6193 000015F8 09C0                    	or	ax,ax
  6194 000015FA 750C                    	jnz	short first_com			; this is the first instance
  6195                                  
  6196                                  	; 14/01/2023
  6197 000015FC 268936[9526]            	mov	[es:ResJmpTable],si		; save old stub jump table
  6198 00001601 268C1E[9726]            	mov	[es:ResJmpTable+2],ds
  6199 00001606 EB06                    	jmp	short init_cntry
  6200                                  
  6201                                  first_com:
  6202 00001608 26C606[9926]01          	mov	byte [es:FirstCom],1		; indicate first command.com
  6203                                  
  6204                                  init_cntry:
  6205                                  	; 14/01/2023
  6206 0000160E 06                      	push	es
  6207 0000160F 1F                      	pop	ds
  6208                                  	;assume	ds:RESGROUP
  6209                                  
  6210 00001610 B465                    	mov	ah,65h
  6211                                  	;mov	ah,GETEXTCNTRY			; get extended country info
  6212 00001612 B004                    	mov	al,4				; get file ucase table
  6213 00001614 BAFFFF                  	mov	dx,-1				;
  6214                                  	;mov	bx,-1				;
  6215 00001617 89D3                    	mov	bx,dx
  6216 00001619 B90500                  	mov	cx,5				; number of bytes we want
  6217                                  	;mov	di,offset resgroup:FUCase_Addr	; buffer for address
  6218 0000161C BF[B502]                	mov	di,FUCase_Addr
  6219 0000161F CD21                    	int	21h
  6220                                  		; DOS - 4.x internal - COUNTRY-DEPENDENT FILENAME CAPITALIZATION
  6221                                  		; AL = function -
  6222                                  
  6223                                  ;	Bugbug:	conditionalize dbcs_vector stuff?
  6224                                  
  6225 00001621 1E                      	push	ds				;
  6226 00001622 B80063                  	mov	ax,6300h
  6227                                  	;mov	ax,(ECS_CALL shl 8) or GETLEADBTBL ;
  6228 00001625 CD21                    	int	21h				;
  6229                                  		; DOS - 3.2+ only - GET DOUBLE BYTE CHARACTER SET LEAD TABLE
  6230                                  			
  6231 00001627 8CDB                    	mov	bx,ds				; get segment to bx
  6232 00001629 1F                      	pop	ds				;
  6233 0000162A 8936[BA02]              	mov	[Dbcs_Vector_Addr],si		; save address of
  6234 0000162E 891E[BC02]              	mov	[Dbcs_Vector_Addr+2],bx		; dbcs vector
  6235                                  
  6236                                  	;mov	ax,[16h]
  6237 00001632 A11600                  	mov	ax,[PDB.PARENT_PID]
  6238                                  				; mov ax,ds:16h	; Init PARENT so we can exit
  6239 00001635 A3[3E02]                	mov	[Parent],ax			;  correctly.
  6240 00001638 A10A00                  	mov	ax,[PDB.EXIT]   ; mov ax,ds:0Ah
  6241 0000163B A3[4002]                	mov	[OldTerm],ax
  6242 0000163E A10C00                  	mov	ax,[PDB.EXIT+2] ; mov ax,ds:0Ch
  6243 00001641 A3[4202]                	mov	[OldTerm+2],ax
  6244                                  
  6245                                  	; 14/01/2023
  6246                                  	;;;mov	ax,offset ResGroup:EndCode + 15
  6247                                  	;;mov	ax,1569h	; MSDOS 5.0 COMMAND.COM
  6248                                  	; 06/06/2023
  6249                                  	;mov	ax,1679h	; MSDOS 6.22 COMMAND.COM
  6250                                  	; 18/07/2024
  6251                                  	;mov	ax,16B3h	; PCDOS 7.1 COMMAND.COM
  6252                                  	
  6253                                  	;mov	ax,EndCode+15
  6254                                  	;;mov	ax,INITSTART+15 ; 24/09/2018
  6255                                  	; 14/01/2023
  6256                                  	;mov	cl,4				; ax = size of resident part of
  6257                                  	;shr	ax,cl				;  command in paragraphs. Add
  6258                                  	;mov	cx,cs				;  this to CS and you get the
  6259                                  	;add	ax,cx				;  segment of the TPA.
  6260                                  
  6261 00001644 8CC8                    	mov	ax,cs
  6262                                  	; 14/08/2024
  6263                                  	EndCodeParag equ (ENDCODE+15)>>4 
  6264                                  	;add	ax,(EndCode+15)>>4
  6265 00001646 056901                  	add	ax,EndCodeParag
  6266                                  	
  6267 00001649 A3[5804]                	mov	[Res_Tpa],ax			; Temporarily save the TPA segment
  6268 0000164C 2500F0                  	and	ax,0F000h
  6269 0000164F 050010                  	add	ax,1000h			; Round up to next 64K boundary
  6270 00001652 7303                    	jnc	short TpaSet			; Memory wrap if carry set
  6271 00001654 A1[5804]                	mov	ax,[Res_Tpa]
  6272                                  TpaSet:
  6273 00001657 A3[4C04]                	mov	[LTpa],ax			; Good enough for the moment
  6274                                  	;mov	ax,[2]
  6275 0000165A A10200                  	mov	ax,[PDB.BLOCK_LEN]		; ax = # of paras given to command
  6276                                  
  6277 0000165D 8C1E[5204]              	mov	[MySeg1],ds			; These 3 variables are used as part of
  6278 00001661 8C1E[5604]              	mov	[MySeg2],ds			;  3 long ptrs that the transient will
  6279 00001665 8C1E[4A04]              	mov	[MySeg],ds			;  use to call resident routines.
  6280                                  	; 19/04/2023
  6281                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1641h
  6282 00001669 8C1E[5607]              	mov	[MySeg3],ds			; segment of msg retriever routine 
  6283                                  
  6284 0000166D A3[9502]                	mov	[MemSiz],ax			; Needed for execing other programs
  6285                                  
  6286                                  	; 14/01/2023 - Retro DOS v4.0 COMMAND.COM
  6287                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1648h
  6288                                  
  6289                                  ; First reallocate the COMMAND size to its memory image
  6290                                  	
  6291 00001670 50                      	push	ax    
  6292                                    	;;;mov	bx,2320h  ; MSDOS 5.0 COMMAND.COM
  6293                                  	;;mov	bx,offset RESGROUP:TranStart    ;
  6294                                  	;mov	bx,TRANSTART
  6295                                  	;;add	bx,98C5h  ; MSDOS 5.0 COMMAND.COM
  6296                                          ;add	bx,offset TRANGROUP:TranSpaceEnd;
  6297                                  	;add	bx,15 ; *			; round up the size
  6298                                  	; 06/06/2023
  6299                                  	;mov	bx,26E0h  ; MSDOS 6.22 COMMAND.COM ; mov bx,offset RESGROUP:TranStart
  6300                                  	;add	bx,0AF95h ; MSDOS 6.22 COMMAND.COM ; add bx,offset TRANGROUP:TranSpaceEnd
  6301                                  	;add	bx,15 ; *			; round up the size
  6302                                  
  6303                                  	; 03/05/2023
  6304                                  	;mov	bx,TRANSTART+15 ; * ; 14/01/2023
  6305                                  	;add	bx,TRANSPACEEND
  6306                                  	; 06/06/2023
  6307                                  	;mov	bx,TRANSTART+TRANSPACEEND+15 
  6308                                          ;mov	cl,4				;
  6309                                          ;shr	bx,cl				; size of command.com
  6310 00001671 BBDE0C                  	mov	bx,(TRANSTART+TRANSPACEEND+15)>>4
  6311                                  
  6312 00001674 B44A                    	mov	ah,4Ah
  6313                                  	;mov	ah,SETBLOCK			; free all memory above pgm
  6314 00001676 CD21                            int     21h				;
  6315 00001678 58                              pop     ax				;
  6316                                  	
  6317                                  ; Compute maximum size of environment
  6318                                  
  6319                                  	;;mov	word [ENVMAX],69 ; = (160/16)+(973/16)-1 ; (11EEh-0E30h+0Fh/10h) = 3Ch
  6320                                          ;mov	word [ENVMAX],((ENVIRONSIZ+15)/16) + ((ENVMAXIMUM-ZERO+15)/16) - 1
  6321                                  	; 14/01/2023 - Retro DOS v4.0 COMMAND.COM
  6322                                  	;mov	word [EnvMax],81	; 10+72-1  ; MSDOS 5.0 COMMAND.COM
  6323                                  	;mov	word [EndMax],90	; 12+79-1  ; MSDOS 6.22 COMMAND.COM	
  6324                                  	; 22/07/2024
  6325                                  	;mov	word [EndMax],95	; 
  6326 00001679 C706[8420]5800          	mov	word [EnvMax],((ENVIRONSIZ+15)/16) + ((EnvMaximum-ZERO+15)/16) - 1
  6327                                  			; MSDOS 6.22	; 12+(((1B53h-1670h)+15)/16)-1 = 90
  6328                                  			; PCDOS 7.1	; ((166+15+)/16)+(1BF5h-16B0h+15)/16)-1 = 95
  6329                                  ;
  6330                                  ; Compute minimum size of environment
  6331                                  ;
  6332                                  	;;mov	word [EnvSiz],10 ; = 160/16	; MSDOS 3.3 COMMAND.COM
  6333                                  	;mov	word [EnvSiz],16 ; = 256/16	; MSDOS 5.0 COMMAND.COM
  6334 0000167F C706[8220]1000          	mov	word [EnvSiz],ENVSML/16 ; 256/16
  6335                                  
  6336                                  	;;;mov	dx,offset TranGroup:Transpaceend + 15 ; dx = size of transient
  6337                                  	;;mov	dx,98D4h	; MSDOS 5.0 COMMAND.COM
  6338                                  	; 06/06/2023
  6339                                  	;;mov	dx,0AFA4h	; MSDOS 6.22 COMMAND.COM
  6340                                  	;mov	dx,TRANSPACEEND+15 ; 4D5Ch+0Fh (for MSDOS 3.3 COMMAND.COM)
  6341                                  	; 22/07/2024
  6342                                  	;mov	dx,0AAA9h	; PCDOS 7.1 COMMAND.COM (0AA9Ah+0Fh)
  6343                                  	;mov	cl,4				;  in paragraphs.
  6344                                  	;shr	dx,cl
  6345 00001685 BA610A                  	mov	dx,(TRANSPACEEND+15)>>4
  6346                                  
  6347 00001688 8916[9220]                      mov     [TrnSize],dx			; save size of transient in paragraphs
  6348                                  
  6349 0000168C 29D0                    	sub	ax,dx				; max seg addr - # para's needed for transient
  6350 0000168E A3[8F02]                	mov	[TrnSeg],ax			;  = seg addr to load the transient at.
  6351                                  	;mov	ax,[2Ch]
  6352 00001691 A12C00                  	mov	ax,[PDB.ENVIRON]		; ax = environment segment
  6353                                  
  6354                                  	; 14/01/2023
  6355                                          ; MSDOS 6.0
  6356                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6357 00001694 A3[3A04]                	mov	[EnvirSeg],ax
  6358                                          
  6359                                  	; 21/01/2023
  6360 00001697 09C0                    	or	ax,ax				; if there is no environment segment,
  6361 00001699 7407                    	jz	short buildenv			; make one
  6362                                    
  6363                                  	; 21/01/2023
  6364                                  	; MSDOS 3.3 & MSDOS 5.0
  6365                                  	;;inc	byte [CHUCKENV]
  6366                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6367                                  	;inc	byte [AllocedEnv]		; Flag - old environment segment
  6368                                  	
  6369                                  	; MSDOS 3.3 & MSDOS 5.0
  6370                                  	; 06/06/2023
  6371                                  	;jmp	short environpassed
  6372                                  	
  6373                                  	; MSDOS 6.0
  6374                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM	
  6375 0000169B 803E[9926]00            	cmp	byte [FirstCom],0		; if this is the first command.com,
  6376 000016A0 7403                    	je	short environpassed		; do a merge job (make sure COMSPEC exists)
  6377                                  
  6378                                  	; MSDOS 6.0
  6379                                  
  6380                                  ; We allocate a buffer here just large enough to hold the 'PATH=' and
  6381                                  ; the COMSPEC. After parsing, we will allocate an environment of the right
  6382                                  ; size and free this buffer. We need this buffer because we no longer have an
  6383                                  ; ENVIRONMENT segment but need a place to store the COMSPEC which can be
  6384                                  ; given on the command line before we know the environment size. This routine
  6385                                  ; will not return in case of an allocation error. It will either exit or hang
  6386                                  ; depending on whether or not this is the first COMMAND.COM or not.
  6387                                  
  6388                                  	; 14/01/2023
  6389                                  buildenv:
  6390 000016A2 E8E607                  	call	alloc_env                       ; try to allocate buffer
  6391                                  environpassed:
  6392                                  	; 14/01/2023 - MSDOS 5.0 COMMAND.COM
  6393                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6394                                  	;mov	[EnvirSeg],ax
  6395                                  	;
  6396 000016A5 8EC0                    	mov	es,ax                           ; and it load into es.
  6397                                  	;assume	es:nothing
  6398                                  
  6399                                  gottheenvir:
  6400                                  
  6401                                  ; Initialize the command drive
  6402                                  
  6403                                  	; 14/01/2023
  6404                                  	; MSDOS 3.3 & MSDOS 6.0
  6405 000016A7 B419                    	mov	ah,19h
  6406                                  	;mov	ah,GET_DEFAULT_DRIVE	; 19h
  6407 000016A9 CD21                    	int	21h
  6408 000016AB FEC0                    	inc	al
  6409 000016AD A2[9402]                	mov	[ComDrv],al
  6410                                  
  6411                                          ;mov	al,byte ptr ds:[FCB]	; al = default drive number for command
  6412 000016B0 A05C00                          mov	al,[FCB] ; [5Ch]
  6413 000016B3 08C0                    	or	al,al
  6414 000016B5 7433                    	jz	short nocomdrv		; no drive specified
  6415                                  
  6416 000016B7 B43A                    	mov	ah,':'
  6417 000016B9 A2[9402]                	mov	[ComDrv],al
  6418 000016BC 0440                    	add	al,40h			; convert number to uppercase character
  6419                                  
  6420 000016BE FD                      	std
  6421                                  
  6422                                  	; MSDOS 6.0
  6423                                  	; 06/06/2023
  6424                                  	; MSDOS 6.22 - COMMAND.COM - RESGROUP:17B7h
  6425 000016BF 803E[5420]00            	cmp	byte [AllocedEnv],0	; if a new environment is being built,
  6426 000016C4 7420                    	je	short notwidenv		;  move the default comspec string in it
  6427                                  	; 14/01/2023
  6428                                  	; MSDOS 5.0 COMMAND.COM
  6429 000016C6 8B3E[6B20]              	mov	di,[ComspOffset]
  6430 000016CA 26807D013A                      cmp	byte [es:di+1],':'	; drive specifier already exist?
  6431 000016CF 7415                            je	short notwidenv		; yes, must have been inherited that way
  6432                                  
  6433                                  	; 06/06/2023
  6434                                  	; MSDOS 3.3
  6435                                  	;;cmp	byte [CHUCKENV],0
  6436                                  	;;jne	short NOTWIDENV
  6437                                  	; 21/01/2021
  6438                                  	; MSDOS 5.0 - COMMAND.COM - RESGROUP:16A5h
  6439                                   	;cmp	byte [AllocedEnv],0
  6440                                  	;ja	short notwidenv
  6441                                  
  6442 000016D1 1E                        	push	ds			;  2 bytes to make room for a drivespec.
  6443 000016D2 06                      	push	es			;  the drivespec is in ax and is copied
  6444 000016D3 1F                      	pop	ds			;  on to the front of the string.
  6445                                  
  6446                                  ; 06/06/2023
  6447                                  %if 0
  6448                                  	; 21/01/2023
  6449                                  	; 14/01/2023
  6450                                  	; MSDOS 5.0 COMMAND.COM
  6451                                  	; MSDOS 3.3
  6452                                  	; 23/09/2018
  6453                                  	; 30/04/2018
  6454                                  	;mov	di,159
  6455                                  	;;MOV	DI,OFFSET ENVIRONMENT:ECOMSPEC+ENVIRONSIZ2-1-10H
  6456                                  	;mov	di,(ECOMSPEC-ENVIRONMENT)+ENVIRONSIZ2-1 ; mov di,9Fh
  6457                                  	mov	di,ENVIRONSIZ-1 ; 21/01/2023
  6458                                  	;mov	si,157
  6459                                  	;;MOV	SI,OFFSET ENVIRONMENT:ECOMSPEC+ENVIRONSIZ2-3-10H
  6460                                          ;mov	si,(ECOMSPEC-ENVIRONMENT)+ENVIRONSIZ2-3 ; mov si,9Dh 
  6461                                  	mov	si,ENVIRONSIZ-3 ; 21/01/2023 	
  6462                                  	;MOV	CX,ENVIRONSIZ2-2 ; mov cx,90h
  6463                                  	mov	cx,MAX_COMSPEC-2 ; 144
  6464                                  %endif
  6465                                  	; MSDOS 6.0
  6466                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM - RESGROUP:17CCh
  6467 000016D4 8DB58F00                        lea	si,[di+MAX_COMSPEC-3]	; lea si,[di+143]
  6468 000016D8 8DBD9100                        lea	di,[di+MAX_COMSPEC-1]	; lea di,[di+145]
  6469                                  
  6470 000016DC B99000                          mov	cx,MAX_COMSPEC-2 ; 144
  6471                                  
  6472 000016DF F3A4                    	rep	movsb
  6473 000016E1 1F                      	pop	ds
  6474                                  
  6475                                  	; MSDOS 6.0
  6476                                  	; 06/06/2023
  6477 000016E2 268945FF                	mov	[es:di-1],ax
  6478                                  
  6479                                  	; MSDOS 3.3
  6480                                  	;mov	[es:0Eh],ax
  6481                                  	;;;MOV	WORD PTR ES:[ECOMSPEC-10H],AX
  6482                                  	;;MOV	[es:(ECOMSPEC-ENVIRONMENT)],ax	; mov [es:0Eh],ax
  6483                                  	; 14/01/2023
  6484                                  	; 06/06/2023
  6485                                  	;mov	[es:ECOMSPEC],ax ; mov [es:0Eh],ax
  6486                                  
  6487                                  	; MSDOS 3.3 & MSDOS 6.0
  6488                                  notwidenv:
  6489 000016E6 FC                      	cld
  6490 000016E7 A3[3620]                	mov	[AUTOBAT],ax ; db 0,":\AUTOEXEC.BAT"
  6491                                  
  6492                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  6493                                  %if 0
  6494                                  	; 14/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6495                                  	; (MSDOS 5.0 COMMAND.COM RESGROUP:16C3h)
  6496                                  	; 06/06/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6497                                  	mov	[KAUTOBAT],ax ; db 0,":\AUTOEXEC.BAT"
  6498                                  %endif
  6499                                  
  6500                                  nocomdrv:
  6501 000016EA E841FA                  	call	SetVect        ; Set the vectors
  6502                                  
  6503                                  ; parsing starts here
  6504                                  
  6505                                  	; 14/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6506                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:16C9h - CODERES:0989h)
  6507                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6508                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:17E8h - CODERES:0998h)
  6509                                  	; MSDOS 6.0
  6510 000016ED 0E                      	push	cs
  6511 000016EE 0E                      	push	cs
  6512 000016EF 1F                      	pop	ds
  6513 000016F0 07                      	pop	es
  6514                                  	;assume ds:ResGroup,es:ResGroup
  6515                                  
  6516 000016F1 BE8000                  	mov	si,80h				; get command line
  6517 000016F4 AC                      	lodsb					; get length of line
  6518 000016F5 89F7                    	mov	di,si				; get line position in di
  6519 000016F7 30E4                    	xor	ah,ah				; ax = length of command line
  6520                                  
  6521                                  ; insure that the command line correctly ends with a cr
  6522                                  
  6523 000016F9 01C7                    	add	di,ax				; go to end of command line
  6524 000016FB C6050D                          mov	byte [di],0Dh			; insert a carriage return
  6525 000016FE 31C9                    	xor	cx,cx				; clear cx
  6526 00001700 890E[5F21]                      mov	[num_positionals],cx		; initialize positionals
  6527                                  
  6528                                  ; Scan the command line looking for the parameters
  6529                                  
  6530                                  Parse_command_line:
  6531                                  	;mov	di,offset ResGroup:Parse_Command; Get address of parse_command
  6532 00001704 BF[9920]                	mov	di,PARSE_COMMAND
  6533 00001707 8B0E[5F21]              	mov	cx,[num_positionals]		; Get number of positionals
  6534 0000170B 31D2                    	xor	dx,dx				; clear dx
  6535 0000170D 8936[6121]                      mov	[old_parse_ptr],si		; save position before calling parser
  6536                                  	;call	dword ptr Init_Parse
  6537 00001711 FF1E[8E20]              	call	far [Init_Parse]		; call parser
  6538 00001715 890E[5F21]                      mov     [num_positionals],cx		; Save number of positionals
  6539                                  	; 29/01/2023
  6540                                  	;;cmp	ax,END_OF_LINE ; 0FFFFh ; -1 	; are we at end of line?
  6541                                          ;cmp	ax,-1
  6542                                  	;jne	short t1
  6543                                  	; 10/06/2023
  6544 00001719 40                      	inc	ax	 ; cmp ax,-1
  6545 0000171A 7503                    	jnz	short t1 ; 0FFFFh -> 0
  6546                                  	; ax = 0
  6547 0000171C E99502                  	jmp     ArgsDone                        ; yes - exit
  6548                                  t1:	
  6549                                  	;;cmp	ax,RESULT_NO_ERROR ; 0		; did an error occur
  6550                                  	;;cmp	ax,0
  6551                                  	;and	ax,ax
  6552                                  	; 10/06/2023
  6553 0000171F 48                      	dec	ax  ; cmp ax,0
  6554 00001720 7468                    	jz	short parse_cont  ; 1 -> 0	; no - continue
  6555                                  
  6556                                  ; Before issuing error message - make sure switch is not /C
  6557                                  
  6558                                  parse_line_error:
  6559                                  	; 14/01/2023
  6560                                  	;push	si				; save line position
  6561                                  	;push	ax				; save error number
  6562                                  	;cmp	ax,3
  6563 00001722 83F803                  	cmp	ax,BadSwt_Ptr ; 3		; Was error invalid switch?
  6564                                          ;jnz	short parse_line_error_disp	; No - just issue message
  6565 00001725 7538                    	jne	short parse_line_error_disp2
  6566 00001727 56                      	push	si ; **				; save line position
  6567 00001728 50                      	push	ax ; *				; save error number
  6568 00001729 89F7                    	mov	di,si				; Get terminating pointer in DI
  6569 0000172B 8B36[6121]                      mov     si,[old_parse_ptr]		; Get starting pointer in SI
  6570                                  
  6571                                  init_chk_delim:
  6572 0000172F 39FE                    	cmp	si,di				; at end of parsed parameter?
  6573 00001731 742A                            je	short parse_line_error_disp	; Yes - just display message
  6574 00001733 AC                      	lodsb					;
  6575 00001734 3C20                    	cmp	al,20h ; ' ' ; 16/04/2023
  6576                                  	;cmp	al,space_chr ; 14/01/2023
  6577                                  	;;cmp	al,[space]			; Skip blank spaces
  6578 00001736 74F7                    	je	short init_chk_delim		;
  6579                                  	;cmp	al,9
  6580 00001738 3C09                    	cmp	al,tab_chr ; 9			; Skip tab characters
  6581 0000173A 74F3                    	je	short init_chk_delim		;
  6582                                  
  6583 0000173C 3A06[4E04]              	cmp	al,[RSwitChar]	; '/'		; Switch?
  6584 00001740 751B                            jne	short parse_line_error_disp	; No - just issue message
  6585 00001742 AC                      	lodsb					; Get the char after the switch
  6586                                  
  6587                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  6588                                  ;ifdef	DBCS
  6589                                  %if 1
  6590 00001743 E837FD                  	call	ITestKanj			; Is it DBCS?
  6591 00001746 7515                    	jnz	short parse_line_error_disp	; Yes - can't be /C or /K
  6592                                  %endif
  6593                                  ;endif
  6594 00001748 E8D505                  	call	iupconv 			; upper case it
  6595                                  
  6596                                  	;cmp	al,[scswitch]	; 'C'		; it is /C?
  6597                                          ;jne	short check_k_too ; MSDOS 6.0	;
  6598                                  	; 16/04/2023
  6599 0000174B 3C43                    	cmp	al,'C' ; scswitch
  6600                                  	;jne	short parse_line_error_disp  ; MSDOS 5.0 COMMAND.COM
  6601                                  	; 06/06/2023
  6602                                  	; MSDOS 6.22 COMMAND.COM
  6603 0000174D 7505                    	jne	short check_k_too
  6604 0000174F 5A                      	pop	dx ; *				; even up stack
  6605 00001750 5A                      	pop	dx ; **				; even up stack
  6606 00001751 E9D100                  	jmp	SetSSwitch			; Yes - go set COMMAND /C
  6607                                  
  6608                                  	; MSDOS 6.0
  6609                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  6610                                  check_k_too:
  6611                                  	;cmp	al,[skswitch]	; 'K'		; it is /K?
  6612                                          ;jne	short parse_line_error_disp	;
  6613                                  	; 06/06/2023
  6614 00001754 3C4B                    	cmp	al,'K'
  6615 00001756 7505                    	jne	short parse_line_error_disp
  6616 00001758 5A                      	pop	dx ; *				; even up stack
  6617 00001759 5A                      	pop	dx ; **				; even up stack
  6618 0000175A E9C100                          jmp	SetKSwitch			; Yes - go set COMMAND /K
  6619                                  
  6620                                  parse_line_error_disp:
  6621                                  	; 14/01/2023
  6622 0000175D 58                      	pop	ax ; *				; restore error number
  6623 0000175E 5E                      	pop	si ; **				; restore line position
  6624                                  parse_line_error_disp2:
  6625 0000175F 89C2                    	mov	dx,ax				; get message number
  6626 00001761 E84C05                  	call	RPrintParse
  6627 00001764 E871FC                  	call	crlf
  6628 00001767 EB9B                            jmp     short Parse_command_line        ; continue parsing
  6629                                  
  6630                                  ; 22/07/2024
  6631                                  
  6632                                  ;CHECKDSWITCH:
  6633                                  	;;cmp	al,'d'
  6634                                          ;cmp	al,[letter_d]
  6635                                  	;jnz	short CHECKCSWITCH
  6636                                  
  6637                                  ; 16/04/2023
  6638                                  %if 1
  6639                                  SetMSwitch:
  6640                                          ;cmp	byte [ext_msg],1
  6641 00001769 803E[9420]01            	cmp	byte [ext_msg],SET_EXTENDED_MSG	; has /MSG switch been set?
  6642                                  	; 16/04/2023
  6643                                  	;jnz	short setMswitchok		; no - set it
  6644                                  	;;mov	ax,1
  6645                                  	;mov	ax,MoreArgs_Ptr                 ; set up too many arguments
  6646                                  	;jmp	parse_line_error                ; go issue error message
  6647                                  	; 16/04/2023
  6648 0000176E 747C                    	je	short parse_line_error_j
  6649                                  setMswitchok:
  6650                                          ;mov	byte [ext_msg],1
  6651 00001770 C606[9420]01            	mov	byte [ext_msg],SET_EXTENDED_MSG	; set /MSG switch
  6652                                  	; 06/06/2023
  6653 00001775 EB8D                    	jmp	short Parse_command_line	; keep parsing
  6654                                  %endif
  6655                                  
  6656                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6657                                  
  6658                                  SetDSwitch:
  6659                                  
  6660                                  ; Flag no date/time prompting.
  6661                                  
  6662                                  	; MSDOS 6.0
  6663 00001777 803E[9620]00            	cmp	byte [dswitch],0	; has /D switch been set?
  6664                                  	; 16/04/2023
  6665                                  	;jz	short setdateok		; no - set it
  6666                                          ;;mov	ax,1
  6667                                  	;mov	ax,MoreArgs_Ptr		; set up too many arguments
  6668                                          ;jmp	parse_line_error	; go issue error message
  6669                                  	; 16/04/2023
  6670 0000177C 756E                    	jnz	short parse_line_error_j
  6671                                  setdateok:
  6672 0000177E FE06[9620]              	inc	byte  [dswitch]		; indicate /D entered
  6673                                  
  6674                                  	; MSDOS 3.3 & MSDOS 6.0
  6675 00001782 C606[4720]01                    mov	byte [PRDATTM],1	; User explicitly says no date time
  6676                                  	; MSDOS 3.3
  6677                                  	;jmp	short CHKARG
  6678                                  	; MSDOS 6.0
  6679 00001787 E97AFF                  	jmp     Parse_command_line	; continue parsing
  6680                                  
  6681                                  parse_cont:
  6682                                  	; 15/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6683                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:173Ch - CODERES:09FCh)
  6684                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6685                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:1869h - CODERES:0A19h)
  6686                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6687                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:18AEh
  6688                                  
  6689                                  	; MSDOS 6.0
  6690                                  
  6691                                  ; See if a switch was entered
  6692                                  ;
  6693                                  ; Bugbug: See if Comnd1_Syn can be moved into a reg. before the compare
  6694                                  
  6695 0000178A 813E[5821][D820]        	cmp	word [COMND1_SYN],COMMAND_F_SYN ; was /F entered?
  6696 00001790 7460                    	je	short SetFSwitch		; yes go set fail switch
  6697 00001792 813E[5821][CC20]        	cmp	word [COMND1_SYN],COMMAND_P_SYN ; was /P entered?
  6698 00001798 744B                    	je	short SetPSwitch		; yes go set up PERMCOM
  6699 0000179A 813E[5821][E420]        	cmp	word [COMND1_SYN],COMMAND_D_SYN ; was /D entered?
  6700 000017A0 74D5                    	je	short SetDSwitch		; yes go set date switch
  6701 000017A2 813E[5821][0921]        	cmp	word [COMND1_SYN],COMMAND_C_SYN ; was /C entered?
  6702 000017A8 747B                    	je	short SetSSwitch		; yes go set up SINGLECOM
  6703                                  	; 06/06/2023
  6704                                  	; MSDOS 6.0 only!
  6705 000017AA 813E[5821][2F21]        	cmp	word [COMND1_SYN],COMMAND_K_SYN ; was /K entered?
  6706 000017B0 746C                            je	short SetKSwitch		; yes go set up SINGLECOM
  6707                                  	;
  6708 000017B2 813E[5821][F020]        	cmp	word [COMND1_SYN],COMMAND_E_SYN ; was /E entered?
  6709 000017B8 747C                    	je	short SetESwitch		; yes go set up environment
  6710                                  
  6711                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6712                                  ; PCDOS 7.1 COMMAND.COM
  6713                                  %if 1
  6714 000017BA 813E[5821][3B21]        	cmp	word [COMND1_SYN],COMMAND_Y_SYN ; was /Y entered?
  6715                                  	;je	short SetYSwitch		; yes (step switch)
  6716                                  	; 22/07/2024
  6717 000017C0 7508                    	jne	short parse_cont_@
  6718                                  
  6719                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:19C3h
  6720                                  SetYSwitch:
  6721 000017C2 800E[5A04]10            	or      byte [Y_Flag], 10h
  6722 000017C7 E93AFF                  	jmp     Parse_command_line
  6723                                  
  6724                                  parse_cont_@:
  6725                                  %endif
  6726 000017CA 813E[5821][1521]        	cmp	word [COMND1_SYN],COMMAND_M_SYN	; was /MSG entered?
  6727                                  	;je	short SetMSwitchjmp		; yes go set up message flag
  6728                                  	; 15/01/2023
  6729 000017D0 7497                    	je	short SetMSwitch 
  6730                                  
  6731                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6732                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:18FDh
  6733                                  %if 1
  6734 000017D2 813E[5821][4721]        	cmp	word [COMND1_SYN],COMMAND_H_SYN	; was /H entered?
  6735 000017D8 747A                    	je	short SetHSwitch		; yes (load into UMB switch)
  6736 000017DA 813E[5821][5321]        	cmp	word [COMND1_SYN],COMMAND_O_SYN	; was /O entered?
  6737 000017E0 747F                    	je	short SetOSwitch		; yes (disable overwrite prompt)
  6738                                  %endif
  6739 000017E2 E99800                  	jmp	ChkOtherArgs		; Must be something else
  6740                                  
  6741                                  	; MSDOS 6.0
  6742                                  ;SetMSwitchjmp:
  6743                                  	;jmp	SetMSwitch
  6744                                  
  6745                                  ; 22/07/2024
  6746                                  %if 1
  6747                                  SetPSwitch:
  6748                                  
  6749                                  ; We have a permanent COMMAND switch /P. Flag this and stash the
  6750                                  ; termination address.
  6751                                  
  6752                                  	; MSDOS 6.0
  6753 000017E5 803E[A202]00            	cmp	byte [PermCom],0	; has /p switch been set?
  6754 000017EA 7415                    	jz	short permcomok		; no - set it
  6755                                  	; 16/04/2023
  6756                                  parse_line_error_j:
  6757                                          ;mov	ax,1
  6758 000017EC B80100                  	mov	ax,MoreArgs_Ptr		; set up too many arguments
  6759 000017EF E930FF                          jmp	parse_line_error	; go issue error
  6760                                  %endif
  6761                                  	
  6762                                  	; MSDOS 6.0
  6763                                  SetFSwitch:
  6764 000017F2 803E[A902]FF            	cmp	byte [fFail],-1		; has fail switch been set?
  6765                                  	; 16/04/2023
  6766                                  	;jne	short failok		; no - set it
  6767                                  	;;mov	ax,1
  6768                                  	;mov	ax,MoreArgs_Ptr         ; set up too many arguments
  6769                                          ;jmp	parse_line_error        ; go issue error 
  6770                                  	; 16/04/2023
  6771 000017F7 74F3                    	je	short parse_line_error_j
  6772                                  
  6773                                  	; MSDOS 3.3 & MSDOS 6.0
  6774                                  failok:
  6775 000017F9 C606[A902]FF            	mov	byte [fFail],-1		; fail all INT 24s.
  6776                                  	; MSDOS 3.3
  6777                                  	;jmp	short CHKARG
  6778                                  	; MSDOS 6.0
  6779 000017FE E903FF                  	jmp	Parse_command_line
  6780                                  
  6781                                  ;CHECKPSWITCH:
  6782                                  	;;cmp	al,'p'			; Permanent COMMAND switch
  6783                                  	;cmp	al,[letter_p]
  6784                                          ;jnz	short CHECKDSWITCH
  6785                                  
  6786                                  ; 22/07/2024
  6787                                  %if 0
  6788                                  SetPSwitch:
  6789                                  
  6790                                  ; We have a permanent COMMAND switch /P. Flag this and stash the
  6791                                  ; termination address.
  6792                                  
  6793                                  	; MSDOS 6.0
  6794                                  	cmp	byte [PermCom],0	; has /p switch been set?
  6795                                  	jz	short permcomok		; no - set it
  6796                                  	; 16/04/2023
  6797                                  parse_line_error_j:
  6798                                          ;mov	ax,1
  6799                                  	mov	ax,MoreArgs_Ptr		; set up too many arguments
  6800                                          jmp	parse_line_error	; go issue error
  6801                                  %endif
  6802                                  
  6803                                  permcomok:
  6804                                  	; MSDOS 3.3 & MSDOS 6.0
  6805 00001801 FE06[A202]              	inc	byte [PermCom]
  6806                                  	;mov	word [OLDTERM],LODCOM
  6807 00001805 C706[4002][E000]        	mov	word [OldTerm],LodCom_Trap
  6808                                  	;mov	[OLDTERM+2],ds
  6809 0000180B 8C1E[4202]              	mov	[OldTerm+2],ds
  6810                                  
  6811                                  ; make sure that we display the date and time. if the flag was not
  6812                                  ; initialized, set it to indicate yes, do prompt.
  6813                                  
  6814                                  	; MSDOS 3.3
  6815                                  	;cmp	byte [PRDATTM],-1
  6816                                  	;jnz	short CHKARG
  6817                                  	;mov	byte [PRDATTM],0
  6818                                  	;jmp	short CHKARG
  6819                                  
  6820                                  	; MSDOS 6.0
  6821 0000180F 803E[4720]FF            	cmp	byte [PRDATTM],-1
  6822 00001814 7505                    	jne	short Parse_command_line_jmp
  6823 00001816 C606[4720]00            	mov	byte [PRDATTM],0
  6824                                  Parse_command_line_jmp:
  6825 0000181B E9E6FE                  	jmp     Parse_command_line	; keep parsing
  6826                                  
  6827                                  ;COMRETURNSJ:
  6828                                  ;	; MSDOS 3.3
  6829                                  ;	JMP	ARGSDONE
  6830                                  
  6831                                  	; 15/01/2023
  6832                                  	; MSDOS 6.0 
  6833                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  6834                                  SetKSwitch:
  6835 0000181E C606[A302]00            	mov	byte [SemiPermCom],0
  6836 00001823 EB05                    	jmp	short SetSorKSwitch
  6837                                  
  6838                                  ;CHECKCSWITCH:
  6839                                  	;;cmp	al,'c'
  6840                                  	;cmp	al,[letter_c]
  6841                                          ;jnz	short CHECKESWITCH
  6842                                  
  6843                                  SetSSwitch:
  6844                                  ;SETCSWITCH:
  6845                                  
  6846                                  ; Set up pointer to command line, flag no date/time and turn off SingleCom.
  6847                                  
  6848 00001825 C606[A202]00            	mov	byte [PermCom],0	; A SingleCom must not be a PermCom
  6849                                  SetSorKSwitch:	; 06/06/2023
  6850 0000182A 8936[A502]              	mov	[SingleCom],si		; Point to the rest of the command line
  6851 0000182E C606[4720]01            	mov	byte [PRDATTM],1	; no date or time either, explicit
  6852                                  ;COMRETURNSJ: ; 24/09/2018
  6853 00001833 E97E01                  	jmp     ArgsDone
  6854                                  
  6855                                  ;CHECKESWITCH:
  6856                                  	;cmp	al,'e'
  6857                                  	;jnz	short CHKARG
  6858                                  
  6859                                  ; Look for environment-size setting switch
  6860                                  
  6861                                  ; The environment size is represented in decimal bytes and is
  6862                                  ; converted into paragraphs (rounded up to the next paragraph).
  6863                                  
  6864                                  SetESwitch:
  6865                                  	; MSDOS 6.0
  6866 00001836 803E[9520]00            	cmp	byte [eswitch],0	; has environment size switch been set?
  6867                                  	; 16/04/2023
  6868                                  	;jz	short eswitchok		; no - set it
  6869                                  	;;mov	ax,1
  6870                                  	;mov	ax,MoreArgs_Ptr		; set up too many arguments
  6871                                          ;jmp	parse_line_error	; go issue error message
  6872                                  	; 16/04/2023
  6873 0000183B 75AF                    	jnz	short parse_line_error_j
  6874                                  eswitchok:
  6875 0000183D FE06[9520]              	inc	byte [eswitch]		; indicate /E entered 	
  6876                                  
  6877                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  6878                                  	; 15/01/2023 - Retro DOS v4.1 (& v4.1) - MSDOS 5.0 COMMAND.COM
  6879                                  	; MSDOS 6.0
  6880                                  	;mov	di,offset ResGroup:Comnd1_Addr	; get number returned
  6881 00001841 BF[5A21]                        mov	di,COMND1_ADDR
  6882 00001844 8B1D                    	mov     bx,[di]				; into bx
  6883                                  
  6884 00001846 83C30F                  	add	bx,0Fh				; Round up to next paragraph
  6885 00001849 B104                    	mov	cl,4				; convert to pargraphs
  6886 0000184B D3EB                    	shr	bx,cl				; by right 4
  6887                                  
  6888 0000184D 891E[8220]              	mov	[EnvSiz],bx			; EnvSiz is in paragraphs
  6889 00001851 E9B0FE                  	jmp	Parse_command_line		; continue parsing command line
  6890                                  
  6891                                  ; 16/04/2023
  6892                                  %if 0
  6893                                  SetMSwitch:
  6894                                          ;cmp	byte [ext_msg],1
  6895                                  	cmp	byte [ext_msg],SET_EXTENDED_MSG	; has /MSG switch been set?
  6896                                  	jnz	short setMswitchok		; no - set it
  6897                                  	;mov	ax,1
  6898                                  	mov	ax,MoreArgs_Ptr                 ; set up too many arguments
  6899                                  	jmp	parse_line_error                ; go issue error message
  6900                                  setMswitchok:
  6901                                          ;mov	byte [ext_msg],1
  6902                                  	mov	byte [ext_msg],SET_EXTENDED_MSG	; set /MSG switch
  6903                                  	jmp	Parse_command_line              ; keep parsing
  6904                                  %endif
  6905                                  
  6906                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6907                                  %if 1
  6908                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1913h
  6909                                  SetHSwitch:
  6910                                  	;jmp	short load_to_hma_umb	; load COMMAND.COM into HMA/UMB
  6911                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:19CBh
  6912                                  load_to_hma_umb:
  6913                                  	;cmp	byte [520h],0
  6914 00001854 803E[0E04]00            	cmp	byte [COMMAND_HIGH],0
  6915 00001859 741B                    	jz	short set_command_high_flag
  6916                                  parse_line_error_j2: ; 22/07/2024
  6917 0000185B B80100                  	mov	ax,1			; too many parameters
  6918 0000185E E9C1FE                  	jmp	parse_line_error
  6919                                  
  6920                                  ;set_command_high_flag:
  6921                                  ;	inc	byte [COMMAND_HIGH]
  6922                                  ;	jmp     Parse_command_line
  6923                                  
  6924                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1916h
  6925                                  SetOSwitch:
  6926                                  	;jmp	short disable_overwrite_msg
  6927                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:19DFh
  6928                                  disable_overwrite_msg:
  6929 00001861 803E[FA01]63            	cmp	byte [cox_location],'c' ; "cox"
  6930                                  	;jz	short change_cox_to_VCB
  6931                                  	;mov	ax, 1 ; MoreArgs_Ptr
  6932                                  	;jmp	parse_line_error
  6933                                  	; 22/07/2024
  6934 00001866 75F3                    	jnz	short parse_line_error_j2
  6935                                  change_cox_to_VCB:
  6936 00001868 C606[FA01]56            	mov     byte [cox_location],56h ; 'V' ; "VCB"
  6937 0000186D C706[FB01]4342          	mov     word [cox_location+1],4243h ; 'CB'
  6938 00001873 E98EFE                  	jmp     Parse_command_line
  6939                                  
  6940                                  set_command_high_flag:
  6941 00001876 FE06[0E04]              	inc	byte [COMMAND_HIGH]
  6942 0000187A E987FE                  	jmp     Parse_command_line
  6943                                  %endif
  6944                                  
  6945                                  ;ArgsDoneJ:
  6946                                  	;jmp	ArgsDone
  6947                                  
  6948                                  	; 15/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6949                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:181Dh - CODERES:0ADDh)
  6950                                  
  6951                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6952                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:196Dh - CODERES:0B1Dh)
  6953                                  
  6954                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6955                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:19FAh
  6956                                  
  6957                                  ChkOtherArgs:
  6958                                  
  6959                                  ; We have a non-switch character here.
  6960                                  
  6961                                  	; MSDOS 6.0
  6962 0000187D 1E                      	push	ds ; ****			;
  6963 0000187E 56                      	push	si ; *** 			; save place in command line
  6964 0000187F C536[5A21]              	lds	si,[COMND1_ADDR]		; get address of filespec
  6965                                  	;assume	ds:nothing			;
  6966                                  
  6967 00001883 89F2                    	mov	dx,si				; put in dx also
  6968 00001885 B8023D                  	mov	ax,3D02h
  6969                                  	;mov	ax,(OPEN shl 8) or 2            ; Read and write
  6970 00001888 CD21                    	int	21h
  6971 0000188A 7260                    	jc	short ChkSrchSpec		; Wasn't a file
  6972 0000188C 89C3                    	mov	bx,ax
  6973 0000188E B80044                  	mov	ax,4400h
  6974                                  	;mov	ax,IOCTL shl 8
  6975 00001891 CD21                    	int	21h
  6976 00001893 F6C280                  	test	dl,80h
  6977 00001896 7506                    	jnz	short IsaDevice
  6978                                  BadSetCon:
  6979 00001898 B43E                    	mov	ah,3Eh
  6980                                  	;mov	ah,CLOSE		; Close initial handle, wasn't a device
  6981 0000189A CD21                    	int	21h
  6982 0000189C EB4E                    	jmp	short ChkSrchSpec
  6983                                  
  6984                                  	; 15/01/2023
  6985                                  IsaDevice:
  6986                                  	; MSDOS 3.3 & MSDOS 6.0
  6987 0000189E 30F6                    	xor	dh,dh
  6988 000018A0 80CA03                  	or	dl,3				; Make sure has CON attributes
  6989                                  	;mov	ax,(IOCTL shl 8) or 1
  6990 000018A3 B80144                  	mov	ax,(IOCTL*256)|1 ; 4401h
  6991 000018A6 CD21                    	int	21h
  6992                                  	;
  6993                                  	; 15/01/2023
  6994 000018A8 72EE                    	jc	short BadSetCon	; MSDOS 6.0 (& 5.0)
  6995                                  	; 25/09/2018
  6996                                  	;pop	dx ; *
  6997                                  	;pop	dx ; **
  6998                                  	;
  6999                                  	;jc	short BADSETCON	; MSDOS 6.0	; Can't set attributes - quit
  7000                                  	
  7001 000018AA 89DA                    	mov	dx,bx				; Save new handle
  7002                                  
  7003                                  	; MSDOS 6.0
  7004 000018AC 26803E[9A26]01          	cmp	byte [es:DevFlag],1
  7005 000018B2 742A                    	jz	short DevErr
  7006                                  
  7007                                  	; MSDOS 3.3
  7008                                          ;pop	bx ; *				; Throw away saved SI
  7009                                          ;pop	bx ; **				; Throw away saved CX
  7010                                  
  7011                                  	; MSDOS 3.3 & MSDOS 6.0
  7012 000018B4 51                      	push	cx ; **
  7013 000018B5 B90300                  	mov	cx,3
  7014 000018B8 31DB                    	xor	bx,bx
  7015                                  
  7016                                  	; 15/01/2023
  7017                                  rcclloop:
  7018 000018BA B43E                    	mov	ah,3Eh
  7019                                  	;mov	ah,CLOSE ; 3Eh
  7020 000018BC CD21                    	int	21h
  7021 000018BE 43                      	inc	bx
  7022 000018BF E2F9                    	loop	rcclloop
  7023                                  
  7024 000018C1 89D3                    	mov	bx,dx				; New device handle
  7025 000018C3 B445                    	mov	ah,45h
  7026                                  	;mov	ah,XDUP ; 45h
  7027 000018C5 CD21                    	int	21h				; Dup to 0
  7028 000018C7 B445                    	mov	ah,45h
  7029                                  	;mov	ah,XDUP
  7030 000018C9 CD21                    	int	21h				; Dup to 1
  7031 000018CB B445                    	mov	ah,45h
  7032                                  	;mov	ah,XDUP
  7033 000018CD CD21                    	int	21h				; Dup to 2
  7034 000018CF B43E                    	mov	ah,3Eh
  7035                                  	;mov	ah,CLOSE
  7036 000018D1 CD21                    	int	21h				; Close initial handle
  7037                                  	
  7038 000018D3 59                      	pop	cx ; **
  7039                                  	
  7040                                  	; MSDOS 6.0
  7041 000018D4 5E                      	pop	si ; ***			; restore position of command line
  7042 000018D5 1F                      	pop	ds ; ****			;
  7043                                  
  7044                                  ; Register the fact that we already have redirected the output
  7045                                  ; and can not do it again
  7046                                  
  7047 000018D6 26FE06[9A26]            	inc	byte [es:DevFlag]		
  7048 000018DB E926FE                  	jmp	Parse_command_line		; continue parsing
  7049                                  
  7050                                  	; MSDOS 3.3
  7051                                  	;jcxz	ARGSDONEJ2
  7052                                  	;jmp	CHKARG
  7053                                  
  7054                                  	; MSDOS 6.0
  7055                                  DevErr:
  7056 000018DE 5E                      	pop	si ; ***
  7057 000018DF 1F                      	pop	ds ; ****
  7058 000018E0 BA0100                  	mov	dx,1
  7059 000018E3 E8CA03                          call	RPrintParse                     ; "Too many parameters"
  7060 000018E6 E8EFFA                          call	crlf
  7061 000018E9 E918FE                  	jmp	Parse_command_line
  7062                                  
  7063                                  ChkSrchSpec:				; Not a device, so must be directory spec
  7064                                  	; MSDOS 6.0
  7065 000018EC 26803E[9B26]01                  cmp	byte [es:PathFlag],1		; already set COMSPEC?
  7066 000018F2 74EA                            jz	short DevErr			; yes, error
  7067                                  	
  7068 000018F4 26FE06[9B26]                    inc	byte [es:PathFlag]		; mark that we have a path
  7069                                  
  7070                                  ; We have to override the passed environment. Allocate a buffer for use now.
  7071                                  ; This buffer will later be replaced by a proper environment
  7072                                  
  7073                                  	; 15/01/2023 - Retro DOS v4.0 COMMAND.COM
  7074                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1899h
  7075                                  	; 06/06/2023
  7076                                  	;mov	ax,[ss:EnvirSeg]
  7077                                  	
  7078                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7079                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:19E9h
  7080                                  	;
  7081                                  	; MSDOS 6.0
  7082 000018F9 E88F05                  	call	alloc_env                       ; environment buffer
  7083                                  
  7084                                  ; 06/06/2023
  7085                                  %if 0
  7086                                  	; 15/01/2023
  7087                                  	; MSDOS 5.0
  7088                                  	cmp	byte [ss:AllocedEnv],1
  7089                                  	mov	byte [ss:AllocedEnv],0
  7090                                  	jne     short env_alloced
  7091                                  	call	alloc_env
  7092                                  	mov	[ss:EnvirSeg],ax
  7093                                  %endif
  7094                                  
  7095                                  env_alloced:
  7096                                  	; MSDOS 5.0 & MSDOS 6.0
  7097 000018FC 8EC0                    	mov	es,ax
  7098                                  	;assume	es:nothing
  7099 000018FE 56                      	push	si ; **				; remember location of file
  7100 000018FF 31C9                    	xor	cx,cx				; clear cx for counting
  7101                                  	
  7102                                  	; 15/01/2023
  7103                                  countloop:
  7104 00001901 AC                      	lodsb					; get a character
  7105 00001902 41                      	inc	cx				; increment counter
  7106                                          ;;cmp	al,0
  7107                                  	;cmp	al,END_OF_LINE_OUT              ; are we at end of line?
  7108                                  	;jne	short countloop			; no - keep counting
  7109 00001903 08C0                    	or	al,al	
  7110 00001905 75FA                    	jnz	short countloop
  7111                                  	; 06/03/2023
  7112                                  	; al = 0 ; (*) 
  7113                                  
  7114                                  	;;;;mov	al,[Space]
  7115                                  	;;;mov	al,[ss:Space] ; 15/01/2023 - MSDOS 5.0 COMMAND.COM
  7116                                  	;;mov	al,space_chr ; Retro DOS v4.0 (& v4.1) COMMAND.COM
  7117                                  	; 16/04/2023
  7118                                  	;mov	al,20h ; ' ' 
  7119 00001907 4E                      	dec	si				; move back one
  7120                                          ;mov	[si],al				; put a space at end of line
  7121 00001908 C60420                  	mov	byte [si],20h ; ' ' ; space_chr
  7122                                  
  7123                                  ; We now know how long the new pathspec for command.com is. Time to
  7124                                  ; figure out how long the current COMSPEC setting is, and then to move
  7125                                  ; all the environment data up, throwing that COMSPEC setting away, and
  7126                                  ; preparing to append the new COMSPEC. ComspOffset (the offset of
  7127                                  ; where the filespec exists in the environment) is updated as well.
  7128                                  
  7129                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7130                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:19FEh
  7131                                  
  7132                                  	; MSDOS 6.0
  7133 0000190B 51                      	push	cx ; * 				;
  7134 0000190C B90080                          mov	cx,ENVBIG ; 32768		;
  7135 0000190F 368B3E[6B20]                    mov	di,[ss:ComspOffset]		; get location of COMSPEC
  7136                                          ;mov	al,0                            ;
  7137                                  	; 06/06/2023
  7138                                  	; al = 0 ; (*)
  7139 00001914 F2AE                    	repne	scasb                           ; find the end of COMSPEC
  7140 00001916 89FE                            mov	si,di                           ;
  7141                                  comp_endenv:					;
  7142 00001918 AE                      	scasb					; end of env?
  7143 00001919 7404                    	je	short got_endenv		; yes
  7144 0000191B F2AE                    	repne	scasb				;
  7145 0000191D EBF9                    	jmp	short comp_endenv		;
  7146                                  got_endenv:					;
  7147 0000191F 89F9                    	mov	cx,di				;
  7148 00001921 29F1                    	sub	cx,si				;
  7149 00001923 368B3E[6B20]            	mov	di,[ss:ComspOffset]		;
  7150 00001928 83EF08                  	sub	di,ComspStrLen	; sub di,8	;
  7151 0000192B 1E                      	push	ds ; +				;
  7152 0000192C 06                      	push	es				;
  7153 0000192D 1F                      	pop	ds				;
  7154 0000192E F3A4                    	rep	movsb				;
  7155 00001930 4F                      	dec	di				; copy in new COMSPEC=
  7156 00001931 0E                      	push	cs				;
  7157 00001932 1F                      	pop	ds				;
  7158                                          ;assume ds:RESGROUP			;
  7159                                  	;mov    si,offset RESGROUP:ComspString	;
  7160 00001933 BE[6D20]                	mov	si,ComspString			; "COMSPEC=\COMMAND.COM"
  7161                                  	;mov	cx,ComspStrLen	; mov cx,8	;
  7162 00001936 B108                            mov	cl,ComspStrLen	; mov cl,8
  7163 00001938 F3A4                    	rep	movsb				;
  7164 0000193A 893E[6B20]              	mov	[ComspOffset],di		;
  7165 0000193E 1F                      	pop	ds ; + 				;
  7166                                          ;assume ds:nothing			;
  7167 0000193F 59                      	pop	cx ; *				;
  7168                                  	;
  7169 00001940 5E                      	pop	si ; **				; get new comspec location back
  7170                                  
  7171                                  	;; MSDOS 3.3 COMMAND.COM
  7172                                  	;;mov	byte [CHUCKENV],0		; If search specified -- no inheritance
  7173                                  	;;mov	ax,PATHSTRING	; "PATH="	; Figure environment pointer
  7174                                  	;;mov	cl,4
  7175                                  	;;shr	ax,cl
  7176                                  	;;mov	dx,ds
  7177                                  	;;add	ax,dx
  7178                                  	;;mov	[ENVIRSEG],ax
  7179                                  	;;mov	es,ax
  7180                                  	;;;mov	al,' '
  7181                                  	;;mov	al,[SPACE_CHR]
  7182                                  	;;mov	[si-1],al
  7183                                  	;;pop	si ; **				; Remember location
  7184                                  	;;pop	cx ; *				; and count
  7185                                  	;;;mov	di,[ECOMLOC]
  7186                                  	;;mov	di,[COMSPOFFSET]
  7187                                  
  7188                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7189                                  	;; 15/01/2023
  7190                                  	;; MSDOS 5.0 COMMAND.COM
  7191                                  	;pop	si ; **
  7192                                  	;;mov	di,14
  7193                                  	;mov	di,ECOMSPEC ; mov di,0Eh
  7194                                  
  7195                                  ComtrLoop:
  7196                                  	; MSDOS 3.3 & MSDOS 6.0
  7197 00001941 AC                      	lodsb
  7198 00001942 49                      	dec	cx
  7199                                  	;;;;cmp	al,' '
  7200                                  	;;;cmp	al,[space_chr]
  7201                                  	;;cmp	al,[ss:Space] ;  MSDOS 5.0 COMMAND.COM
  7202                                  	;cmp	al,space_chr ; Retro DOS v4.0 (& v4.1) COMMAND.COM
  7203                                  	; 16/04/2023
  7204 00001943 3C20                    	cmp	al,20h ; ' ' ; space_chr
  7205 00001945 7416                    	je	short SetComsr
  7206                                  	; MSDOS 3.3
  7207                                  	;cmp	al,9
  7208                                  	;je	short SetComsr
  7209                                  	; MSDOS 3.3 & MSDOS 6.0
  7210 00001947 AA                      	stosb
  7211                                  
  7212                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7213                                  %if 1
  7214                                  ;ifdef	DBCS
  7215 00001948 30E4                    	xor	ah,ah
  7216                                  ;endif
  7217                                  %endif
  7218 0000194A E311                    	jcxz	SetComsr
  7219                                  
  7220                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7221                                  %if 1
  7222                                  ;ifdef DBCS
  7223 0000194C 1E                      	push	ds				; Make sure we have
  7224 0000194D 0E                      	push	cs				;  local DS for
  7225 0000194E 1F                      	pop	ds				;  ItestKanj
  7226 0000194F E82BFB                  	call	ITestKanj
  7227 00001952 1F                      	pop	ds				; restore parser ds
  7228 00001953 74EC                    	jz	short ComtrLoop
  7229 00001955 49                      	dec	cx
  7230 00001956 A4                      	movsb
  7231 00001957 FEC4                    	inc	ah
  7232 00001959 E302                    	jcxz	SetComsr
  7233                                  ;endif
  7234                                  %endif
  7235 0000195B EBE4                    	jmp	short ComtrLoop
  7236                                  
  7237                                  SetComsr:
  7238                                  	; 15/01/2023
  7239                                  	; MSDOS 6.0
  7240 0000195D 51                      	push	cx ; **
  7241 0000195E 0E                      	push	cs				; Get local segment
  7242 0000195F 1F                      	pop	ds				;
  7243                                  	;assume	ds:ResGroup			;
  7244 00001960 1E                      	push	ds ; *
  7245                                  	;mov	si,offset ResGroup:ComSpect
  7246 00001961 BE[2820]                	mov	si,COMSPECT ; "\COMMAND.COM"
  7247 00001964 B90E00                  	mov	cx,14
  7248 00001967 268A45FF                	mov	al,[es:di-1]
  7249                                  
  7250                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7251                                  %if 1
  7252                                  ;ifdef DBCS
  7253 0000196B 08E4                    	or	ah,ah
  7254 0000196D 7508                    	jnz	short iNotRoot			; Last char was KANJI second byte, might be '\'
  7255                                  ;endif
  7256                                  %endif
  7257 0000196F 3A06[4F04]              	cmp	al,[RDirChar]
  7258 00001973 7502                    	jne	short iNotRoot
  7259 00001975 46                      	inc	si				; Don't make a double /
  7260 00001976 49                      	dec	cx
  7261                                  	
  7262                                  	; MSDOS 3.37
  7263                                  	;push	si
  7264                                  	;push	cx
  7265                                  	;push	ds
  7266                                  	;mov	si,COMSPECT ; "/COMMAND.COM"
  7267                                  	;mov	cx,14
  7268                                  	;mov	al,[es:di-1]
  7269                                  	;call	PATHCHRCMPR
  7270                                  	;jnz	short INOTROOT			
  7271                                  	;inc	si				; Don't make a double /
  7272                                  	;dec	cx
  7273                                  
  7274                                  iNotRoot:
  7275                                  	; MSDOS 3.3 & MSDOS 6.0
  7276 00001977 F3A4                    	rep	movsb
  7277                                  
  7278                                  	;;mov	dx,[ECOMLOC]			; Now lets make sure its good!
  7279                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7280                                  	; MSDOS 6.0 
  7281 00001979 8B16[6B20]              	mov	dx,[ComspOffset] ; [COMSPOFFSET]
  7282                                  	; 15/01/2023
  7283                                  	;;mov	dx,14
  7284                                  	;mov	dx,ECOMSPEC ; mov dx,0Eh ; MSDOS 5.0 COMMAND.COM
  7285                                  
  7286 0000197D 06                      	push	es
  7287 0000197E 1F                      	pop	ds
  7288                                  	;;mov	ax,OPEN shl 8
  7289                                  	;mov	ax,OPEN*256 ; 3D00h
  7290 0000197F B8003D                  	mov	ax,3D00h ; 15/01/2023
  7291 00001982 CD21                    	int	21h				; Open COMMAND.COM
  7292 00001984 1F                      	pop	ds ; *
  7293 00001985 720E                    	jc	short SetComsrBad		; No COMMAND.COM here
  7294 00001987 89C3                    	mov	bx,ax				; Handle
  7295 00001989 B43E                    	mov	ah,3Eh ; 15/01/2023
  7296                                  	;mov	ah,CLOSE ; 3Eh
  7297 0000198B CD21                    	int	21h				; Close COMMAND.COM
  7298                                  SetComsrRet:
  7299                                  	; 15/01/2023
  7300 0000198D 59                      	pop	cx ; **
  7301 0000198E 5E                      	pop	si ; ***
  7302                                  
  7303                                  	; MSDOS 6.0
  7304 0000198F 1F                      	pop	ds ; ****			;
  7305                                  	;assume	ds:ResGroup			;
  7306                                  	;
  7307 00001990 0E                      	push	cs				; Make sure local ES is
  7308 00001991 07                      	pop	es				;  restored
  7309 00001992 E96FFD                  	jmp	Parse_command_line		; continue parsing command line
  7310                                  
  7311                                  	; MSDOS 3.3
  7312                                  ;ARGSDONEJ2:
  7313                                  	;jcxz	ARGSDONE
  7314                                  	;jmp	CHKARG
  7315                                  
  7316                                  	; 16/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7317                                  SetComsrBad:
  7318                                  	; MSDOS 3.3 & MSDOS 6.0
  7319                                  	;mov	dx,offset ResGroup:BadComlkMsg	; dx = ptr to msg
  7320 00001995 BA[FB21]                	mov	dx,BADCOMLKMES
  7321                                  
  7322                                  ;	Note: we're about to make a near call to TriageError, which
  7323                                  ;	lives in a different segment and group. Some linkers will
  7324                                  ;	generate a warning like "Possible fix-up overflow". We're
  7325                                  ;	ok, though, because we all fit in 64 KB and, at init time,
  7326                                  ;	we're still all together.
  7327                                  
  7328                                  	; 16/01/2023
  7329                                  	;TRIAGEERROR equ TRANSTART+TriageError
  7330                                  	;(MSDOS 5.0 COMMAND.COM, 2320h+2D92h)
  7331                                  
  7332                                  	; 06/06/2023
  7333                                  	TRIAGEERROR equ TRANSTART+TriageError
  7334                                  	;(MSDOS 6.22 COMMAND.COM, 26E0h+333Ch)
  7335                                  
  7336                                  	;;;call	50B2h ; MSDOS 5.0 COMMAND.COM
  7337                                  	;;call	5A1Ch ; MSDOS 6.22 COMMAND.COM
  7338                                  	; 18/07/2024
  7339                                  	;call	5A6Ch ; PCDOS 7.1 COMMAND.COM	
  7340 00001998 E8(7D58)                	call	TRIAGEERROR	; TRIAGEERROR procedure is at offset 354Eh
  7341                                  				; in original MSDOS 3.3 COMMAND.COM
  7342                                  
  7343                                  			; TriageError procedure is at offset 50B2h
  7344                                  			; in original MSDOS 5.0 COMMAND.COM	
  7345 0000199B 83F841                  	cmp	ax,65
  7346 0000199E 7503                    	jne	short doprt
  7347                                  	;mov	dx,offset ResGroup:BadComaccMsg	; dx = ptr to msg
  7348 000019A0 BA[2422]                	mov	dx,BADCOMACCMSG
  7349                                  doprt:
  7350 000019A3 E835FA                  	call	RPrint
  7351                                  	;mov	si,offset ResGroup:ComSpect
  7352 000019A6 BE[2820]                	mov     si,COMSPECT ; "\COMMAND.COM"
  7353                                  	;;mov	di,[ECOMLOC]
  7354                                  	; 06/06/2023
  7355 000019A9 8B3E[6B20]              	mov	di,[ComspOffset] ; MSDOS 6.22 COMMAND.COM
  7356                                  	; 16/01/2023
  7357                                  	;mov	di,ECOMSPEC ; mov di,0Eh ; MSDOS 5.0 COMMAND.COM
  7358 000019AD B90E00                  	mov	cx,14
  7359 000019B0 F3A4                    	rep	movsb				; get my default back
  7360                                  
  7361 000019B2 EBD9                    	jmp	short SetComsrRet
  7362                                  
  7363                                  	; 16/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7364                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1927h (CODERES:0BE7h)
  7365                                  
  7366                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7367                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1A99h (CODERES:0C49h)
  7368                                  ArgsDone:
  7369                                  	; MSDOS 6.0
  7370 000019B4 8E06[3A04]              	mov	es,[EnvirSeg]			; get environment back
  7371                                  	;assume	es:nothing			;
  7372                                  
  7373                                  	; MSDOS 3.3 & MSDOS 6.0
  7374 000019B8 803E[A202]00                    cmp	byte [PermCom],0
  7375 000019BD 742E                            jz	short ComReturns
  7376                                  
  7377 000019BF 06                      	push	es				; Save environment pointer
  7378 000019C0 B450                    	mov	ah,50h
  7379                                  	;mov	ah,SET_CURRENT_PDB ; 50h
  7380 000019C2 8CDB                    	mov	bx,ds
  7381 000019C4 8EC3                    	mov	es,bx
  7382 000019C6 CD21                    	int	21h				; current process is me
  7383 000019C8 BF0A00                  	mov	di,PDB.EXIT ; mov di,0Ah	; Diddle the addresses in my header
  7384                                  	;;mov	ax,offset RESGROUP:LODCOM
  7385                                  	;mov	ax,LODCOM
  7386                                  	; 16/01/2023
  7387 000019CB B8[E000]                	mov	ax,LodCom_Trap
  7388 000019CE AB                              stosw
  7389 000019CF 8CD8                            mov	ax,ds
  7390 000019D1 AB                              stosw
  7391                                  	;;mov	ax,offset RESGROUP:CONTC
  7392                                  	;mov	ax,CONTC
  7393                                  	; 16/01/2023
  7394 000019D2 B8[AC00]                	mov	ax,Ctrlc_Trap
  7395 000019D5 AB                              stosw
  7396 000019D6 8CD8                            mov	ax,ds
  7397 000019D8 AB                              stosw
  7398                                  	;;mov	ax,offset DATARES:CritErr_Trap  ; MSDOS 6.0
  7399                                  	;mov	ax,CRITERR
  7400                                  	; 16/01/2023
  7401 000019D9 B8[B700]                	mov	ax,CritErr_Trap
  7402 000019DC AB                      	stosw
  7403 000019DD 8CD8                    	mov     ax,ds
  7404 000019DF AB                      	stosw
  7405                                  	;;mov	word ptr ds:16h,ds
  7406                                  	;mov	word ptr ds:[Pdb_Parent_Pid],ds ; Parent is me forever
  7407 000019E0 8C1E1600                	mov	[PDB.PARENT_PID],ds
  7408                                          ;;mov	dx,offset RESGROUP:Int_2e
  7409                                  	;mov	dx,Int_2e
  7410                                          ; 16/01/2023
  7411 000019E4 BA[A100]                	mov	dx,Int2e_Trap
  7412 000019E7 B82E25                  	mov	ax,252Eh
  7413                                  	;;mov	ax,(SET_INTERRUPT_VECTOR SHL 8) OR 2Eh
  7414                                  	;mov	ax,(SET_INTERRUPT_VECTOR*256) | 2Eh ; 252Eh
  7415 000019EA CD21                    	int     21h	; DOS - SET INTERRUPT VECTOR
  7416                                  			; AL = interrupt number
  7417                                  			; DS:DX = new vector to be used for specified interrupt
  7418 000019EC 07                              pop	es				; Remember environment
  7419                                  	
  7420                                  ComReturns:
  7421                                          ;mov	ax,word ptr ds:Pdb_Parent_Pid
  7422 000019ED A11600                  	mov	ax,[PDB.PARENT_PID] ; mov ax,ds:16h
  7423                                  	; 16/01/2023
  7424 000019F0 A3[3E02]                	mov	[Parent],ax			; Save parent
  7425                                          ;mov	word ptr ds:Pdb_Parent_Pid,ds 	; Parent is me
  7426 000019F3 8C1E1600                        mov	[PDB.PARENT_PID],ds ; mov word ptr ds:16h,ds
  7427                                          ;mov	ax,word ptr ds:PDB_Jfn_Table
  7428 000019F7 A11800                          mov	ax,[PDB.JFN_TABLE] ; mov ax,ds:18h
  7429 000019FA A3[9F02]                        mov	[Io_Save],ax		; Get the default stdin and out
  7430 000019FD 8C1E[3E04]                      mov	[Com_Ptr+2],ds		; Set all these to resident
  7431 00001A01 8C1E[4204]                      mov	[Com_Fcb1+2],ds
  7432 00001A05 8C1E[4604]              	mov	[Com_Fcb2+2],ds
  7433                                          ;mov	di,offset ResGroup:ComSpec
  7434 00001A09 BF[4B02]                        mov	di,ComSpec
  7435                                  
  7436                                  	;;mov	si,[ECOMLOC]
  7437                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  7438 00001A0C 8B36[6B20]              	mov	si,[ComspOffset]
  7439                                  	; 16/01/2023 - MSDOS 5.0 COMMAND.COM
  7440                                  	;mov	si,ECOMSPEC ; mov si,0Eh
  7441                                  
  7442 00001A10 803E[5420]00            	cmp	byte [AllocedEnv],0 ; MSDOS 6.0
  7443                                          ;cmp	byte [CHUCKENV],0 ; MSDOS 3.3
  7444                                  	
  7445 00001A15 8CD8                    	mov	ax,ds				; Xchg es,ds
  7446 00001A17 06                      	push	es
  7447 00001A18 1F                      	pop	ds
  7448 00001A19 8EC0                    	mov	es,ax
  7449                                  
  7450                                  	; 06/06/2023
  7451 00001A1B 7517                    	jne	short CopyComsp ; MSDOS 6.0
  7452                                  	; 16/01/2023	
  7453                                  	;je	short CopyComsp ; MSDOS 5.0
  7454                                  	;;je	short COPYCOMSP	; MSDOS 3.3	; All set up for copy
  7455                                  
  7456 00001A1D 0E                              push	cs
  7457 00001A1E 1F                              pop	ds
  7458                                  
  7459                                          ;mov	si,offset ResGroup:ComspString
  7460 00001A1F BE[6D20]                	mov	si,ComspString ; "COMSPEC=\COMMAND.COM"
  7461 00001A22 06                      	push	es
  7462 00001A23 57                      	push	di
  7463 00001A24 E89A02                  	call	IfindE
  7464 00001A27 89FE                    	mov	si,di
  7465 00001A29 06                      	push	es
  7466 00001A2A 1F                      	pop	ds
  7467 00001A2B 5F                      	pop	di
  7468 00001A2C 07                      	pop	es
  7469 00001A2D 7305                            jnc	short CopyComsp
  7470                                  
  7471                                  	; 06/06/2023
  7472                                  	; MSDOS 6.0
  7473                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1B04h
  7474                                  ComSpecNofnd:
  7475                                  	;;mov	si,offset ResGroup:ComspString
  7476                                  	;mov	si,ComspString ; "COMSPEC=\COMMAND.COM"
  7477                                  	;add	si,ComspStrLen ; add si,8
  7478 00001A2F BE[7520]                	mov	si,ComspString+ComspStrLen
  7479                                  	
  7480                                  	;; 21/01/2023
  7481                                  	;; MSDOS 5.0 COMMAND.COM - RESGROUP:19A1h
  7482                                  	;;mov	si,0Eh
  7483                                  	;mov	si,ECOMSPEC
  7484                                  	
  7485 00001A32 0E                      	push	cs
  7486 00001A33 1F                      	pop	ds	
  7487                                  
  7488                                  	; 21/01/2023
  7489                                  ;COMSPECNOFND:
  7490                                  	; MSDOS 3.3
  7491                                          ;;mov	si,[es:ECOMLOC]
  7492                                          ;mov	si,[es:COMSPOFFSET]
  7493                                  	;;add	si,offset RESGROUP:PATHSTRING
  7494                                          ;add	si,PATHSTRING ; "PATH="
  7495                                  	;push	cs
  7496                                  	;pop	ds
  7497                                  
  7498                                  CopyComsp:
  7499                                  	; 21/01/2023
  7500                                  ;COPYCOMSP:
  7501                                  	; MSDOS 3.3 & MSDOS 6.0
  7502                                  	;;mov	es:PutBackComSpec.SubstPtr,di
  7503                                  	;mov	[es:PUTBACKSUBSTPTR],di		; Save ptr to beginning of comspec path
  7504 00001A34 26893E[2A02]            	mov	[es:PutBackComSpec],di
  7505 00001A39 807C013A                	cmp	byte [si+1],':'			; Is there a drive specifier in comspec
  7506 00001A3D 7506                    	jne	short CopyComspLoop		; If not, do not skip over first 2 bytes
  7507                                  	;;add	es:PutBackComSpec.SubstPtr,2
  7508                                  	;add	word [es:PUTBACKSUBSTPTR],2
  7509 00001A3F 268306[2A02]02          	add	word [es:PutBackComSpec],2
  7510                                  CopyComspLoop:
  7511 00001A45 AC                      	lodsb
  7512 00001A46 AA                      	stosb
  7513 00001A47 08C0                    	or	al,al
  7514 00001A49 75FA                    	jnz	short CopyComspLoop
  7515                                  
  7516 00001A4B 26893E[8B02]            	mov	[es:ComSpec_End],di		; Save ptr to end of comspec path
  7517 00001A50 26FF0E[8B02]            	dec	word [es:ComSpec_End]
  7518 00001A55 268A26[9402]            	mov	ah,[es:ComDrv]
  7519 00001A5A 80C440                  	add	ah,'A'-1 ; 40h
  7520 00001A5D 268826[2F02]            	mov	[es:PutBackDrv],ah		; save drive letter
  7521                                  
  7522                                  	; 21/01/2023 - Retrro DOS v4.0 (& v4.1) COMMAND.COM
  7523                                  	
  7524                                  	; MSDOS 6.0
  7525 00001A62 E8E702                  	call	setup_for_messages		; set up parse and extended error messages
  7526                                  
  7527                                  ; The routine below sets up the exact resident size of COMMAND. If this is not
  7528                                  ; the first COMMAND, then the resident code is not duplicated and the resident
  7529                                  ; size is just the data. If we are the first COMMAND, it checks if we are to
  7530                                  ; be loaded into HIMEM. If not, then the resident size includes the code and
  7531                                  ; the data otherwise it is just the data.
  7532                                   
  7533 00001A65 E88603                  	call	Setup_res_end			; put resident size in ResSize
  7534                                  
  7535 00001A68 0E                      	push	cs
  7536 00001A69 1F                      	pop	ds
  7537                                  	;assume	ds:RESGROUP
  7538                                  
  7539                                  ;Public EnvMaximum
  7540                                          ; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7541                                  EnvMaximum:	; MSDOS 5.0 COMMAND.COM - RESGROUP:19DCh
  7542                                          ; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7543                                  		; MSDOS 6.22 COMMAND.COM - RESGROUP:1B53h
  7544                                          ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  7545                                  		; PCDOS 7.1 COMMAND.COM - RESGROUP:1B53h
  7546                                  
  7547                                  	; 21/01/2023
  7548                                  	; MSDOS 6.0
  7549                                  	;;mov	si,offset RESGROUP:TranStart
  7550                                  	;;mov	si,2320h	; MSDOS 5.0 COMMAND.COM
  7551                                  	; 06/06/2023
  7552                                  	;;mov	si,26E0h	; MSDOS 6.22 COMMAND.COM
  7553                                  	;mov	si,TRANSTART
  7554                                  	;add	si,100h
  7555                                  	; 23/04/2023
  7556 00001A6A BED028                  	mov	si,TRANSTART+100h
  7557                                  
  7558                                  	;;mov	cx,offset TRANGROUP:TranDataEnd - 100H
  7559                                  	;;mov	cx,87C2h	; MSDOS 5.0 COMMAND.COM
  7560                                  	; 06/06/2023
  7561                                  	;;mov	cx,9D53h	; MSDOS 6.22 COMMAND.COM
  7562                                  	; 18/07/2024
  7563                                  	;mov	cx,9B47h	; PCDOS 7.1 COMMAND.COM	
  7564 00001A6D B9[B896]                	mov	cx,TRANDATAEND-100h
  7565                                  
  7566 00001A70 FC                      	cld
  7567 00001A71 D1E9                    	shr	cx,1
  7568 00001A73 31D2                    	xor	dx,dx
  7569                                  Ichksum:
  7570 00001A75 AD                      	lodsw
  7571 00001A76 01C2                    	add	dx,ax
  7572 00001A78 83D200                  	adc	dx,0
  7573 00001A7B E2F8                    	loop	Ichksum
  7574                                  
  7575 00001A7D 8916[9702]                      mov	[Sum],dx			; store checksum
  7576                                  
  7577 00001A81 803E[4720]00                    cmp     byte [PRDATTM],0
  7578 00001A86 750C                            jne	short NoBatchSeg		; don't do autoexec or date time
  7579                                  	
  7580                                  ; Allocate batch segment for d:/autoexec.bat + no arguments
  7581                                  
  7582                                  	;mov	bx,((SIZE BatchSegment) + 15 + 1 + 0fh)/16
  7583                                  	; 21/01/2023
  7584                                  	;mov	bx,4
  7585 00001A88 BB0400                          mov	bx,((BATCHSEGMENT.SIZE)+16+0Fh)/16 ; (33+16+15)/16
  7586 00001A8B B448                    	mov	ah,48h
  7587                                  	;mov	ah,ALLOC                        ;
  7588 00001A8D CD21                            int	21h                             ;
  7589 00001A8F 7203                    	jc	short NoBatchSeg		; didn't allocate - pretend no batch
  7590 00001A91 A3[4902]                        mov	[Batch],ax			; save batch segment
  7591                                  
  7592                                  NoBatchSeg:
  7593                                  	; 21/01/2023
  7594                                  	; MSDOS 6.0 (& MSDOS 5.0)
  7595 00001A94 8B1E[3A04]              	mov	bx,[EnvirSeg]			; get old environment segment
  7596 00001A98 891E[8620]              	mov	[OldEnv],bx			; save it
  7597 00001A9C C706[8820]0000          	mov	word [UsedEnv],0		; initialize env size counter
  7598 00001AA2 8EDB                    	mov	ds,bx
  7599                                  	;assume	ds:nothing
  7600                                  	
  7601 00001AA4 31F6                    	xor	si,si
  7602 00001AA6 89F7                    	mov	di,si
  7603                                  
  7604                                  ; This is the maximum allowed size for the environment
  7605                                  
  7606                                  	; 21/01/2023
  7607                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1A1Eh
  7608                                  	;mov	bx,4096 - 1 ; 0FFFh		; max. allowed env. size
  7609                                  	;;mov	[ss:EnvMax],bx
  7610                                  	;shl	bx,1
  7611                                  	;shl	bx,1
  7612                                  	;shl	bx,1
  7613                                  	;shl	bx,1
  7614 00001AA8 BBF0FF                  	mov	bx,(4096-1)<<4 ; mov bx,0FFF0h
  7615 00001AAB 36891E[8420]            	mov	[ss:EnvMax], bx			; convert envmax to bytes
  7616 00001AB0 4B                      	dec	bx				; dec by one to leave room for double 0
  7617 00001AB1 31D2                    	xor	dx,dx				; use dx to indicate that there was
  7618                                  						; no environment size error.
  7619                                  ;public NxtStr
  7620                                  NxtStr:
  7621 00001AB3 E8E101                  	call	GetStrLen			; get the size of the current env string
  7622                                  
  7623                                  ;Bugbug: Can use ss here to address UsedEnv
  7624                                  
  7625 00001AB6 1E                      	push	ds                              ; get addressability to environment
  7626 00001AB7 0E                              push	cs                              ;                       counter
  7627 00001AB8 1F                              pop	ds                              ;
  7628                                  	;assume	ds:ResGroup
  7629 00001AB9 010E[8820]                      add	[UsedEnv],cx			; add the string length to env size
  7630 00001ABD 1F                      	pop	ds                              ;
  7631                                  	;assume	ds:nothing
  7632                                  	
  7633 00001ABE 83F901                  	cmp	cx,1				; end of environment was encountered.
  7634 00001AC1 7405                    	je	short EnvExit
  7635 00001AC3 29CB                    	sub	bx,cx
  7636                                  	;jae	short OkCpyStr			; can't fit in all of enviroment.
  7637                                  	; 21/01/2023
  7638 00001AC5 73EC                    	jae	short NxtStr
  7639 00001AC7 42                      	inc	dx				; out of env space msg must be displayed
  7640                                  	;jmp	short EnvExit
  7641                                  
  7642                                  ;OkCpyStr:
  7643                                  	;jmp	short NxtStr
  7644                                  
  7645                                  EnvExit:
  7646 00001AC8 0E                      	push	cs
  7647 00001AC9 1F                      	pop	ds
  7648                                  	;assume	ds:ResGroup
  7649 00001ACA 09D2                    	or	dx,dx				; dx will be non-zero if error
  7650 00001ACC 7406                    	jz	short EnvNoErr
  7651                                  	;mov	dx,offset ResGroup:OutEnvMsg	; dx = ptr to msg
  7652 00001ACE BA[7B21]                	mov	dx,OUTENVMSG
  7653 00001AD1 E807F9                  	call 	RPrint
  7654                                  EnvNoErr:
  7655 00001AD4 A1[8220]                	mov	ax,[EnvSiz]			; env size previously set
  7656 00001AD7 B104                    	mov	cl,4
  7657 00001AD9 D3E0                    	shl	ax,cl				; get size in bytes
  7658 00001ADB 3B06[8820]              	cmp	ax,[UsedEnv]			; is it a new env?
  7659 00001ADF 7706                    	ja	short st_envsize		; yes, store the size
  7660 00001AE1 A1[8820]                	mov	ax,[UsedEnv]
  7661 00001AE4 83C00F                  	add	ax,15				; round up
  7662                                  st_envsize:	
  7663 00001AE7 D3E8                    	shr	ax,cl
  7664 00001AE9 A3[8220]                	mov	[EnvSiz],ax			; store env size needed(paras)
  7665                                  
  7666                                  ;if MSVER
  7667                                  	;cmp	SingleCom,0
  7668                                  	;jnz	nophead 			; don't print header if SingleCom
  7669                                  	;mov	dx,offset ResGroup:CopyrightMsg	; dx = ptr to msg
  7670                                  	;call	RPrint
  7671                                  ;nophead:
  7672                                  ;endif
  7673                                  	; 21/01/2023
  7674                                  
  7675                                  	; MSDOS 3.3 & 6.0
  7676 00001AEC 833E[4902]00            	cmp     word [Batch],0		; did we set up a batch segment?
  7677 00001AF1 7503                    	jnz     short DoDate		; yes - go initialize it
  7678 00001AF3 E99300                  	jmp     NoDttm			; don't do autoexec or date time
  7679                                  
  7680                                  DoDate:
  7681                                  
  7682                                  ; allocate batch segment for d:/autoexec.bat + no arguments
  7683                                  
  7684 00001AF6 A1[4902]                	mov	ax,[Batch]		; get batch segment
  7685 00001AF9 C606[9D02]03            	mov	byte [EchoFlag],3	; set batch echo
  7686 00001AFE C706[AE02]0100          	mov	word [Nest],1		; set nest flag to 1 batch
  7687 00001B04 8EC0                    	mov	es,ax
  7688                                  
  7689                                  ; initialize the segment
  7690                                  
  7691 00001B06 31FF                    	xor	di,di
  7692                                  	;;mov	al,0
  7693                                  	;mov	al,BATCHTYPE ; 0
  7694                                  	; 06/06/2023
  7695 00001B08 31C0                    	xor	ax,ax
  7696 00001B0A AA                      	stosb
  7697                                  	;mov	al,1			; initialize echo for batch exit
  7698                                  	;inc	al
  7699                                  	; 22/07/2024
  7700 00001B0B 40                      	inc	ax
  7701 00001B0C AA                      	stosb
  7702                                  
  7703                                  ; Hosebag! This guy does not use the struct fields to init the BatchSegment
  7704                                  
  7705                                  	;xor	ax,ax			; initialize to zero
  7706                                  	; 06/06/2023
  7707                                  	;dec	al ; ax = 0
  7708                                  	; 22/07/2024
  7709 00001B0D 48                      	dec	ax
  7710                                  
  7711                                  	; 21/01/2023
  7712 00001B0E AA                      	stosb	; MSDOS 6.0 		; clear out BatchEOF
  7713                                  
  7714 00001B0F AB                      	stosw				; batch segment of last job - batlast
  7715 00001B10 AB                      	stosw				; segment for FOR
  7716 00001B11 AA                      	stosb				; FOR flag
  7717 00001B12 AB                      	stosw				; position in file - batseek
  7718 00001B13 AB                      	stosw
  7719                                  
  7720                                  ; clean out the parameters
  7721                                  
  7722                                  	;mov	ax,-1			; initialize to no parameters
  7723                                  	; 06/06/2023
  7724 00001B14 48                      	dec	ax ; ax = -1
  7725                                  
  7726 00001B15 B90A00                  	mov	cx,10
  7727 00001B18 F3AB                    	rep	stosw
  7728                                  
  7729                                  ; decide whether we should grab the default drive
  7730                                  
  7731 00001B1A 803E[3620]00            	cmp	byte [AUTOBAT],0 ; ":\AUTOEXEC.BAT"
  7732 00001B1F 7509                    	jne	short NoAutSet
  7733 00001B21 B419                    	mov	ah,19h	; 21/01/2023
  7734                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
  7735 00001B23 CD21                    	int	21h
  7736                                  	;;add	al,'A'
  7737                                  	;add	al,[letter_A] ; Ucasea
  7738                                  	;add	al,[ucasea] ; 21/01/2023
  7739                                  	; 21/01/2023
  7740 00001B25 0441                    	add	al,'A'
  7741 00001B27 A2[3620]                	mov	[AUTOBAT],al
  7742                                  
  7743                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7744                                  %if 0
  7745                                  	; 21/01/2023
  7746                                  	; 06/06/2023
  7747                                  	mov	[KAUTOBAT],al
  7748                                  %endif
  7749                                  
  7750                                  NoAutSet:
  7751                                  
  7752                                  ; copy in the batch file name (including nul)
  7753                                  
  7754                                  	;mov	si,offset ResGroup:AutoBat
  7755 00001B2A BE[3620]                	mov	si,AUTOBAT
  7756 00001B2D B90800                  	mov	cx,8
  7757 00001B30 F3A5                    	rep	movsw
  7758                                  	; 23/04/2023
  7759 00001B32 A4                      	movsb	; MSDOS 6.0		; move in carriage return to terminate string
  7760                                  
  7761                                  	;mov	dx,offset ResGroup:AutoBat
  7762 00001B33 BA[3620]                	mov     dx,AUTOBAT ; ":\AUTOEXEC.BAT"
  7763                                  
  7764                                  	;;mov	ax,OPEN shl 8
  7765 00001B36 B8003D                  	mov	ax,3D00h ; 21/01/2023
  7766                                  	;mov	ax,OPEN*256 ; 3D00h	; open for read
  7767 00001B39 CD21                    	int	21h			; see if autoexec.bat exists
  7768 00001B3B 7208                    	jc	short noabat
  7769 00001B3D 89C3                    	mov	bx,ax
  7770 00001B3F B43E                    	mov	ah,3Eh ; 21/01/2023
  7771                                  	;mov	ah,CLOSE  ; 3Eh
  7772 00001B41 CD21                    	int	21h
  7773                                  	;jmp	Drv0			; go process autoexec
  7774                                  	; 22/07/2024
  7775 00001B43 EB51                    	jmp	short Drv0
  7776                                  
  7777                                  noabat:
  7778 00001B45 50                      	push	ax
  7779 00001B46 E85701                  	call	Setup_Seg
  7780 00001B49 A3[5220]                	mov	[triage_add+2],ax
  7781 00001B4C 58                      	pop	ax
  7782 00001B4D FF1E[5020]              	call	far [triage_add]	; get extended error
  7783 00001B51 83F841                  	cmp	ax,65			; network access denied?
  7784                                  	;jne	short OPENERR		; no - go deallocate batch
  7785                                  	; 21/01/2023
  7786                                  	;;je	short AccDenErr
  7787                                  	; 22/07/2024
  7788 00001B54 7506                    	jne	short OpenErr
  7789                                  	; 06/06/2023
  7790                                  	;je	short AccDenErr
  7791                                  
  7792                                  	; 21/01/2023
  7793                                  ;_ACCDENERROR:					; yes - put out message
  7794                                  ;	;mov	dx,offset ResGroup:AccDen	; dx = ptr to msg
  7795                                  ;	mov	dx,ACCDENERR
  7796                                  ;	call	RPRINT
  7797                                  
  7798                                  	; 21/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7799                                  
  7800                                  	; MSDOS 6.0 (& MSDOS 5.0)
  7801                                  
  7802                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7803                                  ; 06/06/2023
  7804                                  ; 21/01/2023
  7805                                  %if 0
  7806                                  
  7807                                  ; If AUTOEXEC.BAT is not found, then check for KAUTOEXE.BAT. Changed
  7808                                  ; by Ellen to check only when in Korea. The country information
  7809                                  ; returned will overlay the old parse data area, but we don't care
  7810                                  ; since we won't need the parse information or country information.
  7811                                  ; We only care about the country code returned in BX.
  7812                                  
  7813                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1AE7h
  7814                                  	; 06/06/2023
  7815                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1C5Eh
  7816                                  
  7817                                  	;mov	dx,offset ResGroup:Internat_Info ; set up internat vars
  7818                                  	mov	dx,INTERNAT_INFO
  7819                                  	mov	ax,3800h
  7820                                  	;mov	ax,INTERNATIONAL<<8
  7821                                  	;;mov	ax,INTERNATIONAL shl 8		; get country dependent info
  7822                                  	int	21h				;
  7823                                  	jc	short NoKabat 			; error - don't bother with it
  7824                                  	cmp	bx,52h
  7825                                  	;cmp	bx,KOREA_COUNTRY_CODE		; are we speaking korean?
  7826                                  	jne	short OpenErr 			; no, don't check for kautoexe
  7827                                  
  7828                                  	;mov	di,BatFile			; 3/3/kk
  7829                                  	mov	di,20h
  7830                                  	;mov	si,offset ResGroup:KautoBat	; another trial to do	3/3/kk
  7831                                  	mov	si,KAUTOBAT
  7832                                  	mov	cx,8				; auto execution for the 3/3/kk
  7833                                  	rep	movsw				; non-english country	3/3/kk
  7834                                  	movsb					; move in carraige return to terminate string
  7835                                  	;mov	dx,offset ResGroup:KautoBat	; 3/3/kk
  7836                                  	mov	dx,KAUTOBAT
  7837                                  	mov	ax,3D00h
  7838                                  	;mov	ax,OPEN<<8
  7839                                  	;;mov	ax,OPEN shl 8			; 3/3/kk
  7840                                  	int	21h				; see if kautoexe.bat exists  3/3/kk
  7841                                  	jc	short NoKabat 			; 3/3/kk
  7842                                  	mov	bx,ax				; 3/3/kk
  7843                                  	mov	ah,3Eh
  7844                                  	;mov	ah,CLOSE			; 3/3/kk
  7845                                  	int	21h				; 3/3/kk
  7846                                  	jmp	short Drv0			; 3/3/kk
  7847                                  
  7848                                  NoKabat:					; 3/3/kk
  7849                                  	call	far [triage_add]		; get extended error
  7850                                  	cmp	ax,65				; network access denied?
  7851                                  	jnz	short OpenErr 			; no - go deallocate batch
  7852                                  
  7853                                  %endif	
  7854                                  	; 06/06/2023 - Retro DOS 4.2 COMMAND.COM
  7855                                  	; 21/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7856                                  
  7857                                  AccDenErr:					; yes - put out message
  7858                                  	;mov	dx,offset ResGroup:AccDen	; dx = ptr to msg
  7859 00001B56 BA[D006]                	mov	dx,ACCDEN
  7860 00001B59 E87FF8                  	call	RPrint
  7861                                  OpenErr:
  7862                                  ;OPENERR:
  7863 00001B5C 8E06[4902]              	mov	es,[Batch]		; not found--turn off batch job
  7864 00001B60 B449                    	mov	ah,49h
  7865                                  	;mov	ah,DEALLOC ; 49h
  7866 00001B62 CD21                    	int	21h
  7867 00001B64 C706[4902]0000          	mov	word [Batch],0		; after dealloc in case of ^c
  7868 00001B6A C606[9D02]01            	mov	byte [EchoFlag],1
  7869 00001B6F C706[AE02]0000          	mov	word [Nest],0		; indicate no batch in progress
  7870                                  ;DoDttm:
  7871                                  	;mov	ax,offset TranGroup:Datinit
  7872 00001B75 B8[9C32]                	mov	ax,DATINIT
  7873 00001B78 A3[4820]                	mov	[INITADD],ax
  7874                                  
  7875                                  	; MSDOS 6.0
  7876                                  ;;M004;;mov	ax,TrnSeg	
  7877                                  ;
  7878                                  ; M004; We cant use TrnSeg now because it is not initialized. We now that
  7879                                  ; M004; the transient starts on a para boundary at the label TranStart.
  7880                                  ; M004; We use TranStart to get the start of the transient segment.
  7881                                  
  7882                                  	; 21/01/2023
  7883                                  	;mov	ax,offset RESGROUP:TranStart	; M004
  7884                                  	;;mov	ax,2320h ; MSDOS 5.0 COMMAND.COM
  7885                                  	; 06/06/2023
  7886                                  	;mov	ax,26E0h ; MSDOS 6.22 COMMAND.COM
  7887                                  	;
  7888                                  	;mov	ax,TRANSTART
  7889                                  	;mov	cl,4				; M004
  7890                                  	;shr	ax,cl				; get relative seg ; M004
  7891                                  	; 06/06/2023
  7892 00001B7B B87D02                  	mov	ax,TRANSTART>>4	
  7893                                  
  7894 00001B7E 8CC9                    	mov	cx,cs
  7895 00001B80 01C8                    	add	ax,cx				; ax = transient seg ; M004
  7896                                  
  7897                                  	; 21/01/2023
  7898                                  	; MSDOS 3.3
  7899                                  	; 25/09/2018
  7900                                  	;mov     ax,[TrnSeg]	; COMMAND.COM (MSDOS 3.3) - Offset 1387h
  7901                                  
  7902                                  	; MSDOS 3.3 & MSDOS 6.0
  7903 00001B82 A3[4A20]                	mov	[INITADD+2],ax
  7904                                  	;call	dword ptr InitAdd
  7905 00001B85 FF1E[4820]              	call	far [INITADD]
  7906                                  
  7907                                  NoDttm:
  7908                                  	; MSDOS 6.0
  7909                                  	; 21/01/2023
  7910                                  ;Copyright:
  7911                                  	;public	Copyright
  7912                                  ;	Bugbug:	remove Copyright label.
  7913                                  
  7914                                  ;if IBMVER
  7915 00001B89 833E[A502]00            	cmp	word [SingleCom],0
  7916 00001B8E 7506                    	jnz	short Drv0			; don't print header if SingleCom
  7917                                  	;mov	dx,offset ResGroup:CopyrightMsg	; dx = ptr to msg
  7918 00001B90 BA[9621]                	mov	dx,COPYRIGHTMSG
  7919 00001B93 E845F8                  	call	RPrint
  7920                                  ;endif
  7921                                  	; 21/01/2023
  7922                                  	; MSDOS 3.3
  7923                                  	;cmp	word [SingleCom],0	; don't print header if SingleCom
  7924                                  	;jnz	short DRV0
  7925                                  	;mov	dx,HEADERPTR	; dx = ptr to msg
  7926                                  	;call	RPRINT
  7927                                  ;DRV0:
  7928                                  	; MSDOS 3.3
  7929                                  	;mov	byte [INITFLAG],0
  7930                                  	;jmp	ENDINIT
  7931                                  
  7932                                  	; 21/01/2023
  7933                                  	; MSDOS 6.0
  7934                                  Drv0:						; Reset APPEND state
  7935 00001B96 1E                      	push	ds				; save data segment
  7936 00001B97 0E                      	push	cs				; Get local segment into DS
  7937 00001B98 1F                      	pop	ds				;
  7938 00001B99 B807B7                  	mov	ax,0B707h ; 21/01/2023
  7939                                  	;mov	ax,APPENDSETSTATE		; Set the state of Append
  7940 00001B9C 8B1E[BE02]              	mov	bx,[Append_State] 		;  back to the original state
  7941 00001BA0 CD2F                    	int	2Fh				;
  7942 00001BA2 1F                      	pop	ds				; get data segment back
  7943                                  
  7944                                  ;Check FirstCom set previously to see if this is the first instance of
  7945                                  ;command.com. If not, we do not move command.com. Instead, we copy over the
  7946                                  ;jump table from the previous stub to the current stub.
  7947                                  
  7948 00001BA3 803E[9926]01            	cmp	byte [FirstCom],1		; first command.com?
  7949 00001BA8 7431                    	jz	short move_code			; yes, move it
  7950                                  
  7951 00001BAA 06                      	push	es
  7952 00001BAB 1E                      	push	ds
  7953                                  
  7954 00001BAC 1E                      	push	ds
  7955 00001BAD 07                      	pop	es
  7956                                  	;mov	di,offset DATARES:Int2f_Entry
  7957 00001BAE BF[6600]                	mov	di,Int2f_Entry	
  7958                                  
  7959                                  	;mov	ds,[es:ResJmpTable+2]		; get segment address
  7960                                  	;mov	si,[es:ResJmpTable]		; get offset address
  7961                                  	; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7962 00001BB1 26C536[9526]            	lds	si,[es:ResJmpTable]
  7963                                  
  7964                                  	;mov	cx,11
  7965                                  	;;mov 	cx,NUM_RELOC_ENTRIES 		; number of dword ptrs
  7966                                  	;shl	cx,1
  7967                                  	;shl	cx,1				; size of table in bytes
  7968                                  	; 21/01/2023
  7969 00001BB6 B92C00                  	mov	cx,44				; size of table in bytes
  7970                                  
  7971 00001BB9 FC                      	cld
  7972 00001BBA F3A4                    	rep	movsb				; copy the jump table
  7973                                  
  7974                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  7975                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1D6Ch
  7976                                  %if 1
  7977 00001BBC A0[FA01]                	mov     al,[cox_location] ; "cox"
  7978 00001BBF 26A2[FA01]              	mov     [es:cox_location],al ; "cox"
  7979 00001BC3 A1[FB01]                	mov     ax,[cox_location+1]
  7980 00001BC6 A3[FB01]                	mov     [cox_location+1],ax
  7981                                  %endif
  7982                                  
  7983                                  ;Check if the resident code is in HMA. We assume that it is in HMA if its 
  7984                                  ;code segment > 0f000h. If in HMA, we set the ComInHMA flag
  7985                                  
  7986 00001BC9 26817DFE00F0            	cmp	word [es:di-2],0F000h		; is resident code in HMA?
  7987 00001BCF 7206                    	jb	short res_low			; no, dont set flag
  7988                                  
  7989 00001BD1 26C606[9600]01          	mov	byte [es:ComInHMA],1		; indicate code in HMA
  7990                                  res_low:
  7991 00001BD7 1F                      	pop	ds
  7992 00001BD8 07                      	pop	es
  7993 00001BD9 EB03                    	jmp	short finish_init
  7994                                  
  7995                                  ;Now, we can move the resident code to its final location, either to HIMEM
  7996                                  ;or to overlay the messages in the data segment if the user has not used the
  7997                                  ;/msg switch.
  7998                                  
  7999                                  move_code:
  8000 00001BDB E85702                  	call	Move_res_code			; move the code
  8001                                  
  8002                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  8003                                  ; PCDOS 7.1 COMMAND.COM
  8004                                  %if 0
  8005                                  finish_init:
  8006                                  	;jmp	RESGROUP:EndInit 		; finish initializing
  8007                                  	jmp	EndInit
  8008                                  %else
  8009                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1D8Fh
  8010                                  finish_init:
  8011 00001BDE 803E[A202]01            	cmp	byte [PermCom],1
  8012 00001BE3 7523                    	jne	short finish_init_@
  8013 00001BE5 803E[0E04]01            	cmp	byte [COMMAND_HIGH],1	; COMMAND.COM will be moved to HMA/UMB
  8014 00001BEA 751C                    	jne	short finish_init_@
  8015 00001BEC BB4000                  	mov	bx,40h			; high memory first fit
  8016 00001BEF B80158                  	mov	ax,5801h		; set allocation strategy
  8017 00001BF2 CD21                    	int	21h		; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  8018                                  				; AL = function code: set allocation strategy
  8019 00001BF4 BB0100                  	mov	bx,1			; add UMBs to DOS memory chain
  8020 00001BF7 B80358                  	mov	ax,5803h		; set UMB link state
  8021 00001BFA CD21                    	int	21h		; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  8022                                  				; AL = function code: (DOS 5beta) set UMB link state
  8023 00001BFC 720A                    	jb	short finish_init_@
  8024 00001BFE 8B1E[B404]              	mov	bx,[ResSize]
  8025 00001C02 B448                    	mov	ah,48h
  8026 00001C04 CD21                    	int	21h		; DOS - 2+ - ALLOCATE MEMORY
  8027                                  				; BX = number of 16-byte paragraphs desired
  8028 00001C06 7303                    	jnb	short patch_segments_hma
  8029                                  finish_init_@:
  8030 00001C08 E90AE7                  	jmp	EndInit
  8031                                  
  8032                                  patch_segments_hma:
  8033                                  	;mov	[ds:0Ch],ax
  8034 00001C0B A30C00                  	mov	[PDB.EXIT+2],ax
  8035                                  	;mov	[ds:10h],ax
  8036 00001C0E A31000                  	mov	[PDB.CTRL_C+2],ax
  8037                                  	;mov	[ds:14h],ax
  8038 00001C11 A31400                  	mov	[PDB.FATAL_ABORT+2],ax
  8039                                  	;mov	[ds:16h],ax
  8040 00001C14 A31600                  	mov	[PDB.PARENT_PID],ax
  8041                                  	;mov	[ds:36h],ax
  8042 00001C17 A33600                  	mov	[PDB.JFN_Pointer+2],ax
  8043 00001C1A A3[3E02]                	mov	[Parent],ax
  8044 00001C1D A3[4202]                	mov	[OldTerm+2],ax
  8045 00001C20 A3[3E04]                	mov	[Com_Ptr+2],ax
  8046 00001C23 A3[4204]                	mov	[Com_Fcb1+2],ax
  8047 00001C26 A3[4604]                	mov	[Com_Fcb2+2],ax
  8048 00001C29 A3[4A04]                	mov	[MySeg],ax
  8049 00001C2C A3[5204]                	mov	[MySeg1],ax
  8050 00001C2F A3[5604]                	mov	[MySeg2],ax
  8051 00001C32 A3[5607]                	mov	[MySeg3],ax
  8052 00001C35 A3[2801]                	mov	[int2fh_segm],ax ; [Carousel_i2f_Hook+3] ; 23/07/2024
  8053                                  	;mov	di,(offset Int2f_Entry+2)
  8054 00001C38 BF[6800]                	mov	di,Int2f_Entry+2
  8055 00001C3B 833DFF                  	cmp	word [di],0FFFFh
  8056 00001C3E 7409                    	jz	short already_hma
  8057 00001C40 B10B                    	mov	cl,11		; NUM_RELOC_ENTRIES
  8058                                  patch_entry_seg:
  8059 00001C42 8905                    	mov	[di],ax
  8060 00001C44 83C704                  	add	di,4
  8061 00001C47 E2F9                    	loop	patch_entry_seg
  8062                                  already_hma:
  8063 00001C49 8EC0                    	mov	es,ax
  8064 00001C4B 31F6                    	xor	si,si
  8065 00001C4D 31FF                    	xor	di,di
  8066 00001C4F B103                    	mov	cl,3			; BX = resident part size in paragraphs
  8067                                  					; after shifting: resident part size in words
  8068 00001C51 D3E3                    	shl	bx,cl			; move resident part of COMMAND.COM to HMA (UMB)
  8069 00001C53 89D9                    	mov	cx,bx			; number of words
  8070 00001C55 F3A5                    	rep movsw
  8071 00001C57 1E                      	push	ds
  8072 00001C58 8ED9                    	mov	ds,cx	; 0
  8073                                  	;mov	[ds:0BAh],ax	; INT 2Eh segment
  8074 00001C5A A3BA00                  	mov	[(2Eh*4)+2],ax
  8075 00001C5D 40                      	inc	ax
  8076                                  	;mov	[ds:0BEh],ax	; INT 2Fh segment
  8077 00001C5E A3BE00                  	mov	[(2Fh*4)+2],ax
  8078 00001C61 1F                      	pop	ds
  8079 00001C62 8CC3                    	mov	bx,es
  8080 00001C64 B450                    	mov	ah,50h
  8081 00001C66 CD21                    	int	21h		; DOS - 2+ internal - SET PSP SEGMENT
  8082                                  				; BX = segment address of new PSP
  8083 00001C68 4B                      	dec	bx
  8084 00001C69 8EC3                    	mov	es,bx			; memory arena header (segment)
  8085 00001C6B 43                      	inc	bx			; PSP (program) address/segment
  8086                                  	;mov	[es:1],bx
  8087                                  	;mov	[es:ARENA.owner],bx
  8088 00001C6C 26891E0100              	mov	[es:arena_owner],bx
  8089                                  	;mov	word [es:8],4F43h	; 'CO' ; [es:arena_name]
  8090 00001C71 26C7060800434F          	mov	word [es:arena_name],4F43h
  8091                                  	;mov	word [es:0Ah],4D4Dh	; 'MM'
  8092 00001C78 26C7060A004D4D          	mov	word [es:arena_name+2],4D4Dh
  8093                                  	;mov	word [es:0Ch],4E41h	; 'AN'
  8094 00001C7F 26C7060C00414E          	mov	word [es:arena_name+4],4E41h
  8095                                  	;mov	word [es:0Eh],44h	; 'D'
  8096 00001C86 26C7060E004400          	mov	word [es:arena_name+6],44h
  8097 00001C8D FE06[0E04]              	inc	byte [COMMAND_HIGH]	; = 2
  8098                                  					; Resident portion of COMMAND.COM is
  8099                                  					; in HMA/UMB flag (=2)
  8100 00001C91 53                      	push	bx
  8101                                  	;mov	ax,offset EndInit
  8102 00001C92 B8[1503]                	mov	ax,EndInit
  8103 00001C95 50                      	push	ax
  8104 00001C96 CB                      	retf	
  8105                                  %endif
  8106                                  
  8107                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8108                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1BA8h (CODERES:0E68h)
  8109                                  
  8110                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  8111                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1E48h
  8112                                  
  8113                                  GetStrLen:
  8114                                  ;	Get length of string pointed to by DS:SI. Length includes NULL.
  8115                                  ;	Length is returned in CX
  8116                                  
  8117                                  	; MSDOS 3.3 & MSDOS 6.0
  8118 00001C97 31C9                    	xor	cx,cx
  8119                                  NxtChar:
  8120 00001C99 AC                      	lodsb
  8121 00001C9A 41                      	inc	cx
  8122 00001C9B 08C0                    	or	al,al
  8123 00001C9D 75FA                    	jnz	short NxtChar
  8124 00001C9F C3                      	retn
  8125                                  
  8126                                  	; 29/01/2023
  8127                                  Setup_Seg:
  8128                                  
  8129                                  ; If the transient has been loaded in TranSeg, then we need to use that
  8130                                  ; segment for calls to routines in the transient area. Otherwise, the current
  8131                                  ; code segment is used
  8132                                  ; Segment returned in AX.
  8133                                  
  8134                                  	; MSDOS 3.3 & MSDOS 6.0
  8135 00001CA0 A1[8F02]                	mov	ax,[TrnSeg]
  8136 00001CA3 803E[9102]01            	cmp	byte [TrnMvFlg],1	; Has transient portion been moved
  8137 00001CA8 7405                    	je	short setup_end
  8138                                  
  8139                                  ;06/06/2023
  8140                                  %if 0
  8141                                  	push	bx
  8142                                  	mov	bx,cs
  8143                                  	;mov	ax,offset ResGroup:TranStart
  8144                                  	;mov	ax,2320h ; MSDOS 5.0 COMMAND.COM
  8145                                  	; 06/06/2023
  8146                                  	;mov	ax,26E0h ; MSDOS 6.22 COMMAND.COM
  8147                                  	;mov	ax,TRANSTART
  8148                                  	;shr	ax,1
  8149                                  	;shr	ax,1
  8150                                  	;shr	ax,1
  8151                                  	;shr	ax,1
  8152                                  	; 29/01/2023
  8153                                  	mov	ax,TRANSTART>>4
  8154                                  	add	ax,bx
  8155                                  	pop	bx
  8156                                  %endif
  8157                                  	; 06/06/2023
  8158 00001CAA 8CC8                    	mov	ax,cs
  8159 00001CAC 057D02                  	add	ax,TRANSTART>>4
  8160                                  
  8161                                  setup_end:
  8162 00001CAF C3                      	retn
  8163                                  
  8164                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8165                                  ;RPRINT:
  8166                                  	; MSDOS 3.3
  8167                                  	;push	ax
  8168                                  	;call	SETUP_SEG
  8169                                  	;mov	[PRINTADD+2], ax
  8170                                  	;;call	dword ptr PRINTADD
  8171                                  	;call	far [PRINTADD]
  8172                                  	;pop	ax
  8173                                  	;retn
  8174                                  
  8175                                  	; 29/01/2023
  8176                                  	; MSDOS 6.0
  8177                                  ;***	RPrintParse - display parse error message
  8178                                  ;
  8179                                  ;	ENTRY	DX = parse error #
  8180                                  ;
  8181                                  ;	EXIT	nothing
  8182                                  ;
  8183                                  ;	USED	flags
  8184                                  ;
  8185                                  ;	EFFECTS
  8186                                  ;	  Message is displayed on stdout.
  8187                                  
  8188                                  RPrintParse:	;proc
  8189                                  	;assume	ds:ResGroup,ss:ResGroup
  8190                                  
  8191 00001CB0 52                      	push	dx				; preserve DX
  8192 00001CB1 87D3                    	xchg	bx,dx				; bx = parse error #
  8193                                  						; dx = saved BX
  8194 00001CB3 4B                      	dec	bx				; bx = parse error index, from 0
  8195 00001CB4 D1E3                    	shl	bx,1				; bx = offset in word table
  8196                                  	;mov	bx,ParsMsgPtrs[bx]		; bx = ptr to error msg
  8197 00001CB6 8B9F[E309]              	mov	bx,[bx+PARSMSGPTRS]
  8198 00001CBA 87D3                    	xchg	bx,dx				; dx = ptr to error msg
  8199                                  						; bx = restored
  8200 00001CBC E81CF7                  	call	RPrint				; print the message
  8201 00001CBF 5A                      	pop	dx				; restore DX
  8202 00001CC0 C3                      	retn
  8203                                  
  8204                                  ;RPrintParse	endp
  8205                                  
  8206                                  	; 29/01/2023
  8207                                  ;PATHCHRCMPR:
  8208                                  	; MSDOS 3.3
  8209                                  	;push	dx
  8210                                  	;mov	dl,[slash_chr]
  8211                                  	;;cmp	byte [RSWITCHAR],'/'
  8212                                          ;cmp	[RSWITCHAR],dl
  8213                                  	;je	short RNOSLASHT
  8214                                  	;;cmp	al,'/'
  8215                                  	;cmp	al,dl
  8216                                  	;je	short RET41 ; zf = 1 
  8217                                  ;RNOSLASHT:
  8218                                          ;;cmp	al,'\'
  8219                                  	;cmp	al,[bslash_chr]
  8220                                  ;RET41:
  8221                                  	;pop	dx
  8222                                  	;retn
  8223                                  
  8224                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8225                                  IfindE:
  8226                                  	; MSDOS 3.3 & MSDOS 6.0
  8227 00001CC1 E80300                  	call	ifind				; find the name
  8228                                  	;jc	short ifind2			; carry means not found
  8229                                  	;jmp	short Iscasb1 			; scan for = sign
  8230                                  	; 29/01/2023
  8231 00001CC4 734E                    	jnc	short Iscasb1
  8232                                  ifind2:
  8233 00001CC6 C3                      	retn
  8234                                  
  8235                                  	; 29/01/2023
  8236                                  
  8237                                  ; on return of find1, es:di points to beginning of name
  8238                                  
  8239                                  ifind:
  8240 00001CC7 FC                      	cld
  8241 00001CC8 E83B00                  	call	Icount0				; cx = length of name
  8242 00001CCB 8E06[3A04]              	mov	es,[EnvirSeg]
  8243 00001CCF 31FF                    	xor	di,di
  8244                                  ifind1:
  8245 00001CD1 51                      	push	cx
  8246 00001CD2 56                      	push	si
  8247 00001CD3 57                      	push	di
  8248                                  ifind11:
  8249 00001CD4 AC                      	lodsb
  8250                                  
  8251                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
  8252                                  ; PCDOS 7.1 COMMAND.COM
  8253                                  %if 1
  8254                                  ;ifdef DBCS
  8255 00001CD5 E8A5F7                  	call	ITestKanj
  8256 00001CD8 740F                    	jz	short _NotKanj4
  8257 00001CDA 4E                      	dec	si
  8258 00001CDB AD                      	lodsw
  8259 00001CDC 47                      	inc	di
  8260 00001CDD 47                      	inc	di
  8261 00001CDE 263B45FE                	cmp	ax,[es:di-2]
  8262 00001CE2 7511                    	jne	short ifind12
  8263 00001CE4 49                      	dec	cx
  8264 00001CE5 E2ED                    	loop	ifind11
  8265 00001CE7 EB0C                    	jmp	short ifind12
  8266                                  _NotKanj4:
  8267                                  ;endif
  8268                                  %endif
  8269 00001CE9 E83400                  	call	iupconv
  8270 00001CEC 47                      	inc	di
  8271 00001CED 263A45FF                	cmp	al,[es:di-1]
  8272 00001CF1 7502                    	jnz	short ifind12
  8273 00001CF3 E2DF                    	loop	ifind11
  8274                                  ifind12:
  8275 00001CF5 5F                      	pop	di
  8276 00001CF6 5E                      	pop	si
  8277 00001CF7 59                      	pop	cx
  8278 00001CF8 74CC                    	jz	short ifind2
  8279 00001CFA 51                      	push	cx
  8280 00001CFB E81A00                  	call	Iscasb2 			; scan for a nul
  8281 00001CFE 59                      	pop	cx
  8282                                  	;cmp	byte [es:di],0
  8283                                  	;jnz	short ifind1
  8284                                  	;stc					; indicate not found
  8285 00001CFF 26803D01                	cmp	byte [es:di],1
  8286 00001D03 73CC                    	jnb	short ifind1
  8287                                  	; cf=1					; indicate not found
  8288                                  ;ifind2:
  8289 00001D05 C3                      	retn
  8290                                  
  8291                                  	; 29/01/2023
  8292                                  Icount0:
  8293 00001D06 1E                      	push	ds
  8294 00001D07 07                      	pop	es
  8295 00001D08 89F7                    	mov	di,si
  8296                                  
  8297 00001D0A 57                      	push	di				; count number of chars until "="
  8298 00001D0B E80600                  	call	Iscasb1
  8299                                  	; 25/09/2018
  8300                                  	;jmp	short Icountx
  8301                                  	;push	di				; count number of chars until nul
  8302                                  	;call	Iscasb2
  8303                                  ;Icountx:
  8304 00001D0E 59                      	pop	cx
  8305 00001D0F 29CF                    	sub	di,cx
  8306 00001D11 87CF                    	xchg	di,cx
  8307 00001D13 C3                      	retn
  8308                                  
  8309                                  Iscasb1:
  8310                                  	; 29/01/2023
  8311 00001D14 B03D                    	mov	al,"="
  8312                                  	;mov	al,[equalsign] ; [equal_sign]	; scan for an =
  8313 00001D16 EB02                    	jmp	short Iscasbx
  8314                                  Iscasb2:
  8315 00001D18 30C0                    	xor	al,al				; scan for a nul
  8316                                  Iscasbx:
  8317 00001D1A B90001                  	mov	cx,256 ; 100h
  8318 00001D1D F2AE                    	repnz	scasb
  8319 00001D1F C3                      	retn
  8320                                  
  8321                                  	; 29/01/2023
  8322                                  ;IUPCONV:
  8323                                  	; MSDOS 3.3
  8324                                          ;;cmp	al,"a"
  8325                                  	;cmp	al,[letter_a]
  8326                                          ;jb	short IRET22
  8327                                          ;;cmp	al,"z"
  8328                                          ;cmp	al,[letter_z]
  8329                                  	;ja	short IRET22
  8330                                          ;sub	al,20h			; Lower-case changed to upper-case
  8331                                  ;IRET22:
  8332                                  	;retn
  8333                                  
  8334                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8335                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1C32h
  8336                                  
  8337                                  	; MSDOS 6.0
  8338                                  ; *****************************************************************
  8339                                  ; *
  8340                                  ; * ROUTINE:	 IUPCONV    (ADDED BY EMG 4.00)
  8341                                  ; *
  8342                                  ; * FUNCTION:	 This routine returns the upper case equivalent of
  8343                                  ; *		 the character in AL from the file upper case table
  8344                                  ; *		 in DOS if character if above ascii 128, else
  8345                                  ; *		 subtracts 20H if between "a" and "z".
  8346                                  ; *
  8347                                  ; * INPUT:	 DS	      set to resident
  8348                                  ; *		 AL	      char to be upper cased
  8349                                  ; *		 FUCASE_ADDR  set to the file upper case table
  8350                                  ; *
  8351                                  ; * OUTPUT:	 AL	      upper cased character
  8352                                  ; *
  8353                                  ; *****************************************************************
  8354                                  
  8355                                  iupconv:	;proc	near				
  8356                                  	;assume	ds:ResGroup			;
  8357                                  
  8358 00001D20 3C80                    	cmp	al,80h				; see if char is > ascii 128
  8359 00001D22 7210                    	jb	short other_fucase		; no - upper case math
  8360 00001D24 2C80                    	sub	al,80h				; only upper 128 chars in table
  8361 00001D26 1E                      	push	ds				;
  8362 00001D27 53                      	push	bx				;
  8363                                  	;lds	bx,dword ptr FUCase_Addr+1	; get table address
  8364 00001D28 C51E[B602]              	lds     bx,[FUCase_Addr+1]
  8365 00001D2C 83C302                  	add	bx,2				; skip over first word
  8366                                  	;xlat	ds:byte ptr [bx]		; convert to upper case
  8367 00001D2F D7                      	xlat
  8368 00001D30 5B                      	pop	bx				;
  8369 00001D31 1F                      	pop	ds				;
  8370 00001D32 EB0A                    	jmp	short iupconv_end		; we finished - exit
  8371                                  
  8372                                  other_fucase:					;
  8373                                  	;cmp	al,[lcasea] ; [letter_a]	; if between "a" and "z",
  8374 00001D34 3C61                    	cmp	al,'a'
  8375 00001D36 7206                    	jb	short iupconv_end		;     subtract 20h to get
  8376                                  	;cmp	al,[lcasez] ; [letter_z]	; upper case equivalent.
  8377 00001D38 3C7A                    	cmp	al,'z'
  8378 00001D3A 7702                    	ja	short iupconv_end		;
  8379 00001D3C 2C20                    	sub	al,20h				; Change lower-case to upper
  8380                                  iupconv_end:					;
  8381 00001D3E C3                      	retn
  8382                                  
  8383                                  ;iupConv endp
  8384                                  
  8385                                  	; 29/01/2023
  8386                                  init_contc_specialcase:
  8387                                  	; MSDOS 3.3 & MSDOS 6.0
  8388                                  						; This routine is called if control-C
  8389 00001D3F 83C406                  	add	sp,6				;  is type during the date/time prompt
  8390 00001D42 56                      	push	si				;  at initialization time.  The desired
  8391 00001D43 89D6                    	mov	si,dx				;  response is to make it look like the
  8392 00001D45 C74401000D              	mov	word [si+1],0D00h		;  user typed <CR> by "popping" the
  8393 00001D4A 5E                      	pop	si				;  INT 21h stuff off the stack, putting
  8394 00001D4B CF                      	iret					;  a <CR> in the user's buffer, and
  8395                                  						;  returning directly to the user.
  8396                                  						; In this case the user is TCODE.
  8397                                  
  8398                                  ; ----------------------------------------------------------------------------
  8399                                  
  8400                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8401                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1C62h (CODERES:0F22h)
  8402                                  
  8403                                  	; MSDOS 6.0
  8404                                  ; ****************************************************************
  8405                                  ; *
  8406                                  ; * ROUTINE:	 Setup_for_messages
  8407                                  ; *
  8408                                  ; * FUNCTION:	 Sets up system for PARSE and EXTENDED ERROR
  8409                                  ; *		 messages as follows:
  8410                                  ; *
  8411                                  ; *		 IF /P and /MSG are entered
  8412                                  ; *		    keep PARSE and EXTENDED ERRORS in memory
  8413                                  ; *		 ELSE IF /P is entered
  8414                                  ; *		    use PARSE and EXTENDED ERRORS on disk
  8415                                  ; *		    remove PARSE ERRORS from memory
  8416                                  ; *		 ELSE
  8417                                  ; *		    remove PARSE ERRORS from memory
  8418                                  ; *		 ENDIF
  8419                                  ; *
  8420                                  ; * INPUT:	 PERMCOM	Set up with user input
  8421                                  ; *		 EXT_MSG	Set up with user input
  8422                                  ; *		 System set up to retain PARSE ERRORS
  8423                                  ; *
  8424                                  ; * OUTPUT:	 registers unchanged
  8425                                  ; *
  8426                                  ; ****************************************************************
  8427                                  
  8428                                  setup_for_messages: ;proc near		
  8429                                  
  8430 00001D4C 53                      	push	bx
  8431 00001D4D 1E                      	push	ds				; save data segment
  8432 00001D4E 06                      	push	es				; save environment segment
  8433 00001D4F 50                      	push	ax				;
  8434 00001D50 52                      	push	dx				;
  8435 00001D51 57                      	push	di				;
  8436 00001D52 8CC8                    	mov	ax,cs				; get local segment to ES and DS
  8437 00001D54 8ED8                    	mov	ds,ax				;
  8438 00001D56 8EC0                    	mov	es,ax				;
  8439                                  
  8440 00001D58 803E[A202]00            	cmp	byte [PermCom],0		; was permcom set?
  8441 00001D5D 743C                    	jz	short no_permcom		; No - don't worry about messages
  8442                                  
  8443                                  ;*	We're permanent. Install our message services int 2f handler.
  8444                                  
  8445 00001D5F 06                      	push	es
  8446                                  	;mov	ax,(GET_INTERRUPT_VECTOR shl 8) or 2Fh
  8447 00001D60 B82F35                  	mov	ax,352Fh
  8448 00001D63 CD21                    	int	21h
  8449                                  			; DOS - 2+ - GET INTERRUPT VECTOR
  8450                                  			; AL = interrupt number
  8451                                  			; Return: ES:BX = value of interrupt vector
  8452 00001D65 891E[AE04]              	mov	[Int2fHandler],bx
  8453 00001D69 8C06[B004]              	mov	[Int2fHandler+2],es
  8454 00001D6D 07                      	pop	es
  8455                                  
  8456                                  ;	DS = RESGROUP seg addr
  8457                                  
  8458                                  ; M005; We will not hook int 2fh on any command.com other than the first.
  8459                                  ; M005; Carousel loads as a permanent command.com and when we exit Carousel,
  8460                                  ; M005; it just wipes our arena out. So, int 2fh is still hooked and the
  8461                                  ; M005; first int 2fh call after exit from Carousel (from the DOS terminate
  8462                                  ; M005; call) goes off into space.
  8463                                  
  8464 00001D6E 803E[9926]00            	cmp	byte [FirstCom],0		; M005
  8465 00001D73 7416                    	je	short no_msg_hook		; M005
  8466                                  ;
  8467                                  ; M005; !!!SLIMIEST CAROUSEL HACK OFF ALL!!!
  8468                                  ; M005; Carousel plays around with the interrupt vector tables. He saves it
  8469                                  ; M005; before loading a new command.com. Then, it takes hold of the current
  8470                                  ; M005; command.com's PSP and then looks at all interrupt vectors whose
  8471                                  ; M005; segment matches the command.com PSP and then updates these segments
  8472                                  ; M005; to the new command.com's PSP in his saved vector table. Whenever we
  8473                                  ; M005; we pop into his menu, he puts this saved table into the vector table.
  8474                                  ; M005; If we now quit, Carousel just wipes out command.com's arena and then
  8475                                  ; M005; issues a terminate. Unfortunately, the int 2fh vector is pointing at
  8476                                  ; M005; the command.com that was wiped out and so the next int 2fh call will
  8477                                  ; M005; bomb. To prevent Carousel from doing this clever(1**$$#) patching, we
  8478                                  ; M005; renormalize our int 2fh pointer so that its cs is not the same as the
  8479                                  ; M005; command.com PSP. Now, he does no such patching and our int 2fh vector
  8480                                  ; M005; remains nice and happy. The renormalized pointer points at a far 
  8481                                  ; M005; jump to the actual int 2fh entry point.
  8482                                  ;
  8483 00001D75 1E                      	push	ds				; M005
  8484                                  	;mov	dx,offset DATARES:Carousel_i2f_Hook ; M005
  8485 00001D76 BA[2501]                	mov     dx,Carousel_i2f_Hook
  8486 00001D79 83EA10                  	sub	dx,10h				; renormalize offset; M005
  8487 00001D7C 8CD8                    	mov	ax,ds				; M005
  8488 00001D7E 40                      	inc	ax				; Relocated cs ; M005
  8489 00001D7F 8ED8                    	mov	ds,ax				; M005
  8490                                  	;mov	ax,(SET_INTERRUPT_VECTOR shl 8) or 2Fh
  8491 00001D81 B82F25                  	mov	ax,252Fh
  8492 00001D84 CD21                    	int	21h
  8493                                  			; DOS - SET INTERRUPT VECTOR
  8494                                  			; AL = interrupt number
  8495                                  			; DS:DX = new vector to be used for specified interrupt
  8496 00001D86 1F                      	pop	ds				; M005
  8497                                  	;mov	word ptr Carousel_i2f_Hook+3,ds	; M005
  8498 00001D87 8C1E[2801]              	mov	[Carousel_i2f_Hook+3],ds  ; mov [int2fh_segm], ds ; 23/07/2024
  8499                                  						; patch in the cs for jump
  8500                                  no_msg_hook:					; M005
  8501 00001D8B 803E[9420]01            	cmp	byte [ext_msg],1 ; SET_EXTENDED_MSG
  8502 00001D90 7516                    	jne	short permcom_end		; no /msg - exit
  8503                                  
  8504                                  permcom_slash_msg:				; Keep messages in memory
  8505                                  	;mov	di,offset ResGroup:ExtMsgEnd 	; get address of resident end
  8506                                  	;mov	di,0DD8h ; PCDOS 7.1 COMMAND.COM (*)
  8507 00001D92 BF[DC0C]                	mov     di,ExtMsgEnd ; = offset PATRICIDE ; 23/07/2024 (*)
  8508 00001D95 893E[B204]              	mov	[ResMsgEnd],di			; save it
  8509 00001D99 EB0D                    	jmp	short permcom_end		; exit
  8510                                  
  8511                                  no_permcom:					
  8512                                  	;cmp	byte [ext_msg],SET_EXTENDED_MSG	; was /msg specified?
  8513 00001D9B 803E[9420]01            	cmp	byte [ext_msg],1
  8514 00001DA0 7506                    	jne	short permcom_end		; no - no error
  8515                                  	;mov	dx,LessArgs_Ptr			; get message number for "Required parameter missing"
  8516 00001DA2 BA0200                  	mov	dx,2
  8517 00001DA5 E808FF                  	call	RPrintParse
  8518                                  
  8519                                  permcom_end:
  8520 00001DA8 5F                      	pop	di				;
  8521 00001DA9 5A                      	pop	dx				;
  8522 00001DAA 58                      	pop	ax				;
  8523 00001DAB 07                      	pop	es				; get environment back
  8524 00001DAC 1F                      	pop	ds				;
  8525 00001DAD 5B                      	pop	bx
  8526                                  
  8527 00001DAE C3                      	retn					;
  8528                                  
  8529                                  ;setup_for_messages	endp
  8530                                  
  8531                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8532                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1CC5h
  8533                                  
  8534                                  	; MSDOS 6.0
  8535                                  
  8536                                  ;***	CheckHelp - print help text and exit if /? is on command line
  8537                                  ;
  8538                                  ;	ENTRY	command-line tail at 81h
  8539                                  ;
  8540                                  ;	EXIT	return if /? not found
  8541                                  ;		terminate if /? found
  8542                                  ;
  8543                                  ;	USED	AX,BX,CX,DX,SI,DI
  8544                                  ;
  8545                                  ;	EFFECTS	Help text displayed if /? found on command line
  8546                                  
  8547                                  CheckHelp:	; proc
  8548                                  	;assume	cs:RESGROUP,ds:RESGROUP,es:RESGROUP,ss:RESGROUP
  8549                                  
  8550 00001DAF BE8100                  	mov	si,81h			; DS:SI = ptr to command-line tail
  8551                                  	;mov	di,offset RESGROUP:Parse_Command
  8552 00001DB2 BF[9920]                	mov	di,PARSE_COMMAND
  8553                                  					; ES:DI = ptr to primary parse block
  8554 00001DB5 31C9                    	xor	cx,cx			; CX = # positional param's found
  8555 00001DB7 31D2                    	xor	dx,dx			; DX will be ptr to result buffer
  8556                                  chParse:
  8557                                  	;call	dword ptr Init_Parse
  8558 00001DB9 FF1E[8E20]              	call	far [Init_Parse]	; call system parser
  8559                                  
  8560                                  	;;cmp	ax,END_OF_LINE
  8561                                  	;cmp	ax,-1 ; 0FFFFh	
  8562                                  	;je	short chRet		; end of command line, no /? found
  8563                                  	;;cmp	ax,RESULT_NO_ERROR
  8564                                  	;;cmp	ax,0
  8565                                  	;;je	short chWhich		; valid syntax element found
  8566                                  	;;jmp	short chParse		; go parse more
  8567                                  	;and	ax,ax ; cmp ax,0
  8568                                  	;jnz	short chParse ; jne
  8569                                  	; 10/06/2023
  8570 00001DBD 40                      	inc	ax	; cmp ax,-1
  8571 00001DBE 741B                    	jz	short chRet   ; 0FFFFh -> 0
  8572 00001DC0 48                      	dec	ax	; cmp ax,0
  8573 00001DC1 75F6                    	jnz	short chParse ; 1 -> 0
  8574                                  	; ax = 0
  8575                                  chWhich:
  8576                                  	;cmp	Comnd1_Syn,offset RESGROUP:Command_?_Syn
  8577 00001DC3 813E[5821][2321]        	cmp     word [COMND1_SYN],COMMAND_?_SYN ; "/?"
  8578 00001DC9 7411                    	je	short chHelp		; /? found - display help & exit
  8579                                  	;cmp	Comnd1_Syn,offset RESGROUP:Command_C_Syn
  8580 00001DCB 813E[5821][0921]        	cmp     word [COMND1_SYN],COMMAND_C_SYN ; "/C"
  8581                                  	; 06/06/2023
  8582 00001DD1 7408                    	je	short chRet		; /c found - ignore rest of line
  8583                                  	; 29/01/2023
  8584                                  	;jne	short chParse
  8585                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  8586                                  	; MSDOS 6.0
  8587                                  	;cmp	Comnd1_Syn,offset RESGROUP:Command_K_Syn
  8588 00001DD3 813E[5821][2F21]        	cmp	word [COMND1_SYN],COMMAND_K_SYN ; "/K"
  8589                                  	;je	short chRet		; /k found - ignore rest of line
  8590                                  	;jmp	short chParse		; anything else - ignore, keep looking
  8591                                  	; 06/06/2023
  8592 00001DD9 75DE                    	jne	short chParse
  8593                                  chRet:
  8594 00001DDB C3                      	retn
  8595                                  chHelp:
  8596                                  	;mov	si,offset RESGROUP:HelpMsgs	; SI = ptr to msg ptr list
  8597 00001DDC BE[5F26]                	mov	si,HelpMsgs
  8598                                  chHelpNext:
  8599 00001DDF AD                      	lodsw					; AX = ptr to msg
  8600 00001DE0 09C0                    	or	ax,ax
  8601 00001DE2 7407                    	jz	short chHelpDone		; end of list - all done
  8602 00001DE4 89C2                    	mov	dx,ax				; DX = ptr to msg
  8603 00001DE6 E8F2F5                  	call	RPrint				; display msg
  8604 00001DE9 EBF4                    	jmp	short chHelpNext		; go do next msg
  8605                                  
  8606                                  chHelpDone:
  8607 00001DEB CD20                    	int	20h				; terminate program
  8608                                  ;chRet:
  8609 00001DED C3                      	retn
  8610                                  
  8611                                  ;CheckHelp	endp
  8612                                  
  8613                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8614                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1D03h
  8615                                  
  8616                                  	; MSDOS 6.0
  8617                                  
  8618                                  ;***** Setup_res_end -- This routine determines the resident size of COMMAND.
  8619                                  ;
  8620                                  ; It determines based on 2 factors:
  8621                                  ;	1. Is this is the first COMMAND?
  8622                                  ;	2. Is COMMAND to be loaded into HIMEM?
  8623                                  ;   The strategy works as follows:
  8624                                  ;
  8625                                  ;	if (First COMMAND)
  8626                                  ;	then if (COMMAND in HIMEM)
  8627                                  ;		ResSize = resident_data;
  8628                                  ;	     else
  8629                                  ;		ResSize = resident_data + resident_code;
  8630                                  ;	else
  8631                                  ;	   ResSize = resident_data;
  8632                                  ;
  8633                                  ; Int 2fh calls have been added to determine whether or not we are the first
  8634                                  ; COMMAND and whether DOS is in HIMEM.
  8635                                  ;
  8636                                  ;	ENTRY: ResMsgEnd = resident size of data in paras
  8637                                  ;
  8638                                  ;	EXIT:  ResSize = resident size in low memory
  8639                                  ;
  8640                                  ;	REGISTERS AFFECTED: ax,cx,dx
  8641                                  ;
  8642                                  
  8643                                  GET_HMA_ADDR	equ	4A02h
  8644                                  
  8645                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8646                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1FBFh
  8647                                  
  8648                                  Setup_res_end:	;proc near
  8649                                  	
  8650 00001DEE 1E                      	push	ds
  8651 00001DEF 8CC8                    	mov	ax,cs
  8652 00001DF1 8ED8                    	mov	ds,ax				;ds = RESGROUP
  8653                                  	;assume	ds:RESGROUP
  8654                                  
  8655 00001DF3 8B0E[B204]              	mov	cx,[ResMsgEnd]			;set resident size = data
  8656                                  
  8657                                  ;ifndef	ROMDOS
  8658                                  
  8659                                  ;M042 -- Begin changes
  8660                                  ;If messages are to be kept behind, we need to round up the messages to
  8661                                  ;the next para boundary. This is because we have a dummy segment between the
  8662                                  ;data and the resident code segment so that the code segment starts on a
  8663                                  ;para boundary
  8664                                  
  8665                                  	;cmp	cx,offset RESGROUP:ExtMsgEnd	;messages to be resident?
  8666                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  8667                                  	;cmp	cx,0DD8h
  8668 00001DF7 81F9[DC0C]              	cmp	cx,ExtMsgEnd
  8669 00001DFB 7506                    	jne	short calc_res			;no, continue
  8670 00001DFD 83C10F                  	add	cx,15				;round up
  8671 00001E00 83E1F0                  	and	cx,0FFF0h
  8672                                  calc_res:
  8673                                  
  8674                                  ;M042 -- End changes
  8675                                  
  8676                                  	; 18/07/2024
  8677                                  	;xor	ax,ax
  8678                                         	
  8679 00001E03 803E[9926]01            	cmp	byte [FirstCom],1		;is it first command.com?
  8680                                  	;jne	short not_first			;no, do not keep code
  8681                                  	; 06/06/2023
  8682 00001E08 751A                    	jne	short not_first2
  8683                                  
  8684                                  ;We issue a version check call with al=01 to detect if DOS is in HMA. If so,
  8685                                  ;bit 4 of dh is set
  8686                                  
  8687 00001E0A 53                      	push	bx
  8688 00001E0B 51                      	push	cx
  8689                                  	;mov	ax,(Set_CTRL_C_Trapping shl 8) or 06h ;is DOS in HIMEM? ;M013
  8690 00001E0C B80633                  	mov	ax,3306h
  8691 00001E0F CD21                    	int	21h
  8692                                  		; DOS - 5+ Get TRUE Version Number
  8693                                  		; (BL major, BH minor, DL revision, DH flags)
  8694 00001E11 59                      	pop	cx
  8695                                  
  8696                                  ;bugbug: remove version check after testing
  8697                                  
  8698 00001E12 80FB05                  	cmp	bl,5				;bl has true version ; M013
  8699 00001E15 7207                    	jb	short oldver
  8700                                  
  8701 00001E17 31C0                    	xor	ax,ax
  8702 00001E19 80E610                  	and	dh,10h				;is DOS in HMA ; M013
  8703                                  	;pop	bx
  8704                                  	;jnz	short not_first			;DOS in HIMEM, code not
  8705                                  						;	resident
  8706                                  	; 29/01/2023
  8707 00001E1C 7503                    	jnz	short not_first_pop
  8708                                  oldver:
  8709                                  	;mov	ax,offset CODERES:EndCode	;size of code in bytes
  8710                                  	; 06/06/2023
  8711                                  	;;mov	ax,81Ah ; MSDOS 5.0 and MSDOS 6.22 COMMAND.COM
  8712                                  	; 06/06/2023
  8713                                  	; 29/01/2023
  8714                                  	;mov	ax,EndCode-(RCODE_START+100h) ; 23/04/2023
  8715                                  	; 03/05/2023
  8716 00001E1E B87208                  	mov	ax,EndCode-RCODE_START	; 06/06/2023
  8717                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  8718                                  	;mov	ax,894h ; EndCode-RCODE_START
  8719                                  
  8720                                  not_first_pop:
  8721                                  	; 29/01/2023
  8722 00001E21 5B                      	pop	bx
  8723                                  
  8724                                  not_first:
  8725                                  
  8726                                  ;Note that ax = 0 (side effect of int 2fh), if the code is not to be retained
  8727                                  
  8728 00001E22 01C1                    	add	cx,ax
  8729                                  
  8730                                  not_first2:	; 06/06/2023
  8731                                  
  8732                                  ;endif	;not ROMDOS
  8733                                  
  8734 00001E24 83C10F                  	add	cx,15				;round up to next para
  8735 00001E27 D1E9                    	shr	cx,1
  8736 00001E29 D1E9                    	shr	cx,1
  8737 00001E2B D1E9                    	shr	cx,1
  8738 00001E2D D1E9                    	shr	cx,1				;ax = para size of res code
  8739 00001E2F 890E[B404]              	mov	[ResSize],cx			;store resident size
  8740                                  
  8741 00001E33 1F                      	pop	ds
  8742                                  	;assume	ds:nothing
  8743 00001E34 C3                      	retn
  8744                                  
  8745                                  ;ifndef	ROMDOS
  8746                                  
  8747                                  ;bugbug: remove this code (for version independent COMMAND) after testing
  8748                                  
  8749                                  	; 29/01/2023
  8750                                  ;oldver:
  8751                                  ;	pop	bx
  8752                                  ;	;mov	ax,offset CODERES:EndCode	;size of code in bytes
  8753                                  ;	;;mov	ax,81Ah ; MSDOS 5.0 COMMAND.COM
  8754                                  ;	; 29/01/2023
  8755                                  ;	mov	ax,EndCode-RCODE_START
  8756                                  ;	jmp	short not_first
  8757                                  
  8758                                  ;endif	;not ROMDOS
  8759                                  
  8760                                  ;setup_res_end	endp
  8761                                  
  8762                                  ;ifndef	ROMDOS
  8763                                  
  8764                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8765                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1D52h
  8766                                  
  8767                                  	; MSDOS 6.0
  8768                                  ;*** Move_res_code -- This routine moves the resident code to its final 
  8769                                  ; location. We check if DOS is in HIMEM. If so, we try to load ourselves
  8770                                  ; in HIMEM. If we fail, then we remain low and update ResSize to reflect
  8771                                  ; the correct resident size. When remaining low, we have to check if we 
  8772                                  ; need to overlay the messages part of the data segment which is determined
  8773                                  ; by the /msg switch.
  8774                                  ;
  8775                                  ;	ENTRY: ResMsgEnd = end of resident data
  8776                                  ;
  8777                                  ;	EXIT:  The resident code is either up high or in its final location
  8778                                  ;		down low.
  8779                                  ;
  8780                                  ;	REGISTERS AFFECTED: ax,bx,cx,dx,si,di
  8781                                  
  8782                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8783                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:200Eh
  8784                                  	
  8785                                  Move_res_code:	;proc near
  8786                                  
  8787 00001E35 1E                      	push	ds
  8788 00001E36 06                      	push	es
  8789                                  
  8790 00001E37 8CC8                    	mov	ax,cs
  8791 00001E39 8ED8                    	mov	ds,ax
  8792                                  	;assume	ds:RESGROUP
  8793                                  
  8794                                  	;mov	ax,(Set_CTRL_C_Trapping shl 8) or 06h ; M013
  8795 00001E3B B80633                  	mov	ax,3306h
  8796 00001E3E CD21                    	int	21h				;DOS in HIMEM?
  8797                                  		; DOS - 5+ Get TRUE Version Number
  8798                                  		; (BL major, BH minor, DL revision, DH flags)
  8799                                  
  8800 00001E40 80E610                  	and	dh,10h				; M013
  8801 00001E43 7517                    	jnz	short move_high			;yes, move code high
  8802                                  
  8803                                  ;Check if messages have been discarded or not
  8804                                  
  8805                                  load_low:
  8806 00001E45 1E                      	push	ds
  8807 00001E46 07                      	pop	es				;es = RESGROUP
  8808 00001E47 8B3E[B204]              	mov	di,[ResMsgEnd]			;end offset in DATARES
  8809                                  	;;mov	bx,offset RESGROUP:ExtMsgEnd	;end offset of messages
  8810                                  	;mov	bx,ExtMsgEnd
  8811                                  
  8812                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8813                                  %if 0	; PCDOS 7.1 COMMAND.COM
  8814                                  
  8815                                  	; 29/01/2023
  8816                                  	cmp	di,ExtMsgEnd
  8817                                  	;cmp	di,bx				;are messages to be kept?
  8818                                  	je	short no_move			;yes, dont move code
  8819                                  ;%else
  8820                                  	; Erdogan Tan - 18/07/2024
  8821                                  	;mov	bx,ExtMsgEnd ; (this bx is not used after here!)
  8822                                  %endif
  8823                                  
  8824                                  ; 18/07/2024
  8825                                  %if 0
  8826                                  	jmp	short setup_move		;es:di points at dest.
  8827                                  %else
  8828                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8829                                  setup_move:
  8830                                  	;mov	si,offset RESGROUP:StartCode
  8831                                  	; 03/05/2023
  8832 00001E4B BE[100D]                	mov	si,RCODE_START  ; Start addr of Resident Code (CODERES segment)
  8833                                  				; 0D40h for MSDOS 5.0 COMMAND.COM
  8834                                  				; 0E10h for PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8835                                  	;mov	cx,offset CODERES:EndCode	;cx = bytes to move
  8836                                  	;mov	cx,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8837                                  	; 06/06/2023
  8838                                  	;mov	cx,EndCode-(RCODE_START+100h) ; 23/04/2023
  8839                                  	; 03/05/2023
  8840 00001E4E B97208                  	mov	cx,EndCode-RCODE_START	; 06/06/2023
  8841                                  	;mov	cx,894h ; PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8842                                  
  8843 00001E51 FC                      	cld
  8844 00001E52 57                      	push	di				;need di for patching offset
  8845 00001E53 F3A4                    	rep	movsb
  8846 00001E55 5F                      	pop	di
  8847                                  patch_up:
  8848 00001E56 E86A01                  	call	patch_stub
  8849 00001E59 07                      	pop	es
  8850 00001E5A 1F                      	pop	ds
  8851                                  	;assume	ds:nothing
  8852 00001E5B C3                      	retn
  8853                                  %endif
  8854                                  
  8855                                  move_high:
  8856                                  
  8857                                  ;We have to call DOS to get the load address in HIMEM for COMMAND
  8858                                  ;We pass in bx the number of bytes we need
  8859                                  
  8860                                  	;mov	bx,offset CODERES:EndCode
  8861                                  	; 29/01/2023
  8862                                  	;;mov	bx,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8863                                  	; 06/06/2023
  8864                                  	;mov	bx,EndCode-(RCODE_START+100h) ; 23/04/2023 ; 06/06/2023
  8865                                  	; 03/05/2023
  8866 00001E5C BB7208                  	mov	bx,EndCode-RCODE_START ; 06/06/2023
  8867                                  	; 18/07/2024
  8868                                  	;mov	bx,894h	 ; PCDOS 7.1 COMMAND.COM
  8869                                  
  8870                                  ;M030;
  8871                                  ; Set di=0ffffh so that we load low in case no one answers this int 2fh
  8872                                  
  8873 00001E5F BFFFFF                  	mov	di,0FFFFh			;DT - in case no-one handles
  8874                                  						;this ; M030
  8875 00001E62 B8024A                  	mov	ax,GET_HMA_ADDR ; 4A02h
  8876 00001E65 CD2F                    	int	2Fh
  8877                                  
  8878                                  ;If the offset = 0xffff, then no HMA available
  8879                                  
  8880 00001E67 83FFFF                  	cmp	di,0FFFFh			;HMA available?
  8881 00001E6A C606[9600]01            	mov	byte [ComInHMA],1		;assume command.com in HMA
  8882 00001E6F 75DA                    	jne	short setup_move		;no error, es:di = memory
  8883                                  
  8884                                  	;mov	byte [ComInHMA],0		;could not load in HMA
  8885                                  	; 29/01/2023	
  8886 00001E71 FE0E[9600]              	dec	byte [ComInHMA] ; 1 -> 0
  8887                                  
  8888                                  ;Zero means that we do not have enough HIMEM. Remain low and update
  8889                                  ;ResSize to reflect this
  8890                                  
  8891 00001E75 8B0E[B204]              	mov	cx,[ResMsgEnd]			;size of data in bytes
  8892                                  	;;mov	ax,offset CODERES:EndCode	;size of code in bytes
  8893                                  	;;mov	ax,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8894                                  	;mov	ax,EndCode-RCODE_START
  8895                                  	;add	cx,ax
  8896                                  	; 06/06/2023
  8897                                  	; 29/01/2023
  8898                                  	;add	cx,(EndCode-(RCODE_START+100h))+15 ; 23/04/2023 ; 06/06/2023
  8899                                  	;add	cx,15				;round up to next para
  8900                                  	; 03/05/2023
  8901 00001E79 81C18108                	add	cx,(EndCode-RCODE_START)+15 ; 06/06/2023
  8902 00001E7D D1E9                    	shr	cx,1
  8903 00001E7F D1E9                    	shr	cx,1
  8904 00001E81 D1E9                    	shr	cx,1
  8905 00001E83 D1E9                    	shr	cx,1				;ax = para size of res code
  8906 00001E85 890E[B404]              	mov	[ResSize],cx			;store resident size
  8907 00001E89 EBBA                    	jmp	short load_low			;let code remain low
  8908                                  
  8909                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8910                                  %if 0	 ; PCDOS 7.1 COMMAND.COM
  8911                                  no_move:
  8912                                  	; 05/05/2023
  8913                                  	;mov	cl,4
  8914                                  	add	di,0Fh
  8915                                  	and	di,0FFF0h			;round it to a para offset
  8916                                  	jmp	short patch_up
  8917                                  
  8918                                  setup_move:
  8919                                  	;mov	si,offset RESGROUP:StartCode
  8920                                  	; 03/05/2023
  8921                                  	mov	si,RCODE_START  ; Start addr of Resident Code (CODERES segment)
  8922                                  				; 0D40h for MSDOS 5.0 COMMAND.COM
  8923                                  				; 0E10h for PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8924                                  	;mov	cx,offset CODERES:EndCode	;cx = bytes to move
  8925                                  	;mov	cx,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8926                                  	; 06/06/2023
  8927                                  	;mov	cx,EndCode-(RCODE_START+100h) ; 23/04/2023
  8928                                  	; 03/05/2023
  8929                                  	mov	cx,EndCode-RCODE_START	; 06/06/2023
  8930                                  	;mov	cx,894h ; PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8931                                  
  8932                                  	cld
  8933                                  	push	di				;need di for patching offset
  8934                                  	rep	movsb
  8935                                  	pop	di
  8936                                  
  8937                                  patch_up:
  8938                                  	call	patch_stub
  8939                                  	pop	es
  8940                                  	pop	ds
  8941                                  	;assume	ds:nothing
  8942                                  	retn
  8943                                  %endif
  8944                                  
  8945                                  ;Move_res_code endp
  8946                                  
  8947                                  ;else	;ROMDOS
  8948                                  ;
  8949                                  ;;***	Move_res_code - ROMDOS version - locate ROM resident
  8950                                  ;
  8951                                  ;Move_res_code	proc
  8952                                  ;
  8953                                  ;	push	es
  8954                                  ;
  8955                                  ;	invoke	FindROMRes		; ES:DI = ptr to ROM resident code
  8956                                  ;	call	patch_stub
  8957                                  ;
  8958                                  ;	pop	es
  8959                                  ;	ret
  8960                                  ;
  8961                                  ;Move_res_code	endp
  8962                                  ;
  8963                                  ;	assume	ds:NOTHING		; to match ending assume above
  8964                                  ;
  8965                                  ;endif	;ROMDOS
  8966                                  
  8967                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8968                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1D52h
  8969                                  
  8970                                  	; MSDOS 6.0
  8971                                  ;*** Alloc_env -- This routine allocates the temporary environment for the
  8972                                  ; Init code to initialize the COMSPEC. This is not a complete environment. 
  8973                                  ; Later on, at EndInit time, a proper sized environment is allocated and
  8974                                  ; the contents of this temporary environment are copied to it. This routine
  8975                                  ; will not be called in case a valid environment is passed to command.com
  8976                                  ;
  8977                                  ;       ENTRY:  FirstCom and initial EnvirSeg set
  8978                                  ;
  8979                                  ;       EXIT:   ax = EnvirSeg = segment of newly allocated environment segment
  8980                                  ;
  8981                                  ;       REGISTERS AFFECTED: ax,bx,cx,dx
  8982                                  
  8983                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  8984                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1F3Fh
  8985                                  
  8986                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8987                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:206Eh
  8988                                  
  8989                                  alloc_env:	;proc near
  8990                                  	;assume ds:nothing
  8991                                  	
  8992 00001E8B 1E                              push    ds
  8993 00001E8C 06                      	push	es
  8994 00001E8D 56                      	push	si
  8995 00001E8E 57                      	push	di
  8996                                  
  8997                                  ; 07/06/2023
  8998                                  ; 29/01/2023 - MSDOS 6.0 COMMAND.COM
  8999                                  ;%if 0
  9000                                  %if 1 
  9001 00001E8F 16                              push    ss
  9002 00001E90 1F                              pop     ds
  9003                                  	;assume ds:RESGROUP
  9004                                  
  9005 00001E91 A1[3A04]                        mov     ax,[EnvirSeg]
  9006                                  
  9007 00001E94 803E[5420]00                    cmp	byte [AllocedEnv],0
  9008 00001E99 7403                            je	short alloc_cont
  9009 00001E9B E91A01                          jmp     alloc_done
  9010                                  
  9011                                  alloc_cont:
  9012 00001E9E 29FF                            sub     di,di                           ; default start
  9013                                          ;mov	bx,SIZE Environment             ; default size needed
  9014                                  	; 29/01/2023
  9015 00001EA0 BBA600                  	mov	bx,ENVIRONSIZ	; mov bx,180 ; 07/06/2023
  9016                                  				; mov bx,166 ; 18/07/2024 ; PCDOS 7.1
  9017 00001EA3 803E[9926]00                    cmp	byte [FirstCom],0		; first COMMAND.COM?
  9018 00001EA8 7462                            je	short alloc_seg			; no
  9019                                  
  9020                                  ;   Check EnvirSeg; if non-zero, then scan it for PATH and COMSPEC;
  9021                                  ;   Record their respective locations and do not add the default vars.
  9022                                  
  9023 00001EAA 09C0                    	or      ax,ax
  9024 00001EAC 745A                    	jz	short alloc_new			; no previous environment
  9025                                  
  9026 00001EAE 8EC0                            mov     es,ax
  9027                                  	;assume es:nothing
  9028                                  
  9029                                  _find_path:
  9030 00001EB0 B000                            mov     al,0
  9031 00001EB2 29FF                            sub     di,di
  9032                                  comp_path:
  9033 00001EB4 AE                              scasb                                   ; end of env?
  9034 00001EB5 7417                    	je	short _find_prompt		; yes
  9035                                  	;je	short find_comspec ; 18/07/2024 ; PCDOS 7.1 COMMAND.COM
  9036 00001EB7 4F                              dec     di
  9037 00001EB8 B90500                          mov     cx,PathStrLen ; mov cx,5 ; "PATH="
  9038                                          ;mov	si,offset RESGROUP:PathString
  9039 00001EBB BE[5520]                	mov	si,PathString	; "PATH="
  9040 00001EBE F3A6                            repe    cmpsb
  9041 00001EC0 7407                            je	short got_path
  9042 00001EC2 B90001                          mov	cx,256
  9043 00001EC5 F2AE                            repne   scasb                           ; find next NULL
  9044 00001EC7 EBEB                            jmp     short comp_path
  9045                                  
  9046                                  got_path:
  9047 00001EC9 C606[5520]00                    mov	byte [PathString],0		; don't add it
  9048                                  
  9049                                  _find_prompt:
  9050                                  
  9051                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9052                                  ;%if 0 ;  PCDOS 7.1 COMMAND.COM
  9053                                  ;	sub     di,di
  9054                                  ;comp_prompt:
  9055                                  ;	scasb                                   ; end of env?
  9056                                  ;	je	short find_comspec		; yes
  9057                                  ;	dec     di
  9058                                  ;	mov     cx,PrmptStrLen2	; mov cx,7
  9059                                  ;	;mov	si,offset RESGROUP:PrmptString
  9060                                  ;	mov	si,PrmptString	; "PROMPT=$P$G"
  9061                                  ;	repe	cmpsb
  9062                                  ;	je	short got_prompt
  9063                                  ;	mov	cx,256
  9064                                  ;	repne	scasb                           ; find next NULL
  9065                                  ;	jmp	short comp_prompt
  9066                                  ;
  9067                                  ;got_prompt:
  9068                                  ;	mov	byte [PrmptString],0		; don't add it
  9069                                  ;%endif
  9070                                  
  9071                                  find_comspec:
  9072 00001ECE 29FF                            sub     di,di
  9073                                  comp_comspec:
  9074 00001ED0 AE                              scasb                                   ; end of env?
  9075 00001ED1 7423                            je	short got_envend		; yes
  9076 00001ED3 4F                              dec     di
  9077 00001ED4 B90800                          mov	cx,ComspStrLen	; mov cx,8
  9078                                  	;mov	si,offset RESGROUP:ComspString
  9079 00001ED7 BE[6D20]                	mov	si,ComspString	; "COMSPEC=\COMMAND.COM"
  9080 00001EDA F3A6                            repe    cmpsb
  9081 00001EDC 7407                            je	short got_comspec
  9082 00001EDE B90001                          mov     cx,256
  9083 00001EE1 F2AE                            repne   scasb                           ; find next NULL
  9084 00001EE3 EBEB                            jmp	short comp_comspec
  9085                                  
  9086                                  got_comspec:
  9087 00001EE5 893E[6B20]                      mov     [ComspOffset],di
  9088                                  
  9089                                  find_envend:
  9090 00001EE9 29FF                            sub     di,di
  9091 00001EEB B90080                          mov     cx,ENVBIG	; 32768		; max env size
  9092                                  comp_envend:
  9093 00001EEE 49                              dec     cx                              ;
  9094 00001EEF AE                              scasb                                   ; end of env?
  9095 00001EF0 7404                            je	short got_envend		; yes
  9096 00001EF2 F2AE                            repne   scasb
  9097 00001EF4 EBF8                            jmp	short comp_envend
  9098                                  
  9099                                  got_envend:
  9100 00001EF6 4F                              dec     di
  9101                                  	; 07/06/2023
  9102 00001EF7 8D9DA600                	lea     bx,[di+ENVIRONSIZ]		; add room for the basics
  9103                                  	; 18/07/2024
  9104                                  	;lea     bx,[di+166] ; PCDOS 7.1 COMMAND.COM - ENVIRONSIZ = 166
  9105                                  
  9106                                  ;   We want to fall through to alloc_new and set up default
  9107                                  ;   path and prompt ONLY IF this is the first process;  in all other
  9108                                  ;   cases, we assume it is a bad idea to try editing the user's environment
  9109                                  
  9110 00001EFB 1E                              push    ds
  9111                                          ;mov	ds,ds:[PDB_Parent_Pid]
  9112 00001EFC 8E1E1600                        mov	ds,[PDB.PARENT_PID]
  9113                                  	;cmp	ds:[PDB_Parent_Pid],0           ; is parent's parent pid field 0?
  9114 00001F00 833E160000              	cmp	word [PDB.PARENT_PID],0
  9115 00001F05 1F                      	pop     ds
  9116 00001F06 7504                            jne	short alloc_seg			; no, we're not the first process
  9117                                                                                  ; so don't muck with the env.
  9118                                  alloc_new:
  9119 00001F08 FE06[5420]              	inc	byte [AllocedEnv]		; note we have virgin env.
  9120                                  
  9121                                  alloc_seg:
  9122                                  
  9123                                  ; Allocate default environment size
  9124                                  
  9125 00001F0C 89D9                            mov     cx,bx                           ; save byte-granular size in CX
  9126 00001F0E 83C30F                          add     bx,15
  9127 00001F11 D1EB                            shr     bx,1
  9128 00001F13 D1EB                            shr     bx,1
  9129 00001F15 D1EB                            shr     bx,1
  9130 00001F17 D1EB                            shr     bx,1                            ; BX = # paras
  9131 00001F19 B448                    	mov	ah,ALLOC ; 48h
  9132 00001F1B CD21                    	int	21h
  9133 00001F1D 7303                            jnc	short init_ok
  9134 00001F1F E99B00                          jmp     init_nomem                      ; insufficient memory, error
  9135                                  
  9136                                  ; If a previous environment existed (ie, DI != 0), then copy it into
  9137                                  ; the new buffer
  9138                                  
  9139                                  init_ok:
  9140 00001F22 8EC0                    	mov	es,ax
  9141                                  	;assume	es:nothing                      ; es = temp env segment
  9142                                  
  9143 00001F24 09FF                    	or      di,di
  9144 00001F26 7412                            jz	short copy_path
  9145                                  
  9146 00001F28 51                              push    cx
  9147 00001F29 1E                              push    ds
  9148 00001F2A 8E1E[3A04]                      mov     ds,[EnvirSeg]
  9149                                          ;assume ds:nothing
  9150 00001F2E 29F6                            sub     si,si
  9151 00001F30 89F9                            mov     cx,di
  9152 00001F32 29FF                            sub     di,di
  9153 00001F34 F3A4                            rep     movsb
  9154 00001F36 1F                              pop     ds
  9155                                          ;assume ds:RESGROUP
  9156 00001F37 59                              pop     cx
  9157 00001F38 29F9                            sub     cx,di
  9158                                  
  9159                                  copy_path:
  9160                                  
  9161                                  ; First clear out (the rest of) the buffer
  9162                                  
  9163 00001F3A 57                              push    di
  9164 00001F3B 29C0                            sub     ax,ax
  9165 00001F3D F3AA                            rep     stosb
  9166 00001F3F 5F                              pop     di
  9167                                  
  9168                                  ; Initialize the path string (PATH=) first
  9169                                  
  9170                                          ;mov	si,offset RESGROUP:PathString   ; DS:SI -> "PATH=\0"
  9171 00001F40 BE[5520]                	mov	si,PathString
  9172 00001F43 3804                            cmp     [si],al				; add it?
  9173 00001F45 744D                            je	short init_prompt		; no
  9174                                  	;;mov	cx,PathStrLen+1                 ;
  9175                                  	;mov	cx,6 ; db "PATH=",0
  9176                                          ; 14/08/2024
  9177 00001F47 B106                    	mov	cl,6
  9178 00001F49 F3A4                    	rep     movsb                           ;
  9179 00001F4B 3806[5420]                      cmp     [AllocedEnv],al			; virgin env?
  9180 00001F4F 7443                            je	short init_prompt		; no
  9181                                  
  9182                                  ; Establish a more reasonable default for the PATH
  9183                                  
  9184                                  	;mov	ah,GET_DEFAULT_DRIVE
  9185 00001F51 B419                    	mov	ah,19h
  9186 00001F53 CD21                    	int	21h
  9187 00001F55 0441                            add     al,'A'                          ; convert to letter
  9188 00001F57 A2[5B20]                        mov     [DefPathString],al              ;
  9189 00001F5A A2[6220]                        mov     [DefPath2String],al             ; now our default paths are complete
  9190                                  
  9191 00001F5D B200                            mov     dl,0                            ; get dir for default drive
  9192 00001F5F 1E                              push    ds                              ;
  9193 00001F60 06                              push    es                              ;
  9194 00001F61 1F                              pop     ds                              ;
  9195 00001F62 C6055C                          mov     byte [di],'\'			;
  9196 00001F65 8D7501                          lea     si,[di+1]                       ; set DS:SI -> available space
  9197                                  	;mov	ah,Current_Dir                  ;
  9198 00001F68 B447                            mov	ah,47h
  9199 00001F6A CD21                    	int     21h                             ;
  9200 00001F6C 1F                              pop     ds                              ;
  9201                                  
  9202                                  	;mov	cx,9 ; db "C:\MSDOS",0
  9203                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  9204                                  	;;mov	cx,7 ; db "C:\DOS",0
  9205                                  	;mov	cx,DefPathStrLen+1 ; 7
  9206                                  	; 14/08/2024 ; ch = 0
  9207 00001F6D B107                    	mov	cl,DefPathStrLen+1 ; 7
  9208                                  	
  9209                                  	;mov	dx,offset RESGROUP:DefPathString
  9210 00001F6F BA[5B20]                	mov	dx,DefPathString	; "C:\MSDOS"
  9211                                  			; 18/07/2024	; "C:\DOS" for PCDOS 7.1 COMMAND.COM
  9212 00001F72 89D6                    	mov	si,dx                           ;
  9213                                          ;mov	ah,CHDir                        ;
  9214 00001F74 B43B                            mov	ah,3Bh
  9215 00001F76 CD21                    	int     21h                             ;
  9216 00001F78 730D                            jnc	short init_setpath		; DefPathString exists!
  9217                                  
  9218                                          ;mov	cx,7 ; db "C:\DOS",0
  9219                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  9220                                  	;;mov	cx,9 ; db "C:\MSDOS",0
  9221                                  	;mov	cx,DefPath2StrLen+1 ; 9
  9222                                  	; 14/08/2024 ; ch = 0
  9223 00001F7A B109                    	mov	cl,DefPath2StrLen+1 ; 9
  9224                                  
  9225                                  	;mov	dx,offset RESGROUP:DefPath2String
  9226 00001F7C BA[6220]                	mov	dx,DefPath2String	; "C:\DOS"
  9227                                  			; 18/07/2024	; "C:\MSDOS" for PCDOS 7.1 COMMAND.COM
  9228 00001F7F 89D6                            mov     si,dx                           ;
  9229                                          ;mov	ah,CHDir                        ;
  9230 00001F81 B43B                            mov	ah,3Bh
  9231 00001F83 CD21                            int     21h                             ;
  9232 00001F85 720D                            jc	short init_prompt		; DefPath2String doesn't exist
  9233                                  
  9234                                  init_setpath:
  9235 00001F87 89FA                            mov     dx,di                           ; success
  9236 00001F89 1E                              push    ds                              ; so restore prev dir
  9237 00001F8A 06                              push    es                              ;
  9238 00001F8B 1F                              pop     ds                              ; DS:DX -> prev dir
  9239                                          ;mov	ah,CHDir                        ;
  9240 00001F8C B43B                            mov	ah,3Bh
  9241 00001F8E CD21                            int     21h                             ;
  9242 00001F90 1F                              pop     ds                              ;
  9243                                  
  9244 00001F91 4F                              dec     di                              ; then copy in DefPathString
  9245 00001F92 F3A4                            rep     movsb                           ; DS:SI -> "C:\\DOS\0"
  9246                                  
  9247                                  ; Initialize the default prompt
  9248                                  
  9249                                  init_prompt:
  9250                                  ;init_compec:	; 18/07/2024 (PCDOS 7.1 COMMAND.COM - RESGROUP:217Ah)
  9251                                  
  9252 00001F94 57                      	push	di				;
  9253 00001F95 29C0                    	sub	ax,ax 				;
  9254                                  	;mov	cx,64				; insure any data read in
  9255                                  	; 14/08/2024
  9256 00001F97 B140                    	mov	cl,64  ; ch = 0
  9257 00001F99 F3AA                    	rep	stosb				; from Current_Dir is zapped
  9258 00001F9B 5F                      	pop	di				;
  9259                                  
  9260                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9261                                  ;%if 0 	; PCDOS 7.1 COMMAND.COM
  9262                                  ;	cmp	[AllocedEnv],al			; virgin env?
  9263                                  ;	je	short init_comspec		; no
  9264                                  ;	;mov	si,offset RESGROUP:PrmptString  ; DS:SI -> "PROMPT=$P$G\0"
  9265                                  ;	mov	si,PrmptString
  9266                                  ;	cmp	[si],al				; add it?
  9267                                  ;	je	short init_comspec		; no
  9268                                  ;	;mov	cx,PrmptStrLen+1                ;
  9269                                  ;	mov	cl,12  ; db "PROMPT=$P$G",0
  9270                                  ;	rep	movsb                           ;
  9271                                  ;%endif
  9272                                  
  9273                                  ; Initialize the Comspec string
  9274                                  
  9275                                  init_comspec:
  9276                                  	; 18/07/2024 (PCDOS 7.1 COMMAND.COM - RESGROUP:2183h)
  9277                                  
  9278 00001F9C 3906[6B20]                      cmp	[ComspOffset],ax		; add it?
  9279 00001FA0 750D                            jne	short init_done			; no
  9280                                          ;lea	ax,[di+8]
  9281 00001FA2 8D4508                  	lea     ax,[di+ComspStrLen]             ;
  9282 00001FA5 A3[6B20]                        mov	[ComspOffset],ax		;
  9283                                          ;mov	si,offset RESGROUP:ComspString  ; DS:SI -> "COMSPEC=\\COMMAND.COM\0"
  9284 00001FA8 BE[6D20]                        mov	si,ComspString
  9285                                  	; 23/07/2024
  9286                                  	;mov	cx,ComspStrLen2+1               ;
  9287                                          ;;mov	cx,21 ; db "COMSPEC=\COMMAND.COM",0
  9288                                  	; 14/08/2024
  9289 00001FAB B115                    	mov	cl,ComspStrLen2+1 ; 21
  9290 00001FAD F3A4                    	rep     movsb                           ;
  9291                                  
  9292                                  init_done:
  9293 00001FAF 8CC0                            mov     ax,es                           ; return env seg in ax
  9294 00001FB1 A3[3A04]                        mov     [EnvirSeg],ax			; save env seg
  9295 00001FB4 FE06[5420]                      inc	byte [AllocedEnv]		; remember that *we* alloced it
  9296                                  %endif
  9297                                  
  9298                                  ; 07/06/2023
  9299                                  ; 29/01/2023 - MSDOS 5.0 COMMAND.COM (RESGROUP:1DC4h)
  9300                                  ;%if 1
  9301                                  %if 0
  9302                                  	;mov	bx,10
  9303                                  	mov	bx,ENVIRONSIZ>>4 ; 160/16
  9304                                  	mov	ah,48h
  9305                                  	int	21h    	; DOS - 2+ - ALLOCATE MEMORY
  9306                                  			; BX = number of 16-byte paragraphs desired
  9307                                  	jc	short init_nomem
  9308                                  
  9309                                  init_ok:
  9310                                  	mov	es,ax
  9311                                  	;assume	es:nothing                      ; es = temp env segment
  9312                                  
  9313                                  	xor	di,di
  9314                                  	mov	ax,di
  9315                                  	;mov	cx,160
  9316                                  	mov	cx,ENVIRONSIZ
  9317                                          rep	stosb
  9318                                  
  9319                                  init_pathstr:
  9320                                  
  9321                                  ; Initialize the path string (PATH=) first
  9322                                  
  9323                                  	push	ss
  9324                                  	pop	ds
  9325                                  
  9326                                          ;mov	si,offset RESGROUP:PathString   ; DS:SI -> "PATH=\0"
  9327                                  	mov	si,PathString
  9328                                  	mov	di,0
  9329                                  init_cp_pathstr:
  9330                                  	lodsb
  9331                                  	stosb
  9332                                  	or	al,al
  9333                                  	jnz	short init_cp_pathstr
  9334                                  
  9335                                  ; Initialize the Comspec string
  9336                                  
  9337                                  init_comspec:
  9338                                          ;mov	si,offset RESGROUP:ComspString  ; DS:SI -> "COMSPEC=\\COMMAND.COM\0"
  9339                                          mov	si,ComspString
  9340                                  	; 05/05/2023
  9341                                  	mov	di,6
  9342                                  init_cp_compstr:
  9343                                  	lodsb
  9344                                  	stosb
  9345                                  	or	al,al
  9346                                  	jnz	short init_cp_compstr
  9347                                  
  9348                                  init_done:
  9349                                          mov     ax,es                           ; return env seg in ax
  9350                                          ;mov	[EnvirSeg],ax			; save env seg
  9351                                          ;inc	byte [AllocedEnv]		; remember that *we* alloced it
  9352                                  %endif
  9353                                  
  9354                                  	; 29/01/2023
  9355                                  alloc_done:
  9356 00001FB8 5F                      	pop	di
  9357 00001FB9 5E                      	pop	si
  9358 00001FBA 07                      	pop	es
  9359 00001FBB 1F                              pop     ds
  9360                                  	;assume	ds:nothing
  9361 00001FBC C3                      	retn
  9362                                  
  9363                                  	; 29/01/2023
  9364                                  init_nomem:
  9365                                  
  9366                                  ;We call the error routine from here. This routine never returns. It either
  9367                                  ;terminates COMMAND with error( if it is not the first invocation ) or hangs
  9368                                  ;the system ( if it is the first COMMAND.COM ).
  9369                                  
  9370 00001FBD E80000                  	call	Alloc_error
  9371                                  
  9372                                  ;Alloc_env	endp
  9373                                  
  9374                                  ;*** Alloc_error: This routine just jumps to the actual label where we 
  9375                                  ; check if this is a permanent or secondary command.com and take the 
  9376                                  ; appropriate action.
  9377                                  ;
  9378                                  ;	ENTRY:	ds = RESGROUP = DATARES
  9379                                  ;
  9380                                  ;	EXIT:	None - does not return
  9381                                  ;
  9382                                  ;	REGISTERS AFFECTED: Does not matter
  9383                                  ;
  9384                                  
  9385                                  ;public Alloc_error
  9386                                  Alloc_error:	;proc	near
  9387                                  
  9388                                  	;jmp	RESGROUP:BadMemErr
  9389                                  	; 29/01/2023
  9390 00001FC0 E955EE                  	jmp	BadMemErr	
  9391                                  	
  9392                                  ;Alloc_error	endp
  9393                                  
  9394                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9395                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1DFFh
  9396                                  
  9397                                  	; MSDOS 6.0
  9398                                  ;*** Patch_stub -- This routine patches in the segment and offset values in
  9399                                  ; the stub table of the various entry points in the resident code segment.
  9400                                  ; Some of them are interrupt entry points and some of them are entries from
  9401                                  ; the transient to the resident code segment.
  9402                                  ;
  9403                                  ;	ENTRY:	ds = RESGROUP
  9404                                  ;		es:di = segment:offset of final location of resident code
  9405                                  ;
  9406                                  ;	EXIT:	All segments and offsets patched into the stub table
  9407                                  ;
  9408                                  ;	REGISTERS AFFECTED: ax, bx, cx, dx, si, di
  9409                                  
  9410                                  patch_stub:	;proc near
  9411                                  	;assume	ds:RESGROUP
  9412                                  	
  9413 00001FC3 06                      	push	es
  9414                                  
  9415 00001FC4 8CC3                    	mov	bx,es			;bx = resident code segment
  9416 00001FC6 89FA                    	mov	dx,di
  9417                                  	;mov	di,offset DATARES:Int2f_Entry
  9418 00001FC8 BF[6600]                	mov	di,Int2f_Entry
  9419                                  	;mov	si,offset RESGROUP:Reloc_Table
  9420 00001FCB BE[7F26]                	mov	si,Reloc_Table
  9421 00001FCE 1E                      	push	ds
  9422 00001FCF 07                      	pop	es			;es = RESGROUP = DATARES
  9423                                  
  9424                                  ;bx:dx = segment:offset of resident code segment
  9425                                  ;es:di = entry point table in stub
  9426                                  ;ds:si = offset table in INIT segment -- offsets of code entry points now
  9427                                  
  9428                                  	;mov	cx,NUM_RELOC_ENTRIES	;number of entry points
  9429 00001FD0 B90B00                  	mov	cx,11 ; MSDOS 5.0 COMMAND.COM
  9430                                  patchlp:
  9431 00001FD3 AD                      	lodsw				;get current offset
  9432 00001FD4 01D0                    	add	ax,dx			;offset it by code seg location 
  9433 00001FD6 AB                      	stosw				;store offset
  9434 00001FD7 89D8                    	mov	ax,bx			
  9435 00001FD9 AB                      	stosw				;store segment 
  9436 00001FDA E2F7                    	loop	patchlp
  9437                                  
  9438 00001FDC 07                      	pop	es
  9439 00001FDD C3                      	retn
  9440                                  
  9441                                  ;Patch_stub	endp
  9442                                  
  9443                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9444                                  
  9445                                  	; MSDOS 6.0
  9446                                  ;*** Patch_segs -- This routine patches the segment values in the dword 
  9447                                  ; pointers that the stub uses to jump to the actual handler. These values 
  9448                                  ; are temporarily needed to handle these interrupts if they occur before
  9449                                  ; the resident is relocated to its final position and all the addresses of
  9450                                  ; the handlers have been updated.
  9451                                  ;
  9452                                  ;	ENTRY:	es = PSP segment = code segment
  9453                                  ;
  9454                                  ;	EXIT:	Current segment values patched into the jump table in the
  9455                                  ;		stub.
  9456                                  ;
  9457                                  ;	REGISTERS AFFECTED: ax, cx, di
  9458                                  
  9459                                  patch_segs:	;proc near
  9460                                  
  9461                                  	;mov	di,offset RESGROUP:Int2f_Entry
  9462 00001FDE BF[6600]                	mov	di,Int2f_Entry 
  9463 00001FE1 B90400                  	mov	cx,4			;we have to patch 4 handlers
  9464 00001FE4 83C702                  	add	di,2
  9465 00001FE7 8CC0                    	mov	ax,es
  9466                                  pseglp:
  9467 00001FE9 AB                      	stosw				;store the segment value
  9468 00001FEA 83C702                  	add	di,2			;skip the next offset value
  9469 00001FED E2FA                    	loop	pseglp
  9470                                  
  9471 00001FEF C3                      	retn
  9472                                  
  9473                                  ;Patch_segs	endp
  9474                                  
  9475                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9476                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1E2Ch
  9477                                  
  9478                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9479                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:20D8h
  9480                                  
  9481                                  	; MSDOS 6.0
  9482                                  ;*** get_XMMAddr -- This routine gets the call address for the XMM driver
  9483                                  ; by issuing the appropriate int 2fh. This is stored in a stub variable 
  9484                                  ; and is used by the stub when we have to jump to the resident in HMA
  9485                                  ;
  9486                                  ;	ENTRY:	ds = RESGROUP
  9487                                  ;
  9488                                  ;	EXIT:	XMMCallAddr = XMM driver far call address
  9489                                  ;
  9490                                  ;	REGISTERS AFFECTED:
  9491                                  ;
  9492                                  
  9493                                  get_XMMAddr:	;proc near
  9494                                  	;assume	ds:RESGROUP
  9495                                  
  9496 00001FF0 06                      	push	es
  9497                                  
  9498                                  	;mov	ax,XMM_MULTIPLEX SHL 8 + XMM_INSTALL_CHECK
  9499 00001FF1 B80043                  	mov	ax,4300h
  9500 00001FF4 CD2F                    	int	2Fh
  9501                                  		; - Multiplex - XMS - INSTALLATION CHECK
  9502                                  		; Return: AL = 80h XMS driver installed
  9503                                  		; AL <> 80h no driver
  9504 00001FF6 3C80                    	cmp	al,80h			; Q: installed
  9505 00001FF8 750D                    	jne	short cXMMexit		; N: set error, quit
  9506                                  ;
  9507                                  ; get the XMM control functions entry point, save it, we
  9508                                  ; need to call it later.
  9509                                  ;
  9510                                  	;mov	ax,XMM_MULTIPLEX SHL 8 + XMM_FUNCTION_ADDR
  9511 00001FFA B81043                  	mov	ax,4310h
  9512 00001FFD CD2F                    	int	2Fh
  9513                                  		; - Multiplex - XMS - GET DRIVER ADDRESS
  9514                                  		; Return: ES:BX -> driver entry point
  9515                                  
  9516 00001FFF 891E[9200]              	mov	[XMMCallAddr], bx
  9517 00002003 8C06[9400]              	mov	[XMMCallAddr+2],es
  9518                                  cXMMexit:
  9519 00002007 07                      	pop	es
  9520 00002008 C3                      	retn				; done
  9521                                  
  9522                                  ;get_XMMAddr	endp
  9523                                  
  9524                                  ;=============================================================================
  9525                                  ; UNINIT.ASM, MSDOS 6.0, 1991
  9526                                  ;=============================================================================
  9527                                  ; 24/09/2018 - Retro DOS v3.0
  9528                                  
  9529                                  ; (30/04/2018 - Retro DOS v2.0, MSDOS 2.11 COMMAND.COM)
  9530                                  
  9531                                  ; TITLE	COMMAND Initialization messages
  9532                                  
  9533                                  ;INIT	SEGMENT PUBLIC PARA
  9534                                  
  9535                                  ; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9536                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9537                                  
  9538                                  	; 25/09/2018
  9539                                  	; (15 bytes filler)
  9540 00002009 00                      	db 0
  9541                                  	;db "25/9/2018 ETAN"
  9542                                  	; 30/01/2023
  9543                                  	;db "30/1/2023 ETAN"
  9544                                  	; 19/06/2023
  9545                                  	;db "19/6/2023 ETAN"
  9546                                  	; 31/07/2024
  9547 0000200A 31352F382F32303234-     	db "15/8/2024 ETAN" ; 15/08/2024
  9547 00002013 204554414E         
  9548 00002018 00                      	db 0
  9549                                  
  9550                                  ; 30/01/2023
  9551                                  %if 0
  9552                                  	; MSDOS 3.3 COMMAND.COM - offset 145Eh
  9553                                  	;dw 0
  9554                                  COPYRIGHTMSG:	; MSDOS 3.3 COMMAND.COM - offset 1460h
  9555                                  	db 0Dh,0Ah
  9556                                  	db 0Dh,0Ah
  9557                                  	db 'Microsoft(R) MS-DOS(R)  Version 3.30'
  9558                                  	db 0Dh,0Ah
  9559                                  	db '             (C)Copyright Microsoft Corp 1981-1987               '
  9560                                  	db ' ',0Dh,0Ah
  9561                                  	db '                                                   ',
  9562                                  	db 0Dh,0Ah,0
  9563                                  
  9564                                  	times	43 db 20h
  9565                                  
  9566                                  _152Fh:	db 'Specified COMMAND search directory bad',0Dh,0Ah,0
  9567                                  BADCOMLKMES:
  9568                                  	dw _152Fh
  9569                                  
  9570                                  _155Ah:	db 'Specified COMMAND search directory bad access denied',0Dh,0Ah,0
  9571                                  BADCOMACCMSG:
  9572                                  	dw _155Ah
  9573                                  
  9574                                  _1593h:	db 'Access denied',0Dh,0Ah,0
  9575                                  ACCDENERR:
  9576                                  	dw _1593h
  9577                                  
  9578                                  _15A5h:	db 'Out of environment space',0Dh,0Ah,0
  9579                                  OUTENVMSG:
  9580                                  	dw _15A5h
  9581                                  
  9582                                  BADVERMSG:
  9583                                  	db 'Incorrect DOS version',0Dh,0Ah,'$'
  9584                                  
  9585                                  BADENVSIZMSG:
  9586                                  	db 'Invalid environment size specified',0Dh,0Ah,'$'
  9587                                  
  9588                                  HEADERPTR:
  9589                                  	dw COPYRIGHTMSG
  9590                                  %endif
  9591                                  
  9592                                  ; 30/01/2023
  9593                                  ;align 16
  9594                                  	; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9595                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1E50h 
  9596                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9597                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:2100h
  9598                                  
  9599                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  9600                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:2200h 
  9601                                  ICONDEV:
  9602 00002019 2F4445562F                      db '/DEV/'
  9603 0000201E 434F4E000000000000      	db 'CON',0,0,0,0,0,0	; Room for 8 char device
  9604                                  BADCSPFL:
  9605 00002027 00                      	db 0
  9606                                  COMSPECT:
  9607 00002028 5C434F4D4D414E442E-     	db '\COMMAND.COM',0
  9607 00002031 434F4D00           
  9608 00002035 00                      	db 0
  9609                                  AUTOBAT:
  9610 00002036 003A5C4155544F4558-     	db 0,':\AUTOEXEC.BAT',0,0Dh
  9610 0000203F 45432E424154000D   
  9611                                  
  9612                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  9613                                  %if 0
  9614                                  ; 07/06/2023
  9615                                  KAUTOBAT:
  9616                                  	db 0,':\KAUTOEXEC.BAT',0,0Dh
  9617                                  %endif
  9618                                   
  9619                                  PRDATTM:
  9620 00002047 FF                      	db -1 ; 0FFh		; Init not to prompt for date time
  9621                                  INITADD:
  9622 00002048 00000000                	dd 0
  9623                                  print_add:
  9624 0000204C [1654]                  	dw Printf_Init
  9625 0000204E 0000                    	dw 0
  9626                                  triage_add:
  9627 00002050 [D430]                  	dw Triage_Init
  9628 00002052 0000                    	dw 0
  9629                                  ;CHUCKENV:
  9630                                  AllocedEnv:
  9631 00002054 00                      	db 0
  9632                                  
  9633                                  ; 30/01/2023 - MSDOS 3.3
  9634                                  ;COMSPOFFSET:
  9635                                  ;ECOMLOC:
  9636                                  ;	;dw 0Eh
  9637                                  ;	;dw offset ENVIRONMENT:ECOMSPEC-10h
  9638                                  ;	dw ECOMSPEC-ENVIRONMENT ; 30/04/2018	
  9639                                  ;COMSPSTRING:
  9640                                  ;	db 'COMSPEC='
  9641                                  
  9642                                  ; 18/07/2024
  9643                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:223Ch
  9644                                  
  9645                                  ; 30/01/2023 - MSDOS 5.0 & MSDOS 6.0
  9646                                  PathString:
  9647 00002055 504154483D00            	db 'PATH=',0
  9648                                  PathStrLen equ ($-PathString)-1
  9649                                  ;;;
  9650                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9651                                  ; MSDOS 6.0
  9652                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9653                                  ; PCDOS 7.1
  9654                                  DefPathString:
  9655                                  	;db 'C:\MSDOS',0
  9656 0000205B 433A5C444F5300          	db 'C:\DOS',0	; 18/07/2024
  9657                                  DefPathStrLen equ ($-DefPathString)-1
  9658                                  DefPath2String:
  9659                                  	;db 'C:\DOS',0
  9660 00002062 433A5C4D53444F5300      	db 'C:\MSDOS',0	; 18/07/2024
  9661                                  DefPath2StrLen equ ($-DefPath2String)-1
  9662                                  
  9663                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9664                                  ; PCDOS 7.1 COMMAND.COM
  9665                                  %if 0
  9666                                  PrmptString:
  9667                                  	db 'PROMPT=$P$G',0
  9668                                  PrmptStrLen equ ($-PrmptString)-1
  9669                                  PrmptStrLen2 equ 7	; length of PROMPT=
  9670                                  %endif
  9671                                  
  9672                                  ; 18/07/2024
  9673                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:2252h
  9674                                  
  9675                                  ComspOffset:
  9676 0000206B 0000                    	dw 0
  9677                                  ;;;
  9678                                  ComspString:
  9679 0000206D 434F4D535045433D5C-     	db 'COMSPEC=\COMMAND.COM',0
  9679 00002076 434F4D4D414E442E43-
  9679 0000207F 4F4D00             
  9680                                  ComspStrLen equ 8		; length of COMSPEC=
  9681                                  ComspStrLen2 equ ($-ComspString)-1
  9682                                  				; length of full COMSPEC
  9683                                  	; 29/01/2023
  9684                                  ;equal_sign:
  9685                                  ;equalsign:
  9686                                  ;	db '='
  9687                                  ;letter_a:
  9688                                  ;lcasea:
  9689                                  ;	db 'a'
  9690                                  ;letter_z:
  9691                                  ;lcasez:
  9692                                  ;	db 'z'
  9693                                  	; 30/01/2023
  9694                                  ;;slash_chr:
  9695                                  ;;	db '/'
  9696                                  ;;bslash_chr:
  9697                                  ;;	db '\'
  9698                                  ;space_chr:
  9699                                  ;;space:
  9700                                  ;	db 20h
  9701                                  ;;letter_p:
  9702                                  ;;	db 'p'
  9703                                  ;;letter_d:
  9704                                  ;;	db 'd'
  9705                                  ;;letter_c:
  9706                                  ;;	db 'c'
  9707                                  	; 16/04/2023
  9708                                  ; MSDOS 5.0 & MSDOS 6.0
  9709                                  ;scswitch:
  9710                                  ;	db 'C'		; Single command
  9711                                  ;;skswitch:
  9712                                  ;	db 'K' ; MSDOS 6.0
  9713                                  ;;letter_A:
  9714                                  ;ucasea: ; 21/01/2023 
  9715                                  ;	db 'A'
  9716                                  
  9717                                  	; 30/01/2023
  9718                                  EnvSiz:
  9719 00002082 0000                    	dw 0		; size user wants to allocate
  9720                                  EnvMax:
  9721 00002084 0000                    	dw 0		; maximum size allowed
  9722                                  OldEnv:
  9723 00002086 0000                    	dw 0		; envirseg at initialization
  9724                                  UsedEnv:
  9725 00002088 0000                    	dw 0		; amount of envirseg used
  9726                                  	; MSDOS 5.0 & MSDOS 6.0
  9727                                  PARS_MSG_OFF:
  9728 0000208A 0000                    	dw 0		; SAVED PARSE ERROR MESSAGE OFFSET
  9729                                  PARS_MSG_SEG:
  9730 0000208C 0000                    	dw 0		; SAVED PARSE ERROR MESSAGE SEGMENT
  9731                                  
  9732                                  ;Do not separate the following two words. Used to call transient PARSE routine
  9733                                  
  9734                                  Init_Parse:
  9735                                  	;dw 4FFBh	; MSDOS 5.0 COMMAND.COM (TRANGROUP:APPEND_PARSE)
  9736                                  init_p:
  9737 0000208E [1254]                  	dw append_parse ; dw 564Bh ; PCDOS 7.1 COMMAND.COM ; 18/07/2024 
  9738                                  initend:
  9739 00002090 0000                    	dw 0		; segment address of end of init
  9740                                  TrnSize:
  9741 00002092 0000                    	dw 0		; size of transient in paragraphs
  9742                                  
  9743                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
  9744                                  %if 0
  9745                                  resetenv:
  9746                                  	;dw 0		; set if we need to setblck env at endinit
  9747                                  	; 23/07/2024
  9748                                  	db 0
  9749                                  %endif
  9750                                  
  9751                                  ext_msg:
  9752 00002094 00                      	db 0		; set if /MSG switch entered
  9753                                  eswitch:
  9754 00002095 00                      	db 0		; set if /e was entered
  9755                                  dswitch:
  9756 00002096 00                      	db 0		; set if /d was entered
  9757                                  parsemes_ptr:
  9758 00002097 0000                    	dw 0		; word to store parse error number
  9759                                  
  9760                                  	; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9761                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1ED6h
  9762                                  
  9763                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9764                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:21A5h
  9765                                  
  9766                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  9767                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:2288h
  9768                                  
  9769                                  	; MSDOS 6.0 (UINIT.ASM, 1991)
  9770                                  ;  The following parse control block is used for COMMAND. This block is
  9771                                  ;  used for parsing during initialization. The syntax for COMMAND is:
  9772                                  ;  COMMAND [/?] [d:][path][/P][/F][/D][/E:xxxxx][/MSG][/C executable]
  9773                                  ;
  9774                                  ;  Anything on the command line after the /C switch will be passed to the
  9775                                  ;  executable command, so if /C is used, it must be specified last. The
  9776                                  ;  /MSG switch can only be specified if the /P switch is specified.
  9777                                  ;
  9778                                  ;  The /? switch causes help text to be displayed. Any other options
  9779                                  ;  on the command line are ignored. Command.com will not load if /?
  9780                                  ;  is specified.
  9781                                  
  9782                                  INTERNAT_INFO:		; used for country info after parsing is completed
  9783                                  PARSE_COMMAND:
  9784 00002099 [9C20]                  	dw COMMAND_PARMS
  9785 0000209B 00                      	db 0			; no extra delimiter
  9786                                  COMMAND_PARMS:
  9787 0000209C 0002                    	db 0,2			; 1 positional parm
  9788 0000209E [BA20]                  	dw COMMAND_FILE
  9789 000020A0 [BA20]                  	dw COMMAND_FILE
  9790                                          ; MSDOS 5.0
  9791                                  	;db 7			; 7 switches
  9792                                  	; MSDOS 6.0
  9793                                  	;db 8 			; 8 switches
  9794                                  	; 07/06/2023
  9795                                  	; MSDOS 6.22
  9796                                  	;db 9			; 9 switches
  9797                                  	; 22/07/2024
  9798                                  	; PCDOS 7.1
  9799 000020A2 0B                      	db 11			; 11 switches
  9800 000020A3 [C320]                  	dw COMMAND_SWITCH1
  9801 000020A5 [CF20]                  	dw COMMAND_SWITCH2
  9802 000020A7 [DB20]                  	dw COMMAND_SWITCH3
  9803 000020A9 [E720]                  	dw COMMAND_SWITCH4
  9804 000020AB [0021]                  	dw COMMAND_SWITCH5
  9805 000020AD [0C21]                  	dw COMMAND_SWITCH6
  9806 000020AF [1A21]                  	dw COMMAND_SWITCH7
  9807                                  	; 07/06/2023
  9808 000020B1 [2621]                  	dw COMMAND_SWITCH8 ; MSDOS 6.0
  9809 000020B3 [3221]                  	dw COMMAND_SWITCH9 ; MSDOS 6.22
  9810                                  	; 22/07/2024
  9811 000020B5 [3E21]                  	dw COMMAND_SWITCH10 ; PCDOS 7.1
  9812 000020B7 [4A21]                  	dw COMMAND_SWITCH11 ; PCDOS 7.1
  9813 000020B9 00                      	db 0			; no keywords
  9814                                  
  9815                                  COMMAND_FILE:
  9816 000020BA 0102                    	dw 0201h		; filespec - optional
  9817 000020BC 0100                    	dw 1			; capitalize - file table
  9818 000020BE [5621]                  	dw COMND1_OUTPUT	; result buffer
  9819 000020C0 [5E21]                  	dw NO_VAL 		;
  9820 000020C2 00                      	db 0			; no keywords
  9821                                  
  9822                                  COMMAND_SWITCH1:
  9823 000020C3 0000                    	dw 0			; no match flags
  9824 000020C5 0200                    	dw 2			; capitalize by char table
  9825 000020C7 [5621]                  	dw COMND1_OUTPUT	; result buffer
  9826 000020C9 [5E21]                  	dw NO_VAL 		;
  9827 000020CB 01                      	db 1			; 1 keyword
  9828                                  COMMAND_P_SYN:
  9829 000020CC 2F5000                  	db '/P',0		; /P switch
  9830                                  
  9831                                  COMMAND_SWITCH2:
  9832 000020CF 0000                    	dw 0			; no match flags
  9833 000020D1 0200                    	dw 2			; capitalize by char table
  9834 000020D3 [5621]                  	dw COMND1_OUTPUT	; result buffer
  9835 000020D5 [5E21]                  	dw NO_VAL 		;
  9836 000020D7 01                      	db 1			; 1 keyword
  9837                                  COMMAND_F_SYN:
  9838 000020D8 2F4600                  	db '/F',0		; /F switch
  9839                                  
  9840                                  COMMAND_SWITCH3:
  9841 000020DB 0000                    	dw 0			; no match flags
  9842 000020DD 0200                    	dw 2			; capitalize by char table
  9843 000020DF [5621]                  	dw COMND1_OUTPUT	; result buffer
  9844 000020E1 [5E21]                  	dw NO_VAL 		;
  9845 000020E3 01                      	db 1			; 1 keyword
  9846                                  COMMAND_D_SYN:
  9847 000020E4 2F4400                  	db '/D',0		; /D switch
  9848                                  
  9849                                  COMMAND_SWITCH4:
  9850 000020E7 0080                    	dw 8000h		; numeric value - required
  9851 000020E9 0000                    	dw 0			; no function flags
  9852 000020EB [5621]                  	dw COMND1_OUTPUT	; result buffer
  9853 000020ED [F320]                  	dw COMMAND_E_VAL	; pointer to value list
  9854 000020EF 01                      	db 1			; 1 keyword
  9855                                  COMMAND_E_SYN:
  9856 000020F0 2F4500                  	db '/E',0		; /E switch
  9857                                  
  9858                                  COMMAND_E_VAL:
  9859 000020F3 01                      	db 1			;
  9860 000020F4 01                      	db 1			; 1 range
  9861 000020F5 01                      	db 1			; returned if result
  9862                                  	;dd ENVSML,ENVBIG	; minimum & maximum value
  9863                                  	; MSDOS 5.0 COMMAND.COM (RESGROUP:1F2Bh)
  9864                                  	; PCDOS 7.1 COMMAND.COM (RESGROUP:22E5h)
  9865 000020F6 A0000000                	dd 160	 ; ENVSML	 
  9866 000020FA 00800000                	dd 32768 ; ENVBIG
  9867 000020FE 00                      	db 0			; no numeric values
  9868 000020FF 00                      	db 0			; no string values
  9869                                  
  9870                                  COMMAND_SWITCH5:
  9871 00002100 0000                    	dw 0			; no match flags
  9872 00002102 0200                    	dw 2			; capitalize by char table
  9873 00002104 [5621]                  	dw COMND1_OUTPUT	; result buffer
  9874 00002106 [5E21]                  	dw NO_VAL 		;
  9875 00002108 01                      	db 1			; 1 keyword
  9876                                  COMMAND_C_SYN:
  9877 00002109 2F4300                  	db '/C',0		; /C switch
  9878                                  
  9879                                  COMMAND_SWITCH6:
  9880 0000210C 0000                    	dw 0			; no match flags
  9881 0000210E 0200                    	dw 2			; capitalize by char table
  9882 00002110 [5621]                  	dw COMND1_OUTPUT	; result buffer
  9883 00002112 [5E21]                  	dw NO_VAL 		;
  9884 00002114 01                      	db 1			; 1 keyword
  9885                                  COMMAND_M_SYN:
  9886 00002115 2F4D534700              	db '/MSG',0		; /MSG switch
  9887                                  
  9888                                  COMMAND_SWITCH7:
  9889 0000211A 0000                    	dw 0			; no match flags
  9890 0000211C 0200                    	dw 2			; capitalize by char table
  9891 0000211E [5621]                  	dw COMND1_OUTPUT	; result buffer
  9892 00002120 [5E21]                  	dw NO_VAL 		;
  9893 00002122 01                      	db 1			; 1 keyword
  9894                                  COMMAND_?_SYN:
  9895 00002123 2F3F00                  	db '/?',0 		; /? switch
  9896                                  
  9897                                  	; 07/06/2023
  9898                                  	; MSDOS 6.0
  9899                                  COMMAND_SWITCH8:
  9900 00002126 0000                    	dw 0			; no match flags
  9901 00002128 0200                    	dw 2			; capitalize by char table
  9902 0000212A [5621]                  	dw COMND1_OUTPUT	; result buffer
  9903 0000212C [5E21]                  	dw NO_VAL 		;
  9904 0000212E 01                      	db 1			; 1 keyword
  9905                                  COMMAND_K_SYN:
  9906 0000212F 2F4B00                  	db '/K',0		; /K switch
  9907                                  
  9908                                  	; 07/06/2023
  9909                                  	; MSDOS 6.22
  9910                                  COMMAND_SWITCH9:
  9911 00002132 0000                    	dw 0			; no match flags
  9912 00002134 0200                    	dw 2			; capitalize by char table
  9913 00002136 [5621]                  	dw COMND1_OUTPUT	; result buffer
  9914 00002138 [5E21]                  	dw NO_VAL 		;
  9915 0000213A 01                      	db 1			; 1 keyword
  9916                                  COMMAND_Y_SYN:
  9917 0000213B 2F5900                  	db '/Y',0		; /Y switch
  9918                                  
  9919                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  9920                                  %if 1
  9921                                  	; PCDOS 7.1 COMMAND.COM  - RESGROUP:2336h
  9922                                  COMMAND_SWITCH10:
  9923 0000213E 0000                    	dw 0			; no match flags
  9924 00002140 0200                    	dw 2			; capitalize by char table
  9925 00002142 [5621]                  	dw COMND1_OUTPUT	; result buffer
  9926 00002144 [5E21]                  	dw NO_VAL 		;
  9927 00002146 01                      	db 1			; 1 keyword
  9928                                  COMMAND_H_SYN:
  9929 00002147 2F4800                  	db '/H',0		; /H switch
  9930                                  
  9931                                  COMMAND_SWITCH11:
  9932 0000214A 0000                    	dw 0			; no match flags
  9933 0000214C 0200                    	dw 2			; capitalize by char table
  9934 0000214E [5621]                  	dw COMND1_OUTPUT	; result buffer
  9935 00002150 [5E21]                  	dw NO_VAL 		;
  9936 00002152 01                      	db 1			; 1 keyword
  9937                                  COMMAND_O_SYN:
  9938 00002153 2F4F00                  	db '/O',0		; /O switch
  9939                                  %endif
  9940                                  
  9941                                  COMND1_OUTPUT:
  9942                                  COMND1_TYPE:
  9943 00002156 00                      	db 0			; type
  9944                                  COMND1_CODE:
  9945 00002157 00                      	db 0			; return value
  9946                                  COMND1_SYN:
  9947 00002158 0000                    	dw 0			; synonym pointer
  9948                                  COMND1_ADDR:
  9949 0000215A 00000000                	dd 0			; numeric value / address
  9950                                  				; of string value
  9951                                  NO_VAL:
  9952 0000215E 00                      	db 0			; no values
  9953                                  num_positionals:
  9954 0000215F 0000                    	dw 0			; counter for positionals
  9955                                  old_parse_ptr:
  9956 00002161 0000                    	dw 0			; SI position before calling parser
  9957                                  
  9958                                  	; 30/01/2023
  9959                                  ;***	INITIALIZATION MESSAGES
  9960                                  ;	-------------------------
  9961                                  ;	include	comimsg.inc	;M00
  9962                                  ;-----------------------------------------------------------------------------	
  9963                                  
  9964                                  BADVERMSG:
  9965 00002163 17                      	db 23
  9966 00002164 496E636F7272656374-     	db 'Incorrect DOS version',0Dh,0Ah
  9966 0000216D 20444F532076657273-
  9966 00002176 696F6E0D0A         
  9967                                  OUTENVMSG:
  9968 0000217B 1A                      	db 26
  9969 0000217C 4F7574206F6620656E-     	db 'Out of environment space',0Dh,0Ah
  9969 00002185 7669726F6E6D656E74-
  9969 0000218E 2073706163650D0A   
  9970                                  
  9971                                  ; 07/06/2023
  9972                                  ;COPYRIGHTMSG:
  9973                                  ;	db 94
  9974                                  ;	db 0Dh,0Ah
  9975                                  ;	db 0Dh,0Ah
  9976                                  ;	db 'Microsoft(R) MS-DOS(R) Version 5.00',0Dh,0Ah
  9977                                  ;	db '             (C)Copyright Microsoft Corp 1981-1991.',0Dh,0Ah
  9978                                  
  9979                                  ; 23/07/2024
  9980                                  %if 0
  9981                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9982                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:2286h
  9983                                  COPYRIGHTMSG:
  9984                                  	db 94
  9985                                  	db 0Dh,0Ah
  9986                                  	db 0Dh,0Ah
  9987                                  	db 'Microsoft(R) MS-DOS(R) Version 6.22',0Dh,0Ah
  9988                                  	db '             (C)Copyright Microsoft Corp 1981-1994.',0Dh,0Ah
  9989                                  %else
  9990                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
  9991                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:2385h
  9992                                  COPYRIGHTMSG:
  9993 00002196 64                      	db 100
  9994 00002197 0D0A                    	db 0Dh,0Ah
  9995 00002199 0D0A                    	db 0Dh,0Ah
  9996 0000219B 504320444F53205665-     	db 'PC DOS Version 7.10',0Dh,0Ah
  9996 000021A4 7273696F6E20372E31-
  9996 000021AD 300D0A             
  9997 000021B0 202020202020202020-     	db '             (C)Copyright International Business Machines Corp '
  9997 000021B9 20202020284329436F-
  9997 000021C2 707972696768742049-
  9997 000021CB 6E7465726E6174696F-
  9997 000021D4 6E616C20427573696E-
  9997 000021DD 657373204D61636869-
  9997 000021E6 6E657320436F727020 
  9998 000021EF 313938312D32303032-     	db '1981-2002.',0Dh,0Ah
  9998 000021F8 2E0D0A             
  9999                                  %endif
 10000                                  
 10001                                  BADCOMLKMES:
 10002 000021FB 28                      	db 40
 10003 000021FC 537065636966696564-     	db 'Specified COMMAND search directory bad',0Dh,0Ah
 10003 00002205 20434F4D4D414E4420-
 10003 0000220E 736561726368206469-
 10003 00002217 726563746F72792062-
 10003 00002220 61640D0A           
 10004                                  	; 07/06/2023
 10005                                  BADCOMACCMSG:
 10006 00002224 37                      	db 55
 10007 00002225 537065636966696564-     	db 'Specified COMMAND search directory bad, access denied',0Dh,0Ah
 10007 0000222E 20434F4D4D414E4420-
 10007 00002237 736561726368206469-
 10007 00002240 726563746F72792062-
 10007 00002249 61642C206163636573-
 10007 00002252 732064656E6965640D-
 10007 0000225B 0A                 
 10008                                  HELPMSG1:
 10009 0000225C 38                      	db 56
 10010                                  	;db 'Starts a new copy of the MS-DOS command interpreter.',0Dh,0Ah
 10011                                  	; 23/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 10012 0000225D 537461727473206120-     	db 'Starts a new copy of the PC DOS command interpreter.',0Dh,0Ah
 10012 00002266 6E657720636F707920-
 10012 0000226F 6F6620746865205043-
 10012 00002278 20444F5320636F6D6D-
 10012 00002281 616E6420696E746572-
 10012 0000228A 7072657465722E0D0A 
 10013 00002293 0D0A                    	db 0Dh,0Ah
 10014                                  ;HELPMSG2:
 10015                                  ;	db 70
 10016                                  ;	db 'COMMAND [[drive:]path] [device] [/E:nnnnn] [/P] [/C string] [/MSG]'
 10017                                  ;	db 0Dh,0Ah
 10018                                  ;	db 0Dh,0Ah
 10019                                  	; 07/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 10020                                  HELPMSG2:
 10021 00002295 38                      	db 56
 10022 00002296 434F4D4D414E44205B-     	db 'COMMAND [[drive:]path] [device] [/E:nnnnn] [/P [/MSG]]',0Dh,0Ah
 10022 0000229F 5B64726976653A5D70-
 10022 000022A8 6174685D205B646576-
 10022 000022B1 6963655D205B2F453A-
 10022 000022BA 6E6E6E6E6E5D205B2F-
 10022 000022C3 50205B2F4D53475D5D-
 10022 000022CC 0D0A               
 10023                                  HELPMSG3:
 10024                                  	;db 42
 10025                                  	;db '        [/Y [/C command | /K command]]',0Dh,0Ah
 10026                                  	;db 0Dh,0Ah
 10027                                  	; 23/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 10028 000022CE 34                      	db 52
 10029 000022CF 20202020202020205B-     	db '        [/H] [/O] [/Y [/C command | /K command]]',0Dh,0Ah
 10029 000022D8 2F485D205B2F4F5D20-
 10029 000022E1 5B2F59205B2F432063-
 10029 000022EA 6F6D6D616E64207C20-
 10029 000022F3 2F4B20636F6D6D616E-
 10029 000022FC 645D5D0D0A         
 10030 00002301 0D0A                    	db 0Dh,0Ah
 10031                                  ;HELPMSG3:
 10032                                  HELPMSG4:
 10033 00002303 48                              db 72
 10034 00002304 20205B64726976653A-     	db '  [drive:]path    Specifies the directory containing COMMAND.COM '
 10034 0000230D 5D7061746820202020-
 10034 00002316 537065636966696573-
 10034 0000231F 207468652064697265-
 10034 00002328 63746F727920636F6E-
 10034 00002331 7461696E696E672043-
 10034 0000233A 4F4D4D414E442E434F-
 10034 00002343 4D20               
 10035 00002345 66696C652E0D0A          	db 'file.',0Dh,0Ah
 10036                                  ;HELPMSG4:
 10037                                  HELPMSG5:
 10038 0000234C 4D                      	db 77
 10039 0000234D 202064657669636520-     	db '  device          Specifies the device to use for command input and '
 10039 00002356 202020202020202020-
 10039 0000235F 537065636966696573-
 10039 00002368 207468652064657669-
 10039 00002371 636520746F20757365-
 10039 0000237A 20666F7220636F6D6D-
 10039 00002383 616E6420696E707574-
 10039 0000238C 20616E6420         
 10040 00002391 6F75747075742E0D0A      	db 'output.',0Dh,0Ah
 10041                                  ;HELPMSG5:
 10042                                  HELPMSG6:
 10043 0000239A 45                      	db 69
 10044 0000239B 20202F453A6E6E6E6E-     	db '  /E:nnnnn        Sets the initial environment size to nnnnn bytes.'
 10044 000023A4 6E2020202020202020-
 10044 000023AD 536574732074686520-
 10044 000023B6 696E697469616C2065-
 10044 000023BF 6E7669726F6E6D656E-
 10044 000023C8 742073697A6520746F-
 10044 000023D1 206E6E6E6E6E206279-
 10044 000023DA 7465732E           
 10045 000023DE 0D0A                    	db 0Dh,0Ah
 10046                                  ;HELPMSG6:
 10047                                  HELPMSG7:
 10048 000023E0 4D                      	db 77
 10049 000023E1 20202F502020202020-     	db '  /P              Makes the new Command Interpreter permanent '
 10049 000023EA 202020202020202020-
 10049 000023F3 4D616B657320746865-
 10049 000023FC 206E657720436F6D6D-
 10049 00002405 616E6420496E746572-
 10049 0000240E 707265746572207065-
 10049 00002417 726D616E656E7420   
 10050 0000241F 2863616E2774206578-     	db '(can',27h,'t exit).',0Dh,0Ah
 10050 00002428 6974292E0D0A       
 10051                                  ;HELPMSG7:
 10052                                  HELPMSG8:
 10053                                  	;db 80
 10054                                  	;db '  /C string       Carries out the command specified by string, and '
 10055                                  	;db 'then stops.',0Dh,0Ah
 10056                                  	; 07/06/2023
 10057 0000242E 46                      	db 70
 10058 0000242F 20202F4D5347202020-     	db '  /MSG            Stores all error messages in memory (requires /P).'
 10058 00002438 202020202020202020-
 10058 00002441 53746F72657320616C-
 10058 0000244A 6C206572726F72206D-
 10058 00002453 657373616765732069-
 10058 0000245C 6E206D656D6F727920-
 10058 00002465 287265717569726573-
 10058 0000246E 202F50292E         
 10059 00002473 0D0A                    	db 0Dh,0Ah
 10060                                  
 10061                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
 10062                                  ; PCDOS 7.1 COMMAND.COM
 10063                                  ;***
 10064                                  HELPMSG9:
 10065 00002475 4A                      	db 74
 10066 00002476 20202F482020202020-     	db '  /H              Loads the Command Interpreter into a UMB '
 10066 0000247F 202020202020202020-
 10066 00002488 4C6F61647320746865-
 10066 00002491 20436F6D6D616E6420-
 10066 0000249A 496E74657270726574-
 10066 000024A3 657220696E746F2061-
 10066 000024AC 20554D4220         
 10067 000024B1 696620617661696C61-     	db 'if available.',0Dh,0Ah
 10067 000024BA 626C652E0D0A       
 10068                                  HELPMSG10:
 10069 000024C0 4E                      	db 78
 10070 000024C1 20202F4F2020202020-     	db '  /O              Disables overwrite prompt on COPY,XCOPY,and MOVE '
 10070 000024CA 202020202020202020-
 10070 000024D3 44697361626C657320-
 10070 000024DC 6F7665727772697465-
 10070 000024E5 2070726F6D7074206F-
 10070 000024EE 6E20434F50592C5843-
 10070 000024F7 4F50592C616E64204D-
 10070 00002500 4F564520           
 10071 00002504 636F6D6D616E64732E-     	db 'commands.',0Dh,0Ah
 10071 0000250D 0D0A               
 10072                                  ;***
 10073                                  
 10074                                  ;HELPMSG8:
 10075                                  ; 23/07/2024 - PCDOS 7.1 COMMAND.COM
 10076                                  ;HELPMSG9:
 10077                                  HELPMSG11:
 10078                                  	;db 78
 10079                                  	;db '  /MSG            Specifies that all error messages be stored in '
 10080                                  	;db 'memory. You',0Dh,0Ah
 10081                                  ;HELPMSG9:
 10082                                  	;db 56
 10083                                  	;db '                  need to specify /P with this switch.',0Dh,0Ah
 10084 0000250F 4A                      	db 74
 10085 00002510 20202F592020202020-     	db '  /Y              Steps through the batch program specified by /C'
 10085 00002519 202020202020202020-
 10085 00002522 537465707320746872-
 10085 0000252B 6F7567682074686520-
 10085 00002534 62617463682070726F-
 10085 0000253D 6772616D2073706563-
 10085 00002546 696669656420627920-
 10085 0000254F 2F43               
 10086 00002551 206F72202F4B2E0D0A      	db ' or /K.',0Dh,0Ah
 10087                                  
 10088                                  	; 07/06/2023
 10089                                  ; 23/07/2024
 10090                                  ;HELPMSG10:
 10091                                  HELPMSG12:
 10092 0000255A 3F                      	db 63
 10093 0000255B 20202F4320636F6D6D-     	db '  /C command      Executes the specified command and returns.',0Dh,0Ah
 10093 00002564 616E64202020202020-
 10093 0000256D 457865637574657320-
 10093 00002576 746865207370656369-
 10093 0000257F 6669656420636F6D6D-
 10093 00002588 616E6420616E642072-
 10093 00002591 657475726E732E0D0A 
 10094                                  ; 23/07/2024
 10095                                  ;HELPMSG11:
 10096                                  HELPMSG13:
 10097 0000259A 4B                      	db 75
 10098 0000259B 20202F4B20636F6D6D-     	db '  /K command      Executes the specified command and continues running.'
 10098 000025A4 616E64202020202020-
 10098 000025AD 457865637574657320-
 10098 000025B6 746865207370656369-
 10098 000025BF 6669656420636F6D6D-
 10098 000025C8 616E6420616E642063-
 10098 000025D1 6F6E74696E75657320-
 10098 000025DA 72756E6E696E672E   
 10099 000025E2 0D0A                    	db 0Dh,0Ah
 10100 000025E4 0D0A                    	db 0Dh,0Ah
 10101                                  ;HELPMSG12:
 10102                                  ; 23/07/2024
 10103                                  HELPMSG14:
 10104 000025E6 4C                      	db 76
 10105 000025E7 546865202F5020616E-     	db 'The /P and /MSG switches may be used only when COMMAND is started'
 10105 000025F0 64202F4D5347207377-
 10105 000025F9 697463686573206D61-
 10105 00002602 792062652075736564-
 10105 0000260B 206F6E6C7920776865-
 10105 00002614 6E20434F4D4D414E44-
 10105 0000261D 206973207374617274-
 10105 00002626 6564               
 10106 00002628 206279207573696E67-     	db ' by using',0Dh,0Ah
 10106 00002631 0D0A               
 10107                                  ;HELPMSG13:
 10108                                  ; 23/07/2024
 10109                                  HELPMSG15:
 10110 00002633 2B                      	db 43
 10111 00002634 746865205348454C4C-     	db 'the SHELL command in the CONFIG.SYS file.',0Dh,0Ah
 10111 0000263D 20636F6D6D616E6420-
 10111 00002646 696E2074686520434F-
 10111 0000264F 4E4649472E53595320-
 10111 00002658 66696C652E0D0A     
 10112                                  
 10113                                  HelpMsgs:
 10114 0000265F [5C22]                          dw HELPMSG1
 10115 00002661 [9522]                  	dw HELPMSG2
 10116 00002663 [CE22]                  	dw HELPMSG3
 10117 00002665 [0323]                  	dw HELPMSG4
 10118 00002667 [4C23]                  	dw HELPMSG5
 10119 00002669 [9A23]                  	dw HELPMSG6
 10120 0000266B [E023]                  	dw HELPMSG7
 10121 0000266D [2E24]                  	dw HELPMSG8
 10122 0000266F [7524]                  	dw HELPMSG9
 10123                                  
 10124                                  	; 07/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 10125 00002671 [C024]                  	dw HELPMSG10
 10126 00002673 [0F25]                  	dw HELPMSG11
 10127 00002675 [5A25]                  	dw HELPMSG12
 10128 00002677 [9A25]                  	dw HELPMSG13
 10129                                  
 10130                                  	; 23/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 10131 00002679 [E625]                  	dw HELPMSG14
 10132 0000267B [3326]                  	dw HELPMSG15
 10133                                  
 10134                                  	; 23/04/2023
 10135 0000267D 0000                    	dw 0
 10136                                  
 10137                                  ;-----------------------------------------------------------------------------
 10138                                  
 10139                                  ;SR;
 10140                                  ; This table of offsets is used by the init code to calculate the new offsets
 10141                                  ;for these labels after the resident code has been relocated
 10142                                  
 10143                                  ;Reloc_Table:
 10144                                  	;dw offset CODERES:MsgInt2fHandler
 10145                                  	;dw offset CODERES:Int_2e
 10146                                  	;dw offset CODERES:ContC
 10147                                  	;dw offset CODERES:DskErr
 10148                                  	;dw offset CODERES:Exec_Ret
 10149                                  	;dw offset CODERES:TRemCheck
 10150                                  	;dw offset CODERES:TrnLodCom1
 10151                                  	;dw offset CODERES:LodCom
 10152                                  	;dw offset CODERES:MsgRetriever
 10153                                  	;dw offset CODERES:THeadFix
 10154                                  	;dw offset CODERES:Lh_OffUnlink	; M003
 10155                                  
 10156                                  	; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10157                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:22F6h
 10158                                  
 10159                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10160                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:26C1h
 10161                                  
 10162                                  Reloc_Table:	; 23/07/2024 ; PCDOS 7.1 COMMAND.COM CODERES addresses
 10163 0000267F 9007                    	dw MsgInt2fHandler - RCODE_START  ; 7B2h (RESGROUP:7B2h+X) *
 10164 00002681 7601                    	dw Int_2e - RCODE_START		  ; 170h (RESGROUP:170h+X) *
 10165 00002683 3300                    	dw ContC - RCODE_START		  ; 02Eh (RESGROUP:02Eh+X) *
 10166 00002685 7B04                    	dw DSKERR - RCODE_START		  ; 495h (RESGROUP:495h+X) *
 10167 00002687 2700                    	dw Exec_Ret - RCODE_START	  ; 022h (RESGROUP:022h+X) *
 10168 00002689 A402                    	dw TRemCheck - RCODE_START	  ; 2A6h (RESGROUP:2A6h+X) *
 10169 0000268B 4604                    	dw TrnLodCom1 - RCODE_START	  ; 472h (RESGROUP:472h+X) *
 10170 0000268D AD01                    	dw LodCom - RCODE_START		  ; 1A7h (RESGROUP:1A7h+X) *
 10171 0000268F D307                    	dw MsgRetriever - RCODE_START	  ; 7F5h (RESGROUP:7F5h+X) *
 10172 00002691 C302                    	dw THeadFix - RCODE_START	  ; 2C5h (RESGROUP:2C5h+X) *
 10173 00002693 4C08                    	dw Lh_OffUnlink - RCODE_START	  ; 86Eh (RESGROUP:86Eh+X) *
 10174                                  
 10175                                  	; MSDOS 6.22 COMMAND.COM Reloc_Table CODERES addresses:
 10176                                  	; 738h,177h,035h,445h,029h,2A3h,422h,1AEh,77Bh,2C2h,7F4h
 10177                                  
 10178                                  	; 07/06/2023
 10179                                  	; X = 0D40h for MSDOS 5.0 COMMAND.COM
 10180                                  	; X = 0E50h for MSDOS 6.22 COMMAND.COM
 10181                                  	; 23/07/2024
 10182                                  	; X = 0E10h for PCDOS 7.1 COMMAND.COM
 10183                                  	;; example:
 10184                                  	;;	MsgIn2FHandler is at RESGROUP:15C2h or at CODERES:07B2h
 10185                                  	;;				(in PCDOS 7.1 COMMAND.COM)
 10186                                  
 10187                                  NUM_RELOC_ENTRIES equ ($-Reloc_Table)/2
 10188                                  
 10189                                  ResJmpTable:
 10190 00002695 00000000                	dd 0			; stores prev stub jump table addr
 10191                                  FirstCom:
 10192 00002699 00                      	db 0			; flag set if first command.com
 10193                                  DevFlag:
 10194 0000269A 00                      	db 0
 10195                                  PathFlag:
 10196 0000269B 00                      	db 0
 10197                                  
 10198                                  	;; MSDOS 5.0 COMMAND.COM - RESGROUP:2313h
 10199                                  	;;times 13 db 0
 10200                                  
 10201                                  	; 07/06/2023
 10202                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:26DEh
 10203                                  	;times 2 db 0
 10204                                  
 10205                                  ; 30/01/2023
 10206                                  coderes_end equ $
 10207                                  
 10208                                  ;INIT	ENDS
 10209                                  
 10210                                  ;	END
 10211                                  
 10212                                  ;-----------------------------------------------------------------------------
 10213                                  ; 14/10/2018 (Retro DOS v3.0 COMMAND.COM Signature)
 10214                                  ;-----------------------------------------------------------------------------
 10215                                  
 10216                                  ;db	"Retro DOS v3.0 COMMAND.COM by Erdogan Tan [2018]"
 10217                                  	; 30/01/2023
 10218 0000269C 00                      db	0
 10219                                  ;db	"Retro DOS v4.0 COMMAND.COM by Erdogan Tan [2023]"
 10220                                  	; 07/06/2023
 10221                                  ;db	"Retro DOS v4.2 COMMAND.COM by Erdogan Tan [2023]"
 10222                                  	; 21/07/2024
 10223                                  ;db	"Retro DOS v5.0 COMMAND.COM by Erdogan Tan [2024]"
 10224                                  	; 13/03/2025
 10225 0000269D 526574726F20444F53-     db	"Retro DOS v5.0 COMMAND.COM by Erdogan Tan [2025]"
 10225 000026A6 2076352E3020434F4D-
 10225 000026AF 4D414E442E434F4D20-
 10225 000026B8 6279204572646F6761-
 10225 000026C1 6E2054616E205B3230-
 10225 000026CA 32355D             
 10226 000026CD 00                      db	0
 10227                                  
 10228                                  ;-----------------------------------------------------------------------------
 10229                                  ; 24/09/2018 (Retro DOS v3.0 COMMAND)
 10230                                  ;-----------------------------------------------------------------------------
 10231                                  
 10232                                  ;TAIL    SEGMENT PUBLIC PARA
 10233                                  ;        ORG     0
 10234                                  ;TRANSTART LABEL WORD
 10235                                  ;TAIL    ENDS
 10236                                  
 10237                                  ;ALIGN 16  ; 25/09/2018
 10238                                  
 10239                                  ; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10240                                  
 10241                                  numbertodiv equ ($-StartCode)+100h ; 16/04/2023
 10242                                  numbertomod equ (numbertodiv % 16)
 10243                                  
 10244                                  %if numbertomod>0 & numbertomod<16
 10245 000026CE 00<rep 2h>              	times (16-numbertomod) db 0
 10246                                  %endif
 10247                                  
 10248                                  ; 30/01/2023
 10249                                  ;TRANSTART:
 10250                                  
 10251                                  ; 21/04/2018 (Retro DOS v2.0 COMMAND)
 10252                                  ;	times	128 db 0	
 10253                                  
 10254                                  ;-----------------------------------------------------------------------------
 10255                                  ; SEGMENT - TRANSCODE
 10256                                  ;-----------------------------------------------------------------------------
 10257                                  
 10258                                  ;TRANGROUP: ; 21/04/2018
 10259                                  
 10260                                  ; 31/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10261                                  ;-----------------------------------------------------------------------------
 10262                                  
 10263                                  ; MSDOS 3.3 COMMAND.COM Transient Portion Addresses
 10264                                  
 10265                                  ; 21/04/2018 - Retro DOS v2.0
 10266                                  ; transcom.s (COMMAND.COM source file 2 of 2) code/data addresses 
 10267                                  ; (these values must be changed when transcom.s source code is changed
 10268                                  ; and data offsets are changed)
 10269                                  ;
 10270                                  ; 30/04/2018
 10271                                  ; 29/04/2018
 10272                                  
 10273                                  ; 24/09/2018 (original MSDOS 3.3 COMMAND.COM TrnSeg offset addresses)
 10274                                  ;COMMAND      EQU  012CH
 10275                                  ;DATINIT      EQU  2091H
 10276                                  ;HEADCALL     EQU  428FH
 10277                                  ;TRANSPACEEND EQU  4D5CH
 10278                                  ;TRANDATAEND  EQU  3F44H
 10279                                  
 10280                                  ; 29/04/2018 (original MSDOS 3.3 COMMAND.COM TrnSeg offset addresses)
 10281                                  ;TRIAGE_INIT  EQU  1F15H
 10282                                  ;PRINTF_INIT  EQU  34E0H 
 10283                                  
 10284                                  ;GETEXTERRNUM EQU  1EEEH  ; TRIAGEERROR (GET_EXT_ERR_NUMBER) proc addr	
 10285                                  
 10286                                  ;TPA	EQU  4293H
 10287                                  ;TRNLEN	EQU  04D6H
 10288                                  
 10289                                  ; 20/10/2018 - Retro DOS v3.0 COMMAND.COM transient portion addresses
 10290                                  ;COMMAND      EQU  012CH
 10291                                  ;DATINIT      EQU  206FH
 10292                                  ;HEADCALL     EQU  426FH
 10293                                  ; 09/01/2023
 10294                                  ;TRANSPACEEND EQU  4D3CH
 10295                                  ;TRANDATAEND  EQU  3F24H
 10296                                  ;TRIAGE_INIT  EQU  1EF3H
 10297                                  ;PRINTF_INIT  EQU  34BFH 
 10298                                  ;
 10299                                  ;GETEXTERRNUM EQU  1ECCH  ; TRIAGEERROR (GET_EXT_ERR_NUMBER) proc addr
 10300                                  
 10301                                  ;-----------------------------------------------------------------------------
 10302                                  ; ARENA.INC, MSDOS 6.0, 1991
 10303                                  ;-----------------------------------------------------------------------------
 10304                                  ; 13/10/2018 - Retro DOS 3.0
 10305                                  ; 17/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10306                                  
 10307                                  ;BREAK <Memory arena structure>
 10308                                  
 10309                                  ; (-*-) Same with MSDOS 2.11 & MSDOS 6.0
 10310                                  
 10311                                  ; arena item
 10312                                  
 10313                                  struc ARENA
 10314 00000000 ??                        .signature:	resb 1		; 4D for valid item, 5A for last item
 10315 00000001 ????                      .owner:	resw 1		; owner of arena item
 10316 00000003 ????                      .size:	resw 1		; size in paragraphs of item
 10317                                  endstruc
 10318                                  
 10319                                  ;-----------------------------------------------------------------------------
 10320                                  ;START OF TRANSIENT PORTION
 10321                                  ;This code is loaded at the end of memory and may be overwritten by
 10322                                  ;memory-intensive user programs.
 10323                                  ;-----------------------------------------------------------------------------
 10324                                  
 10325                                  ; 16/04/2023
 10326                                  TRANSTART EQU ($-StartCode)+100h ; 18/04/2023
 10327                                  ; 29/09/2018
 10328                                  ; 31/01/2023 
 10329                                  ;TRANSTART:	; Offset 1660h in original MSDOS 3.3 COMMAND.COM
 10330                                  			
 10331                                  		; 09/01/2023
 10332                                  		; Offset 2320h in original MSDOS 5.0 COMMAND.COM
 10333                                  			
 10334                                  		; 07/06/2023
 10335                                  		; Offset 26E0h in original MSDOS 6.22 COMMAND.COM
 10336                                  
 10337                                  ; 25/09/2018
 10338                                  ; (original MSDOS 3.3 COMMAND.COM TRIAGEERROR offset address)
 10339                                  ;
 10340                                  ; 'GET_EXT_ERR_NUMBER' ('TRIAGEERROR') procedure is at offset 354Eh 
 10341                                  ; in MSDOS 3.3 COMMAND.COM (It is at offset 1EEEh in transient porsion).	 	
 10342                                  ;
 10343                                  ;TRIAGEERROR EQU TRANSTART+GETEXTERRNUM-100H
 10344                                  ;
 10345                                  ;
 10346                                  ;COMTRANS:
 10347                                  ;
 10348                                  ; 20/10/2018 - Retro DOS v3.0	
 10349                                  ;INCBIN	"TRANCOM3.BIN"
 10350                                  ;
 10351                                  ;COMLEN	EQU $-COMTRANS ; End of COMMAND load.
 10352                                  ;
 10353                                  ; 29/04/2018
 10354                                  ;BSS_SIZE EQU TRANSPACEEND-TRANDATAEND	
 10355                                  ;
 10356                                  ;TIMES BSS_SIZE db 0
 10357                                  ;
 10358                                  ;COMLEN	EQU $-COMTRANS ; 30/04/2018
 10359                                  
 10360                                  ;COMMANDCOMSIZE equ $ - 100h
 10361                                  
 10362                                  ; 31/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10363                                  ; ============================================================================
 10364                                  ; --- ('trancom5.s', 31/01/2023 - modified from 'trancom3.s', 20/10/2018) ----
 10365                                  ; ============================================================================
 10366                                  
 10367                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM (MSDOS 6.22 COMMAND.COM)
 10368                                  
 10369                                  ; ----------------------------------------------------------------------------
 10370                                  ; START OF TRANSIENT PORTION
 10371                                  ; ----------------------------------------------------------------------------
 10372                                  ; SEGMENT - TRANSCODE
 10373                                  ; ----------------------------------------------------------------------------
 10374                                  
 10375                                  ; 18/04/2023
 10376                                  section .TRANGROUP  vstart=0  ; 31/01/2023 - Retro DOS v4.0 (& v4.1) 
 10377                                  
 10378                                  ; 18/04/2023
 10379                                  ;-----------------------------------------------------------------------------
 10380                                  ; TRANSCODE segment offset 0
 10381                                  TRANSIENTSTART:
 10382                                  
 10383                                  	; 31/01/2023
 10384 00000000 00<rep 100h>            	times 256 db 0		; Allow for 100H parameter area
 10385                                  
 10386                                  ;============================================================================
 10387                                  ; TCODE.ASM, MSDOS 6.0, 1991
 10388                                  ;============================================================================
 10389                                  ; 12/10/2018 - Retro DOS v3.0
 10390                                  ; 31/01/2023 - Retro DOS v4.0 (& v4.1)
 10391                                  
 10392                                  ;[ORG 100h]
 10393                                  
 10394                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 0100h
 10395                                  
 10396                                  ; ---------------------------------------------------------------------------
 10397                                  		
 10398                                  	; 31/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10399                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:0100h)
 10400                                  
 10401                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10402                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:0100h)
 10403                                  SETDRV:
 10404 00000100 B40E                    	mov	ah,0Eh
 10405                                  	;mov	ah,SET_DEFAULT_DRIVE ; 0Eh
 10406 00000102 CD21                    	int	21h	; DOS -	SELECT DISK
 10407                                  			; DL = new default drive number
 10408                                  			;		(0 = A, 1 = B, ..)
 10409                                  			; Return: AL = number of logical drives
 10410                                  
 10411                                  ; ---------------------------------------------------------------------------
 10412                                  
 10413                                  ; TCOMMAND is the recycle point in COMMAND. Nothing is known here.
 10414                                  ; No registers (CS:IP) no flags, nothing.
 10415                                  
 10416                                  TCOMMAND:
 10417                                  ; 21/07/2024 - PCDOS 7.1 COMMAND.COM - TRANGROUP:0104h
 10418                                  ; Retro DOS v5.0 COMMAND.COM
 10419                                  %if 1
 10420 00000104 90                      	nop
 10421 00000105 90                      	nop
 10422                                  %endif
 10423 00000106 2E8E1E[F59B]            	mov	ds,[cs:RESSEG]
 10424 0000010B B8FFFF                  	mov	ax,-1
 10425 0000010E 8706[A702]              	xchg	ax,[VerVal]
 10426 00000112 83F8FF                  	cmp	ax,-1
 10427 00000115 7404                    	je	short NOSETVER2
 10428 00000117 B42E                    	mov	ah,2Eh
 10429                                  	;mov	ah,SET_VERIFY_ON_WRITE ; 2Eh
 10430 00000119 CD21                    	int	21h	; DOS -	SET VERIFY FLAG
 10431                                  			; DL = 00h,AL = 01h VERIFY on / 00h VERIFY off
 10432                                  NOSETVER2:
 10433 0000011B 2EFF1E[F39B]            	call	far [cs:HEADCALL]   ; Make sure header fixed
 10434 00000120 31ED                    	xor	bp,bp		    ; Flag transient not read
 10435 00000122 833E[A502]FF            	cmp	word [SingleCom],-1
 10436 00000127 7505                    	jne	short COMMAND
 10437                                  _$EXITPREP:
 10438 00000129 0E                      	push	cs
 10439 0000012A 1F                      	pop	ds
 10440 0000012B E9CF23                  	jmp	_$EXIT		; Have finished the single command
 10441                                  
 10442                                  ; ---------------------------------------------------------------------------
 10443                                  ;
 10444                                  ; Main entry point from resident portion.
 10445                                  ;
 10446                                  ;   If BP <> 0, then we have just loaded transient portion otherwise we are
 10447                                  ;   just beginning the processing of another command.
 10448                                  ;
 10449                                  ; ---------------------------------------------------------------------------
 10450                                  
 10451                                  ; We are not always sure of the state of the world at this time. We presume
 10452                                  ; worst case and initialize the relevant registers: segments and stack.
 10453                                  
 10454                                  COMMAND:
 10455 0000012E FC                      	cld
 10456 0000012F 8CC8                    	mov	ax,cs
 10457 00000131 FA                      	cli
 10458 00000132 8ED0                    	mov	ss,ax
 10459                                  	;mov	sp,offset TRANGROUP:STACK
 10460                                  				; 07/06/2023
 10461 00000134 BC[9EA5]                	mov	sp,STACK	; 0AF24h for MSDOS 6.22 COMMAND.COM
 10462                                  				; 09854h for MSDOS 5.0 COMMAND.COM
 10463                                  				; 25/07/2024
 10464                                  				; 0AA2Dh for PCDOS 7.1 COMMAND.COM
 10465 00000137 FB                      	sti
 10466                                  		
 10467 00000138 8EC0                    	mov	es,ax
 10468                                  		
 10469                                  	; MSDOS 6.0
 10470 0000013A 8ED8                    	mov	ds,ax		;AN000; set DS to transient
 10471                                  	;ASSUME	ES:TRANGROUP,DS:TRANGROUP ;AC000;
 10472                                  	;invoke	TSYSLOADMSG	;AN000; preload messages
 10473                                  	; 31/01/2023
 10474 0000013C E8C653                  	call	TSYSLOADMSG
 10475 0000013F C606[369F]00            	mov	byte [append_exec],0 ;AN041; set internal append state off
 10476                                  
 10477                                  	; MSDOS 3.3 (& MSDOS 6.0)
 10478                                  	;mov	ds,[ss:RESSEG]
 10479                                  	; 31/01/2023
 10480 00000144 8E1E[F59B]              	mov	ds,[RESSEG]
 10481 00000148 36C606[D199]80          	mov	byte [ss:UCOMBUF],128 ; Init UCOMBUF	
 10482 0000014E 36C606[549A]80          	mov	byte [ss:COMBUF],128  ; Init COMBUF (Autoexec doing DATE)
 10483                                  
 10484                                  ; If we have just loaded the transient, then we do NOT need to initialize the
 10485                                  ; command buffer. ????  DO WE NEED TO RESTORE THE USERS DIRECTORY ????
 10486                                  ; I guess not: the only circumstances in which we reload the command processor
 10487                                  ; is after a transient program execution. In this case, we let the current
 10488                                  ; directory lie where it may.
 10489                                  
 10490 00000154 09ED                    	or	bp,bp		; See if just read
 10491 00000156 7409                    	jz	short TESTRDIR	; Not read, check user directory
 10492 00000158 36C706[D299]010D        	mov	word [ss:UCOMBUF+1],0D01h ; Reset buffer
 10493 0000015F EB17                    	jmp	short NOSETBUF
 10494                                  TESTRDIR:
 10495 00000161 803E[A102]00            	cmp	byte [RestDir],0
 10496 00000166 7410                    	jz	short NOSETBUF	; User directory OK
 10497 00000168 1E                      	push	ds
 10498                                  
 10499                                  ; We have an unusual situation to handle. The user *may* have changed his
 10500                                  ; directory as a result of an internal command that got aborted. Restoring it
 10501                                  ; twice may not help us: the problem may never go away. We just attempt it
 10502                                  ; once and give up.
 10503                                  
 10504 00000169 C606[A102]00            	mov	byte [RestDir],0 ; Flag users dirs OK
 10505                                  
 10506                                  	; Restore users directory
 10507 0000016E 0E                      	push	cs
 10508 0000016F 1F                      	pop	ds
 10509 00000170 BA[D79A]                	mov	dx,USERDIR1
 10510 00000173 B43B                    	mov	ah,3Bh
 10511                                  	;mov	ah,CHDir ; 3Bh
 10512 00000175 CD21                    	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 10513                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 10514 00000177 1F                      	pop	ds
 10515                                  NOSETBUF:
 10516 00000178 803E[1403]00            	cmp	byte [PipeFiles],0
 10517 0000017D 740A                    	jz	short NOPCLOSE	; Don't bother if they don't exist
 10518 0000017F 803E[1303]00            	cmp	byte [PipeFlag],0
 10519 00000184 7503                    	jnz	short NOPCLOSE	; Don't del if still piping
 10520 00000186 E8972F                  	call	PIPEDEL
 10521                                  NOPCLOSE:
 10522                                  	;mov	byte [0BE9h],0	; MSDOS 3.3
 10523                                  	; 31/01/2023
 10524 00000189 C606[9902]00            	mov	byte [ExtCom],0 ; Flag internal command
 10525 0000018E 8CC8                    	mov	ax,cs		; Get segment we're in
 10526 00000190 8ED8                    	mov	ds,ax
 10527 00000192 50                      	push	ax
 10528                                  			; 07/06/2023 (INTERNATVARS addr = STACK addr)
 10529 00000193 BA[9EA5]                	mov	dx,INTERNATVARS ; 0AF24h for MSDOS 6.22 COMMAND.COM
 10530                                  				; 09854h for MSDOS 5.0 COMMAND.COM
 10531                                  			; 25/07/2024
 10532                                  				; 0AA2Dh for PCDOS 7.1 COMMAND.COM
 10533 00000196 B80038                  	mov	ax,3800h
 10534                                  	;mov	ax,INTERNATIONAL*256 ; 3800h
 10535 00000199 CD21                    	int	21h	; DOS -	2+ - GET COUNTRY-DEPENDENT INFORMATION
 10536                                  			; get current-country info
 10537                                  			; DS:DX	-> buffer for returned info
 10538 0000019B 58                      	pop	ax
 10539 0000019C 2B06[F79B]              	sub	ax,[TPA]	; AX=size of TPA in paragraphs
 10540 000001A0 53                      	push	bx
 10541 000001A1 BB1000                  	mov	bx,16
 10542 000001A4 F7E3                    	mul	bx		; DX:AX=size of TPA in bytes
 10543 000001A6 5B                      	pop	bx
 10544 000001A7 09D2                    	or	dx,dx		; See if over 64K
 10545 000001A9 7403                    	jz	short SAVSIZ	; OK if not
 10546 000001AB B8FFFF                  	mov	ax,-1		; If so, limit to 65535 bytes
 10547                                  SAVSIZ:
 10548                                  
 10549                                  ; AX is the number of bytes free in the buffer between the resident and the
 10550                                  ; transient with a maximum of 64K-1. We round this down to a multiple of 512.
 10551                                  
 10552 000001AE 3D0002                  	cmp	ax,512
 10553 000001B1 7603                    	jbe	short GOTSIZE
 10554                                  	;and	ax,~1FFh
 10555 000001B3 2500FE                  	and	ax,0FE00h	; NOT 511 = NOT 1FF
 10556                                  GOTSIZE:
 10557 000001B6 A3[159C]                	mov	[BYTCNT],ax	; Max no. of bytes that can be buffered
 10558 000001B9 8E1E[F59B]              	mov	ds,[RESSEG]	; All batch work must use resident seg.
 10559                                  
 10560 000001BD F606[9D02]01            	test	byte [EchoFlag],1 
 10561 000001C2 741E                    	jz	short GETCOM	; Don't do the CRLF
 10562 000001C4 E8382F                  	call	SINGLETEST
 10563 000001C7 7219                    	jb	short GETCOM
 10564 000001C9 F606[1303]FF            	test	byte [PipeFlag],0FFh ; -1
 10565 000001CE 7512                    	jnz	short GETCOM
 10566                                  				; G  Don't print prompt in FOR
 10567 000001D0 F606[AB02]FF            	test	byte [ForFlag],0FFh ; -1
 10568 000001D5 750B                    	jnz	short GETCOM
 10569                                  				; G  Don't print prompt if in batch
 10570 000001D7 F706[4902]FFFF          	test	word [Batch],0FFFFh ; -1
 10571 000001DD 7503                    	jnz	short GETCOM
 10572 000001DF E89727                  	call	CRLF2
 10573                                  
 10574                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10575                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:01E0h
 10576                                  GETCOM:
 10577 000001E2 833E[A502]00            	cmp     word [SingleCom],0
 10578 000001E7 750D                    	jnz     short GETCOM2
 10579 000001E9 F706[4902]FFFF          	test    word [Batch],0FFFFh
 10580 000001EF 7505                    	jnz     short GETCOM2
 10581 000001F1 8026[5A04]EF            	and     byte [Y_Flag],0EFh ; Y/N question overwrite flag ; ~10h
 10582                                  
 10583                                  ;GETCOM:	; MSDOS 5.0 COMMAND.COM
 10584                                  GETCOM2:
 10585 000001F6 C606[B002]00            	mov	byte [Call_Flag],0 ; G Reset call flags
 10586 000001FB C606[B102]00            	mov	byte [Call_Batch_Flag],0
 10587 00000200 B419                    	mov	ah,19h
 10588                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
 10589 00000202 CD21                    	int	21h	; DOS -	GET DEFAULT DISK NUMBER
 10590 00000204 36A2[079C]              	mov	[ss:CURDRV],al
 10591 00000208 F606[1303]FF            	test	byte [PipeFlag],0FFh ; -1 ; Pipe has highest presedence
 10592 0000020D 7403                    	jz	short NOPIPE
 10593 0000020F E9DF2F                  	jmp	PIPEPROC	; Continue the pipeline
 10594                                  NOPIPE:
 10595 00000212 F606[9D02]01            	test	byte [EchoFlag],1
 10596 00000217 7417                    	jz	short NOPDRV	; No prompt if echo off
 10597 00000219 E8E32E                  	call	SINGLETEST
 10598 0000021C 7212                    	jb	short NOPDRV
 10599 0000021E F606[AB02]FF            	test	byte [ForFlag],0FFh ; G  Don't print prompt in FOR	
 10600 00000223 750B                    	jnz	short NOPDRV
 10601 00000225 F706[4902]FFFF          	test	word [Batch],0FFFFh ; G  Don't print prompt if in batch
 10602 0000022B 750D                    	jnz	short TESTFORBAT
 10603 0000022D E8C01E                  	call	PRINT_PROMPT	; Prompt the user
 10604                                  NOPDRV:
 10605 00000230 F606[AB02]FF            	test	byte [ForFlag],0FFh ; FOR has next highest precedence
 10606 00000235 7403                    	jz	short TESTFORBAT
 10607 00000237 E9BD0C                  	jmp	FORPROC		; Continue the FOR
 10608                                  
 10609                                  TESTFORBAT:
 10610 0000023A 36C606[A09B]00          	mov	byte [ss:RE_INSTR],0 ; Turn redirection back off	
 10611 00000240 C606[C202]00            	mov	byte [Re_OutStr],0  ; [0C09h] for MSDOS 3.3 
 10612 00000245 C606[C102]00            	mov	byte [Re_Out_App],0 ; [0C08h] for MSDOS 3.3
 10613 0000024A C606[AA02]00            	mov	byte [IfFlag],0	; no more ifs...
 10614 0000024F F706[4902]FFFF          	test	word [Batch],0FFFFh ; Batch has lowest precedence
 10615 00000255 7441                    	jz	short ISNOBAT
 10616                                  
 10617                                  	; 31/01/2023
 10618                                  
 10619                                  	; MSDOS 6.0
 10620                                  
 10621                                  ;	Bugbug:	MULT_SHELL_GET no longer used?
 10622                                  
 10623 00000257 06                      	push	es			;AN000; save ES
 10624 00000258 1E                      	push	ds			;AN000; save DS
 10625                                  	;mov	ax,mult_shell_get	;AN000; check to see if SHELL has command
 10626                                  	; 05/02/2023
 10627 00000259 B80219                  	mov	ax,1902h
 10628 0000025C 8E06[4902]              	mov	es,[Batch]		;AN000; get batch segment
 10629                                  	;mov	di,20h
 10630 00000260 BF2000                  	mov	di,BATCHSEGMENT.BatFile	;AN000; get batch file name
 10631 00000263 0E                      	push	cs			;AN000; get local segment to DS
 10632 00000264 1F                      	pop	ds			;AN000;
 10633                                  	;mov	dx,offset trangroup:combuf ;AN000; pass communications buffer
 10634 00000265 BA[549A]                	mov	dx,COMBUF
 10635 00000268 CD2F                    	int	2Fh			;AN000; call the shell
 10636                                  		; - Multiplex - DOS 4.x only SHELLB.COM - COMMAND.COM INTERFACE
 10637                                  		; ES:DI -> ASCIZ full filename of current batch file, with at least the
 10638                                  		; final filename element uppercased
 10639                                  		; DS:DX -> buffer for results
 10640                                  	;cmp	al,0FFh
 10641 0000026A 3CFF                    	cmp	al,shell_action		;AN000; does shell have a commmand?
 10642 0000026C 1F                      	pop	ds			;AN000; restore DS
 10643 0000026D 07                      	pop	es			;AN000; restore ES
 10644 0000026E 7424                    	jz	short JDOCOM1		;AN000; yes - go process command
 10645                                  
 10646                                  	; MSDOS 3.3 (& MSDOS 6.0)
 10647 00000270 1E                      	push	ds
 10648 00000271 E80E04                  	call	READBAT			; Continue BATCH
 10649 00000274 1F                      	pop	ds
 10650 00000275 C606[B402]00            	mov	byte [NullFlag],0	;G reset no command flag
 10651 0000027A F706[4902]FFFF          	test	word [Batch],0FFFFh
 10652 00000280 7512                    	jnz	short JDOCOM1		;G if batch still in progress continue
 10653 00000282 8B1E[B202]              	mov	bx,[Next_Batch]
 10654                                  	; 31/01/2023
 10655 00000286 09DB                    	or	bx,bx
 10656                                  	;cmp	bx,0			;G see if there is a new batch file
 10657 00000288 740A                    	jz	short JDOCOM1		;G no - go do command
 10658 0000028A 891E[4902]              	mov	[Batch],bx		;G get segment of next batch file
 10659 0000028E C706[B202]0000          	mov	word [Next_Batch],0	;G reset next batch
 10660                                  JDOCOM1:
 10661 00000294 0E                      	push	cs
 10662 00000295 1F                      	pop	ds
 10663                                  	;jmp	short DOCOM1
 10664                                  	; 07/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 10665 00000296 EB5D                    	jmp	short DOCOM0
 10666                                  ISNOBAT:
 10667 00000298 833E[A502]00            	cmp	word [SingleCom],0
 10668 0000029D 741D                    	jz	short REGCOM
 10669                                  	; 07/06/2023 - MSDOS 6.22 COMMAND.COM
 10670 0000029F 8B36[A302]              	mov	si,[SemiPermCom] ;  MSDOS 6.0
 10671                                  	;mov	si,0FFFFh 	 ;  MSDOS 3.3 & MSDOS 5.0
 10672 000002A3 8736[A502]              	xchg	si,[SingleCom]
 10673 000002A7 BF[569A]                	mov	di,COMBUF+2
 10674 000002AA 31C9                    	xor	cx,cx
 10675                                  SINGLELOOP:
 10676 000002AC AC                      	lodsb
 10677 000002AD AA                      	stosb
 10678 000002AE 41                      	inc	cx
 10679 000002AF 3C0D                    	cmp	al,0Dh
 10680 000002B1 75F9                    	jnz	short SINGLELOOP
 10681 000002B3 49                      	dec	cx
 10682 000002B4 0E                      	push	cs
 10683 000002B5 1F                      	pop	ds
 10684 000002B6 880E[559A]              	mov	[COMBUF+1],cl
 10685                                  
 10686                                  ; do NOT issue a trailing CRLF...
 10687                                  
 10688                                  	;jmp	short DOCOM1
 10689                                  	; 07/06/2023
 10690                                  	; MSDOS 6.22 COMMAND.COM
 10691 000002BA EB39                    	jmp	short DOCOM0
 10692                                  
 10693                                  	;nop
 10694                                  
 10695                                  	; 31/01/2023 - Retro DOS v4.0 COMMAND.COM
 10696                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:02A6h
 10697                                  
 10698                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10699                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:02BBh
 10700                                  
 10701                                  ; We have a normal command.  
 10702                                  ; Printers are a bizarre quantity. Sometimes they are a stream and
 10703                                  ; sometimes they aren't. At this point, we automatically close all spool
 10704                                  ; files and turn on truncation mode.
 10705                                  
 10706                                  REGCOM:
 10707                                  	;mov	ax,(ServerCall shl 8) + 9
 10708                                  	; 31/01/2023
 10709 000002BC B8095D                  	mov	ax,5D09h
 10710                                  	;mov	ax,(SERVERCALL<<8)+9
 10711 000002BF CD21                    	int	21h	; DOS -	3.1+ internal -	FLUSH REDIRECTED PRINTER OUTPUT
 10712                                  	;mov	ax,(ServerCall shl 8) + 8
 10713 000002C1 B8085D                  	mov	ax,5D08h
 10714                                  	;mov	ax,(SERVERCALL<<8)+8
 10715 000002C4 B201                    	mov	dl,1
 10716 000002C6 CD21                    	int	21h	; DOS -	3.1+ internal -	SET REDIRECTED PRINTER MODE
 10717                                  			; DL = 00h redirected output is	combined
 10718                                  			;      01h redirected output placed in separate	jobs
 10719                                  			; start	new print job now
 10720 000002C8 0E                      	push	cs
 10721 000002C9 1F                      	pop	ds	; Need local segment to point to buffer
 10722 000002CA BA[D199]                	mov	dx,UCOMBUF
 10723                                  
 10724                                  	; MSDOS 6.0
 10725                                  ;	Try to read interactive command line via DOSKey.
 10726                                  ;	If that fails, use DOS Buffered Keyboard Input.
 10727                                  
 10728                                  	; 31/01/2023
 10729 000002CD B81048                  	mov	ax,4810h	; AX = DOSKey Read Line function
 10730 000002D0 CD2F                    	int	2Fh
 10731 000002D2 09C0                    	or	ax,ax
 10732 000002D4 7404                    	jz	short GOTCOM	; DOSKey gave us a command line
 10733                                  
 10734 000002D6 B40A                    	mov	ah,0Ah
 10735                                  	;mov	ah,Std_Con_String_Input	; AH = DOS Buffered Keyboard Input
 10736 000002D8 CD21                    	int	21h	; DOS -	BUFFERED KEYBOARD INPUT
 10737                                  			; DS:DX	-> buffer
 10738                                  GOTCOM:
 10739 000002DA 8A0E[D199]              	mov	cl,[UCOMBUF]
 10740 000002DE 30ED                    	xor	ch,ch
 10741 000002E0 83C103                  	add	cx,3
 10742 000002E3 BE[D199]                	mov	si,UCOMBUF
 10743 000002E6 BF[549A]                	mov	di,COMBUF
 10744 000002E9 F3A4                    	rep	movsb		; Transfer it to the cooked buffer
 10745                                  
 10746                                  	; -------------
 10747                                  
 10748                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10749                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:02EDh
 10750                                  
 10751 000002EB E88B26                  	call	CRLF2
 10752 000002EE 31C0                    	xor	ax,ax
 10753 000002F0 EB06                    	jmp	short DOCOM2
 10754                                  	; -------------
 10755                                  
 10756                                  DOCOM:
 10757 000002F2 E88426                  	call	CRLF2
 10758                                  
 10759                                  	; -------------
 10760                                  
 10761                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10762                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:02F4h
 10763                                  
 10764                                  
 10765                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 10766                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:02F6h
 10767                                  DOCOM0:
 10768 000002F5 B80100                  	mov	ax,1
 10769                                  DOCOM2:
 10770 000002F8 1E                      	push	ds
 10771 000002F9 8E1E[F59B]              	mov     ds,[RESSEG]
 10772 000002FD A3[FD01]                	mov	[cox_Y_option],ax
 10773 00000300 1F                      	pop	ds
 10774 00000301 BE[549A]                	mov	si,COMBUF
 10775 00000304 8A4C01                  	mov	cl,[si+1]
 10776 00000307 30ED                    	xor	ch,ch
 10777 00000309 83C602                  	add	si,2
 10778 0000030C E82501                  	call	get_cox_y_n_opt
 10779 0000030F 7303                    	jnc	short DOCOM1    ; YES answer
 10780                                  	; 07/06/2023
 10781                                  NULLCOMJ:
 10782 00000311 E90201                  	jmp	NULLCOM         ; NO answer
 10783                                  	; -------------
 10784                                  
 10785                                  	; MSDOS 5.0 & MSDOS 6.0 COMMAND.COM
 10786                                  DOCOM1:
 10787 00000314 E8662A                  	call	PRESCAN		; Cook the input buffer
 10788 00000317 7403                    	jz	short NOPIPEPROC
 10789 00000319 E9502E                  	jmp	PIPEPROCSTRT	; Fire up the pipe
 10790                                  
 10791                                  	; 07/06/2023
 10792                                  ;NULLCOMJ:
 10793                                  	;jmp	NULLCOM
 10794                                  
 10795                                  NOPIPEPROC:
 10796 0000031C E85831                  	call	PARSELINE
 10797 0000031F 730B                    	jnb	short OKPARSE	; user error? or maybe we goofed?
 10798                                  BADPARSE:
 10799 00000321 0E                      	push	cs
 10800 00000322 1F                      	pop	ds
 10801 00000323 BA[FA8F]                	mov	dx,BADNAM_PTR	; 31/01/2023
 10802 00000326 E8F750                  	call	std_eprintf
 10803 00000329 E9D8FD                  	jmp	TCOMMAND
 10804                                  
 10805                                  OKPARSE:
 10806                                  	;test	byte [ARGV0_ARG_FLAGS],2
 10807                                  	;test	byte [ARG+ARGV_ELE.argflags],2 ; wildcard
 10808                                  	; 01/02/2023
 10809 0000032C F606[529F]02            	test	byte [ARG+ARGV_ELE.argflags],2
 10810 00000331 75EE                    	jnz	short BADPARSE	; ambiguous commands not allowed
 10811                                  	;cmp	word [ARG_ARGVCNT],0  ; there WAS a command, wasn't there?
 10812 00000333 833E[10A2]00            	cmp	word [ARG+ARG_UNIT.argvcnt],0
 10813 00000338 74D7                    	jz	short NULLCOMJ
 10814                                  	;cmp	word [ARGV0_ARGLEN],0 ; probably an unnecessary check...
 10815 0000033A 833E[559F]00            	cmp	word [ARG+ARGV_ELE.arglen],0
 10816 0000033F 74D0                    	jz	short NULLCOMJ	; guarantees argv[0] at least x<NULL>
 10817                                  
 10818 00000341 BE[569A]                	mov	si,COMBUF+2
 10819 00000344 BF[BA9C]                	mov	di,IDLEN
 10820                                  	;;mov	ax,(Parse_File_Descriptor shl 8) or 01h
 10821                                  				; Make FCB with blank scan-off
 10822                                  	;mov	ax,(Parse_File_Descriptor<<8)|01h
 10823 00000347 B80129                  	mov	ax,2901h
 10824 0000034A CD21                    	int	21h	; DOS -	PARSE FILENAME
 10825                                  			; DS:SI	-> string to parse
 10826                                  			; ES:DI	-> buffer to fill with unopened	FCB
 10827                                  			; AL = bit mask	to control parsing
 10828                                  	;mov	bx,[ARG_ARGV]
 10829 0000034C 8B1E[509F]              	mov	bx,[ARG+ARG_UNIT.argv] ; mov bx,[ARG]
 10830 00000350 807F013A                	cmp	byte [bx+1],':'	; was a drive specified?
 10831 00000354 751B                    	jne	short DRVGD	; no, use default of zero...
 10832 00000356 8A17                    	mov	dl,[bx]		; pick-up drive letter
 10833                                  	;mov	dl,[bx+ARGV_ELE.argpointer] ; mov dl,[bx+0]
 10834                                  	;and	dl,~20h
 10835 00000358 80E2DF                  	and	dl,0DFh		; uppercase the sucker
 10836                                  	;sub	dl,[CAPITAL_A]	; convert it to a drive number, A=0
 10837                                  	; 31/01/2023
 10838 0000035B 80EA41                  	sub	dl,'A'
 10839 0000035E 3CFF                    	cmp	al,-1		; See what PARSE said about our drive letter.
 10840 00000360 740C                    	je	short DRVBADJ	; It was invalid.
 10841                                  	;mov	di,[ARGV0_ARGSTARTEL]
 10842 00000362 8B3E[539F]              	mov	di,[ARG+ARGV_ELE.argstartel]
 10843 00000366 803D00                  	cmp	byte [di],0	; is there actually a command there?
 10844 00000369 7506                    	jne	short DRVGD	; if not, we have:  "d:", "d:\", "d:/"
 10845 0000036B E992FD                  	jmp	SETDRV		; and set drive to new drive spec
 10846                                  DRVBADJ:
 10847 0000036E E9B128                  	jmp	DRVBAD
 10848                                  DRVGD:
 10849 00000371 8A05                    	mov	al,[di]
 10850 00000373 A2[149C]                	mov	[SPECDRV],al
 10851 00000376 B020                    	mov	al,' '
 10852 00000378 B90900                  	mov	cx,9
 10853 0000037B 47                      	inc	di
 10854 0000037C F2AE                    	repne	scasb		; Count number of letters in command name
 10855 0000037E B008                    	mov	al,8
 10856 00000380 28C8                    	sub	al,cl
 10857 00000382 A2[BA9C]                	mov	[IDLEN],al	; IDLEN is truly the length
 10858 00000385 BF8100                  	mov	di,81h
 10859 00000388 56                      	push	si
 10860 00000389 BE[569A]                	mov	si,COMBUF+2	; Skip over all leading delims
 10861 0000038C E8F725                  	call	scanoff
 10862                                  
 10863                                  	; 01/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10864                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0356h
 10865                                  
 10866                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10867                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0391h
 10868                                  
 10869                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 10870                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0393h
 10871                                  
 10872                                  	; MSDOS 6.0
 10873                                  ;SR;
 10874                                  ; We are going to skip over the first char always. The logic is that the
 10875                                  ;command tail can never start from the first character. The code below is 
 10876                                  ;trying to figure out the command tail and copy it to the command line 
 10877                                  ;buffer in the PSP. However, if the first character happens to be a switch
 10878                                  ;character and the user given command line is a full 128 bytes, we try to
 10879                                  ;copy 128 bytes to the PSP while it can take only 127 chars. This extra
 10880                                  ;char overwrites the code and leads to a crash on future commands.
 10881                                  
 10882 0000038F 46                      	inc	si ;  MSDOS 6.0
 10883                                  
 10884                                  DO_SKIPCOM:
 10885 00000390 AC                      	lodsb			; move command line pointer over
 10886 00000391 E8FA25                  	call	DELIM		; pathname -- have to do it ourselves
 10887 00000394 740A                    	jz	short DO_SKIPPED ; 'cause parse_file_descriptor is dumb
 10888 00000396 3C0D                    	cmp	al,0Dh		; can't always depend on argv[0].arglen
 10889 00000398 7406                    	jz	short DO_SKIPPED ; to be the same length as the user-
 10890 0000039A 3A06[F99B]              	cmp	al,[SWITCHAR]	; specified command string
 10891 0000039E 75F0                    	jnz	short DO_SKIPCOM 
 10892                                  DO_SKIPPED:
 10893 000003A0 4E                      	dec	si
 10894 000003A1 31C9                    	xor	cx,cx
 10895                                  COMTAIL:
 10896 000003A3 AC                      	lodsb
 10897 000003A4 AA                      	stosb			; Move command tail to 80h
 10898 000003A5 3C0D                    	cmp	al,0Dh
 10899 000003A7 E0FA                    	loopne	COMTAIL
 10900 000003A9 4F                      	dec	di
 10901 000003AA 89FD                    	mov	bp,di
 10902 000003AC F6D1                    	not	cl
 10903 000003AE 880E8000                	mov	[80h],cl
 10904 000003B2 5E                      	pop	si
 10905                                  ;-----
 10906                                  ; Some of these comments are sadly at odds with this brave new code.
 10907                                  ;-----
 10908                                  ; If the command has 0 parameters must check here for
 10909                                  ; any switches that might be present.
 10910                                  ; SI -> first character after the command.
 10911                                  
 10912                                  	;mov	di,arg.argv[0].argsw_word
 10913                                  	;mov	di,[ARGV0_ARGSW_WORD]
 10914 000003B3 8B3E[579F]              	mov	di,[ARG+ARGV_ELE.argsw_word]
 10915 000003B7 893E[0B9C]              	mov	[COMSW],di	; ah yes, the old addressing mode problem...
 10916                                  	;mov	SI,arg.argv[1 * SIZE argv_ele].argpointer  
 10917                                  				; s = argv[1];
 10918                                  	;mov	si,[ARGV1_ARGPOINTER]
 10919 000003BB 8B36[5B9F]              	mov	si,[ARG+ARGV_ELE.SIZE+ARGV_ELE.argpointer]
 10920 000003BF 09F6                    	or	si,si		;   if (s == NULL)
 10921 000003C1 7502                    	jnz	short DOPARSE	;	s = bp; (buffer end)
 10922 000003C3 89EE                    	mov	si,bp
 10923                                  DOPARSE:
 10924 000003C5 BF5C00                  	mov	di,FCB ; 5Ch
 10925                                  	;mov	ax,(Parse_File_Descriptor shl 8) or 01h
 10926                                  	; 01/02/2023
 10927 000003C8 B80129                  	mov	ax,2901h
 10928                                  	;mov	ax,(Parse_File_Descriptor<<8)|01h
 10929 000003CB CD21                    	int	21h	; DOS -	PARSE FILENAME
 10930                                  			; DS:SI	-> string to parse
 10931                                  			; ES:DI	-> buffer to fill with unopened	FCB
 10932                                  			; AL = bit mask	to control parsing
 10933 000003CD A2[089C]                	mov	[PARM1],al	; Save result of parse
 10934                                  	;mov	di,arg.argv[1*SIZE argv_ele].argsw_word
 10935                                  	;mov	di,[ARGV1_ARGSW_WORD]
 10936 000003D0 8B3E[629F]              	mov	di,[ARG+ARGV_ELE.SIZE+ARGV_ELE.argsw_word]
 10937 000003D4 893E[0D9C]              	mov	[ARG1S],di
 10938                                  	;mov	si,arg.argv[2*SIZE argv_ele].argpointer    
 10939                                  				; s = argv[2];
 10940                                  	;mov	si,[ARGV2_ARGPOINTER]
 10941 000003D8 8B36[669F]              	mov	si,[ARG+(2*ARGV_ELE.SIZE)+ARGV_ELE.argpointer]
 10942 000003DC 09F6                    	or	si,si		; if (s == NULL)
 10943 000003DE 7502                    	jnz	short DOPARSE2
 10944 000003E0 89EE                    	mov	si,bp		;     s = bp; (buffer end)
 10945                                  DOPARSE2:			
 10946 000003E2 BF6C00                  	mov	di,FCB+10h ; 6Ch
 10947                                  	;;mov	ax,(Parse_File_Descriptor shl 8) or 01h
 10948 000003E5 B80129                  	mov	ax,2901h
 10949                                  	;mov	ax,(Parse_File_Descriptor<<8)|01h
 10950 000003E8 CD21                    	int	21h	; DOS -	PARSE FILENAME
 10951                                  			; DS:SI	-> string to parse
 10952                                  			; ES:DI	-> buffer to fill with unopened	FCB
 10953                                  			; AL = bit mask	to control parsing
 10954 000003EA A2[0A9C]                	mov	[PARM2],al	; Save result
 10955                                  	;mov	di,[ARGV2_ARGSW_WORD]
 10956                                  	;mov	di,arg.argv[2*SIZE argv_ele].argsw_word
 10957 000003ED 8B3E[6D9F]              	mov	di,[ARG+(2*ARGV_ELE.SIZE)+ARGV_ELE.argsw_word]
 10958 000003F1 893E[0F9C]              	mov	[ARG2S],di
 10959                                  	;mov	di,[ARGV0_ARGSW_WORD]
 10960                                  	;mov	di,arg.argv[0].argsw_word
 10961 000003F5 8B3E[579F]              	mov	di,[ARG+ARGV_ELE.argsw_word]
 10962 000003F9 F7D7                    	not	di		; ARGTS doesn't include the flags
 10963                                  	;and	di,[ARG_ARGSWINFO] ; from COMSW...
 10964                                  	;and	di,arg.argswinfo	
 10965 000003FB 233E[12A2]              	and	di,[ARG+ARG_UNIT.argswinfo]
 10966 000003FF 893E[119C]              	mov	[ARGTS],di
 10967                                  
 10968 00000403 A0[BA9C]                	mov	al,[IDLEN]
 10969 00000406 8A16[149C]              	mov	dl,[SPECDRV]
 10970 0000040A 08D2                    	or	dl,dl		; if a drive was specified...
 10971 0000040C 7505                    	jnz	short EXTERNALJ1 ; it MUST be external, by this time
 10972 0000040E FEC8                    	dec	al		; (I don't know why -- old code did it)
 10973 00000410 E96227                  	jmp	FNDCOM		; otherwise, check internal com table
 10974                                  EXTERNALJ1:
 10975 00000413 E96428                  	jmp	EXTERNAL
 10976                                  NULLCOM:
 10977 00000416 8E1E[F59B]              	mov	ds,[RESSEG]
 10978 0000041A F706[4902]FFFF          	test	word [Batch],0FFFFh ; -1 ;G Are we in a batch file?
 10979 00000420 7405                    	jz	short NOSETFLAG	  ;G only set flag if in batch
 10980 00000422 C606[B402]01            	mov	byte [NullFlag],1 ;G set flag to indicate no command
 10981                                  	;mov	byte [NullFlag],nullcommand ; 1
 10982                                  NOSETFLAG:
 10983 00000427 833E[A502]FF            	cmp	word [SingleCom],0FFFFh ; -1
 10984 0000042C 7403                    	je	short EXITJ
 10985 0000042E E9B1FD                  	jmp	GETCOM
 10986                                  EXITJ:
 10987 00000431 E9F5FC                  	jmp	_$EXITPREP
 10988                                  
 10989                                  ; 07/06/2023
 10990                                  ; ---------------------------------------------------------------------------
 10991                                  ; MSDOS 6.2(2) COMMAND.COM procedure only !
 10992                                  ; -----------------------------------------
 10993                                  ; Hex-Rays IDA / disassembled source code ! modified for NASM by Erdogan Tan
 10994                                  ; ---------------------------------------------------------------------------
 10995                                  
 10996                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10997                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0436h
 10998                                  
 10999                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 11000                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0438h
 11001                                  get_cox_y_n_opt:
 11002 00000434 E339                    	jcxz	ccydp4		; empty	input buffer
 11003                                  ccydp0:
 11004 00000436 803C0D                  	cmp	byte [si],0Dh
 11005 00000439 7434                    	je	short ccydp4
 11006 0000043B 803C0A                  	cmp	byte [si],0Ah
 11007 0000043E 742F                    	je	short ccydp4
 11008 00000440 06                      	push	es
 11009 00000441 8E06[F59B]              	mov	es,[RESSEG]
 11010 00000445 26A0[5A04]              	mov	al,[es:Y_Flag]
 11011 00000449 A810                    	test	al,10h		; bit 1	= 1 -> Y/N answer is needed
 11012 0000044B 7421                    	jz	short ccydp3 ; cf=0 ; 07/06/2023
 11013 0000044D 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],1 ; (in) Batch file ?
 11014 00000453 7419                    	je	short ccydp3	; yes, don't check for ESCAPE
 11015 00000455 A840                    	test	al,40h		; ESCAPE status
 11016                                  				; (bit 4 is zero if Y/N	is escaped)
 11017 00000457 7417                    	jz	short ccydp5
 11018                                  ccydp1:
 11019 00000459 26F706[4902]FFFF        	test	word [es:Batch],0FFFFh
 11020 00000460 740B                    	jz	short ccydp2
 11021 00000462 268E06[4902]            	mov	es,[es:Batch]
 11022                                  	;mov	byte [es:2],1 ; [es:BATCHSEGMENT.BatchEOF]
 11023 00000467 26C606020001            	mov	byte [es:BATCHSEGMENT.BatchEOF],1
 11024                                  ccydp2:
 11025 0000046D F9                      	stc
 11026                                  ccydp3:		; 07/06/2023 ; cf = 0
 11027 0000046E 07                      	pop	es
 11028                                  ccydp4:		; 07/06/2023 ; cf = 0
 11029 0000046F C3                      	retn
 11030                                  
 11031                                  ;ccydp3:
 11032                                  ;	pop	es
 11033                                  ;ccydp4:
 11034                                  ;	clc
 11035                                  ;	retn
 11036                                  
 11037                                  ccydp5:
 11038 00000470 89F2                    	mov	dx,si
 11039 00000472 BB0200                  	mov	bx,2
 11040 00000475 B440                    	mov	ah,40h
 11041 00000477 CD21                    	int	21h	; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 11042                                  			; BX = file handle, CX = number	of bytes to write
 11043                                  			; DS:DX -> buffer
 11044 00000479 BA[9592]                	mov	dx,cox_Y_quest_ptr ; msg number	pointer	of ' [Y/N]?'
 11045                                  				   ; (is 1082)
 11046 0000047C E8A14F                  	call	std_eprintf
 11047 0000047F 1E                      	push	ds
 11048 00000480 B83B04                  	mov	ax,1083	; cox_Y_answer number (overwrite Y/N answer letter)
 11049 00000483 B6FF                    	mov	dh,0FFh		; utility_msg_class
 11050 00000485 E88350                  	call	TSYSGETMSG
 11051                                  	;mov	cx,'NY' ; MASM word format
 11052                                  	; NASM word format
 11053 00000488 B9594E                  	mov	cx,'YN'        ; 'YN' Yes/No (CL=Y)
 11054 0000048B 7202                    	jc	short ccydp6
 11055 0000048D 8B0C                    	mov	cx,[si]
 11056                                  ccydp6:
 11057 0000048F 1F                      	pop	ds
 11058                                  ccydp7:
 11059 00000490 B408                    	mov	ah,8
 11060 00000492 CD21                    	int	21h	; DOS -	KEYBOARD INPUT,	NO ECHO
 11061                                  			; Return: AL = character
 11062 00000494 84C0                    	test	al,al
 11063 00000496 7510                    	jnz	short ccydp8
 11064 00000498 B408                    	mov	ah,8
 11065 0000049A CD21                    	int	21h	; DOS -	KEYBOARD INPUT,	NO ECHO
 11066                                  			; Return: AL = character
 11067 0000049C 3C3F                    	cmp	al,'?'
 11068 0000049E 75F0                    	jne	short ccydp7
 11069 000004A0 26800E[5A04]40          	or	byte [es:Y_Flag],40h ; bit 4, question flag
 11070 000004A6 EBB1                    	jmp	short ccydp1
 11071                                  ccydp8:
 11072 000004A8 3C1B                    	cmp	al,1Bh		; ESCAPE ?
 11073 000004AA 7509                    	jne	short ccydp9
 11074 000004AC 268026[5A04]EF          	and	byte [es:Y_Flag],0EFh ; (ESCAPE) Clear bit 4 ; ~10h
 11075                                  	;jmp	short ccydp12
 11076                                  	; 07/06/2023
 11077 000004B2 9C                      	pushf
 11078 000004B3 EB18                    	jmp	short ccydp12
 11079                                  ccydp9:
 11080                                  	; 25/07/2024 - PCDOS 7.1 COMMAND.COM
 11081 000004B5 3C41                    	cmp     al,41h ; 'A'
 11082 000004B7 7202                    	jb      short ccydp13
 11083                                  	;
 11084 000004B9 24DF                    	and	al,0DFh		; uppercase
 11085                                  ccydp13:	; 25/07/2024
 11086 000004BB 38E8                    	cmp	al,ch		; NO character (N)
 11087 000004BD 7503                    	jne	short ccydp10
 11088 000004BF F9                      	stc
 11089 000004C0 EB04                    	jmp	short ccydp11	; cf = 1 -> overwrite NO answer
 11090                                  ccydp10:
 11091 000004C2 38C8                    	cmp	al,cl		; YES character	(Y)
 11092 000004C4 75CA                    	jne	short ccydp7
 11093                                  ccydp11:
 11094 000004C6 9C                      	pushf			; cf = 0 -> overwrite YES answer
 11095 000004C7 88C2                    	mov	dl,al
 11096 000004C9 B402                    	mov	ah,2
 11097 000004CB CD21                    	int	21h	; DOS -	DISPLAY	OUTPUT
 11098                                  			; DL = character to send to standard output
 11099                                  	; 07/06/2023
 11100                                  	;popf
 11101                                  ccydp12:
 11102                                  	;pushf
 11103 000004CD E8A924                  	call	CRLF2
 11104 000004D0 9D                      	popf
 11105 000004D1 07                      	pop	es
 11106 000004D2 C3                      	retn
 11107                                  
 11108                                  ;============================================================================
 11109                                  ; MSHALO.ASM, MSDOS 6.0, 1991
 11110                                  ;============================================================================
 11111                                  ; 12/10/2018 - Retro DOS v3.0
 11112                                  
 11113                                  ; 05/02/2023 - Retro DOS v5.0 (& v4.1) COMMAND.COM
 11114                                  
 11115                                  ;	SCCSID = @(#)ibmhalo.asm	1.1 85/04/10
 11116                                  ;   On 2K (800h) boundaries beginning at address C0000h and ending at EF800h
 11117                                  ;   there is a header that describes a block of rom program.  This header
 11118                                  ;   contains information needed to initialize a module and to provide PCDOS
 11119                                  ;   with a set of reserved names for execution.
 11120                                  ;
 11121                                  ;   This header has the following format:
 11122                                  ;
 11123                                  ;   rom_header	STRUC
 11124                                  ;	Signature1  DB	55h
 11125                                  ;	Signature2  DB	AAh
 11126                                  ;	rom_length  DB	?		; number of 512 byte pieces
 11127                                  ;	init_jmp    DB	3 dup (?)
 11128                                  ;	name_list   name_struc <>
 11129                                  ;   rom_header	ENDS
 11130                                  ;
 11131                                  ;   name_struc	STRUC
 11132                                  ;	name_len    DB	?
 11133                                  ;	name_text   DB	? DUP (?)
 11134                                  ;	name_jmp    DB	3 DUP (?)
 11135                                  ;   name_struc	ENDS
 11136                                  ;
 11137                                  ;   The name list is a list of names that are reserved by a particular section
 11138                                  ;   of a module.  This list of names is terminated by a null name (length
 11139                                  ;   is zero).
 11140                                  ;
 11141                                  ;   Consider now, the PCDOS action when a user enters a command:
 11142                                  ;
 11143                                  ;	COMMAND.COM has control.
 11144                                  ;	o   If location FFFFEh has FDh then
 11145                                  ;	o	Start scanning at C0000h, every 800h for a byte 55h followed
 11146                                  ;		    by AAh, stop scan if we get above or = F0000H
 11147                                  ;	o	When we've found one, compare the name entered by the user
 11148                                  ;		    with the one found in the rom.  If we have a match, then
 11149                                  ;		    set up the environment for execution and do a long jump
 11150                                  ;		    to the near jump after the found name.
 11151                                  ;	o	If no more names in the list, then continue scanning the module
 11152                                  ;		    for more 55h followed by AAh.
 11153                                  ;	o   We get to this point only if there is no matching name in the
 11154                                  ;		rom.  We now look on disk for the command.
 11155                                  ;
 11156                                  ;   This gives us the flexibility to execute any rom cartridge without having
 11157                                  ;   to 'hard-code' the name of the cartridge into PCDOS.  Rom modules that
 11158                                  ;   want to be invisible to the DOS should not have any names in their lists
 11159                                  ;   (i.e. they have a single null name).
 11160                                  ;
 11161                                  ;   Consider a new release of BASIC, say, that patches bugs in the ROM version.
 11162                                  ;   Clearly this version will be available on disk.  How does a user actually
 11163                                  ;   invoke this new BASIC??  He cannot call it BASIC on the disk because the
 11164                                  ;   EXEC loader will execute the ROM before it even looks at the disk!	Only
 11165                                  ;   solution:
 11166                                  ;
 11167                                  ;   o	Keep things consistent and force the user to have his software named
 11168                                  ;	differently from the ROM names (BASIC1, BASIC2, etc).
 11169                                  
 11170                                  struc ROM_HEADER
 11171 00000000 ??                          .signature1: resb 1
 11172 00000001 ??                          .signature2: resb 1
 11173 00000002 ??                          .rom_length: resb 1
 11174 00000003 ??????                      .init_jmp:	 resb 3
 11175 00000006 ??                          .name_list:	 resb 1
 11176                                      .size:
 11177                                  endstruc
 11178                                  
 11179                                  struc NAME_STRUC
 11180 00000000 ??                          .name_len:	resb 1
 11181 00000001 ??                          .name_text:	resb 1
 11182 00000002 ??????                      .name_jmp:	resb 3
 11183                                      .size:	
 11184                                  endstruc
 11185                                  
 11186                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 03D1h
 11187                                  
 11188                                  ; =============== S U B	R O U T	I N E =======================================
 11189                                  
 11190                                  ;ASSUME	CS:TRANGROUP,DS:NOTHING,ES:NOTHING,SS:NOTHING
 11191                                  
 11192                                  ; 05/02/2023
 11193                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:03FBh
 11194                                  
 11195                                  ; 07/06/2023
 11196                                  ; MSDOS 6.22 COMMAND.COM - TRANGROUP:04D5h
 11197                                  
 11198                                  ; 25/07/2024
 11199                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:04DBh
 11200                                  
 11201                                  ; Check for IBM PC Jr rom cartrides. DS:DX is a pointer to name
 11202                                  
 11203                                  ROM_SCAN:
 11204 000004D3 06                      	push	es
 11205 000004D4 56                      	push	si
 11206 000004D5 57                      	push	di
 11207 000004D6 51                      	push	cx
 11208 000004D7 50                      	push	ax
 11209 000004D8 53                      	push	bx
 11210                                  
 11211                                  	; check for PC Jr signature in rom
 11212                                  
 11213 000004D9 B800F0                  	mov	ax,0F000h
 11214 000004DC 8EC0                    	mov	es,ax
 11215 000004DE 26803EFEFFFD            	cmp	byte [es:0FFFEh],0FDh
 11216 000004E4 7408                    	je	short SCAN_IT
 11217                                  NO_ROM:
 11218 000004E6 F8                      	clc
 11219                                  ROM_RET:
 11220 000004E7 5B                      	pop	bx
 11221 000004E8 58                      	pop	ax
 11222 000004E9 59                      	pop	cx
 11223 000004EA 5F                      	pop	di
 11224 000004EB 5E                      	pop	si
 11225 000004EC 07                      	pop	es
 11226 000004ED C3                      	retn
 11227                                  
 11228                                  	; start scanning at C000h
 11229                                  SCAN_IT:
 11230 000004EE B800C0                  	mov	ax,0C000h
 11231                                  SCAN_ONE:
 11232 000004F1 8EC0                    	mov	es,ax
 11233 000004F3 31FF                    	xor	di,di
 11234                                  
 11235                                  	; check for a valid header
 11236                                  SCAN_MODULE:
 11237 000004F5 26813D55AA              	cmp	word [es:di],0AA55h
 11238 000004FA 740A                    	je	short SCAN_LIST
 11239 000004FC 058000                  	add	ax,80h
 11240                                  SCAN_END:
 11241 000004FF 3D00F0                  	cmp	ax,0F000h
 11242 00000502 72ED                    	jb	short SCAN_ONE
 11243 00000504 EBE0                    	jmp	short NO_ROM
 11244                                  
 11245                                  	; trundle down list of names
 11246                                  SCAN_LIST:
 11247                                  	;mov	bl,[es:di+2]	; number of 512-byte jobbers
 11248 00000506 268A5D02                	mov	bl,[es:di+ROM_HEADER.rom_length]
 11249 0000050A 30FF                    	xor	bh,bh		; nothing in the high byte
 11250 0000050C D1E3                    	shl	bx,1
 11251 0000050E D1E3                    	shl	bx,1		; number of paragraphs
 11252 00000510 83C37F                  	add	bx,7Fh
 11253 00000513 83E380                  	and	bx,0FF80h	; round to 2k
 11254                                  	;mov	di,6
 11255                                  	; 05/05/2023
 11256 00000516 BF0600                  	mov	di,ROM_HEADER.name_list
 11257                                  	;nop
 11258                                  SCAN_NAME:
 11259 00000519 268A0D                  	mov	cl,[es:di]	; length of name
 11260 0000051C 47                      	inc	di		; point to name
 11261 0000051D 30ED                    	xor	ch,ch
 11262 0000051F 09C9                    	or	cx,cx		; zero length name
 11263 00000521 7504                    	jnz	short SCAN_TEST	; nope... compare
 11264 00000523 01D8                    	add	ax,bx		; yep, skip to next block
 11265 00000525 EBD8                    	jmp	short SCAN_END
 11266                                  
 11267                                  	; compare a single name
 11268                                  SCAN_TEST:
 11269 00000527 89D6                    	mov	si,dx
 11270 00000529 46                      	inc	si
 11271 0000052A F3A6                    	repe	cmpsb		 ; compare name
 11272 0000052C 7407                    	jz	short SCAN_FOUND ; success!
 11273                                  SCAN_NEXT:
 11274 0000052E 01CF                    	add	di,cx		; failure, next name piece
 11275 00000530 83C703                  	add	di,3
 11276 00000533 EBE4                    	jmp	short SCAN_NAME
 11277                                  
 11278                                  	; found a name. save entry location
 11279                                  SCAN_FOUND:	
 11280 00000535 803C3F                  	cmp	byte [si],'?'
 11281 00000538 7405                    	je	short SCAN_SAVE
 11282 0000053A 803C20                  	cmp	byte [si],' '
 11283 0000053D 75EF                    	jne	short SCAN_NEXT
 11284                                  SCAN_SAVE:
 11285 0000053F 2E8C06[B79D]            	mov	[cs:ROM_CS],es
 11286 00000544 2E893E[B59D]            	mov	[cs:ROM_IP],di
 11287 00000549 F9                      	stc
 11288 0000054A EB9B                    	jmp	short ROM_RET
 11289                                  
 11290                                  ; ---------------------------------------------------------------------------
 11291                                  
 11292                                  ; execute a rom-placed body of code. allocate largest block
 11293                                  
 11294                                  ROM_EXEC:
 11295 0000054C BBFFFF                  	mov	bx,0FFFFh
 11296                                  	; 05/02/2023
 11297 0000054F B448                    	mov	ah,48h
 11298                                  	;mov	ah,ALLOC ; 48h
 11299 00000551 CD21                    	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 11300                                  			; BX = number of 16-byte paragraphs desired
 11301 00000553 B448                    	mov	ah,48h
 11302                                  	;mov	ah,ALLOC ; 48h
 11303 00000555 CD21                    	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 11304                                  			; BX = number of 16-byte paragraphs desired
 11305 00000557 53                      	push	bx
 11306 00000558 50                      	push	ax
 11307                                  
 11308                                  	; set terminate addresses
 11309                                  
 11310 00000559 B82225                  	mov	ax,2522h
 11311                                  	;;mov	ax,(set_interrupt_vector SHL 8) + int_terminate
 11312                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8)+INT_TERMINATE
 11313 0000055C 1E                      	push	ds
 11314 0000055D 2E8E1E[F59B]            	mov	ds,[cs:RESSEG]
 11315                                  	;mov	dx,offset RESGROUP:EXEC_WAIT
 11316                                  	;mov	dx,131h ; MSDOS 3.3
 11317                                  	; 05/02/2023
 11318                                  	;mov	dx,0D6Bh ; MSDOS 5.0
 11319 00000562 BA[390D]                	mov	dx,Exec_Wait
 11320 00000565 CD21                    	int	21h	; DOS -	SET INTERRUPT VECTOR
 11321                                  			; AL = interrupt number
 11322                                  			; DS:DX	= new vector to	be used	for specified interrupt
 11323 00000567 8CDA                    	mov	dx,ds
 11324 00000569 8EC2                    	mov	es,dx
 11325 0000056B 1F                      	pop	ds
 11326                                  		
 11327                                  	; and create program header and dup all jfn's
 11328                                  
 11329 0000056C 5A                      	pop	dx
 11330 0000056D B455                    	mov	ah,55h
 11331                                  	;mov	ah,DUP_PDB ; 55h
 11332 0000056F CD21                    	int	21h	; DOS -	2+ internal - CREATE PSP
 11333                                  			; DX = segment number at which to set up PSP
 11334                                  			; SI = (DOS 3+)	value to place in memory size field at DX:[0002h]
 11335                                  		
 11336                                  	; set up dma address
 11337                                  
 11338 00000571 8EDA                    	mov	ds,dx
 11339 00000573 BA8000                  	mov	dx,80h
 11340 00000576 B41A                    	mov	ah,1Ah
 11341                                  	;mov	ah,Set_DMA ; 1Ah
 11342 00000578 CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 11343                                  			; DS:DX	-> disk	transfer buffer
 11344                                  
 11345                                  	; copy in environment info
 11346                                  
 11347 0000057A 26A1[3A04]              	mov	ax,[es:EnvirSeg]
 11348                                  	;mov	[2Ch],ax
 11349 0000057E A32C00                  	mov	[PDB.ENVIRON],ax
 11350                                  
 11351                                  	; set up correct size of block
 11352                                  
 11353 00000581 5B                      	pop	bx		; BX has size, DS has segment
 11354 00000582 8CDA                    	mov	dx,ds
 11355 00000584 01DA                    	add	dx,bx
 11356                                  	;mov	[2],dx
 11357 00000586 89160200                	mov	[PDB.BLOCK_LEN],dx
 11358                                  
 11359                                  	; change ownership of block
 11360                                  
 11361 0000058A 8CDA                    	mov	dx,ds
 11362 0000058C 4A                      	dec	dx
 11363 0000058D 8EDA                    	mov	ds,dx
 11364 0000058F 42                      	inc	dx	
 11365                                  	;mov	[1],dx
 11366 00000590 89160100                	mov	[ARENA.owner],dx
 11367 00000594 8EDA                    	mov	ds,dx
 11368                                  
 11369                                  	; set up correct stack
 11370                                  
 11371 00000596 81FB0010                	cmp	bx,1000h
 11372 0000059A 7202                    	jb	short GOT_STACK
 11373 0000059C 31DB                    	xor	bx,bx
 11374                                  GOT_STACK:
 11375 0000059E B104                    	mov	cl,4
 11376 000005A0 D3E3                    	shl	bx,cl
 11377 000005A2 8CDA                    	mov	dx,ds
 11378 000005A4 8ED2                    	mov	ss,dx
 11379 000005A6 89DC                    	mov	sp,bx
 11380 000005A8 31C0                    	xor	ax,ax
 11381 000005AA 50                      	push	ax
 11382                                  
 11383                                  	; set up initial registers and go to the guy
 11384                                  
 11385 000005AB F7D0                    	not	ax
 11386 000005AD 2EFF36[B79D]            	push	word [cs:ROM_CS]
 11387 000005B2 2EFF36[B59D]            	push	word [cs:ROM_IP]
 11388 000005B7 8EC2                    	mov	es,dx
 11389 000005B9 CB                      	retf	; far return
 11390                                  
 11391                                  ; 25/07/2024 - Retro DOS v5.0
 11392                                  ; ---------------------------------------------------------------------------
 11393                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:05C2h
 11394                                  
 11395                                  ; =============== S U B	R O U T	I N E =======================================
 11396                                  
 11397                                  int_21h_indirect:
 11398 000005BA 1E                      	push	ds		; (*)
 11399 000005BB 9C                      	pushf			; (**)
 11400 000005BC 53                      	push	bx
 11401 000005BD 31DB                    	xor	bx, bx
 11402 000005BF 8EDB                    	mov	ds, bx		; 0
 11403 000005C1 5B                      	pop	bx
 11404 000005C2 0E                      	push	cs		; simulate INT 21h
 11405                                  				; stack: ip, cs, flags (**)
 11406 000005C3 E80300                  	call	INT21h_fcall
 11407 000005C6 C20200                  	retn	2		; discard ds (*) on top	of stack
 11408                                  
 11409                                  ; =============== S U B	R O U T	I N E =======================================
 11410                                  
 11411                                  INT21h_fcall:
 11412                                  	;push	word ptr ds:86h
 11413 000005C9 FF368600                	push	word [(4*21h)+2] ; INT 21h segment
 11414                                  	;push	word ptr ds:84h
 11415 000005CD FF368400                	push	word [4*21h]	; INT 21h offset
 11416 000005D1 55                      	push	bp
 11417 000005D2 89E5                    	mov	bp,sp
 11418 000005D4 8E5E0C                  	mov	ds,[bp+12]	; DS (*) in stack
 11419 000005D7 FF760E                  	push	word [bp+14]	; return addr of the caller of INT21h_fcall
 11420 000005DA 8F460C                  	pop	word [bp+12]	; return address from INT 21h
 11421 000005DD 5D                      	pop	bp
 11422 000005DE FA                      	cli
 11423 000005DF CB                      	retf
 11424                                  
 11425                                  ; =============== S U B	R O U T	I N E =======================================
 11426                                  
 11427                                  int_2Fh_indirect:
 11428 000005E0 1E                      	push	ds
 11429 000005E1 53                      	push	bx
 11430 000005E2 31DB                    	xor	bx,bx
 11431 000005E4 8EDB                    	mov	ds,bx
 11432 000005E6 5B                      	pop	bx
 11433 000005E7 9C                      	pushf
 11434 000005E8 FA                      	cli
 11435                                  	;call	dword ptr ds:0BCh
 11436 000005E9 FF1EBC00                	call	far [4*2Fh]	;  INT 2Fh handler
 11437 000005ED 1F                      	pop	ds
 11438 000005EE C3                      	retn
 11439                                  
 11440                                  ; ---------------------------------------------------------------------------
 11441                                  
 11442                                  ;============================================================================
 11443                                  ; TBATCH.ASM, MSDOS 6.0, 1991
 11444                                  ;============================================================================
 11445                                  ; 12/10/2018 - Retro DOS v3.0
 11446                                  
 11447                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 04B9h
 11448                                  
 11449                                  ; =============== S U B	R O U T	I N E =======================================
 11450                                  
 11451                                  ;Break	<PromptBat - Open or wait for batch file>
 11452                                  
 11453                                  ; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11454                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:04E2h
 11455                                  
 11456                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 11457                                  ; MSDOS 6.22 COMMAND.COM - TRANGROUP:05BCh
 11458                                  
 11459                                  ; Open the batch file. If we cannot find the batch file. If the media is
 11460                                  ; changeable, we prompt for the change. Otherwise, we terminate the batch
 11461                                  ; file. Leave segment registers alone.
 11462                                  
 11463                                  PROMPTBAT:
 11464 000005EF E85308                  	call	BATOPEN
 11465 000005F2 7201                    	jc	short PROMPTBAT1
 11466 000005F4 C3                      	retn
 11467                                  PROMPTBAT1:
 11468                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11469                                  	; MSDOS 6.0 COMMAND.COM
 11470 000005F5 83FA02                  	cmp	dx,ERROR_FILE_NOT_FOUND ;AN022; Ask for diskette if file not found
 11471 000005F8 740A                    	je	short BAT_REMCHECK	;AN022;
 11472 000005FA 83FA03                  	cmp	dx,ERROR_PATH_NOT_FOUND ;AN022; Ask for diskette if path not found
 11473 000005FD 7405                    	je	short BAT_REMCHECK	;AN022; Otherwise, issue message and exit
 11474                                  	;invoke	output_batch_name	;AN022; set up batch name in bwdbuf
 11475 000005FF E83500                  	call	output_batch_name
 11476 00000602 EB13                    	jmp	short BATDIE		;AN022;
 11477                                  
 11478                                  	; 05/02/2023
 11479                                  	; MSDOS 3.3 COMMAND.COM
 11480                                  	;cmp	dx,ACCDENPTR
 11481                                  	;jz	short BATDIE
 11482                                  
 11483                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11484                                  BAT_REMCHECK:				;AN022; Go see if media is removable
 11485 00000604 2EFF1E[FF9B]            	call	far [cs:RCH_ADDR]	; DX has error number
 11486 00000609 7417                    	jz	short ASKFORBAT		; Media is removable
 11487                                  
 11488                                  ; The media is not changeable. Turn everything off.
 11489                                  
 11490 0000060B E84B0B                  	call	FOROFF
 11491 0000060E E8962D                  	call	PipeOff
 11492 00000611 A2[AA02]                	mov	[IfFlag],al	; No If in progress.	
 11493 00000614 BA[F48F]                	mov	dx,BADBAT_PTR
 11494                                  BATDIE:
 11495 00000617 E8F803                  	call	BATCHOFF
 11496 0000061A 0E                      	push	cs
 11497 0000061B 1F                      	pop	ds
 11498                                  	;invoke	std_eprintf	;AC022; display message ;  MSDOS 6.0
 11499                                  	; 05/02/2023
 11500 0000061C E8014E                  	call	std_eprintf	; MSDOS 6.0
 11501                                  	;call	STD_PRINTF	; MSDOS 3.3
 11502                                  
 11503                                  ; TCOMMAND resets the stack. This is the equivalent of a non-local goto.
 11504                                  
 11505 0000061F E9E2FA                  	jmp	TCOMMAND
 11506                                  
 11507                                  ; Ask the user to reinsert the batch file
 11508                                  
 11509                                  ASKFORBAT:
 11510 00000622 1E                      	push	ds
 11511 00000623 0E                      	push	cs
 11512 00000624 1F                      	pop	ds
 11513                                  
 11514                                  	; MSDOS 6.0
 11515                                  	;mov	dx,offset TRANGROUP:NEEDBAT_ptr  ;AN022;
 11516 00000625 BA[F78F]                	mov	dx,NEEDBAT_PTR
 11517                                  	;invoke	std_eprintf	 	;Prompt for batch file on stderr
 11518                                  	; 05/02/2023
 11519 00000628 E8F54D                  	call	std_eprintf
 11520                                  	;mov	dx,offset trangroup:pausemes_ptr
 11521 0000062B BA[A490]                	mov	dx,PAUSEMES_PTR
 11522                                  	;invoke std_eprintf		;AN000; get second part of message
 11523 0000062E E8EF4D                  	call	std_eprintf
 11524                                  					;AN000; print it to stderr
 11525                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11526                                  	;call	STD_EPRINTF
 11527 00000631 E82E00                  	call	GETKEYSTROKE
 11528 00000634 1F                      	pop	ds
 11529 00000635 EBB8                    	jmp	short PROMPTBAT
 11530                                  
 11531                                  
 11532                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11533                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:052Ah
 11534                                  
 11535                                  	; MSDOS 6.0
 11536                                  ;****************************************************************
 11537                                  ;*
 11538                                  ;* ROUTINE:	Output_batch_name
 11539                                  ;*
 11540                                  ;* FUNCTION:	Sets up batch name to be printed on extended error
 11541                                  ;*
 11542                                  ;* INPUT:	DX - extended error number
 11543                                  ;*
 11544                                  ;* OUTPUT:	Ready to call print routine
 11545                                  ;*
 11546                                  ;****************************************************************
 11547                                  ;
 11548                                  ;public	output_batch_name		;AN022;
 11549                                  
 11550                                  output_batch_name:	;proc near	;AN022;
 11551                                  
 11552 00000637 1E                      	push	ds			;AN022; save resident segment
 11553 00000638 8E1E[4902]              	mov	ds,[Batch]		;AN022; get batch file segment
 11554                                  	;assume	DS:nothing		;AN022;
 11555                                  	;;mov	SI,BatFile		;AN022; get offset of batch file
 11556                                  	; 05/02/2023
 11557                                  	;mov	si,20h
 11558                                  	; 24/04/2023
 11559 0000063C BE2000                  	mov	si,BATCHSEGMENT.BatFile
 11560                                  	;invoke	dstrlen 		;AN022; get length of string
 11561 0000063F E85D2A                  	call	dstrlen
 11562                                  	;mov	di,offset Trangroup:bwdbuf
 11563                                  					;AN022; target for batch name
 11564 00000642 BF[399D]                	mov	di,BWDBUF
 11565 00000645 F3A4                    	rep	movsb			;AN022; move the name
 11566                                  
 11567 00000647 0E                      	push	cs			;AN022; get local segment
 11568 00000648 1F                      	pop	ds			;AN022;
 11569                                  	;assume	DS:trangroup		;AN022;
 11570                                  	; 05/02/2023
 11571 00000649 8916[D78F]              	mov	[extend_buf_ptr],dx	;AN022; put message number in block
 11572                                  	;mov	byte [msg_disp_class],1
 11573 0000064D C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class
 11574                                  					;AN022; set up extended error msg class
 11575                                  	;mov	dx,offset TranGroup:Extend_Buf_ptr
 11576 00000652 BA[D78F]                	mov	dx,extend_buf_ptr	
 11577                                  					;AN022; get extended message pointer
 11578                                  	;mov	string_ptr_2,offset trangroup:bwdbuf 
 11579 00000655 C706[A09D][399D]        	mov	word [string_ptr_2],BWDBUF	
 11580                                  					;AN022; point to substitution
 11581                                  	;mov	byte [extend_buf_sub],1
 11582 0000065B C606[D98F]01            	mov	byte [extend_buf_sub],one_subst
 11583                                  					;AN022; set up for one subst
 11584 00000660 1F                      	pop	ds			;AN022; restore data segment
 11585 00000661 C3                      	retn				;AN022; return
 11586                                  
 11587                                  ;output_batch_name    endp		;AN022;
 11588                                  
 11589                                  
 11590                                  ; =============== S U B	R O U T	I N E =======================================
 11591                                  
 11592                                  ;Break	<GetKeystroke - get a keystroke and flush queue>
 11593                                  
 11594                                  ; Read the next keystroke. Since there may be several characters in the queue
 11595                                  ; after the one we ask for (function keys/Kanji), we need to flush the queue
 11596                                  ; AFTER waiting.
 11597                                  
 11598                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11599                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0555h
 11600                                  
 11601                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 11602                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:062Fh
 11603                                  
 11604                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 11605                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:066Ah
 11606                                  
 11607                                  GETKEYSTROKE:
 11608                                  	; 05/02/2023
 11609                                  	; MSDOS 3.3
 11610                                  	;;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) OR STD_CON_INPUT_NO_ECHO
 11611                                  	;;mov	ax,0C08h
 11612                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8)|STD_CON_INPUT_NO_ECHO
 11613                                  	;int	21h	; DOS -	CLEAR KEYBOARD BUFFER
 11614                                  	;		; AL must be 01h,06h,07h,08h,or 0Ah.
 11615                                  	;;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) + 0
 11616                                  	;;mov	ax,0C00h
 11617                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8)+0
 11618                                  	;int	21h	; DOS -	CLEAR KEYBOARD BUFFER
 11619                                  	;		; AL must be 01h,06h,07h,08h,or 0Ah.
 11620                                  	;retn
 11621                                  
 11622                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11623                                  	; MSDOS 6.0
 11624 00000662 52                      	push	dx			;AN000;  3/3/KK
 11625                                  	;mov	ax,(ECS_call SHL 8) OR GetInterimMode
 11626                                  					;AN000;  3/3/KK
 11627 00000663 B80263                  	mov	ax,6302h
 11628 00000666 CD21                    	int	21h			;AN000;  3/3/KK
 11629                                  		; DOS - 3.2+ only - GET KOREAN (HONGEUL) INPUT MODE
 11630                                  	
 11631 00000668 52                      	push	dx			;AN000;  save interim state 3/3/KK
 11632                                  	;mov	ax,(ECS_call SHL 8) OR SetInterimMode
 11633                                  					;AN000;  3/3/KK
 11634 00000669 B80163                  	mov	ax,6301h
 11635 0000066C B201                    	mov	dl,1
 11636                                  	;mov	dl,InterimMode		;AN000;  3/3/KK
 11637 0000066E CD21                    	int	21h			;AN000;  3/3/KK
 11638                                  		; DOS - 3.2+ only - SET KOREAN (HONGEUL) INPUT MODE
 11639                                  		; DL = new mode
 11640                                  		; 00h return only full characters on DOS keyboard input functions
 11641                                  		; 01h return partially-formed characters also
 11642                                  	
 11643                                  	;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) OR STD_CON_INPUT_no_echo
 11644 00000670 B8080C                  	mov	ax,0C08h
 11645 00000673 CD21                    	int	21h			; Get character with KB buffer flush
 11646                                  		; DOS - CLEAR KEYBOARD BUFFER
 11647                                  		; AL must be 01h, 06h, 07h, 08h, or 0Ah.
 11648                                  
 11649                                  	;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) + 0
 11650 00000675 B8000C                  	mov	ax,0C00h
 11651 00000678 CD21                    	int	21h
 11652                                  		; DOS - CLEAR KEYBOARD BUFFER
 11653                                  		; AL must be 01h, 06h, 07h, 08h, or 0Ah.
 11654                                  
 11655                                  	;mov	ax,(ECS_call SHL 8) OR SetInterimMode
 11656                                  					;AN000;  3/3/KK
 11657 0000067A B80163                  	mov	ax,6301h
 11658 0000067D 5A                      	pop	dx			;AN000;  restore interim state 3/3/KK
 11659 0000067E CD21                    	int	21h			;AN000;  3/3/KK
 11660 00000680 5A                      	pop	dx			;AN000;  3/3/KK
 11661                                  	
 11662 00000681 C3                      	retn
 11663                                  
 11664                                  ; =============== S U B	R O U T	I N E =======================================
 11665                                  
 11666                                  ; Break	<ReadBat - read 1 line from batch file>
 11667                                  
 11668                                  ; ReadBat - read a single line from the batch file. 
 11669                                  ; Perform all substitutions as appropriate.
 11670                                  
 11671                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11672                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0575h
 11673                                  
 11674                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 11675                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:068Ah
 11676                                  
 11677                                  READBAT:
 11678                                  	;ASSUME	DS:ResGroup,ES:TranGroup
 11679                                  		
 11680                                  	;mov	byte [Suppress],1
 11681                                  				; initialize line suppress status
 11682 00000682 C606[9E02]01            	mov	byte [Suppress],YES_ECHO
 11683 00000687 F606[9302]FF            	test	byte [Batch_Abort],-1 ; 0FFh
 11684 0000068C 751F                    	jnz	short TRYING_TO_ABORT
 11685 0000068E C606[9202]01            	mov	byte [In_Batch],1 ; set flag to indicate batch job
 11686                                  
 11687                                  	; MSDOS 6.0
 11688                                  
 11689                                  ;M037; Start of changes
 11690                                  ; We check here if we have set the flag indicating that the batchfile is at
 11691                                  ;EOF. In this case, we do not want to continue with the normal processing.
 11692                                  ;We call GetBatByt once more so that the batch segment gets freed up, the
 11693                                  ;batch file gets closed etc. and then return as if everything is done.
 11694                                  
 11695                                  	; 05/02/2023
 11696 00000693 1E                      	push	ds
 11697 00000694 8E1E[4902]              	mov	ds,[Batch]
 11698                                  	;cmp	byte [2],0
 11699 00000698 803E020000              	cmp	byte [BATCHSEGMENT.BatchEOF],0
 11700                                  				; are we at EOF in batchfile
 11701 0000069D 1F                      	pop	ds
 11702 0000069E 740A                    	jz	short CONTBAT	; no, continue normal processing
 11703                                  	;invoke	GetBatByt	; frees up batchseg
 11704 000006A0 E8DC03                  	call	GETBATBYT
 11705 000006A3 26A2[569A]              	mov	[es:COMBUF+2],al
 11706                                  				; stuff CR into command buffer
 11707                                  				; as a dummy command
 11708                                  	;;invoke CrLf2		; print a CR-LF
 11709                                  	;call	CRLF2
 11710                                  	;;return		; done batch processing
 11711                                  	;retn
 11712                                  	; 24/04/2023
 11713 000006A7 E9CF22                  	jmp	CRLF2
 11714                                  
 11715                                  ;M037; End of changes
 11716                                  		
 11717                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11718                                  CONTBAT:
 11719 000006AA E842FF                  	call	PROMPTBAT
 11720                                  
 11721                                  TRYING_TO_ABORT:
 11722 000006AD BF[569A]                	mov	di,COMBUF+2
 11723                                  
 11724                                  ; Save position and try to scan for first non delimiter.
 11725                                  
 11726                                  TESTNOP:
 11727 000006B0 8CD8                    	mov	ax,ds
 11728 000006B2 8E1E[4902]              	mov	ds,[Batch]
 11729 000006B6 FF360800                	push	word [BATCHSEGMENT.BatSeek]
 11730 000006BA FF360A00                	push	word [BATCHSEGMENT.BatSeek+2]
 11731                                  				; save current location.
 11732 000006BE 8ED8                    	mov	ds,ax
 11733 000006C0 E85506                  	call	SKIPDELIM	; skip to first non-delim
 11734                                  
 11735                                  ; If the first non-delimiter is not a : (label), we reseek back to the
 11736                                  ; beginning and read the line.
 11737                                  
 11738 000006C3 3C3A                    	cmp	al,':'		; is it a label?
 11739 000006C5 59                      	pop	cx
 11740 000006C6 5A                      	pop	dx		; restore position in bat file
 11741 000006C7 7432                    	jz	short NOPLINE	; yes, resync everything.
 11742 000006C9 F706[4902]FFFF          	test	word [Batch],-1 ; are we done with the batch file?
 11743 000006CF 7439                    	jz	short RDBAT	; no, go read batch file
 11744                                  
 11745                                  	;cmp	al,'@'
 11746 000006D1 3C40                    	cmp	al,No_Echo_Char	; see if user wants to suppress line
 11747 000006D3 7507                    	jne	short SET_BAT_POS ; no - go and set batch file position
 11748                                  	;mov	byte [Suppress],0
 11749 000006D5 C606[9E02]00            	mov	byte [Suppress],NO_ECHO ; yes set flag to indicate
 11750 000006DA EB2E                    	jmp	short RDBAT	; go read batch file
 11751                                  	;nop
 11752                                  SET_BAT_POS:
 11753 000006DC 1E                      	push	ds
 11754 000006DD 8E1E[4902]              	mov	ds,[Batch]
 11755                                  	;mov	[8],dx
 11756 000006E1 89160800                	mov	[BATCHSEGMENT.BatSeek],dx ; reseek back to beginning
 11757                                  	;mov	[10],cx
 11758 000006E5 890E0A00                	mov	[BATCHSEGMENT.BatSeek+2],cx
 11759 000006E9 1F                      	pop	ds
 11760                                  	;;mov	ax,(LSEEK SHL 8) + 0
 11761                                  	; 05/02/2023
 11762 000006EA B80042                  	mov	ax,4200h
 11763                                  	;mov	ax,(LSEEK*256) ; 4200h ; seek back
 11764                                  
 11765                                  ; 25/07/2024
 11766                                  ; PCDOS 7.1 COMMAND.COM
 11767                                  %if 0
 11768                                  	int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 11769                                  			; AL = method: offset from beginning of	file
 11770                                  %else
 11771 000006ED E8CAFE                  	call	int_21h_indirect
 11772                                  %endif
 11773                                  	;mov	word [cs:BATBUFPOS],0FFFFh
 11774                                  	; 24/04/2023
 11775                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:05E3h
 11776 000006F0 26C706[C7A5]FFFF        	mov	word [es:BATBUFPOS],-1; 0FFFFh
 11777                                  	;mov	word [cs:BATBUFPOS],-1 ; nuke batch buffer position
 11778 000006F7 31C9                    	xor	cx,cx		; Initialize line length to zero
 11779 000006F9 EB0F                    	jmp	short RDBAT
 11780                                  
 11781                                  	;nop
 11782                                  
 11783                                  ; The first non-delimiter is a :. This line is not echoed and is ignored.
 11784                                  ; We eat characters until a CR is seen.
 11785                                  
 11786                                  NOPLINE:
 11787 000006FB E80501                  	call	SKIPTOEOL
 11788 000006FE E87E03                  	call	GETBATBYT	; eat trailing LF
 11789                                  	;test	word [Batch],0FFFFh
 11790 00000701 F706[4902]FFFF          	test	word [Batch],-1 ; are we done with the batch file?
 11791 00000707 75A7                    	jnz	short TESTNOP	; no, go get another line
 11792                                  READBAT_RETN:			; Hit EOF
 11793 00000709 C3                      	retn
 11794                                  
 11795                                  ; ---------------------------------------------------------------------------
 11796                                  
 11797                                  ; Read a line into the buffer pointed to by ES:DI. If any %s are seen in the
 11798                                  ; input, we are to consider two special cases:
 11799                                  ;
 11800                                  ;   %0 to %9	These represent replaceable parameters from the batch segment
 11801                                  ;   %sym%	This is a symbol from the environment
 11802                                  
 11803                                  RDBAT:
 11804 0000070A E87203                  	call	GETBATBYT
 11805 0000070D 41                      	inc	cx		; Inc the line length
 11806                                  
 11807                                  	; 05/02/2023
 11808                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0601h
 11809 0000070E E85020                  	call	testkanj
 11810 00000711 740C                    	jz	short RDBAT1
 11811                                  	;cmp	cx,127
 11812 00000713 83F97F                  	cmp	cx,COMBUFLEN-1
 11813 00000716 7350                    	jnb	short TOOLONG
 11814 00000718 AA                      	stosb
 11815 00000719 E86303                  	call    GETBATBYT
 11816 0000071C 41                      	inc	cx
 11817 0000071D EB0A                    	jmp	short SAVBATBYT
 11818                                  RDBAT1:
 11819 0000071F 81F98000                	cmp	cx,COMBUFLEN ; 128 ; Is it too long?
 11820 00000723 7343                    	jnb	short TOOLONG	   ; Yes - handle it, handle it
 11821                                  
 11822                                  ; See if we have a parameter character.
 11823                                  
 11824 00000725 3C25                    	cmp	al,'%'		; Check for parameter
 11825 00000727 7449                    	je	short NEEDPARM
 11826                                  
 11827                                  ; no parameter character. Store it as usual and see if we are done.
 11828                                  
 11829                                  SAVBATBYT:
 11830 00000729 AA                      	stosb			; End of line found?
 11831 0000072A 3C0D                    	cmp	al,0Dh
 11832 0000072C 75DC                    	jne	short RDBAT	; no, go for more
 11833                                  
 11834                                  ; We have read in an entire line. 
 11835                                  ; Decide whether we should echo the command line or not.
 11836                                  
 11837                                  FOUND_EOL:
 11838 0000072E 81EF[579A]              	sub	di,COMBUF+3
 11839 00000732 89F8                    	mov	ax,di		; remember that we've not counted the CR
 11840 00000734 26A2[559A]              	mov	[es:COMBUF+1],al
 11841                                  				; Set length of line
 11842 00000738 E84403                  	call	GETBATBYT	; Eat linefeed
 11843 0000073B E8F206                  	call	BATCLOSE
 11844 0000073E 803E[9E02]00            	cmp	byte [Suppress],NO_ECHO ; 0
 11845 00000743 7407                    	jz	short RESET
 11846 00000745 F606[9D02]01            	test	byte [EchoFlag],1  ; To echo or not to echo, that is the
 11847 0000074A 7504                    	jnz	short TRY_NEXTFLAG ; question. (Profound, huh?)
 11848                                  RESET:
 11849 0000074C 0E                      	push	cs
 11850 0000074D 1F                      	pop	ds		; Go back to local segment
 11851 0000074E 74B9                    	jz	short READBAT_RETN ; no echoing here...
 11852                                  TRY_NEXTFLAG:
 11853 00000750 803E[B402]01            	cmp	byte [NullFlag],nullcommand ; 1
 11854                                  				;G was there a command last time?
 11855 00000755 7403                    	jz	short NO_CRLF_PRINT
 11856                                  				;G no - don't print crlf
 11857 00000757 E81F22                  	call	CRLF2		;G Print out prompt
 11858                                  NO_CRLF_PRINT:
 11859 0000075A E89319                  	call	PRINT_PROMPT
 11860 0000075D 0E                      	push	cs		;G change data segment
 11861 0000075E 1F                      	pop	ds
 11862 0000075F BA[569A]                	mov	dx,COMBUF+2	; get command line for echoing
 11863 00000762 E86D22                  	call	CRPRINT
 11864                                  	;call	CRLF2
 11865                                  	;retn
 11866                                  	; 06/02/2023
 11867 00000765 E91122                  	jmp	CRLF2
 11868                                  
 11869                                  ; The line was too long. Eat remainder of input text up until the CR
 11870                                  
 11871                                  TOOLONG:
 11872 00000768 3C0D                    	cmp	al,0Dh		; Has the end of the line been reached?
 11873 0000076A 7403                    	jz	short LTLCONT	; Yes, continue
 11874 0000076C E89400                  	call	SKIPTOEOL	; Eat remainder of line	
 11875                                  LTLCONT:
 11876 0000076F AA                      	stosb			; Terminate the command
 11877 00000770 EBBC                    	jmp	short FOUND_EOL	; Go process the valid part of the line
 11878                                  
 11879                                  ; We have found a parameter lead-in character. Check for the 0-9 case first
 11880                                  
 11881                                  NEEDPARM:
 11882 00000772 E80A03                  	call	GETBATBYT	; get next character
 11883 00000775 3C25                    	cmp	al,'%'		; Check for two consecutive %
 11884 00000777 74B0                    	je	short SAVBATBYT	; if so, replace with a single %
 11885 00000779 3C0D                    	cmp	al,0Dh		; Check for end-of-line
 11886 0000077B 74AC                    	je	short SAVBATBYT	; yes, treat it normally
 11887                                  
 11888                                  ; We have found %<something>. If the <something> is in the range 0-9, we
 11889                                  ; retrieve the appropriate parameter from the batch segment. Otherwise we
 11890                                  ; see if the <something> has a terminating % and then look up the contents
 11891                                  ; in the environment.
 11892                                  
 11893                                  PAROK:
 11894 0000077D 2C30                    	sub	al,'0'
 11895 0000077F 7239                    	jb	short NEEDENV	; look for parameter in the environment
 11896 00000781 3C09                    	cmp	al,9
 11897 00000783 7735                    	ja	short NEEDENV
 11898                                  
 11899                                  ; We have found %<number>. This is taken from the parameters in the
 11900                                  ; allocated batch area.
 11901                                  
 11902 00000785 98                      	cbw
 11903 00000786 89C3                    	mov	bx,ax		; move index into AX
 11904 00000788 D1E3                    	shl	bx,1		; convert word index into byte ptr
 11905 0000078A 06                      	push	es
 11906 0000078B 8E06[4902]              	mov	es,[Batch]
 11907                                  
 11908                                  ; The structure of the batch area is:
 11909                                  ;
 11910                                  ;   BYTE    type of segment
 11911                                  ;   DWORD   offset for next line
 11912                                  ;   10 WORD pointers to parameters. -1 is empty parameter
 11913                                  ;   ASCIZ   file name (with . and ..)
 11914                                  ;   BYTES   CR-terminated parameters
 11915                                  ;   BYTE    0 flag to indicate end of parameters
 11916                                  ;
 11917                                  ; Get pointer to BX'th argument
 11918                                  
 11919                                  	;;mov	si,[es:bx+0Bh]
 11920                                  	; 05/02/2023
 11921                                  	;mov	si,[es:bx+0Ch] 	; MSDOS 5.0 COMMAND.COM
 11922 0000078F 268B770C                	mov	si,[es:bx+BATCHSEGMENT.BatParm]
 11923 00000793 07                      	pop	es
 11924                                  
 11925                                  ; Is there a parameter here?
 11926                                  
 11927 00000794 83FEFF                  	cmp	si,-1		; Check if parameter exists
 11928 00000797 7503                    	jnz	short YES_THERE_IS ; Yes go get it
 11929 00000799 E96EFF                  	jmp	RDBAT		; Ignore if it doesn't
 11930                                  
 11931                                  ; Copy in the found parameter from batch segment
 11932                                  
 11933                                  YES_THERE_IS:
 11934 0000079C 1E                      	push	ds
 11935 0000079D 8E1E[4902]              	mov	ds,[Batch]
 11936 000007A1 49                      	dec	cx		; Don't count '%' in line length
 11937                                  COPYPARM:
 11938 000007A2 AC                      	lodsb			; From resident segment
 11939 000007A3 3C0D                    	cmp	al,0Dh		; Check for end of parameter
 11940 000007A5 740F                    	je	short ENDPARAM
 11941 000007A7 41                      	inc	cx		; Inc the line length
 11942 000007A8 81F98000                	cmp	cx,COMBUFLEN ; 128 ; Is it too long?
 11943 000007AC 7303                    	jnb	short LINETOOL	; Yes - handle it, handle it
 11944 000007AE AA                      	stosb
 11945 000007AF EBF1                    	jmp	short COPYPARM
 11946                                  
 11947                                  ; We have copied up to the limit. Stop copying and eat remainder of batch
 11948                                  ; line. We need to make sure that the tooLong code isn't fooled into
 11949                                  ; believing that we are at EOL. Clobber AL too.
 11950                                  
 11951                                  LINETOOL:
 11952 000007B1 30C0                    	xor	al,al
 11953 000007B3 1F                      	pop	ds
 11954 000007B4 EBB2                    	jmp	short TOOLONG
 11955                                  
 11956                                  ; We have copied in an entire parameter. Go back for more
 11957                                  
 11958                                  ENDPARAM:
 11959 000007B6 1F                      	pop	ds
 11960 000007B7 E950FF                  	jmp	RDBAT
 11961                                  
 11962                                  ; We have found % followed by something other than 0-9. We presume that there
 11963                                  ; will be a following % character. In between is an environment variable that
 11964                                  ; we will fetch and replace in the batch line with its value.
 11965                                  
 11966                                  NEEDENV:
 11967                                  	; MSDOS 6.0 COMMAND.COM
 11968                                  	; 05/02/2023 
 11969 000007BA 49                      	dec     cx 		;AN070; Don't count "%"
 11970                                  
 11971                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11972 000007BB 1E                      	push	ds
 11973 000007BC 57                      	push	di
 11974                                  				; temp spot for name
 11975 000007BD BF[BB9C]                	mov	di,ID
 11976 000007C0 0430                    	add	al,'0'		; reconvert character
 11977 000007C2 AA                      	stosb			; store it in appropriate place
 11978                                  
 11979                                  ; loop getting characters until the next % is found or until EOL
 11980                                  
 11981                                  GETENV1:
 11982 000007C3 E8B902                  	call	GETBATBYT	; get the byte
 11983 000007C6 AA                      	stosb			; store it
 11984 000007C7 3C0D                    	cmp	al,0Dh		; EOL?
 11985 000007C9 7514                    	jne	short GETENV15	; no, see if it the term char
 11986                                  
 11987                                  ; The user entered a string with a % but no trailing %. We copy the string.
 11988                                  
 11989 000007CB 26C645FF00              	mov	byte [es:di-1],0 ; nul terminate the string
 11990 000007D0 BE[BB9C]                	mov	si,ID 		; point to buffer
 11991 000007D3 5F                      	pop	di		; point to line buffer
 11992 000007D4 0E                      	push	cs
 11993 000007D5 1F                      	pop	ds
 11994 000007D6 E89302                  	call	STRCPY
 11995                                  	; 05/02/2023
 11996 000007D9 72D6                    	jc	short LINETOOL	;  MSDOS 6.0 COMMAND.COM
 11997                                  	; 24/04/2023
 11998                                  	;dec	di  		;  MSDOS 3.3 COMMAND.COM	
 11999 000007DB 1F                      	pop	ds
 12000 000007DC E94AFF                  	jmp	SAVBATBYT
 12001                                  GETENV15:
 12002 000007DF 3C25                    	cmp	al,'%'		; terminating %?
 12003 000007E1 75E0                    	jne	short GETENV1	; no, go suck out more characters
 12004                                  
 12005                                  ; M017 - following DEC is wrong, because we replace the % with a = here.
 12006                                  ; This was the source of bug #1.
 12007                                  ;	dec	cx		;AN070; Don't count "%"
 12008                                  
 12009 000007E3 B03D                    	mov	al,'='		; terminate  with =
 12010 000007E5 268845FF                	mov	[es:di-1],al
 12011                                  
 12012                                  ; ID now either has a =-terminated string which we are to find in the
 12013                                  ; environment or a non =-terminated string which will not be found in the
 12014                                  ; environment.
 12015                                  
 12016                                  GETENV2:
 12017 000007E9 BE[BB9C]                	mov	si,ID
 12018 000007EC 0E                      	push	cs
 12019 000007ED 1F                      	pop	ds		; DS:SI points to name
 12020 000007EE 51                      	push	cx
 12021 000007EF E8C51E                  	call	find_name_in_environment
 12022 000007F2 59                      	pop	cx
 12023 000007F3 06                      	push	es
 12024 000007F4 1F                      	pop	ds
 12025 000007F5 0E                      	push	cs
 12026 000007F6 07                      	pop	es
 12027 000007F7 89FE                    	mov	si,di
 12028 000007F9 5F                      	pop	di		; get back pointer to command line
 12029                                  
 12030                                  ; If the parameter was not found, there is no need to perform any replacement.
 12031                                  ; We merely pretend that we've copied the parameter.
 12032                                  
 12033 000007FA 7203                    	jc	short GETENV6
 12034                                  
 12035                                  ; ES:DI points to command line being built
 12036                                  ; DS:SI points either to nul-terminated environment object AFTER =
 12037                                  
 12038 000007FC E86D02                  	call	STRCPY		; (let RdBat handle overflow)
 12039                                  	; 24/04/2022
 12040                                  	;dec	di 		; MSDOS 3.3 COMMAND.COM
 12041                                  GETENV6:
 12042 000007FF 1F                      	pop	ds
 12043 00000800 E907FF                  	jmp	RDBAT		; go back to batch file
 12044                                  
 12045                                  ; =============== S U B	R O U T	I N E =======================================
 12046                                  
 12047                                  ;   SkipToEOL - read from batch file until end of line
 12048                                  
 12049                                  	; 06/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12050                                  SKIPTOEOL:
 12051 00000803 F706[4902]FFFF          	test	word [Batch],-1 ; 0FFFFh
 12052                                  	;jnz	short SKIPTOEOL1  	
 12053                                  	;retn			; no batch file in effect
 12054                                  	
 12055 00000809 7407                    	jz	short SKIPTOEOL2 ; Retro DOS v3.0 COMMAND.COM
 12056                                  SKIPTOEOL1:
 12057 0000080B E87102                  	call	GETBATBYT
 12058 0000080E 3C0D                    	cmp	al,0Dh		; eol character?
 12059 00000810 75F1                    	jnz	short SKIPTOEOL	; no, go eat another
 12060                                  SKIPTOEOL2:
 12061 00000812 C3                      	retn
 12062                                  
 12063                                  ; =============== S U B	R O U T	I N E =======================================
 12064                                  
 12065                                  ;Break	<Allocate and deallocate the transient portion>
 12066                                  
 12067                                  ; Free Transient. Modify ES,AX,flags
 12068                                  
 12069                                  	; 06/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12070                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0708h
 12071                                  
 12072                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 12073                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:081Eh
 12074                                  FREE_TPA:
 12075 00000813 06                      	push	es
 12076 00000814 8E06[F59B]              	mov	es,[RESSEG]
 12077 00000818 268E06[5804]            	mov	es,[es:Res_Tpa]
 12078 0000081D B449                    	mov	ah,49h
 12079                                  	;mov	ah,DEALLOC ; 49h
 12080                                  
 12081                                  ; 25/07/2024
 12082                                  ; PCDOS 7.1 COMMAND.COM
 12083                                  %if 0
 12084                                  	int	21h	; DOS -	2+ - FREE MEMORY
 12085                                  			; ES = segment address of area to be freed
 12086                                  %else
 12087 0000081F E898FD                  	call	int_21h_indirect
 12088                                  %endif
 12089                                  
 12090 00000822 07                      	pop	es
 12091 00000823 C3                      	retn
 12092                                  
 12093                                  ; =============== S U B	R O U T	I N E =======================================
 12094                                  
 12095                                  ; Allocate transient. Modify AX,BX,DX,flags
 12096                                  
 12097                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 12098                                  	; 06/02/2023
 12099                                  ALLOC_TPA:
 12100 00000824 06                      	push	es
 12101 00000825 8E06[F59B]              	mov	es,[RESSEG]
 12102 00000829 BBFFFF                  	mov	bx,0FFFFh 	; Re-allocate the transient	
 12103 0000082C B448                    	mov	ah,48h
 12104                                  	;mov	ah,ALLOC ; 48h
 12105                                  
 12106                                  ; 25/07/2024
 12107                                  ; PCDOS 7.1 COMMAND.COM
 12108                                  %if 0
 12109                                  	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 12110                                  			; BX = number of 16-byte paragraphs desired
 12111                                  %else
 12112 0000082E E889FD                  	call	int_21h_indirect
 12113                                  %endif
 12114                                  
 12115 00000831 53                      	push	bx	  	; Save size of block
 12116 00000832 B448                    	mov	ah,48h
 12117                                  	;mov	ah,ALLOC ; 48h
 12118                                  
 12119                                  ; 25/07/2024
 12120                                  ; PCDOS 7.1 COMMAND.COM
 12121                                  %if 0
 12122                                  	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 12123                                  			; BX = number of 16-byte paragraphs desired
 12124                                  %else
 12125 00000834 E883FD                  	call	int_21h_indirect
 12126                                  %endif
 12127                                  
 12128                                  ; Attempt to align TPA on 64K boundary
 12129                                  
 12130 00000837 5B                      	pop	bx		; Restore size of block
 12131 00000838 26A3[5804]              	mov	[es:Res_Tpa],ax
 12132                                  				; Save segment to beginning of block
 12133 0000083C A3[039C]                	mov	[TRAN_TPA],ax
 12134                                  
 12135                                  ; Is the segment already aligned on a 64K boundary
 12136                                  
 12137 0000083F 89C2                    	mov	dx,ax		; Save segment
 12138 00000841 25FF0F                  	and	ax,0FFFh	; Test if above boundary
 12139 00000844 7507                    	jnz	short CALC_TPA
 12140 00000846 89D0                    	mov	ax,dx
 12141 00000848 2500F0                  	and	ax,0F000h	; Test if multiple of 64K
 12142 0000084B 7523                    	jnz	short NOROUND
 12143                                  CALC_TPA:
 12144 0000084D 89D0                    	mov	ax,dx
 12145 0000084F 2500F0                  	and	ax,0F000h
 12146 00000852 050010                  	add	ax,1000h	; Round up to next 64K boundary
 12147 00000855 7219                    	jc	short NOROUND	; Memory wrap if carry set
 12148                                  
 12149                                  ; Make sure that new boundary is within allocated range
 12150                                  
 12151 00000857 268B16[5804]            	mov	dx,[es:Res_Tpa]
 12152 0000085C 01DA                    	add	dx,bx		; Compute maximum address
 12153 0000085E 39C2                    	cmp	dx,ax		; Is 64K address out of range?
 12154 00000860 720E                    	jb	short NOROUND
 12155                                  
 12156                                  ; Make sure that we won't overwrite the transient
 12157                                  
 12158 00000862 8CCB                    	mov	bx,cs		; CS is beginning of transient
 12159 00000864 39C3                    	cmp	bx,ax
 12160 00000866 7208                    	jb	short NOROUND
 12161                                  
 12162                                  ; The area from the 64K boundary to the beginning of the transient must
 12163                                  ; be at least 64K.
 12164                                  
 12165 00000868 29C3                    	sub	bx,ax
 12166                                  	;cmp	bx,4096
 12167 0000086A 81FB0010                	cmp	bx,1000h	; Size greater than 64K?	
 12168 0000086E 7304                    	jnb	short ROUNDDONE
 12169                                  NOROUND:
 12170 00000870 26A1[5804]              	mov	ax,[es:Res_Tpa]
 12171                                  ROUNDDONE:
 12172 00000874 26A3[4C04]              	mov	[es:LTpa],ax	; Re-compute everything
 12173 00000878 A3[F79B]                	mov	[TPA],ax
 12174 0000087B 89C3                    	mov	bx,ax
 12175 0000087D 8CC8                    	mov	ax,cs
 12176 0000087F 29D8                    	sub	ax,bx
 12177 00000881 53                      	push	bx
 12178 00000882 BB1000                  	mov	bx,16
 12179 00000885 F7E3                    	mul	bx
 12180 00000887 5B                      	pop	bx
 12181 00000888 09D2                    	or	dx,dx
 12182 0000088A 7403                    	jz	short SAVSIZ2
 12183 0000088C B8FFFF                  	mov	ax,-1
 12184                                  SAVSIZ2:
 12185                                  
 12186                                  ; AX is the number of bytes free in the buffer between the resident and the
 12187                                  ; transient with a maximum of 64K-1. We round this down to a multiple of 512.
 12188                                  
 12189 0000088F 3D0002                  	cmp	ax,512
 12190 00000892 7603                    	jbe	short GOTSIZE2
 12191                                  	;and	ax,~1FFh
 12192 00000894 2500FE                  	and	ax,0FE00h	; NOT 511 = NOT 1FFh
 12193                                  GOTSIZE2:
 12194 00000897 A3[159C]                	mov	[BYTCNT],ax
 12195 0000089A 07                      	pop	es
 12196 0000089B C3                      	retn
 12197                                  
 12198                                  ; =============== S U B	R O U T	I N E =======================================
 12199                                  
 12200                                  ;Break	<BatCom - enter a batch file>
 12201                                  
 12202                                  ; The exec search has determined that the user has requested a batch file for
 12203                                  ; execution. We parse the arguments, create the batch segment, and signal
 12204                                  ; batch processing.
 12205                                  
 12206                                  	; 12/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12207                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:078Eh
 12208                                  
 12209                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 12210                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0868h
 12211                                  
 12212                                  	; 18/07/2024 - Retro DOS 5.0 COMMAND.COM
 12213                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:08A7h
 12214                                  
 12215                                  BATCOM:	
 12216                                  
 12217                                  ;ASSUME	DS:TRANGROUP, ES:NOTHING
 12218                                  
 12219                                  ; Batch parameters are read with ES set to segment of resident part
 12220                                  
 12221                                  	; MSDOS 6.0
 12222 0000089C 8E06[F59B]              	mov	es,[RESSEG]
 12223                                  	;ASSUME	ES:RESGROUP
 12224                                  	;cmp	byte [es:Call_Batch_Flag],1
 12225 000008A0 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12226                                  					;AN043; If in CALL,
 12227 000008A6 7403                    	jz	short skip_ioset	;AN043; redirection was already set up
 12228                                  	;invoke	IOSET			; Set up any redirection
 12229 000008A8 E80527                  	call	IOSET
 12230                                  skip_ioset:				;AN043;
 12231 000008AB E865FF                  	call	FREE_TPA		; G
 12232                                  	;cmp	byte [es:Call_Batch_Flag],1
 12233 000008AE 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12234 000008B4 7403                    	jz	short GETECHO 		; G if we're in a call, don't execute
 12235                                  
 12236                                  	; 12/02/2023
 12237                                  	; MSDOS 3.3
 12238                                  	;call	IOSET
 12239                                  	;mov	es,[RESSEG]
 12240                                  	;call	FREE_TPA
 12241                                  	;;cmp	byte [es:CALL_BATCH_FLAG],1
 12242                                  	;cmp	byte [es:CALL_BATCH_FLAG],call_in_progress
 12243                                  	;jz	short GETECHO		; G if we're in a call, don't execute
 12244                                  
 12245                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12246                                  
 12247                                  ; Since BATCH has lower precedence than PIPE or FOR. If a new BATCH file is
 12248                                  ; being started it MUST be true that no FOR or PIPE is currently in progress.
 12249                                  ; Don't execute if in call
 12250                                  
 12251 000008B6 E8A008                  	call	FOROFF
 12252                                  GETECHO:
 12253 000008B9 E8EB2A                  	call	PipeOff
 12254 000008BC 26A0[9D02]              	mov	al,[es:EchoFlag]	; preserve echo state for chaining
 12255 000008C0 2401                    	and	al,1			; Save current echo state
 12256                                  
 12257 000008C2 50                      	push	ax
 12258 000008C3 31C0                    	xor	ax,ax
 12259 000008C5 26F706[4902]FFFF        	test	word [es:Batch],-1 	; Are we in a batch file?
 12260 000008CC 7414                    	jz	short LEAVEBAT	   	; No, nothing to save
 12261 000008CE 26A1[4902]              	mov	ax,[es:Batch] 		; Get current batch segment
 12262                                  	;cmp	byte [es:Call_Batch_Flag],1
 12263 000008D2 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12264 000008D8 7408                    	jz	short LEAVEBAT
 12265                                  
 12266                                  ;  We are in a chained batch file, save batlast from previous batch segment
 12267                                  ;  so that if we're in a CALL, we will return to the correct batch file.
 12268                                  
 12269 000008DA 06                      	push	es
 12270 000008DB 8EC0                    	mov	es,ax		; Get current batch segment
 12271                                  	;mov	ax,[es:02h] ; MSDOS 3.3 COMMAND.COM
 12272                                  				; Get previous batch segment
 12273                                  	; 12/02/2023
 12274                                  	;mov	ax,[es:03h] ; MSDOS 6.0 (&5.0) COMMAND.COM	
 12275 000008DD 26A10300                	mov	ax,[es:BATCHSEGMENT.BatLast]
 12276 000008E1 07                      	pop	es
 12277                                  LEAVEBAT:
 12278 000008E2 50                      	push	ax		; Keep segment until new one created
 12279                                  	;cmp	byte [es:Call_Batch_Flag],1
 12280 000008E3 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12281 000008E9 7403                    	jz	short STARTBAT
 12282 000008EB E82401                  	call	BATCHOFF
 12283                                  
 12284                                  ; Find length of batch file
 12285                                  
 12286                                  STARTBAT:
 12287 000008EE 26C606[B102]00          	mov	byte [es:Call_Batch_Flag],0 ; Reset call flag
 12288 000008F4 BE[1D9B]                	mov	si,EXECPATH
 12289                                  
 12290                                  	; 12/02/2023
 12291                                  	; MSDOS 6.0
 12292 000008F7 B811B7                  	mov	ax,0B711h
 12293                                  	;mov	ax,AppendTruename
 12294                                  				;AN042; Get the real path where the batch file
 12295 000008FA CD2F                    	int	2Fh		;AN042;    was found with APPEND
 12296 000008FC B44E                    	mov	ah,4Eh
 12297                                  	;mov	ah,Find_First	;AN042; The find_first will return it
 12298 000008FE 89F2                    	mov	dx,si		;AN042; Get the string
 12299 00000900 B91300                  	mov	cx,13h
 12300                                  	;mov	cx,search_attr	;AN042; filetypes to search for
 12301                                  	
 12302                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12303                                  %if 0
 12304                                  	int	21h		;AN042;
 12305                                  %else
 12306 00000903 E8B4FC                  	call	int_21h_indirect
 12307                                  %endif
 12308                                  
 12309                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12310 00000906 E89627                  	call	dstrlen
 12311                                  ;
 12312                                  ; Allocate batch area:
 12313                                  ;   BYTE    type of segment
 12314                                  ;   WORD    segment of last batch file
 12315                                  ;   WORD    segment for FOR command
 12316                                  ;   BYTE    FOR flag state on entry to batch file
 12317                                  ;   DWORD   offset for next line
 12318                                  ;   10 WORD pointers to parameters.  -1 is empty parameter
 12319                                  ;   ASCIZ   file name (with . and ..)
 12320                                  ;   BYTES   CR-terminated parameters
 12321                                  ;   BYTE    0 flag to indicate end of parameters
 12322                                  ;
 12323                                  ; We allocate the maximum size for the command line and use setblock to shrink
 12324                                  ; later when we've squeezed out the extra
 12325                                  ;
 12326 00000909 89CB                    	mov	bx,cx		; length of file name.
 12327                                  	;add	bx,190	; MSDOS 3.3 (BATCHSEGMENT struc size = 32)
 12328                                  	; 12/02/2023
 12329                                  	;add	bx,191	; MSDOS 6.0 (BATCHSEGMENT struc size = 33)
 12330                                  			; PCDOS 7.1 ; 26/07/2024
 12331                                   	; 25/04/2023
 12332 0000090B 81C3BF00                	add	bx,15+BATCHSEGMENT.SIZE+COMBUFLEN+15
 12333                                  					; structure + max len + round up
 12334 0000090F 51                      	push	cx
 12335 00000910 B104                    	mov	cl,4
 12336 00000912 D3EB                    	shr	bx,cl		; convert to paragraphs
 12337 00000914 53                      	push	bx		; Save size of batch segment
 12338 00000915 B448                    	mov	ah,48h
 12339                                  	;mov	ah,ALLOC ; 48h ; Allocate batch segment
 12340                                  
 12341                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12342                                  %if 0
 12343                                  	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 12344                                  				; BX = number of 16-byte paragraphs desired
 12345                                  %else
 12346 00000917 E8A0FC                  	call	int_21h_indirect
 12347                                  %endif
 12348                                  
 12349 0000091A 5B                      	pop	bx		; Get size of batch segment
 12350                                  
 12351                                  ; This should *NEVER* return an error. The transient is MUCH bigger than
 12352                                  ; the batch segment. This may not be true, however, in a multitasking system.
 12353                                  ; G This error will occur with nesting of batch files. We also need to
 12354                                  ; G make sure that we don't overlay the transient.
 12355                                  
 12356 0000091B 7222                    	jc	short MEM_ERROR	;G not enough memory - exit
 12357                                  
 12358 0000091D 50                      	push	ax		;G save batch segment
 12359 0000091E 01D8                    	add	ax,bx		;G get end of batch segment
 12360 00000920 83C020                  	add	ax,20h		;G add some tpa work area
 12361 00000923 8CCB                    	mov	bx,cs		;G get the transient segment
 12362                                  
 12363                                  	; MSDOS 6.0
 12364                                  ; M006; We cant check just for above. If the batchseg goes into a UMB, the
 12365                                  ; M006; batchseg is always above the transient. We need to change this code
 12366                                  ; M006; to only check for an overlap
 12367                                  
 12368                                  	;;mov	dx,offset TRANGROUP:TranSpaceEnd ; M006
 12369                                  	; 12/02/2023
 12370                                  	;;mov	dx,98C5h ; MSDOS 5.0 COMMAND.COM
 12371                                  	; 18/07/2024
 12372                                  	;mov	dx,0AA9Ah ; PCDOS 7.1 COMMAND.COM
 12373                                  	;mov	dx,TRANSPACEEND		
 12374                                  	;add	dx,15		;round up para; M006
 12375 00000925 BA1AA6                  	mov	dx,TRANSPACEEND+15
 12376                                  
 12377 00000928 D3EA                    	shr	dx,cl		;para size of transient; M006
 12378 0000092A 01DA                    	add	dx,bx		;dx = top of transient; M006
 12379                                  
 12380 0000092C 39D8                    	cmp	ax,bx		; M006
 12381 0000092E 7212                    	jb	short ENOUGH_MEM
 12382                                  				; Batchseg below transient
 12383                                  				; enough memory ; M006
 12384 00000930 39D0                    	cmp	ax,dx		; M006
 12385 00000932 770E                    	ja	short ENOUGH_MEM	
 12386                                  				; Batchseg above transient
 12387                                  				; enough memory ; M006
 12388                                  
 12389                                  ; M006; Batchseg overlaps transient -- insufficient memory
 12390                                  
 12391 00000934 58                      	pop	ax		; restore ax; M006
 12392                                  
 12393                                  	; 12/02/2023
 12394                                  	; MSDOS 3.3
 12395                                  ; M006;	cmp	ax,bx		;G do we end before the transient
 12396                                  ; M006;	pop	ax		;G get batch segment back
 12397                                  ; M006;	jb	short ENOUGH_MEM ;G we have enough memory - continue
 12398                                  
 12399                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12400 00000935 06                      	push	es		;G no we're hitting the transient
 12401 00000936 8EC0                    	mov	es,ax
 12402 00000938 B80049                  	mov	ax,4900h
 12403                                  	;mov	ax,DEALLOC*256 ; 4900h ;G deallocate the batch segment
 12404                                  
 12405                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12406                                  %if 0
 12407                                  	int	21h	; DOS -	2+ - FREE MEMORY
 12408                                  			; ES = segment address of area to be freed
 12409                                  %else
 12410 0000093B E87CFC                  	call	int_21h_indirect
 12411                                  %endif
 12412                                  
 12413 0000093E 07                      	pop	es
 12414                                  MEM_ERROR:
 12415 0000093F E9B900                  	jmp	NO_MEMORY	;G Set up for message and exit
 12416                                  
 12417                                  ENOUGH_MEM:
 12418                                  	; 12/02/2023 - Retro DOS v4.0 COMMAND.COM
 12419                                  	; MSDOS 6.0
 12420 00000942 58                      	pop	ax		; restore ax; M006
 12421                                  
 12422                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12423 00000943 26A3[4902]              	mov	[es:Batch],ax
 12424 00000947 E8DAFE                  	call	ALLOC_TPA
 12425                                  
 12426                                  ; Initialize batch segment
 12427                                  
 12428 0000094A 5A                      	pop	dx		; length of name
 12429 0000094B 58                      	pop	ax		;G get saved batch segment back
 12430 0000094C 26FF06[AE02]            	inc	word [es:Nest]	;G increment # batch files in progress
 12431 00000951 06                      	push	es
 12432 00000952 268E06[4902]            	mov	es,[es:Batch]
 12433                                  	;mov	byte [ES:0],0
 12434                                  				; signal batch file type
 12435 00000957 26C606000000            	mov	byte [es:BATCHSEGMENT.BatType],BATCHTYPE ; 0
 12436                                  	;;mov	[es:2],ax	; MSDOS 3.3
 12437                                  				;G save segment of last batch file
 12438                                  	;mov	[es:3],ax	; MSDOS 6.0
 12439 0000095D 26A30300                	mov	[es:BATCHSEGMENT.BatLast],ax
 12440 00000961 1E                      	push	ds
 12441 00000962 8E1E[F59B]              	mov	ds,[RESSEG]	;G set to resident data
 12442                                  
 12443 00000966 31C0                    	xor	ax,ax
 12444 00000968 8A1E[AB02]              	mov	bl,[ForFlag]	;G get the current FOR state
 12445                                  	;;mov	[es:6],bl	; MSDOS 3.3
 12446                                  				;G save it in the batch segment
 12447                                  	;mov	[es:7],bl	; MSDOS 6.0 	
 12448 0000096C 26881E0700              	mov	[es:BATCHSEGMENT.BatForFlag],bl
 12449 00000971 F6C3FF                  	test	bl,-1 ; 0FFh	;G are we in a FOR?
 12450 00000974 7406                    	jz	short FOR_NOT_ON ;G no, for segment set to 0	
 12451                                  	;mov	ax,[ForPtr]	;G yes, get current FOR segment	
 12452                                  	;mov	byte [ForFlag],0 ;G reset forflag
 12453                                  	; 26/07/2024
 12454 00000976 A2[AB02]                	mov	[ForFlag],al ; 0
 12455 00000979 A1[AC02]                	mov	ax,[ForPtr]	;G yes, get current FOR segment	
 12456                                  FOR_NOT_ON:
 12457                                  	;;mov	[es:4],ax	; MSDOS 3.3
 12458                                  				;G save FOR segment in batch segment
 12459                                  	;mov	[es:5],ax	; MSDOS 6.0		
 12460 0000097C 26A30500                	mov	[es:BATCHSEGMENT.BatForPtr],ax	
 12461 00000980 31C0                    	xor	ax,ax
 12462 00000982 A3[AC02]                	mov	[ForPtr],ax	;G make sure for segment is not active
 12463 00000985 8A1E[9D02]              	mov	bl,[EchoFlag]
 12464 00000989 1F                      	pop	ds
 12465                                  	;mov	[es:1],bl 
 12466                                  				 ;G save echo state of parent
 12467 0000098A 26881E0100              	mov	[es:BATCHSEGMENT.BatEchoFlag],bl
 12468                                  ;SR;
 12469                                  ; Initialize the new BatchEOF flag we have added to 0
 12470                                  
 12471                                  	; MSDOS 6.0
 12472                                  	;mov	byte [es:2],0
 12473 0000098F 26C606020000            	mov	byte [es:BATCHSEGMENT.BatchEOF],0
 12474                                  
 12475                                  	;mov	[es:08h],ax  ; MSDOS 6.0
 12476 00000995 26A30800                	mov	[es:BATCHSEGMENT.BatSeek],ax ; point to beginning of file
 12477                                  	;mov	[es:0Ah],ax  ; MSDOS 6.0	
 12478 00000999 26A30A00                	mov	[es:BATCHSEGMENT.BatSeek+2],ax
 12479                                  
 12480                                  ; Initialize pointers
 12481                                  
 12482 0000099D 48                      	dec	ax		; put -1 into AX
 12483                                  	;;mov	di,0Bh  ; MSDOS 3.3
 12484                                  				; point to parm area
 12485                                  	;mov	di,0Ch	; MSDOS 6.0
 12486 0000099E BF0C00                  	mov	di,BATCHSEGMENT.BatParm
 12487 000009A1 89FB                    	mov	bx,di
 12488 000009A3 B90A00                  	mov	cx,10
 12489 000009A6 F3AB                    	rep stosw		; Init to no parms
 12490                                  
 12491                                  ; Move in batch file name
 12492                                  
 12493 000009A8 89D1                    	mov	cx,dx
 12494 000009AA F3A4                    	rep	movsb
 12495                                  
 12496                                  ; Now copy the command line into batch segment, parsing the arguments along
 12497                                  ; the way. Segment will look like this:
 12498                                  ;
 12499                                  ;   <arg0>CR<arg1>CR...<arg9>CR<arg10>CR...<ARGn>CR 0
 12500                                  ;
 12501                                  ; or, in the case of fewer arguments:
 12502                                  ;
 12503                                  ;   <arg0>CR<arg1>CR...<arg6>CR CR CR ... CR 0
 12504                                  
 12505 000009AC BE[569A]                	mov	si,COMBUF+2
 12506                                  	;mov	cx,10		; at most 10 arguments
 12507                                  	; 07/06/2023
 12508 000009AF B10A                    	mov	cl,10
 12509                                  EACHPARM:
 12510 000009B1 E8D21F                  	call	scanoff		; skip to argument
 12511                                  
 12512                                  ; AL is first non-delimiter. DS:SI points to char = AL
 12513                                  
 12514 000009B4 3C0D                    	cmp	al,0Dh		; end of road?
 12515 000009B6 741D                    	jz	short HAVPARM	; yes, no more arguments
 12516                                  
 12517                                  ; If CX = 0 then we have stored the most parm we can. Skip store
 12518                                  
 12519 000009B8 E306                    	jcxz	MOVPARM		; Only first 10 parms get pointers
 12520                                  
 12521                                  ; Go into allocated piece and stick in new argument pointer.
 12522                                  
 12523 000009BA 26893F                  	mov	[es:bx],di	; store batch pointer
 12524 000009BD 83C302                  	add	bx,2		; advance arg counter
 12525                                  
 12526                                  ; Move the parameter into batch segment
 12527                                  
 12528                                  MOVPARM:
 12529 000009C0 AC                      	lodsb			; get byte
 12530 000009C1 E8CA1F                  	call	DELIM		; if delimiter
 12531 000009C4 7407                    	jz	short ENDPARM	; then done with parm
 12532 000009C6 AA                      	stosb			; store byte
 12533 000009C7 3C0D                    	cmp	al,0Dh		; if CR then not delimiter
 12534 000009C9 740A                    	jz	short HAVPARM	; but end of parm list, finish
 12535 000009CB EBF3                    	jmp	short MOVPARM
 12536                                  
 12537                                  ; We have copied a parameter up until the first separator.
 12538                                  ; Terminate it with CR.
 12539                                  
 12540                                  ENDPARM:
 12541 000009CD B00D                    	mov	al,0Dh
 12542 000009CF AA                      	stosb
 12543 000009D0 E3DF                    	jcxz	EACHPARM	; if no parameters, don't dec
 12544 000009D2 49                      	dec	cx		; remember that we've seen one.	
 12545 000009D3 EBDC                    	jmp	short EACHPARM
 12546                                  
 12547                                  ; We have parsed the entire line. Terminate the arg list
 12548                                  
 12549                                  HAVPARM:
 12550 000009D5 30C0                    	xor	al,al		; Nul terminate the parms
 12551 000009D7 AA                      	stosb
 12552                                  
 12553                                  ; Now we know EXACTLY how big the BATCH segment is. Round up size (from DI)
 12554                                  ; into paragraphs and setblock to the appropriate size
 12555                                  
 12556 000009D8 8D5D0F                  	lea	bx,[di+15]
 12557 000009DB B104                    	mov	cl,4
 12558 000009DD D3EB                    	shr	bx,cl
 12559 000009DF B44A                    	mov	ah,4Ah
 12560                                  	;mov	ah,SETBLOCK ; 4Ah
 12561                                  
 12562                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12563                                  %if 0
 12564                                  	int	21h	; DOS -	2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 12565                                  			; ES = segment address of block	to change
 12566                                  			; BX = new size	in paragraphs
 12567                                  %else
 12568 000009E1 E8D6FB                  	call	int_21h_indirect
 12569                                  %endif
 12570                                  
 12571 000009E4 07                      	pop	es
 12572 000009E5 06                      	push	es
 12573 000009E6 1F                      	pop	ds		; Simply batch FCB setup
 12574 000009E7 833E[A502]FF            	cmp	word [SingleCom],-1 ; 0FFFFh
 12575 000009EC 7506                    	jne	short NOBATSING
 12576 000009EE C706[A502]F0FF          	mov	word [SingleCom],0FFF0h ; Flag single command BATCH job
 12577                                  
 12578                                  NOBATSING:
 12579                                  
 12580                                  ; Enter the batch file with the current echo state
 12581                                  
 12582 000009F4 58                      	pop	ax		; Get original echo state
 12583 000009F5 A2[9D02]                	mov	[EchoFlag],al	; restore it
 12584 000009F8 E909F7                  	jmp	TCOMMAND
 12585                                  
 12586                                  ; The following is executed if there isn't enough memory for batch segment
 12587                                  
 12588                                  NO_MEMORY:
 12589 000009FB 5A                      	pop	dx		; even up our stack 
 12590 000009FC 58                      	pop	ax
 12591 000009FD 58                      	pop	ax
 12592 000009FE E823FE                  	call	ALLOC_TPA	; reallocate memory
 12593                                  
 12594                                  	; 12/02/2023
 12595                                  	; MSDOS 3.3
 12596                                  	;mov	dx,INSFMEMMESPTR
 12597                                  	;jmp	CERROR
 12598                                  
 12599                                  	; MSDOS 6.0
 12600                                  	;mov	byte [msg_disp_class],1
 12601 00000A01 C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class
 12602                                  				;AN000; set up extended error msg class
 12603                                  	;mov	dx,offset TranGroup:Extend_Buf_ptr
 12604 00000A06 BA[D78F]                	mov	dx,extend_buf_ptr
 12605                                  	;			;AC000; get extended message pointer
 12606                                  	;mov	word [extend_buf_ptr],8
 12607 00000A09 C706[D78F]0800          	mov	word [extend_buf_ptr],ERROR_NOT_ENOUGH_MEMORY
 12608                                  				;AN000; get message number in control block
 12609 00000A0F E91423                  	jmp	cerror		;g print error message and go...
 12610                                  
 12611                                  ; =============== S U B	R O U T	I N E =======================================
 12612                                  
 12613                                  	; 12/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12614                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 12615                                  BATCHOFF:
 12616 00000A12 50                      	push	ax
 12617 00000A13 06                      	push	es
 12618 00000A14 1E                      	push	ds
 12619 00000A15 53                      	push	bx
 12620                                  
 12621 00000A16 2E8E06[F59B]            	mov	es,[cs:RESSEG]
 12622                                  	;mov	ds,[cs:RESSEG]
 12623                                  	; 26/07/2024
 12624 00000A1B 06                      	push	es
 12625 00000A1C 1F                      	pop	ds
 12626                                  
 12627 00000A1D A1[4902]                	mov	ax,[Batch]	; Free the batch segment
 12628 00000A20 09C0                    	or	ax,ax
 12629 00000A22 7443                    	jz	short NOTFREE
 12630                                  
 12631 00000A24 06                      	push	es
 12632 00000A25 8EC0                    	mov	es,ax
 12633 00000A27 F606[9D02]01            	test	byte [EchoFlag],1
 12634                                  				;G Is echo on?
 12635 00000A2C 7505                    	jnz	short ECHO_LAST_LINE
 12636                                  				;G Yes - echo last line in file
 12637                                  	;mov	byte [SUPPRESS],0
 12638 00000A2E C606[9E02]00            	mov	byte [Suppress],NO_ECHO
 12639                                  				;G no - don't echo last line in file	
 12640                                  ECHO_LAST_LINE:
 12641                                  	;mov	bl,[es:1]
 12642 00000A33 268A1E0100              	mov	bl,[es:BATCHSEGMENT.BatEchoFlag]
 12643                                  				; G get echo state
 12644 00000A38 881E[9D02]              	mov	[EchoFlag],bl
 12645                                  				; G  and restore it
 12646                                  	;;mov	bx,[es:4]  ; MSDOS 3.3
 12647                                  	;mov	bx,[es:5]  ; MSDOS 6.0
 12648 00000A3C 268B1E0500              	mov	bx,[es:BATCHSEGMENT.BatForPtr]
 12649                                  				;G Get FOR segment
 12650 00000A41 891E[AC02]              	mov	[ForPtr],bx	;G  and restore it
 12651                                  	;;mov	bl,[es:6]  ; MSDOS 3.3
 12652                                  	;mov	bl,[es:7]  ; MSDOS 6.0	
 12653 00000A45 268A1E0700              	mov	bl,[es:BATCHSEGMENT.BatForFlag]
 12654                                  				;G Get FOR flag
 12655 00000A4A 881E[AB02]              	mov	[ForFlag],bl
 12656                                  				;G  and restore it
 12657                                  	;;mov	bx,[es:2] ; MSDOS 3.3
 12658                                  	;mov	bx,[es:3] ; MSDOS 6.0	
 12659 00000A4E 268B1E0300              	mov	bx,[es:BATCHSEGMENT.BatLast]
 12660                                  				;G  Get old batch segment
 12661 00000A53 B449                    	mov	ah,49h
 12662                                  	;mov	ah,DEALLOC ; 49h
 12663                                  
 12664                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12665                                  %if 0
 12666                                  	int	21h	; DOS -	2+ - FREE MEMORY
 12667                                  			; ES = segment address of area to be freed
 12668                                  %else
 12669 00000A55 E862FB                  	call	int_21h_indirect
 12670                                  %endif
 12671                                  
 12672 00000A58 07                      	pop	es
 12673 00000A59 891E[B202]              	mov	[Next_Batch],bx	;G reset batch segment	
 12674 00000A5D 26FF0E[AE02]            	dec	word [es:Nest]
 12675 00000A62 31C0                    	xor	ax,ax
 12676 00000A64 A3[4902]                	mov	[Batch],ax	; No batch in progress
 12677                                  NOTFREE:
 12678 00000A67 5B                      	pop	bx
 12679 00000A68 1F                      	pop	ds
 12680 00000A69 07                      	pop	es
 12681 00000A6A 58                      	pop	ax
 12682 00000A6B C3                      	retn
 12683                                  
 12684                                  ; =============== S U B	R O U T	I N E =======================================
 12685                                  
 12686                                  	; 12/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12687                                  
 12688                                  ; StrCpy - copy string, checking count in CX against COMBUFLEN
 12689                                  ;	Entry : DS:SI ==> source string
 12690                                  ;		ES:DI ==> destination string
 12691                                  ;		CX = current length of destination string
 12692                                  ;	Exit  : string copied, CX updated, Carry set if length limit exceeded
 12693                                  
 12694                                  	; 12/02/2023	
 12695                                  	; MSDOS 3.3
 12696                                  ;STRCPY:
 12697                                  	;push	ax
 12698                                  ;CCYCLE:
 12699                                  	;lodsb
 12700                                  	;stosb
 12701                                  	;or	al,al
 12702                                  	;jnz	short CCYCLE
 12703                                  	;pop	ax
 12704                                  	;retn
 12705                                  
 12706                                  ;Procedure StrCpy,NEAR
 12707                                  
 12708                                  	; 12/02/2023
 12709                                  	; MSDOS 6.0
 12710                                  STRCPY:
 12711 00000A6C 50                      	push	ax
 12712                                  ccycle:
 12713 00000A6D AC                      	lodsb
 12714 00000A6E 41                      	inc	cx
 12715                                  	;cmp	cx,128
 12716 00000A6F 81F98000                	cmp	cx,COMBUFLEN
 12717                                  	;jb	short ccopy
 12718                                  	;stc			; set carry to signal error
 12719                                  	;jmp	short ccend
 12720                                  	; 12/02/2023
 12721 00000A73 F5                      	cmc
 12722 00000A74 7205                    	jc	short ccend
 12723                                  ccopy:
 12724 00000A76 AA                      	stosb
 12725 00000A77 08C0                    	or	al,al
 12726 00000A79 75F2                    	jnz	short ccycle
 12727                                  ccend:
 12728 00000A7B 49                      	dec	cx		; discount extra byte
 12729 00000A7C 4F                      	dec	di		; back up pointer
 12730 00000A7D 58                      	pop	ax
 12731 00000A7E C3                      	retn			; return carry clear
 12732                                  
 12733                                  ;EndProc StrCpy
 12734                                  
 12735                                  ;============================================================================
 12736                                  ; TBATCH2.ASM, MSDOS 6.0, 1991
 12737                                  ;============================================================================
 12738                                  ; 12/10/2018 - Retro DOS v3.0
 12739                                  
 12740                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 0892h
 12741                                  
 12742                                  ; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12743                                  
 12744                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 0977h
 12745                                  
 12746                                  ; =============== S U B	R O U T	I N E =======================================
 12747                                  
 12748                                  ;Break	<GetBatByt - retrieve a byte from the batch file>
 12749                                  
 12750                                  ; Get one byte from the batch file and return it in AL. End-of-file returns
 12751                                  ; <CR> and ends batch mode. DS must be set to resident segment.
 12752                                  ; AH, DX destroyed.
 12753                                  
 12754                                  ; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 12755                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 0A95h
 12756                                  
 12757                                  GETBATBYT:
 12758 00000A7F 53                      	push	bx
 12759 00000A80 51                      	push	cx
 12760 00000A81 1E                      	push	ds
 12761 00000A82 F606[9302]FF            	test	byte [Batch_Abort],-1
 12762                                  	;jnz	short BATEOF
 12763                                  	; 14/02/2023
 12764 00000A87 7403                    	jz	short getbatbyt1
 12765 00000A89 E9D200                  	jmp	BATEOF
 12766                                  getbatbyt1:
 12767 00000A8C F706[4902]FFFF          	test	word [Batch],-1
 12768                                  	;jz	short BATEOF
 12769                                  	; 14/02/2023
 12770 00000A92 7503                    	jnz	short getbatbyt2
 12771 00000A94 E9C700                  	jmp	BATEOF
 12772                                  getbatbyt2:
 12773 00000A97 06                      	push	es
 12774 00000A98 8E06[4902]              	mov	es,[Batch]
 12775                                  
 12776                                  	; MSDOS 6.0
 12777                                  ;M020;
 12778                                  ;Check if we have already reached EOF (BatchEOF flag set. Then, we do not
 12779                                  ;try to read from the batchfile again.
 12780                                  
 12781                                  	;cmp	byte [es:2],0
 12782 00000A9C 26803E020000            	cmp	byte [es:BATCHSEGMENT.BatchEOF],0
 12783                                  				;already reached EOF?	;M020
 12784 00000AA2 7403                    	jz	short not_eof	;no, read batch file	;M020
 12785 00000AA4 E99D00                  	jmp	At_EOF		;yes, no more reads	;M020
 12786                                  not_eof:						;M020
 12787                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12788                                  	;add	word [es:8],1	; MSDOS 6.0
 12789 00000AA7 268306080001            	add	word [es:BATCHSEGMENT.BatSeek],1
 12790                                  	;adc	word [es:10],0	; MSDOS 6.0
 12791 00000AAD 2683160A0000            	adc	word [es:BATCHSEGMENT.BatSeek+2],0
 12792 00000AB3 07                      	pop	es
 12793                                  
 12794                                  ; See if we have bytes buffered...
 12795                                  
 12796 00000AB4 8CC8                    	mov	ax,cs
 12797 00000AB6 8ED8                    	mov	ds,ax
 12798 00000AB8 8B1E[C7A5]              	mov	bx,[BATBUFPOS]
 12799 00000ABC 83FBFF                  	cmp	bx,-1
 12800 00000ABF 7541                    	jnz	short UNBUF
 12801                                  
 12802                                  ; There are no bytes in the buffer. Let's try to fill it up.
 12803                                  
 12804 00000AC1 BA[C9A5]                	mov	dx,BATBUF
 12805 00000AC4 8B0E[E495]              	mov	cx,[BATBUFLEN] ; max to read.
 12806 00000AC8 8B1E[F49E]              	mov	bx,[BATHAND]
 12807                                  	; 14/02/2023
 12808 00000ACC B43F                    	mov	ah,3Fh
 12809                                  	;mov	ah,READ ; 3Fh	; Get one more byte from batch file
 12810                                  
 12811                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12812                                  %if 0
 12813                                  	int	21h	; DOS -	2+ - READ FROM FILE WITH HANDLE
 12814                                  			; BX = file handle,CX = number	of bytes to read
 12815                                  			; DS:DX	-> buffer
 12816                                  %else
 12817 00000ACE E8E9FA                  	call	int_21h_indirect
 12818                                  %endif
 12819                                  
 12820                                  	; MSDOS 6.0
 12821 00000AD1 7321                    	jnc	short bat_read_ok	;AN022; if no error - continue
 12822                                  	;invoke	get_ext_error_number	;AN022; get the error
 12823 00000AD3 E87515                  	call	get_ext_error_number
 12824 00000AD6 1E                      	push	ds			;AN022; save local segment
 12825 00000AD7 8E1E[F59B]              	mov	ds,[RESSEG]		;AN022; get resident segment
 12826                                  	;assume ds:resgroup		;AN022;
 12827 00000ADB 89C2                    	mov	dx,ax			;AN022; put error in DX
 12828                                  	;invoke	output_batch_name	;AN022; set up to print the error
 12829 00000ADD E857FB                  	call	output_batch_name
 12830 00000AE0 1F                      	pop	ds			;AN022;
 12831                                  	;assume	ds:trangroup		;AN022;
 12832                                  	;invoke	std_eprintf		;AN022; print out the error
 12833 00000AE1 E83C49                  	call	std_eprintf
 12834                                  	;mov	byte ptr combuf+2,end_of_line_in
 12835 00000AE4 C606[569A]0D            	mov	byte [COMBUF+2],END_OF_LINE_IN ; 0Dh
 12836                                  	;				;AN022; terminate the batch line for parsing
 12837                                  	;mov	byte ptr combuf+3,end_of_line_out 
 12838 00000AE9 C606[579A]00            	mov	byte [COMBUF+3],END_OF_LINE_OUT ; 0
 12839                                  	;				;AN022; terminate the batch line for output
 12840                                  ;M020;
 12841                                  ;Old bug! We jump to BatEof from here without ds=RESGROUP. Probably, this
 12842                                  ;error is never hit (and it shouldn't be)
 12843                                  
 12844 00000AEE 8E1E[F59B]              	mov	ds,[RESSEG]		; ds = RESGROUP ; M020
 12845 00000AF2 EB6A                    	jmp	short BATEOF		;AN022; terminate the batch file
 12846                                  bat_read_ok:				;AN022;
 12847                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12848 00000AF4 89C1                    	mov	cx,ax
 12849                                  	;jcxz	TURN_OFF ; MSDOS 3.3
 12850                                  	; 14/02/2023
 12851 00000AF6 E320                    	jcxz	BATEOFDS ; MSDOS 6.0
 12852 00000AF8 890E[E9A5]              	mov	[BATBUFEND],cx
 12853 00000AFC 31DB                    	xor	bx,bx
 12854 00000AFE 891E[C7A5]              	mov	[BATBUFPOS],bx
 12855                                  
 12856                                  	; Buffered bytes!
 12857                                  UNBUF:
 12858 00000B02 8A87[C9A5]              	mov	al,[BATBUF+bx]		; get next byte
 12859 00000B06 43                      	inc	bx
 12860 00000B07 3B1E[E9A5]              	cmp	bx,[BATBUFEND]		; beyond end of buffer?
 12861 00000B0B 7203                    	jb	short SETBUFPOS
 12862 00000B0D BBFFFF                  	mov	bx,-1
 12863                                  SETBUFPOS:
 12864 00000B10 891E[C7A5]              	mov	[BATBUFPOS],bx
 12865 00000B14 3C1A                    	cmp	al,1Ah			; ^Z for termination?
 12866 00000B16 7575                    	jne	short GETBYTEDONE
 12867                                  
 12868                                  ;We get here only when we hit an EOF
 12869                                  	
 12870                                  	; MSDOS 6.0
 12871                                  BATEOFDS:
 12872                                  ;SR;
 12873                                  ; HACK!!! A massive hack being put in here to get batch processing to work
 12874                                  ;properly on EOF. Previously, a CR was returned and batch processing turned
 12875                                  ;off the moment we hit an EOF. Unfortunately, if the last line had no CR-LF,
 12876                                  ;batch processing is turned off before the last line is processed and so 
 12877                                  ;this line would never be executed. 
 12878                                  ;   	To fix this, a new flag BatchEOF has been introduced. This flag is
 12879                                  ;set to 4 if there is no CR-LF before the EOF -- this is determined by looking
 12880                                  ;at the buffer contents. If there is no LF ( we assume that presence of LF
 12881                                  ;indicated a CR-LF combination), then we set BatchEOF to 4 and return a 
 12882                                  ;fake CR to the caller. This decrements BatchEOF. On the next call to this
 12883                                  ;routine, BatchEOF is decremented to 2 and a fake lF is returned. On the 
 12884                                  ;third call, BatchEOF becomes zero and batch processing is turned off,
 12885                                  ;now that the last line has been processed. If the EOF is the first char read into the buffer 
 12886                                  ;during this call, and there was a CR-LF previously, we are going to fake
 12887                                  ;another redundant CR-LF. There is no work-around I can think of.
 12888                                  ; 	I would love to restructure this entire routine and its caller to
 12889                                  ;make the flow really easy to understand but I guess this will have to wait.
 12890                                  ;
 12891 00000B18 06                      	push	es
 12892 00000B19 8E06[F59B]              	mov	es,[RESSEG]
 12893                                  ;SR;
 12894                                  ; If we had already set the BatchEOF flag on a previous call (BatchEOF == 2
 12895                                  ;or BatchEOF == 1 now), then do not do the LF check.
 12896                                  ;
 12897 00000B1D 268E06[4902]            	mov	es,[es:Batch]
 12898                                  	;cmp	byte [es:2],0
 12899 00000B22 26803E020000            	cmp	byte [es:BATCHSEGMENT.BatchEOF],0
 12900 00000B28 7516                    	jnz	short crpresent
 12901                                  
 12902                                  	;inc	byte [es:2]
 12903 00000B2A 26FE060200              	inc	byte [es:BATCHSEGMENT.BatchEOF]
 12904                                  					;match the dec following
 12905 00000B2F 8B1E[E9A5]              	mov	bx,[BATBUFEND]
 12906 00000B33 80BF[C8A5]0A            	cmp	byte [bx+BATBUF-1],0Ah	;was a LF present?
 12907 00000B38 7406                    	je	short crpresent		;yes, no need to fake it
 12908                                  
 12909                                  	;add	byte [es:2],3
 12910 00000B3A 268006020003            	add	byte [es:BATCHSEGMENT.BatchEOF],3
 12911                                  					;BatchEOF == 4 to fake CR-LF
 12912                                  crpresent:
 12913                                  ;;	;pop	es
 12914                                  
 12915                                  	;ASSUME	DS:TranGroup
 12916                                  	; 14/02/2023
 12917 00000B40 8E1E[F59B]              	mov	ds,[RESSEG]
 12918                                  	;ASSUME	DS:ResGroup
 12919                                  ;SR;
 12920                                  ; The shift operation is done here to replace the decrement. This is because
 12921                                  ;we can jump to this label directly from above when bogus calls are made to
 12922                                  ;this routine even after batch processing is turned off. The shift ensures
 12923                                  ;maintains the following invariance : 4 -> 2; 2 -> 1 ; 1 -> 0; 0 -> 0. Thus,
 12924                                  ;it is used as a decrement and also as a NOP to just fall through on bogus 
 12925                                  ;calls.
 12926                                  ;	We turn batch processing off if BatchEOF == 1 or BatchEOF == 0.
 12927                                  ;BatchEOF == 1 when we fall through from BatEOFDS and BatchEOF == 0 on a 
 12928                                  ;direct jump to BATEOF. If BatchEOF == 4, we return a fake CR-LF without 
 12929                                  ;turning batch processing off.
 12930                                  
 12931                                  At_EOF:					;new label added ;M020
 12932                                  	;shr	byte [es:2],1
 12933 00000B44 26D02E0200              	shr	byte [es:BATCHSEGMENT.BatchEOF],1
 12934                                  					;decrement the flag
 12935 00000B49 7412                    	jz	short turn_off		;zero,turn batch off
 12936                                  	;cmp	byte [es:2],1
 12937 00000B4B 26803E020001            	cmp	byte [es:BATCHSEGMENT.BatchEOF],1				
 12938 00000B51 7405                    	jz	short ret_lf		;BatchEOF was 2, return LF
 12939                                  ;
 12940                                  ;BatchEOF == 4, indicates return fake CR now and fake LF next.
 12941                                  ;
 12942 00000B53 B00D                    	mov	al,0Dh			;return fake CR.
 12943 00000B55 07                      	pop	es
 12944 00000B56 EB35                    	jmp	short GETBYTEDONE
 12945                                  ret_lf:
 12946 00000B58 B00A                    	mov	al,0Ah			;return fake LF
 12947 00000B5A 07                      	pop	es
 12948 00000B5B EB30                    	jmp	short GETBYTEDONE		
 12949                                  turn_off:
 12950 00000B5D 07                      	pop	es
 12951                                  ;BATEOF:
 12952                                  	; MSDOS 3.3
 12953                                  ;TURN_OFF:
 12954                                  	;mov	ds,[RESSEG]
 12955                                  
 12956                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12957                                  BATEOF:
 12958 00000B5E E8B1FE                  	call	BATCHOFF
 12959 00000B61 E8CC02                  	call	BATCLOSE
 12960                                  
 12961                                  ;;;	mov	BatchEOF,0	;make sure BatchEOF = 0
 12962                                  
 12963                                  ;SR; BugBug
 12964                                  ; There is a good reason why this carriage return is being returned here. 
 12965                                  ;This was part of the old code, thanks to some brain-damaged coding. Because,
 12966                                  ;of the way the caller is structured, a fake CR has to be returned again on
 12967                                  ;EOF to ensure the termination of the caller's loop. If echo is on, this
 12968                                  ;results in an extra linefeed after the batchfile is run if the last line of
 12969                                  ;the batchfile already had a CR-LF. 
 12970                                  ;NB: Do not confuse this with the faked CR. The fake CR-LF was to mark
 12971                                  ;the end-of-line. This CR is to mark the end-of-file.
 12972                                  
 12973 00000B64 B00D                    	mov	al,0Dh			; If end-of-file, then end of line
 12974 00000B66 F606[9302]FF            	test	byte [Batch_Abort],-1
 12975 00000B6B C606[9302]00            	mov	byte [Batch_Abort],0
 12976 00000B70 7407                    	jz	short CONT_GET_BYT
 12977 00000B72 BF[569A]                	mov	di,COMBUF+2		; reset pointer to beginning of buffer
 12978 00000B75 31C9                    	xor	cx,cx			; zero line length
 12979 00000B77 EB14                    	jmp	short GETBYTEDONE
 12980                                  CONT_GET_BYT:
 12981 00000B79 833E[A502]F0            	cmp	word [SingleCom],0FFF0h ; See if we need to set SINGLECOM
 12982 00000B7E 750D                    	jne	short GETBYTEDONE
 12983 00000B80 833E[AE02]00            	cmp	word [Nest],0		;G See if we have nested batch files
 12984 00000B85 7506                    	jnz	short GETBYTEDONE	;G Yes - don't exit just yet
 12985 00000B87 C706[A502]FFFF          	mov	word [SingleCom],0FFFFh	; -1 ; Cause termination
 12986                                  GETBYTEDONE:
 12987 00000B8D 1F                      	pop	ds
 12988 00000B8E 59                      	pop	cx
 12989 00000B8F 5B                      	pop	bx
 12990 00000B90 C3                      	retn
 12991                                  
 12992                                  ; ---------------------------------------------------------------------------
 12993                                  
 12994                                  ;break	<$If - conditional execution>
 12995                                  
 12996                                  	; 17/04/2023
 12997                                  ;IFERRORP:
 12998                                  ;	pop	ax
 12999                                  ;IFERROR:
 13000                                  ;	; 14/02/2023 - Retro DOS v4.0 COMMAND.COM
 13001                                  ;FORERROR:
 13002                                  ;	mov	dx,SYNTMES_PTR
 13003                                  ;	jmp	cerror
 13004                                  
 13005                                  ; ---------------------------------------------------------------------------
 13006                                  
 13007                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13008                                  	;
 13009                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 13010                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0B69h
 13011                                  
 13012                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 13013                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0BAEh
 13014                                  _$IF:
 13015                                  	; MSDOS 6.0
 13016                                  ; Turn off any pipes in progress.
 13017 00000B91 1E                      	push	ds			;AN004; save local DS
 13018 00000B92 8E1E[F59B]              	mov	ds,[RESSEG]		;AN004; get resident segment
 13019                                  	;assume	ds:resgroup		;AN004;
 13020 00000B96 803E[1403]00            	cmp	byte [PipeFiles],0	;AN004; Only turn off if present.
 13021 00000B9B 7403                    	jz	short IFNoPipe		;AN004; no pipe - continue
 13022                                  	;invoke	PipeDel 		;AN004; turn off piping
 13023 00000B9D E88025                  	call	PIPEDEL	
 13024                                  IFNoPipe:				;AN004;
 13025 00000BA0 1F                      	pop	ds			;AN004; get local DS back
 13026                                  	;assume	ds:trangroup		;AN004;
 13027                                  
 13028                                  	; MSDOS 3.3 (&MSDOS 6.0)
 13029 00000BA1 C606[069C]00            	mov	byte [IFNOTFLAG],0
 13030 00000BA6 C706[9CA4]0000          	mov	word [IF_NOT_COUNT],0
 13031 00000BAC BE8100                  	mov	si,81h
 13032                                  IFREENT:
 13033 00000BAF E8D41D                  	call	scanoff
 13034 00000BB2 3C0D                    	cmp	al,0Dh
 13035 00000BB4 743C                    	je	short IFERROR
 13036 00000BB6 89F5                    	mov	bp,si
 13037 00000BB8 BF[3394]                	mov	di,IFTAB		; Prepare to search if table	
 13038                                  	;mov	ch,0
 13039                                  	; 17/04/2023
 13040 00000BBB 30ED                    	xor	ch,ch
 13041                                  IFINDCOM:
 13042 00000BBD 89EE                    	mov	si,bp
 13043 00000BBF 8A0D                    	mov	cl,[di]
 13044 00000BC1 47                      	inc	di
 13045 00000BC2 E33E                    	jcxz	IFSTRING
 13046 00000BC4 EB02                    	jmp	short FIRSTCOMP
 13047                                  IFCOMP:
 13048 00000BC6 7510                    	jnz	short IF_DIF
 13049                                  FIRSTCOMP:
 13050 00000BC8 AC                      	lodsb
 13051 00000BC9 268A25                  	mov	ah,[es:di]
 13052 00000BCC 47                      	inc	di
 13053 00000BCD 38E0                    	cmp	al,ah
 13054 00000BCF 7405                    	je	short IFLP
 13055 00000BD1 80CC20                  	or	ah,20h			; Try lower case
 13056 00000BD4 38E0                    	cmp	al,ah
 13057                                  IFLP:
 13058 00000BD6 E2EE                    	loop	IFCOMP
 13059                                  IF_DIF:
 13060 00000BD8 9F                      	lahf
 13061 00000BD9 01CF                    	add	di,cx			; Bump to next position without affecting flags
 13062 00000BDB 8B1D                    	mov	bx,[di]			; Get handler address
 13063 00000BDD 47                      	inc	di
 13064 00000BDE 47                      	inc	di
 13065 00000BDF 9E                      	sahf
 13066 00000BE0 75DB                    	jnz	short IFINDCOM
 13067 00000BE2 AC                      	lodsb
 13068 00000BE3 3C0D                    	cmp	al,0Dh
 13069                                  IFERRJ:
 13070 00000BE5 740B                    	jz	short IFERROR
 13071 00000BE7 E8A41D                  	call	DELIM
 13072 00000BEA 75D1                    	jnz	short IFINDCOM
 13073 00000BEC E8971D                  	call	scanoff
 13074 00000BEF FFE3                    	jmp	bx
 13075                                  
 13076                                  	; 17/04/2023
 13077                                  IFERRORP:
 13078 00000BF1 58                      	pop	ax
 13079                                  IFERROR:
 13080                                  	; 14/02/2023 - Retro DOS v4.0 COMMAND.COM
 13081                                  FORERROR:
 13082 00000BF2 BA[AA90]                	mov	dx,SYNTMES_PTR
 13083 00000BF5 E92E21                  	jmp	cerror
 13084                                  
 13085                                  IFNOT:
 13086 00000BF8 F616[069C]              	not	byte [IFNOTFLAG]
 13087 00000BFC FF06[9CA4]              	inc	word [IF_NOT_COUNT]
 13088 00000C00 EBAD                    	jmp	short IFREENT
 13089                                  
 13090                                  ; We are comparing two strings for equality. First, find the end of the
 13091                                  ; first string.
 13092                                  
 13093                                  IFSTRING:
 13094 00000C02 56                      	push	si			; save away pointer for later compare
 13095 00000C03 31C9                    	xor	cx,cx			; count of chars in first string
 13096                                  FIRST_STRING:
 13097 00000C05 AC                      	lodsb				; get character
 13098 00000C06 3C0D                    	cmp	al,0Dh			; end of line?
 13099 00000C08 74E7                    	jz	short IFERRORP		; yes => error
 13100 00000C0A E8811D                  	call	DELIM			; is it a delimiter?
 13101 00000C0D 7403                    	jz	short EQUAL_CHECK 	; yes, go find equal sign
 13102 00000C0F 41                      	inc	cx			; remember 1 byte for the length
 13103 00000C10 EBF3                    	jmp	short FIRST_STRING 	; go back for more
 13104                                  EQUAL_CHECK:
 13105 00000C12 3C3D                    	cmp	al,'='			; is char we have an = sign?
 13106 00000C14 7407                    	je	short EQUAL_CHECK2 	; yes, go find second one.
 13107 00000C16 3C0D                    	cmp	al,0Dh			; end of line?
 13108 00000C18 74D7                    	je	short IFERRORP		; yes, syntax error
 13109 00000C1A AC                      	lodsb				; get next char
 13110 00000C1B EBF5                    	jmp	short EQUAL_CHECK
 13111                                  
 13112                                  ; The first = has been found. The next char had better be an = too.
 13113                                  
 13114                                  EQUAL_CHECK2:
 13115 00000C1D AC                      	lodsb				; get potential = char
 13116 00000C1E 3C3D                    	cmp	al,'='			; is it good?	
 13117                                  	;jnz	short IFERRPJ		; no, error
 13118                                  	; 17/04/2023
 13119 00000C20 75CF                    	jne	short IFERRORP
 13120                                  
 13121                                  ; Find beginning of second string.
 13122                                  
 13123 00000C22 E8611D                  	call	scanoff
 13124 00000C25 3C0D                    	cmp	al,0Dh
 13125                                  	;jz	short IFERRPJ
 13126                                  	; 17/04/2023
 13127 00000C27 74C8                    	je	short IFERRORP
 13128 00000C29 5F                      	pop	di
 13129                                  
 13130                                  ; DS:SI points to second string
 13131                                  ; CX has number of chars in first string
 13132                                  ; ES:DI points to first string
 13133                                  
 13134 00000C2A F3A6                    	repe	cmpsb
 13135 00000C2C 7414                    	jz	short MATCH		; match found!
 13136                                  
 13137                                  ; No match. Let's find out what was wrong. The character that did not match
 13138                                  ; has been advanced over. Let's back up to it.
 13139                                  
 13140 00000C2E 4E                      	dec	si
 13141                                  
 13142                                  ; If it is EOL, then syntax error
 13143                                  
 13144 00000C2F 803C0D                  	cmp	byte [si],0Dh
 13145                                  	;jz	short IFERRJ
 13146                                  	; 17/04/2023
 13147 00000C32 74BE                    	je	short IFERROR
 13148                                  
 13149                                  ; Advance pointer over remainder of unmatched text to next delimiter
 13150                                  
 13151                                  SKIPSTRINGEND:
 13152 00000C34 AC                      	lodsb
 13153                                  NOTMATCH:
 13154 00000C35 3C0D                    	cmp	al,0Dh
 13155                                  IFERRORJ2:
 13156                                  	;jz	short IFERRJ
 13157                                  	; 17/04/2023
 13158 00000C37 74B9                    	jz	short IFERROR
 13159 00000C39 E8521D                  	call	DELIM
 13160 00000C3C 75F6                    	jnz	short SKIPSTRINGEND
 13161                                  
 13162                                  ; Signal that we did NOT have a match
 13163                                  
 13164 00000C3E B0FF                    	mov	al,-1	 ; 0FFh
 13165 00000C40 EB37                    	jmp	short IFRET
 13166                                  
 13167                                  	; 17/04/2023
 13168                                  ;IFERRPJ:
 13169                                  	;jmp	IFERRORP
 13170                                  
 13171                                  ; The compare succeeded. Was the second string longer than the first?
 13172                                  ; We do this by seeing if the next char is a delimiter.
 13173                                  
 13174                                  MATCH:
 13175 00000C42 AC                      	lodsb
 13176 00000C43 E8481D                  	call	DELIM
 13177 00000C46 75ED                    	jnz	short NOTMATCH ; not same.
 13178 00000C48 30C0                    	xor	al,al
 13179 00000C4A EB2D                    	jmp	short IFRET
 13180                                  
 13181                                  ; ---------------------------------------------------------------------------
 13182                                  
 13183                                  IFEXISTS:
 13184                                  
 13185                                  IFEXIST_ATTR	EQU	ATTR_HIDDEN+ATTR_SYSTEM  ; 2+4 = 6
 13186                                  
 13187                                  ;MOREDELIM:
 13188 00000C4C AC                      	lodsb
 13189 00000C4D E83E1D                  	call	DELIM
 13190 00000C50 75FA                    	jnz	short IFEXISTS
 13191                                  	;jnz	short MOREDELIM
 13192                                  
 13193 00000C52 BA[399D]                	mov	dx,DIRBUF
 13194 00000C55 B8001A                  	mov	ax,1A00h
 13195                                  	;mov	ax,Set_DMA*256 ; 1A00h
 13196 00000C58 CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 13197                                  			; DS:DX	-> disk	transfer buffer
 13198 00000C5A BB0200                  	mov	bx,2	; if(0) [|not](|1) exist[1|2] file(2|3)
 13199 00000C5D 031E[9CA4]              	add	bx,[IF_NOT_COUNT]
 13200                                  	;mov	ax,ARG_ARGV
 13201                                  	;mov	ax,ARG+ARG_UNIT.argv
 13202 00000C61 B8[509F]                	mov	ax,ARG
 13203 00000C64 E82929                  	call	argv_calc		; convert arg index to pointer
 13204 00000C67 8B17                    	mov	dx,[bx]
 13205                                  	;mov	dx,[bx+ARGV_ELE.argpointer] ; mov dx,[bx+0]
 13206                                  	;mov	cx,6
 13207 00000C69 B90600                  	mov	cx,IFEXIST_ATTR ; filetypes to search for
 13208 00000C6C B8004E                  	mov	ax,4E00h
 13209                                  	;mov	ax,Find_First*256 ; 4E00h ; request first match, if any
 13210 00000C6F CD21                    	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 13211                                  			; CX = search attributes
 13212                                  			; DS:DX	-> ASCIZ filespec
 13213                                  			; (drive,path, and wildcards allowed)
 13214 00000C71 7204                    	jc	short IF_EX_C ; carry is how to determine error
 13215 00000C73 30C0                    	xor	al,al
 13216 00000C75 EB02                    	jmp	short IFRET
 13217                                  
 13218                                  	;nop
 13219                                  IF_EX_C:
 13220 00000C77 B0FF                    	mov	al,-1	; 0FFh	; false 'n' fall through...
 13221                                  IFRET:
 13222 00000C79 F606[069C]FF            	test	byte [IFNOTFLAG],-1 ; 0FFh
 13223 00000C7E 7402                    	jz	short REALTEST
 13224 00000C80 F6D0                    	not	al
 13225                                  REALTEST:
 13226 00000C82 08C0                    	or	al,al
 13227 00000C84 7403                    	jz	short IFTRUE
 13228 00000C86 E97BF4                  	jmp	TCOMMAND
 13229                                  
 13230                                  IFTRUE:
 13231 00000C89 E8FA1C                  	call	scanoff
 13232 00000C8C 89F1                    	mov	cx,si
 13233 00000C8E 81E98100                	sub	cx,81h
 13234 00000C92 280E8000                	sub	[80h],cl
 13235 00000C96 8A0E8000                	mov	cl,[80h]
 13236 00000C9A 880E[559A]              	mov	[COMBUF+1],cl
 13237 00000C9E BF[569A]                	mov	di,COMBUF+2
 13238 00000CA1 FC                      	cld
 13239 00000CA2 F3A4                    	rep	movsb
 13240 00000CA4 B00D                    	mov	al,0Dh
 13241 00000CA6 AA                      	stosb
 13242                                  
 13243                                  ; Signal that an IF was done. 
 13244                                  ; This prevents the redirections from getting lost.
 13245                                  
 13246 00000CA7 1E                      	push	ds
 13247 00000CA8 8E1E[F59B]              	mov	ds,[RESSEG]
 13248 00000CAC C606[AA02]FF            	mov	byte [IfFlag],-1
 13249 00000CB1 1F                      	pop	ds
 13250                                  
 13251                                  ; Go do the command
 13252                                  
 13253                                  	;jmp	DOCOM1 ; MSDOS 5.0 COMMAND.COM
 13254                                  	; 07/06/2023
 13255                                  	; Retro DOS v4.2 COMMAND.COM
 13256 00000CB2 E940F6                  	jmp	DOCOM0 ; MSDOS 6.22 COMMAND.COM
 13257                                  
 13258                                  ; ---------------------------------------------------------------------------
 13259                                  
 13260                                  IFERRORJ3:
 13261 00000CB5 EB80                    	jmp	IFERRORJ2
 13262                                  
 13263                                  IFERLEV:
 13264                                  
 13265                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 13266                                  ; PCDOS 7.1 COMMAND.COM
 13267                                  ;%if 1
 13268                                  ;	cmp	byte [si],0F2h  ; CODE PAGE 437
 13269                                  ;	jne	short IFERLEV_@
 13270                                  ;	inc	si
 13271                                  ;IFERLEV_@:	
 13272                                  ;%endif
 13273 00000CB7 B70A                    	mov	bh,10
 13274 00000CB9 30DB                    	xor	bl,bl
 13275                                  GETNUMLP:
 13276 00000CBB AC                      	lodsb
 13277 00000CBC 3C0D                    	cmp	al,0Dh
 13278 00000CBE 74F5                    	je	short IFERRORJ3
 13279 00000CC0 E8CB1C                  	call	DELIM
 13280 00000CC3 740C                    	jz	short GOTNUM
 13281 00000CC5 2C30                    	sub	al,'0'
 13282 00000CC7 86D8                    	xchg	al,bl
 13283 00000CC9 F6E7                    	mul	bh
 13284 00000CCB 00D8                    	add	al,bl
 13285 00000CCD 86D8                    	xchg	al,bl
 13286 00000CCF EBEA                    	jmp	short GETNUMLP
 13287                                  GOTNUM:
 13288 00000CD1 1E                      	push	ds
 13289 00000CD2 8E1E[F59B]              	mov	ds,[RESSEG]
 13290 00000CD6 8A26[9A02]              	mov	ah,[RetCode]
 13291 00000CDA 1F                      	pop	ds
 13292 00000CDB 30C0                    	xor	al,al
 13293 00000CDD 38DC                    	cmp	ah,bl
 13294 00000CDF 7398                    	jnb	short IFRET
 13295 00000CE1 FEC8                    	dec	al
 13296 00000CE3 EB94                    	jmp	short IFRET
 13297                                  
 13298                                  ; ---------------------------------------------------------------------------
 13299                                  
 13300                                  ; Shift the parameters in the batch structure by 1 and set up the new argument.
 13301                                  ; This is a NOP if no batch in progress.
 13302                                  
 13303                                  _SHIFT:
 13304 00000CE5 8E1E[F59B]              	mov	ds,[RESSEG]
 13305 00000CE9 A1[4902]                	mov	ax,[Batch]		; get batch pointer
 13306 00000CEC 09C0                    	or	ax,ax			; in batch mode?
 13307 00000CEE 7501                    	jnz	short SHIFT1		; yes, operate in batch segment	
 13308                                  SHIFT_RETN:				; no, done.
 13309 00000CF0 C3                      	retn
 13310                                  SHIFT1:
 13311 00000CF1 8EC0                    	mov	es,ax
 13312 00000CF3 8ED8                    	mov	ds,ax
 13313                                  
 13314                                  ; Now move the batch args down by 1 word
 13315                                  
 13316                                  	;;mov	di,0Bh ; MSDOS 3.3 COMMAND.COM
 13317                                  	;mov	di,0Ch ; MSDOS 5.0 COMMAND.COM
 13318 00000CF5 BF0C00                  	mov	di,BATCHSEGMENT.BatParm ; point to parm table
 13319 00000CF8 8D7502                  	lea	si,[di+2]		; make source = dest + 2
 13320 00000CFB B90900                  	mov	cx,9			; move 9 parameters
 13321 00000CFE F3A5                    	rep	movsw			; SHIFT down
 13322                                  
 13323                                  ; If the last parameter (the one not moved) is empty (= -1) then we are done.
 13324                                  ; We have copied it into the previous position.
 13325                                  
 13326 00000D00 833DFF                  	cmp	word [di],-1	; if last one was not in use then
 13327 00000D03 74EB                    	je	short SHIFT_RETN ; No new parm
 13328                                  
 13329                                  ; This last pointer is NOT nul. Get it and scan to find the next argument.
 13330                                  ; Assume, first, that there is no next argument.
 13331                                   
 13332 00000D05 8B35                    	mov	si,[di]
 13333 00000D07 C705FFFF                	mov	word [di],-1		; Assume no parm
 13334                                  
 13335                                  ; The parameters are CR separated. Scan for end of this parm.
 13336                                  
 13337                                  SKIPCRLP:
 13338 00000D0B AC                      	lodsb
 13339 00000D0C 3C0D                    	cmp	al,0Dh
 13340 00000D0E 75FB                    	jne	short SKIPCRLP
 13341                                  
 13342                                  ; We are now pointing at next arg. If it is 0 (end of original line) then we
 13343                                  ; are finished. There are no more parms and the pointer has been previously
 13344                                  ; initialized to indicate it.
 13345                                  
 13346 00000D10 803C00                  	cmp	byte [si],0
 13347 00000D13 74DB                    	jz	short SHIFT_RETN 	; End of parms
 13348 00000D15 8935                    	mov	[di],si			; Pointer to next parm as %9
 13349 00000D17 C3                      	retn
 13350                                  
 13351                                  ; =============== S U B	R O U T	I N E =======================================
 13352                                  
 13353                                  ; Skip delim reads bytes from the batch file until a non-delimiter is seen.
 13354                                  ; returns char in AL, carry set -> eof
 13355                                  
 13356                                  SKIPDELIM:
 13357 00000D18 F706[4902]FFFF          	test	word [Batch],-1		; batch file empty. OOPS!
 13358 00000D1E 740A                    	jz	short SKIPERR
 13359 00000D20 E85CFD                  	call	GETBATBYT		; get a char
 13360 00000D23 E8681C                  	call	DELIM			; check for ignoreable chars
 13361 00000D26 74F0                    	jz	short SKIPDELIM		; ignore this char.
 13362 00000D28 F8                      	clc
 13363 00000D29 C3                      	retn
 13364                                  SKIPERR:
 13365 00000D2A F9                      	stc
 13366                                  GOTO_RETN:
 13367 00000D2B C3                      	retn
 13368                                  
 13369                                  ; ---------------------------------------------------------------------------
 13370                                  
 13371                                  ;  CALL is an internal command that transfers control to a .bat, .exe, or
 13372                                  ;  .com file. This routine strips the CALL off the command line, sets
 13373                                  ;  the CALL_FLAG to indicate a call in progress, and returns control to
 13374                                  ;  DOCOM1 in TCODE to reprocess the command line and execute the file
 13375                                  ;  being CALLed.
 13376                                  
 13377                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13378                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0C27h
 13379                                  
 13380                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 13381                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0D01h
 13382                                  
 13383                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 13384                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0D4Ch
 13385                                  _$CALL:
 13386                                  
 13387                                  ;  strip off CALL from command line
 13388                                  
 13389                                  	;ASSUME DS:trangroup,ES:trangroup
 13390                                  
 13391 00000D2C 56                      	push	si
 13392 00000D2D 57                      	push	di
 13393 00000D2E 50                      	push	ax
 13394 00000D2F 51                      	push	cx
 13395 00000D30 BE[569A]                	mov	si,COMBUF+2
 13396 00000D33 E8501C                  	call	scanoff			;get to first non-delimeter
 13397                                  	;add	si,4
 13398 00000D36 83C604                  	add	si,length_call		;point to char past CALL
 13399 00000D39 BF[569A]                	mov	di,COMBUF+2
 13400                                  	;mov	cx,124		
 13401 00000D3C B97C00                  	mov	cx,COMBUFLEN-length_call 
 13402                                  					;get length of buffer
 13403 00000D3F F3A4                    	rep	movsb			;move it
 13404 00000D41 59                      	pop	cx
 13405 00000D42 58                      	pop	ax
 13406 00000D43 5F                      	pop	di
 13407 00000D44 5E                      	pop	si
 13408                                  
 13409                                  ;  set call flag to indicate call in progress
 13410                                  
 13411 00000D45 1E                      	push	ds
 13412 00000D46 8E1E[F59B]              	mov	ds,[RESSEG]
 13413 00000D4A C606[B002]01            	mov	byte [Call_Flag],call_in_progress ; 1
 13414 00000D4F C606[B102]01            	mov	byte [Call_Batch_Flag],call_in_progress ; 1
 13415                                  
 13416                                  ; Turn off any pipes in progress.
 13417                                  
 13418 00000D54 803E[1403]00            	cmp	byte [PipeFiles],0 	; Only turn off if present.
 13419 00000D59 7403                    	jz	short _NOPIPE
 13420 00000D5B E8C223                  	call	PIPEDEL
 13421                                  _NOPIPE:
 13422 00000D5E 1F                      	pop	ds
 13423 00000D5F C3                      	retn
 13424                                  
 13425                                  ; ---------------------------------------------------------------------------
 13426                                  
 13427                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13428                                  _GOTO:
 13429 00000D60 8E1E[F59B]              	mov	ds,[RESSEG]
 13430 00000D64 F706[4902]FFFF          	test	word [Batch],-1	; If not in batch mode, a nop
 13431 00000D6A 74BF                    	jz	short GOTO_RETN
 13432 00000D6C 31D2                    	xor	dx,dx
 13433 00000D6E 1E                      	push	ds
 13434 00000D6F 8E1E[4902]              	mov	ds,[Batch]
 13435                                  	;mov	[8],dx	; MSDOS 5.0 COMMAND.COM
 13436 00000D73 89160800                	mov	[BATCHSEGMENT.BatSeek],dx ; Back to start
 13437                                  	;mov	[10],dx	; MSDOS 5.0 COMMAND.COM
 13438 00000D77 89160A00                	mov	[BATCHSEGMENT.BatSeek+2],dx ; Back to start
 13439                                  
 13440                                  	; MSDOS 6.0
 13441                                  ;M037
 13442                                  ; Clear EOF indicator because we have reseeked to the beginning of the file.
 13443                                  ;
 13444 00000D7B C606020000              	mov	byte [BATCHSEGMENT.BatchEOF],0
 13445                                  					; clear eof indicator ;M037
 13446                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13447 00000D80 1F                      	pop	ds
 13448                                  GOTOOPEN:
 13449 00000D81 E86BF8                  	call	PROMPTBAT
 13450                                  	;mov	di,5Dh
 13451 00000D84 BF5D00                  	mov	di,FCB+1		; Get the label
 13452 00000D87 B90B00                  	mov	cx,11
 13453 00000D8A B020                    	mov	al,' '
 13454 00000D8C F2AE                    	repne	scasb
 13455 00000D8E 7501                    	jnz	short NOINC
 13456 00000D90 41                      	inc	cx
 13457                                  NOINC:
 13458 00000D91 83E90B                  	sub	cx,11
 13459 00000D94 F7D9                    	neg	cx
 13460                                  	;mov	[cs:GOTOLEN],cx
 13461                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13462 00000D96 26890E[399D]            	mov	[es:GOTOLEN],cx	; MSDOS 5.0 (& 6.0)
 13463                                  
 13464                                  ; At beginning of file. Skip to first non-delimiter char
 13465                                  
 13466 00000D9B E87AFF                  	call	SKIPDELIM
 13467 00000D9E 721C                    	jb	short BADGOTO
 13468 00000DA0 3C3A                    	cmp	al,':'
 13469 00000DA2 7426                    	jz	short CHKLABEL
 13470                                  LABLKLP:				; Look for the label
 13471 00000DA4 E8D8FC                  	call	GETBATBYT
 13472 00000DA7 3C0A                    	cmp	al,0Ah
 13473 00000DA9 7509                    	jne	short LABLKTST
 13474                                  
 13475                                  ; At beginning of line. Skip to first non-delimiter char
 13476                                  
 13477 00000DAB E86AFF                  	call	SKIPDELIM
 13478 00000DAE 720C                    	jb	short BADGOTO
 13479 00000DB0 3C3A                    	cmp	al,':'
 13480 00000DB2 7416                    	je	short CHKLABEL
 13481                                  LABLKTST:
 13482 00000DB4 F706[4902]FFFF          	test	word [Batch],0FFFFh ; -1
 13483 00000DBA 75E8                    	jnz	short LABLKLP
 13484                                  BADGOTO:
 13485 00000DBC E87100                  	call	BATCLOSE
 13486                                  
 13487                                  	; MSDOS 6.0
 13488                                  ;SR;
 13489                                  ; At this point we are terminating without freeing up any nested batch 
 13490                                  ;segments i.e if the error occurred within a called batch file. This routine
 13491                                  ;will traverse the linked list of batch segments and free all of them.
 13492                                  ;
 13493 00000DBF E8BD00                  	call	free_batch		; free up nested batch segments
 13494                                  
 13495                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13496 00000DC2 0E                      	push	cs
 13497 00000DC3 1F                      	pop	ds
 13498 00000DC4 BA[A790]                	mov	dx,BADLAB_PTR
 13499 00000DC7 E95C1F                  	jmp	cerror
 13500                                  
 13501                                  ; Found the :.	Skip to first non-delimiter char
 13502                                  
 13503                                  CHKLABEL:
 13504 00000DCA E84BFF                  	call	SKIPDELIM
 13505 00000DCD 72ED                    	jb	short BADGOTO
 13506 00000DCF BF5D00                  	mov	di,FCB+1 ; 5Dh
 13507                                  	;mov	cx,[cs:GOTOLEN]
 13508                                  	; 14/02/2023
 13509 00000DD2 268B0E[399D]            	mov	cx,[es:GOTOLEN]	 ; MSDOS 5.0 (& 6.0) COMMAND.COM
 13510 00000DD7 EB05                    	jmp	short GOTBYTE
 13511                                  
 13512                                  NEXTCHRLP:
 13513 00000DD9 51                      	push	cx
 13514 00000DDA E8A2FC                  	call	GETBATBYT
 13515 00000DDD 59                      	pop	cx
 13516                                  GOTBYTE:
 13517                                  	; 18/03/2023
 13518                                  	; 14/02/2023
 13519                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0CD9h
 13520 00000DDE E88019                  	call	testkanj
 13521 00000DE1 7413                    	jz	short NOTKANJ1
 13522 00000DE3 263A05                  	cmp	al,[es:di]
 13523 00000DE6 75CC                    	jne	short LABLKTST
 13524 00000DE8 47                      	inc	di
 13525 00000DE9 49                      	dec	cx
 13526 00000DEA E3C8                    	jcxz	LABLKTST
 13527 00000DEC 51                      	push	cx
 13528 00000DED E88FFC                  	call	GETBATBYT
 13529 00000DF0 59                      	pop	cx
 13530 00000DF1 263A05                  	cmp	al,[es:di]
 13531 00000DF4 EB0C                    	jmp	short KNEXTLABCHR
 13532                                  NOTKANJ1:
 13533                                  	; 14/02/2023
 13534                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0CF1h
 13535 00000DF6 0C20                    	or	al,20h
 13536 00000DF8 263A05                  	cmp	al,[es:di]
 13537                                  	;jne	short TRYUPPER
 13538                                  	;jmp	short NEXTLABCHR
 13539                                  	; 25/04/2023
 13540 00000DFB 7407                    	je	short NEXTLABCHR 
 13541                                  TRYUPPER:
 13542 00000DFD 2C20                    	sub	al,20h
 13543 00000DFF 263A05                  	cmp	al,[es:di]
 13544                                  KNEXTLABCHR:
 13545 00000E02 75B0                    	jnz	short LABLKTST
 13546                                  NEXTLABCHR:
 13547 00000E04 47                      	inc	di
 13548 00000E05 E2D2                    	loop	NEXTCHRLP
 13549 00000E07 E875FC                  	call	GETBATBYT
 13550                                  	; 14/02/2023
 13551 00000E0A 26833E[399D]08          	cmp	word [es:GOTOLEN],8 ;  MSDOS 5.0 (& 6.0) COMMAND.COM
 13552                                  	;cmp	word [cs:GOTOLEN],8 ; Is the label at least 8 chars long?
 13553 00000E10 7D04                    	jge	short GOTOCONT	; Yes, then the next char doesn't matter
 13554 00000E12 3C20                    	cmp	al,' '
 13555 00000E14 779E                    	ja	short LABLKTST
 13556                                  GOTOCONT:
 13557 00000E16 3C0D                    	cmp	al,0Dh
 13558 00000E18 7407                    	je	short SKIPLFEED
 13559                                  TONEXTBATLIN:
 13560 00000E1A E862FC                  	call	GETBATBYT
 13561 00000E1D 3C0D                    	cmp	al,0Dh
 13562 00000E1F 75F9                    	jne	short TONEXTBATLIN
 13563                                  SKIPLFEED:
 13564 00000E21 E85BFC                  	call	GETBATBYT
 13565                                  
 13566                                  	; MSDOS 6.0
 13567                                  ;SR;
 13568                                  ; The BatchEOF flag is set in GetBatByt to indicate that we are faking a 
 13569                                  ;CR-LF for the last line. On a goto, this flag has to be cleared, because
 13570                                  ;BatchEOF == 1 now, after returning a CR-LF. The next call to GetBatByt
 13571                                  ;to get the EOF has not been made yet because we encountered the Goto. On
 13572                                  ;all other cases, EOF will be hit while trying to read the next line and
 13573                                  ;we are fine. I know, I know, what a massive hack from hell!! God help us!!
 13574                                  ;
 13575 00000E24 06                      	push	es
 13576 00000E25 8E06[4902]              	mov	es,[Batch]
 13577 00000E29 26C606020000            	mov	byte [es:BATCHSEGMENT.BatchEOF],0
 13578                                  					;invalidate fake CR-LF flag
 13579 00000E2F 07                      	pop	es
 13580                                  
 13581                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13582                                  	;call	BATCLOSE
 13583                                  	;retn
 13584                                  	; 14/02/2023
 13585                                  	;jmp	short BATCLOSE
 13586                                  
 13587                                  ; =============== S U B	R O U T	I N E =======================================
 13588                                  
 13589                                  	; 27/07/2024
 13590                                  BATCLOSE:
 13591 00000E30 2E8B1E[F49E]            	mov	bx,[cs:BATHAND]
 13592 00000E35 83FB05                  	cmp	bx,5
 13593 00000E38 7205                    	jb	short CLOSERETURN
 13594                                  	; 14/02/2023
 13595 00000E3A B43E                    	mov	ah,3Eh
 13596                                  	;mov	ah,CLOSE ; 3Eh
 13597                                  
 13598                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13599                                  %if 0
 13600                                  	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 13601                                  			; BX = file handle
 13602                                  %else
 13603 00000E3C E87BF7                  	call	int_21h_indirect
 13604                                  %endif
 13605                                  
 13606                                  CLOSERETURN:
 13607 00000E3F C606[9202]00            	mov	byte [In_Batch],0 ; reset flag	
 13608 00000E44 C3                      	retn
 13609                                  
 13610                                  ; =============== S U B	R O U T	I N E =======================================
 13611                                  
 13612                                  ; Open the BATCH file, If open fails, AL is drive of batch file (A=1)
 13613                                  ; Also, fills internal batch buffer. If access denied, then AX = -1
 13614                                  	
 13615                                  	; 27/07/2024
 13616                                  	; 14/02/2023
 13617                                  BATOPEN:
 13618 00000E45 1E                      	push	ds
 13619 00000E46 8E1E[4902]              	mov	ds,[Batch]
 13620                                  	;;mov	dx,1Fh	; MSDOS 3.3 COMMAND.COM
 13621                                  	;mov	dx,20h	; MSDOS 5.0 COMMAND.COM
 13622 00000E4A BA2000                  	mov	dx,BATCHSEGMENT.BatFile
 13623                                  
 13624                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13625                                  %if 0
 13626                                  	mov	ax,3D00h
 13627                                  	;mov	ax,(OPEN<<8) ; 3D00h ; Open the batch file
 13628                                  
 13629                                  	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 13630                                  			; DS:DX	-> ASCIZ filename
 13631                                  			; AL = access mode
 13632                                  			; 0 - read
 13633                                  %else
 13634 00000E4D B8203D                  	mov	ax,3D20h
 13635                                  	;mov	ax,(OPEN<<8)|20h ; 3D20h ; Open the batch file
 13636                                  				 ; 00-100-000b (00-DENYNONE-READONLY)
 13637 00000E50 E867F7                  	call	int_21h_indirect
 13638                                  %endif
 13639                                  
 13640 00000E53 721C                    	jc	short SETERRDL
 13641                                  	;mov	dx,[8]
 13642 00000E55 8B160800                	mov	dx,[BATCHSEGMENT.BatSeek]
 13643                                  	;mov	cx,[10]
 13644 00000E59 8B0E0A00                	mov	cx,[BATCHSEGMENT.BatSeek+2]
 13645 00000E5D 1F                      	pop	ds
 13646                                  	;mov	[cs:BATHAND],ax
 13647 00000E5E 26A3[F49E]              	mov	[es:BATHAND],ax ; MSDOS 5.0 (& 6.0) COMMAND.COM
 13648 00000E62 89C3                    	mov	bx,ax
 13649 00000E64 B80042                  	mov	ax,4200h
 13650                                  	;mov	ax,(LSEEK<<8) ; 4200h ; Go to the right spot
 13651 00000E67 CD21                    	int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 13652                                  			; AL = method: offset from beginning of	file
 13653                                  
 13654                                  	;mov	word [cs:BATBUFPOS],-1 ; 0FFFFh
 13655                                  					; nuke batch buffer position
 13656 00000E69 26C706[C7A5]FFFF        	mov	word [es:BATBUFPOS],-1 ; MSDOS 5.0 (& 6.0) COMMAND.COM
 13657                                  BATOPEN_RETN:
 13658 00000E70 C3                      	retn
 13659                                  
 13660                                  SETERRDL:
 13661 00000E71 89D3                    	mov	bx,dx
 13662                                  	; MSDOS 6.0
 13663                                  	;invoke	get_ext_error_number 	;AN022; get the extended error
 13664                                  	; 14/02/2023
 13665 00000E73 E8D511                  	call	get_ext_error_number
 13666 00000E76 89C2                    	mov	dx,ax		     	;AN022; save extended error in DX
 13667                                  
 13668                                  	; MSDOS 3.3
 13669                                  	;mov	dx,INSERTDSKPTR
 13670                                  	;call	GET_EXT_ERR_NUMBER
 13671                                  
 13672                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13673 00000E78 8A07                    	mov	al,[bx]			; Get drive spec
 13674 00000E7A 2C40                    	sub	al,'@'	; sub al,40h	; A = 1, B = 2 ..
 13675 00000E7C 1F                      	pop	ds
 13676 00000E7D F9                      	stc				; SUB mucked over carry
 13677 00000E7E C3                      	retn
 13678                                  
 13679                                  ; =============== S U B	R O U T	I N E =======================================
 13680                                  
 13681                                  ;Free_batch : This routine traverses the linked batch segments freeing all
 13682                                  ;the batch and FOR segments until all of them are freed. It also restores
 13683                                  ;the old state of the EchoFlag.
 13684                                  ;
 13685                                  ;	ENTRY:	ds = RESGROUP
 13686                                  ;
 13687                                  ;	EXIT: 	All batch & FOR segments freed.
 13688                                  ;		EchoFlag restored to old state before batch process.
 13689                                  ;
 13690                                  ;	REGISTERS AFFECTED: bx, cx
 13691                                  
 13692                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13693                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0D7Eh
 13694                                  
 13695                                  free_batch: ;proc near
 13696                                  	;assume	ds:RESGROUP,es:nothing
 13697                                  
 13698 00000E7F 06                      	push	es
 13699 00000E80 8B1E[B202]              	mov	bx,[Next_Batch]
 13700 00000E84 09DB                    	or	bx,bx
 13701 00000E86 7433                    	jz	short fb_ret
 13702                                  _ClearBatch:
 13703 00000E88 8EC3                    	mov	es,bx			; get batch segment
 13704                                  	;mov	bx,es:BatForPtr		; get old FOR segment
 13705 00000E8A 268B1E0500              	mov	bx,[es:BATCHSEGMENT.BatForPtr] ; [es:5]
 13706                                  	;cmp	bx,0			; is a FOR in progress
 13707                                  	; 27/07/2024
 13708 00000E8F 21DB                    	and	bx,bx
 13709 00000E91 7409                    	jz	short no_bat_for	; no - don't deallocate
 13710 00000E93 06                      	push	es			;
 13711 00000E94 8EC3                    	mov	es,bx			; yes - free it up...
 13712 00000E96 B449                    	mov	ah,49h
 13713                                  	;mov	ah,DEALLOC		;
 13714                                  
 13715                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13716                                  %if 0
 13717                                  	int	21h			;
 13718                                  %else
 13719 00000E98 E81FF7                  	call	int_21h_indirect
 13720                                  %endif
 13721 00000E9B 07                      	pop	es			; restore to batch segment
 13722                                  no_bat_for:
 13723                                  	;mov	cl,[es:1]
 13724 00000E9C 268A0E0100              	mov	cl,[es:BATCHSEGMENT.BatEchoFlag]
 13725                                  					; get old echo flag
 13726                                  	;mov	bx,[es:3]
 13727 00000EA1 268B1E0300              	mov	bx,[es:BATCHSEGMENT.BatLast]
 13728                                  					; get old batch segment
 13729 00000EA6 B449                    	mov	ah,49h
 13730                                  	;mov	ah,DEALLOC		; free it up...
 13731                                  
 13732                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13733                                  %if 0
 13734                                  	int	21h			;
 13735                                  %else
 13736 00000EA8 E80FF7                  	call	int_21h_indirect
 13737                                  %endif
 13738                                  	; 14/02/2023
 13739                                  	;mov	[Batch],bx		; get ready to deallocate next batch
 13740 00000EAB FF0E[AE02]              	dec	word [Nest]		; is there another batch file?
 13741 00000EAF 75D7                    	jnz	short _ClearBatch	; keep going until no batch file
 13742                                  	
 13743 00000EB1 880E[9D02]              	mov	[EchoFlag],cl		;restore echo status
 13744 00000EB5 C706[4902]0000          	mov	word [Batch],0		;no batch process in progress
 13745                                  fb_ret:
 13746 00000EBB 07                      	pop	es
 13747 00000EBC C3                      	ret
 13748                                  
 13749                                  ;free_batch endp
 13750                                  
 13751                                  ;============================================================================
 13752                                  ; TFOR.ASM, MSDOS 6.0, 1991
 13753                                  ;============================================================================
 13754                                  ; 10/10/2018 - Retro DOS v3.0
 13755                                  
 13756                                  ; All batch proccessing has DS set to segment of resident portion
 13757                                  
 13758                                  ;ASSUME DS:RESGROUP,ES:TRANGROUP
 13759                                  
 13760                                  ; MSDOS 3.3 COMMAND.COM, transient portion/segment offset 0BE9h
 13761                                  
 13762                                  ; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13763                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:0DBFh
 13764                                  
 13765                                  ; ---------------------------------------------------------------------------
 13766                                  
 13767                                  	; 15/02/2023
 13768                                  FORTERM:
 13769                                  	; MSDOS 6.0
 13770 00000EBD 0E                      	push	cs			;AN037; Get local segment into
 13771 00000EBE 1F                      	pop	ds			;AN037;  DS, ES
 13772 00000EBF 0E                      	push	cs			;AN037;
 13773 00000EC0 07                      	pop	es			;AN037;
 13774                                  
 13775                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13776 00000EC1 E89502                  	call	FOROFF
 13777                                  	;mov	ds,[cs:RESSEG]
 13778 00000EC4 268E1E[F59B]            	mov	ds,[es:RESSEG] ; 15/02/2023 - MSDOS 5.0
 13779 00000EC9 813E[A502]00FF          	cmp	word [SingleCom],0FF00h
 13780 00000ECF 750F                    	jne	short BAT_CRLF
 13781 00000ED1 833E[AE02]00            	cmp	word [Nest],0		;See if we have nested batch files
 13782 00000ED6 7508                    	jne	short BAT_CRLF		;Yes - don't exit just yet
 13783 00000ED8 C706[A502]FFFF          	mov	word [SingleCom],-1 ; 0FFFFh ; Cause a terminate
 13784 00000EDE EB12                    	jmp	short NOFORP2
 13785                                  BAT_CRLF:
 13786 00000EE0 F606[9D02]01            	test	byte [EchoFlag],1 	; Is echo on?
 13787 00000EE5 740B                    	jz	short NOFORP2		; no - exit
 13788 00000EE7 F706[4902]FFFF          	test	word [Batch],-1 ; 0FFFFh
 13789                                  					; print CRLF if in batch
 13790 00000EED 7403                    	jz	short NOFORP2
 13791 00000EEF E8871A                  	call	CRLF2
 13792                                  NOFORP2:
 13793 00000EF2 E90FF2                  	jmp	TCOMMAND
 13794                                  
 13795                                  ; ---------------------------------------------------------------------------
 13796                                  
 13797                                  ;------
 13798                                  ;   For-loop processing. For loops are of the form:
 13799                                  ;	    for %<loop-variable> in (<list>) do <command>
 13800                                  ; where <command> may contain references of the form %<variable>, which are
 13801                                  ; later substituted with the items in <list>. The for-loop structure is
 13802                                  ; set-up by the procedure '$for'; successive calls to 'forproc' execute
 13803                                  ; <command> once for each item in <list>. All of the information needed for
 13804                                  ; loop processing is stored on a piece of memory gotten from 'alloc'. This
 13805                                  ; structure is actually fairly large, on the order of 700 bytes, and includes
 13806                                  ; a complete copy of the original command-line structure as parsed by
 13807                                  ; 'parseline', loop control variables, and a dma buffer for the
 13808                                  ; 'FindFirst/FindNext' expansion of wildcard filenames in <list>. When loop
 13809                                  ; processing has completed, this chunk of memory is returned to the system.
 13810                                  ;
 13811                                  ;   All of the previously defined variables, in 'datares', used for loop
 13812                                  ; processing may be erased. Only one, (DW) ForPtr, need be allocated.
 13813                                  ;
 13814                                  ;   The error message, 'for_alloc_mes', should be moved into the file
 13815                                  ; containing all of the other error messages.
 13816                                  ;
 13817                                  ;   Referencing the allocated for-loop structure is a little tricky.
 13818                                  ; At the moment, a byte is defined as part of a new segment, 'for_segment'.
 13819                                  ; When 'forproc' actually runs, ES and DS are set to point to the base of the
 13820                                  ; new chunk of memory.	References to this byte, 'f', thus assemble correctly
 13821                                  ; as offsets of ES or DS. 'f' would not be necessary, except that the
 13822                                  ; assembler translates an instruction such as 'mov AX, [for_minarg]' as an
 13823                                  ; immediate move of the offset of 'for_minarg' into AX. In other words, in
 13824                                  ; terms of PDP-11 mnemonics, the assembler ACTUALLY assembles
 13825                                  ;	mov  AX, #for_minarg 	; AX := 02CA (for example)
 13826                                  ; instead of
 13827                                  ;	mov  AX, for_minarg	; AX := [02CA] (contents of 02CA)
 13828                                  ; By using 'f', we pretend that we are actually referencing an allocated
 13829                                  ; structure, and the assembler coughs up the code we want. Notice that it
 13830                                  ; doesn't matter whether we put brackets around the location or not -- the
 13831                                  ; assembler is "smart" enough to know that we want an address instead of the
 13832                                  ; contents of that location.
 13833                                  ;
 13834                                  ;   Finally, there now exists the potential to easily implement nested loops.
 13835                                  ; One method would be to have a link field in each for-structure pointing to
 13836                                  ; its parent.  Variable references that couldn't be resolved in the local
 13837                                  ; frame would cause a search of prior frames. For-structures would still be
 13838                                  ; allocated and released in exactly the same fashion. The only limit on the
 13839                                  ; number of nested loops would be memory size (although at 700 bytes a pop,
 13840                                  ; memory wouldn't last THAT long). Alternately, a small structure could be
 13841                                  ; maintained in the resident data area. This structure would be an array of
 13842                                  ; control-variable names and pointers to for-structure blocks. This would
 13843                                  ; greatly speed up the resolution of non-local variable references. However,
 13844                                  ; since space in the resident is precious, we would have to compromise on a
 13845                                  ; "reasonable" level of nesting -- 10, 16, 32 levels, whatever. For-structure
 13846                                  ; allocation and de-allocation would have to be modified slightly to take this
 13847                                  ; new structure into account.
 13848                                  ;
 13849                                  ;   Oops, just one more thing. Forbuf need not be a part of the for-structure.
 13850                                  ; It could just as well be one structure allocated in 'transpace'. Actually,
 13851                                  ; it may be easier to allocate it as part of 'for_segment'.
 13852                                  ;------
 13853                                  		; include fordata.asm
 13854                                  
 13855                                  ; Data structure definitions included by tfor.asm
 13856                                  
 13857                                  struc FOR_INFO
 13858 00000000 <res 444h>                .FOR_ARGS:	  resb  ARG_UNIT.SIZE	; argv[] structure 
 13859 00000444 ??                        .FOR_COM_START: resb  1		; beginning of <command>
 13860 00000445 ????                      .FOR_EXPAND:	  resw  1		; * or ? item in <list>?
 13861 00000447 ????                      .FOR_MINARG:	  resw  1		; beginning of <list>
 13862 00000449 ????                      .FOR_MAXARG:	  resw  1		; end of <list>
 13863 0000044B <res 80h>                 .FORBUF:	  resw  64		; temporary buffer
 13864 000004CB <res 80h>                 .FORDMA:	  resw  64		; FindFirst/Next buffer
 13865 0000054B ??                        .FOR_VAR:	  resb  1		; loop control variable
 13866                                    .size:
 13867                                  endstruc
 13868                                  					; ARG_UNIT.SIZE = 1348 (544h)
 13869                                  					; ARG_UNIT.SIZE = 1092 ; 27/07/2024
 13870                                  _$FOR_EXIT:
 13871 00000EF5 EBC6                    	jmp	short FORTERM		; exceeding maxarg means all done
 13872                                  
 13873                                  ; ---------------------------------------------------------------------------
 13874                                  
 13875                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13876                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 13877                                  FORPROC:
 13878 00000EF7 A1[AC02]                	mov	ax,[ForPtr]
 13879 00000EFA 8ED8                    	mov	ds,ax
 13880 00000EFC 8EC0                    	mov	es,ax			; operate in for-info area
 13881                                  	;;mov	dx,5CBh	; MSDOS 5.0 & 6.22
 13882                                  	;mov	dx,4CBh ; PCDOS 7.1 ; 27/07/2024
 13883 00000EFE BACB04                  	mov	dx,FOR_INFO.FORDMA	; 1348+1+2+2+2+128 = 1483 = 5CBh
 13884                                  		; PCDOS 7.1 COMMAND.COM ; 1092+1+2+2+2+128 = 1227 = 4CBh
 13885 00000F01 B8001A                  	mov	ax,1A00h
 13886                                  	;mov	ax,Set_DMA*256 ; 1A00h
 13887 00000F04 CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 13888                                  			; DS:DX	-> disk	transfer buffer
 13889                                  FOR_BEGIN:
 13890                                  	;;cmp	word [545h],0
 13891                                  	;cmp	word [445h] ; 27/07/2024
 13892 00000F06 833E450400              	cmp	word [FOR_INFO.FOR_EXPAND],0
 13893 00000F0B 7404                    	jz	short FOR_BEGIN1
 13894                                  					; non-zero for_expand equals FALSE
 13895                                  	;;inc	word [547h]
 13896                                  	;inc	word [447h] ; 27/07/2024
 13897 00000F0D FF064704                	inc	word [FOR_INFO.FOR_MINARG]
 13898                                  FOR_BEGIN1:
 13899                                  	;mov	bx,[447h] ; 27/07/2024
 13900 00000F11 8B1E4704                	mov	bx,[FOR_INFO.FOR_MINARG] ; current item in <list> to examine
 13901                                  	;cmp	bx,[449h] ; 27/07/2024
 13902 00000F15 3B1E4904                	cmp	bx,[FOR_INFO.FOR_MAXARG]
 13903 00000F19 7FDA                     	jg	short _$FOR_EXIT	; exceeding maxarg means all done
 13904                                  	;mov	ax,0
 13905 00000F1B B80000                  	mov	ax,FOR_INFO.FOR_ARGS ; 0
 13906 00000F1E E86F26                  	call	argv_calc		; compute argv[x] address
 13907                                  	;mov	cx,[bx+3]
 13908 00000F21 8B4F03                  	mov	cx,[bx+ARGV_ELE.argstartel]
 13909 00000F24 8B17                    	mov	dx,[bx]
 13910                                  	;mov	dx,[bx+ARGV_ELE.argpointer] ; mov dx,[bx+0]
 13911                                  	;test	byte [bx+2],4		; Is there a path separator in this arg?
 13912 00000F26 F6470204                	test	byte [bx+ARGV_ELE.argflags],4 ; path_sep
 13913 00000F2A 7512                    	jnz	short FORSUB		; Yes, argstartel should be correct
 13914 00000F2C 8B37                    	mov	si,[bx]
 13915                                  	;mov	si,[bx+ARGV_ELE.argpointer]
 13916                                  
 13917                                  	;mov	al,[cs:LPAREN]
 13918                                  	; 15/02/2023
 13919                                  	; MSDOS 6.0 (& 5.0) COMMAND.com
 13920                                  	;mov	al,'('	; mov al,lparen
 13921                                  	;cmp	[si-1],	al		; If the current token is the first
 13922                                  	; 27/07/2024
 13923 00000F2E 807CFF28                	cmp	byte [si-1],'('
 13924 00000F32 750A                    	jne	short FORSUB		;  one in the list and originally had
 13925 00000F34 41                      	inc	cx			;  the opening paren as its first char,
 13926                                  					;  the argstartel ptr needs to be
 13927                                  					;  advanced passed it before the prefix
 13928                                  					;  length is computed.
 13929                                  	;mov	al,':'
 13930                                  	;cmp	[si+1],	al		; If the token begins with "(d:",
 13931                                  	; 27/07/2024
 13932 00000F35 807C013A                	cmp	byte [si+1],':'
 13933 00000F39 7503                    	jne	short FORSUB		;  argstartel has to be moved over the
 13934 00000F3B 83C102                  	add	cx,2			;  rest of the prefix as well.
 13935                                  FORSUB:
 13936 00000F3E 29D1                    	sub	cx,dx			; compute length of pathname prefix
 13937                                  	;;cmp	word [545h],0
 13938                                  	;cmp	word [445h],0 ; 27/07/2024
 13939 00000F40 833E450400              	cmp	word [FOR_INFO.FOR_EXPAND],0
 13940                                  					; are we still expanding a name?
 13941 00000F45 7416                    	jz	short FOR_FIND_NEXT
 13942                                  					; if so, get next matching filename
 13943                                  	;test	byte [bx+2],2
 13944 00000F47 F6470202                	test	byte [bx+ARGV_ELE.argflags],2 ; wildcard
 13945 00000F4B 7505                    	jnz	short FOR_FIND_FIRST
 13946                                  					; should we expand THIS (new) arg?
 13947                                  	;mov	cx,[bx+5]
 13948                                  					; else, just copy all of it directly
 13949 00000F4D 8B4F05                  	mov	cx,[bx+ARGV_ELE.arglen]
 13950 00000F50 EB1D                    	jmp	short FOR_SMOOSH
 13951                                  
 13952                                  	;nop
 13953                                  	; 15/02/2023
 13954                                  FOR_FIND_FIRST:
 13955 00000F52 51                      	push	cx
 13956 00000F53 31C9                    	xor	cx,cx
 13957 00000F55 B8004E                  	mov	ax,4E00h
 13958                                  	;mov	ax,Find_First*256 ; 4E00h
 13959 00000F58 CD21                    	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 13960                                  			; CX = search attributes
 13961                                  			; DS:DX	-> ASCIZ filespec
 13962                                  			; (drive,path, and wildcards allowed)
 13963 00000F5A 59                      	pop	cx
 13964 00000F5B EB05                    	jmp	short FOR_RESULT
 13965                                  
 13966                                  	;nop
 13967                                  FOR_FIND_NEXT:
 13968 00000F5D B8004F                  	mov	ax,4F00h
 13969                                  	;mov	ax,Find_Next*256 ;4F00h
 13970 00000F60 CD21                    	int	21h	; DOS -	2+ - FIND NEXT ASCIZ (FINDNEXT)
 13971                                  			; [DTA]	= data block from
 13972                                  			; last AH = 4Eh/4Fh call
 13973                                  FOR_RESULT:
 13974 00000F62 B8FFFF                  	mov	ax,-1 ; 0FFFFh		; assume worst case
 13975 00000F65 7201                    	jc	short FOR_CHECK
 13976                                  	; 15/02/2023
 13977 00000F67 40                      	inc	ax ; ax = 0
 13978                                  	;mov	ax,0			; Find* returns 0 for SUCCESS
 13979                                  FOR_CHECK:				; record success of findfirst/next
 13980                                  	;;mov	[545h],ax
 13981                                  	;mov	[445h],ax ; 27/07/2024
 13982 00000F68 A34504                  	mov	[FOR_INFO.FOR_EXPAND],ax
 13983 00000F6B 09C0                    	or	ax,ax			; anything out there?
 13984 00000F6D 7597                    	jnz	short FOR_BEGIN		; if not, try next arg
 13985                                  FOR_SMOOSH:
 13986                                  	;mov	si,[bx+ARGV_ELE.argpointer] ; mov si,[bx+0]
 13987 00000F6F 8B37                    	mov	si,[bx] 		; copy argv[arg][0,CX] into destbuf
 13988                                  	;;mov	di,54Bh	; MSDOS 5.0 & 6.22 COMMAND.COM
 13989                                  	;mov	di,44Bh ; 27/07/2024 ; PCDOS 7.1 COMMAND.COM
 13990 00000F71 BF4B04                  	mov	di,FOR_INFO.FORBUF	; some days this will be the entire
 13991 00000F74 F3A4                    	rep	movsb			; arg, some days just the path prefix
 13992                                  					
 13993 00000F76 833E450400              	cmp	word [FOR_INFO.FOR_EXPAND],0
 13994                                  					; if we're not expanding, we can
 13995 00000F7B 7509                    	jnz	short FOR_MAKE_COM 	; skip the following
 13996                                  	; 15/02/2023
 13997                                  	;;mov	si,05E9h ; MSDOS 3.3 & 5.0 & 6.22 COMMAND.COM ; 27/07/2024
 13998                                  	; 27/07/2024
 13999                                  	;mov	si,04E9h ; PCDOS 7.1 COMMAND.COM
 14000 00000F7D BEE904                  	mov	si,FOR_INFO.FORDMA+FIND_BUF.PNAME ; 14/10/2018
 14001                                  FOR_MORE:
 14002                                  	;cmp	byte [si],0		; tack on matching filename
 14003                                  	;jz	short FOR_MAKE_COM
 14004                                  	;movsb
 14005                                  	;jnz	short FOR_MORE
 14006                                  	; 25/04/2023
 14007 00000F80 AC                      	lodsb
 14008 00000F81 AA                      	stosb
 14009 00000F82 08C0                    	or	al,al
 14010 00000F84 75FA                    	jnz	short FOR_MORE
 14011                                  FOR_MAKE_COM:
 14012                                  	; 25/04/2023
 14013                                  	;xor	al,al			; tack a null byte onto the end
 14014                                  	;stosb				; of the substitute string
 14015 00000F86 31C9                    	xor	cx,cx			; character count for command line
 14016 00000F88 F7D1                    	not	cx			; negate it -- take advantage of loopnz
 14017 00000F8A 31DB                    	xor	bx,bx			; argpointer
 14018 00000F8C BF[569A]                	mov	di,COMBUF+2
 14019                                  	; 15/02/2023
 14020                                  	;;mov	bl,[544h] ; MSDOS 5.0-6.22 ; 27/07/2024
 14021                                  	; 27/07/2024
 14022                                  	;mov	bl,[444h] ; PCDOS 7.1 COMMAND.COM 
 14023 00000F8F 8A1E4404                	mov	bl,[FOR_INFO.FOR_COM_START] ; argindex
 14024                                  	;;mov	dh,[64Bh]
 14025                                  	;mov	dh,[54Bh] ; 27/07/2024 ; PCDOS 7.1 COMMAND.COM
 14026 00000F93 8A364B05                	mov	dh,[FOR_INFO.FOR_VAR]
 14027                                  					; %<for-var> is replaced by [forbuf]
 14028 00000F97 0E                      	push	cs			; time to form the <command> string
 14029 00000F98 07                      	pop	es
 14030                                  	;assume ES:trangroup
 14031                                  	;mov	ax,FOR_INFO.FOR_ARGS
 14032 00000F99 B80000                  	mov	ax,0			; translate offset to pointer
 14033 00000F9C E8F125                  	call	argv_calc
 14034                                  	;mov	si,[bx+9]
 14035 00000F9F 8B7709                  	mov	si,[bx+ARGV_ELE.arg_ocomptr]
 14036                                  					; mov ptr passed beginning space
 14037 00000FA2 46                      	inc	si
 14038                                  FOR_MAKE_LOOP:
 14039 00000FA3 8A04                    	mov	al,[si]			; the <command> arg, byte by byte
 14040 00000FA5 46                      	inc	si
 14041 00000FA6 3C25                    	cmp	al,'%'			; looking for %<control-variable>
 14042 00000FA8 7514                    	jne	short FOR_STOSB 	; no % ... add byte to string
 14043 00000FAA 3834                    	cmp	[si],dh			; got the right <variable>?
 14044 00000FAC 7510                    	jnz	short FOR_STOSB		; got a %, but wrong <variable>
 14045 00000FAE 46                      	inc	si			; skip over <for-variable>
 14046                                  
 14047 00000FAF 56                      	push	si
 14048                                  	; 15/02/2023
 14049                                  	;;mov	si,54Bh	; MSDOS 5.0-6.22 ; 27/07/2024
 14050                                  	; 27/07/2024
 14051                                  	;mov	si,44Bh ; PCDOS 7.1 COMMAND.COM
 14052 00000FB0 BE4B04                  	mov	si,FOR_INFO.FORBUF
 14053                                  					; substitute the <item> for <variable>
 14054                                  					; to make a final <command> to execute
 14055                                  SLOOP:					
 14056 00000FB3 AC                      	lodsb				; grab all those <item> bytes, and
 14057 00000FB4 AA                      	stosb				; add 'em to the <command> string,
 14058 00000FB5 08C0                    	or	al,al			; until we run into a null
 14059 00000FB7 E0FA                    	loopne	SLOOP
 14060 00000FB9 4F                      	dec	di			; adjust length and <command> pointer
 14061 00000FBA 41                      	inc	cx			; so we can overwrite the null
 14062 00000FBB 5E                      	pop	si
 14063 00000FBC EBE5                    	jmp	short FOR_MAKE_LOOP
 14064                                  					; got back for more <command> bytes
 14065                                  FOR_STOSB:
 14066 00000FBE AA                      	stosb				; take a byte from the <command> arg
 14067 00000FBF 49                      	dec	cx			; and put it into the <command> to be
 14068                                  					; executed (and note length, too)
 14069 00000FC0 3C0D                    	cmp	al,0Dh
 14070 00000FC2 75DF                    	jne	short FOR_MAKE_LOOP	; If not done, loop.
 14071                                  FOR_MADE_COM:
 14072 00000FC4 F6D1                    	not	cl
 14073                                  	;mov	[cs:COMBUF+1],cl
 14074                                  	;mov	ds,[cs:RESSEG]
 14075                                  	; 15/02/2023 - Retro DOS v4.0 COMMAND.COM
 14076                                  	; MSDOS 5.0 COMMAND.COM
 14077 00000FC6 26880E[559A]            	mov	[es:COMBUF+1],cl
 14078 00000FCB 268E1E[F59B]            	mov	ds,[es:RESSEG]
 14079                                  	;assume DS:resgroup
 14080 00000FD0 F606[9D02]01            	test	byte [EchoFlag],1 	; shall we echo this <command>, dearie?
 14081 00000FD5 742F                    	jz	short NOECHO3
 14082                                  	;cmp	byte [NullFlag],nullcommand
 14083 00000FD7 803E[B402]01            	cmp	byte [NullFlag],1 	;G was there a command last time?
 14084 00000FDC 7403                    	jz	short NO_CRLF_PR  	;G no - don't print crlf
 14085                                  
 14086 00000FDE E89819                  	call	CRLF2		  	;G Print out prompt
 14087                                  NO_CRLF_PR:
 14088 00000FE1 C606[B402]00            	mov	byte [NullFlag],0 	;G reset no command flag
 14089 00000FE6 0E                      	push	cs
 14090 00000FE7 1F                      	pop	ds
 14091 00000FE8 57                      	push	di
 14092 00000FE9 E80411                  	call	PRINT_PROMPT	  	;G Prompt the user
 14093 00000FEC 5F                      	pop	di
 14094                                  
 14095 00000FED 26C645FF00              	mov	byte [es:di-1],0  	; yeah, PRINT it out...	
 14096 00000FF2 C706[A09D][569A]        	mov	word [string_ptr_2],COMBUF+2
 14097                                  	; 17/04/2023
 14098 00000FF8 BA[DF91]                	mov	dx,string_buf_ptr
 14099 00000FFB E82A44                  	call	std_printf
 14100 00000FFE 26C645FF0D              	mov	byte [es:di-1],0Dh
 14101 00001003 E9ECF2                  	jmp	DOCOM		  	; run silent, run deep...
 14102                                  NOECHO3:
 14103 00001006 C606[B402]00            	mov	byte [NullFlag],0
 14104 0000100B 0E                      	push	cs
 14105 0000100C 1F                      	pop	ds
 14106                                  	;jmp	DOCOM1
 14107                                  	; 07/06/2023
 14108                                  	; Retro DOS v4.2 COMMAND.COM
 14109 0000100D E9E5F2                  	jmp	DOCOM0 ; MSDOS 6.22 COMMAND.COM
 14110                                  
 14111                                  FORNESTERRJ:				; no multi-loop processing... yet!
 14112 00001010 E84601                  	call	FOROFF
 14113 00001013 E92901                  	jmp	FORNESTERR
 14114                                  
 14115                                  ; ---------------------------------------------------------------------------
 14116                                  
 14117                                  FORERRORJ:
 14118 00001016 E9D9FB                  	jmp	FORERROR
 14119                                  
 14120                                  ; ---------------------------------------------------------------------------
 14121                                  
 14122                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0F24h
 14123                                  
 14124                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 14125                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0FFEh
 14126                                  
 14127                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 14128                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1040h
 14129                                  _$FOR:
 14130 00001019 8E06[F59B]              	mov	es,[RESSEG]
 14131 0000101D 26803E[AB02]00          	cmp	byte [es:ForFlag],0 ; is another one already running?
 14132 00001023 75EB                    	jnz	short FORNESTERRJ   ; if flag is set.... boom!
 14133                                  
 14134                                  ; Turn off any pipes in progress.
 14135                                  
 14136 00001025 26803E[1403]00          	cmp	byte [es:PipeFiles],0 ; Only turn off if present.
 14137 0000102B 7403                    	jz	short NO_PIPE
 14138 0000102D E8F020                  	call	PIPEDEL
 14139                                  NO_PIPE:
 14140 00001030 31D2                    	xor	dx,dx			; counter (0 <= DX < argvcnt)
 14141 00001032 E8F400                  	call	NEXTARG			; move to next argv[n]
 14142 00001035 72DF                    	jc	short FORERRORJ		; no more args -- bad forloop
 14143 00001037 3C25                    	cmp	al,'%'			; next arg MUST start with '%'...
 14144 00001039 75DB                    	jne	short FORERRORJ
 14145 0000103B 89C5                    	mov	bp,ax			; save forloop variable
 14146 0000103D AC                      	lodsb
 14147 0000103E 08C0                    	or	al,al			; and MUST end immediately...
 14148 00001040 75D4                    	jnz	short FORERRORJ
 14149 00001042 E8E400                  	call	NEXTARG			; let's make sure the next arg is 'in'
 14150 00001045 72CF                    	jb	short FORERRORJ
 14151                                  	;and	ax,0DFDFh
 14152 00001047 25DFDF                  	and	ax,~2020h		; uppercase the letters
 14153                                  	; 15/02/2023
 14154                                  	;cmp	ax,4E49h  	; MSDOS 5.0
 14155                                  	;cmp	ax,[IN_WORD] 	; MSDOS 3.3
 14156                                  	;cmp	ax,in_word	; MSDOS 5.0
 14157 0000104A 3D494E                  	cmp	ax,'IN'
 14158 0000104D 75C7                    	jnz	short FORERRORJ
 14159 0000104F AC                      	lodsb
 14160                                  
 14161                                  	; 15/02/2023
 14162                                  	; MSDOS 3.3
 14163                                  	;or	al,al			; it, too, must end right away
 14164                                  	;jz	short CHECKLPAREN
 14165                                  	;cmp	al,[LPAREN]
 14166                                  	;jnz	short FORERRORJ
 14167                                  	;;add	word [bx+ARGV_ELE.argpointer],2 ; add word [bx+0],2
 14168                                  	;add	word [bx],2
 14169                                  	;;add	word [bx+9],2
 14170                                  	;add	word [bx+ARGV_ELE.arg_ocomptr],2
 14171                                  	;;sub	word [bx+5],2
 14172                                  	;sub	word [bx+ARGV_ELE.arglen],2
 14173                                  	;mov	ax,[si-1]
 14174                                  	;jmp	short LPCHECK
 14175                                  
 14176                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14177                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0F5Bh
 14178                                  
 14179                                  	; MSDOS 6.0
 14180                                  ; Compaq bug fix -- exit from this loop on error
 14181                                  
 14182 00001050 08C0                    	or	al,al
 14183 00001052 75C2                    	jne	short FORERRORJ		; jump on error
 14184                                  
 14185                                  ;	je	short CHECKLPAREN
 14186                                  ;
 14187                                  ; Not null. Perhaps there are no spaces between this and the (:
 14188                                  ;   FOR %i in(foo bar...
 14189                                  ; Check for the Lparen here
 14190                                  ;
 14191                                  ;;	cmp	al,lparen
 14192                                  ;;	jnz	short FORERRORJ
 14193                                  ;
 14194                                  ; The token was in(... We strip off the "in" part to simulate a separator
 14195                                  ; being there in the first place.
 14196                                  ;
 14197                                  ;;	add	word [bx+ARGV_ELE.argpointer],2 ; advance source pointer
 14198                                  ;;	add	word [bx+ARGV_ELE.arg_ocomptr],2
 14199                                  ;;						; advance original string
 14200                                  ;;	sub	word [bx+ARGV_ELE.arglen],2 	; decrement the appropriate length
 14201                                  ;
 14202                                  ; SI now points past the in(.  Simulate a nextarg call that results in the
 14203                                  ; current value.
 14204                                  ;
 14205                                  ;;	mov	ax,[si-1]		; get lparen and next char
 14206                                  ;;	jmp	short LPCHECK
 14207                                  ;
 14208                                  ; end of Compaq bug fix
 14209                                  
 14210                                  ; ---------------------------------------------------------------------------
 14211                                  
 14212                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14213                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0F5Fh
 14214                                  
 14215                                  	; MSDOS 3.3 (& MSDOS 6.0)
 14216                                  CHECKLPAREN:
 14217 00001054 E8D200                  	call	NEXTARG			; lparen delimits beginning of <list>
 14218 00001057 72BD                    	jc	short FORERRORJ
 14219                                  LPCHECK:
 14220                                  	; 15/02/2023
 14221                                  	; MSDOS 5.0 (% MSDOS 6.0)
 14222                                  	;;cmp	al,[LPAREN]
 14223                                  	;cmp	al,lparen
 14224 00001059 3C28                    	cmp	al,'('
 14225 0000105B 75B9                    	jne	short FORERRORJ
 14226 0000105D 80FC00                  	cmp	ah,0
 14227 00001060 7410                    	je	short FOR_PAREN_TOKEN
 14228                                  	;;cmp	ah,[RPAREN]		; special case:  null list
 14229                                  	;cmp	ah,rparen
 14230 00001062 80FC29                  	cmp	ah,')'
 14231 00001065 7503                    	jne	short FOR_LIST_NOT_EMPTY
 14232 00001067 E953FE                  	jmp	FORTERM
 14233                                  FOR_LIST_NOT_EMPTY:
 14234                                  	;inc	word [bx+ARGV_ELE.argpointer] ; inc word [bx+0]
 14235 0000106A FF07                    	inc	word [bx]		; Advance ptr past "("
 14236                                  	;dec	word [bx+5]		; Adjust the rest of this argv entry
 14237 0000106C FF4F05                  	dec	word [bx+ARGV_ELE.arglen] ; to agree.
 14238 0000106F 46                      	inc	si			; Inc si so check for ")" works
 14239 00001070 EB0D                    	jmp	short FOR_LIST
 14240                                  
 14241                                  	;nop
 14242                                  FOR_PAREN_TOKEN:
 14243 00001072 E8B400                  	call	NEXTARG			; what have we in our <list>?
 14244 00001075 729F                    	jc	short FORERRORJ
 14245                                  	; 15/02/2023
 14246                                  	;;;cmp	ax,[RPAREN+1]
 14247                                  	;;cmp	ax,[NULLRPAREN]		; special case:  null list
 14248                                  	;cmp	ax,nullrparen
 14249 00001077 83F829                  	cmp	ax,29h	; db 29h,0 ; db ')',0
 14250 0000107A 7503                    	jne	short FOR_LIST
 14251 0000107C E93EFE                  	jmp	FORTERM
 14252                                  
 14253                                  ;FORERORJJ:
 14254                                  	;jmp	FORERROR
 14255                                  
 14256                                  FOR_LIST:				; skip over rest of <list>
 14257 0000107F 89D1                    	mov	cx,dx			; first arg of <list>
 14258                                  
 14259                                  SKIP_LIST:
 14260                                  	;add	si,[bx+5]
 14261 00001081 037705                  	add	si,[bx+ARGV_ELE.arglen]
 14262 00001084 83EE03                  	sub	si,3			; si = ptr to last char of token
 14263                                  	; 15/02/2023
 14264                                  	;;mov	al,[RPAREN]
 14265                                  	;mov	al,rparen
 14266 00001087 B029                    	mov	al,')'
 14267 00001089 3804                    	cmp	[si],al			; Is this the last element in <list>
 14268 0000108B 7408                    	je	short FOR_END_LIST 	; Yes, exit loop.
 14269 0000108D E89900                  	call	NEXTARG			; No, get next arg <list>
 14270                                  	;jc	short FORERORJJ		; If no more and no rparen, error.
 14271                                  	;jmp	short SKIP_LIST
 14272                                  	; 15/02/2023
 14273 00001090 73EF                    	jnc	short SKIP_LIST
 14274                                  
 14275                                  	; 15/02/2023
 14276                                  FORERORJJ:
 14277 00001092 E95DFB                  	jmp	FORERROR
 14278                                  
 14279                                  FOR_END_LIST:
 14280 00001095 89D7                    	mov	di,dx			; record position of last arg in <list>
 14281 00001097 C60400                  	mov	byte [si],0		; Zap the rparen
 14282                                  	; 15/02/2023
 14283                                  	;;;cmp	ax,[RPAREN+1]
 14284                                  	;;cmp	ax,[NULLRPAREN] 	; Was this token only a rparen
 14285                                  	;cmp	ax,nullparen
 14286 0000109A 83F829                  	cmp	ax,29h	; db 29h,0 ; db ')',0
 14287 0000109D 7401                    	je	short FOR_DO		; Yes, continue
 14288 0000109F 47                      	inc	di			; No, inc position of last arg
 14289                                  FOR_DO:
 14290 000010A0 E88600                  	call	NEXTARG			; now we had BETTER find a 'do'...
 14291 000010A3 72ED                    	jc	short FORERORJJ
 14292                                  	;and	ax,0DFDFh
 14293 000010A5 25DFDF                  	and	ax,~2020h		; uppercase the letters
 14294                                  	; 15/02/2023
 14295                                  	;;cmp	ax,[DO_WORD]
 14296                                  	;cmp	ax,do_word ; 4F44h
 14297 000010A8 3D444F                  	cmp	ax,'DO'	 ; 4F44h
 14298 000010AB 75E5                    	jne	short FORERORJJ
 14299 000010AD AC                      	lodsb
 14300 000010AE 08C0                    	or	al,al			; and it had BETTER be ONLY a 'do'...
 14301 000010B0 75E0                    	jnz	short FORERORJJ
 14302                                  		
 14303 000010B2 E87400                  	call	NEXTARG			; on to the beginning of <command>
 14304 000010B5 72DB                    	jc	short FORERORJJ		; null <command> not legal
 14305                                  
 14306 000010B7 50                      	push	ax
 14307 000010B8 53                      	push	bx
 14308 000010B9 51                      	push	cx
 14309 000010BA 52                      	push	dx			; preserve registers against disaster
 14310 000010BB 57                      	push	di
 14311 000010BC 56                      	push	si
 14312 000010BD 55                      	push	bp
 14313 000010BE E852F7                  	call	FREE_TPA		; need to make free memory, first
 14314 000010C1 E89500                  	call	FOROFF
 14315                                  	;mov	bx,264 ; 27/07/2024  ; MSDOS 5.0-6.22 & PCDOS 7.1	
 14316 000010C4 BB0801                  	mov	bx,FOR_INFO.size-ARG_UNIT.SIZE
 14317 000010C7 E8E927                  	call	SAVE_ARGS		; extra bytes needed for for-info
 14318 000010CA 9C                      	pushf
 14319 000010CB 26A3[AC02]              	mov	[es:ForPtr],ax
 14320 000010CF E852F7                  	call	ALLOC_TPA		; ALLOC_TPA clobbers registers...
 14321 000010D2 9D                      	popf
 14322 000010D3 5D                      	pop	bp
 14323 000010D4 5E                      	pop	si
 14324 000010D5 5F                      	pop	di
 14325 000010D6 5A                      	pop	dx
 14326 000010D7 59                      	pop	cx
 14327 000010D8 5B                      	pop	bx
 14328 000010D9 58                      	pop	ax
 14329 000010DA 723C                    	jc	short FOR_ALLOC_ERR
 14330                                  
 14331 000010DC 06                      	push	es			; save resgroup seg...
 14332 000010DD 26FF36[AC02]            	push	word [es:ForPtr]
 14333 000010E2 07                      	pop	es
 14334                                  	;assume es:for_segment
 14335 000010E3 49                      	dec	cx			; forproc wants min pointing before
 14336 000010E4 4F                      	dec	di			; first arg, max right at last one
 14337                                  	; 15/02/2023
 14338                                  	;;mov	[547h],cx
 14339                                  	; 27/07/2024
 14340                                  	;mov	[447h],cx ; PCDOS 7.1 COMMAND.COM
 14341 000010E5 26890E4704              	mov	[es:FOR_INFO.FOR_MINARG],cx
 14342                                  	;;mov	[549h],di
 14343                                  	;mov	[449h],di ; PCDOS 7.1 COMMAND.COM ; 27/07/2024
 14344 000010EA 26893E4904              	mov	[es:FOR_INFO.FOR_MAXARG],di
 14345                                  	;;mov	[544h],dl
 14346                                  	;mov	[444h],dl ; PCDOS 7.1 COMMAND.COM ; 27/07/2024
 14347 000010EF 2688164404              	mov	[es:FOR_INFO.FOR_COM_START],dl
 14348                                  	;;mov	word [545h],0FFFFh ; -1
 14349                                  	;mov	[445h],0FFFFh ; PCDOS 7.1 COMMAND.COM ; 27/07/2024
 14350 000010F4 26C7064504FFFF          	mov	word [es:FOR_INFO.FOR_EXPAND],-1
 14351                                  					; non-zero means FALSE
 14352 000010FB 89E8                    	mov	ax,bp
 14353                                  	;;mov	[64Bh],ah
 14354                                  	;mov	[54Bh],ah ; 27/07/2024 ; PCDOS 7.1 COMMAND.COM
 14355 000010FD 2688264B05              	mov	[es:FOR_INFO.FOR_VAR],ah
 14356 00001102 07                      	pop	es
 14357                                  	;assume es:resgroup
 14358 00001103 26FE06[AB02]            	inc	byte [es:ForFlag]
 14359 00001108 26833E[A502]FF          	cmp	word [es:SingleCom],-1
 14360 0000110E 7507                    	jne	short FOR_RET
 14361 00001110 26C706[A502]00FF        	mov	word [es:SingleCom],0FF00h
 14362                                  FOR_RET:
 14363 00001117 C3                      	retn
 14364                                  
 14365                                  FOR_ALLOC_ERR:
 14366                                  	; 15/02/2023
 14367                                  	; MSDOS 3.3
 14368                                  	;mov	dx,INSFMEMMESPTR
 14369                                  	;jmp	CERROR
 14370                                  
 14371                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14372                                  	; MSDOS 6.0
 14373                                  	;mov	byte [msg_disp_class],1
 14374 00001118 C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class
 14375                                  					;AN000; set up extended error msg class
 14376                                  	;mov	dx,offset TranGroup:Extend_Buf_ptr
 14377 0000111D BA[D78F]                	mov	dx,extend_buf_ptr
 14378                                  					;AC000; get extended message pointer
 14379                                  	;mov	word [extend_buf_ptr],8
 14380 00001120 C706[D78F]0800          	mov	word [extend_buf_ptr],ERROR_NOT_ENOUGH_MEMORY
 14381                                  					;AN000; get message number in control block
 14382 00001126 E9FD1B                  	jmp	cerror
 14383                                  
 14384                                  
 14385                                  ; =============== S U B	R O U T	I N E =======================================
 14386                                  
 14387                                  NEXTARG:
 14388 00001129 42                      	inc	dx			; next argv[n]
 14389                                  	;cmp	dx,[ARG_ARGVCNT]
 14390 0000112A 3B16[10A2]              	cmp	dx,[ARG+ARG_UNIT.argvcnt]
 14391                                  					; make sure we don't run off end
 14392 0000112E 7D0D                    	jge	short NEXTARG_ERR 	;  of argv[]...	
 14393 00001130 89D3                    	mov	bx,dx
 14394                                  	;mov	ax,ARG_ARGV
 14395                                  	;mov	ax,ARG+ARG_UNIT.argv
 14396 00001132 B8[509F]                	mov	ax,ARG
 14397 00001135 E85824                  	call	argv_calc		; convert array index to pointer
 14398 00001138 8B37                    	mov	si,[bx]			; load pointer to argstring
 14399                                  	;mov	si,[bx+ARGV_ELE.argpointer] ; mov si,[bx+0]
 14400 0000113A AD                      	lodsw				; and load first two chars
 14401 0000113B F8                      	clc
 14402 0000113C C3                      	retn
 14403                                  NEXTARG_ERR:
 14404 0000113D F9                      	stc
 14405 0000113E C3                      	retn
 14406                                  
 14407                                  ; ---------------------------------------------------------------------------
 14408                                  
 14409                                  FORNESTERR:
 14410 0000113F 1E                      	push	ds
 14411 00001140 8E1E[F59B]              	mov	ds,[RESSEG]
 14412                                  	;ASSUME DS:RESGROUP
 14413 00001144 BA[5A91]                	mov	dx,FORNESTMES_PTR
 14414 00001147 813E[A502]00FF          	cmp	word [SingleCom],0FF00h
 14415 0000114D 7506                    	jne	short NOFORP3
 14416 0000114F C706[A502]FFFF          	mov	word [SingleCom],-1 ; 0FFFFh ; Cause termination
 14417                                  NOFORP3:
 14418 00001155 1F                      	pop	ds
 14419 00001156 E9CD1B                  	jmp	cerror
 14420                                  
 14421                                  ; =============== S U B	R O U T	I N E =======================================
 14422                                  
 14423                                  ; General routine called to free the for segment. We also clear the forflag
 14424                                  ; too. Change no registers.
 14425                                  
 14426                                  FOROFF:
 14427 00001159 50                      	push	ax
 14428 0000115A 06                      	push	es
 14429 0000115B 2E8E06[F59B]            	mov	es,[cs:RESSEG]
 14430 00001160 26A1[AC02]              	mov	ax,[es:ForPtr]
 14431 00001164 09C0                    	or	ax,ax
 14432 00001166 7408                    	jz	short FREEDONE
 14433 00001168 06                      	push	es
 14434 00001169 8EC0                    	mov	es,ax
 14435                                  	; 15/02/2023
 14436 0000116B B449                    	mov	ah,49h
 14437                                  	;mov	ah,DEALLOC ; 49h
 14438 0000116D CD21                    	int	21h	; DOS -	2+ - FREE MEMORY
 14439                                  			; ES = segment address of area to be freed
 14440 0000116F 07                      	pop	es
 14441                                  FREEDONE:
 14442 00001170 26C706[AC02]0000        	mov	word [es:ForPtr],0
 14443 00001177 26C606[AB02]00          	mov	byte [es:ForFlag],0
 14444 0000117D 07                      	pop	es
 14445 0000117E 58                      	pop	ax
 14446 0000117F C3                      	retn
 14447                                  
 14448                                  ;============================================================================
 14449                                  ; TCMD1A.ASM, MSDOS 6.0, 1991
 14450                                  ;============================================================================
 14451                                  ; 09/10/2018 - Retro DOS v3.0
 14452                                  
 14453                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 0ECBh
 14454                                  
 14455                                  ; ---------------------------------------------------------------------------
 14456                                  
 14457                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14458                                  
 14459                                  %if 0
 14460                                  
 14461                                  ; The DIR command displays the contents of a directory.
 14462                                  ;
 14463                                  ; ****************************************************************
 14464                                  ; *
 14465                                  ; * ROUTINE:	 CATALOG - display file(s) in directory
 14466                                  ; *
 14467                                  ; * FUNCTION:	 PARSE command line for drive, file, or path name.
 14468                                  ; *		 DIR allows two switches, /P (pause) and /W (wide).
 14469                                  ; *		 If an error occurs issue and error message and
 14470                                  ; *		 transfer control to CERROR.
 14471                                  ; *
 14472                                  ; * INPUT:	 command line at offset 81H
 14473                                  ; *
 14474                                  ; * OUTPUT:	 none
 14475                                  ; *
 14476                                  ; ****************************************************************
 14477                                  
 14478                                  CATALOG:
 14479                                  	; MSDOS 3.3
 14480                                  
 14481                                  	;mov	ax,ARG_ARGV
 14482                                  	;mov	ax,ARG+ARG_UNIT.argv
 14483                                  	mov	ax,ARG
 14484                                  	mov	dx,0FFFFh
 14485                                  	xor	cx,cx
 14486                                  	xor	si,si
 14487                                  DIR1:
 14488                                  	;cmp	cx,[ARG_ARGVCNT]
 14489                                  	cmp	cx,[ARG+ARG_UNIT.argvcnt]
 14490                                  	jnb	short DIR6 ; No more arguments
 14491                                  	mov	bx,cx
 14492                                  	call	ARGV_CALC
 14493                                  	;or	si,[bx+7]
 14494                                  	or	si,[bx+ARGV_ELE.argsw_word]
 14495                                  	test	si,7FFCh  ; test si,~8003
 14496                                  	jnz	short DIR2  ; /A,/B,/V switches (are invalid)
 14497                                  	;test	byte [bx+2],1
 14498                                  	test	byte [bx+ARGV_ELE.argflags],sw_flag  ; 1
 14499                                  	jz	short DIR3
 14500                                  	jmp	short DIR5
 14501                                  DIR2:
 14502                                  	mov	dx,BADPARMPTR
 14503                                  	jmp	CERROR
 14504                                  DIR3:
 14505                                  	or	cx,cx
 14506                                  	jnz	short DIR4	
 14507                                  	;cmp	word [bx+5],3
 14508                                  	cmp	word [bx+ARGV_ELE.arglen],3
 14509                                  	jz	short DIR5
 14510                                  	;add	word [bx+ARGV_ELE.argpointer],3 ; add word [bx+0],3
 14511                                  	add	word [bx],3
 14512                                  	;add	word [bx+9],3
 14513                                  	add	word [bx+ARGV_ELE.arg_ocomptr],3
 14514                                  	;add	word [bx+3],3
 14515                                  	add	word [bx+ARGV_ELE.argstartel],3
 14516                                  	;sub	word [bx+5],3
 14517                                  	sub	word [bx+ARGV_ELE.arglen],3
 14518                                  DIR4:
 14519                                  	cmp	dx,0FFFFh
 14520                                  	jnz	short DIR2
 14521                                  	mov	dx,bx
 14522                                  DIR5:
 14523                                  	inc	cx
 14524                                  	jmp	short DIR1
 14525                                  DIR6:
 14526                                  	mov	[COMSW],si
 14527                                  	push	dx
 14528                                  	xor	al,al
 14529                                  	cmp	dx,0FFFFh
 14530                                  	jz	short DIR7
 14531                                  	mov	bx,dx
 14532                                  	;mov	di,[bx+ARGV_ELE.argpointer]  ;mov di,[bx+0]
 14533                                  	mov	di,[bx]
 14534                                  	cmp	byte [di+1],':'
 14535                                  	jnz	short DIR7
 14536                                  	mov	al,[di]
 14537                                  	or	al,20h		; Lowercase drive name	
 14538                                  	sub	al,'a'-1 ; 60h  ; Convert to drive number (0,1..)
 14539                                  DIR7:
 14540                                  	;mov	[5CH],al
 14541                                  	mov	[FCB],al
 14542                                  	call	OKVOLARG
 14543                                  	mov	al,'?'		; *.* is default file spec.
 14544                                  	;mov	di,5Dh
 14545                                  	mov	di,FCB+1
 14546                                  	mov	cx,11
 14547                                  	rep stosb
 14548                                  
 14549                                  ; Begin by processing any switches that may have been specified.
 14550                                  ; BITS will contain any information about switches that was
 14551                                  ; found when the command line was parsed.
 14552                                  
 14553                                  	mov	ax,[COMSW]	; Get switches from command
 14554                                  	mov	[_BITS],ax	; initialize switches
 14555                                  	mov	word [COMSW],0	; initialize flags
 14556                                  	mov	byte [LINPERPAG],23 ; Set default for lines per page
 14557                                  	;test	al,1
 14558                                  	test	al,SWITCHW	; /W ?
 14559                                  	;mov	al,1
 14560                                  	mov	al,NORMPERLIN
 14561                                  	jz	short DIR8
 14562                                  	;mov	al,5
 14563                                  	mov	al,WIDEPERLIN
 14564                                  DIR8:
 14565                                  	mov	[LINLEN],al	; Set number of entries per line
 14566                                  	mov	[LINCNT],al
 14567                                  	mov	word [FILECNT],0 ; Keep track of how many files found
 14568                                  	mov	dx,DIRBUF
 14569                                  	mov	ah,Set_DMA ; 1Ah
 14570                                  	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 14571                                  			; DS:DX	-> disk	transfer buffer
 14572                                  	;mov	dl,[5Ch]
 14573                                  	mov	dl,[FCB]
 14574                                  	call	SAVUDIR
 14575                                  	pop	bx
 14576                                  	cmp	bx,0FFFFh
 14577                                  	jz	short DIR9
 14578                                  	;mov	dx,[bx+ARGV_ELE.argpointer] ; mov dx,[bx+0]
 14579                                  	mov	dx,[bx]
 14580                                  
 14581                                  ; The user may have specified a device. Search for the path and see if the
 14582                                  ; attributes indicate a device.
 14583                                  
 14584                                  	mov	ah,Find_First ; 4Eh
 14585                                  	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 14586                                  			; CX = search attributes
 14587                                  			; DS:DX	-> ASCIZ filespec
 14588                                  			; (drive,path, and wildcards allowed)
 14589                                  	jc	short DIR10
 14590                                  			; Check device atrribute..
 14591                                  	;test	byte [DIRBUF_ATTRIB2],40h
 14592                                  	;test	byte [DIRBUF_ATTRIB2],ATTR_DEVICE
 14593                                  	; 14/10/2018
 14594                                  	;test	byte [DIRBUF+21],40h
 14595                                  	test	byte [DIRBUF+FIND_BUF.ATTR],ATTR_DEVICE
 14596                                  	jz	short DIR10	; no, go do normal operation
 14597                                  	mov	word [COMSW],-2 ; 0FFFEh  ; Signal device
 14598                                  DIR9:
 14599                                  	jmp	short DOHEADER
 14600                                  DIR10:
 14601                                  	;mov	dx,[bx+ARGV_ELE.argpointer]
 14602                                  	mov	dx,[bx]
 14603                                  	mov	ah,CHDir ; 3Bh
 14604                                  	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 14605                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 14606                                  	jnc	short DOHEADER
 14607                                  	;mov	si,[bx+3]
 14608                                  	mov	si,[bx+ARGV_ELE.argstartel]
 14609                                  	cmp	dx,si
 14610                                  	jz	short DIR_NO_DRIVE
 14611                                  	xor	cl,cl
 14612                                  	xchg	cl,[si]
 14613                                  	mov	ah,CHDir ; 3Bh
 14614                                  	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 14615                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 14616                                  	xchg	cl,[si]
 14617                                  	jnc	short DIR_NO_DRIVE
 14618                                  	mov	al,[si-1]
 14619                                  	call	PATHCHRCMP
 14620                                  	jnz	short DIR11
 14621                                  	mov	al,[si-2]
 14622                                  	call	PATHCHRCMP
 14623                                  	jz	short DIR12
 14624                                  	xchg	cl,[si-1]
 14625                                  	mov	ah,CHDir ; 3Bh
 14626                                  	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 14627                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 14628                                  	xchg	cl,[si-1]
 14629                                  	jnc	short DIR_NO_DRIVE
 14630                                  DIR11:
 14631                                  	mov	ch,':'
 14632                                  	cmp	ch,[si-1]
 14633                                  	jnz	short DIR12
 14634                                  	;mov	cx,[bx+ARGV_ELE.argpointer] ; mov cx,[bx+0]
 14635                                  	mov	cx,[bx]
 14636                                  	xchg	cx,si
 14637                                  	sub	cx,si
 14638                                  	cmp	cx,2
 14639                                  	jz	short DIR_NO_DRIVE
 14640                                  DIR12:
 14641                                  	mov	dx,BADCDPTR
 14642                                  	;test	byte [bx+2],4
 14643                                  	test	byte [bx+ARGV_ELE.argflags],4 ; path_sep
 14644                                  	jnz	short DIRERROR
 14645                                  DIRNF:
 14646                                  	mov	dx,FNOTFOUNDPTR
 14647                                  DIRERROR:
 14648                                  	jmp	CERROR
 14649                                  DIR_NO_DRIVE:
 14650                                  	cmp	word [si],'..'
 14651                                  	jnz	short DOREALPARSE
 14652                                  	cmp	byte [si+2],0
 14653                                  	jnz	short DOREALPARSE
 14654                                  	inc	word [COMSW]
 14655                                  	jmp	short DOHEADER
 14656                                  DOREALPARSE:
 14657                                  	mov	di,FCB ; 5Ch	
 14658                                  	;mov	ax,290Eh
 14659                                  	mov	ax,(Parse_File_Descriptor<<8)|0Eh
 14660                                  	int	21h	; DOS -	PARSE FILENAME
 14661                                  			; DS:SI	-> string to parse
 14662                                  			; ES:DI	-> buffer to fill with unopened	FCB
 14663                                  			; AL = bit mask	to control parsing
 14664                                  	cmp	byte [si],0
 14665                                  	jz	short DOHEADER
 14666                                  	dec	word [COMSW]
 14667                                  DOHEADER:
 14668                                  		
 14669                                  ; Display the header
 14670                                  
 14671                                  	push	bx
 14672                                  	call	BUILD_DIR_STRING
 14673                                  	mov	dx,DIRBUF
 14674                                  	mov	[VOL_DIR],dx
 14675                                  	mov	dx,DIRHEADPTR
 14676                                  	call	PRINTF_CRLF
 14677                                  	pop	bx
 14678                                  	cmp	bx,0FFFFh
 14679                                  	jz	short DOSEARCH
 14680                                  
 14681                                  ; If there were chars left after parse or device, then invalid file name
 14682                                  
 14683                                  	cmp	word [COMSW],0
 14684                                  	jz	short DOSEARCH	; nothing left; good parse
 14685                                  	jl	short DIRNFFIX	; not .. => error file not found
 14686                                  	call	RESTUDIR
 14687                                  	mov	dx,BADCDPTR
 14688                                  	jmp	CERROR		; was .. => error directory not found
 14689                                  DIRNFFIX:
 14690                                  	call	RESTUDIR
 14691                                  	jmp	short DIRNF
 14692                                  
 14693                                  ; We are assured that everything is correct. Let's go and search. Use
 14694                                  ; attributes that will include finding directories. Perform the first search
 14695                                  ; and reset our directory afterward.
 14696                                  
 14697                                  DOSEARCH:
 14698                                  	;mov	byte [55h],0FFh
 14699                                  	mov	byte [FCB-7],0FFh
 14700                                  	;mov	byte [5Bh],10h
 14701                                  	mov	byte [FCB-1],10h
 14702                                  
 14703                                  ; Caution! Since we are using an extended FCB, we will *also* be returning
 14704                                  ; the directory information as an extended FCB. We must bias all fetches into
 14705                                  ; DIRBUF by 8 (Extended FCB part + drive)
 14706                                  
 14707                                  	mov	ah,Dir_Search_First ; 11h
 14708                                  	mov	dx,FCB-7 ; 55h
 14709                                  	int	21h	; DOS -	SEARCH FIRST USING FCB
 14710                                  			; DS:DX	-> FCB
 14711                                  
 14712                                  ; Restore the user's directory. We preserve, though, the return from the
 14713                                  ; previous system call for later checking.
 14714                                  
 14715                                  FOUND_FIRST_FILE:
 14716                                  	push	ax		; save return state
 14717                                  	call	RESTUDIR	; restore user's dir	
 14718                                  	pop	ax		; get return state back
 14719                                  
 14720                                  ; Main scanning loop. Entry has AL = Search first/next error code. Test for
 14721                                  ; no more.
 14722                                  
 14723                                  DIRSTART:
 14724                                  	inc	al		; 0FFh = file not found
 14725                                  	jnz	short DISPLAY	; Either an error or we are finished
 14726                                  	jmp	CHKCNT
 14727                                  DISPLAY:
 14728                                  	inc	word [FILECNT]	; Keep track of how many we find
 14729                                  	mov	si,DIRBUF+8	; SI -> information returned by sys call
 14730                                  	;call	SHONAME
 14731                                  	call	DISPLAYNAME
 14732                                  	;test	byte [_BITS],1
 14733                                  	test	byte [_BITS],SWITCHW ; W switch set?
 14734                                  	jz	short DIRTEST	; If so, no size, date, or time
 14735                                  	jmp	NEXENT
 14736                                  DIRTEST:
 14737                                  	;test	byte [DIRBUF_ATTRIB1],10h
 14738                                  	; 14/10/2018
 14739                                  	;test	byte [DIRBUF_ATTRIB1],ATTR_DIRECTORY
 14740                                  	;test	byte [DIRBUF+19],10h
 14741                                  	test	byte [DIRBUF+8+DIR_ENTRY.DIR_ATTR],ATTR_DIRECTORY
 14742                                  	jz	short FILEENT
 14743                                  	mov	dx,DMESPTR
 14744                                  	call	STD_PRINTF
 14745                                  	jmp	short NOFSIZ
 14746                                  FILEENT:
 14747                                  	;mov	dx,[DIRBUF_FSIZ_L]
 14748                                  	;mov	dx,[DIRBUF+36]
 14749                                  	mov	dx,[DIRBUF+8+DIR_ENTRY.DIR_SIZE_L]
 14750                                  	mov	[FILESIZE_L],dx
 14751                                  	;mov	dx,[DIRBUF_FSIZ_H]
 14752                                  	;mov	dx,[DIRBUF+38]
 14753                                  	mov	dx,[DIRBUF+8+DIR_ENTRY.DIR_SIZE_H]
 14754                                  	mov	[FILESIZE_H],dx
 14755                                  	mov	dx,FSIZEMESPTR
 14756                                  	call	STD_PRINTF	; Print size of file
 14757                                  NOFSIZ:
 14758                                  	;mov	ax,[DIRBUF_FDATE]  ; Get date
 14759                                  	;mov	ax,[DIRBUF+32]
 14760                                  	mov	ax,[DIRBUF+8+DIR_ENTRY.DIR_DATE]
 14761                                  	or	ax,ax
 14762                                  	jz	short NEXENT	; Skip if no date
 14763                                  	mov	di,CHARBUF
 14764                                  	push	ax
 14765                                  	mov	ax,'  '
 14766                                  	stosw
 14767                                  	pop	ax
 14768                                  	mov	bx,ax
 14769                                  	and	ax,1Fh		; Get day
 14770                                  	mov	dl,al
 14771                                  	mov	ax,bx
 14772                                  	mov	cl,5
 14773                                  	shr	ax,cl		; Align month
 14774                                  	and	al,0Fh		; Get month
 14775                                  	mov	dh,al
 14776                                  	mov	cl,bh
 14777                                  	shr	cl,1		; Align year
 14778                                  	xor	ch,ch
 14779                                  	add	cx,80		; Relative 1980
 14780                                  	cmp	cl,100
 14781                                  	jb	short MILLENIUM
 14782                                  	sub	cl,100
 14783                                  MILLENIUM:
 14784                                  	call	DATE_CXDX
 14785                                  	;mov	cx,[DIRBUF_FTIME]
 14786                                  	;mov	cx,[DIRBUF+30]
 14787                                  	mov	cx,[DIRBUF+8+DIR_ENTRY.DIR_TIME]
 14788                                  	jcxz	PRBUF		; Time field present?
 14789                                  	mov	ax,2020h
 14790                                  	stosw
 14791                                  	shr	cx,1
 14792                                  	shr	cx,1
 14793                                  	shr	cx,1
 14794                                  	shr	cl,1
 14795                                  	shr	cl,1		; Hours in CH, minutes in CL
 14796                                  	mov	bl,[TIME_24]
 14797                                  	or	bl,80h		; Tell P_TIME called from DIR
 14798                                  	call	P_TIME		; Don't care about DX, never used with DIR
 14799                                  PRBUF:
 14800                                  	xor	ax,ax
 14801                                  	stosb
 14802                                  	mov	dx,CHARBUF
 14803                                  	mov	[STRING_PTR_2],dx
 14804                                  	mov	dx,STRINGBUF2PTR
 14805                                  	call	STD_PRINTF
 14806                                  NEXENT:
 14807                                  	dec	byte [LINCNT]
 14808                                  	jnz	short SAMLIN
 14809                                  NEXLIN:
 14810                                  	mov	al,[LINLEN]
 14811                                  	mov	[LINCNT],al
 14812                                  	call	CRLF2
 14813                                  	dec	byte [LINPERPAG]
 14814                                  	jnz	short SCROLL
 14815                                  	;test	byte [_BITS],2
 14816                                  	test	byte [_BITS],SWITCHP ; P switch present?
 14817                                  	jz	short SCROLL	; If not, just continue
 14818                                  	mov	byte [LINPERPAG],23
 14819                                  	call	PAUSE
 14820                                  	jmp	short SCROLL
 14821                                  SAMLIN:
 14822                                  	mov	dx,TABPTR	; Output a tab
 14823                                  	call	STD_PRINTF
 14824                                  SCROLL:
 14825                                  	mov	ah,Dir_Search_Next ; 12h
 14826                                  	;mov	dx,55h
 14827                                  	mov	dx,FCB-7	; DX -> Unopened FCB
 14828                                  	int	21h	; DOS -	SEARCH NEXT USING FCB
 14829                                  			; DS:DX	-> FCB
 14830                                  			; Return: AL = status
 14831                                  	jmp	DIRSTART
 14832                                  CHKCNT:
 14833                                  	test	word [FILECNT],0FFFFh ; -1
 14834                                  	jnz	short TRAILER
 14835                                  	jmp	DIRNF
 14836                                  TRAILER:
 14837                                  	mov	al,[LINLEN]
 14838                                  	cmp	al,[LINCNT]
 14839                                  	jz	short MMESSAGE
 14840                                  	call	CRLF2
 14841                                  MMESSAGE:
 14842                                  	mov	dx,DIRMESPTR
 14843                                  	mov	si,[FILECNT]
 14844                                  	mov	[DIR_NUM],si
 14845                                  	call	STD_PRINTF
 14846                                  DTFREE:
 14847                                  	mov	ah,GET_DRIVE_FREESPACE ; 36h
 14848                                  	;mov	dl,[5Ch]
 14849                                  	mov	dl,[FCB]
 14850                                  	int	21h	; DOS -	2+ - GET DISK SPACE
 14851                                  			; DL = drive code (0 = default,	1 = A,2 = B,etc.)
 14852                                  	cmp	ax,-1
 14853                                  	jnz	short DTFREE1
 14854                                  DTRET:
 14855                                  	retn
 14856                                  DTFREE1:
 14857                                  	mul	cx
 14858                                  	mul	bx
 14859                                  	mov	[BYTES_FREE],ax
 14860                                  	mov	[BYTES_FREE+2],dx
 14861                                  	mov	dx,BYTEMESPTR
 14862                                  	jmp	STD_PRINTF
 14863                                  
 14864                                  ; =============== S U B	R O U T	I N E =======================================
 14865                                  
 14866                                  SHONAME:
 14867                                  DISPLAYNAME:
 14868                                  	; MSDOS 3.3
 14869                                  	mov	di,CHARBUF
 14870                                  	mov	cx,8
 14871                                  	rep	movsb
 14872                                  	mov	al,' '
 14873                                  	stosb
 14874                                  	mov	cx,3
 14875                                  	rep	movsb
 14876                                  	xor	ax,ax
 14877                                  	stosb
 14878                                  	push	dx
 14879                                  	mov	dx,CHARBUF
 14880                                  	mov	[STRING_PTR_2],dx
 14881                                  	mov	dx,STRINGBUF2PTR
 14882                                  	call	STD_PRINTF
 14883                                  	pop	dx
 14884                                  	retn
 14885                                  
 14886                                  %endif
 14887                                  
 14888                                  ;============================================================================
 14889                                  ; DIR.ASM, MSDOS 6.0, 1991
 14890                                  ;============================================================================
 14891                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14892                                  
 14893                                  	; MSDOS 6.0
 14894                                  %if 0
 14895                                  
 14896                                  ;***	DIR.ASM - DIR internal command
 14897                                  
 14898                                  comment	% =================================================================
 14899                                  
 14900                                  This module replaces TCMD1A.ASM.  The old module was titled 
 14901                                  "PART4 COMMAND Transient routines".
 14902                                  
 14903                                  From residual documentation, I surmise that TCMD.ASM originally
 14904                                  contained the internal commands DIR, PAUSE, ERASE, TYPE, VOL, and
 14905                                  VER.  The file seems to have been successively split:
 14906                                  
 14907                                    TCMD -> TCMD1,TCMD2 -> TCMD1A,TCMD1B,TCMD2A,TCMD2B
 14908                                  
 14909                                  TCMD1A.ASM contained only the DIR command.
 14910                                  
 14911                                  Usage:
 14912                                  ------
 14913                                  
 14914                                  DIR <filespec> /w /p /b /s /l /c /o<sortorder> /a<attriblist>
 14915                                  
 14916                                  DIR /?
 14917                                  
 14918                                  
 14919                                  <filespec> may include any or none of:  drive; directory path;
 14920                                             wildcarded filename.  If drive or directory path are
 14921                                  	   omitted, the current defaults are used.  If the
 14922                                  	   file name or extension is omitted, wildcards are
 14923                                  	   assumed.
 14924                                  
 14925                                  /w	Wide listing format.  Files are displayed in compressed
 14926                                  	'name.ext' format.  Subdirectory files are enclosed in
 14927                                  	brackets, '[dirname]'.
 14928                                  
 14929                                  /p	Paged, or prompted listing.  A screenful is displayed
 14930                                  	at a time.  The name of the directory being listed appears
 14931                                  	at the top of each page.
 14932                                  
 14933                                  	Bugbug:  pages nead to be uniform length..?
 14934                                  
 14935                                  /b	Bare listing format.  Turns off /w or /p.  Files are 
 14936                                  	listed in compressed 'name.ext' format, one per line,
 14937                                  	without additional information.  Good for making batch
 14938                                  	files or for piping.  When used with /s, complete
 14939                                  	pathnames are listed.
 14940                                  
 14941                                  /s	Descend subdirectory tree.  Performs command on current
 14942                                  	or specified directory, then for each subdirectory below
 14943                                  	that directory.  Directory header and footer is displayed
 14944                                  	for each directory where matching files are found, unless
 14945                                  	used with /b.  /b suppresses headers and footers.
 14946                                  
 14947                                  	Tree is explored depth first, alphabetically within the
 14948                                  	same level.
 14949                                  
 14950                                  	Bugbug:  hidden directories aren't searched.
 14951                                  
 14952                                  /l	Display file names, extensions and paths in lowercase.	;M010
 14953                                  
 14954                                  /c	Display file compression ratio, if the file is on a MagicDrv
 14955                                  	compressed volume.
 14956                                  
 14957                                  /o	Sort order.  /o alone sorts by default order (dirs-first, name,
 14958                                  	extension).  A sort order may be specified after /o.  Any of
 14959                                  	the following characters may be used: nedsgc (name, extension,
 14960                                  	date/time, size, group-dirs-first, compression ratio).	Placing
 14961                                  	a '-' before any letter causes a downward sort on that field.
 14962                                  	E.g., /oe-d means sort first by extension in alphabetical order,
 14963                                  	then within each extension sort by date and time in reverse
 14964                                  	chronological order.
 14965                                  
 14966                                  /a	Attribute selection.  Without /a, hidden and system files
 14967                                  	are suppressed from the listing.  With /a alone, all files
 14968                                  	are listed.  An attribute list may follow /a, consisting of
 14969                                  	any of the following characters:  hsdar (hidden, system,
 14970                                  	directory, archive, read-only).  A '-' before any letter
 14971                                  	means 'not' that attribute.  E.g., /ar-d means files that
 14972                                  	are marked read-only and are not directory files.  Note
 14973                                  	that hidden or system files may be included in the listing.
 14974                                  	They are suppressed without /a but are treated like any other
 14975                                  	attribute with /a.
 14976                                  
 14977                                  /?	Help listing.  Display DIR useage information.	;M008;Handled externally
 14978                                  
 14979                                  /h has been removed.					;M008
 14980                                  
 14981                                  DIRCMD	An environment variable named DIRCMD is parsed before the
 14982                                  	DIR command line.  Any command line options may be specified
 14983                                  	in DIRCMD, and become defaults.  /? will be ignored in DIRCMD.
 14984                                  	A filespec may be specified in DIRCMD and will be used unless
 14985                                  	a filespec is specified on the command line.  Any switch
 14986                                  	specified in DIRCMD may be overridden on the command line.
 14987                                  	If the original DIR default action is desired for a particular
 14988                                  	switch, the switch letter may be preceded by a '-' on the
 14989                                  	command line.  E.g.,
 14990                                  
 14991                                  	  /-w	use long listing format
 14992                                  	  /-p	don't page the listing
 14993                                  	  /-b	don't use bare format
 14994                                  	  /-s	don't descend subdirectory tree
 14995                                  	  /-o	display files in disk order
 14996                                  	  /-a	suppress hidden and system files
 14997                                  
 14998                                  Notes:
 14999                                  ------
 15000                                  
 15001                                  For sorted listings, file entries are loaded into the TPA buffer, which
 15002                                  is usually about 64K in size.  This allows sorts of up to 3000 files at
 15003                                  a time.  Each entry takes up 21 bytes in the buffer (see EntryStruc below).
 15004                                  The byte after the last entry is 0FFh.  The first byte of each entry is
 15005                                  a flag byte which is made zero when the entry is loaded, and made one
 15006                                  when the entry is used.
 15007                                  
 15008                                  Revision History
 15009                                  ================
 15010                                  M01	md	7/13/90 	Use ROM BIOS data area to obtain screen height
 15011                                  				in the absence of ANSI.SYS
 15012                                  
 15013                                  M007	sa	8/1/90		Allow /p/b combination
 15014                                  
 15015                                  M008	sa	8/1/90		Remove /h parameter.  Eliminate code used
 15016                                  				to internally handle /? message.
 15017                                  
 15018                                  M010	sa	8/5/90		Add support for /l (lowercase) option.
 15019                                  
 15020                                  M011	sa	8/5/90		Patch up bug where MS-DOS does not load the
 15021                                  				first FCB with the drive number when the drive
 15022                                  				letter in the command line is preceded by a
 15023                                  				switch.  Now dir manually loads the drive
 15024                                  				number after parsing.
 15025                                  
 15026                                  M018	md	8/12/90 	Increment the screen height by 1 when obtained
 15027                                  				from the ROM BIOS.
 15028                                  
 15029                                  M023	sa	8/31/90		Prevent DIR from failing if it encounters
 15030                                  				a subdirectory having len(pathname)>MAXPATH.
 15031                                  				Just skip over that subdirectory.
 15032                                  
 15033                                  M028	dbo	9/24/90		When country=US, sort by strict character
 15034                                  				byte value, rather than collating table.
 15035                                  				This to match MS-DOS Shell's sort order.
 15036                                  
 15037                                  ========================================================================= %
 15038                                  
 15039                                  %endif
 15040                                  
 15041                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM (PCDOS 7.1)
 15042                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM (MSDOS 6.22)
 15043                                  ;ifdef DBLSPACE_HOOKS
 15044                                  ;NUM_DIR_SWS	equ	16	; # of dir switch synonyms in Dir_Sw_Ptrs list
 15045                                  ; 28/07/2024 - PCDOS 7.1 COMMAND.COM
 15046                                  NUM_DIR_SWS	equ	18
 15047                                  ;else
 15048                                  ; 16/02/2023 - Retro DOS v4.0 (v4.1) COMMAND.COM (MSDOS 5.0)
 15049                                  ;NUM_DIR_SWS	equ	14	; # of dir switch synonyms in Dir_Sw_Ptrs list
 15050                                  ;endif
 15051                                  
 15052                                  ;OptionRec	record	inmem:1,lcase:1,bare:1,subd:1,pagd:1,wide:1
 15053                                  ;
 15054                                  ;		on/off bit record for /l, /b, /s, /p, /w, /c options
 15055                                  ;		(order is hard-coded; see OnOffSw)
 15056                                  ;		Inmem is set when entries are loaded in memory.
 15057                                  
 15058                                  ; 28/07/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
 15059                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM (MSDOS 5.0)
 15060                                  mask.wide  equ 1	; dir /W switch
 15061                                  mask.pagd  equ 2	; dir /P switch
 15062                                  mask.subd  equ 4	; dir /S switch
 15063                                  mask.bare  equ 8	; dir /B switch
 15064                                  mask.lcase equ 16	; dir /L switch	
 15065                                  ;mask.inmem equ 32	;
 15066                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15067                                  mask.narrow equ 32	; dir /Z switch
 15068                                  mask.year4 equ 64	; dir /4 switch	
 15069                                  mask.inmem equ 128	; 
 15070                                  
 15071                                  ; 28/07/2024
 15072                                  ; 05/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 15073                                  ;ifdef DBLSPACE_HOOKS
 15074                                  ;  OptionRec	record	inmem:1,lcase:1,bare:1,subd:1,pagd:1,wide:1,cratio:1
 15075                                  ;else
 15076                                  ;  OptionRec	record	inmem:1,lcase:1,bare:1,subd:1,pagd:1,wide:1
 15077                                  ;endif
 15078                                  ;mask.cratio equ 1
 15079                                  ;mask.wide   equ 2
 15080                                  ;mask.pagd   equ 4
 15081                                  ;mask.subd   equ 8
 15082                                  ;mask.bare   equ 16
 15083                                  ;mask.lcase  equ 32
 15084                                  ;mask.inmem  equ 64
 15085                                  ;
 15086                                  mask.dev    equ 1
 15087                                  mask.baddir equ 2	
 15088                                  
 15089                                  NUM_ATTR_LTRS	equ	6	; length of attribute letter list
 15090                                  
 15091                                  ; 05/06/2023
 15092                                  ;ifdef DBLSPACE_HOOKS
 15093                                  NUM_ORDER_LTRS	equ	6	; length of sort order letter list
 15094                                  CRATIO_ORDER	equ	6	; position of 'C' in ORDER_LTRS
 15095                                  ;else
 15096                                  ;NUM_ORDER_LTRS	equ	5	; length of sort order letter list
 15097                                  ;endif
 15098                                  
 15099                                  ;ResultBuffer	struc		; structure of parse result buffer
 15100                                  ;ValueType	db	?
 15101                                  ;ValueTag	db	?
 15102                                  ;SynPtr		dw	?
 15103                                  ;ValuePtr	dd	?
 15104                                  ;ResultBuffer	ends
 15105                                  
 15106                                  ;ErrorRec	record	baddir:1,dev:1
 15107                                  ;
 15108                                  ;		Error bits are:
 15109                                  ;		  Invalid directory format
 15110                                  ;		  File is device
 15111                                  
 15112                                  ;EntryStruc	struc			; our private directory entry structure
 15113                                  ;used		db	?		; =0 until entry used, then =1
 15114                                  ;filename	db	8 dup (?)	; filename
 15115                                  ;fileext	db	3 dup (?)	; extension
 15116                                  ;fileattr	db	?		; file attributes
 15117                                  ;filetime	dw	?		; file time
 15118                                  ;filedate	dw	?		; file date
 15119                                  ;filesize	dd	?		; file size
 15120                                  ; 05/06/2023
 15121                                  ;;ifdef DBLSPACE_HOOKS
 15122                                  ;compratio	db	?		; compression ratio
 15123                                  ;;endif
 15124                                  ;EntryStruc	ends
 15125                                  
 15126                                  ;shove	macro	val		; hose-bag 8086 doesn't push immediate
 15127                                  ;	mov	ax,val		; invisible, dangerous use of AX!
 15128                                  ;	push	ax
 15129                                  ;	endm
 15130                                  
 15131                                  ;	public	Catalog		; our entry point
 15132                                  ;
 15133                                  ;	break	<DIR (Catalog) principal routines>
 15134                                  ;
 15135                                  ;	assume	cs:TRANGROUP,ds:TRANGROUP,es:nothing,ss:TRANGROUP
 15136                                  ; ---------------------------------------------------------------------------
 15137                                  ;	Bugbug:	Each routine should start with it's own ASSUME.
 15138                                  
 15139                                  ;----------------------------------------------------------------------------
 15140                                  ;----------------------------------------------------------------------------
 15141                                  
 15142                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 15143                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:108Dh
 15144                                  
 15145                                  ;***	Catalog - DIR command main routine
 15146                                  ;
 15147                                  ;	ENTRY	FCB #1 in PSP has drive# from cmd-line or default
 15148                                  ;		Cmd-line tail text is at 81h, terminated by 0Dh
 15149                                  ;		CS, DS, ES, SS = TRANGROUP seg addr
 15150                                  ;		Tpa = TPA buffer seg addr
 15151                                  ;		BytCnt = # bytes in TPA buffer
 15152                                  ;
 15153                                  ;	EXIT	nothing
 15154                                  ;
 15155                                  ;	USED	AX,BX,CX,DX,SI,DI,BP
 15156                                  ;
 15157                                  ;	ERROR EXITS
 15158                                  ;
 15159                                  ;	  Errors are handled by setting up error message pointers
 15160                                  ;	   for Std_EPrintf and jumping to CError. Syntax errors in
 15161                                  ;	   the environment variable, however, are handled by printing
 15162                                  ;	   an error message and continuing.
 15163                                  ;
 15164                                  ;	EFFECTS
 15165                                  ;
 15166                                  ;	  Directory listing is displayed (on standard output).
 15167                                  ;	  APPEND is disabled. HeadFix routine is expected to
 15168                                  ;	   restore APPEND state.
 15169                                  ;	  Working directory may be changed. The user's default
 15170                                  ;	   directory is saved and flagged for restoration by RestUDir
 15171                                  ;	   during COMMAND cycle.
 15172                                  ;	  Lots of variables may be changed in TRANSPACE segment.
 15173                                  ;
 15174                                  ;	NOTES
 15175                                  ;
 15176                                  ;	  ES = TRANGROUP seg addr except when used to address the
 15177                                  ;	   the TPA buffer, where directory entries are loaded from disk.
 15178                                  
 15179                                  	; 16/02/2023
 15180                                  
 15181                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 15182                                  ; ----------------------------------------
 15183                                  ; MSDOS 6.22 COMMAND.COM - TRANGROUP:1167h
 15184                                  
 15185                                  ; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15186                                  ;----------------------------------------------------------------------------
 15187                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:11B7h
 15188                                  
 15189                                  CATALOG:
 15190                                  
 15191                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15192                                  %if 0
 15193                                  	; 07/06/2023
 15194                                  	; MSDOS 6.22 COMMAND COM feature only !
 15195                                  	call    screen_f_set	; set display parameters for video/text mode
 15196                                  	;			; (different depending on scr width/columns)
 15197                                  	call	SetDefaults
 15198                                  	call	ParseEnvironment
 15199                                  	call	ParseCmdLine
 15200                                  	jnc	short catalog1	; no parse error
 15201                                  	;jmp	catErr		; error msg is set up
 15202                                  	; 07/06/2023
 15203                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMANBD.COM
 15204                                  	jmp	catExtErr2
 15205                                  %else
 15206                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15207                                  	; PCDOS 7.1 COMMAND.COM
 15208 00001180 C606[2B9C]00            	mov	byte [nocommas],0
 15209 00001185 C606[2D9C]00            	mov	byte [bfree_not_kilo],0
 15210                                  				; use kilobyte if number of bytes is very big
 15211 0000118A 50                      	push	ax
 15212 0000118B 51                      	push	cx
 15213 0000118C 57                      	push	di
 15214 0000118D 56                      	push	si
 15215 0000118E 06                      	push	es
 15216 0000118F BE[0C93]                	mov	si,no_sep_text	; NO_SEP=1 ; Removes the commas from numbers
 15217 00001192 E82215                  	call	find_name_in_environment
 15218 00001195 720A                    	jb	short catalog0
 15219 00001197 C606[2D9C]FF            	mov	byte [bfree_not_kilo],0FFh 
 15220                                  				; no need to kilobyte (short) display
 15221 0000119C C606[2B9C]FF            	mov	byte [nocommas],0FFh
 15222                                  				; do not use commas for displaying numbers
 15223                                  catalog0:
 15224 000011A1 07                      	pop	es
 15225 000011A2 5E                      	pop	si
 15226 000011A3 5F                      	pop	di
 15227 000011A4 59                      	pop	cx
 15228 000011A5 58                      	pop	ax
 15229 000011A6 E8D000                  	call	SetDefaults
 15230 000011A9 E8F400                  	call	ParseEnvironment
 15231 000011AC E80C01                  	call	ParseCmdLine
 15232 000011AF 7303                    	jnc	short catalog1	; no parse error
 15233                                  	;jmp	catErr
 15234                                  	; 31/07/2024
 15235 000011B1 E9C200                  	jmp	catExtErr2
 15236                                  %endif
 15237                                   
 15238                                  catalog1:
 15239 000011B4 E83501                  	call	SetOptions
 15240 000011B7 E80B01                  	call	SetCollatingTable
 15241                                  
 15242                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15243                                  %if 1
 15244 000011BA C606[2A9C]00            	mov	byte [narrow],0
 15245                                  	;test	byte [_Bits],20h	; /Z switch (narrow)
 15246 000011BF F606[8B9D]20            	test	byte [_Bits],mask.narrow ; 20h
 15247 000011C4 740A                    	jz	short catalog1_1
 15248 000011C6 C606[2A9C]FF            	mov	byte [narrow],0FFh
 15249 000011CB C606[2B9C]FF            	mov	byte [nocommas],0FFh
 15250                                  catalog1_1:
 15251                                  	;test	byte [_Bits],40h	; /4 switch
 15252 000011D0 F606[8B9D]40            	test	byte [_Bits],mask.year4	; 40h
 15253 000011D5 7407                    	jz	short catalog1_2
 15254                                  	;mov	byte [cs:yeardigit4],0FFh ; 4 digits year
 15255                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15256 000011D7 C606[2C9C]FF            	mov	byte [yeardigit4],0FFh
 15257 000011DC EB05                    	jmp	short catalog1_3
 15258                                  catalog1_2:
 15259                                  	;mov	byte [cs:yeardigit4],0	; 2 digits year
 15260 000011DE C606[2C9C]00            	mov	byte [yeardigit4],0
 15261                                  catalog1_3:
 15262                                  %endif
 15263                                  
 15264                                  ;	Drive # to operate on has already been placed in FCB by
 15265                                  ;	COMMAND preprocessing. OkVolArg & PathCrunch depend on that.
 15266                                  
 15267                                  	;;;test	Bits,mask bare
 15268                                  	;;test 	word [_Bits],8
 15269                                  	;test	byte [_Bits],8
 15270                                  	; 07/06/2023
 15271 000011E3 F606[8B9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0 (6.22)
 15272                                  		; 31/07/2024 ; mask.bare = 8 ; PCDOS 7.1
 15273 000011E8 750A                    	jnz	short catalog2	; don't display volume info for /b
 15274                                  	;invoke	OkVolArg	; find & display volume info
 15275 000011EA E8CD0D                  	call	OkVolArg
 15276                                  	;sub	byte [LeftOnpage],2
 15277 000011ED 832E[1E9C]02            	sub	word [LeftOnPage],2
 15278                                  				; record display lines used by volume info
 15279 000011F2 EB14                    	jmp	short catCrunch
 15280                                  
 15281                                  ;	OkVolArg side effects:
 15282                                  ;	APPEND is disabled;
 15283                                  ;	DTA established at DirBuf;
 15284                                  ;	Filename fields in FCB are wildcarded.
 15285                                  
 15286                                  catalog2:
 15287                                  ;	OkVolArg wasn't executed, so we have to do these ourselves.
 15288                                  
 15289                                  	;invoke	DisAppend	; disable APPEND
 15290 000011F4 E88C0D                  	call	DisAppend
 15291                                  
 15292                                  	;mov	dx,offset TRANGROUP:DirBuf
 15293 000011F7 BA[399D]                	mov	dx,DIRBUF
 15294 000011FA B41A                    	mov	ah,1Ah
 15295                                  	;mov	ah,Set_DMA
 15296 000011FC CD21                    	int	21h		; set DTA
 15297                                  
 15298                                  	;mov	di,FCB	; 5Ch	; ES:DI = ptr to FCB
 15299                                  	;inc	di		; ES:DI = ptr to filename field of FCB
 15300                                  	; 28/07/2024
 15301 000011FE BF5D00                  	mov	di, FCB+1 ; 5Dh
 15302 00001201 B03F                    	mov	al,'?'		; AL = wildcard character
 15303 00001203 B90B00                  	mov	cx,11
 15304 00001206 F3AA                    	rep	stosb		; wildcard filename field
 15305                                  
 15306                                  catCrunch:
 15307 00001208 E83C01                  	call	CrunchPath	; crunch pathname to get directory and filename
 15308 0000120B 7233                    	jc	short catRecErr	; handle recorded or extended error
 15309                                  
 15310                                  ;	User's directory has been saved, we've changed to specified directory.
 15311                                  ;	ComSw = error bits for later use
 15312                                  ;	FCB contains parsed filename
 15313                                  
 15314                                  	;cmp	byte [COMSW],0
 15315 0000120D 833E[0B9C]00            	cmp	word [COMSW],0
 15316 00001212 752C                    	jne	short catRecErr	; handle recorded error
 15317                                  
 15318 00001214 E88A01                  	call	InstallCtrlC	; install control-C handler
 15319                                  
 15320                                  ; 31/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 15321                                  %if 0
 15322                                  	; 07/06/2023
 15323                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 15324                                  	; MSDOS 6.0 (DBLSPACE/DRVSPACE)
 15325                                  
 15326                                   	;test	word [_Bits],1	; mask.cratio
 15327                                  	test	byte [_Bits],mask.cratio ; compression ratio wanted?
 15328                                  	jz      short catalog4
 15329                                  	call    OpenCVF         ; yes, try to open CVF file
 15330                                  	jnc     short catalog4
 15331                                  
 15332                                  	;and	word [_Bits],0FFFEh ; not (mask cratio)
 15333                                  	and	byte [_Bits],~mask.cratio ; 0FEh
 15334                                  %endif
 15335                                  
 15336                                  catalog4:	; 07/06/2023
 15337 00001217 E8A10A                  	call	ZeroTotals	; zero grand totals
 15338 0000121A E8DD04                  	call	ListDir		; list main directory
 15339                                  	;jc	short catExtErr
 15340                                  	; 07/06/2023
 15341                                  	; MSDOS 6.22 COMMAND.COM
 15342 0000121D 7247                    	jc      short catExtErr1
 15343                                  
 15344                                  	;;;test	Bits,mask subd
 15345                                  	;;test	word [_Bits],4
 15346                                  	;test	byte [_Bits],4
 15347                                  	; 07/06/2023
 15348 0000121F F606[8B9D]04            	test	byte [_Bits],mask.subd ; 8 ; MSDOS 6.0 (6.22)
 15349                                  			; 31/07/2024   ; 4 ; PCDOS 7.1
 15350 00001224 7405                    	jz	short catalog3	; subdirectories option not set
 15351 00001226 E89001                  	call	ListSubds	; list subdirectories
 15352                                  	;jc	short catExtErr
 15353                                  	; 07/06/2023
 15354                                  	; MSDOS 6.22 COMMAND.COM
 15355 00001229 723B                    	jc      short catExtErr1
 15356                                  
 15357                                  catalog3:
 15358                                  ;	Check if any files were found.
 15359                                  
 15360                                  	;;;test	Bits,mask bare
 15361                                  	;;test	word [_Bits],8
 15362                                  	;test	byte [_Bits],8
 15363                                  	; 07/06/2023
 15364 0000122B F606[8B9D]08            	test	byte [_Bits],mask.bare ; 16 ; MSDOS 6.0 (6.22)
 15365                                  			; 31/07/2024   ; 8  ; PCDOS 7.1
 15366 00001230 750D                    	jnz	short catRet	; don't bother for bare format
 15367                                  
 15368                                  ; 31/07/2024
 15369                                  ; PCDOS 7.1 COMMAND.COM
 15370                                  %if 0
 15371                                  	mov	ax,[FileCntTotal]
 15372                                  	or	ax,ax
 15373                                  	jz	short catNoFiles ; no files found
 15374                                  %else
 15375 00001232 8B0E[5E9C]              	mov	cx,[FileCntTotal]
 15376 00001236 0B0E[609C]              	or	cx,[FileCntTotal+2]
 15377 0000123A E317                    	jcxz	catNoFiles	; no files found
 15378                                  %endif
 15379                                  
 15380 0000123C E8BA02                  	call	DisplayTotals	; display trailing grand totals
 15381                                  	;jmp	short catRet	; all done
 15382                                  	; 25/04/2023
 15383                                  	; 07/06/2023
 15384                                  catRet:
 15385                                  	;retn	; MSDOS 5.0 COMMAND.COM
 15386                                  	
 15387                                  ; 31/07/2024
 15388                                  ; PCDOS 7.1 COMMAND.COM
 15389                                  %if 0
 15390                                  	; 07/06/2023
 15391                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 15392                                  
 15393                                  	;test	word [_Bits],1	; mask.cratio
 15394                                  	test	byte [_Bits],mask.cratio
 15395                                  	jz      short catRetn
 15396                                  	call    CloseCVF
 15397                                  %endif
 15398                                  
 15399                                  catRetn:
 15400 0000123F C3                      	retn
 15401                                  
 15402                                  catRecErr:
 15403                                  
 15404                                  ;	ComSw may have error bit set. If not, do extended error.
 15405                                  
 15406                                  	;;;test	ComSw,mask dev
 15407                                  	;;test	word [COMSW],1
 15408                                  	;test	byte [COMSW],1
 15409 00001240 F606[0B9C]01            	test	byte [COMSW],mask.dev
 15410 00001245 750C                    	jnz	short catNoFiles 
 15411                                  				; filename is device, respond 'file not found'
 15412                                  	;;test	ComSw,mask baddir
 15413                                  	;;test	word [COMSW],2
 15414                                  	;test	byte [COMSW],2
 15415 00001247 F606[0B9C]02            	test	byte [COMSW],mask.baddir
 15416                                  	;jz	short catExtErr	; no ComSw error bits, must be extended error
 15417                                  	; 07/06/2023
 15418                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM 
 15419 0000124C 7418                    	jz	short catExtErr1
 15420                                  
 15421                                  	;mov	dx,offset TRANGROUP:BadCd_Ptr
 15422                                  				; invalid directory
 15423 0000124E BA[3791]                	mov	dx,badcd_ptr
 15424                                  	;jmp	short catErr
 15425                                  	; 07/06/2023
 15426                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 15427 00001251 EB23                    	jmp	short catExtErr2	
 15428                                  
 15429                                  catNoFiles:
 15430                                  
 15431                                  ;	Display header and force 'file not found' message.
 15432                                  
 15433 00001253 E8EF07                  	call	DisplayHeader
 15434 00001256 B80200                  	mov	ax,ERROR_FILE_NOT_FOUND ; 2
 15435 00001259 C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class ; 1
 15436 0000125E BA[D78F]                	mov	dx,extend_buf_ptr
 15437 00001261 A3[D78F]                	mov	[extend_buf_ptr],ax
 15438                                  	;jmp	short catErr
 15439                                  	; 07/06/2023
 15440                                  	; MSDOS 6.22 COMMAND.COM
 15441 00001264 EB10                    	jmp	short catExtErr2
 15442                                  
 15443                                  catExtErr:	; Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 15444                                  	; 07/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 15445                                  catExtErr1:
 15446                                  
 15447                                  ;	DOS has returned an error status. Get the extended error#, and
 15448                                  ;	set up an error message, changing 'No more files' error 
 15449                                  ;	to 'File not found' error.
 15450                                  
 15451 00001266 E8D20D                  	call	Set_Ext_Error_Msg
 15452 00001269 833E[D78F]12            	cmp	word [extend_buf_ptr],ERROR_NO_MORE_FILES ; 18
 15453                                  	;jne	short catalog4  ; catErr ; MSDOS 5.0 COMMAND.COM
 15454                                  	; 07/06/2023
 15455                                  	; MSDOS 6.22 COMMAND.COM
 15456 0000126E 7506                    	jne	short catExtErr2	
 15457                                  
 15458 00001270 C706[D78F]0200          	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND ; 2
 15459                                  
 15460                                  ;catalog4:	; Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 15461                                  	; 07/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 15462                                  catExtErr2:
 15463                                  
 15464                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15465                                  %if 0
 15466                                  	;test	word [_Bits],1	; mask.cratio
 15467                                  	test	byte [_Bits],mask.cratio
 15468                                  				; close Compressed Volume File if cratio
 15469                                  	jz      short catErr
 15470                                  	call    CloseCVF
 15471                                  %endif
 15472                                  
 15473                                  ;	Error exit. Error message information has been set up
 15474                                  ;	for Std_EPrintf.
 15475                                  
 15476                                  catErr:
 15477 00001276 E9AD1A                  	jmp	cerror		; go to COMMAND error recycle point
 15478                                  
 15479                                  	; 25/04/2023
 15480                                  ;catRet:
 15481                                  	;retn
 15482                                  
 15483                                  ; ---------------------------------------------------------------------------
 15484                                  
 15485                                  ;***	SetDefaults - set default pathname, options
 15486                                  ;
 15487                                  ;	ENTRY	DS = TRANGROUP seg addr
 15488                                  ;
 15489                                  ;	EXIT	nothing
 15490                                  ;
 15491                                  ;	USED	AX,DI
 15492                                  ;
 15493                                  ;	EFFECTS
 15494                                  ;	  SrcBuf = '*',EOL - default pathname
 15495                                  ;	  PathPos = ptr to pathname
 15496                                  ;	  PathCnt = length of pathname
 15497                                  
 15498                                  	; 16/02/2023
 15499                                  SetDefaults:
 15500 00001279 BF[219E]                	mov	di,SrcBuf		; DI = ptr to pathname buffer
 15501 0000127C 893E[8F9D]              	mov	[PathPos],di		; PathPos = ptr to pathname
 15502                                  	;mov	al,STAR
 15503 00001280 B02A                    	mov	al,'*'
 15504 00001282 AA                      	stosb
 15505                                  	;mov	al,END_OF_LINE_IN
 15506 00001283 B00D                    	mov	al,0Dh ; cr
 15507 00001285 AA                      	stosb				; SrcBuf = '*',0Dh
 15508 00001286 C706[8D9D]0100          	mov	word [PathCnt],1	; PathCnt = pathname length
 15509                                  
 15510 0000128C 31C0                    	xor	ax,ax			; AX = 0
 15511 0000128E A3[0B9C]                	mov	[COMSW],ax		; = no error
 15512 00001291 A3[8B9D]                	mov	[_Bits],ax		; = options off
 15513 00001294 A2[BE9D]                	mov	[DestBuf],al		; = no sort
 15514 00001297 C606[939D]06            	mov	byte [AttrSpecified],ATTR_HIDDEN+ATTR_SYSTEM ; 6
 15515 0000129C A2[949D]                	mov	[AttrSelect],al		; exclude hidden, system files
 15516                                  peRet:	; 25/04/2023
 15517 0000129F C3                      	retn
 15518                                  
 15519                                  ; ---------------------------------------------------------------------------
 15520                                  
 15521                                  ;***	ParseEnvironment - find and parse our environment variable
 15522                                  ;
 15523                                  ;	Find our environment variable and parse it. If a parse
 15524                                  ;	error occurs, issue an error message. The parse results
 15525                                  ;	up to the error will still have effect. Always leave
 15526                                  ;	the option variables in a useable state.
 15527                                  ;
 15528                                  ;	ENTRY	DS = TRANGROUP seg addr
 15529                                  ;
 15530                                  ;	EXIT	nothing
 15531                                  ;
 15532                                  ;	USED	AX,BX,CX,DX,SI,DI
 15533                                  ;
 15534                                  ;	EFFECTS
 15535                                  ;
 15536                                  ;	  Bits may contain new option settings.
 15537                                  ;	  DestBuf may contain new series of sort codes.
 15538                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 15539                                  ;	  SrcBuf may contain a new default pathname/filespec.
 15540                                  ;	  PathPos, PathCnt updated for new pathname.
 15541                                  ;
 15542                                  ;	  If a parse error occurred, an error message will be issued.
 15543                                  
 15544                                  	; 16/02/2023
 15545                                  ParseEnvironment:
 15546 000012A0 E80D04                  	call	GetEnvValue		; get environment variable value
 15547 000012A3 72FA                    	jc	short peRet		; name not found in environment
 15548                                  
 15549                                  ;	SI = ptr to value of environment variable, in TRANGROUP seg
 15550                                  
 15551 000012A5 E85E05                  	call	Parse_Line		; parse environment value
 15552 000012A8 83F8FF                  	cmp	ax,-1 ; 0FFFFh
 15553                                  	;cmp	ax,END_OF_LINE
 15554 000012AB 74F2                    	je	short peRet		; successful completion
 15555                                  
 15556                                  ;	Some kind of parse error occurred.
 15557                                  ;	We're set up for a Std_EPrintf call.
 15558                                  
 15559 000012AD E87041                  	call	std_eprintf		; display the parse error
 15560                                  	;mov	byte [Msg_Disp_Class],util_msg_class ; -1
 15561                                  					; restore default msg class
 15562 000012B0 C606[D58F]FF            	mov	byte [msg_disp_class],0FFh ; -1
 15563                                  	;mov	dx,offset TRANGROUP:ErrParsEnv_Ptr
 15564 000012B5 BA[9292]                	mov	dx,errparsenv_ptr
 15565                                  	;;invoke Printf_Crlf		; "(Error occurred in environment.."
 15566                                  	;call	Printf_Crlf
 15567                                  	; 25/04/2023
 15568                                  	;retn
 15569 000012B8 E95F41                  	jmp	Printf_Crlf
 15570                                  					;M008;Internal handling of /? removed
 15571                                  ;peOk:	and	Bits,not mask help	; disallow /h in environment variable
 15572                                  	; 25/04/2023
 15573                                  ;peRet:
 15574                                  	;retn
 15575                                  
 15576                                  ; ---------------------------------------------------------------------------
 15577                                  
 15578                                  ;***	ParseCmdLine - parse and record command line parameters
 15579                                  ;
 15580                                  ;	ENTRY	PSP offset 81h is beginning of cmd line buffer
 15581                                  ;		DS, ES, CS = TRANGROUP seg addr
 15582                                  ;
 15583                                  ;	EXIT	CY = set if parse error occurred
 15584                                  ;
 15585                                  ;		If parse error occurred, we're set up for Std_EPrintf call:
 15586                                  ;		AX = system parser error code
 15587                                  ;		DX = ptr to message block
 15588                                  ;
 15589                                  ;	USED	AX,BX,CX,DX,SI,DI
 15590                                  ;
 15591                                  ;	EFFECTS
 15592                                  ;
 15593                                  ;	  Bits may contain new option settings.
 15594                                  ;	  DestBuf may contain new series of sort codes.
 15595                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 15596                                  ;	  SrcBuf may contain a new default pathname/filespec.
 15597                                  ;	  PathPos, PathCnt updated for new pathname.
 15598                                  ;
 15599                                  ;	  If parse error occurred, we're set up for Std_EPrintf call:
 15600                                  ;	  Msg_Disp_Class = parse error class
 15601                                  ;	  Byte after last parameter in text is zeroed to make ASCIIZ string
 15602                                  ;	  Message block (see DX) is set up for parse error message
 15603                                  
 15604                                  	; 16/02/2023
 15605                                  ParseCmdLine:
 15606 000012BB BE8100                  	mov	si,81h			; SI = ptr to cmd-line tail text
 15607 000012BE E84505                  	call	Parse_Line		; parse cmd line tail
 15608 000012C1 83F8FF                  	cmp	ax,-1 ; 0FFFFh
 15609                                  	;;cmp	ax,END_OF_LINE
 15610                                  	; 25/04/2023
 15611                                  	;je	short pcOk		; parse completed successfully
 15612                                  
 15613                                  ;	A parse error occurred. We're all set up for message output.
 15614                                  
 15615                                  	; 25/04/2023
 15616                                  	; cf = 1 (ax < 0FFFFh)
 15617                                  	;stc		   		; return failure
 15618                                  	;jmp	short pcRet
 15619                                  	; 25/04/2023
 15620                                  	;retn
 15621                                  pcOk:
 15622                                  	; 25/04/2023
 15623                                  	;cf = 0 (ax = 0FFFFh)
 15624                                  	;clc				; return success
 15625                                  pcRet:
 15626 000012C4 C3                      	retn
 15627                                  
 15628                                  ; ---------------------------------------------------------------------------
 15629                                  
 15630                                  ;***	SetCollatingTable - set up character collating table for sorting
 15631                                  ;
 15632                                  ;	If country is other than USA, try to get a collating table
 15633                                  ;	for character sorting. For USA, use straight byte values.
 15634                                  ;	This is so DIR behaves like the MS-DOS Shell, which sorts
 15635                                  ;	by straight byte values in the USA for better performance.
 15636                                  ;
 15637                                  ;	ENTRY	ES = TRANGROUP seg addr
 15638                                  ;
 15639                                  ;	EXIT	nothing
 15640                                  ;
 15641                                  ;	USED	AX,BX,CX,DX,DI
 15642                                  ;
 15643                                  ;	EFFECTS
 15644                                  ;
 15645                                  ;	  If collating table is set -
 15646                                  ;	    CountryPtrId = 6.
 15647                                  ;	    CountryPtr points to collating table.
 15648                                  ;
 15649                                  ;	  Otherwise -
 15650                                  ;	    CountryPtrId = 0.
 15651                                  
 15652                                  SetCollatingTable:
 15653                                  
 15654                                  ;	Begin modification M028
 15655                                  
 15656                                  	;mov	dx,offset TRANGROUP:InternatVars
 15657                                  	;			; DS:DX = ptr to international info buffer
 15658 000012C5 BA[9EA5]                	mov	dx,INTERNATVARS
 15659 000012C8 B80038                  	mov	ax,3800h
 15660                                  	;mov	ax,INTERNATIONAL << 8
 15661                                  	;;mov	ax,INTERNATIONAL shl 8
 15662                                  				; AX = 'Get current country info'
 15663 000012CB CD21                    	int	21h		; call DOS
 15664 000012CD 7217                    	jc	short scNoTable	; error - so don't collate
 15665                                  
 15666                                  ;	BX = country code
 15667                                  
 15668 000012CF 83FB01                  	cmp	bx,1
 15669 000012D2 7412                    	je	short scNoTable	; we're in USA, don't collate
 15670                                  
 15671                                  ;	End modification M028
 15672                                  
 15673                                  ;*	Country code is other than USA. Try to get a collating table.
 15674                                  
 15675 000012D4 B80665                  	mov	ax,6506h
 15676                                  	;mov	ax,(GETEXTCNTRY << 8) + SETCOLLATE
 15677                                  	;;mov	ax,(GETEXTCNTRY shl 8) + SETCOLLATE
 15678                                  				; AH = 'Get Extended Country Info'
 15679                                  				; AL = 'Get Pointer to Collating Table'
 15680 000012D7 BBFFFF                  	mov	bx,-1		; BX = code page of interest = CON
 15681 000012DA B90500                  	mov	cx,5		; CX = length of info buffer
 15682 000012DD 89DA                    	mov	dx,bx		; DX = country ID = default
 15683                                  	;mov	di,offset TRANGROUP:CountryPtrInfo
 15684 000012DF BF[BEA5]                	mov	di,CountryPtrInfo
 15685                                  				; ES:DI = ptr to info buffer
 15686 000012E2 CD21                    	int	21h		; call DOS
 15687 000012E4 7305                    	jnc	short scRet	; success
 15688                                  
 15689                                  ;*	Set CountryPtrId = 0 to signal no collating table.
 15690                                  
 15691                                  scNoTable:			;M028
 15692 000012E6 C606[BEA5]00            	mov	byte [CountryPtrId],0
 15693                                  scRet:
 15694 000012EB C3                      	retn
 15695                                  
 15696                                  ; ---------------------------------------------------------------------------
 15697                                  
 15698                                  ;***	SetOptions - check and set options
 15699                                  ;
 15700                                  ;	ENTRY	nothing
 15701                                  ;
 15702                                  ;	EXIT	nothing
 15703                                  ;
 15704                                  ;	USED	AX,BX,CX,DX
 15705                                  ;
 15706                                  ;	EFFECTS
 15707                                  ;
 15708                                  ;	  Bits may contain modified option settings.
 15709                                  ;	  Display_Ioctl table, including LinPerPag variable, is filled in.
 15710                                  ;	  LeftOnPage is initialized to # lines till end of page is handled.
 15711                                  ;	  PerLine is set according to /w presence.
 15712                                  
 15713                                  	; 16/02/2023
 15714                                  
 15715                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 15716                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:12BEh
 15717                                  
 15718                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15719                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1335h
 15720                                  
 15721                                  SetOptions:
 15722                                  
 15723                                  ;	If bare listing requested, cancel wide listings.
 15724                                  
 15725                                  	;;;test	Bits,mask bare
 15726                                  	;;test	word [_Bits],8
 15727                                  	;test	byte [_Bits],8
 15728                                  	; 07/06/2023
 15729 000012EC F606[8B9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0
 15730                                  		; 31/07/2024 ; mask.bare = 8 ; PCDOS 7.1
 15731 000012F1 7405                    	jz	short setopts1
 15732                                  	;;;and	Bits,not mask wide	;M007;Allow /p with /b
 15733                                  	;;and	word [_Bits],0FFFEh
 15734                                  	;;and	byte [_Bits],0FEh
 15735                                  	; 31/07/2024
 15736                                  	;and	word [_Bits],0FFFEh ; PCDOS 7.1 COMMAND.COM
 15737                                  	; 07/06/2023
 15738 000012F3 8026[8B9D]FE            	and	byte [_Bits],~mask.wide ; 0FDh ; MSDOS 6.0
 15739                                  			; 31/07/2024	; 0FEh ; PCDOS 7.1 	
 15740                                  
 15741                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15742                                  %if 0
 15743                                  ;setopts1:	; MSDOS 5.0 COMMAND.COM
 15744                                  	; 07/06/2023
 15745                                   	; MSDOS 6.22 COMMAND.COM
 15746                                  setopts0:
 15747                                  	;test	word [_Bits],12h  ; (mask bare) or (mask wide)
 15748                                  	test	byte [_Bits],(mask.bare|mask.wide)
 15749                                  	jz      short setopts1
 15750                                  	;and 	word [_Bits],0FFFEh ; not mask cratio
 15751                                  	and	byte [_Bits],~mask.cratio
 15752                                  %endif
 15753                                  
 15754                                  setopts1:
 15755                                  ;	Set # lines per display page.
 15756                                  
 15757                                  ;M01  Obtain screen height from ROM BIOS data area
 15758                                  ;
 15759                                  ;M01	mov	LinPerPag,LINESPERPAGE	; default value
 15760                                  
 15761 000012F8 1E                      	push	ds
 15762                                  	;mov	ax,ROMBIOS_DATA 	; Get ROM Data segment
 15763 000012F9 B84000                  	mov	ax,40h
 15764 000012FC 8ED8                    	mov	ds,ax			;
 15765                                  	;Assume	DS:ROMBIOS_DATA
 15766                                  
 15767                                  	;mov	al,[CRT_Rows] ; [84h]	; Get max rows
 15768 000012FE A08400                  	mov	al,[84h]
 15769 00001301 1F                      	pop	ds			;
 15770                                  	;Assume	DS:Trangroup
 15771                                  
 15772 00001302 08C0                    	or	al,al			; If zero specified
 15773 00001304 7502                    	jnz	short setopts2		;
 15774                                  
 15775                                  	;mov	al,LINESPERPAGE 	; assume 24 rows
 15776 00001306 B019                    	mov	al,25	; MSDOS 5.0 COMMAND.COM (TRANGROUP:11D1h)
 15777                                  setopts2:
 15778 00001308 30E4                    	xor	ah,ah
 15779                                  setopts3:
 15780 0000130A FEC0                    	inc	al			; height + 1 ;M018
 15781                                  
 15782 0000130C A3[179F]                	mov	[LinPerPag],ax		; set the rows now
 15783                                  
 15784                                  ; Now the console driver can change the rows if it knows better (M01 end)
 15785                                  
 15786                                  	;mov	ax,(IOCTL shl 8)+GENERIC_IOCTL_HANDLE
 15787                                  					; IOCTL for handles
 15788 0000130F B80C44                  	mov	ax,440Ch
 15789                                  	;mov	bx,STDOUT		; handle #
 15790 00001312 BB0100                  	mov	bx,1
 15791                                  	;mov	ch,IOC_SC		; screen
 15792 00001315 B503                    	mov	ch,3
 15793                                  	;mov	cl,get_generic		; get display info
 15794 00001317 B17F                    	mov	cl,7Fh
 15795 00001319 BA[079F]                	mov	dx,Display_Ioctl	; info block
 15796 0000131C CD21                    	int	21h			; call DOS
 15797                                  
 15798 0000131E A1[179F]                	mov	ax,[LinPerPag]		; AX = # lines per page
 15799 00001321 A3[1E9C]                	mov	[LeftOnPage],ax		; initialize # lines left on page
 15800                                  
 15801                                  ;	Set # entries per line.
 15802                                  
 15803                                  	;mov	byte [PerLine],NORMPERLIN
 15804                                  					; # entries per line without /w
 15805 00001324 C606[1D9C]01            	mov	byte [PerLine],1
 15806                                  	;;;test	Bits,mask wide
 15807                                  	;;test	word [_Bits],1
 15808                                  	;test	byte [_Bits],1
 15809                                  	; 07/06/2023
 15810 00001329 F606[8B9D]01            	test	byte [_Bits],mask.wide ; 2 ; MSDOS 6.0
 15811                                  			; 31/07/2024   ; 1 ; PCDOS 7.1
 15812 0000132E 7405                    	jz	short setopts4
 15813                                  	;mov	byte [PerLine],WIDEPERLIN
 15814                                  					; # entries per line with /w
 15815 00001330 C606[1D9C]05            	mov	byte [PerLine],5
 15816                                  setopts4:
 15817                                  				;M011;start;The following code checks if a drive
 15818                                  				;letter has been parsed into SrcBuf, and if
 15819                                  				;so, the correct drive number is loaded into
 15820                                  				;the first FCB, at offset 5C.
 15821                                  
 15822                                  	;cmp	TRANGROUP:[SrcBuf+1],COLON_CHAR	; is this a drive letter?
 15823 00001335 803E[229E]3A            	cmp	byte [SrcBuf+1],':'
 15824 0000133A 750A                    	jne	short soRet
 15825                                  	;mov	al,TRANGROUP:[SrcBuf]		; load drive letter into al
 15826 0000133C A0[219E]                	mov	al,[SrcBuf]
 15827                                  	;and	al,not 20h			; capitalize ASCII drive letter (LowerCase-32)-->UpperCase
 15828 0000133F 24DF                    	and	al,0DFh ; ~20h ; not 20h
 15829 00001341 2C40                    	sub	al,'@'	; 40h			; convert to 1-based number (1=A)
 15830 00001343 A25C00                  	mov	[FCB],al  ; [5Ch]		; store in first FCB
 15831                                  						;M011;end
 15832                                  soRet:
 15833 00001346 C3                      	retn
 15834                                  
 15835                                  ; ---------------------------------------------------------------------------
 15836                                  
 15837                                  ;***	CrunchPath - analyze supplied or default pathname
 15838                                  ;
 15839                                  ;	ENTRY	PathPos = ptr to pathname buffer
 15840                                  ;		PathCnt = length of pathname, not incl trailing delimiter
 15841                                  ;		Pathname in buffer must end in delimiter (like CR) and
 15842                                  ;		 must have space for another char after the delimiter.
 15843                                  ;
 15844                                  ;	EXIT	CY = clear if no error
 15845                                  ;		We are changed to directory found in pathname
 15846                                  ;		Previous directory ready to be restored via RestUDir
 15847                                  ;		FCB filename fields contain filename (possibly w/ wildcards)
 15848                                  ;
 15849                                  ;		If error occurred,
 15850                                  ;		CY = set
 15851                                  ;		ComSw = error bits (see ErrorRec)
 15852                                  ;		If ComSw not set,
 15853                                  ;		Ready for DOS Get Extended Error call
 15854                                  
 15855                                  	; 16/02/2023
 15856                                  CrunchPath:
 15857 00001347 E87802                  	call	FileIsDevice
 15858 0000134A 7507                    	jne	short crpath1	; not a device, skip ahead
 15859                                  	;;;or	ComSw,mask dev	; signal file is device
 15860                                  	;;or	word [COMSW],1
 15861                                  	;or	byte [COMSW],1
 15862 0000134C 800E[0B9C]01            	or	byte [COMSW],mask.dev
 15863 00001351 EB2F                    	jmp	short cpErr	; return error
 15864                                  crpath1:
 15865 00001353 FF36[8F9D]              	push	word [PathPos]	; save ptr to pathname
 15866 00001357 C606[979D]FF            	mov	byte [DirFlag],-1
 15867                                  				; tell PathCrunch not to parse file into FCB
 15868 0000135C E8C316                  	call	PathCrunch	; change to directory in pathname
 15869 0000135F C606[979D]00            	mov	byte [DirFlag],0
 15870                                  				; reset our little flag
 15871 00001364 5E                      	pop	si		; SI = ptr to pathname
 15872 00001365 7208                    	jc	short cpNoDir	; didn't find directory path
 15873 00001367 741A                    	jz	short cpRet	; found directory path w/ no filename
 15874                                  				;  - leave wildcard default in FCB and return
 15875                                  
 15876                                  ;*	We found a directory, and there was a filename attached.
 15877                                  ;	DestTail = ptr to ASCIIZ filename
 15878                                  
 15879 00001369 8B36[BB9D]              	mov	si,[DestTail]	; SI = ptr to filename
 15880 0000136D EB28                    	jmp	short cpFile	; go parse the file into FCB
 15881                                  
 15882                                  ;*	PathCrunch failed to find a directory in the pathname.
 15883                                  ;
 15884                                  ;	Msg_Numb = error code
 15885                                  ;	DestIsDir = nonzero if path delimiter char's occur in pathname
 15886                                  ;	SI = ptr to pathname (now an ASCIIZ string)
 15887                                  
 15888                                  cpNoDir:
 15889 0000136F A1[349F]                	mov	ax,[Msg_Numb]	  ; AX = error code from PathCrunch
 15890 00001372 09C0                    	or	ax,ax
 15891 00001374 750C                    	jnz	short cpErr	  ; error occurred - return it
 15892 00001376 803E[B99D]00            	cmp	byte [DestIsDir],0
 15893 0000137B 7407                    	je	short cpMaybe	  ; no path delimiters seen, maybe it's a file
 15894                                  crpath3:
 15895                                  	;;;or	ComSw,mask baddir ; signal invalid directory name
 15896                                  	;;or	word [COMSW],2
 15897                                  	;or	byte [COMSW],2
 15898 0000137D 800E[0B9C]02            	or	byte [COMSW],mask.baddir
 15899                                  	;jmp	short cpErr	  ; return error
 15900                                  	; 16/02/2023
 15901                                  cpErr:
 15902 00001382 F9                      	stc			  ; return error
 15903                                  cpRet:
 15904 00001383 C3                      	retn
 15905                                  
 15906                                  cpMaybe:
 15907                                  ;	SI = ptr to pathname
 15908                                  
 15909                                  	;cmp	byte [si+1],COLON_CHAR
 15910 00001384 807C013A                	cmp	byte [si+1],':'
 15911 00001388 7501                    	jne	short crpath2	  ; no drive specifier, skip ahead
 15912 0000138A AD                      	lodsw			  ; SI = ptr past drive specifier "d:"
 15913                                  crpath2:
 15914 0000138B 813C2E2E                	cmp	word [si],".."	; 2E2Eh
 15915 0000138F 7506                    	jne	short cpFile	  ; if not "..", treat as a file
 15916 00001391 807C0200                	cmp	byte [si+2],0
 15917                                  	;jne	short cpFile	  ; or if there's more after "..", treat as file
 15918                                  	;;;;or	ComSw,mask baddir ; signal invalid directory
 15919                                  	;;;or	word [COMSW],2
 15920                                  	;;or	byte [COMSW],2
 15921                                  	;or	byte [COMSW],mask.baddir
 15922                                  	;jmp	short cpErr	  ; return error
 15923                                  	; 16/02/2023
 15924 00001395 74E6                    	je	short crpath3
 15925                                  
 15926                                  ;	The preceding code was taken from the old DIR routine.
 15927                                  ;	It's garbage, I'm afraid. It's meant to check for ".."
 15928                                  ;	occurring when we're at the root directory. Too bad it
 15929                                  ;	doesn't handle problems with "..\..", etc.
 15930                                  
 15931                                  ;	We're ready to parse a filename into the FCB.
 15932                                  ;	SI = ptr to ASCIIZ filename
 15933                                  
 15934                                  cpFile:	
 15935 00001397 BF5C00                  	mov	di,FCB	; 5Ch	; DI = ptr to FCB
 15936 0000139A B80E29                  	mov	ax,290Eh
 15937                                  	;mov	ax,(Parse_File_Descriptor<<8)|0Eh
 15938                                  	;;mov	ax,(Parse_File_Descriptor shl 8) or 0Eh
 15939                                  				; wildcards already in FCB used as defaults
 15940 0000139D CD21                    	int	21h
 15941 0000139F F8                      	clc			; return success
 15942                                  	;jmp	short cpRet
 15943                                  	; 16/02/2023
 15944 000013A0 C3                      	retn
 15945                                  
 15946                                  ;cpErr:
 15947                                  ;	stc			; return error
 15948                                  ;cpRet:
 15949                                  ;	retn
 15950                                  
 15951                                  ; ---------------------------------------------------------------------------
 15952                                  
 15953                                  ;***	InstallCtrlC - install our private control-C handler
 15954                                  ;
 15955                                  ;	Put our control-c handler in front of command.com's default
 15956                                  ;	handler, to make sure the user's default directory gets restored.
 15957                                  ;	This shouldn't be necessary, but, for now, there are situations
 15958                                  ;	where the TDATA segment is left in a modified state when a
 15959                                  ;	control-c occurs.  This means that the transient will be
 15960                                  ;	reloaded, and the user's directory cannot be restored.
 15961                                  ;
 15962                                  ;	Bugbug:  fix the wider problem?  Involves message services.  Ugly.
 15963                                  ;
 15964                                  ;	ENTRY	nothing
 15965                                  ;
 15966                                  ;	EXIT	nothing
 15967                                  ;
 15968                                  ;	USED	AX,BX,DX
 15969                                  ;
 15970                                  ;	EFFECTS
 15971                                  ;
 15972                                  ;	  CtrlCHandler address placed in int 23 vector.
 15973                                  ;
 15974                                  ;	NOTE
 15975                                  ;
 15976                                  ;	  Command.com's basic control-c handler will be restored
 15977                                  ;	  to the int 23 vector by the HeadFix routine, after DIR finishes.
 15978                                  
 15979                                  	; 16/02/2023
 15980                                  InstallCtrlC:
 15981 000013A1 06                      	push	es			; preserve ES
 15982 000013A2 B82335                  	mov	ax,3523h
 15983                                  	;mov	ax,(GET_INTERRUPT_VECTOR<<8)+23h
 15984                                  	;;mov	ax,(GET_INTERRUPT_VECTOR shl 8) + 23h
 15985 000013A5 CD21                    	int	21h
 15986 000013A7 891E[C3A5]              	mov	[OldCtrlCHandler],bx	; save old int 23 vector
 15987 000013AB 8C06[C5A5]              	mov	[OldCtrlCHandler+2],es	 
 15988 000013AF 07                      	pop	es			; restore ES
 15989                                  
 15990 000013B0 BA[C61C]                	mov	dx,CtrlCHandler 	; DS:DX = ptr to CtrlCHandler
 15991 000013B3 B82325                  	mov	ax,2523h
 15992                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8)+23h
 15993                                  	;;mov	ax,(SET_INTERRUPT_VECTOR shl 8) + 23h
 15994 000013B6 CD21                    	int	21h
 15995 000013B8 C3                      	retn
 15996                                  
 15997                                  ; ---------------------------------------------------------------------------
 15998                                  
 15999                                  ;***	ListSubds - search and list files in subdirectories
 16000                                  ;
 16001                                  ;	ENTRY	Current directory (on selected drive) is top of subdir tree
 16002                                  ;		FCB is still set up for file searches
 16003                                  ;		Bits, AttrSpecified, AttrSelect, DestBuf all still set up
 16004                                  ;
 16005                                  ;	EXIT	CY = clear if no error
 16006                                  ;		FileCnt = # files found & displayed
 16007                                  ;		FileSiz = total size of files found
 16008                                  ;
 16009                                  ;		If error,
 16010                                  ;		CY = set
 16011                                  ;		Ready for DOS Get Extended Error call
 16012                                  ;
 16013                                  ;	USED	AX,BX,CX,DX,SI,DI,BP
 16014                                  ;
 16015                                  ;	EFFECTS
 16016                                  ;
 16017                                  ;	  FileCntTotal, FileSizTotal are updated.
 16018                                  ;	  Subdirectories may be listed on standard output device.
 16019                                  ;
 16020                                  ;	NOTES
 16021                                  ;
 16022                                  ;	  ListSubds seeds the recursive entry point lsNode with a ptr
 16023                                  ;	   to a buffer where we'll stack up subdirectory filenames.
 16024                                  ;	   Each name is stored ASCIIZ.
 16025                                  
 16026                                  	; 16/02/2023
 16027                                  ListSubds:
 16028                                  	;invoke	SetRest1		; make sure user's dir gets restored
 16029 000013B9 E8581D                  	call	SetRest1
 16030                                  
 16031 000013BC BB[7B9E]                	mov	bx,ScanBuf   		; BX = ptr to child name buffer
 16032                                  lsNode:
 16033 000013BF C60700                  	mov	byte [bx],0		; start with null child name
 16034                                  lsLoop:
 16035 000013C2 E88702                  	call	FindNextChild		; search for next subdirectory
 16036 000013C5 7235                    	jc	short lsErr		; search failed - examine error
 16037                                  
 16038 000013C7 89DA                    	mov	dx,bx			; DX = ptr to child's name
 16039 000013C9 E8ED04                  	call	ChangeDir		; enter child directory
 16040                                  
 16041                                  					; M023;start
 16042 000013CC 7306                    	jnc	short lstsd1		; check for error
 16043                                  	;cmp	ax,3
 16044 000013CE 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND	; error due to len(pathname)>MAXPATH?
 16045 000013D1 74EF                    	je	short lsLoop		; yes, skip over this subdirectory
 16046                                  	;jmp	short lsRet		; no, other error: DIR must fail
 16047                                  	; 16/02/2023			; M023;end
 16048 000013D3 C3                      	retn
 16049                                  lstsd1:	
 16050 000013D4 53                      	push	bx
 16051 000013D5 E82203                  	call	ListDir			; list the directory
 16052 000013D8 5B                      	pop	bx
 16053                                  
 16054                                  ;	Note we're ignoring errors returned here.
 16055                                  
 16056 000013D9 89DF                    	mov	di,bx			; DI = ptr to child's name
 16057 000013DB B90D00                  	mov	cx,13			; CX = max name length w/ null
 16058 000013DE 30C0                    	xor	al,al			; AL = zero byte to look for
 16059 000013E0 F2AE                    	repne	scasb			; DI = ptr to next name pos'n in buf
 16060 000013E2 53                      	push	bx			; save ptr to child's name
 16061 000013E3 89FB                    	mov	bx,di			; BX = ptr to next name pos'n in buf
 16062 000013E5 E8D7FF                  	call	lsNode			; recurse from new node
 16063 000013E8 5B                      	pop	bx			; BX = ptr to child's name
 16064 000013E9 9C                      	pushf				; save error condition
 16065                                  	
 16066                                  	;;shove	0
 16067                                  	;mov	ax,0
 16068 000013EA 29C0                    	sub	ax,ax ; 0
 16069 000013EC 50                      	push	ax
 16070                                  	;shove	".."
 16071 000013ED B82E2E                  	mov	ax,'..'  ; 2E2Eh
 16072 000013F0 50                      	push	ax
 16073 000013F1 89E2                    	mov	dx,sp			; DX = ptr to "..",0 on stack
 16074 000013F3 E8C304                  	call	ChangeDir		; return to parent directory
 16075 000013F6 58                      	pop	ax			; restore stack
 16076 000013F7 58                      	pop	ax
 16077                                  
 16078 000013F8 9D                      	popf				; restore error condition from child
 16079                                  	;jc	short lsRet		; return error
 16080                                  	;jmp	short lsLoop		; look for more children
 16081                                  	; 16/02/2023
 16082 000013F9 73C7                    	jnc	short lsLoop
 16083 000013FB C3                      	retn
 16084                                  lsErr:
 16085 000013FC E84C0C                  	call	get_ext_error_number	; AX = extended error code
 16086                                  	;cmp	ax,2
 16087 000013FF 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND
 16088 00001402 7406                    	je	short lsRet		; file not found, we're ok
 16089                                  	;cmp	ax,18
 16090 00001404 83F812                  	cmp	ax,ERROR_NO_MORE_FILES
 16091 00001407 7401                    	je	short lsRet		; no more files, we're ok
 16092 00001409 F9                      	stc				; return other errors
 16093                                  lsRet:	
 16094 0000140A C3                      	retn
 16095                                  
 16096                                  ; ---------------------------------------------------------------------------
 16097                                  
 16098                                  	;break	<DIR support routines>
 16099                                  
 16100                                  ;***	SUPPORT ROUTINES
 16101                                  
 16102                                  ; ----------------------
 16103                                  
 16104                                  ;***	CheckChild - check potential subdirectory name for FindNextChild
 16105                                  ;
 16106                                  ;	ENTRY	DirBuf contains DOS Find-buffer with potential child
 16107                                  ;		BX = ptr to last child's name
 16108                                  ;		BP = ptr to temp child's name
 16109                                  ;
 16110                                  ;	EXIT	nothing
 16111                                  ;
 16112                                  ;	USED	AX,CX,SI,DI
 16113                                  ;
 16114                                  ;	EFFECTS
 16115                                  ;
 16116                                  ;	  Filename pointed to by BP may be changed.
 16117                                  ;
 16118                                  ;	NOTES
 16119                                  ;
 16120                                  ;	  Potential filename replaces temp filename if:
 16121                                  ;	   it's a subdirectory file;
 16122                                  ;	   it doesn't start with a '.';
 16123                                  ;	   it's alphanumerically greater than last child's name;
 16124                                  ;	   and it's alphanumerically less than temp name.
 16125                                  
 16126                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16127                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16128                                  CheckChild:
 16129                                  	;test	DirBuf.find_buf_attr,ATTR_DIRECTORY
 16130 0000140B F606[4E9D]10            	test	byte [DIRBUF+FIND_BUF.ATTR],ATTR_DIRECTORY ; 10h
 16131 00001410 741D                    	jz	short ccRet	; not a subdirectory file- return
 16132                                  
 16133                                  	; 16/02/2023
 16134 00001412 BE[579D]                	mov	si,DIRBUF+FIND_BUF.PNAME
 16135 00001415 803C2E                  	cmp	byte [si],'.'
 16136                                  	;;cmp	DirBuf.find_buf_pname,'.'
 16137                                  	;cmp	byte [DIRBUF+FIND_BUF.PNAME],'.'
 16138 00001418 7415                    	je	short ccRet	; starts with a dot- return
 16139                                  
 16140                                  	;;mov	si,offset TRANGROUP:DirBuf+find_buf_pname
 16141                                  	;mov	si,DIRBUF+FIND_BUF.PNAME
 16142 0000141A 89DF                    	mov	di,bx
 16143 0000141C E8B104                  	call	CmpAscz		; compare candidate to last child's name
 16144 0000141F 760E                    	jna	short ccRet	; it's not above it- return
 16145                                  
 16146                                  	; 07/06/2023
 16147                                  	;;mov	si,offset TRANGROUP:DirBuf+find_buf_pname
 16148                                  	;mov	si,DIRBUF+FIND_BUF.PNAME
 16149                                  	; si = DIRBUF+FIND_BUF.PNAME
 16150 00001421 89EF                    	mov	di,bp
 16151 00001423 E8AA04                  	call	CmpAscz		; compare candidate to temp name
 16152 00001426 7307                    	jnb	short ccRet	; it's not below it- return
 16153                                  
 16154                                  ;	New kid is alright. Copy to temp.
 16155                                  
 16156                                  	; 07/06/2023
 16157                                  	;;mov	si,offset TRANGROUP:DirBuf+find_buf_pname
 16158                                  	;mov	si,DIRBUF+FIND_BUF.PNAME
 16159                                  	; si = DIRBUF+FIND_BUF.PNAME
 16160 00001428 89EF                    	mov	di,bp
 16161 0000142A B90D00                  	mov	cx,13
 16162 0000142D F3A4                    	rep	movsb
 16163                                  ccRet:
 16164 0000142F C3                      	retn
 16165                                  
 16166                                  ; ---------------------------------------------------------------------------
 16167                                  
 16168                                  ;***	CmpEntry - compare one directory entry to another in sort order
 16169                                  ;
 16170                                  ;	Compare one directory entry against another according to
 16171                                  ;	the sort codes in DestBuf. One or more comparisons
 16172                                  ;	may be made of file name, extension, time/date, and
 16173                                  ;	size.  Comparisons may be made for upward or downward
 16174                                  ;	sort order.
 16175                                  ;
 16176                                  ;	ENTRY	ES:BX = ptr to entry to compare
 16177                                  ;		ES:BP = ptr to entry to be compared against
 16178                                  ;		DestBuf contains sort codes (see DestBuf)
 16179                                  ;		DS = TRANGROUP seg addr
 16180                                  ;
 16181                                  ;	EXIT	BX = unchanged
 16182                                  ;		BP = unchanged
 16183                                  ;		Condition flags set for same, above, or below
 16184                                  ;		 comparing BX entry against BP entry.
 16185                                  ;		 'Same, above, below' translate to 'same, after, before'.
 16186                                  ;
 16187                                  ;	USED:	AX,CX,DX,SI,DI
 16188                                  
 16189                                  	; 16/02/2023
 16190                                  CmpEntry:
 16191 00001430 BE[BE9D]                	mov	si,DestBuf	; (DS:SI) = ptr to sort codes
 16192                                  ceLoop:
 16193 00001433 31C0                    	xor	ax,ax		; AX = 0
 16194 00001435 8A04                    	mov	al,[si]		; AL = sort code
 16195 00001437 08C0                    	or	al,al
 16196 00001439 741C                    	jz	short ceDone	; sort code is zero, we're done
 16197 0000143B 46                      	inc	si		; DS:SI = ptr to next sort code
 16198 0000143C 56                      	push	si		; save ptr to next sort code
 16199 0000143D FEC8                    	dec	al
 16200 0000143F D0E0                    	shl	al,1
 16201                                  	;sal	al,1		; AX = index into cmp call table
 16202                                  				; CY set for downward sort order
 16203 00001441 89C6                    	mov	si,ax		; SI = index into cmp call table
 16204 00001443 2E8B84[5814]            	mov	ax,[cs:si+FieldCmps]
 16205                                  				; AX = addr of compare routine
 16206 00001448 7204                    	jc	short ceDn	; downwards sort - go swap entries
 16207 0000144A FFD0                    	call	ax 		; do upwards sort
 16208 0000144C EB06                    	jmp	short ceNs
 16209                                  ceDn:
 16210 0000144E 87EB                    	xchg	bx,bp		; swap entry ptrs for downward sort order
 16211 00001450 FFD0                    	call	ax		; do sort
 16212 00001452 87EB                    	xchg	bx,bp		; swap ptrs back
 16213                                  ceNs:
 16214 00001454 5E                      	pop	si		; SI = ptr to next sort code
 16215 00001455 74DC                    	je	short ceLoop	; compare showed no difference, keep trying
 16216                                  ceDone:
 16217                                  
 16218                                  ;	Get here either from unequal compare or sort code = 0.
 16219                                  ;	In the latter case, condition codes indicate equality,
 16220                                  ;	which is correct.
 16221                                  
 16222 00001457 C3                      	retn
 16223                                  
 16224                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16225                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:1339h)
 16226                                  
 16227                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 16228                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:144Eh)
 16229                                  
 16230                                  FieldCmps:		; call table of entry comparisons
 16231 00001458 [6214]                  	dw	CmpName
 16232 0000145A [6D14]                  	dw	CmpExt
 16233 0000145C [BE14]                  	dw	CmpTime
 16234 0000145E [DA14]                  	dw	CmpSize
 16235 00001460 [DF14]                  	dw	CmpType
 16236                                  
 16237                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 16238                                  %if 0
 16239                                  	; 05/06/2023 - Retro DOS 4.2 COMMAND.COM
 16240                                  	dw	CmpCratio
 16241                                  %endif
 16242                                  
 16243                                  ; ---------------------------------------------------------------------------
 16244                                  
 16245                                  ;***	CmpName - compare file name of two entries
 16246                                  ;***	CmpExt - compare extension of two entries
 16247                                  ;
 16248                                  ;	ENTRY	ES:BX = ptr to one entry
 16249                                  ;		ES:BP = ptr to another entry
 16250                                  ;
 16251                                  ;	EXIT	BX = unchanged
 16252                                  ;		BP = unchanged
 16253                                  ;		Condition flags set for same, above, or below
 16254                                  ;		comparing BX entry to BP entry.
 16255                                  ;
 16256                                  ;	USED:	AX,CX,DX,SI,DI
 16257                                  
 16258                                  	; 16/02/2023
 16259                                  CmpName:
 16260 00001462 89DE                    	mov	si,bx		; ES:SI = ptr to BX entry
 16261 00001464 89EF                    	mov	di,bp		; ES:DI = ptr to BP entry
 16262                                  	;;add	si,filename	; ES:SI = ptr to BX name
 16263                                  	;add	si,1
 16264                                  	; 25/04/2023
 16265 00001466 46                      	inc	si
 16266                                  	;;add	di,filename	; ES:DI = ptr to BP name
 16267                                  	;add	di,1
 16268                                  	; 25/04/2023
 16269 00001467 47                      	inc	di
 16270                                  	;mov	cx,size filename
 16271                                  				; CX = length of name
 16272 00001468 B90800                  	mov	cx,8
 16273 0000146B EB0C                    	jmp	short CmpStr
 16274                                  
 16275                                  CmpExt:
 16276                                  	; 07/06/2023
 16277                                  	;mov	si,bx		; ES:SI = ptr to BX entry
 16278                                  	;mov	di,bp		; ES:DI = ptr to BP entry
 16279                                  	;;add	si,fileext	; ES:SI = ptr to BX extension
 16280                                  	;add	si,9
 16281                                  	;;add	di,fileext	; ES:DI = ptr to BP extension
 16282                                  	;add	di,9
 16283                                  	;
 16284 0000146D BE0900                  	mov	si,9
 16285 00001470 89F7                    	mov	di,si ; mov di,9
 16286 00001472 01DE                    	add	si,bx
 16287 00001474 01EF                    	add	di,bp
 16288                                  	;
 16289                                  	;mov	cx,size fileext	; CX = length of extension field
 16290 00001476 B90300                  	mov	cx,3
 16291                                  
 16292                                  ;	Bugbug:	use symbol for subfunction code.
 16293                                  
 16294                                  CmpStr:	
 16295 00001479 803E[BEA5]06            	cmp	byte [CountryPtrId],6
 16296 0000147E 753A                    	jne	short cnNoCollTable
 16297                                  				; no collating table available
 16298                                  
 16299                                  ;*	Compare strings using collating table.
 16300                                  ;
 16301                                  ;	ES:SI = ptr to 1st string
 16302                                  ;	ES:DI = ptr to 2nd string
 16303                                  ;	CX = length
 16304                                  
 16305 00001480 55                      	push	bp		; preserve BP
 16306 00001481 53                      	push	bx		; preserve BX
 16307 00001482 1E                      	push	ds		; preserve DS
 16308 00001483 C51E[BFA5]              	lds	bx,[CountryPtr]	; DS:BX = ptr to collating table
 16309                                  	;assume	ds:NOTHING
 16310 00001487 8B2F                    	mov	bp,[bx]		; BP = size of collating table
 16311 00001489 43                      	inc	bx
 16312 0000148A 43                      	inc	bx		; DS:BX = ptr to collating values
 16313                                  				; DS:[BX]-2 = size of table
 16314 0000148B 31C0                    	xor	ax,ax		; AX = 0 for starters
 16315                                  
 16316                                  ;	Bugbug:	Investigate removing collating table length checks.
 16317                                  
 16318                                  cnNextChar:
 16319 0000148D 268A05                  	mov	al,[es:di]	; AL = AX = char from 2nd string
 16320 00001490 47                      	inc	di		; ES:DI = ptr to next char 2nd string
 16321                                  
 16322                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 16323                                  %if 0
 16324                                  	cmp	ax,bp		; compare to collating table length
 16325                                  	jae	short cn1 	; char not in table
 16326                                  	xlat				
 16327                                  cn1:				; AL = AX = collating value
 16328                                  	mov	dx,ax		; DX = collating value from 2nd string
 16329                                  	;lods	byte ptr es:[si]
 16330                                  	es	lodsb		; AL = AX = char from 1st string
 16331                                  				; ES:SI = ptr to next char 1st string
 16332                                  	cmp	ax,bp		; compare to collating table length
 16333                                  	jae	short cn2	; char not in table
 16334                                  	xlat				
 16335                                  cn2:				; AL = AX = collating value
 16336                                  	cmp	ax,dx		; compare collating values
 16337                                  	loope	cnNextChar	; until unequal or no more left
 16338                                  
 16339                                  	pop	ds		; restore DS
 16340                                  	;assume	ds:TRANGROUP
 16341                                  	pop	bx		; restore BX
 16342                                  	pop	bp		; restore BP
 16343                                  	retn
 16344                                  
 16345                                  ;*	If no collating table is available, simply compare raw ASCII values.
 16346                                  ;	Don't we wish we could just do this all the time? Sigh.
 16347                                  
 16348                                  %else
 16349                                  	; 31/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 16350 00001491 84F6                    	test	dh,dh
 16351 00001493 7408                    	jz	short cn1
 16352 00001495 30F6                    	xor	dh,dh
 16353 00001497 88C2                    	mov	dl,al
 16354                                  	;lods	byte ptr es:[si]
 16355 00001499 26AC                    	es	lodsb
 16356 0000149B EB15                    	jmp	short cn4
 16357                                  cn1:
 16358 0000149D E8C112                  	call	testkanj
 16359 000014A0 7402                    	jz	short cn2
 16360 000014A2 B601                    	mov	dh,1
 16361                                  cn2:
 16362 000014A4 39E8                    	cmp	ax,bp
 16363 000014A6 7301                    	jnb	short cn3
 16364 000014A8 D7                      	xlat
 16365                                  cn3:
 16366 000014A9 88C2                    	mov	dl,al
 16367                                  	;lods	byte ptr es:[si]
 16368 000014AB 26AC                    	es	lodsb
 16369 000014AD 39E8                    	cmp	ax,bp
 16370 000014AF 7301                    	jnb	short cn4
 16371 000014B1 D7                      	xlat
 16372                                  cn4:
 16373 000014B2 38D0                    	cmp	al,dl
 16374 000014B4 E1D7                    	loope	cnNextChar
 16375 000014B6 1F                      	pop	ds
 16376 000014B7 5B                      	pop	bx
 16377 000014B8 5D                      	pop	bp
 16378 000014B9 C3                      	retn	
 16379                                  %endif
 16380                                  
 16381                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16382                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:138Dh)
 16383                                  cnNoCollTable:
 16384                                  	;repe	cmps byte ptr es:[si], byte ptr es:[di] ; 31/07/2024
 16385                                  				;db 0F3h,26h,0A6h,0C3h
 16386 000014BA F3                      	repe	; 0F3h
 16387 000014BB 26                      	es	; 26h
 16388 000014BC A6                      	cmpsb	; 0A6h
 16389 000014BD C3                      	retn	; 0C3h
 16390                                  
 16391                                  ; ---------------------------------------------------------------------------
 16392                                  
 16393                                  ;***	CmpTime - compare entries by date/time
 16394                                  ;
 16395                                  ;	ENTRY	ES:BX = ptr to one entry
 16396                                  ;		ES:BP = ptr to another entry
 16397                                  ;
 16398                                  ;	EXIT	BX = unchanged
 16399                                  ;		BP = unchanged
 16400                                  ;		Condition flags set for same, above, or below
 16401                                  ;		 comparing BX entry to BP entry.
 16402                                  ;
 16403                                  ;	USED:	CX,SI,DI
 16404                                  ;
 16405                                  ;	NOTE	Filetime and filedate fields in our private entry
 16406                                  ;		structure must be adjacent and in that order.
 16407                                  
 16408                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16409                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16410                                  CmpTime:
 16411 000014BE 89DE                    	mov	si,bx
 16412 000014C0 89EF                    	mov	di,bp
 16413                                  	;add	si,filedate + size filedate - 1
 16414 000014C2 83C610                  	add	si,16 ; 15+2-1
 16415                                  	;add	di,filedate + size filedate - 1
 16416 000014C5 83C710                  	add	di,16 ; 15+2-1
 16417                                  	; 07/06/2023
 16418 000014C8 BE1000                  	mov	si,16
 16419                                  CmpST2:		; 07/06/2023
 16420 000014CB 89F7                    	mov	di,si	; mov di,16
 16421 000014CD 01DE                    	add	si,bx
 16422 000014CF 01EF                    	add	di,bp
 16423                                  
 16424                                  	;mov	cx,size filetime + size filedate
 16425 000014D1 B90400                  	mov	cx,4 ; 2+2
 16426 000014D4 FD                      	std
 16427                                  	;repe	cmps byte ptr es:[si],[di]
 16428                                  				;db 0F3h,26h,0A6h, 0FCh,0C3h
 16429 000014D5 F3                      	repe	; 0F3h
 16430 000014D6 26                      	es	; 26h
 16431 000014D7 A6                      	cmpsb	; 0A6h
 16432                                  	
 16433 000014D8 FC                      	cld	; 0FCh
 16434 000014D9 C3                      	retn	; 0C3h
 16435                                  
 16436                                  ; ---------------------------------------------------------------------------
 16437                                  
 16438                                  ;***	CmpSize - compare entries by size
 16439                                  ;
 16440                                  ;	ENTRY	ES:BX = ptr to one entry
 16441                                  ;		ES:BP = ptr to another entry
 16442                                  ;
 16443                                  ;	EXIT	BX = unchanged
 16444                                  ;		BP = unchanged
 16445                                  ;		Condition flags set for same, above, or below
 16446                                  ;		 comparing BX entry to BP entry.
 16447                                  ;
 16448                                  ;	USED:	CX,SI,DI
 16449                                  
 16450                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16451                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16452                                  CmpSize:
 16453                                  	;mov	si,bx
 16454                                  	;mov	di,bp
 16455                                  	;;add	si,filesize + size filesize - 1
 16456                                  	;add	si,20  ; 17+4-1
 16457                                  	;;add	di,filesize + size filesize - 1
 16458                                  	;add	di,20  ; 17+4-1
 16459                                  	; 07/06/2023
 16460 000014DA BE1400                  	mov	si,20
 16461                                  	;;;
 16462 000014DD EBEC                    	jmp	short CmpST2 ; 07/06/2023
 16463                                  	;;;
 16464                                  ;CmpST2:
 16465                                  ;	mov	di,si	; mov di,20
 16466                                  ;	add	si,bx
 16467                                  ;	add	di,bp
 16468                                  ;
 16469                                  ;	;mov	cx,size filesize
 16470                                  ;	mov	cx,4
 16471                                  ;	std
 16472                                  ;	;repe	cmps byte ptr es:[si],[di]
 16473                                  ;				;db 0F3h,26h,0A6h
 16474                                  ;	repe	; 0F3h
 16475                                  ;	es	; 26h
 16476                                  ;	cmpsb	; 0A6h
 16477                                  ;
 16478                                  ;	cld
 16479                                  ;	retn
 16480                                  
 16481                                  ; ---------------------------------------------------------------------------
 16482                                  
 16483                                  ;***	CmpType - compare entries by file type (subdirectory or not)
 16484                                  ;
 16485                                  ;	ENTRY	ES:BX = ptr to one entry
 16486                                  ;		ES:BP = ptr to another entry
 16487                                  ;
 16488                                  ;	EXIT	BX = unchanged
 16489                                  ;		BP = unchanged
 16490                                  ;		Condition flags set for same, above, or below
 16491                                  ;		 comparing BX entry to BP entry.
 16492                                  ;
 16493                                  ;	USED:	AX
 16494                                  
 16495                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16496                                  CmpType:
 16497                                  	;mov	al,es:[bx].fileattr
 16498 000014DF 268A470C                	mov	al,[es:bx+12]
 16499                                  	;mov	ah,es:[bp].fileattr
 16500 000014E3 268A660C                	mov	ah,[es:bp+12]
 16501                                  	;and	ax,(ATTR_DIRECTORY shl 8) + ATTR_DIRECTORY
 16502                                  	;and	ax,1010h
 16503 000014E7 251010                  	and	ax,(ATTR_DIRECTORY<<8)+ATTR_DIRECTORY
 16504 000014EA 38C4                    	cmp	ah,al
 16505 000014EC C3                      	retn
 16506                                  
 16507                                  ; ---------------------------------------------------------------------------
 16508                                  
 16509                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 16510                                  %if 0
 16511                                  
 16512                                  ;***	CmpCratio - compare entries by compression ratio
 16513                                  ;
 16514                                  ;	ENTRY	ES:BX = ptr to one entry
 16515                                  ;		ES:BP = ptr to another entry
 16516                                  ;
 16517                                  ;	EXIT	BX = unchanged
 16518                                  ;		BP = unchanged
 16519                                  ;		Condition flags set for same, above, or below
 16520                                  ;		 comparing BX entry to BP entry.
 16521                                  ;
 16522                                  ;	USED:	AX
 16523                                  
 16524                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 16525                                  CmpCratio:
 16526                                  	;mov	al,es:[bx].compratio
 16527                                  	mov	al,[es:bx+21]	
 16528                                  	;cmp	al,es:[bp].compratio
 16529                                  	cmp     al,[es:bp+21]
 16530                                  	retn
 16531                                  
 16532                                  %endif
 16533                                  
 16534                                  ; ---------------------------------------------------------------------------
 16535                                  
 16536                                  ;***	DefaultAttr - set default attribute conditions
 16537                                  ;
 16538                                  ;	ENTRY	nothing
 16539                                  ;
 16540                                  ;	EXIT	CY clear
 16541                                  ;
 16542                                  ;	USED
 16543                                  ;
 16544                                  ;	EFFECTS
 16545                                  ;
 16546                                  ;	  AttrSpecified, AttrSelect are updated with new attribute conditions.
 16547                                  
 16548                                  	; 16/02/2023
 16549                                  DefaultAttr:
 16550                                  	;mov	byte [AttrSpecified],6
 16551 000014ED C606[939D]06            	mov	byte [AttrSpecified],ATTR_HIDDEN+ATTR_SYSTEM
 16552                                  					; specify H and S
 16553 000014F2 C606[949D]00            	mov	byte [AttrSelect],0	; H and S must be off
 16554 000014F7 F8                      	clc				; return success
 16555                                  dtRet:	; 18/02/2023
 16556 000014F8 C3                      	retn
 16557                                  
 16558                                  ; ---------------------------------------------------------------------------
 16559                                  
 16560                                  ;***	DisplayTotals - display grand total stats
 16561                                  ;
 16562                                  ;	If we searched subdirectories, display the total # files found
 16563                                  ;	 and total size of files found.
 16564                                  ;	Display disk space remaining.
 16565                                  ;
 16566                                  ;	ENTRY	FileCntTotal, FileSizTotal contain correct values
 16567                                  ;		Bits contains setting of /s
 16568                                  ;		FCB contains drive #
 16569                                  ;
 16570                                  ;	EXIT	nothing
 16571                                  ;
 16572                                  ;	USES	AX,DX
 16573                                  ;		FileSiz
 16574                                  
 16575                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16576                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:13D1h
 16577                                  
 16578                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16579                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:14F1h
 16580                                  
 16581                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 16582                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1565h
 16583                                  
 16584                                  DisplayTotals:
 16585                                  	;;;test	Bits,mask subd
 16586                                  	;;test	word [_Bits],4
 16587                                  	;test	byte [_Bits],4
 16588                                  	; 07/06/2023
 16589 000014F9 F606[8B9D]04            	test	byte [_Bits],mask.subd	; 8 ; MSDOS 6.0
 16590                                  			; 31/07/2024	; 4 ; PCDOS 7.1
 16591 000014FE 7423                    	jz	short dtFree		; no subdirectories- do bytes free
 16592                                  
 16593 00001500 E87614                  	call	CRLF2			; start on new line
 16594 00001503 E87304                  	call	UseLine
 16595                                  
 16596 00001506 BA[8F92]                	mov	dx,total_ptr
 16597 00001509 E81C3F                  	call	std_printf		; "Total:",cr,lf
 16598 0000150C E86A04                  	call	UseLine
 16599                                  
 16600                                  ; 31/07/2024
 16601                                  ; PCDOS 7.1 COMMAND.COM
 16602                                  	;;;
 16603                                  %if 0
 16604                                  	; 07/06/2023
 16605                                  	; MSDOS 6.22 COMMAND.COM
 16606                                  	;test	word [_Bits],1		; mask.cratio
 16607                                  	test	byte [_Bits],mask.cratio
 16608                                  	jz      short dtCntSize
 16609                                  	mov     ax,[ccluUsedTotal]
 16610                                  	mov     [ccluUsedDir],ax
 16611                                  	mov     si,csecUsedTotal
 16612                                  	mov     di,csecUsedDir
 16613                                  	movsw
 16614                                  	movsw
 16615                                  dtCntSize:    
 16616                                  %endif
 16617                                  	;;;
 16618 0000150F A1[5E9C]                	mov	ax,[FileCntTotal]	; AX = # files found mod 64K
 16619 00001512 BE[629C]                	mov	si,FileSizTotal
 16620 00001515 BF[229C]                	mov	di,FileSiz
 16621 00001518 A5                      	movsw				; move total size to size variable
 16622 00001519 A5                      	movsw
 16623                                  
 16624                                  ; 31/07/2024
 16625                                  ; PCDOS 7.1 COMMAND.COM
 16626                                  %if 1
 16627 0000151A A5                      	movsw
 16628 0000151B A5                      	movsw
 16629 0000151C 8B16[609C]              	mov	dx,[FileCntTotal+2]
 16630                                  %endif
 16631 00001520 E8D306                  	call	DisplayCntSiz		; display file count & size
 16632                                  dtFree:
 16633                                  
 16634                                  ; 31/07/2024
 16635                                  ; PCDOS 7.1 COMMAND.COM
 16636                                  %if 0
 16637                                  	mov	ah,36h
 16638                                  	;mov	ah,GET_DRIVE_FREESPACE	; AH = DOS Get Free Space function
 16639                                  	mov	dl,[FCB] ; [5Ch]	; DL = drive#
 16640                                  	int	21h			; call DOS
 16641                                  	cmp	ax,-1			; check 'invalid drive' return code
 16642                                  	jz	short dtRet		; can't get drive space - return
 16643                                  	mul	cx
 16644                                  	mul	bx
 16645                                  	mov	[Bytes_Free],ax
 16646                                  	mov	[Bytes_Free+2],dx
 16647                                  	mov	dx,bytmes_ptr
 16648                                  %else
 16649                                  	; 31/07/2024 - Retro DOS v5.0
 16650                                  	; PCDOS 7.1 COMMAND.COM
 16651 00001523 E86907                  	call	GetDriveLtr
 16652 00001526 A2[5A9C]                	mov	byte [efs_drive],al ; "C:\"
 16653 00001529 BA[5A9C]                	mov	dx,efs_drive ; "C:\"
 16654 0000152C BF[2E9C]                	mov	di,efs_buffer
 16655 0000152F B92C00                  	mov	cx,44
 16656 00001532 26890D                  	mov	[es:di],cx
 16657 00001535 26C745020000            	mov	word [es:di+2],0
 16658 0000153B B80373                  	mov	ax,7303h	; GET EXTENDED FREE SPACE ON DRIVE (Windows95, FAT32)
 16659                                  				; DS:DX	-> ASCIZ string	for drive ("C:\" or "\\SERVER\Share")
 16660                                  				; ES:DI	-> buffer for extended free space structure
 16661                                  				; CX = length of buffer	for extended free space
 16662 0000153E CD21                    	int	21h		; DOS -
 16663                                  				;
 16664                                  				; Return:
 16665                                  				; CF clear if successful
 16666                                  				; ES:DI	buffer filled
 16667                                  				; CF set on error
 16668                                  				; AX = error code
 16669                                  				;
 16670                                  				; Format of extended free space	structure:
 16671                                  				;
 16672                                  				; Offset  Size	  Description
 16673                                  				; 00h	 WORD	 (ret) size of returned	structure
 16674                                  				; 02h	 WORD	 (call)	structure version (0000h)
 16675                                  				;		 (ret) actual structure	version	(0000h)
 16676                                  				; 04h	 DWORD	 number	of sectors per cluster
 16677                                  				;		 (with adjustment for compression)
 16678                                  				; 08h	 DWORD	 number	of bytes per sector
 16679                                  				; 0Ch	 DWORD	 number	of available clusters
 16680                                  				; 10h	 DWORD	 total number of clusters on the drive
 16681                                  				; 14h	 DWORD	 number	of physical sectors available on the drive,
 16682                                  				;		 without adjustment for	compression
 16683                                  				; 18h	 DWORD	 total number of physical sectors on the drive,
 16684                                  				;		 without adjustment for	compression
 16685                                  				; 1Ch	 DWORD	 number	of available allocation	units,
 16686                                  				;		 without adjustment for	compression
 16687                                  				; 20h	 DWORD	 total allocation units,
 16688                                  				;		 without adjustment for	compression
 16689                                  				; 24h  8 BYTEs	 reserved
 16690 00001540 89C1                    	mov	cx,ax		; error	code (cf=1) or (cf=0) efs structure size (44)
 16691 00001542 268B5D08                	mov	bx,[es:di+8]	; bytes	per sector
 16692 00001546 268B4514                	mov	ax,[es:di+14h]	; number of sectors available
 16693 0000154A 268B5516                	mov	dx,[es:di+16h]
 16694 0000154E 7204                    	jc	short get_efs_err
 16695 00001550 08C9                    	or	cl,cl
 16696 00001552 750F                    	jnz	short dtFree_1	; cl = 44 (IBMDOS 7.1 Kernel, INT 21h, AX=7303h	return value)
 16697                                  get_efs_err:
 16698 00001554 B436                    	mov	ah,36h
 16699                                  	;mov	ah,GET_DRIVE_FREESPACE	; AH = DOS Get Free Space function
 16700 00001556 8A165C00                	mov	dl,[FCB] 		; DL = drive#
 16701                                  	;mov	dl,[5Ch]
 16702 0000155A CD21                    	int	21h		; DOS -	2+ - GET DISK SPACE
 16703                                  				; DL = drive code (0 = default,	1 = A, 2 = B, etc.)
 16704 0000155C 83F8FF                  	cmp	ax,0FFFFh	; ax = sectors per cluster
 16705 0000155F 7497                    	je	short dtRet	; ! invalid drive ! return
 16706 00001561 F7E1                    	mul	cx		; * bytes per sectors
 16707                                  				; dx:ax	= bytes	per cluster
 16708                                  				; bx = free clusters
 16709                                  dtFree_1:
 16710 00001563 89D1                    	mov	cx,dx		; hw of	free sectors
 16711 00001565 F7E3                    	mul	bx		; lw of	free sectors * bytes per sector
 16712 00001567 91                      	xchg	ax,cx
 16713 00001568 87DA                    	xchg	dx,bx
 16714 0000156A F7E2                    	mul	dx
 16715 0000156C 01D8                    	add	ax,bx
 16716 0000156E 83D200                  	adc	dx,0		; dx:ax:cx = free bytes
 16717 00001571 09D2                    	or	dx,dx
 16718 00001573 7416                    	jz	short dtFree_2
 16719 00001575 88E9                    	mov	cl,ch		; prints free space as kilobytes
 16720 00001577 88C5                    	mov	ch,al		; save al
 16721 00001579 88E0                    	mov	al,ah		; / 256
 16722 0000157B 88D4                    	mov	ah,dl
 16723 0000157D D0CE                    	ror	dh,1		; / 2 (= free bytes / 512)
 16724 0000157F D1D8                    	rcr	ax,1
 16725 00001581 D1D9                    	rcr	cx,1
 16726 00001583 D0CE                    	ror	dh,1		; / 2 (= free bytes / 1024)
 16727 00001585 D1D8                    	rcr	ax,1
 16728 00001587 D1D9                    	rcr	cx,1
 16729 00001589 B2FF                    	mov	dl,0FFh	; dx > 0
 16730                                  dtFree_2:
 16731 0000158B 890E[A99D]              	mov	[Bytes_Free],cx
 16732 0000158F A3[AB9D]                	mov	[Bytes_Free+2],ax
 16733 00001592 09D2                    	or	dx,dx		; is dx	> 0 ?
 16734 00001594 740F                    	jz	short dtFree_3	; no
 16735 00001596 BA[D592]                	mov	dx,kbytesf_ptr	; MSG_1106 (".. K bytes free" msg)
 16736                                  				; 30 digits, long binary do decimal
 16737 00001599 803E[2D9C]00            	cmp	byte [bfree_not_kilo],0
 16738 0000159E 741C                    	jz	short dtFree_5
 16739 000015A0 BA[D592]                	mov	dx,kbytesf_ptr	; MSG_1106
 16740                                  				; ".. K	bytes free" msg, 28 digits
 16741 000015A3 EB17                    	jmp	short dtFree_5
 16742                                  dtFree_3:
 16743 000015A5 BA[4490]                	mov	dx,bytmes1_ptr	; MSG_1020 (".. bytes free" msg)
 16744                                  				; 30 digits, long binary do decimal
 16745 000015A8 803E[2A9C]00            	cmp	byte [narrow],0	; narrow display area ?
 16746 000015AD 7503                    	jnz	short dtFree_4	; yes
 16747 000015AF BA[5290]                	mov	dx,bytmes2_ptr	; MSG_1020, 33 digits
 16748                                  dtFree_4:
 16749 000015B2 803E[2D9C]00            	cmp	byte [bfree_not_kilo],0 ; not kilobyte option
 16750 000015B7 7403                    	jz	short dtFree_5	; use kilo bytes (if number of free bytes is big)
 16751 000015B9 BA[6090]                	mov	dx,bytmes_n_ptr	; narrow (28 digits), MSG_1020
 16752                                  dtFree_5:
 16753                                  %endif
 16754 000015BC E8693E                  	call	std_printf	; "nnn bytes free",cr,lf
 16755                                  	;call	UseLine
 16756                                  ;dtRet:
 16757                                  	;retn
 16758                                  	; 18/02/2023
 16759 000015BF E9B703                  	jmp	UseLine
 16760                                  
 16761                                  ; ---------------------------------------------------------------------------
 16762                                  
 16763                                  ;***	FileIsDevice - see if file looks like a device
 16764                                  ;
 16765                                  ;	ENTRY	PathPos = ptr to pathname
 16766                                  ;		PathCnt = length of pathname w/o terminating char
 16767                                  ;		DirBuf is DOS DTA
 16768                                  ;
 16769                                  ;	EXIT	ZR = set if file looks like a device
 16770                                  ;
 16771                                  ;	USED	AX,BX,CX,DX,DI
 16772                                  ;
 16773                                  ;	EFFECTS
 16774                                  ;
 16775                                  ;	  DTA buffer holds results of Find First function
 16776                                  ;
 16777                                  ;	NOTES
 16778                                  ;
 16779                                  ;	  We try to flag devices in two ways. First, we try
 16780                                  ;	  the DOS Find First function. It returns attribute bit 6
 16781                                  ;	  set on a successful find if it identifies a device name.
 16782                                  ;	  Unfortunately, it returns 'path not found' for a device
 16783                                  ;	  name terminated with colon, such as "CON:". So, we look
 16784                                  ;	  for any colon in the pathname after the 2nd character,
 16785                                  ;	  and flag the pathname as a device if we find one.
 16786                                  
 16787                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16788                                  FileIsDevice:
 16789 000015C2 8B16[8F9D]              	mov	dx,[PathPos]	 ; DX = ptr to pathname
 16790                                  
 16791 000015C6 89D7                    	mov	di,dx
 16792 000015C8 033E[8D9D]              	add	di,[PathCnt]	 ; DI = ptr to byte after pathname
 16793 000015CC 30DB                    	xor	bl,bl		 ; BL = NUL to terminate pathname with
 16794 000015CE 861D                    	xchg	bl,[di] 	 ; BL = saved pathname terminating char
 16795                                  
 16796 000015D0 31C9                    	xor	cx,cx		 ; CX = attribute mask (normal search)
 16797 000015D2 B44E                    	mov	ah,4Eh
 16798                                  	;mov	ah,Find_First	 ; AH = DOS Find First function code
 16799 000015D4 CD21                    	int	21h	 	 ; call DOS
 16800 000015D6 861D                    	xchg	bl,[di]		 ; restore pathname terminating char
 16801 000015D8 720A                    	jc	short piCol	 ; didn't find a dir entry, check for colon
 16802                                  
 16803                                  ;	Found a dir entry, see if Find First thinks it's a device.
 16804                                  
 16805                                  	;test	byte [DIRBUF+21],40h
 16806 000015DA F606[4E9D]40            	test	byte [DIRBUF+FIND_BUF.ATTR],ATTR_DEVICE
 16807 000015DF 7403                    	jz	short piCol	 ; device attribute not set, look for colon
 16808 000015E1 31C9                    	xor	cx,cx		 ; it's a device, return ZR flag
 16809                                  	;jmp	short piRet
 16810                                  	; 25/04/2023
 16811                                  piRet:
 16812 000015E3 C3                      	retn
 16813                                  
 16814                                  ;	Device attribute not returned by Find First function. But
 16815                                  ;	let's check for a colon anywhere in the pathname after the
 16816                                  ;	second byte.
 16817                                  ;
 16818                                  ;	DI = ptr to byte after pathname
 16819                                  
 16820                                  piCol:
 16821 000015E4 4F                      	dec	di		 ; DI = ptr to last char in pathname
 16822 000015E5 B03A                    	mov	al,':'
 16823                                  	;mov	al,COLON_CHAR	 ; AL = colon char to search for
 16824 000015E7 8B0E[8D9D]              	mov	cx,[PathCnt]	 ; CX = # chars to scan
 16825 000015EB 49                      	dec	cx
 16826 000015EC 49                      	dec	cx		 ; ignore 1st two chars of pathname
 16827 000015ED 09C9                    	or	cx,cx
 16828 000015EF 78F2                    	js	short piRet	 ; if < 2 chars in pathname, just return
 16829 000015F1 09FF                    	or	di,di		 ; clear ZR in case CX = 0
 16830 000015F3 FD                      	std			 ; scan downward
 16831 000015F4 F2AE                    	repne	scasb
 16832 000015F6 FC                      	cld			 ; restore default upward direction
 16833                                  
 16834                                  ;	After scanning, the ZR flag is set to indicate presence of a colon.
 16835                                  ;piRet:
 16836 000015F7 C3                      	retn
 16837                                  
 16838                                  ;FileIsDevice endp
 16839                                  
 16840                                  ; ---------------------------------------------------------------------------
 16841                                  
 16842                                  ;***	FindFirst - find first directory entry to display
 16843                                  ;***	FindNext - find next directory entry to display
 16844                                  ;
 16845                                  ;	ENTRY	Bits<inmem> = set if entries are loaded in TPA
 16846                                  ;		AttrSpecified, AttrSelect are set
 16847                                  ;
 16848                                  ;	EXIT	CY = clear if successful
 16849                                  ;		BX = offset in TPA buffer of directory entry found
 16850                                  ;
 16851                                  ;		If unsuccessful,
 16852                                  ;		CY = set
 16853                                  ;		AX = DOS error code
 16854                                  ;		DOS Get Extended Error call will get error code
 16855                                  ;
 16856                                  ;		NOTE: if entries were loaded into TPA, AX contains
 16857                                  ;		ERROR_NO_MORE_FILES when no more entries are available,
 16858                                  ;		but DOS Get Extended Error call WON'T return the correct
 16859                                  ;		error. That's ok, because we'll see the value in AX
 16860                                  ;		and recognize it as a non-error condition.
 16861                                  ;
 16862                                  ;	USED	AX,CX,DX,SI,DI
 16863                                  ;
 16864                                  ;	EFFECTS
 16865                                  ;
 16866                                  ;	  Entries in memory may be marked as output.
 16867                                  ;	  If not sorted, entry is loaded at TPA.
 16868                                  ;
 16869                                  ;	NOTES
 16870                                  ;
 16871                                  ;	  If we don't find a qualifying file, we return after the final
 16872                                  ;	   DOS Find File call. A DOS Get Extended Error call will then
 16873                                  ;	   indicate an appropriate condition.
 16874                                  
 16875                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16876                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:144Fh
 16877                                  
 16878                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16879                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1585h
 16880                                  
 16881                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 16882                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1667h
 16883                                  	
 16884                                  FindFirst:
 16885                                  	;mov	ax,offset TRANGROUP:GetFirst
 16886 000015F8 B8[CF16]                	mov	ax,GetFirst
 16887 000015FB EB03                    	jmp	short ffFindEntry
 16888                                  
 16889                                  	; 18/02/2023
 16890                                  FindNext:
 16891                                  	;mov	ax,offset TRANGROUP:GetNext
 16892 000015FD B8[DD16]                	mov	ax,GetNext
 16893                                  
 16894                                  ;	AX = address of correct disk get routine to use.
 16895                                  
 16896                                  ffFindEntry:
 16897 00001600 06                      	push	es			; save TRANGROUP seg addr
 16898                                  	;;;test	Bits,mask inmem
 16899                                  	;;test	word [_Bits],20h
 16900                                  	;test	byte [_Bits],20h
 16901                                  	; 07/06/2023
 16902 00001601 F606[8B9D]80            	test	byte [_Bits],mask.inmem ; 40h ; MSDOS 6.0
 16903                                  			; 31/07/2024	; 80h ; PCDOS 7.1	
 16904 00001606 7405                    	jz	short ffDisk		; entries not in memory, search disk
 16905                                  
 16906                                  ;	Entries are loaded in memory to sort out. Find the first one.
 16907                                  ;	There will always be one, or LoadEntries would've failed.
 16908                                  
 16909 00001608 E81A00                  	call	FindInMem		; find first entry in TPA
 16910 0000160B EB16                    	jmp	short ffRet		; return what TPA search returns
 16911                                  
 16912                                  ;	Get entry from disk.
 16913                                  
 16914                                  ffDisk:
 16915 0000160D FFD0                    	call	ax			; get entry from disk
 16916 0000160F 720E                    	jc	short ffGetErr		; get & return error
 16917 00001611 8E06[F79B]              	mov	es,[TPA]		; ES = seg addr of TPA
 16918 00001615 31FF                    	xor	di,di			; ES:DI = ptr to TPA
 16919 00001617 89FB                    	mov	bx,di			; BX = offset of entry in TPA
 16920 00001619 E85C01                  	call	LoadEntry		; load entry to TPA
 16921 0000161C F8                      	clc				; return success
 16922 0000161D EB04                    	jmp	short ffRet
 16923                                  
 16924                                  ffGetErr:
 16925 0000161F E8290A                  	call	 get_ext_error_number	; AX = DOS error code
 16926 00001622 F9                      	stc
 16927                                  ffRet:
 16928 00001623 07                      	pop	es			; ES = TRANGROUP seg addr again
 16929 00001624 C3                      	retn
 16930                                  
 16931                                  ; ---------------------------------------------------------------------------
 16932                                  
 16933                                  ;***	FindInMem - find next directory entry in TPA buffer
 16934                                  ;
 16935                                  ;	ENTRY	TPA is loaded (see LoadEntries)
 16936                                  ;
 16937                                  ;	EXIT	BX = offset in TPA of entry found
 16938                                  ;
 16939                                  ;		If no more files,
 16940                                  ;		CY = set
 16941                                  ;		AX = DOS 'no more files' error code
 16942                                  ;
 16943                                  ;	USED	AX,BX,CX,DX,SI,DI,BP,ES
 16944                                  ;
 16945                                  ;	EFFECTS
 16946                                  ;
 16947                                  ;	  Entry found is flagged as 'used' (see EntryStruc).
 16948                                  
 16949                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16950                                  FindInMem:
 16951 00001625 8E06[F79B]              	mov	es,[TPA]		; ES = TPA seg addr
 16952 00001629 31DB                    	xor	bx,bx			; ES:BX = ptr to 1st entry in TPA
 16953 0000162B FC                      	cld				; make sure default string direction is up
 16954                                  	
 16955 0000162C E86D00                  	call	FindOneInMem		; locate an entry
 16956 0000162F 720E                    	jc	short fiNoMore		; none left, set up 'no more files' error
 16957                                  
 16958                                  ;	BX = ptr to entry in TPA
 16959                                  
 16960                                  fiBest:
 16961 00001631 89DD                    	mov	bp,bx			; BP = ptr to best entry so far
 16962                                  fiNext:
 16963 00001633 E87300                  	call	FindNextInMem		; locate next entry
 16964 00001636 720C                    	jc	short fiFound		; no more, best entry so far wins
 16965                                  
 16966                                  ;	BX = ptr to next entry
 16967                                  
 16968 00001638 E8F5FD                  	call	CmpEntry		; compare it to best found so far (BP)
 16969 0000163B 73F6                    	jnb	short fiNext		; it's not better, go look at next one
 16970 0000163D EBF2                    	jmp	short fiBest		; it's better, go mark it as best so far
 16971                                  
 16972                                  fiNoMore:
 16973                                  
 16974                                  ;	No more entries available in TPA. Set up 'no more files' error.
 16975                                  
 16976                                  	;mov	ax,18
 16977 0000163F B81200                  	mov	ax,ERROR_NO_MORE_FILES	; AX = 'no more files' error code
 16978 00001642 F9                      	stc				; return error
 16979                                  	;jmp	short fiRet
 16980                                  	; 18/02/2023
 16981 00001643 C3                      	retn
 16982                                  
 16983                                  fiFound:
 16984 00001644 89EB                    	mov	bx,bp			; BX = ptr to best entry found
 16985 00001646 26C60701                	mov	byte [es:bx],1		; mark entry 'used'
 16986 0000164A F8                      	clc				; return success
 16987                                  fiRet:
 16988 0000164B C3                      	retn
 16989                                  
 16990                                  ; ---------------------------------------------------------------------------
 16991                                  
 16992                                  ;***	FindNextChild - find next subdirectory in current directory
 16993                                  ;
 16994                                  ;	ENTRY	BX = ptr to last child found, ASCIIZ filename
 16995                                  ;		DirBuf is established DTA
 16996                                  ;
 16997                                  ;	EXIT	BX = ptr (same addr) to next child found, ASCIIZ filename
 16998                                  ;
 16999                                  ;		If failure,
 17000                                  ;		CY = set
 17001                                  ;		DOS Get Extended Error call will get error
 17002                                  ;
 17003                                  ;	USED	AX,CX,DX,SI,DI,BP
 17004                                  ;
 17005                                  ;	EFFECTS
 17006                                  ;
 17007                                  ;	  DirBuf is used for find first/next calls.
 17008                                  ;
 17009                                  ;	NOTES
 17010                                  ;
 17011                                  ;	  We keep on checking files until DOS returns an error. If
 17012                                  ;	  the error is 'no more files' and the temp filename is not
 17013                                  ;	  the initial high tag, copy the temp to the child's name spot
 17014                                  ;	  and return success. Otherwise, send the error back to caller.
 17015                                  ;
 17016                                  ;	  This routine depends on DS,ES,CS, & SS all being equal.
 17017                                  
 17018                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17019                                  FindNextChild:
 17020 0000164C 83EC0C                  	sub	sp,12			; make temp filename buf on stack
 17021                                  	;shove	00FFh			; temp filename = high tag
 17022 0000164F B8FF00                  	mov	ax,0FFh
 17023 00001652 50                      	push	ax
 17024 00001653 89E5                    	mov	bp,sp			; BP = ptr to temp filename buf
 17025                                  	;shove	"*"	
 17026 00001655 B02A                    	mov	al,'*'  ; ax = 002Ah
 17027 00001657 50                      	push	ax
 17028                                  	;;shove	".*" 
 17029                                  	;mov	ax,"*."
 17030                                  	;mov	ax,2E2Ah
 17031 00001658 B42E                    	mov	ah,'.'
 17032 0000165A 50                      	push	ax
 17033 0000165B E83106                  	call	GetDriveLtr		; AX = "d:"
 17034 0000165E 50                      	push	ax
 17035 0000165F 89E2                    	mov	dx,sp			; DX = ptr to "d:*.*",0 on stack
 17036                                  
 17037                                  ;	See that the stack is restored properly at the end of this proc.
 17038                                  
 17039                                  	;mov	cx,10h
 17040 00001661 B91000                  	mov	cx,ATTR_DIRECTORY	; CX = attributes for file search
 17041 00001664 B44E                    	mov	ah,4Eh
 17042                                  	;mov	ah,Find_First
 17043 00001666 CD21                    	int	21h			; DOS- Find First matching file
 17044 00001668 722C                    	jc	short fcRet		; return error
 17045                                  
 17046 0000166A E89EFD                  	call	CheckChild		; check child against last, temp
 17047                                  fcNext:	
 17048                                  	;mov	cx,10h
 17049 0000166D B91000                  	mov	cx,ATTR_DIRECTORY	; CX = attributes for file search
 17050 00001670 B44F                    	mov	ah,4Fh
 17051                                  	;mov	ah,Find_Next
 17052 00001672 CD21                    	int	21h			; DOS- Find Next matching file
 17053 00001674 7205                    	jc	short fcErr		; examine error
 17054                                  
 17055 00001676 E892FD                  	call	CheckChild		; check child against last, temp
 17056 00001679 EBF2                    	jmp	short fcNext		; go find another child
 17057                                  
 17058                                  fcErr:
 17059 0000167B E8CD09                  	call	get_ext_error_number	; AX = extended error code
 17060                                  	;cmp	ax,18
 17061 0000167E 83F812                  	cmp	ax,ERROR_NO_MORE_FILES	; no more files?
 17062 00001681 7512                    	jne	short fcNope		; some other error- return it
 17063                                  
 17064                                  ;	We ran out of files. See if we qualified at least one.
 17065                                  
 17066 00001683 807E00FF                	cmp	byte [bp],0FFh
 17067 00001687 740C                    	je	short fcNope		; temp filename is unused- no child
 17068                                  
 17069                                  ;	Move temp filename to child name position.
 17070                                  
 17071 00001689 89EE                    	mov	si,bp			; SI = ptr to temp filename
 17072 0000168B 89DF                    	mov	di,bx			; DI = ptr to child name pos'n
 17073                                  fcMove:
 17074 0000168D AC                      	lodsb				; AL = next byte of filename
 17075 0000168E AA                      	stosb				; store byte
 17076 0000168F 08C0                    	or	al,al
 17077 00001691 7403                    	jz	short fcRet		; byte was zero, return success (CY clear)
 17078 00001693 EBF8                    	jmp	short fcMove		; go move another byte
 17079                                  fcNope:
 17080 00001695 F9                      	stc				; return error
 17081                                  fcRet:
 17082 00001696 9F                      	lahf
 17083 00001697 83C414                  	add	sp,20			; restore stack
 17084 0000169A 9E                      	sahf
 17085 0000169B C3                      	retn
 17086                                  
 17087                                  ; ---------------------------------------------------------------------------
 17088                                  
 17089                                  ;***	FindOneInMem - find the first available entry in TPA
 17090                                  ;***	FindNextInMem - find the next available entry in TPA
 17091                                  ;
 17092                                  ;	ENTRY	ES = TPA seg addr
 17093                                  ;		BX = ptr to entry in TPA
 17094                                  ;
 17095                                  ;	EXIT	BX = ptr to entry found
 17096                                  ;		CY = set if no more entries available in TPA
 17097                                  ;
 17098                                  ;	USED	AL
 17099                                  
 17100                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17101                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17102                                  FindOneInMem:
 17103 0000169C 268A07                  	mov	al,[es:bx]		; examine 'used' byte of starting entry
 17104 0000169F 3C01                    	cmp	al,1
 17105 000016A1 7406                    	je	short FindNextInMem	; entry has already been used
 17106 000016A3 3CFF                    	cmp	al,0FFh
 17107 000016A5 7407                    	je	short foNoMore		; 0FFh, we're at the end of the list
 17108                                  
 17109                                  ;	BX = ptr to entry that hasn't been output yet.
 17110                                  
 17111 000016A7 F8                      	clc				; return success
 17112 000016A8 C3                      	retn
 17113                                  
 17114                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17115                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:163Ah
 17116                                  FindNextInMem:
 17117                                  	; 07/06/2023
 17118                                  	;add	bx,21 ; MSDOS 5.0
 17119                                  	; 07/06/2023
 17120 000016A9 83C316                  	add	bx,22 ; MSDOS 6.0  ; size EntryStruc (22 = 21 + compratio)
 17121                                  	;add	bx,size EntryStruc	; BX = ptr to next entry
 17122 000016AC EBEE                    	jmp	short FindOneInMem	; go look at it
 17123                                  foNoMore:
 17124 000016AE F9                      	stc				; ran out of entries, return failure
 17125 000016AF C3                      	retn
 17126                                  
 17127                                  ; ---------------------------------------------------------------------------
 17128                                  
 17129                                  ;***	GetEnvValue - get value of our environment variable
 17130                                  ;
 17131                                  ;	ENTRY	DS, ES = TRANGROUP seg addr
 17132                                  ;
 17133                                  ;	EXIT	CY = set if environment variable not in environment
 17134                                  ;
 17135                                  ;		Otherwise:
 17136                                  ;		SI = ptr to environment variable asciiz value in TRANGROUP
 17137                                  ;
 17138                                  ;	USED	AX,BX,CX,DX,DI
 17139                                  ;		(We assume the (almost) worst, since we don't know about
 17140                                  ;		Find_Name_In_Environment.)
 17141                                  ;
 17142                                  ;	EFFECTS
 17143                                  ;
 17144                                  ;	  ScanBuf is loaded with value text
 17145                                  
 17146                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17147                                  GetEnvValue:
 17148 000016B0 06                      	push	es				; save ES
 17149                                  	;mov	si,offset TRANGROUP:DirEnvVar	; DS:SI = ptr to variable name
 17150 000016B1 BE[0593]                	mov	si,DirEnvVar	; "DIRCMD="
 17151                                  	;invoke	Find_Name_In_Environment
 17152 000016B4 E80010                  	call	find_name_in_environment
 17153 000016B7 7214                    	jc	short geRet			; name not found in environment
 17154                                  
 17155                                  ;	ES:DI = ptr to value of environment variable
 17156                                  ;	We're assuming DS, CS, and SS are unchanged.
 17157                                  
 17158 000016B9 1E                      	push	ds
 17159 000016BA 06                      	push	es
 17160 000016BB 1F                      	pop	ds
 17161 000016BC 07                      	pop	es
 17162                                  
 17163                                  	;assume	ds:nothing
 17164                                  
 17165                                  ;	DS = seg addr of environment variable value (in environment segment)
 17166                                  ;	ES = TRANGROUP seg addr
 17167                                  
 17168 000016BD 89FE                    	mov	si,di				; DS:SI = ptr to value string
 17169                                  	;mov	di,offset TRANGROUP:ScanBuf	; ES:DI = ptr to dest buffer
 17170 000016BF BF[7B9E]                	mov	di,ScanBuf
 17171                                  geLoop:
 17172                                  ;@@:	
 17173 000016C2 AC                      	lodsb
 17174 000016C3 08C0                    	or	al,al
 17175 000016C5 AA                      	stosb
 17176                                  	;loopnz	@B		; move the string, including trailing null
 17177 000016C6 E0FA                    	loopnz	geLoop
 17178                                  
 17179 000016C8 06                      	push	es
 17180 000016C9 1F                      	pop	ds		; DS = TRANGROUP seg addr again
 17181                                  	;assume	ds:TRANGROUP
 17182                                  
 17183                                  	;mov	si,offset TRANGROUP:ScanBuf	; SI = ptr to var value
 17184 000016CA BE[7B9E]                	mov	si,ScanBuf
 17185                                  geRet:
 17186 000016CD 07                      	pop	es				; restore ES
 17187 000016CE C3                      	retn
 17188                                  
 17189                                  ; ---------------------------------------------------------------------------
 17190                                  
 17191                                  ;***	GetFirst - get first directory entry from disk
 17192                                  ;
 17193                                  ;	ENTRY	DOS DTA established at DirBuf
 17194                                  ;		FCB contains drive # and filename
 17195                                  ;		Current directory (on selected drive) is the one to search
 17196                                  ;		AttrSpecified & AttrSelect masks set
 17197                                  ;
 17198                                  ;	EXIT	CY = clear if success
 17199                                  ;		DirBuf contains extended FCB for file found
 17200                                  ;
 17201                                  ;		If unsuccessful,
 17202                                  ;		CY = set
 17203                                  ;		Ready for DOS Get Extended Error call
 17204                                  ;
 17205                                  ;	USED	AX,DX
 17206                                  ;
 17207                                  ;	EFFECTS
 17208                                  ;
 17209                                  ;	  FCB-7 = 0FFh to mark extended FCB
 17210                                  ;	  FCB-1 = attribute mask to find all files
 17211                                  ;	  These fields should remain unmodified for GetNext calls.
 17212                                  ;
 17213                                  ;***	GetNext - get next directory entry from disk
 17214                                  ;
 17215                                  ;	ENTRY	As for GetFirst, plus
 17216                                  ;		FCB-7 set up as extended FCB w/ find-all attribute byte
 17217                                  ;
 17218                                  ;	EXIT	As for GetFirst
 17219                                  ;
 17220                                  ;	USED	AX,DX
 17221                                  
 17222                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17223                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:144Fh
 17224                                  
 17225                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17226                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1660h
 17227                                  GetFirst:
 17228                                  	;mov	byte [55h],0FFh	; -1
 17229 000016CF C6065500FF              	mov	byte [FCB-7],0FFh	; signal extended FCB
 17230                                  	;mov	byte [5Bh],16h
 17231 000016D4 C6065B0016              	mov	byte [FCB-1],ATTR_ALL ; 16h
 17232                                  					; find any file
 17233                                  	; 07/06/2023
 17234                                  	;mov	dx,FCB-7 ; 55h		; DX = ptr to extended FCB
 17235 000016D9 B411                    	mov	ah,11h
 17236                                  	;mov	ah,Dir_Search_First	; AH = DOS Find First function code
 17237                                  	; 07/06/2023
 17238                                  	;int	21h			; call DOS
 17239                                  	;shl	al,1			; CY = set if error
 17240                                  	;jc	short gfRet		; return error
 17241                                  	;jmp	short gfFound		; go look at attr's
 17242                                  	; 07/06/2023
 17243 000016DB EB02                    	jmp	short GetFrstNxt
 17244                                  GetNext:
 17245                                  	; 07/06/2023
 17246                                  	;;mov	dx,55h
 17247                                  	;mov	dx,FCB-7		; DX = ptr to extended FCB
 17248 000016DD B412                    	mov	ah,12h
 17249                                  	;mov	ah,Dir_Search_Next	; AH = DOS Find Next function code
 17250                                  GetFrstNxt:
 17251                                  	; 07/06/2023
 17252 000016DF BA5500                  	mov	dx,FCB-7 ; mov dx,55h
 17253                                  	;
 17254 000016E2 CD21                    	int	21h			; call DOS
 17255 000016E4 D0E0                    	shl	al,1			; CY = set if error
 17256 000016E6 7211                    	jc	short gfRet		; return error
 17257                                  
 17258                                  ;*	Found an entry. Check attributes.
 17259                                  gfFound:
 17260                                  	;;mov	al,[DirBuf+8].dir_attr	; AL = file attributes
 17261                                  	;mov	al,[DIRBUF+19]
 17262 000016E8 A0[4C9D]                	mov	al,[DIRBUF+8+DIR_ENTRY.DIR_ATTR]
 17263 000016EB 8A26[939D]              	mov	ah,[AttrSpecified]	; AH = mask of pertinent attr's
 17264 000016EF 20E0                    	and	al,ah			; AL = pertinent attr's of file
 17265 000016F1 2226[949D]              	and	ah,[AttrSelect]		; AH = attr settings to match
 17266 000016F5 38E0                    	cmp	al,ah
 17267 000016F7 75E4                    	jne	short GetNext		; attr's don't match, look for another
 17268                                  gfRet:
 17269 000016F9 C3                      	retn
 17270                                  
 17271                                  ; ---------------------------------------------------------------------------
 17272                                  
 17273                                  ;***	ListDir - search for and list files in the current directory
 17274                                  ;
 17275                                  ;	List header, files, and trailer for current directory on selected
 17276                                  ;	drive. Header & trailer are listed if at least one file is found.
 17277                                  ;	If no qualifying files are found, no display output occurs.
 17278                                  ;
 17279                                  ;	ENTRY	Current directory (on selected drive) is the one to be listed
 17280                                  ;		FCB contains selected drive # and filename spec
 17281                                  ;		Option bits, attribute masks, and sort codes set up
 17282                                  ;
 17283                                  ;	EXIT	CY = clear if no error
 17284                                  ;		FileCnt = # files found & displayed
 17285                                  ;
 17286                                  ;		If error,
 17287                                  ;		CY = set
 17288                                  ;		Ready for DOS Get Extended Error call
 17289                                  ;
 17290                                  ;	USED	AX,BX,CX,DX,SI,DI,BP
 17291                                  ;		FileSiz
 17292                                  ;
 17293                                  ;	EFFECTS
 17294                                  ;
 17295                                  ;	  FileCntTotal, FileSizTotal are updated.
 17296                                  ;	  Files found are listed. A directory header and trailer are
 17297                                  ;	   displayed only if files are found.
 17298                                  
 17299                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17300                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:155Eh
 17301                                  
 17302                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17303                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1694h
 17304                                  
 17305                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 17306                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1776h
 17307                                  ListDir:
 17308 000016FA 31C0                    	xor	ax,ax ; 0
 17309 000016FC A3[209C]                	mov	[FileCnt],ax		; zero file count
 17310 000016FF A3[229C]                	mov	[FileSiz],ax		; zero file size accumulator
 17311 00001702 A3[249C]                	mov	[FileSiz+2],ax
 17312                                  
 17313                                  ; 31/07/2024
 17314                                  ; PCDOS 7.1 COMMAND.COM
 17315                                  %if 1
 17316 00001705 A3[269C]                	mov	[FileSiz+4],ax
 17317 00001708 A3[289C]                	mov	[FileSiz+6],ax	
 17318                                  %else
 17319                                  	; 08/06/2023
 17320                                  	; MSDOS 6.0
 17321                                  ;ifdef DBLSPACE_HOOKS
 17322                                  	mov	[ccluUsedDir],ax 	; zero count clusters used
 17323                                  	mov	[csecUsedDir],ax	; zero count compressed sectors used
 17324                                  	mov	[csecUsedDir+2],ax
 17325                                  ;endif
 17326                                  %endif	
 17327                                  	;cmp	byte [DestBuf],0	; check for sort code
 17328                                  	; 31/07/2024
 17329 0000170B 3806[BE9D]              	cmp	[DestBuf],al ; 0
 17330 0000170F 740A                    	je	short ld1		; no sort
 17331 00001711 E83000                  	call	LoadEntries		; load entries for sorted listing
 17332 00001714 7305                    	jnc	short ld1		; no error - continue
 17333 00001716 E83209                  	call	get_ext_error_number	; AX = DOS error code
 17334                                  	; 19/02/2023
 17335                                  	;stc
 17336 00001719 EB12                    	jmp	short ldErr		; return error
 17337                                  ld1:
 17338 0000171B E8DAFE                  	call	FindFirst		; find first file
 17339 0000171E 720D                    	jc	short ldErr		; not found, return error
 17340                                  
 17341                                  ;	BX = offset in TPA buffer of entry found
 17342                                  
 17343 00001720 E82203                  	call	DisplayHeader		; if at least one file, display header
 17344                                  ldNext:
 17345 00001723 E8FA02                  	call	DisplayFile		; display the file entry
 17346                                  ;ldNext:
 17347 00001726 E8D4FE                  	call	FindNext		; find another file
 17348 00001729 7202                    	jc	short ldErr		; not found
 17349                                  	;call	DisplayFile		; display entry
 17350                                  	;jmp	short ldNext		; go find another one
 17351                                  	; 19/02/2023
 17352 0000172B EBF6                    	jmp	short ldNext
 17353                                  ldErr:
 17354                                  	;cmp	ax,2
 17355 0000172D 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND
 17356 00001730 7407                    	je	short ldDone		; file not found, we're done
 17357                                  	;cmp	ax,18
 17358 00001732 83F812                  	cmp	ax,ERROR_NO_MORE_FILES
 17359 00001735 7402                    	je	short ldDone		; no more files, we're done
 17360 00001737 F9                      	stc
 17361                                  	;jmp	short ldRet
 17362                                  	; 19/02/2023
 17363 00001738 C3                      	retn
 17364                                  ldDone:
 17365 00001739 833E[209C]00            	cmp	word [FileCnt],0
 17366                                  	;je	short ld2		; no files found, just return
 17367                                  	; 25/04/2023
 17368 0000173E 7403                    	jz	short ldRet
 17369 00001740 E8A104                  	call	DisplayTrailer		; display trailing info
 17370                                  	; 08/06/2023
 17371                                  	; cf=0
 17372                                  ;ld2:	
 17373                                  	;clc				; return success
 17374                                  ldRet:
 17375 00001743 C3                      	retn
 17376                                  
 17377                                  ; ---------------------------------------------------------------------------
 17378                                  
 17379                                  ;***	LoadEntries - attempt to load entries from current directory
 17380                                  ;
 17381                                  ;	Load all qualifying directory entries from the current directory
 17382                                  ;	into the TPA. If an error is returned by FindFirst/FindNext calls
 17383                                  ;	other than 'no more files', return to caller with carry flag set.
 17384                                  ;	If we run out of buffer space, display a message that we haven't
 17385                                  ;	enough memory to sort this directory, but return without error.
 17386                                  ;	Other routines know whether or not entries have been loaded by
 17387                                  ;	the 'inmem' flag bit, which we set here.
 17388                                  ;
 17389                                  ;	The TPA is usually 64K - 512 bytes long. At 20 bytes per entry,
 17390                                  ;	this allows sorting over 3000 entries in a directory.
 17391                                  ;
 17392                                  ;	ENTRY	Tpa = buffer seg addr
 17393                                  ;		BytCnt = buffer length, in bytes
 17394                                  ;		Current directory (on selected drive) is the one to load
 17395                                  ;		FCB contains drive # and filespec
 17396                                  ;		Bits, AttrSpecified, AttrSelect, & DestBuf (sort codes) are set
 17397                                  ;
 17398                                  ;	EXIT	CY = set if error
 17399                                  ;		If error, DOS Get Extended Error will get error info
 17400                                  ;
 17401                                  ;	USED	AX,CX,DX,SI,DI
 17402                                  ;
 17403                                  ;	EFFECTS
 17404                                  ;
 17405                                  ;	  Inmem bit of Bits = set if load succeeded.
 17406                                  ;	  Tpa buffer contains directory entries.
 17407                                  ;	  Byte after last entry = 0FFh.
 17408                                  
 17409                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17410                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17411                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 17412                                  LoadEntries:
 17413 00001744 06                      	push	es			; save TRANGROUP seg addr
 17414 00001745 8E06[F79B]              	mov	es,[TPA]		; ES = TPA seg addr
 17415 00001749 31FF                    	xor	di,di			; ES:DI = destination ptr
 17416                                  	;;;and	Bits,not mask inmem	; signal entries not loaded
 17417                                  	; MSDOS 5.0
 17418                                  	;;;and	word [_Bits],0FFDFh
 17419                                  	;;and	byte [_Bits],0DFh	; not 20h
 17420                                  	; 31/07/2024
 17421                                  	;and	word [_Bits],0FF7Fh ; PCDOS 7.1 COMMAND.COM
 17422                                  	; 08/06/2023
 17423                                  	;and	byte [_Bits],0BFh	; ~20h ; MSDOS 6.0
 17424 0000174B 8026[8B9D]7F            	and	byte [_Bits],~mask.inmem ; 0BFh ; MSDOS 6.0
 17425                                  			; 31/07/2024	; 07Fh ; PCDOS 7.1
 17426                                  
 17427 00001750 E87CFF                  	call	GetFirst		; look for first file
 17428 00001753 7221                    	jc	short leRet		; return any error
 17429 00001755 E82000                  	call	LoadEntry		; load entry into TPA
 17430                                  leNext:
 17431 00001758 E882FF                  	call	GetNext			; get another file
 17432 0000175B 720F                    	jc	short leLoaded		; assume any error is no more files
 17433 0000175D A1[159C]                	mov	ax,[BYTCNT]		; AX = size of TPA
 17434 00001760 29F8                    	sub	ax,di			; AX = bytes left in TPA
 17435                                  	; 08/06/2023
 17436                                  	;;cmp	ax,size EntryStruc+2	; insist on entry size + 2 bytes
 17437                                  	;cmp	ax,23 ; 21+2 ; MSDOS 5.0
 17438 00001762 83F818                  	cmp	ax,24 ; 22+2 ; MSDOS 6.0
 17439 00001765 720E                    	jb	short leOk		; not enough memory left, give up
 17440 00001767 E80E00                  	call	LoadEntry		; load entry into TPA
 17441 0000176A EBEC                    	jmp	short leNext		; go get another file
 17442                                  
 17443                                  leLoaded:
 17444 0000176C 26C605FF                	mov	byte [es:di],0FFh	; mark end of entry list
 17445                                  	;;;or	Bits,mask inmem		; signal entries loaded in memory
 17446                                  	; MSDOS 5.0
 17447                                  	;;or	word [_Bits],20h
 17448                                  	;or	byte [_Bits],20h
 17449                                  	; 08/06/2023
 17450                                  	;or	byte [_Bits],40h	; MSDOS 6.0
 17451 00001770 800E[8B9D]80            	or	byte [_Bits],mask.inmem ; 40h ; MSDOS 6.0 
 17452                                  			; 31/07/2024	; 80h ; PCDOS 7.1	
 17453                                  	; 25/04/2023
 17454                                  	; cf = 0
 17455                                  leOk:
 17456 00001775 F8                      	clc				; return no error
 17457                                  leRet:
 17458 00001776 07                      	pop	es			; ES = TRANGROUP seg addr again
 17459 00001777 C3                      	retn
 17460                                  
 17461                                  ; ---------------------------------------------------------------------------
 17462                                  
 17463                                  ;***	LoadEntry - load directory entry from DirBuf ext'd FCB
 17464                                  ;
 17465                                  ;	ENTRY	ES:DI = ptr to load point in TPA
 17466                                  ;		DirBuf contains extended FCB of entry to load
 17467                                  ;
 17468                                  ;	EXIT	ES:DI = ptr to next byte available in TPA
 17469                                  ;
 17470                                  ;	USED	AX,CX,SI
 17471                                  ;
 17472                                  ;	NOTES
 17473                                  ;
 17474                                  ;	  I could've used symbolic offsets and sizes of fields from
 17475                                  ;	   the dir_entry struc to do this, but this is time-critical,
 17476                                  ;	   so I hard-wired the structure of the DOS 4.x returned FCB,
 17477                                  ;	   as well as our private directory entry structure.
 17478                                  ;
 17479                                  ;	  We force a zero size for subdirectory files. A zero size is
 17480                                  ;	   ordinarily returned for subdirectories, but with Novell
 17481                                  ;	   Netware 286 or 386 loaded, we can't depend on it. Bug #1594.
 17482                                  
 17483                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17484                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:15DDh
 17485                                  	
 17486                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17487                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:171Ch
 17488                                  
 17489                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 17490                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:17FDh
 17491                                  LoadEntry:
 17492                                  	;mov	si,offset TRANGROUP:Dirbuf+8	; DS:SI = ptr to filename
 17493 00001778 BE[419D]                	mov	si,DIRBUF+8
 17494 0000177B 30C0                    	xor	al,al				; AL = 0
 17495 0000177D AA                      	stosb					; 'used' byte = false
 17496 0000177E B90B00                  	mov	cx,11
 17497 00001781 F3A4                    	rep	movsb				; transfer filename & extension
 17498 00001783 AC                      	lodsb					; AL = attrib byte
 17499 00001784 AA                      	stosb					; store attrib byte
 17500                                  	;add	si,10 ; 22-11-1
 17501                                  	;add	si,dir_time-dir_attr-1		; skip to time field
 17502 00001785 83C60A                  	add	si,(DIR_ENTRY.DIR_TIME-DIR_ENTRY.DIR_ATTR)-1
 17503 00001788 A5                      	movsw					; transfer time
 17504 00001789 A5                      	movsw					; transfer date
 17505                                  
 17506                                  ; 08/06/2023
 17507                                  ; MSDOS 5.0
 17508                                  %if 0
 17509                                  	inc	si				; skip alloc unit
 17510                                  	inc	si
 17511                                  	;and	al,10h
 17512                                  	and	al,ATTR_DIRECTORY
 17513                                  	jnz	short leSetDirSize		; force zero size for subdir
 17514                                  	movsw
 17515                                  	movsw					; transfer size
 17516                                  	retn
 17517                                  leSetDirSize:
 17518                                  	xor	ax,ax ; 0
 17519                                  	stosw
 17520                                  	stosw					; store zero size
 17521                                  	retn
 17522                                  %endif
 17523                                  
 17524                                  ; 08/06/2023
 17525                                  ; MSDOS 6.0
 17526                                  ;%if 1
 17527                                  ;ifdef DBLSPACE_HOOKS
 17528 0000178A 88C1                    	mov	cl,al				; attrib to cl
 17529 0000178C AD                      	lodsw					; allocation unit (cluster
 17530                                  	;and	cl,10h
 17531 0000178D 80E110                  	and	cl,ATTR_DIRECTORY
 17532 00001790 7506                    	jnz	short leSetDirSize		; force zero size for subdir
 17533 00001792 A5                      	movsw
 17534 00001793 A5                      	movsw					; transfer size
 17535                                  
 17536                                  ; 31/07/2024 - Retro DOS 5.0 - PCDOS 7.1 COMMAND.COM
 17537                                  %if 0
 17538                                  	;;test	word [_Bits],1
 17539                                  	;test	word [_Bits],mask.cratio	; compression ratio report?
 17540                                  	test	byte [_Bits],mask.cratio
 17541                                  	jnz	short leCalcRatio		; yup
 17542                                  %endif
 17543                                  
 17544 00001794 31C0                    	xor	ax,ax
 17545 00001796 AA                      	stosb					; dummy compression ratio
 17546 00001797 C3                      	retn
 17547                                  
 17548                                  ; 31/07/2024 - Retro DOS 5.0 - PCDOS 7.1 COMMAND.COM
 17549                                  %if 0
 17550                                  leCalcRatio:
 17551                                  	call	CalcCompRatio			; takes cluster in AX
 17552                                  	or	ax,ax				;   returns ratio in AX
 17553                                  	jz	short leNoRatio			; 0 means couldn't calculate
 17554                                  	dec	ah				; pack 1.0 - 16.0 comp ratio
 17555                                  	mov	cl,4				;   into 2 nibbles.  Store
 17556                                  	shl	ah,cl				;   1-16 as 0-15 in hi nibble,
 17557                                  	or	al,ah				;   tenths (0-9) in low nibble
 17558                                  	stosb
 17559                                  	retn
 17560                                  %endif
 17561                                  
 17562                                  leSetDirSize:
 17563 00001798 31C0                    	xor	ax,ax ; 0
 17564 0000179A AB                      	stosw
 17565 0000179B AB                      	stosw					; store zero size
 17566                                  leNoRatio:
 17567 0000179C FEC8                    	dec	al				; al = FFh = special invalid
 17568 0000179E AA                      	stosb					; compression ratio
 17569 0000179F C3                      	retn
 17570                                  ;endif
 17571                                  ;%endif
 17572                                  
 17573                                  ; ---------------------------------------------------------------------------
 17574                                  
 17575                                  ;***	NoOrder - turn sorting off
 17576                                  ;
 17577                                  ;	ENTRY	nothing
 17578                                  ;
 17579                                  ;	EXIT	CY clear
 17580                                  ;
 17581                                  ;	USED	AX
 17582                                  ;
 17583                                  ;	EFFECTS
 17584                                  ;
 17585                                  ;	  DestBuf is updated with sort code bytes. See DestBuf description.
 17586                                  
 17587                                  	; 19/02/2023
 17588                                  NoOrder:
 17589 000017A0 C606[BE9D]00            	mov	byte [DestBuf],0
 17590                                  				; no sort
 17591 000017A5 F8                      	clc			; no error
 17592 000017A6 C3                      	retn
 17593                                  
 17594                                  ; ---------------------------------------------------------------------------
 17595                                  
 17596                                  ;***	OnOffSw - record occurence of on/off option switch
 17597                                  ;
 17598                                  ;	ENTRY	DI = index into word list of switches
 17599                                  ;
 17600                                  ;	EXIT	CY clear
 17601                                  ;
 17602                                  ;	USED	AX,CX
 17603                                  ;
 17604                                  ;	EFFECTS
 17605                                  ;
 17606                                  ;	  Bits modified to indicate option state.
 17607                                  
 17608                                  	; 19/02/2023
 17609                                  OnOffSw:
 17610 000017A7 89F9                    	mov	cx,di		; CX = index into word list of options
 17611 000017A9 D1E9                    	shr	cx,1
 17612 000017AB D1E9                    	shr	cx,1		; CX = bit position of option
 17613 000017AD B80100                  	mov	ax,1		
 17614 000017B0 D3E0                    	shl	ax,cl		; AX = bit mask of option
 17615 000017B2 F7C70200                	test	di,2		; check if it is a negated option
 17616 000017B6 7405                    	jz	short oo1	; it's negated
 17617                                  	;or	Bits,ax		; turn option on
 17618 000017B8 0906[8B9D]              	or	[_Bits],ax
 17619                                  	;jmp	short ooRet
 17620                                  	; 19/02/2023
 17621                                  	;cf=0
 17622 000017BC C3                      	retn
 17623                                  oo1:	
 17624 000017BD F7D0                    	not	ax		; AX = complemented bit mask of option
 17625                                  	;and	Bits,ax		; turn option off
 17626 000017BF 2106[8B9D]              	and	[_Bits],ax
 17627                                  ooRet:
 17628                                  	; 19/02/2023
 17629                                  	;cf=0
 17630                                  	;clc			; always return success
 17631 000017C3 C3                      	retn
 17632                                  
 17633                                  ; ---------------------------------------------------------------------------
 17634                                  
 17635                                  ;***	ParseAttr - parse and record /A option
 17636                                  ;
 17637                                  ;	ENTRY	BX = ptr to system parser result buffer for /A occurence
 17638                                  ;
 17639                                  ;	EXIT	CY = set if error occurs parsing attribute conditions
 17640                                  ;
 17641                                  ;		For parse error, we set up for Std_EPrintf call:
 17642                                  ;		AX = parse error code, like system parser
 17643                                  ;		DX = ptr to message block
 17644                                  ;
 17645                                  ;	USED	AX,CX,DX,DI
 17646                                  ;
 17647                                  ;	EFFECTS
 17648                                  ;
 17649                                  ;	  AttrSpecified, AttrSelect are updated with new attribute conditions.
 17650                                  ;	  If parse error occurs, attribute conditions parsed so far hold.
 17651                                  ;
 17652                                  ;	  For parse error, we set up for Std_EPrintf call:
 17653                                  ;	  Msg_Disp_Class = parse error message class
 17654                                  ;	  Message block (see DX) is set up for parse error message
 17655                                  
 17656                                  	; 19/02/2023
 17657                                  ParseAttr:
 17658 000017C4 56                      	push	si			; save SI
 17659 000017C5 C606[939D]00            	mov	byte [AttrSpecified],0	; cancel all attribute conditions
 17660                                  
 17661                                  ;	Each /A invocation starts by assuming all files are to be listed.
 17662                                  
 17663                                  	;;mov	si,word ptr [bx].ValuePtr
 17664                                  					; SI = ptr to string after /A
 17665                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 17666 000017CA 8B7704                  	mov	si,[bx+4]
 17667                                  paLoop:	
 17668 000017CD BA0100                  	mov	dx,1			; DX = 1 (for un-negated attribute)
 17669 000017D0 AC                      	lodsb				; AL = next char in string
 17670 000017D1 08C0                    	or	al,al
 17671                                  	;jz	short paOk		; it's terminating null, we're done
 17672                                  	; 19/02/2023
 17673 000017D3 742F                    	jz	short paRet ; cf=0
 17674 000017D5 3C2D                    	cmp	al,'-'
 17675 000017D7 7502                    	jne	short pa1		; not '-', go look for letter
 17676 000017D9 4A                      	dec	dx			; DX = 0 (for negated attribute)
 17677 000017DA AC                      	lodsb				; AL = next char
 17678                                  pa1:	
 17679                                  	;mov	di,offset TRANGROUP:AttrLtrs 
 17680                                  					; DI = ptr to attrib letter list
 17681 000017DB BF[D895]                	mov	di,AttrLtrs ; "RHSvDA"
 17682                                  	;mov	cx,6
 17683 000017DE B90600                  	mov	cx,NUM_ATTR_LTRS ; 6	; CX = length of attrib letter list
 17684 000017E1 F2AE                    	repne	scasb			; look for our letter in the list
 17685 000017E3 751B                    	jne	short paErr		; not found, return error
 17686                                  
 17687 000017E5 F7D1                    	not	cx
 17688                                  	;add	cx,6
 17689 000017E7 83C106                  	add	cx,NUM_ATTR_LTRS	; CX = attrib bit #, 0-5
 17690                                  
 17691                                  ;	Note that we rely on AttrLtrs to be in the attribute bit order,
 17692                                  ;	starting from bit 0.
 17693                                  
 17694                                  ;	Record this attribute bit in AttrSpecified.
 17695                                  
 17696 000017EA B001                    	mov	al,1
 17697 000017EC D2E0                    	shl	al,cl			; AL = mask for our bit
 17698 000017EE 0806[939D]              	or	[AttrSpecified],al	; set it in the 'specified' mask
 17699                                  
 17700                                  ;	Record the selected state for this attribute in AttrSelect.
 17701                                  ;	DX = 0 or 1, the selected state for this attribute.
 17702                                  
 17703 000017F2 F6D0                    	not	al			; AL = mask for all other bits
 17704 000017F4 2006[949D]              	and	[AttrSelect],al		; clear our bit
 17705 000017F8 D2E2                    	shl	dl,cl			; DL = our bit state in position
 17706 000017FA 0816[949D]              	or	[AttrSelect],dl		; set selected attr state
 17707 000017FE EBCD                    	jmp	short paLoop		; go look at next char
 17708                                  
 17709                                  ;	The attribute letter string is invalid.
 17710                                  
 17711                                  paErr:	
 17712 00001800 E89D04                  	call	SetupParamError		; set message up for Std_EPrintf
 17713 00001803 F9                      	stc		   		; return error
 17714                                  	; 19/02/2023
 17715                                  	;jmp	short paRet
 17716                                  ;paOk:
 17717                                  	;clc				; return success		
 17718                                  paRet:	
 17719 00001804 5E                      	pop	si			; restore SI
 17720 00001805 C3                      	retn
 17721                                  
 17722                                  ; ---------------------------------------------------------------------------
 17723                                  
 17724                                  ;***	ParseLine - parse a line of text
 17725                                  ;
 17726                                  ;	Parse text until an EOL (CR or NUL) is found, or until a parse
 17727                                  ;	error occurs.
 17728                                  ;
 17729                                  ;	ENTRY	DS:SI = ptr to text
 17730                                  ;		CS, DS, ES = TRANGROUP seg addr
 17731                                  ;
 17732                                  ;	EXIT	AX = last return code from system parser
 17733                                  ;		CX = # positional parameters (pathnames) found - 0 or 1
 17734                                  ;
 17735                                  ;		If parse error occurred, we're set up for Std_EPrintf call:
 17736                                  ;		DX = ptr to message block
 17737                                  ;
 17738                                  ;	USED	BX,CX,DX,SI,DI
 17739                                  ;
 17740                                  ;	EFFECTS
 17741                                  ;
 17742                                  ;	  Bits may contain new option settings.
 17743                                  ;	  DestBuf may contain new series of sort codes.
 17744                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 17745                                  ;	  SrcBuf may contain a new default pathname/filespec.
 17746                                  ;	  PathPos, PathCnt updated for new pathname.
 17747                                  ;
 17748                                  ;	  If parse error occurred, we're set up for Std_EPrintf call:
 17749                                  ;	  Msg_Disp_Class = parse error class
 17750                                  ;	  Byte after last parameter in text is zeroed to make ASCIIZ string
 17751                                  ;	  Message block (see DX) is set up for parse error message
 17752                                  
 17753                                  	; 19/02/2023
 17754                                  Parse_Line:
 17755                                  	; 04/05/2023
 17756 00001806 BF[A596]                	mov	di,PARSE_DIR		; ES:DI = ptr to parse block
 17757 00001809 31C9                    	xor	cx,cx			; CX = # positionals found
 17758                                  plPars:
 17759 0000180B E84D0D                  	call	Parse_With_Msg		; call parser
 17760 0000180E 83F8FF                  	cmp	ax,-1
 17761                                  	;cmp	ax,END_OF_LINE ; 0FFFFh ; -1
 17762 00001811 7411                    	je	short plRet		; EOL encountered, return
 17763 00001813 83F800                  	cmp	ax,RESULT_NO_ERROR ; 0
 17764 00001816 750C                    	jne	short plRet		; parse error occurred, return
 17765                                  
 17766                                  ;	Parse call succeeded. We have a filespec or a switch.
 17767                                  ;	DX = ptr to result buffer
 17768                                  
 17769 00001818 89D3                    	mov	bx,dx			; BX = ptr to parse result buffer
 17770 0000181A 803F05                  	cmp	byte [bx],RESULT_FILESPEC ; 5
 17771 0000181D 7406                    	je	short plFil		; we have a filespec
 17772                                  
 17773 0000181F E85900                  	call	ParseSwitch		; else we have a switch
 17774                                  	;jc	short plRet		; error parsing switch, return
 17775                                  	;jmp	short plPars		; parse more
 17776                                  	; 19/02/2023
 17777 00001822 73E7                    	jnc	short plPars
 17778                                  plRet:
 17779 00001824 C3                      	retn	
 17780                                  plFil:	
 17781 00001825 E8BA00                  	call	CopyPathname		; copy pathname into our buffer
 17782 00001828 EBE1                    	jmp	short plPars		; parse more
 17783                                  ;plRet:
 17784                                  ;	retn
 17785                                  
 17786                                  ; ---------------------------------------------------------------------------
 17787                                  
 17788                                  ;***	ParseOrder - parse and record /O option
 17789                                  ;
 17790                                  ;	ENTRY	BX = ptr to system parser result buffer for /O occurence
 17791                                  ;
 17792                                  ;	EXIT	CY = set if error occurs parsing order
 17793                                  ;
 17794                                  ;		For parse error, we set up for Std_EPrintf call:
 17795                                  ;		AX = parse error code, like system parser
 17796                                  ;		DX = ptr to message block
 17797                                  ;
 17798                                  ;	USED	AX,CX,DX,DI
 17799                                  ;
 17800                                  ;	EFFECTS
 17801                                  ;
 17802                                  ;	  DestBuf is updated with sort code bytes. See DestBuf description.
 17803                                  ;
 17804                                  ;	  For parse error, we set up for Std_EPrintf call:
 17805                                  ;	  Msg_Disp_Class = parse error message class
 17806                                  ;	  Message block (see DX) is set up for parse error message
 17807                                  
 17808                                  	; 19/02/2023 - Retro DOS v4.0 COMMAND.COM
 17809                                  	;
 17810                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17811                                  	; MSDOS 6.22 COMMAND.COM
 17812                                  ParseOrder:
 17813 0000182A 56                      	push	si			; save SI
 17814 0000182B 53                      	push	bx			; save ptr to result buffer
 17815                                  
 17816                                  	;;mov	si,word ptr [bx].ValuePtr
 17817                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 17818 0000182C 8B7704                  	mov	si,[bx+4]		; SI = ptr to order letters
 17819                                  	;mov	bx,offset TRANGROUP:DestBuf
 17820                                  	; 08/06/2023
 17821 0000182F BB[BE9D]                	mov	bx,DestBuf		; BX = ptr to sort code buffer
 17822 00001832 8A04                    	mov	al,[si]			; AL = 1st char of order string
 17823 00001834 08C0                    	or	al,al
 17824 00001836 750E                    	jnz	short poLtr		; not NUL, go parse letters
 17825                                  
 17826                                  ;	We have /O alone. Set standard sort order.
 17827                                  ;	Note hardwired dependency on character order in OrderLtrs.
 17828                                  
 17829 00001838 C60705                  	mov	byte [bx],5		; sort 1st by group (subdirs 1st)
 17830 0000183B 43                      	inc	bx
 17831 0000183C C60701                  	mov	byte [bx],1		; then by name
 17832 0000183F 43                      	inc	bx
 17833 00001840 C60702                  	mov	byte [bx],2		; then by extension
 17834 00001843 43                      	inc	bx
 17835 00001844 EB2F                    	jmp	short poOk		; return success
 17836                                  
 17837                                  ;	We have /O<something>. Parse sort order letters.
 17838                                  
 17839                                  poLtr:	
 17840 00001846 30D2                    	xor	dl,dl			; DL = 0 (upward sort)
 17841 00001848 AC                      	lodsb				; AL = next sort order letter
 17842 00001849 08C0                    	or	al,al
 17843 0000184B 7428                    	jz	short poOk		; NUL found, return success
 17844                                  
 17845 0000184D 3C2D                    	cmp	al,'-'
 17846 0000184F 7503                    	jne	short po1		; not '-', go look for letter
 17847 00001851 B280                    	mov	dl,80h			; DL = downward sort mask
 17848 00001853 AC                      	lodsb				; AL = next char
 17849                                  po1:
 17850                                  	;mov	di,offset TRANGROUP:OrderLtrs
 17851                                  	; 08/06/2023
 17852 00001854 BF[DE95]                	mov	di,OrderLtrs ;"NEDSGC"	; DI = ptr to list of letters
 17853                                  	; (NUM_ORDER_LTRS = 6 for MSDOS 6.22 COMMAND.COM)
 17854                                  	; ((N,E,D,S,G for MSDOS 5.0 and N,E,D,S,G,C for MSDOS 6.22)) 
 17855                                  	;mov	cx,6 ; 08/06/2023
 17856 00001857 B90600                  	mov	cx,NUM_ORDER_LTRS ; 5	; CX = length of list
 17857 0000185A F2AE                    	repne	scasb			; look for our letter in the list
 17858 0000185C 7510                    	jne	short poErr		; not found, return error
 17859                                  
 17860 0000185E F7D9                    	neg	cx
 17861                                  	;add	cx,6 ; 08/06/2023
 17862 00001860 83C106                  	add	cx,NUM_ORDER_LTRS ; 5	; CL = sort order code, 1-6
 17863                                  
 17864 00001863 08D1                    	or	cl,dl			; CL = sort code with up/dn bit
 17865 00001865 880F                    	mov	[bx],cl			; store sort order code in buffer
 17866 00001867 43                      	inc	bx			; BX = ptr to next spot in buffer
 17867                                  	;cmp	bx,offset TRANGROUP:EndDestBuf
 17868 00001868 81FB[159E]              	cmp	bx,EndDestBuf
 17869                                  	;jae	short poErr		; too many letters
 17870                                  	;
 17871                                  	;jmp	short poLtr		; go look at next char
 17872                                  	; 19/02/2023
 17873 0000186C 72D8                    	jb	short poLtr
 17874                                  
 17875                                  ;	The sort order string is invalid.  
 17876                                  
 17877                                  poErr:
 17878 0000186E 5B                      	pop	bx			; BX = ptr to result buffer
 17879 0000186F E82E04                  	call	SetupParamError		; set message up for Std_EPrintf
 17880 00001872 F9                      	stc				; return failure
 17881 00001873 EB04                    	jmp	short poRet
 17882                                  poOk:	
 17883 00001875 C60700                  	mov	byte [bx],0		; mark end of sort code list
 17884 00001878 5B                      	pop	bx			; BX = ptr to result buffer
 17885                                  	; 19/02/2023
 17886                                  	;cf=0
 17887                                  	;clc				; return success
 17888                                  poRet:
 17889 00001879 5E                      	pop	si			; restore SI
 17890 0000187A C3                      	retn
 17891                                  
 17892                                  ; ---------------------------------------------------------------------------
 17893                                  ; MSDOS 6.0
 17894                                  	; 08/06/2023
 17895                                  
 17896                                  ; 31/07/2024 - Retro DOS 5.0 - PCDOS 7.1 COMMAND.COM
 17897                                  %if 0
 17898                                  
 17899                                  ;ifdef DBLSPACE_HOOKS
 17900                                  
 17901                                  ;***	ParseRatio - parse and record /C[H] option
 17902                                  ;
 17903                                  ;	ENTRY	BX = ptr to system parser result buffer for /C occurence
 17904                                  ;		DI = index into word list of switches
 17905                                  ;
 17906                                  ;	EXIT	CY = set if error occurs parsing order
 17907                                  ;
 17908                                  ;		For parse error, we set up for Std_EPrintf call:
 17909                                  ;		AX = parse error code, like system parser
 17910                                  ;		DX = ptr to message block
 17911                                  ;
 17912                                  ;	USED	AX,CX,DX,DI
 17913                                  ;
 17914                                  ;	EFFECTS
 17915                                  ;
 17916                                  ;	  Bits modified to indicate option state.
 17917                                  ;	  fUseHostSize is set to zero for /C, non-zero for /CH.
 17918                                  ;
 17919                                  ;	  For parse error, we set up for Std_EPrintf call:
 17920                                  ;	  Msg_Disp_Class = parse error message class
 17921                                  ;	  Message block (see DX) is set up for parse error message
 17922                                  
 17923                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17924                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:184Ch
 17925                                  
 17926                                  ParseRatio:	;proc
 17927                                  	call	OnOffSw			; turn on option bit
 17928                                  	push	si			; save SI
 17929                                  	;;mov	si,word ptr [bx].ValuePtr
 17930                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 17931                                  	mov	si,[bx+4]		; SI = ptr to possible H option
 17932                                  	mov	al,[si] 		; AL = null or 'H'
 17933                                  	or	al,al
 17934                                  	jz	short prDone		; if null, no H option to check
 17935                                  	cmp	al,'H' 			; only H is allowed, make sure that's
 17936                                  	je	short prDone		;   what it is
 17937                                  	call	SetupParamError		; set message up for Std_EPrintf
 17938                                  	stc				; return failure
 17939                                  	jmp	short prRet
 17940                                  prDone:
 17941                                  	mov	[fUseHostSize],al	; set Host cluster size flag
 17942                                  	; 08/06/2023
 17943                                  	;clc
 17944                                  	;;cf = 0
 17945                                  prRet:	
 17946                                  	pop	si
 17947                                  	retn
 17948                                  
 17949                                  ;ParseRatio	;endp
 17950                                  ;endif
 17951                                  
 17952                                  %endif
 17953                                  
 17954                                  ; ---------------------------------------------------------------------------
 17955                                  
 17956                                  ;***	ParseSwitch - parse a switch
 17957                                  ;
 17958                                  ;	ENTRY	BX = ptr to parse result buffer after system parser processed
 17959                                  ;		     a switch
 17960                                  ;
 17961                                  ;	EXIT	CY = set if parse error occurred
 17962                                  ;
 17963                                  ;		If parse error occurred, we're set up for Std_EPrintf call:
 17964                                  ;		AX = parse error code, like system parser
 17965                                  ;		DX = ptr to message block
 17966                                  ;
 17967                                  ;	USED	AX,BX,DX
 17968                                  ;
 17969                                  ;	EFFECTS
 17970                                  ;
 17971                                  ;	  Bits may contain new option settings.
 17972                                  ;	  DestBuf may contain new series of sort codes.
 17973                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 17974                                  ;
 17975                                  ;	  If parse error occurred, we're set up for Std_EPrintf call:
 17976                                  ;	  Msg_Disp_Class = parse error class
 17977                                  ;	  Byte after last parameter in text is zeroed to make ASCIIZ string
 17978                                  ;	  Message block (see DX) is set up for parse error message
 17979                                  
 17980                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17981                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:16E2h
 17982                                  
 17983                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17984                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1869h
 17985                                  ParseSwitch:
 17986 0000187B 51                      	push	cx			; save CX
 17987 0000187C 57                      	push	di			; save DI
 17988                                  
 17989                                  	;;mov	ax,[bx].SynPtr		; AX = synonym ptr
 17990                                  	;mov	ax,[bx+ResultBuffer.SynPtr]
 17991 0000187D 8B4702                  	mov	ax,[bx+2]
 17992                                  	;mov	di,offset TRANGROUP:Dir_Sw_Ptrs
 17993 00001880 BF[0397]                	mov	di,Dir_Sw_Ptrs		; ES:DI = ptr to list of synonym ptrs
 17994                                  	; 08/06/2023
 17995                                  	; (NUM_DIR_SWS = 16 for MSDOS 6.0)
 17996                                  	;mov	cx,16
 17997                                  	; 31/07/2024
 17998                                  	;mov	cx,18 ; PCDOS 7.1 COMMAND.COM
 17999 00001883 B91200                  	mov	cx,NUM_DIR_SWS ; 14	; CX = # of dir switches in list
 18000 00001886 FC                      	cld				; scan direction = upward
 18001 00001887 F2AF                    	repne	scasw			; locate synonym ptr in list
 18002                                  	;sub	di,offset TRANGROUP:Dir_Sw_Ptrs + 2
 18003 00001889 81EF[0597]              	sub	di,Dir_Sw_Ptrs+2
 18004                                  
 18005                                  ;	DI = index into word list of synonym ptrs
 18006                                  
 18007 0000188D 2EFF95[9518]            	call	word [cs:di+SwHandler]	; use same index into call table
 18008                                  
 18009 00001892 5F                      	pop	di			; restore DI
 18010 00001893 59                      	pop	cx			; restore CX
 18011                                  
 18012 00001894 C3                      	retn
 18013                                  
 18014                                  ; ---------------------------------------------------------------------------
 18015                                  
 18016                                  ;	Order in this table must correspond to order in Dir_Sw_Ptrs list.
 18017                                  ;	Simple on/off switches must occur first in both lists, and must be
 18018                                  ;	  in order of option bits in Bits, starting with bit 0.
 18019                                  
 18020                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18021                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:16FCh
 18022                                  
 18023                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18024                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1883h
 18025                                  SwHandler:
 18026                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 18027                                  
 18028                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18029                                  %if 0
 18030                                  		; ifdef DBLSPACE_HOOKS
 18031                                  	dw	OnOffSw 	; /-C
 18032                                  	dw	ParseRatio	; /C[H]
 18033                                  	;	; endif	
 18034                                  %endif
 18035                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 18036                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1922h
 18037                                  
 18038 00001895 [A717]                  	dw	OnOffSw		; /-W
 18039 00001897 [A717]                  	dw	OnOffSw		; /W
 18040 00001899 [A717]                  	dw	OnOffSw		; /-P
 18041 0000189B [A717]                  	dw	OnOffSw		; /P
 18042 0000189D [A717]                  	dw	OnOffSw		; /-S
 18043 0000189F [A717]                  	dw	OnOffSw		; /S
 18044 000018A1 [A717]                  	dw	OnOffSw		; /-B
 18045 000018A3 [A717]                  	dw	OnOffSw		; /B
 18046 000018A5 [A717]                  	dw	OnOffSw		; /-L	;M010
 18047 000018A7 [A717]                  	dw	OnOffSw		; /L	;M010
 18048                                  
 18049                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18050                                  %if 1
 18051 000018A9 [A717]                    	dw	OnOffSw		; /-Z
 18052 000018AB [A717]                  	dw	OnOffSw		; /Z
 18053 000018AD [A717]                  	dw	OnOffSw		; /-4
 18054 000018AF [A717]                  	dw	OnOffSw		; /4
 18055                                  %endif
 18056 000018B1 [A017]                  	dw	NoOrder		; /-O
 18057 000018B3 [2A18]                  	dw	ParseOrder	; /O
 18058 000018B5 [ED14]                  	dw	DefaultAttr	; /-A
 18059 000018B7 [C417]                  	dw	ParseAttr	; /A
 18060                                  
 18061                                  ; ---------------------------------------------------------------------------
 18062                                  
 18063                                  	;break	<DIR utility routines>
 18064                                  
 18065                                  ;***	UTILITY ROUTINES
 18066                                  ; ---------------------- 
 18067                                  
 18068                                  ; ---------------------------------------------------------------------------
 18069                                  
 18070                                  ;***	ChangeDir - change directory on target drive
 18071                                  ;
 18072                                  ;	ENTRY	FCB contains drive #
 18073                                  ;		DS:DX = ptr to ASCIIZ string w/o drive specifier
 18074                                  ;
 18075                                  ;	EXIT	Changed current directory on drive
 18076                                  ;
 18077                                  ;		If error,
 18078                                  ;		CY = set
 18079                                  ;		DOS Get Extended Error call will get error
 18080                                  ;
 18081                                  ;	USED	AX,DX,SI,DI
 18082                                  ;
 18083                                  ;	EFFECTS
 18084                                  ;
 18085                                  ;	  DirBuf is used to build "d:string".
 18086                                  
 18087                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18088                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1718h
 18089                                  
 18090                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18091                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:18A3h
 18092                                  
 18093                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 18094                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1946h
 18095                                  ChangeDir:
 18096                                  	;mov	di,offset TRANGROUP:DirBuf
 18097 000018B9 BF[399D]                	mov	di,DIRBUF
 18098 000018BC E8D003                  	call	GetDriveLtr	; AX = "d:"
 18099 000018BF AB                      	stosw			; put drive specifier in buffer
 18100 000018C0 89D6                    	mov	si,dx		; SI = ptr to argument string
 18101                                  cdLoop:
 18102 000018C2 AC                      	lodsb
 18103 000018C3 AA                      	stosb			; move byte to buffer
 18104 000018C4 08C0                    	or	al,al
 18105 000018C6 75FA                    	jne	short cdLoop	; continue until null transferred
 18106                                  
 18107                                  	;mov	dx,offset TRANGROUP:DirBuf
 18108 000018C8 BA[399D]                	mov	dx,DIRBUF	; DX = ptr to "d:string"
 18109                                  	;mov	ah,CHDir
 18110 000018CB B43B                    	mov	ah,3Bh
 18111 000018CD CD21                    	int	21h		; change directory
 18112 000018CF C3                      	retn			; return what CHDIR returns
 18113                                  
 18114                                  ; ---------------------------------------------------------------------------
 18115                                  
 18116                                  ;***	CmpAscz - compare two ASCIIZ strings alphanumerically
 18117                                  ;
 18118                                  ;	ENTRY	DS:SI = ptr to one ASCIIZ string
 18119                                  ;		ES:DI = ptr to another ASCIIZ string
 18120                                  ;
 18121                                  ;	EXIT	flags set after REPE CMPSB
 18122                                  ;
 18123                                  ;	USED	AL,CX,SI,DI
 18124                                  ;
 18125                                  ;	NOTES
 18126                                  ;
 18127                                  ;	Maximum run of comparison is length of DS:SI string.
 18128                                  ;	This ensures that two identical strings followed by
 18129                                  ;	random characters will compare correctly.
 18130                                  
 18131                                  	; 19/02/2023
 18132                                  CmpAscz:
 18133                                  	; 07/06/2023
 18134 000018D0 56                      	push	si ; *
 18135                                  	;
 18136 000018D1 57                      	push	di
 18137                                  
 18138 000018D2 89F7                    	mov	di,si
 18139 000018D4 30C0                    	xor	al,al
 18140 000018D6 B9FFFF                  	mov	cx,0FFFFh
 18141 000018D9 F2AE                    	repne	scasb
 18142 000018DB F7D1                    	not	cx
 18143                                  
 18144 000018DD 5F                      	pop	di
 18145 000018DE F3A6                    	repe	cmpsb
 18146                                  
 18147                                  	; 07/06/2023
 18148 000018E0 5E                      	pop	si ; *
 18149                                  	;
 18150 000018E1 C3                      	retn
 18151                                  
 18152                                  ; ---------------------------------------------------------------------------
 18153                                  
 18154                                  ;***	CopyPathname - copy pathname to our buffer
 18155                                  ;
 18156                                  ;	ENTRY	BX = ptr to parse result buffer after system parser processed
 18157                                  ;		     a filespec
 18158                                  ;
 18159                                  ;	EXIT	nothing
 18160                                  ;
 18161                                  ;	USED	AX
 18162                                  ;
 18163                                  ;	EFFECTS
 18164                                  ;
 18165                                  ;	  SrcBuf may contain a new pathname/filespec.
 18166                                  ;	  PathPos, PathCnt updated for new pathname.
 18167                                  
 18168                                  	; 19/02/2023
 18169                                  CopyPathname:
 18170 000018E2 56                      	push	si
 18171                                  	;;lds	si,dword ptr [bx].ValuePtr  ; load far ptr from result buffer
 18172                                  	;lds	si,[bx+ResultBuffer.ValuePtr]
 18173 000018E3 C57704                  	lds	si,[bx+4]
 18174                                  	;invoke	Move_To_SrcBuf		    ; copy pathname to SrcBuf
 18175 000018E6 E8EF17                  	call	Move_To_SrcBuf
 18176 000018E9 5E                      	pop	si
 18177 000018EA C3                      	retn
 18178                                  
 18179                                  ; ---------------------------------------------------------------------------
 18180                                  
 18181                                  ;***	CountFile - update counters with current file
 18182                                  ;
 18183                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18184                                  ;
 18185                                  ;	EXIT	nothing
 18186                                  ;
 18187                                  ;	USED	AX,DX
 18188                                  ;
 18189                                  ;	EFFECTS
 18190                                  ;
 18191                                  ;	  FileCnt, FileCntTotal, FileSiz, FileSizTotal are updated.
 18192                                  
 18193                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18194                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 18195                                  CountFile:
 18196 000018EB 06                      	push	es			; save TRANGROUP seg addr
 18197 000018EC 8E06[F79B]              	mov	es,[TPA]		; ES = TPA seg addr
 18198                                  
 18199 000018F0 FF06[209C]              	inc	word [FileCnt]		; # files this directory
 18200 000018F4 FF06[5E9C]              	inc	word [FileCntTotal]	; # files total
 18201 000018F8 7504                    	jnz	short cntf1
 18202 000018FA FF06[609C]              	inc	word [FileCntTotal+2]
 18203                                  cntf1:
 18204                                  	;mov	ax,word ptr es:[bx].filesize
 18205                                  					; AX = low word of file size
 18206                                  	;mov	dx,word ptr es:[bx].filesize+2
 18207                                  					; DX = high word of file size
 18208 000018FE 268B4711                	mov	ax,[es:bx+17] ; [es:bx+EntryStruc.filesize]
 18209 00001902 268B5713                	mov	dx,[es:bx+19] ; [es:bx+EntryStruc.filesize+2]
 18210 00001906 0106[229C]              	add	[FileSiz],ax
 18211 0000190A 1116[249C]              	adc	[FileSiz+2],dx		; size of this directory
 18212                                  
 18213                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18214                                  %if 1
 18215 0000190E 8316[269C]00            	adc	word [FileSiz+4],0
 18216                                  %endif
 18217 00001913 0106[629C]              	add	[FileSizTotal],ax
 18218 00001917 1116[649C]              	adc	[FileSizTotal+2],dx	; total size of files listed
 18219                                  
 18220                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18221                                  %if 1
 18222 0000191B 8316[669C]00            	adc	word [FileSizTotal+4],0
 18223                                  %endif
 18224 00001920 07                      	pop	es			; ES = TRANGROUP seg addr again
 18225                                  dbRet:	; 19/02/2023
 18226 00001921 C3                      	retn
 18227                                  
 18228                                  ; ---------------------------------------------------------------------------
 18229                                  
 18230                                  ;***	DisplayBare - display filename in bare format
 18231                                  ;
 18232                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18233                                  ;
 18234                                  ;	EXIT	DX = # char's displayed, including dot
 18235                                  ;
 18236                                  ;	USED	AX,CX,SI,DI
 18237                                  ;
 18238                                  ;	EFFECTS
 18239                                  ;
 18240                                  ;	  Filename is displayed in name.ext format, followed by cr/lf.
 18241                                  ;	  If /s is on, complete pathname is displayed.
 18242                                  ;
 18243                                  ;	NOTE
 18244                                  ;
 18245                                  ;	  Directory pseudofiles . and .. and suppressed in bare listing.
 18246                                  
 18247                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18248                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1775h
 18249                                  
 18250                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18251                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1900h
 18252                                  
 18253                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18254                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:19ADh
 18255                                  
 18256                                  DisplayBare:
 18257                                  ;	Suppress . and .. files from bare listing.
 18258                                  
 18259 00001922 8CD9                    	mov	cx,ds			; CX = saved TRANGROUP seg addr
 18260 00001924 8E1E[F79B]              	mov	ds,[TPA]		; DS:BX = ptr to file entry
 18261                                  	;assume	ds:NOTHING
 18262                                  	;cmp	ds:[bx].filename,'.'	; check 1st char of filename
 18263 00001928 807F012E                	cmp	byte [bx+1],'.' ; [bx+EntrStruc.filename]
 18264 0000192C 8ED9                    	mov	ds,cx			; DS = TRANGROUP seg addr again
 18265                                  	;assume	ds:TRANGROUP
 18266 0000192E 74F1                    	je	short dbRet		; it's . or .. - don't display
 18267                                  
 18268                                  	;;;test	Bits,mask subd
 18269                                  	;;test	word [_Bits],4
 18270                                  	;test	byte [_Bits],4
 18271                                  	; 08/06/2023
 18272 00001930 F606[8B9D]04            	test	byte [_Bits],mask.subd	; 8 ; MSDOS 6.0
 18273                                  			; 01/08/2024    ; 4 ; PCDOS 7.1	
 18274 00001935 743C                    	jz	short dbNameExt		; not /s - display filename only
 18275                                  
 18276                                  	;invoke	Build_Dir_String
 18277 00001937 E8C308                  	call	build_dir_string
 18278                                  	;mov	di,offset TRANGROUP:BwdBuf
 18279 0000193A BF[399D]                	mov	di,BWDBUF		; ES:DI = ptr to dir string
 18280                                     
 18281                                  	;;;test	Bits,mask lcase		;M010;check for lowercase option
 18282                                  	;;test	word [_Bits],10h
 18283                                  	;test	byte [_Bits],10h
 18284                                  	; 08/06/2023
 18285 0000193D F606[8B9D]10            	test	byte [_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18286                                  			; 01/08/2024	; 10h ; PCDOS 7.1
 18287                                  	;jz	@F			;M010;lowercase not needed
 18288 00001942 7405                    	jz	short dbare1
 18289 00001944 89FE                    	mov	si,di			;M010;DS:SI --> ASCIIZ string in BwdBuf	
 18290 00001946 E89803                  	call	LowercaseString		;M010;path string is in BwdBuf
 18291                                  dbare1:
 18292                                  ;@@:	
 18293                                  	;xor	al,al			; AL = 0
 18294                                  	; 19/02/2023
 18295 00001949 31C0                    	xor	ax,ax
 18296 0000194B B9FFFF                  	mov	cx,0FFFFh
 18297 0000194E FC                      	cld
 18298 0000194F F2AE                    	repne	scasb			; ES:DI = ptr to byte after null
 18299 00001951 4F                      	dec	di			; ES:DI = ptr to null byte
 18300                                  
 18301                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18302                                  %if 1 ; *!
 18303                                  ;ifdef DBCS
 18304 00001952 56                      	push	si ; *!
 18305 00001953 57                      	push	di
 18306                                  	;mov	si,offset TRANGROUP:BwdBuf
 18307 00001954 BE[399D]                	mov	si,BWDBUF
 18308 00001957 4F                      	dec	di
 18309 00001958 E8C911                  	call	CheckDBCSTailByte
 18310 0000195B 5F                      	pop	di
 18311                                  	; 01/08/2024
 18312                                  	;pop	si ; *!
 18313 0000195C 7407                    	jz	short dbTailByte	; if last char is double byte
 18314                                  ;endif
 18315                                  %endif
 18316 0000195E 26807DFF5C              	cmp	byte [es:di-1],'\'
 18317                                  	;je	@F
 18318 00001963 7403                    	je	short dbare2		; already terminated w/ '\'
 18319                                  
 18320                                  dbTailByte:	; 01/08/2024
 18321                                  	;mov	ax,'\'			; AX = '\',0
 18322 00001965 B05C                    	mov	al,'\'
 18323 00001967 AB                      	stosw				; add to dir string
 18324                                  ;@@:
 18325                                  dbare2:
 18326                                  	;;mov	String_Ptr_2,offset TRANGROUP:BwdBuf
 18327                                  	;mov	word [string_ptr_2],BWDBUF ; *!
 18328                                  	; 01/08/2024
 18329 00001968 8936[A09D]              	mov	[string_ptr_2],si ; BWDBUF ; *!
 18330 0000196C 5E                      	pop	si ; *!
 18331                                  	;mov	dx,offset TRANGROUP:String_Buf_Ptr
 18332 0000196D BA[DF91]                	mov	dx,string_buf_ptr
 18333                                  	;invoke	Std_Printf		; display device & directory path
 18334 00001970 E8B53A                  	call	std_printf
 18335                                  dbNameExt:
 18336 00001973 E82D00                  	call	DisplayDotForm		; display name.ext
 18337                                  	;invoke	CrLf2			; display cr/lf
 18338 00001976 E80010                  	call	CRLF2
 18339                                  	; 19/02/2023
 18340                                  	;call	UseLine			;M007;Allow /p with /b
 18341                                  ;dbRet:
 18342                                  	;retn
 18343                                  
 18344                                  	; 19/02/2023
 18345                                  	;jmp	short UseLine
 18346                                  
 18347                                  ; ---------------------------------------------------------------------------
 18348                                  
 18349                                  ;***	UseLine - use a display line, start a new page if none left
 18350                                  ;
 18351                                  ;	ENTRY	nothing
 18352                                  ;
 18353                                  ;	EXIT	nothing
 18354                                  ;
 18355                                  ;	USED	flags
 18356                                  
 18357                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18358                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A04h
 18359                                  
 18360                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18361                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D58h
 18362                                  UseLine:
 18363 00001979 FF0E[1E9C]              	dec	word [LeftOnPage]
 18364 0000197D 833E[1E9C]02            	cmp	word [LeftOnPage],2
 18365 00001982 771E                    	ja	short ulRet
 18366                                  	; 19/02/2023
 18367                                  	;call	EndPage
 18368                                  ;ulRet:
 18369                                  	;retn
 18370                                  
 18371                                  	; 19/02/2023
 18372                                  	;jmp	short EndPage
 18373                                  
 18374                                  ; ---------------------------------------------------------------------------
 18375                                  
 18376                                  ;***	EndPage - end the current display page
 18377                                  ;
 18378                                  ;	ENTRY	LeftOnPage = # lines left on display page
 18379                                  ;		Current directory (on selected drive) is the one being listed
 18380                                  ;		Bits contains /p setting
 18381                                  ;
 18382                                  ;	EXIT	LeftOnPage = # lines left for next page
 18383                                  ;
 18384                                  ;	USED	AX,DX
 18385                                  ;
 18386                                  ;	EFFECTS
 18387                                  ;
 18388                                  ;	  Pause is invoked to display a message and wait for a keystroke.
 18389                                  ;	  BwdBuf (same as DirBuf) used to build directory string.
 18390                                  
 18391                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18392                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:19B8h
 18393                                  
 18394                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18395                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1BADh
 18396                                  
 18397                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18398                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D0Ch
 18399                                  EndPage:
 18400                                  	;;;test	Bits,mask pagd
 18401                                  	;;test	word [_Bits],2
 18402                                  	;test	byte [_Bits],2
 18403                                  	; 08/06/2023
 18404 00001984 F606[8B9D]02            	test	byte [_Bits],mask.pagd ; 4 ; MSDOS 6.0
 18405                                  			; 01/08/2024   ; 2 ; PCDOS 7.1	
 18406 00001989 7410                    	jz	short epNew		; paged display isn't enabled
 18407                                  
 18408 0000198B 53                      	push	bx			; save BX
 18409 0000198C 51                      	push	cx			; save CX
 18410                                  
 18411                                  	;invoke	Pause			; "Press any key to continue..."
 18412 0000198D E87003                  	call	PAUSE
 18413                                  
 18414                                  	;invoke	Build_Dir_String
 18415 00001990 E86A08                  	call	build_dir_string
 18416                                  	;mov	dx,offset TRANGROUP:DirCont_Ptr
 18417 00001993 BA[9B92]                	mov	dx,dircont_ptr
 18418                                  	;invoke	Printf_Crlf		; "(continuing <dir>)", cr/lf
 18419 00001996 E8813A                  	call	Printf_Crlf
 18420                                  
 18421 00001999 59                      	pop	cx			; restore CX
 18422 0000199A 5B                      	pop	bx			; restore BX
 18423                                  epNew:	
 18424 0000199B A1[179F]                	mov	ax,[LinPerPag]		; AX = # lines per page
 18425 0000199E 48                      	dec	ax			; AX = # lines till next EndPage
 18426 0000199F A3[1E9C]                	mov	[LeftOnPage],ax		; LeftOnPage = countdown variable
 18427                                  ulRet:	
 18428                                  	; 19/02/2023
 18429 000019A2 C3                      	retn
 18430                                  
 18431                                  ; ---------------------------------------------------------------------------
 18432                                  
 18433                                  ;***	DisplayDotForm - display filename in compressed dot format
 18434                                  ;
 18435                                  ;	Display name.ext, with no cr/lf's. Dot is displayed only
 18436                                  ;	if the filename has a nonblank extension.
 18437                                  ;
 18438                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18439                                  ;
 18440                                  ;	EXIT	DX = # char's displayed, including dot
 18441                                  ;
 18442                                  ;	USED	AX,CX,SI,DI
 18443                                  ;
 18444                                  ;	EFFECTS
 18445                                  ;
 18446                                  ;	  Filename is displayed in name.ext format.
 18447                                  ;
 18448                                  ;	NOTE
 18449                                  ;
 18450                                  ;	  We allow for bogus filenames that have blanks embedded
 18451                                  ;	  in the name or extension.
 18452                                  
 18453                                  ;	Bugbug:	might be a good performance gain if we buffered
 18454                                  ;	up the output and used DOS function 9.
 18455                                  
 18456                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18457                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:17C8h
 18458                                  
 18459                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18460                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1953h
 18461                                  
 18462                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18463                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1A0Dh
 18464                                  DisplayDotForm:
 18465 000019A3 1E                      	push	ds			; save TRANGROUP seg addr
 18466 000019A4 06                      	push	es			; save ES
 18467 000019A5 2EA1[F79B]              	mov	ax,[cs:TPA]		; AX = TPA seg addr
 18468 000019A9 8ED8                    	mov	ds,ax			; DS:BX = ptr to entry
 18469                                  	;assume	ds:nothing
 18470 000019AB 8EC0                    	mov	es,ax			; ES:BX = ptr to entry
 18471                                  
 18472                                  	; 08/06/2023
 18473                                  	;mov	di,bx			; ES:DI = ptr to entry
 18474                                  	;;;add	di,filename + size filename - 1
 18475                                  	;add	di,8 ; 1+8-1		; ES:DI = ptr to last char in name field
 18476                                  	;;mov	cx,size filename	; CX = length of name field
 18477                                  	;mov	cx,8
 18478                                  	; 08/06/2023
 18479 000019AD B90800                  	mov	cx,8
 18480 000019B0 89CF                    	mov	di,cx
 18481 000019B2 01DF                    	add	di,bx	
 18482                                  
 18483 000019B4 B020                    	mov	al,' '
 18484 000019B6 FD                      	std				; scan down
 18485 000019B7 F3AE                    	repe	scasb			; scan for nonblank
 18486                                  
 18487                                  ;	Assume file name has at least one character.
 18488                                  
 18489 000019B9 41                      	inc	cx			; CX = # chars in name
 18490 000019BA 89CA                    	mov	dx,cx			; DX = # chars to be displayed
 18491                                  
 18492 000019BC 89DE                    	mov	si,bx			; DS:SI = ptr to entry
 18493                                  	;;add	si,filename		; DS:SI = ptr to name
 18494                                  	;add	si,1 
 18495                                  	;		; add si,EntryStruc.filename
 18496                                  	; 25/04/2023
 18497 000019BE 46                      	inc	si
 18498                                  NextNameChar:
 18499 000019BF FC                      	cld
 18500 000019C0 AC                      	lodsb				; AL = next char
 18501                                  
 18502                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18503                                  %if 1
 18504                                  ;ifdef DBCS
 18505                                  	;invoke	testkanj
 18506                                  	;jz	@f			; if this is not lead byte
 18507 000019C1 E89D0D                  	call	testkanj
 18508 000019C4 7409                    	jz	short ddf3
 18509                                  	;invoke	Print_Char		; display lead byte
 18510 000019C6 E8E507                  	call    PRINT_CHAR
 18511 000019C9 49                      	dec	cx
 18512 000019CA 7413                    	jz	short ExtChar		; if this is end
 18513 000019CC AC                      	lodsb				; get tail byte
 18514                                  	;jmp	short NameChar10	; display tail byte
 18515 000019CD EB0B                    	jmp	short ddf1
 18516                                  ;@@:
 18517                                  ddf3:
 18518                                  ;endif
 18519                                  %endif
 18520                                  	;;;test	Bits,mask lcase		;M010;check for lowercase option
 18521                                  	;;test	word [ss:_Bits],10h
 18522                                  	;test	byte [ss:_Bits],10h
 18523                                  	; 08/06/2023
 18524 000019CF 36F606[8B9D]10          	test	byte [ss:_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18525                                  			; 01/08/2024	   ; 10h ; PCDOS 7.1
 18526                                  	;jz	short @F		;M010;lowercase not required
 18527 000019D5 7403                    	jz	short ddf1
 18528 000019D7 E8FC02                  	call	LowerCase		;M010;filename char is in AL
 18529                                  
 18530                                  ;NameChar10:
 18531                                  ddf1:
 18532                                  ;@@:	
 18533                                  	;invoke	Print_Char		; display it
 18534 000019DA E8D107                  	call	PRINT_CHAR
 18535 000019DD E2E0                    	loop	NextNameChar
 18536                                  
 18537                                  ExtChar:	; 01/08/2024
 18538                                  
 18539                                  ;	Now do extension.
 18540                                  
 18541 000019DF 89DF                    	mov	di,bx			; ES:DI = ptr to entry
 18542                                  	;add	di,fileext + size fileext - 1
 18543 000019E1 83C70B                  	add	di,11 ; 9+3-1		; ES:DI = ptr to last char in ext field
 18544                                  	;mov	cx,size fileext		; CX = length of ext field
 18545 000019E4 B90300                  	mov	cx,3
 18546 000019E7 B020                    	mov	al,' '
 18547 000019E9 FD                      	std				; scan down
 18548 000019EA F3AE                    	repe	scasb			; scan for nonblank
 18549 000019EC 742E                    	je	short ddDone		; no nonblank chars in ext
 18550                                  
 18551 000019EE 41                      	inc	cx			; CX = # chars in ext
 18552 000019EF 01CA                    	add	dx,cx			; DX = total # chars to be displayed
 18553 000019F1 42                      	inc	dx			;      including dot
 18554                                  
 18555 000019F2 B02E                    	mov	al,'.'
 18556 000019F4 E8B707                  	call	PRINT_CHAR
 18557 000019F7 89DE                    	mov	si,bx			; DS:SI = ptr to entry
 18558                                  	;add	si,fileext		; DS:SI = ptr to ext
 18559 000019F9 83C609                  	add	si,9
 18560                                  
 18561                                  NextExtChar:
 18562 000019FC FC                      	cld
 18563 000019FD AC                      	lodsb				; AL = next char
 18564                                  
 18565                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18566                                  %if 1
 18567                                  ;ifdef DBCS
 18568                                  	;invoke	testkanj
 18569                                  	;jz	@f			; if this is not lead byte
 18570 000019FE E8600D                  	call	testkanj
 18571 00001A01 7409                    	jz	short ddf4
 18572                                  	;invoke	Print_Char		; display lead byte
 18573 00001A03 E8A807                  	call    PRINT_CHAR
 18574 00001A06 49                      	dec	cx
 18575 00001A07 7413                    	jz	short ddDone		; if this is end
 18576 00001A09 AC                      	lodsb				; get tail byte
 18577                                  	;jmp	short ExtChar10		; display tail byte
 18578 00001A0A EB0B                    	jmp	short ddf2
 18579                                  ;@@:
 18580                                  ddf4:
 18581                                  ;endif
 18582                                  %endif
 18583                                  	;;;test	CS:Bits,mask lcase	;M010;check for lowercase option
 18584                                  	;;test	word [cs:_Bits],10h
 18585                                  	;test	byte [cs:_Bits],10h
 18586                                  	; 08/06/2023
 18587 00001A0C 2EF606[8B9D]10          	test	byte [cs:_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18588                                  			; 01/08/2024	   ; 10h ; PCDOS 7.1
 18589                                  	;jz	short @F		;M010;lowercase not required
 18590 00001A12 7403                    	jz	short ddf2
 18591 00001A14 E8BF02                  	call	LowerCase		;M010;fileext char is in AL
 18592                                  ;@@:	
 18593                                  ddf2:
 18594                                  	;invoke	Print_Char		; display it
 18595 00001A17 E89407                  	call	PRINT_CHAR
 18596 00001A1A E2E0                    	loop	NextExtChar
 18597                                  ddDone:
 18598 00001A1C 07                      	pop	es			; restore ES
 18599 00001A1D 1F                      	pop	ds			; DS = TRANGROUP seg addr again
 18600                                  	;assume	ds:TRANGROUP
 18601 00001A1E FC                      	cld				; leave direction flag = up
 18602 00001A1F C3                      	retn
 18603                                  
 18604                                  ; ---------------------------------------------------------------------------
 18605                                  
 18606                                  ;***	DisplayFile - display file entry, update counters
 18607                                  ;
 18608                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18609                                  ;		Bits contains /w, /p settings
 18610                                  ;
 18611                                  ;	EXIT	nothing
 18612                                  ;
 18613                                  ;	USED	AX,CX,DX,SI,DI,BP
 18614                                  ;
 18615                                  ;	EFFECTS
 18616                                  ;
 18617                                  ;	  Entry is displayed.  
 18618                                  ;	  If not /b,
 18619                                  ;	    Cursor is left at end of entry on screen.
 18620                                  ;	    FileCnt, FileCntTotal, FileSiz, FileSizTotal are updated.
 18621                                  ;	  If /b,
 18622                                  ;	    Cursor is left at beginning of next line.
 18623                                  ;	    Cnt's and Siz's aren't updated.
 18624                                  
 18625                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18626                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:182Eh
 18627                                  	
 18628                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18629                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:19B9h
 18630                                  
 18631                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18632                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1A8Fh
 18633                                  
 18634                                  DisplayFile:
 18635                                  	;;;test	Bits,mask bare
 18636                                  	;;test	word [_Bits],8
 18637                                  	;test	byte [_Bits],8
 18638                                  	; 08/06/2023
 18639 00001A20 F606[8B9D]08            	test	byte [_Bits],mask.bare ; 16 ; MSDOS 6.0
 18640                                  			; 01/08/2024	; 8 ; PCDOS 7.1
 18641 00001A25 7405                    	jz	short dfNorm		; not /b - do normal display
 18642                                  
 18643 00001A27 E8F8FE                  	call	DisplayBare		; display file in bare format
 18644 00001A2A EB18                    	jmp	short dfRet
 18645                                  dfNorm:	
 18646 00001A2C E87800                  	call	DisplayNext		; pos'n cursor for next entry
 18647                                  	;;;test	Bits,mask wide
 18648                                  	;;test	word [_Bits],1
 18649                                  	;test	byte [_Bits],1
 18650                                  	; 08/06/2023
 18651 00001A2F F606[8B9D]01            	test	byte [_Bits],mask.wide ; 2 ; MSDOS 6.0
 18652                                  			; 01/08/2024   ; 1 ; PCDOS 7.1
 18653 00001A34 7405                    	jz	short dfFull		; full format
 18654 00001A36 E82A02                  	call	DisplayWide		; wide format
 18655 00001A39 EB06                    	jmp	short dfCnt
 18656                                  dfFull:	
 18657 00001A3B E83400                  	call	DisplayName		; display filename & extension
 18658 00001A3E E88D00                  	call	DisplayTheRest		; display size, date, time
 18659                                  
 18660                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18661                                  %if 0	
 18662                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 18663                                  	; MSDOS 6.0
 18664                                  ;ifdef DBLSPACE_HOOKS
 18665                                  	;;test	Bits,mask cratio
 18666                                  	;test	word [_Bits],1
 18667                                  	test	byte [_Bits],mask.cratio
 18668                                  					; display compression ratio
 18669                                  	jz	short dfCnt
 18670                                  	call	DisplayCompRatio
 18671                                  ;endif
 18672                                  %endif
 18673                                  
 18674                                  dfCnt:
 18675 00001A41 E8A7FE                  	call	CountFile		; update file counters
 18676                                  dfRet:
 18677                                  dhRet:	; 19/02/2023
 18678 00001A44 C3                      	retn
 18679                                  
 18680                                  ; ---------------------------------------------------------------------------
 18681                                  
 18682                                  ;***	DisplayHeader - display directory header of working directory
 18683                                  ;
 18684                                  ;	ENTRY	Current directory (on selected drive) is the one to display
 18685                                  ;		LeftOnPage = # lines left on display page
 18686                                  ;
 18687                                  ;	EXIT	nothing
 18688                                  ;
 18689                                  ;	ERROR EXIT
 18690                                  ;
 18691                                  ;	  Build_Dir_String will exit through CError with "Invalid drive
 18692                                  ;	   specification" if there's a problem obtaining the current
 18693                                  ;	   directory pathname.
 18694                                  ;
 18695                                  ;	USED	AX,DX,SI,DI
 18696                                  ;
 18697                                  ;	EFFECTS
 18698                                  ;
 18699                                  ;	  BwdBuf (which is really the same buffer as DirBuf, which
 18700                                  ;	   we are using for the DTA) contains the directory string.
 18701                                  ;	  LeftOnPage is adjusted.
 18702                                  
 18703                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18704                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18705                                  
 18706                                  DisplayHeader:
 18707                                  	;;;test	Bits,mask bare
 18708                                  	;;test	word [_Bits],8
 18709                                  	;test	byte [_Bits],8
 18710                                  	; 08/06/2023
 18711 00001A45 F606[8B9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0
 18712                                  			; 01/08/2024	; 8 ; PCDOS 7.1
 18713 00001A4A 75F8                    	jnz	short dhRet		; /b - don't display header
 18714                                  
 18715                                  	;;;test	Bits,mask subd
 18716                                  	;;test	word [_Bits],4
 18717                                  	;test	byte [_Bits],4
 18718                                  	; 08/06/2023
 18719 00001A4C F606[8B9D]04            	test	byte [_Bits],mask.subd ; 8 ; MSDOS 6.0
 18720                                  			; 01/08/2024   ; 4 ; PCDOS 7.1
 18721 00001A51 7408                    	jz	short dhNorm		; not /s
 18722                                  
 18723                                  ;	For subdirectory listings, put a blank line before the header.
 18724                                  
 18725                                  	;invoke	Crlf2			; start with a blank line
 18726 00001A53 E8230F                  	call	CRLF2
 18727 00001A56 E820FF                  	call	UseLine
 18728 00001A59 EB05                    	jmp	short dhCom
 18729                                  dhNorm:
 18730 00001A5B B020                    	mov	al,' ' ; 20h
 18731                                  	;mov	al,BLANK		; if not /s, precede by a blank
 18732 00001A5D E84E07                  	call	PRINT_CHAR		; print a leading blank
 18733                                  dhCom:
 18734 00001A60 E89A07                  	call	build_dir_string
 18735 00001A63 BA[4391]                	mov	dx,dirhead_ptr
 18736 00001A66 E8BF39                  	call	std_printf		; print header & cr/lf
 18737 00001A69 E80DFF                  	call	UseLine
 18738 00001A6C E80A0F                  	call	CRLF2			; another cr/lf
 18739                                  	;call	UseLine
 18740                                  ;dhRet:
 18741                                  	;retn
 18742                                  
 18743                                  	; 19/02/2023
 18744 00001A6F E907FF                  	jmp	UseLine
 18745                                  
 18746                                  ; ---------------------------------------------------------------------------
 18747                                  
 18748                                  ;***	DisplayName - display file name & extension
 18749                                  ;
 18750                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18751                                  ;
 18752                                  ;	EXIT	nothing
 18753                                  ;
 18754                                  ;	USED	AX,CX,DX,SI,DI
 18755                                  ;
 18756                                  ;	EFFECTS
 18757                                  ;
 18758                                  ;	  Filename & extension are displayed in spread format.
 18759                                  ;	  Cursor is left at end of extension.
 18760                                  
 18761                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18762                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18763                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18764                                  
 18765                                  DisplayName:
 18766 00001A72 1E                      	push	ds			; save TRANGROUP seg addr
 18767 00001A73 8E1E[F79B]              	mov	ds,[TPA]		; DS:BX = ptr to entry
 18768                                  	;assume	ds:nothing
 18769 00001A77 89DE                    	mov	si,bx			; DS:SI = ptr to entry
 18770                                  	;;add	si,filename		; DS:SI = ptr to filename
 18771                                  	;add	si,1  ; EntryStruc.filename
 18772                                  	; 08/06/2023
 18773 00001A79 46                      	inc	si
 18774 00001A7A BF[6A9C]                	mov	di,CHARBUF		; ES:DI = ptr to CharBuf
 18775                                  
 18776 00001A7D B90800                  	mov	cx,8
 18777 00001A80 FC                      	cld
 18778 00001A81 F3A4                    	rep	movsb			; move filename to CharBuf
 18779 00001A83 B020                    	mov	al,' '
 18780 00001A85 AA                      	stosb				; add a blank
 18781                                  	;mov	cx,3
 18782                                  	; 08/06/2023
 18783 00001A86 B103                    	mov	cl,3
 18784 00001A88 F3A4                    	rep	movsb			; add extension
 18785 00001A8A 30C0                    	xor	al,al
 18786 00001A8C AA                      	stosb				; add a NULL
 18787                                  
 18788 00001A8D 1F                      	pop	ds			; DS = TRANGROUP seg addr again
 18789                                  	;assume	ds:TRANGROUP
 18790                                  
 18791                                  	;;;test	Bits,mask lcase		;M010;check for lowercase option
 18792                                  	;;test	word [_Bits],10h
 18793                                  	;test	byte [_Bits],10h
 18794                                  	; 08/06/2023
 18795 00001A8E F606[8B9D]10            	test	byte [_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18796                                  			; 01/08/2024	; 10h ; PCDOS 7.1
 18797 00001A93 7406                    	jz	short dn1		;M010;lowercase not required
 18798 00001A95 BE[6A9C]                	mov	si,CHARBUF		;M010;DS:SI --> ASCIIZ string
 18799 00001A98 E84602                  	call	LowercaseString		;M010;filename.ext string is in CharBuf
 18800                                  dn1:	
 18801 00001A9B C706[A09D][6A9C]        	mov	word [string_ptr_2],CHARBUF
 18802 00001AA1 BA[DF91]                	mov	dx,string_buf_ptr
 18803                                  	;call	std_printf		; print filename & extension
 18804                                  	;retn
 18805                                  	; 19/02/2023
 18806 00001AA4 E98139                  	jmp	std_printf
 18807                                  
 18808                                  ; ---------------------------------------------------------------------------
 18809                                  
 18810                                  ;***	DisplayNext - move display cursor to next entry position
 18811                                  ;
 18812                                  ;	ENTRY	LeftOnLine = # entries can still be printed on this line
 18813                                  ;		LeftOnPage = # lines can still be printed for this page
 18814                                  ;		FileCnt = # files in this dir displayed before this one
 18815                                  ;		Bits contains /w setting
 18816                                  ;
 18817                                  ;	EXIT	nothing
 18818                                  ;
 18819                                  ;	USED	AX,DX
 18820                                  ;
 18821                                  ;	EFFECTS
 18822                                  ;
 18823                                  ;	  LeftOnLine will be updated to reflect the entry about to be
 18824                                  ;	   displayed.
 18825                                  ;	  LeftOnPage may be updated.
 18826                                  
 18827                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18828                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18829                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18830                                  	
 18831                                  DisplayNext:
 18832 00001AA7 833E[209C]00            	cmp	word [FileCnt],0
 18833 00001AAC 7415                    	je	short dn1st		; 1st file in directory
 18834 00001AAE 803E[1C9C]00            	cmp	byte [LeftOnLine],0
 18835 00001AB3 7E08                    	jng	short dnEol	; jle	; no more room on this line
 18836                                  
 18837                                  ;	We are in wide mode (LeftOnLine is always 0 otherwise) and
 18838                                  ;	we still have room for more on this line.
 18839                                  ;	Tab to next position.
 18840                                  
 18841 00001AB5 BA[EE91]                	mov	dx,tab_ptr
 18842 00001AB8 E86D39                  	call	std_printf
 18843 00001ABB EB0C                    	jmp	short dnDone
 18844                                  dnEol:	
 18845                                  ;	Start this entry on a new line.
 18846                                  
 18847 00001ABD E8B90E                  	call	CRLF2		; start on new line
 18848 00001AC0 E8B6FE                  	call	UseLine
 18849                                  dn1st:
 18850 00001AC3 A0[1D9C]                	mov	al,[PerLine]
 18851 00001AC6 A2[1C9C]                	mov	[LeftOnLine],al	; reset # entries left on line
 18852                                  
 18853                                  dnDone:
 18854 00001AC9 FE0E[1C9C]              	dec	byte [LeftOnLine]
 18855                                  				; reflect the entry about to be displayed
 18856 00001ACD C3                      	retn
 18857                                  
 18858                                  ; ---------------------------------------------------------------------------
 18859                                  
 18860                                  ;***	DisplayTheRest - display file size/dir, date, time
 18861                                  ;
 18862                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18863                                  ;		Display cursor is at end of file extension
 18864                                  ;
 18865                                  ;	EXIT	nothing
 18866                                  ;
 18867                                  ;	USED	AX,CX,DX,SI,DI,BP
 18868                                  ;
 18869                                  ;	EFFECTS
 18870                                  ;
 18871                                  ;	  File size, date, & time are displayed.
 18872                                  
 18873                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18874                                  
 18875                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18876                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1A7Ch
 18877                                  
 18878                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18879                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1B47h
 18880                                  
 18881                                  DisplayTheRest:
 18882 00001ACE 06                      	push	es			; save TRANGROUP seg addr
 18883 00001ACF 8E06[F79B]              	mov	es,[TPA]		; ES = TPA seg addr
 18884 00001AD3 89DD                    	mov	bp,bx			; BP = offset of entry in TPA
 18885                                  	;;test	es:[bp].fileattr,ATTR_DIRECTORY
 18886                                  	;test	byte [es:bp+EntryStruc.fileattr],10h
 18887 00001AD5 26F6460C10              	test	byte [es:bp+12],ATTR_DIRECTORY
 18888 00001ADA 7425                    	jz	short drNonDir		; not a directory file
 18889                                  
 18890                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18891                                  %if 1
 18892 00001ADC 803E[2B9C]00            	cmp	byte [nocommas],0	; no commas ?
 18893 00001AE1 750C                    	jnz	short dr_2		; yes
 18894 00001AE3 C706[A09D][0094]        	mov	word [string_ptr_2],twospacechars ; db "  ",0
 18895 00001AE9 BA[DF91]                	mov	dx,string_buf_ptr
 18896 00001AEC E83939                  	call	std_printf
 18897                                  dr_2:
 18898                                  %endif
 18899                                  
 18900                                  ;	For a directory file, display <DIR> instead of size.
 18901                                  
 18902                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18903                                  %if 0
 18904                                  	mov	dx,dmes_ptr
 18905                                  	call	std_printf
 18906                                  	; 08/06/2023
 18907                                  	;jmp	short drCom
 18908                                  
 18909                                  	; 08/06/2023
 18910                                  	; MSDOS 6.22 COMMAND.COM (disassembled source code)
 18911                                  	test    byte [screen_f_1],40h	; 80 columns ?
 18912                                  	jz      short dr_0      	; no
 18913                                  	mov     dx,space_4_ptr		; 4 space chars
 18914                                  	call    std_printf
 18915                                  dr_0:
 18916                                  	jmp	short drCom		; skip to common fields
 18917                                  %else
 18918                                  	; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18919 00001AEF BA[F191]                	mov	dx,dmes_ptr		; MSG_1068
 18920 00001AF2 803E[2D9C]00            	cmp	byte [bfree_not_kilo],0 ; size will be displayed as kilobyte ?
 18921 00001AF7 7403                    	jz	short dr_3		; yes
 18922 00001AF9 BA[F491]                	mov	dx,space_4_ptr		; 4 space chars
 18923                                  dr_3:
 18924 00001AFC E82939                  	call	std_printf
 18925 00001AFF EB2A                    	jmp	short drCom	
 18926                                  %endif
 18927                                  
 18928                                  drNonDir:
 18929                                  ;	For a non-directory file, display file size.
 18930                                  
 18931                                  	;;mov	dx,word ptr es:[bp].filesize
 18932                                  	;mov	dx,[es:bp+EntryStruc.filesize]
 18933 00001B01 268B5611                	mov	dx,[es:bp+17]
 18934 00001B05 8916[9C9D]              	mov	[File_Size_Low],dx
 18935                                  	;;mov	dx,word ptr es:[bp].filesize+2
 18936                                  	;mov	dx,[es:bp+EntryStruc.filesize+2]
 18937 00001B09 268B5613                	mov	dx,[es:bp+19]
 18938 00001B0D 8916[9E9D]              	mov	[File_Size_High],dx
 18939 00001B11 BA[B591]                	mov	dx,disp_file_size_ptr
 18940                                  
 18941                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18942                                  %if 1
 18943 00001B14 803E[2A9C]00            	cmp	byte [narrow],0
 18944 00001B19 7503                    	jnz	short dr_4		; narrow display
 18945 00001B1B BA[C391]                	mov	dx,disp_file_size_w_ptr	; big file (wide)
 18946                                  dr_4:
 18947 00001B1E 803E[2D9C]00            	cmp	byte [bfree_not_kilo],0
 18948 00001B23 7403                    	jz	short dr_5		; big file
 18949 00001B25 BA[D191]                	mov	dx,disp_file_size_n_ptr ; not big file
 18950                                  dr_5:	
 18951                                  %endif
 18952                                  
 18953 00001B28 E8FD38                  	call	std_printf
 18954                                  drCom:
 18955                                  ;	For all files, display date & time.
 18956                                  
 18957                                  	;;mov	ax,es:[bp].filedate	; AX = date word
 18958                                  	;mov	ax,[es:bp+EntryStruc.filedate]
 18959 00001B2B 268B460F                	mov	ax,[es:bp+15]
 18960                                  
 18961                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18962                                  %if 0
 18963                                  	or	ax,ax			; test for null date (DOS 1.x)
 18964                                  	jz	short drDone		; no date, skip date/time display
 18965                                  %else
 18966 00001B2F 09C0                    	or	ax,ax
 18967 00001B31 7503                    	jnz	short dr_6
 18968 00001B33 E9AA00                  	jmp	drDone
 18969                                  dr_6:
 18970                                  %endif
 18971                                  
 18972 00001B36 89C3                    	mov	bx,ax			; BX = date word
 18973 00001B38 83E01F                  	and	ax,1Fh			; AX = day of month
 18974 00001B3B 88C2                    	mov	dl,al			; DL = day of month
 18975 00001B3D 89D8                    	mov	ax,bx			; AX = date word
 18976 00001B3F B105                    	mov	cl,5
 18977 00001B41 D3E8                    	shr	ax,cl			; shift day out
 18978 00001B43 240F                    	and	al,0Fh			; AL = month
 18979 00001B45 88C6                    	mov	dh,al			; DH = month
 18980 00001B47 88F9                    	mov	cl,bh
 18981 00001B49 D0E9                    	shr	cl,1			; CL = year - 1980
 18982 00001B4B 30ED                    	xor	ch,ch			; CX = year - 1980
 18983                                  
 18984                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18985                                  %if 0
 18986                                  	; MSDOS 5.0-6.22
 18987                                  	add	cx,80			; CX = 2-digit year
 18988                                  	cmp	cl,100
 18989                                  	jb	short dr_1		; not year 2000 yet, skip ahead
 18990                                  	sub	cl,100			; adjust for 21st century
 18991                                  %else
 18992                                  	; PCDOS 7.1
 18993 00001B4D 81C1BC07                	add	cx,1980			; CX = 4-digit year
 18994 00001B51 803E[2C9C]00            	cmp	byte [yeardigit4],0	; 4 digits year display ?
 18995 00001B56 7509                    	jnz	short dr_1		; yes
 18996 00001B58 81E9D007                	sub	cx,2000			; after	year 2000 (21st century)
 18997 00001B5C 7903                    	jns	short dr_1
 18998 00001B5E 83C164                  	add	cx,100			; before year 2000 (20th century)
 18999                                  %endif
 19000                                  
 19001                                  dr_1:	
 19002 00001B61 86D6                    	xchg	dh,dl			; DX = month/day
 19003 00001B63 890E[3292]              	mov	[DirDat_Yr],cx		; move year to msg block
 19004 00001B67 8916[3492]              	mov	[DirDat_Mo_Day],dx	; move month/day to msg block
 19005                                  	;;mov	cx,es:[bp].filetime	; CX = file time
 19006                                  	;mov	cx,[es:bp+EntryStruc.filetime]
 19007 00001B6B 268B4E0D                	mov	cx,[es:bp+13]
 19008 00001B6F E310                    	jcxz	drPrint			; no time field - go print
 19009 00001B71 D1E9                    	shr	cx,1
 19010 00001B73 D1E9                    	shr	cx,1
 19011 00001B75 D1E9                    	shr	cx,1			; CH = hours
 19012 00001B77 D0E9                    	shr	cl,1
 19013 00001B79 D0E9                    	shr	cl,1			; CL = minutes
 19014 00001B7B 86CD                    	xchg	ch,cl			; CX = hr/min
 19015 00001B7D 890E[3D92]              	mov	[DirTim_Hr_Min],cx	; move time to msg block
 19016                                  drPrint:
 19017                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 19018                                  %if 1
 19019 00001B81 C706[2D92]3504          	mov	word [dirdattim_ptr],1077 ; MSG_1077 (normal)
 19020 00001B87 C606[3792]A4            	mov	byte [DirDat_form],0A4h   ; Right_Align+DATE_MDY_2
 19021 00001B8C C706[3892]0A08          	mov	word [DirDat_width],80Ah  ; 10 (max), 8 (min)
 19022 00001B92 803E[2A9C]00            	cmp	byte [narrow],0
 19023 00001B97 750C                    	jnz	short dr_narrow
 19024 00001B99 C706[2D92]3304          	mov	word [dirdattim_ptr],1075 ; MSG_1075 (narrow)
 19025 00001B9F 8106[3892]0202          	add	word [DirDat_width],202h  ; 12 (max), 10 (min)
 19026                                  dr_narrow:
 19027 00001BA5 803E[2C9C]00            	cmp	byte [yeardigit4],0
 19028 00001BAA 740B                    	jz	short dr_7		 ; 2 digits year display
 19029                                  		; 4 digits year display
 19030 00001BAC C606[3792]B4            	mov	byte [DirDat_form],0B4h  ; Right_Align+DATE_MDY_4
 19031 00001BB1 8106[3892]0202          	add	word [DirDat_width],202h ; 12 (max), 10 (min)
 19032                                  dr_7:	
 19033                                  %endif
 19034 00001BB7 BA[2D92]                	mov	dx,dirdattim_ptr
 19035 00001BBA E86B38                  	call	std_printf		; print date & time
 19036                                  
 19037                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 19038                                  %if 1
 19039                                  	; restore message data format fields (to the default values)
 19040 00001BBD C706[2D92]3504          	mov	word [dirdattim_ptr],1077 ; MSG_1077
 19041 00001BC3 C606[3792]A4            	mov	byte [DirDat_form],0A4h   ; Right_Align+DATE_MDY_2
 19042 00001BC8 C706[3892]0A08          	mov	word [DirDat_width],80Ah  ; 10 (max), 8 (min)
 19043 00001BCE C706[3292]0000          	mov	word [DirDat_Yr],0
 19044 00001BD4 C706[3492]0000          	mov	word [DirDat_Mo_Day],0
 19045 00001BDA C706[3D92]0000          	mov	word [DirTim_Hr_Min],0
 19046                                  %endif
 19047                                  
 19048                                  drDone:
 19049 00001BE0 07                      	pop	es			; ES = TRANGROUP seg addr again	
 19050 00001BE1 89EB                    	mov	bx,bp			; BX = offset of entry in TPA again
 19051                                  dtrRet:		; 03/08/2024
 19052                                  	; 19/02/2023
 19053 00001BE3 C3                      	retn
 19054                                  
 19055                                  ; ---------------------------------------------------------------------------
 19056                                  ; MSDOS 6.0
 19057                                  
 19058                                  ; 01/08/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 19059                                  %if 0
 19060                                  ;ifdef DBLSPACE_HOOKS
 19061                                  
 19062                                  ;***	DisplayCompRatio - display compression ratio
 19063                                  ;
 19064                                  ;	ENTRY	BX = offset of entry in TPA buffer
 19065                                  ;
 19066                                  ;	EXIT	nothing
 19067                                  ;
 19068                                  ;	USED	AX,CX,DX
 19069                                  ;
 19070                                  ;	EFFECTS
 19071                                  ;
 19072                                  ;	  File compression ratio is displayed.
 19073                                  
 19074                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19075                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1B09h
 19076                                  
 19077                                  DisplayCompRatio: ;proc
 19078                                  	push	es			; save TRANGROUP seg addr
 19079                                  	mov	es,[TPA]		; ES = TPA seg addr
 19080                                  	;;mov	al,es:[bx].compratio
 19081                                  	;mov	al,[es:bx+EntryStruc.compratio]
 19082                                  	mov	al,[es:bx+15h]
 19083                                  	cmp	al,0FFh			; invalid/no compression ratio?
 19084                                  	je	short dcrRet
 19085                                  
 19086                                  	mov	ah,al			; unpack compression ratio
 19087                                  	mov	cl,4
 19088                                  	shr	ah,cl			; isolate whole number portion
 19089                                  	inc	ah			; 0-15 = 1-16
 19090                                  	and	al,0Fh 			; isolate tenths
 19091                                  
 19092                                  	mov	[Dir_CRatio_1],ah
 19093                                  	mov	[Dir_CRatio_2],al
 19094                                  	;mov	dx,offset TRANGROUP:DirCompRatio_Ptr
 19095                                  	;invoke	Std_Printf
 19096                                  	mov	dx,DirCompRatio_Ptr
 19097                                  	call	std_printf	
 19098                                  dcrRet:
 19099                                  	pop	es
 19100                                  dtrRet:		; 08/06/2023
 19101                                  	retn
 19102                                  
 19103                                  ;DisplayCompRatio ;endp
 19104                                  
 19105                                  ;endif
 19106                                  %endif
 19107                                  
 19108                                  ; ---------------------------------------------------------------------------
 19109                                  
 19110                                  ;***	DisplayTrailer - display trailing lines for directory listing
 19111                                  ;
 19112                                  ;	ENTRY	LeftOnPage = # lines left on display page
 19113                                  ;		FileCnt = # files listed
 19114                                  ;		FileSiz = total size of files listed
 19115                                  ;
 19116                                  ;	EXIT	nothing
 19117                                  ;
 19118                                  ;	USED
 19119                                  ;
 19120                                  ;	EFFECTS
 19121                                  ;
 19122                                  ;	  Trailing info lines are displayed
 19123                                  
 19124                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19125                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19126                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 19127                                  	; 14/08/2024
 19128                                  DisplayTrailer:
 19129                                  	;;;test	Bits,mask bare
 19130                                  	;;test	word [_Bits],8
 19131                                  	;test	byte [_Bits],8
 19132                                  	; 08/06/2023
 19133 00001BE4 F606[8B9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0
 19134                                  			    ; 02/08/2024 ; 8 ; PCDOS 7.1 	
 19135 00001BE9 75F8                    	jnz	short dtrRet		; /b - don't display trailer
 19136                                  
 19137 00001BEB E88B0D                  	call	CRLF2			; start on new line
 19138 00001BEE E888FD                  	call	UseLine
 19139 00001BF1 A1[209C]                	mov	ax,[FileCnt]		; AX = # files found
 19140                                  	; 14/08/2024
 19141 00001BF4 31D2                    	xor	dx,dx
 19142                                  
 19143                                  ;	DisplayTotals uses this entry point.
 19144                                  ;
 19145                                  DisplayCntSiz:
 19146                                  ;	AX = # files
 19147                                  ;	FileSiz = dword total size of files
 19148                                  
 19149                                  ; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 19150                                  ; PCDOS 7.1 COMMAND.COM
 19151                                  %if 0 
 19152                                  	mov	[Dir_Num],ax		; load # files
 19153                                  	mov	dx,dirmes_ptr		; DX = ptr to message block
 19154                                  	call	std_printf		; "nnn File(s)"
 19155                                  
 19156                                  	mov	dx,bytes_ptr
 19157                                  	call	std_printf		; "nnn bytes",cr,lf
 19158                                  	; 19/02/2023
 19159                                  	;call	UseLine
 19160                                  ;dtrRet:
 19161                                  	;retn
 19162                                  
 19163                                  	; 19/02/2023
 19164                                  	jmp	UseLine
 19165                                  %else
 19166                                  	; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 19167 00001BF6 A3[A59D]                	mov	[Dir_Num],ax		; number of files
 19168 00001BF9 8916[A79D]              	mov	[Dir_Num+2],dx
 19169 00001BFD BA[1A90]                	mov	dx,dirmes_ptr		; MSG_1019, 9 bytes, word	
 19170 00001C00 803E[2A9C]00            	cmp	byte [narrow],0		; narrow display ?
 19171 00001C05 7503                    	jnz	short dcs_1		; yes
 19172 00001C07 BA[2890]                	mov	dx,dirmes_w_ptr		; MSG_1019, 10 bytes
 19173                                  dcs_1:
 19174 00001C0A 803E[2D9C]00            	cmp	byte [bfree_not_kilo],0	; is kilobyte display usable?
 19175 00001C0F 7403                    	jz	short dcs_2		; yes (big files)
 19176 00001C11 BA[3690]                	mov	dx,dirmes2_ptr		; MSG_1019, 9 bytes, dword
 19177                                  dcs_2:
 19178 00001C14 E81138                  	call	std_printf		; "nnn File(s)"
 19179 00001C17 8B0E[269C]              	mov	cx,[FileSiz+4]		; 5th and 6th byte of the file size
 19180                                  					; (6th byte=0)
 19181 00001C1B E329                    	jcxz	dcs_3			; file size is (in) 4 bytes
 19182 00001C1D 8B16[259C]              	mov	dx,[FileSiz+3]		; convert to kilobytes
 19183 00001C21 A1[239C]                	mov	ax,[FileSiz+1]
 19184 00001C24 D0CD                    	ror	ch,1			; ch = 5th byte of file size
 19185 00001C26 D1DA                    	rcr	dx,1
 19186 00001C28 D1D8                    	rcr	ax,1
 19187 00001C2A D0CD                    	ror	ch,1
 19188 00001C2C D1DA                    	rcr	dx,1
 19189 00001C2E D1D8                    	rcr	ax,1			; dx:ax = (ch:dx:ax) / 1024
 19190 00001C30 8916[249C]              	mov	[FileSiz+2],dx
 19191 00001C34 A3[229C]                	mov	[FileSiz],ax
 19192 00001C37 BA[7392]                	mov	dx,kbytes_ptr		; MSG_1107 normal, 14 bytes
 19193 00001C3A 803E[2D9C]00            	cmp	byte [bfree_not_kilo],0 ; is kilobyte display usable?
 19194 00001C3F 741C                    	jz	short dcs_5		; yes (big files)
 19195                                  		; no (not big files)
 19196 00001C41 BA[8192]                	mov	dx,kybytes_n_ptr	; MSG_1107 narrow, 10 bytes
 19197 00001C44 EB17                    	jmp	short dcs_5
 19198                                  dcs_3:
 19199 00001C46 BA[4992]                	mov	dx,bytes_ptr		; MSG_1079 normal, 12 bytes
 19200 00001C49 803E[2A9C]00            	cmp	byte [narrow],0		; narrow display option
 19201 00001C4E 7503                    	jnz	short dcs_4
 19202 00001C50 BA[5792]                	mov	dx,bytes_w_tr		; MSG_1079 wide, 14 bytes
 19203                                  dcs_4:
 19204 00001C53 803E[2D9C]00            	cmp	byte [bfree_not_kilo],0
 19205 00001C58 7403                    	jz	short dcs_5
 19206 00001C5A BA[6592]                	mov	dx,bytes_n_ptr		; MSG_1079 narrow, 10 bytes
 19207                                  dcs_5:
 19208 00001C5D E8C837                  	call	std_printf		; "nnn bytes",cr,lf
 19209                                  	;call	UseLine
 19210                                  ;dtrRet:
 19211                                  	;retn
 19212                                  	; 02/08/2024
 19213 00001C60 E916FD                  	jmp	UseLine
 19214                                  %endif
 19215                                  
 19216                                  ; ---------------------------------------------------------------------------
 19217                                  
 19218                                  ;***	DisplayWide - display filename in wide format
 19219                                  ;
 19220                                  ;	ENTRY	BX = offset of entry in TPA buffer
 19221                                  ;
 19222                                  ;	EXIT	nothing
 19223                                  ;
 19224                                  ;	USED	AX,CX,DX,SI,DI
 19225                                  ;
 19226                                  ;	EFFECTS
 19227                                  ;
 19228                                  ;	  Name.ext is displayed. Cursor left at end of field (padded
 19229                                  ;	  with blanks). Subdirectory files are displayed as [name.ext].
 19230                                  
 19231                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19232                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:198Ah
 19233                                  
 19234                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19235                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1CDEh
 19236                                  
 19237                                  DisplayWide:
 19238 00001C63 1E                      	push	ds			; save TRANGROUP seg addr
 19239 00001C64 8E1E[F79B]              	mov	ds,[TPA]		; DS:BX = ptr to entry
 19240                                  	;assume	ds:nothing
 19241                                  
 19242                                  	;;test	ds:[bx].fileattr,ATTR_DIRECTORY
 19243                                  	;test	byte [bx+EntryStruc.fileattr],10h
 19244 00001C68 F6470C10                	test	byte [bx+12],ATTR_DIRECTORY
 19245 00001C6C 9C                      	pushf	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19246 00001C6D 7405                    	jz	short dw1		; not a subdirectory file
 19247 00001C6F B05B                    	mov	al,'['
 19248 00001C71 E83A05                  	call	PRINT_CHAR		; prefix subdirectory
 19249                                  dw1:	
 19250 00001C74 E82CFD                  	call	DisplayDotForm		; display name.ext
 19251                                  
 19252                                  ;	DX = # chars displayed in name.ext
 19253                                  
 19254                                  	;;test	ds:[bx].fileattr,ATTR_DIRECTORY
 19255                                  	;test	byte [bx+EntryStruc.fileattr],10h
 19256                                  	; 03/08/2024
 19257                                  	;test	byte [bx+12],ATTR_DIRECTORY
 19258 00001C77 9D                      	popf	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19259 00001C78 7405                    	jz	short dw2		; not a subdirectory file
 19260 00001C7A B05D                    	mov	al,']'
 19261 00001C7C E82F05                  	call	PRINT_CHAR		; postfix subdirectory
 19262                                  dw2:
 19263                                  ;	Pad field with blanks.
 19264                                  
 19265                                  	;mov	cx,size filename + size fileext + 1
 19266 00001C7F B90C00                  	mov	cx,12 ; 8+3+1
 19267                                  					; CX = field size
 19268 00001C82 29D1                    	sub	cx,dx			; CX = # pad char's
 19269 00001C84 E307                    	jcxz	dwDone
 19270 00001C86 B020                    	mov	al,' '
 19271                                  dw3:	
 19272 00001C88 E82305                  	call	PRINT_CHAR
 19273 00001C8B E2FB                    	loop	dw3
 19274                                  dwDone:	
 19275 00001C8D 1F                      	pop	ds			; DS = TRANGROUP seg addr again
 19276                                  	;assume	ds:TRANGROUP
 19277 00001C8E C3                      	retn
 19278                                  
 19279                                  ; ---------------------------------------------------------------------------
 19280                                  
 19281                                  ;***	GetDriveLtr - get target drive letter
 19282                                  ;
 19283                                  ;	ENTRY	FCB contains drive #
 19284                                  ;
 19285                                  ;	EXIT	AX = "d:"
 19286                                  ;
 19287                                  ;	USED	nothing
 19288                                  
 19289                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19290                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:19D8h
 19291                                  GetDriveLtr:
 19292 00001C8F A05C00                  	mov	al,[FCB] ; 5Ch	; AL = target drive #
 19293 00001C92 08C0                    	or	al,al
 19294 00001C94 7505                    	jnz	short gdl1	; not current drive default, skip ahead
 19295 00001C96 A0[079C]                	mov	al,[CURDRV]	; AL = current drive #
 19296 00001C99 FEC0                    	inc	al		; AL = 1-based drive #
 19297                                  gdl1:	
 19298 00001C9B 0440                    	add	al,'A'-1 ; 40h	; AL = target drive letter
 19299 00001C9D B43A                    	mov	ah,':'		; AX = "d:"
 19300 00001C9F C3                      	retn
 19301                                  
 19302                                  ; ---------------------------------------------------------------------------
 19303                                  
 19304                                  ;***	SetupParamError - set up for Std_EPrintf parameter parse error message
 19305                                  ;
 19306                                  ;	Do for our /O and /A string parsers what Parse_With_Msg does
 19307                                  ;	for system parser calls. Set up a message substitution block,
 19308                                  ;	etc. for invalid value strings. I copied the procedure from
 19309                                  ;	Setup_Parse_Error_Msg.
 19310                                  ;
 19311                                  ;	ENTRY	BX = ptr to system parser result buffer (contains ptr to str)
 19312                                  ;		
 19313                                  ;
 19314                                  ;	EXIT	AX = system parser error return code for bad param format
 19315                                  ;		DX = ptr to message description block for Std_EPrintf
 19316                                  ;
 19317                                  ;	USED	SI
 19318                                  ;
 19319                                  ;	EFFECTS
 19320                                  ;
 19321                                  ;	  Msg_Disp_Class = parse error message class
 19322                                  ;	  Message block (see DX) is set up for parse error message
 19323                                  
 19324                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19325                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:19E9h
 19326                                  SetupParamError:
 19327 00001CA0 B80900                  	mov	ax,9			; parse error #
 19328 00001CA3 C606[D58F]02            	mov	byte [msg_disp_class],parse_msg_class
 19329                                  	;mov	byte [msg_disp_class],2
 19330 00001CA8 A3[D78F]                	mov	[extend_buf_ptr],ax
 19331                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 19332 00001CAB 8B7704                  	mov	si,[bx+4]
 19333 00001CAE 8936[A09D]              	mov	[string_ptr_2],si
 19334 00001CB2 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst
 19335                                  	;mov	byte [extend_buf_sub],1
 19336 00001CB7 BA[D78F]                	mov	dx,extend_buf_ptr
 19337 00001CBA C3                      	retn
 19338                                  
 19339                                  ; ---------------------------------------------------------------------------
 19340                                  
 19341                                  ;***	ZeroTotals - zero grand total file count, size
 19342                                  ;
 19343                                  ;	ENTRY	nothing
 19344                                  ;
 19345                                  ;	EXIT	nothing
 19346                                  ;
 19347                                  ;	USED	AX
 19348                                  ;
 19349                                  ;	EFFECTS
 19350                                  ;
 19351                                  ;	  FileCntTotal & FileSizTotal are zeroed.
 19352                                  ;
 19353                                  ;	NOTES
 19354                                  ;
 19355                                  ;	  FileCntTotal throuth csecUsedTotal must be together!
 19356                                  
 19357                                  ; 05/06/2023
 19358                                  ;ifdef DBLSPACE_HOOKS
 19359                                  ;csecSIZE EQU size csecUsed + size csecUsedDir + size csecUsedTotal
 19360                                  ;ccluSIZE EQU size ccluUsed + size ccluUsedDir + size ccluUsedTotal
 19361                                  ;endif
 19362                                  
 19363                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19364                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A13h
 19365                                  
 19366                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 19367                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1C08h
 19368                                  
 19369                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19370                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D67h
 19371                                  ZeroTotals:
 19372 00001CBB BF[5E9C]                	mov	di,FileCntTotal
 19373                                  
 19374                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 19375                                  	;;mov	cx,size FileCntTotal+size FileSizTotal
 19376                                  	;mov	cx,8
 19377                                  	;ifdef DBLSPACE_HOOKS
 19378                                  	;mov	cx,size FileCntTotal+size FileSizTotal+csecSIZE+ccluSIZE
 19379                                  	;endif
 19380                                  	;mov	cx,26
 19381                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19382 00001CBE B90C00                  	mov	cx,12
 19383                                  
 19384 00001CC1 30C0                    	xor	al,al
 19385 00001CC3 F3AA                    	rep	stosb
 19386 00001CC5 C3                      	retn	
 19387                                  
 19388                                  ; ---------------------------------------------------------------------------
 19389                                  
 19390                                  ;***	CtrlCHandler - our own control-c handler
 19391                                  ;
 19392                                  ;	Make sure user's default directory gets restored. See notes
 19393                                  ;	at InstallCtrlCHandler.
 19394                                  ;
 19395                                  ;	ENTRY	control-c
 19396                                  ;
 19397                                  ;	EXIT	to OldCtrlCHandler
 19398                                  ;
 19399                                  ;	USED	DS,flags
 19400                                  ;
 19401                                  ;	EFFECTS
 19402                                  ;
 19403                                  ;	  Restore user's default directory.
 19404                                  ;
 19405                                  ;	NOTES
 19406                                  ;
 19407                                  ;	  This handler is only installed after calling PathCrunch,
 19408                                  ;	  which sets UserDir1, so the restoration will work.
 19409                                  ;
 19410                                  ;	  The original control-c vector will be restored, whether
 19411                                  ;	  or not this one is invoked, in the HeadFix routine.
 19412                                  
 19413                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19414                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A1Eh
 19415                                  
 19416                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 19417                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1C13h ; *
 19418                                  
 19419                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19420                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D72h
 19421                                  
 19422                                  CtrlCHandler:	;proc far
 19423                                  
 19424                                  ;SR;
 19425                                  ; Save all registers used: ds, dx, ax. I know ax is being used by the 
 19426                                  ;CtrlC handler, am not sure about ds & dx. Save them to be safe
 19427                                  ;
 19428 00001CC6 1E                      	push	ds
 19429 00001CC7 0E                      	push	cs
 19430 00001CC8 1F                      	pop	ds			; DS = TRANGROUP seg addr
 19431 00001CC9 50                      	push	ax
 19432                                  
 19433                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19434                                  %if 0
 19435                                  	push	bx ; *
 19436                                  	push	dx
 19437                                  	call	CloseCVF ; * 		; close CVF file if open
 19438                                  	call	RestUDir		; restore user's default directory
 19439                                  	pop	dx
 19440                                  	pop	bx ; *
 19441                                  %else
 19442 00001CCA 52                      	push	dx
 19443 00001CCB E8620B                  	call	RestUDir		; restore user's default directory
 19444 00001CCE 5A                      	pop	dx
 19445                                  %endif
 19446 00001CCF 58                      	pop	ax
 19447 00001CD0 1F                      	pop	ds
 19448 00001CD1 2EFF2E[C3A5]            	jmp	far [cs:OldCtrlCHandler]
 19449                                  					; go to previous int 23 handler
 19450                                  
 19451                                  ; ---------------------------------------------------------------------------
 19452                                  
 19453                                  ;M010;start
 19454                                  ;***	LowerCase - convert ASCII character in AL to lowercase
 19455                                  ;
 19456                                  ;	ENTRY	AL = character to be displayed
 19457                                  ;
 19458                                  ;	EXIT	AL is lowercase
 19459                                  ;
 19460                                  ;	USED	nothing
 19461                                  
 19462                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19463                                  LowerCase:
 19464 00001CD6 3C41                    	cmp	al,'A'		; ensure AL is in range 'A'-'Z'
 19465 00001CD8 7206                    	jb	short lcRet
 19466 00001CDA 3C5A                    	cmp	al,'Z'
 19467 00001CDC 7702                    	ja	short lcRet
 19468                                  
 19469 00001CDE 0C20                    	or	al,20h		; convert to ASCII lowercase (UpperCase+32)-->LowerCase
 19470                                  lcRet:
 19471 00001CE0 C3                      	retn
 19472                                  
 19473                                  ; ---------------------------------------------------------------------------
 19474                                  
 19475                                  ;***	LowercaseString - convert ASCIIZ string at DS:SI to lowercase
 19476                                  ;
 19477                                  ;	ENTRY	DS:SI points to start of ASCIIZ string
 19478                                  ;		ES = DS
 19479                                  ;
 19480                                  ;	EXIT	nothing
 19481                                  ;	
 19482                                  ;	USED	AL,SI
 19483                                  
 19484                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19485                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19486                                  LowercaseString:
 19487 00001CE1 57                      	push	di			; save di
 19488 00001CE2 89F7                    	mov	di,si			; ES:DI --> ASCIIZ string
 19489 00001CE4 FC                      	cld
 19490                                  NextChar: 
 19491 00001CE5 AC                      	lodsb				; get character from string into al
 19492 00001CE6 08C0                    	or	al,al			; are we at end of string?
 19493 00001CE8 7414                    	jz	short EndOfString
 19494                                  
 19495                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19496                                  %if 1
 19497                                  ;ifdef DBCS
 19498                                  	;invoke	testkanj
 19499                                  	;jz	@f			; if this is not lead byte
 19500 00001CEA E8740A                  	call	testkanj
 19501 00001CED 7409                    	jz	short NextChar_@
 19502 00001CEF AA                      	stosb				; store lead byte
 19503 00001CF0 AC                      	lodsb				; get tail byte
 19504 00001CF1 08C0                    	or	al,al
 19505 00001CF3 7409                    	jz	short EndOfString	; if end
 19506 00001CF5 AA                      	stosb				; store tail byte
 19507 00001CF6 EBED                    	jmp	short NextChar
 19508                                  ;@@:
 19509                                  NextChar_@:
 19510                                  ;endif
 19511                                  %endif
 19512 00001CF8 E8DBFF                  	call	LowerCase		; convert character to lowercase
 19513 00001CFB AA                      	stosb				; store character back into buffer
 19514 00001CFC EBE7                    	jmp	short NextChar		; repeat until end of string
 19515                                  
 19516                                  EndOfString:
 19517 00001CFE 5F                      	pop	di			; restore di
 19518 00001CFF C3                      	retn
 19519                                  
 19520                                  ;M010;end
 19521                                  
 19522                                  ; 08/06/2023
 19523                                  ; ---------------------------------------------------------------------------
 19524                                  ; MSDOS 6.2(2) COMMAND.COM procedure only !
 19525                                  ; -----------------------------------------
 19526                                  ; Hex-Rays IDA / disassembled source code ! modified for NASM by Erdogan Tan
 19527                                  ; ---------------------------------------------------------------------------
 19528                                  
 19529                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19530                                  %if 0
 19531                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19532                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1C44h
 19533                                  screen_f_set:
 19534                                  	; set dir display parameters depending on screen width (# of columns)
 19535                                  	push	ds
 19536                                  	mov	ax,40h
 19537                                  	mov	ds,ax
 19538                                  	cmp	word [4Ah],40	; Check ROMBIOS DATA colums per row
 19539                                  				; value (80 or 40)
 19540                                  	pop	ds
 19541                                  	jnz	short columns_80 ; 80 columns per line (video mode 3)
 19542                                  	and	byte [screen_f_1],0BFh ; ~40h
 19543                                  	mov	word [screen_f_2],0A0Ah ; 10 bytes (file size field)
 19544                                  	and	byte [screen_f_3],0BFh
 19545                                  	and	byte [screen_f_4],0BFh
 19546                                  	mov	word [screen_f_5],0A0Ah ; 10 bytes (file size field)
 19547                                  	and	byte [screen_f_6],0BFh
 19548                                  	mov	word [screen_f_7],1C1Ch ; 28 bytes (free bytes field)
 19549                                  	;jmp	short screen_f_set_retn
 19550                                  	retn
 19551                                  columns_80:
 19552                                  	or	byte [screen_f_1],40h
 19553                                  	mov	word [screen_f_2],0E0Eh ; 14 bytes (file size field)
 19554                                  	or	byte [screen_f_3],40h
 19555                                  	or	byte [screen_f_4],40h
 19556                                  	mov	word [screen_f_5],0E0Eh ; 14 bytes (file size field)
 19557                                  	or	byte [screen_f_6],40h
 19558                                  	mov	word [screen_f_7],2020h ; 32 bytes (free bytes field)
 19559                                  screen_f_set_retn:
 19560                                  	retn
 19561                                  %endif
 19562                                  
 19563                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19564                                  %if 0
 19565                                  
 19566                                  ;============================================================================
 19567                                  ; CRATIO.ASM, MSDOS 6.0, 1992
 19568                                  ;============================================================================
 19569                                  ; 08/06/2023 - Retro DOS v4.2
 19570                                  
 19571                                  ; The code to calculate compression ratios requires access to the drive's
 19572                                  ; (DOS) FAT and MagicDrv FAT regions.  Two buffers are used (one for each
 19573                                  ; FAT type).  pbufDOSFAT and pbufMDFAT contain the offset to the buffers,
 19574                                  ; segFATBuf contains the segment (both buffers are in the same segment).
 19575                                  ; The buffers are of variable size: cFATEntries contains the size of the
 19576                                  ; buffers in terms of the number of FAT entries they can contain.
 19577                                  
 19578                                  ; ---------------------------------------------------------------------------
 19579                                  
 19580                                  ;***	OpenCVF - open Compressed Volume File for compression ratio report
 19581                                  ;
 19582                                  ;	ENTRY
 19583                                  ;		FCB setup with drive for DIR
 19584                                  ;
 19585                                  ;	EXIT	If successful, CY clear, CVF file open, fhCVF has file handle,
 19586                                  ;		szCVF has \0 terminated CVF file name, MDBPB loaded.
 19587                                  ;
 19588                                  ;		If unsuccessful, CY set
 19589                                  ;
 19590                                  ;	USED	AX, BX, CX, DX, SI, DI
 19591                                  
 19592                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19593                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1CA1h
 19594                                  OpenCVF:
 19595                                  	mov	ax,-1
 19596                                  	mov	[fhCVF],ax		;indicate CVF not open
 19597                                  	mov	[entInBuf],ax		;  and no FAT entries in buffers
 19598                                  
 19599                                  	mov	dl,[FCB] ; mov dl,5Ch	;target drive of DIR cmd
 19600                                  	or	dl,dl			;default drive?
 19601                                  	jz	short ocvf_default
 19602                                  	dec	dl			;no, from 1=A to 0=A
 19603                                  	jmp	short ocvf_swap_info
 19604                                  
 19605                                  ocvf_default:
 19606                                  	mov	dl,[CURDRV]		;0=A, 1=B, ...
 19607                                  
 19608                                  ocvf_swap_info:
 19609                                  	mov	ax,4A11h ; multMagicDrv	;magicdrv Int 2Fh multiplex ID
 19610                                  	mov	bx,1	 ; MD_DRIVE_MAP	;get drive swap info
 19611                                  	int	2fh
 19612                                  
 19613                                  	or	ax,ax			;0 if okay
 19614                                  	jnz	short ocvf_error
 19615                                  
 19616                                  	test	bl,80h 			;80h set if compressed volume
 19617                                  	jz	short ocvf_error
 19618                                  
 19619                                  	and	bl,7Fh 			;bl = host drive, bh = seq #
 19620                                  
 19621                                  	; The CVF may have been mounted from a swapped host drive, in which
 19622                                  	; case the host drive returned in BL is the original host (now
 19623                                  	; swapped with a CVF).	Make a second drive swap info call on the
 19624                                  	; returned host to see if it must be accessed by a different drive
 19625                                  	; letter.
 19626                                  
 19627                                  	push	bx
 19628                                  	push	dx			;save dl, orig drive letter
 19629                                  
 19630                                  	mov	ax,4A11h ; mov ax,multMagicDrv
 19631                                  	mov	dl,bl
 19632                                  	mov	bx,1	 ; mov bx,MD_DRIVE_MAP
 19633                                  	int	2fh
 19634                                  
 19635                                  	pop	dx
 19636                                  	pop	cx			;bx from 1st drive swap info call
 19637                                  
 19638                                  	or	ax,ax			;0 if okay
 19639                                  	jnz	short ocvf_error
 19640                                  
 19641                                  	and	bl,7Fh
 19642                                  	xchg	bx,cx			;bx = 1st, cx = 2nd swap results
 19643                                  
 19644                                  	cmp	dl,cl			;2nd swap info call return orig drive?
 19645                                  	je	short ocvf_got_host	;yes, 1st swap info call returned host
 19646                                  
 19647                                  	mov	bl,cl			;no, use swapped host, orig seq #
 19648                                  ocvf_got_host:
 19649                                  	; Build the filename of the Compressed Volume File
 19650                                  
 19651                                  	;mov	di,offset TRANGROUP:szCVF
 19652                                  					;CVF name buffer
 19653                                  	mov	di,szCVF
 19654                                  
 19655                                  	mov	al,bl
 19656                                  	add	al,'A'
 19657                                  	mov	ah,':'
 19658                                  	cld
 19659                                  	stosw				; drive:
 19660                                  
 19661                                  	;mov	si,offset TRANGROUP:sCVFRoot
 19662                                  					; \name.
 19663                                  	mov	si,sCVFRoot	; "\DBLSPACE"
 19664                                  	;mov	cx,cbCVFRoot
 19665                                  	mov	cx,10
 19666                                  	rep	movsb
 19667                                  
 19668                                  	add	di,3			; point past extension
 19669                                  	xor	al,al
 19670                                  	std
 19671                                  	stosb				; null terminate
 19672                                  
 19673                                  	mov	al,bh			; seq #
 19674                                  	mov	bl,10
 19675                                  	;mov	cx,3			; 3 digit ext/seq #
 19676                                  	mov	cl,3
 19677                                  ;@@:
 19678                                  ocvf_1:	xor	ah,ah			; convert seq # to ascii
 19679                                  	div	bl			;   and store as CVF extension
 19680                                  	add	ah,'0'
 19681                                  	xchg	ah,al
 19682                                  	stosb
 19683                                  	mov	al,ah
 19684                                  	;loop	@b
 19685                                  	loop	ocvf_1
 19686                                  
 19687                                  	cld
 19688                                  
 19689                                  	; Now open the Compressed Volume File
 19690                                  
 19691                                  	; 08/06/2023
 19692                                  	; MSDOS 6.22 COMMAND.COM code only !
 19693                                  	;;;
 19694                                  	mov	di,szCVF ; *
 19695                                  	mov	word [di+4],5652h ; 'RV' (DRVSPACE)
 19696                                  	mov	ax,3D00h
 19697                                  	;mov	dx,szCVF
 19698                                  	mov	dx,di ; *
 19699                                  	int	21h     ; DOS - 2+ - OPEN DISK FILE WITH HANDLE
 19700                                  			; DS:DX -> ASCIZ filename
 19701                                  			; AL = access mode
 19702                                  			; 0 - read
 19703                                  	jnb     short ocvf_2
 19704                                  	mov	word [di+4],4C42h ; 'BL' (DBLSPACE)
 19705                                  	;;;
 19706                                  
 19707                                  	;mov	ax,(OPEN shl 8) or 00h 	;compatibility mode/read access
 19708                                  	mov	ax,3D00h
 19709                                  	;;mov	dx,offset TRANGROUP:szCVF
 19710                                  	;mov	dx,szCVF
 19711                                  	mov	dx,di ; *
 19712                                  	int	21h
 19713                                  	;jc	short ocvf_error
 19714                                  	; 18/06/2023
 19715                                  	jnc	short ocvf_2
 19716                                  ocvf_error:	; 18/06/2023
 19717                                  	stc				;indicate failure
 19718                                  	retn
 19719                                  ocvf_2:
 19720                                  	mov	[fhCVF],ax		; success, save CVF file handle
 19721                                  
 19722                                  	; Read the extended MagicDrv BPB
 19723                                  
 19724                                  	mov	bx,ax
 19725                                  	;mov	ah,READ
 19726                                  	mov	ah,3Fh
 19727                                  	;mov	cx,size MD_BPB
 19728                                  	mov	cx,64
 19729                                  	;mov	dx,offset TRANGROUP:MDBPB
 19730                                  	mov	dx,MDBPB
 19731                                  	int	21h
 19732                                  	jc	short ocvf_error1
 19733                                  
 19734                                  	cmp	ax,cx			; get it all?
 19735                                  	je	short ocvf_pick_cluster_size
 19736                                  					; yes...
 19737                                  ocvf_error1:
 19738                                  	call	CloseCVF
 19739                                  	; 18/06/2023
 19740                                  ;ocvf_error:
 19741                                  	stc				;indicate failure
 19742                                  	;jmp	short ocvf_ret
 19743                                  	retn
 19744                                  
 19745                                  	; Determine the cluster size to use for ratio calculation
 19746                                  
 19747                                  ocvf_pick_cluster_size:
 19748                                  	cmp	byte [fUseHostSize],0 	; user want Host drive cluster size?
 19749                                  	je	short ovcf_use_CVF_size	; no, use CVF cluster size
 19750                                  
 19751                                  	;mov	ah,Get_Drive_Data	; get the host drive cluster size
 19752                                  	mov	ah,1Ch
 19753                                  	mov	dl,[szCVF]
 19754                                  	;sub	dl,40h	
 19755                                  	sub	dl,'A'-1		; 1 = A, 2 = B, ...
 19756                                  	push	ds
 19757                                  	int	21h
 19758                                  	pop	ds
 19759                                  
 19760                                  	cmp	al,0FFh			; host drive cluster size in AL if okay,
 19761                                  	jne	short ovcf_set_size	;   failed = 0FFh
 19762                                  
 19763                                  ovcf_use_CVF_size:
 19764                                  	;mov	al,[MDBPB.dos_bpb.csecPerClu]
 19765                                  	mov	al,[MDBPB+0Dh]		; using CVF cluster size
 19766                                  
 19767                                  ovcf_set_size:
 19768                                  	mov	[csecPerCluster],al
 19769                                  
 19770                                  	; Lastly, setup the FAT buffers
 19771                                  ocvf_set_buf:
 19772                                  	mov	ax,[BYTCNT]		; if >= 32k TPA space available,
 19773                                  	mov	[savBytCnt],ax		;   setup larger FAT buffers
 19774                                  	cmp	ax,32*1024  ; 8000h
 19775                                  	jae	short ocvf_big_buf
 19776                                  
 19777                                  	; small TPA, use small resident buffers
 19778                                  
 19779                                  	;mov	word ptr [cFATEntries],cRES_FAT_ENTRIES
 19780                                  	mov	word [cFATEntries],32 ; cRES_FAT_ENTRIES
 19781                                  	mov	[segFATBuf],ds
 19782                                  	;mov	word ptr [pbufDOSFAT],offset TRANGROUP:bufDOSFAT
 19783                                  	;mov	word ptr [pbufMDFAT],offset TRANGROUP:bufMDFAT
 19784                                  	mov	word [pbufDOSFAT],bufDOSFAT
 19785                                  	mov	word [pbufMDFAT],bufMDFAT
 19786                                  	;jmp	short ocvf_success
 19787                                  	; 08/06/2023
 19788                                  	; cf = 1
 19789                                  	clc
 19790                                  	retn
 19791                                  
 19792                                  ocvf_big_buf:
 19793                                  	;mov	bx,cBIG_FAT_ENTRIES
 19794                                  	mov	bx,256
 19795                                  	mov	[cFATEntries],bx
 19796                                  
 19797                                  	shl	bx,1			; 6 bytes per entry (2 for DOS FAT, 4 MD FAT)
 19798                                  	mov	cx,bx			; entries * 2
 19799                                  	shl	bx,1
 19800                                  	add	bx,cx			; bx = # entries * 6
 19801                                  
 19802                                  	sub	ax,bx			; reduce TPA size by size of FAT buffers
 19803                                  	and	ax,0FE00h		; init code rounds BytCnt down to multiple of
 19804                                  	mov	[BYTCNT],ax		;   512 bytes -- a no-op with some buf sizes.
 19805                                  
 19806                                  	mov	bx,[TPA]		; buffers in the TPA
 19807                                  	mov	[segFATBuf],bx
 19808                                  	mov	[pbufDOSFAT],ax		; DOS FAT buffer offset
 19809                                  	add	ax,cx			;   + DOS FAT buffer size
 19810                                  	mov	[pbufMDFAT],ax 		;   = MD FAT buffer offset
 19811                                  	; 08/06/2023
 19812                                  	; cf = 0
 19813                                  ;ocvf_success:
 19814                                  	;clc				;indicate success
 19815                                  ocvf_ret:
 19816                                  	retn
 19817                                  
 19818                                  ; ---------------------------------------------------------------------------
 19819                                  
 19820                                  ;***	CloseCVF - close Compressed Volume File
 19821                                  ;
 19822                                  ;	ENTRY	fhCVF has file handle
 19823                                  ;
 19824                                  ;	EXIT
 19825                                  ;
 19826                                  ;	USED	AX, BX, CX, DX
 19827                                  
 19828                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 19829                                  CloseCVF:
 19830                                  	mov	bx,[fhCVF]		; -1 unless file is open
 19831                                  	cmp	bx,-1 ; 0FFFFh
 19832                                  	je	short ccvf_ret
 19833                                  
 19834                                  	;mov	ah,CLOSE
 19835                                  	mov	ah,3Eh
 19836                                  	int	21h
 19837                                  
 19838                                  	mov	word [fhCVF],-1 ; 0FFFFh ; don't try to close again
 19839                                  
 19840                                  	mov	ax,[savBytCnt]		; 'deallocate' DOS & MD FAT buffers
 19841                                  	mov	[BYTCNT],ax		;   by restoring old TPA byte count
 19842                                  ccvf_ret:
 19843                                  	retn
 19844                                  
 19845                                  ; ---------------------------------------------------------------------------
 19846                                  
 19847                                  ;***	CalcCompRatio - calculate file compression ratio
 19848                                  ;
 19849                                  ;	ENTRY	AX = starting cluster of file to get compression ratio of
 19850                                  ;
 19851                                  ;	EXIT	AX = compression ratio.  Example: a ratio of 2.7 to 1.0
 19852                                  ;		     will return AH = 02h & AL = 07h
 19853                                  ;		ccluUsed set to # DOS clusters used by file
 19854                                  ;		csecUsed set to # compressed sectors used by file
 19855                                  ;		ccluUsedDir, ccluUsedTotal, csecUsedDir, csecUsedTotal updated
 19856                                  ;	USED	none
 19857                                  
 19858                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 19859                                  CalcCompRatio:
 19860                                  	push	bx
 19861                                  	push	cx
 19862                                  	push	dx
 19863                                  	push	es
 19864                                  	mov	es,[segFATBuf]		; es is pointer to FAT buffers
 19865                                  	;assume	es:nothing
 19866                                  
 19867                                  	xor	bx,bx			; zero count of sectors & clusters used
 19868                                  	mov	[ccluUsed],bx
 19869                                  	mov	[csecUsed],bx
 19870                                  	mov	[csecUsed+2],bx
 19871                                  ccr_next:
 19872                                  	cmp	ax,2			; sanity check the DOS FAT value
 19873                                  	jb	short ccr_screwy
 19874                                  
 19875                                  	cmp	ax,0FFF0h		; end of file?
 19876                                  	jae	short ccr_eof
 19877                                  
 19878                                  	call	CheckFATBuffers 	; make sure buffers contain target
 19879                                  	jc	short ccr_screwy	;   FAT entries
 19880                                  
 19881                                  	call	GetMDFATEntry		; returns corresponding entry in BX:CX
 19882                                  	jc	short ccr_screwy
 19883                                  
 19884                                  	shl	bx,1			; used bit to CY
 19885                                  	jnc	short ccr_screwy	; better be used!
 19886                                  
 19887                                  	mov	ch,bh			; save uncompressed count
 19888                                  
 19889                                  	shl	bx,1			; get count into position
 19890                                  	and	bx,0F00h		; bh = count of compressed sectors used
 19891                                  	xchg	bh,bl			; bx = count
 19892                                  	inc	bx			; 0 - 15 means 1 - 16 used
 19893                                  
 19894                                  	add	[csecUsed],bx
 19895                                  	adc	word [csecUsed+2],0
 19896                                  
 19897                                  	mov	dx,ax			; save cluster # in dx
 19898                                  
 19899                                  	mov	al,ch			; uncompressed count to al
 19900                                  	mov	cl,3
 19901                                  	shr	al,cl			; get uncompressed count into position
 19902                                  	and	ax,000Fh		; ax = uncompressed count (0 - 15)
 19903                                  	dec	bx			; bx = compressed count (0 - 15)
 19904                                  	cmp	ax,bx			; if the compressed cnt > uncompressed
 19905                                  	;jae	@f			;   fudge a little and use the larger
 19906                                  	jae	short ccr_1 ; jnb
 19907                                  	mov	ax,bx
 19908                                  ;@@:	
 19909                                  ccr_1:
 19910                                  	mov	cl,[csecPerCluster]	; round up to the number of clusters
 19911                                  	xor	ch,ch			;   required for uncompressed
 19912                                  	add	ax,cx			;   sectors
 19913                                  	div	cl
 19914                                  	xor	ah,ah
 19915                                  	add	[ccluUsed],ax
 19916                                  
 19917                                  	mov	ax,dx			; restore cluster #
 19918                                  	call	GetDOSFATEntry		; retuns next DOS FAT entry in AX
 19919                                  	;jc	short ccr_screwy
 19920                                  	;jmp	short ccr_next
 19921                                  	; 08/06/2023
 19922                                  	jnc	short ccr_next
 19923                                  ccr_screwy:
 19924                                  	xor	ax,ax			; something screwy happened, set
 19925                                  					;   ratio to 0.0 and exit
 19926                                  ccr_ret:
 19927                                  	pop	es
 19928                                  	pop	dx
 19929                                  	pop	cx
 19930                                  	pop	bx
 19931                                  	retn
 19932                                  
 19933                                  	; Reached the end-of-file, now calculate the ratio as the
 19934                                  	; number of DOS sectors used / number of compressed sectors used.
 19935                                  
 19936                                  ccr_eof:
 19937                                  	mov	ax,[ccluUsed]
 19938                                  	add	[ccluUsedDir],ax	; update cluster used totals
 19939                                  	add	[ccluUsedTotal],ax
 19940                                  
 19941                                  	mov	cx,[csecUsed+2]
 19942                                  	mov	bx,[csecUsed]		; cx:bx = # compressed sectors used
 19943                                  
 19944                                  	add	[csecUsedDir],bx	; update sector used totals
 19945                                  	adc	[csecUsedDir+2],cx
 19946                                  	add	[csecUsedTotal],bx
 19947                                  	adc	[csecUsedTotal+2],cx
 19948                                  
 19949                                  	call	ComputeRatio		; ax=clusters used, cx:bx=sectors used
 19950                                  
 19951                                  	jmp	short ccr_ret
 19952                                  
 19953                                  	; 08/06/2023
 19954                                  ;ccr_screwy:
 19955                                  ;	xor	ax,ax			; something screwy happened, set
 19956                                  ;					;   ratio to 0.0 and exit
 19957                                  ;ccr_ret:
 19958                                  ;	pop	es
 19959                                  ;	pop	dx
 19960                                  ;	pop	cx
 19961                                  ;	pop	bx
 19962                                  ;	retn
 19963                                  
 19964                                  ; ---------------------------------------------------------------------------
 19965                                  
 19966                                  ;***	ComputeRatio - calculate ratio of compressed sectors used to
 19967                                  ;		       (would be) DOS sectors used
 19968                                  ;
 19969                                  ;	Entry
 19970                                  ;		AX = DOS clusters used, cx:bx = compressed sectors used
 19971                                  ;	Exit
 19972                                  ;		ah = whole portion, al = tenths
 19973                                  ;
 19974                                  ;	Used	BX, CX, DX
 19975                                  
 19976                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 19977                                  ComputeRatio:
 19978                                  	push	si
 19979                                  	push	di
 19980                                  
 19981                                  	mov	si,bx
 19982                                  	mov	di,cx			; save cx:bx in di:si
 19983                                  
 19984                                  	mov	bl,[csecPerCluster]
 19985                                  	xor	bh,bh
 19986                                  	mul	bx			; dx:ax = # DOS sectors used
 19987                                  	mov	bx,si			; restore bx
 19988                                  
 19989                                  	call	Div32			; dx:ax = quotient, cx:bx = remainder
 19990                                  
 19991                                  	push	ax			; save quotient
 19992                                  
 19993                                  	mov	ax,bx			; if no remainder, tenths will be 0
 19994                                  	or	ax,cx			;   which is in AX so skip following
 19995                                  	jz	short cr_got_tenths	;   (happens frequently)
 19996                                  
 19997                                  	; Multiply the reminder by 10, add half the divisor so result is
 19998                                  	; rounded up, and divide again to get tenths digit
 19999                                  
 20000                                  	mov	ax,cx
 20001                                  	xor	dx,dx
 20002                                  	mov	cx,bx
 20003                                  	mov	bx,10
 20004                                  	mul	bx
 20005                                  	xchg	ax,cx
 20006                                  	mul	bx
 20007                                  	add	dx,cx			; dx:ax = remainder * 10
 20008                                  
 20009                                  	mov	cx,di
 20010                                  	mov	bx,si
 20011                                  	shr	cx,1
 20012                                  	rcr	bx,1			; cx:bx = 1/2 divisor
 20013                                  	add	ax,bx
 20014                                  	adc	dx,cx			; dx:ax = remainder * 10 + 1/2 divisor
 20015                                  
 20016                                  	mov	cx,di
 20017                                  	mov	bx,si
 20018                                  
 20019                                  	call	Div32
 20020                                  
 20021                                  cr_got_tenths:
 20022                                  	pop	bx			; original quotient
 20023                                  	mov	ah,bl
 20024                                  
 20025                                  	cmp	al,10			; if the tenths rounded up to the
 20026                                  	jb	short cr_exit 		;   next whole number, adjust the
 20027                                  					;   whole number part and 0 the
 20028                                  	inc	ah			;   tenths  (i.e. round 1.97 to 2.0)
 20029                                  	xor	al,al
 20030                                  cr_exit:
 20031                                  	pop	di
 20032                                  	pop	si
 20033                                  
 20034                                  	retn
 20035                                  
 20036                                  ; ---------------------------------------------------------------------------
 20037                                  
 20038                                  ;***	Div32 - 32 bit divide for computing ratios
 20039                                  ;
 20040                                  ;	Entry	DX:AX = dividend, CX:BX = divisor
 20041                                  ;
 20042                                  ;	Exit	DX:AX = quotient, CX:BX = reminder
 20043                                  
 20044                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 20045                                  Div32:
 20046                                  	jcxz	d32_16bit		; differently if 16bit divisor
 20047                                  
 20048                                  	push	si
 20049                                  	push	di
 20050                                  
 20051                                  	; Brute force divide by subtraction. This is okay because worse case
 20052                                  	; the dividend will only be 16 times greater, and typically about 2
 20053                                  	; times
 20054                                  
 20055                                  	xor	si,si
 20056                                  	mov	di,si			; di:si is quotient
 20057                                  ;@@:
 20058                                  div32_1:
 20059                                  	sub	ax,bx			; subtract divisor
 20060                                  	sbb	dx,cx
 20061                                  	jc	short d32_too_far
 20062                                  
 20063                                  	add	si, 1			; accumulate quotient
 20064                                  	adc	di, 0
 20065                                  	;jmp	short @b
 20066                                  	jmp	short div32_1
 20067                                  
 20068                                  d32_too_far:
 20069                                  	add	ax,bx			; fix the last subtraction
 20070                                  	adc	dx,cx
 20071                                  
 20072                                  	mov	cx,di
 20073                                  	mov	bx,si			; dx:ax = remainder, cx:bx = quoient
 20074                                  
 20075                                  	xchg	ax,bx
 20076                                  	xchg	dx,cx			; dx:ax = quoient, cx:bx = remainder
 20077                                  
 20078                                  	pop	di
 20079                                  	pop	si
 20080                                  
 20081                                  	retn
 20082                                  
 20083                                  d32_16bit:
 20084                                  	div	bx			; divide dx:ax by bx
 20085                                  
 20086                                  	mov	bx,dx			; remainder to cx:bx
 20087                                  	xor	dx,dx			; quotient to dx:ax
 20088                                  	mov	cx,dx
 20089                                  	retn
 20090                                  
 20091                                  ; --------------------------------------------------------------------------- 
 20092                                  
 20093                                  ;***	GetDOSFATEntry - returns next cluster in file's FAT chain
 20094                                  ;
 20095                                  ;	Entry	AX = current cluster number
 20096                                  ;		ES = segment of FAT buffer
 20097                                  ;		Entry should be in FAT buffer
 20098                                  ;
 20099                                  ;	Exit	AX = next cluster number
 20100                                  ;		CY set if error
 20101                                  ;
 20102                                  ;	Uses	BX
 20103                                  
 20104                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20105                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1EF2h
 20106                                  GetDOSFATEntry:
 20107                                  	sub	ax,[entInBuf]		; calc entry # in buffer
 20108                                  	jc	short gdf_ret 		; CY already set for error
 20109                                  
 20110                                  	mov	bx,ax
 20111                                  
 20112                                  	;cmp	MDBPB.f12BitFAT, 0	; 12 or 16 bit FAT?
 20113                                  	cmp	byte [MDBPB+3Dh],0
 20114                                  	jnz	short gdf_12		; go do 12
 20115                                  
 20116                                  	shl	bx,1			; offset = entry * 2
 20117                                  	add	bx,[pbufDOSFAT]
 20118                                  	mov	ax,[es:bx]
 20119                                  	; 08/06/2023
 20120                                  	; cf = 0
 20121                                  ;gdf_success:
 20122                                  	;clc				; success
 20123                                  gdf_ret:
 20124                                  	retn
 20125                                  
 20126                                  gdf_12:
 20127                                  	shr	bx,1
 20128                                  	add	bx,ax			; offset to entry = entry * 1.5
 20129                                  	add	bx,[pbufDOSFAT]
 20130                                  
 20131                                  ;	ES:BX points to the word containing the desired 12 bit FAT entry.
 20132                                  ;	For odd entries, the upper 12 bits are valid, for even entries
 20133                                  ;	the low 12 bits are valid.  odd: OOOx  even: xEEE
 20134                                  
 20135                                  	test	al,1			; is current entry odd?
 20136                                  
 20137                                  	mov	ax,[es:bx]		; word with FAT entry
 20138                                  	jnz	short gdf_odd
 20139                                  
 20140                                  	and	ax,0FFFh		; keep low 12 bits for even
 20141                                  	jmp	short gdf_testEOF
 20142                                  
 20143                                  gdf_odd:
 20144                                  	mov	bx,cx			; (save cx in bx)
 20145                                  	mov	cl,4
 20146                                  	shr	ax,cl			; upper 12 bits for odd
 20147                                  	mov	cx,bx			; (restore cx)
 20148                                  
 20149                                  gdf_testEOF:
 20150                                  	cmp	ax,0FF0h		; valid entry?
 20151                                  	;jb	short gdf_success
 20152                                  	cmc	; cf = 1 <--> cf = 0
 20153                                  	jnc	short gdf_ret
 20154                                  
 20155                                  	or	ah,0F0h			; caller expects 16 bit special values
 20156                                  	;jmp	short gdf_success
 20157                                  	; cf = 0
 20158                                  	retn
 20159                                  
 20160                                  ; --------------------------------------------------------------------------- 
 20161                                  
 20162                                  ;***	GetMDFATEntry - returns requested MD FAT entry
 20163                                  ;
 20164                                  ;	Entry	AX = current DOS cluster number
 20165                                  ;		ES = segment of FAT buffer
 20166                                  ;		Entry should be in FAT buffer
 20167                                  ;
 20168                                  ;	Exit	BX:CX = corresponding MD FAT entry
 20169                                  ;		CY set if error
 20170                                  ;
 20171                                  ;	Uses	None
 20172                                  
 20173                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 20174                                  GetMDFATEntry:
 20175                                  	mov	bx,ax
 20176                                  	sub	bx,[entInBuf]		; calc entry # in buffer
 20177                                  	jc	short gmf_ret 		; CY already set for error return
 20178                                  
 20179                                  	shl	bx,1
 20180                                  	shl	bx,1			; * 4 bytes per MDFAT entry
 20181                                  
 20182                                  	add	bx,[pbufMDFAT]
 20183                                  	mov	cx,[es:bx]
 20184                                  	mov	bx,[es:bx+2]
 20185                                  
 20186                                  	clc
 20187                                  gmf_ret:
 20188                                  	retn
 20189                                  
 20190                                  ; --------------------------------------------------------------------------- 
 20191                                  
 20192                                  ;***	CheckFATBuffers - check that target FAT entry is in FAT buffers.  If
 20193                                  ;			  not, fill the buffers starting with the requested
 20194                                  ;			  entry.
 20195                                  ;
 20196                                  ;	ENTRY	AX = FAT entry #
 20197                                  ;		ES = segment of FAT buffers
 20198                                  ;
 20199                                  ;	EXIT	FAT buffers contain target entry, or CY set if error
 20200                                  ;		entInBuf updated
 20201                                  ;
 20202                                  ;	USED	BX
 20203                                  
 20204                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20205                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1F4Bh
 20206                                  
 20207                                  CheckFATBuffers:
 20208                                  	mov	bx,ax
 20209                                  	sub	bx,[entInBuf]
 20210                                  	jb	short cfb_load_fat
 20211                                  
 20212                                  	sub	bx,[cFATEntries]
 20213                                  	jae	short cfb_load_fat ; jnb
 20214                                  
 20215                                  	clc
 20216                                  	retn
 20217                                  
 20218                                  	; Desired entry isn't in the FAT buffers, reload the buffers to
 20219                                  	; include it
 20220                                  
 20221                                  cfb_load_fat:
 20222                                  	push	ax
 20223                                  	push	cx
 20224                                  	push	dx
 20225                                  
 20226                                  	; Start with the DOS FAT buffer
 20227                                  
 20228                                  	xor	cx,cx			; zero high offset to FAT file position
 20229                                  
 20230                                  	;cmp	MDBPB.f12BitFAT, 0	; 12 or 16 bit FAT?
 20231                                  	cmp	byte [MDBPB+3Dh],0
 20232                                  	jnz	short cfb_12		; go do 12
 20233                                  
 20234                                  	mov	[entInBuf],ax		; this entry is first
 20235                                  
 20236                                  	shl	ax,1			; 2 bytes per cluster #
 20237                                  	rcl	cx,1			; cx:ax = offset to FAT entry
 20238                                  
 20239                                  	jmp	short cfb_common
 20240                                  
 20241                                  cfb_12:
 20242                                  	;and	al,not 1 ; 0FEh		; start with even # entry
 20243                                  	and	al,~1
 20244                                  	mov	[entInBuf],ax
 20245                                  
 20246                                  	mov	bx,ax
 20247                                  	shr	bx,1
 20248                                  	add	ax,bx			; ax = offset to FAT entry
 20249                                  					;      (entry # * 1.5)
 20250                                  cfb_common:
 20251                                  	mov	bx,ax			; cx:bx = offset to FAT entry
 20252                                  
 20253                                  	;mov	ax,[MDBPB.csecMDReserved] ; # magicDrv reserved sectors
 20254                                  	mov	ax,[MDBPB+27h]
 20255                                  	;add	ax,[MDBPB.dos_bpb.csecReserved]
 20256                                  	add	ax,[MDBPB+0Eh]
 20257                                  
 20258                                  	;mul	word [MDBPB.dos_bpb.cbPerSec]
 20259                                  	mul	word [MDBPB+0Bh]	; DX:AX = DOS FAT file origin
 20260                                  	add	ax,bx
 20261                                  	adc	dx,cx			; DX:AX = file offset to read from
 20262                                  
 20263                                  	mov	cx,[cFATEntries]	; size to read
 20264                                  	shl	cx,1
 20265                                  	mov	bx,[pbufDOSFAT]		; es:bx = location to read
 20266                                  
 20267                                  	call	ReadCVFile
 20268                                  	jc	short cfb_error
 20269                                  
 20270                                  	; Now read the corresponding MagicDrv FAT entries
 20271                                  
 20272                                  	;mov	ax,[MDBPB.secMDFATStart]
 20273                                  	mov	ax,[MDBPB+24h]
 20274                                  	inc	ax
 20275                                  	;mul	word [MDBPB.dos_bpb.cbPerSec]
 20276                                  	mul	word [MDBPB+0Bh]	; DX:AX = MDFAT file offset
 20277                                  
 20278                                  	mov	bx,[entInBuf]
 20279                                  	xor	cx,cx			; CX:BX = 32 bit cluster #
 20280                                  	;add	bx,[MDBPB.cluFirstData]
 20281                                  	add	bx,[MDBPB+2Dh]
 20282                                  	adc	cx,cx			; CX:BX = MDFAT entry #
 20283                                  
 20284                                  	shl	bx,1
 20285                                  	rcl	cx,1
 20286                                  	shl	bx,1
 20287                                  	rcl	cx,1			; * 4 bytes per MDFAT entry
 20288                                  
 20289                                  	add	ax,bx
 20290                                  	adc	dx,cx			; DX:AX = file offset of MDFAT entry
 20291                                  
 20292                                  	mov	cx,[cFATEntries]
 20293                                  	shl	cx,1
 20294                                  	shl	cx,1			; size to read
 20295                                  	mov	bx,[pbufMDFAT]		; es:bx = location to read into
 20296                                  
 20297                                  	call	ReadCVFile
 20298                                  	;jnc	short cfb_ret ; cf = 0 ; 08/06/2023
 20299                                  	; 08/06/2023
 20300                                  	; cf = 1
 20301                                  cfb_error:
 20302                                  	;stc
 20303                                  cfb_ret:
 20304                                  	pop	dx
 20305                                  	pop	cx
 20306                                  	pop	ax
 20307                                  	retn
 20308                                  
 20309                                  ; --------------------------------------------------------------------------- 
 20310                                  
 20311                                  ;***	ReadCVFile - read from the Compressed Volume File
 20312                                  ;
 20313                                  ;	Entry	DX:AX file offset, ES:BX buffer location, CX length in bytes
 20314                                  ;
 20315                                  ;	Exit	CY set if error, else data read
 20316                                  ;
 20317                                  ;	Uses	AX, BX, CX, DX
 20318                                  
 20319                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 20320                                  ReadCVFile:
 20321                                  	push	bx			; save buffer loc
 20322                                  	push	cx			; save read length
 20323                                  
 20324                                  	mov	cx,dx
 20325                                  	mov	dx,ax			; cx:dx = file offset of fat entry
 20326                                  	;mov	ax,(LSEEK shl 8) or 0
 20327                                  	mov	ax,4200h
 20328                                  	mov	bx,[fhCVF]
 20329                                  	int	21h
 20330                                  	jc	short rcf_ret 		; CY set for error return
 20331                                  
 20332                                  	;mov	ah,READ
 20333                                  	mov	ah,3Fh
 20334                                  	pop	cx			; read length
 20335                                  	pop	dx			; buffer loc offset
 20336                                  	push	ds
 20337                                  	push	es
 20338                                  	pop	ds			; buffer loc segment
 20339                                  	int	21h
 20340                                  	pop	ds
 20341                                  	jc	short rcf_ret 		; CY set for error return
 20342                                  
 20343                                  	cmp	ax,cx			; read it all?
 20344                                  	;je	short rcf_ret 		; yes, CY clear
 20345                                  	; 08/06/2023
 20346                                  	; ax < cx
 20347                                  	;stc				; end-of-file?
 20348                                  rcf_ret:
 20349                                  	retn
 20350                                  
 20351                                  %endif
 20352                                  
 20353                                  ;============================================================================
 20354                                  ; TCMD1B.ASM, MSDOS 6.0, 1991
 20355                                  ;============================================================================
 20356                                  ; 09/10/2018 - Retro DOS v3.0
 20357                                  
 20358                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1195h
 20359                                  
 20360                                  ; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20361                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 1A4Ah
 20362                                  
 20363                                  ; =============== S U B	R O U T	I N E =======================================
 20364                                  
 20365                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20366                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1FF4h
 20367                                  
 20368                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20369                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1DCCh
 20370                                  PAUSE:
 20371 00001D00 BA[A490]                	mov	dx,PAUSEMES_PTR ; 19/02/2023
 20372 00001D03 E82237                  	call	std_printf
 20373 00001D06 E859E9                  	call	GETKEYSTROKE
 20374                                  	;call	CRLF2
 20375                                  	;retn
 20376                                  	; 19/02/2023
 20377 00001D09 E96D0C                  	jmp	CRLF2
 20378                                  
 20379                                  ; ---------------------------------------------------------------------------
 20380                                  
 20381                                  ;****************************************************************
 20382                                  ;*
 20383                                  ;* ROUTINE:	DEL/ERASE - erase file(s)
 20384                                  ;*
 20385                                  ;* FUNCTION:	PARSE command line for file or path name and /P
 20386                                  ;*		and invoke PATHCRUNCH. If an error occurs, set
 20387                                  ;*		up an error message and transfer control to CERROR.
 20388                                  ;*		Otherwise, transfer control to NOTEST2 if /P not
 20389                                  ;*		entered or SLASHP_ERASE if /P entered.
 20390                                  ;*
 20391                                  ;* INPUT:	command line at offset 81H
 20392                                  ;*
 20393                                  ;* OUTPUT:	if no error:
 20394                                  ;*		FCB at 5ch set up with filename(s) entered
 20395                                  ;*		Current directory set to entered directory
 20396                                  ;*
 20397                                  ;****************************************************************
 20398                                  
 20399                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20400                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A57h
 20401                                  
 20402                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20403                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2001h
 20404                                  
 20405                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20406                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1DD9h
 20407                                  ERASE:
 20408                                  	; MSDOS 6.0
 20409                                  
 20410                                  	;assume	ds:trangroup,es:trangroup
 20411                                  
 20412 00001D0C BE8100                  	mov	si,81h		;AC000; get command line
 20413 00001D0F C706[0B9C]0000          	mov	word [COMSW],0 	;AN000; clear switch indicator
 20414 00001D15 BF[9A96]                	mov	di,PARSE_ERASE
 20415                                  				;AN000; Get address of PARSE_ERASE
 20416 00001D18 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20417                                  erase_scan:
 20418 00001D1A 31D2                    	xor	dx,dx		;AN000;
 20419 00001D1C E83C08                  	call	Parse_With_Msg	;AC018; call parser
 20420                                  	
 20421                                  	;cmp	ax,-1  ; 0FFFFh
 20422                                  	;;cmp	ax,END_OF_LINE	;AN000; are we at end of line?
 20423                                  	;je	short good_line	;AN000; yes - done parsing
 20424                                  	;;cmp	ax,0
 20425                                  	;;cmp	ax,RESULT_NO_ERROR ; 0
 20426                                  	;and	ax,ax		;AC000; did we have an error?
 20427                                  	;jnz	short errj2	;AC000; yes exit
 20428                                  	; 10/06/2023
 20429 00001D1F 40                      	inc	ax  ; cmp ax,-1
 20430 00001D20 743C                    	jz	short good_line ; 0FFFFh -> 0
 20431 00001D22 48                      	dec	ax  ; cmp ax,0	
 20432 00001D23 7566                    	jnz	short errj2  ; 1 -> 0
 20433                                  	; ax = 0
 20434                                  
 20435 00001D25 813E[EDA5][0D96]        	cmp	word [PARSE1_SYN],SLASH_P_SYN ; "/P"
 20436                                  				;AN000; was /P entered?
 20437 00001D2B 741C                    	je	short set_erase_prompt
 20438                                  				;AN000; yes - go set prompt
 20439                                  ;
 20440                                  ; Must be filespec since no other matches occurred. move filename to srcbuf
 20441                                  ;
 20442 00001D2D 56                      	push	si		;AC000; save position in line
 20443 00001D2E C536[EFA5]              	lds	si,[PARSE1_ADDR]
 20444                                  				;AC000; get address of filespec
 20445                                  	;cmp	byte [si+1],colon_char
 20446 00001D32 807C013A                	cmp	byte [si+1],':'	;AC000; drive specified?
 20447 00001D36 750B                    	jne	short erase_drive_ok
 20448                                  				;AC000; no - continue
 20449                                  	;cmp	byte [si+2],END_OF_LINE_OUT
 20450 00001D38 807C0200                	cmp	byte [si+2],0	;AC000; was only drive entered?
 20451 00001D3C 7505                    	jne	short erase_drive_ok
 20452                                  				;AC000; no - continue
 20453 00001D3E B80200                  	mov	ax,ERROR_FILE_NOT_FOUND ; 2
 20454                                  				;AN022; get message number in control block
 20455 00001D41 EB3D                    	jmp	short extend_setup
 20456                                  				;AC000; exit
 20457                                  erase_drive_ok:
 20458 00001D43 E89213                  	call	Move_To_SrcBuf	;AC000; move to srcbuf
 20459 00001D46 5E                      	pop	si		;AC000; get position back
 20460 00001D47 EBD1                    	jmp	short erase_scan
 20461                                  				;AN000; continue parsing
 20462                                  set_erase_prompt:
 20463 00001D49 833E[0B9C]00            	cmp	word [COMSW],0 	;AN018; was /P already entered?
 20464 00001D4E 7408                    	jz	short ok_to_set_erase_prompt
 20465                                  				;AN018; no go set switch
 20466                                  	;mov	ax,1
 20467 00001D50 B80100                  	mov	ax,MoreArgs_Ptr 
 20468                                  				;AN018; set up too many arguments
 20469 00001D53 E81408                  	call	setup_parse_error_msg
 20470                                  				;AN018; set up an error message
 20471 00001D56 EB33                    	jmp	short errj2	;AN018; exit
 20472                                  
 20473                                  ok_to_set_erase_prompt: 	;AN018;
 20474 00001D58 FF06[0B9C]              	inc	word [COMSW]	;AN000; indicate /p specified
 20475 00001D5C EBBC                    	jmp	short erase_scan
 20476                                  				;AN000; continue parsing
 20477                                  good_line:			;G  We know line is good
 20478 00001D5E E8C10C                  	call	PathCrunch
 20479 00001D61 730D                    	jnc	short checkdr
 20480 00001D63 A1[349F]                	mov	ax,[Msg_Numb]	;AN022; get message number
 20481                                  	;cmp	ax,0		;AN022; was message flag set?
 20482 00001D66 09C0                    	or	ax,ax
 20483 00001D68 7516                    	jnz	short extend_setup
 20484                                  				;AN022; yes - print out message
 20485                                  	;cmp	byte [DestIsDir],0
 20486 00001D6A 3806[B99D]              	cmp	[DestIsDir],al 	; No CHDIRs worked
 20487 00001D6E 750D                    	jnz	short badpath_err
 20488                                  				;AC022; see if they should have
 20489                                  checkdr:
 20490 00001D70 833E[0B9C]00            	cmp	word [COMSW],0 	;AN000; was /p specified
 20491 00001D75 7403                    	jz	short notest2j	;AN000; no - go to notest2
 20492 00001D77 E9FB1B                  	jmp	slashp_erase	;AN000; yes - go to slashp_erase
 20493                                  notest2j:
 20494 00001D7A E9931B                  	jmp	notest2
 20495                                  
 20496                                  badpath_err:			;AN022; "Path not found" message
 20497 00001D7D B80300                  	mov	ax,ERROR_PATH_NOT_FOUND ; 3
 20498                                  				;AN022; set up error number
 20499                                  extend_setup:			;AN022;
 20500                                  	;mov	byte [msg_disp_class],1
 20501 00001D80 C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class
 20502                                  				;AN022; set up extended error msg class
 20503 00001D85 BA[D78F]                	mov	dx,extend_buf_ptr
 20504                                  				;AC022; get extended message pointer
 20505 00001D88 A3[D78F]                	mov	[extend_buf_ptr],ax
 20506                                  				;AN022; get message number in control block
 20507                                  errj2:				;AC022; exit jump
 20508 00001D8B E9980F                  	jmp	cerror		;AN022;
 20509                                  
 20510                                  ; ---------------------------------------------------------------------------
 20511                                  
 20512                                  ; ****************************************************************
 20513                                  ; *
 20514                                  ; * ROUTINE:	 CRENAME - rename file(s)
 20515                                  ; *
 20516                                  ; * FUNCTION:	 PARSE command line for one full filespec and one
 20517                                  ; *		 filename. Invoke PATHCRUNCH on the full filespec.
 20518                                  ; *		 Make sure the second filespec only contains a
 20519                                  ; *		 filename. If both openands are valid, attempt
 20520                                  ; *		 to rename the file.
 20521                                  ; *
 20522                                  ; * INPUT:	 command line at offset 81H
 20523                                  ; *
 20524                                  ; * OUTPUT:	 none
 20525                                  ; *
 20526                                  ; ****************************************************************
 20527                                  
 20528                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20529                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20530                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20531                                  CRENAME:
 20532                                  	; MSDOS 6.0
 20533                                  	;assume	ds:trangroup,es:trangroup
 20534                                  
 20535 00001D8E BE8100                  	mov	si,81h		;AC000; Point to command line
 20536 00001D91 BF[2797]                	mov	di,PARSE_RENAME
 20537                                  				;AN000; Get address of PARSE_RENAME
 20538 00001D94 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20539 00001D96 31D2                    	xor	dx,dx		;AN000;
 20540 00001D98 E8C007                  	call	Parse_With_Msg	;AC018; call parser
 20541                                  	;cmp	ax,RESULT_NO_ERROR ; 0
 20542 00001D9B 09C0                    	or	ax,ax ; 0 ?	;AC000; did we have an error?
 20543                                  ;	jz	short crename_no_parse_error
 20544                                  				;AC000; no - continue
 20545 00001D9D 752C                    	jnz	short crename_parse_error
 20546                                  				;AC000; Yes, fail. (need long jump)
 20547                                  ;
 20548                                  ;  Get first file name returned from parse into our buffer
 20549                                  ;
 20550                                  crename_no_parse_error:
 20551 00001D9F 56                      	push	si		;AN000; save position in line
 20552 00001DA0 C536[EFA5]              	lds	si,[PARSE1_ADDR]
 20553                                  				;AN000; get address of filespec
 20554 00001DA4 E83113                  	call    Move_To_SrcBuf	;AN000; move to srcbuf
 20555 00001DA7 5E                      	pop	si		;AN000; restore position in line
 20556                                  
 20557 00001DA8 31D2                    	xor	dx,dx		;AN000; clear dx
 20558 00001DAA E8AE07                  	call	Parse_With_Msg	;AC018; call parser
 20559                                  	;cmp	ax,RESULT_NO_ERROR
 20560 00001DAD 21C0                    	and	ax,ax ; 0 ?	;AN000; did we have an error?
 20561 00001DAF 751A                    	jnz	short crename_parse_error
 20562                                  				;AN000; Yes, fail.
 20563                                  ;
 20564                                  ;  Check the second file name for drive letter colon
 20565                                  ;
 20566 00001DB1 56                      	push	si		;AN000; save position in line
 20567 00001DB2 C536[EFA5]              	lds	si,[PARSE1_ADDR]
 20568                                  				;AC000; get address of path
 20569                                  	;mov	al,':'		;AC000;
 20570                                  	;cmp	[si+1],al	;AC000; Does the 2nd parm have a drive spec?
 20571 00001DB6 807C013A                	cmp	byte [si+1],':'
 20572 00001DBA 7511                    	jnz	short ren_no_drive
 20573                                  				;AN000; Yes, error
 20574                                  	;mov	byte [msg_disp_class],2
 20575 00001DBC C606[D58F]02            	mov	byte [msg_disp_class],parse_msg_class
 20576                                  				;AN000; set up parse error msg class
 20577 00001DC1 BA[D78F]                	mov	dx,extend_buf_ptr
 20578                                  				;AC000; get extended message pointer
 20579                                  	;mov	word [extend_buf_ptr],0Ah
 20580 00001DC4 C706[D78F]0A00          	mov	word [extend_buf_ptr],BadParm_Ptr
 20581                                  				;AN000; get "Invalid parameter" message number
 20582 00001DCA 5E                      	pop	si		;AN000;
 20583                                  crename_parse_error:		;AC022;
 20584 00001DCB EB64                    	jmp	short errj	;AC000;
 20585                                  
 20586                                  ;  Get second file name returned from parse into the fCB. Save
 20587                                  ;  character after file name so we can later check to make sure it
 20588                                  ;  isn't a path character.
 20589                                  
 20590                                  ren_no_drive:
 20591 00001DCD BF6C00                  	mov	di,FCB+10h ; 6Ch
 20592                                  				;AC000; set up to parse second file name
 20593                                  	;mov	ax,(Parse_File_Descriptor SHL 8) OR 01H ;AC000;
 20594 00001DD0 B80129                  	mov	ax,2901h
 20595 00001DD3 CD21                    	int	21h		;AC000; do the function
 20596 00001DD5 AC                      	lodsb			;AC000; Load char after filename
 20597 00001DD6 A2[B19D]                	mov	[One_Char_Val],al
 20598                                  				;AN000; save char after filename
 20599 00001DD9 5E                      	pop	si		;AN000; get line position back
 20600                                  ;
 20601                                  ; We have source and target. See if any args beyond.
 20602                                  ;
 20603 00001DDA BF[2797]                	mov	di,PARSE_RENAME
 20604                                  				;AC000; get address of parse_rename
 20605 00001DDD E86507                  	call	parse_check_eol ;AC000; are we at end of line?
 20606 00001DE0 75E9                    	jnz	short crename_parse_error
 20607                                  				;AN000; no, fail.
 20608 00001DE2 E83D0C                  	call	PathCrunch
 20609 00001DE5 BA[E88F]                	mov	dx,BADCPMES_PTR
 20610 00001DE8 74A1                    	jz	short errj2	; If 1st parm a dir, print error msg
 20611 00001DEA 730F                    	jnc	short notest3
 20612 00001DEC A1[349F]                	mov	ax,[Msg_Numb]	;AN022; get message number
 20613                                  	;cmp	ax,0		;AN022; was message flag set?
 20614 00001DEF 21C0                    	and	ax,ax ; 0 ?
 20615 00001DF1 758D                    	jnz	short extend_setup
 20616                                  				;AN022; yes - print out message
 20617                                  	;cmp	byte [DestIsDir],0
 20618 00001DF3 3806[B99D]              	cmp	[DestIsDir],al	; No CHDIRs worked
 20619 00001DF7 7402                    	jz	short notest3 	; see if they should have
 20620 00001DF9 EB82                    	Jmp	badpath_err	;AC022; set up error
 20621                                  notest3:
 20622 00001DFB A0[B19D]                	mov	al,[One_Char_Val]
 20623                                  				;AN000; move char into AX
 20624 00001DFE BA[0990]                	mov	dx,INORNOT_PTR 
 20625                                  				; Load invalid fname error ptr
 20626 00001E01 E8100C                  	call	pathchrcmp	; Is the char in al a path sep?
 20627 00001E04 742B                    	jz	short errj	; Yes, error - 2nd arg must be
 20628                                  				;  filename only.
 20629                                  	;mov	ah,FCB_Rename
 20630 00001E06 B417                    	mov	ah,17h
 20631 00001E08 BA5C00                  	mov	dx,FCB ; 5Ch
 20632 00001E0B CD21                    	int	21h
 20633 00001E0D 3CFF                    	cmp	al,0FFh		; Did an error occur??
 20634 00001E0F 7506                    	jne	short renameok
 20635                                  
 20636 00001E11 E83702                  	call	get_ext_error_number
 20637                                  				;AN022; get extended error
 20638 00001E14 50                      	push	ax		;AC022; Save results
 20639 00001E15 B0FF                    	mov	al,0FFh		; Restore original error state
 20640                                  renameok:
 20641 00001E17 50                      	push	ax
 20642 00001E18 E8150A                  	call	RestUDir
 20643 00001E1B 58                      	pop	ax
 20644 00001E1C FEC0                    	inc	al
 20645                                  	;;retnz
 20646                                  	;jz	short rn1
 20647                                  	;retn	
 20648 00001E1E 7514                    	jnz	short ret56
 20649                                  rn1:
 20650 00001E20 58                      	pop	ax		;AC022; get the error number back
 20651 00001E21 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND ; 2 
 20652                                  				;AN022; error file not found?
 20653 00001E24 7408                    	je	short use_renerr
 20654                                  				;AN022; yes - use generic error message
 20655 00001E26 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5 
 20656                                  				;AN022; error file not found?
 20657 00001E29 7403                    	je	short use_renerr
 20658                                  				;AN022; yes - use generic error message
 20659 00001E2B E952FF                  	jmp	extend_setup	;AN022; need long jump - use extended error
 20660                                  
 20661                                  use_renerr:
 20662 00001E2E BA[E58F]                	mov	dx,RENERR_PTR	;AC022;
 20663                                  errj:
 20664 00001E31 E9F20E                  	jmp	cerror
 20665                                  ret56:
 20666                                  ;typefil_ret:	; 20/02/2023 ; 17/04/2023
 20667 00001E34 C3                      	retn
 20668                                  
 20669                                  ; ---------------------------------------------------------------------------
 20670                                  
 20671                                  ;****************************************************************
 20672                                  ;*
 20673                                  ;* ROUTINE:	TYPEFIL - Display the contents of a file to the
 20674                                  ;*		standard output device
 20675                                  ;*
 20676                                  ;* SYNTAX:	TYPE filespec
 20677                                  ;*
 20678                                  ;* FUNCTION:	If a valid filespec is found, read the file until
 20679                                  ;*		1Ah and display the contents to STDOUT.
 20680                                  ;*
 20681                                  ;* INPUT:	command line at offset 81H
 20682                                  ;*
 20683                                  ;* OUTPUT:	none
 20684                                  ;*
 20685                                  ;****************************************************************
 20686                                  
 20687                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20688                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20689                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20690                                  TYPEFIL:
 20691                                  	; MSDOS 6.0	
 20692                                  	;assume	ds:trangroup,es:trangroup
 20693                                  
 20694 00001E35 BE8100                  	mov	si,81h
 20695 00001E38 BF[8896]                	mov	di,PARSE_MRDIR
 20696                                  				;AN000; Get address of PARSE_MRDIR
 20697 00001E3B 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20698 00001E3D 31D2                    	xor	dx,dx		;AN000;
 20699 00001E3F E81907                  	call	Parse_With_Msg	;AC018; call parser
 20700                                  	;cmp	ax,RESULT_NO_ERROR
 20701 00001E42 09C0                    	or	ax,ax ; 0 ?	;AC000; did we have an error?
 20702 00001E44 751E                    	jnz	short typefil_parse_error
 20703                                  				;AN000; yes - issue error message
 20704                                  
 20705 00001E46 56                      	push	si		;AC000; save position in line
 20706 00001E47 C536[EFA5]              	lds	si,[PARSE1_ADDR]
 20707                                  				;AC000; get address of filespec
 20708 00001E4B E88A12                  	call	Move_To_SrcBuf	;AC000; move to srcbuf
 20709 00001E4E 5E                      	pop	si		;AC000; get position back
 20710 00001E4F BF[8896]                	mov	di,PARSE_MRDIR
 20711                                  				;AC000; get address of parse_mrdir
 20712 00001E52 E8F006                  	call	parse_check_eol ;AC000; are we at end of line?
 20713                                  	;jz	short gottarg 	;AC000; yes - continue
 20714                                  	; 20/02/2023
 20715                                  ;typefil_parse_error:		;AN000; no - set up error message and exit
 20716                                  	;jmp	cerror
 20717 00001E55 750D                    	jnz	short typefil_parse_error
 20718                                  gottarg:
 20719 00001E57 E8C510                  	call	SETPATH
 20720 00001E5A F606[BD9D]02            	test	byte [DestInfo],00000010b ; 2
 20721                                  				; Does the filespec contain wildcards
 20722 00001E5F 7406                    	jz	short nowilds 	; No, continue processing
 20723 00001E61 BA[0990]                	mov	dx,INORNOT_PTR	; Yes, report error
 20724                                  	; 20/02/2023
 20725                                  typefil_parse_error:
 20726 00001E64 E9BF0E                  	jmp	cerror
 20727                                  nowilds:
 20728                                  	;mov	ax,ExtOpen SHL 8 ;AC000; open the file
 20729 00001E67 B8006C                  	mov	ax,6C00h
 20730                                  	;mov	bx,read_open_mode ; 0
 20731                                  				;AN000; get open mode for TYPE
 20732 00001E6A 31C9                    	xor	cx,cx		;AN000; no special files
 20733 00001E6C 89CB                    	mov	bx,cx ; 20/02/2023
 20734 00001E6E BA0101                  	mov	dx,101h
 20735                                  	;mov	dx,read_open_flag ; 101h
 20736                                  				;AN000; set up open flags
 20737 00001E71 BE[219E]                	mov	si,SrcBuf	;AN030; get file name
 20738                                  	;int	21h
 20739                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20740 00001E74 E843E7                  	call	int_21h_indirect
 20741 00001E77 7313                    	jnc	short typecont	; If open worked, continue. Otherwise load
 20742                                  
 20743                                  typerr: 			;AN022;
 20744 00001E79 0E                      	push	cs		;AN022; make sure we have local segment
 20745 00001E7A 1F                      	pop	ds		;AN022;
 20746 00001E7B E8BD01                  	call	Set_Ext_Error_Msg ;AN022;
 20747 00001E7E C706[A09D][219E]        	mov	word [string_ptr_2],SrcBuf 
 20748                                  				;AC022; get address of failed string
 20749                                  	;mov	byte [extend_buf_sub],1
 20750 00001E84 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst
 20751                                  				;AC022; put number of subst in control block
 20752 00001E89 E99A0E                  	jmp	cerror		;AC022; exit
 20753                                  
 20754                                  typecont:
 20755 00001E8C 89C3                    	mov	bx,ax		;AC000; get Handle
 20756                                  ;M043
 20757                                  ; We should do the LSEEK for filesize only if this handle belongs to a file
 20758                                  ;and not if it belongs to a device. If device, set TypeFilSiz+2 to -1 to
 20759                                  ;indicate it is a device.
 20760                                  ;
 20761                                  	;mov	ax,(IOCTL shl 8) or 0
 20762 00001E8E B80044                  	mov	ax,4400h
 20763                                  	;int	21h
 20764                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20765 00001E91 E826E7                  	call	int_21h_indirect
 20766                                  
 20767 00001E94 F6C280                  	test	dl,80h		;is it a device?
 20768 00001E97 7408                    	jz	short not_device
 20769                                  				;no, a file
 20770                                  
 20771                                  	;mov	word [TypeFilSiz+2],-1 ; 0FFFFh
 20772                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20773 00001E99 C706[9E9D]FFFF          	mov	word [File_Size_High],-1 ; 0FFFFh
 20774                                  				;indicate it is a device
 20775 00001E9F EB19                    	jmp	short dotype
 20776                                  not_device:
 20777                                  ;SR;
 20778                                  ; Find the filesize by seeking to the end and then reset file pointer to
 20779                                  ;start of file
 20780                                  
 20781                                  	;mov	ax,(LSEEK shl 8) or 2
 20782 00001EA1 B80242                  	mov	ax,4202h
 20783 00001EA4 31D2                    	xor	dx,dx
 20784 00001EA6 89D1                    	mov	cx,dx		;seek  to end of file
 20785                                  	;int	21h
 20786                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20787 00001EA8 E80FE7                  	call	int_21h_indirect
 20788                                  
 20789                                  	;mov	[TypeFilSiz],ax
 20790                                  	;mov	[TypeFilSiz+2],dx ;store filesize
 20791                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20792 00001EAB A3[9C9D]                	mov	[File_Size_Low],ax
 20793 00001EAE 8916[9E9D]              	mov	[File_Size_High],dx
 20794                                  
 20795                                  	;mov	ax,(LSEEK shl 8) or 0
 20796 00001EB2 B80042                  	mov	ax,4200h
 20797 00001EB5 31D2                    	xor	dx,dx
 20798                                  	;int	21h	        ;reset file pointer to start
 20799                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20800 00001EB7 E800E7                  	call	int_21h_indirect
 20801                                  dotype:				;M043
 20802 00001EBA C606[E59E]00            	mov	byte [zflag],0 	; Reset ^Z flag
 20803 00001EBF 8E1E[F79B]              	mov	ds,[TPA]
 20804 00001EC3 31D2                    	xor	dx,dx
 20805                                  	;ASSUME	DS:NOTHING
 20806                                  typelp:
 20807 00001EC5 2E803E[E59E]00          	cmp	byte [cs:zflag],0
 20808                                  				;AC050; Is the ^Z flag set?
 20809                                  	;retnz			; Yes, return
 20810                                  	; 17/04/2023
 20811 00001ECB 7401                    	jz	short tf1
 20812 00001ECD C3                      	retn
 20813                                  tf1:
 20814 00001ECE 2E8B0E[159C]            	mov	cx,[cs:BYTCNT]	;AC056; No, continue
 20815                                  
 20816                                  ;Update the filesize left to read
 20817                                  
 20818                                  	;cmp	word [cs:TypeFilSiz+2],-1
 20819                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20820 00001ED3 2E833E[9E9D]FF          	cmp	word [cs:File_Size_High],-1 ; 0FFFFh
 20821                                  				;is it a device? M043
 20822 00001ED9 7431                    	je	short typ_read	;yes, just read from it; M043
 20823                                  
 20824                                  	;cmp	word [cs:TypeFilSiz+2],0
 20825                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20826 00001EDB 2E833E[9E9D]00          	cmp	word [cs:File_Size_High],0
 20827                                  				;more than 64K left?
 20828 00001EE1 740D                    	jz	short lt64k	;no, do word subtraction
 20829                                  	;sub	[cs:TypeFilSiz],cx
 20830                                  	;sbb	word [cs:TypeFilSiz+2],0
 20831                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20832 00001EE3 2E290E[9C9D]            	sub	[cs:File_Size_Low],cx
 20833 00001EE8 2E831E[9E9D]00          	sbb	word [cs:File_Size_High],0
 20834                                  				;update filesize
 20835 00001EEE EB1C                          	jmp	short typ_read	;do the read
 20836                                  lt64k:
 20837                                  	;cmp	cx,[cs:TypeFilSiz]
 20838                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20839 00001EF0 2E3B0E[9C9D]            	cmp	cx,[cs:File_Size_Low]
 20840                                  				;readsize <= buffer?
 20841 00001EF5 7610                    	jbe	short gtbuf	; yes, just update readsize
 20842                                  
 20843                                  ;Buffer size is larger than bytes to read
 20844                                  
 20845                                  	;mov	cx,[cs:TypeFilSiz]
 20846                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20847 00001EF7 2E8B0E[9C9D]            	mov	cx,[cs:File_Size_Low]
 20848 00001EFC E364                    	jcxz	typelp_ret
 20849                                  	;mov	word [cs:TypeFilSiz],0
 20850                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20851 00001EFE 2EC706[9C9D]0000        	mov	word [cs:File_Size_Low],0
 20852 00001F05 EB05                    	jmp	short typ_read
 20853                                  gtbuf:
 20854                                  	;sub	[cs:TypeFilSiz],cx
 20855                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20856 00001F07 2E290E[9C9D]            	sub	 [cs:File_Size_Low],cx
 20857                                  				;update filesize remaining
 20858                                  typ_read:
 20859                                  	;mov	ah,read
 20860 00001F0C B43F                    	mov	ah,3Fh
 20861                                  	;int	21h
 20862                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20863 00001F0E E8A9E6                  	call	int_21h_indirect
 20864 00001F11 7303                    	jnc	short tf2	;M043
 20865 00001F13 E963FF                  	jmp	typerr		;M043
 20866                                  tf2:				;M043
 20867                                  ;M043;	jc	typerr		;AN022; Exit if error
 20868                                  
 20869 00001F16 89C1                    	mov	cx,ax
 20870 00001F18 E348                    	jcxz	typelp_ret	;AC000; exit if nothing read
 20871 00001F1A 1E                      	push	ds
 20872 00001F1B 07                      	pop	es		; Check to see if a ^Z was read.
 20873                                  	;assume es:nothing
 20874 00001F1C 31FF                    	xor	di,di
 20875 00001F1E 50                      	push	ax
 20876 00001F1F B01A                    	mov	al,1Ah
 20877 00001F21 F2AE                    	repnz	scasb
 20878 00001F23 58                      	pop	ax
 20879 00001F24 91                      	xchg	ax,cx
 20880                                  	;cmp	ax,0
 20881 00001F25 21C0                    	and	ax,ax
 20882 00001F27 7506                    	jnz	short foundz	; Yes, handle it
 20883 00001F29 807DFF1A                	cmp	byte [di-1],1Ah	; No, double check
 20884 00001F2D 750A                    	jnz	short typecont2	; No ^Z, continue
 20885                                  foundz:
 20886 00001F2F 29C1                    	sub	cx,ax		; Otherwise change cx so that only those
 20887 00001F31 49                      	dec	cx		;  bytes up to but NOT including the ^Z
 20888 00001F32 0E                      	push	cs		;  will be typed.
 20889 00001F33 07                      	pop	es
 20890                                  	;assume es:trangroup
 20891 00001F34 26F616[E59E]            	not	byte [es:zflag]	; Turn on ^Z flag so that the routine
 20892                                  typecont2:			;  will quit after this write.
 20893 00001F39 53                      	push	bx
 20894 00001F3A BB0100                  	mov	bx,1
 20895                                  	;mov	ah,Write
 20896 00001F3D B440                    	mov	ah,40h
 20897                                  	;int	21h
 20898                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20899 00001F3F E878E6                  	call	int_21h_indirect
 20900 00001F42 5B                      	pop	bx
 20901 00001F43 720C                    	jc	short Error_outputj
 20902 00001F45 39C8                    	cmp	ax,cx
 20903 00001F47 7503                    	jnz	short tf3	;M043
 20904 00001F49 E979FF                  	jmp	typelp		;M043
 20905                                  tf3:				;M043
 20906                                  ;M043;	jz	short typelp
 20907 00001F4C 49                      	dec	cx
 20908 00001F4D 39C8                    	cmp	ax,cx
 20909                                  	;;retz			; One less byte OK (^Z)
 20910                                  	;jnz	short Error_outputj
 20911                                  ;tf4:
 20912                                  	;retn
 20913 00001F4F 7411                    	jz	short typelp_ret ; 20/02/2023
 20914                                  
 20915                                  Error_outputj:
 20916 00001F51 BB0100                  	mov	bx,1
 20917                                  	;mov	ax,IOCTL SHL 8
 20918 00001F54 B80044                  	mov	ax,4400h
 20919                                  	;int	21h
 20920                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20921 00001F57 E860E6                  	call	int_21h_indirect
 20922 00001F5A F6C280                  	test	dl,80h
 20923                                  	;test	dl,devid_ISDEV
 20924                                  	;;retnz			; If device, no error message
 20925                                  	;jnz	short tf4
 20926 00001F5D 7503                    	jnz	short typelp_ret
 20927 00001F5F E9980A                  	jmp	error_output
 20928                                  typelp_ret:
 20929 00001F62 C3                      	retn
 20930                                  
 20931                                  ; ---------------------------------------------------------------------------
 20932                                  
 20933                                  ; VOLUME command displays the volume ID on the specified drive
 20934                                  
 20935                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20936                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20937                                  	; 10/06/2023
 20938                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20939                                  VOLUME:
 20940                                  	; MSDOS 6.0
 20941 00001F63 BE8100                  	mov	si,81h
 20942 00001F66 BF[7696]                	mov	di,PARSE_VOL
 20943                                  				;AN000; Get address of PARSE_VOL
 20944 00001F69 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20945 00001F6B 31D2                    	xor	dx,dx		;AN000;
 20946 00001F6D E8EB05                  	call	Parse_With_Msg	;AC018; call parser
 20947                                  
 20948                                  	;cmp	ax,-1 ; 0FFFFh
 20949                                  	;;cmp	ax,END_OF_LINE	;AC000; are we at end of line?
 20950                                  	;je	short OkVolArg	;AC000; Yes, display default volume ID
 20951                                  	;;cmp	ax,RESULT_NO_ERROR
 20952                                  	;;cmp	ax,0		;AC000; did we have an error?
 20953                                  	;or	ax,ax ; 0?
 20954                                  	;jnz	short badvolarg	;AC000; Yes, fail.
 20955                                  	; 10/06/2023
 20956 00001F70 40                      	inc	ax  ; cmp ax,-1
 20957 00001F71 7447                    	jz	short OkVolArg ; 0FFFFh -> 0
 20958 00001F73 48                      	dec	ax  ; cmp ax,0
 20959 00001F74 750A                    	jnz	short badvolarg ; 1 -> 0
 20960                                  	; ax = 0
 20961                                  
 20962                                  ; We have parsed off the drive. See if there are any more chars left
 20963                                  
 20964 00001F76 BF[7696]                	mov	di,PARSE_VOL
 20965                                  				;AC000; get address of parse_vol
 20966 00001F79 31D2                    	xor	dx,dx		;AC000;
 20967 00001F7B E8C705                  	call	parse_check_eol ;AC000; call parser
 20968 00001F7E 743A                    	jz	short OkVolArg	;AC000; yes, end of road
 20969                                  
 20970                                  ; The line was not interpretable. Report an error.
 20971                                  
 20972                                  badvolarg:
 20973 00001F80 E9A30D                  	jmp	cerror
 20974                                  
 20975                                  ; ---------------------------------------------------------------------------
 20976                                  
 20977                                  ;***	DisAppend - disable APPEND
 20978                                  ;
 20979                                  ;	ENTRY	nothing
 20980                                  ;
 20981                                  ;	EXIT	nothing
 20982                                  ;
 20983                                  ;	USED	AX,BX
 20984                                  ;
 20985                                  ;	EFFECTS
 20986                                  ;
 20987                                  ;	  APPEND is disabled. If it was active, it will be re-enabled
 20988                                  ;	  after the command finishes, by the HeadFix routine.
 20989                                  ;
 20990                                  ;	NOTE
 20991                                  ;
 20992                                  ;	  This routine must not be called more than once during a single
 20993                                  ;	  command cycle. The second call would permanently disable APPEND.
 20994                                  
 20995                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20996                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1CDFh
 20997                                  	
 20998                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20999                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2289h
 21000                                  
 21001                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21002                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2069h
 21003                                  
 21004                                  	; MSDOS 6.0
 21005                                  DisAppend:
 21006 00001F83 1E                      	push	ds			; save DS
 21007 00001F84 06                      	push	es			; save ES
 21008 00001F85 57                      	push	di
 21009                                  
 21010                                  	;mov	ax,APPENDINSTALL	; AX = Append Installed Check code
 21011 00001F86 B800B7                  	mov	ax,0B700h
 21012                                  	;int	2Fh			; talk to APPEND via multiplex
 21013                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21014 00001F89 E854E6                  	call	int_2Fh_indirect
 21015 00001F8C 08C0                    	or	al,al
 21016 00001F8E 7426                    	jz	short daRet		; APPEND not installed, return
 21017                                  
 21018                                  	;mov	ax,APPENDDOS		; AX = Get Append Version code
 21019 00001F90 B802B7                  	mov	ax,0B702h
 21020                                  	;int	2Fh			; talk to APPEND via multiplex
 21021                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21022 00001F93 E84AE6                  	call	int_2Fh_indirect
 21023 00001F96 83F8FF                  	cmp	ax,0FFFFh
 21024 00001F99 751B                    	jne	short daRet		; it's not a local version, return
 21025                                  
 21026                                  	;mov	ax,APPENDGETSTATE	; AX = Get Function State code
 21027 00001F9B B806B7                  	mov	ax,0B706h
 21028                                  	;int	2Fh			; talk to APPEND via multiplex
 21029                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21030 00001F9E E83FE6                  	call	int_2Fh_indirect
 21031                                  
 21032 00001FA1 8E1E[F59B]              	mov	ds,[RESSEG]		; DS = resident seg addr
 21033                                  
 21034 00001FA5 891E[BE02]              	mov	[Append_State],bx	; Append_State = saved APPEND state
 21035 00001FA9 C606[C002]FF            	mov	byte [Append_Flag],-1	; Append_Flag = true, restore state
 21036                                  
 21037 00001FAE 31DB                    	xor	bx,bx			; BX = APPEND state = off
 21038                                  	;mov	ax,APPENDSETSTATE	; AX = Set Append State code
 21039 00001FB0 B807B7                  	mov	ax,0B707h
 21040                                  	;int	2Fh			; talk to APPEND via multiplex
 21041                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21042 00001FB3 E82AE6                  	call	int_2Fh_indirect
 21043                                  daRet:	
 21044 00001FB6 5F                      	pop	di
 21045 00001FB7 07                      	pop	es			; restore ES
 21046 00001FB8 1F                      	pop	ds			; restore DS
 21047                                  
 21048 00001FB9 C3                      	retn
 21049                                  
 21050                                  ; ---------------------------------------------------------------------------
 21051                                  
 21052                                  ; Find the Volume ID on the disk.
 21053                                  
 21054                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21055                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21056                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21057                                  	
 21058                                  	; MSDOS 6.0
 21059                                  OkVolArg:
 21060 00001FBA E8C6FF                  	call	DisAppend		; disable APPEND
 21061 00001FBD E8B909                  	call	CRLF2
 21062                                  	;mov	al,blank			
 21063 00001FC0 B020                    	mov	al,' ' ; 20h		;AN051; Print out a blank
 21064 00001FC2 E8E901                  	call	PRINT_CHAR		;AN051;  before volume message
 21065 00001FC5 1E                      	push	ds
 21066 00001FC6 07                      	pop	es
 21067                                  
 21068                                  ; Volume IDs are only findable via extended FCBs or find_first with attributes
 21069                                  ; of volume_id ONLY.
 21070                                  
 21071 00001FC7 BF5500                  	mov	di,FCB-7 ; 55h		; Point to extended FCB beginning
 21072 00001FCA B0FF                    	mov	al,-1 ; 0FFh		; Tag to indicate Extention
 21073 00001FCC AA                      	stosb
 21074 00001FCD 31C0                    	xor	ax,ax			; Zero padding to volume label
 21075 00001FCF AB                      	stosw
 21076 00001FD0 AB                      	stosw
 21077 00001FD1 AA                      	stosb
 21078 00001FD2 B008                    	mov	al,ATTR_VOLUME_ID ; 8	; Look for volume label
 21079 00001FD4 AA                      	stosb
 21080 00001FD5 47                      	inc	di			; Skip drive byte; it is already set
 21081 00001FD6 B90B00                  	mov	cx,11			; fill in remainder of file
 21082 00001FD9 B03F                    	mov	al,'?'
 21083 00001FDB F3AA                    	rep	stosb
 21084                                  
 21085                                  ; Set up transfer address (destination of search first information)
 21086                                  
 21087 00001FDD BA[399D]                	mov	dx,DIRBUF
 21088                                  	;mov	ah,Set_DMA
 21089 00001FE0 B41A                    	mov	ah,1Ah
 21090                                  	;int	21h
 21091                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21092 00001FE2 E8D5E5                  	call	int_21h_indirect
 21093                                  
 21094                                  ; Do the search
 21095                                  
 21096 00001FE5 BA5500                  	mov	dx,FCB-7 ; 55h
 21097                                  	;mov	ah,Dir_Search_First
 21098 00001FE8 B411                    	mov	ah,11h
 21099                                  	;int	21h
 21100                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21101 00001FEA E8CDE5                  	call	int_21h_indirect
 21102                                  
 21103                                  
 21104                                  ;********************************
 21105                                  ; Print volume ID info
 21106                                  
 21107 00001FED 50                      	push	ax			;AC000; AX return from SEARCH_FIRST for VOL ID
 21108 00001FEE A05C00                  	mov	al,[FCB]  ; [5Ch]	;AC000; get drive letter
 21109 00001FF1 0440                    	add	al,'@'  ; add al,40h
 21110 00001FF3 3C40                    	cmp	al,'@'
 21111 00001FF5 7505                    	jne	short drvok
 21112 00001FF7 A0[079C]                	mov	al,[CURDRV]
 21113                                  	;add	al,capital_A
 21114 00001FFA 0441                    	add	al,'A'
 21115                                  drvok:
 21116 00001FFC A2[B39D]                	mov	[vol_drv],al		;AC000; get drive letter into argument
 21117 00001FFF 58                      	pop	ax			;AC000; get return code back
 21118 00002000 08C0                    	or	al,al			;AC000; volume label found?
 21119 00002002 7405                    	jz	short Get_vol_name	;AC000; volume label exists - go get it
 21120 00002004 BA[F790]                	mov	dx,VolMes_Ptr_2		;AC000; set up no volume message
 21121 00002007 EB13                    	jmp	short print_serial	;AC000; go print it
 21122                                  
 21123                                  Get_vol_name:
 21124 00002009 BF[6A9C]                	mov	di,CHARBUF
 21125 0000200C 89FA                    	mov	dx,di
 21126 0000200E BE[419D]                	mov	si,DIRBUF+8		;AN000;  3/3/KK
 21127 00002011 B90B00                  	mov	cx,11			;AN000;  3/3/KK
 21128 00002014 F3A4                    	rep	movsb			;AN000;  3/3/KK
 21129                                  
 21130 00002016 30C0                    	xor	al,al			;AC000; store a zero to terminate the string
 21131 00002018 AA                      	stosb
 21132 00002019 BA[0591]                	mov	dx,VolMes_Ptr		;AC000; set up message
 21133                                  
 21134                                  print_serial:
 21135                                  
 21136                                  ; Attempt to get the volume serial number from the disk. If an error
 21137                                  ; occurs, do not print volume serial number.
 21138                                  
 21139 0000201C 52                      	push	dx			;AN000; save message offset
 21140                                  	;mov	ax,(GetSetMediaID SHL 8)
 21141 0000201D B80069                  	mov	ax,6900h		;AC036; Get the volume serial info
 21142 00002020 8A1E5C00                	mov	bl,[FCB] ; [5Ch]	;AN000; get drive number from FCB
 21143 00002024 BA[199F]                	mov	dx,vol_ioctl_buf	;AN000; target buffer
 21144                                  	;int	21h			;AN000; do the call
 21145                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21146 00002027 E890E5                  	call	int_21h_indirect
 21147                                  			; DOS - 4.0 internal - GET/SET DISK SERIAL NUMBER
 21148                                  			; AL = 00h get serial number / 01h set serial number
 21149                                  			; BL = drive (0=default, 1=A, 2=B, etc)
 21150                                  			; DS:DX -> disk info
 21151 0000202A 5A                      	pop	dx			;AN000; get message offset back
 21152 0000202B 720B                    	jc	short printvol_end	;AN000; if error, just go print label
 21153 0000202D E8F833                  	call	std_printf		;AC000; go print volume message
 21154                                  	;mov	al,blank				
 21155 00002030 B020                    	mov	al,' ' ; 20h		;AN051; Print out a blank
 21156 00002032 E87901                  	call	PRINT_CHAR		;AN051;  before volume message
 21157 00002035 BA[1E91]                	mov	dx,VolSerMes_Ptr 	;AN000; get serial number message
 21158                                  printvol_end:
 21159 00002038 E9ED33                  	jmp	std_printf		;AC000; go print and exit
 21160                                  
 21161                                  ; ---------------------------------------------------------------------------
 21162                                  
 21163                                  ;****************************************************************
 21164                                  ;*
 21165                                  ;* ROUTINE:	Set_ext_error_msg
 21166                                  ;*
 21167                                  ;* FUNCTION:	Sets up extended error message for printing
 21168                                  ;*
 21169                                  ;* INPUT:	return from INT 21
 21170                                  ;*
 21171                                  ;* OUTPUT:	extended error message set up in extended error
 21172                                  ;*		buffer.
 21173                                  ;*
 21174                                  ;****************************************************************
 21175                                  	
 21176                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21177                                  
 21178                                  	; MSDOS 6.0
 21179                                  Set_Ext_Error_Msg:			;AN000;
 21180 0000203B E80D00                  	call	get_ext_error_number	;AC022; get the extended error
 21181 0000203E C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class
 21182                                  	;mov	byte [msg_disp_class],1	;AN000; set up extended error msg class
 21183 00002043 BA[D78F]                	mov	dx,extend_buf_ptr 	;AC000; get extended message pointer
 21184 00002046 A3[D78F]                	mov	[extend_buf_ptr],ax	;AN000; get message number in control block
 21185 00002049 F9                      	stc				;AN000; make sure carry is set
 21186 0000204A C3                      	retn				;AN000; return
 21187                                  
 21188                                  ; ---------------------------------------------------------------------------
 21189                                  
 21190                                  ;****************************************************************
 21191                                  ;*
 21192                                  ;* ROUTINE:	Get_ext_error_number
 21193                                  ;*
 21194                                  ;* FUNCTION:	Does get extended error function call
 21195                                  ;*
 21196                                  ;* INPUT:	return from INT 21
 21197                                  ;*
 21198                                  ;* OUTPUT:	AX - extended error number
 21199                                  ;*
 21200                                  ;****************************************************************
 21201                                  
 21202                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21203                                  
 21204                                  	; MSDOS 6.0
 21205                                  get_ext_error_number:			;AN022;
 21206                                  
 21207                                  	;SaveReg <BX,CX,DX,SI,DI,BP,ES,DS>
 21208                                  					;AN022; save registers
 21209 0000204B 53                      	push	bx
 21210 0000204C 51                      	push	cx
 21211 0000204D 52                      	push	dx
 21212 0000204E 56                      	push	si
 21213 0000204F 57                      	push	di
 21214 00002050 55                      	push	bp
 21215 00002051 06                      	push	es
 21216 00002052 1E                      	push	ds
 21217                                  	;mov	ah,GetExtendedError	;AN022; get extended error
 21218 00002053 B459                    	mov	ah,59h
 21219 00002055 31DB                    	xor	bx,bx			;AN022; clear BX
 21220 00002057 CD21                    	int	21h			;AN022;
 21221                                  			; DOS - 3+ - GET EXTENDED ERROR CODE
 21222                                  			; BX = version code (0000h for DOS 3.x)
 21223                                  
 21224                                  	;RestoreReg  <DS,ES,BP,DI,SI,DX,CX,BX>
 21225                                  					;AN022; restore registers
 21226 00002059 1F                      	pop	ds
 21227 0000205A 07                      	pop	es
 21228 0000205B 5D                      	pop	bp
 21229 0000205C 5F                      	pop	di
 21230 0000205D 5E                      	pop	si
 21231 0000205E 5A                      	pop	dx
 21232 0000205F 59                      	pop	cx
 21233 00002060 5B                      	pop	bx
 21234                                  
 21235 00002061 C3                      	retn				;AN022; return
 21236                                  
 21237                                  ;============================================================================
 21238                                  ; TCMD2A.ASM, MSDOS 6.0, 1991
 21239                                  ;============================================================================
 21240                                  ; 08/10/2018 - Retro DOS v3.0
 21241                                  
 21242                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1379h
 21243                                  
 21244                                  ; 21/02/2023 - Retro DOS v4.0 (& v4.1)
 21245                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 1DB7h
 21246                                  
 21247                                  ; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21248                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 2361h
 21249                                  
 21250                                  ; ---------------------------------------------------------------------------
 21251                                  
 21252                                  ; MSDOS 6.0
 21253                                  ;***	Version - display DOS version
 21254                                  ;
 21255                                  ;	SYNTAX	ver [/debug]
 21256                                  ;
 21257                                  ;		/debug - display additional DOS configuration info
 21258                                  ;
 21259                                  ;	ENTRY	command-line tail is in PSP
 21260                                  ;
 21261                                  ;	EXIT	if successful, nothing
 21262                                  ;		if parse fails,
 21263                                  ;		  parse error message is set up (for Std_EPrintf)
 21264                                  ;		    AX = system parser error code
 21265                                  ;		    DX = ptr to message block
 21266                                  ;		  we jump to CError
 21267                                  ;
 21268                                  ;	EFFECTS
 21269                                  ;	  If parse fails, a parse error message is displayed.
 21270                                  ;	  Otherwise, version message is displayed.
 21271                                  ;	  If /debug is specified, additional DOS info is displayed.
 21272                                  
 21273                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21274                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21275                                  	; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 21276                                  VERSION:
 21277                                  	;assume	ds:TRANGROUP,es:TRANGROUP
 21278                                  
 21279                                  ;	Parse command line for /debug switch.
 21280                                  
 21281 00002062 BE8100                  	mov	si,81h			; DS:SI = ptr to command tail
 21282 00002065 BF[4497]                	mov	di,PARSE_VER		; ES:DI = ptr to parse block
 21283 00002068 31C9                    	xor	cx,cx			; CX = # positional param's found
 21284 0000206A E8EE04                  	call	Parse_With_Msg
 21285                                  
 21286 0000206D B301                    	mov	bl,1			; BL = flag = /debug present
 21287                                  	;cmp	ax,RESULT_NO_ERROR
 21288                                  	;cmp	ax,0
 21289                                  	;je	short verPrintVer	; something parsed - must be /debug
 21290 0000206F 09C0                    	or	ax,ax
 21291 00002071 740A                    	jz	short verPrintVer 
 21292 00002073 FECB                    	dec	bl			; BL = flag = no /debug present
 21293                                  	;cmp	ax,END_OF_LINE ; -1
 21294 00002075 83F8FF                  	cmp	ax,-1 ; 0FFFFh
 21295                                  
 21296                                  ; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 21297                                  %if 0
 21298                                  	je	short verPrintVer	; reached end of line - ok
 21299                                  %else
 21300 00002078 7414                    	je	short not_truever_sw
 21301                                  %endif
 21302                                  
 21303                                  ;	The parse failed. Error message has been set up.
 21304                                  
 21305 0000207A E9A90C                  	jmp	cerror
 21306                                  
 21307                                  verPrintVer:
 21308                                  
 21309                                  ; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 21310                                  %if 1
 21311                                  check_t_switch:
 21312 0000207D 813E[EDA5][6497]        	cmp	word [PARSE1_SYN],SLASH_T_SYN ; "/T" ; /t switch
 21313 00002083 7509                    	jne	short not_truever_sw
 21314 00002085 BA[8797]                	mov	dx,RD5CMD_VER_MSG
 21315 00002088 B409                    	mov	ah,STD_CON_STRING_OUTPUT ; 9 ; print the message
 21316 0000208A CD21                    	int	21h
 21317 0000208C EB47                    	jmp	short verDone
 21318                                  not_truever_sw:
 21319                                  %endif
 21320 0000208E 53                      	push	bx			; save /debug flag
 21321 0000208F E8E708                  	call	CRLF2
 21322 00002092 E84300                  	call	PRINT_VERSION
 21323 00002095 E8E108                  	call	CRLF2
 21324 00002098 5B                      	pop	bx   			; BL = /debug flag
 21325 00002099 08DB                    	or	bl,bl
 21326 0000209B 7438                    	jz	short verDone		; /debug is false - we're done
 21327                                  
 21328                                  ;*	For /debug, display DOS internal revision and DOS location
 21329                                  ;	(low memory, HMA, or ROM).
 21330                                  
 21331                                  ;	Bugbug:	use symbols for bitmasks below.
 21332                                  
 21333                                  	;mov	ax,(Set_CTRL_C_Trapping shl 8) + 6 ; M013
 21334 0000209D B80633                  	mov	ax,3306h
 21335 000020A0 CD21                    	int	21h
 21336                                  		; DOS - 5+ Get TRUE Version Number
 21337                                  		; (BL major, BH minor, DL revision, DH flags)
 21338 000020A2 88D0                    	mov	al,dl			;revision number in dl; M013
 21339 000020A4 88F7                    	mov	bh,dh			;flags in dh now; M013
 21340                                  ;M032	and	al,7			; AL = DOS internal revision
 21341 000020A6 3C19                    	cmp	al,'Z'-'A' ; 25	 ;M032	; revision in A-to-Z range?
 21342                                  	;jbe	short @f	 ;M032	; A-to-Z revision ok
 21343 000020A8 7602                    	jbe	short ver1
 21344                                  	;mov	al,0E9h
 21345 000020AA B0E9                    	mov	al,'*'-'A' ; -23 ;M032	; beyond Z, just say revision *
 21346                                  ;@@:
 21347                                  ver1:
 21348                                  
 21349                                  ; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21350                                  %if 0
 21351                                  	add	al,'A' ; 41h		; AL = DOS internal rev letter
 21352                                  %else
 21353                                  	; PCDOS 7.1 COMMAND.COM
 21354 000020AC 0430                    	add	al,'0'  ; 30h
 21355                                  %endif
 21356                                  
 21357 000020AE A2[B19D]                	mov	[One_Char_Val],al
 21358 000020B1 BA[A992]                	mov	dx,dosrev_ptr		; MSG_1090
 21359 000020B4 E87133                  	call	std_printf		; print DOS internal revision
 21360                                  
 21361                                  ; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21362                                  %if 1
 21363 000020B7 08D2                    	or	dl,dl
 21364 000020B9 741A                    	jz	short verDone		; Revision 0
 21365                                  %endif
 21366                                  
 21367 000020BB B104                    	mov	cl,4
 21368 000020BD D2EF                    	shr	bh,cl			; CY = DOS in ROM
 21369 000020BF 7209                    	jc	short verRom
 21370 000020C1 D0EF                    	shr	bh,1			; CY = DOS in HMA
 21371 000020C3 720A                    	jc	short verHma
 21372                                  
 21373                                  ;	DOS isn't in ROM or HMA, so it must be in lower memory.
 21374                                  
 21375                                  	;mov	dx,offset TRANGROUP:DosLow_Ptr
 21376 000020C5 BA[BD92]                	mov	dx,DosLow_Ptr		; MSG_1093
 21377 000020C8 EB08                    	jmp	short verPrintLoc
 21378                                  verRom: 
 21379                                  	;mov	dx,offset TRANGROUP:DosRom_Ptr
 21380 000020CA BA[B792]                	mov	dx,DosRom_Ptr		; MSG_1091
 21381 000020CD EB03                    	jmp	short verPrintLoc
 21382                                  verHma: 
 21383                                  	;mov	dx,offset TRANGROUP:DosHma_Ptr
 21384 000020CF BA[BA92]                	mov	dx,DosHma_Ptr		; MSG_1092
 21385                                  verPrintLoc:
 21386 000020D2 E85333                  	call	std_printf
 21387                                  verDone:
 21388 000020D5 E9A108                  	jmp	CRLF2
 21389                                  
 21390                                  ; 21/02/2023
 21391                                  ;	; MSDOS 3.3
 21392                                  ;VERSION:
 21393                                  ;	call	CRLF2
 21394                                  ;	call	PRINT_VERSION
 21395                                  ;	jmp	CRLF2
 21396                                  
 21397                                  ; =============== S U B	R O U T	I N E =======================================
 21398                                  
 21399                                  	; 21/02/2023 - Retro DOS v4.0
 21400                                  PRINT_VERSION:
 21401                                  	;mov	ah,GET_VERSION ; 30h
 21402 000020D8 B430                    	mov	ah,30h
 21403 000020DA CD21                    	int	21h	; DOS -	GET DOS	VERSION
 21404                                  			; Return: AL = major version number (00h for DOS 1.x)
 21405 000020DC 50                      	push	ax
 21406 000020DD 30E4                    	xor	ah,ah
 21407 000020DF A3[AD9D]                	mov	[Major_Ver_Num],ax
 21408 000020E2 58                      	pop	ax
 21409 000020E3 86C4                    	xchg	ah,al
 21410 000020E5 30E4                    	xor	ah,ah
 21411 000020E7 A3[AF9D]                	mov	[Minor_Ver_Num],ax
 21412 000020EA BA[F490]                	mov	dx,VerMes_Ptr	; MSG_1040
 21413 000020ED E93833                  	jmp	std_printf
 21414                                  
 21415                                  ; =============== S U B	R O U T	I N E =======================================
 21416                                  
 21417                                  	; 21/02/2023 - Retro DOS v4.0
 21418                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21419                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21420                                  
 21421                                  PRINT_PROMPT:
 21422                                  
 21423                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21424                                  %if 0
 21425                                  	push	ds
 21426                                  	push	cs
 21427                                  	pop	ds		; Make sure DS is in TRANGROUP
 21428                                  	push	es
 21429                                  	call	find_prompt	; Look for prompt string
 21430                                  	jc	short PP0	; Can't find one
 21431                                  	cmp	byte [es:di],0
 21432                                  	jnz	short PP1
 21433                                  PP0:				; Use default prompt
 21434                                  	call	PRINT_DRIVE
 21435                                  	mov	al,'>'
 21436                                  	;mov	al,SYM
 21437                                  	call	PRINT_CHAR
 21438                                  	jmp	short PP5
 21439                                  ;PP1:
 21440                                  ;	mov	al,[es:di]	; Get a char
 21441                                  ;	inc	di
 21442                                  ;	or	al,al
 21443                                  ;	jz	short PP5	; Nul terminated
 21444                                  ;	; 21/02/2023
 21445                                  ;	cmp	al,'$' ; 24h
 21446                                  ;	;cmp	al,[DOLLAR]	; Meta character
 21447                                  ;	jz	short PP2	; Nope
 21448                                  ;	call	PRINT_CHAR
 21449                                  ;	jmp	short PP1
 21450                                  PP2:
 21451                                  	mov	al,[es:di]
 21452                                  	inc	di
 21453                                  	;mov	bx,CLSSTRING+2	; "[2J"
 21454                                  	mov	bx,PROMPT_TABLE-3
 21455                                  	or	al,al
 21456                                  	jz	short PP5
 21457                                  PP3:
 21458                                  	add	bx,3
 21459                                  	; 21/02/2023
 21460                                  	call	UPCONV		; MSDOS 5.0 (& 6.0)
 21461                                  	;call	UPCONV_MAPCALL  ; MSDOS 3.3
 21462                                  	cmp	al,[bx]
 21463                                  	jz	short PP4
 21464                                  	cmp	byte [bx],0
 21465                                  	jnz	short PP3
 21466                                  	;jmp	short PP1
 21467                                  	; 21/02/2023
 21468                                  PP1:
 21469                                  	mov	al,[es:di]	; Get a char
 21470                                  	inc	di
 21471                                  	or	al,al
 21472                                  	jz	short PP5	; Nul terminated
 21473                                  	; 21/02/2023
 21474                                  	cmp	al,'$' ; 24h
 21475                                  	;cmp	al,[DOLLAR]	; Meta character
 21476                                  	jz	short PP2	; Nope
 21477                                  	call	PRINT_CHAR
 21478                                  	jmp	short PP1
 21479                                  PP4:
 21480                                  	push	es
 21481                                  	push	di
 21482                                  	push	cs
 21483                                  	pop	es
 21484                                  	call	word [bx+1]
 21485                                  	pop	di
 21486                                  	pop	es
 21487                                  	jmp	short PP1
 21488                                  PP5:
 21489                                  	pop	es		; Restore segments
 21490                                  	pop	ds
 21491                                  	retn
 21492                                  %else
 21493                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21494                                  	; PCDOS 7.1 COMMAND.COM
 21495 000020F0 1E                      	push	ds
 21496 000020F1 0E                      	push	cs
 21497 000020F2 1F                      	pop	ds		; Make sure DS is in TRANGROUP
 21498 000020F3 06                      	push	es
 21499 000020F4 9C                      	pushf
 21500                                  PP0:
 21501 000020F5 B8104A                  	mov	ax,4A10h	; SMARTDRV INSTALLATION CHECK (*)
 21502 000020F8 BB0000                  	mov	bx,0		; (*)
 21503 000020FB CD2F                    	int	2Fh
 21504 000020FD 3DBEBA                  	cmp	ax,0BABEh	; 0BABEh if installed
 21505 00002100 7504                    	jnz	short PP1
 21506                                  	;cmp	cx,0		; number of dirty cache elements
 21507 00002102 21C9                    	and	cx,cx ; 03/08/2024
 21508 00002104 7516                    	jnz	short PP3
 21509                                  PP1:
 21510 00002106 9D                      	popf
 21511 00002107 E8AA05                  	call	find_prompt	; Look for prompt string
 21512 0000210A 7206                    	jc	short PP2	; Can't find one
 21513 0000210C 26803D00                	cmp	byte [es:di],0
 21514 00002110 752E                    	jnz	short PP4
 21515                                  PP2:				; Use default prompt
 21516 00002112 1E                      	push	ds
 21517 00002113 07                      	pop	es
 21518 00002114 E8AE00                  	call	build_dir_for_prompt
 21519 00002117 E88A00                  	call	PRINT_G
 21520 0000211A EB40                    	jmp	short PP8
 21521                                  PP3:
 21522 0000211C B8104A                  	mov	ax,4A10h	; SMARTDRV - FLUSH BUFFERS (**)
 21523 0000211F BB0100                  	mov	bx,1		; (**)
 21524 00002122 CD2F                    	int	2Fh
 21525 00002124 EBCF                    	jmp	short PP0
 21526                                  PP5:
 21527 00002126 268A05                  	mov	al,[es:di]
 21528 00002129 47                      	inc	di
 21529                                  	;mov	bx,CLSSTRING+2	; "[2J"
 21530 0000212A BB[0594]                	mov	bx,PROMPT_TABLE-3
 21531 0000212D 08C0                    	or	al,al
 21532 0000212F 742B                    	jz	short PP8
 21533                                  PP6:
 21534 00002131 83C303                  	add	bx,3
 21535 00002134 E85406                  	call	UPCONV
 21536 00002137 3A07                    	cmp	al,[bx]
 21537 00002139 7416                    	je	short PP7
 21538 0000213B 803F00                  	cmp	byte [bx],0
 21539 0000213E 75F1                    	jnz	short PP6
 21540                                  	;jmp	short PP4
 21541                                  PP4:
 21542 00002140 268A05                  	mov	al,[es:di]	; Get a char
 21543 00002143 47                      	inc	di
 21544 00002144 08C0                    	or	al,al
 21545                                  	; 13/03/2025 (BugFix)
 21546 00002146 7414                    	jz	short PP8	; Nul terminated
 21547 00002148 3C24                    	cmp	al,'$' ; 24h	; Meta character
 21548 0000214A 74DA                    	je	short PP5	; Nope
 21549 0000214C E85F00                  	call	PRINT_CHAR
 21550 0000214F EBEF                    	jmp	short PP4
 21551                                  PP7:
 21552 00002151 06                      	push	es
 21553 00002152 57                      	push	di
 21554 00002153 0E                      	push	cs
 21555 00002154 07                      	pop	es
 21556 00002155 FF5701                  	call	word [bx+1]
 21557 00002158 5F                      	pop	di
 21558 00002159 07                      	pop	es
 21559 0000215A EBE4                    	jmp	short PP4
 21560                                  PP8:
 21561 0000215C 07                      	pop	es		; Restore segments
 21562 0000215D 1F                      	pop	ds
 21563 0000215E C3                      	retn
 21564                                  
 21565                                  %endif
 21566                                  
 21567                                  ; ---------------------------------------------------------------------------
 21568                                  
 21569                                  PRINT_BACK:
 21570                                  	; 21/02/2023
 21571 0000215F BA[F791]                	mov	dx,dback_ptr
 21572 00002162 E9C332                  	jmp	std_printf
 21573                                  
 21574                                  ; ---------------------------------------------------------------------------
 21575                                  
 21576                                  PRINT_EQ:
 21577 00002165 B03D                    	mov	al,'='
 21578 00002167 EB45                    	jmp	short PRINT_CHAR
 21579                                  
 21580                                  ; ---------------------------------------------------------------------------
 21581                                  
 21582                                  ; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 21583                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:223Eh
 21584                                  %if 1
 21585                                  PRINT_R:	 ; Print [RetCode] as PROMPT
 21586 00002169 1E                      	push	ds
 21587 0000216A 8E1E[F59B]              	mov	ds,[RESSEG]
 21588 0000216E A0[9A02]                	mov	al,[RetCode]
 21589 00002171 1F                      	pop	ds
 21590 00002172 30E4                    	xor	ah,ah
 21591 00002174 B20A                    	mov	dl,10
 21592 00002176 BE[9C21]                	mov	si,RetCode_str ; "000"
 21593 00002179 F6F2                    	div	dl
 21594 0000217B 80C430                  	add	ah,30h	; '0'
 21595 0000217E 886402                  	mov	[si+2],ah
 21596 00002181 30E4                    	xor	ah,ah
 21597 00002183 F6F2                    	div	dl
 21598 00002185 053030                  	add	ax,3030h
 21599 00002188 8904                    	mov	[si],ax
 21600 0000218A 3C30                    	cmp	al,30h	; '0'
 21601 0000218C 7507                    	jnz	short Print_R_@
 21602 0000218E 46                      	inc	si
 21603 0000218F 80FC30                  	cmp	ah,30h	; '0'
 21604 00002192 7501                    	jnz	short Print_R_@
 21605 00002194 46                      	inc	si
 21606                                  Print_R_@:
 21607 00002195 8936[A09D]              	mov	[string_ptr_2],si
 21608 00002199 F8                      	clc
 21609 0000219A EB46                    	jmp	short Print_R_@@
 21610                                  
 21611                                  ; ---------------------------------------------------------------------------
 21612                                  RetCode_str:
 21613 0000219C 30303000                	db	'000',0
 21614                                  ; ---------------------------------------------------------------------------
 21615                                  ;; 'PROMPT $R' test for PCDOS 7.1 COMMAND.COM - Erdogan Tan - August 6, 2024
 21616                                  ;
 21617                                  ;	[org 100h]
 21618                                  ;	
 21619                                  ;	;mov	ah,09h
 21620                                  ;	;mov	dx,program_name
 21621                                  ;	;int	21h
 21622                                  ;	call	print_msg
 21623                                  ;
 21624                                  ;	mov	al,255  ; Return Code
 21625                                  ;	mov	ah,4Ch
 21626                                  ;	int	21h
 21627                                  ;hang:
 21628                                  ;	;sti
 21629                                  ;	jmp	short hang
 21630                                  ;
 21631                                  ;print_msg:
 21632                                  ;	mov	ah,0Eh
 21633                                  ;	mov	bx,7
 21634                                  ;	mov	si,program_name
 21635                                  ;nextchr:
 21636                                  ;	lodsb
 21637                                  ;	or	al,al
 21638                                  ;	jz	short pmsg_end
 21639                                  ;	int	10h
 21640                                  ;	jmp	short nextchr
 21641                                  ;pmsg_end:
 21642                                  ;	retn
 21643                                  ;
 21644                                  ;program_name:
 21645                                  ;	db 0Dh,0Ah
 21646                                  ;	db "IBM PCDOS 7.1 COMMAND.COM (Prompt "
 21647                                  ;	db 24h,"R) Return Code Test Program"
 21648                                  ;	db 0Dh,0Ah
 21649                                  ;	db "(Erdogan Tan - 06/08/2024)"
 21650                                  ;	;db 0Dh,0Ah,"$"
 21651                                  ;	db 0Dh,0Ah,0 
 21652                                  
 21653                                  %endif
 21654                                  
 21655                                  ; ---------------------------------------------------------------------------
 21656                                  
 21657                                  PRINT_ESC:
 21658 000021A0 B01B                    	mov	al,1Bh
 21659 000021A2 EB0A                    	jmp	short PRINT_CHAR
 21660                                  
 21661                                  ; ---------------------------------------------------------------------------
 21662                                  
 21663                                  	; 21/02/2023
 21664                                  PRINT_G:
 21665                                  	;mov	al,[RABRACKET]
 21666 000021A4 B03E                    	mov	al,'>' ; 3Eh
 21667 000021A6 EB06                    	jmp	short PRINT_CHAR
 21668                                  
 21669                                  ; ---------------------------------------------------------------------------
 21670                                  
 21671                                  	; 21/02/2023
 21672                                  PRINT_L:
 21673                                  	;mov	al,[LABRACKET]
 21674 000021A8 B03C                    	mov	al,'<' ; 3Ch
 21675 000021AA EB02                    	jmp	short PRINT_CHAR
 21676                                  
 21677                                  ; ---------------------------------------------------------------------------
 21678                                  
 21679                                  	; 21/02/2023
 21680                                  Print_B:
 21681                                  	;mov	al,[VBAR]
 21682 000021AC B07C                    	mov	al,'|' ; 7Ch
 21683                                  
 21684                                  ; =============== S U B	R O U T	I N E =======================================
 21685                                  
 21686                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21687                                  PRINT_CHAR:
 21688                                  	; MSDOS 6.0
 21689                                  
 21690                                  ;	Bugbug:	Why bother with ds,es here?
 21691                                  		
 21692 000021AE 06                      	push	es
 21693 000021AF 1E                      	push	ds
 21694 000021B0 07                      	pop	es
 21695 000021B1 57                      	push	di
 21696 000021B2 52                      	push	dx
 21697 000021B3 88C2                    	mov	dl,al		;AC000; Get char into al
 21698                                  	;mov	ah,STD_CON_OUTPUT
 21699                                  				;AC000; print the char to stdout
 21700 000021B5 B402                    	mov	ah,2
 21701 000021B7 CD21                    	int	21h		;AC000;
 21702 000021B9 5A                      	pop	dx
 21703 000021BA 5F                      	pop	di
 21704 000021BB 07                      	pop	es
 21705 000021BC C3                      	retn
 21706                                  
 21707                                  ; ---------------------------------------------------------------------------
 21708                                  
 21709                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21710                                  PRINT_DRIVE:
 21711                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
 21712 000021BD B419                    	mov	ah,19h
 21713 000021BF CD21                    	int	21h	; DOS -	GET DEFAULT DISK NUMBER
 21714 000021C1 0441                    	add	al,'A'
 21715                                  	;add	al,[CAPITAL_A]
 21716                                  	;call	PRINT_CHAR
 21717                                  	;retn
 21718                                  	; 21/02/2023
 21719 000021C3 EBE9                    	jmp	short PRINT_CHAR
 21720                                  
 21721                                  ; ---------------------------------------------------------------------------
 21722                                  
 21723                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21724                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1EB6h
 21725                                  
 21726                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21727                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2460h
 21728                                  
 21729                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21730                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:229Ch
 21731                                  
 21732                                  build_dir_for_prompt:
 21733 000021C5 30D2                    	xor	dl,dl
 21734 000021C7 BE[399D]                	mov	si,BWDBUF
 21735 000021CA 89F7                    	mov	di,si
 21736 000021CC A0[079C]                	mov	al,[CURDRV]
 21737 000021CF 0441                    	add	al,'A'
 21738 000021D1 B43A                    	mov	ah,':'
 21739 000021D3 AB                      	stosw
 21740 000021D4 A0[FA9B]                	mov	al,[DIRCHAR]
 21741 000021D7 AA                      	stosb
 21742 000021D8 87FE                    	xchg	si,di
 21743 000021DA 893E[A09D]              	mov	[string_ptr_2],di
 21744                                  	;mov	ah,CURRENT_DIR ; 47h
 21745 000021DE B447                    	mov	ah,47h
 21746 000021E0 CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 21747                                  			; DL = drive (0=default,1=A,etc.)
 21748                                  			; DS:SI	points to 64-byte buffer area
 21749                                  	;mov	dx,STRINGBUF2PTR ; MSDOS 3.3
 21750                                  Print_R_@@:	; 06/08/2024
 21751 000021E2 BA[DF91]                	mov	dx,string_buf_ptr
 21752 000021E5 7303                    	jnc	short doprint
 21753                                  	;mov	dx,BADCURDRVPTR	; MSDOS 3.3
 21754 000021E7 BA[A190]                	mov	dx,BADCURDRV
 21755                                  doprint:
 21756                                  	;call	std_printf
 21757                                  	;retn
 21758 000021EA E93B32                  	jmp	std_printf
 21759                                  
 21760                                  ; =============== S U B	R O U T	I N E =======================================
 21761                                  
 21762                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21763                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1EDFh
 21764                                  
 21765                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21766                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:22C5h
 21767                                  
 21768                                  build_dir_for_chdir:
 21769 000021ED E80D00                  	call	build_dir_string
 21770 000021F0 BA[399D]                	mov	dx,DIRBUF
 21771 000021F3 8916[A09D]              	mov	[string_ptr_2],dx
 21772                                  	;mov	dx,offset trangroup:string_buf_ptr ; MSDOS 6.0
 21773                                  	;mov	dx,STRINGBUF2PTR ; MSDOS 3.3
 21774 000021F7 BA[DF91]                	mov	dx,string_buf_ptr
 21775                                  	;call	std_printf
 21776                                  	;retn
 21777                                  	; 21/02/2023
 21778                                  	;jmp	short doprint
 21779 000021FA E92B32                  	jmp	std_printf
 21780                                  
 21781                                  ; =============== S U B	R O U T	I N E =======================================
 21782                                  
 21783                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21784                                  build_dir_string:
 21785 000021FD 8A165C00                	mov	dl,[FCB] ; mov dl,[5Ch]
 21786 00002201 88D0                    	mov	al,dl
 21787 00002203 0440                    	add	al,'@'	; 40h
 21788 00002205 3C40                    	cmp	al,'@'
 21789 00002207 7506                    	jne	short gotdrive
 21790 00002209 0206[079C]              	add	al,[CURDRV]
 21791 0000220D FEC0                    	inc	al
 21792                                  gotdrive:
 21793 0000220F 50                      	push	ax
 21794 00002210 BE[3C9D]                	mov	si,BWDBUF+3
 21795                                  	;mov	ah,CURRENT_DIR ; 47h
 21796 00002213 B447                    	mov	ah,47h
 21797 00002215 CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 21798                                  			; DL = drive (0=default,1=A,etc.)
 21799                                  			; DS:SI	points to 64-byte buffer area
 21800 00002217 7305                    	jnc	short dpbisok
 21801 00002219 0E                      	push	cs
 21802 0000221A 1F                      	pop	ds
 21803 0000221B E9040A                  	jmp	DRVBAD
 21804                                  dpbisok:
 21805 0000221E BF[399D]                	mov	di,BWDBUF
 21806 00002221 89FA                    	mov	dx,di
 21807 00002223 58                      	pop	ax
 21808 00002224 B43A                    	mov	ah,':'
 21809 00002226 AB                      	stosw
 21810 00002227 A0[FA9B]                	mov	al,[DIRCHAR]
 21811 0000222A AA                      	stosb
 21812 0000222B C3                      	retn
 21813                                  
 21814                                  ; ---------------------------------------------------------------------------
 21815                                  
 21816                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21817                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1F1Fh
 21818                                  
 21819                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21820                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:24C9h
 21821                                  
 21822                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21823                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2305h
 21824                                  PATH:
 21825                                  	; MSDOS 6.0
 21826 0000222C 30C0                    	xor	al,al			;AN049; Set up holding buffer
 21827 0000222E BF[2399]                	mov	di,SRCXNAME		;AN049;  for PATH while parsing
 21828 00002231 AA                      	stosb				;AN049; Initialize PATH to null
 21829 00002232 4F                      	dec	di			;AN049; point to the start of buffer
 21830 00002233 E8600D                  	call	PGETARG 		; Pre scan for arguments
 21831 00002236 7460                    	jz	short disppath		; Print the current path
 21832                                  	;cmp	al,semicolon		;AC049; NUL path argument?
 21833 00002238 3C3B                    	cmp	al,';' ; 3Bh
 21834 0000223A 7503                    	jne	short pathslp 		;AC049;
 21835 0000223C 46                      	inc	si			;AN049; point past semicolon
 21836 0000223D EB1B                    	jmp	short scan_white	;AC049; Yes - make sure nothing else on line
 21837                                  pathslp:					; Get the user specified path
 21838 0000223F AC                      	lodsb				; Get a character
 21839 00002240 3C0D                    	cmp	al,0Dh
 21840                                  	;cmp	al,END_OF_LINE_IN	;AC049; Is it end of line?
 21841 00002242 7434                    	je	short path_eol		;AC049; yes - end of command
 21842 00002244 E81A05                  	call	testkanj		;See if DBCS
 21843 00002247 7405                    	jz	short notkanj2		;No - continue
 21844 00002249 AA                      	stosb				;AC049; Yes - store the first byte
 21845 0000224A AC                      	lodsb				;skip second byte of DBCS
 21846                                  path_hold:				;AN049;
 21847 0000224B AA                      	stosb				;AC049; Store a byte in the PATH buffer
 21848 0000224C EBF1                    	jmp	short pathslp		;continue parsing
 21849                                  notkanj2:
 21850 0000224E E83A05                  	call	UPCONV			;upper case the character
 21851                                  
 21852 00002251 3C3B                    	cmp	al,';' ; 3Bh
 21853                                  	;cmp	al,semicolon		;AC049; ';' not a delimiter on PATH
 21854 00002253 74F6                    	je	short path_hold		;AC049; go store it
 21855 00002255 E83607                  	call	DELIM			;delimiter?
 21856 00002258 75F1                    	jnz	short path_hold		;AC049; no - go store character
 21857                                  scan_white:				;AN049; make sure were at EOL
 21858 0000225A AC                      	lodsb				;AN049; get a character
 21859 0000225B 3C0D                    	cmp	al,0Dh
 21860                                  	;cmp	al,END_OF_LINE_IN	;AN049; end of line?
 21861 0000225D 7419                    	je	short path_eol		;AN049; yes - go set path
 21862 0000225F 3C20                    	cmp	al,' ' ; 20h
 21863                                  	;cmp	al,blank		;AN049; whitespace?
 21864 00002261 74F7                    	je	short scan_white	;AN049; yes - continue scanning
 21865                                  	;cmp	al,9
 21866 00002263 3C09                    	cmp	al,tab_chr ; 9		;AN049; whitespace?
 21867 00002265 74F3                    	je	short scan_white	;AN049; yes - continue scanning
 21868                                  
 21869 00002267 BA[D78F]                	mov	dx,extend_buf_ptr 	;AN049; no - set up error message
 21870                                  	;mov	word [extend_buf_ptr],1	;AN049; get "Too many parameters" message number
 21871 0000226A C706[D78F]0100          	mov	word [extend_buf_ptr],MoreArgs_Ptr
 21872                                  	;mov	byte [msg_disp_class],2		
 21873                                  					;AN049; set up parse error msg class
 21874 00002270 C606[D58F]02            	mov	byte [msg_disp_class],parse_msg_class
 21875 00002275 E9AE0A                  	jmp	cerror			;AN049;
 21876                                  path_eol:				;AN049; Parsing was clean
 21877 00002278 30C0                    	xor	al,al			;AN049; null terminate the PATH
 21878 0000227A AA                      	stosb				;AN049;    buffer
 21879 0000227B E83104                  	call	find_path		;AN049; Find PATH in environment
 21880 0000227E E80504                  	call	delete_path		;AC049; Delete any offending name
 21881 00002281 E8BB04                  	call	scan_double_null	;AC049; Scan to end of environment
 21882 00002284 E88B04                  	call	move_name		;AC049; move in PATH=
 21883 00002287 BE[2399]                	mov	si,SRCXNAME		;AN049; Set up source as PATH buffer
 21884                                  store_path:				;AN049; Store the PATH in the environment
 21885 0000228A AC                      	lodsb				;AN049; Get a character
 21886                                  	;cmp	al,END_OF_LINE_OUT ; 0	;AN049; null character?
 21887 0000228B 20C0                    	and	al,al ; al=0 ?
 21888 0000228D 7405                    	jz	short got_paths		;AN049; yes - exit
 21889 0000228F E81B05                  	call	store_char		;AN049; no - store character
 21890 00002292 EBF6                    	jmp	short store_path	;AN049; continue
 21891                                  got_paths:				;AN049; we're finished
 21892 00002294 31C0                    	xor	ax,ax			;	null terminate the PATH in
 21893 00002296 AB                      	stosw				;    	the environment
 21894 00002297 C3                      	retn
 21895                                  disppath:
 21896 00002298 E81404                  	call	find_path		;AN049;
 21897 0000229B E80300                  	call	print_path
 21898                                  	;call	CRLF2
 21899                                  	;retn
 21900                                  	; 21/02/2023
 21901 0000229E E9D806                  	jmp	CRLF2
 21902                                  
 21903                                  ; =============== S U B	R O U T	I N E =======================================
 21904                                  
 21905                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21906                                  print_path:
 21907 000022A1 26803D00                	cmp	byte [es:di],0
 21908 000022A5 750A                    	jnz	short path1
 21909                                  path0:
 21910 000022A7 BA[5191]                	mov	dx,NULLPATH_PTR
 21911 000022AA 0E                      	push	cs
 21912 000022AB 07                      	pop	es
 21913 000022AC 0E                      	push	cs
 21914 000022AD 1F                      	pop	ds
 21915 000022AE E97731                  	jmp	std_printf
 21916                                  path1:
 21917 000022B1 06                      	push	es
 21918 000022B2 1F                      	pop	ds
 21919 000022B3 83EF05                  	sub	di,5
 21920 000022B6 89FE                    	mov	si,di
 21921 000022B8 E89E04                  	call	SCASB2		; Look for null
 21922                                  	;cmp	cx,0FFh ; 255
 21923                                  	; 21/02/2023
 21924                                  	;ch = 0
 21925 000022BB 80F9FF                  	cmp	cl,255
 21926 000022BE 74E7                    	je	short path0
 21927 000022C0 0E                      	push	cs
 21928 000022C1 07                      	pop	es
 21929 000022C2 BF[96A3]                	mov	di,Arg_Buf
 21930                                  	;mov	dx,100h ; 256
 21931                                  	;sub	dx,cx
 21932                                  	;xchg	dx,cx
 21933                                  	; 21/02/2023
 21934 000022C5 F6D9                    	neg	cl ; 256-cl
 21935 000022C7 F3A4                    	rep	movsb
 21936 000022C9 BA[9991]                	mov	dx,arg_buf_ptr
 21937 000022CC 0E                      	push	cs
 21938 000022CD 1F                      	pop	ds
 21939 000022CE E95731                  	jmp	std_printf
 21940                                  
 21941                                  ; ---------------------------------------------------------------------------
 21942                                  
 21943                                  ; ****************************************************************
 21944                                  ; *
 21945                                  ; * ROUTINE:	 CLS
 21946                                  ; *
 21947                                  ; * FUNCTION:	 Clear the screen using INT 10h. If ANSI.SYS is
 21948                                  ; *		 installed, send a control string to clear the
 21949                                  ; *		 screen.
 21950                                  ; *
 21951                                  ; * INPUT:	 command line at offset 81H
 21952                                  ; *
 21953                                  ; * OUTPUT:	 none
 21954                                  ; *
 21955                                  ; ****************************************************************
 21956                                  
 21957                                  	; MSDOS 6.0
 21958                                  
 21959                                  ANSI_installed	equ 0FFh
 21960                                  
 21961                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21962                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21963                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21964                                  CLS:
 21965                                  	;;mov	ah,Mult_ANSI		;AN000; see if ANSI.SYS installed
 21966                                  	;mov	ah,1Ah
 21967                                  	;mov	al,0			;AN000;
 21968 000022D1 B8001A                  	mov	ax,1A00h
 21969 000022D4 CD2F                    	int	2Fh			;AN000;
 21970                                  		; - Multiplex - DOS 4+ ANSI.SYS internal - INSTALLATION CHECK
 21971                                  		; Return: AL = FFh if installed
 21972 000022D6 3CFF                    	cmp	al,ANSI_installed	;AN000;
 21973 000022D8 7429                    	je	short ansicls 		;AN000; installed - go do ANSI CLS
 21974                                  
 21975                                  check_lines:
 21976                                  	;mov	ax,(IOCTL SHL 8) + generic_ioctl_handle ; 440Ch
 21977 000022DA B80C44                  	mov	ax,440Ch		;AN000; get lines per page on display
 21978                                  	;mov	bx,stdout		;AN000; lines for stdout
 21979 000022DD BB0100                  	mov	bx,1   ; handle
 21980                                  	;;mov	ch,ioc_sc		;AN000; type is display
 21981                                  	;mov	ch,3   ; CON device	
 21982                                  	;;mov	cl,get_generic		;AN000; get information
 21983                                  	;mov	cl,7Fh ; minor function, get display info
 21984                                  	; 25/04/2023
 21985 000022E0 B97F03                  	mov	cx,037Fh
 21986 000022E3 BA[079F]                	mov	dx,Display_Ioctl	;AN000;
 21987 000022E6 CD21                    	int	21h			;AN000;
 21988 000022E8 720A                    	jc	short no_variable	;AN000; function had error, use default
 21989                                  		; 21/02/2023
 21990                                  		; ds:dx = parameter block
 21991                                  		; --- https://stanislavs.org/helppc/int_21-44-c.html ---
 21992                                  		; offset 00h  byte  level (0 for DOS 4.0)
 21993                                  		;   	 01h  byte  reserved
 21994                                  		;   	 02h  word  length of following data
 21995                                  		;   	 04h  word  control flags
 21996                                  		;	       bit 0 set for blink, clear for intensity
 21997                                  		;	       bits 1 to 15 reserved
 21998                                  		;   	 06h  byte  mode type (1=text, 2=graphics)
 21999                                  		;   	 07h  byte  reserved
 22000                                  		;   	 08h  word  colors; 0=monochrome, n=bits per pixel
 22001                                  		;   	 0Ah  word  pixel columns
 22002                                  		;   	 0Ch  word  pixel rows
 22003                                  		;   	 0Eh  word  character columns
 22004                                  		;   	 10h  word  character rows
 22005                                  	
 22006                                  	;mov	ax,[LinPerPag] ; [Display_Ioctl+10h]
 22007                                  	;				;AN000; get number of rows returned
 22008                                  	;mov	dh,al			;AN000; set number of rows
 22009                                  	;mov	ax,[display_width] ; [Display_Ioctl+0Eh]
 22010                                  	;				;AN000; get number of columns returned
 22011                                  	;mov	dl,al			;AN000; set number of columns
 22012                                  	; 21/02/2023
 22013 000022EA 8A16[159F]              	mov	dl,[display_width]
 22014 000022EE 8A36[179F]              	mov	dh,[LinPerPag]
 22015 000022F2 EB3B                    	jmp	short regcls		;AN000; go do cls
 22016                                  
 22017                                  no_variable:
 22018                                  	;;mov	bx,stdout		;AC000; set handle as stdout
 22019                                  	;mov	bx,1
 22020                                  	; bx = 1
 22021                                  	;mov	ax,IOCTL SHL 8		;AC000; do ioctl - get device info
 22022 000022F4 B80044                  	mov	ax,4400h
 22023 000022F7 CD21                    	int	21h			;AC000;
 22024 000022F9 F6C280                  	test	dl,80h
 22025                                  	;test	dl,devid_ISDEV		;AC000; is handle a device
 22026 000022FC 7405                    	jz	short ansicls 		;AC000; If a file put out ANSI
 22027 000022FE F6C210                  	test	dl,10h
 22028                                  	;test	dl,devid_SPECIAL	;AC000;
 22029 00002301 7505                    	jnz	short cls_normal	;AC000; If not special CON, do ANSI
 22030                                  
 22031                                  ansicls:
 22032 00002303 E85200                  	call	ansi_cls		;AN000; clear the screen
 22033 00002306 EB2C                    	jmp	short cls_ret		;AN000; exit
 22034                                  
 22035                                  ; Get video mode
 22036                                  
 22037                                  cls_normal:				;AC000;
 22038                                  	;mov	ah,get_video_state	;AC000; set up to get video state
 22039 00002308 B40F                    	mov	ah,0Fh
 22040                                  	;int	video_io_int		;AC000; do int 10h - BIOS video IO
 22041 0000230A CD10                    	int	10h
 22042 0000230C 3C03                    	cmp	al,3
 22043                                  	;cmp	al,video_alpha		;AC000; see if in text mode
 22044 0000230E 760A                    	jbe	short DoAlpha
 22045 00002310 3C07                    	cmp	al,7
 22046                                  	;cmp	al,video_bw		;AC000; see if black & white card
 22047 00002312 7406                    	je	short DoAlpha
 22048                                  
 22049                                  ; We are in graphics mode. Bogus IBM ROM does not scroll correctly. We will
 22050                                  ; be just as bogus and set the mode that we just got. This will blank the
 22051                                  ; screen too.
 22052                                  
 22053                                  	;mov	ah,set_video_mode	;AC000; set video mode call
 22054 00002314 B400                    	mov	ah,0
 22055                                  	;int	video_io_int		;AC000; do int 10h - BIOS video IO
 22056 00002316 CD10                    	int	10h
 22057 00002318 EB1A                    	jmp	short cls_ret		;AC000; exit
 22058                                  
 22059                                  DoAlpha:
 22060                                  
 22061                                  ; Get video mode and number of columns to scroll
 22062                                  
 22063                                  ;M01 - INT 10 Function 0F doesn't reliably return the number of rows on some
 22064                                  ;M01   adaptors. We circumvent this by reaching directly into the BIOS data
 22065                                  ;M01   area
 22066                                  ;M01   Commented out code here is the original
 22067                                  ;M01	mov	ah,get_video_state	;AC000; set up to get current video state
 22068                                  ;M01	int	video_io_int		;AC000; do int 10h - BIOS video IO
 22069                                  ;M01	mov	dl,ah
 22070                                  ;M01	mov	dh,linesperpage 	;AC000; have 25 rows on the screen
 22071                                  
 22072                                  ;M01   Following code lifted from a fix Compaq applied to ANSI
 22073                                  
 22074 0000231A 1E                      	push	ds
 22075                                  	;mov	ax,ROMBIOS_DATA 	; GET ROM Data segment	M01
 22076 0000231B B84000                  	mov	ax,40h
 22077 0000231E 8ED8                    	mov	ds,ax			;  *			M01
 22078                                  
 22079                                  	;mov	dx,[CRT_Cols]		; Get Columns - assume < 256 M01
 22080 00002320 8A164A00                	mov	dl,[4Ah]
 22081                                  	;mov	dh,[CRT_Rows]		; GET MAX NUM OF ROWS	M01
 22082 00002324 8A368400                	mov	dh,[84h]
 22083 00002328 1F                      	pop	ds			;			M01
 22084                                  
 22085 00002329 08F6                    	or	dh,dh			; Q:ZERO		M01
 22086 0000232B 7502                    	jnz	short regcls		;  *JMP IF NO		M01
 22087                                  
 22088                                  	;mov	dh,LINESPERPAGE 	; SET TO 24 ROWS	M01
 22089                                  	; 25/04/2023
 22090 0000232D B619                    	mov	dh,25
 22091                                  regcls:
 22092 0000232F FEC6                    	inc	dh			; height+1		M018
 22093 00002331 E80100                  	call	reg_cls 		; go clear the screen
 22094                                  cls_ret:
 22095 00002334 C3                      	retn				; exit
 22096                                  
 22097                                  ; ---------------------------------------------------------------------------
 22098                                  
 22099                                  ; MSDOS 6.0
 22100                                  
 22101                                  ; ****************************************************************
 22102                                  ; *
 22103                                  ; * ROUTINE:	 REG_CLS
 22104                                  ; *
 22105                                  ; * FUNCTION:	 Clear the screen using INT 10H.
 22106                                  ; *
 22107                                  ; * INPUT:	 DL = NUMBER OF COLUMNS
 22108                                  ; *		 DH = NUMBER OF ROWS
 22109                                  ; *
 22110                                  ; * OUTPUT:	 none
 22111                                  ; *
 22112                                  ; ****************************************************************
 22113                                  
 22114                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22115                                  reg_cls:
 22116                                  ; Set overscan to black.
 22117                                  
 22118 00002335 FECE                    	dec	dh			; decrement rows and columns
 22119 00002337 FECA                    	dec	dl			;  to zero base
 22120 00002339 52                      	push	dx			; save rows,columns
 22121                                  	;mov	ah,set_color_palette	; set up to set the color to blank
 22122 0000233A B40B                    	mov	ah,0Bh
 22123 0000233C 31DB                    	xor	bx,bx
 22124                                  	;int	video_io_int		; do int 10h - BIOS video IO
 22125 0000233E CD10                    	int	10h
 22126 00002340 5A                      	pop	dx			;  restore rows,colums
 22127                                  
 22128 00002341 31C0                    	xor	ax,ax			; zero out ax
 22129 00002343 89C1                    	mov	cx,ax			;  and cx
 22130                                  
 22131                                  ; Scroll active page
 22132                                  
 22133                                  	;mov	ah,scroll_video_page	; set up to scroll page up
 22134 00002345 B406                    	mov	ah,6
 22135                                  	;mov	bh,video_attribute	; attribute for blank line
 22136 00002347 B707                    	mov	bh,7
 22137 00002349 30DB                    	xor	bl,bl			; set BL to 0
 22138                                  	;int	video_io_int		; do int 10h - BIOS video IO
 22139 0000234B CD10                    	int	10h
 22140                                  
 22141                                  ; Seek to cursor to 0,0
 22142                                  
 22143                                  ;M022 following two lines added
 22144                                  	;mov	ah,get_video_state	; get current video page in BH
 22145 0000234D B40F                    	mov	ah,0Fh
 22146                                  	;int	video_io_int
 22147 0000234F CD10                    	int	10h
 22148                                  	;mov	ah,set_cursor_position	; set up to set cursor position
 22149 00002351 B402                    	mov	ah,2
 22150 00002353 31D2                    	xor	dx,dx			; row and column 0
 22151                                  ;M022	mov	bh,0
 22152                                  	;int	video_io_int		; do into 10h - BIOS video IO
 22153 00002355 CD10                    	int	10h
 22154                                  
 22155 00002357 C3                      	retn
 22156                                  
 22157                                  ; ---------------------------------------------------------------------------
 22158                                  
 22159                                  ; MSDOS 6.0
 22160                                  
 22161                                  ; ****************************************************************
 22162                                  ; *
 22163                                  ; * ROUTINE:	 ANSI_CLS
 22164                                  ; *
 22165                                  ; * FUNCTION:	 Clear the screen using by writing a control code
 22166                                  ; *		 to STDOUT.
 22167                                  ; *
 22168                                  ; * INPUT:	 none
 22169                                  ; *
 22170                                  ; * OUTPUT:	 none
 22171                                  ; *
 22172                                  ; ****************************************************************
 22173                                  
 22174                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22175                                  ansi_cls:			;AC000;
 22176 00002358 BE[0394]                	mov	si,CLSSTRING
 22177                                  			; db 4,1Bh,'[2J'
 22178 0000235B AC                      	lodsb
 22179 0000235C 88C1                    	mov	cl,al	; al = 4
 22180 0000235E 30ED                    	xor	ch,ch
 22181                                  	;mov	ah,Raw_CON_IO
 22182 00002360 B406                    	mov	ah,6
 22183                                  clrloop:
 22184 00002362 AC                      	lodsb
 22185 00002363 88C2                    	mov	dl,al
 22186 00002365 CD21                    	int	21h
 22187                                  		; DOS - DIRECT CONSOLE I/O CHARACTER OUTPUT
 22188 00002367 E2F9                    	loop	clrloop
 22189 00002369 C3                      	retn
 22190                                  
 22191                                  ;============================================================================
 22192                                  ; TCMD2B.ASM, MSDOS 6.0, 1991
 22193                                  ;============================================================================
 22194                                  ; 08/10/2018 - Retro DOS v3.0
 22195                                  
 22196                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 156Dh
 22197                                  
 22198                                  ; 21/02/2023 - Retro DOS v4.0 (& v4.1)
 22199                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 206Bh
 22200                                  
 22201                                  ; ---------------------------------------------------------------------------
 22202                                  
 22203                                  ; ****************************************************************
 22204                                  ; *
 22205                                  ; * ROUTINE:	 CTTY - Change console
 22206                                  ; *
 22207                                  ; * SYNTAX:	 CTTY device
 22208                                  ; *
 22209                                  ; * FUNCTION:	 If a valid console device is specified, CTTY will
 22210                                  ; *		 duplicate the device handle to STDIN, STDOUT and
 22211                                  ; *		 STDERR. This routine returns to LODCOM1.
 22212                                  ; *
 22213                                  ; * INPUT:	 command line at offset 81H
 22214                                  ; *
 22215                                  ; * OUTPUT:	 none
 22216                                  ; *
 22217                                  ; ****************************************************************
 22218                                  
 22219                                  	; 21/02/2023 - Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 22220                                  	; 08/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 22221                                  	; 10/06/2023
 22222                                  	; 03/08/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
 22223                                  CTTY:
 22224                                  	; MSDOS 6.0
 22225 0000236A 1E                      	push	ds			;AN000; Get local ES
 22226 0000236B 07                      	pop	es			;AN000;
 22227 0000236C BE8100                  	mov	si,81h			;AC000; Get command argument for CTTY
 22228 0000236F BF[3297]                	mov	di,PARSE_CTTY
 22229                                  					;AC000; Get address of PARSE_CTTY
 22230 00002372 31C9                    	xor	cx,cx			;AC000; clear cx,dx
 22231 00002374 31D2                    	xor	dx,dx			;AC000;
 22232 00002376 E8F325                  	call	cmd_parse		;AC000; call parser
 22233                                  
 22234                                  	;cmp	ax,-1 ; 0FFFFh
 22235                                  	;;cmp	ax,END_OF_LINE		;AN000; are we at end of line?
 22236                                  	;je	short ctty_error	;AN000; yes - error
 22237                                  	;;cmp	ax,RESULT_NO_ERROR ; 0	;AN000; did an error occur
 22238                                  	;and	ax,ax ; ax > 0 ?
 22239                                  	;jnz	short ctty_error	;AN000; YES -ERROR
 22240                                  	; 10/06/2023
 22241 00002379 40                      	inc	ax  ; cmp ax,-1
 22242 0000237A 7434                    	jz	short ctty_error  ; 0FFFFh -> 0
 22243 0000237C 48                      	dec	ax  ; cmp ax,0
 22244 0000237D 7531                    	jnz	short ctty_error  ; 1 -> 0
 22245                                  	; ax = 0
 22246                                  
 22247 0000237F 56                      	push	si			;AN000; save position in line
 22248 00002380 C536[EFA5]              	lds	si,[PARSE1_ADDR]	;AN000; get address of filespec
 22249 00002384 BF[219E]                	mov	di,SrcBuf		;AN000; get address of srcbuf
 22250                                  ctty_move_filename:			;AN000; put filespec in srcbuf
 22251 00002387 AC                      	lodsb				;AN000; get a char from buffer
 22252 00002388 AA                      	stosb				;AN000; store in srcbuf
 22253                                  	;cmp	al,END_OF_LINE_OUT ; 0	;AN000; it char a terminator?
 22254 00002389 08C0                    	or	al,al ; al = 0 ?
 22255 0000238B 75FA                    	jnz	short ctty_move_filename ; 26/04/2023
 22256                                  					;AN000; no - keep moving
 22257 0000238D 5E                      	pop	si			;AN000; get line position back
 22258 0000238E BF[3297]                	mov	di,PARSE_CTTY		;AC000; Get address of PARSE_CTTY
 22259 00002391 E8B101                  	call	parse_check_eol 	;AN000; are we at end of line?
 22260                                  	;jz	short nocolon 		;AN000; yes - continue
 22261                                  	; 21/02/2023
 22262 00002394 751A                    	jnz	short ctty_error
 22263                                  ;ctty_error:
 22264                                  	;jmp	short isbaddev		;AC000; yes - exit
 22265                                  
 22266                                  	; 21/02/2023
 22267                                  	; MSDOS 3.3
 22268                                  	;call	SETPATH
 22269                                  	;dec	si
 22270                                  	;dec	si
 22271                                  	;cmp	byte [si],':'
 22272                                  	;jnz	short NOCOLON
 22273                                  	;mov	byte [si],0
 22274                                  nocolon:
 22275                                  	; 21/02/2023
 22276                                  	; MSDOS 6.0
 22277 00002396 BA[219E]                	mov	dx,SrcBuf
 22278                                  ;NOCOLON:
 22279                                  	; MSDOS 3.3 & MSDOS 6.0
 22280                                  	;;mov	ax,(OPEN SHL 8) OR 2 ; Read and write
 22281                                  	;mov	ax,(OPEN<<8)|2 ; 3D02h
 22282 00002399 B8023D                  	mov	ax,3D02h ; 21/02/2023
 22283 0000239C CD21                    	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 22284                                  			; DS:DX	-> ASCIZ filename
 22285                                  			; AL = access mode
 22286                                  			; 2 - read & write
 22287 0000239E 7210                    	jc	short isbaddev
 22288 000023A0 89C3                    	mov	bx,ax
 22289                                  	;mov	ax,IOCTL*256 ; 4400h
 22290 000023A2 B80044                  	mov	ax,4400h
 22291 000023A5 CD21                    	int	21h	; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 22292                                  			; BX = file or device handle
 22293 000023A7 F6C280                  	test	dl,80h
 22294 000023AA 750C                    	jnz	short devisok
 22295                                  closedev:
 22296                                  	;mov	ah,CLOSE ; 3Eh ; Close initial handle
 22297 000023AC B43E                    	mov	ah,3Eh
 22298 000023AE CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 22299                                  			; BX = file handle
 22300                                  ctty_error:
 22301                                  isbaddev:
 22302 000023B0 BA[5791]                	mov	dx,BADDEV_PTR
 22303 000023B3 E87230                  	call	std_printf
 22304 000023B6 EB40                    	jmp	short resret
 22305                                  
 22306                                  	;nop
 22307                                  devisok:
 22308                                  	; 21/02/2023
 22309                                  	; MSDOS 6.0
 22310 000023B8 52                      	push	dx		;AN007; save device info
 22311                                  	; 08/06/2023
 22312 000023B9 A1[FA91]                	mov	ax,[acrlf_ptr]	;AN021; get message number for 0d, 0a
 22313                                  	;mov	dh,util_msg_class
 22314 000023BC B6FF                    	mov	dh,-1 ; 0FFh	;AN021; this is a utility message
 22315 000023BE 53                      	push	bx		;AN021; save handle
 22316 000023BF E84931                  	call	TSYSGETMSG	;AN021; get the address of the message
 22317 000023C2 89F2                    	mov	dx,si		;AN021; get address into dx
 22318                                  	;mov	ax,(Write shl 8)
 22319 000023C4 B80040                  	mov	ax,4000h	;AN007; write to device
 22320 000023C7 B90200                  	mov	cx,2		;AN007; write two bytes
 22321 000023CA CD21                    	int	21h		;AN007;
 22322 000023CC 5B                      	pop	bx		;AN021; get back handle
 22323 000023CD 5A                      	pop	dx		;AN007; get back device info
 22324 000023CE 72DC                    	jc	short closedev	;AN007; if error, quit
 22325                                  
 22326                                  	; MSDOS 3.3 & MSDOS 6.0
 22327 000023D0 30F6                    	xor	dh,dh
 22328 000023D2 80CA03                  	or	dl,3
 22329                                  	;;mov	ax,(IOCTL SHL 8) OR 1
 22330                                  	;mov	ax,(IOCTL<<8)|1 ; 4401h
 22331 000023D5 B80144                  	mov	ax,4401h
 22332 000023D8 CD21                    	int	21h	; DOS -	2+ - IOCTL - SET DEVICE	INFORMATION
 22333                                  			; BX = device handle,DH = 0
 22334                                  			; DL = device information to set 
 22335                                  			;	(bits 0-7 from	function 0)
 22336 000023DA 53                      	push	bx
 22337 000023DB B90300                  	mov	cx,3
 22338 000023DE 31DB                    	xor	bx,bx
 22339                                  iclloop:			; Close basic handles
 22340                                  	;mov	ah,CLOSE ; 3Eh
 22341 000023E0 B43E                    	mov	ah,3Eh
 22342 000023E2 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 22343                                  			; BX = file handle
 22344 000023E4 43                      	inc	bx
 22345 000023E5 E2F9                    	loop	iclloop
 22346 000023E7 5B                      	pop	bx		; Get handle
 22347                                  	;mov	ah,XDUP ; 45h
 22348 000023E8 B445                    	mov	ah,45h
 22349 000023EA CD21                    	int	21h	; DOS -	2+ - CREATE DUPLICATE HANDLE (DUP)
 22350                                  			; BX = file handle to duplicate
 22351                                  	;mov	ah,XDUP ; 45h
 22352 000023EC B445                    	mov	ah,45h
 22353 000023EE CD21                    	int	21h	; DOS -	2+ - CREATE DUPLICATE HANDLE (DUP)
 22354                                  			; BX = file handle to duplicate
 22355                                  	;mov	ah,XDUP ; 45h
 22356 000023F0 B445                    	mov	ah,45h
 22357 000023F2 CD21                    	int	21h	; DOS -	2+ - CREATE DUPLICATE HANDLE (DUP)
 22358                                  			; BX = file handle to duplicate
 22359                                  	;mov	ah,CLOSE ; 3Eh
 22360 000023F4 B43E                    	mov	ah,3Eh
 22361 000023F6 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 22362                                  			; BX = file handle
 22363                                  resret:
 22364 000023F8 8E1E[F59B]              	mov	ds,[RESSEG]
 22365 000023FC 1E                      	push	ds
 22366                                  	;mov	ax,[18h]
 22367 000023FD A11800                  	mov	ax,[PDB.JFN_TABLE] ; Get new 0 and 1
 22368 00002400 A3[9F02]                	mov	[Io_Save],ax
 22369                                  	;;;mov	ax,31Eh ; MSDOS 3.3
 22370                                  	;;mov	ax,LODCOM1
 22371                                  	;;mov	ax,offset DATARES:TrnLodCom1_Trap  ; MSDOS 6.0
 22372                                  	;mov	ax,175h ; MSDOS 6.0
 22373 00002403 B8[D600]                	mov	ax,TrnLodCom1_Trap
 22374 00002406 50                      	push	ax
 22375                                  
 22376 00002407 CB                      	retf		; Far return
 22377                                  
 22378                                  ; ---------------------------------------------------------------------------
 22379                                  
 22380                                  ;****************************************************************
 22381                                  ;*
 22382                                  ;* ROUTINE:	CHCP - Change code page internal command
 22383                                  ;*		(added DOS 3.30 07/21/86)
 22384                                  ;*
 22385                                  ;* SYNTAX:	CHCP [xxx]
 22386                                  ;*		where xxx is a valid code page
 22387                                  ;*
 22388                                  ;* FUNCTION:	If xxx is specified, CHCP will use INT 21H function
 22389                                  ;*		6402H to set the code page to xxxx. If no parameters
 22390                                  ;*		are specified, CHCP will use INT 21H function 6401H
 22391                                  ;*		to get global code page and display it to the user.
 22392                                  ;*
 22393                                  ;* INPUT:	command line at offset 81H
 22394                                  ;*
 22395                                  ;* OUTPUT:	none
 22396                                  ;*
 22397                                  ;****************************************************************
 22398                                  
 22399                                  NLSFUNC_installed equ  0FFh
 22400                                  set_global_cp	  equ  2
 22401                                  get_global_cp	  equ  1
 22402                                  
 22403                                  	; 21/02/2023 - Retro DOS v4.0
 22404                                  	; 09/06/2023 - Retro DOS v4.2 COMMAND.COM
 22405                                  	; 10/06/2023
 22406                                  	; 03/08/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
 22407                                  CHCP:
 22408                                  	; MSDOS 6.0
 22409 00002408 1E                      	push	ds		;AN000; Get local ES
 22410 00002409 07                      	pop	es		;AN000;
 22411 0000240A BE8100                  	mov	si,81h		;AC000; Get command argument for CHCP
 22412 0000240D BF[3396]                	mov	di,PARSE_CHCP
 22413                                  				;AN000; Get address of PARSE_CHCP
 22414 00002410 31C9                    	xor	cx,cx		;AC000; clear cx,dx
 22415 00002412 31D2                    	xor	dx,dx		;AC000;
 22416 00002414 E84401                  	call    Parse_With_Msg	;AC018; call parser
 22417                                  
 22418                                  	;cmp	ax,-1
 22419                                  	;;cmp	ax,END_OF_LINE	;AN000; are we at end of line?
 22420                                  	;;jne	short setcp	;AC000; no go get number & set code page
 22421                                  	;je	short getcp	;AC000; yes - no parm - get code page
 22422                                  ;setcp:
 22423                                  	;;cmp	ax,0
 22424                                  	;;cmp	ax,RESULT_NO_ERROR
 22425                                  	;			;AN000; did we have an error?
 22426                                  	;;jne	short cp_error	;AC018; yes - go issue message
 22427                                  	;and	ax,ax ; ax > 0 ?
 22428                                  	;jnz	short cp_error	
 22429                                  	; 10/06/2023
 22430 00002417 40                      	inc	ax  ; cmp ax,-1	
 22431 00002418 745C                    	jz	short getcp ; 0FFFFh -> 0
 22432 0000241A 48                      	dec	ax  ; cmp ax,0
 22433 0000241B 7556                    	jnz	short cp_error ; 1 -> 0
 22434                                  	; ax = 0
 22435                                  
 22436                                  	;;push	cx		;AN000; save positional count
 22437                                  	;mov	bx,PARSE1_ADDR	;AN000; get number returned
 22438                                  	;;mov	cx,[bx]		;AN000;  into cx
 22439                                  	;;mov	[system_cpage],cx
 22440                                  	;			;AN000; save user input number
 22441                                  	;;pop	cx		;AC000; restore positional count
 22442                                  	;; 21/02/2023
 22443                                  	;mov	di,[bx]
 22444                                  	;mov	[system_cpage],di
 22445                                  	; 09/06/2023	
 22446 0000241D 8B1E[EFA5]              	mov	bx,[PARSE1_ADDR]
 22447 00002421 891E[9A9D]              	mov	[system_cpage],bx
 22448                                  	;
 22449 00002425 BF[3396]                	mov	di,PARSE_CHCP	;AN000; Get address of PARSE_CHCP
 22450 00002428 E81A01                  	call	parse_check_eol ;AN000; are we at end of line?
 22451 0000242B 7546                    	jnz	short cp_error	;AC000; no - exit
 22452                                  okset:
 22453                                  	;;mov	ah,NLSFUNC	;AN000; see if NLSFUNC installed
 22454                                  	;mov	ah,14h
 22455                                  	;mov	al,0		;AN000;
 22456 0000242D B80014                  	mov	ax,1400h
 22457 00002430 CD2F                    	int	2Fh		;AN000;
 22458                                  	;cmp	al,0FFh
 22459 00002432 3CFF                    	cmp	al,NLSFUNC_installed
 22460                                  				;AN000;
 22461 00002434 7405                    	je	short got_NLS 	;AN000; Yes - continue
 22462 00002436 BA[9B90]                	mov	dx,NLSFUNC_PTR
 22463                                  				;AN000; no - set up error message
 22464 00002439 EB38                    	jmp	short cp_error	;AN000; error exit
 22465                                  
 22466                                  	; 21/02/2023
 22467                                  got_NLS:
 22468                                  	; MSDOS 6.0
 22469 0000243B 8B1E[9A9D]              	mov	bx,[system_cpage]
 22470                                  				;AN000; get user input code page
 22471                                  ;SET_CP_TBL_NUM:
 22472                                  	;mov	[SYSTEM_CPAGE],bx ; MSDOS 3.3
 22473                                  	;
 22474                                  	; MSDOS 3.3 & MSDOS 6.0
 22475                                  	;;mov	ah,GETSETCDPG 	;get/set global code page function
 22476                                  	;mov	ah,66h
 22477                                  	;;mov	al,set_global_cp 
 22478                                  	;mov	al,2		;minor - set
 22479                                  	; 26/04/2023
 22480 0000243F B80266                  	mov	ax,6602h
 22481 00002442 CD21                    	int	21h
 22482                                  		; DOS - 3.3+ - SET GLOBAL CODE PAGE TABLE
 22483                                  		; BX = active code page
 22484                                  		; DX = system code page (active page at boot time)
 22485                                  
 22486 00002444 733F                    	jnc	short chcp_return
 22487                                  				;no error - exit
 22488                                  
 22489 00002446 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND ; 2
 22490 00002449 7515                    	jnz	short chcp_other_error
 22491                                  
 22492                                  	;mov	ah,GETEXTENDEDERROR ; 59h
 22493 0000244B B459                    	mov	ah,59h
 22494 0000244D 31DB                    	xor	bx,bx
 22495 0000244F CD21                    	int	21h	; DOS -	3+ - GET EXTENDED ERROR	CODE
 22496                                  			; BX = version code (0000h for DOS 3.x)
 22497                                  
 22498 00002451 83F80D                  	cmp	ax,ERROR_INVALID_DATA ; 0Dh ; invalid code page
 22499 00002454 7505                    	jne	short no_countrysys ; 26/04/2023
 22500                                  	;mov	dx,FNOTFOUNDPTR ; MSDOS 3.3
 22501 00002456 BA[9E90]                	mov	dx,INV_CODE_PAGE
 22502                                  	;jmp	cerror
 22503 00002459 EB18                    	jmp	short cp_error
 22504                                  
 22505                                  	; 21/02/2023
 22506                                  	; MSDOS 6.0 (& 5.0) COMMAND.COM
 22507                                  no_countrysys:
 22508                                  ;M045;	mov	byte [msg_disp_class],ext_msg_class	   
 22509                                  ;					;AN000; set up extended error msg class
 22510                                  ;M045;	mov	dx,extend_buf_ptr	;AC000; get extended message pointer
 22511                                  ;M045;	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND
 22512                                  					;AN000; get message number in control block
 22513 0000245B BA[C692]                	mov	dx,NoCntry_Ptr
 22514 0000245E EB13                    	jmp	short cp_error
 22515                                  
 22516                                  chcp_other_error:		; end of p716
 22517                                  	;mov	ah,GETEXTENDEDERROR ; 59h ;error - see what it is
 22518 00002460 B459                    	mov	ah,59h
 22519 00002462 31DB                    	xor	bx,bx
 22520 00002464 CD21                    	int	21h	; DOS -	3+ - GET EXTENDED ERROR	CODE
 22521                                  			; BX = version code (0000h for DOS 3.x)
 22522 00002466 83F841                  	cmp	ax,65		;was it access denied?
 22523 00002469 7505                    	jne	short none_set	;no - assume all failed
 22524 0000246B BA[7F90]                	mov	dx,cp_not_all_ptr
 22525                                  				;set up message
 22526                                  	;jmp	cerror		;AC000; error exit
 22527 0000246E EB03                    	jmp     short cp_error
 22528                                  none_set:
 22529 00002470 BA[7190]                	mov	dx,cp_not_set_ptr
 22530                                  				;set up message
 22531                                  cp_error:
 22532 00002473 E9B008                  	jmp	cerror		;exit
 22533                                  getcp:
 22534                                  	;;mov	ah,GETSETCDPG ; 66h
 22535                                  	;mov	ah,66h		;get/set global code page function	
 22536                                  	;;mov	al,get_global_cp ; 1
 22537                                  	;mov	al,1		;minor - get
 22538                                  	; 26/04/2023
 22539 00002476 B80166                  	mov	ax,6601h
 22540 00002479 CD21                    	int	21h	; DOS -	3.3+ - GET GLOBAL CODE PAGE TABLE
 22541 0000247B 891E[9A9D]              	mov	[system_cpage],bx
 22542                                  				;get active cp for output
 22543 0000247F BA[8D90]                	mov	dx,cp_active_ptr
 22544 00002482 E8A32F                  	call	std_printf	;print it out
 22545                                  chcp_return:
 22546 00002485 C3                      	retn
 22547                                  
 22548                                  ; ---------------------------------------------------------------------------
 22549                                  
 22550                                  ; ****************************************************************
 22551                                  ; *
 22552                                  ; * ROUTINE:	 TRUENAME
 22553                                  ; *
 22554                                  ; * FUNCTION:	 Entry point for the internal TRUENAME command.
 22555                                  ; *		 Parses the command line. If a path is found, set
 22556                                  ; *		 SRCXNAME to path. If only a drive letter is found,
 22557                                  ; *		 set SRCXNAME to the drive letter. If no path
 22558                                  ; *		 is found, set the path of SRCXNAME to dot (.) for
 22559                                  ; *		 current directory. Use the NAME TRANSLATE system
 22560                                  ; *		 call to get the real name and  then display the 
 22561                                  ; *		 real name. If an error occurs issue an error
 22562                                  ; *		 message and transfer control to  CERROR.
 22563                                  ; *
 22564                                  ; * INPUT:	 command line at offset 81H
 22565                                  ; *
 22566                                  ; * OUTPUT:	 none
 22567                                  ; *
 22568                                  ; ****************************************************************
 22569                                  
 22570                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22571                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2197h
 22572                                  
 22573                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 22574                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2741h
 22575                                  
 22576                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 22577                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:257Dh
 22578                                  
 22579                                  TRUENAME:				;AN000; TRUENAME entry point
 22580 00002486 1E                      	push	ds			;AN000; Get local ES
 22581 00002487 07                      	pop	es			;AN000;
 22582 00002488 BE8100                  	mov	si,81h			;AN000; Get command line
 22583 0000248B BF[9196]                	mov	di,PARSE_CHDIR		;AN000; Get address of PARSE_CHDIR
 22584 0000248E 31C9                    	xor	cx,cx			;AN000; clear cx,dx
 22585 00002490 31D2                    	xor	dx,dx			;AN000;
 22586 00002492 E8C600                  	call	Parse_With_Msg		;AC018; call parser
 22587                                  
 22588 00002495 BF[2399]                	mov	di,SRCXNAME		;AN000; get address of srcxname
 22589                                  	;cmp	ax,0FFFFh
 22590                                  	;;cmp	ax,END_OF_LINE		;AN000; are we at end of line?
 22591                                  	;je	short tn_eol		;AN000; yes - go process
 22592                                  	;; 22/02/2023
 22593                                  	;;cmp	ax,0
 22594                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 22595                                  	;;jne	short tn_parse_error	;AN000; yes - go issue message
 22596                                  	;and	ax,ax ; ax = 0 ?
 22597                                  	;jnz	short tn_parse_error ; no, parse error	
 22598                                  	; 10/06/2023
 22599 00002498 40                      	inc	ax  ; 0FFFFh -> 0 ; cmp ax,0FFFFh
 22600 00002499 7433                    	jz	short tn_eol ; ah = 0 ; *
 22601 0000249B 48                      	dec	ax  ; 1 -> 0 ; cmp ax, 0
 22602 0000249C 752D                    	jnz	short tn_parse_error
 22603                                  	
 22604                                  	;cmp	byte [PARSE1_TYPE],6
 22605 0000249E 803E[EBA5]06            	cmp	byte [PARSE1_TYPE],result_drive
 22606                                  					;AN000; was a drive entered?
 22607                                  	;je	short tn_drive		;AN000; yes - go process
 22608                                  	;jmp	short tn_filespec	;AN000; nothing else - must be filespec
 22609                                  	; 23/02/2023
 22610 000024A3 7512                    	jne	short tn_filespec
 22611                                  
 22612                                  ;tn_eol: 
 22613                                  ;	;mov	ah,0			;AN000; no parameters on line
 22614                                  ;	mov	ah,END_OF_LINE_OUT	;AN000; set buffer to .
 22615                                  ;	;mov	al,dot_chr		;AN000;   for current dir
 22616                                  ;	mov	al,'.'
 22617                                  ;	stosw				;AN000; store in srcxname
 22618                                  ;	jmp	short tn_doit		;AN000; go do command
 22619                                  
 22620                                  tn_drive:				;AN000; a drive was entered
 22621 000024A5 56                      	push	si			;AN000; save position in line
 22622 000024A6 BE[EFA5]                	mov	si,PARSE1_ADDR		;AN000; get address of drive
 22623 000024A9 AC                      	lodsb				;AN000; get the drive number
 22624 000024AA 0440                    	add	al,"A"-1 ; 40h		;AN000; convert it to char
 22625 000024AC AA                      	stosb				;AN000; store it in srcxname
 22626                                  	;mov	ax,dot_colon		;AN000; get colon and . and
 22627 000024AD B83A2E                  	mov	ax,':.' ; 2E3Ah ; ah=".", al=":"
 22628 000024B0 AB                      	stosw				;AN000;  store in srcxname
 22629                                  	;mov	al,0
 22630 000024B1 B000                    	mov	al,END_OF_LINE_OUT	;AN000; put a terminator char
 22631 000024B3 AA                      	stosb				;AN000;
 22632 000024B4 5E                      	pop	si			;AN000; get line position back
 22633 000024B5 EB0C                    	jmp	short tn_check_eol	;AN000; check to make sure eol
 22634                                  
 22635                                  tn_filespec:				;AN000; a filespec was entered
 22636 000024B7 56                      	push	si			;AN000; save position in line
 22637 000024B8 C536[EFA5]              	lds	si,[PARSE1_ADDR]	;AN000; get address of filespec
 22638                                  
 22639                                  tn_move_filename:			;AN000; put filespec in srcxname
 22640 000024BC AC                      	lodsb				;AN000; get a char from buffer
 22641 000024BD AA                      	stosb				;AN000; store in srcxname
 22642                                  	;;cmp	al,0
 22643                                  	;cmp	al,END_OF_LINE_OUT	;AN000; it char a terminator?
 22644 000024BE 08C0                    	or	al,al ; al = 0 ?
 22645 000024C0 75FA                    	jnz	short tn_move_filename	;AN000; no - keep moving
 22646 000024C2 5E                      	pop	si			;AN000; get line position back
 22647                                  
 22648                                  tn_check_eol:				;AN000; make sure no extra parms
 22649 000024C3 BF[9196]                	mov	di,PARSE_CHDIR		;AN000; get address of parse_chdir
 22650 000024C6 E87C00                  	call	parse_check_eol 	;AN000; are we at end of line?
 22651 000024C9 7406                    	jz	short tn_doit 		;AN000; Yes - do the command
 22652                                  tn_parse_error: 			;AN000; A parse error occurred
 22653 000024CB E95808                  	jmp	cerror			;AN000; Go to error routine
 22654                                  
 22655                                  tn_eol: 
 22656                                  	;23/02/2023
 22657                                  	;;mov	ah,0			;AN000; no parameters on line
 22658                                  	;mov	ah,END_OF_LINE_OUT	;AN000; set buffer to .
 22659                                  	;;mov	al,dot_chr		;AN000;   for current dir
 22660                                  	;mov	al,'.'
 22661                                  	; 10/06/2023
 22662                                  	;mov	ax,002Eh
 22663                                  	; ah = 0 ; *
 22664 000024CE B02E                    	mov	al,'.'  ;dot_chr ; 2Eh
 22665                                  	;	
 22666 000024D0 AB                      	stosw				;AN000; store in srcxname
 22667                                  	; 23/02/2023
 22668                                  	;jmp	short tn_doit		;AN000; go do command
 22669                                  
 22670                                  tn_doit:				;AN000;
 22671 000024D1 BE[2399]                	mov	si,SRCXNAME		;AN000; set up srcxname as source
 22672 000024D4 BF[549A]                	mov	di,COMBUF		;AN000; set up combuf as target (need big target)
 22673 000024D7 B460                    	mov	ah,xNameTrans		;AN000; do name translate call
 22674                                  	;mov	ah,60h
 22675 000024D9 CD21                    	int	21h			;AN000;
 22676 000024DB 7311                    	jnc	short tn_print_xname	;AN000; If no error - print result
 22677                                  
 22678 000024DD E85BFB                  	call	Set_Ext_Error_Msg	;AN000; get extended message
 22679 000024E0 C706[A09D][2399]        	mov	word [string_ptr_2],SRCXNAME
 22680                                  					;AN000; get address of failed string
 22681                                  	;mov	byte [extend_buf_sub],1
 22682 000024E6 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst
 22683                                  					;AN000; put number of subst in control block
 22684 000024EB E93808                  	jmp	cerror			;AN000; Go to error routine
 22685                                  
 22686                                  tn_print_xname: 			;AN000;
 22687 000024EE C706[A09D][549A]        	mov	word [string_ptr_2],COMBUF
 22688                                  					;AN000; Set up address of combuf
 22689 000024F4 BA[DF91]                	mov	dx,string_buf_ptr	;AN000; Set up address of print control block
 22690 000024F7 E87F04                  	call	CRLF2			;AN000; print a crlf
 22691                                  	;call	Printf_Crlf		;AN000; print it out
 22692                                  	;retn				;AN000;
 22693                                  	; 23/02/2023
 22694 000024FA E91D2F                  	jmp	Printf_Crlf
 22695                                  
 22696                                  ; ---------------------------------------------------------------------------
 22697                                  
 22698                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22699                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2219h
 22700                                  
 22701                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 22702                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:27C3h
 22703                                  
 22704                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22705                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2600h
 22706                                  _$EXIT:
 22707                                  	; MSDOS 6.0
 22708 000024FD 1E                      	push	ds			;AN000; save data segment
 22709 000024FE 8E1E[F59B]              	mov	ds,[RESSEG]		;AN000; get resident data segment
 22710                                  	;assume	ds:resgroup		;AN000;
 22711                                  
 22712 00002502 803E[A202]00            	cmp	byte [PermCom],0	;AN045; is this a permanent COMMAND?
 22713 00002507 740A                    	jz	short free_com		;AN045; no - free everything
 22714                                  
 22715                                  ;	We're a permanent command.
 22716                                  ;	Unless this is a singlecom (int 2Eh), don't deallocate transient.
 22717                                  
 22718 00002509 833E[A502]FF            	cmp	word [SingleCom],-1	;M034
 22719 0000250E 7403                    	je	short no_reset		;M034 ; exit singlecom
 22720 00002510 E9F1DB                  	jmp	TCOMMAND		;permanent command, recycle
 22721                                  
 22722                                  free_com:
 22723                                  
 22724                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 22725                                  %if 0
 22726                                  	;mov	ax,(multdos shl 8 or message_2f)
 22727                                  	mov	ax,122Eh		;AN060; reset parse message pointers
 22728                                  	;mov	dl,SET_CRITICAL_MSG	;AN000; set up critical error message address
 22729                                  	mov	dl,5
 22730                                  	mov	di,[Crit_Msg_Off] 	;AN000; old offset of critical messages
 22731                                  	mov	es,[Crit_Msg_Seg] 	;AN000; old segment of critical messages
 22732                                  	int	2Fh			;AN000; go set it
 22733                                  %endif
 22734                                  
 22735                                  no_reset:				;AN045;
 22736 00002513 1F                      	pop	ds			;AN000; restore local data segment
 22737                                  	;assume	ds:trangroup		;AN000;
 22738                                  ;M040
 22739                                  ; Restore user directory if the restore flag is set. RestUDir1 checks for
 22740                                  ;this, restores user dir if flag is set and resets the flag.
 22741                                  
 22742                                  	;invoke	RestUDir1		;restore user dir if needed ;M040
 22743 00002514 E80C03                  	call	RestUDir1
 22744 00002517 8E06[F59B]              	mov	es,[RESSEG]
 22745                                  	;assume	es:resgroup
 22746                                  
 22747 0000251B 26A1[3E02]              	mov	ax,[es:Parent]
 22748                                  	;mov	[es:16h],ax
 22749                                  	;mov	[es:PDB_Parent_PID],ax
 22750 0000251F 26A31600                	mov	[es:PDB.PARENT_PID],ax
 22751 00002523 26A1[4002]              	mov	ax,[es:OldTerm]
 22752                                  	;mov	[es:0Ah],ax
 22753                                  	;mov	[es:PDB_Exit],ax
 22754 00002527 26A30A00                	mov	[es:PDB.EXIT],ax
 22755 0000252B 26A1[4202]              	mov	ax,[es:OldTerm+2]
 22756                                  	;mov	[es:0Ch],ax
 22757                                  	;mov	[es:PDB_Exit+2],ax
 22758 0000252F 26A30C00                	mov	[es:PDB.EXIT+2],ax
 22759                                  
 22760 00002533 06                      	push	es
 22761 00002534 8E06[039C]              	mov	es,[TRAN_TPA]
 22762                                  	;mov	ah,DEALLOC
 22763 00002538 B449                    	mov	ah,49h
 22764 0000253A CD21                    	int	21h			; Now running in "free" space
 22765 0000253C 07                      	pop	es
 22766                                  
 22767                                  	;mov	ah,Exit
 22768 0000253D B44C                    	mov	ah,4Ch
 22769                                  	;mov	al,byte ptr RetCode
 22770 0000253F 26A0[9A02]              	mov	al,[es:RetCode]
 22771 00002543 CD21                    	int	21h
 22772                                  
 22773                                  ; ---------------------------------------------------------------------------
 22774                                  
 22775                                  ; MSDOS 6.0
 22776                                  ; ****************************************************************
 22777                                  ; *
 22778                                  ; * ROUTINE:	 PARSE_CHECK_EOL
 22779                                  ; *
 22780                                  ; * FUNCTION:	 Calls parser to see if end of line occurred.
 22781                                  ; *		 If not end of line, set up to print parse
 22782                                  ; *		 error message. ASSUMES NO MORE PARAMETERS ARE
 22783                                  ; *		 EXPECTED!
 22784                                  ; *
 22785                                  ; * INPUT:	 DS:SI	  last output from parser
 22786                                  ; *		 ES:DI	  points to parse block
 22787                                  ; *		 CX	  last output from parser
 22788                                  ; *
 22789                                  ; * OUTPUT:	 AX	  parser return code
 22790                                  ; *
 22791                                  ; *		 if end of line found
 22792                                  ; *		     zero flag set
 22793                                  ; *		 else
 22794                                  ; *		     MSG_DISPLAY_CLASS set to parse error
 22795                                  ; *
 22796                                  ; ****************************************************************
 22797                                  
 22798                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22799                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2270h
 22800                                  
 22801                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22802                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2648h
 22803                                  parse_check_eol:
 22804 00002545 31D2                    	xor	dx,dx			;AN000;
 22805 00002547 8936[989D]              	mov	[parse_last],si 	;AN018; save start of parameter
 22806 0000254B E81E24                  	call	cmd_parse		;AN000; call parser
 22807 0000254E 3CFF                    	cmp	al,-1 ; 0FFh
 22808                                  	;cmp	al,END_OF_LINE	; 0FFh	;AN000; Are we at end of line?
 22809 00002550 7408                    	je	short parse_good_eol	;AN000; yes - no problem
 22810                                  	;cmp	ax,0
 22811                                  	;cmp	ax,RESULT_NO_ERROR	;AN018; was any error found?
 22812 00002552 21C0                    	and	ax,ax ; ax = 0 ?
 22813 00002554 7501                    	jnz	short ok_to_setup_pmsg	;AN018; yes - continue
 22814 00002556 40                      	inc	ax			;AN018; set AX to 1 and turn off zero flag
 22815                                  ok_to_setup_pmsg:
 22816 00002557 E81000                  	call	setup_parse_error_msg	;AN018; go set up error message
 22817                                  parse_good_eol:
 22818                                  parse_msg_good:	; 23/02/2023
 22819 0000255A C3                      	retn				;AN000;
 22820                                  
 22821                                  ; ---------------------------------------------------------------------------
 22822                                  
 22823                                  ; MSDOS 6.0
 22824                                  ; ****************************************************************
 22825                                  ; *
 22826                                  ; * ROUTINE:	 PARSE_WITH_MSG
 22827                                  ; *
 22828                                  ; * FUNCTION:	 Calls parser. If an error occurred, the error
 22829                                  ; *		 message is set up.
 22830                                  ; *
 22831                                  ; * INPUT:	 DS:SI	  last output from parser
 22832                                  ; *		 ES:DI	  points to parse block
 22833                                  ; *		 CX	  last output from parser
 22834                                  ; *
 22835                                  ; * OUTPUT:	 AX	  parser return code
 22836                                  ; *
 22837                                  ; *		 if no error
 22838                                  ; *		     outputs from parser
 22839                                  ; *		 else
 22840                                  ; *		     MSG_DISPLAY_CLASS set to parse error
 22841                                  ; *		     error message set up for STD_PRINTF
 22842                                  ; *
 22843                                  ; ****************************************************************
 22844                                  
 22845                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22846                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22847                                  Parse_With_Msg:
 22848 0000255B 8936[989D]              	mov	[parse_last],si 	;AN018; save start of parameter
 22849 0000255F E80A24                  	call	cmd_parse		;AN018; call parser
 22850 00002562 3CFF                    	cmp	al,-1 ; 0FFh
 22851                                  	;cmp	al,END_OF_LINE	; 0FFh	;AN018; Are we at end of line?
 22852 00002564 74F4                    	je	short parse_msg_good	;AN018; yes - no problem
 22853                                  	;cmp	ax,0
 22854                                  	;cmp	ax,RESULT_NO_ERROR	;AN018; did an error occur
 22855 00002566 09C0                    	or	ax,ax ; ax = 0 ?
 22856 00002568 74F0                    	jz	short parse_msg_good	;AN018; yes - no problem
 22857                                  	; 23/02/2023
 22858                                  	;call	setup_parse_error_msg	;AN018; go set up error message
 22859                                  ;parse_msg_good:
 22860                                  	;retn				;AN018;
 22861                                  	; 23/02/2023
 22862                                  	;jmp	short setup_parse_error_msg	
 22863                                  
 22864                                  ; ---------------------------------------------------------------------------
 22865                                  
 22866                                  ; MSDOS 6.0
 22867                                  ; ****************************************************************
 22868                                  ; *
 22869                                  ; * ROUTINE:	 SETUP_PARSE_ERROR_MSG
 22870                                  ; *
 22871                                  ; * FUNCTION:	 Calls parser.	If an error occurred, the error
 22872                                  ; *		 message is set up.
 22873                                  ; *
 22874                                  ; * INPUT:	 AX	     Parse error number
 22875                                  ; *		 SI	     Set to past last parameter
 22876                                  ; *		 Parse_last  Set to start of last parameter
 22877                                  ; *
 22878                                  ; * OUTPUT:	 MSG_DISPLAY_CLASS set to parse error
 22879                                  ; *		 error message set up for STD_PRINTF
 22880                                  ; *
 22881                                  ; ****************************************************************
 22882                                  
 22883                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22884                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22885                                  setup_parse_error_msg:
 22886 0000256A C606[D58F]02            	mov	byte [msg_disp_class],parse_msg_class
 22887                                  	;mov	byte [msg_disp_class],2	;AC018; Set up parse message class
 22888 0000256F BA[D78F]                	mov	dx,extend_buf_ptr	;AC018; get extended message pointer
 22889 00002572 C60400                  	mov	byte [si],END_OF_LINE_OUT ; 0
 22890                                  					;AC018; terminate the parameter string
 22891 00002575 A3[D78F]                	mov	[extend_buf_ptr],ax	;AC018; get message number in control block
 22892 00002578 83F802                  	cmp	ax,2
 22893                                  	;cmp	ax,LessArgs_Ptr 	;AC018; if required parameter missing
 22894 0000257B 740D                    	je	short setup_parse_msg_ret
 22895                                  					;AN018;    no subst
 22896 0000257D 8B36[989D]              	mov	si,[parse_last] 	;AC018; get start of parameter
 22897 00002581 8936[A09D]              	mov	[string_ptr_2],si 	;AC018; get address of failed string
 22898 00002585 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst
 22899                                  					;AC018; put number of subst in control block
 22900                                  	;mov	byte [extend_buf_sub],1
 22901                                  setup_parse_msg_ret:
 22902 0000258A 46                      	inc	si			;AN018; make sure zero flag not set
 22903 0000258B C3                      	retn				;AC018;
 22904                                  
 22905                                  ;============================================================================
 22906                                  ; TENV.ASM, MSDOS 6.0, 1991
 22907                                  ;============================================================================
 22908                                  ; 08/10/2018 - Retro DOS v3.0
 22909                                  
 22910                                  ; TITLE	Part6 COMMAND Transient routines.
 22911                                  
 22912                                  ;	Environment utilities and misc. routines
 22913                                  
 22914                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1690h
 22915                                  
 22916                                  ; 23/02/2023 - Retro DOS v4.0 (& v4.1)
 22917                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 22BDh
 22918                                  
 22919                                  ; ---------------------------------------------------------------------------
 22920                                  
 22921                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 22922                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 22923                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22924                                  ADD_PROMPT:
 22925 0000258C E8FC00                  	call	delete_prompt	; Delete any existing prompt
 22926 0000258F E8AD01                  	call	scan_double_null
 22927                                  
 22928                                  ADD_PROMPT2:
 22929 00002592 56                      	push	si
 22930 00002593 E89B01                  	call	GETARG
 22931 00002596 5E                      	pop	si
 22932 00002597 7501                    	jnz	short ADD_PROMPT3
 22933                                  ADD_PROMPT_RETN:
 22934 00002599 C3                      	retn
 22935                                  ADD_PROMPT3:			; Pre scan for arguments
 22936 0000259A E87501                  	call	move_name	; Move in name
 22937 0000259D E89101                  	call	GETARG
 22938 000025A0 56                      	push	si
 22939 000025A1 EB53                    	jmp	short ADD_NAME
 22940                                  
 22941                                  ;break	The SET command
 22942                                  
 22943                                  ; Input: DS:SI points to a CR terminated string
 22944                                  ; Output: carry flag is set if no room
 22945                                  ;	  otherwise name is added to environment
 22946                                  
 22947                                  DISP_ENVJ:
 22948 000025A3 E9BC00                  	jmp	DISP_ENV
 22949                                  
 22950                                  ADD_NAME_TO_ENVIRONMENT:
 22951 000025A6 E88801                  	call	GETARG
 22952 000025A9 74F8                    	jz	short DISP_ENVJ
 22953                                  
 22954                                  ; check if line contains exactly one equals sign
 22955                                  
 22956 000025AB 31DB                    	xor	bx,bx		; = count is 0
 22957 000025AD 56                      	push	si		; Save pointer to beginning of line
 22958                                  EQLP:
 22959 000025AE AC                      	lodsb			; Get a char
 22960 000025AF 3C0D                    	cmp	al,13 ; 0Dh	; IF CR we're all done
 22961 000025B1 740F                    	je	short QUEQ	
 22962 000025B3 3C3D                    	cmp	al,'='		; Look for = sign	
 22963 000025B5 75F7                    	jne	short EQLP	; not there, get next char
 22964 000025B7 FEC3                    	inc	bl		; Otherwise increment EQ count
 22965 000025B9 803C0D                  	cmp	byte [si],13	; Look for CR following = sign
 22966 000025BC 75F0                    	jne	short EQLP
 22967 000025BE FEC7                    	inc	bh		; Set BH=1 means no parameters
 22968 000025C0 EBEC                    	jmp	short EQLP	; And look for more
 22969                                  QUEQ:
 22970 000025C2 5E                      	pop	si		; Restore beginning of line
 22971 000025C3 FECB                    	dec	bl		; Zero flag means only one EQ
 22972 000025C5 7406                    	jz	short ONEQ	; Good line
 22973 000025C7 BA[AA90]                	mov	dx,SYNTMES_PTR
 22974 000025CA E95907                  	jmp	cerror
 22975                                  ONEQ:
 22976 000025CD 53                      	push	bx
 22977 000025CE E8BD00                  	call	delete_name_in_environment
 22978 000025D1 5B                      	pop	bx
 22979 000025D2 FECF                    	dec	bh
 22980 000025D4 74C3                    	jz	short ADD_PROMPT_RETN
 22981 000025D6 E86601                  	call	scan_double_null
 22982 000025D9 89FB                    	mov	bx,di		; Save ptr to beginning of env var name
 22983 000025DB E83401                  	call	move_name
 22984 000025DE 56                      	push	si
 22985 000025DF 87FB                    	xchg	bx,di		; Switch ptrs to beginning and end of
 22986                                  				;  env var name
 22987                                  		
 22988                                  ; We want to special-case COMSPEC. This is to reduce the amount of code
 22989                                  ; necessary in the resident for re-reading the transient. Let's look for
 22990                                  ; COMSPEC=
 22991                                  
 22992 000025E1 C606[E395]00            	mov	byte [comspec_flag],0 ; MSDOS 6.0 ; clear flag ; M024
 22993 000025E6 BE[FD92]                	mov	si,COMSPECSTR ; "COMSPEC="
 22994 000025E9 B90400                  	mov	cx,4
 22995 000025EC F3A7                    	repe	cmpsw
 22996 000025EE 7504                    	jnz	short NOT_COMSPEC
 22997                                  				; Zero set => exact match
 22998 000025F0 FE06[E395]              	inc	byte [comspec_flag] ; MSDOS 6.0 ; comspec is changing ; M024
 22999                                  	;mov	byte [COMSPEC_FLAG],1
 23000                                  NOT_COMSPEC:
 23001 000025F4 89DF                    	mov	di,bx		; Load ptr to end of env var name
 23002                                  ADD_NAME:
 23003 000025F6 5E                      	pop	si		; Add the value of the new env var
 23004 000025F7 56                      	push	si		;  to the environment.
 23005                                  ADD_NAME1:
 23006 000025F8 AC                      	lodsb
 23007 000025F9 3C0D                    	cmp	al,13 ; 0Dh
 23008 000025FB 7405                    	je	short ADD_NAME_RET
 23009 000025FD E8AD01                  	call	store_char
 23010 00002600 EBF6                    	jmp	short ADD_NAME1
 23011                                  ADD_NAME_RET:
 23012 00002602 5E                      	pop	si
 23013 00002603 803E[E395]00            	cmp	byte [comspec_flag],0
 23014                                  				; If the new env var is comspec,	
 23015                                  ADD_NAME_JZ_RET:
 23016 00002608 748F                    	jz	short ADD_PROMPT_RETN 
 23017                                  				;  copy the value into the
 23018                                  				;  comspec var in the resident
 23019                                  
 23020                                  ; We have changed the COMSPEC variable. We need to update the resident
 23021                                  ; pieces necessary to reread in the info. First, skip all delimiters
 23022                                  
 23023 0000260A E87903                  	call	scanoff
 23024 0000260D 8E06[F59B]              	mov	es,[RESSEG]	;  comspec var in the resident
 23025                                  
 23026                                  ; Make sure that the printer knows where the beginning of the string is
 23027                                  
 23028 00002611 BF[4B02]                	mov	di,ComSpec
 23029 00002614 89FB                    	mov	bx,di
 23030                                  
 23031                                  ; Generate drive letter for display
 23032                                  
 23033 00002616 31C0                    	xor	ax,ax		;g assume no drive first
 23034 00002618 26A2[9402]              	mov	[es:ComDrv],al
 23035                                  	; 23/02/2023
 23036                                  	; MSDOS 6.0 (& 5.0)
 23037 0000261C 50                      	push	ax		;AN000; 3/3/KK
 23038 0000261D 8A04                    	mov	al,[si]		;AN000; 3/3/KK
 23039 0000261F E83F01                  	call	testkanj	;AN000; 3/3/KK	
 23040 00002622 58                      	pop	ax		;AN000; 3/3/KK
 23041 00002623 7518                    	jnz	short _GOTDRIVE
 23042                                  	;
 23043 00002625 807C013A                	cmp	byte [si+1],':'	; drive specified?
 23044 00002629 7512                    	jne	short _GOTDRIVE
 23045 0000262B 8A04                    	mov	al,[si]		; get his specified drive
 23046                                  	; 23/02/2023
 23047 0000262D E85B01                  	call	UPCONV
 23048                                  	;call	UPCONV_MAPCALL	; convert to uppercase
 23049 00002630 2C41                    	sub	al,'A'		; convert to 0-based
 23050 00002632 83C702                  	add	di,2
 23051 00002635 FEC0                    	inc	al		; convert to 1-based number
 23052 00002637 26A2[9402]              	mov	[es:ComDrv],al
 23053                                  
 23054                                  ; Stick the drive letter in the prompt message. Nothing special needs to be
 23055                                  ; done here..
 23056                                  	;add	al,40h
 23057 0000263B 0440                    	add	al,'A'-1
 23058                                  _GOTDRIVE:
 23059                                  	; 23/02/2023
 23060                                  	;;mov	[es:0BD9h],di	; MSDOS 3.3 COMMAND.COM offset 1734h
 23061                                  	;mov	[es:PUTBACKSUBSTPTR],di
 23062                                  	;mov	[es:0233h],di	; MSDOS 5.0 COMMAND.COM offset 236Eh
 23063 0000263D 26893E[2A02]            	mov	[es:PutBackComSpec],di
 23064                                  				;g point to beginning of name after drive
 23065                                  	;;mov	[es:0A21h],al	; MSDOS 3.3 COMMAND.COM offset 1739h
 23066                                  	;mov	[es:PUTBACKDRV],al
 23067                                  	;mov	[es:0238h],al	; MSDOS 5.0 COMMAND.COM offset 2373h
 23068 00002642 26A2[2F02]              	mov	[es:PutBackDrv],al
 23069                                  
 23070                                  ; Copy chars until delim      	
 23071                                  
 23072 00002646 89DF                    	mov	di,bx
 23073                                  COPY_COMSPEC:
 23074 00002648 AC                      	lodsb
 23075 00002649 E84203                  	call	DELIM
 23076 0000264C 7407                    	jz	short COPYDONE
 23077 0000264E 3C0D                    	cmp	al,13 ; 0Dh
 23078 00002650 7403                    	je	short COPYDONE
 23079 00002652 AA                      	stosb
 23080 00002653 EBF3                    	jmp	short COPY_COMSPEC
 23081                                  COPYDONE:
 23082 00002655 30C0                    	xor	al,al		; Null terminate the string and quit
 23083 00002657 AA                      	stosb
 23084                                  	;mov	byte [comspec_flag],0
 23085 00002658 A2[E395]                	mov	[comspec_flag],al ; 0 ; 23/02/2023
 23086 0000265B 4F                      	dec	di
 23087 0000265C 26893E[8B02]            	mov	[es:ComSpec_End],di
 23088 00002661 C3                      	retn
 23089                                  
 23090                                  DISP_ENV:
 23091 00002662 8E1E[F59B]              	mov	ds,[RESSEG]
 23092 00002666 8E1E[3A04]              	mov	ds,[EnvirSeg]
 23093                                  	; assume ds:nothing
 23094 0000266A 31F6                    	xor	si,si
 23095                                  PENVLP:
 23096 0000266C 803C00                  	cmp	byte [si],0
 23097 0000266F 7497                    	jz	short ADD_NAME_JZ_RET
 23098 00002671 BF[96A3]                	mov	di,Arg_Buf
 23099                                  PENVLP2:
 23100 00002674 AC                      	lodsb
 23101 00002675 AA                      	stosb
 23102 00002676 08C0                    	or	al,al
 23103 00002678 75FA                    	jnz	short PENVLP2
 23104 0000267A BA[9991]                	mov	dx,arg_buf_ptr
 23105 0000267D 1E                      	push	ds
 23106 0000267E 06                      	push	es
 23107 0000267F 1F                      	pop	ds
 23108                                  	; assume ds:nothing
 23109 00002680 E8972D                  	call	Printf_Crlf
 23110 00002683 1F                      	pop	ds
 23111 00002684 EBE6                    	jmp	short PENVLP
 23112                                  
 23113                                  ; =============== S U B	R O U T	I N E =======================================
 23114                                  
 23115                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23116                                  delete_path:
 23117 00002686 BE[F192]                	mov	si,PATH_TEXT ; "PATH="
 23118 00002689 EB03                    	jmp	short delete_name_in_environment
 23119                                  
 23120                                  ; =============== S U B	R O U T	I N E =======================================
 23121                                  
 23122                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23123                                  delete_prompt:
 23124 0000268B BE[F692]                	mov	si,PROMPT_TEXT ; "PROMPT="
 23125                                  
 23126                                  ; ---------------------------------------------------------------------------
 23127                                  
 23128                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23129                                  delete_name_in_environment:
 23130                                  
 23131                                  ; Input: DS:SI points to a "=" terminated string
 23132                                  ; Output: carry flag is set if name not found
 23133                                  ;	  otherwise name is deleted
 23134                                  
 23135 0000268E 56                      	push	si
 23136 0000268F 1E                      	push	ds
 23137 00002690 E82C00                  	call	FIND		; ES:DI points to name
 23138 00002693 7217                    	jc	short del1
 23139 00002695 89FE                    	mov	si,di		; Save it
 23140 00002697 E8BF00                  	call	SCASB2		; Scan for the nul
 23141 0000269A 87FE                    	xchg	si,di
 23142                                  ;SR;
 23143                                  ; If we have only one env string, then the double null is lost when the last
 23144                                  ;string is deleted and we have an invalid empty environment with only a
 23145                                  ;single null. To avoid this, we will look for the double null case and then
 23146                                  ;move an extra null char.
 23147                                  ; Bugbug: The only possible problem is that the last pathstring
 23148                                  ;will be followed by a triple null. Is this really a problem?
 23149                                  
 23150                                  	; MSDOS 6.0
 23151 0000269C 26803C00                	cmp	byte [es:si],0	;null char?
 23152 000026A0 7501                    	jnz	short not_dnull	;no, we are at a double null
 23153 000026A2 4E                      	dec	si		;point at the double null
 23154                                  not_dnull:
 23155                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23156 000026A3 E86901                  	call	GETENVSIZ
 23157 000026A6 29F1                    	sub	cx,si
 23158 000026A8 06                      	push	es
 23159 000026A9 1F                      	pop	ds		; ES:DI points to name
 23160                                  				; DS:SI points to next name
 23161 000026AA F3A4                    	rep	movsb
 23162                                  del1:
 23163 000026AC 1F                      	pop	ds
 23164 000026AD 5E                      	pop	si
 23165                                  find_retn:
 23166 000026AE C3                      	retn
 23167                                  
 23168                                  ; =============== S U B	R O U T	I N E =======================================
 23169                                  
 23170                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23171                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:23E2h
 23172                                  find_path:
 23173 000026AF BE[F192]                	mov	si,PATH_TEXT ; "PATH="
 23174 000026B2 EB03                    	jmp	short find_name_in_environment
 23175                                  
 23176                                  ; =============== S U B	R O U T	I N E =======================================
 23177                                  
 23178                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23179                                  find_prompt:
 23180 000026B4 BE[F692]                	mov	si,PROMPT_TEXT ; "PROMPT="
 23181                                  
 23182                                  ; ---------------------------------------------------------------------------
 23183                                  
 23184                                  find_name_in_environment:
 23185                                  
 23186                                  ; Input: DS:SI points to a "=" terminated string
 23187                                  ; Output: ES:DI points to the arguments in the environment
 23188                                  ;	  zero is set if name not found
 23189                                  ;	  carry flag is set if name not valid format
 23190                                  
 23191 000026B7 E80500                  	call	FIND		; Find the name
 23192 000026BA 72F2                    	jc	short find_retn	; Carry means not found	
 23193 000026BC E99600                  	jmp	SCASB1		; Scan for = sign
 23194                                  
 23195                                  ; ---------------------------------------------------------------------------
 23196                                  	;nop
 23197                                  
 23198                                  ; =============== S U B	R O U T	I N E =======================================
 23199                                  
 23200                                  ; On return of FIND1, ES:DI points to beginning of name
 23201                                  
 23202                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 23203                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 23204                                  FIND:
 23205 000026BF FC                      	cld
 23206 000026C0 E84100                  	call	COUNT0		; CX = Length of name
 23207 000026C3 8E06[F59B]              	mov	es,[RESSEG]
 23208                                  	;assume es:RESGROUP
 23209 000026C7 268E06[3A04]            	mov	es,[es:EnvirSeg]
 23210                                  	;assume es:NOTHING
 23211 000026CC 31FF                    	xor	di,di
 23212                                  find1:	
 23213 000026CE 51                      	push	cx
 23214 000026CF 56                      	push	si
 23215 000026D0 57                      	push	di
 23216                                  find11:
 23217 000026D1 AC                      	lodsb
 23218                                  	; 23/02/2023 
 23219                                  	; MSDOS 6.0 (& 5.0)
 23220 000026D2 E88C00                  	call	testkanj	
 23221 000026D5 740F                    	jz	short notkanj3
 23222 000026D7 4E                      	dec	si
 23223 000026D8 AD                      	lodsw
 23224 000026D9 47                      	inc	di
 23225 000026DA 47                      	inc	di
 23226 000026DB 263B45FE                	cmp	ax,[es:di-2]
 23227 000026DF 7511                    	jne	short find12
 23228 000026E1 49                      	dec	cx
 23229 000026E2 E2ED                    	loop	find11
 23230 000026E4 EB0C                    	jmp	short find12
 23231                                  notkanj3:
 23232 000026E6 E8A200                  	call	UPCONV		; MSDOS 5.0 (& 6.0)
 23233                                  	;call	UPCONV_MAPCALL	; MSDOS 3.3
 23234 000026E9 47                      	inc	di
 23235 000026EA 263A45FF                	cmp	al,[es:di-1]
 23236 000026EE 7502                    	jne	short find12
 23237 000026F0 E2DF                    	loop	find11
 23238                                  find12:
 23239 000026F2 5F                      	pop	di
 23240 000026F3 5E                      	pop	si
 23241 000026F4 59                      	pop	cx
 23242 000026F5 74B7                    	jz	short find_retn
 23243 000026F7 51                      	push	cx
 23244 000026F8 E85E00                  	call	SCASB2		; Scan for a nul
 23245 000026FB 59                      	pop	cx
 23246 000026FC 26803D00                	cmp	byte [es:di],0
 23247 00002700 75CC                    	jnz	short find1
 23248 00002702 F9                      	stc			; Indicate not found
 23249 00002703 C3                      	retn
 23250                                  
 23251                                  ; =============== S U B	R O U T	I N E =======================================
 23252                                  
 23253                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23254                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2437h
 23255                                  COUNT0:
 23256 00002704 1E                      	push	ds
 23257 00002705 07                      	pop	es
 23258                                  	;assume es:nothing
 23259 00002706 89F7                    	mov	di,si
 23260                                  ;COUNT1:
 23261 00002708 57                      	push	di		; Count number of chars until "="
 23262 00002709 E84900                  	call	SCASB1
 23263                                  	; 23/02/2023
 23264                                  ;	jmp	short COUNTX
 23265                                  ;COUNT2:
 23266                                  ;	push	di		; Count number of chars until nul
 23267                                  ;	call	SCASB2
 23268                                  ;COUNTX:
 23269 0000270C 59                      	pop	cx
 23270 0000270D 29CF                    	sub	di,cx
 23271 0000270F 87CF                    	xchg	di,cx
 23272                                  move_name_retn:
 23273 00002711 C3                      	retn
 23274                                  
 23275                                  ; =============== S U B	R O U T	I N E =======================================
 23276                                  
 23277                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23278                                  move_name:
 23279 00002712 803C0D                  	cmp	byte [si],13 ; 0Dh
 23280 00002715 74FA                    	je	short move_name_retn
 23281 00002717 AC                      	lodsb
 23282                                  	; 23/02/2023 
 23283                                  	; MSDOS 6.0 (& 5.0)
 23284 00002718 E84600                  	call	testkanj		
 23285 0000271B 7409                    	jz	short notkanj1
 23286 0000271D E88D00                  	call	store_char
 23287 00002720 AC                      	lodsb
 23288 00002721 E88900                  	call	store_char
 23289 00002724 EBEC                    	jmp	short move_name
 23290                                  notkanj1: 
 23291 00002726 E86200                  	call	UPCONV
 23292                                  	;call	UPCONV_MAPCALL ; MSDOS 3.3
 23293 00002729 E88100                  	call	store_char
 23294 0000272C 3C3D                    	cmp	al,'='
 23295 0000272E 75E2                    	jne	short move_name
 23296                                  getarg_retn:
 23297 00002730 C3                      	retn
 23298                                  
 23299                                  ; =============== S U B	R O U T	I N E =======================================
 23300                                  
 23301                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23302                                  GETARG:
 23303 00002731 BE8000                  	mov	si,80h
 23304 00002734 AC                      	lodsb
 23305 00002735 08C0                    	or	al,al
 23306 00002737 74F7                    	jz	short getarg_retn
 23307 00002739 E84A02                  	call	scanoff
 23308 0000273C 3C0D                    	cmp	al,13 ; 0Dh
 23309                                  sdn_retn:
 23310 0000273E C3                      	retn
 23311                                  
 23312                                  ; =============== S U B	R O U T	I N E =======================================
 23313                                  
 23314                                  ; Point ES:DI to the final NULL string. Note that in an empty environment,
 23315                                  ; there is NO double NULL, merely a string that is empty.
 23316                                  
 23317                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23318                                  scan_double_null:
 23319 0000273F 8E06[F59B]              	mov	es,[RESSEG]
 23320 00002743 268E06[3A04]            	mov	es,[es:EnvirSeg]
 23321 00002748 31FF                    	xor	di,di
 23322                                  
 23323                                  ; Top cycle-point. If the string here is empty, then we are done
 23324                                  
 23325                                  sdn1:
 23326 0000274A 26803D00                	cmp	byte [es:di],0	; nul string?
 23327 0000274E 74EE                    	jz	short sdn_retn	; yep, all done
 23328 00002750 E80600                  	call	SCASB2
 23329 00002753 EBF5                    	jmp	short sdn1
 23330                                  
 23331                                  ; =============== S U B	R O U T	I N E =======================================
 23332                                  
 23333                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23334                                  SCASB1:
 23335 00002755 B03D                    	mov	al,'='		; Scan for an =
 23336 00002757 EB02                    	jmp	short SCASBX
 23337                                  
 23338                                  ; =============== S U B	R O U T	I N E =======================================
 23339                                  
 23340                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23341                                  SCASB2:
 23342 00002759 30C0                    	xor	al,al		; Scan for a nul
 23343                                  
 23344                                  ; ---------------------------------------------------------------------------
 23345                                  
 23346                                  	; 23/02/2023
 23347                                  SCASBX:
 23348 0000275B B90001                  	mov	cx,256
 23349 0000275E F2AE                    	repne	scasb
 23350 00002760 C3                      	retn
 23351                                  
 23352                                  ; =============== S U B	R O U T	I N E =======================================
 23353                                  
 23354                                  ; MSDOS 6.0
 23355                                  
 23356                                  ;Bugbug: This is Kanji stuff - put it in conditionals
 23357                                  
 23358                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23359                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:249Ah
 23360                                  
 23361                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 23362                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2872h
 23363                                  testkanj:
 23364 00002761 1E                      	push	ds			;AN000;  3/3/KK
 23365 00002762 56                      	push	si			;AN000;  3/3/KK
 23366 00002763 50                      	push	ax			;AN000;  3/3/KK
 23367 00002764 2E8E1E[F59B]            	mov	ds,[cs:RESSEG]		;AN000;  Get resident segment
 23368 00002769 C536[BA02]              	lds	si,[Dbcs_Vector_Addr]	;AN000;  get DBCS vector
 23369                                  ktlop:					;AN000;  3/3/KK
 23370 0000276D 833C00                  	cmp	word [si],0		;AN000;  end of Table 3/3/KK
 23371 00002770 740E                    	je	short notlead 		;AN000;  3/3/KK
 23372 00002772 58                      	pop	ax			;AN000;  3/3/KK
 23373 00002773 50                      	push	ax			;AN000;  3/3/KK
 23374 00002774 3A04                    	cmp	al,[si]			;AN000;  3/3/KK
 23375 00002776 7208                    	jb	short notlead 		;AN000;  3/3/KK
 23376 00002778 46                      	inc	si			;AN000;  3/3/KK
 23377 00002779 3A04                    	cmp	al,[si]			;AN000;  3/3/KK
 23378 0000277B 7607                    	jbe	short islead		;AN000;  3/3/KK
 23379 0000277D 46                      	inc	si			;AN000;  3/3/KK
 23380 0000277E EBED                    	jmp	short ktlop		;AN000;  try another range ; 3/3/KK
 23381                                  notlead:				;AN000;  3/3/KK
 23382 00002780 31C0                    	xor	ax,ax			;AN000;  set zero 3/3/KK
 23383 00002782 EB03                    	jmp	short ktret		;AN000;  3/3/KK
 23384                                  islead: 				;AN000;  3/3/KK
 23385 00002784 31C0                    	xor	ax,ax			;AN000;  reset zero 3/3/KK
 23386 00002786 40                      	inc	ax			;AN000;  3/3/KK
 23387                                  ktret:					;AN000;  3/3/KK
 23388 00002787 58                      	pop	ax			;AN000;  3/3/KK
 23389 00002788 5E                      	pop	si			;AN000;  3/3/KK
 23390 00002789 1F                      	pop	ds			;AN000;  3/3/KK
 23391 0000278A C3                      	retn				;AN000;  3/3/KK
 23392                                  
 23393                                  ; =============== S U B	R O U T	I N E =======================================
 23394                                  
 23395                                  ; MSDOS 6.0
 23396                                  
 23397                                  ; ****************************************************************
 23398                                  ; *
 23399                                  ; * ROUTINE:	 UPCONV     (ADDED BY EMG 4.00)
 23400                                  ; *
 23401                                  ; * FUNCTION:	 This routine returns the upper case equivalent of
 23402                                  ; *		 the character in AL from the file upper case table
 23403                                  ; *		 in DOS if character if above  ascii 128, else
 23404                                  ; *		 subtracts 20H if between "a" and "z".
 23405                                  ; *
 23406                                  ; * INPUT:	 AL	      char to be upper cased
 23407                                  ; *		 FUCASE_ADDR  set to the file upper case table
 23408                                  ; *
 23409                                  ; * OUTPUT:	 AL	      upper cased character
 23410                                  ; *
 23411                                  ; ****************************************************************
 23412                                  
 23413                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 23414                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:24C4h
 23415                                  
 23416                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 23417                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2A6Eh
 23418                                  
 23419                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 23420                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:289Ch
 23421                                  UPCONV:
 23422 0000278B 3C80                    	cmp	al,80h			;AN000;  see if char is > ascii 128
 23423 0000278D 7213                    	jb	short oth_fucase	;AN000;  no - upper case math
 23424 0000278F 2C80                    	sub	al,80h			;AN000;  only upper 128 chars in table
 23425 00002791 1E                      	push	ds			;AN000;
 23426 00002792 53                      	push	bx			;AN000;
 23427 00002793 8E1E[F59B]              	mov	ds,[RESSEG]		;AN000;  get resident data segment
 23428                                  	;lds	bx,dword ptr FUCase_Addr+1
 23429 00002797 C51E[B602]              	lds	bx,[FUCase_Addr+1]	;AN000;  get table address
 23430 0000279B 83C302                  	add	bx,2			;AN000;  skip over first word
 23431                                  	;xlat	ds:byte ptr [bx]	;AN000;  convert to upper case
 23432 0000279E D7                      	xlat
 23433 0000279F 5B                      	pop	bx			;AN000;
 23434 000027A0 1F                      	pop	ds			;AN000;
 23435                                  	;jmp	short upconv_end	;AN000;  we finished - exit
 23436                                  	; 10/06/2023
 23437                                  upconv_end:
 23438                                  	; 24/02/2023
 23439 000027A1 C3                      	retn
 23440                                  oth_fucase:				;AN000;
 23441 000027A2 3C61                    	cmp	al,'a' ; small_a	;AC000; if between "a" and "z",
 23442 000027A4 72FB                    	jb	short upconv_end	;AC000;    subtract 20h to get
 23443 000027A6 3C7A                    	cmp	al,'z' ; small_z	;AC000;    upper case equivalent.
 23444 000027A8 77F7                    	ja	short upconv_end	;AC000;
 23445 000027AA 2C20                    	sub	al,20h			;AC000; Change lower-case to upper
 23446                                  ;upconv_end:	; 10/06/2023		;AN000;
 23447 000027AC C3                      	retn
 23448                                  
 23449                                  ; ---------------------------------------------------------------------------
 23450                                  
 23451                                  ; MSDOS 3.3
 23452                                  
 23453                                  	; 24/02/2023
 23454                                  ;UPCONV_MAPCALL:
 23455                                  	;			; If between "a" and "z"
 23456                                  	;cmp	al,[small_a]
 23457                                  	;jb	short UPCONV_END
 23458                                  	;cmp	al,[small_z]
 23459                                  	;ja	short UPCONV_END
 23460                                  	;sub	al,20h		; Change lower-case to upper
 23461                                  ;UPCONV_END:
 23462                                  	;call	far [cs:MAP_CALL] ; (far) call to char mapping routine 
 23463                                  	;			  ; 	  for (current) country
 23464                                  	;retn
 23465                                  
 23466                                  ; =============== S U B	R O U T	I N E =======================================
 23467                                  
 23468                                  ; STORE A CHAR IN environment, GROWING IT IF NECESSARY
 23469                                  
 23470                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 23471                                  store_char:
 23472 000027AD 51                      	push	cx
 23473 000027AE 53                      	push	bx
 23474                                  
 23475                                  	; 24/02/2023
 23476                                  	;;16/10/2018
 23477                                  	; MSDOS 6.0
 23478 000027AF 06                      	push	es		;AN056;*
 23479 000027B0 1E                      	push	ds		;AN056; Save local DS
 23480 000027B1 8E1E[F59B]              	mov	ds,[RESSEG]	;AN056; Get resident segment
 23481 000027B5 8E06[3A04]              	mov	es,[EnvirSeg]	;AN056; Get environment segment
 23482 000027B9 1F                      	pop	ds		;AN056; Get local segment back
 23483                                  
 23484                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23485 000027BA E85200                  	call	GETENVSIZ
 23486 000027BD 89CB                    	mov	bx,cx		; Save room for double nul
 23487 000027BF 83EB02                  	sub	bx,2
 23488 000027C2 39DF                    	cmp	di,bx
 23489 000027C4 723F                    	jb	short store1
 23490 000027C6 50                      	push	ax
 23491 000027C7 51                      	push	cx
 23492 000027C8 53                      	push	bx		; Save Size of environment
 23493 000027C9 E847E0                  	call	FREE_TPA
 23494 000027CC 5B                      	pop	bx
 23495 000027CD 83C302                  	add	bx,2		; Recover true environment size
 23496                                  
 23497 000027D0 81FB0080                	cmp	bx,8000h	; Don't let environment grow > 32K
 23498 000027D4 7203                    	jb	short envsiz_ok
 23499                                  bad_env_size:			;AN056;
 23500 000027D6 F9                      	stc
 23501 000027D7 EB16                    	jmp	short envnoset
 23502                                  	;nop
 23503                                  envsiz_ok:
 23504 000027D9 B104                    	mov	cl,4
 23505 000027DB D3EB                    	shr	bx,cl		; Convert back to paragraphs
 23506 000027DD 43                      	inc	bx
 23507                                  	; 24/02/2023
 23508                                  	; MSDOS 6.0
 23509 000027DE 8CC1                    	mov	cx,es		;AN056; Get environment segment
 23510 000027E0 01D9                    	add	cx,bx		;AN056; Add in size of environment
 23511 000027E2 83C120                  	add	cx,20h		;AN056; Add in some TPA
 23512 000027E5 8CC8                    	mov	ax,cs		;AN056; Get the transient segment
 23513 000027E7 39C1                    	cmp	cx,ax		;AN056; Are we hitting the transient?
 23514 000027E9 73EB                    	jnb	short bad_env_size
 23515                                  				;AN056; Yes - don't do it!!!
 23516                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23517 000027EB B44A                    	mov	ah,4Ah
 23518                                  	;mov	ah,SETBLOCK ; 4Ah
 23519 000027ED CD21                    	int	21h	; DOS -	2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 23520                                  			; ES = segment address of block	to change
 23521                                  			; BX = new size	in paragraphs
 23522                                  envnoset:
 23523 000027EF 9C                      	pushf
 23524 000027F0 06                      	push	es
 23525 000027F1 8E06[F59B]              	mov	es,[RESSEG]
 23526 000027F5 E82CE0                  	call	ALLOC_TPA
 23527 000027F8 07                      	pop	es
 23528 000027F9 9D                      	popf
 23529 000027FA 59                      	pop	cx
 23530 000027FB 58                      	pop	ax
 23531                                  	; 10/06/2023
 23532 000027FC 7307                    	jnc	short store1
 23533                                  	; 24/02/2023
 23534 000027FE 07                      	pop	es ; MSDOS 6.0	;AN056;*	
 23535                                  	;jnc	short store1
 23536 000027FF BA[EE8F]                	mov	dx,ENVERR_PTR
 23537 00002802 E92105                  	jmp	cerror
 23538                                  store1:	
 23539 00002805 AA                      	stosb
 23540 00002806 26C7050000              	mov	word [es:di],0	; NULL IS AT END
 23541                                  	; 24/02/2023
 23542 0000280B 07                      	pop	es ; MSDOS 6.0	;AN056;*
 23543 0000280C 5B                      	pop	bx
 23544 0000280D 59                      	pop	cx
 23545 0000280E C3                      	retn
 23546                                  
 23547                                  ; =============== S U B	R O U T	I N E =======================================
 23548                                  
 23549                                  	; 24/02/2023
 23550                                  GETENVSIZ:
 23551                                  
 23552                                  ;Get size of environment in bytes, rounded up to paragraph boundry
 23553                                  ;ES has environment segment
 23554                                  ;Size returned in CX, all other registers preserved
 23555                                  
 23556 0000280F 06                      	push	es
 23557 00002810 50                      	push	ax
 23558 00002811 8CC0                    	mov	ax,es
 23559 00002813 48                      	dec	ax		;Point at arena
 23560 00002814 8EC0                    	mov	es,ax
 23561                                  	;mov	ax,[es:3]
 23562 00002816 26A10300                	mov	ax,[es:ARENA.size]
 23563 0000281A B104                    	mov	cl,4
 23564 0000281C D3E0                    	shl	ax,cl		;Convert to bytes
 23565 0000281E 89C1                    	mov	cx,ax
 23566 00002820 58                      	pop	ax
 23567 00002821 07                      	pop	es
 23568                                  getenvsiz_retn:
 23569 00002822 C3                      	retn
 23570                                  
 23571                                  ; =============== S U B	R O U T	I N E =======================================
 23572                                  
 23573                                  	; 24/02/2023
 23574                                  RestUDir1:
 23575 00002823 1E                      	push	ds
 23576 00002824 8E1E[F59B]              	mov	ds,[RESSEG]
 23577 00002828 803E[A102]00            	cmp	byte [RestDir],0
 23578 0000282D 1F                      	pop	ds
 23579 0000282E 74F2                    	jz	short getenvsiz_retn
 23580                                  
 23581                                  ; =============== S U B	R O U T	I N E =======================================
 23582                                  
 23583                                  	; 24/02/2023
 23584                                  RestUDir:
 23585 00002830 BA[D79A]                	mov	dx,USERDIR1
 23586 00002833 B43B                    	mov	ah,3Bh
 23587                                  	;mov	ah,CHDir ; 3Bh
 23588 00002835 CD21                    	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 23589                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 23590 00002837 30C0                    	xor	al,al
 23591                                  	;call	SETREST
 23592                                  	;retn
 23593                                  	; 24/02/2023
 23594 00002839 E9DA08                  	jmp	SETREST
 23595                                  
 23596                                  ;============================================================================
 23597                                  ; TENV2.ASM, MSDOS 6.0, 1991
 23598                                  ;============================================================================
 23599                                  ; 07/10/2018 - Retro DOS v3.0
 23600                                  
 23601                                  ; TITLE	Part6 COMMAND Transient routines.
 23602                                  
 23603                                  ;	Environment utilities and misc. routines
 23604                                  
 23605                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 18C2h
 23606                                  
 23607                                  ; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23608                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2577h
 23609                                  
 23610                                  ; ---------------------------------------------------------------------------
 23611                                  
 23612                                  ; ****************************************************************
 23613                                  ; *
 23614                                  ; * ROUTINE:	 $CHDIR
 23615                                  ; *
 23616                                  ; * FUNCTION:	 Entry point for CHDIR command. Parse the command
 23617                                  ; *		 line. If path is found, CHDIR to path. If a drive
 23618                                  ; *		 letter is found, get and display the current dir
 23619                                  ; *		 of the specified drive. If nothing is found, get
 23620                                  ; *		 and display the current dir of the default drive.
 23621                                  ; *
 23622                                  ; * INPUT:	 command line at offset 81H
 23623                                  ; *
 23624                                  ; * OUTPUT:	 none
 23625                                  ; *
 23626                                  ; ****************************************************************
 23627                                  
 23628                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23629                                  
 23630                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 23631                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2B21h
 23632                                  
 23633                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 23634                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:294Fh
 23635                                  
 23636                                  _$CHDIR:
 23637                                  	; MSDOS 6.0
 23638 0000283C BE8100                  	mov	si,81h
 23639 0000283F BF[9196]                	mov	di,PARSE_CHDIR
 23640                                  				;AN000; Get address of PARSE_CHDIR
 23641 00002842 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 23642 00002844 31D2                    	xor	dx,dx		;AN000;
 23643 00002846 E812FD                  	call	Parse_With_Msg	;AC018; call parser
 23644                                  	
 23645                                  	;cmp	ax,-1
 23646                                  	;;cmp	ax,END_OF_LINE	;AC000; are we at end of line?
 23647                                  	;je	short bwdj	; No args
 23648                                  	;;cmp	ax,0
 23649                                  	;;cmp	ax,RESULT_NO_ERROR
 23650                                  	;			;AC000; did we have an error?
 23651                                  	;or	ax,ax ; ax = 0 ?
 23652                                  	;jnz	short ChDirErr	;AC018; yes - exit
 23653                                  	
 23654                                  	; 10/06/2023
 23655 00002849 40                      	inc	ax	; cmp ax,-1
 23656 0000284A 7414                    	jz	short bwdj ; 0FFFFh -> 0
 23657 0000284C 48                      	dec	ax	; cmp ax,0
 23658 0000284D 756F                    	jnz	short ChDirErr ; 1 -> 0
 23659                                  	; ax = 0
 23660                                  
 23661                                  	;cmp	byte [PARSE1_TYPE],6
 23662 0000284F 803E[EBA5]06            	cmp	byte [PARSE1_TYPE],result_drive
 23663                                  				;AC000; was a drive entered?
 23664 00002854 7511                    	jne	short REALCD	; no
 23665                                  
 23666                                  ; D: was found. See if there is anything more.
 23667                                  
 23668 00002856 BF[9196]                	mov	di,PARSE_CHDIR
 23669                                  				;AC000; get address of parse_chdir
 23670 00002859 31D2                    	xor	dx,dx		;AC000;
 23671 0000285B E8E7FC                  	call	parse_check_eol ;AC000; call parser
 23672 0000285E 755E                    	jnz	short ChDirErr	;AC000;
 23673                                  bwdj:
 23674 00002860 E88AF9                  	call	build_dir_for_chdir
 23675                                  				; Drive only specified
 23676 00002863 E81301                  	call	CRLF2
 23677                                  chdir_retn:
 23678 00002866 C3                      	retn
 23679                                  
 23680                                  	; 24/02/2023
 23681                                  	; MSDOS 3.3
 23682                                  	;mov	ax,[COMSW]
 23683                                  	;or	ax,[ALLSWITCH]
 23684                                  	;mov	dx,BADPARMPTR
 23685                                  	;jnz	short CHDIR_ERR
 23686                                  	;mov	si,81h
 23687                                  	;call	SCANOFF
 23688                                  	;cmp	al,0Dh		; are we at end of line?
 23689                                  	;je	short BWDJ	; No args
 23690                                  	;inc	si
 23691                                  	;lodsb
 23692                                  	;cmp	al,':'
 23693                                  	;jne	short REALCD
 23694                                  	;push	si
 23695                                  	;call	SCANOFF
 23696                                  	;pop	si
 23697                                  	;cmp	al,0Dh		; was a drive entered?
 23698                                  	;jne	short REALCD	; no
 23699                                  ;BWDJ:
 23700                                  	;call	BUILD_DIR_FOR_CHDIR ; Drive only specified
 23701                                  	;call	CRLF2
 23702                                  ;CHDIR_RETN:
 23703                                  	;retn
 23704                                  
 23705                                  	; 24/02/2023
 23706                                  	; MSDOS 6.0
 23707                                  REALCD:
 23708 00002867 56                      	push	si		;AN000; save position in line
 23709 00002868 C536[EFA5]              	lds	si,[PARSE1_ADDR]
 23710                                  				;AN000; get address of filespec
 23711 0000286C E86908                  	call	Move_To_SrcBuf	;AN000; move to srcbuf
 23712 0000286F 5E                      	pop	si		;AN000; restore position in line
 23713 00002870 BF[9196]                	mov	di,PARSE_CHDIR	;AC000; get address of parse_chdir
 23714 00002873 31D2                    	xor	dx,dx		;AC000;
 23715 00002875 E8CDFC                  	call	parse_check_eol ;AC000; call parser
 23716 00002878 7544                    	jnz	short ChDirErr	;AC000;
 23717                                  	
 23718 0000287A E8A206                  	call	SETPATH
 23719 0000287D F606[BD9D]02            	test	byte [DestInfo],2
 23720 00002882 7519                    	jnz	short BadChDir
 23721                                  
 23722                                  	; 26/04/2023
 23723 00002884 B43B                    	mov	ah,3Bh
 23724                                  	;mov	ah,CHDir
 23725                                  	;int	21h
 23726                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23727 00002886 E831DD                  	call    int_21h_indirect
 23728 00002889 73DB                    	jnc	short chdir_retn
 23729                                  	
 23730 0000288B E8BDF7                  	call	get_ext_error_number
 23731                                  				;AN022; get the extended error
 23732 0000288E 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ; 3
 23733                                  				;AN022; see if path not found
 23734 00002891 740A                    	je	short BadChDir	;AN022; yes - issue old message
 23735                                  ;SR;
 23736                                  ; We want to issue "Invalid Directory" message even if the path is valid
 23737                                  ;but is not a directory. The extended error returns "Access denied" which
 23738                                  ;is kind of confusing. Issue the old message if access denied error is 
 23739                                  ;returned
 23740                                  
 23741 00002893 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 23742 00002896 7405                    	je	short BadChDir
 23743                                  	
 23744 00002898 E8A200                  	call	set_ext_error_subst ;AN022;
 23745 0000289B EB21                    	jmp	short ChDirErr	;AN022;
 23746                                  
 23747                                  BadChDir:
 23748 0000289D BA[3791]                	mov	dx,badcd_ptr
 23749                                  ;ChDirErr:
 23750                                  ;	call	std_eprintf
 23751                                  ;mkdir_retn:
 23752                                  	;retn
 23753                                  	; 24/02/2023
 23754 000028A0 EB1C                    	jmp	short ChDirErr	;AN022;
 23755                                  
 23756                                  	; 24/02/2023
 23757                                  	; MSDOS 3.3
 23758                                  ;REALCD:
 23759                                  	;call	SETPATH
 23760                                  	;test	byte [DESTINFO],2
 23761                                  	;jnz	short BADCHDIR
 23762                                  	;mov	ah,CHDir ; 3Bh
 23763                                  	;int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 23764                                  	;		; DS:DX	-> ASCIZ directory name	(may include drive)
 23765                                  	;jnc	short CHDIR_RETN
 23766                                  ;BADCHDIR:
 23767                                  	;mov	dx,BADCDPTR
 23768                                  ;CHDIR_ERR:
 23769                                  	;call	STD_EPRINTF
 23770                                  ;MKDIR_RETN:
 23771                                  	;retn
 23772                                  
 23773                                  ; =============== S U B	R O U T	I N E =======================================
 23774                                  
 23775                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23776                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:25E2h
 23777                                  
 23778                                  	; 11/06/2023 - Retro DOS v4.2
 23779                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2B8Ch
 23780                                  
 23781                                  	; 04/08/2024 - Retro DOS v5.0
 23782                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:29BBh
 23783                                  
 23784                                  _$MKDIR:
 23785                                  	; MSDOS 6.0
 23786 000028A2 E86700                  	call	SETRMMK
 23787 000028A5 7217                    	jc	short MkDirErr
 23788                                  
 23789 000028A7 B439                    	mov	ah,39h
 23790                                  	;mov	ah,MKDIR
 23791                                  	;int	21h
 23792                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23793 000028A9 E80EDD                  	call    int_21h_indirect
 23794 000028AC 7313                    	jnc	short mkdir_retn
 23795                                  
 23796 000028AE E89AF7                  	call	get_ext_error_number	
 23797                                  				;AN022; get the extended error
 23798 000028B1 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ; 3
 23799                                  				;AN022; see if path not found
 23800 000028B4 742C                    	je	short MD_other_err
 23801                                  				;AN022; yes - issue old message
 23802 000028B6 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 23803                                  				;AN022; access denied?
 23804 000028B9 7407                    	je	short badmderr	;AN022; yes - see if file exists
 23805                                  	
 23806 000028BB E87F00                  	call	set_ext_error_subst
 23807                                  				;AN022;
 23808                                  	;jmp	short MkDirerr	;AC022; yes - go print it
 23809                                  	; 24/02/2023
 23810                                  ChDirErr:
 23811                                  MkDirErr:
 23812                                  RmDirErr:
 23813 000028BE E85F2B                  	call	std_eprintf
 23814                                  mkdir_retn:
 23815                                  rmdir_retn:
 23816 000028C1 C3                      	retn
 23817                                  	
 23818                                  badmderr:
 23819 000028C2 BA[2399]                	mov	dx,SRCXNAME	;AN006; Set Disk transfer address
 23820 000028C5 B41A                    	mov	ah,1Ah
 23821                                  	;mov	ah,Set_DMA	;AN006;
 23822                                  	;int	21h		;AN006;
 23823                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23824 000028C7 E8F0DC                  	call    int_21h_indirect
 23825                                  	
 23826 000028CA B44E                    	mov	ah,4Eh
 23827                                  	;mov	ah,Find_First	;AN006; see if file/dir exists
 23828                                  	;mov	cx,10h
 23829 000028CC B91000                  	mov	cx,ATTR_DIRECTORY
 23830                                  				;AN006;   search for directory
 23831                                  	;int	21h		;AN006;
 23832                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23833 000028CF E8E8DC                  	call    int_21h_indirect
 23834 000028D2 720E                    	jc	short MD_other_err
 23835                                  				;AN006; doesn't exist - must be something else
 23836                                  	;;mov	dl,SRCXNAME.find_buf_attr
 23837                                  				;AN006; we found a file/dir
 23838                                  	;mov	dl,[SRCXNAME+21] 
 23839 000028D4 8A16[3899]              	mov	dl,[SRCXNAME+FIND_BUF.ATTR]
 23840 000028D8 F6C210                  	test	dl,ATTR_DIRECTORY
 23841                                  				;AN006; was it a directory?
 23842 000028DB 7405                    	jz	short MD_other_err
 23843                                  				;AN006; no - must have been a file
 23844 000028DD BA[4692]                	mov	dx,MD_EXISTS_PTR
 23845                                  				;AN006; set up already exists error
 23846 000028E0 EBDC                    	jmp	short MkDirErr	;AN006; make sure we didn't have network error
 23847                                  MD_other_err:			;AN006;
 23848 000028E2 BA[3A91]                	mov	dx,badmkd_ptr
 23849                                  ;MkDirErr:
 23850                                  	;call	std_eprintf
 23851                                  	;retn
 23852                                  	; 24/02/2023
 23853 000028E5 EBD7                    	jmp	short MkDirErr
 23854                                  
 23855                                  	; 24/02/2023
 23856                                  	; MSDOS 3.3
 23857                                  	;call	SETRMMK
 23858                                  	;jb	short MKDIRERR
 23859                                  	;mov	ah,MKDIR ; 39h
 23860                                  	;int	21h	; DOS -	2+ - CREATE A SUBDIRECTORY (MKDIR)
 23861                                  	;		; DS:DX	-> ASCIZ pathname (may include drive)
 23862                                  	;jnc	short MKDIR_RETN
 23863                                  	;mov	dx,BADMKDPTR
 23864                                  	;call	GET_EXT_ERR_NUMBER
 23865                                  ;MKDIRERR:
 23866                                  	;call	STD_EPRINTF
 23867                                  	;retn
 23868                                  
 23869                                  ; =============== S U B	R O U T	I N E =======================================
 23870                                  
 23871                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23872                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2656h
 23873                                  	
 23874                                  	; 11/06/2023 - Retro DOS v4.2
 23875                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2C00h
 23876                                  	
 23877                                  	; 04/08/2024 - Retro DOS v5.0
 23878                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2A32h
 23879                                  
 23880                                  _$RMDIR:
 23881 000028E7 E82200                  	call	SETRMMK
 23882 000028EA 72D2                    	jb	short RmDirErr
 23883 000028EC 7519                    	jnz	short badrderr
 23884                                  
 23885 000028EE B43A                    	mov	ah,3Ah
 23886                                  	;mov	ah,RMDIR ; 3Ah
 23887                                  	;int	21h	; DOS -	2+ - REMOVE A DIRECTORY	ENTRY (RMDIR)
 23888                                  			; DS:DX	-> ASCIZ pathname (may include drive)
 23889                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23890 000028F0 E8C7DC                  	call    int_21h_indirect
 23891 000028F3 73CC                    	jnc	short rmdir_retn ; 24/02/2023
 23892                                  
 23893                                  	; 24/02/2023
 23894                                  	; MSDOS 6.0
 23895 000028F5 E853F7                  	call	get_ext_error_number
 23896                                  				;AN022; get the extended error
 23897 000028F8 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ; 3
 23898                                  				;AN022; see if path not found
 23899 000028FB 740A                    	je	short badrderr	;AN022; yes - issue old message
 23900 000028FD 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 23901                                  				;AN022; access denied?
 23902 00002900 7405                    	je	short badrderr	;AN022; yes - issue old message
 23903                                  
 23904 00002902 E83800                  	call	set_ext_error_subst
 23905                                  				;AN022;
 23906 00002905 EBB7                    	jmp	short RmDirErr	;AC022; yes - go print it
 23907                                  
 23908                                  	; MSDOS 6.0
 23909                                  badrderr:
 23910                                  	; 24/02/2023
 23911 00002907 BA[3D91]                	mov	dx,badrmd_ptr
 23912 0000290A EBB2                    	jmp	short RmDirErr
 23913                                  ;RmDirErr:
 23914                                  	;call	std_eprintf
 23915                                  ;;rmdir_retn
 23916                                  	;retn
 23917                                  
 23918                                  	; 24/02/2023
 23919                                  	; MSDOS 3.3
 23920                                  	;mov	dx,BADRMDPTR
 23921                                  	;call	GET_EXT_ERR_NUMBER ; MSDOS 3.3
 23922                                  ;RMDIRERR:
 23923                                  	;call	STD_EPRINTF
 23924                                  ;RMDIR_RETN:
 23925                                  	;retn
 23926                                  
 23927                                  ; =============== S U B	R O U T	I N E =======================================
 23928                                  
 23929                                  ; 	<Common MkDir/RmDir set up code>
 23930                                  ;****************************************************************
 23931                                  ;*
 23932                                  ;* ROUTINE:	SETRMMK
 23933                                  ;*
 23934                                  ;* FUNCTION:	Parse routine for the internal MKDIR and RMDIR
 23935                                  ;*		commands. Parses the command line for a required
 23936                                  ;*		filespec.
 23937                                  ;*
 23938                                  ;* INPUT:	command line at offset 81H
 23939                                  ;*
 23940                                  ;* OUTPUT:	carry clear
 23941                                  ;*		    DS:DX points to ASCIIZ argument
 23942                                  ;*		carry set
 23943                                  ;*		    DS:DX has error message pointer
 23944                                  ;*
 23945                                  ;****************************************************************
 23946                                  
 23947                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23948                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2624h
 23949                                  	
 23950                                  	; 11/06/2023 - Retro DOS v4.2
 23951                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2BCEh
 23952                                  
 23953                                  	; 04/08/2024 - Retro DOS v5.0
 23954                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2A00h
 23955                                  
 23956                                  SETRMMK:
 23957                                  	; MSDOS 6.0
 23958 0000290C BE8100                  	mov	si,81h
 23959 0000290F BF[8896]                	mov	di,PARSE_MRDIR 	;AN000; Get address of PARSE_MRDIR
 23960 00002912 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 23961 00002914 31D2                    	xor	dx,dx		;AN000;
 23962                                  	;invoke	Parse_With_Msg	;AC000; call parser
 23963 00002916 E842FC                  	call	Parse_With_Msg
 23964                                  	;cmp	ax,0
 23965                                  	;cmp	ax,RESULT_NO_ERROR
 23966 00002919 09C0                    	or	ax,ax ; 0 ?	;AC000; did we have an error?
 23967 0000291B 7519                    	jnz	short noargerr	;AC000; yes - exit
 23968                                  
 23969 0000291D BF[2399]                	mov	di,SRCXNAME
 23970                                  				;AN000; get address of srcxname
 23971 00002920 57                      	push	di		;AN000; save address
 23972 00002921 56                      	push	si		;AN000; save position in line
 23973 00002922 C536[EFA5]              	lds	si,[PARSE1_ADDR]
 23974                                  				;AN000; get address of path
 23975                                  mrdir_move_filename:		;AN000; put filespec in srcxname
 23976 00002926 AC                      	lodsb			;get a char from buffer
 23977 00002927 AA                      	stosb			;AN000; store in srcxname
 23978                                  	;cmp	al,0
 23979                                  	;cmp	al,END_OF_LINE_OUT
 23980 00002928 20C0                    	and	al,al ; 0 ?	;AC000; it char a terminator?
 23981 0000292A 75FA                    	jnz	short mrdir_move_filename
 23982                                  				;AC000; no - keep moving
 23983 0000292C 5E                      	pop	si		;AN000; get line position back
 23984                                  
 23985                                  ; we have scanned an argument.	See if any args beyond.
 23986                                  
 23987 0000292D BF[8896]                	mov	di,PARSE_MRDIR
 23988 00002930 E812FC                  	call	parse_check_eol ;AC000; are we at end of line?
 23989 00002933 5A                      	pop	dx		;AC000; get address of SRCXNAME
 23990                                  	;retz			;yes - return no error
 23991 00002934 7406                    	jz	short setrmmk_retn
 23992                                  noargerr:
 23993 00002936 BA[D78F]                	mov	dx,extend_buf_ptr
 23994                                  				;AC000; get extended message pointer
 23995 00002939 31C0                    	xor	ax,ax
 23996 0000293B F9                      	stc
 23997                                  setrmmk_retn:
 23998 0000293C C3                      	retn
 23999                                  
 24000                                  	; 24/02/2023
 24001                                  	; MSDOS 3.3
 24002                                  ;SETRMMK:
 24003                                  	;mov	si,81h
 24004                                  	;call	SCANOFF
 24005                                  	;cmp	al,0Dh
 24006                                  	;je	short NOARGERR
 24007                                  	;mov	dx,si
 24008                                  ;SETRMMK1:
 24009                                  	;lodsb
 24010                                  	;call	DELIM
 24011                                  	;jz	short SETRMMK3
 24012                                  	;cmp	al,0Dh
 24013                                  	;jne	short SETRMMK1
 24014                                  	;mov	byte [si-1],0
 24015                                  ;SETRMMK2:
 24016                                  	;retn
 24017                                  ;SETRMMK3:
 24018                                  	;mov	byte [si-1],0
 24019                                  	;push	si
 24020                                  	;call	SCANOFF
 24021                                  	;pop	si
 24022                                  	;cmp	al,0Dh
 24023                                  	;je	short SETRMMK2
 24024                                  ;NOARGERR:
 24025                                  	;mov	dx,BADARGSPTR
 24026                                  	;xor	ax,ax
 24027                                  	;stc
 24028                                  ;SETRMMK_RETN:
 24029                                  	;retn
 24030                                  
 24031                                  ; =============== S U B	R O U T	I N E =======================================
 24032                                  
 24033                                  ; MSDOS 6.0
 24034                                  
 24035                                  ;****************************************************************
 24036                                  ;*
 24037                                  ;* ROUTINE:	Set_ext_error_subst
 24038                                  ;*
 24039                                  ;* FUNCTION:	Sets up substitution for extended error
 24040                                  ;*
 24041                                  ;* INPUT:	AX - extended error number
 24042                                  ;*		DX - offset of string
 24043                                  ;*
 24044                                  ;* OUTPUT:	Extend_Buf_Ptr set up for STD_EPRINTF
 24045                                  ;*
 24046                                  ;****************************************************************
 24047                                  
 24048                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24049                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:267Ch
 24050                                  set_ext_error_subst:
 24051                                  	;mov	byte [msg_disp_class],1
 24052 0000293D C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class
 24053                                  					;AN022; set up extended error msg class
 24054 00002942 8916[A09D]              	mov	[string_ptr_2],dx 	;AN022; get address of failed string
 24055                                  	;mov	byte [extend_buf_sub],1
 24056 00002946 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst
 24057                                  	;AN022; put number of subst in control block
 24058 0000294B BA[D78F]                	mov	dx,extend_buf_ptr 	;AN022; get extended message pointer
 24059 0000294E A3[D78F]                	mov	[extend_buf_ptr],ax	;AN022; get message number in control block
 24060                                  savudir_err_retn: ; 24/02/2023
 24061 00002951 C3                      	retn				;AN022; return
 24062                                  
 24063                                  ; =============== S U B	R O U T	I N E =======================================
 24064                                  
 24065                                  ; <SavUDir - preserve the users current directory on a particular drive>
 24066                                  
 24067                                  ; SavUDir - move the user's current directory on a drive into UserDir1
 24068                                  ; SavUDir1 - move the user's current directory on a drive into a specified
 24069                                  ;   buffer
 24070                                  ;
 24071                                  ;   Inputs:	DL has 1-based drive number
 24072                                  ;		ES:DI has destination buffer (SavUDir1 only)
 24073                                  ;   Outputs:	Carry Clear
 24074                                  ;		    DS = TranGroup
 24075                                  ;		Carry Set
 24076                                  ;		    AX has error code
 24077                                  ;   Registers Modified: AX, SI
 24078                                  
 24079                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24080                                  SAVUDIR:
 24081 00002952 BF[D79A]                	mov	di,USERDIR1
 24082                                  ; --------------
 24083                                  SAVUDIR1:
 24084 00002955 88D0                    	mov	al,dl
 24085 00002957 0440                    	add	al,'@' ; 40h
 24086 00002959 3C40                    	cmp	al,'@' ; 40h
 24087 0000295B 7506                    	jne	short GOTUDRV
 24088 0000295D 0206[079C]              	add	al,[CURDRV]
 24089 00002961 FEC0                    	inc	al		; A = 1
 24090                                  GOTUDRV:
 24091 00002963 AA                      	stosb
 24092 00002964 8A26[FA9B]              	mov	ah,[DIRCHAR]
 24093 00002968 B03A                    	mov	al,':' ; 3Ah
 24094 0000296A AB                      	stosw
 24095 0000296B 06                      	push	es
 24096 0000296C 1F                      	pop	ds
 24097 0000296D 89FE                    	mov	si,di
 24098 0000296F B447                    	mov	ah,47h ; 24/02/2023
 24099                                  	;mov	ah,CURRENT_DIR	; 47h
 24100                                  	;int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 24101                                  			; DL = drive (0=default,1=A,etc.)
 24102                                  			; DS:SI	points to 64-byte buffer area
 24103                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 24104 00002971 E846DC                  	call	int_21h_indirect
 24105 00002974 72DB                    	jc	short savudir_err_retn ; 24/02/2023
 24106 00002976 0E                      	push	cs
 24107 00002977 1F                      	pop	ds
 24108 00002978 C3                      	retn
 24109                                  
 24110                                  ; =============== S U B	R O U T	I N E =======================================
 24111                                  
 24112                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24113                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:26B7h
 24114                                  CRLF2:
 24115 00002979 52                      	push	dx
 24116 0000297A BA[FA91]                	mov	dx,acrlf_ptr
 24117 0000297D 1E                      	push	ds
 24118 0000297E 0E                      	push	cs
 24119 0000297F 1F                      	pop	ds
 24120 00002980 E8A52A                  	call	std_printf
 24121 00002983 1F                      	pop	ds
 24122 00002984 5A                      	pop	dx
 24123 00002985 C3                      	retn
 24124                                  
 24125                                  ; =============== S U B	R O U T	I N E =======================================
 24126                                  
 24127                                  ; These routines (SCANOFF, DELIM) are called in batch processing when DS
 24128                                  ; may NOT be TRANGROUP
 24129                                  
 24130                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24131                                  scanoff:
 24132 00002986 AC                      	lodsb
 24133 00002987 E80400                  	call	DELIM
 24134 0000298A 74FA                    	jz	short scanoff
 24135 0000298C 4E                      	dec	si		; Point to first non-delimiter
 24136                                  scanoff_retn:
 24137 0000298D C3                      	retn
 24138                                  
 24139                                  ; =============== S U B	R O U T	I N E =======================================
 24140                                  
 24141                                  ; Input:    AL is character to classify
 24142                                  ; Output:   Z set if delimiter
 24143                                  ;	    NZ set otherwise
 24144                                  ; Registers modified: none
 24145                                  
 24146                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24147                                  DELIM:
 24148 0000298E 3C20                    	cmp	al,' '	 ;20h
 24149 00002990 74FB                    	je	short scanoff_retn
 24150 00002992 3C3D                    	cmp	al,'='  ; 3Dh
 24151 00002994 74F7                    	je	short scanoff_retn
 24152 00002996 3C2C                    	cmp	al,','	; 2Ch
 24153 00002998 74F3                    	je	short scanoff_retn
 24154 0000299A 3C3B                    	cmp	al,';'	 ;3Bh
 24155 0000299C 74EF                    	je	short scanoff_retn
 24156 0000299E 3C09                    	cmp	al,9		; Check for TAB character
 24157 000029A0 74EB                    	je	short scanoff_retn
 24158 000029A2 3C0A                    	cmp	al,0Ah		; Check for line feed character - BAS
 24159 000029A4 C3                      	retn
 24160                                  
 24161                                  
 24162                                  ; =============== S U B	R O U T	I N E =======================================
 24163                                  
 24164                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24165                                  FCB_TO_ASCZ:			
 24166                                  	; Convert DS:SI to ASCIZ ES:DI
 24167 000029A5 B90800                  	mov	cx,8
 24168                                  MAINNAME:
 24169 000029A8 AC                      	lodsb
 24170 000029A9 3C20                    	cmp	al,' ' ; 20h
 24171 000029AB 7401                    	jz	short SKIPSPC
 24172 000029AD AA                      	stosb
 24173                                  SKIPSPC:
 24174 000029AE E2F8                    	loop	MAINNAME
 24175 000029B0 AC                      	lodsb
 24176 000029B1 3C20                    	cmp	al,' '
 24177 000029B3 740F                    	je	short GOTNAME
 24178 000029B5 88C4                    	mov	ah,al
 24179                                  	; 24/02/2023
 24180 000029B7 B02E                    	mov	al,'.' ; 2Eh  ; MSDOS 5.0 (& 6.0)
 24181                                  	;mov	al,[DOT_CHR]  ; MSDOS 3.3
 24182                                  	;stosb
 24183                                  	;xchg	al,ah
 24184                                  	;stosb
 24185                                  	; 24/02/2023
 24186 000029B9 AB                      	stosw
 24187 000029BA B102                    	mov	cl,2
 24188                                  EXTNAME:
 24189 000029BC AC                      	lodsb
 24190 000029BD 3C20                    	cmp	al,' '
 24191 000029BF 7403                    	je	short GOTNAME
 24192 000029C1 AA                      	stosb
 24193 000029C2 E2F8                    	loop	EXTNAME
 24194                                  GOTNAME:
 24195 000029C4 30C0                    	xor	al,al
 24196 000029C6 AA                      	stosb
 24197                                  STRCOMP_RETN:
 24198 000029C7 C3                      	retn
 24199                                  
 24200                                  ; =============== S U B	R O U T	I N E =======================================
 24201                                  
 24202                                  ; Compare ASCIZ DS:SI with ES:DI.
 24203                                  ; SI,DI destroyed.
 24204                                  
 24205                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24206                                  STRCOMP:	
 24207 000029C8 A6                      	cmpsb
 24208 000029C9 75FC                    	jnz	short STRCOMP_RETN ; Strings not equal
 24209 000029CB 807CFF00                	cmp	byte [si-1],0	; Hit NUL terminator?
 24210                                  	;jz	short STRCOMP_RETN ; Yes, strings equal
 24211                                  	;jmp	short STRCOMP	; Equal so far, keep going
 24212                                  	; 24/02/2023
 24213 000029CF 75F7                    	jnz	short STRCOMP
 24214 000029D1 C3                      	retn
 24215                                  
 24216                                  ; =============== S U B	R O U T	I N E =======================================
 24217                                  
 24218                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 24219                                  CRPRINT:
 24220 000029D2 50                      	push	ax
 24221                                  	;mov	al,13	; 0Dh
 24222 000029D3 B00D                    	mov	al,0Dh
 24223 000029D5 51                      	push	cx
 24224 000029D6 57                      	push	di
 24225 000029D7 89D7                    	mov	di,dx
 24226 000029D9 B9FFFF                  	mov	cx,65535 ; 0FFFFh
 24227 000029DC 06                      	push	es
 24228 000029DD 1E                      	push	ds
 24229 000029DE 07                      	pop	es
 24230 000029DF F2AE                    	repne	scasb		; LOOK FOR TERMINATOR
 24231 000029E1 C645FF00                	mov	byte [di-1],0	; nul terminate the string
 24232 000029E5 07                      	pop	es
 24233 000029E6 8916[A09D]              	mov	[string_ptr_2],dx
 24234                                  	;mov	dx,STRINGBUF2PTR  ; MSDOS 3.3 (Retro DOS v3.0 COMMAND.COM)
 24235 000029EA BA[DF91]                	mov	dx,string_buf_ptr ; MSDOS 5.0 (& 6.0)
 24236 000029ED E8382A                  	call	std_printf
 24237                                  	;mov	byte [di-1],13
 24238 000029F0 C645FF0D                	mov	byte [di-1],0Dh	; now put the CR back
 24239 000029F4 7204                    	jb	short error_output
 24240 000029F6 5F                      	pop	di
 24241 000029F7 59                      	pop	cx
 24242 000029F8 58                      	pop	ax
 24243 000029F9 C3                      	retn
 24244                                  
 24245                                  ; ---------------------------------------------------------------------------
 24246                                  
 24247                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24248                                  error_output:
 24249 000029FA 0E                      	push	cs
 24250 000029FB 1F                      	pop	ds
 24251 000029FC 8E06[F59B]              	mov	es,[RESSEG]
 24252 00002A00 BA[EB8F]                	mov	dx,NOSPACE_PTR
 24253 00002A03 26803E[1303]00          	cmp	byte [es:PipeFlag],0
 24254 00002A09 7406                    	jz	short go_to_error
 24255 00002A0B E89909                  	call	PipeOff
 24256 00002A0E BA[5D91]                	mov	dx,PIPEEMES_PTR
 24257                                  go_to_error:
 24258 00002A11 E91203                  	jmp	cerror
 24259                                  
 24260                                  ; =============== S U B	R O U T	I N E =======================================
 24261                                  
 24262                                  ;---- Mod for path invocation ----
 24263                                  
 24264                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24265                                  pathchrcmp:
 24266                                  	; 18/03/2023	
 24267                                  	;push	ax
 24268                                  	;mov	ah,'/' ; 2Fh
 24269                                  	;cmp	[SWITCHAR],ah
 24270 00002A14 803E[F99B]2F            	cmp	byte [SWITCHAR],'/' ; 2Fh
 24271 00002A19 7404                    	je	short noslasht
 24272 00002A1B 3C2F                    	cmp	al,'/'
 24273 00002A1D 7402                    	je	short pccont
 24274                                  noslasht:
 24275 00002A1F 3C5C                    	cmp	al,'\' ; 5Ch
 24276                                  pccont:	
 24277                                  	;pop	ax
 24278 00002A21 C3                      	retn
 24279                                  
 24280                                  ; =============== S U B	R O U T	I N E =======================================
 24281                                  
 24282                                  ; PATHCRUNCH -
 24283                                  ;
 24284                                  ; ENTRY FCB (in PSP) contains drive # to crunch on
 24285                                  ;       PathPos = ptr to string with pathname in it
 24286                                  ;       PathCnt = length of string
 24287                                  ;
 24288                                  ; EXIT  PathPos = ptr after pathname (w/ NULL) in string
 24289                                  ;       PathCnt = length left in string
 24290                                  ;       DestIsDir = nonzero if pathname delimiter char's found in pathname
 24291                                  ;       DestInfo<bit1> = set if wildcard char's found in pathname
 24292                                  ;       If path crunched successfully,
 24293                                  ;         CY = clear
 24294                                  ;         Current directory is changed to directory in pathname
 24295                                  ;         UserDir1 contains previous directory for use by RestUDir
 24296                                  ;         RestDir = nonzero to flag later restoration of user's dir
 24297                                  ;         DestTail = ptr to beginning of filename
 24298                                  ;         If filename found in pathname,
 24299                                  ;           ZR = clear
 24300                                  ;           FCB filename fields contain filename
 24301                                  ;         If filename not found (pure directory path),
 24302                                  ;           ZR = set
 24303                                  ;           FCB filename fields are wildcarded with ?'s
 24304                                  ;       If pathcrunch failed (no ChDir's worked),
 24305                                  ;         CY = set
 24306                                  ;         Msg_Numb = extended error code
 24307                                  ;
 24308                                  ; NOTE  DIR asks PathCrunch to forego parsing the filename into the
 24309                                  ;       FCB by setting DirFlag. In this case, the FCB is returned
 24310                                  ;       with the filename wildcarded.
 24311                                  
 24312                                  	; 25/02/2023 - Retro DOS v4.0 (& v4.1)
 24313                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2767h
 24314                                  
 24315                                  	; 11/06/2023 - Retro DOS v4.2
 24316                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2D11h
 24317                                  
 24318                                  	; 04/08/2024 - Retro DOS v5.0
 24319                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2B45h
 24320                                  PathCrunch:
 24321                                  	; MSDOS 6.0
 24322 00002A22 C706[349F]0000          	mov     word [Msg_Numb],0
 24323                                  				;AN022; Set up message flag
 24324                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24325                                  	;mov	dl,[5Ch]
 24326 00002A28 8A165C00                	mov	dl,[FCB]	; DL = drive # (1 = A)
 24327 00002A2C E823FF                  	call	SAVUDIR		; save current directory in UserDir1
 24328                                  	; MSDOS 6.0
 24329 00002A2F 7233                     	jc	short pcrunch_cderrj
 24330                                  				;AN022; if error on current dir - report
 24331 00002A31 E8EB04                  	call	SETPATH		; scan past switches, whitespace
 24332                                  
 24333                                  ;       DX = ptr to pathname, NULL-terminated
 24334                                  ;       PathPos = ptr to byte after NULL at end of pathname
 24335                                  
 24336                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24337 00002A34 F606[BD9D]02            	test	byte [DestInfo],2 ; test if wildcards (? or *) seen
 24338 00002A39 752C                    	jnz	short trypeel	; wildcard seen, peel filename
 24339                                  
 24340                                  	;mov	ah,CHDir ; 3Bh
 24341 00002A3B B43B                    	mov	ah,3Bh
 24342 00002A3D CD21                    	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 24343                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 24344                                  	; MSDOS 6.0
 24345 00002A3F 7313                    	jnc	short chdir_worked	;AN022; no error - continue
 24346                                  	
 24347 00002A41 E807F6                  	call	get_ext_error_number    ;AN022; get the extended error
 24348 00002A44 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ;AN022; if path not found
 24349 00002A47 741E                    	je	short trypeel		;AC022;    keep trying
 24350 00002A49 83F805                  	cmp	ax,ERROR_ACCESS_DENIED  ;AN022; if access denied
 24351 00002A4C 7419                    	je	short trypeel		;AC022;    keep trying
 24352 00002A4E A3[349F]                	mov	[Msg_Numb],ax           ;AN022; set up message flag
 24353 00002A51 E99D00                  	jmp	peelfail                ;AN022; exit with other error
 24354                                  
 24355                                  	; MSDOS 3.3
 24356                                  	;jc	short trypeel
 24357                                  chdir_worked:
 24358                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24359 00002A54 E8BD06                  	call	SetRest1	; set 'Restore Directory' flag true
 24360 00002A57 B03F                    	mov	al,'?'		; if pure dir, wildcard filename in FCB
 24361 00002A59 BF5D00                  	mov	di,5Dh  ; FCB+1
 24362 00002A5C B90B00                  	mov	cx,11
 24363 00002A5F F3AA                    	rep	stosb
 24364 00002A61 30C0                    	xor	al,al		; return carry clear, zero set
 24365 00002A63 C3                      	retn
 24366                                  
 24367                                  pcrunch_cderrj: 		;AN022; need this for long jmp
 24368 00002A64 E98200                  	jmp	pcrunch_cderr	;AN022;
 24369                                  
 24370                                  trypeel:
 24371 00002A67 8B36[8F9D]              	mov	si,[PathPos]
 24372 00002A6B 4E                      	dec	si		; SI = ptr to NULL at end of pathname
 24373 00002A6C 8A44FF                  	mov	al,[si-1]	; AL = last char of pathname
 24374                                  	; 25/02/2023
 24375                                  	; MSDOS 5.0 (& 6.0)
 24376 00002A6F 803E[4F9F]00            	cmp	byte [KPARSE],0
 24377 00002A74 7505                    	jnz	short delstrt	; Last char is 2nd KANJI byte, might be '\'
 24378                                  	
 24379 00002A76 E89BFF                  	call	pathchrcmp
 24380 00002A79 7476                    	jz	short peelfail	; Trailing '/'
 24381                                  delstrt:
 24382 00002A7B 89F1                    	mov	cx,si		; CX = ptr to NULL at end of pathname
 24383 00002A7D 89D6                    	mov	si,dx		; SI = ptr to start of pathname
 24384 00002A7F 52                      	push	dx		; save ptr to pathname
 24385                                  delloop:
 24386 00002A80 39CE                    	cmp	si,cx
 24387                                  	;jz	short BADRET
 24388                                  	; 25/02/2023
 24389 00002A82 7413                    	je	short gotdele	; no char's left, we have what we have
 24390 00002A84 AC                      	lodsb			; AL = next char of pathname
 24391 00002A85 E8D9FC                  	call	testkanj
 24392 00002A88 7403                    	jz	short notkanj8	; not Kanji, move along
 24393 00002A8A 46                      	inc	si
 24394 00002A8B EBF3                    	jmp	short delloop	
 24395                                  
 24396                                  	; 25/02/2023
 24397                                  	; MSDOS 3.3
 24398                                  	;mov	al,[si]
 24399                                  	;call	PATHCHRCMP
 24400                                  	;jz	short TRYCD
 24401                                  	;dec	si
 24402                                  	;jmp	short delloop
 24403                                  
 24404                                  notkanj8:
 24405 00002A8D E884FF                  	call	pathchrcmp
 24406 00002A90 75EE                    	jnz	short delloop	; not a path delimiter, keep looking
 24407 00002A92 89F2                    	mov	dx,si
 24408 00002A94 4A                      	dec	dx		; DX = ptr to last delimiter found	
 24409 00002A95 EBE9                    	jmp	short delloop	; go look for more
 24410                                  
 24411                                  	; 25/02/2023
 24412                                  	; MSDOS 5.0 (& 6.0)
 24413                                  gotdele:
 24414 00002A97 89D6                    	mov	si,dx		; SI = ptr to pathname or last delim
 24415 00002A99 5A                      	pop	dx		; DX = ptr to pathname
 24416 00002A9A 39D6                    	cmp	si,dx
 24417 00002A9C 7455                    	je	short badret	; didn't find path delim
 24418 00002A9E 89F1                    	mov	cx,si		; CX = ptr to last path delimiter
 24419 00002AA0 89D6                    	mov	si,dx		; SI = ptr to pathname
 24420                                  delloop2:			; Set value of KPARSE
 24421 00002AA2 39CE                    	cmp	si,cx
 24422 00002AA4 7412                    	je	short trycd	; roll up till SI meets CX
 24423 00002AA6 C606[4F9F]00            	mov	byte [KPARSE],0
 24424 00002AAB AC                      	lodsb
 24425 00002AAC E8B2FC                  	call	testkanj
 24426 00002AAF 74F1                    	jz	short delloop2
 24427 00002AB1 46                      	inc	si
 24428 00002AB2 FE06[4F9F]              	inc	byte [KPARSE]
 24429 00002AB6 EBEA                    	jmp	short delloop2
 24430                                  
 24431                                  trycd:
 24432 00002AB8 50                      	push	ax
 24433                                  	; 25/02/2023
 24434 00002AB9 B02E                    	mov	al,'.'
 24435                                  	;mov	al,[DOT_CHR]	; AL = '.'
 24436                                  	; MSDOS 6.0
 24437 00002ABB 384401                  	cmp	[si+1],al	; check for '.' after path delim
 24438                                  				;M019; allow continuation if '. ' or 
 24439                                  				;M019; '..' is not found.
 24440 00002ABE 7509                    	jne	short trycd1	;M019; '.' not found
 24441 00002AC0 384402                  	cmp	[si+2],al	;M019; check for '..'
 24442 00002AC3 7404                    	je	short trycd1	;M019; found '..'
 24443 00002AC5 807C0200                	cmp	byte [si+2],0	;M019; check for '. ' (null terminated)
 24444                                  trycd1:	
 24445 00002AC9 58                      	pop     ax
 24446 00002ACA 7425                    	jz	short peelfail	; if . or .., pure cd should have worked
 24447                                  
 24448                                  	; 25/02/2023
 24449                                  	; MSDOS 3.3
 24450                                  	;cmp	[si+1],	al	; check for '.' after path delim
 24451                                  	;pop	ax
 24452                                  	;jz	short PEELFAIL	; if . or .., pure cd should have worked
 24453                                  
 24454                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24455 00002ACC 8A44FF                  	mov	al,[si-1]
 24456 00002ACF 3C3A                    	cmp	al,':' 		; Special case d:\file
 24457 00002AD1 7420                    	je	short badret
 24458                                  	; 25/02/2023
 24459                                  	; MSDOS 6.0
 24460 00002AD3 803E[4F9F]00            	cmp	byte [KPARSE],0
 24461 00002AD8 7505                    	jnz	short notdoublesl
 24462 00002ADA E837FF                  	call	pathchrcmp
 24463                                  	;jnz	short notdoublesl
 24464                                  				; Last char is 2nd KANJI byte, might be '\'
 24465                                  	; 25/02/2023
 24466 00002ADD 7412                    	jz	short peelfail 
 24467                                  ;peelfail:
 24468                                  	;stc
 24469                                  	;retn
 24470                                  
 24471                                  notdoublesl:
 24472 00002ADF C60400                  	mov	byte [si],0
 24473                                  	;mov	ah,CHDir ; 3Bh
 24474 00002AE2 B43B                    	mov	ah,3Bh
 24475                                  	;int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 24476                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 24477                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 24478 00002AE4 E8D3DA                  	call	int_21h_indirect
 24479 00002AE7 7321                    	jnc	short cdsucc
 24480                                  
 24481                                  	; 25/02/2023
 24482                                  	; MSDOS 6.0
 24483                                  pcrunch_cderr:
 24484 00002AE9 E85FF5                  	call	get_ext_error_number
 24485                                  				;AN022; get the extended error
 24486 00002AEC A3[349F]                	mov	[Msg_Numb],ax	;AN022; set up message flag
 24487 00002AEF 09F6                    	or	si,si		;AN022; set up zero flag to not zero
 24488                                  peelfail: ; 25/02/2023
 24489 00002AF1 F9                      	stc			;AN022; set up carry flag
 24490                                  pcrunch_retn:
 24491 00002AF2 C3                      	retn
 24492                                  
 24493                                  badret:
 24494                                  	; MSDOS 3.3 & MSDOS 6.0
 24495 00002AF3 8A04                    	mov	al,[si]
 24496 00002AF5 E81CFF                  	call	pathchrcmp	; Special case 'DIRCHAR'file
 24497 00002AF8 F9                      	stc
 24498 00002AF9 75F7                    	jnz	short pcrunch_retn
 24499 00002AFB 30DB                    	xor	bl,bl
 24500 00002AFD 865C01                  	xchg	bl,[si+1]
 24501                                  	;mov	ah,CHDir ; 3Bh
 24502 00002B00 B43B                    	mov	ah,3Bh
 24503                                  	;int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 24504                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 24505                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 24506 00002B02 E8B5DA                  	call	int_21h_indirect
 24507                                  	;jc	short pcrunch_retn ; MSDOS 3.3
 24508                                  	; 25/02/2023
 24509 00002B05 72E2                    	jc	short pcrunch_cderr
 24510                                  				;AN022; go to error exit 
 24511 00002B07 885C01                  	mov	[si+1],bl
 24512                                  cdsucc:
 24513 00002B0A E80706                  	call	SetRest1
 24514 00002B0D 46                      	inc	si		; Reset zero
 24515 00002B0E 8936[BB9D]              	mov	[DestTail],si
 24516                                  	; 25/02/2023
 24517                                  	; MSDOS 6.0
 24518 00002B12 9C                      	pushf			;AN015; save flags
 24519 00002B13 803E[979D]FF            	cmp	byte [DirFlag],-1
 24520                                  				;AN015; don't do parse if in DIR
 24521 00002B18 7408                    	je	short pcrunch_end
 24522                                  				;AN015;
 24523                                  	; MSDOS 3.3 & MSDOS 6.0
 24524 00002B1A BF5C00                  	mov	di,FCB  ; 5Ch
 24525                                  	;mov	ax,(Parse_File_Descriptor<<8)|2 ; 2902h
 24526 00002B1D B80229                  	mov	ax,2902h	
 24527 00002B20 CD21                    	int	21h		; Parse with default drive
 24528                                  			; DOS -	PARSE FILENAME
 24529                                  			; DS:SI	-> string to parse
 24530                                  			; ES:DI	-> buffer to fill with unopened	FCB
 24531                                  			; AL = bit mask	to control parsing
 24532                                  	; MSDOS 3.3
 24533                                  	;retn
 24534                                  
 24535                                  pcrunch_end:
 24536 00002B22 9D                      	popf			;AN015; get flags back
 24537 00002B23 C3                      	retn
 24538                                  
 24539                                  ; =============== S U B	R O U T	I N E =======================================
 24540                                  
 24541                                  ; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 24542                                  ; PCDOS 7.1 COMMAND.COM
 24543                                  %if 1
 24544                                  ;ifdef DBCS
 24545                                  ;
 24546                                  ;	Check if the character position is at Tail Byte of DBCS
 24547                                  ;
 24548                                  ;	input:	ds:si = start address of the string
 24549                                  ;		ds:di = character position to check
 24550                                  ;	output:	ZF = 1 if at Tail Byte
 24551                                  ;
 24552                                  ;CheckDBCSTailByte proc near
 24553                                  CheckDBCSTailByte:
 24554 00002B24 50                      	push	ax
 24555 00002B25 51                      	push	cx
 24556 00002B26 57                      	push	di
 24557 00002B27 89F9                    	mov	cx,di			; save character position
 24558                                  cdtb_check:
 24559 00002B29 39F7                    	cmp	di,si
 24560 00002B2B 7409                    	jz	short cdtb_next		; if at the top
 24561 00002B2D 4F                      	dec	di			; go back
 24562 00002B2E 8A05                    	mov	al,[di]			; get character
 24563                                  	;invoke	testkanj
 24564 00002B30 E82EFC                  	call	testkanj
 24565 00002B33 75F4                    	jnz	short cdtb_check	; if DBCS lead byte do next
 24566 00002B35 47                      	inc	di			; adjust
 24567                                  cdtb_next:
 24568 00002B36 29F9                    	sub	cx,di			; if the length is odd then
 24569 00002B38 80F101                  	xor	cl,1			; the character position is
 24570 00002B3B F6C101                  	test	cl,1			; at the tail byte
 24571 00002B3E 5F                      	pop	di
 24572 00002B3F 59                      	pop	cx
 24573 00002B40 58                      	pop	ax
 24574 00002B41 C3                      	retn
 24575                                  ;CheckDBCSTailByte endp
 24576                                  ;endif
 24577                                  %endif
 24578                                  
 24579                                  ;============================================================================
 24580                                  ; TMISC1.ASM, MSDOS 6.0, 1991
 24581                                  ;============================================================================
 24582                                  ; 05/10/2018 - Retro DOS v3.0
 24583                                  
 24584                                  ;TITLE	Part7 COMMAND Transient Routines
 24585                                  
 24586                                  ;	More misc routines
 24587                                  
 24588                                  ;---------------------------
 24589                                  ; We can get rid of this switch processing code if we can take
 24590                                  ; care of the remaining two calls to switch, later in the file.
 24591                                  ; However, I have not checked whether or not any other files use
 24592                                  ; switch -- after all, it IS public!
 24593                                  ;---------------------------
 24594                                  
 24595                                  ; 14/06/2023
 24596                                  SWCOUNT	EQU 8	; MSDOS 6.22		; Length of switch_list
 24597                                  ; 28/03/2023
 24598                                  ;SWCOUNT  EQU  6  ; MSDOS 6.0 (& MSDOS 5.0)
 24599                                  ;;SWCOUNT EQU  5  ; MSDOS 3.3	
 24600                                  
 24601                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1AC2h
 24602                                  
 24603                                  ; 25/02/2023 - Retro DOS v4.0 (& v4.1)
 24604                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2869h
 24605                                  
 24606                                  ; ---------------------------------------------------------------------------
 24607                                  
 24608                                  	; 25/02/2023
 24609                                  RETSW:
 24610 00002B42 93                      	xchg	ax,bx		; Put switches in AX
 24611 00002B43 C3                      	retn
 24612                                  
 24613                                  ; =============== S U B	R O U T	I N E =======================================
 24614                                  
 24615                                  	; 25/02/2023 - Retro DOS v4.0 COMMAND.COM
 24616                                  	; 11/06/2023 - Retro DOS 4.2 COMMAND.COM
 24617                                  	; 04/08/2024 - Retro DOS 5.0 COMMAND.COM
 24618                                  SWITCH:
 24619 00002B44 31DB                    	xor	bx,bx		; Initialize - no switches set
 24620                                  SWLOOP:
 24621 00002B46 E83DFE                  	call	scanoff		; Skip any delimiters
 24622 00002B49 3A06[F99B]              	cmp	al,[SWITCHAR]	; Is it a switch specifier?
 24623 00002B4D 75F3                    	jnz	short RETSW	; No -- we're finished
 24624 00002B4F 81CB0080                	or	bx,8000h
 24625                                  	;or	bx,FSWITCH	; Indicate there is a switch specified
 24626 00002B53 46                      	inc	si		; Skip over the switch character
 24627 00002B54 E82FFE                  	call	scanoff
 24628 00002B57 3C0D                    	cmp	al,0Dh
 24629 00002B59 74E7                    	je	short RETSW	; Oops
 24630 00002B5B 46                      	inc	si
 24631                                  
 24632                                  	; Convert lower case input to upper case
 24633                                  
 24634 00002B5C E82CFC                  	call	UPCONV
 24635                                  	;call	UPCONV_MAPCALL	; MSDOS 3.3
 24636                                  
 24637 00002B5F BF[D095]                	mov	di,switch_list	; "-Y?VBAPW" (for PCDOS 7.1) ; 04/08/2024
 24638                                  				; "-Y?VBAPW" (for MSDOS 6.22) ; 11/06/2023
 24639                                  				; "?VBAPW" (for MSDOS 6.0)
 24640                                  				; ("VBAPW" (for MSDOS 3.3))
 24641                                  	; 11/06/2023
 24642                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2E33h
 24643 00002B62 B90800                  	mov	cx,8  ; MSDOS 6.22
 24644                                  	;mov	cx,6  ; MSDOS 6.0 (& MSDOS 5.0)
 24645                                  	;;mov	cx,5  ; MSDOS 3.3
 24646                                  	;;mov	cx,SWCOUNT ; 5 (for MSDOS 3.3), (6 (for MSDOS 6.0))
 24647                                  
 24648                                  	;nop
 24649                                  
 24650 00002B65 F2AE                    	repne	scasb		; Look for matching switch
 24651 00002B67 7507                    	jnz	short BADSW
 24652 00002B69 B80100                  	mov	ax,1
 24653 00002B6C D3E0                    	shl	ax,cl		; Set a bit for the switch
 24654 00002B6E 09C3                    	or	bx,ax
 24655                                  BADSW: 				; Retro DOS v3.0 COMMAND.COM modificiation
 24656 00002B70 EBD4                    	jmp	short SWLOOP
 24657                                  ;BADSW:
 24658                                  	;jmp	short SWLOOP
 24659                                  ;DRVBAD:
 24660                                  ;	mov	dx,baddrv_ptr
 24661                                  ;	jmp	cerror
 24662                                  EXTERNALJ:
 24663 00002B72 E90501                  	jmp	EXTERNAL
 24664                                  FNDCOM:				; search the internal command table
 24665 00002B75 08C0                    	or	al,al		; Get real length of first arg
 24666 00002B77 74F9                    	jz	short EXTERNALJ	; If 0, it must begin with "\" so has
 24667                                  				;  to be external.
 24668                                  ; barryf code starts here
 24669                                  
 24670 00002B79 E89203                  	call	test_append	; see if APPEND installed
 24671 00002B7C 7429                    	jz	short CONTCOM	; not loaded
 24672                                  
 24673                                  APPEND_INTERNAL:
 24674 00002B7E 8A0E[BA9C]              	mov	cl,[IDLEN]
 24675 00002B82 B500                    	mov	ch,0
 24676 00002B84 890E[8F9D]              	mov	[PathPos],cx
 24677                                  	
 24678                                  	; 25/02/2023
 24679                                  	; MSDOS 6.0
 24680 00002B88 FE06[369F]              	inc 	byte [append_exec]
 24681                                  				;AN041; set APPEND to ON
 24682 00002B8C E82104                  	call	IOSET		; re-direct the o'l io
 24683                                  
 24684 00002B8F BE[BA9C]                	mov	si,IDLEN	; address command name, DS already set
 24685 00002B92 BAFFFF                  	mov	dx,-1 ; 0FFFFh	; set invoke function
 24686                                  		
 24687                                  	; MSDOS 6.0
 24688 00002B95 BF[1254]                	mov	di,append_parse
 24689                                  				;AN010; Get the entry point for PARSE for APPEND
 24690                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24691 00002B98 B801AE                  	mov	ax,0AE01h
 24692 00002B9B CD2F                    	int	2Fh	; - Multiplex -	DOS 3.3+ internal
 24693                                  			; - INSTALLABLE	COMMAND	- EXECUTE
 24694                                  			; DX = FFFFh, DS:SI -> buffer
 24695                                  			; Return: buffer at DS:SI filled with a	length byte
 24696                                  			; followed by the uppercase internal command
 24697                                  			; to execute (if length not 0)
 24698                                  	; 25/02/2023
 24699                                  	; INT 2Fh
 24700                                  	; 	AX = AE01h
 24701                                  	; entry:
 24702                                  	; 	DX = magic value FFFFh
 24703                                  	; 	CH = 00h
 24704                                  	; 	CL = length of command name
 24705                                  	; 	DS:BX -> command line buffer  -- (offset COMBUF)
 24706                                  	; 	DS:SI -> command name buffer  -- (offset IDLEN)
 24707                                  	; return:
 24708                                  	;	DS:SI buffer updated
 24709                                  	;	if length byte is nonzero, the following bytes contain
 24710                                  	;	the uppercase internal command to execute and the command line
 24711                                  	; 	buffer contains the command's parameters
 24712                                  	;	(the first DS:[SI] bytes are ignored)
 24713                                  	;
 24714                                  	; Format of COMMAND.COM command line buffer:
 24715                                  	;	Offset  Size    Description
 24716                                  	;	00h     BYTE    max length of command line, as in INT 21/AH=0Ah
 24717                                  	;	01h     BYTE    count of bytes to follow, excluding terminating 0Dh
 24718                                  	;	N BYTEs command line text, terminated by 0Dh
 24719                                  	;
 24720                                  	; Format of command name buffer:
 24721                                  	;	Offset  Size    Description
 24722                                  	;	00h     BYTE    length of command name
 24723                                  	;	01h    N BYTEs  uppercased command name (blank-padded to 11 chars)
 24724                                  
 24725 00002B9D 803E[BA9C]00            	cmp	byte [IDLEN],0 ; execute requested
 24726 00002BA2 7503                    	jne	short CONTCOM
 24727 00002BA4 E9A300                  	jmp	CMD_DONE
 24728                                  
 24729                                  	;nop
 24730                                  CONTCOM:			; continue with internal scan
 24731 00002BA7 BF[4F94]                	mov	di,COMTAB
 24732 00002BAA 31C9                    	xor	cx,cx
 24733                                  FINDCOM:
 24734 00002BAC BE[BB9C]                	mov	si,ID		; pointer to command argument
 24735 00002BAF 8A0D                    	mov	cl,[di]		; load length of internal command
 24736 00002BB1 47                      	inc	di		; advance past length
 24737 00002BB2 E3BE                    	jcxz	EXTERNALJ 	; if it's zero, we're out of internals
 24738 00002BB4 3A0E[BA9C]              	cmp	cl,[IDLEN]	; that of the command argument
 24739 00002BB8 7506                    	jne	short ABCD	; lengths not equal ==> strings not eq
 24740 00002BBA 890E[8F9D]              	mov	[PathPos],cx	; store length of command
 24741 00002BBE F3A6                    	repe	cmpsb
 24742                                  ABCD:
 24743 00002BC0 9F                      	lahf			; save the good ol' flags
 24744 00002BC1 01CF                    	add	di,cx		; skip over remaining internal, if any
 24745 00002BC3 8A05                    	mov	al,[di]		; load drive-check indicator byte (DCIB)
 24746 00002BC5 A2[059C]                	mov	[CHKDRV],al	; save command flag byte in chkdrv
 24747 00002BC8 47                      	inc	di		; increment DI (OK, OK, I'll stop)
 24748 00002BC9 8B1D                    	mov	bx,[di]		; load internal command address
 24749 00002BCB 47                      	inc	di		; skip over the puppy
 24750 00002BCC 47                      	inc	di
 24751                                  
 24752                                  	; MSDOS 6.0
 24753 00002BCD 8B15                    	mov	dx,[di]		; load ptr to help msg #s
 24754 00002BCF 47                      	inc	di
 24755 00002BD0 47                      	inc	di
 24756 00002BD1 9E                      	sahf			; remember those flags?
 24757 00002BD2 75D8                    	jnz	short FINDCOM	; well, if all the cmps worked...
 24758                                  
 24759                                  ; All messages get redirected.
 24760                                  
 24761 00002BD4 803E[369F]00            	cmp     byte [append_exec],0
 24762                                  				;AN041; APPEND just executed?
 24763 00002BD9 7503                    	jnz 	short DONT_SET_IO
 24764                                  				;AN041; Yes - this junk is already set
 24765 00002BDB E8D203                  	call	IOSET		; re-direct the ol' i/o
 24766                                  
 24767                                  DONT_SET_IO:			;AN041;
 24768                                  
 24769                                  ; Check for /?. Certain commands, flagged fLimitHelp,
 24770                                  ; respond to /? only if it is the only command-line argument.
 24771                                  
 24772 00002BDE A1[0B9C]                	mov	ax,[COMSW]	; AX = switches after command
 24773 00002BE1 0B06[119C]              	or	ax,[AllSwitch]	; AX = all switches
 24774                                  	;and	ax,SwitchQues
 24775 00002BE5 83E020                  	and	ax,20h
 24776 00002BE8 7426                    	jz	short DRIVE_CHECK
 24777                                  				; /? not in command line
 24778 00002BEA F606[059C]04            	test	byte [CHKDRV],4	
 24779                                  	;test	byte [CHKDRV],fLimitHelp
 24780 00002BEF 7407                    	jz	short DO_HELP	; /? allowed in combination
 24781                                  
 24782                                  ; Make sure /? is the only argument on the command line.
 24783                                  
 24784 00002BF1 833E[10A2]02            	cmp	word [ARG+ARG_UNIT.argvcnt],2
 24785 00002BF6 7518                    	jne	short DRIVE_CHECK
 24786                                  				; /? not only arg - ignore
 24787                                  
 24788                                  ; Note: this is all the check we need, even against things like /??.
 24789                                  ; Our argv parser breaks /?? into two args, /? and ?.
 24790                                  
 24791                                  DO_HELP:
 24792                                  ; DX = ptr to word list of msg #s, terminated by zero word
 24793                                  
 24794 00002BF8 89D6                    	mov	si,dx		; SI = ptr to list of msg #s
 24795                                      	;mov	ax,no_subst	; AL = no subst's code
 24796 00002BFA B80000                  	mov	ax,0
 24797 00002BFD 50                      	push	ax		; build subst block on stack
 24798                                  
 24799                                  NEXT_HELP_MSG:
 24800 00002BFE AD                      	lodsw			; AX = help msg # or zero
 24801 00002BFF 09C0                    	or	ax,ax
 24802 00002C01 7409                    	jz	short HELP_DONE
 24803 00002C03 50                      	push	ax		; SS:SP = ptr to subst block
 24804                                  				; (msg # and no_subst byte)
 24805                                  ;; We assume DS = SS.
 24806                                  	
 24807 00002C04 89E2                    	mov     dx,sp		; DS:DX = ptr to subst block
 24808 00002C06 E81F28                  	call	std_printf	; display help message
 24809 00002C09 58                      	pop	ax		; remove msg # from stack
 24810 00002C0A EBF2                    	jmp	short NEXT_HELP_MSG
 24811                                  
 24812                                  HELP_DONE:
 24813 00002C0C 58                      	pop	ax		; clean up stack
 24814 00002C0D E9F4D4                  	jmp	TCOMMAND
 24815                                  
 24816                                  	; 25/02/2023
 24817                                  	; MSDOS 3.3
 24818                                  	;sahf			; remember those flags?
 24819                                  	;jnz	short FINDCOM	; well, if all the cmps worked...
 24820                                  	;call	IOSET		; re-direct the ol' i/o
 24821                                  
 24822                                  DRIVE_CHECK:
 24823 00002C10 F606[059C]01            	test	byte [CHKDRV],1
 24824                                  	;test	byte [CHKDRV],FCHECKDRIVE
 24825                                  				; did we wanna check those drives?
 24826 00002C15 7411                    	jz	short NOCHECK
 24827 00002C17 A0[089C]                	mov	al,[PARM1]	; parse_file_descriptor results tell
 24828 00002C1A 0A06[0A9C]              	or	al,[PARM2]	; us whether those drives were OK
 24829 00002C1E 3CFF                    	cmp	al,-1
 24830 00002C20 7506                    	jne	short NOCHECK
 24831                                  	;jmp	DRVBAD
 24832                                  	; 25/02/2023
 24833                                  DRVBAD:
 24834 00002C22 BA[6E90]                	mov	dx,baddrv_ptr
 24835 00002C25 E9FE00                  	jmp	cerror
 24836                                  
 24837                                  ; The user may have omitted the space between the command and its arguments.
 24838                                  ; We need to copy the remainder of the user's command line into the buffer.
 24839                                  ; Note that thisdoes not screw up the arg structure; it points into COMBUF not
 24840                                  ; into the command line at 80.
 24841                                  
 24842                                  NOCHECK:
 24843 00002C28 E8C602                  	call	cmd_copy
 24844                                  SWITCHECK:
 24845                                  	;test	byte [CHKDRV],2
 24846 00002C2B F606[059C]02            	test	byte [CHKDRV],fSwitchAllowed 
 24847                                  				; Does the command take switches
 24848 00002C30 7516                    	jnz	short REALWORK	; Yes, process the command
 24849 00002C32 E82F00                  	call	noswit		; No, check to see if any switches
 24850 00002C35 7511                    	jnz	short REALWORK	; None, process the command
 24851                                  
 24852                                  	; MSDOS 6.0
 24853                                  	;mov	byte [msg_disp_class],2
 24854 00002C37 C606[D58F]02            	mov	byte [msg_disp_class],parse_msg_class
 24855                                  				;AN000; set up parse error msg class
 24856 00002C3C BA[D78F]                	mov	dx,extend_buf_ptr	
 24857                                  				;AC000; get extended message pointer
 24858                                  	;mov	word [extend_buf_ptr],3
 24859 00002C3F C706[D78F]0300          	mov	word [extend_buf_ptr],BadSwt_Ptr
 24860                                  				;AN000; get "Invalid switch" message number
 24861 00002C45 E9DE00                  	jmp	cerror		; Print error and chill out...
 24862                                  
 24863                                  	; 25/02/2023
 24864                                  	; MSDOS 3.3
 24865                                  	;mov	dx,BADPARMPTR
 24866                                  	;jmp	CERROR
 24867                                  
 24868                                  REALWORK:
 24869 00002C48 FFD3                    	call	bx		; do some real work, at last
 24870                                  
 24871                                  ; See if we're in a batch CALL command. If we are, reprocess the command line,
 24872                                  ; otherwise, go get another command.
 24873                                  
 24874                                  CMD_DONE:
 24875 00002C4A 0E                      	push	cs		; g  restore data segment
 24876 00002C4B 1F                      	pop	ds		; g
 24877 00002C4C 1E                      	push	ds
 24878 00002C4D 8E1E[F59B]              	mov	ds,[RESSEG]	; g  save data segment
 24879                                  	;cmp	byte [Call_Flag],1
 24880                                  				; G  Is a call in progress?
 24881 00002C51 803E[B002]01            	cmp	byte [Call_Flag],call_in_progress
 24882 00002C56 C606[B002]00            	mov	byte [Call_Flag],0
 24883                                  				; G  Either way, reset flag
 24884 00002C5B 1F                      	pop	ds		; g  get data segment back
 24885 00002C5C 7403                    	jz	short INCALL	; G
 24886 00002C5E E9A3D4                  	jmp	TCOMMAND	; chill out...
 24887                                  INCALL:
 24888                                  	;jmp	DOCOM1
 24889                                  	; 11/06/2023
 24890                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 24891 00002C61 E991D6                  	jmp	DOCOM0
 24892                                  
 24893                                  ; =============== S U B	R O U T	I N E =======================================
 24894                                  
 24895                                  	; 25/02/2023
 24896                                  noswit:
 24897 00002C64 57                      	push	di		; Save di
 24898 00002C65 BF8100                  	mov	di,81h		; di = ptr to command args
 24899 00002C68 BE8000                  	mov	si,80h		; Get address of length of command args
 24900 00002C6B AC                      	lodsb			; Load length
 24901 00002C6C 88C1                    	mov	cl,al		; Move length to cl
 24902 00002C6E 30ED                    	xor	ch,ch		; Zero ch
 24903 00002C70 2EA0[F99B]              	mov	al,[cs:SWITCHAR] ; al = switch character
 24904                                  	;cmp	al,0		; Turn off ZF
 24905                                  	; 25/02/2023
 24906 00002C74 20C0                    	and	al,al
 24907 00002C76 F2AE                    	repne	scasb		; Scan for a switch character and return
 24908 00002C78 5F                      	pop	di		;  with ZF set if one was found
 24909 00002C79 C3                      	retn
 24910                                  
 24911                                  ; ---------------------------------------------------------------------------
 24912                                  
 24913                                  	; 25/02/2023 - Retro DOS v4.0 COMMAND.COM
 24914                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:29A6h
 24915                                  
 24916                                  EXTERNAL:
 24917 00002C7A E89102                  	call	test_append	; check to see if append installed
 24918 00002C7D 7403                    	jz	short NOT_BARRYF
 24919                                  				; no - truly external command
 24920 00002C7F E9FCFE                  	jmp	APPEND_INTERNAL	; yes - go to Barryf code
 24921                                  
 24922                                  NOT_BARRYF:
 24923 00002C82 2EC606[069C]00          	mov	byte [cs:FILTYP],0
 24924 00002C88 2E8A16[149C]            	mov	dl,[cs:SPECDRV]
 24925 00002C8D 2E8816[BA9C]            	mov	[cs:IDLEN],dl
 24926 00002C92 2EC606[B49D]00          	mov	byte [cs:ROM_CALL],0
 24927 00002C98 52                      	push	dx
 24928 00002C99 BA[BA9C]                	mov	dx,IDLEN
 24929 00002C9C E834D8                  	call	ROM_SCAN
 24930 00002C9F 5A                      	pop	dx
 24931                                  	;jnc	short POSTSAVE
 24932 00002CA0 7305                    	jnc	short DO_SCAN
 24933 00002CA2 2EFE06[B49D]            	inc	byte [cs:ROM_CALL]
 24934                                  	;jmp	short POSTSAVE
 24935                                  
 24936                                  	;nop
 24937                                  DO_SCAN:
 24938                                  POSTSAVE:
 24939 00002CA7 BF[1D9B]                	mov	di,EXECPATH
 24940 00002CAA C60500                  	mov	byte [di],0	; Initialize to current directory
 24941                                  	
 24942 00002CAD 2E803E[B49D]00          	cmp	byte [cs:ROM_CALL],0
 24943                                  	;jz	short RESEARCH
 24944                                  	; 25/02/2023
 24945                                  	;jmp	short NEOEXECUTE
 24946 00002CB3 7577                    	jnz	short NEOEXECUTE
 24947                                  
 24948                                  	;nop
 24949                                  RESEARCH:
 24950 00002CB5 E8E808                  	call	path_search	; find the mother (result in execpath)
 24951 00002CB8 09C0                    	or	ax,ax		; did we find anything?
 24952                                  	;jz	short BADCOMJ45	; null means no (sob)
 24953                                  	; 25/02/2023
 24954 00002CBA 7465                    	jz	short BADCOM
 24955 00002CBC 83F804                  	cmp	ax,4		; 04H and 08H are .exe and .com
 24956                                  				; fuckin' sixteen-bit machine ought
 24957                                  	;jl	short BATCOMJ	; to be able to handle a SIXTEEN-BIT
 24958                                  				; DISPLACEMENT!!
 24959                                  	;;jmp	short NEOEXECUTE
 24960                                  	;jmp	short EXECUTE	
 24961                                  	; 25/02/2023
 24962 00002CBF 7D6B                    	jnl	short EXECUTE ; jge
 24963                                  
 24964                                  	; 02H is .bat
 24965                                  
 24966                                  ; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 24967                                  ; PCDOS 7.1 COMMAND.COM
 24968                                  %if 1
 24969                                  		; ... .BAT file	...
 24970 00002CC1 BA[1D9B]                	mov	dx,EXECPATH
 24971 00002CC4 B8003D                  	mov	ax,3D00h
 24972 00002CC7 CD21                    	int	21h		; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 24973                                  				; DS:DX	-> ASCIZ filename
 24974                                  				; AL = access mode
 24975                                  				; 0 - read
 24976 00002CC9 7253                    	jb	short BATCOMJ
 24977 00002CCB 8326[96A3]00            	and	word [TPBUF],0	; clear 1st two bytes of the buffer
 24978 00002CD0 BA[96A3]                	mov	dx,TPBUF
 24979 00002CD3 B90200                  	mov	cx,2
 24980 00002CD6 89C3                    	mov	bx,ax
 24981 00002CD8 B43F                    	mov	ah,3Fh
 24982 00002CDA CD21                    	int	21h		; DOS -	2+ - READ FROM FILE WITH HANDLE
 24983                                  				; BX = file handle, CX = number	of bytes to read
 24984                                  				; DS:DX	-> buffer
 24985 00002CDC B43E                    	mov	ah,3Eh
 24986 00002CDE CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 24987                                  				; BX = file handle
 24988 00002CE0 813E[96A3]2F2A          	cmp	word [TPBUF],2A2Fh ; '/*' (NASM syntax)
 24989 00002CE6 7536                    	jnz	short BATCOMJ
 24990 00002CE8 B8[7E97]                	mov	ax,REXX_EXE ; "REXX.EXE"
 24991                                  	;mov	[ARG_ARGV],ax
 24992 00002CEB A3[509F]                	mov	[ARG+ARGV_ELE.argpointer],ax
 24993                                  	;mov	word [ARGV0_ARG_FLAGS],0
 24994 00002CEE C706[529F]0000          	mov	word [ARG+ARGV_ELE.argflags],0
 24995                                  	;mov	[ARGV0_ARGSTARTEL],ax
 24996 00002CF4 A3[539F]                	mov	[ARG+ARGV_ELE.argstartel],ax
 24997                                  	;mov	word [ARGV0_ARGLEN],8
 24998 00002CF7 C706[559F]0800          	mov	word [ARG+ARGV_ELE.arglen],8
 24999                                  	;mov	word [ARGV0_ARGSW_WORD],0
 25000 00002CFD C706[579F]0000          	mov	word [ARG+ARGV_ELE.argsw_word],0
 25001                                  	;mov	[ARGV0_ARG_OCOMPTR],ax
 25002 00002D03 A3[599F]                	mov	[ARG+ARGV_ELE.arg_ocomptr],ax
 25003                                  				; pointer into original	command	string
 25004 00002D06 E89708                  	call	path_search
 25005 00002D09 85C0                    	test	ax,ax
 25006 00002D0B 740C                    	jz	short rexx_nf_err
 25007 00002D0D BE[559A]                	mov	si,COMBUF+1
 25008 00002D10 BF8000                  	mov	di,80h		; PSP command tail (arguments)
 25009 00002D13 89F9                    	mov	cx,di ; 128
 25010 00002D15 F3A4                    	rep movsb
 25011 00002D17 EB13                    	jmp	short NEOEXECUTE
 25012                                  rexx_nf_err:
 25013 00002D19 BA[FD8F]                	mov	dx,REXXNOTF_PTR	; MSG_1012 ; REXX.EXE not found
 25014 00002D1C EB08                    	jmp	short cerror	
 25015                                  %endif
 25016                                  
 25017                                  	;nop
 25018                                  BATCOMJ:
 25019 00002D1E E97BDB                  	jmp	BATCOM
 25020                                  
 25021                                  	; 25/02/2023
 25022                                  ;BADCOMJ45:
 25023                                  	;jmp	short BADCOM
 25024                                  
 25025                                  ; 06/08/2024
 25026                                  ; ---------------------------------------------------------------------------
 25027                                  
 25028                                  	;  25/02/2023 - Retro DOS v4.0 COMMAND.COM
 25029                                  BADCOM:
 25030 00002D21 0E                      	push	cs
 25031 00002D22 1F                      	pop	ds
 25032 00002D23 BA[FA8F]                	mov	dx,BADNAM_PTR
 25033                                  cerror:		
 25034 00002D26 E8F726                  	call	std_eprintf
 25035 00002D29 E9D8D3                  	jmp	TCOMMAND
 25036                                  
 25037                                  ; ---------------------------------------------------------------------------
 25038                                  
 25039                                  	;nop
 25040                                  EXECUTE:
 25041                                  NEOEXECUTE:
 25042 00002D2C E88102                  	call	IOSET
 25043                                  
 25044                                  ; MSDOS 6.0
 25045                                  ;M051
 25046                                  ; Previously LoadHigh was jumping to the execute label above. This was wrong
 25047                                  ;because IOSET was getting invoked twice resulting in 2 sets of redirections.
 25048                                  ;After a close, this would still leave one open active resulting in sharing
 25049                                  ;errors on subsequent opens of the redirected file.
 25050                                  
 25051                                  LH_EXECUTE:			;M051	
 25052 00002D2F 8E06[039C]              	mov	es,[TRAN_TPA]
 25053                                  	;mov	ah,DEALLOC ; 49h
 25054 00002D33 B449                    	mov	ah,49h
 25055 00002D35 CD21                    	int	21h	; DOS -	2+ - FREE MEMORY
 25056                                  			; ES = segment address of area to be freed
 25057                                  				; Now running in "free" space
 25058 00002D37 8E06[F59B]              	mov	es,[RESSEG]
 25059 00002D3B 26FE06[9902]            	inc	byte [es:ExtCom] ; Indicate external command
 25060 00002D40 26C606[A102]00          	mov	byte [es:RestDir],0 
 25061                                  				; Since USERDIR1 is in transient, insure
 25062                                  				; this flag value for re-entry to COMMAND
 25063                                  	; MSDOS 6.0
 25064 00002D46 BE[1D9B]                	mov	si,EXECPATH	  ; offset TRANGROUP:EXECPATH	
 25065 00002D49 BF[5E04]                	mov	di,SafePathBuffer ; offset RESGROUP:SAFEPATHBUFFER
 25066                                  	;mov	cx,LENMSGORPATHBUF
 25067 00002D4C B95000                  	mov	cx,80
 25068 00002D4F FC                      	cld
 25069 00002D50 F3A4                    	rep	movsb		; copy program pathname to resident
 25070                                  
 25071                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25072 00002D52 BF5C00                  	mov	di,FCB ; 5Ch
 25073 00002D55 89FE                    	mov	si,di
 25074                                  	;mov	cx,82 ; 52h	; moving (100h-5Ch)/2 = 80h-2Eh
 25075 00002D57 B152                    	mov	cl,82 ; 25/02/2023
 25076 00002D59 F3A5                    	rep	movsw		; Transfer parameters to resident header
 25077                                  	
 25078                                  	; 25/02/2023
 25079                                  	;mov	dx,EXECPATH  ; MSDOS 3.3
 25080                                  	; MSDOS 6.0 (& 5.0)
 25081                                  	;mov	dx,offset RESGROUP:SAFEPATHBUFFER
 25082 00002D5B BA[5E04]                	mov	dx,SafePathBuffer
 25083 00002D5E 06                      	push	es
 25084 00002D5F 1F                      	pop	ds
 25085                                  
 25086                                  	;mov	bx,offset RESGROUP:EXEC_BLOCK
 25087 00002D60 BB[3A04]                	mov	bx,Exec_Block  ; = offset EnvirSeg
 25088                                  	;mov	ax,EXEC*256 ; 4B00h
 25089 00002D63 B8004B                  	mov	ax,4B00h
 25090                                  	;test	byte [ROM_CALL],-1 ; 0FFh ; MSDOS 3.3
 25091 00002D66 2EF606[B49D]FF          	test	byte [cs:ROM_CALL],-1 ; MSDOS 6.0 (& 5.0)
 25092 00002D6C 7403                    	jz	short OK_EXEC
 25093 00002D6E E9DBD7                  	jmp	ROM_EXEC
 25094                                  
 25095                                  OK_EXEC:
 25096                                  
 25097                                  ; we are now running in free space. Anything we do from here on may get
 25098                                  ; trashed. Move the stack (also in free space) to allocated space because
 25099                                  ; since EXEC restores the stack, somebody may trash what is on the stack.
 25100                                  
 25101 00002D71 8CC1                    	mov	cx,es
 25102 00002D73 8ED1                    	mov	ss,cx
 25103 00002D75 BC[2E05]                	mov	sp,RStack
 25104                                  	; MSDOS 3.3
 25105                                  	;jmp	far [EXEC_ADDR]	; Jmp to the EXEC in the resident
 25106                                  	; 25/02/2023
 25107                                  	; MSDOS 6.0
 25108 00002D78 2EFF2E[FB9B]            	jmp	far [cs:EXEC_ADDR] ; Jmp to the EXEC in the resident
 25109                                  
 25110                                  ; =============== S U B	R O U T	I N E =======================================
 25111                                  
 25112                                  ; Prescan converts the input buffer into a canonicalized form.
 25113                                  ; All redirections and pipes are removed.
 25114                                  
 25115                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25116                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2A51h
 25117                                  
 25118                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25119                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2FFBh
 25120                                  
 25121                                  	; 05/08/2024 - Retro DOS v5.0 COMMAND.COM
 25122                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2E8Dh
 25123                                  PRESCAN:
 25124 00002D7D 31C9                    	xor	cx,cx
 25125 00002D7F 8E06[F59B]              	mov	es,[RESSEG]
 25126 00002D83 BE[569A]                	mov	si,COMBUF+2
 25127 00002D86 89F7                    	mov	di,si
 25128                                  COUNTQUOTES:
 25129 00002D88 AC                      	lodsb			; get a byte
 25130 00002D89 3C22                    	cmp	al,22h	; '"'	; is it a quote?
 25131 00002D8B 7504                    	jne	short COUNTEND	; no, try for end of road
 25132 00002D8D FEC5                    	inc	ch		; bump count
 25133 00002D8F EBF7                    	jmp	short COUNTQUOTES
 25134                                  				; go get next char
 25135                                  COUNTEND:
 25136 00002D91 3C0D                    	cmp	al,0Dh	; 13	; end of road?
 25137 00002D93 75F3                    	jne	short COUNTQUOTES
 25138                                  				; no, go back for next char
 25139                                  	; 26/02/2023
 25140                                  	; MSDOS 5.0 (& 6.0)
 25141 00002D95 51                      	push	cx		; save count
 25142 00002D96 89FE                    	mov	si,di		; restore pointer to begining
 25143                                  KanjiScan:
 25144 00002D98 AC                      	lodsb			; get a byte
 25145 00002D99 E8C5F9                  	call	testkanj	; is it a leadin byte
 25146 00002D9C 740F                    	jz	short KanjiQuote
 25147                                  				; no, check for quotes
 25148 00002D9E 88C4                    	mov	ah,al		; save leadin
 25149 00002DA0 AC                      	lodsb			; get trailing byte
 25150 00002DA1 3D2020                  	cmp	ax,2020h
 25151                                  	;cmp	ax,DB_SPACE	; is it Kanji space
 25152 00002DA4 75F2                    	jne	short KanjiScan	; no, go get next
 25153 00002DA6 C744FE2020              	mov	word [si-2],2020h
 25154                                  				; replace with spaces
 25155 00002DAB EBEB                    	jmp	short KanjiScan	; go get next char
 25156                                  	
 25157                                  KanjiQuote:
 25158 00002DAD 3C22                    	cmp	al,22h	; '"'	; beginning of quoted string
 25159 00002DAF 750D                    	jne	short KanjiEnd	; no, check for end
 25160 00002DB1 FECD                    	dec	ch		; drop count
 25161 00002DB3 74E3                    	jz	short KanjiScan	; if count is zero, no quoting
 25162                                  KanjiQuoteLoop:
 25163 00002DB5 AC                      	lodsb			; get next byte
 25164 00002DB6 3C22                    	cmp	al,22h	; '"'	; is it another quote
 25165 00002DB8 75FB                    	jne	short KanjiQuoteLoop
 25166                                  				; no, get another
 25167 00002DBA FECD                    	dec	ch		; yes, drop count
 25168 00002DBC EBDA                    	jmp	short KanjiScan	; go get next char
 25169                                  KanjiEnd:
 25170 00002DBE 3C0D                    	cmp	al,13 ; 0Dh	; end of line character?
 25171 00002DC0 75D6                    	jne	short KanjiScan	; go back to beginning
 25172 00002DC2 59                      	pop	cx		; get back original count
 25173                                  	; 26/04/2023
 25174 00002DC3 89FE                    	mov	si,di		; restore pointer to beginning
 25175                                  	
 25176                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25177                                  PRESCANLP:
 25178 00002DC5 AC                      	lodsb
 25179                                  	; 26/02/2023
 25180 00002DC6 E898F9                  	call	testkanj
 25181 00002DC9 740C                    	jz	short NOTKANJ6
 25182                                  	; MSDOS 6.0
 25183 00002DCB 8805                    	mov	[di],al
 25184 00002DCD 47                      	inc	di		; fake STOSB into DS
 25185 00002DCE AC                      	lodsb			; grab second byte
 25186 00002DCF 8805                    	mov	[di],al		; fake stosb into DS
 25187 00002DD1 FEC1                    	inc	cl
 25188 00002DD3 FEC1                    	inc	cl
 25189 00002DD5 EBEE                    	jmp	short PRESCANLP
 25190                                  
 25191                                  NOTKANJ6:
 25192                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25193 00002DD7 3C22                    	cmp	al,'"'	; 22h	; " character
 25194 00002DD9 7510                    	jne	short TRYGREATER
 25195 00002DDB FECD                    	dec	ch
 25196 00002DDD 740C                    	jz	short TRYGREATER
 25197                                  QLOOP:
 25198 00002DDF 8805                    	mov	[di],al
 25199 00002DE1 47                      	inc	di
 25200 00002DE2 FEC1                    	inc	cl
 25201 00002DE4 AC                      	lodsb
 25202 00002DE5 3C22                    	cmp	al,'"'		; " character
 25203 00002DE7 75F6                    	jne	short QLOOP
 25204 00002DE9 FECD                    	dec	ch
 25205                                  TRYGREATER:
 25206 00002DEB 3C3E                    	cmp	al,'>' ; 3Eh
 25207                                  	;cmp	al,rabracket	; MSDOS 6.0 (& 5.0)
 25208                                  	;;cmp	al,[RABRACKET]	; MSDOS 3.3
 25209 00002DED 7565                    	jne	short NOOUT
 25210                                  
 25211                                  ; We have found a ">" char. We need to see if there is another ">"
 25212                                  ; following it.
 25213                                  
 25214 00002DEF 3804                    	cmp	[si],al
 25215 00002DF1 7506                    	jne	short NOAPPND
 25216 00002DF3 AC                      	lodsb
 25217 00002DF4 26FE06[C102]            	inc	byte [es:Re_Out_App] ; Flag >>
 25218                                  NOAPPND:
 25219                                  ; Now we attempt to find the file name. First, scan off all whitespace
 25220                                  
 25221 00002DF9 E88AFB                  	call	scanoff
 25222                                  
 25223                                  	; 26/02/2023
 25224                                  	; MSDOS 6.0
 25225 00002DFC 3C3C                    	cmp	al,'<' ; 3Ch
 25226                                  	;cmp	al,labracket	;AN040; was there no filename?
 25227 00002DFE 7404                    	je	short REOUT_ERRSET
 25228                                  				;AN040; yes - set up error
 25229                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25230 00002E00 3C0D                    	cmp	al,0Dh
 25231 00002E02 750D                    	jnz	short GOTREOFIL
 25232                                  
 25233                                  ; There was no file present. Set us up at end-of-line.
 25234                                  
 25235                                  REOUT_ERRSET:			;AN040; set up for an error
 25236 00002E04 C6050D                  	mov	byte [di],0Dh	; Clobber first ">"
 25237 00002E07 26C706[C202]0900        	mov	word [es:Re_OutStr],9
 25238                                  				; Cause an error later
 25239 00002E0E E9B700                  	jmp	PRESCANEND
 25240                                  
 25241                                  GOTREOFIL:
 25242 00002E11 57                      	push	di
 25243                                  	;mov	di,offset RESGROUP:RE_OUTSTR
 25244 00002E12 BF[C202]                	mov	di,Re_OutStr
 25245 00002E15 89FB                    	mov	bx,di
 25246 00002E17 06                      	push	es
 25247                                  
 25248                                  	; 26/02/2023
 25249                                  	; MSDOS 6.0
 25250                                  SETREOUTSTR:			; Get the output redirection name
 25251                                  				; MSKK06 07/14/89
 25252 00002E18 51                      	push	cx		; save cx
 25253 00002E19 B94D00                  	mov	cx,64+13	; CX = max string length
 25254                                  SETREOUTSTR_LOOP:
 25255 00002E1C AC                      	lodsb
 25256 00002E1D 3C0D                    	cmp	al,0Dh
 25257 00002E1F 741A                    	je	short GOTRESTR_J
 25258 00002E21 E86AFB                  	call	DELIM
 25259 00002E24 7415                    	jz	short GOTRESTR_J
 25260 00002E26 3A06[F99B]              	cmp	al,[SWITCHAR]
 25261 00002E2A 740F                    	je	short GOTRESTR_J
 25262 00002E2C 3C22                    	cmp	al,'"' ; 22h 	;AN033; Is the character a quote?
 25263 00002E2E 7421                    	je	short PIPEERRSYNJ5_J
 25264                                  				;AN033; Yes - get out quick - or system crashes
 25265 00002E30 3C3C                    	cmp	al,'<' ; 3Ch
 25266                                  	;cmp	al,labracket	;AN002; Is char for input redirection
 25267 00002E32 7404                    	je	short ABRACKET_TERM
 25268                                  				;AN002; yes - end of string
 25269 00002E34 3C3E                    	cmp	al,'>' ; 3Eh
 25270                                  	;cmp	al,rabracket	;AN002; Is char for output redirection
 25271 00002E36 7506                    	jne	short NO_ABRACKET
 25272                                  				;AN002; no - not end of string
 25273                                  ABRACKET_TERM:			;AN002; have end of string by < or >
 25274 00002E38 4E                      	dec	si		;AN002; back up over symbol
 25275 00002E39 B020                    	mov	al,20h ; BLANK	;AN002; show delimiter as char
 25276                                  GOTRESTR_J:
 25277 00002E3B 59                      	pop	cx		; MSKK06 07/14/89
 25278 00002E3C EB66                    	jmp	short GOTRESTR	;AN002; go process it
 25279                                  NO_ABRACKET:			;AN002; NOT AT END OF STRING
 25280 00002E3E AA                      	stosb			; store it into resgroup
 25281                                  
 25282                                  ; 05/08/2024 - PCDOS 7.1 COMMAND.COM
 25283                                  %if 1
 25284                                  ;ifdef DBCS
 25285                                  	;invoke	testkanj
 25286                                  	;jz	short @f	; if not lead byte of DBCS
 25287 00002E3F E81FF9                  	call	testkanj
 25288 00002E42 7409                    	jz	short NO_ABRACKET_@
 25289 00002E44 E3F5                    	jcxz	GOTRESTR_J	; if no tail byte
 25290 00002E46 AC                      	lodsb
 25291 00002E47 3C0D                    	cmp	al,0Dh
 25292 00002E49 74F0                    	jz	short GOTRESTR_J ; if tail byte does't come and ends
 25293 00002E4B AA                      	stosb			; copy tail byte
 25294 00002E4C 49                      	dec	cx
 25295                                  ;@@:
 25296                                  NO_ABRACKET_@:	; 05/08/2024
 25297                                  ;endif
 25298                                  %endif
 25299                                  
 25300 00002E4D E2CD                    	loop	SETREOUTSTR_LOOP
 25301                                  				; MSKK06 07/14/89
 25302 00002E4F EBEA                    	jmp	short GOTRESTR_J
 25303                                  PIPEERRSYNJ5_J:
 25304 00002E51 59                      	pop	cx		; recover CX
 25305 00002E52 EB4B                    	jmp	short PIPEERRSYNJ5
 25306                                  
 25307                                  	; 26/02/2023
 25308                                  ;	; MSDOS 3.3
 25309                                  ;SETREOUTSTR_LOOP:		; Get the output redirection name
 25310                                  ;	lodsb
 25311                                  ;	cmp	al,0Dh
 25312                                  ;	jz	short GOTRESTR
 25313                                  ;	call	DELIM
 25314                                  ;	jz	short GOTRESTR
 25315                                  ;	cmp	al,[SWITCHAR]
 25316                                  ;	je	short GOTRESTR
 25317                                  ;	cmp	al,'"'
 25318                                  ;	jne	short NO_ABRACKET
 25319                                  ;	dec	ch
 25320                                  ;NO_ABRACKET:
 25321                                  ;	stosb
 25322                                  ;	jmp	short SETREOUTSTR_LOOP
 25323                                  
 25324                                  NOOUT:
 25325                                  	; 26/02/2023
 25326                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25327 00002E54 3C3C                    	cmp	al, '<' ; 3Ch
 25328                                  	;cmp	al,labracket	; MSDOS 6.0
 25329                                  	;;cmp	al,[LABRACKET]  ; MSDOS 3.3
 25330 00002E56 7523                    	jne	short CHKPIPE
 25331 00002E58 89F3                    	mov	bx,si		; Save loc of "<"
 25332 00002E5A E829FB                  	call	scanoff
 25333                                  	; MSDOS 6.0
 25334 00002E5D 3C3E                    	cmp	al,'>' ; 3Eh
 25335                                  	;cmp	al,rabracket	;AN040; was there no filename?
 25336 00002E5F 7404                    	je	short REIN_ERRSET ;AN040; yes - set up error
 25337                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25338 00002E61 3C0D                    	cmp	al,0Dh
 25339 00002E63 750B                    	jne	short GOTREIFIL
 25340                                  REIN_ERRSET:			;AN040; set up for error
 25341 00002E65 C6050D                  	mov	byte [di],0Dh	; Clobber "<"
 25342 00002E68 C706[A09B]0900          	mov	word [RE_INSTR],9 
 25343                                  				; Cause an error later
 25344 00002E6E EB58                    	jmp	short PRESCANEND
 25345                                  GOTREIFIL:
 25346 00002E70 57                      	push	di
 25347 00002E71 BF[A09B]                	mov	di,RE_INSTR
 25348 00002E74 89FB                    	mov	bx,di
 25349 00002E76 06                      	push	es
 25350 00002E77 0E                      	push	cs
 25351 00002E78 07                      	pop	es		; store in TRANGROUP
 25352                                  	; 26/04/2023
 25353                                  	;jmp	short SETREOUTSTR_LOOP  ; MSDOS 3.3 COMMAND.COM
 25354 00002E79 EB9D                    	jmp	short SETREOUTSTR ; MSDOS 5.0 (& 6.0) COMMAND.COM
 25355                                  				; Get the input redirection name
 25356                                  CHKPIPE:
 25357 00002E7B 88C4                    	mov	ah,al
 25358                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25359 00002E7D 80FC7C                  	cmp	ah,'|' ; 7Ch
 25360                                  	;cmp	ah,ALTPIPECHR ; 7Ch
 25361                                  	;je	short ISPIPE3
 25362                                  	;; MSDOS 6.0
 25363                                  	;cmp	ah,'|' ; 7Ch
 25364                                  	;;cmp	al,vbar ; 7Ch
 25365                                  	;;;cmp	ah,[VBAR]  ; MSDOS 3.3
 25366 00002E80 7539                    	jne	short CONTPRESCAN
 25367                                  ISPIPE3:
 25368                                  ; Only push the echo flag if we are entering the pipe for the first time.
 25369                                  
 25370 00002E82 26803E[1303]00          	cmp	byte [es:PipeFlag],0
 25371 00002E88 7505                    	jne	short NOECHOPUSH
 25372 00002E8A 26D026[9D02]            	shl	byte [es:EchoFlag],1 ; push echo state and turn it off
 25373                                  NOECHOPUSH:
 25374 00002E8F 26FE06[1303]            	inc	byte [es:PipeFlag]
 25375 00002E94 E8EFFA                  	call	scanoff
 25376 00002E97 3C0D                    	cmp	al,0Dh
 25377 00002E99 7404                    	je	short PIPEERRSYNJ5
 25378                                  	; 26/02/2023
 25379 00002E9B 3C7C                    	cmp	al,'|' ; 7Ch
 25380                                  	;cmp	al,ALTPIPECHR ; 7Ch
 25381                                  	;je	short PIPEERRSYNJ5
 25382                                  	;; MSDOS 6.0
 25383                                  	;cmp	al,'|' ; 7Ch
 25384                                  	;;cmp	al,vbar ; 7Ch
 25385                                  	;;;cmp	al,[VBAR]  ; MSDOS 3.3	
 25386 00002E9D 751C                    	jne	short CONTPRESCAN
 25387                                  
 25388                                  PIPEERRSYNJ5:
 25389 00002E9F 06                      	push	es
 25390 00002EA0 1F                      	pop	ds
 25391 00002EA1 E99E02                  	jmp	PIPEERRSYN
 25392                                  
 25393                                  ; Trailing :s are allowed on devices. Check to be sure that there is more
 25394                                  ; than just a : in the redir string.
 25395                                  
 25396                                  GOTRESTR:
 25397 00002EA4 86C4                    	xchg	ah,al
 25398 00002EA6 B03A                    	mov	al,':' ; 3Ah
 25399 00002EA8 29FB                    	sub	bx,di		; compute negative of number of chars
 25400 00002EAA 83FBFF                  	cmp	bx,-1		; is there just a :?
 25401 00002EAD 7407                    	je	short NOTRAILCOL ; yep, don't change
 25402 00002EAF 263845FF                	cmp	[es:di-1],al	; Trailing ':' OK on devices
 25403 00002EB3 7501                    	jne	short NOTRAILCOL
 25404 00002EB5 4F                      	dec	di		; Back up over trailing ':'
 25405                                  NOTRAILCOL:
 25406 00002EB6 30C0                    	xor	al,al
 25407 00002EB8 AA                      	stosb			; NUL terminate the string
 25408 00002EB9 07                      	pop	es
 25409 00002EBA 5F                      	pop	di		; Remember the start
 25410                                  CONTPRESCAN:
 25411 00002EBB 8825                    	mov	[di],ah		; "delete" the redirection string
 25412 00002EBD 47                      	inc	di
 25413 00002EBE 80FC0D                  	cmp	ah,0Dh
 25414 00002EC1 7405                    	je	short PRESCANEND
 25415 00002EC3 FEC1                    	inc	cl
 25416 00002EC5 E9FDFE                  	jmp	PRESCANLP
 25417                                  PRESCANEND:
 25418 00002EC8 26803E[1303]00          	cmp	byte [es:PipeFlag],0
 25419 00002ECE 7414                    	jz	short ISNOPIPE
 25420                                  
 25421                                  	; 11/06/2023
 25422                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:314Ah
 25423                                  	;mov	di,48Ah		; PipeStr ; RESGROUP:EndInit+160
 25424                                  	;mov	[es:488h],di	; [es:PipePtr],di
 25425                                  				; (RESGROUP:EndInit+158)
 25426                                  	; 26/02/2023
 25427                                  	;;MSDOS 5.0 COMMAND.COM - TRANGROUP:2BA0h
 25428                                  	;;mov	di,3C0h		; offset RESGROUP:PIPESTR
 25429                                  	;;			; (EndInit+160]
 25430                                  
 25431                                  	; 05/08/2024
 25432                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2FEAh
 25433                                  	;mov	di,4BEh		; PipeStr ; RESGROUP:EndInit+160	
 25434                                  	;mov	[es:4BCh],di	; (RESGROUP:EndInit+158)
 25435                                  
 25436                                  	;mov	di,offset RESGROUP:PIPESTR
 25437 00002ED0 BF[B503]                	mov	di,PipeStr	; RESGROUP:EndInit+160
 25438                                  
 25439                                  	;;MSDOS 5.0 COMMAND.COM - TRANGROUP:2BA3h
 25440                                  	;;mov	[es:3BEh],di	; [es:EndInit+158]
 25441 00002ED3 26893E[B303]            	mov	[es:PipePtr],di	; RESGROUP:EndInit+158
 25442                                  	
 25443 00002ED8 BE[569A]                	mov	si,COMBUF+2
 25444 00002EDB E8A8FA                  	call	scanoff
 25445                                  PIPESETLP:			; Transfer the pipe into the resident
 25446 00002EDE AC                      	lodsb			; pipe buffer
 25447 00002EDF AA                      	stosb
 25448 00002EE0 3C0D                    	cmp	al,0Dh
 25449 00002EE2 75FA                    	jnz	short PIPESETLP
 25450                                  ISNOPIPE:
 25451 00002EE4 880E[559A]              	mov	[COMBUF+1],cl
 25452 00002EE8 26803E[1303]00          	cmp	byte [es:PipeFlag],0 ; [es:41Ch] ; PCDOS 7.1 COMMAND.COM
 25453 00002EEE 0E                      	push	cs
 25454 00002EEF 07                      	pop	es
 25455 00002EF0 C3                      	retn
 25456                                  
 25457                                  ; =============== S U B	R O U T	I N E =======================================
 25458                                  
 25459                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25460                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2BC1h
 25461                                  cmd_copy:
 25462 00002EF1 BE[569A]                	mov	si,COMBUF+2
 25463 00002EF4 E88FFA                  	call	scanoff		; advance past separators...
 25464 00002EF7 0336[8F9D]              	add	si,[PathPos]
 25465 00002EFB BF8100                  	mov	di,81h
 25466 00002EFE 31C9                    	xor	cx,cx
 25467                                  cmdcopy:
 25468 00002F00 AC                      	lodsb
 25469 00002F01 AA                      	stosb
 25470 00002F02 3C0D                    	cmp	al,0Dh
 25471 00002F04 7403                    	je	short copy_done
 25472 00002F06 41                      	inc	cx
 25473 00002F07 EBF7                    	jmp	short cmdcopy
 25474                                  copy_done:
 25475 00002F09 880E8000                	mov	[80h],cl
 25476 00002F0D C3                      	retn
 25477                                  
 25478                                  ; =============== S U B	R O U T	I N E =======================================
 25479                                  
 25480                                  	; 25/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25481                                  test_append:
 25482 00002F0E BB[549A]                	mov	bx,COMBUF	; barry can address
 25483 00002F11 BE[BA9C]                	mov	si,IDLEN	; address command name, DS already set 	
 25484 00002F14 BAFFFF                  	mov	dx,-1
 25485 00002F17 B800AE                  	mov	ax,0AE00h
 25486 00002F1A CD2F                    	int	2Fh	; - Multiplex -	DOS 3.3+ internal 
 25487                                  			; - INSTALLABLE	COMMAND	- INSTALL CHECK
 25488                                  			; DX = FFFFh,[BX -> command line
 25489                                  			; Return: AL = FFh if this command is a TSR extension 
 25490                                  			;		   to COMMAND.COM
 25491                                  			; AL = 00h if the command should be executed as	usual
 25492                                  	;cmp	al,0
 25493 00002F1C 08C0                    	or	al,al ; 25/02/2023
 25494 00002F1E C3                      	retn
 25495                                  
 25496                                  	; 25/02/2023
 25497                                  	; INT 2Fh
 25498                                  	; 	AX = AE00h
 25499                                  	; entry:
 25500                                  	; 	DX = magic value FFFFh
 25501                                  	; 	CH = FFh
 25502                                  	; 	CL = length of command line tail
 25503                                  	; 	DS:BX -> command line buffer  -- (offset COMBUF)
 25504                                  	; 	DS:SI -> command name buffer  -- (offset IDLEN)
 25505                                  	; return:
 25506                                  	;	AL = FFh if this command is a TSR extension to COMMAND.COM
 25507                                  	;	AL = 00h if the command should be executed as usual
 25508                                  	;
 25509                                  	; Format of COMMAND.COM command line buffer:
 25510                                  	;	Offset  Size    Description
 25511                                  	;	00h     BYTE    max length of command line, as in INT 21/AH=0Ah
 25512                                  	;	01h     BYTE    count of bytes to follow, excluding terminating 0Dh
 25513                                  	;	N BYTEs command line text, terminated by 0Dh
 25514                                  	;
 25515                                  	; Format of command name buffer:
 25516                                  	;	Offset  Size    Description
 25517                                  	;	00h     BYTE    length of command name
 25518                                  	;	01h    N BYTEs  uppercased command name (blank-padded to 11 chars)
 25519                                  
 25520                                  ;============================================================================
 25521                                  ; TMISC2.ASM, MSDOS 6.0, 1991
 25522                                  ;============================================================================
 25523                                  ; 05/10/2018 - Retro DOS v3.0
 25524                                  
 25525                                  ;	More misc routines
 25526                                  
 25527                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1D9Bh
 25528                                  
 25529                                  ; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25530                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2BEFh
 25531                                  
 25532                                  ; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25533                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3199h
 25534                                  
 25535                                  ; 05/08/2024 - Retro DOS v5.0 COMMAND.COM
 25536                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 3039h
 25537                                  
 25538                                  ; =============== S U B	R O U T	I N E =======================================
 25539                                  
 25540                                  SETPATH:
 25541                                  
 25542                                  ; ENTRY PathPos = ptr to string
 25543                                  ;       PathCnt = length of string
 25544                                  ;
 25545                                  ; EXIT  PathPos = ptr to string after pathname
 25546                                  ;       PathCnt = length of rest of string
 25547                                  ;       DX = ptr to pathname in string, made ASCIIZ
 25548                                  ;       DestIsDir = 1 if pathname delimiters appeared in pathname, 0 otherwise
 25549                                  ;       DestInfo = 2 if wildcards (?, *) appeared in pathname, 0 otherwise
 25550                                  ;
 25551                                  ;       A null character is dropped at the end of the pathname. If the
 25552                                  ;       character in that spot previously was CR, it is copied into the
 25553                                  ;       following byte. So there must be at least two two character 
 25554                                  ;       positions in the buffer following the pathname.
 25555                                  
 25556                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25557                                  	
 25558                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25559                                  	; MSDOS 6.0
 25560                                  	;mov	ax,[PathCnt]	;AC000; get length of string
 25561                                  	;mov	si,[PathPos]	;AC000; get start of source buffer
 25562                                  
 25563                                  	; 26/02/2023
 25564                                  	; MSDOS 3.3
 25565                                  	;mov	si,80h
 25566                                  	;lodsb
 25567                                  	;xor	ah,ah
 25568                                  	;mov	[PATCNT],ax
 25569                                  	;mov	[PATHPOS],si
 25570                                  GETPATH:
 25571                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25572 00002F1F C606[BD9D]00            	mov	byte [DestInfo],0
 25573 00002F24 C606[B99D]00            	mov	byte [DestIsDir],0
 25574 00002F29 8B36[8F9D]              	mov	si,[PathPos]	; SI = ptr to string
 25575 00002F2D 8B0E[8D9D]              	mov	cx,[PathCnt]	; CX = string length
 25576 00002F31 89F2                    	mov	dx,si		; DX = ptr to string
 25577 00002F33 E34D                    	jcxz	PATHDONE	; string length is zero, we're done
 25578 00002F35 51                      	push	cx		; save string length
 25579 00002F36 56                      	push	si		; save ptr to string
 25580 00002F37 E80AFC                  	call	SWITCH
 25581                                  
 25582                                  ;       After Switch, SI has been scanned past any switches, and
 25583                                  ;       switches that COMMAND intrinsically recognizes are recorded in AX.
 25584                                  
 25585 00002F3A A3[919D]                	mov	[PathSw],ax	; PathSw = switch occurrence mask
 25586 00002F3D 5B                      	pop	bx		; BX = ptr to original string
 25587 00002F3E 29F3                    	sub	bx,si		; BX = -(# chars scanned by Switch)
 25588 00002F40 59                      	pop	cx		; CX = string length
 25589 00002F41 01D9                    	add	cx,bx		; CX = string length from current SI
 25590 00002F43 89F2                    	mov	dx,si		; DX = ptr to current string
 25591                                  SKIPPATH:
 25592                                  	; 26/02/2023
 25593                                  	; MSDOS 6.0
 25594 00002F45 C606[4F9F]00            	mov	byte [KPARSE],0
 25595                                  SKIPPATH2:
 25596 00002F4A E336                    	jcxz	PATHDONE	; string length is zero, we're done
 25597 00002F4C 49                      	dec	cx		; CX = length left after next char
 25598 00002F4D AC                      	lodsb			; AL = next char of string
 25599                                  				; SI = ptr to char after this one
 25600                                  	; 26/02/2023
 25601 00002F4E E810F8                  	call	testkanj
 25602 00002F51 7408                    	jz	short TESTPPSEP
 25603 00002F53 49                      	dec	cx
 25604 00002F54 46                      	inc	si
 25605 00002F55 FE06[4F9F]              	inc	byte [KPARSE]
 25606 00002F59 EBEF                    	jmp	short SKIPPATH2
 25607                                  TESTPPSEP:
 25608 00002F5B E8B6FA                  	call	pathchrcmp	; compare AL to path delimiter char
 25609 00002F5E 7504                    	jnz	short TESTPMETA	; it's not a path delim
 25610 00002F60 FE06[B99D]              	inc	byte [DestIsDir]
 25611                                  				; DestIsDir = 1, signalling path char
 25612                                  TESTPMETA:
 25613 00002F64 3C3F                    	cmp	al,'?'
 25614 00002F66 7505                    	jne	short TESTPSTAR	; char is not '?'
 25615 00002F68 800E[BD9D]02            	or	byte [DestInfo],2 ; DestInfo = 2, signalling wildcard
 25616                                  TESTPSTAR:
 25617 00002F6D 3C2A                    	cmp	al,'*'
 25618                                  	;cmp	al,[STAR] ; MSDOS 3.3	
 25619 00002F6F 7505                    	jne	short TESTPDELIM ; char is not '*'
 25620 00002F71 800E[BD9D]02            	or	byte [DestInfo],2 ; DestInfo = 2, signalling wildcard
 25621                                  TESTPDELIM:
 25622 00002F76 E815FA                  	call	DELIM		; compare AL to all delimiters
 25623 00002F79 7406                    	jz	short PATHDONEDEC ; delimiter found, back up & leave
 25624 00002F7B 3A06[F99B]              	cmp	al,[SWITCHAR]
 25625 00002F7F 75C4                    	jne	short SKIPPATH	; char isn't switch, go get next char
 25626                                  PATHDONEDEC:
 25627 00002F81 4E                      	dec	si		; SI = ptr to char after pathname
 25628                                  PATHDONE:
 25629 00002F82 30C0                    	xor	al,al		; AL = NULL
 25630 00002F84 8604                    	xchg	al,[si]		; place NULL after pathname
 25631 00002F86 46                      	inc	si		; SI = ptr to byte after NULL
 25632 00002F87 3C0D                    	cmp	al,0Dh		; were we at end of line?
 25633 00002F89 7502                    	jne	short NOPSTORE	; not EOL, finish up
 25634 00002F8B 8804                    	mov	[si],al		; save EOL after NULL
 25635                                  NOPSTORE:
 25636 00002F8D 8936[8F9D]              	mov	[PathPos],si	; PathPos = ptr to char after NULL
 25637 00002F91 890E[8D9D]              	mov	[PathCnt],cx	; PathCnt = length of string left
 25638                                  SETPATH_RETN:
 25639 00002F95 C3                      	retn
 25640                                  
 25641                                  ; ---------------------------------------------------------------------------
 25642                                  
 25643                                  PGETARG:
 25644 00002F96 BE8000                  	mov	si,80h
 25645 00002F99 AC                      	lodsb
 25646 00002F9A 08C0                    	or	al,al
 25647 00002F9C 74F7                    	jz	short SETPATH_RETN
 25648 00002F9E E80300                  	call	PSCANOFF
 25649 00002FA1 3C0D                    	cmp	al,0Dh
 25650 00002FA3 C3                      	retn
 25651                                  
 25652                                  ; ---------------------------------------------------------------------------
 25653                                  
 25654                                  PSCANOFF:
 25655 00002FA4 AC                      	lodsb
 25656 00002FA5 E8E6F9                  	call	DELIM
 25657 00002FA8 7504                    	jnz	short PSCANOFFD
 25658 00002FAA 3C3B                    	cmp	al,';' ; 3Bh
 25659 00002FAC 75F6                    	jne	short PSCANOFF	; ';' is not a delimiter
 25660                                  PSCANOFFD:
 25661 00002FAE 4E                      	dec	si		; Point to first non-delimiter
 25662 00002FAF C3                      	retn
 25663                                  
 25664                                  ; =============== S U B	R O U T	I N E =======================================
 25665                                  
 25666                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25667                                  IOSET:
 25668                                  	; ALL REGISTERS PRESERVED
 25669 00002FB0 1E                      	push	ds
 25670 00002FB1 52                      	push	dx
 25671 00002FB2 50                      	push	ax
 25672 00002FB3 53                      	push	bx
 25673 00002FB4 51                      	push	cx
 25674 00002FB5 2E8E1E[F59B]            	mov	ds,[cs:RESSEG]
 25675 00002FBA 803E[1303]00            	cmp	byte [PipeFlag],0
 25676 00002FBF 750D                    	jne	short NOREDIR
 25677 00002FC1 F606[AA02]FF            	test	byte [IfFlag],0FFh
 25678 00002FC6 7506                    	jnz	short NOREDIR
 25679 00002FC8 E88C00                  	call	TESTDOREIN
 25680 00002FCB E80600                  	call	TESTDOREOUT
 25681                                  NOREDIR:
 25682 00002FCE 59                      	pop	cx
 25683 00002FCF 5B                      	pop	bx
 25684 00002FD0 58                      	pop	ax
 25685 00002FD1 5A                      	pop	dx
 25686 00002FD2 1F                      	pop	ds
 25687                                  IOSET_RETN:	; 06/08/2024
 25688 00002FD3 C3                      	retn
 25689                                  
 25690                                  ; =============== S U B	R O U T	I N E =======================================
 25691                                  
 25692                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25693                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2CF3h
 25694                                  
 25695                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 25696                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:313Dh
 25697                                  TESTDOREOUT:
 25698 00002FD4 803E[C202]00            	cmp	byte [Re_OutStr],0
 25699                                  	;je	short NOREOUT  ; MSDOS 3.3
 25700                                  	; 26/02/2023
 25701                                  	;jne	short REOUTEXISTS
 25702                                  	;jmp	NOREOUT
 25703                                  	; 06/08/2024
 25704 00002FD9 74F8                    	jz	short IOSET_RETN
 25705                                  REOUTEXISTS:
 25706 00002FDB 803E[C102]00            	cmp	byte [Re_Out_App],0
 25707 00002FE0 745D                    	je	short REOUTCRT
 25708                                  
 25709 00002FE2 BA[C202]                	mov	dx,Re_OutStr
 25710                                  
 25711                                  	; 26/02/2023
 25712                                  	; MSDOS 6.0
 25713                                  	;mov	ax,(OPEN SHL 8) OR 2 ;AC011; Open for read/write
 25714 00002FE5 B8023D                  	mov	ax,3D02h
 25715                                  	; MSDOS 3.3
 25716                                  	;mov	ax,(OPEN<<8)|1  ; 3D01h ; Open for write
 25717                                  	
 25718                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25719 00002FE8 50                      	push	ax
 25720 00002FE9 CD21                    	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 25721                                  			; DS:DX	-> ASCIZ filename
 25722                                  			; AL = access mode
 25723                                  			; 1 - write
 25724 00002FEB 5B                      	pop	bx
 25725 00002FEC 724B                    	jc	short OpenWriteError
 25726                                  
 25727                                  	; 26/02/2023
 25728                                  	; MSDOS 6.0
 25729 00002FEE 89C3                    	mov	bx,ax
 25730                                  	;mov	ax,IOCTL<<8		;AN035; Get attributes of handle
 25731 00002FF0 B80044                  	mov	ax,4400h
 25732 00002FF3 CD21                    	int	21h			;AN035;
 25733                                  			; DOS - 2+ - IOCTL - GET DEVICE INFORMATION
 25734                                  			; BX = file or device handle
 25735 00002FF5 F6C280                  	test	dl,80h
 25736                                  	;test	dl,devid_ISDEV		;AN035; Is it a device?
 25737 00002FF8 7554                    	jnz	short SET_REOUT		;AN035; Yes, don't read from it
 25738                                  	
 25739                                  	;mov	ax,(LSEEK SHL 8) OR 2
 25740 00002FFA B80242                  	mov	ax,4202h
 25741 00002FFD B9FFFF                  	mov	cx,-1			;AC011; MOVE TO EOF -1
 25742 00003000 89CA                    	mov	dx,cx			;AC011;
 25743 00003002 CD21                    	int	21h
 25744                                  			; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 25745                                  			; AL = method: offset from end of file
 25746 00003004 0E                      	push	cs			;AN011; Get transient seg to DS
 25747 00003005 1F                      	pop	ds			;AN011;
 25748                                  	
 25749                                  	;mov	ax,(READ SHL 8) 	;AN011; Read one byte from the
 25750 00003006 B8003F                  	mov	ax,3F00h
 25751 00003009 B90100                  	mov	cx,1			;AN011;  file into one_char_val
 25752 0000300C BA[B19D]                	mov	dx,One_Char_Val		;AN011;
 25753 0000300F CD21                    	int	21h			;AN011;
 25754                                  			; DOS - 2+ - READ FROM FILE WITH HANDLE
 25755                                  			; BX = file handle, CX = number of bytes to read
 25756                                  			; DS:DX -> buffer
 25757 00003011 7226                    	jc	short OpenWriteError	;AN011; If error, exit
 25758 00003013 39C8                    	cmp	ax,cx			;AN017; Did we read 1 byte?
 25759 00003015 7517                    	jnz	short reout_0_length	;AN017; No - file must be 0 length
 25760                                  	
 25761 00003017 803E[B19D]1A            	cmp	byte [One_Char_Val],1Ah	;AN011; Was char an eof mark?
 25762 0000301C 8E1E[F59B]              	mov	ds,[RESSEG]		;AN011; Get resident segment back
 25763 00003020 752C                    	jne	short SET_REOUT		;AN011; No, just continue
 25764                                  	
 25765                                  	;mov	ax,(LSEEK<<8)|1		;AN011; EOF mark found
 25766 00003022 B80142                  	mov	ax,4201h
 25767 00003025 B9FFFF                  	mov	cx,-1			;AN011; LSEEK back one byte
 25768                                  setreout_p:	; 26/02/2023
 25769 00003028 89CA                    	mov	dx,cx			;AN011;
 25770 0000302A CD21                    	int	21h			;AN011;
 25771 0000302C EB20                    	jmp	short SET_REOUT
 25772                                  reout_0_length: 			;AN017; We have a 0 length file
 25773                                  	; ds = cs ; 26/02/2023
 25774                                  	;mov	ds,[cs:RESSEG] ; MSDOS 5.0 COMMAND.COM - TRANGROUP:2D50h
 25775                                  					;AN017; Get resident segment back
 25776                                  	; 26/02/2023
 25777 0000302E 8E1E[F59B]              	mov	ds,[RESSEG]
 25778                                  	;mov	ax,(LSEEK SHL 8)	;AN017; Move to beginning of file
 25779 00003032 B80042                  	mov	ax,4200h
 25780 00003035 31C9                    	xor	cx,cx			;AN017; Offset is 0
 25781                                  	;mov	dx,cx			;AN017;
 25782                                  	;int	21h			;AN017;
 25783                                  	;jmp	short SET_REOUT 	;AN017; now finish setting up redirection
 25784                                  	; 26/02/2023
 25785 00003037 EBEF                    	jmp	short setreout_p
 25786                                  
 25787                                  	; 26/02/2023
 25788                                  	; MSDOS 3.3
 25789                                  	;xor	dx,dx
 25790                                  	;xor	cx,cx
 25791                                  	;mov	bx,ax
 25792                                  	;mov	ax,(LSEEK<<8)|2 ; 4202h
 25793                                  	;int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 25794                                  	;		; AL = method: offset from end of file
 25795                                  	;jmp	short SET_REOUT
 25796                                  		
 25797                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25798                                  OpenWriteError:	
 25799                                  	;cmp	ax,5
 25800 00003039 83F805                  	cmp	ax,ERROR_ACCESS_DENIED
 25801 0000303C F9                      	stc
 25802                                  	;;je	short REDIRERR ; MSDOS 3.3
 25803                                  	; 26/02/2023
 25804                                  	;jnz	short REOUTCRT
 25805                                  	;jmp	REDIRERR
 25806 0000303D 743B                    	je	short REDIRERR
 25807                                  
 25808                                  REOUTCRT:	
 25809 0000303F BA[C202]                	mov	dx,Re_OutStr
 25810 00003042 31C9                    	xor	cx,cx
 25811                                  	;mov	ah,CREAT ; 3Ch
 25812 00003044 B43C                    	mov	ah,3Ch
 25813 00003046 50                      	push	ax
 25814 00003047 CD21                    	int	21h	; DOS -	2+ - CREATE A FILE WITH	HANDLE (CREAT)
 25815                                  			; CX = attributes for file
 25816                                  			; DS:DX	-> ASCIZ filename (may include drive and path)
 25817 00003049 5B                      	pop	bx
 25818                                  	;jc	short REDIRERR ; MSDOS 3.3
 25819                                  	; 26/02/2023
 25820                                  	;jnc	short NOREDIRERR
 25821                                  	;jmp	REDIRERR
 25822 0000304A 722E                    	jc	short REDIRERR
 25823                                  	
 25824                                  NOREDIRERR:
 25825 0000304C 89C3                    	mov	bx,ax
 25826                                  SET_REOUT:
 25827                                  
 25828                                  ; Mega sleaze!! We move the SFN from the new handle spot into the old stdout
 25829                                  ; spot. We invalidate the new JFN we got.
 25830                                  
 25831 0000304E B0FF                    	mov	al,0FFh
 25832                                  	;xchg	al,[bx+18h]
 25833 00003050 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 25834 00003053 A21900                  	mov	[PDB.JFN_TABLE+1],al
 25835                                  NOREOUT:	; 06/08/2024
 25836 00003056 C3                      	retn
 25837                                  
 25838                                  ; =============== S U B	R O U T	I N E =======================================
 25839                                  
 25840                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25841                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2CABh
 25842                                  
 25843                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 25844                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:30F5h
 25845                                  TESTDOREIN:
 25846 00003057 2E803E[A09B]00          	cmp	byte [cs:RE_INSTR],0
 25847                                  	;jz	short IOSET_RETN
 25848                                  	; 06/08/2024
 25849 0000305D 74F7                    	jz	short NOREOUT
 25850 0000305F 1E                      	push	ds
 25851 00003060 0E                      	push	cs
 25852 00003061 1F                      	pop	ds
 25853 00003062 BA[A09B]                	mov	dx,RE_INSTR
 25854                                  	;;mov	ax,OPEN*256 ; 3D00h
 25855                                  	;mov	ax,3D00h
 25856                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 25857                                  	;mov	ax,(OPEN*256)+SHARING_DENY_NONE
 25858 00003065 B8403D                  	mov	ax,3D40h
 25859 00003068 89C3                    	mov	bx,ax
 25860 0000306A CD21                    	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 25861                                  			; DS:DX	-> ASCIZ filename
 25862                                  			; AL = access mode
 25863                                  			; 0 - read
 25864 0000306C 1F                      	pop	ds
 25865                                  
 25866 0000306D 720B                    	jc	short REDIRERR
 25867                                  
 25868 0000306F 89C3                    	mov	bx,ax
 25869 00003071 B0FF                    	mov	al,0FFh
 25870                                  
 25871                                  ; Mega sleaze!! We move the SFN from the new handle spot into the old stdin
 25872                                  ; spot. We invalidate the new JFN we got.
 25873                                  
 25874                                  	;xchg	al,[bx+18h]
 25875 00003073 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 25876 00003076 A21800                  	mov	[PDB.JFN_TABLE],al
 25877 00003079 C3                      	retn
 25878                                  
 25879                                  ; ---------------------------------------------------------------------------
 25880                                  
 25881                                  ; We had some kind of error on the redirection. Figure out what the
 25882                                  ; appropriate message should be; BX has the system call that failed
 25883                                  
 25884                                  REDIRERR:
 25885 0000307A 0E                      	push	cs
 25886 0000307B 1F                      	pop	ds
 25887 0000307C E82E00                  	call	TriageError  ; MSDOS 6.0
 25888                                  	;call	GET_EXT_ERR_NUMBER ; MSDOS 3.3
 25889                                  
 25890                                  ; At this point, we have recognized the network-generated access denied error.
 25891                                  ; The correct message is in DX
 25892                                  
 25893 0000307F 83F841                  	cmp	ax,65
 25894 00003082 7408                    	je	short _CERRORJ	;AC000; just issue message returned
 25895 00003084 80FF3D                  	cmp	bh,OPEN ; 3Dh
 25896 00003087 7406                    	je	short OpenError
 25897 00003089 BA[F18F]                	mov	dx,FULLDIR_PTR
 25898                                  _CERRORJ:
 25899 0000308C E997FC                  	jmp	cerror
 25900                                  
 25901                                  OpenError:
 25902                                  ; The system call was an OPEN. Report either file not found or path not found.
 25903                                  
 25904                                  	; 26/02/2023
 25905                                  	; MSDOS 6.0
 25906                                  	;mov	byte [cs:msg_disp_class],1
 25907 0000308F 2EC606[D58F]01          	mov	byte [cs:msg_disp_class],ext_msg_class
 25908                                  				;AN000; set up extended error msg class
 25909 00003095 BA[D78F]                	mov	dx,extend_buf_ptr
 25910                                  				;AC000; get extended message pointer
 25911 00003098 2EA3[D78F]              	mov	[cs:extend_buf_ptr],ax
 25912                                  				;AN000; get message number in control block
 25913 0000309C E987FC                  	jmp	cerror
 25914                                  
 25915                                  	; 26/02/2023
 25916                                  	; MSDOS 3.3
 25917                                  	;mov	dx,FNOTFOUNDPTR
 25918                                  	;;cmp	ax,2
 25919                                  	;cmp	ax,ERROR_FILE_NOT_FOUND
 25920                                  	;je	short _CERRORJ
 25921                                  	;mov	dx,ACCDENPTR
 25922                                  	;;cmp	ax,5 ; Access denied error
 25923                                  	;cmp	ax,ERROR_ACCESS_DENIED
 25924                                  	;je	short _CERRORJ
 25925                                  	;	; ERROR_PATH_NOT_FOUND
 25926                                  	;mov	dx,PNOTFOUNDPTR
 25927                                  	;jmp	CERROR
 25928                                  
 25929                                  ; =============== S U B	R O U T	I N E =======================================
 25930                                  
 25931                                  ; Compute length of string (including NUL) in DS:SI into CX. Change no other
 25932                                  ; registers
 25933                                  
 25934                                  	; 26/02/2023 - Retro DOS v4.0 COMMAND.COM
 25935                                  dstrlen:
 25936 0000309F 50                      	push	ax
 25937 000030A0 31C9                    	xor	cx,cx
 25938 000030A2 FC                      	cld
 25939                                  dloop:
 25940 000030A3 AC                      	lodsb
 25941 000030A4 41                      	inc	cx
 25942 000030A5 08C0                    	or	al,al
 25943 000030A7 75FA                    	jnz	short dloop
 25944 000030A9 29CE                    	sub	si,cx
 25945 000030AB 58                      	pop	ax
 25946                                  TRIAGEERR_RETN:
 25947 000030AC C3                      	retn
 25948                                  
 25949                                  ; =============== S U B	R O U T	I N E =======================================
 25950                                  
 25951                                  ;Break	<Extended error support>
 25952                                  
 25953                                  TriageError:  ; MSDOS 6.0
 25954                                  
 25955                                  ; TriageError will examine the return from a carry-set system call and
 25956                                  ; return the correct error if applicable.
 25957                                  ;
 25958                                  ;   Inputs:	outputs from a carry-settable system call
 25959                                  ;		No system calls may be done in the interrim
 25960                                  ;   Outputs:	If carry was set on input
 25961                                  ;		   carry set on output
 25962                                  ;		   DX contains trangroup offset to printf message
 25963                                  ;		else
 25964                                  ;		   No registers changed
 25965                                  
 25966                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1EEEh
 25967                                  
 25968                                  ; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25969                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2D92h
 25970                                  
 25971                                  ; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25972                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 333Ch
 25973                                  
 25974                                  GET_EXT_ERR_NUMBER:  ; MSDOS 3.3
 25975 000030AD 73FD                    	jnc	short TRIAGEERR_RETN ; no carry => do nothing...
 25976 000030AF 9C                      	pushf
 25977 000030B0 53                      	push	bx
 25978 000030B1 51                      	push	cx
 25979 000030B2 56                      	push	si
 25980 000030B3 57                      	push	di
 25981 000030B4 55                      	push	bp
 25982 000030B5 06                      	push	es
 25983 000030B6 1E                      	push	ds
 25984 000030B7 50                      	push	ax
 25985 000030B8 52                      	push	dx
 25986 000030B9 B459                    	mov	ah,59h
 25987                                  	;mov	ah,GETEXTENDEDERROR
 25988 000030BB CD21                    	int	21h	; DOS -	3+ - GET EXTENDED ERROR	CODE
 25989                                  			; BX = version code (0000h for DOS 3.x)
 25990 000030BD 59                      	pop	cx
 25991 000030BE 5B                      	pop	bx		; restore original AX
 25992 000030BF BA[0090]                	mov	dx,ACCDEN_PTR
 25993 000030C2 83F841                  	cmp	ax,65		; network access denied?
 25994 000030C5 7404                    	je	short NoMove	; Yes, return it.
 25995 000030C7 89D8                    	mov	ax,bx
 25996 000030C9 89CA                    	mov	dx,cx
 25997                                  NoMove:
 25998 000030CB 1F                      	pop	ds
 25999 000030CC 07                      	pop	es
 26000 000030CD 5D                      	pop	bp
 26001 000030CE 5F                      	pop	di
 26002 000030CF 5E                      	pop	si
 26003 000030D0 59                      	pop	cx
 26004 000030D1 5B                      	pop	bx
 26005 000030D2 9D                      	popf
 26006 000030D3 C3                      	retn
 26007                                  
 26008                                  ; =============== S U B	R O U T	I N E =======================================
 26009                                  
 26010                                  	; Far call from resident portion/segment of COMMAND.COM
 26011                                  
 26012                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1F15h
 26013                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2DB9h
 26014                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3363h
 26015                                  
 26016                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26017                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26018                                  Triage_Init:
 26019 000030D4 E8D6FF                  	call	TriageError	 ; MSDOS 6.0
 26020                                  	;call	GET_EXT_ERR_NUMBER ; MSDOS 3.3
 26021 000030D7 CB                      	retf
 26022                                  
 26023                                  ; =============== S U B	R O U T	I N E =======================================
 26024                                  
 26025                                  ; MSDOS 6.0
 26026                                  
 26027                                  ; ****************************************************************
 26028                                  ; *
 26029                                  ; * ROUTINE:	 MOVE_TO_SRCBUF
 26030                                  ; *
 26031                                  ; * FUNCTION:	 Move ASCIIZ string from DS:SI to SRCBUF.  Change
 26032                                  ; *		 terminating 0 to 0dH.	Set PATHCNT to length of
 26033                                  ; *		 string.  Set PATHPOS to start of SRCBUF.
 26034                                  ; *
 26035                                  ; * INPUT:	 DS:SI points to ASCIIZ string
 26036                                  ; *		 ES    points to TRANGROUP
 26037                                  ; *
 26038                                  ; * OUTPUT:	 SRCBUF filled in with string terminated by 0dH
 26039                                  ; *		 PATHCNT set to length of string
 26040                                  ; *		 PATHPOS set to start of SRCBUF
 26041                                  ; *		 CX,AX	 changed
 26042                                  ; *
 26043                                  ; ****************************************************************
 26044                                  
 26045                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26046                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2CABh
 26047                                  Move_To_SrcBuf:
 26048 000030D8 56                      	push	si			;AN000;  save si,di
 26049 000030D9 57                      	push	di			;AN000;
 26050 000030DA 51                      	push	cx			;AN000;
 26051 000030DB BF[219E]                	mov	di,SrcBuf		;AN000;  set ES:DI to srcbuf
 26052 000030DE 31C9                    	xor	cx,cx			;AN000; clear cx for counint
 26053 000030E0 89C8                    	mov	ax,cx			;AN000; clear ax
 26054 000030E2 57                      	push	di			;AN000; save start of srcbuf
 26055 000030E3 AC                      	lodsb				;AN000; get a character from DS:SI
 26056                                  mts_get_chars:				;AN000;
 26057                                  	;cmp	al,0			;AN000; was it a null char?
 26058 000030E4 20C0                    	and 	al,al ; al = 0 ?
 26059 000030E6 7405                    	jz	short mts_end_string	;AN000; yes - exit
 26060 000030E8 AA                      	stosb				;AN000; no - store it in srcbuf
 26061 000030E9 41                      	inc	cx			;AN000; increment length count
 26062 000030EA AC                      	lodsb				;AN000; get a character from DS:SI
 26063 000030EB EBF7                    	jmp	short mts_get_chars	;AN000; go check it
 26064                                  mts_end_string: 			;AN000; we've reached the end of line
 26065                                  	;mov	al,END_OF_LINE_IN	;AN000; store 0Dh in srcbuf
 26066 000030ED B00D                    	mov	al,0Dh
 26067 000030EF AA                      	stosb				;AN000;
 26068 000030F0 5F                      	pop	di			;AN000; restore start of srcbuf
 26069 000030F1 0E                      	push	cs			;AN000; set DS to local segment
 26070 000030F2 1F                      	pop	ds			;AN000;
 26071 000030F3 890E[8D9D]              	mov	[PathCnt],cx		;AN000; set patchcnt to length count
 26072 000030F7 893E[8F9D]              	mov	[PathPos],di		;AN000; set pathpos to start of srcbuf
 26073 000030FB 59                      	pop	cx			;AN000; restore cx,di,si
 26074 000030FC 5F                      	pop	di			;AN000;
 26075 000030FD 5E                      	pop	si			;AN000;
 26076 000030FE C3                      	retn				;AN000; exit
 26077                                  
 26078                                  ;============================================================================
 26079                                  ; TPIPE.ASM, MSDOS 6.0, 1991
 26080                                  ;============================================================================
 26081                                  ; 03/10/2018 - Retro DOS v3.0
 26082                                  
 26083                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1F19h
 26084                                  
 26085                                  ; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26086                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2DE4h
 26087                                  
 26088                                  ; =============== S U B	R O U T	I N E =======================================
 26089                                  
 26090                                  	; 26/02/2023
 26091                                  SINGLETEST:
 26092 000030FF 1E                      	push	ds
 26093 00003100 2E8E1E[F59B]            	mov	ds,[cs:RESSEG]
 26094 00003105 833E[A502]00            	cmp	word [SingleCom],0
 26095 0000310A 7406                    	jz	short TESTDONE
 26096 0000310C 813E[A502]FFEF          	cmp	word [SingleCom],0EFFFh
 26097                                  TESTDONE:
 26098 00003112 1F                      	pop	ds
 26099 00003113 C3                      	retn
 26100                                  
 26101                                  ; =============== S U B	R O U T	I N E =======================================
 26102                                  
 26103                                  	; 26/02/2023
 26104                                  SetRest1:
 26105 00003114 B001                    	mov	al,1
 26106                                  
 26107                                  ; ---------------------------------------------------------------------------
 26108                                  
 26109                                  SETREST:
 26110 00003116 1E                      	push	ds
 26111 00003117 8E1E[F59B]              	mov	ds,[RESSEG]
 26112 0000311B A2[A102]                	mov	[RestDir],al
 26113 0000311E 1F                      	pop	ds
 26114 0000311F C3                      	retn
 26115                                  
 26116                                  ; =============== S U B	R O U T	I N E =======================================
 26117                                  
 26118                                  ; Note that we need to handle the same thing that RestDir handles: the
 26119                                  ; requirement that we try only once to restore the user's environment after
 26120                                  ; and INT 24 or the like. If the condition that causes the INT 24 does not
 26121                                  ; disappear, we just give up.
 26122                                  
 26123                                  	; 26/02/2023 - Retro DOS v4.0 COMMAND.COM
 26124                                  	;
 26125                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26126                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:33AFh
 26127                                  	;
 26128                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26129                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:324Fh
 26130                                  PIPEDEL:
 26131 00003120 1E                      	push	ds
 26132 00003121 52                      	push	dx
 26133 00003122 2E8E1E[F59B]            	mov	ds,[cs:RESSEG]
 26134                                  	;;;mov	dx,320h	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2E0Ch
 26135                                  	;;mov	dx,3EAh	; MSDOS 6.22 COMMAND.COM - TRANGROUP:33B1h
 26136                                  	;mov	dx,41Eh	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3256h
 26137                                  			; Pipe1 = offset RESGROUP:EndInit
 26138 00003127 BA[1503]                	mov	dx,Pipe1	; Clean up in case ^C
 26139                                  	;mov	ah,Unlink ; 41h 
 26140 0000312A B441                    	mov	ah,41h
 26141                                  	;int	21h	; DOS -	2+ - DELETE A FILE (UNLINK)
 26142                                  			; DS:DX	-> ASCIZ pathname of file to delete 
 26143                                  			;		(no wildcards allowed)
 26144                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26145 0000312C E88BD4                  	call	int_21h_indirect
 26146                                  
 26147                                  	;;;mov	dx,36Fh ; MSDOS 5.0 COMMAND.COM - TRANGROUP:2E13h
 26148                                  	;;mov	dx,439h	; MSDOS 6.22 COMMAND.COM - TRANGROUP:33BDh
 26149                                  	;mov	dx,46Dh	; PCDOS 7.1 COMMAND.COM - TRANGROUP:325Eh
 26150                                  			; Pipe2 = offset RESGROUP:EndInit+79
 26151 0000312F BA[6403]                	mov	dx,Pipe2
 26152                                  	;mov	ah,Unlink ; 41h
 26153 00003132 B441                    	mov	ah,41h
 26154                                  	;int	21h	; DOS -	2+ - DELETE A FILE (UNLINK)
 26155                                  			; DS:DX	-> ASCIZ pathname of file to delete 
 26156                                  			;		(no wildcards allowed)
 26157                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26158 00003134 E883D4                  	call	int_21h_indirect
 26159 00003137 5A                      	pop	dx
 26160 00003138 E86C02                  	call	PipeOff
 26161 0000313B C606[1403]00            	mov	byte [PipeFiles],0
 26162 00003140 1F                      	pop	ds
 26163 00003141 C3                      	retn
 26164                                  
 26165                                  ; ---------------------------------------------------------------------------
 26166                                  
 26167                                  	; 26/02/2023
 26168                                  PIPEERRSYN:
 26169 00003142 BA[AA90]                	mov	dx,SYNTMES_PTR	; MSG_1030 ; 06/08/2024
 26170 00003145 E8D8FF                  	call	PIPEDEL
 26171 00003148 0E                      	push	cs
 26172 00003149 1F                      	pop	ds
 26173 0000314A E9D9FB                  	jmp	cerror
 26174                                  
 26175                                  ; ---------------------------------------------------------------------------
 26176                                  
 26177                                  	; 26/02/2023
 26178                                  PIPERR:
 26179 0000314D 9C                      	pushf
 26180 0000314E E85CFF                  	call    TriageError
 26181                                  	;call	GET_EXT_ERR_NUMBER  ; MSDOS 3.3
 26182 00003151 50                      	push	ax		; Save results from TriageError
 26183 00003152 52                      	push	dx
 26184 00003153 BA[5D91]                	mov	dx,PIPEEMES_PTR
 26185 00003156 E8C7FF                  	call	PIPEDEL
 26186 00003159 0E                      	push	cs
 26187 0000315A 1F                      	pop	ds
 26188 0000315B E8C222                  	call	std_eprintf
 26189 0000315E 5A                      	pop	dx		; Restore results from TriageError
 26190 0000315F 58                      	pop	ax
 26191 00003160 9D                      	popf
 26192 00003161 83F841                  	cmp	ax,65		; network access denied
 26193 00003164 7503                    	jne	short TCOMMANDJ
 26194 00003166 E9BDFB                  	jmp	cerror
 26195                                  
 26196                                  TCOMMANDJ:
 26197 00003169 E998CF                  	jmp	TCOMMAND
 26198                                  
 26199                                  ; ---------------------------------------------------------------------------
 26200                                  
 26201                                  	; 27/02/2023 - Retro DOS v4.0 COMMAND.COM
 26202                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26203                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26204                                  PIPEPROCSTRT:
 26205 0000316C 8E1E[F59B]              	mov	ds,[RESSEG]
 26206 00003170 FE06[1403]              	inc	byte [PipeFiles] ; Flag that the pipe files exist
 26207                                  
 26208                                  	; MSDOS 6.0
 26209 00003174 06                      	push	es
 26210 00003175 57                      	push	di
 26211 00003176 1E                      	push	ds
 26212 00003177 56                      	push	si
 26213                                  	
 26214 00003178 1E                      	push	ds
 26215 00003179 06                      	push	es
 26216 0000317A 1F                      	pop	ds			;ds = TRANGROUP
 26217 0000317B BE[7097]                	mov	si,TempVarName		;ds:si = "TEMP="
 26218                                  
 26219                                  ;Some hideous code in Find_Name_In_Environment. Expects ds = TRANGROUP and
 26220                                  ;so the routine is not really general
 26221                                  
 26222 0000317E E836F5                  	call	find_name_in_environment
 26223                                  					;es:di points at path
 26224 00003181 1F                      	pop	ds			;ds = DATARES again
 26225 00003182 7220                    	jc	short no_temp_path
 26226                                  	
 26227 00003184 1E                      	push	ds
 26228 00003185 06                      	push	es
 26229 00003186 1F                      	pop	ds
 26230 00003187 07                      	pop	es			;swap ds and es
 26231 00003188 89FE                    	mov	si,di			;ds:si points at path
 26232                                  	
 26233 0000318A E8B702                  	call	skip_white		;skip white space chars
 26234                                  
 26235                                  ;This copies the path into both buffers -- Pipe1 & Pipe2
 26236                                  
 26237 0000318D E8C002                  	call	copy_pipe_path		;copy the pipe path
 26238                                  	
 26239                                  ;Check if the TEMP path is valid
 26240                                  
 26241 00003190 06                      	push	es
 26242 00003191 1F                      	pop	ds			;ds = DATARES
 26243                                  	;mov	dx,offset DATARES:Pipe1	;ds:dx = path to look for
 26244                                  	;;;mov	dx,320h ; MSDOS 5.0 - offset EndInit
 26245                                  	;;mov	dx,3EAh	; MSDOS 6.22 - offset EndInit
 26246                                  	;mov	dx,41Eh	; PCDOS 7.1 COMMAND.COM - offset EndInit
 26247 00003192 BA[1503]                	mov	dx,Pipe1
 26248                                  	;mov	ax,(CHMOD shl 8) or 0
 26249 00003195 B80043                  	mov	ax,4300h
 26250                                  	;int	21h
 26251                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26252 00003198 E81FD4                  	call	int_21h_indirect
 26253 0000319B 7207                    	jc	short no_temp_path
 26254                                  	
 26255 0000319D F7C11000                	test	cx,10h			;is it a directory?
 26256 000031A1 7501                    	jnz	short no_temp_path	;yes, continue (carry clear)
 26257                                  	
 26258 000031A3 F9                      	stc				;no, indicate fail
 26259                                  no_temp_path:
 26260 000031A4 5E                      	pop	si
 26261 000031A5 1F                      	pop	ds
 26262 000031A6 5F                      	pop	di
 26263 000031A7 07                      	pop	es
 26264 000031A8 730B                    	jnc	short crt_temp		;path found, create tempfiles
 26265                                  
 26266                                  	; 27/02/2023
 26267                                  	; MSDOS 3.3
 26268                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
 26269                                  	;				; Get current drive
 26270                                  	;int	21h ; DOS - GET DEFAULT DISK NUMBER
 26271                                  	;add	al,[cs:CAPITAL_A]
 26272                                  	;mov	byte [PIPE2],al		; Make pipe files in root of def drv
 26273                                  	;mov	bx,PIPE1
 26274                                  	;mov	[bx],al
 26275                                  	;xor	ah,ah			; nul terminate path names
 26276                                  	;mov	byte [PIPE1+3],ah
 26277                                  	;mov	byte [PIPE2+3],ah
 26278                                  
 26279                                  	; MSDOS 6.0
 26280                                  ;SR;
 26281                                  ; We want to create temp files in the current directory rather than in the 
 26282                                  ;root of the drive. This is because the number of files that can be present
 26283                                  ;in the root directory is fixed, whereas it is not so in subdirectories.
 26284                                  
 26285                                  	;mov	ah,'.'
 26286                                  	;mov	[Pipe1],ah	; = RESGROUP:EndInit
 26287                                  	;mov	[Pipe2],ah	; = RESGROUP:EndInit+79
 26288                                  	;xor	ah,ah
 26289                                  	;mov	[Pipe1+1],ah	; = RESGROUP:EndInit+1
 26290                                  	;mov	[Pipe2+1],ah		;create files in current dir
 26291                                  	; 27/02/2023
 26292 000031AA B92E00                  	mov	cx,002Eh
 26293 000031AD 890E[1503]              	mov	[Pipe1],cx
 26294 000031B1 890E[6403]              	mov	[Pipe2],cx
 26295                                  crt_temp:
 26296                                  	; MSDOS 6.0
 26297                                  	;mov	dx,offset DATARES:Pipe1	; = RESGROUP:EndInit
 26298                                  	;;mov	dx,320h ; MSDOS 5.0 COMMAND.COM
 26299                                  	;mov	dx,3EAh ; MSDOS 6.22 COMMAND.COM	
 26300 000031B5 BA[1503]                	mov	dx,Pipe1
 26301                                  	; MSDOS 3.3
 26302                                  	;mov	dx,bx
 26303                                  	
 26304                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26305 000031B8 31C9                    	xor	cx,cx
 26306                                  	;mov	ah,CREATETEMPFILE ; 5Ah ; the CreateTemp call
 26307 000031BA B45A                    	mov	ah,5Ah
 26308                                  	;int	21h
 26309                                  		; DOS -	3+ - CREATE UNIQUE FILE
 26310                                  		; DS:DX	-> ASCIZ directory path	name ending with a '' + 13 bytes
 26311                                  		;         to receive generated filename
 26312                                  		; CX = file attributes (only bits 0,1,2,5 may be set)
 26313                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26314 000031BC E8FBD3                  	call	int_21h_indirect
 26315 000031BF 728C                    	jc	short PIPERR	; Couldn't create
 26316                                  
 26317 000031C1 89C3                    	mov	bx,ax
 26318                                  	;mov	ah,CLOSE ; 3Eh	; Don't proliferate handles
 26319 000031C3 B43E                    	mov	ah,3Eh
 26320 000031C5 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 26321                                  			; BX = file handle
 26322                                  	;;;mov	dx,PIPE2
 26323                                  	;;;mov	dx,36Fh ; MSDOS 5.0 COMMAND.COM
 26324                                  	;;mov	dx,439h ; MSDOS 6.22 COMMAND.COM
 26325                                  	;mov	dx,46Dh ; PCDOS 7.1 COMMAND.COM
 26326 000031C7 BA[6403]                	mov	dx,Pipe2
 26327                                  	;mov	ah,CREATETEMPFILE ; 5Ah ; the CreateTemp call
 26328 000031CA B45A                    	mov	ah,5Ah
 26329                                  	;int	21h
 26330                                  		; DOS -	3+ - CREATE UNIQUE FILE
 26331                                  		; DS:DX	-> ASCIZ directory path	name ending with a '' + 13 bytes to
 26332                                  		; receive generated filename
 26333                                  		; CX = file attributes (only bits 0,1,2,5 may be set)
 26334                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26335 000031CC E8EBD3                  	call	int_21h_indirect
 26336                                  	; 17/04/2023
 26337                                  	;jc	short PIPERR
 26338                                  	; 27/02/2023
 26339 000031CF 7303                    	jnc	short pps1
 26340 000031D1 E979FF                  	jmp	PIPERR
 26341                                  pps1:
 26342 000031D4 89C3                    	mov	bx,ax
 26343 000031D6 B43E                    	mov	ah,CLOSE ; 3Eh	; Don't proliferate handles
 26344                                  	;int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 26345                                  				; BX = file handle
 26346                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26347 000031D8 E8DFD3                  	call	int_21h_indirect
 26348                                  	;
 26349                                  	;call	near ptr TESTDOREIN ; Set up a redirection if specified
 26350 000031DB E879FE                  	call	TESTDOREIN
 26351                                  	;;mov	si,[488h] ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 26352                                  	;mov	si,[4BCh] ; PCDOS 7.1 COMMAND.COM ; 06/08/2024
 26353 000031DE 8B36[B303]              	mov	si,[PipePtr]	; offset RESGROUP:EndInit+158
 26354 000031E2 833E[A502]FF            	cmp	word [SingleCom],-1 ; 0FFFFh
 26355 000031E7 7506                    	jne	short NOSINGP
 26356 000031E9 C706[A502]00F0          	mov	word [SingleCom],0F000h ; Flag single command pipe
 26357                                  NOSINGP:
 26358 000031EF EB2A                    	jmp	short FIRSTPIPE
 26359                                  
 26360                                  ; ---------------------------------------------------------------------------
 26361                                  
 26362                                  	; 27/02/2023 - Retro DOS v4.0 COMMAND.COM
 26363                                  	; 11/06/2026 - Retro DOS v4.2 COMMAND.COM
 26364                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26365                                  PIPEPROC:
 26366 000031F1 8026[9D02]FE            	and	byte [EchoFlag],0FEh  ; force current echo to be off
 26367                                  	;;mov	si,[488h] ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 26368 000031F6 8B36[B303]              	mov	si,[PipePtr]	; offset RESGROUP:EndInit+158
 26369 000031FA AC                      	lodsb
 26370                                  	; 27/02/2023
 26371 000031FB 3C7C                    	cmp	al,'|'		
 26372                                  	;;cmp	al,ALTPIPECHR	; Alternate pipe char? 	
 26373                                  	;je	short ISPIPE1	; Yes
 26374                                  	;cmp	al,'|'
 26375                                  	;;cmp	al,[cs:VBAR]
 26376 000031FD 7403                    	je	short ISPIPE1
 26377 000031FF E98600                  	jmp	PIPEEND		; Pipe done
 26378                                  ISPIPE1:
 26379 00003202 8B16[3604]              	mov	dx,[InPipePtr]	; Get the input file name
 26380                                  	;mov	ax,OPEN*256 ; 3D00h
 26381 00003206 B8003D                  	mov	ax,3D00h
 26382                                  	;int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 26383                                  			; DS:DX	-> ASCIZ filename
 26384                                  			; AL = access mode
 26385                                  			; 0 - read
 26386                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26387 00003209 E8AED3                  	call	int_21h_indirect
 26388                                  PIPEERRJ:
 26389 0000320C 7303                    	jnc	short NO_PIPEERR
 26390 0000320E E93CFF                  	jmp	PIPERR		; Lost the pipe file
 26391                                  NO_PIPEERR:
 26392 00003211 89C3                    	mov	bx,ax
 26393 00003213 B0FF                    	mov	al,0FFh
 26394                                  	;xchg	al,[bx+18h]
 26395 00003215 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 26396 00003218 A21800                  	mov	[PDB.JFN_TABLE],al ; Redirect
 26397                                  FIRSTPIPE:
 26398 0000321B BF[569A]                	mov	di,COMBUF+2
 26399 0000321E 31C9                    	xor	cx,cx
 26400 00003220 803C0D                  	cmp	byte [si],0Dh	; '|<CR>'
 26401 00003223 7503                    	jne	short PIPEOK1
 26402                                  PIPEERRSYNJ:
 26403 00003225 E91AFF                  	jmp	PIPEERRSYN
 26404                                  PIPEOK1:
 26405                                  	;;;mov	al,[cs:VBAR]
 26406                                  	; 27/02/2023
 26407                                  	;;mov	al,vbar
 26408                                  	;mov	al,'|'
 26409                                  	;cmp	[si],al		; '||'
 26410                                  	;je	short PIPEERRSYNJ
 26411 00003228 803C7C                  	cmp	byte [si],'|'
 26412                                  	;cmp	byte [si],ALTPIPECHR ; '##' or '|#'?
 26413 0000322B 74F8                    	je	short PIPEERRSYNJ
 26414                                  PIPECOMLP:
 26415 0000322D AC                      	lodsb
 26416 0000322E AA                      	stosb
 26417                                  	; 27/02/2023
 26418 0000322F E82FF5                  	call	testkanj
 26419 00003232 7405                    	jz	short NOTKANJ5
 26420 00003234 A4                      	movsb
 26421                                  ;  Added following 2 commands to the fix pipe bug.
 26422 00003235 41                      	inc	cx		;AN000;  3/3/KK
 26423 00003236 41                      	inc	cx		;AN000;  3/3/KK
 26424 00003237 EBF4                    	jmp	short PIPECOMLP
 26425                                  NOTKANJ5:
 26426 00003239 3C0D                    	cmp	al,0Dh
 26427 0000323B 7439                    	je	short LASTPIPE
 26428 0000323D 41                      	inc	cx
 26429                                  	; 27/02/2023
 26430 0000323E 3C7C                    	cmp	al,'|'
 26431                                  	;cmp	al,ALTPIPECHR
 26432                                  	;je	short ISPIPE2
 26433                                  	;;cmp	al,[cs:VBAR]
 26434                                  	;cmp	al,vbar
 26435 00003240 75EB                    	jne	short PIPECOMLP
 26436                                  ISPIPE2:
 26437 00003242 26C645FF0D              	mov	byte [es:di-1],0Dh
 26438 00003247 49                      	dec	cx
 26439                                  	;mov	[cs:COMBUF+1],cl
 26440                                  	; 27/02/2023
 26441 00003248 26880E[559A]            	mov	[es:COMBUF+1],cl
 26442 0000324D 4E                      	dec	si
 26443                                  	;;mov	[3BEh],si ; MSDOS 5.0 COMMAND.COM
 26444                                  	; 11/06/2023 - MSDOS 6.22 COMMAND.COM
 26445                                  	;mov	[488h],si ; [PipePtr] = [EndInit+158]
 26446                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26447                                  	;mov	[4BCh],si ; [PipePtr] = [EndInit+158]
 26448 0000324E 8936[B303]              	mov	[PipePtr],si		; On to next pipe element
 26449                                  			; mov [EndInit+158],si
 26450 00003252 8B16[3804]              	mov	dx,[OutPipePtr]
 26451 00003256 51                      	push	cx
 26452 00003257 31C9                    	xor	cx,cx
 26453                                  	;mov	ax,CREAT*256 ; 3C00h
 26454 00003259 B8003C                  	mov	ax,3C00h
 26455                                  	;int	21h	; DOS -	2+ - CREATE A FILE WITH	HANDLE (CREAT)
 26456                                  			; CX = attributes for file
 26457                                  			; DS:DX	-> ASCIZ filename (may include drive and path)
 26458                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26459 0000325C E85BD3                  	call	int_21h_indirect
 26460 0000325F 59                      	pop	cx
 26461 00003260 72AA                    	jc	short PIPEERRJ		; Lost the file
 26462 00003262 89C3                    	mov	bx,ax
 26463 00003264 B0FF                    	mov	al,0FFh
 26464                                  	;xchg	al,[bx+18h]
 26465 00003266 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 26466 00003269 A21900                  	mov	[PDB.JFN_TABLE+1],al
 26467 0000326C 8716[3604]              	xchg	dx,[InPipePtr]	; Swap for next element of pipe
 26468 00003270 8916[3804]              	mov	[OutPipePtr],dx
 26469 00003274 EB0D                    	jmp	short PIPECOM
 26470                                  LASTPIPE:
 26471                                  	;mov	[cs:COMBUF+1],cl 
 26472                                  	; 27/02/2023
 26473 00003276 26880E[559A]            	mov	[es:COMBUF+1],cl
 26474 0000327B 4E                      	dec	si
 26475                                  	;;;mov	[3BEh],si ; MSDOS 5.0 COMMAND.COM
 26476                                  	;;mov	[488h],si ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 26477                                  	;mov	[4BCh],si ; PCDOS 7.1 COMMAND.COM ; 06/08/2024
 26478 0000327C 8936[B303]              	mov	[PipePtr],si	; Point at the CR (anything not '|' will do)
 26479                                  		; mov [EndInit+158],si
 26480 00003280 E851FD                  	call	TESTDOREOUT	; Set up the redirection if specified
 26481                                  PIPECOM:
 26482 00003283 0E                      	push	cs
 26483 00003284 1F                      	pop	ds
 26484 00003285 E994D0                  	jmp	NOPIPEPROC	; Process the pipe element
 26485                                  PIPEEND:
 26486 00003288 E895FE                  	call	PIPEDEL
 26487 0000328B 813E[A502]00F0          	cmp	word [SingleCom],0F000h
 26488 00003291 7506                    	jnz	short NOSINGP2
 26489 00003293 C706[A502]FFFF          	mov	word [SingleCom],-1 ; 0FFFFh ; Make it return
 26490                                  NOSINGP2:
 26491 00003299 E968CE                  	jmp	TCOMMAND
 26492                                  
 26493                                  ; =============== S U B	R O U T	I N E =======================================
 26494                                  
 26495                                  ; Date and time are set during initialization and use
 26496                                  ; this routines since they need to do a long return
 26497                                  
 26498                                  	; 27/02/2023 - Retro DOS v4.0 COMMAND.COM
 26499                                  
 26500                                  DATINIT:
 26501 0000329C 2E8C1E[F59B]            	mov	[cs:RESSEG],ds	; SetInitFlag needs resseg initialized
 26502 000032A1 06                      	push	es
 26503 000032A2 1E                      	push	ds		; Going to use the previous stack
 26504 000032A3 8CC8                    	mov	ax,cs		; Set up the appropriate segment registers
 26505 000032A5 8EC0                    	mov	es,ax
 26506 000032A7 8ED8                    	mov	ds,ax
 26507 000032A9 E85922                  	call	TSYSLOADMSG ; MSDOS 6.0 ; AN000; preload messages
 26508 000032AC BA[9EA5]                	mov	dx,INTERNATVARS
 26509 000032AF B80038                  	mov	ax,3800h
 26510                                  	;mov	ax,INTERNATIONAL*256 ; 3800h
 26511                                  	;int	21h	; DOS -	2+ - GET COUNTRY-DEPENDENT INFORMATION
 26512                                  			; get current-country info
 26513                                  			; DS:DX	-> buffer for returned info
 26514                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26515 000032B2 E805D3                  	call	int_21h_indirect
 26516                                  	; 20/10/2018
 26517 000032B5 C70681000D00            	mov	word [81h],0Dh ; Want to prompt for date during initialization
 26518 000032BB C606[549A]80            	mov	byte [COMBUF],128 ; Init COMBUF
 26519 000032C0 C706[559A]010D          	mov	word [COMBUF+1],0D01h
 26520 000032C6 E80600                  	call	DATE
 26521 000032C9 E86300                  	call	CTIME
 26522 000032CC 1F                      	pop	ds
 26523 000032CD 07                      	pop	es
 26524 000032CE CB                      	retf	; far return
 26525                                  
 26526                                  ; =============== S U B	R O U T	I N E =======================================
 26527                                  
 26528                                  ; MSDOS 6.0
 26529                                  
 26530                                  ; ****************************************************************
 26531                                  ; *
 26532                                  ; * ROUTINE:	 DATE - Set system date
 26533                                  ; *
 26534                                  ; * FUNCTION:	 If a date is specified, set the system date,
 26535                                  ; *		 otherwise display the current system date and
 26536                                  ; *		 prompt the user for a new date.  If an invalid
 26537                                  ; *		 date is specified, issue an error message and
 26538                                  ; *		 prompt for a new date.  If the user enters
 26539                                  ; *		 nothing when prompted for a date, terminate.
 26540                                  ; *
 26541                                  ; * INPUT:	 command line at offset 81H
 26542                                  ; *
 26543                                  ; * OUTPUT:	 none
 26544                                  ; *
 26545                                  ; ****************************************************************
 26546                                  
 26547                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26548                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2FC4h
 26549                                  
 26550                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26551                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:356Eh
 26552                                  
 26553                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26554                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3417h
 26555                                  DATE:
 26556 000032CF BE8100                  	mov	si,81h			; Accepting argument for date inline
 26557 000032D2 BF[5296]                	mov	di,PARSE_DATE		;AN000; Get address of PARSE_DATE
 26558 000032D5 31C9                    	xor	cx,cx			;AN000; clear counter for positionals
 26559 000032D7 31D2                    	xor	dx,dx			;AN000;
 26560 000032D9 E89016                  	call	cmd_parse		;AC000; call parser
 26561                                  
 26562                                  	; 27/02/2023
 26563                                  	;cmp	ax,-1
 26564                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26565                                  	;je	short PRMTDAT 		;AC000; yes - go ask for date
 26566                                  	;;cmp	ax,0
 26567                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26568                                  	;;jne	short DATERR		;AN000; yes - go issue message
 26569                                  	; 26/04/2023
 26570                                  	;or	ax,ax ; ax = 0 ?
 26571                                  	;jnz	short DATERR
 26572                                  	;;jmp	short COMDAT		;AC000; we have a date
 26573                                  	; 11/06/2023
 26574 000032DC 40                      	inc	ax  ; cmp ax,-1
 26575 000032DD 7429                    	jz	short PRMTDAT ; 0FFFFh -> 0
 26576 000032DF 48                      	dec	ax  ; cmp ax,0
 26577 000032E0 7542                    	jnz	short DATERR ; 1 -> 0
 26578                                  	; ax = 0
 26579                                  
 26580                                  	; 27/02/2023
 26581                                  COMDAT:
 26582 000032E2 8B0E[F7A5]              	mov	cx,[DATE_YEAR]		;AC000; get parts of date in
 26583 000032E6 8A36[F9A5]              	mov	dh,[DATE_MONTH]		;AC000;  cx and dx for set
 26584 000032EA 8A16[FAA5]              	mov	dl,[DATE_DAY]		;AC000;  date function call.
 26585 000032EE 51                      	push	cx			;AC000; save date
 26586 000032EF 52                      	push	dx			;AC000;
 26587 000032F0 B90100                  	mov	cx,1			;AC000; set 1 positional entered
 26588 000032F3 31D2                    	xor	dx,dx			;AN029;
 26589 000032F5 E87416                  	call	cmd_parse		;AN029; call parser
 26590 000032F8 3CFF                    	cmp	al,0FFh ; -1
 26591                                  	;cmp	al,END_OF_LINE		;AN029; Are we at end of line?
 26592 000032FA 5A                      	pop	dx			;AC000; retrieve date
 26593 000032FB 59                      	pop	cx			;AC000;
 26594 000032FC 7526                    	jnz	short DATERR		;AC000; extra stuff on line - try again
 26595                                  	; 26/04/2023
 26596                                  	;mov	ah,SET_DATE		;yes - set date
 26597 000032FE B42B                    	mov	ah,2Bh
 26598                                  	;int	21h
 26599                                  			; DOS - SET CURRENT DATE
 26600                                  			; DL = day, DH = month, CX = year
 26601                                  			; Return: AL = 00h if no error /= FFh if bad value sent to routine
 26602                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26603 00003300 E8B7D2                  	call	int_21h_indirect
 26604 00003303 08C0                    	or	al,al
 26605 00003305 751D                    	jnz	short DATERR
 26606                                  date_end:
 26607 00003307 C3                      	retn
 26608                                  
 26609                                  PRMTDAT:
 26610                                  	; Print "Current date is
 26611 00003308 E81808                  	call	GetDate 		;AN000; get date for output
 26612                                  
 26613 0000330B 86D6                    	xchg	dh,dl			;AN000; switch month & day
 26614 0000330D 890E[C090]              	mov	[CurDat_yr],cx		;AC000; put year into message control block
 26615 00003311 8916[C290]              	mov	[CurDat_mo_day],dx	;AC000; put month and day into message control block
 26616 00003315 BA[B090]                	mov	dx,CurDat_Ptr		;AC000; set up message for output
 26617 00003318 E80D21                  	call	std_printf
 26618                                  
 26619                                  ;AD061; mov	word [CurDat_yr],0	;AC000; reset year, month and day
 26620                                  ;AD061; mov	word [CurDat_mo_day],0 	;AC000;  pointers in control block
 26621                                  
 26622                                  GET_NEW_DATE:				;AN000;
 26623 0000331B E8BF00                  	call	GETDAT			;AC000; prompt user for date
 26624                                  	
 26625                                  	; 11/06/2023
 26626                                  	;cmp	ax,0FFFFh ; -1
 26627                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26628                                  	;je	short date_end		;AC000; yes - exit
 26629                                  	; 26/04/2023
 26630                                  	;;cmp	ax,0
 26631                                  	;;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26632                                  	;;;jnz	short DATERR		;AN000; yes - go issue message
 26633                                  	;; 27/02/2023
 26634                                  	;;jz	short COMDAT
 26635                                  	; 26/04/2023
 26636                                  	;and	ax,ax ; 0 ?
 26637                                  	;jz	short COMDAT
 26638                                  
 26639                                  	; 11/06/2023
 26640 0000331E 40                      	inc	ax  ; cmp ax,-1
 26641 0000331F 74E6                    	jz	short date_end ; 0FFFFh -> 0
 26642 00003321 48                      	dec	ax  ; cmp ax,0
 26643 00003322 74BE                    	jz	short COMDAT ; 1 -> 0
 26644                                  	; ax > 0
 26645                                  
 26646                                  ;COMDAT:
 26647                                  ;	....
 26648                                  DATERR:
 26649 00003324 E852F6                  	call	CRLF2			;AN028; print out a blank line
 26650 00003327 BA[AD90]                	mov	dx,BADDAT_PTR
 26651 0000332A E8FB20                  	call	std_printf
 26652 0000332D EBEC                    	jmp	short GET_NEW_DATE	;AC000; get date again
 26653                                  
 26654                                  ; =============== S U B	R O U T	I N E =======================================
 26655                                  
 26656                                  ; MSDOS 6.0
 26657                                  
 26658                                  ; TIME gets and sets the time
 26659                                  
 26660                                  ; ****************************************************************
 26661                                  ; *
 26662                                  ; * ROUTINE:	 TIME - Set system time
 26663                                  ; *
 26664                                  ; * FUNCTION:	 If a time is specified, set the system time,
 26665                                  ; *		 otherwise display the current system time and
 26666                                  ; *		 prompt the user for a new time.  If an invalid
 26667                                  ; *		 time is specified, issue an error message and
 26668                                  ; *		 prompt for a new time.  If the user enters
 26669                                  ; *		 nothing when prompted for a time, terminate.
 26670                                  ; *
 26671                                  ; * INPUT:	 command line at offset 81H
 26672                                  ; *
 26673                                  ; * OUTPUT:	 none
 26674                                  ; *
 26675                                  ; ****************************************************************
 26676                                  
 26677                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26678                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:302Dh
 26679                                  
 26680                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26681                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:35D7h
 26682                                  
 26683                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26684                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3481h
 26685                                  CTIME:
 26686 0000332F BE8100                  	mov	si,81h			; Accepting argument for time inline
 26687 00003332 BF[6496]                	mov	di,PARSE_TIME		;AN000; Get address of PARSE_time
 26688 00003335 31C9                    	xor	cx,cx			;AN000; clear counter for positionals
 26689 00003337 31D2                    	xor	dx,dx			;AN000;
 26690 00003339 E83016                  	call	cmd_parse		;AC000; call parser
 26691                                  	
 26692                                  	; 27/02/2023
 26693                                  	;cmp	ax,-1
 26694                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26695                                  	;je	short PRMTTIM 		;AC000; yes - prompt for time
 26696                                  	;;cmp	ax,0
 26697                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26698                                  	;;jne	short TIMERR		;AN000; yes - go issue message
 26699                                  	;and	ax,ax ; ax = 0 ?
 26700                                  	;jnz	short TIMERR
 26701                                  	;;jmp	short COMTIM		;AC000; we have a time
 26702                                  	; 11/06/2023
 26703 0000333C 40                      	inc	ax  ; cmp ax,-1
 26704 0000333D 742D                    	jz	short PRMTTIM ; 0FFFFh -> 0
 26705 0000333F 48                      	dec	ax  ; cmp ax,0
 26706 00003340 754A                    	jnz	short TIMERR ; 1 -> 0
 26707                                  	; ax = 0
 26708                                  	
 26709                                  	; 27/02/2023
 26710                                  COMTIM:
 26711 00003342 8A2E[FFA5]              	mov	ch,[TIME_HOUR]		;AC000; get parts of time in
 26712 00003346 8A0E[00A6]              	mov	cl,[TIME_MINUTES]	;AC000;  cx and dx for set
 26713 0000334A 8A36[01A6]              	mov	dh,[TIME_SECONDS]	;AC000;  time function call
 26714 0000334E 8A16[02A6]              	mov	dl,[TIME_FRACTION]	;AC000;
 26715 00003352 51                      	push	cx			;AC000; save time
 26716 00003353 52                      	push	dx			;AC000;
 26717 00003354 B90100                  	mov	cx,1			;AC000; set 1 positional parm entered
 26718 00003357 31D2                    	xor	dx,dx			;AN029;
 26719 00003359 E81016                  	call	cmd_parse		;AN029; call parser
 26720 0000335C 3CFF                    	cmp	al, -1
 26721                                  	;cmp	al,END_OF_LINE		;AN029; Are we at end of line?
 26722 0000335E 5A                      	pop	dx			;AC000; retieve time
 26723 0000335F 59                      	pop	cx			;AC000;
 26724 00003360 752A                    	jnz	short TIMERR		;AC000; extra stuff on line - try again
 26725                                  SAVTIM:
 26726                                  	;mov	ah,SET_TIME
 26727 00003362 B42D                    	mov	ah,2Dh
 26728                                  	;int	21h
 26729                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26730 00003364 E853D2                  	call	int_21h_indirect
 26731 00003367 08C0                    	or	al,al
 26732 00003369 7521                    	jnz	short TIMERR		;AC000; if an error occured, try again
 26733                                  time_end:
 26734 0000336B C3                      	retn
 26735                                  
 26736                                  PRMTTIM:
 26737                                  	;Printf "Current time is ... "
 26738                                  
 26739                                  	;mov	ah,Get_Time		;AC000; get the current time
 26740 0000336C B42C                    	mov	ah,2Ch
 26741                                  	;int	21h			;AC000;   Get time in CX:DX
 26742                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26743 0000336E E849D2                  	call	int_21h_indirect
 26744 00003371 86CD                    	xchg	ch,cl			;AN000; switch hours & minutes
 26745 00003373 86D6                    	xchg	dh,dl			;AN000; switch seconds & hundredths
 26746 00003375 890E[E290]              	mov	[CurTim_hr_min],cx	;AC000; put hours and minutes into message subst block
 26747 00003379 8916[E490]              	mov	[CurTim_Sec_hn],dx	;AC000; put seconds and hundredths into message subst block
 26748 0000337D BA[DD90]                	mov	dx,CurTim_Ptr		;AC000; set up message for output
 26749 00003380 E8A520                  	call	std_printf
 26750                                  
 26751                                  ;AD061; mov	word [CurTim_hr_min],0 	;AC000; reset hour, minutes, seconds, and hundredths
 26752                                  ;AD061; mov	word [CurTim_Sec_hn],0 	;AC000;  pointers in control block
 26753                                  
 26754                                  GET_NEW_TIME:
 26755 00003383 E8B100                  	call	GETTIM			;AC000;
 26756                                  	
 26757                                  	; 11/06/2023
 26758                                  	;cmp	ax,-1
 26759                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26760                                  	;je	short time_end		;AC000;
 26761                                  	;;cmp	ax,0
 26762                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26763                                  	;;jne	short TIMERR		;AN000; yes - go issue message
 26764                                  	;or	ax,ax  ; ax = 0 ?
 26765                                  	;;jnz	short TIMERR
 26766                                  	; 27/02/2023
 26767                                  	;jz	short COMTIM
 26768                                  
 26769                                  	; 11/06/2023
 26770 00003386 40                      	inc	ax  ; cmp ax,-1
 26771 00003387 74E2                    	jz	short time_end ; 0FFFFh -> 0
 26772 00003389 48                      	dec	ax  ; cmp ax,0
 26773 0000338A 74B6                    	jz	short COMTIM ; 1 -> 0
 26774                                  	; ax > 0
 26775                                  
 26776                                  ;COMTIM:
 26777                                  ;	....
 26778                                  TIMERR:
 26779 0000338C E8EAF5                  	call	CRLF2			;AN028; print out a blank line
 26780 0000338F BA[DA90]                	mov	dx,BadTim_Ptr
 26781 00003392 E89320                  	call	std_printf		; Print error message
 26782 00003395 EBEC                    	jmp	short GET_NEW_TIME	;AC000; Try again
 26783                                  
 26784                                  ; =============== S U B	R O U T	I N E =======================================
 26785                                  
 26786                                  ; MSDOS 6.0
 26787                                  
 26788                                  ; Set the special flag in the INIT flag to the value in CX.
 26789                                  
 26790                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26791                                  SetInitFlag:
 26792 00003397 8E1E[F59B]              	mov	ds,[RESSEG]
 26793                                  
 26794 0000339B 8026[1203]FD            	and	byte [InitFlag],~INITSPECIAL ; 0FDh ; not initspecial
 26795                                  	;and	byte [InitFlag],0FDh
 26796 000033A0 080E[1203]              	or	byte [InitFlag],cl
 26797 000033A4 0E                      	push	cs
 26798 000033A5 1F                      	pop	ds
 26799 000033A6 C3                      	retn
 26800                                  
 26801                                  ; =============== S U B	R O U T	I N E =======================================
 26802                                  
 26803                                  ; MSDOS 6.0
 26804                                  
 26805                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26806                                  PipeOff:
 26807 000033A7 1E                      	push	ds
 26808 000033A8 50                      	push	ax
 26809 000033A9 2E8E1E[F59B]            	mov	ds,[cs:RESSEG]
 26810 000033AE 30C0                    	xor	al,al
 26811 000033B0 8606[1303]              	xchg	[PipeFlag],al
 26812 000033B4 08C0                    	or	al,al
 26813 000033B6 7404                    	jz	short PipeOffDone
 26814 000033B8 D02E[9D02]              	shr	byte [EchoFlag],1
 26815                                  PipeOffDone:
 26816 000033BC 58                      	pop	ax
 26817 000033BD 1F                      	pop	ds
 26818 000033BE C3                      	retn
 26819                                  
 26820                                  ; =============== S U B	R O U T	I N E =======================================
 26821                                  
 26822                                  ; MSDOS 6.0
 26823                                  
 26824                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26825                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26826                                  	; 08/08/2024 - Retro DOS v5.0 COMMAND.COM
 26827                                  PRINT_TIME:
 26828                                  	;mov	ah,Get_Time
 26829 000033BF B42C                    	mov	ah,2Ch
 26830                                  	;int	21h			; Get time in CX:DX
 26831                                  	; 08/08/2024 - PCDOS 7.1 COMMAND.COM
 26832 000033C1 E8F6D1                  	call	int_21h_indirect
 26833                                  
 26834 000033C4 06                      	push	es
 26835 000033C5 0E                      	push	cs
 26836 000033C6 07                      	pop	es
 26837 000033C7 86CD                    	xchg	ch,cl			;AN000; switch hours & minutes
 26838 000033C9 86D6                    	xchg	dh,dl			;AN000; switch seconds & hundredths
 26839 000033CB 2E890E[2492]            	mov	[cs:PromTim_hr_min],cx	;AC000; put hours and minutes into message subst block
 26840 000033D0 2E8916[2692]            	mov	[cs:PromTim_Sec_hn],dx	;AC000; put seconds and hundredths into message subst block
 26841 000033D5 BA[1F92]                	mov	dx,promtim_ptr		;AC000; set up message for output
 26842 000033D8 E84D20                  	call	std_printf
 26843                                  
 26844                                  ;AD061; mov	word [cs:PromTim_hr_min],0
 26845                                  					;AC000; reset hour, minutes, seconds, and hundredths
 26846                                  ;AD061; mov	word [cs:PromTim_Sec_hn],0
 26847                                  					;AC000;  pointers in control block
 26848 000033DB 07                      	pop	es
 26849 000033DC C3                      	retn
 26850                                  
 26851                                  ; =============== S U B	R O U T	I N E =======================================
 26852                                  
 26853                                  ; MSDOS 6.0
 26854                                  
 26855                                  ; ****************************************************************
 26856                                  ; *
 26857                                  ; * ROUTINE:	 GETDAT - Prompt user for date
 26858                                  ; *
 26859                                  ; * FUNCTION:	 Gets the date format from the COUNTRY DEPENDENT
 26860                                  ; *		 INFORMATION and issues the "Enter new date"
 26861                                  ; *		 message with the proper date format. COMBUF
 26862                                  ; *		 is reset to get a date from the command line.
 26863                                  ; *		 The PARSE_DATE blocks are then reset and the
 26864                                  ; *		 PARSE function call is issued.
 26865                                  ; *
 26866                                  ; * INPUT:	 NONE
 26867                                  ; *
 26868                                  ; * OUTPUT:	 COMBUF
 26869                                  ; *		 PARSER RETURN CODES
 26870                                  ; *
 26871                                  ; ****************************************************************
 26872                                  
 26873                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26874                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:30E2h
 26875                                  
 26876                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26877                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:368Ch
 26878                                  
 26879                                  	; 08/08/2024 - Retro DOS v5.0 COMMAND.COM
 26880                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3539h
 26881                                  GETDAT:
 26882                                  	;mov	ax,(International SHL 8)
 26883 000033DD B80038                  	mov	ax,3800h
 26884                                  					; Determine what format the date
 26885 000033E0 BA5C00                  	mov	dx,5Ch			;  should be entered in and
 26886                                  	;int	21h			;  print a message describing it
 26887                                  			; DOS - 2+ - GET COUNTRY-DEPENDENT INFORMATION
 26888                                  			; get current-country info
 26889                                  			; DS:DX -> buffer for returned info
 26890                                  	; 08/08/2024 - PCDOS 7.1 COMMAND.COM
 26891 000033E3 E8D4D1                  	call	int_21h_indirect
 26892 000033E6 89D6                    	mov	si,dx
 26893 000033E8 AD                      	lodsw
 26894 000033E9 2E8B16[FD91]            	mov	dx,[cs:usadat_ptr]	;AC000; get mm-dd-yy
 26895 000033EE 48                      	dec	ax
 26896 000033EF 780C                    	js	short printformat
 26897 000033F1 2E8B16[0092]            	mov	dx,[cs:eurdat_ptr]	;AC000; get dd-mm-yy
 26898 000033F6 7405                    	jz	short printformat
 26899 000033F8 2E8B16[0392]            	mov	dx,[cs:japdat_ptr]	;AC000; get yy-mm-dd
 26900                                  printformat:
 26901 000033FD 89D0                    	mov	ax,dx			;AN000; get message number of format
 26902                                  	;mov	dh,util_msg_class	;AN000; this is a utility message
 26903 000033FF B6FF                    	mov	dh,-1 ; 0FFh
 26904 00003401 E80721                  	call	TSYSGETMSG		;AN000; get the address of the message
 26905 00003404 2E8936[D190]            	mov	[cs:NewDat_Format],si	;AN000; put the address in subst block
 26906 00003409 BA[CC90]                	mov	dx,NewDat_Ptr		;AC000; get address of message to print
 26907 0000340C E81920                  	call	std_printf
 26908                                  	;mov	word [cs:NewDat_Format],no_subst
 26909                                  					;AN000; reset subst block
 26910 0000340F 2EC706[D190]0000        	mov	word [cs:NewDat_Format],0
 26911                                  
 26912                                  	; 28/02/2023
 26913 00003416 BF[5296]                	mov	di,PARSE_DATE		;AN000; Get address of PARSE_DATE
 26914                                  ; 28/02/2023
 26915                                  gettim_p:	
 26916                                  	;mov	ah,Std_Con_String_Input
 26917 00003419 B40A                    	mov	ah,0Ah
 26918 0000341B BA[549A]                	mov	dx,COMBUF
 26919 0000341E B90200                  	mov	cx,INITSPECIAL ; 2	; Set bit in InitFlag that indicates
 26920 00003421 E873FF                  	call	SetInitFlag		;  prompting for date.
 26921                                  	;int	21h			; Get input line
 26922                                  	; 08/08/2024 - PCDOS 7.1 COMMAND.COM
 26923 00003424 E893D1                  	call	int_21h_indirect
 26924 00003427 31C9                    	xor	cx,cx			; Reset bit in InitFlag that indicates
 26925 00003429 E86BFF                  	call	SetInitFlag		;  prompting for date.
 26926 0000342C E84AF5                  	call	CRLF2
 26927                                  	; 28/02/2023
 26928                                  	;mov	di,PARSE_DATE		;AN000; Get address of PARSE_DATE
 26929                                  ;gettim_p: ; 28/02/2023
 26930 0000342F BE[569A]                	mov	si,COMBUF+2
 26931                                  	;xor	cx,cx	 ; cx = 0	;AN000; clear counter for positionals
 26932 00003432 31D2                    	xor	dx,dx			;AN000;
 26933                                  	;call	cmd_parse		;AC000; call parser
 26934                                  	;retn
 26935                                  	; 28/02/2023
 26936 00003434 E93515                  	jmp	cmd_parse
 26937                                  
 26938                                  ; =============== S U B	R O U T	I N E =======================================
 26939                                  
 26940                                  ; MSDOS 6.0
 26941                                  
 26942                                  ; ****************************************************************
 26943                                  ; *
 26944                                  ; * ROUTINE:	 GETTIME - Prompt user for time
 26945                                  ; *
 26946                                  ; * FUNCTION:	 Gets the time format from the COUNTRY DEPENDENT
 26947                                  ; *		 INFORMATION and issues the "Enter new time"
 26948                                  ; *		 message. COMBUF is reset to get a time from the
 26949                                  ; *		 command line. The PARSE_TIME blocks are then
 26950                                  ; *		 reset and the PARSE function call is issued.
 26951                                  ; *
 26952                                  ; * INPUT:	 NONE
 26953                                  ; *
 26954                                  ; * OUTPUT:	 COMBUF
 26955                                  ; *		 PARSER RETURN CODES
 26956                                  ; *
 26957                                  ; ****************************************************************
 26958                                  
 26959                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26960                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:313Dh
 26961                                  
 26962                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26963                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:36E7h
 26964                                  
 26965                                  	; 08/08/2024 - Retro DOS v5.0 COMMAND.COM
 26966                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3596h
 26967                                  GETTIM:
 26968 00003437 31C9                    	xor	cx,cx			; Initialize hours and minutes to zero
 26969 00003439 BA[EB90]                	mov	dx,NewTim_Ptr
 26970 0000343C E8E91F                  	call	std_printf
 26971                                  
 26972                                  	; 28/02/2023
 26973 0000343F BF[6496]                	mov	di,PARSE_TIME
 26974 00003442 EBD5                    	jmp	short gettim_p
 26975                                  
 26976                                  ; 28/02/2023
 26977                                  ;	;mov	ah,Std_Con_String_Input
 26978                                  ;	mov	ah,0Ah
 26979                                  ;	mov	dx,COMBUF
 26980                                  ;	mov	cx,INITSPECIAL ; 2	; Set bit in InitFlag that indicates
 26981                                  ;	call	SetInitFlag		;  prompting for time.
 26982                                  ;	int	21h			; Get input line
 26983                                  ;	; 28/02/2023
 26984                                  ;	xor	cx,cx			; Reset bit in InitFlag that indicates
 26985                                  ;	call	SetInitFlag		;  prompting for time.
 26986                                  ;	call	CRLF2
 26987                                  ;	; 28/02/2023
 26988                                  ;	;mov	si,COMBUF+2
 26989                                  ;	; 28/02/2023
 26990                                  ;	mov	di,PARSE_TIME		;AN000; Get address of PARSE_TIME
 26991                                  ;	; 28/02/2023
 26992                                  ;	jmp	short gettim_p	
 26993                                  ;	; 28/02/2023
 26994                                  ;	;;xor	cx,cx			;AN000; clear counter for positionals
 26995                                  ;	;xor	dx,dx			;AN000;
 26996                                  ;	;call	cmd_parse		;AC000; call parser
 26997                                  ;	;retn
 26998                                  
 26999                                  
 27000                                  ; =============== S U B	R O U T	I N E =======================================
 27001                                  
 27002                                  ; MSDOS 6.0
 27003                                  
 27004                                  ;Skip_white: Skips over the whitespace chars that could be present after
 27005                                  ;the '=' sign in the environment variable before the actual path.
 27006                                  ;
 27007                                  ;	ENTRY:	ds:si = arguments of the environment variable
 27008                                  ;
 27009                                  ;	EXIT:	ds:si = start of the path
 27010                                  ;
 27011                                  ;	REGISTERS AFFECTED: ax
 27012                                  
 27013                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27014                                  skip_white:
 27015 00003444 FC                      	cld
 27016                                  skw_lp:
 27017 00003445 AC                      	lodsb
 27018 00003446 3C20                    	cmp	al,' '			;blank char?
 27019 00003448 74FB                    	jz	short skw_lp		;yes, skip it
 27020 0000344A 3C09                    	cmp	al,9			;tab char?
 27021 0000344C 74F7                    	jz	short skw_lp		;yes, skip it
 27022 0000344E 4E                      	dec	si			;point at first non-white
 27023 0000344F C3                      	retn
 27024                                  
 27025                                  ; =============== S U B	R O U T	I N E =======================================
 27026                                  
 27027                                  ; MSDOS 6.0
 27028                                  
 27029                                  ;Copy_pipe_path: This routine copies the path from the TEMP environment
 27030                                  ;variable into the path buffers Pipe1 & Pipe2.
 27031                                  ;
 27032                                  ;	ENTRY:	ds:si = path to be copied
 27033                                  ;		es = RESGROUP
 27034                                  ;
 27035                                  ;	EXIT:	Path copied into Pipe1 and Pipe2.
 27036                                  ;
 27037                                  ;	REGISTERS AFFECTED: si, di, cx, ax
 27038                                  
 27039                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27040                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3174h
 27041                                  
 27042                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 27043                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:371Eh
 27044                                  
 27045                                  	; 08/08/2024 - Retro DOS v5.0 COMMAND.COM
 27046                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:35CEh
 27047                                  copy_pipe_path:
 27048 00003450 B9FFFF                  	mov	cx,0FFFFh ; 65535
 27049 00003453 30C0                    	xor	al,al
 27050                                  
 27051 00003455 89F7                    	mov	di,si
 27052 00003457 06                      	push	es			;save es
 27053 00003458 1E                      	push	ds
 27054 00003459 07                      	pop	es			;es:di = path to be copied
 27055                                  	
 27056 0000345A FC                      	cld
 27057 0000345B 57                      	push	di
 27058 0000345C F2AE                    	repnz	scasb			;look for the null char
 27059 0000345E 5F                      	pop	di
 27060                                  
 27061 0000345F 07                      	pop	es			;es = RESGROUP again
 27062                                  
 27063 00003460 F7D1                    	not	cx			;length including the null
 27064                                  
 27065                                  	;;;;mov	di,320h ; MSDOS 5.0 COMMAND.COM ; (RESGROUP:EndInit)
 27066                                  	;;;mov	di,3EAh ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 27067                                  	;;mov	di,41Eh ; PCDOS 7.1 COMMAND.COM ; 08/08/2024	
 27068                                  	;mov	di,offset DATARES:Pipe1
 27069 00003462 BF[1503]                	mov	di,Pipe1  ; (offset RESGROUP:EndInit)
 27070 00003465 57                      	push	di
 27071 00003466 51                      	push	cx			
 27072 00003467 F3A4                    	rep	movsb			;copy path into Pipe1
 27073 00003469 59                      	pop	cx
 27074 0000346A 5F                      	pop	di
 27075                                  
 27076 0000346B 1E                      	push	ds
 27077 0000346C 06                      	push	es
 27078 0000346D 1F                      	pop	ds			;ds:si = Pipe1
 27079 0000346E 89FE                    	mov	si,di
 27080                                  	;;;;mov	di,36Fh ; MSDOS 5.0 COMMAND.COM ; (RESGROUP:EndInit+79)
 27081                                  	;;;mov	di,439h ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 27082                                  	;;mov	di,46Dh ; PCDOS 7.1 COMMAND.COM ; 08/08/2024	
 27083                                  	;mov	di,offset DATARES:Pipe2	;es:di = Pipe2
 27084 00003470 BF[6403]                	mov	di,Pipe2  ; (offset RESGROUP:EndInit+79)
 27085 00003473 F3A4                    	rep	movsb			;copy path into Pipe2
 27086 00003475 1F                      	pop	ds
 27087 00003476 C3                      	retn
 27088                                  
 27089                                  ;============================================================================
 27090                                  ; PARSE2.ASM, MSDOS 6.0, 1991
 27091                                  ;============================================================================
 27092                                  ; 03/10/2018 - Retro DOS v3.0
 27093                                  
 27094                                  ;----------------------------------------------------------------------------
 27095                                  ; PARSELINE takes an MSDOS command line and maps it into a UNIX-style
 27096                                  ; argv[argvcnt] array. The most important difference between this array and
 27097                                  ; the tradition UNIX format is the extra cparse information included with
 27098                                  ; each argument element.
 27099                                  ;---------------
 27100                                  ; ENTRY:
 27101                                  ;	BL	     special delimiter for cparse -- not implemented)
 27102                                  ;---------------
 27103                                  ; EXIT:
 27104                                  ;	CF	    set if error
 27105                                  ;	AL	    error code (carry set). Note AH clobbered in any event.
 27106                                  ;	argv[]	    array of cparse flags and pointers to arguments
 27107                                  ;	argvcnt     argument count
 27108                                  ;---------------
 27109                                  ; NOTE(S):
 27110                                  ;	*   BL (special delimiter) is ignored, for now (set to space).
 27111                                  ;	*   Parseflags record contains cparse flags, as follows:
 27112                                  ;		sw_flag 	--	was this arg a switch?
 27113                                  ;		wildcard	--	whether or not it contained a * or ?
 27114                                  ;		path_sep	--	maybe it was a pathname
 27115                                  ;		unused		--	for future expansion
 27116                                  ;		special_delim	--	was there an initial special delimiter?
 27117                                  ;	*   argv[] and argvcnt are undefined if CF/AL indicates an error.
 27118                                  ;	*   Relationship between input, cparse output, and comtail can be
 27119                                  ;	    found in the following chart. Despite the claim of the cparse
 27120                                  ;	    documentation that, "Token buffer always starts d: for non switch
 27121                                  ;	    tokens", such is not the case (see column two, row two).
 27122                                  ;	    Similarly, [STARTEL] is not null when the command line is one of
 27123                                  ;	    the forms, "d:", "d:\", or "d:/". In fact, *STARTEL (i.e., what
 27124                                  ;	    STARTEL addresses) will be null. This is clearly just a
 27125                                  ;	    documentation error.
 27126                                  ;	*   cparse also returns a switch code in BP for each switch it
 27127                                  ;	    recognizes on the command line.
 27128                                  ;	*   arglen for each token does NOT include the terminating null.
 27129                                  ;	*   Finally, note that interesting constructions like 'foodir/*.exe'
 27130                                  ;	    parse as three separate tokens, and the asterisk is NOT a wildcard.
 27131                                  ;	    For example, 'for %i in (foodir/*.exe) do echo %i' will first
 27132                                  ;	    echo 'foodir', then '*', then '.exe'. Using cparse for command-
 27133                                  ;	    line parsing may result in slightly different behavior than
 27134                                  ;	    previously observed with the old COMMAND.COM command-line parser.
 27135                                  ;
 27136                                  ;	    Input		    Cparse		Command Line (80H)
 27137                                  ;	\alan\foo.bat		c:\alan\foo.bat 	\alan\foo.bat
 27138                                  ;	alan\foo.bat		alan\foo.bat		alan\foo.bat
 27139                                  ;	foo.bat 		foo.bat 		foo.bat
 27140                                  ;	c:\alan\foo.bat 	c:\alan\foo.bat 	c:\alan\foo.bat
 27141                                  ;	c:alan\foo.bat		c:alan\foo.bat		c:alan\foo.bat
 27142                                  ;	c:foo.bat		c:foo.bat		c:foo.bat
 27143                                  
 27144                                  ; =============== S U B	R O U T	I N E =======================================
 27145                                  
 27146                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 23D0h
 27147                                  
 27148                                  ; 01/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27149                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 319Bh
 27150                                  
 27151                                  ; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27152                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3745h
 27153                                  
 27154                                  ; 27/07/2024 - Retro DOS v4.0-v4.1-v4.2-v5.0 COMMAND.COM (PARSELINE)
 27155                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 35F5h
 27156                                  
 27157                                  PARSELINE:
 27158 00003477 50                      	push	ax			; most of these are clobbered
 27159 00003478 53                      	push	bx			; by cparse...
 27160 00003479 51                      	push	cx
 27161 0000347A 52                      	push	dx
 27162 0000347B 57                      	push	di
 27163 0000347C 56                      	push	si
 27164 0000347D 9C                      	pushf
 27165                                  	;mov	byte [cpyflag],0  ; Turn "CPARSE called from COPY flag" off
 27166 0000347E C706[16A4]FFFF          	mov	word [LASTARG],-1 ; last argument at which to accumulate
 27167 00003484 31C0                    	xor	ax,ax
 27168                                  	;;mov	cx,1348
 27169                                  	; 27/07/2024
 27170                                  	;mov	cx,1092  ; PCDOS 7.1 COMMAND.COM
 27171 00003486 B94404                  	mov	cx,ARG_UNIT.SIZE ; 1092
 27172 00003489 A2[A49D]                	mov	[cpyflag],al ; 0 ; 27/07/2024
 27173 0000348C BF[509F]                	mov	di,ARG
 27174 0000348F F3AA                    	rep	stosb
 27175                                  	;mov	word [ARGBUF_PTR],ARG_ARGBUF
 27176 00003491 C706[94A3][14A2]        	mov	word [ARGBUF_PTR],ARG+ARG_UNIT.argbuf
 27177                                  	;mov	word [ARG_ARGSWINFO],0 ; switch information, and info to date
 27178                                  	;mov	word [ARG+ARG_UNIT.argswinfo],0
 27179 00003497 A3[12A2]                	mov	[ARG+ARG_UNIT.argswinfo],ax ; 0 ; 27/07/2024
 27180                                  	;mov	word [ARG_ARGVCNT],0 ; initialize argvcnt/argv[]
 27181                                  	;mov	word [ARG+ARG_UNIT.argvcnt],0
 27182 0000349A A3[10A2]                	mov	[ARG+ARG_UNIT.argvcnt],ax ; 0 ; 27/07/2024 
 27183 0000349D BE[569A]                	mov	si,COMBUF+2	; prescan leaves cooked input in combuf
 27184                                  
 27185                                  ; This next section of code (up to pcont:)  makes sure that si is set up for
 27186                                  ; parsing. It should point at COMBUF if FORFLAG is set and arg.argforcombuf
 27187                                  ; otherwise. This is done so that commands can get arg pointers into their
 27188                                  ; original command line (or an exact copy of it) in arg_ocomptr.
 27189                                  ; Arg.argforcombuf is used so that the for loop processor will always be able
 27190                                  ; to get a hold of its original command line; even after COMBUF is blasted by
 27191                                  ; the command to be repeated or the transient part of command has been
 27192                                  ; reloaded.
 27193                                  
 27194 000034A0 1E                      	push	ds
 27195 000034A1 8E1E[F59B]              	mov	ds,[RESSEG]
 27196                                  	;cmp	byte [ForFlag],0
 27197 000034A5 3806[AB02]              	cmp	[ForFlag],al ; 0 ; 27/07/2024
 27198 000034A9 1F                      	pop	ds
 27199 000034AA 7510                    	jnz	short PCONT
 27200                                  	;mov	di,ARG_ARGFORCOMBUF
 27201 000034AC BF[14A3]                	mov	di,ARG+ARG_UNIT.argforcombuf
 27202 000034AF 30ED                    	xor	ch,ch
 27203 000034B1 8A0E[559A]              	mov	cl,[COMBUF+1]
 27204 000034B5 FEC1                    	inc	cl
 27205 000034B7 F3A4                    	rep	movsb
 27206                                  	;mov	si,ARG_ARGFORCOMBUF
 27207 000034B9 BE[14A3]                	mov	si,ARG+ARG_UNIT.argforcombuf
 27208                                  PCONT:
 27209 000034BC BF[96A3]                	mov	di,TPBUF	; destination is temporary token buffer
 27210 000034BF B320                    	mov	bl,' '		; no special delimiter, for now
 27211                                  PARSELOOP:
 27212 000034C1 8936[18A4]              	mov	[COMPTR],si	; save ptr into original command buffer
 27213 000034C5 31ED                    	xor	bp,bp		; switch information put here by cparse
 27214 000034C7 C606[329F]00            	mov	byte [expand_star],0 ; don't expand *'s to ?'s
 27215 000034CC E8B7F4                  	call	scanoff		; skip leading blanks...
 27216 000034CF E8D512                  	call	cparse		; byte off a token (args in SI, DI, BL)
 27217 000034D2 730B                    	jnb	short MORE_PRSE
 27218 000034D4 09ED                    	or	bp,bp		; Check for trailing switch character
 27219 000034D6 7403                    	jz	short PARSEDONE
 27220 000034D8 E81700                  	call	newarg		; We hit CR but BP is non-zero. The
 27221                                  				;   typical cause of this is that a
 27222                                  				;   switch char IMMEDIATELY preceeds
 27223                                  				;   the CR. We have an argument, but it
 27224                                  				;   is sort of an error.
 27225                                  	;jmp	short PARSEDONE	; We're done (found the CR).
 27226                                  	; 01/03/2023
 27227                                  PARSEDONE:
 27228 000034DB 9D                      	popf
 27229 000034DC F8                      	clc
 27230 000034DD EB0C                    	jmp	short PARSE_EXIT
 27231                                  
 27232                                  MORE_PRSE:
 27233 000034DF C606[A49D]02            	mov	byte [cpyflag],2
 27234                                  				; tell CPARSE that 1st token is done
 27235 000034E4 E80B00                  	call	newarg		; add to argv array (CX has char count)
 27236 000034E7 73D8                    	jnb	short PARSELOOP	; was everything OK?
 27237                                  	;jmp	short PARSE_ERROR ; NO, it wasn't -- bug out (CF set)
 27238                                  	; 01/03/2023
 27239                                  ;PARSEDONE:
 27240                                  	;popf
 27241                                  	;clc
 27242                                  	;jmp	short PARSE_EXIT
 27243                                  
 27244                                  PARSE_ERROR:			; error entry (er, exit) point
 27245 000034E9 9D                      	popf
 27246 000034EA F9                      	stc
 27247                                  PARSE_EXIT:			; depend on not changing CF
 27248 000034EB 5E                      	pop	si
 27249 000034EC 5F                      	pop	di
 27250 000034ED 5A                      	pop	dx
 27251 000034EE 59                      	pop	cx
 27252 000034EF 5B                      	pop	bx
 27253 000034F0 58                      	pop	ax
 27254 000034F1 C3                      	retn
 27255                                  
 27256                                  ; =============== S U B	R O U T	I N E =======================================
 27257                                  
 27258                                  ; NEWARG adds the supplied argstring and cparse data to arg.argv[].
 27259                                  ;
 27260                                  ; ENTRY:
 27261                                  ;   BH			argflags
 27262                                  ;   CX			character count in argstring
 27263                                  ;   DI			pointer to argstring
 27264                                  ;   comptr		ptr to starting loc of current token in original command
 27265                                  ;   [STARTEL]		cparse's answer to where the last element starts
 27266                                  ; EXIT:
 27267                                  ;   argbufptr		points to next free section of argbuffer
 27268                                  ;   arg.argbuf		contains null-terminated argument strings
 27269                                  ;   arg.argvcnt 	argument count
 27270                                  ;   arg.argv[]		array of flags and pointers
 27271                                  ;   arg.arg_ocomptr	ptr to starting loc of current token in original command
 27272                                  ;   CF			set if error
 27273                                  ;   AL			carry set:  error code; otherwise, zero
 27274                                  
 27275                                  	; 01/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27276                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27277                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27278                                  newarg:
 27279 000034F2 53                      	push	bx
 27280 000034F3 51                      	push	cx
 27281 000034F4 52                      	push	dx
 27282 000034F5 57                      	push	di
 27283 000034F6 56                      	push	si
 27284 000034F7 9C                      	pushf
 27285 000034F8 E86200                  	call	arg_switch		; if it's a switch, record switch info
 27286                                  					; LEAVE SWITCH ON COMMAND LINE!!
 27287                                  	;;;jc	short newarg_done 	; previous arg's switches -- and leave
 27288                                  
 27289                                  	;cmp	word [ARG_ARGVCNT],64	; check to ensure we've not
 27290 000034FB 833E[10A2]40            	cmp	word [ARG+ARG_UNIT.argvcnt],ARGMAX ; 64
 27291 00003500 7D50                    	jge	short to_many_args	; exceeded array limits
 27292 00003502 88FE                    	mov	dh,bh			
 27293                                  	;mov	bx,[ARG_ARGVCNT]	; save argflags	
 27294 00003504 8B1E[10A2]              	mov	bx,[ARG+ARG_UNIT.argvcnt] ; argv[argvcnt++] = arg data
 27295                                  	;inc	word [ARG_ARGVCNT]
 27296 00003508 FF06[10A2]              	inc	word [ARG+ARG_UNIT.argvcnt]
 27297                                  	;mov	ax,ARG_ARGV
 27298 0000350C B8[509F]                	mov	ax,ARG+ARG_UNIT.argv
 27299 0000350F E87E00                  	call	argv_calc		; convert offset to pointer
 27300                                  	;mov	[BX].argsw_word,0 	; no switch information, yet...
 27301                                  	;mov	word [bx+7],0
 27302 00003512 C747070000              	mov	word [bx+ARGV_ELE.argsw_word],0
 27303                                  	;mov	[BX].arglen,CX		; argv[argvcnt].arglen = arg length
 27304                                  	;mov	[bx+5],cx
 27305 00003517 894F05                  	mov	[bx+ARGV_ELE.arglen],cx 
 27306                                  	;mov	[BX].argflags,DH 	; argv[argvcnt].argflags = cparse flags
 27307                                  	;mov	[bx+2],dh
 27308 0000351A 887702                  	mov	[bx+ARGV_ELE.argflags],dh
 27309 0000351D 8B36[94A3]              	mov	si,[ARGBUF_PTR]
 27310                                  	;mov	[BX].argpointer,SI 	; argv[argvcnt].argpointer = [argbufptr]
 27311                                  	;mov	[bx+ARGV_ELE.argpointer],si
 27312 00003521 8937                    	mov	[bx],si			
 27313 00003523 0336[F69E]              	add	si,[STARTEL]		; save startel from new location
 27314 00003527 29FE                    	sub	si,di			; form pointer into argbuf
 27315                                  	;mov	[BX].argstartel,SI ; argv[argvcnt].argstartel = new [STARTEL]
 27316                                  	;mov	[bx+3],si
 27317 00003529 897703                  	mov	[bx+ARGV_ELE.argstartel],si
 27318 0000352C 8B36[18A4]              	mov	si,[COMPTR]
 27319                                  	;mov	[BX].arg_ocomptr,si ; arg_ocomptr = ptr into original com line
 27320                                  	;mov	[bx+9],si
 27321 00003530 897709                  	mov	[bx+ARGV_ELE.arg_ocomptr],si
 27322 00003533 89FE                    	mov	si,di			; now save argstring in argbuffer
 27323 00003535 8B3E[94A3]              	mov	di,[ARGBUF_PTR]		; load the argbuf pointer and make
 27324                                  
 27325                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27326                                  ; PCDOS 7.1 COMMAND.COM
 27327                                  %if 0
 27328                                  	add	di,cx			; sure we're not about to run off
 27329                                  	;cmp	DI,OFFSET TRANGROUP:arg.argbuf+ARGBLEN-1
 27330                                  	;;cmp	di,ARG_ARGBUF+255
 27331                                  	;cmp	di,ARG+ARG_UNIT.argbuf+127
 27332                                  	cmp	di,ARG+ARG_UNIT.argbuf+ARGBLEN-1
 27333                                  	jge	short buf_oflow		; the end of the buffer (plus null byte)
 27334                                  	sub	di,cx
 27335                                  %else
 27336                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27337                                  	;mov	bx,ARG_ARGBUF+127
 27338 00003539 BB[93A2]                	mov	bx,ARG+ARG_UNIT.argbuf+ARGBLEN-1
 27339 0000353C 29FB                    	sub	bx,di	; sure we're not about to run off
 27340 0000353E 39CB                    	cmp	bx,cx
 27341 00003540 7302                    	jnb	short newarg_@
 27342 00003542 89D9                    	mov	cx,bx	
 27343                                  %endif
 27344                                  
 27345                                  newarg_@:	; 27/07/2024
 27346 00003544 FC                      	cld
 27347 00003545 F3A4                    	rep	movsb
 27348 00003547 B000                    	mov	al,ANULL ; 0		; tack a null byte on the end
 27349 00003549 AA                      	stosb
 27350 0000354A 893E[94A3]              	mov	[ARGBUF_PTR],di		; update argbufptr after copy
 27351                                  newarg_done:
 27352 0000354E 9D                      	popf
 27353 0000354F F8                      	clc
 27354 00003550 EB05                    	jmp	short newarg_exit
 27355                                  
 27356                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27357                                  ; PCDOS 7.1 COMMAND.COM
 27358                                  %if 0
 27359                                  to_many_args:
 27360                                  	mov	ax,1
 27361                                  	jmp	short newarg_error
 27362                                  buf_oflow:
 27363                                  	mov	ax,2
 27364                                  %else
 27365                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27366                                  ;buf_oflow:
 27367                                  ;	; 27/07/2024
 27368                                  ;	; PCDOS 7.1 COMMAND.COM
 27369                                  ;	sub	di,cx
 27370                                  ;	;mov	cx,ARG_ARGBUF+7Fh
 27371                                  ;	mov	cx,ARG+ARG_UNIT.argbuf+ARGBLEN-1
 27372                                  ;	sub	cx,di
 27373                                  ;	jmp     short newarg_@
 27374                                  to_many_args:
 27375 00003552 B80100                  	mov	ax,1
 27376                                  %endif
 27377                                  
 27378                                  newarg_error:
 27379 00003555 9D                      	popf
 27380 00003556 F9                      	stc
 27381                                  newarg_exit:
 27382 00003557 5E                      	pop	si
 27383 00003558 5F                      	pop	di
 27384 00003559 5A                      	pop	dx
 27385 0000355A 59                      	pop	cx
 27386 0000355B 5B                      	pop	bx
 27387 0000355C C3                      	retn
 27388                                  
 27389                                  ; =============== S U B	R O U T	I N E =======================================
 27390                                  
 27391                                  ; ARG_SWITCH decides if an argument might really be a switch. In the
 27392                                  ; event that it is, and we can recognize
 27393                                  ;
 27394                                  ; ENTRY:
 27395                                  ;   As in <newarg>.
 27396                                  ; EXIT:
 27397                                  ;   CF	    --	    clear (wasn't a switch); set (was a switch)
 27398                                  ; NOTE(S):
 27399                                  ;   *	The mechanism mapping a switch into a bit-value depends entirely
 27400                                  ;	on the order of definition in the <switch_list> variable and the
 27401                                  ;	values chosen to define the bits in CMDT:COMEQU.ASM. Change either
 27402                                  ;	<switch_list> or the definitions in CMDT:COMEQU.ASM -- and rewrite
 27403                                  ;	this mechanism. This code taken from CMDT:TCODE.ASM.
 27404                                  ;   *	The <switch_list> declared below is redundant to one declared in
 27405                                  ;	TDATA.ASM, and used in TCODE.ASM.
 27406                                  ;   *	An ugly routine.
 27407                                  
 27408                                  	; 01/03/2023 - Retro DOS v4.0 COMMAND.COM
 27409                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27410                                  	; 08/08/2024 - Retro DOS v5.0 COMMAND.COM
 27411                                  arg_switch:
 27412 0000355D 50                      	push	ax
 27413 0000355E 53                      	push	bx
 27414 0000355F 51                      	push	cx
 27415 00003560 57                      	push	di
 27416 00003561 9C                      	pushf
 27417 00003562 F6C701                  	test	bh,1 ; sw_flag		; is it a switch? (preserve flag word)
 27418 00003565 741C                    	jz	short arg_no_switch0
 27419 00003567 833E[16A4]FF            	cmp	word [LASTARG],-1 	; have we encountered any REAL args yet?
 27420 0000356C 741B                    	je	short arg_no_switch1 	; no, so leading switches don't matter
 27421 0000356E 8B1E[16A4]              	mov	bx,[LASTARG]		; yes, add switch info to last REAL arg
 27422                                  	;mov	ax,offset TRANGROUP:arg.argv
 27423                                  	;mov	ax,ARG_ARGV
 27424 00003572 B8[509F]                	mov	ax,ARG+ARG_UNIT.argv  ; ARG+0
 27425 00003575 E81800                  	call	argv_calc
 27426                                  	;or	[BX].argsw_word,BP
 27427                                  	;or	[bx+7],bp
 27428 00003578 096F07                  	or	[bx+ARGV_ELE.argsw_word],bp
 27429                                  	;or	arg.argswinfo,BP
 27430                                  	;or	[ARG_ARGSWINFO],bp
 27431 0000357B 092E[12A2]              	or	[ARG+ARG_UNIT.argswinfo],bp
 27432                                  arg_yes_switch:
 27433 0000357F 9D                      	popf
 27434 00003580 F9                      	stc
 27435 00003581 EB08                    	jmp	short arg_switch_exit
 27436                                  
 27437                                  arg_no_switch0:
 27438                                  	;mov	ax,[ARG_ARGVCNT]
 27439 00003583 A1[10A2]                	mov	ax,[ARG+ARG_UNIT.argvcnt]
 27440 00003586 A3[16A4]                	mov	[LASTARG],ax
 27441                                  arg_no_switch1:
 27442 00003589 9D                      	popf
 27443 0000358A F8                      	clc
 27444                                  arg_switch_exit:
 27445 0000358B 5F                      	pop	di
 27446 0000358C 59                      	pop	cx
 27447 0000358D 5B                      	pop	bx
 27448 0000358E 58                      	pop	ax
 27449 0000358F C3                      	retn
 27450                                  
 27451                                  ; =============== S U B	R O U T	I N E =======================================
 27452                                  
 27453                                  ; ARGV_CALC maps an array index into a byte-offset from the base of
 27454                                  ; the supplied array.  Method used for computing the address is:
 27455                                  ;	Array Index * Array Elt Size + Base Addr = Elt Addr
 27456                                  ; ENTRY:
 27457                                  ;   AX	    --	    base of array
 27458                                  ;   BX	    --	    array index
 27459                                  ; EXIT:
 27460                                  ;   BX	    --	    byte offset
 27461                                  
 27462                                  	; 01/03/2023 - Retro DOS v4.0 COMMAND.COM
 27463                                  argv_calc:
 27464 00003590 50                      	push	ax		; Save base
 27465 00003591 88D8                    	mov	al,bl		; al = array index
 27466                                  	;mov	bl,11
 27467 00003593 B30B                    	mov	bl,ARGV_ELE.SIZE ; bl = size of an argv element
 27468 00003595 F6E3                    	mul	bl		; ax = base offset
 27469 00003597 5B                      	pop	bx		; Get base
 27470 00003598 01D8                    	add	ax,bx		; Add in base offset
 27471 0000359A 93                      	xchg	ax,bx		; Restore ax and put byte offset in bx
 27472 0000359B C3                      	retn
 27473                                  
 27474                                  ; ---------------------------------------------------------------------------
 27475                                  	
 27476                                  	;db 0Ah dup(0)
 27477                                  	;times 10 db 0
 27478                                  
 27479 0000359C 90<rep 4h>              align 16
 27480                                  
 27481                                  ;============================================================================
 27482                                  ; PATH1.ASM, MSDOS 6.0, 1991
 27483                                  ;============================================================================
 27484                                  ; 03/10/2018 - Retro DOS v3.0
 27485                                  
 27486                                  ;----------------------------------------------------------------------------
 27487                                  ;    PATH.ASM contains the routines to perform pathname incovation. Path and
 27488                                  ;    Parse share a temporary buffer and argv[] definitions. <Path_Search>,
 27489                                  ;    given a pathname, attempts to find a corresponding executable or batch
 27490                                  ;    file on disk. Directories specified in the user's search path will be
 27491                                  ;    searched for a matching file, if a match is not found in the current
 27492                                  ;    directory and if the pathname is actually only an MSDOS filename.
 27493                                  ;    <Path_Search> assumes that the parsed command name can be found in
 27494                                  ;    argv[0] -- in other words, <Parseline> should be executed prior to
 27495                                  ;    <Path_Search>. Alternatively, the command name and appropriate
 27496                                  ;    information could be placed in argv[0], or <Path_Search> could be
 27497                                  ;    (easily) modified to make no assumptions about where its input is found.
 27498                                  ;    Please find enclosed yet another important routine, <Save_Args>, which
 27499                                  ;    places the entire arg/argv[]/argbuf structure on a piece of newly
 27500                                  ;    allocated memory. This is handy for for-loop processing, and anything
 27501                                  ;    else that wants to save the whole shebang and then process other command
 27502                                  ;    lines.
 27503                                  ;
 27504                                  ; Alan L, OS/MSDOS				    August 15, 1983
 27505                                  ;
 27506                                  ; ENTRY:
 27507                                  ;   <Path_Search>:	    argv[0].
 27508                                  ;   <Save_Args>:	    bytes to allocate in addition to arg structure
 27509                                  ; EXIT:
 27510                                  ;   <Path_Search>:	    success flag, best pathname match in EXECPATH.
 27511                                  ;   <Save_Args>:	    success flag, segment address of new memory
 27512                                  ; NOTE(S):
 27513                                  ;   *	<Argv_calc> handily turns an array index into an absolute pointer.
 27514                                  ;	The computation depends on the size of an argv[] element (arg_ele).
 27515                                  ;   *	<Parseline> calls <cparse> for chunks of the command line. <Cparse>
 27516                                  ;	does not function as specified; see <Parseline> for more details.
 27517                                  ;   *	<Parseline> now knows about the flags the internals of COMMAND.COM
 27518                                  ;	need to know about. This extra information is stored in a switch_flag
 27519                                  ;	word with each command-line argument; the switches themselves will not
 27520                                  ;	appear in the resulting arg structure.
 27521                                  ;   *	With the exception of CARRY, flags are generally preserved across calls.
 27522                                  ;----------------------------------------------------------------------------
 27523                                  
 27524                                  ; =============== S U B	R O U T	I N E =======================================
 27525                                  
 27526                                  ; PATH_SEARCH tries to find the file it's given, somewhere. An initial value
 27527                                  ; of *argv[0].argstartel == 0 implies that there is no command (empty line
 27528                                  ; or 'd:' or 'd:/'). This check is done in strip; otherwise, strip formats
 27529                                  ; the filename/pathname into tpbuf. Search(tpbuf) is executed to see if we
 27530                                  ; have a match, either in the current working directory if we were handed
 27531                                  ; a filename, or in the specified directory, given a pathname. If this call
 27532                                  ; fails, and we were given a pathname, then Path_Search fails. Otherwise,
 27533                                  ; Path_Crunch is repeatedly invoked on tpbuf[STARTEL] (if there's a drive
 27534                                  ; prefix, we want to skip it) for each pathstring in userpath. Success on
 27535                                  ; either the first invocation of search or on one of the succeeding calls
 27536                                  ; sets up the appropriate information for copying the successful pathname
 27537                                  ; prefix (if any) into the result buffer, followed by the successful filename
 27538                                  ; match (from [search_best_buf]). The result is returned in in EXECPATH.
 27539                                  ;
 27540                                  ; ENTRY:
 27541                                  ;   argv[0]		--	command name and associated information
 27542                                  ; EXIT:
 27543                                  ;   AX			--	non-zero indicates type of file found
 27544                                  ;   EXECPATH		--	successful pathname (AX non-zero)
 27545                                  ; NOTE(S):
 27546                                  ;   1)	Uses the temporary buffer, tpbuf, from the parse routines.
 27547                                  ;   2)	Some files are more equal than others.	See search: for rankings.
 27548                                  ;   3)	Path_Search terminates as soon as a call to search succeeds, even
 27549                                  ;	if search returns an .exe or .bat.
 27550                                  ;   5)	Clobbers dma address.
 27551                                  
 27552                                  ;PBUFLEN 	EQU	128		; length of EXECPATH
 27553                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 27554                                  PBUFLEN 	EQU	256
 27555                                  PATH_SEP_CHAR	EQU	';'
 27556                                  
 27557                                  ;parseflags RECORD special_delim:1, unused:4, path_sep:1, wildcard:1, sw_flag:1
 27558                                  
 27559                                  	;special_delim equ 128
 27560                                  	;path_sep equ 4
 27561                                  	;wildcard equ 2
 27562                                  	;sw_flag  equ 1
 27563                                  
 27564                                  ;----------------------------------------------------------------------------
 27565                                  
 27566                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2510h
 27567                                  
 27568                                  ; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27569                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 32D1h
 27570                                  
 27571                                  ; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27572                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 387Bh
 27573                                  
 27574                                  ; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 27575                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 372Fh
 27576                                  
 27577                                  path_search:
 27578 000035A0 53                      	push	bx
 27579 000035A1 51                      	push	cx
 27580 000035A2 52                      	push	dx		; could use a "stack 'em" instruction
 27581 000035A3 56                      	push	si
 27582 000035A4 57                      	push	di
 27583 000035A5 55                      	push	bp
 27584 000035A6 9C                      	pushf
 27585                                  
 27586                                  	;test	ds:arg.argv[0].argflags, (MASK wildcard) + (MASK sw_flag)
 27587                                  	;test	byte [ARGV0_ARG_FLAGS],3
 27588 000035A7 F606[529F]03            	test	byte [ARG+ARGV_ELE.argflags],3 ; wildcard+sw_flag
 27589 000035AC 7403                    	jz	short path_search_ok
 27590                                  path_failure_jmp:
 27591 000035AE E9C100                  	jmp	path_failure	; ambiguous commands not allowed
 27592                                  
 27593                                  path_search_ok:
 27594 000035B1 E85201                  	call	STORE_PCHAR	; figure out the pathname separator
 27595 000035B4 BA[1AA4]                	mov	dx,FBUF		; clobber old dma value with
 27596 000035B7 B8001A                  	mov	ax,Set_DMA*256 ; 1A00h ; a pointer to our dma buffer
 27597 000035BA CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 27598                                  			; DS:DX	-> disk	transfer buffer
 27599 000035BC 06                      	push	es
 27600 000035BD E8EFF0                  	call	find_path	; get a handle (ES:DI) on user path
 27601 000035C0 8C06[45A4]              	mov	[pathinfo+0],es	; and squirrel it away
 27602 000035C4 893E[47A4]              	mov	[pathinfo+2],di	; "old" pathstring pointer
 27603 000035C8 893E[49A4]              	mov	[pathinfo+4],di	; "new" pathstring pointer
 27604 000035CC 07                      	pop	es
 27605                                  	
 27606                                  	;mov	bx,PBUFLEN ; 128 ; copy/format argv[0] into temp buffer
 27607                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 27608                                  	;mov	bx,256
 27609 000035CD BB0001                  	mov	bx,PBUFLEN ; 256 ; copy/format argv[0] into temp buffer
 27610 000035D0 BE[1D9B]                	mov	si,EXECPATH
 27611 000035D3 E88002                  	call	STRIP
 27612 000035D6 72D6                    	jc	short path_failure_jmp ; if possible, of course
 27613                                  		
 27614 000035D8 89F2                    	mov	dx,si		; search (EXECPATH, error_message)
 27615 000035DA C706[9AA4][6E90]        	mov	word [search_error],baddrv_ptr
 27616 000035E0 E89F01                  	call	PSEARCH		; must do at least one search
 27617 000035E3 09C0                    	or	ax,ax		; find anything?
 27618 000035E5 7469                    	jz	short path_noinit
 27619                                  				; failure ... search farther
 27620 000035E7 89C5                    	mov	bp,ax		; success... save filetype code
 27621 000035E9 BF[1D9B]                	mov	di,EXECPATH
 27622                                  	;mov	si,ds:arg.argv[0].argpointer
 27623                                  	;mov	si,[ARG_ARGV]
 27624 000035EC 8B36[509F]              	mov	si,[ARG+ARGV_ELE.argpointer]
 27625                                  	;mov	cx,ds:arg.argv[0].argstartel
 27626                                  	;mov	cx,[ARGV0_ARGSTARTEL]
 27627 000035F0 8B0E[539F]              	mov	cx,[ARG+ARGV_ELE.argstartel]
 27628 000035F4 29F1                    	sub	cx,si		; compute prefix bytes to copy
 27629                                  
 27630                                  ; We have the number of bytes in the prefix (up to the final component).
 27631                                  ; We need to form the complete pathname including leading drive and current
 27632                                  ; directory.
 27633                                  ;
 27634                                  ; Is there a drive letter present?
 27635                                  
 27636 000035F6 B43A                    	mov	ah,':'
 27637 000035F8 83F902                  	cmp	cx,2		; room for drive letter?
 27638 000035FB 7205                    	jb	short adddrive	; no, stick it in
 27639 000035FD 386401                  	cmp	[si+1],	ah	; colon present?
 27640 00003600 7408                    	je	short movedrive	; yes, just move it
 27641                                  adddrive:
 27642 00003602 A0[079C]                	mov	al,[CURDRV]	; get current drive
 27643 00003605 0441                    	add	al,'A'		; convert to uppercase letter
 27644 00003607 AB                      	stosw			; store d:
 27645 00003608 EB05                    	jmp	short checkpath
 27646                                  
 27647                                  movedrive:
 27648 0000360A AD                      	lodsw			; move d:
 27649 0000360B AB                      	stosw
 27650 0000360C 83E902                  	sub	cx,2		; 2 bytes less to move
 27651                                  checkpath:
 27652 0000360F 0C20                    	or	al,20h
 27653 00003611 88C2                    	mov	dl,al
 27654                                  	;sub	dl,60h
 27655 00003613 80EA60                  	sub	dl,'a'-1	; convert to 1-based for current dir
 27656                                  
 27657                                  ; Stick in beginning path char
 27658                                  
 27659 00003616 A0[4BA4]                	mov	al,[psep_char]
 27660 00003619 AA                      	stosb
 27661                                  
 27662                                  ; Is there a leading /? If so, then no current dir copy is necessary.
 27663                                  ; Otherwise, get current dir for DL.
 27664                                  
 27665 0000361A 83F901                  	cmp	cx,1		; is there room for path char?
 27666 0000361D 720A                    	jb	short addpath	; no, go add path
 27667 0000361F AC                      	lodsb
 27668 00003620 49                      	dec	cx
 27669 00003621 3A06[4BA4]              	cmp	al,[psep_char]	; is there a path separator?
 27670 00003625 741C                    	je	short movepath	; yes, go move remainder of path
 27671 00003627 41                      	inc	cx
 27672 00003628 4E                      	dec	si		; undo the lodsb
 27673                                  addpath:
 27674 00003629 56                      	push	si
 27675 0000362A 89FE                    	mov	si,di		; remainder of buffer
 27676 0000362C B80047                  	mov	ax,Current_Dir*256 ; 4700h
 27677 0000362F CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 27678                                  			; DL = drive (0=default,1=A,etc.)
 27679                                  			; DS:SI	points to 64-byte buffer area
 27680                                  
 27681                                  ; The previous current dir will succeed a previous find_first already worked.
 27682                                  ;
 27683                                  ; Find end of string.
 27684                                  
 27685 00003631 89F7                    	mov	di,si
 27686 00003633 5E                      	pop	si
 27687 00003634 A0[4BA4]                	mov	al,[psep_char]
 27688 00003637 803D00                  	cmp	byte [di],0	; root (empty dir string)?
 27689 0000363A 7407                    	jz	short movepath	; yes, no need for path char
 27690                                  scanend:
 27691                                  	;cmp	byte [di],0	; end of string?
 27692                                  	;jz	short foundend
 27693                                  	;inc	di
 27694                                  	;jmp	short scanend
 27695                                  	; 18/03/2023 - Retro DOS v4.0 COMMAND.COM
 27696 0000363C 47                      	inc	di
 27697 0000363D 803D00                  	cmp	byte [di],0
 27698 00003640 75FA                    	jnz	short scanend
 27699                                  
 27700                                  ; Stick in a trailing path char.
 27701                                  
 27702                                  foundend:
 27703 00003642 AA                      	stosb
 27704                                  
 27705                                  ; Move remaining part of path. Skip leading path char if present.
 27706                                  
 27707                                  movepath:
 27708 00003643 3804                    	cmp	[si],al		; first char a path char?
 27709 00003645 7502                    	jne	short copypath
 27710                                  	; 26/04/2023
 27711 00003647 46                      	inc	si		; move past leading char
 27712 00003648 49                      	dec	cx		; drop from count
 27713                                  copypath:
 27714 00003649 E302                    	jcxz	_copydone	; no chars to move!
 27715 0000364B F3A4                    	rep	movsb
 27716                                  _copydone:
 27717 0000364D E9A100                  	jmp	path_success
 27718                                  				; run off and form complete pathname
 27719                                  path_noinit:
 27720                                  	;test	ds:arg.argv[0].argflags, MASK path_sep
 27721                                  	;test	byte [ARGV0_ARG_FLAGS],4
 27722 00003650 F606[529F]04            	test	byte [ARG+ARGV_ELE.argflags],4 ; path_sep
 27723 00003655 751B                    	jnz	short path_failure
 27724                                  				; complete pathname specified ==> fail
 27725                                  	;mov	bh,';'
 27726 00003657 B73B                    	mov	bh,PATH_SEP_CHAR
 27727                                  				; semicolon terminates pathstring
 27728                                  	;mov	dx,ds:arg.argv[0].argstartel
 27729                                  				; this is where the last element starts
 27730                                  	;mov	dx,[ARGV0_ARGSTARTEL]
 27731 00003659 8B16[539F]              	mov	dx,[ARG+ARGV_ELE.argstartel]
 27732                                  	;sub	dx,ds:arg.argv[0].argpointer
 27733                                  				; form pointer into EXECPATH,
 27734                                  	;sub	dx,[ARG_ARGV]
 27735 0000365D 2B16[509F]              	sub	dx,[ARG+ARGV_ELE.argpointer]
 27736 00003661 81C2[1D9B]              	add	dx,EXECPATH	; skipping over drive spec, if any
 27737                                  path_loop:
 27738 00003665 E8AD00                  	call	path_crunch	; pcrunch (EXECPATH, pathinfo)
 27739 00003668 89C5                    	mov	bp,ax		; save filetype code
 27740 0000366A 9F                      	lahf			; save flags, just in case
 27741 0000366B 09ED                    	or	bp,bp		; did path_crunch find anything?
 27742 0000366D 7508                    	jnz	short path_found
 27743 0000366F 9E                      	sahf			; see? needed those flags, after all!
 27744 00003670 73F3                    	jnc	short path_loop	; is there anything left to the path?
 27745                                  path_failure:
 27746 00003672 31C0                    	xor	ax,ax
 27747 00003674 E98700                  	jmp	path_exit
 27748                                  
 27749                                  path_found:				; pathinfo[] points to winner
 27750 00003677 BF[1D9B]                	mov	di,EXECPATH
 27751                                  	;mov	cx,pathinfo[4]
 27752 0000367A 8B0E[49A4]              	mov	cx,[pathinfo+4]	; "new" pointer -- end of string
 27753                                  	;mov	si,pathinfo[2]
 27754 0000367E 8B36[47A4]              	mov	si,[pathinfo+2]	; "old" pointer -- beginning of string
 27755                                  
 27756                                  ;	BAS Nov 20/84
 27757                                  ;   Look at the pathname and expand . and .. if they are the first element
 27758                                  ;   in the pathname (after the drive letter)
 27759                                  
 27760 00003682 06                      	push	es
 27761                                  	;push	pathinfo[0]
 27762 00003683 FF36[45A4]              	push	word [pathinfo+0]
 27763 00003687 07                      	pop	es
 27764                                  ;SR;
 27765                                  ; Oops! Gets fooled if path= \;..
 27766                                  ; We should also check if a drive letter is really present
 27767                                  ;
 27768 00003688 26807C022E              	cmp	byte [es:si+2],'.'
 27769                                  				; Look for Current dir at start of path
 27770 0000368D 7534                    	jne	short path_cpy
 27771                                  
 27772                                  	; 18/03/2023
 27773                                  	; MSDOS 6.0
 27774 0000368F 26807C013A              	cmp	byte [es:si+1],':'
 27775                                  				; does path have drive letter?
 27776 00003694 752D                    	jne	short path_cpy	; no, copy the path string
 27777                                  
 27778 00003696 51                      	push	cx		; Save pointer to end of string
 27779                                  	;mov	al,[es:si]
 27780                                  	;mov	[di],al		; Copy drive letter, :, and root char
 27781                                  	;mov	al,[es:si+1]	; to EXECPATH
 27782                                  	;mov	[di+1],al
 27783                                  	; 05/05/2023
 27784 00003697 268B04                  	mov	ax,[es:si]
 27785 0000369A 8905                    	mov	[di],ax
 27786 0000369C A0[4BA4]                	mov	al,[psep_char]
 27787 0000369F 884502                  	mov	[di+2],	al
 27788 000036A2 56                      	push	si		; Save pointer to begining of string
 27789 000036A3 268A14                  	mov	dl,[es:si]	; Convert device letter for cur dir
 27790 000036A6 80CA20                  	or	dl,20h
 27791                                  	;sub	dl,60h
 27792 000036A9 80EA60                  	sub	dl,'a'-1
 27793 000036AC 89FE                    	mov	si,di		; pointer to EXECPATH
 27794 000036AE 83C603                  	add	si,3		; Don't wipe out drive and root info
 27795 000036B1 B80047                  	mov	ax,Current_Dir*256 ; 4700h
 27796 000036B4 CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 27797                                  			; DL = drive (0=default,1=A,etc.)
 27798                                  			; DS:SI	points to 64-byte buffer area
 27799 000036B6 E8E6F9                  	call	dstrlen		; Determine length of present info
 27800 000036B9 01CE                    	add	si,cx		; Don't copy over drive and root info
 27801 000036BB 4E                      	dec	si
 27802 000036BC 89F7                    	mov	di,si		; Point to end of target string
 27803 000036BE 5E                      	pop	si		; Restore pointer to begining of string
 27804 000036BF 83C603                  	add	si,3		; Point past drive letter, :, .
 27805 000036C2 59                      	pop	cx		; Restore pointer to end of string
 27806                                  path_cpy:
 27807 000036C3 07                      	pop	es
 27808 000036C4 29F1                    	sub	cx,si		; yields character count
 27809 000036C6 1E                      	push	ds		; time to switch segments
 27810 000036C7 FF36[45A4]              	push	word [pathinfo+0]
 27811                                  				; string lives in this segment
 27812 000036CB 1F                      	pop	ds
 27813 000036CC FC                      	cld
 27814                                  
 27815                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27816                                  	; MSDOS 5.0 (& MSDOS 5.0)
 27817                                  	;;rep	movsb ; 3/3/KK	; copy the prefix path into EXECPATH
 27818                                  kloop:
 27819 000036CD AC                      	lodsb			;AN000;  3/3/KK
 27820 000036CE AA                      	stosb			;AN000;  3/3/KK
 27821 000036CF E88FF0                  	call	testkanj	;AN000;  3/3/KK
 27822 000036D2 7410                    	jz	short _notkanj1	;AN000;  3/3/KK
 27823 000036D4 49                      	dec	cx		;AN000;  3/3/KK
 27824 000036D5 E307                    	jcxz	popdone		;AN000;  Ignore boundary error 3/3/KK
 27825 000036D7 A4                      	movsb			;AN000;  3/3/KK
 27826 000036D8 49                      	dec	cx		;AN000;  3/3/KK
 27827 000036D9 83F901                  	cmp	cx,1		;AN000;  One char (the terminator) left ? 3/3/KK
 27828 000036DC 77EF                    	ja	short kloop	;AN000;  no.  3/3/KK
 27829                                  popdone:			;AN000;  3/3/KK
 27830 000036DE 1F                      	pop	ds		;AN000;  Yes ES:DI->terminator, last char is 3/3/KK
 27831 000036DF A0[4BA4]                	mov	al,[psep_char]	;AN000;  KANJI 3/3/KK
 27832 000036E2 EB0C                    	jmp	short path_store
 27833                                  				;AN000;  3/3/KK
 27834                                  _notkanj1:
 27835                                  	; 26/04/2023
 27836 000036E4 E2E7                    	loop	kloop
 27837 000036E6 1F                      	pop	ds		; return to our segment
 27838 000036E7 4F                      	dec	di		; overwrite terminator
 27839 000036E8 A0[4BA4]                	mov	al,[psep_char]	; with a pathname separator
 27840 000036EB 3A45FF                  	cmp	al,[di-1]
 27841 000036EE 7401                    	je	short path_success
 27842                                  path_store:
 27843 000036F0 AA                      	stosb
 27844                                  path_success:
 27845 000036F1 BE[4DA4]                	mov	si,search_best_buf
 27846 000036F4 31C9                    	xor	cx,cx
 27847                                  path_succ_loop:
 27848 000036F6 AC                      	lodsb			; append winning filename to path
 27849 000036F7 AA                      	stosb			; (including terminating null)
 27850 000036F8 08C0                    	or	al,al
 27851 000036FA 75FA                    	jnz	short path_succ_loop
 27852 000036FC 89E8                    	mov	ax,bp		; retrieve filetype code
 27853                                  path_exit:
 27854 000036FE 9D                      	popf
 27855 000036FF 5D                      	pop	bp
 27856 00003700 5F                      	pop	di
 27857 00003701 5E                      	pop	si		; chill out...
 27858 00003702 5A                      	pop	dx
 27859 00003703 59                      	pop	cx
 27860 00003704 5B                      	pop	bx
 27861 00003705 C3                      	retn
 27862                                  
 27863                                  ; =============== S U B	R O U T	I N E =======================================
 27864                                  
 27865                                  ; STORE_PCHAR determines the pathname-element separator and squirrels
 27866                                  ; it away. In other words, must we say '/bin/ls' or '\bin\ls'?
 27867                                  ;
 27868                                  ; ENTRY:
 27869                                  ; EXIT:
 27870                                  ; NOTE(S):
 27871                                  ;   *	Uses <psep_char>, defined in <path_search>.
 27872                                  
 27873                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27874                                  STORE_PCHAR:
 27875 00003706 50                      	push	ax
 27876 00003707 B02F                    	mov	al,'/'		; is the pathname-element separator
 27877 00003709 E808F3                  	call	pathchrcmp	; a regular slash?
 27878 0000370C 7402                    	jz	short STORE_SLASH
 27879                                  				; if yes, remember slash
 27880 0000370E B05C                    	mov	al,'\'
 27881                                  	; 18/03/2023
 27882                                  	;mov	[psep_char],al	; otherwise, remember back-slash
 27883                                  	;pop	ax
 27884                                  	;retn
 27885                                  STORE_SLASH:
 27886 00003710 A2[4BA4]                	mov	[psep_char],al
 27887 00003713 58                      	pop	ax
 27888 00003714 C3                      	retn
 27889                                  
 27890                                  ; =============== S U B	R O U T	I N E =======================================
 27891                                  
 27892                                  ; PATH_CRUNCH takes a prefix from a prefix string, and a suffix from
 27893                                  ; EXECPATH, and smooshes them into tpbuf. The caller may supply an
 27894                                  ; additional separator to use for breaking up the path-string. Null is the
 27895                                  ; default. Once the user-string has been formed, search is invoked to see
 27896                                  ; what's out there.
 27897                                  ;
 27898                                  ; ENTRY:
 27899                                  ;   BH			--	additional terminator character
 27900                                  ;   SI			--	pointer into pathstring to be dissected
 27901                                  ;   DX			--	pointer to stripped filename
 27902                                  ; EXIT:
 27903                                  ;   AX			--	non-zero (file type), zero (nothing found)
 27904                                  ;   SI			--	moves along pathstring from call to call
 27905                                  ;   [search_best_buf]	--	name of best file (AX non-zero)
 27906                                  ;   [tpbuf]		--	clobbered
 27907                                  ; NOTE(S):
 27908                                  ;   *	Implicit in this code is the ability to specify when to search
 27909                                  ;	the current directory (if at all) through the PATH defined by
 27910                                  ;	the user, a la UNIX (e.g., PATH=;c:\bin;c:\etc searches the
 27911                                  ;	current directory before the bin and etc directories of drive c).
 27912                                  
 27913                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27914                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3454h
 27915                                  
 27916                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27917                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:39FEh
 27918                                  
 27919                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 27920                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:38B2h
 27921                                  path_crunch:
 27922 00003715 53                      	push	bx
 27923 00003716 51                      	push	cx
 27924 00003717 52                      	push	dx
 27925 00003718 57                      	push	di
 27926 00003719 56                      	push	si
 27927                                  	;pushf	; ** ; 18/03/2023
 27928 0000371A E8E9FF                  	call	STORE_PCHAR	; figure out pathname separator
 27929 0000371D BF[96A3]                	mov	di,TPBUF	; destination of concatenated string
 27930 00003720 8B36[49A4]              	mov	si,[pathinfo+4]	; "new" pointer to start with
 27931 00003724 8936[47A4]              	mov	[pathinfo+2],si	; becomes "old" pointer
 27932 00003728 1E                      	push	ds		; save old segment pointer
 27933 00003729 FF36[45A4]              	push	word [pathinfo+0]
 27934                                  				; replace with pointer to userpath's
 27935 0000372D 1F                      	pop	ds		; segment
 27936                                  	; 26/04/2023
 27937 0000372E 30C9                    	xor	cl,cl		;AN000; clear flag for later use 3/3/KK
 27938                                  path_cr_copy:
 27939 00003730 AC                      	lodsb			; get a pathname byte
 27940 00003731 08C0                    	or	al,al		; check for terminator(s)
 27941 00003733 7414                    	jz	short path_seg	; null terminates segment & pathstring
 27942 00003735 38F8                    	cmp	al,bh
 27943 00003737 7410                    	je	short path_seg	; BH terminates a pathstring segment
 27944                                  	;
 27945                                  	; 18/03/2023
 27946                                  	; MSDOS 6.0 (& 5.0) COMMAND.COM
 27947 00003739 E825F0                  	call	testkanj	;AN000; 3/3/KK
 27948 0000373C 7406                    	jz	short _notkanj2	;AN000; 3/3/KK
 27949 0000373E AA                      	stosb			;AN000; 3/3/KK
 27950 0000373F A4                      	movsb			;AN000; 3/3/KK
 27951 00003740 B101                    	mov	cl,1 ; *	;AN000; CL=1 means latest stored char is DBCS 3/3/KK
 27952 00003742 EBEC                    	jmp	short path_cr_copy
 27953                                  _notkanj2:
 27954 00003744 30C9                    	xor	cl,cl ; *	;AN000; CL=0 means latest stored char is SBCS 3/3/KK
 27955                                  	;
 27956 00003746 AA                      	stosb
 27957 00003747 EBE7                    	jmp	short path_cr_copy
 27958                                  
 27959                                  path_seg:
 27960 00003749 1F                      	pop	ds		; restore old data segment
 27961 0000374A 8936[49A4]              	mov	[pathinfo+4],si	; save "new" pointer for next time
 27962 0000374E 88C3                    	mov	bl,al		; remember if we saw null or not...
 27963                                  				;;; REMOVE NEXT 3 LINES FOR CURDIR SPEC
 27964 00003750 31C0                    	xor	ax,ax		; in case nothing in pathstr...
 27965 00003752 81FF[96A3]              	cmp	di,TPBUF	; was there really anything in pathstr?
 27966 00003756 7421                    	je	short path_cr_leave
 27967                                  				; if nothing was copied, pathstr empty
 27968                                  path_cr_look:
 27969 00003758 A0[4BA4]                	mov	al,[psep_char]	; form complete pathname
 27970                                  	;
 27971                                  	; 18/03/2023
 27972                                  	; MSDOS 6.0
 27973 0000375B 08C9                    	or	cl,cl ; *	;AN000; 3/3/KK
 27974 0000375D 7505                    	jnz	short path_cr_store
 27975                                  				;AN000; this is a trailing byte of ECS code 3/3/KK
 27976                                  	;
 27977 0000375F 3A45FF                  	cmp	al,[di-1]	; add pathname separator for suffix
 27978 00003762 7401                    	je	short path_cr_l1
 27979                                  path_cr_store:
 27980 00003764 AA                      	stosb
 27981                                  path_cr_l1:
 27982 00003765 89D6                    	mov	si,dx
 27983                                  path_cr_l2:
 27984 00003767 AC                      	lodsb			; tack the stripped filename onto
 27985 00003768 AA                      	stosb			; the end of the path, up to and
 27986 00003769 08C0                    	or	al,al		; including the terminating null
 27987 0000376B 75FA                    	jnz	short path_cr_l2
 27988 0000376D BA[96A3]                	mov	dx,TPBUF	; and look for an appropriate file...
 27989 00003770 C706[9AA4][5491]        	mov	word [search_error],BADPMES_PTR
 27990                                  	;invoke search
 27991 00003776 E80900                  	call	PSEARCH		; results are in AX & search_best_buf
 27992                                  
 27993                                  	; 18/03/2023
 27994                                  ;path_cr_leave:
 27995                                  	;or	bl,bl		; did we finish off the pathstring?
 27996                                  	;jz	short path_cr_empty
 27997                                  	;			; null in BL means all gone...
 27998                                  	;popf	; **		; otherwise, plenty left
 27999                                  	;clc
 28000                                  	;jmp	short path_cr_exit
 28001                                  ;path_cr_empty:
 28002                                  	;popf	; **
 28003                                  	;stc
 28004                                  ;path_cr_exit:
 28005                                  
 28006                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28007                                  path_cr_leave:
 28008                                  	;popf ; ** ; 18/03/2023
 28009 00003779 80FB01                  	cmp	bl,1	; if bl = 0 -> cf = 1 (path_cr_empty:)
 28010                                  
 28011                                  path_cr_exit:
 28012 0000377C 5E                      	pop	si
 28013 0000377D 5F                      	pop	di
 28014 0000377E 5A                      	pop	dx
 28015 0000377F 59                      	pop	cx
 28016 00003780 5B                      	pop	bx
 28017 00003781 C3                      	retn
 28018                                  
 28019                                  ;============================================================================
 28020                                  ; PATH2.ASM, MSDOS 6.0, 1991
 28021                                  ;============================================================================
 28022                                  ; 02/10/2018 - Retro DOS v3.0
 28023                                  
 28024                                  ;----------------------------------------------------------------------------
 28025                                  ;   SEARCH, when given a pathname, attempts to find a file with
 28026                                  ; one of the following extensions: .com, .exe, .bat (highest to
 28027                                  ; lowest priority). Where conflicts arise, the extension with
 28028                                  ; the highest priority is favored.
 28029                                  ; ENTRY:
 28030                                  ;   DX		--	pointer to null-terminated pathname
 28031                                  ;   fbuf	--	dma buffer for findfirst/next
 28032                                  ; EXIT:
 28033                                  ;   AX		--	8)  file found with .com extension
 28034                                  ;			4)  file found with .exe extension
 28035                                  ;			2)  file found with .bat extension
 28036                                  ;			0)  no such file to be found
 28037                                  ;   (if AX is non-zero:)
 28038                                  ;   [search_best]	identical to AX
 28039                                  ;   [search_best_buf]	null-terminated filename
 28040                                  ; NOTES:
 28041                                  ;   1) Requires caller to have allocated a dma buffer and executed a setdma.
 28042                                  ;---------------
 28043                                  ; CONSTANTS:
 28044                                  ;---------------
 28045                                  SEARCH_FILE_NOT_FOUND	EQU	0
 28046                                  SEARCH_COM		EQU	8
 28047                                  SEARCH_EXE		EQU	4
 28048                                  SEARCH_BAT		EQU	2
 28049                                  FNAME_LEN		EQU	8
 28050                                  FNAME_MAX_LEN		EQU	13
 28051                                  DOT			EQU	'.'
 28052                                  WILDCHAR		EQU	'?'
 28053                                  
 28054                                  
 28055                                  ; =============== S U B	R O U T	I N E =======================================
 28056                                  
 28057                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 26D6h
 28058                                  
 28059                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28060                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:34C9h
 28061                                  
 28062                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28063                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3A73h
 28064                                  
 28065                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 28066                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3927h
 28067                                  PSEARCH:
 28068 00003782 51                      	push	cx
 28069 00003783 52                      	push	dx
 28070 00003784 57                      	push	di
 28071 00003785 56                      	push	si
 28072                                  	;pushf	; ** ; 18/03/2023
 28073 00003786 52                      	push	dx		; check drivespec (save pname ptr)
 28074 00003787 89D7                    	mov	di,dx		; working copy of pathname
 28075 00003789 BE[5AA4]                	mov	si,search_curdir_buf
 28076 0000378C 31D2                    	xor	dx,dx		; zero means current drive
 28077 0000378E 807D013A                	cmp	byte [di+1],':'	; is there a drive spec?
 28078 00003792 7508                    	jne	short SEARCH_DIR_CHECK
 28079 00003794 8A15                    	mov	dl,[di]		; get the drive byte
 28080 00003796 80E2DF                  	and	dl,0DFh ; ~20h	; uppercase the sucker
 28081 00003799 80EA40                  	sub	dl,'@' ; 40h	; and convert to drive number
 28082                                  SEARCH_DIR_CHECK:
 28083 0000379C B80047                  	mov	ax,Current_Dir*256 ; 4700h
 28084 0000379F CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 28085                                  			; DL = drive (0=default,1=A,etc.)
 28086                                  			; DS:SI	points to 64-byte buffer area
 28087 000037A1 5A                      	pop	dx		; directory? If we can't we'll
 28088 000037A2 724C                    	jc	short SEARCH_INVALID_DRIVE
 28089                                  				; assume it's a bad drive...
 28090 000037A4 B91300                  	mov	cx,search_attr	; 13h
 28091                                  				; filetypes to search for
 28092 000037A7 B8004E                  	mov	ax,Find_First*256 ; 4E00h ; request first match, if any
 28093 000037AA CD21                    	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 28094                                  			; CX = search attributes
 28095                                  			; DS:DX	-> ASCIZ filespec
 28096                                  			; (drive,path, and wildcards allowed)
 28097 000037AC 7249                    	jc	short SEARCH_NO_FILE
 28098 000037AE C606[4CA4]00            	mov	byte [search_best],SEARCH_FILE_NOT_FOUND ; 0
 28099 000037B3 C606[4DA4]00            	mov	byte [search_best_buf],ANULL
 28100                                  				; 0 ; nothing's been found, yet
 28101                                  SEARCH_LOOP:
 28102 000037B8 E84300                  	call	SEARCH_FTYPE	; determine if .com, &c...
 28103 000037BB 3A06[4CA4]              	cmp	al,[search_best]
 28104                                  				; better than what we've found so far?
 28105 000037BF 7E13                    	jle	short SEARCH_NEXT
 28106                                  				; no, look for another
 28107 000037C1 A2[4CA4]                	mov	[search_best],al
 28108                                  				; found something... save its code
 28109                                  	;mov	si,offset TRANGROUP:fbuf.find_buf_pname
 28110                                  	;mov	si,FBUF_PNAME
 28111 000037C4 BE[38A4]                	mov	si,FBUF+FIND_BUF.PNAME ; FBUF+30
 28112 000037C7 BF[4DA4]                	mov	di,search_best_buf
 28113 000037CA B90D00                  	mov	cx,FNAME_MAX_LEN ; 13
 28114 000037CD FC                      	cld
 28115 000037CE F3A4                    	rep	movsb		; save complete pathname representation
 28116 000037D0 3C08                    	cmp	al,SEARCH_COM	; 8
 28117                                  				; have we found the best of all?
 28118 000037D2 740A                    	je	short SEARCH_DONE
 28119                                  SEARCH_NEXT:			; keep on looking
 28120 000037D4 B91300                  	mov	cx,search_attr ; 13h
 28121 000037D7 B8004F                  	mov	ax,Find_Next*256 ; 4F00h ; next match
 28122 000037DA CD21                    	int	21h	; DOS -	2+ - FIND NEXT ASCIZ (FINDNEXT)
 28123                                  			; [DTA]	= data block from
 28124                                  			; last AH = 4Eh/4Fh call
 28125 000037DC 73DA                    	jnc	short SEARCH_LOOP
 28126                                  SEARCH_DONE:			; it's all over with...
 28127 000037DE A0[4CA4]                	mov	al,[search_best]
 28128                                  				; pick best to return with
 28129                                  	; 18/03/2023
 28130                                  	; MSDOS 6.0
 28131 000037E1 803E[069F]01            	cmp	byte [ext_entered],1
 28132                                  				;AN005; Did user request a specific ext?
 28133 000037E6 7411                    	je	short SEARCH_EXIT
 28134                                  				;AN005; no - exit
 28135 000037E8 A0[069F]                	mov	al,[ext_entered]
 28136                                  				;AN005; yes - get the real file type back
 28137 000037EB A2[4CA4]                	mov	[search_best],al
 28138                                  				;AN005; save the real file type
 28139                                  	;
 28140 000037EE EB09                    	jmp	short SEARCH_EXIT
 28141                                  
 28142                                  SEARCH_INVALID_DRIVE:		; Tell the user path/drive
 28143 000037F0 8B16[9AA4]              	mov	dx,[search_error]
 28144                                  				; appropriate error message
 28145 000037F4 E8311C                  	call	std_printf	; and pretend no file found
 28146                                  
 28147                                  SEARCH_NO_FILE:			; couldn't find a match
 28148                                  	;mov	ax,SEARCH_FILE_NOT_FOUND ; 0
 28149                                  	; 18/03/2023
 28150 000037F7 31C0                    	xor	ax,ax
 28151                                  SEARCH_EXIT:
 28152                                  	;popf	; ** ; 18/03/2023
 28153 000037F9 5E                      	pop	si
 28154 000037FA 5F                      	pop	di
 28155 000037FB 5A                      	pop	dx
 28156 000037FC 59                      	pop	cx
 28157 000037FD C3                      	retn
 28158                                  
 28159                                  ; =============== S U B	R O U T	I N E =======================================
 28160                                  
 28161                                  ; SEARCH_FTYPE determines the type of a file by examining its extension.
 28162                                  ;
 28163                                  ; ENTRY:
 28164                                  ;   fbuf    --	dma buffer containing filename
 28165                                  ; EXIT:
 28166                                  ;   AX	    --	file code, as given in search header
 28167                                  ; NOTE(S):
 28168                                  ;   *	Implicit assumption that NULL == search_file_not_found
 28169                                  
 28170                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28171                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28172                                  
 28173                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 28174                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3927h
 28175                                  SEARCH_FTYPE:
 28176 000037FE 57                      	push	di
 28177 000037FF 56                      	push	si
 28178                                  	;mov	ax,ANULL ; 0	; find the end of the filename
 28179                                  	; 18/02/2023
 28180 00003800 31C0                    	xor	ax,ax ; ax = 0		
 28181                                  	;mov	di,offset TRANGROUP:fbuf.find_buf_pname
 28182                                  	;mov	di,FBUF_PNAME
 28183 00003802 BF[38A4]                	mov	di,FBUF+FIND_BUF.PNAME ; FBUF+1Eh
 28184 00003805 B90D00                  	mov	cx,FNAME_MAX_LEN ; 13
 28185 00003808 FC                      	cld
 28186 00003809 F2AE                    	repnz	scasb		; search for the terminating null
 28187 0000380B 7535                    	jnz	short FTYPE_EXIT
 28188                                  				; weird... no null byte at end
 28189 0000380D 83EF05                  	sub	di,5		; . + E + X + T + NULL
 28190                                  
 28191                                  	; Compare .COM
 28192                                  
 28193 00003810 BE[C495]                	mov	si,comext ; ".COM"
 28194 00003813 89F8                    	mov	ax,di
 28195 00003815 A7                      	cmpsw
 28196 00003816 7508                    	jnz	short FTYPE_EXE
 28197 00003818 A7                      	cmpsw
 28198 00003819 7505                    	jnz	short FTYPE_EXE
 28199                                  	;mov	ax,8
 28200 0000381B B80800                  	mov	ax,SEARCH_COM	; success!
 28201 0000381E EB22                    	jmp	short FTYPE_EXIT
 28202                                  
 28203                                  	; Compare .EXE
 28204                                  FTYPE_EXE:			; still looking... now for '.exe'
 28205 00003820 89C7                    	mov	di,ax
 28206 00003822 BE[C895]                	mov	si,exeext ; ".EXE"
 28207 00003825 A7                      	cmpsw
 28208 00003826 7508                    	jnz	short FTYPE_BAT
 28209 00003828 A7                      	cmpsw
 28210 00003829 7505                    	jnz	short FTYPE_BAT
 28211                                  	;mov	ax,4
 28212 0000382B B80400                  	mov	ax,SEARCH_EXE	; success!
 28213 0000382E EB12                    	jmp	short FTYPE_EXIT
 28214                                  
 28215                                  	; Compare .BAT
 28216                                  FTYPE_BAT:			; still looking... now for '.bat'
 28217 00003830 89C7                    	mov	di,ax
 28218 00003832 BE[CC95]                	mov	si,batext ; ".BAT"
 28219 00003835 A7                      	cmpsw
 28220 00003836 7508                    	jnz	short FTYPE_FAIL
 28221 00003838 A7                      	cmpsw
 28222 00003839 7505                    	jnz	short FTYPE_FAIL
 28223                                  	;mov	ax,2
 28224 0000383B B80200                  	mov	ax,SEARCH_BAT	; success!
 28225 0000383E EB02                    	jmp	short FTYPE_EXIT
 28226                                  
 28227                                  FTYPE_FAIL:			; file doesn't match what we need
 28228                                  	;mov	ax,ANULL ; 0
 28229                                  	; 18/03/2023
 28230 00003840 29C0                    	sub	ax,ax  ; ax = 0
 28231                                  FTYPE_EXIT:
 28232                                  	; 18/03/2023
 28233                                  	; MSDOS 6.0
 28234 00003842 803E[069F]01            	cmp	byte [ext_entered],1
 28235                                  				;AN005; was an extension entered?
 28236 00003847 740A                    	jz	short FTYPE_DONE
 28237                                  				;AN005; no - exit
 28238                                  	;cmp	ax,ANULL	;AN005; was any match found
 28239 00003849 21C0                    	and	ax,ax  ; ax = 0 ?
 28240 0000384B 7406                    	jz	short FTYPE_DONE
 28241                                  				;AN005; no - exit
 28242 0000384D A2[069F]                	mov	[ext_entered],al
 28243                                  				;AN005; save the match type found
 28244 00003850 B80800                  	mov	ax,SEARCH_COM	;AN005; send back best was found to stop search
 28245                                  FTYPE_DONE:
 28246 00003853 5E                      	pop	si
 28247 00003854 5F                      	pop	di
 28248 00003855 C3                      	retn
 28249                                  
 28250                                  ; =============== S U B	R O U T	I N E =======================================
 28251                                  
 28252                                  ; STRIP copies the source string (argv[0]) into the destination buffer,
 28253                                  ; replacing any extension with wildcards.
 28254                                  ;
 28255                                  ; ENTRY:
 28256                                  ;	BX	--	maximum length of destination buffer
 28257                                  ;	DS:SI	--	address of destination buffer
 28258                                  ;	argv[0] --	command name to be stripped
 28259                                  ; EXIT:
 28260                                  ;	CF	--	set if failure, clear if successful
 28261                                  ; NOTE(S):
 28262                                  
 28263                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28264                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28265                                  	; 08/08/2024 - Retro DOS v5.0 COMMAND.COM
 28266                                  STRIP:
 28267 00003856 50                      	push	ax
 28268 00003857 53                      	push	bx
 28269 00003858 51                      	push	cx
 28270 00003859 52                      	push	dx
 28271 0000385A 57                      	push	di
 28272 0000385B 56                      	push	si
 28273                                  	;pushf	; ** ; 18/03/2023
 28274                                  		
 28275                                  	; 05/05/2023
 28276                                  	; MSDOS 6.0
 28277 0000385C C606[069F]01            	mov	byte [ext_entered],1
 28278                                  				;AN005; assume no extension on file name
 28279                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28280                                  	;mov	dx,[ARG_ARGV]
 28281                                  	;mov	dx,ds:arg.argv[0].argpointer
 28282                                  				; save pointer to beginning of argstring
 28283                                  	;mov	dx,[ARGV0_ARGPOINTER]
 28284 00003861 8B16[509F]              	mov	dx,[ARG+ARGV_ELE.argpointer]
 28285                                  	;mov	di,ds:arg.argv[0].argstartel
 28286                                  				; beginning of last pathname element
 28287                                  	;mov	di,[ARGV0_ARGSTARTEL] ; beginning of last pathname element
 28288 00003865 8B3E[539F]              	mov	di,[ARG+ARGV_ELE.argstartel]
 28289 00003869 803D00                  	cmp	byte [di],0	; *STARTEL == NULL means no command
 28290 0000386C 743D                    	je	short STRIP_ERROR
 28291 0000386E 89D1                    	mov	cx,dx		; compute where end of argstring lies
 28292                                  	;add	cx,ds:arg.argv[0].arglen
 28293                                  	;add	cx,[ARGV0_ARGLEN]
 28294 00003870 030E[559F]              	add	cx,[ARG+ARGV_ELE.arglen]
 28295 00003874 29F9                    	sub	cx,di		; and then find length of last element
 28296 00003876 41                      	inc	cx		; include null as well
 28297 00003877 B02E                    	mov	al,'.'
 28298                                  	;mov	al,DOT		; let's find the filetype extension
 28299 00003879 FC                      	cld
 28300 0000387A F2AE                    	repnz	scasb		; wind up pointing to either null or dot
 28301                                  
 28302                                  	; 18/03/2023
 28303                                  	; MSDOS 6.0
 28304 0000387C E307                    	jcxz	PROCESS_EXT	;AN005; if no extension found, just continue
 28305 0000387E B000                    	mov	al,0 ; 18/03/2023
 28306                                  	;mov	byte [ext_entered],0
 28307 00003880 A2[069F]                	mov	[ext_entered],al
 28308                                  				;AN005; we found an extension
 28309                                  	;;mov	al,ANULL	;AN005; continue scanning until the
 28310                                  	;mov	al,0
 28311 00003883 F2AE                    	repnz	scasb		;AN005; end of line is reached.
 28312                                  PROCESS_EXT:
 28313                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28314 00003885 89F9                    	mov	cx,di		; pointer to end of argstring yields
 28315 00003887 29D1                    	sub	cx,dx		; number of bytes to be copied
 28316 00003889 83EB04                  	sub	bx,4		; can argstring fit into dest. buffer?
 28317 0000388C 39D9                    	cmp	cx,bx
 28318 0000388E 7F1B                    	jg	short STRIP_ERROR
 28319                                  				; if not, we must have a bad pathname
 28320 00003890 89F7                    	mov	di,si		; destination buffer
 28321 00003892 89D6                    	mov	si,dx		; source is beginning of pathname
 28322 00003894 FC                      	cld
 28323 00003895 F3A4                    	rep	movsb		; SI=arg,DI=buffer,CX=argend-argbeg
 28324                                  
 28325                                  	; 18/03/2023
 28326                                  	; MSDOS 6.0
 28327 00003897 803E[069F]01            	cmp	byte [ext_entered],1
 28328                                  				;AN005; if an extension was entered
 28329 0000389C 750A                    	jne	short SKIP_WILDS ; cf = 1 ; 12/06/2023
 28330                                  				;AN005;    don't set up wildcard ext.
 28331                                  
 28332                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28333 0000389E 4F                      	dec	di		; overwrite null or dot
 28334 0000389F AA                      	stosb			; with a dot
 28335 000038A0 B03F                    	mov	al,'?'
 28336                                  	;mov	al,WILDCHAR	; now add wildcards
 28337 000038A2 AA                      	stosb
 28338 000038A3 AA                      	stosb
 28339 000038A4 AA                      	stosb
 28340 000038A5 B000                    	mov	al,0
 28341                                  	;mov	al,ANULL	; and a terminating null	
 28342 000038A7 AA                      	stosb
 28343                                  SKIP_WILDS:
 28344                                  	;popf	; ** ; 18/03/2023
 28345 000038A8 F8                      	clc
 28346 000038A9 EB01                    	jmp	short STRIP_EXIT ; chill out...
 28347                                  
 28348                                  STRIP_ERROR:
 28349                                  	;popf	; ** ; 18/03/2023
 28350 000038AB F9                      	stc
 28351                                  STRIP_EXIT:
 28352 000038AC 5E                      	pop	si
 28353 000038AD 5F                      	pop	di
 28354 000038AE 5A                      	pop	dx
 28355 000038AF 59                      	pop	cx
 28356 000038B0 5B                      	pop	bx
 28357 000038B1 58                      	pop	ax
 28358 000038B2 C3                      	retn
 28359                                  
 28360                                  ; =============== S U B	R O U T	I N E =======================================
 28361                                  
 28362                                  ; SAVE_ARGS attempts to preserve the existing argv[]/argvcnt/argbuffer
 28363                                  ;
 28364                                  ; structure in newly allocated memory. The argv[] structure is found at the
 28365                                  ; beginning of this area. The caller indicates how much extra space is
 28366                                  ; needed in the resulting structure; Save_Args returns a segment number and
 28367                                  ; an offset into that area, indicating where the caller may preserve its own
 28368                                  ; data. Note that <argvcnt> can be found at <offset-2>.
 28369                                  ; ENTRY:
 28370                                  ;   BX	    --	size (in bytes) of extra area to allocate
 28371                                  ; EXIT:
 28372                                  ;   AX	    --	segment of new area.
 28373                                  ;   CF	    --	set if unable to save a copy.
 28374                                  ; NOTE(S):
 28375                                  ;   1)	The allocated area will be AT LEAST the size requested -- since
 28376                                  ;	the underlying MSDOS call, <alloc> returns an integral number of
 28377                                  ;	paragraphs.
 28378                                  ;   2)	It is an error if MSDOS can't allocate AT LEAST as much memory
 28379                                  ;	as the caller of Save_Args requests.
 28380                                  ;   3)	AX is undefined if CF indicates an error.
 28381                                  
 28382                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28383                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28384                                  	; 09/08/2024 - Retro DOS v5.0 COMMAND.COM
 28385                                  SAVE_ARGS:
 28386 000038B3 53                      	push	bx
 28387 000038B4 51                      	push	cx
 28388 000038B5 52                      	push	dx
 28389 000038B6 57                      	push	di
 28390 000038B7 56                      	push	si
 28391 000038B8 55                      	push	bp
 28392                                  	; 01/05/2023
 28393                                  	; 26/04/2023
 28394                                  	;pushf ; **
 28395                                  	;;add	bx,1363		; space for arg structure, round up
 28396                                  	; 09/08/2024 - PCDOS 7.1 COMMAND.COM
 28397                                  	;add	bx,1107 ; 1092+15
 28398 000038B9 81C35304                	add	bx,ARG_UNIT.SIZE+15 ; 1348+15
 28399 000038BD B104                    	mov	cl,4		; to paragraph size and convert
 28400 000038BF D3EB                    	shr	bx,cl		; size in bytes to size in paragraphs
 28401 000038C1 B80048                  	mov	ax,ALLOC*256 ; 4800h
 28402 000038C4 CD21                    	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 28403                                  			; BX = number of 16-byte paragraphs desired
 28404 000038C6 7241                    	jc	short SAVE_ERROR ; ***
 28405 000038C8 89C5                    	mov	bp,ax		; save segment id
 28406 000038CA 06                      	push	es		; save TRANGROUP address
 28407 000038CB 8EC0                    	mov	es,ax		; switch to new memory segment
 28408                                  	; assume es:nothing
 28409                                  	;mov	cx,1348		; get back structure size
 28410 000038CD B94404                  	mov	cx,ARG_UNIT.SIZE ; 1092 ; 09/08/2024
 28411 000038D0 31FF                    	xor	di,di		; destination is new memory area
 28412                                  	;mov	si,ARG_ARGV
 28413 000038D2 BE[509F]                	mov	si,ARG		; source is arg structure
 28414                                  	; 09/08/2024
 28415 000038D5 56                      	push	si
 28416 000038D6 F3A4                    	rep	movsb		; move that sucker!
 28417                                  	;mov	cx,arg.argvcnt 	; adjust argv pointers
 28418                                  	;mov	cx,[ARG_ARGVCNT]
 28419 000038D8 8B0E[10A2]              	mov	cx,[ARG+ARG_UNIT.argvcnt]
 28420 000038DC 31C0                    	xor	ax,ax		; base address for argv_calc
 28421                                  
 28422                                  ;	Bugbug:	What did they mean by this?
 28423                                  ;	Note that the replacement line produces exactly the same code.
 28424                                  ;;	mov	SI, OFFSET TRANGROUP:arg.argbuf - OFFSET arg_unit.argbuf
 28425                                  ;	mov	SI, OFFSET TRANGROUP:arg
 28426                                  
 28427                                  	;;mov	si,ARG_ARGV
 28428                                  	;mov	si,ARG
 28429                                  	; 09/08/2024
 28430 000038DE 5E                      	pop	si
 28431                                  SAVE_PTR_LOOP:
 28432 000038DF 49                      	dec	cx		; exhausted all args?
 28433 000038E0 7C24                    	jl	short SAVE_DONE
 28434 000038E2 89CB                    	mov	bx,cx		; get arg index and
 28435 000038E4 E8A9FC                  	call	argv_calc	; convert to a pointer
 28436                                  	;mov	dx,ds:arg.argv[bx].argpointer
 28437                                  	;mov	dx,[ARG_ARGV+bx]
 28438 000038E7 8B97[509F]              	mov	dx,[ARG+ARGV_ELE.argpointer+bx]
 28439 000038EB 29F2                    	sub	dx,si		; adjust argpointer
 28440                                  	;mov	es:argv[BX].argpointer,dx
 28441                                  	;mov	[es:bx+ARGV_ELE.argpointer],dx ; mov [es:bx+0],dx
 28442 000038ED 268917                  	mov	[es:bx],dx
 28443                                  	;mov	dx,ds:arg.argv[bx].argstartel
 28444                                  	;mov	dx,[ARGV0_ARGSTARTEL+bx]
 28445 000038F0 8B97[539F]              	mov	dx,[ARG+ARGV_ELE.argstartel+bx]
 28446 000038F4 29F2                    	sub	dx,si		; and adjust argstartel
 28447                                  	;mov	es:argv[bx].argstartel,dx
 28448                                  	;mov	[es:bx+3],dx
 28449 000038F6 26895703                	mov	[es:bx+ARGV_ELE.argstartel],dx
 28450                                  	;mov	dx,ds:arg.argv[bx].arg_ocomptr
 28451                                  	;mov	dx,[ARGV0_OCOMPTR+bx]
 28452 000038FA 8B97[599F]              	mov	dx,[ARG+ARGV_ELE.arg_ocomptr+bx]
 28453 000038FE 29F2                    	sub	dx,si		; and adjust arg_ocomptr
 28454                                  	;mov	es:argv[bx].arg_ocomptr,dx
 28455                                  	;mov	[es:bx+9],dx
 28456 00003900 26895709                	mov	[es:bx+ARGV_ELE.arg_ocomptr],dx
 28457 00003904 EBD9                    	jmp	short SAVE_PTR_LOOP
 28458                                  SAVE_DONE:
 28459 00003906 07                      	pop	es		; back we go to TRANGROUP
 28460                                  	; assume es:nothing
 28461 00003907 89E8                    	mov	ax,bp		; restore segment id
 28462                                  	; 26/04/2023
 28463                                  	; cf = 0 ; *
 28464                                  	;jmp	short SAVE_OK
 28465                                  
 28466                                  	; 26/04/2023
 28467                                  ;SAVE_ERROR:
 28468                                  ;	; 26/04/2023
 28469                                  ;	;popf ; **
 28470                                  ;	stc
 28471                                  ;	jmp	short SAVE_EXIT
 28472                                  
 28473                                  SAVE_OK:
 28474                                  	; 26/04/2023
 28475                                  	;popf ; **
 28476                                  	; 26/04/2023
 28477                                  	; cf = 0 ; *
 28478                                  	;clc
 28479                                  SAVE_EXIT:
 28480                                  SAVE_ERROR:	; 26/04/2023 (cf=1) ; ***
 28481 00003909 5D                      	pop	bp
 28482 0000390A 5E                      	pop	si
 28483 0000390B 5F                      	pop	di
 28484 0000390C 5A                      	pop	dx
 28485 0000390D 59                      	pop	cx
 28486 0000390E 5B                      	pop	bx
 28487                                  answ_no:	; 26/04/2023
 28488 0000390F C3                      	retn
 28489                                  
 28490                                  ;============================================================================
 28491                                  ; TUCODE.ASM, MSDOS 6.0, 1991 (1)
 28492                                  ;============================================================================
 28493                                  ; 02/10/2018 - Retro DOS v3.0
 28494                                  
 28495                                  ; Title	COMMAND Language midifiable Code Transient
 28496                                  
 28497                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2843h
 28498                                  
 28499                                  ; =============== S U B	R O U T	I N E =======================================
 28500                                  
 28501                                  ; ****************************************************************
 28502                                  ; *
 28503                                  ; * ROUTINE:	 NOTEST2 - execution of DEL/ERASE command
 28504                                  ; *
 28505                                  ; * FUNCTION:	 Delete files based on user parsed input. Prompt
 28506                                  ; *		 user for Y/N if necessary. If an error occurs,
 28507                                  ; *		 set up an error message and go to CERROR.
 28508                                  ; *
 28509                                  ; * INPUT:	 FCB at 5ch set up with filename(s) entered
 28510                                  ; *		 Current directory set to entered directory
 28511                                  ; *
 28512                                  ; * OUTPUT:	 none
 28513                                  ; *
 28514                                  ; ****************************************************************
 28515                                  ;
 28516                                  ; ARE YOU SURE prompt when deleting *.*
 28517                                  
 28518                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28519                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28520                                  notest2:
 28521 00003910 B90B00                  	mov	cx,11
 28522 00003913 BE5D00                  	mov	si,FCB+1 ; 5Dh
 28523                                  ambspec:
 28524 00003916 AC                      	lodsb
 28525 00003917 3C3F                    	cmp	al,'?'
 28526 00003919 7502                    	jne	short allfil
 28527 0000391B E2F9                    	loop	ambspec
 28528                                  allfil:
 28529                                  	; 19/03/2023
 28530                                  	;cmp	cx,0
 28531 0000391D 09C9                    	or	cx,cx
 28532 0000391F 752E                    	jnz	short noprmpt
 28533                                  askagn:	
 28534 00003921 BA[F190]                	mov	dx,SureMes_Ptr	; "Are you sure (Y/N)?"
 28535 00003924 E8011B                  	call	std_printf
 28536 00003927 BE8000                  	mov	si,80h
 28537 0000392A 89F2                    	mov	dx,si
 28538 0000392C C7047800                	mov	word [si],120	; zero length
 28539                                  	;mov	ax,0C0Ah
 28540 00003930 B80A0C                  	mov	ax,(STD_CON_INPUT_FLUSH<<8)|Std_Con_String_Input
 28541 00003933 CD21                    	int	21h	; DOS -	CLEAR KEYBOARD BUFFER
 28542                                  			; AL must be 01h,06h,07h,08h or 0Ah.
 28543 00003935 AD                      	lodsw
 28544 00003936 08E4                    	or	ah,ah
 28545 00003938 74E7                    	jz	short askagn
 28546 0000393A E849F0                  	call	scanoff
 28547                                  	; 19/03/2023
 28548                                  	; MSDOS 6.0
 28549 0000393D E80C02                  	call	char_in_xlat	; Convert to upper case
 28550                                  	;retc			; return if function not supported
 28551                                  	; 19/03/2023
 28552                                  	;jnc	short check_yn
 28553                                  ;answ_no:
 28554                                  	;retn
 28555 00003940 72CD                    	jc	short answ_no
 28556                                  
 28557                                  	; 19/03/2023
 28558                                  	; AL = 0 if it was (country depended) NO character
 28559                                  	; AL = 1 if it was (country depenced) YES character
 28560                                  
 28561                                  	; MSDOS 3.3
 28562                                  	;call	UPCONV
 28563                                  
 28564                                  	; 19/03/2023	
 28565                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28566                                  	;cmp	al,[CAPITAL_N]
 28567                                  	;jne	short CHECK_Y
 28568                                  	;retn
 28569                                  ;CHECK_Y:
 28570                                  	;cmp	al,[CAPITAL_Y]
 28571                                  	;pushf
 28572                                  	;call	CRLF2
 28573                                  	;popf
 28574                                  	;jne	short ASKAGN
 28575                                  
 28576                                  check_yn:
 28577                                  	; 19/03/2023
 28578                                  	;cmp	al,0	; NO character
 28579 00003942 08C0                    	or	al,al
 28580 00003944 74C9                    	jz	short answ_no
 28581                                  	;cmp	al,1	 ;YES character
 28582 00003946 FEC8                    	dec	al ; 1 -> 0 --> zf = 1
 28583 00003948 9C                      	pushf
 28584 00003949 E82DF0                  	call	CRLF2
 28585 0000394C 9D                      	popf
 28586 0000394D 75D2                    	jnz	short askagn
 28587                                  noprmpt:
 28588 0000394F B413                    	mov	ah,FCB_Delete ; 13h
 28589 00003951 BA5C00                  	mov	dx,FCB ; 5Ch
 28590 00003954 CD21                    	int	21h	; DOS -	DELETE FILE via	FCB
 28591                                  			; DS:DX	-> FCB with filename field filled with
 28592                                  			; template for deletion ('?' wildcard allowed,but not '*')
 28593                                  			; Return: AL = 00h file	found,FFh file	not found
 28594 00003956 FEC0                    	inc	al
 28595 00003958 7403                    	jz	short eraerr
 28596                                  	; 26/04/2023
 28597                                  	;call	RestUDir
 28598                                  ;answ_no:
 28599                                  	;retn
 28600 0000395A E9D3EE                  	jmp	RestUDir ; 26/04/2023
 28601                                  
 28602                                  	; 19/03/2023
 28603                                  	; MSDOS 6.0
 28604                                  eraerr:
 28605                                  	;invoke	set_ext_error_msg
 28606                                  				;AN022; set up the extended error
 28607 0000395D E8DBE6                  	call	Set_Ext_Error_Msg
 28608 00003960 52                      	push	dx		;AN022; save message
 28609                                  	;invoke	RESTUDIR
 28610 00003961 E8CCEE                  	call	RestUDir
 28611 00003964 5A                      	pop	dx		;AN022; restore message
 28612                                  	
 28613 00003965 833E[D78F]12            	cmp	word [extend_buf_ptr],ERROR_NO_MORE_FILES ; 18
 28614                                  				;AN022; convert no more files to
 28615 0000396A 7506                    	jne	short cerrorj2	;AN022;  file not found
 28616 0000396C C706[D78F]0200          	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND ; 2  
 28617                                  				;AN000; get message number in control block
 28618                                  cerrorj2:
 28619 00003972 E9B1F3                  	jmp	cerror
 28620                                  	
 28621                                  	; 19/03/2023
 28622                                  	; MSDOS 3.3
 28623                                  ;ERAERR:	
 28624                                  	;mov	ah,Set_DMA ; 1Ah
 28625                                  	;mov	dx,FCB ; 5Ch
 28626                                  	;int	21h		; DOS -	SET DISK TRANSFER AREA ADDRESS
 28627                                  	;			; DS:DX	-> disk	transfer buffer
 28628                                  	;mov	ah,Dir_Search_First ; 11h
 28629                                  	;int	21h		; DOS -	SEARCH FIRST USING FCB
 28630                                  	;			; DS:DX	-> FCB
 28631                                  	;push	ax
 28632                                  	;call	RESTUDIR
 28633                                  	;pop	ax
 28634                                  	;mov	dx,FNOTFOUNDPTR
 28635                                  	;inc	al
 28636                                  	;jz	short CERRORJ
 28637                                  	;mov	dx,ACCDENPTR
 28638                                  	;jmp	CERROR
 28639                                  
 28640                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28641                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:36D4h
 28642                                  
 28643                                  ; ****************************************************************
 28644                                  ; *
 28645                                  ; * ROUTINE:	 SLASHP_ERASE - execution of DEL/ERASE /P
 28646                                  ; *
 28647                                  ; * FUNCTION:	 Delete files based on user parsed input. Prompt
 28648                                  ; *		 user for Y/N where necessary. If an error occurs
 28649                                  ; *		 set up and error message and transfer control
 28650                                  ; *		 to CERROR.
 28651                                  ; *
 28652                                  ; * INPUT:	 FCB at 5Ch set up with filename(s) entered
 28653                                  ; *		 Current directory set to entered directory
 28654                                  ; *
 28655                                  ; * OUTPUT:	 none
 28656                                  ; *
 28657                                  ; ****************************************************************
 28658                                  
 28659                                  	; 19/03/2023
 28660                                  slashp_erase:				;AN000; entry point
 28661                                  	;invoke	build_dir_string	;AN000; set up current directory string for output
 28662 00003975 E885E8                  	call	build_dir_string
 28663                                  
 28664 00003978 B41A                    	mov	ah,Set_DMA ; 1Ah	;AN000; issue set dta int 21h
 28665                                  	;mov	dx,offset trangroup:destdir
 28666 0000397A BA[F69C]                	mov	dx,DESTDIR		;AN000; use Destdir for target
 28667 0000397D CD21                    	int	21h			;AN000;
 28668                                  
 28669                                  	;mov	ah,11h
 28670 0000397F B411                    	mov	ah,Dir_Search_First	;AN000; do dir search first int 21h
 28671 00003981 BA5C00                  	mov	dx,FCB	; 5Ch		;AN000; use FCB at 5Ch for target
 28672 00003984 CD21                    	int	21h			;AN000;
 28673 00003986 FEC0                    	inc	al			;AN000; did an error occur
 28674                                  	;jz	short eraerr		;AN022; go to error exit
 28675                                  	; 26/04/2023
 28676 00003988 7502                    	jnz	short delete_prompt_loop
 28677                                  
 28678                                  	; 26/04/2023
 28679                                  stop_del:
 28680 0000398A EBD1                    	jmp	short eraerr		;AN022; go to error exit - need long jmp
 28681                                  
 28682                                  delete_prompt_loop:			;AN000;
 28683                                  	;mov	si,offset trangroup:destdir+1
 28684 0000398C BE[F79C]                	mov	si,DESTDIR+1		;AN000; set up FCB as source
 28685                                  	;mov	di,offset trangroup:dest
 28686 0000398F BF[C69C]                	mov	di,DEST			;AN000; set up dest as target
 28687 00003992 A0[FA9B]                	mov	al,[DIRCHAR]		;AN000; store a "\" in the first char
 28688 00003995 AA                      	stosb				;AN000;   of DEST
 28689                                  	;invoke	FCB_TO_ASCZ		;AN000; convert filename from FCB to ASCIIZ string
 28690 00003996 E80CF0                  	call	FCB_TO_ASCZ
 28691                                  
 28692                                  slashp_askagn:				;AN000;
 28693 00003999 E8DDEF                  	call	CRLF2			;AN000; print out carriage return, line feed
 28694                                  	;mov	dx,offset trangroup:bwdbuf
 28695 0000399C BA[399D]                	mov	dx,BWDBUF		;AN000; print out current directory string
 28696 0000399F 89D3                    	mov	bx,dx			;AN000; get string pointer in bx
 28697 000039A1 807F0300                	cmp	byte [bx+3],END_OF_LINE_OUT ; 0
 28698                                  					;AN000; see if only D:\,0
 28699 000039A5 7504                    	jnz	short not_del_root	;AN000; no continue
 28700 000039A7 C6470200                	mov	byte [bx+2],END_OF_LINE_OUT ; 0
 28701                                  					;AN000; yes, get rid of \ ;
 28702                                  not_del_root:				;AN000;
 28703 000039AB 8916[A09D]              	mov	[string_ptr_2],dx 	;AN000;
 28704                                  	;mov	dx,offset trangroup:string_buf_ptr
 28705 000039AF BA[DF91]                	mov	dx,string_buf_ptr	;AN000;
 28706                                  	;invoke	std_printf		;AN000;
 28707 000039B2 E8731A                  	call	std_printf
 28708                                  	;mov	dx,offset trangroup:dest
 28709 000039B5 BA[C69C]                	mov	dx,DEST			;AN000; print out file name string
 28710 000039B8 8916[A09D]              	mov	[string_ptr_2],dx 	;AN000;
 28711                                  	;mov	dx,offset trangroup:string_buf_ptr
 28712 000039BC BA[DF91]                	mov	dx,string_buf_ptr	;AN000;
 28713                                  	;invoke	std_printf		;AN000;
 28714 000039BF E8661A                  	call	std_printf
 28715                                  	;mov	dx,offset trangroup:Del_Y_N_Ptr
 28716 000039C2 BA[EE90]                	mov	dx,Del_Y_N_Ptr		;AN000; issue ", Delete (Y/N)?" message
 28717                                  	;invoke	std_printf		;AN000;
 28718 000039C5 E8601A                  	call	std_printf
 28719                                  
 28720                                  ;;M029	mov	si,80H			;AN000; set up buffer for input
 28721                                  ;;M029	mov	dx,si			;AN000;
 28722                                  ;;M029	mov	word ptr [si],combuflen ;AN000;
 28723                                  ;;M029	mov	ax,(std_con_input_flush shl 8) or std_con_string_input	;AN000;
 28724                                  ;;M029	int	21h			;AN000; get input from the user
 28725                                  ;;M029	lodsw				;AN000;
 28726                                  ;;M029	or	ah,ah			;AN000; was a character entered?
 28727                                  ;;M029	jz	short slashp_askagn	;AN000; no - ask again
 28728                                  ;;M029	invoke	scanoff 		;AN000; scan off leading delimiters
 28729                                  
 28730                                  ;	Get a single character input.
 28731                                  
 28732                                  	;;mov	ax,(STD_CON_INPUT_FLUSH shl 8) or STD_CON_INPUT	;M029
 28733                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8)|STD_CON_INPUT
 28734 000039C8 B8010C                  	mov	ax,0C01h
 28735 000039CB CD21                    	int	21h			;M029
 28736                                  
 28737 000039CD E87C01                  	call	char_in_xlat		;AN000; yes - upper case it
 28738                                  	;retc				;AN000; return if function not supported
 28739                                  	; 19/03/2023
 28740 000039D0 7301                    	jnc	short slashp_check_yn
 28741                                  slashp_ans_no:
 28742 000039D2 C3                      	retn
 28743                                  
 28744                                  slashp_check_yn:
 28745                                  	; 19/03/2023
 28746                                  	; AL = 0 if it was (country depended) NO character
 28747                                  	; AL = 1 if it was (country depenced) YES character
 28748                                  
 28749                                  	;cmp	al,capital_n		;AN000; was it no?
 28750                                  	;cmp	al,0
 28751 000039D3 20C0                    	and	al,al ; 0
 28752 000039D5 7420                    	jz	short next_del_file	;AN000; yes - don't delete file
 28753                                  	;cmp	al,capital_y		;AN000; was it yes?
 28754                                  	;cmp	al,1
 28755 000039D7 FEC8                    	dec	al  ; 1-> 0 --> zf = 1
 28756                                  	;jz	short delete_this_file	;AN000; yes - delete the file
 28757                                  	;jmp	short slashp_askagn	;AN000; it was neither - ask again
 28758                                  	; 19/03/2023
 28759 000039D9 75BE                    	jnz	short slashp_askagn
 28760                                  
 28761                                  delete_this_file:			;AN000;
 28762 000039DB B413                    	mov	ah,FCB_Delete ; 13h	;AN000; delete the file
 28763                                  	;mov	dx,offset trangroup:destdir
 28764 000039DD BA[F69C]                	mov	dx,DESTDIR		;AN000; use Destdir for target
 28765 000039E0 CD21                    	int	21h			;AN000;
 28766 000039E2 FEC0                    	inc	al			;AN000; did an error occur?
 28767 000039E4 7511                    	jnz	short next_del_file	;AN000; no - get next file
 28768                                  ;
 28769                                  ;M041; Begin changes
 28770                                  ; We got an error deleting the file. If this is access denied, we can go on
 28771                                  ;to the next file after printing an error message.
 28772                                  ;
 28773                                  	;invoke	Get_ext_error_number	;see what error we got
 28774 000039E6 E862E6                  	call	get_ext_error_number
 28775 000039E9 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 28776                                  					;is it access denied?
 28777 000039EC 759C                    	jne	short stop_del		;no, some other error
 28778                                  	;invoke	CrLf2			;print a CR-LF
 28779 000039EE E888EF                  	call	CRLF2
 28780                                  	;invoke set_ext_error_msg	;error message
 28781 000039F1 E847E6                  	call	Set_Ext_Error_Msg
 28782                                  	;invoke	std_eprintf		;"Access denied"
 28783 000039F4 E8291A                  	call	std_eprintf
 28784                                  	; 26/04/2023
 28785                                  	;jmp	short next_del_file	;try next file
 28786                                  	; 26/04/2023
 28787                                  ;stop_del:
 28788                                  ;;
 28789                                  ;;M041; End changes
 28790                                  ;;
 28791                                  ;	jmp	eraerr			;AN022; go to error exit - need long jmp
 28792                                  
 28793                                  next_del_file:				;AN000;
 28794                                  ;
 28795                                  ; M050 - begin
 28796                                  ; 	Norton Utilities 5.0 has a bug. DiskMon when invoked
 28797                                  ;       with /protect+ and /light+ makes it intercept all
 28798                                  ;       deletes. This hook does not save and restore the DTA correctly.
 28799                                  ;       They save the DWORD in a WORD by mistake! They save both the
 28800                                  ;       segment and the offset in the SAME variable (WORD)!!!
 28801                                  ;
 28802 000039F7 B41A                    	mov	ah,Set_DMA ; 1Ah
 28803                                  	;mov	dx,offset trangroup:destdir
 28804 000039F9 BA[F69C]                	mov	dx,DESTDIR
 28805 000039FC CD21                    	int	21h
 28806                                  ;
 28807                                  ; M050 - end
 28808                                  
 28809 000039FE B412                    	mov	ah,Dir_Search_Next ; 12h
 28810                                  					;AN000; search for another file
 28811 00003A00 BA5C00                  	mov	dx,FCB	; 5Ch		;AN000;
 28812 00003A03 CD21                    	int	21h			;AN000;
 28813 00003A05 FEC0                    	inc	al			;AN000; was a file found?
 28814                                  	;jz	short slash_p_exit	;AN000; no - exit
 28815                                  	;jmp	delete_prompt_loop	;AN000; yes - continue (need long jump)
 28816                                  	; 26/04/2023
 28817 00003A07 7583                    	jnz	short delete_prompt_loop
 28818                                  
 28819                                  slash_p_exit:
 28820                                  	;invoke	get_ext_error_number	;AN022; get the extended error number
 28821 00003A09 E83FE6                  	call	get_ext_error_number
 28822 00003A0C 83F812                  	cmp	ax,ERROR_NO_MORE_FILES	;AN022; was error file not found?
 28823 00003A0F 7403                    	jz	short good_erase_exit 	;AN022; yes - clean exit
 28824 00003A11 E96CE3                  	jmp	extend_setup		;AN022; go issue error message
 28825                                  
 28826                                  good_erase_exit:
 28827                                  	;invoke	restudir		;AN000; we're finished - restore user's dir
 28828 00003A14 E819EE                  	call	RestUDir
 28829                                  	;call	CRLF2			;AN000; print out carriage return, line feed
 28830                                  	;retn				;AN000; exit
 28831                                  	; 19/03/2023
 28832 00003A17 E95FEF                  	jmp	CRLF2
 28833                                  
 28834                                  ; =============== S U B	R O U T	I N E =======================================
 28835                                  
 28836                                  ; ECHO, BREAK, and VERIFY commands. Check for "ON" and "OFF"
 28837                                  
 28838                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28839                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28840                                  	; 10/08/2024 - Retro DOS v5.0 COMMAND.COM
 28841                                  _ECHO:
 28842 00003A1A E89900                  	call	ON_OFF
 28843 00003A1D 7212                    	jb	short DOEMES
 28844 00003A1F 8E1E[F59B]              	mov	ds,[RESSEG]
 28845 00003A23 7506                    	jnz	short ECH_OFF
 28846 00003A25 800E[9D02]01            	or	byte [EchoFlag],1
 28847 00003A2A C3                      	retn
 28848                                  
 28849                                  ECH_OFF:
 28850 00003A2B 8026[9D02]FE            	and	byte [EchoFlag],0FEh
 28851 00003A30 C3                      	retn
 28852                                  
 28853                                  	; 19/03/2023
 28854                                  	; MSDOS 6.0 (& MSDOS 5.0)
 28855                                  ;CERRORJ:
 28856                                  	;jmp	cerror
 28857                                  
 28858                                  ; There was no discrenable ON or OFF after the ECHO. If there is nothing but
 28859                                  ; delimiters on the command line, we issue the ECHO is ON/OFF message.
 28860                                  
 28861                                  DOEMES:
 28862                                  	; 19/03/2023
 28863                                  	; MSDOS 6.0
 28864                                  	;cmp	cl,0		;AC000; was anything on the line?
 28865 00003A31 20C9                    	and	cl,cl
 28866 00003A33 7409                    	jz	short PECHO	; just display current state.
 28867 00003A35 BA8200                  	mov	dx,82h		; Skip one char after "ECHO"
 28868 00003A38 E897EF                  	call	CRPRINT
 28869 00003A3B E93BEF                  	jmp	CRLF2
 28870                                  
 28871                                  	; 19/03/2023
 28872                                  	; MSDOS 3.3
 28873                                  	;call	MOVE_TO_FIRST_ARG
 28874                                  	;jz	short PECHO
 28875                                  	;mov	dx,82h
 28876                                  	;call	CRPRINT
 28877                                  	;jmp	CRLF2
 28878                                  
 28879                                  PECHO:
 28880                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28881 00003A3E 8E1E[F59B]              	mov	ds,[RESSEG]
 28882 00003A42 8A1E[9D02]              	mov	bl,[EchoFlag]
 28883 00003A46 0E                      	push	cs
 28884 00003A47 1F                      	pop	ds
 28885 00003A48 80E301                  	and	bl,1
 28886 00003A4B BA[7F91]                	mov	dx,EchoMes_Ptr
 28887 00003A4E EB24                    	jmp	short PYN
 28888                                  
 28889                                  ; ---------------------------------------------------------------------------
 28890                                  
 28891                                  	; 19/03/2023
 28892                                  	; MSDOS 3.3
 28893                                  CERRORJ:
 28894 00003A50 E9D3F2                  	jmp	cerror
 28895                                  
 28896                                  ; =============== S U B	R O U T	I N E =======================================
 28897                                  
 28898                                  	; 19/03/2023
 28899                                  	; MSDOS 3.3
 28900                                  ;MOVE_TO_FIRST_ARG:
 28901                                  	;mov	si,81h
 28902                                  	;call	SCANOFF
 28903                                  	;cmp	al,0Dh
 28904                                  	;retn
 28905                                  
 28906                                  ; =============== S U B	R O U T	I N E =======================================
 28907                                  
 28908                                  CNTRLC:
 28909 00003A53 E86000                  	call	ON_OFF
 28910 00003A56 B80133                  	mov	ax,(Set_CTRL_C_Trapping<<8)|1 ; 3301h
 28911 00003A59 720C                    	jc	short PCNTRLC
 28912 00003A5B 7505                    	jnz	short CNTRLC_OFF
 28913 00003A5D B201                    	mov	dl,1
 28914 00003A5F CD21                    	int	21h	; DOS -	EXTENDED CONTROL-BREAK CHECKING
 28915                                  			; AL = 00h get state / 01h set state / 02h set AND get
 28916                                  			; DL = 00h for OFF or 01h for ON
 28917 00003A61 C3                      	retn
 28918                                  
 28919                                  ; ---------------------------------------------------------------------------
 28920                                  
 28921                                  CNTRLC_OFF:
 28922 00003A62 30D2                    	xor	dl,dl
 28923 00003A64 CD21                    	int	21h		; Turn off ^C check
 28924 00003A66 C3                      	retn
 28925                                  
 28926                                  ; ---------------------------------------------------------------------------
 28927                                  
 28928                                  PCNTRLC:
 28929                                  	; 19/03/2023
 28930                                  	; MSDOS 6.0
 28931                                  	;cmp	cl,0		;AC000; rest of line blank?
 28932 00003A67 08C9                    	or	cl,cl
 28933 00003A69 75E5                    	jnz	short CERRORJ 	; no, oops!
 28934                                  
 28935                                  	; 19/03/2023
 28936                                  	; MSDOS 3.3
 28937                                  	;call	MOVE_TO_FIRST_ARG
 28938                                  	;jnz	short CERRORJ
 28939                                  ;pccont:
 28940                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28941 00003A6B 30C0                    	xor	al,al
 28942 00003A6D CD21                    	int	21h		; get Ctrl-Break state (ah=33h)
 28943 00003A6F 88D3                    	mov	bl,dl
 28944 00003A71 BA[6391]                	mov	dx,CtrlcMes_Ptr
 28945                                  
 28946                                  ; ---------------------------------------------------------------------------
 28947                                  
 28948                                  PYN:	; write "ON" or "OFF" state 
 28949                                  
 28950                                  	; 26/04/2023
 28951                                  	; 19/03/2023
 28952                                  	; MSDOS 3.3
 28953                                  	;call	STD_PRINTF
 28954                                  	;mov	dx,ONMES_PTR	;AC000; get ON pointer
 28955                                  	;or	bl,bl
 28956                                  	;jnz	short PRINTVAL
 28957                                  	;mov	dx,OFFMES_PTR	;AC000; get OFF pointer
 28958                                  	
 28959                                  	; 26/04/2023
 28960                                  	; 19/03/2023
 28961                                  	; MSDOS 6.0
 28962 00003A74 BE[9091]                	mov	si,ONMES_PTR
 28963 00003A77 08DB                    	or	bl,bl
 28964 00003A79 7503                    	jnz	short PRINTVAL
 28965 00003A7B BE[8D91]                	mov	si,OFFMES_PTR
 28966                                  PRINTVAL:
 28967                                  	; 19/03/2023
 28968                                  	; MSDOS 3.3
 28969                                  	;jmp	STD_PRINTF
 28970                                  
 28971                                  	; 19/03/2023
 28972                                  	; MSDOS 6.0
 28973 00003A7E 52                      	push	dx		;AN000; save offset of message block
 28974 00003A7F 89D3                    	mov	bx,dx		;AN000; save offset value
 28975 00003A81 AD                      	lodsw			;AN000; get message number of on or off
 28976 00003A82 B6FF                    	mov	dh,util_msg_class ; -1 ; 0FFh
 28977                                  				;AN000; this is a utility message
 28978 00003A84 E8841A                  	call	TSYSGETMSG	;AN000; get the address of the message
 28979                                  	;add	bx,5
 28980 00003A87 83C305                  	add	bx,Ptr_off_pos	;AN000; point to offset of ON/OFF
 28981                                  	
 28982 00003A8A 8937                    	mov	[bx],si		;AN000; put the offset in the message block
 28983 00003A8C 5A                      	pop	dx		;AN000; get message back
 28984 00003A8D E89819                  	call	std_printf	;AC000; go print message
 28985 00003A90 C7070000                	mov	word [bx],0	;AN000; zero out message pointer
 28986 00003A94 C3                      	retn			;AN000; exit
 28987                                  
 28988                                  ; =============== S U B	R O U T	I N E =======================================
 28989                                  
 28990                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.CO
 28991                                  VERIFY:
 28992 00003A95 E81E00                  	call	ON_OFF
 28993 00003A98 B8012E                  	mov	ax,(SET_VERIFY_ON_WRITE<<8)|1 ; 2E01h
 28994 00003A9B 720A                    	jc	short PVERIFY
 28995 00003A9D 7503                    	jnz	short VER_OFF
 28996 00003A9F CD21                    	int	21h	; DOS -	SET VERIFY FLAG
 28997                                  			; DL = 00h,AL = 01h VERIFY on / 00h VERIFY off
 28998 00003AA1 C3                      	retn
 28999                                  
 29000                                  ; ---------------------------------------------------------------------------
 29001                                  
 29002                                  VER_OFF:
 29003 00003AA2 FEC8                    	dec	al
 29004 00003AA4 CD21                    	int	21h		; Turn off verify after write
 29005 00003AA6 C3                      	retn
 29006                                  
 29007                                  ; ---------------------------------------------------------------------------
 29008                                  
 29009                                  PVERIFY:
 29010                                  	; 19/03/2023
 29011                                  	; MSDOS 6.0
 29012                                  	;cmp	cl,0		;AC000; is rest of line blank?
 29013 00003AA7 20C9                    	and	cl,cl
 29014 00003AA9 75A5                    	jnz	short CERRORJ 	; nope...
 29015                                  
 29016                                  	 ;19/03/2023
 29017                                  	; MSDOS 3.3
 29018                                  	;call	MOVE_TO_FIRST_ARG
 29019                                  	;jnz	short CERRORJ
 29020                                  
 29021 00003AAB B454                    	mov	ah,Get_Verify_On_Write ; 54h
 29022 00003AAD CD21                    	int	21h		; DOS -	2+ - GET VERIFY	FLAG
 29023                                  				; Return: AL = 00h if flag OFF
 29024                                  				; AL = 01h if flag ON
 29025 00003AAF 88C3                    	mov	bl,al
 29026 00003AB1 BA[7191]                	mov	dx,VeriMes_Ptr
 29027 00003AB4 EBBE                    	jmp	short PYN
 29028                                  
 29029                                  ; =============== S U B	R O U T	I N E =======================================
 29030                                  
 29031                                  ; ****************************************************************
 29032                                  ; *
 29033                                  ; * ROUTINE:	 ON_OFF
 29034                                  ; *
 29035                                  ; * FUNCTION:	 Parse the command line for an optional ON or
 29036                                  ; *		 OFF string for the BREAK, VERIFY, and ECHO
 29037                                  ; *		 routines.
 29038                                  ; *
 29039                                  ; * INPUT:	 command line at offset 81H
 29040                                  ; *		 PARSE_BREAK control block
 29041                                  ; *
 29042                                  ; * OUTPUT:	 If carry is clear
 29043                                  ; *		    If ON is found
 29044                                  ; *		       Zero flag set
 29045                                  ; *		    If OFF is found
 29046                                  ; *		       Zero flag clear
 29047                                  ; *		 If carry set
 29048                                  ; *		    If nothing on command line
 29049                                  ; *		       CL set to zero
 29050                                  ; *		    If error
 29051                                  ; *		       CL contains error value from parse
 29052                                  ; *
 29053                                  ; ****************************************************************
 29054                                  
 29055                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29056                                  ON_OFF:
 29057 00003AB6 BE8100                  	mov	si,81h
 29058                                  
 29059                                  	; 19/03/2023
 29060                                  	; MSDOS 3.3
 29061                                  	;call	SCANOFF		; scan off leading blanks & equal
 29062                                  	;cmp	al,0Dh		; are we at end of line?
 29063                                  	;je	short BAD_ONF	; yes, return error
 29064                                  	;lodsw
 29065                                  	;or	ax,2020h	; convert to lowercase
 29066                                  	;cmp	ax,6E6Fh ;'on'
 29067                                  	;je	short ON_CHECK
 29068                                  	;cmp	ax,666Fh ;'of'
 29069                                  	;jne	short BAD_ONF
 29070                                  	;lodsb
 29071                                  	;or	al,20h		; convert to lowercase		
 29072                                  	;cmp	al,66h	 ; 'f'
 29073                                  	;jne	short BAD_ONF	
 29074                                  	;or	al,66h ; or al,'f'
 29075                                  	;jmp	short OFF_CHECK
 29076                                  ;ON_CHECK:
 29077                                  	;xor	al,al
 29078                                  ;OFF_CHECK:
 29079                                  	;lahf
 29080                                  	;mov	bx,ax
 29081                                  	;call	SCANOFF		; scan off leading blanks & equal
 29082                                  	;cmp	al,0Dh		; are we at end of line?	
 29083                                  	;jne	short BAD_ONF	; no, return error
 29084                                  	;mov	ax,bx
 29085                                  	;sahf
 29086                                  	;clc
 29087                                  	;retn
 29088                                  
 29089                                  	; 19/03/2023
 29090                                  	; MSDOS 6.0
 29091                                  scan_on_off:			;AN032; scan off leading blanks & equal
 29092 00003AB9 AC                      	lodsb			;AN032; get a char
 29093                                  	;cmp	al,blank	;AN032; if whitespace
 29094 00003ABA 3C20                    	cmp	al,20h
 29095 00003ABC 74FB                    	je	short scan_on_off
 29096                                  				;AN032;    keep scanning
 29097 00003ABE 3C09                    	cmp	al,tab_chr	;AN032; if tab
 29098                                  	;cmp	al,09h
 29099 00003AC0 74F7                    	je	short scan_on_off
 29100                                  				;AN032;    keep scanning
 29101                                  	;cmp	al,equal_chr	;AN032; if equal char
 29102 00003AC2 3C3D                    	cmp	al,'=' ; 3Dh
 29103 00003AC4 7401                    	je	short parse_on_off
 29104                                  				;AN032;    start parsing
 29105 00003AC6 4E                      	dec	si		;AN032; if none of above - back up
 29106                                  
 29107                                  parse_on_off:			;AN032;    and start parsing
 29108 00003AC7 BF[1096]                	mov	di,PARSE_BREAK	;AN000; Get address of PARSE_BREAK
 29109 00003ACA 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 29110 00003ACC 31D2                    	xor	dx,dx		;AN000;
 29111 00003ACE E89B0E                  	call	cmd_parse	;AC000; call parser
 29112                                  	;cmp	ax,-1 ; 0FFFFh
 29113 00003AD1 83F8FF                  	cmp	ax,END_OF_LINE	;AC000; are we at end of line?
 29114 00003AD4 742E                    	je	short BADONF	;AC000; yes, return error
 29115                                  	;cmp	ax,RESULT_NO_ERROR ;AN000; did an error occur
 29116                                  	;cmp	ax,0
 29117 00003AD6 21C0                    	and	ax,ax ; ax = 0 ?
 29118 00003AD8 7404                    	jz	short on_off_there
 29119                                  				;AN000; no - continue
 29120 00003ADA 89C1                    	mov	cx,ax		;AN000; yes - set cl to error code
 29121 00003ADC EB26                    	jmp	short BADONF	;AN000; return error
 29122                                  
 29123                                  on_off_there:
 29124 00003ADE 803E[ECA5]FF            	cmp	byte [PARSE1_CODE],-1 ; 0FFh
 29125                                  				;AN014; was a valid positional present?
 29126 00003AE3 7505                    	jnz	short good_on_off
 29127                                  				;AN014; yes - continue
 29128 00003AE5 B90A00                  	mov	cx,BadParm_Ptr	;AN014; something other than ON/OFF
 29129                                  	;mov	cx,10 ; 0Ah
 29130 00003AE8 EB1A                    	jmp	short BADONF	;AN014; return error
 29131                                  
 29132                                  good_on_off:			;AN014;
 29133 00003AEA 31C0                    	xor	ax,ax		;AC000; set up return code for
 29134 00003AEC 0A06[ECA5]              	or	al,[PARSE1_CODE]
 29135                                  				;AC000;    ON or OFF in AX
 29136 00003AF0 9C                      	pushf			;AN000; save flags
 29137 00003AF1 BF[1096]                	mov	di,PARSE_BREAK	;AN000; Get address of PARSE_BREAK
 29138 00003AF4 31D2                    	xor	dx,dx		;AN000;
 29139 00003AF6 E8730E                  	call	cmd_parse	;AN000; call parser
 29140 00003AF9 83F8FF                  	cmp	ax,END_OF_LINE	;AN000; are we at end of line?
 29141                                  	;cmp	ax,-1 ; 0FFFFh
 29142 00003AFC 7503                    	jne	short BADONF_flags
 29143                                  				;AN000; NO, return error
 29144 00003AFE 9D                      	popf			;AN000; restore flags
 29145 00003AFF F8                      	clc			;AC000; no error
 29146                                  	;jmp	short on_off_end
 29147                                  				;AN000; return to caller
 29148                                  	; 26/04/2023
 29149 00003B00 C3                      	retn
 29150                                  
 29151                                  BADONF_flags:
 29152 00003B01 89C1                    	mov	cx,ax
 29153 00003B03 9D                      	popf
 29154                                  
 29155                                  ; ---------------------------------------------------------------------------
 29156                                  
 29157                                  ; No discernable ON or OFF has been found. Put an error message pointer in DX
 29158                                  ; and return the error
 29159                                  
 29160                                  BADONF:
 29161 00003B04 BA[4091]                	mov	dx,bad_on_off_ptr
 29162 00003B07 F9                      	stc
 29163                                  on_off_end:
 29164 00003B08 C3                      	retn
 29165                                  
 29166                                  ;============================================================================
 29167                                  ; TUCODE.ASM, MSDOS 6.0, 1991 (2)
 29168                                  ;============================================================================
 29169                                  ; 02/10/2018 - Retro DOS v3.0
 29170                                  
 29171                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 29BFh
 29172                                  
 29173                                  ; =============== S U B	R O U T	I N E =======================================
 29174                                  
 29175                                  	; 20/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29176                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3876h
 29177                                  	
 29178                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29179                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3E20h
 29180                                  
 29181                                  	; 10/08/2024 - Retro DOS v5.0 COMMAND.COM
 29182                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3CD4h
 29183                                  PRINT_DATE:
 29184                                  	; 20/03/2023
 29185                                  	; MSDOS 3.3
 29186                                  	;push	es
 29187                                  	;push	di
 29188                                  	;push	cs
 29189                                  	;pop	es
 29190                                  	;mov	di,ARG_BUF
 29191                                  	;mov	ah,Get_Date ; 2Ah
 29192                                  	;int	21h	; DOS -	GET CURRENT DATE
 29193                                  	;		; Return: DL = day,DH = month,	CX = year
 29194                                  	;		; AL = day of the week (0=Sunday,1=Monday,etc.)
 29195                                  	;cbw
 29196                                  	;call	GETDATE
 29197                                  	;call	P_DATE
 29198                                  	;xor	al,al
 29199                                  	;stosb
 29200                                  	;mov	dx,ARG_BUF_PTR
 29201                                  	;call	STD_PRINTF
 29202                                  		; 20/03/2023 (MSDOS 3.3 COMMAND.COM - TRANGROUP:29DAh)
 29203                                  	;pop	es ; !!??!! 
 29204                                  	;pop	di
 29205                                  	;retn
 29206                                  
 29207                                  	; 20/03/2023
 29208                                  	; MSDOS 6.0
 29209 00003B09 06                      	push	es
 29210 00003B0A 57                      	push	di
 29211 00003B0B 0E                      	push	cs
 29212 00003B0C 07                      	pop	es
 29213 00003B0D E81300                  	call	GetDate 		; get date
 29214 00003B10 86D6                    	xchg	dh,dl			;AN000; switch month & day
 29215 00003B12 890E[1692]              	mov	[promptDat_yr],cx 	;AC000; put year into message control block
 29216 00003B16 8916[1892]              	mov	[promptDat_moday],dx	;AC000; put month and day into message control block
 29217 00003B1A BA[0692]                	mov	dx,promptdat_ptr	;AC000; set up message for output
 29218 00003B1D E80819                  	call	std_printf
 29219                                  	;AD061; mov word [promptDat_yr],0 ;AC000; reset year, month and day
 29220                                  	;AD061; mov word [promptDat_moday],0 ;AC000; pointers in control block
 29221 00003B20 5F                      	pop	di			;AC000; restore di,es
 29222 00003B21 07                      	pop	es			;AC000;
 29223 00003B22 C3                      	retn
 29224                                  
 29225                                  ; ---------------------------------------------------------------------------
 29226                                  
 29227                                  	; 21/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29228                                  
 29229                                  ;GETDATE:
 29230                                  	; 21/03/2023
 29231                                  	; MSDOS 3.3
 29232                                  	;mov	si,ax
 29233                                  	;shl	si,1
 29234                                  	;add	si,ax
 29235                                  	;add	si,WEEKTAB ; "SunMonTueWedThuFriSat"
 29236                                  	;mov	bx,cx
 29237                                  	;mov	cx,3
 29238                                  	;rep	movsb
 29239                                  	;mov	al,' '
 29240                                  	;stosb
 29241                                  	;retn
 29242                                  
 29243                                  	; 21/03/2023
 29244                                  	; MSDOS 6.0
 29245                                  
 29246                                  ; Do GET DATE system call and set up 3 character day of week in ARG_BUF
 29247                                  ; for output. Date will be returned in CX,DX.
 29248                                  
 29249                                  GetDate:
 29250 00003B23 BF[96A3]                	mov	di,Arg_Buf		;AC000; target for day of week
 29251 00003B26 B42A                    	mov	ah,Get_Date ;2Ah	;AC000; get current date
 29252 00003B28 CD21                    	int	21h			;AC000; Get date in CX:DX
 29253 00003B2A 98                      	cbw				;AC000;
 29254 00003B2B 51                      	push	cx			;AN000; save date returned in
 29255 00003B2C 52                      	push	dx			;AN000;  CX:DX
 29256 00003B2D 89C6                    	mov	si,ax
 29257 00003B2F D1E6                    	shl	si,1
 29258 00003B31 01C6                    	add	si,ax			; SI=AX*3
 29259 00003B33 89F1                    	mov	cx,si			;AN000; save si
 29260 00003B35 A1[C990]                	mov	ax,[WeekTab]		;AN000; get message number of weektab
 29261 00003B38 B6FF                    	mov	dh,util_msg_class ;0FFh	;AN000; this is a utility message
 29262 00003B3A 57                      	push	di			;AN000; save argument buffer
 29263 00003B3B E8CD19                  	call	TSYSGETMSG		;AN000; get the address of the message
 29264 00003B3E 5F                      	pop	di			;AN000; retrieve argument buffer
 29265 00003B3F 01CE                    	add	si,cx			;AC000; get day of week
 29266 00003B41 B90300                  	mov	cx,3
 29267 00003B44 F3A4                      	rep	movsb
 29268 00003B46 B000                    	mov	al,END_OF_LINE_OUT ; 0	;AC000; terminate the string
 29269 00003B48 AA                      	stosb
 29270 00003B49 5A                      	pop	dx			;AN000; get back date
 29271 00003B4A 59                      	pop	cx			;AN000;
 29272 00003B4B C3                      	retn
 29273                                  
 29274                                  ; =============== S U B	R O U T	I N E =======================================
 29275                                  
 29276                                  	; 21/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29277                                  
 29278                                  	; MSDOS 6.0
 29279                                  
 29280                                  ; This routine determines whether the character in AL is a
 29281                                  ; Yes or No character. On return, if AL=0, the character is
 29282                                  ; No, if AL=1, the character is Yes.
 29283                                  
 29284                                  ;	assume	ds:trangroup
 29285                                  
 29286                                  char_in_xlat:	; proc	near
 29287                                  	; 21/03/2023
 29288 00003B4C 88C2                    	mov	dl,al			;AC000; get character into DX
 29289 00003B4E 30F6                    	xor	dh,dh			;AC000;
 29290                                  	;mov	ax,(GetExtCntry<<8)+35	;AC000; Yes/No char call
 29291 00003B50 B82365                  	mov	ax,6523h
 29292 00003B53 CD21                    	int	21h			;AC000;
 29293 00003B55 C3                      	retn
 29294                                  
 29295                                  ;char_in_xlat	endp
 29296                                  
 29297                                  ;============================================================================
 29298                                  ; TENV.ASM, MSDOS 6.0, 1991
 29299                                  ;============================================================================
 29300                                  ; 02/10/2018 - Retro DOS v3.0
 29301                                  
 29302                                  ;	Environment utilities and misc. routines
 29303                                  
 29304                                  ; MSDOS 6.0
 29305                                  ; ****************************************************************
 29306                                  ; *
 29307                                  ; * ROUTINE:	 UPCONV     (ADDED BY EMG 4.00)
 29308                                  ; *
 29309                                  ; * FUNCTION:	 This routine returns the upper case equivalent of
 29310                                  ; *		 the character in AL from the file upper case table
 29311                                  ; *		 in DOS if character if above  ascii 128, else
 29312                                  ; *		 subtracts 20H if between "a" and "z".
 29313                                  ; *
 29314                                  ; * INPUT:	 AL	      char to be upper cased
 29315                                  ; *		 FUCASE_ADDR  set to the file upper case table
 29316                                  ; *
 29317                                  ; * OUTPUT:	 AL	      upper cased character
 29318                                  ; *
 29319                                  ; ****************************************************************
 29320                                  ;
 29321                                  ;assume	ds:trangroup				;AN000;
 29322                                  ;
 29323                                  ;upconv	proc	near				;AN000;
 29324                                  ;
 29325                                  ;	cmp	al,80h				;AN000;  see if char is > ascii 128
 29326                                  ;	jb	oth_fucase			;AN000;  no - upper case math
 29327                                  ;	sub	al,80h				;AN000;  only upper 128 chars in table
 29328                                  ;	push	ds				;AN000;
 29329                                  ;	push	bx				;AN000;
 29330                                  ;	mov	ds,[resseg]			;AN000;  get resident data segment
 29331                                  ;assume	ds:resgroup				;AN000;
 29332                                  ;	lds	bx,dword ptr FUCase_Addr+1	;AN000;  get table address
 29333                                  ;	add	bx,2				;AN000;  skip over first word
 29334                                  ;	xlat	ds:byte ptr [bx]		;AN000;  convert to upper case
 29335                                  ;	pop	bx				;AN000;
 29336                                  ;	pop	ds				;AN000;
 29337                                  ;assume	ds:trangroup				;AN000;
 29338                                  ;	jmp	short upconv_end		;AN000;  we finished - exit
 29339                                  ;
 29340                                  ;oth_fucase:					;AN000;
 29341                                  ;	cmp	al,small_a			;AC000; if between "a" and "z",
 29342                                  ;	jb	upconv_end			;AC000;     subtract 20h to get
 29343                                  ;	cmp	al,small_z			;AC000;    upper case equivalent.
 29344                                  ;	ja	upconv_end			;AC000;
 29345                                  ;	sub	al,20h				;AC000; Change lower-case to upper
 29346                                  ;
 29347                                  ;upconv_end:					;AN000;
 29348                                  ;	ret
 29349                                  ;
 29350                                  ;upconv	endp					;AN000;
 29351                                  
 29352                                  ;============================================================================
 29353                                  ; COPY.ASM, MSDOS 6.0, 1991
 29354                                  ;============================================================================
 29355                                  ; 01/10/2018 - Retro DOS v3.0
 29356                                  
 29357                                  ;	title	COMMAND COPY routines.
 29358                                  
 29359                                  ;/*
 29360                                  ; *                      Microsoft Confidential
 29361                                  ; *                      Copyright (C) Microsoft Corporation 1991
 29362                                  ; *                      All Rights Reserved.
 29363                                  ; */
 29364                                  
 29365                                  ;***	COPY.ASM
 29366                                  
 29367                                  ;Source files:  copy.asm, copypr1.asm, copypr2.asm
 29368                                  
 29369                                  
 29370                                  ;***	MODIFICATION HISTORY
 29371                                  
 29372                                  ;11/01/83 EE  Added a few lines at the end of SCANSRC2 to get multiple
 29373                                  ;	     file concatenations (eg copy a.*+b.*+c.*) to work properly.
 29374                                  ;11/02/83 EE  Commented out the code in CPARSE which added drive designators
 29375                                  ;	     to tokens which begin with path characters so that PARSELINE
 29376                                  ;	     will work correctly.
 29377                                  ;11/04/83 EE  Commented out the code in CPARSE that considered paren's to be
 29378                                  ;	     individual tokens. That distinction is no longer needed for
 29379                                  ;	     FOR loop processing.
 29380                                  ;11/17/83 EE  CPARSE upper case conversion is now flag dependent. Flag is
 29381                                  ;	     1 when Cparse is called from COPY.
 29382                                  ;11/17/83 EE  Took out the comment chars around code described in 11/04/83
 29383                                  ;	     mod. It now is conditional on flag like previous mod.
 29384                                  ;11/21/83 NP  Added printf
 29385                                  ;12/09/83 EE  CPARSE changed to use CPYFLAG to determine when a colon should
 29386                                  ;	     be added to a token.
 29387                                  ;05/30/84 MZ  Initialize all copy variables. Fix confusion with destclosed
 29388                                  ;	     NOTE: DestHand is the destination handle. There are two
 29389                                  ;	     special values: -1 meaning destination was never opened and
 29390                                  ;	     0 which means that the destination has been openned and
 29391                                  ;	     closed.
 29392                                  ;06/01/84 MZ  Above reasoning totally specious. Returned things to normal
 29393                                  ;06/06/86 EG  Change to fix problem of source switches /a and /b getting
 29394                                  ;	     lost on large and multiple file (wildcard) copies.
 29395                                  ;06/09/86 EG  Change to use xnametrans call to verify that source and
 29396                                  ;	     destination are not equal.
 29397                                  ;
 29398                                  ;06/24/90 DO  If the destination of a file concatenation is the same as
 29399                                  ;	     first source file AND we run out of disk space before
 29400                                  ;	     completing the concatenation, restore the first source
 29401                                  ;	     file as best we can. See SeekEnd and CopErr. Bug #859.
 29402                                  ;
 29403                                  ;M031 SR 10/11/90  Bug #3069. Use deny write sharing mode to open files
 29404                                  ;		instead of compatibility mode. This gives lesser sharing
 29405                                  ;		violations when files are opened for read on a copy.
 29406                                  
 29407                                  ; ---------------------------------------------------------------------------
 29408                                  ;***	COPY CODE
 29409                                  ; ---------------------------------------------------------------------------
 29410                                  
 29411                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2A15h
 29412                                  
 29413                                  ; 23/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29414                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 38C3h
 29415                                  
 29416                                  ; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29417                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3E6Dh
 29418                                  
 29419                                  ; 10/08/2024 - Retro DOS v5.0 COMMAND.COM
 29420                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 3D1Eh
 29421                                  
 29422                                  COPY:
 29423                                  	; 	Initialize internal variables.
 29424                                  
 29425 00003B56 31C0                    	xor	ax,ax		; AX = 0
 29426 00003B58 A3[A29D]                	mov	[Copy_num],ax	; # files copied (destinations) = 0
 29427 00003B5B A3[D29E]                	mov	[SRCPT],ax	; cmd line ptr for source scan = 0
 29428 00003B5E A3[1E9E]                	mov	[SrcTail],ax	; ptr to last element of source pathname = 0
 29429 00003B61 A2[139C]                	mov	[CFLAG],al	; 'destination file created' = false
 29430 00003B64 A3[199C]                	mov	[NXTADD],ax	; ptr into TPA buffer = 0
 29431 00003B67 A3[0F9C]                	mov	[DestSwitch],ax	; destination switches = none
 29432 00003B6A A3[F69E]                	mov	[STARTEL],ax	; CParse ptr to last pathname element = 0
 29433 00003B6D A3[BB9D]                	mov	[DestTail],ax	; ptr to last element of dest pathname = 0
 29434 00003B70 A2[149C]                	mov	[DestClosed],al	; 'destination file closed' = false
 29435 00003B73 A2[BA9D]                	mov	[DestSiz],al	; length of destination pathname = 0
 29436 00003B76 A2[1D9E]                	mov	[SrcSiz],al	; length of source pathname = 0
 29437 00003B79 A2[BD9D]                	mov	[DestInfo],al	; destination pathname flags = none
 29438 00003B7C A2[209E]                	mov	[SrcInfo],al	; source pathname flags = none
 29439 00003B7F A2[D49E]                	mov	[INEXACT],al	; 'inexact copy' = false
 29440 00003B82 A2[B99D]                	mov	[DestVars],al	; 'dest pathname is directory' = false  ;*!*
 29441 00003B85 A2[1C9E]                	mov	[SrcVars],al	; 'source pathname is directory' = false
 29442 00003B88 A2[D79A]                	mov	[USERDIR1],al	; saved working directory = null
 29443 00003B8B A2[D59E]                	mov	[NOWRITE],al	; 'no write' (source = dest) = false
 29444 00003B8E A2[069C]                	mov	[RDEOF],al	; 'read end of file' = false
 29445 00003B91 A3[789E]                	mov	[SRCHAND],ax	; source handle = 0
 29446 00003B94 A3[DD9E]                	mov	[CPDATE],ax	; copy date = 0
 29447 00003B97 A3[DF9E]                	mov	[CPTIME],ax	; copy time = 0
 29448 00003B9A A2[7A9E]                	mov	[SRCISDEV],al	; 'source is device' = false
 29449                                  	; 23/03/2023
 29450                                  	; MSDOS 6.0 (& MSDOS 5.0) COMMAND.COM	
 29451 00003B9D A2[E59E]                	mov	[OCtrlZ],al	; 'Ctrl+Z removed from original' = false
 29452                                  				; mov [zflag],al ; PCDOS 7.1 ; 10/08/2024
 29453 00003BA0 A3[E19E]                	mov	[OFilePtr_Lo],ax
 29454 00003BA3 A3[E39E]                	mov	[OFilePtr_Hi],ax ; original destination file ptr = null
 29455 00003BA6 A2[D99E]                	mov	[TERMREAD],al	; 'terminate read' = false
 29456 00003BA9 A2[959D]                	mov	[comma],al	; '"+,," found' = false
 29457 00003BAC A2[969D]                	mov	[plus_comma],al ; '"+,," found last time' = false (?)
 29458 00003BAF A2[339F]                	mov	[msg_flag],al	;AN022; 'non-utility msg issued' = false
 29459 00003BB2 A3[119C]                	mov	[AllSwitch],ax	; all switches = none
 29460 00003BB5 A2[0A9C]                	mov	[ArgC],al	; source/dest argument count = 0
 29461 00003BB8 A2[DB9E]                	mov	[PLUS],al	; '"+" in command line' = false
 29462 00003BBB A2[D69E]                	mov	[BINARY],al	; 'binary copy' = false
 29463 00003BBE A2[DA9E]                	mov	[ASCII],al	; 'ascii copy' = false
 29464 00003BC1 A3[209C]                	mov	[FileCnt],ax	; # files copied (destinations) = 0
 29465 00003BC4 A3[D79E]                	mov	[WRITTEN],ax	; 'destination written to' = false
 29466 00003BC7 A2[089C]                	mov	[Concat],al	; 'concatenating' = false
 29467 00003BCA A2[199E]                	mov	[MELCOPY],al	; 'Mel Hallerman copy' = false
 29468 00003BCD A3[1A9E]                	mov	[MELSTART],ax	; Mel Hallerman cmd line ptr = 0
 29469                                  	
 29470                                  	; 12/06/2023
 29471                                  	; MSDOS 6.22 COMMAND.COM
 29472                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 29473 00003BD0 A2[F29E]                	mov     [cox_dest_file], al ; MSDOS 6.22
 29474 00003BD3 A2[F39E]                	mov     [cox_src_file], al  ; MSDOS 6.22
 29475                                  
 29476                                  	;	Initialize buffers with double-nulls.
 29477                                  
 29478 00003BD6 A3[7B9E]                	mov	[ScanBuf],ax
 29479 00003BD9 A3[BE9D]                	mov	[DestBuf],ax
 29480 00003BDC A3[219E]                	mov	[SrcBuf],ax
 29481 00003BDF A3[7F9D]                	mov	[SDIRBUF],ax
 29482 00003BE2 A3[399D]                	mov	[DIRBUF],ax
 29483 00003BE5 A3[F69C]                	mov	[DestFcb],ax
 29484                                  
 29485 00003BE8 A2[DC9E]                	mov	[objcnt],al	; # CParse cmd-line objects found = 0
 29486                                  		
 29487 00003BEB 48                      	dec	ax ; -1		; AX = 0FFFFh
 29488 00003BEC A3[159E]                	mov	[DESTHAND],ax	; destination handle = 'never opened'
 29489 00003BEF A2[1B9C]                	mov	[FRSTSRCH],al	; 'first search for source' = true
 29490 00003BF2 A2[189E]                	mov	[FIRSTDEST],al	; 'first time for dest' = true
 29491 00003BF5 A2[B99D]                	mov	[DestIsDir],al	; 'haven't analyzed destination' ; *!*
 29492                                  
 29493                                  	; 12/06/2023
 29494                                  	; Retro DOS v4.2 COMMAND.COM
 29495                                  	; MSDOS 6.22 COMMAND.COM code only !
 29496                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 29497                                  	;
 29498 00003BF8 E8FB06                  	call	init_copycmd_option ; MSDOS 6.22 
 29499                                  		
 29500 00003BFB BE8100                  	mov	si,81h		; SI = ptr to command line
 29501                                  	;mov	bl,[PLUS_CHR]	; BL = special delimiter = "+"
 29502                                  	; 23/03/2023
 29503 00003BFE B32B                    	mov	bl,'+'
 29504 00003C00 FE06[329F]              	inc	byte [expand_star] ; CParse 'expand * to ?s' = true
 29505 00003C04 C606[A49D]01            	mov	byte [cpyflag],1 ; CParse 'called from COPY' = true
 29506                                  
 29507                                  	;*	Scan the command line for destination information.
 29508                                  
 29509                                  DESTSCAN:
 29510 00003C09 31ED                    	xor	bp,bp			; BP = switch flag accumulator
 29511 00003C0B BF[7B9E]                	mov	di,ScanBuf		; ES:DI = ptr to pathname buf
 29512                                  	; 23/03/2023
 29513 00003C0E 8936[989D]              	mov	[parse_last],si		;AN018; save cmd line ptr
 29514 00003C12 E8920B                  	call	cparse			; parse next object
 29515 00003C15 9C                      	pushf	; (*)			; save CParse flags
 29516 00003C16 FE06[DC9E]              	inc	byte [objcnt]		; count object
 29517 00003C1A F6C780                  	test	bh,80h
 29518 00003C1D 7405                    	jz	short NOCOPY		; no "+" delimiter
 29519 00003C1F C606[DB9E]01            	mov	byte [PLUS],1		; "+" delimiter occurred
 29520                                  NOCOPY:
 29521 00003C24 F6C701                  	test	bh,1
 29522 00003C27 747D                    	jz	short TESTP2		; not a switch
 29523                                  
 29524                                  	;	Found a switch.
 29525                                  
 29526                                  	; 23/03/2023 - Retro DOS v4.0 COMMAND.COM
 29527                                  	;
 29528                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29529                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3F43h
 29530                                  CHK_CP_SWITCH:
 29531                                  	; MSDOS 6.0
 29532 00003C29 F7C51000                	test	bp,10h
 29533                                  	;test	bp,SwitchV ; 10h	;AN038; Verify requested?
 29534 00003C2D 740B                    	jz	short NOT_SLASHV	;AN038; No - set the switch
 29535                                  	;test	word [AllSwitch],10h
 29536 00003C2F F606[119C]10            	test	byte [AllSwitch],10h
 29537                                  	;test	byte [AllSwitch],SwitchV ;AN038; Verify already entered?
 29538 00003C34 7404                    	jz	short NOT_SLASHV	;AN038; No - set the switch
 29539                                  ;AD018; ;or	word [AllSwitch],FBadSwitch ;AN038; Set up bad switch
 29540                                  	;or	bp,FBadSwitch		;AN018; Set up bad switch
 29541 00003C36 81CD0040                	or	bp,4000h
 29542                                  NOT_SLASHV:
 29543                                  	; ****************************************
 29544                                  	; 12/06/2023
 29545                                  	; Retro DOS v4.2 COMMAND.COM
 29546                                  	; MSDOS 6.22 COMMAND.COM code only !
 29547                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 29548                                  	; ****************************************
 29549                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3F55h
 29550                                  	;
 29551 00003C3A F7C54000                	test    bp,40h			; negative Y (-Y) switch flag
 29552 00003C3E 7417                    	jz	short CHK_SLASHY0
 29553                                  	;
 29554                                  	;test	word [AllSwitch],40h
 29555 00003C40 F606[119C]40            	test	byte [AllSwitch],40h	; [AllSwitch] negative (-Y) flag
 29556 00003C45 7507                    	jnz	short NOT_SLASHY1	; N flag
 29557                                  	;test	word [AllSwitch],80h
 29558 00003C47 F606[119C]80            	test	byte [AllSwitch],80h	; [AllSwitch] SwitchY (Y) flag
 29559 00003C4C 7404                    	jz	short NOT_SLASHY2
 29560                                  NOT_SLASHY1:
 29561 00003C4E 81CD0040                	or	bp,4000h		; FBadSwitch (Repetitive)
 29562                                  NOT_SLASHY2:				; Set up bad switch
 29563 00003C52 C606[F19E]00            	mov	byte [cox_y_override],0	; cox_y setting will be used
 29564                                  CHK_SLASHY0:
 29565 00003C57 F7C58000                	test    bp,80h
 29566 00003C5B 742B                    	jz      short CHK_SLASHY4	; not a /Y switch
 29567                                  	;
 29568 00003C5D 8A04                    	mov	al,[si]
 29569 00003C5F 3C79                    	cmp	al,'y'
 29570 00003C61 740A                    	je	short CHK_SLASHY1
 29571 00003C63 3C59                    	cmp	al,'Y'
 29572 00003C65 7406                    	je	short CHK_SLASHY1
 29573 00003C67 81CD0040                	or	bp,4000h		; FBadSwitch
 29574                                  	;				; Set up bad switch
 29575 00003C6B EB1B                    	jmp	short CHK_SLASHY4
 29576                                  CHK_SLASHY1:
 29577 00003C6D C60420                  	mov	byte [si],20h ; ' '
 29578 00003C70 46                      	inc	si
 29579                                  	;test	word [AllSwitch],40h
 29580 00003C71 F606[119C]40            	test	byte [AllSwitch],40h	; [AllSwitch] negative (-Y) flag
 29581 00003C76 7507                    	jnz	short CHK_SLASHY2	; N flag
 29582                                  	;test	word [AllSwitch],80h
 29583 00003C78 F606[119C]80            	test	byte [AllSwitch],80h	; [AllSwitch] SwitchY (Y) flag
 29584 00003C7D 7404                    	jz	short CHK_SLASHY3
 29585                                  CHK_SLASHY2:
 29586 00003C7F 81CD0040                	or	bp,4000h		; FBadSwitch (Repetitive)
 29587                                  	;				; Set up bad switch
 29588                                  CHK_SLASHY3:
 29589 00003C83 C606[F19E]01            	mov	byte [cox_y_override],1
 29590                                  CHK_SLASHY4:
 29591                                  	; ****************************************
 29592                                  	; 12/06/2023
 29593                                  ;NOT_SLASHV:
 29594                                  	;or	[DestSwitch],bp		; assume destination
 29595                                  	;or	[AllSwitch],bp		; keep tabs on all switches
 29596                                  
 29597                                  	; 12/06/2023
 29598                                  	; Retro DOS v4.2 COMMAND.COM
 29599                                  	; MSDOS 6.22 COMMAND.COM -TRANGROUP:3FA7h
 29600 00003C88 092E[0F9C]              	or	[DestSwitch],bp		; set [DestSwitch] SwitchY flag to 1
 29601 00003C8C 092E[119C]              	or	[AllSwitch],bp		; set [AllSwitch] SwitchY flag to 1
 29602                                  	;test	bp,~SwitchCopy		; Bad switch?
 29603 00003C90 F7C5237F                	test	bp,7F23h ; MSDOS 6.22	; ~SwitchCopy ; not SwitchCopy
 29604 00003C94 740A                    	jz	short NOT_BAD_SWITCH	; Switches are okay
 29605                                  
 29606                                  	; 12/06/2023
 29607                                  	; 23/03/2023
 29608                                  	; MSDOS 6.0
 29609                                  	;;test	bp,not SwitchCopy	;AN018; Bad switch?
 29610                                  	;test	bp,7FE3h ; test bp,~SwitchCopy
 29611                                  	;jz	short NOT_BAD_SWITCH	;AN018; Switches are okay
 29612                                  	
 29613 00003C96 9D                      	popf	; (*)			;AN018; fix up stack
 29614 00003C97 B80300                  	mov	ax,BadSwt_Ptr ; 3	;AN018; get "Invalid switch" message number
 29615 00003C9A E8CDE8                  	call	setup_parse_error_msg	;AN018; setup to print the message
 29616 00003C9D E986F0                  	jmp	cerror			;AC018; exit
 29617                                  NOT_BAD_SWITCH:
 29618 00003CA0 9D                      	popf				; restore CParse flags
 29619 00003CA1 7233                    	jc	short CHECKDONE		; found CR
 29620 00003CA3 E963FF                  	jmp	DESTSCAN		; continue scanning for destination
 29621                                  TESTP2:
 29622 00003CA6 9D                      	popf	; (*)			; restore CParse flags
 29623 00003CA7 722D                    	jc	short CHECKDONE		; found CR
 29624 00003CA9 F6C780                  	test	bh,80h
 29625 00003CAC 7504                    	jnz	short GOTPLUS		; found a "+pathname" argument
 29626 00003CAE FE06[0A9C]              	inc	byte [ArgC]		; count independent pathname args
 29627                                  GOTPLUS:
 29628 00003CB2 56                      	push	si			; save cmd line ptr
 29629 00003CB3 A1[F69E]                	mov	ax,[STARTEL]		; AX = ptr to last path element
 29630 00003CB6 BE[7B9E]                	mov	si,ScanBuf		; SI = ptr to path string
 29631 00003CB9 29F0                    	sub	ax,si			; AX = offset of last element
 29632 00003CBB BF[BE9D]                	mov	di,DestBuf		; DI = ptr to destination buf
 29633 00003CBE 01F8                    	add	ax,di			; AX = ptr to last element in
 29634                                  					;  destination path buffer
 29635 00003CC0 A3[BB9D]                	mov	[DestTail],ax		; save ptr to last element
 29636 00003CC3 880E[BA9D]              	mov	[DestSiz],cl		; save path string length
 29637 00003CC7 41                      	inc	cx			; CX = mov length (incl null)
 29638 00003CC8 F3A4                    	rep	movsb			; DestBuf = possible destination path
 29639 00003CCA 883E[BD9D]              	mov	[DestInfo],bh		; save CParse info flags
 29640                                  	;mov	word [DestSwitch],0	; clear destination switches
 29641                                  	; 10/08/2024
 29642 00003CCE 890E[0F9C]              	mov	[DestSwitch],cx ; 0
 29643 00003CD2 5E                      	pop	si			; SI = ptr into cmd line again
 29644 00003CD3 E933FF                  	jmp	DESTSCAN		;AC018; continue scanning for dest
 29645                                  
 29646                                  CHECKDONE:
 29647                                  	;	We reached the CR. The destination scan is finished.
 29648                                  
 29649                                  	;	Disallow "copy file1+" as file overwriting itself.
 29650                                  	;
 29651                                  	;	(Note that "copy file1+file2+" will be accepted, and
 29652                                  	;	equivalent to "copy file1+file2".)
 29653                                  
 29654                                  	;	Bugbug: it looks like "copy /x file1+" would slip
 29655                                  	;	through this check, since the switch would count
 29656                                  	;	as another object in ObjCnt.
 29657                                  
 29658 00003CD6 803E[DB9E]01            	cmp	byte [PLUS],1		; "+" with
 29659 00003CDB 7514                    	jnz	short CDCONT
 29660 00003CDD 803E[0A9C]01            	cmp	byte [ArgC],1		; one arg,
 29661 00003CE2 750D                    	jnz	short CDCONT
 29662 00003CE4 803E[DC9E]02            	cmp	byte [objcnt],2		; two objects..
 29663 00003CE9 7506                    	jnz	short CDCONT
 29664 00003CEB BA[0390]                	mov	dx,OVERWR_PTR
 29665 00003CEE E9D207                  	jmp	COPYERR			; is file overwrite
 29666                                  
 29667                                  CDCONT:
 29668 00003CF1 A0[DB9E]                	mov	al,[PLUS]		; AL = '"+" occurred'
 29669 00003CF4 A2[089C]                	mov	[Concat],al		; if "+" occurred, we're concatenating
 29670 00003CF7 D0E0                    	shl	al,1
 29671 00003CF9 D0E0                    	shl	al,1
 29672 00003CFB A2[D49E]                	mov	[INEXACT],al		; therefore making an inexact copy
 29673                                  	;mov	dx,BADARGSPTR ; MSDOS 3.3 ; 18/04/2023
 29674 00003CFE A0[0A9C]                	mov	al,[ArgC]		; AL = # independent arguments
 29675                                  
 29676                                  	; 23/03/2023
 29677                                  	; MSDOS 3.3		
 29678                                  	;or	al,al
 29679                                  	;jz	short CERROR4J
 29680                                  	; MSDOS 6.0
 29681 00003D01 08C0                    	or	al,al
 29682 00003D03 750B                    	jnz	short TRY_TOO_MANY	; more than 0 args; check if too many
 29683                                  		
 29684 00003D05 BA[D78F]                	mov	dx,extend_buf_ptr	; DX = ptr to msg block
 29685 00003D08 C706[D78F]0200          	mov	word [extend_buf_ptr],LessArgs_Ptr ; 2
 29686                                  	;mov	word [extend_buf_ptr],2	; set msg # "param missing"
 29687 00003D0E EB0D                    	jmp	short CERROR_PARSEJ	; take parse error exit		
 29688                                  
 29689                                  	; more than 0 args; check if too many
 29690                                  TRY_TOO_MANY:
 29691 00003D10 3C02                    	cmp	al,2
 29692 00003D12 7611                    	jbe	short ACOUNTOK		; <= 2 arguments - ok
 29693                                  
 29694                                  	; 23/03/2023
 29695                                  	; MSDOS 6.0
 29696 00003D14 BA[D78F]                	mov	dx,extend_buf_ptr	; DX = ptr to msg block
 29697 00003D17 C706[D78F]0100          	mov	word [extend_buf_ptr],MoreArgs_Ptr
 29698                                  	;mov	word [extend_buf_ptr],1 ; set msg # "too many params"
 29699                                  CERROR_PARSEJ:
 29700 00003D1D C606[D58F]02            	mov	byte [msg_disp_class],parse_msg_class ; 2
 29701                                  					; parse error message	
 29702                                  CERROR4J:
 29703 00003D22 E901F0                  	jmp	cerror
 29704                                  
 29705                                  ACOUNTOK:
 29706 00003D25 BD[B99D]                	mov	bp,DestVars		; BP = base of dest variables
 29707                                  
 29708 00003D28 3C01                    	cmp	al,1
 29709 00003D2A 7520                    	jnz	short GOT2ARGS
 29710                                  
 29711                                  	;	Only one independent pathname argument on command line.
 29712                                  	;	Set destination to d:*.*, where d: is current drive.
 29713                                  
 29714                                  	;	Bugbug: but is this appropriate for "copy x:file1+x:file2"?
 29715                                  	;	The two files would be appended as d:file1, rather than x:file1.
 29716                                  
 29717 00003D2C A0[079C]                	mov	al,[CURDRV]		; AL = current drive (0 = A)
 29718                                  	;add	al,[CAPITAL_A]		; AL = current drive letter
 29719                                  	; 23/03/2023
 29720 00003D2F 0441                    	add	al,'A'
 29721 00003D31 B43A                    	mov	ah,':'			; AX = "d:"
 29722                                  	;mov	byte [bp+1],2
 29723 00003D33 C6460102                	mov	byte [bp+VARSTRUC.SIZ],2 ; pathname length = 2
 29724                                  
 29725 00003D37 BF[BE9D]                	mov	di,DestBuf		; ES:DI = ptr to dest path buf
 29726 00003D3A AB                      	stosw				; store "d:"
 29727                                  		
 29728 00003D3B C706[0F9C]0000          	mov	word [DestSwitch],0	; clear destination switches
 29729                                  	;mov	byte [bp+4],2		
 29730 00003D41 C6460402                	mov	byte [bp+VARSTRUC.INFO],2 ; mark destination 'wildcard present'
 29731                                  	;mov	byte [bp+VARSTRUC.ISDIR],0 ; mark destination 'not a directory'
 29732                                  	;mov	byte [bp+0],0		
 29733 00003D45 C6460000                	mov	byte [bp],0
 29734 00003D49 E82C0A                  	call	SETSTARS		; add wildcards
 29735                                  GOT2ARGS:
 29736                                  	;	If destination pathname is "d:", add full wildcard filename
 29737                                  
 29738                                  	;cmp	byte [bp+1],2
 29739 00003D4C 807E0102                	cmp	byte [bp+VARSTRUC.SIZ],2
 29740 00003D50 7516                    	jnz	short NOTSHORTDEST	; not two chars, can't be "d:"
 29741 00003D52 B03A                    	mov	al,':'  ; 3Ah
 29742 00003D54 3806[BF9D]              	cmp	byte [DestBuf+1],al
 29743 00003D58 750E                    	jnz	short NOTSHORTDEST	; it's just a 2-character filename
 29744                                  	;or	byte [bp+4],2
 29745 00003D5A 804E0402                	or	byte [bp+VARSTRUC.INFO],2 ; mark destination 'wildcard present'
 29746 00003D5E BF[C09D]                	mov	di,DestBuf+2		; ES:DI = ptr after "d:"
 29747                                  	;mov	byte [bp+VARSTRUC.ISDIR],0 ; mark destination 'not a directory'
 29748                                  	;mov	byte [bp+0],0		
 29749 00003D61 C6460000                	mov	byte [bp],0
 29750 00003D65 E8100A                  	call	SETSTARS		; add wildcards
 29751                                  NOTSHORTDEST:
 29752                                  	;	If destination pathname ends with "\", try to make
 29753                                  	;	sure it's "d:\".
 29754                                  
 29755                                  	;mov	di,[bp+2]
 29756 00003D68 8B7E02                  	mov	di,[bp+VARSTRUC.TTAIL]	; DI = ptr to last path element
 29757 00003D6B 803D00                  	cmp	byte [di],0
 29758 00003D6E 7515                    	jnz	short CHKSWTCHES	; not a null, so last char not "\"
 29759                                  
 29760 00003D70 BA[3791]                	mov	dx,badcd_ptr
 29761 00003D73 B03A                    	mov	al,':'
 29762 00003D75 3845FE                  	cmp	[di-2],al
 29763 00003D78 75A8                    	jne	short CERROR4J		; it's not "d:\", exit with error msg
 29764                                  	;mov	byte [bp+0],2
 29765                                  	;mov	byte [bp+VARSTRUC.ISDIR],2 ; destination 'is a directory'
 29766 00003D7A C6460002                	mov	byte [bp],2
 29767                                  	;or	byte [bp+4],6
 29768 00003D7E 804E0406                	or	byte [bp+VARSTRUC.INFO],6 ; destination wildcarded and contains
 29769                                  					  ;  path character
 29770 00003D82 E8F309                  	call	SETSTARS		; add wildcards
 29771                                  CHKSWTCHES:
 29772                                  	;	We have enough information about the destination for now.
 29773                                  
 29774                                  	;	Turn on verify if requested. Save the current verify flag.
 29775                                  
 29776                                  	; 23/03/2023
 29777                                  	; MSDOS 6.0 (& MSDOS 5.0) COMMAND.COM
 29778                                  	;mov	dx,BADPARMPTR
 29779                                  	
 29780 00003D85 A1[119C]                	mov	ax,[AllSwitch]		; AX = all switch flags
 29781                                  
 29782                                  	; 23/03/2023
 29783                                  	; MSDOS 3.3
 29784                                  	;;test	ax,~SWITCHCOPY ; 7FE3h
 29785                                  	;test	ax,NOT_SWITCHCOPY ; 7FE3h ; 13/10/2018
 29786                                  	;jnz	short CERROR4J
 29787                                  	
 29788                                  	; 23/03/2023
 29789                                  	; MSDOS 3.3 (& MSDOS 6.0)
 29790                                  	;test	ax,SwitchV ; 10h
 29791                                  	; 18/04/2023
 29792                                  	;test	ax,10h
 29793 00003D88 A810                    	test	al,10h  ; test al,SwitchV
 29794 00003D8A 7414                    	jz	short NOVERIF		; no /v, no verify
 29795                                  
 29796 00003D8C B454                    	mov	ah,Get_Verify_On_Write ; 54h
 29797 00003D8E CD21                    	int	21h		; DOS -	2+ - GET VERIFY	FLAG
 29798                                  				; Return: AL = 00h if flag OFF
 29799                                  				; AL = 01h if flag ON
 29800 00003D90 1E                      	push	ds
 29801 00003D91 8E1E[F59B]              	mov	ds,[RESSEG]
 29802 00003D95 30E4                    	xor	ah,ah
 29803 00003D97 A3[A702]                	mov	[VerVal],ax		; save current verify flag
 29804 00003D9A 1F                      	pop	ds
 29805 00003D9B B8012E                  	mov	ax,(SET_VERIFY_ON_WRITE<<8)|1 ; 2E01h
 29806 00003D9E CD21                    	int	21h		; DOS -	SET VERIFY FLAG
 29807                                  				; DL = 00h,AL = 01h VERIFY on / 00h VERIFY off
 29808                                  NOVERIF:
 29809                                  	;*	Scan for first source.
 29810                                  
 29811 00003DA0 31ED                    	xor	bp,bp			; BP = switch flags accumulator
 29812 00003DA2 BE8100                  	mov	si,81h			; SI = ptr into command line
 29813                                  	;mov	bl,[PLUS_CHR]		; BL = special CParse delimiter = "+"
 29814                                  	; 23/03/2023
 29815 00003DA5 B32B                    	mov	bl,'+' ; 2Bh
 29816                                  SCANFSRC:
 29817 00003DA7 BF[7B9E]                	mov	di,ScanBuf		; DI = ptr to pathname buf
 29818 00003DAA E8FA09                  	call	cparse			; parse first source pathname
 29819 00003DAD F6C701                  	test	bh,1			; switch?
 29820 00003DB0 75F5                    	jnz	short SCANFSRC		; yes, try again
 29821 00003DB2 092E[0F9C]              	or	[DestSwitch],bp		; include copy-wide switches on dest
 29822                                  
 29823                                  ;	Set ascii copying mode if concatenating, unless /b is specified.
 29824                                  
 29825                                  	; 23/03/2023
 29826 00003DB6 F7C50800                	test	bp,8
 29827                                  	;test	bp,SWITCHB
 29828 00003DBA 750C                    	jnz	short NOSETCASC		; /b - explicit binary copy
 29829 00003DBC 803E[089C]00            	cmp	byte [Concat],0
 29830 00003DC1 7405                    	jz	short NOSETCASC		; we're not concatenating
 29831 00003DC3 C606[DA9E]04            	mov	byte [ASCII],4
 29832                                  	;mov	byte [ASCII],SWITCHA	; set ascii copy
 29833                                  NOSETCASC:
 29834 00003DC8 E83004                  	call	SOURCE_SET		; set source variables
 29835 00003DCB E84400                  	call	FRSTSRC			; set up first source copy
 29836 00003DCE E99800                  	jmp	FIRSTENT		; jump into the copy loop
 29837                                  
 29838                                  ; ---------------------------------------------------------------------------
 29839                                  
 29840                                  	; 24/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29841                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3AE9h
 29842                                  ENDCOPY:
 29843                                  	;*	End of the road. Close destination, display # files
 29844                                  	;	copied (meaning # destinations), and go back to main
 29845                                  	;	transient COMMAND code.
 29846                                  
 29847 00003DD1 E83503                  	call	CLOSEDEST
 29848                                  ENDCOPY2:
 29849 00003DD4 BA[0C90]                	mov	dx,copied_ptr
 29850 00003DD7 8B36[209C]              	mov	si,[FileCnt]
 29851 00003DDB 8936[A29D]              	mov	[Copy_num],si
 29852 00003DDF E84616                  	call	std_printf
 29853 00003DE2 E91FC3                  	jmp	TCOMMAND		; stack could be messed up
 29854                                  
 29855                                  ; ---------------------------------------------------------------------------
 29856                                  
 29857                                  SRCNONEXIST:
 29858                                  	;*	Source doesn't exist. If concatenating, ignore and continue.
 29859                                  	;	Otherwise, say 'file not found' and quit.
 29860                                  
 29861 00003DE5 803E[089C]00            	cmp	byte [Concat],0
 29862 00003DEA 7546                    	jne	short NEXTSRC		; concatenating - go on to next source
 29863                                  
 29864                                  	; 24/03/2023
 29865                                  	; MSDOS 3.3
 29866                                  	;mov	dx,SRCBUF
 29867                                  	;mov	[STRING_PTR_1],dx
 29868                                  	;mov	dx,STRINGBUF1PTR
 29869                                  	;call	STD_PRINTF
 29870                                  	;mov	dx,FNOTFOUNDPTR
 29871                                  	;jmp	COPYERR
 29872                                  
 29873                                  	; 24/*03/2023
 29874                                  	; MSDOS 6.0
 29875                                  	;	Set up error message.
 29876 00003DEC C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class ; 1
 29877                                  				  	; extended error msg
 29878 00003DF1 BA[D78F]                	mov	dx,extend_buf_ptr	; DX = ptr to msg block
 29879 00003DF4 C706[D78F]0200          	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND ; 2
 29880                                  					; 'file not found' msg#
 29881 00003DFA C706[A09D][219E]        	mov	word [string_ptr_2],SrcBuf
 29882                                  					; point at bad pathname
 29883 00003E00 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst ; 1
 29884                                  					; 1 substitution
 29885 00003E05 E9BB06                  	jmp	COPYERR			; print msg and clean up
 29886                                  
 29887                                  ; ---------------------------------------------------------------------------
 29888                                  
 29889                                  SOURCEPROC:
 29890                                  
 29891                                  	;*	Preparatory processing for each source file.
 29892                                  	;	Called at FrstSrc for first source file.
 29893                                  
 29894 00003E08 E8F003                  	call	SOURCE_SET		; set source variables & ascii/binary
 29895 00003E0B 803E[089C]00            	cmp	byte [Concat],0
 29896 00003E10 750B                    	jne	short LEAVECFLAG	; concatenating - leave CFlag alone
 29897                                  
 29898                                  ; ---------------------------------------------------------------------------
 29899                                  
 29900                                  FRSTSRC:
 29901 00003E12 31C0                    	xor	ax,ax
 29902 00003E14 A2[139C]                	mov	[CFLAG],al		; 'destination not created'
 29903 00003E17 A3[199C]                	mov	[NXTADD],ax		; copy buffer ptr = 0
 29904 00003E1A A2[149C]                	mov	[DestClosed],al		; 'destination not closed'
 29905                                  
 29906                                  LEAVECFLAG:
 29907 00003E1D 8936[D29E]              	mov	[SRCPT],si		; save cmd-line ptr
 29908 00003E21 BF[D79A]                	mov	di,USERDIR1		; DI = ptr to buf for user's 
 29909                                  						;   current dir
 29910 00003E24 BD[1C9E]                	mov	bp,SrcVars		; BP = base of source variables
 29911                                  
 29912                                  ; 10/08/2024 - PCDOS 7.1 COMMAND.COM
 29913                                  %if 1
 29914                                  	;mov	bx,deny_none|read_open_mode
 29915 00003E27 BB4000                  	mov	bx,40h			; open mode for COPY ;M046
 29916                                  %endif
 29917 00003E2A E8FE07                  	call	BUILDPATH		; cd to source dir, figure
 29918                                  						;   out stuff about source
 29919 00003E2D 8B36[1E9E]              	mov	si,[SrcTail]		; SI = ptr to source filename
 29920 00003E31 C3                      	retn
 29921                                  
 29922                                  ; ---------------------------------------------------------------------------
 29923                                  
 29924                                  	; 25/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29925                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29926                                  NEXTSRC:
 29927                                  	;*	Next source. Come here after handling each pathname.
 29928                                  	;	We're done unless there are additional source pathnames
 29929                                  	;	to be appended.
 29930                                  	;
 29931                                  	;	Note that all files matching an ambiguous pathname
 29932                                  	;	are processed before coming here.
 29933                                  
 29934 00003E32 803E[DB9E]00            	cmp	byte [PLUS],0
 29935                                  	;jne	short MORECP		; copying "+" sources - keep going
 29936                                  	; 26/04/2023
 29937                                  ;ENDCOPYJ2:
 29938                                  	;jmp	short ENDCOPY
 29939 00003E37 7498                    	je	short ENDCOPY
 29940                                  MORECP:
 29941 00003E39 31ED                    	xor	bp,bp			; BP = switch flags accumulator
 29942 00003E3B 8B36[D29E]              	mov	si,[SRCPT]		; SI = ptr to current pos'n in cmd line
 29943                                  	;mov	bl,[PLUS_CHR]		; BL = special delimiter = "+"
 29944 00003E3F B32B                    	mov	bl,'+' ; 2Bh
 29945                                  SCANSRC:
 29946 00003E41 BF[7B9E]                	mov	di,ScanBuf		; DI = ptr to pathname buf
 29947 00003E44 E86009                  	call	cparse			; parse first source name
 29948                                  	;jb	short ENDCOPYJ2		; CR found - we're done
 29949                                  	; 26/04/2023
 29950 00003E47 7288                    	jb	short ENDCOPY
 29951                                  
 29952 00003E49 F6C780                  	test	bh,80h
 29953                                  	;jz	short ENDCOPYJ2		; no "+" delimiter - we're done
 29954                                  	; 26/04/2023
 29955 00003E4C 7483                    	jz	short ENDCOPY
 29956                                  
 29957 00003E4E F6C701                  	test	bh,1
 29958 00003E51 75EE                    	jnz	short SCANSRC		; switch found - keep looking
 29959                                  
 29960                                  	;	ScanBuf contains the next source pathname.
 29961                                  
 29962 00003E53 E8B2FF                  	call	SOURCEPROC		; prepare this source
 29963 00003E56 803E[959D]01            	cmp	byte [comma],1		; was +,, found last time?
 29964 00003E5B 7507                    	jnz	short NOSTAMP		;  no - try for a file
 29965 00003E5D C606[969D]01            	mov	byte [plus_comma],1	; yes - set flag
 29966 00003E62 EB81                    	jmp	short SRCNONEXIST	; we know we won't find it
 29967                                  
 29968                                  NOSTAMP:
 29969 00003E64 C606[969D]00            	mov	byte [plus_comma],0	; reset +,, flag
 29970                                  
 29971                                  ; ---------------------------------------------------------------------------
 29972                                  
 29973                                  FIRSTENT:
 29974                                  
 29975                                  ;M047
 29976                                  ; The only case we need to worry about is when the source is wildcarded and
 29977                                  ;the destination is not. For this case, ConCat is not yet set to indicate
 29978                                  ;concatenation. We check for this case.
 29979                                  ;
 29980                                  ;NB: This change has been backed out and replaced by M048. This is not the
 29981                                  ;right place to do this check.
 29982                                  
 29983                                  	;	This is where we enter the loop with the first source.
 29984                                  
 29985 00003E69 BF5C00                  	mov	di,FCB ; 5Ch		; DI = ptr to FCB
 29986 00003E6C B80029                  	mov	ax,Parse_File_Descriptor*256 ; 2900h
 29987 00003E6F CD21                    	int	21h		; DOS -	PARSE FILENAME
 29988                                  				; DS:SI	-> string to parse
 29989                                  				; ES:DI	-> buffer to fill with unopened	FCB
 29990                                  				; AL = bit mask	to control parsing
 29991 00003E71 803C00                  	cmp	byte [si],0		; did we parse the whole thing?
 29992 00003E74 7516                    	jne	short SRCHDONE		; no, error, simulate 'not found'
 29993 00003E76 A1[219E]                	mov	ax,[SrcBuf]		; AX = possible "d:"
 29994 00003E79 80FC3A                  	cmp	ah,':'
 29995 00003E7C 7402                    	je	short DRVSPEC1		; AX = definite "d:"
 29996 00003E7E B040                    	mov	al,'@'	; 40h		; AL = drive 'letter' for current drive
 29997                                  DRVSPEC1:
 29998 00003E80 0C20                    	or	al,20h			; AL = lowercase drive letter
 29999 00003E82 2C60                    	sub	al,60h			; AL = drive id (0=current,1=A,..)
 30000                                  	;mov	[5Ch],al
 30001 00003E84 A25C00                  	mov	[FCB],al		; put drive id in FCB
 30002                                  
 30003                                  	;	FCB contains drive and filename to search.
 30004                                  		
 30005 00003E87 B411                    	mov	ah,Dir_Search_First ; 11h  ; AH = 'Find First File'
 30006 00003E89 E86D01                  	call	SEARCH
 30007                                  SRCHDONE:
 30008 00003E8C 9C                      	pushf				; save flags from Search
 30009 00003E8D E893E9                  	call	RestUDir1		; restore users current directory
 30010 00003E90 9D                      	popf				; restore flags from search
 30011 00003E91 7403                    	jz	short NEXTAMBIG0	; found the source - continue
 30012 00003E93 E94FFF                  	jmp	SRCNONEXIST		; didn't find the source
 30013                                  
 30014                                  NEXTAMBIG0:
 30015 00003E96 30C0                    	xor	al,al
 30016 00003E98 8606[1B9C]              	xchg	al,[FRSTSRCH]
 30017 00003E9C 08C0                    	or	al,al
 30018 00003E9E 740B                    	jz	short NEXTAMBIG
 30019                                  SETNMEL:
 30020 00003EA0 B90C00                  	mov	cx,12
 30021 00003EA3 BF[7F9D]                	mov	di,SDIRBUF
 30022 00003EA6 BE[399D]                	mov	si,DIRBUF
 30023 00003EA9 F3A4                    	rep	movsb			; save very first source name
 30024                                  NEXTAMBIG:
 30025 00003EAB 30C0                    	xor	al,al
 30026 00003EAD A2[D59E]                	mov	[NOWRITE],al		; turn off nowrite
 30027 00003EB0 8B3E[1E9E]              	mov	di,[SrcTail]
 30028 00003EB4 BE[3A9D]                	mov	si,DIRBUF+1
 30029 00003EB7 E8EBEA                  	call	FCB_TO_ASCZ		; SrcBuf has complete name
 30030                                  ;MELDO:
 30031                                  	; ****************************************
 30032                                  	; 12/06/2023
 30033                                  	; Retro DOS v4.2 COMMAND.COM
 30034                                  	; MSDOS 6.22 COMMAND.COM code only !
 30035                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 30036                                  	; ****************************************
 30037                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:41DBh
 30038                                  MELDO0:
 30039 00003EBA 803E[F19E]00            	cmp	byte [cox_y_override],0 ; /Y switch override (question) enabled ?
 30040 00003EBF 746C                    	jz	short MELDO ; no
 30041                                  	; ----------------------
 30042                                  	; yes
 30043 00003EC1 E87506                  	call	BUILDDEST
 30044 00003EC4 BE[219E]                	mov	si,SrcBuf
 30045 00003EC7 BF[2399]                	mov	di,SRCXNAME
 30046                                  	;mov	ah,60h
 30047 00003ECA B460                    	mov	ah,xNameTrans ; 60h
 30048 00003ECC CD21                    	int	21h	; DOS - RESOLVE PATH STRING TO CANONICAL PATH STRING
 30049                                  			; DS:SI -> ASCIZ relative path string or directory name
 30050                                  			; ES:DI -> 128-byte buffer for ASCIZ canonical fully qualified name
 30051 00003ECE E8C308                  	call	COMPNAME
 30052 00003ED1 7540                    	jnz	short MELDO1    	; different file names
 30053 00003ED3 803E[089C]00            	cmp	byte [Concat],0
 30054 00003ED8 7539                    	jnz	short MELDO1		; concatenating
 30055                                  	; "File cannot be copied onto itself"
 30056 00003EDA BA[A791]                	mov	dx,file_name_ptr
 30057 00003EDD E84815                  	call	std_printf
 30058 00003EE0 E896EA                  	call	CRLF2
 30059 00003EE3 BA[0390]                	mov	dx,OVERWR_PTR
 30060 00003EE6 E9DA05                  	jmp	COPYERR
 30061                                  ;MELDO1:
 30062                                  	;cmp	byte [CFLAG],0		; destination file created flag
 30063                                  	;jnz	short MELDO		; yes, new (created) file
 30064                                  	;				; no, overwrite question (must be confirmed)
 30065                                  	;call	get_answer_YNA
 30066                                  	;jb	short MELDO2    	; answer is no
 30067                                  	;cmp	byte [Concat],0
 30068                                  	;jnz	short MELDO
 30069                                  	;cmp	byte [cox_dest_file],0	; is there a (valid) target file ?
 30070                                  	;jnz	short DOREAD    	; yes
 30071                                  	;jmp	short MELDO     	; no, destination/target file does not exist
 30072                                  MELDO2:
 30073 00003EE9 803E[199E]00            	cmp	byte [MELCOPY],0	; is 'Mel Hallerman copy' false ?
 30074 00003EEE 7507                    	jnz	short MELDO3    	; no (, it is true)
 30075 00003EF0 803E[089C]00            	cmp	byte [Concat],0
 30076 00003EF5 7408                    	jz	short MELDO4
 30077                                  MELDO3:
 30078 00003EF7 C606[149C]01            	mov	byte [DestClosed],1
 30079 00003EFC E9D2FE                  	jmp	ENDCOPY
 30080                                  MELDO4:
 30081 00003EFF E8EB00                  	call	SEARCHNEXT
 30082 00003F02 74A7                    	jz	short NEXTAMBIG
 30083 00003F04 803E[F39E]00            	cmp	byte [cox_src_file],0
 30084                                  	;jz	short MELDO5
 30085                                  	;jmp	NEXTSRC
 30086                                  	; 18/06/2023
 30087 00003F09 7505                    	jnz	short NEXTSRCJ
 30088                                  MELDO5:
 30089 00003F0B C606[149C]01            	mov	byte [DestClosed],1
 30090                                  NEXTSRCJ:	; 18/06/2023
 30091 00003F10 E91FFF                  	jmp	NEXTSRC
 30092                                  
 30093                                  	; 12/06/2023
 30094                                  MELDO1:
 30095 00003F13 803E[139C]00            	cmp	byte [CFLAG],0		; destination file created flag
 30096 00003F18 7513                    	jnz	short MELDO     	; yes, new (created) file
 30097                                  					; no, overwrite question (must be confirmed)
 30098 00003F1A E81F03                  	call	get_answer_YNA
 30099 00003F1D 72CA                    	jb	short MELDO2    	; answer is no
 30100 00003F1F 803E[089C]00            	cmp	byte [Concat],0
 30101 00003F24 7507                    	jnz	short MELDO
 30102 00003F26 803E[F29E]00            	cmp	byte [cox_dest_file],0	; is there a (valid) target file ?
 30103 00003F2B 7517                    	jnz	short DOREAD    	; yes
 30104                                  	; 12/06/2023
 30105                                  	;jmp	short MELDO     	; no, destination/target file does not exist
 30106                                  
 30107                                  	; ****************************************
 30108                                  	; 12/06/2023
 30109                                  MELDO:
 30110 00003F2D 803E[089C]00            	cmp	byte [Concat],0
 30111 00003F32 7507                    	jnz	short SHOWCPNAM		; concatenating - show name
 30112 00003F34 F606[209E]02            	test	byte [SrcInfo],2	; wildcard - show name
 30113 00003F39 7409                    	jz	short DOREAD
 30114                                  SHOWCPNAM:
 30115                                  	; 25/03/2023
 30116                                  	; MSDOS 3.3
 30117                                  	;mov	dx,SRCBUF
 30118                                  	;mov	[STRING_PTR_2],dx
 30119                                  	;mov	dx,STRINGBUF2PTR
 30120                                  	;call	STD_PRINTF
 30121                                  	;call	CRLF2
 30122                                  	; 25/03/2023 - Retro DOS 4.0 COMMAND.COM
 30123                                  	; MSDOS 6.0 (& MSDOS 5.0
 30124 00003F3B BA[A791]                	mov	dx,file_name_ptr
 30125 00003F3E E8E714                  	call	std_printf
 30126 00003F41 E835EA                  	call	CRLF2
 30127                                  DOREAD:
 30128 00003F44 E8C300                  	call	DOCOPY
 30129 00003F47 803E[089C]00            	cmp	byte [Concat],0
 30130 00003F4C 750A                    	jnz	short NODCLOSE		; concatenating - don't close dest
 30131                                  
 30132 00003F4E E8B801                  	call	CLOSEDEST		; close current destination
 30133 00003F51 7205                    	jc	short NODCLOSE		; concatenating - dest not closed
 30134                                  
 30135 00003F53 C606[139C]00            	mov	byte [CFLAG],0		; 'destination not created'
 30136                                  NODCLOSE:
 30137 00003F58 803E[089C]00            	cmp	byte [Concat],0
 30138 00003F5D 740A                    	jz	short NOFLUSH
 30139                                  
 30140                                  ;	Concatenating - flush output between source files so LostErr
 30141                                  ;	stuff works correctly.
 30142                                  
 30143                                  	;invoke	FlshFil  ; MSDOS 6.0
 30144                                  	; 25/03/2023
 30145 00003F5F E81204                  	call	FlshFil
 30146                                  	;call	FLUSHFIL ; MSDOS 3.3
 30147                                  
 30148 00003F62 F606[199E]FF            	test	byte [MELCOPY],0FFh
 30149                                  	;jz	short NOFLUSH
 30150                                  	;jmp	short DOMELCOPY
 30151                                  	; 25/03/2023
 30152 00003F67 750D                    	jnz	short DOMELCOPY
 30153                                  NOFLUSH:
 30154 00003F69 E88100                  	call	SEARCHNEXT		; try next match
 30155 00003F6C 75A2                    	jnz	short NEXTSRCJ		; not found - finished with 
 30156                                  					;   this source spec
 30157 00003F6E C606[149C]00            	mov	byte [DestClosed],0	; 'destination not closed'
 30158 00003F73 E935FF                  	jmp	NEXTAMBIG		; do next ambig match
 30159                                  
 30160                                  DOMELCOPY:
 30161 00003F76 803E[199E]FF            	cmp	byte [MELCOPY],0FFh
 30162 00003F7B 740D                    	je	short CONTMEL
 30163 00003F7D 8B36[D29E]              	mov	si,[SRCPT]
 30164 00003F81 8936[1A9E]              	mov	[MELSTART],si
 30165 00003F85 C606[199E]FF            	mov	byte [MELCOPY],0FFh
 30166                                  
 30167                                  CONTMEL:
 30168 00003F8A 31ED                    	xor	bp,bp
 30169 00003F8C 8B36[D29E]              	mov	si,[SRCPT]
 30170                                  	;mov	bl,[PLUS_CHR]
 30171                                  	; 25/03/2023
 30172 00003F90 B32B                    	mov	bl,'+'
 30173                                  SCANSRC2:
 30174 00003F92 BF[7B9E]                	mov	di,ScanBuf
 30175 00003F95 E80F08                  	call	cparse
 30176 00003F98 F6C780                  	test	bh,80h
 30177 00003F9B 742F                    	jz	short NEXTMEL		; no "+" - go back to start
 30178 00003F9D F6C701                  	test	bh,1
 30179 00003FA0 75F0                    	jnz	short SCANSRC2		; switch - keep scanning
 30180 00003FA2 E863FE                  	call	SOURCEPROC
 30181 00003FA5 E87BE8                  	call	RestUDir1
 30182 00003FA8 BF[BA9C]                	mov	di,DESTFCB2
 30183 00003FAB B80029                  	mov	ax,Parse_File_Descriptor*256 ; 2900h
 30184 00003FAE CD21                    	int	21h		; DOS -	PARSE FILENAME
 30185                                  				; DS:SI	-> string to parse
 30186                                  				; ES:DI	-> buffer to fill with unopened	FCB
 30187                                  				; AL = bit mask	to control parsing
 30188 00003FB0 BB[809D]                	mov	bx,SDIRBUF+1
 30189 00003FB3 BE[BB9C]                	mov	si,DESTFCB2+1
 30190 00003FB6 8B3E[1E9E]              	mov	di,[SrcTail]
 30191                                  
 30192 00003FBA E83F06                  	call	BUILDNAME
 30193                                  
 30194 00003FBD 803E[089C]00            	cmp	byte [Concat],0
 30195 00003FC2 7405                    	je	short MELDOJ		; not concatenating - continue
 30196                                  
 30197                                  	;	Yes, turn off nowrite because this part of the code 
 30198                                  	;	is only reached after the first file has been dealt with.
 30199                                  
 30200 00003FC4 C606[D59E]00            	mov	byte [NOWRITE],0
 30201                                  MELDOJ:
 30202 00003FC9 E961FF                  	jmp	MELDO
 30203                                  	; 18/06/2023
 30204                                  ;NEXTSRCJ:
 30205                                  	;jmp	NEXTSRC
 30206                                  
 30207                                  NEXTMEL:
 30208 00003FCC E83A01                  	call	CLOSEDEST
 30209 00003FCF 31C0                    	xor	ax,ax
 30210 00003FD1 A2[139C]                	mov	[CFLAG],al
 30211 00003FD4 A3[199C]                	mov	[NXTADD],ax
 30212 00003FD7 A2[149C]                	mov	[SPECDRV],al
 30213 00003FDA 8B36[1A9E]              	mov	si,[MELSTART]
 30214 00003FDE 8936[D29E]              	mov	[SRCPT],si
 30215 00003FE2 E80800                  	call	SEARCHNEXT
 30216 00003FE5 7403                    	jz	short SETNMELJ
 30217 00003FE7 E9EAFD                  	jmp	ENDCOPY2
 30218                                  SETNMELJ:
 30219 00003FEA E9B3FE                  	jmp	SETNMEL
 30220                                  
 30221                                  ; ---------------------------------------------------------------------------
 30222                                  
 30223                                  SEARCHNEXT:
 30224 00003FED B412                    	mov	ah,Dir_Search_Next ; 12h
 30225 00003FEF F606[209E]02            	test	byte [SrcInfo],2
 30226 00003FF4 7503                    	jnz	short SEARCH		; do search-next if ambig
 30227 00003FF6 08E4                    	or	ah,ah			; reset zero flag
 30228 00003FF8 C3                      	retn
 30229                                  
 30230                                  ; ---------------------------------------------------------------------------
 30231                                  
 30232                                  SEARCH:
 30233 00003FF9 50                      	push	ax
 30234 00003FFA B41A                    	mov	ah,Set_DMA ; 1Ah
 30235 00003FFC BA[399D]                	mov	dx,DIRBUF	; put result of search in dirbuf
 30236 00003FFF CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 30237                                  			; DS:DX	-> disk	transfer buffer
 30238 00004001 58                      	pop	ax		; restore search first/next command
 30239 00004002 BA5C00                  	mov	dx,FCB ; 5Ch
 30240 00004005 CD21                    	int	21h		; Do the search
 30241 00004007 08C0                    	or	al,al
 30242 00004009 C3                      	retn
 30243                                  
 30244                                  ; ---------------------------------------------------------------------------
 30245                                  
 30246                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30247                                  
 30248                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30249                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4335h
 30250                                  
 30251                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 30252                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:41E9h
 30253                                  DOCOPY:
 30254 0000400A BE[219E]                	mov	si,SrcBuf	; do name translate of source
 30255 0000400D BF[2399]                	mov	di,SRCXNAME	; save for name comparison
 30256 00004010 B460                    	mov	ah,xNameTrans ; 60h
 30257                                  	;mov	ah,60h
 30258 00004012 CD21                    	int	21h	; DOS -	RESOLVE	PATH STRING TO CANONICAL PATH STRING
 30259                                  			; DS:SI	-> ASCIZ relative path string or directory name
 30260                                  			; ES:DI	-> 128-byte buffer for ASCIZ canonical fully qualified name
 30261 00004014 C606[069C]00            	mov	byte [RDEOF],0	; no EOF yet
 30262                                  
 30263                                  	; MSDOS 6.0
 30264                                  	;mov	ax,ExtOpen shl 8	; open the file
 30265                                  	; 26/03/2023
 30266 00004019 B8006C                  	mov	ax,6C00h
 30267                                  ;M046
 30268                                  ; For reads, the sharing mode should be deny none so that any process can
 30269                                  ;open this file again in any other sharing mode. This is mainly to allow
 30270                                  ;multiple command.com's to access the same file without getting sharing
 30271                                  ;violations
 30272                                  ;
 30273                                  	;mov	bx,deny_none|read_open_mode
 30274 0000401C BB4000                  	mov	bx,40h			; open mode for COPY ;M046
 30275 0000401F 31C9                    	xor	cx,cx			; no special files
 30276                                  	;mov	dx,read_open_flag	; set up open flags
 30277 00004021 BA0101                  	mov	dx,101h
 30278 00004024 CD21                    	int	21h
 30279                                  	; 26/03/2023
 30280 00004026 7230                    	jc	short Error_On_Source
 30281                                  	;jnc	short OPENOK
 30282                                  
 30283                                  	;	Bogosity: IBM wants us to issue Access Denied in this case.
 30284                                  	;	They asked for it...
 30285                                  
 30286                                  	;jmp	short Error_On_Source ;AC022; clean up and exit
 30287                                  
 30288                                  	; 26/03/2023
 30289                                  	; MSDOS 3.3
 30290                                  	;mov	dx,SRCBUF
 30291                                  	;mov	ax,OPEN*256 ; 3D00h
 30292                                  	;int	21h		; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 30293                                  	;			; DS:DX	-> ASCIZ filename
 30294                                  	;			; AL = access mode
 30295                                  	;			; 0 - read
 30296                                  	;jnc	short OPENOK
 30297                                  	;call	GET_EXT_ERR_NUMBER
 30298                                  	;pushf
 30299                                  	;cmp	ax,65
 30300                                  	;jnz	short DOCOPY_ERR
 30301                                  	;mov	dx,ACCDENPTR
 30302                                  	;call	STD_PRINTF
 30303                                  ;DOCOPY_ERR:
 30304                                  	;popf
 30305                                  	;retn
 30306                                  
 30307                                  	; 26/03/2023
 30308                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30309                                  OPENOK:
 30310 00004028 89C3                    	mov	bx,ax
 30311 0000402A 891E[789E]              	mov	[SRCHAND],bx		; save handle
 30312 0000402E B80057                  	mov	ax,File_Times*256 ; 5700h
 30313 00004031 CD21                    	int	21h		; DOS -	2+ - GET FILE'S DATE/TIME
 30314                                  				; BX = file handle
 30315                                  
 30316 00004033 7223                    	jc	short Error_On_Source ; MSDOS 6.0
 30317                                  
 30318 00004035 8916[DD9E]              	mov	[CPDATE],dx		; save date
 30319 00004039 890E[DF9E]              	mov	[CPTIME],cx		; save time
 30320                                  
 30321                                  	; MSDOS 6.0
 30322                                  	;jmp	short No_Copy_Xa 	; (xa copy code removed)
 30323                                  	; 26/04/2023
 30324                                  No_Copy_Xa:
 30325                                  	; 26/03/2023
 30326                                  	;mov	bx,[SRCHAND]		;AN022; get handle back
 30327                                  
 30328                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30329 0000403D B80044                  	mov	ax,(IOCTL<<8) ; 4400h
 30330 00004040 CD21                    	int	21h		; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 30331                                  				; BX = file or device handle
 30332                                  	;and	dl,devid_ISDEV ; 80h
 30333                                  	; 18/04/2023
 30334 00004042 80E280                  	and	dl,80h ; devid_ISDEV
 30335 00004045 8816[7A9E]              	mov	[SRCISDEV],dl		; set source info
 30336 00004049 7436                    	jz	short COPYLP		; source not a device
 30337 0000404B 803E[D69E]00            	cmp	byte [BINARY],0
 30338 00004050 742F                    	je	short COPYLP		; ascii device ok
 30339 00004052 BA[6091]                	mov	dx,INBDEV_PTR		; cannot do binary input
 30340 00004055 E96B04                  	jmp	COPYERR
 30341                                  
 30342                                  Error_On_Source:			;AN022; we have a BAD error
 30343 00004058 E8E0DF                  	call	Set_Ext_Error_Msg	;AN022; set up the error message
 30344 0000405B C706[A09D][219E]        	mov	word [string_ptr_2],SrcBuf
 30345                                  				;AN022; get address of failed string
 30346 00004061 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst ; 1
 30347                                  				;AN022; put number of subst in control block
 30348 00004066 E8B713                  	call	std_eprintf		;AN022; print it
 30349                                  	; 26/03/2023 - Retro DOS v4.0 COMMAND.COM
 30350 00004069 8B1E[789E]              	mov	bx,[SRCHAND]
 30351                                  	;cmp	word [SRCHAND],0	;AN022; did we open the file?
 30352                                  	;je	short No_Close_Src	;AN022; no - don't close
 30353 0000406D 09DB                    	or	bx,bx
 30354 0000406F 7403                    	jz	short No_Close_Src
 30355                                  	;call	CLOSESRC		;AN022; clean up
 30356                                  	; 26/03/2023
 30357 00004071 E89000                  	call	CLOSESRC2 ; bx = [SRCHAND]
 30358                                  No_Close_Src:				;AN022;
 30359 00004074 803E[139C]00            	cmp	byte [CFLAG],0		;AN022; was destination created?
 30360 00004079 7403                    	je	short EndCopyJ3		;AN022; no - just cleanup and exit
 30361 0000407B E953FD                  	jmp	ENDCOPY			;AN022; clean up concatenation and exit
 30362                                  EndCopyJ3:				;AN022;
 30363 0000407E E953FD                  	jmp	ENDCOPY2		;AN022;
 30364                                  
 30365                                  	; 26/04/2023
 30366                                  ;No_Copy_Xa:
 30367                                  ;	; 26/03/2023
 30368                                  ;	;mov	bx,[SRCHAND]		;AN022; get handle back
 30369                                  ;
 30370                                  ;	; MSDOS 3.3 (& MSDOS 6.0)
 30371                                  ;	mov	ax,(IOCTL<<8) ; 4400h
 30372                                  ;	int	21h		; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 30373                                  ;				; BX = file or device handle
 30374                                  ;	;and	dl,devid_ISDEV ; 80h
 30375                                  ;	; 18/04/2023
 30376                                  ;	and	dl,80h ; devid_ISDEV
 30377                                  ;	mov	[SRCISDEV],dl		; set source info
 30378                                  ;	jz	short COPYLP		; source not a device
 30379                                  ;	cmp	byte [BINARY],0
 30380                                  ;	je	short COPYLP		; ascii device ok
 30381                                  ;	mov	dx,INBDEV_PTR		; cannot do binary input
 30382                                  ;	jmp	COPYERR
 30383                                  
 30384                                  COPYLP:
 30385                                  	; 26/03/2023
 30386 00004081 8B1E[789E]              	mov	bx,[SRCHAND] ; ? ; 26/03/2023
 30387 00004085 8B0E[159C]              	mov	cx,[BYTCNT]
 30388 00004089 8B16[199C]              	mov	dx,[NXTADD]
 30389 0000408D 29D1                    	sub	cx,dx			; compute available space
 30390 0000408F 750E                    	jnz	short GOTROOM
 30391 00004091 E8E002                  	call	FlshFil   ; MSDOS 6.0
 30392                                  	;call	FLUSHFIL  ; MSDOS 3.3
 30393 00004094 803E[D99E]00            	cmp	byte [TERMREAD],0
 30394 00004099 7565                    	jne	short CLOSESRC		; give up
 30395 0000409B 8B0E[159C]              	mov	cx,[BYTCNT]
 30396                                  GOTROOM:
 30397 0000409F 1E                      	push	ds
 30398 000040A0 8E1E[F79B]              	mov	ds,[TPA]
 30399 000040A4 B43F                    	mov	ah,READ ; 3Fh
 30400 000040A6 CD21                    	int	21h		; DOS -	2+ - READ FROM FILE WITH HANDLE
 30401                                  				; BX = file handle,CX = number of bytes to read
 30402                                  				; DS:DX	-> buffer
 30403 000040A8 1F                      	pop	ds
 30404                                  	;jc	short CLOSESRC	; MSDOS 3.3
 30405                                  	; 26/03/2023
 30406 000040A9 72AD                    	jc	short Error_On_Source ; MSDOS 6.0
 30407 000040AB 89C1                    	mov	cx,ax			; get count
 30408 000040AD E351                    	jcxz	CLOSESRC		; no more to read
 30409 000040AF 803E[7A9E]00            	cmp	byte [SRCISDEV],0
 30410 000040B4 7507                    	jne	short NOTESTA		; is a device, ascii mode
 30411 000040B6 803E[DA9E]00            	cmp	byte [ASCII],0
 30412 000040BB 741B                    	je	short BINREAD
 30413                                  NOTESTA:
 30414 000040BD 89CA                    	mov	dx,cx
 30415 000040BF 8B3E[199C]              	mov	di,[NXTADD]
 30416 000040C3 B01A                    	mov	al,1Ah
 30417 000040C5 06                      	push	es
 30418 000040C6 8E06[F79B]              	mov	es,[TPA]		; scan for EOF
 30419 000040CA F2AE                    	repne	scasb
 30420 000040CC 07                      	pop	es
 30421 000040CD 7505                    	jnz	short USEALL
 30422 000040CF FE06[069C]              	inc	byte [RDEOF]
 30423 000040D3 41                      	inc	cx
 30424                                  USEALL:
 30425 000040D4 29CA                    	sub	dx,cx
 30426 000040D6 89D1                    	mov	cx,dx
 30427                                  BINREAD:
 30428 000040D8 030E[199C]              	add	cx,[NXTADD]
 30429 000040DC 890E[199C]              	mov	[NXTADD],cx
 30430 000040E0 3B0E[159C]              	cmp	cx,[BYTCNT]		; is buffer full?
 30431 000040E4 720C                    	jb	short TESTDEV		; if not, we may have found eof
 30432                                  	; 26/03/2023
 30433 000040E6 E88B02                  	call	FlshFil
 30434                                  	;call	FLUSHFIL
 30435 000040E9 803E[D99E]00            	cmp	byte [TERMREAD],0
 30436 000040EE 7510                    	jne	short CLOSESRC		; give up
 30437 000040F0 EB8F                    	jmp	short COPYLP
 30438                                  TESTDEV:
 30439 000040F2 803E[7A9E]00            	cmp	byte [SRCISDEV],0	; if file then EOF
 30440 000040F7 7407                    	je	short CLOSESRC
 30441 000040F9 803E[069C]00            	cmp	byte [RDEOF],0
 30442 000040FE 7481                    	je	short COPYLP		; on device, go till ^Z
 30443                                  CLOSESRC:
 30444 00004100 8B1E[789E]              	mov	bx,[SRCHAND]
 30445                                  CLOSESRC2:
 30446 00004104 B43E                    	mov	ah,CLOSE ; 3Eh
 30447 00004106 CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 30448                                  				; BX = file handle
 30449                                  CLOSESRCDEST_RETN:
 30450 00004108 C3                      	retn
 30451                                  
 30452                                  ; ---------------------------------------------------------------------------
 30453                                  
 30454                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30455                                  CLOSEDEST:
 30456                                  
 30457                                  	;	We are called to close the destination.
 30458                                  	;	We need to note whether or not there is any internal data left
 30459                                  	;	to be flushed out.
 30460                                  
 30461 00004109 803E[149C]00            	cmp	byte [DestClosed],0
 30462 0000410E 75F8                    	jne	short CLOSESRCDEST_RETN	; don't double close
 30463 00004110 A0[0F9C]                	mov	al,[DestSwitch]
 30464 00004113 E80904                  	call	SETASC			; check for b or a switch
 30465 00004116 742E                    	jz	short BINCLOS		;   on destination
 30466 00004118 8B1E[199C]              	mov	bx,[NXTADD]
 30467                                  ;
 30468                                  ;M048 -- TryFlush changes the state of ConCat flag. So, before we append a
 30469                                  ;^Z, let's always flush out. This way if the ConCat flag changes, we will
 30470                                  ;just return without appending a ^Z incorrectly for the first file (since we
 30471                                  ;are concatenating now). Also, in case it is a single file copy, we will
 30472                                  ;anyway write the ^Z out separately. The only drawback is that there is a
 30473                                  ;performance overhead on single ASCII file copies which now always involve
 30474                                  ;2 writes instead of 1 before. Is this really that important?
 30475                                  ;
 30476                                  ;M048;	cmp	bx,[BYTCNT]		; is memory full?
 30477                                  ;M048;	jne	short PutZ
 30478                                  
 30479                                  	; 26/03/2023
 30480                                  	; MSDOS 3.3
 30481                                  	;cmp	bx,[BYTCNT]		; is memory full?
 30482                                  	;jne	short PUTZ
 30483                                  
 30484                                  	; 26/03/2023
 30485 0000411C E84802                  	call	TRYFLUSH		; flush (and double-check for concat)	
 30486 0000411F 7402                    	jz	short NOCONC
 30487                                  CONCHNG:
 30488 00004121 F9                      	stc
 30489 00004122 C3                      	retn
 30490                                  
 30491                                  NOCONC:	
 30492 00004123 31DB                    	xor	bx,bx
 30493                                  PUTZ:
 30494 00004125 1E                      	push	ds
 30495 00004126 8E1E[F79B]              	mov	ds,[TPA]
 30496 0000412A C7071A00                	mov	word [bx],1Ah	; add EOF mark (ctrl-Z)
 30497 0000412E 1F                      	pop	ds
 30498 0000412F FF06[199C]              	inc	word [NXTADD]	; make sure our ^z gets written	
 30499 00004133 C606[D59E]00            	mov	byte [NOWRITE],0
 30500 00004138 A1[D79E]                	mov	ax,[WRITTEN]
 30501 0000413B 0306[199C]              	add	ax,[NXTADD]
 30502 0000413F 7205                    	jc	short BINCLOS	; > 1
 30503 00004141 83F801                  	cmp	ax,1
 30504 00004144 740C                    	je	short FORGETITJ	; Written = 0 NxtAdd = 1 (the ^Z)
 30505                                  BINCLOS:
 30506 00004146 E81E02                  	call	TRYFLUSH
 30507 00004149 75D6                    	jnz	short CONCHNG
 30508                                  
 30509                                  	; 26/04/2023
 30510 0000414B 833E[D79E]00            	cmp	word [WRITTEN],0
 30511                                  	; 26/03/2023
 30512 00004150 7503                    	jnz	short NO_FORGET
 30513                                  FORGETITJ:
 30514                                  	;jz	short FORGETIT	; never wrote nothing
 30515                                  	; 26/03/2023
 30516 00004152 E98500                  	jmp	FORGETIT ; 18/04/2023
 30517                                  NO_FORGET:			; wrote something
 30518 00004155 8B1E[159E]              	mov	bx,[DESTHAND]
 30519 00004159 8B0E[DF9E]              	mov	cx,[CPTIME]
 30520 0000415D 8B16[DD9E]              	mov	dx,[CPDATE]
 30521 00004161 803E[D49E]00            	cmp	byte [INEXACT],0 ; copy not exact?
 30522 00004166 7431                    	je	short DODCLOSE	; if no, copy date & time
 30523 00004168 B42C                    	mov	ah,Get_Time ; 2Ch
 30524 0000416A CD21                    	int	21h		; DOS -	GET CURRENT TIME
 30525                                  				; Return: CH = hours,CL = minutes,DH = seconds
 30526                                  				; DL = hundredths of seconds
 30527 0000416C D0E1                    	shl	cl,1
 30528 0000416E D0E1                    	shl	cl,1		; left justify min in cl
 30529 00004170 D1E1                    	shl	cx,1
 30530 00004172 D1E1                    	shl	cx,1
 30531 00004174 D1E1                    	shl	cx,1		; hours to high 5 bits, min to 5-10
 30532 00004176 D0EE                    	shr	dh,1		; divide seconds by 2 (now 5 bits)
 30533 00004178 08F1                    	or	cl,dh		; and stick into low 5 bits of cx
 30534 0000417A 51                      	push	cx		; save packed time
 30535 0000417B B42A                    	mov	ah,Get_Date ; 2Ah
 30536 0000417D CD21                    	int	21h		; DOS -	GET CURRENT DATE
 30537                                  				; Return: DL = day,DH = month,	CX = year
 30538                                  				; AL = day of the week (0=Sunday,1=Monday,etc.)
 30539 0000417F 81E9BC07                	sub	cx,1980
 30540 00004183 86CD                    	xchg	ch,cl
 30541 00004185 D1E1                    	shl	cx,1		; year to high 7 bits
 30542 00004187 D0E6                    	shl	dh,1		; month to high 3 bits
 30543 00004189 D0E6                    	shl	dh,1
 30544 0000418B D0E6                    	shl	dh,1
 30545 0000418D D0E6                    	shl	dh,1
 30546 0000418F D0E6                    	shl	dh,1		; most sig bit of month in carry
 30547 00004191 80D500                  	adc	ch,0		; put that bit next to year
 30548 00004194 08F2                    	or	dl,dh		; or low three of month into day
 30549 00004196 88EE                    	mov	dh,ch		; get year and high bit of month
 30550 00004198 59                      	pop	cx
 30551                                  DODCLOSE:
 30552 00004199 83FB00                  	cmp	bx,0
 30553 0000419C 7E36                    	jle	short CLOSEDONE
 30554 0000419E B80157                  	mov	ax,(File_Times<<8)|1 ; 5701h
 30555 000041A1 CD21                    	int	21h		; DOS -	2+ - SET FILE'S DATE/TIME
 30556                                  				; BX = file handle,CX = time to be set
 30557                                  				; DX = date to be set
 30558                                  	; 26/03/2023
 30559                                  	; MSDOS 6.0
 30560 000041A3 721A                    	jc	short Cleanup_Err ;AN022; handle error
 30561                                  
 30562                                  	;	See if the destination has *anything* in it.
 30563                                  	;	If not, just close and delete it.
 30564                                  
 30565 000041A5 B80242                  	mov	ax,(LSEEK<<8)+2 ; 4202h	; seek to EOF
 30566 000041A8 31D2                    	xor	dx,dx
 30567 000041AA 89D1                    	mov	cx,dx
 30568 000041AC CD21                    	int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 30569                                  			; AL = method: offset from end of file
 30570                                  	;	DX:AX is file size
 30571                                  
 30572 000041AE 09C2                    	or	dx,ax
 30573 000041B0 9C                      	pushf
 30574 000041B1 B80044                  	mov	ax,(IOCTL<<8)+0 ; 4400h	; get the destination attributes
 30575 000041B4 CD21                    	int	21h	; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 30576                                  			; BX = file or device handle
 30577 000041B6 52                      	push	dx		; save them away
 30578 000041B7 B43E                    	mov	ah,CLOSE ; 3Eh
 30579 000041B9 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 30580                                  			; BX = file handle
 30581 000041BB 5A                      	pop	dx
 30582                                  
 30583                                  	; 26/03/2023 - Retro DOS v4.0 COMMAND.COM
 30584                                  	; MSDOS 6.0
 30585 000041BC 730D                    	jnc	short Close_Cont ;AN022; handle error on close
 30586 000041BE 9D                      	popf			;AN022; get the flags back
 30587                                  Cleanup_Err: 			;AN022;
 30588 000041BF E86100                  	call	CleanUpErr	;AN022; attempt to delete the target
 30589                                  	; 26/03/2023
 30590                                  	;call	DestDelete	;AN022; attempt to delete the target
 30591                                  	;jmp	short FILECLOSED
 30592                                  	;			;AN022; close the file
 30593                                  	; 26/03/2023
 30594                                  DestDel_fclosed:
 30595 000041C2 E82700                  	call	DestDelete
 30596                                  FILECLOSED:
 30597 000041C5 FE06[149C]              	inc	byte [DestClosed]
 30598                                  RET50:
 30599 000041C9 F8                      	clc
 30600 000041CA C3                      	retn
 30601                                  	
 30602                                  Close_Cont:			;AN022; no error - co
 30603                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30604 000041CB 9D                      	popf
 30605 000041CC 7506                    	jnz	short CLOSEDONE
 30606 000041CE F7C28000                	test	dx,80h		; is the destination a device?
 30607                                  	;jnz	short CLOSEDONE	; yes, copy succeeded
 30608                                  	;call	DestDelete
 30609                                  	;jmp	short FILECLOSED
 30610                                  	; 26/03/2023
 30611 000041D2 74EE                    	jz	short DestDel_fclosed
 30612                                  CLOSEDONE:
 30613 000041D4 FF06[209C]              	inc	word [FileCnt]
 30614                                  	; 26/03/2023
 30615 000041D8 EBEB                    	jmp	short FILECLOSED
 30616                                  	
 30617                                  ;FILECLOSED:
 30618                                  ;	inc	byte [DestClosed]
 30619                                  ;RET50:
 30620                                  	;clc
 30621                                  	;retn
 30622                                  
 30623                                  FORGETIT:
 30624 000041DA 8B1E[159E]              	mov	bx,[DESTHAND]
 30625 000041DE E8B8FF                  	call	DODCLOSE	 ; close the dest
 30626 000041E1 E80800                  	call	DestDelete
 30627 000041E4 C706[209C]0000          	mov	word [FileCnt],0 ; no files transferred
 30628 000041EA EBDD                    	jmp	short RET50
 30629                                  
 30630                                  ; ---------------------------------------------------------------------------
 30631                                  
 30632                                  	; 26/03/2023
 30633                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 30634                                  DestDelete:
 30635                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 30636                                  %if 1
 30637 000041EC 803E[099C]01            	cmp	byte [notzerofile],1 ; destination file size > 0
 30638 000041F1 74D6                    	je	short RET50 	; yes, do not delete
 30639                                  %endif
 30640 000041F3 BA[BE9D]                	mov	dx,DestBuf
 30641 000041F6 B441                    	mov	ah,Unlink ; 41h
 30642 000041F8 CD21                    	int	21h	; DOS -	2+ - DELETE A FILE (UNLINK)
 30643                                  			; DS:DX	-> ASCIZ pathname of file to delete 
 30644                                  			;		(no wildcards allowed)
 30645 000041FA C3                      	retn
 30646                                  
 30647                                  ; ---------------------------------------------------------------------------
 30648                                  
 30649                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30650                                  SOURCE_SET:
 30651 000041FB 56                      	push	si
 30652 000041FC A1[F69E]                	mov	ax,[STARTEL]
 30653 000041FF BE[7B9E]                	mov	si,ScanBuf	; adjust to copy
 30654 00004202 29F0                    	sub	ax,si
 30655 00004204 BF[219E]                	mov	di,SrcBuf
 30656 00004207 01F8                    	add	ax,di
 30657 00004209 A3[1E9E]                	mov	[SrcTail],ax
 30658 0000420C 880E[1D9E]              	mov	[SrcSiz],cl	; save its size
 30659 00004210 41                      	inc	cx		; include the nul
 30660 00004211 F3A4                    	rep	movsb		; save this source
 30661 00004213 883E[209E]              	mov	[SrcInfo],bh	; save info about it
 30662 00004217 5E                      	pop	si
 30663 00004218 89E8                    	mov	ax,bp		; switches so far
 30664 0000421A E80203                  	call	SETASC		; set a,b switches accordingly
 30665 0000421D E824E9                  	call	SWITCH		; get any more switches on this arg
 30666                                  	;call	SETASC		; set
 30667                                  	;retn
 30668                                  	; 26/03/2023
 30669 00004220 E9FC02                  	jmp	SETASC
 30670                                  
 30671                                  ; =============== S U B	R O U T	I N E =======================================
 30672                                  
 30673                                  ; MSDOS 6.0
 30674                                  
 30675                                  ;****************************************************************
 30676                                  ;*
 30677                                  ;* ROUTINE:	CleanupErr
 30678                                  ;*
 30679                                  ;* FUNCTION:	Issues extended error message for destination
 30680                                  ;*		if not alreay issued
 30681                                  ;*
 30682                                  ;* INPUT:	return from INT 21
 30683                                  ;*
 30684                                  ;* OUTPUT:	none
 30685                                  ;*
 30686                                  ;****************************************************************
 30687                                  
 30688                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30689                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30690                                  	; MSDOS 6.0 (MSDOS 5.0) COMMAND.COM
 30691                                  CleanUpErr:	;proc near		;AN022;
 30692                                  
 30693 00004223 803E[339F]00            	cmp	byte [msg_flag],0	;AN022; have we already issued a message?
 30694 00004228 7511                    	jnz	short CleanupErr_Cont	;AN022; yes - don't issue duplicate error
 30695 0000422A E80EDE                  	call	Set_Ext_Error_Msg	;AN022; set up error message
 30696 0000422D C706[A09D][BE9D]        	mov	word [string_ptr_2],DestBuf 
 30697                                  					;AN022; get address of failed string
 30698 00004233 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst ; 1 
 30699                                  					;AN022; put number of subst in control block
 30700 00004238 E8E511                  	call	std_eprintf		;AN022; issue the error message
 30701                                  CleanupErr_Cont:			;AN022;
 30702                                  getansw_8:	; 12/06/2023
 30703 0000423B C3                      	retn				;AN022; return to caller
 30704                                  
 30705                                  ;CleanUpErr	endp			;AN022;
 30706                                  
 30707                                  
 30708                                  ; 12/06/2023
 30709                                  ; ---------------------------------------------------------------------------
 30710                                  ; MSDOS 6.2(2) COMMAND.COM procedure only !
 30711                                  ; -----------------------------------------
 30712                                  ; Hex-Rays IDA / disassembled source code ! modified for NASM by Erdogan Tan
 30713                                  ; ---------------------------------------------------------------------------
 30714                                  
 30715                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30716                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:456Dh
 30717                                  
 30718                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 30719                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:4427h
 30720                                  
 30721                                  get_answer_YNA:
 30722 0000423C C606[F29E]00            	mov	byte [cox_dest_file],0	; clear validation flag
 30723 00004241 B80043                  	mov	ax,4300h
 30724 00004244 BA[BE9D]                	mov	dx,DestBuf
 30725 00004247 CD21                    	int	21h		; DOS -	2+ - GET FILE ATTRIBUTES
 30726                                  				; DS:DX	-> ASCIZ file name or directory
 30727                                  				; name without trailing	slash
 30728                                  	;jnc	short getansw_1
 30729                                  	;jmp	getansw_5
 30730                                  	; 12/06/2023
 30731 00004249 F5                      	cmc
 30732 0000424A 73EF                    	jnc	short getansw_8 
 30733                                  getansw_1:
 30734 0000424C FE06[F29E]              	inc	byte [cox_dest_file]	; valid destination file
 30735 00004250 8D36[E69E]              	lea	si,cox_sublist_buff
 30736 00004254 C7040B00                	mov	word [si],11		; sublist size, 11 bytes
 30737 00004258 C74402[BE9D]            	mov	word [si+2],DestBuf	; sublist value	(pointer)
 30738 0000425D 8C5C04                  	mov	[si+4],ds		; sublist segment
 30739                                  	;mov	byte [si+6],1		; sub id (N of %N)
 30740 00004260 C6440710                	mov	byte [si+7],10h		; data type flags
 30741                                  	;mov	byte [si+8],0		; maximum length (chars)
 30742                                  	;mov	byte [si+9],0		; minimum length (chars)
 30743                                  	;mov	byte [si+10],0		; pad field character (0)
 30744                                  	; 12/06/2023
 30745 00004264 31C9                    	xor	cx,cx
 30746 00004266 894C08                  	mov	[si+8],cx ; 0
 30747 00004269 884C0A                  	mov	[si+10],cl ; 0
 30748 0000426C FEC1                    	inc	cl
 30749 0000426E 884C06                  	mov	[si+6],cl ; 1	
 30750                                  
 30751                                  	; 12/06/2023
 30752                                  	;lea	si,cox_sublist_buff
 30753 00004271 B84F04                  	mov	ax,1103			; message number
 30754                                  					; 'Overwrite %1 (Yes/No/All)?'
 30755 00004274 BB0200                  	mov	bx,2			; std error (file handle = 2)
 30756                                  	; 12/06/2023
 30757                                  	;mov	cx,1			; byte count
 30758                                  	; cx = 1
 30759                                  	;mov	dh,0FFh			; message class	(utility)
 30760                                  	;xor	dl,dl			; control flag = 0
 30761 00004277 31D2                    	xor	dx,dx
 30762 00004279 FECE                    	dec	dh  ; dh = 0FFh
 30763 0000427B E87514                  	call	SYSDISPMSG
 30764                                  	; 12/06/2023
 30765                                  	;xor	bx,bx
 30766                                  	; bh = 0
 30767                                  getansw_2:
 30768 0000427E B8080C                  	mov	ax,0C08h
 30769 00004281 CD21                    	int	21h		; DOS -	CLEAR KEYBOARD BUFFER
 30770                                  				; AL must be 01h, 06h, 07h, 08h, or 0Ah.
 30771                                  	;cmp	al,0
 30772                                  	;jz	short getansw_2
 30773                                  	; 12/06/2023
 30774 00004283 20C0                    	and	al,al
 30775 00004285 74F7                    	jz	short getansw_2
 30776 00004287 3C0D                    	cmp	al,0Dh
 30777 00004289 743B                    	je	short getansw_4
 30778 0000428B 88C3                    	mov	bl,al
 30779 0000428D 88C2                    	mov	dl,al
 30780 0000428F B82065                  	mov	ax,6520h
 30781 00004292 CD21                    	int	21h		; DOS -	4.x internal - COUNTRY-DEPENDENT FILENAME CAPITALIZATION
 30782                                  				; AL = function	-
 30783 00004294 3A16[8D6D]              	cmp	dl,[_Y_es]		; 'Y' ?
 30784 00004298 740C                    	je	short getansw_3
 30785 0000429A 3A16[8E6D]              	cmp	dl,[_N_o]		; 'N' ?
 30786 0000429E 7406                    	je	short getansw_3
 30787 000042A0 3A16[8F6D]              	cmp	dl,[_A_ll]		; 'A' ?
 30788 000042A4 75D8                    	jne	short getansw_2
 30789                                  getansw_3:
 30790 000042A6 88DF                    	mov	bh,bl
 30791 000042A8 53                      	push	bx
 30792 000042A9 881E[8C6D]              	mov	[MSG_1104],bl
 30793 000042AD B440                    	mov	ah,40h
 30794 000042AF BB0200                  	mov	bx,2			; std error (file handle = 2)
 30795 000042B2 B90100                  	mov	cx,1			; byte count
 30796 000042B5 BA[8C6D]                	mov	dx,MSG_1104
 30797 000042B8 CD21                    	int	21h		; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 30798                                  				; BX = file handle, CX = number	of bytes to write, DS:DX -> buffer
 30799 000042BA B440                    	mov	ah,40h
 30800 000042BC C606[8C6D]08            	mov	byte [MSG_1104],8	; backspace (move cursor to back)
 30801 000042C1 CD21                    	int	21h		; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 30802                                  				; BX = file handle, CX = number	of bytes to write, DS:DX -> buffer
 30803 000042C3 5B                      	pop	bx
 30804 000042C4 EBB8                    	jmp	short getansw_2
 30805                                  getansw_4:
 30806                                  	;cmp	bh,0
 30807                                  	;jz	short getansw_2
 30808                                  	; 12/06/2023
 30809 000042C6 08FF                    	or	bh,bh
 30810 000042C8 74B4                    	jz	short getansw_2
 30811 000042CA 88FA                    	mov	dl,bh
 30812 000042CC B82065                  	mov	ax,6520h
 30813 000042CF CD21                    	int	21h		; DOS -	4.x internal - COUNTRY-DEPENDENT FILENAME CAPITALIZATION
 30814                                  				; AL = function	-
 30815 000042D1 52                      	push	dx
 30816 000042D2 B82E04                  	mov	ax,1070			; message number
 30817 000042D5 BB0200                  	mov	bx,2			; std error (file handle = 2)
 30818 000042D8 31C9                    	xor	cx,cx
 30819                                  	;mov	dh,0FFh			; message class	(utility)
 30820                                  	;xor	dl,dl
 30821                                  	; 12/06/2023
 30822 000042DA 31D2                    	xor	dx,dx
 30823 000042DC FECE                    	dec	dh  ; dh = 0FFh
 30824 000042DE E81214                  	call	SYSDISPMSG
 30825 000042E1 5A                      	pop	dx
 30826 000042E2 3A16[8D6D]              	cmp	dl,[_Y_es]
 30827 000042E6 740B                    	jz	short getansw_5
 30828 000042E8 3A16[8E6D]              	cmp	dl,[_N_o]
 30829 000042EC 7406                    	jz	short getansw_6
 30830 000042EE C606[F19E]00            	mov	byte [cox_y_override],0
 30831                                  	; 12/06/2023
 30832                                  	;jmp	short $+2
 30833                                  getansw_5:
 30834                                  	; 12/06/2023
 30835                                  	;clc
 30836                                  	; cf = 0
 30837                                  	;jmp	short getansw_7
 30838                                  	; 12/06/2023
 30839 000042F3 C3                      	retn
 30840                                  getansw_6:
 30841                                  gcpcmdo_2:	; 12/06/2023
 30842                                  gecpcmd_3:	; 12/06/2023
 30843 000042F4 F9                      	stc
 30844                                  getansw_7:
 30845 000042F5 C3                      	retn
 30846                                  
 30847                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30848                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:463Ah
 30849                                  
 30850                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 30851                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:44F1h
 30852                                  init_copycmd_option:
 30853 000042F6 C606[F19E]01            	mov	byte [cox_y_override],1 ; suppress copy overwrite confirmation
 30854 000042FB 06                      	push	es
 30855 000042FC 8E06[F59B]              	mov	es,[RESSEG]
 30856                                  
 30857                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 30858                                  %if 1
 30859 00004300 26803E[FA01]63          	cmp	byte [es:cox_location],'c' ; "cox"
 30860 00004306 7520                    	jne	short icpcmd_1
 30861                                  %endif
 30862 00004308 268E06[3A04]            	mov	es,[es:EnvirSeg]
 30863 0000430D 8D36[7697]              	lea	si,copycmd		; "COPYCMD="
 30864 00004311 B90800                  	mov	cx,8
 30865 00004314 E83500                  	call	getenv_copycmd
 30866 00004317 7216                    	jc	short icpcmd_3
 30867 00004319 E82000                  	call	get_copycmd_option	; copycmd=/Y or copycmd=/-Y
 30868 0000431C 720F                    	jc	short icpcmd_2
 30869 0000431E 47                      	inc	di			; skip '/'
 30870 0000431F 268A05                  	mov	al,[es:di]
 30871 00004322 24DF                    	and	al,0DFh			; convert to uppercase
 30872 00004324 3C59                    	cmp	al,'Y'
 30873 00004326 7505                    	jnz	short icpcmd_2
 30874                                  icpcmd_1:
 30875 00004328 C606[F19E]00            	mov	byte [cox_y_override],0	; clear copy overwrite question/confirmation
 30876                                  					; (don't suppress)
 30877                                  icpcmd_2:
 30878 0000432D 07                      	pop	es
 30879 0000432E C3                      	retn
 30880                                  icpcmd_3:				; ...
 30881 0000432F 8E06[F59B]              	mov	es,[RESSEG]
 30882 00004333 803E[FD01]00            	cmp	byte [cox_Y_option],0	; default (/Y) switch option (1 = enabled)
 30883 00004338 74F3                    	jz	short icpcmd_2
 30884 0000433A EBEC                    	jmp	short icpcmd_1
 30885                                  
 30886                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30887                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4679h
 30888                                  
 30889                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 30890                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:4538h
 30891                                  get_copycmd_option:
 30892 0000433C 26803D00                	cmp	byte [es:di],0
 30893 00004340 74B2                    	jz	short gcpcmdo_2
 30894 00004342 26803D2F                	cmp	byte [es:di],'/'
 30895 00004346 7403                    	jz	short gcpcmdo_1
 30896 00004348 47                      	inc	di
 30897 00004349 EBF1                    	jmp	short get_copycmd_option
 30898                                  gcpcmdo_1:
 30899                                  	; 12/06/2023
 30900                                  	;clc
 30901                                  	; cf = 0
 30902                                  	;jmp	short gcpcmdo_3
 30903                                  	; 12/06/2023
 30904 0000434B C3                      	retn
 30905                                  	; 12/06/2023
 30906                                  ;gcpcmdo_2:
 30907                                  ;	stc
 30908                                  ;gcpcmdo_3:
 30909                                  ;	retn
 30910                                  
 30911                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30912                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:468Dh
 30913                                  
 30914                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 30915                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:454Bh
 30916                                  getenv_copycmd:
 30917 0000434C 31FF                    	xor	di,di
 30918 0000434E 30C0                    	xor	al,al
 30919                                  gecpcmd_1:
 30920                                  	;cmp	byte [es:di],0
 30921                                  	; 12/06/2023
 30922 00004350 263805                  	cmp	[es:di],al ; 0
 30923 00004353 749F                    	jz	short gecpcmd_3
 30924 00004355 51                      	push	cx
 30925 00004356 56                      	push	si
 30926 00004357 F3A6                    	repe	cmpsb
 30927 00004359 5E                      	pop	si
 30928 0000435A 59                      	pop	cx
 30929 0000435B 7409                    	jz	short gecpcmd_2 ; cf = 0
 30930 0000435D 51                      	push	cx
 30931 0000435E B90080                  	mov	cx,32768
 30932 00004361 F2AE                    	repne	scasb	; al = 0
 30933 00004363 59                      	pop	cx
 30934 00004364 EBEA                    	jmp	short gecpcmd_1
 30935                                  gecpcmd_2:
 30936                                  	;clc
 30937                                  	; 12/06/2023
 30938                                  	; cf = 0
 30939                                  	;jmp	short gecpcmd_4
 30940                                  	; 12/06/2023
 30941 00004366 C3                      	retn
 30942                                  	; 12/06/2023
 30943                                  ;gecpcmd_3:
 30944                                  ;	stc
 30945                                  ;gecpcmd_4:
 30946                                  ;	retn
 30947                                  
 30948                                  ;============================================================================
 30949                                  ; COPYPR1.ASM, MSDOS 6.0, 1991
 30950                                  ;============================================================================
 30951                                  ; 01/10/2018 - Retro DOS v3.0
 30952                                  
 30953                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2FBBh
 30954                                  
 30955                                  ; =============== S U B	R O U T	I N E =======================================
 30956                                  
 30957                                  ;***	TryFlush - flush copy buffer, double-check for concatenation
 30958                                  ;
 30959                                  ;	EXIT	ZR set if concatenate flag unchanged
 30960                                  
 30961                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30962                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3EEAh
 30963                                  
 30964                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30965                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:46ADh
 30966                                  
 30967                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 30968                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:456Ah
 30969                                  TRYFLUSH:
 30970 00004367 A0[089C]                	mov	al,[Concat]
 30971 0000436A 50                      	push	ax
 30972                                  	;call	FLUSHFIL
 30973 0000436B E80600                  	call	FlshFil
 30974 0000436E 58                      	pop	ax
 30975 0000436F 3A06[089C]              	cmp	al,[Concat]
 30976 00004373 C3                      	retn
 30977                                  
 30978                                  ; =============== S U B	R O U T	I N E =======================================
 30979                                  
 30980                                  	; 26/03/2023
 30981                                  	; MSDOS 3.3
 30982                                  ;FLUSHFIL:
 30983                                  	;mov	al,[BINARY]
 30984                                  	;mov	ah,[ASCII]
 30985                                  	;push	ax
 30986                                  	;call	FLSHFIL
 30987                                  	;pop	ax
 30988                                  	;mov	[ASCII],ah
 30989                                  	;mov	[BINARY],al
 30990                                  	;retn
 30991                                  
 30992                                  ; =============== S U B	R O U T	I N E =======================================
 30993                                  
 30994                                  ;***	Flshfil - write out any data remaining in copy buffer.
 30995                                  ;
 30996                                  ;	Inputs:
 30997                                  ;	  [NXTADD] = No. of bytes to write
 30998                                  ;	  [CFLAG] <> 0 if file has been created
 30999                                  ;	Outputs:
 31000                                  ;	  [NXTADD] = 0
 31001                                  
 31002                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31003                                  	;
 31004                                  	; 13/06/2023 - Retro DOS v4.2 COMMAND.COM
 31005                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:46BAh
 31006                                  	;
 31007                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 31008                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:4577h
 31009                                  FlshFil:
 31010 00004374 C606[D99E]00            	mov	byte [TERMREAD],0
 31011 00004379 803E[139C]00            	cmp	byte [CFLAG],0
 31012 0000437E 7403                    	jz	short NotExists
 31013 00004380 E99600                  	jmp	Exists
 31014                                  NotExists:
 31015 00004383 E8B301                  	call	BUILDDEST		; find out all about the destination
 31016 00004386 E80B04                  	call	COMPNAME		; source and dest. the same?
 31017 00004389 7519                    	jnz	short ProcDest		; if not, go ahead
 31018 0000438B 803E[7A9E]00            	cmp	byte [SRCISDEV],0
 31019 00004390 7512                    	jnz	short ProcDest		; same name on device ok
 31020 00004392 803E[089C]00            	cmp	byte [Concat],0		; concatenation?
 31021 00004397 BA[0390]                	mov	dx,OVERWR_PTR
 31022                                  	;je	short COPERR		; not concatenating - overwrite error
 31023                                  	; 26/03/2023
 31024 0000439A 7503                    	jne	short No_Concat_Err
 31025 0000439C E92401                  	jmp	COPYERR
 31026                                  	
 31027                                  No_Concat_Err:	; concatenating
 31028 0000439F C606[D59E]01            	mov	byte [NOWRITE],1 	; flag not writing (just seeking)
 31029                                  ProcDest:
 31030                                  	; MSDOS 6.0
 31031                                  	;mov	ax,(ExtOpen<<8)		; open the file
 31032                                  	; 26/03/2023
 31033 000043A4 B8006C                  	mov	ax,6C00h
 31034 000043A7 BE[BE9D]                	mov	si,DestBuf		; get file name
 31035                                  ;M046
 31036                                  ; For writes, we want to deny writes by anyone else at the same time that we
 31037                                  ;are writing to it. For instance, on a network, 2 workstations could try
 31038                                  ;writing to the same file. Also, because we opened the source file with
 31039                                  ;DENY NONE, it is fine if the source and destination files are the same as
 31040                                  ;would happen when we append to an existing file.
 31041                                  
 31042                                  	; 26/03/2023
 31043                                  	;mov	bx,deny_write|write_open_mode
 31044 000043AA BB2100                  	mov	bx,21h			; get open mode for copy; M046
 31045 000043AD 31C9                    	xor	cx,cx			; no special files
 31046                                  	;mov	dx,write_open_flag	; set up open flags
 31047 000043AF BA0101                  	mov	dx,101h	
 31048                                  
 31049 000043B2 803E[D59E]00            	cmp	byte [NOWRITE],0
 31050 000043B7 7503                    	jne	short DoDestOpen	; don't actually create if nowrite set
 31051                                  	;mov	dx,creat_open_flag	; set up create flags
 31052 000043B9 BA1201                  	mov	dx,112h
 31053                                  
 31054                                  	; 26/03/2023
 31055                                  	; MSDOS 3.3
 31056                                  	;mov	ax,(OPEN*256)+1 ; 3D01h ; open file, write access
 31057                                  	;cmp	byte [NOWRITE],0
 31058                                  	;jne	short DODESTOPEN
 31059                                  	;mov	ah,CREAT ; 3Ch
 31060                                  	;xor	cx,cx
 31061                                  ;DODESTOPEN:
 31062                                  	;mov	dx,DESTBUF
 31063                                  	;int	21h	; DOS -	2+ - CREATE A FILE WITH	HANDLE (CREAT)
 31064                                  	;		; CX = attributes for file
 31065                                  	;		; DS:DX	-> ASCIZ filename (may include drive and path)
 31066                                  
 31067                                  ; 26/03/2023
 31068                                  ;	; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 301Ch
 31069                                  ;	;mov	dx,FULDIRPTR
 31070                                  ;	;call	GET_EXT_ERR_NUMBER
 31071                                  ;	;jc	short COPERR
 31072                                  ;
 31073                                  ;	; 01/10/2018
 31074                                  ;	;jnc	short DEST_OPEN_OKAY
 31075                                  ;		
 31076                                  ;	;mov	dx,FULDIRPTR
 31077                                  ;	;call	GET_EXT_ERR_NUMBER
 31078                                  ;	;jmp	short COPERR
 31079                                  ;
 31080                                  ;	jc	short DEST_OPEN_ERROR
 31081                                  
 31082                                  	; 26/03/2023
 31083                                  DoDestOpen:
 31084 000043BC CD21                    	int     21h	; DOS - 4.0 - EXTENDED OPEN/CREATE
 31085                                  			; BL = open mode as in AL for normal open (INT 21h/AH=3Dh)
 31086                                  			; BH = flags
 31087                                  			; CX = create attribute
 31088                                  			; DL = action if file exists/does not exists
 31089                                  			; DH = 00h (reserved), DS:SI -> ASCIZ file name
 31090                                  
 31091                                  ;	We assume that the error is normal.
 31092                                  ;	TriageError will correct the DX value appropriately.
 31093                                  	
 31094 000043BE 7311                    	jnc	short Dest_Open_Okay
 31095                                  Xa_Set_Error:				;AN030; error occurred on XA
 31096 000043C0 E878DC                  	call	Set_Ext_Error_Msg	;AN030; get extended error
 31097                                  
 31098                                  	; 26/04/2023 - Retro DOS v4.0 ( 4.1) COMMAND.COM
 31099                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3F46h
 31100                                  Ext_Err_Set:				;AN030;
 31101 000043C3 C706[A09D][BE9D]        	mov	word [string_ptr_2],DestBuf
 31102                                  					;AN000; get address of failed string
 31103 000043C9 C606[D98F]01            	mov	byte [extend_buf_sub],one_subst ; 1 
 31104                                  					;AN030; put number of subst in control block
 31105                                  CopErrJ2:				;AN030;
 31106 000043CE E9F200                  	jmp	COPYERR			;AN030; go issue message
 31107                                  
 31108                                  ;DEST_OPEN_OKAY:
 31109                                  	; 26/03/2023
 31110                                  Dest_Open_Okay:
 31111 000043D1 A3[159E]                	mov	[DESTHAND],ax		; save handle
 31112 000043D4 C606[139C]01            	mov	byte [CFLAG],1		; destination now exists
 31113 000043D9 89C3                    	mov	bx,ax
 31114 000043DB B80044                  	mov	ax,IOCTL*256 ; 4400h 	; get device stuff
 31115 000043DE CD21                    	int	21h	   	; DOS - 2+ - IOCTL - GET DEVICE INFORMATION
 31116                                  			   	; BX = file or device handle
 31117                                  
 31118 000043E0 8816[179E]              	mov	[DESTISDEV],dl		; set dest info
 31119                                  	; 18/04/2023
 31120 000043E4 F6C280                  	test	dl,80h
 31121                                  	;test	dl,devid_ISDEV
 31122 000043E7 7430                    	jz	short Exists		; Dest not a device
 31123                                  
 31124                                  ;	Destination is device.
 31125                                  
 31126 000043E9 A0[0F9C]                	mov	al,[DestSwitch]
 31127                                  	; 26/03/2023
 31128 000043EC 240C                    	and	al,0Ch
 31129                                  	;and	al,SWITCHA+SWITCHB ; 4+8
 31130 000043EE 7509                    	jnz	short TestBoth
 31131 000043F0 A0[DA9E]                	mov	al,[ASCII]		; neither set, use current setting
 31132 000043F3 0A06[D69E]              	or	al,[BINARY]
 31133 000043F7 7416                    	jz	short ExSetA		; neither set, default to ascii
 31134                                  TestBoth:
 31135 000043F9 7A1E                    	jpe	short Exists		; both are set, ignore
 31136 000043FB A808                    	test	al,8
 31137                                  	;test	al,SWITCHB
 31138 000043FD 741A                    	jz	short Exists
 31139                                  	;mov	ax,(IOCTL shl 8) or 1
 31140 000043FF B80144                  	mov	ax,(IOCTL<<8)|1 ; 4401h
 31141 00004402 30F6                    	xor	dh,dh
 31142                                  	; 18/04/2023
 31143 00004404 80CA20                  	or	dl,20h
 31144                                  	;or	dl,devid_RAW
 31145 00004407 8816[179E]              	mov	[DESTISDEV],dl
 31146 0000440B CD21                    	int	21h	; DOS -	2+ - IOCTL - SET DEVICE	INFORMATION
 31147                                  			; BX = device handle,DH = 0
 31148                                  			; DL = device information to set (bits 0-7 from	function 0)
 31149 0000440D EB0A                    	jmp	short Exists
 31150                                  
 31151                                  	; 26/03/2023
 31152                                  	; 01/10/2018 - Retro DOS v3.0 modification
 31153                                  ;DEST_OPEN_ERROR:
 31154                                  	;mov	dx,FULDIRPTR
 31155                                  	;call	GET_EXT_ERR_NUMBER
 31156                                  ;COPERR:
 31157                                  	; 26/03/2023
 31158                                  ;CopyErrj:
 31159                                  	;jmp	short COPYERR
 31160                                  
 31161                                  ExSetA:
 31162                                  ;	What we read in may have been in binary mode, flag zapped write OK
 31163                                  
 31164 0000440F C606[DA9E]04            	mov	byte [ASCII],4
 31165                                  	;mov	byte [ASCII],SWITCHA	; set ascii mode
 31166 00004414 800E[D49E]04            	or	byte [INEXACT],4
 31167                                  	;or	byte [INEXACT],SWITCHA	; ascii -> inexact
 31168                                  Exists:
 31169 00004419 803E[D59E]00            	cmp	byte [NOWRITE],0
 31170 0000441E 7524                    	jnz	short NoChecking	; if nowrite don't bother with name check
 31171 00004420 803E[969D]01            	cmp	byte [plus_comma],1	; don't check if just doing +,,
 31172 00004425 741D                    	jz	short NoChecking
 31173 00004427 E86A03                  	call	COMPNAME		; source and dest. the same?
 31174 0000442A 7518                    	jnz	short NoChecking	; if not, go ahead
 31175 0000442C 803E[7A9E]00            	cmp	byte [SRCISDEV],0
 31176 00004431 7511                    	jne	short NoChecking	; same name on device ok
 31177                                  
 31178                                  ;	At this point we know in append (would have gotten overwrite error
 31179                                  ;	on first destination create otherwise), and user trying to specify
 31180                                  ;	destination which has been scribbled already (if dest had been named
 31181                                  ;	first, NoWrite would be set).
 31182                                  
 31183 00004433 BA[0690]                	mov	dx,LOSTERR_PTR		; tell him he's not going to get it
 31184                                  	;invoke	Std_EprintF		;ac022;
 31185                                  	; 26/03/2023
 31186 00004436 E8E70F                  	call	std_eprintf ; MSDOS 6.0 (& 5.0)
 31187                                  	;call	STD_PRINTF  ; MSDOS 3.3	
 31188 00004439 C706[199C]0000          	mov	word [NXTADD],0		; set return
 31189 0000443F FE06[D99E]              	inc	byte [TERMREAD]		; tell read to give up
 31190                                  Ret60:
 31191 00004443 C3                      	retn
 31192                                  
 31193                                  NoChecking:
 31194 00004444 8B1E[159E]              	mov	bx,[DESTHAND]		; get handle
 31195 00004448 31C9                    	xor	cx,cx
 31196 0000444A 870E[199C]              	xchg	cx,[NXTADD]
 31197 0000444E E3F3                    	jcxz	Ret60			; if nothing to write, forget it
 31198 00004450 FF06[D79E]              	inc	word [WRITTEN]		; flag that we wrote something
 31199 00004454 803E[D59E]00            	cmp	byte [NOWRITE],0	; if nowrite set, just seek cx bytes
 31200 00004459 7514                    	jnz	short SeekEnd
 31201 0000445B 31D2                    	xor	dx,dx
 31202 0000445D 1E                      	push	ds
 31203 0000445E 8E1E[F79B]              	mov	ds,[TPA]
 31204 00004462 B440                    	mov	ah,Write ; 40h
 31205 00004464 CD21                    	int	21h	; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 31206                                  			; BX = file handle,CX = number of bytes to write,DS:DX -> buffer
 31207 00004466 1F                      	pop	ds
 31208 00004467 BA[EB8F]                	mov	dx,NOSPACE_PTR
 31209                                  	;jc	short COPERRP		; failure
 31210                                  	; 26/03/2023
 31211                                  	; MSDOS 6.0
 31212 0000446A 7338                    	jnc	short NoChecking2
 31213 0000446C E951FF                  	jmp	Xa_Set_Error
 31214                                  
 31215                                  	; 18/04/2023
 31216                                  	; 26/03/2023
 31217                                  SeekEnd:
 31218 0000446F 31D2                    	xor	dx,dx
 31219 00004471 87CA                    	xchg	dx,cx
 31220                                  	;mov	ax,(LSEEK shl 8) or 1
 31221 00004473 B80142                  	mov	ax,(LSEEK<<8)|1 ; 4201h
 31222 00004476 CD21                    	int	21h		; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 31223                                  				; AL = method: offset from present location
 31224                                  
 31225                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 31226                                  %if 1
 31227 00004478 C606[099C]01            	mov	byte [notzerofile],1 ; (existing) destination file size is not zero
 31228 0000447D 85C0                    	test	ax,ax
 31229 0000447F 7509                    	jnz	short SeekEnd_@
 31230 00004481 85D2                    	test	dx,dx
 31231 00004483 7505                    	jnz	short SeekEnd_@
 31232 00004485 C606[099C]00            	mov	byte [notzerofile],0 ; (existing) destination file size is zero
 31233                                  SeekEnd_@:
 31234                                  %endif
 31235                                  	; 26/03/2023
 31236                                  	; MSDOS 6.0
 31237                                  
 31238                                  ;	Save the file pointer in DX:AX to restore the file
 31239                                  ;	with in case the copy should fail.
 31240                                  
 31241 0000448A A3[E19E]                	mov	[OFilePtr_Lo],ax
 31242 0000448D 8916[E39E]              	mov	[OFilePtr_Hi],dx
 31243                                  
 31244                                  	; 26/03/2023
 31245                                  	; MSDOS 3.3  MSDOS 6.0
 31246                                  
 31247 00004491 803E[069C]00            	cmp	byte [RDEOF],0
 31248 00004496 740B                    	jz	short Retz60
 31249                                  
 31250                                  ;	^Z has been read - we must set the file size to the current
 31251                                  ;	file pointer location
 31252                                  
 31253 00004498 B440                    	mov	ah,Write ; 40h
 31254 0000449A CD21                    	int	21h		; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 31255                                  				; BX = file handle,CX = number	of bytes to write,DS:DX -> buffer
 31256                                  
 31257                                  	; 26/03/2023
 31258                                  	; MSDOS 6.0
 31259 0000449C 727E                    	jc	short Xa_Set_Error_Jmp	;AC022; failure
 31260                                  
 31261                                  ;	Make note that ^Z was removed, in case the
 31262                                  ;	copy should fail and we need to restore the file.
 31263                                  
 31264 0000449E C606[E59E]1A            	mov	byte [OCtrlZ],1Ah
 31265                                  Retz60:
 31266 000044A3 C3                      	retn
 31267                                  
 31268                                  NoChecking2:
 31269 000044A4 29C1                    	sub	cx,ax
 31270 000044A6 749B                    	jz	short Ret60		; wrote all supposed to
 31271                                  	; 18/04/2023
 31272 000044A8 F606[179E]80            	test	byte [DESTISDEV],80h ; devid_ISDEV
 31273                                  	;test	byte [DESTISDEV],devid_ISDEV ;80h
 31274 000044AD 7414                    	jz	short COPYERR		; is a file, error
 31275 000044AF F606[179E]20            	test	byte [DESTISDEV],20h  ; devid_RAW
 31276                                  	;test	byte [DESTISDEV],devid_RAW ; 20h
 31277 000044B4 750A                    	jnz	short DevWrtErr	; is a raw device, error
 31278 000044B6 803E[D49E]00            	cmp	byte [INEXACT],0
 31279 000044BB 7586                    	jnz	short Ret60		; inexact so ok
 31280 000044BD 49                      	dec	cx
 31281                                  ;Retz60:
 31282 000044BE 7483                    	jz	short Ret60		; wrote one byte less (the ^z)
 31283                                  
 31284                                  DevWrtErr:
 31285 000044C0 BA[9391]                	mov	dx,DEVWMES_PTR
 31286                                  	; 26/03/2023
 31287                                  COPYERR:
 31288                                  	;invoke	Std_EPrintF		;AC022;
 31289 000044C3 E85A0F                  	call	std_eprintf  ; MSDOS 6.0
 31290                                  	;call	STD_PRINTF   ; MSDOS 3.3
 31291                                  CopErrP:
 31292 000044C6 FE06[149C]              	inc	byte [DestClosed]
 31293 000044CA 803E[139C]00            	cmp	byte [CFLAG],0
 31294 000044CF 7448                    	jz	short EndCopyJ		; never actually got it open
 31295 000044D1 8B1E[159E]              	mov	bx,[DESTHAND]
 31296 000044D5 83FB00                  	cmp	bx,0
 31297 000044D8 7E33                    	jle	short NoClose
 31298                                  
 31299                                  ;	Check to see if we should save part of the destination file.
 31300                                  
 31301                                  	; 26/03/2023
 31302                                  	; MSDOS 6.0
 31303 000044DA 8B0E[E39E]              	mov	cx,[OFilePtr_Hi]	; CX = hi word of original file ptr
 31304 000044DE 8B16[E19E]              	mov	dx,[OFilePtr_Lo]	; DX = lo word of original file ptr
 31305                                  			
 31306 000044E2 89C8                    	mov	ax,cx
 31307 000044E4 09D0                    	or	ax,dx
 31308 000044E6 7421                    	jz	short ceClose		; null file ptr means nothing to save
 31309                                  
 31310                                  ;	Destination was also the first source. Do the best we can to
 31311                                  ;	restore it. Truncate it back to the size we took from it (which
 31312                                  ;	may have been due to a Ctrl-Z, so may not have included the whole
 31313                                  ;	file). If a Ctrl-Z was originally read, put it back.
 31314                                  
 31315 000044E8 B80042                  	mov	ax,(LSEEK<<8) ; 4200h
 31316 000044EB CD21                    	int	21h
 31317                                  
 31318 000044ED 31C9                    	xor	cx,cx			; CX = # bytes to write = 0
 31319 000044EF B440                    	mov	ah,Write ; 40h
 31320 000044F1 CD21                    	int	21h			; truncate file
 31321                                  
 31322 000044F3 803E[E59E]00            	cmp	byte [OCtrlZ],0
 31323 000044F8 7408                    	je	short ceClose0		; no ctrl-z removed from original
 31324 000044FA 41                      	inc	cx			; CX = # bytes to write = 1
 31325 000044FB BA[E59E]                	mov	dx,OCtrlZ		; DS:DX = ptr to original ctrl-z
 31326 000044FE B440                    	mov	ah,Write ; 40h
 31327 00004500 CD21                    	int	21h			; write ctrl-z
 31328                                  ceClose0:
 31329 00004502 B43E                    	mov	ah,CLOSE ; 3Eh
 31330 00004504 CD21                    	int	21h			; close it
 31331                                  ;;	;mov	byte [CFLAG],0
 31332 00004506 E9C8F8                  	jmp	ENDCOPY			; and go home
 31333                                  
 31334                                  	; MSDOS 3.3 (& MSDOS 6.0)
 31335                                  ceClose:
 31336 00004509 B43E                    	mov	ah,CLOSE ; 3Eh		; close the file
 31337 0000450B CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 31338                                  				; BX = file handle
 31339                                  NoClose:
 31340 0000450D BA[BE9D]                	mov	dx,DestBuf
 31341 00004510 B441                    	mov	ah,Unlink ; 41h 	; and delete it
 31342 00004512 CD21                    	int	21h		; DOS -	2+ - DELETE A FILE (UNLINK)
 31343                                  				; DS:DX	-> ASCIZ pathname of file to delete (no	wildcards allowed)
 31344 00004514 C606[139C]00            	mov	byte [CFLAG],0
 31345                                  EndCopyJ:
 31346 00004519 E9B5F8                  	jmp	ENDCOPY
 31347                                  
 31348                                  Xa_Set_Error_Jmp:			;AN022; go set up error message
 31349 0000451C E9A1FE                  	jmp	Xa_Set_Error
 31350                                  
 31351                                  ;============================================================================
 31352                                  ; COPYPR2.ASM, MSDOS 6.0, 1991
 31353                                  ;============================================================================
 31354                                  ; 01/10/2018 - Retro DOS v3.0
 31355                                  
 31356                                  ; MSDOS 3.3 COMMAND.COM (1987) Transient portion offset 311Fh
 31357                                  
 31358                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31359                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4095h
 31360                                  
 31361                                  ; =============== S U B	R O U T	I N E =======================================
 31362                                  
 31363                                  ;***	SetAsc - set Ascii, Binary, Inexact flags based on switches
 31364                                  ;
 31365                                  ;	Given switch vector in AX,
 31366                                  ;	  Set Ascii flag if /a is set
 31367                                  ;	  Clear Ascii flag if /b is set
 31368                                  ;	  Binary set if /b specified
 31369                                  ;	  Leave Ascii unchanged if neither or both are set
 31370                                  ; 	Also sets Inexact if Ascii is ever set. 
 31371                                  ;	AL = Ascii on exit, flags set
 31372                                  
 31373                                  	; 26/03/2023
 31374                                  SETASC:
 31375                                  	;and	al,SWITCHA+SWITCHB ; 0Ch ; AL = /a, /b flags
 31376 0000451F 240C                    	and	al,0Ch ; 4+8
 31377 00004521 7A10                    	jpe	short LOADSW	; even parity - both or neither
 31378 00004523 50                      	push	ax
 31379                                  	;and	al,SWITCHB  ; 8
 31380 00004524 2408                    	and	al,8
 31381 00004526 A2[D69E]                	mov	[BINARY],al
 31382 00004529 58                      	pop	ax
 31383                                  	;and	al,SWITCHA
 31384 0000452A 2404                    	and	al,4	
 31385 0000452C A2[DA9E]                	mov	[ASCII],al
 31386 0000452F 0806[D49E]              	or	[INEXACT],al
 31387                                  LOADSW:
 31388 00004533 A0[DA9E]                	mov	al,[ASCII]
 31389 00004536 08C0                    	or	al,al
 31390 00004538 C3                      	retn
 31391                                  
 31392                                  ; =============== S U B	R O U T	I N E =======================================
 31393                                  
 31394                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31395                                  	; 13/06/2023 - Retro DOS v4.2 COMMAND.COM
 31396                                  	; 10/08/2024 - Retro DOS v5.0 COMMAND.COM
 31397                                  BUILDDEST:
 31398 00004539 803E[B99D]FF            	cmp	byte [DestIsDir],-1 ; 0FFh
 31399 0000453E 750F                    	jnz	short KNOWABOUTDEST	; figuring already done
 31400 00004540 BF[D79A]                	mov	di,USERDIR1
 31401 00004543 BD[B99D]                	mov	bp,DestVars
 31402                                  
 31403                                  ; 10/08/2024 - PCDOS 7.1 COMMAND.COM
 31404                                  %if 1
 31405                                  	;mov	bx,deny_none|write_open_mode
 31406 00004546 BB4100                  	mov	bx,41h			; open mode for COPY ;M046
 31407                                  %endif
 31408                                  
 31409 00004549 E8DF00                  	call	BUILDPATH
 31410 0000454C E8D4E2                  	call	RestUDir1
 31411                                  
 31412                                  ;	We now know all about the destination
 31413                                  
 31414                                  KNOWABOUTDEST:
 31415 0000454F 30C0                    	xor	al,al
 31416 00004551 8606[189E]              	xchg	al,[FIRSTDEST]
 31417 00004555 08C0                    	or	al,al
 31418 00004557 7503                    	jnz	short FIRSTDST
 31419 00004559 E98C00                  	jmp	NOFIRSTDEST
 31420                                  
 31421                                  FIRSTDST:
 31422                                  ;	Create an fcb of the original dest.
 31423                                  
 31424 0000455C 8B36[BB9D]              	mov	si,[DestTail]
 31425 00004560 BF[F69C]                	mov	di,DestFcb
 31426 00004563 B80029                  	mov	ax,Parse_File_Descriptor*256 ; 2900h
 31427 00004566 CD21                    	int	21h		; DOS -	PARSE FILENAME
 31428                                  				; DS:SI	-> string to parse
 31429                                  				; ES:DI	-> buffer to fill with unopened	FCB
 31430                                  				; AL = bit mask	to control parsing
 31431 00004568 803C00                  	cmp	byte [si],0
 31432 0000456B 7406                    	jz	short GOODPARSE
 31433                                  
 31434                                  	; 27/03/2023	
 31435                                  	; MSDOS 6.0
 31436                                  	;mov	byte [di+1],"|"	;AD052; must be illegal file name character
 31437                                  	
 31438 0000456D BA[F18F]                	mov	dx,FULLDIR_PTR		;AN052; issue "file creation error"
 31439 00004570 E950FF                  	jmp	COPYERR			;AN052;
 31440                                  GOODPARSE:
 31441 00004573 A1[BE9D]                	mov	ax,[DestBuf]		; AX = possible "d:"
 31442 00004576 80FC3A                  	cmp	ah,':'
 31443 00004579 7402                    	jz	short DRVSPEC4
 31444 0000457B B040                    	mov	al,'@'  ; 40h
 31445                                  DRVSPEC4:
 31446                                  ;	AX = "d:" for following FCB drive computation
 31447                                  
 31448 0000457D 8A0E[DA9E]              	mov	cl,[ASCII]		; CL = saved Ascii flag
 31449 00004581 0C20                    	or	al,20h
 31450 00004583 2C60                    	sub	al,60h
 31451 00004585 A2[F69C]                	mov	[DestFcb],al		; store drive # in FCB
 31452                                  
 31453                                  ;*	Figure out what copy mode we're in.
 31454                                  ;	Letters stand for unambiguous, * for ambiguous pathnames.
 31455                                  ;	+n stands for additional sources delimited by +'s.
 31456                                  ;
 31457                                  ;	copy a b	not concatenating
 31458                                  ;	copy a *	not concatenating
 31459                                  ;	copy * a	concatenating
 31460                                  ;	copy * *	not concatenating
 31461                                  ;	copy a+n b	concatenating
 31462                                  ;	copy *+n a	concatenating
 31463                                  ;	copy *+n *	concatenating, Mel Hallerman style
 31464                                  
 31465                                  ;	Bugbug:  copy *.a+a.b *.t  picks up only 1st *.a file.. Why?
 31466                                  ;		 copy a.b+*.a *.t  picks up all *.a files.
 31467                                  
 31468 00004588 A0[BD9D]                	mov	al,[DestInfo]		; AL = destination CParse flags
 31469 0000458B 8A26[209E]              	mov	ah,[SrcInfo]		; AH = source CParse flags
 31470 0000458F 250202                  	and	ax,202h			; AH,AL = source,dest wildcard flags
 31471 00004592 08C0                    	or	al,al
 31472 00004594 7413                    	jz	short NOTMELCOPY 	; no destination wildcard
 31473                                  
 31474                                  ;	Destination is wildcarded.
 31475                                  	
 31476 00004596 38E0                    	cmp	al,ah
 31477 00004598 750F                    	jnz	short NOTMELCOPY ; no source wildcard
 31478                                  
 31479                                  ;	Source and destination are both wildcarded.
 31480                                  
 31481 0000459A 803E[DB9E]00            	cmp	byte [PLUS],0
 31482 0000459F 7408                    	jz	short NOTMELCOPY	; no +'s in source
 31483                                  
 31484                                  ;	Source and destination are wildcarded, and source includes +'s.
 31485                                  ;	It's Mel Hallorman copy time.
 31486                                  
 31487 000045A1 FE06[199E]              	inc	byte [MELCOPY]		; 'Mel copy' = true
 31488 000045A5 30C0                    	xor	al,al
 31489 000045A7 EB06                    	jmp	short SETCONC
 31490                                  
 31491                                  NOTMELCOPY:
 31492 000045A9 3402                    	xor	al,2			; AL=0 -> ambiguous destination, 2 otherwise
 31493 000045AB 20E0                    	and	al,ah
 31494 000045AD D0E8                    	shr	al,1			; AL=1 -> ambiguous source, unambiguous dest
 31495                                  					;   (implies concatenation)
 31496                                  SETCONC:
 31497 000045AF 0A06[DB9E]              	or	al,[PLUS]		; "+" always infers concatenation
 31498                                  
 31499                                  ;	Whew. AL = 1 if concatenating, 0 if not.
 31500                                  
 31501 000045B3 A2[089C]                	mov	[Concat],al
 31502 000045B6 D0E0                    	shl	al,1
 31503 000045B8 D0E0                    	shl	al,1
 31504 000045BA A2[D49E]                	mov	[INEXACT],al		; concatenation -> inexact copy
 31505 000045BD 803E[D69E]00            	cmp	byte [BINARY],0
 31506 000045C2 7524                    	jne	short NOFIRSTDEST 	; explicit binary copy
 31507                                  
 31508                                  	; 13/06/2023 - Retro DOS v4.2 COMMAND.COM
 31509                                  	; MSDOS 6.0 (MSDOS 5.0)
 31510                                  	;mov	[ASCII],al		; otherwise, concatenate in ascii mode
 31511                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:48FAh
 31512                                  	;or	[ASCII],al
 31513                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 31514                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:47C5h  
 31515 000045C4 A2[DA9E]                	mov	[ASCII],al
 31516                                  
 31517 000045C7 08C9                    	or	cl,cl
 31518 000045C9 751D                    	jnz	short NOFIRSTDEST 	; Ascii flag set before, data read correctly
 31519 000045CB 08C0                    	or	al,al
 31520 000045CD 7419                    	jz	short NOFIRSTDEST 	; Ascii flag did not change state
 31521                                  
 31522                                  ;	At this point there may already be binary read data in the read
 31523                                  ;	buffer. We need to find the first ^Z (if there is one) and trim the
 31524                                  ;	amount of data in the buffer correctly.
 31525                                  
 31526 000045CF 8B0E[199C]              	mov	cx,[NXTADD]
 31527 000045D3 E313                    	jcxz	NOFIRSTDEST		; no data, everything ok
 31528 000045D5 B01A                    	mov	al,1Ah
 31529 000045D7 06                      	push	es
 31530 000045D8 31FF                    	xor	di,di
 31531 000045DA 8E06[F79B]              	mov	es,[TPA]
 31532 000045DE F2AE                    	repne	scasb			; scan for EOF
 31533 000045E0 07                      	pop	es
 31534 000045E1 7505                    	jnz	short NOFIRSTDEST 	; no ^z in buffer, everything ok
 31535 000045E3 4F                      	dec	di			; point at ^z
 31536 000045E4 893E[199C]              	mov	[NXTADD],di		; new buffer length
 31537                                  
 31538                                  NOFIRSTDEST:
 31539 000045E8 BB[3A9D]                	mov	bx,DIRBUF+1		; Source of replacement chars
 31540 000045EB 803E[089C]00            	cmp	byte [Concat],0
 31541 000045F0 7403                    	jz	short GOTCHRSRC		; Not a concat
 31542 000045F2 BB[809D]                	mov	bx,SDIRBUF+1		; Source of replacement chars
 31543                                  GOTCHRSRC:
 31544 000045F5 BE[F79C]                	mov	si,DestFcb+1		; Original dest name
 31545 000045F8 8B3E[BB9D]              	mov	di,[DestTail]		; Where to put result
 31546                                  
 31547                                  ; --------------- S U B	R O U T	I N E --------------------------------------- 
 31548                                  
 31549                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31550                                  BUILDNAME:
 31551 000045FC B90800                  	mov	cx,8
 31552                                  BUILDMAIN:
 31553 000045FF AC                      	lodsb
 31554 00004600 3C3F                    	cmp	al,'?'
 31555 00004602 7502                    	jne	short NOTAMBIG
 31556 00004604 8A07                    	mov	al,[bx]
 31557                                  NOTAMBIG:
 31558 00004606 3C20                    	cmp	al,' '
 31559 00004608 7401                    	je	short NOSTORE
 31560 0000460A AA                      	stosb
 31561                                  NOSTORE:
 31562 0000460B 43                      	inc	bx
 31563 0000460C E2F1                    	loop	BUILDMAIN
 31564 0000460E B103                    	mov	cl,3
 31565                                  	;mov	al,' ' ; 20h
 31566                                  	;cmp	[si],al
 31567                                  	; 27/03/2023
 31568 00004610 803C20                  	cmp	byte [si],20h ; ' '
 31569 00004613 7412                    	je	short ENDDEST		; No extension
 31570                                  	;mov	al,[DOT_CHR]
 31571                                  	; 27/03/2023
 31572 00004615 B02E                    	mov	al,'.' ; 2Eh ; dot_chr
 31573 00004617 AA                      	stosb
 31574                                  BUILDEXT:
 31575 00004618 AC                      	lodsb
 31576 00004619 3C3F                    	cmp	al,'?'
 31577 0000461B 7502                    	jne	short NOTAMBIGE
 31578 0000461D 8A07                    	mov	al,[bx]
 31579                                  NOTAMBIGE:
 31580 0000461F 3C20                    	cmp	al,' '
 31581 00004621 7401                    	je	short NOSTOREE
 31582 00004623 AA                      	stosb
 31583                                  NOSTOREE:
 31584 00004624 43                      	inc	bx
 31585 00004625 E2F1                    	loop	BUILDEXT
 31586                                  ENDDEST:
 31587 00004627 30C0                    	xor	al,al
 31588 00004629 AA                      	stosb				; NUL terminate
 31589 0000462A C3                      	retn
 31590                                  
 31591                                  ; =============== S U B	R O U T	I N E =======================================
 31592                                  
 31593                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31594                                  	; 28/03/2023
 31595                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 31596                                  	; 10/08/2024 - Retro DOS v5.0 COMMAND.COM
 31597                                  BUILDPATH:
 31598 0000462B F6460402                	test	byte [bp+VARSTRUC.INFO],2 ; test byte [bp+4],2
 31599 0000462F 7540                    	jnz	short NOTPFILE		; If ambig don't bother with open
 31600 00004631 89EA                    	mov	dx,bp			; Set DX to spec
 31601 00004633 83C205                  	add	dx,VARSTRUC.BUF 	; add dx,5
 31602                                  
 31603                                  	; 27/03/2023
 31604                                  	; MSDOS 6.0
 31605 00004636 57                      	push	di			;AN000;
 31606 00004637 B8006C                  	mov	ax,(ExtOpen<<8)	; 6C00h	;AC000; open the file
 31607                                  
 31608                                  ; 10/08/2024 - PCDOS 7.1 COMMAND.COM
 31609                                  %if 0
 31610                                  	;mov	bx,deny_none|read_open_mode
 31611                                  	mov	bx,40h			; open mode for COPY ;M046
 31612                                  %endif
 31613 0000463A 31C9                    	xor	cx,cx			;AN000; no special files
 31614 0000463C 89D6                    	mov	si,dx			;AN030; get file name offset
 31615                                  	;mov	dx,read_open_flag	;AN000; set up open flags
 31616 0000463E BA0101                  	mov	dx,101h
 31617 00004641 CD21                    	INT	21h
 31618 00004643 5F                      	pop	di			;AN000;
 31619 00004644 7315                    	jnc	short PURE_FILE		;AN022; is pure file
 31620 00004646 E802DA                  	call	get_ext_error_number	;AN022; get the extended error
 31621                                  	;cmp	ax,2
 31622 00004649 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND ;AN022; if file not found - okay
 31623 0000464C 7423                    	jz	short NOTPFILE		;AN022;
 31624                                  	;cmp	ax,3
 31625 0000464E 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ;AN022; if path not found - okay
 31626 00004651 741E                    	jz	short NOTPFILE		;AN022;
 31627                                  	;cmp	ax,5
 31628 00004653 83F805                  	cmp	ax,ERROR_ACCESS_DENIED	;AN022; if access denied - okay
 31629 00004656 7419                    	jz	short NOTPFILE		;AN022;
 31630 00004658 E925D7                  	jmp	extend_setup		;AN022; exit with error
 31631                                  
 31632                                  	; 27/03/2023
 31633                                  	; MSDOS 3.3
 31634                                  	;mov	ax,OPEN*256 ; 3D00h
 31635                                  	;int	21h		; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 31636                                  	;			; DS:DX	-> ASCIZ filename
 31637                                  	;			; AL = access mode
 31638                                  	;			; 0 - read
 31639                                  	;jc	short NOTPFILE
 31640                                  
 31641                                  PURE_FILE:
 31642 0000465B 89C3                    	mov	bx,ax
 31643 0000465D B80044                  	mov	ax,IOCTL*256 ; 4400h
 31644 00004660 CD21                    	int	21h		; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 31645                                  				; BX = file or device handle
 31646 00004662 B43E                    	mov	ah,CLOSE ;3Eh
 31647 00004664 CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 31648                                  				; BX = file handle
 31649                                  	; 18/04/2023
 31650 00004666 F6C280                  	test	dl,80h
 31651                                  	;test	dl,devid_ISDEV ; test dl,80h
 31652 00004669 7553                    	jnz	short ISADEV
 31653 0000466B F6460404                	test	byte [bp+VARSTRUC.INFO],4 ; test byte [bp+4],4
 31654 0000466F 744D                    	jz	short ISADEV
 31655                                  NOTPFILE:
 31656 00004671 8B5605                  	mov	dx,[bp+VARSTRUC.BUF] ; mov dx,[bp+5]
 31657                                  	
 31658                                  	; 27/03/2023
 31659                                  	; MSDOS 6.0
 31660 00004674 80FA00                  	cmp	dl,0		     	;AN034; If no drive specified, get
 31661 00004677 7405                    	je	short SET_DRIVE_SPEC	;AN034;    default drive dir
 31662                                  
 31663 00004679 80FE3A                  	cmp	dh,':'
 31664 0000467C 7402                    	je	short DRVSPEC5
 31665                                  SET_DRIVE_SPEC:
 31666 0000467E B240                    	mov	dl,'@' ; 40h
 31667                                  DRVSPEC5:
 31668 00004680 80CA20                  	or	dl,20h
 31669 00004683 80EA60                  	sub	dl,60h		; A = 1
 31670 00004686 E8CCE2                  	call	SAVUDIR1
 31671                                  	
 31672                                  	; 27/03/2023
 31673                                  	; MSDOS 6.0
 31674 00004689 7306                    	jnc	short CURDIR_OK		;AN022; if error - exit
 31675 0000468B E8BDD9                  	call	get_ext_error_number	;AN022; get the extended error
 31676 0000468E E9EFD6                  	jmp	extend_setup		;AN022; exit with error
 31677                                  
 31678                                  CURDIR_OK:
 31679 00004691 89EA                    	mov	dx,bp
 31680                                  	;add	dx,5
 31681 00004693 83C205                  	add	dx,VARSTRUC.BUF		; Set DX for upcomming CHDIRs
 31682                                  	;mov	bh,[bp+4]
 31683 00004696 8A7E04                  	mov	bh,[bp+VARSTRUC.INFO]
 31684 00004699 80E706                  	and	bh,6
 31685 0000469C 80FF06                  	cmp	bh,6			; Ambig and path ?
 31686 0000469F 7518                    	jne	short CHECKAMB		; jmp if no
 31687                                  	;mov	si,[bp+2]
 31688 000046A1 8B7602                  	mov	si,[bp+VARSTRUC.TTAIL]
 31689 000046A4 B33A                    	mov	bl,':'
 31690 000046A6 385CFE                  	cmp	[si-2],bl
 31691 000046A9 7506                    	jne	short KNOWNOTSPEC
 31692                                  	;mov	byte [bp+VARSTRUC.ISDIR],2
 31693                                  					; Know is d:/file
 31694                                  	;mov	byte [bp+0],2
 31695 000046AB C6460002                	mov	byte [bp],2
 31696 000046AF EB05                    	jmp	short DOPCDJ
 31697                                  KNOWNOTSPEC:
 31698                                  	;mov	byte [bp+VARSTRUC.ISDIR],1
 31699                                  					; Know is path/file
 31700                                  	;mov	byte [bp+0],1
 31701 000046B1 C6460001                	mov	byte [bp],1
 31702 000046B5 4E                      	dec	si
 31703                                  DOPCDJ:
 31704 000046B6 E98300                  	jmp	DOPCD
 31705                                  CHECKAMB:
 31706 000046B9 80FF02                  	cmp	bh,2
 31707 000046BC 7505                    	jnz	short CHECKCD
 31708                                  ISSIMPFILE:
 31709                                  ISADEV:
 31710                                  	;mov	byte [bp+VARSTRUC.ISDIR],0
 31711                                  	;mov	byte [bp+0],0
 31712 000046BE C6460000                	mov	byte [bp],0
 31713 000046C2 C3                      	retn
 31714                                  CHECKCD:
 31715 000046C3 E84EEA                  	call	SetRest1
 31716 000046C6 B43B                    	mov	ah,CHDir ; 3Bh
 31717 000046C8 CD21                    	int	21h		; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 31718                                  				; DS:DX	-> ASCIZ directory name	(may include drive)
 31719 000046CA 7239                    	jb	short NOTPDIR
 31720 000046CC 89D7                    	mov	di,dx
 31721 000046CE 31C0                    	xor	ax,ax
 31722 000046D0 89C1                    	mov	cx,ax
 31723 000046D2 49                      	dec	cx
 31724                                  	; 14/06/2023
 31725                                  	;repne	scasb	 ; MSDOS 3.3
 31726                                  
 31727                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31728                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:424Ah)
 31729                                  	; MSDOS 6.0
 31730                                  Kloop:					;AN000;  3/3/KK
 31731 000046D3 268A05                  	mov	al,[es:di]		;AN000;  3/3/KK
 31732 000046D6 47                      	inc	di			;AN000;  3/3/KK
 31733 000046D7 08C0                    	or	al,al			;AN000;  3/3/KK
 31734 000046D9 740C                    	jz	short DONE		;AN000;  3/3/KK
 31735 000046DB 30E4                    	xor	ah,ah			;AN000;  3/3/KK
 31736 000046DD E881E0                  	call	testkanj		;AN000;  3/3/KK
 31737 000046E0 74F1                    	jz	short Kloop		;AN000;  3/3/KK
 31738 000046E2 47                      	inc	di			;AN000;  3/3/KK
 31739 000046E3 FEC4                    	inc	ah			;AN000;  3/3/KK
 31740 000046E5 EBEC                    	jmp	short Kloop		;AN000;  3/3/KK
 31741                                  DONE:
 31742 000046E7 4F                      	dec	di
 31743 000046E8 A0[FA9B]                	mov	al,[DIRCHAR]
 31744                                  	;mov	byte [bp+VARSTRUC.ISDIR],2 ; assume d:/file
 31745                                  	;mov	byte [bp+0],2
 31746 000046EB C6460002                	mov	byte [bp],2
 31747                                  	; 27/03/2023
 31748                                  	; MSDOS 6.0
 31749 000046EF 08E4                    	or	ah,ah			;AN000; 3/3/KK
 31750 000046F1 7505                    	jnz	short _STORE_PCHAR	;AN000; 3/3/KK
 31751                                  					;this is the trailing byte of ECS code
 31752                                  	;
 31753 000046F3 3A45FF                  	cmp	al,[di-1]
 31754 000046F6 7405                    	jz	short GOTSRCSLSH
 31755                                  _STORE_PCHAR:
 31756 000046F8 AA                      	stosb
 31757                                  	;mov	byte [bp+VARSTRUC.ISDIR],1 ; know path/file
 31758                                  	;mov	byte [bp+0],1
 31759 000046F9 C6460001                	mov	byte [bp],1
 31760                                  GOTSRCSLSH:
 31761                                  	;or	byte [bp+4],6
 31762 000046FD 804E0406                	or 	byte [bp+VARSTRUC.INFO],6
 31763 00004701 E87400                  	call	SETSTARS
 31764                                  NOTPDIR_RETN:
 31765 00004704 C3                      	retn
 31766                                  
 31767                                  	; 28/03/2023
 31768                                  NOTPDIR:
 31769                                  	; MSDOS 6.0
 31770 00004705 E843D9                  	call	get_ext_error_number	;AN022; get the extended error
 31771                                  	;cmp	ax,3
 31772 00004708 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ;AN022; if path not found - okay
 31773 0000470B 7405                    	je	short NOTPDIR_TRY	;AN022;
 31774                                  	;cmp	ax,5
 31775 0000470D 83F805                  	cmp	ax,ERROR_ACCESS_DENIED	;AN022; if access denied - okay
 31776 00004710 7560                    	jne	short EXTEND_SETUPJ	;AN022; otherwise - exit error
 31777                                  NOTPDIR_TRY:
 31778                                  	; MSDOS 3.3 (& MSDOS 6.0)
 31779                                  	;mov	byte [bp+VARSTRUC.ISDIR],0
 31780                                  	;mov	byte [bp+0],0
 31781 00004712 C6460000                	mov	byte [bp],0
 31782                                  	;mov	bh,[bp+4]
 31783 00004716 8A7E04                  	mov	bh,[bp+VARSTRUC.INFO]
 31784 00004719 F6C704                  	test	bh,4
 31785 0000471C 74E6                    	jz	short NOTPDIR_RETN	; Know pure file, no path seps
 31786                                  	;mov	byte [bp+VARSTRUC.ISDIR],2 ; assume d:/file
 31787                                  	;mov	byte [bp+0],2		
 31788 0000471E C6460002                	mov	byte [bp],2
 31789                                  	;mov	si,[bp+2]
 31790 00004722 8B7602                  	mov	si,[bp+VARSTRUC.TTAIL]
 31791 00004725 803C00                  	cmp	byte [si],0
 31792 00004728 744B                    	je	short BADCDERRJ2	; Trailing '/'
 31793                                  	;mov	bl,[DOT_CHR]
 31794                                  	; 28/03/2023 - Retro DOS v4.0 COMMAND.COM
 31795                                  	; MSDOS 6.0 (& 5.0) COMMAND.COM
 31796 0000472A B32E                    	mov	bl,'.'  ; 2Eh ; dot_chr
 31797 0000472C 381C                    	cmp	[si],bl
 31798 0000472E 7445                    	je	short BADCDERRJ2	; If . or .. pure cd should have worked
 31799 00004730 B33A                    	mov	bl,':'  ; 3Ah
 31800 00004732 385CFE                  	cmp	[si-2],bl
 31801 00004735 7405                    	je	short DOPCD		; Know d:/file
 31802                                  	;mov	byte [bp+VARSTRUC.ISDIR],1 
 31803                                  					; Know path/file
 31804                                  	;mov	byte [bp+0],1
 31805 00004737 C6460001                	mov	byte [bp],1
 31806 0000473B 4E                      	dec	si			; Point at last '/'
 31807                                  DOPCD:
 31808 0000473C 30DB                    	xor	bl,bl
 31809 0000473E 861C                    	xchg	bl,[si]			; Stick in a NUL
 31810 00004740 E8D1E9                  	call	SetRest1
 31811                                  
 31812                                  	; 28/03/2023
 31813                                  	; MSDOS 6.0 (& MSDOS 5.0)
 31814 00004743 39F2                    	cmp	dx,si			;AN000;  3/3/KK
 31815 00004745 771B                    	ja	short LookBack		;AN000;  3/3/KK
 31816 00004747 56                      	push	si			;AN000;  3/3/KK
 31817 00004748 51                      	push	cx			;AN000;  3/3/KK
 31818 00004749 89F1                    	mov	cx,si			;AN000;  3/3/KK
 31819 0000474B 89D6                    	mov	si,dx			;AN000;  3/3/KK
 31820                                  Kloop2: 				;AN000;  3/3/KK
 31821 0000474D AC                      	lodsb				;AN000;  3/3/KK
 31822 0000474E E810E0                  	call	testkanj		;AN000;  3/3/KK
 31823 00004751 7409                    	jz	short NotKanj4		;AN000;  3/3/KK
 31824 00004753 AC                      	lodsb				;AN000;  3/3/KK
 31825 00004754 39CE                    	cmp	si,cx			;AN000;  3/3/KK
 31826 00004756 72F5                    	jb	short Kloop2		;AN000;  3/3/KK
 31827 00004758 59                      	pop	cx			;AN000;  3/3/KK
 31828 00004759 5E                      	pop	si			;AN000;  3/3/KK
 31829 0000475A EB0B                    	jmp	short DoCdr		;AN000;  3/3/KK  Last char is ECS code, don't check for
 31830                                  					;		 trailing path sep
 31831                                  NotKanj4:				;AN000;  3/3/KK
 31832 0000475C 39CE                    	cmp	si,cx			;AN000;  3/3/KK
 31833 0000475E 72ED                    	jb	short Kloop2		;AN000;  3/3/KK
 31834 00004760 59                      	pop	cx			;AN000;  3/3/KK
 31835 00004761 5E                      	pop	si			;AN000;  3/3/KK
 31836                                  LookBack:				;AN000;  3/3/KK
 31837                                  	; 28/03/2023
 31838                                  	; MSDOS 3.3 & MSDOS 6.0
 31839 00004762 3A5CFF                  	cmp	bl,[si-1]		; if double slash, then complain.
 31840 00004765 740E                    	je	short BADCDERRJ2
 31841                                  DoCdr:
 31842 00004767 B43B                    	mov	ah,CHDir ; 3Bh
 31843 00004769 CD21                    	int	21h		; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 31844                                  				; DS:DX	-> ASCIZ directory name	(may include drive)
 31845 0000476B 861C                    	xchg	bl,[si]
 31846 0000476D 7395                    	jnc	short NOTPDIR_RETN
 31847                                  	
 31848                                  	; 28/03/2023
 31849                                  	; MSDOS 3.3
 31850                                  ;BADCDERRJ2:
 31851                                  	;stc
 31852                                  	;jmp	BADCDERR
 31853                                  
 31854                                  	; 28/03/2023
 31855                                  	; MSDOS 6.0 (& MSDOS 5.0)
 31856 0000476F E8D9D8                  	call	get_ext_error_number	;AN022; get the extended error
 31857                                  EXTEND_SETUPJ:				;AN022;
 31858 00004772 E90BD6                  	jmp	extend_setup		;AN022; go issue the error message
 31859                                  BADCDERRJ2:
 31860 00004775 E905D6                  	jmp	badpath_err		;AC022; go issue path not found message
 31861                                  
 31862                                  ; =============== S U B	R O U T	I N E =======================================
 31863                                  
 31864                                  	; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31865                                  SETSTARS:
 31866                                  	;mov	[bp+2],di
 31867 00004778 897E02                  	mov	[bp+VARSTRUC.TTAIL],di
 31868                                  	;add	byte [bp+1],12
 31869 0000477B 8046010C                	add	byte [bp+VARSTRUC.SIZ],12
 31870                                  	;;mov	ax,[DOT_QMARK] ; '?.' (2E3Fh)
 31871                                  	; 28/03/2023
 31872                                  	; MSDOS 6.0
 31873 0000477F B83F2E                  	mov	ax,dot_qmark ; 2E3Fh
 31874                                  	;mov	ax,'?.' ; dot_qmark
 31875                                  
 31876 00004782 B90800                  	mov	cx,8
 31877 00004785 F3AA                    	rep	stosb
 31878 00004787 86E0                    	xchg	al,ah
 31879 00004789 AA                      	stosb
 31880 0000478A 86E0                    	xchg	al,ah
 31881 0000478C B103                    	mov	cl,3
 31882 0000478E F3AA                    	rep	stosb
 31883 00004790 30C0                    	xor	al,al
 31884 00004792 AA                      	stosb
 31885 00004793 C3                      	retn
 31886                                  
 31887                                  ; =============== S U B	R O U T	I N E =======================================
 31888                                  
 31889                                  	; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31890                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 31891                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 31892                                  COMPNAME:
 31893 00004794 BE[BE9D]                	mov	si,DestBuf	; do name translate of target
 31894 00004797 BF[7A99]                	mov	di,TRGXNAME	; save for name comparison
 31895 0000479A B460                    	mov	ah,xNameTrans ; 60h
 31896                                  	;mov	ah,60h
 31897 0000479C CD21                    	int	21h	; DOS -	RESOLVE	PATH STRING TO CANONICAL PATH STRING
 31898                                  			; DS:SI	-> ASCIZ relative path string or directory name
 31899                                  			; ES:DI	-> 128-byte buffer for ASCIZ canonical fully qualified name
 31900 0000479E BE[2399]                	mov	si,SRCXNAME	; get name translate of source
 31901 000047A1 BF[7A99]                	mov	di,TRGXNAME	; get name translate of target
 31902                                  	;call	STRCOMP
 31903                                  	;retn
 31904                                  	; 28/03/2023
 31905 000047A4 E921E2                  	jmp	STRCOMP
 31906                                  
 31907                                  ;============================================================================
 31908                                  ; CPARSE.ASM, MSDOS 6.0, 1991
 31909                                  ;============================================================================
 31910                                  ; 30/09/2018 - Retro DOS v3.0
 31911                                  ; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31912                                  ; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 31913                                  ; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 31914                                  
 31915                                  ;-----------------------------------------------------------------------;
 31916                                  ; ENTRY:								;
 31917                                  ;	DS:SI	Points input buffer					;
 31918                                  ;	ES:DI	Points to the token buffer				;
 31919                                  ;	BL	Special delimiter for this call 			;
 31920                                  ;		    Always checked last 				;
 31921                                  ;		    set it to space if there is no special delimiter	;
 31922                                  ; EXIT: 								;
 31923                                  ;	DS:SI	Points to next char in the input buffer 		;
 31924                                  ;	ES:DI	Points to the token buffer				;
 31925                                  ;	[STARTEL] Points to start of last element of path in token	;
 31926                                  ;		points to a NUL for no element strings 'd:' 'd:/'       ;
 31927                                  ;	CX	Character count 					;
 31928                                  ;	BH	Condition Code						;
 31929                                  ;			Bit 1H of BH set if switch character		;
 31930                                  ;				Token buffer contains char after	;
 31931                                  ;				switch character			;
 31932                                  ;				BP has switch bits set (ORing only)	;
 31933                                  ;			Bit 2H of BH set if ? or * in token		;
 31934                                  ;				if * found element ? filled		;
 31935                                  ;			Bit 4H of BH set if path sep in token		;
 31936                                  ;			Bit 80H of BH set if the special delimiter	;
 31937                                  ;			   was skipped at the start of this token	;
 31938                                  ;		Token buffer always starts d: for non switch tokens	;
 31939                                  ;	CARRY SET							;
 31940                                  ;	    if CR on input						;
 31941                                  ;		token buffer not altered				;
 31942                                  ;									;
 31943                                  ;	DOES NOT RETURN ON BAD PATH, OR TRAILING SWITCH CHAR ERROR	;
 31944                                  ; MODIFIES:								;
 31945                                  ;	CX, SI, AX, BH, DX and the Carry Flag				;
 31946                                  ;									;
 31947                                  ;-----------------------------------------------------------------------;
 31948                                  
 31949                                  ; Modifications to cparse: recognition of right and left parentheses
 31950                                  ; as integral tokens, and removal of automatic upper-case conversion code.
 31951                                  ;
 31952                                  ; Both modifications were installed in the course of adding a coherent
 31953                                  ; command-line parser to COMMAND.COM which builds a UNIX-style argv[]/argc
 31954                                  ; structure for command-line arguments. This parser relies on cparse to
 31955                                  ; recognize individual tokens.
 31956                                  ;
 31957                                  ; To process for-loops correctly, parentheses must therefore be
 31958                                  ; recognized as tokens. The upper-case conversion code was removed so
 31959                                  ; that commands (such as for and echo) would be able to use the "original"
 31960                                  ; text of the command line.
 31961                                  ;
 31962                                  ; Note also the modification to prevent the automatic conversion of colons
 31963                                  ; into spaces WITHIN THE SOURCE TEXT!
 31964                                  ;
 31965                                  ; Also note that BP is also clobbered if cparse recognizes any switches
 31966                                  ; on the command line.
 31967                                  ;
 31968                                  ; Alan L, OS/MSDOS				    14 August 1983
 31969                                  
 31970                                  ; ---------------------------------------------------------------------------
 31971                                  
 31972                                  ; COMEQU.ASM (MSDOS 6.0, 1991)
 31973                                  
 31974                                  ;FSWITCH	EQU	8000h
 31975                                  ;FBADSWITCH	EQU	4000h
 31976                                  
 31977                                  	; MSDOS 3.3 COMMAND.COM (1987) Transient portion offset 3334h
 31978                                  
 31979                                  ; =============== S U B	R O U T	I N E =======================================
 31980                                  		
 31981                                  	; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31982                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 431Fh
 31983                                  
 31984                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 31985                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 4AE3h
 31986                                  
 31987                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 31988                                  	; PCDOS 7.1 COMMAND.COM (2003) Transient portion offset 49ABh
 31989                                  cparse:
 31990 000047A7 31C0                    	xor	ax,ax
 31991 000047A9 893E[F69E]              	mov	[STARTEL],di		; No path element (Is DI correct?)
 31992 000047AD A2[F99E]                	mov	[ELPOS],al		; Start in 8 char prefix
 31993                                  	; MSDOS 3.3
 31994                                  	;mov	[SOURCE],al		
 31995                                  	; MSDOS 6.0
 31996 000047B0 A2[FA9E]                	mov	[SKPDEL], al		; No skip delimiter yet
 31997 000047B3 88C7                    	mov	bh,al			; Init nothing
 31998 000047B5 9C                      	pushf				; save flags
 31999 000047B6 57                      	push	di			; save the token buffer addrss
 32000 000047B7 31C9                    	xor	cx,cx			; no chars in token buffer
 32001 000047B9 880E[959D]              	mov	[comma],cl		; reset comma flag
 32002                                  moredelim:
 32003 000047BD AC                      	lodsb
 32004 000047BE E8CDE1                  	call	DELIM
 32005 000047C1 751D                    	jnz	short SCANCDONE
 32006 000047C3 3C20                    	cmp	al,' '
 32007 000047C5 74F6                    	jz	short moredelim
 32008 000047C7 3C09                    	cmp	al,9
 32009 000047C9 74F2                    	jz	short moredelim
 32010                                  	;xchg	al,[SOURCE]
 32011                                  	; 28/03/2023
 32012 000047CB 8606[FA9E]              	xchg	al,[SKPDEL]
 32013 000047CF 08C0                    	or	al,al
 32014 000047D1 74EA                    	jz	short moredelim		; One non space/tab delimiter allowed
 32015 000047D3 F6C780                  	test	bh,80h			; has a special char been found?
 32016 000047D6 7405                    	jz	short no_comma		; no - just exit
 32017 000047D8 C606[959D]01            	mov	byte [comma],1		; set comma flag
 32018                                  no_comma:
 32019 000047DD E92A01                  	jmp	x_done			; Nul argument
 32020                                  
 32021                                  SCANCDONE:
 32022                                  	; 28/03/2023
 32023                                  	; MSDOS 6.0
 32024                                  	; -----------------------------------
 32025                                  	; Mod to avoid upper-case conversion.
 32026                                  	; -----------------------------------
 32027                                  	; MSDOS 3.3
 32028                                  	;cmp	byte [CPYFLAG],1	; 3/3/KK
 32029                                  	;jnz	short cpcont1		; 3/3/KK
 32030                                  	;call	UPCONV_MAPCALL		; 3/3/KK
 32031                                  cpcont1:
 32032                                  	; -----------------------------------
 32033                                  	; 28/03/2023
 32034 000047E0 38D8                    	cmp	al,bl			; Special delimiter?
 32035 000047E2 7505                    	jne	short nospec
 32036 000047E4 80CF80                  	or	bh,80h
 32037 000047E7 EBD4                    	jmp	short moredelim
 32038                                  nospec:
 32039 000047E9 3C0D                    	cmp	al,0Dh			; a CR?
 32040 000047EB 7503                    	jne	short ncperror
 32041 000047ED E91501                  	jmp	cperror
 32042                                  ncperror:
 32043 000047F0 3A06[F99B]              	cmp	al,[SWITCHAR]		; is the char the switch char?
 32044 000047F4 7503                    	jne	short na_switch		; yes, process...
 32045 000047F6 E91401                  	jmp	a_switch
 32046                                  na_switch:
 32047 000047F9 B23A                    	mov	dl,':'
 32048 000047FB 3814                    	cmp	[si],dl
 32049 000047FD 751D                    	jne	short anum_chard	; Drive not specified
 32050                                  	; 28/03/2023
 32051                                  	; MSDOS 6.0 
 32052 000047FF 803E[A49D]01            	cmp	byte [cpyflag],1	; 3/3/KK
 32053 00004804 7503                    	jne	short cpcont2		; 3/3/KK
 32054 00004806 E882DF                  	call	UPCONV			; 3/3/KK
 32055                                  cpcont2:
 32056 00004809 E85901                  	call	move_char
 32057 0000480C AC                      	lodsb				; Get the ':'
 32058 0000480D E85501                  	call	move_char
 32059 00004810 893E[F69E]              	mov	[STARTEL],di
 32060 00004814 C606[F89E]00            	mov	byte [ELCNT],0
 32061 00004819 E9B300                  	jmp	anum_test
 32062                                  anum_chard:
 32063 0000481C 893E[F69E]              	mov	[STARTEL],di
 32064 00004820 C606[F89E]00            	mov	byte [ELCNT],0		; Store of this char sets it to one
 32065 00004825 803E[A49D]01            	cmp	byte [cpyflag],1	; Was CPARSE called from COPY?
 32066 0000482A 751D                    	jnz	short anum_char		; No, don't add drive spec.
 32067 0000482C E8E5E1                  	call	pathchrcmp		; Starts with a pathchar?
 32068 0000482F 7518                    	jnz	short anum_char		; no
 32069 00004831 50                      	push	ax
 32070 00004832 A0[079C]                	mov	al,[CURDRV]		; Insert drive spec
 32071                                  	;add	al,[CAPITAL_A]
 32072                                  	; 28/03/2023
 32073                                  	; MSDOS 6.0
 32074 00004835 0441                    	add	al,'A' ; 41h
 32075 00004837 E82B01                  	call	move_char
 32076 0000483A B03A                    	mov	al,':' ; 3Ah
 32077 0000483C E82601                  	call	move_char
 32078 0000483F 58                      	pop	ax
 32079 00004840 893E[F69E]              	mov	[STARTEL],di
 32080 00004844 C606[F89E]00            	mov	byte [ELCNT],0
 32081                                  anum_char:
 32082                                  	; 28/03/2023
 32083                                  	; MSDOS 6.0
 32084 00004849 E815DF                  	call	testkanj		;AC048			
 32085 0000484C 7406                    	jz	short NOTKANJ		;AC048;
 32086 0000484E E81401                  	call	move_char
 32087 00004851 AC                      	lodsb
 32088 00004852 EB78                    	jmp	short notspecial
 32089                                  
 32090                                  NOTKANJ:				;AN048; If not kanji
 32091 00004854 803E[A49D]01            	cmp	byte [cpyflag],1	;AN048; and if we're in COPY
 32092 00004859 7503                    	jne	short TESTDOT 		;AN048;
 32093 0000485B E82DDF                  	call	UPCONV			;AN048; upper case the char
 32094                                  TESTDOT:
 32095                                  	; 28/03/2023
 32096                                  	;cmp	al,dot_chr  ; 2Eh
 32097 0000485E 3C2E                    	cmp	al,'.'
 32098 00004860 7509                    	jne	short testquest
 32099 00004862 FE06[F99E]              	inc	byte [ELPOS] 		; flag in extension
 32100 00004866 C606[F89E]FF            	mov	byte [ELCNT],0FFh	; Store of the '.' resets it to 0
 32101                                  testquest:
 32102 0000486B 3C3F                    	cmp	al,'?'  ; 3Fh
 32103 0000486D 7503                    	jnz	short testsplat
 32104 0000486F 80CF02                  	or	bh,2
 32105                                  testsplat:
 32106                                  	;cmp	al,[STAR]
 32107 00004872 3C2A                    	cmp	al,star	; 2Ah
 32108                                  	; 27/04/2023
 32109                                  	;cmp	al,'*' 
 32110 00004874 7530                    	jne	short testpath
 32111 00004876 80CF02                  	or	bh,2
 32112 00004879 803E[329F]00            	cmp	byte [expand_star],0
 32113 0000487E 7504                    	jne	short expand_filename
 32114 00004880 EB24                    	jmp	short testpath
 32115                                  
 32116                                  BADPERR2J:
 32117                                  	;jmp	BADPERR2
 32118                                  	; 28/03/2023
 32119                                  	; MSDOS 6.0
 32120 00004882 EB75                    	jmp	short BADPERR2
 32121                                  
 32122                                  expand_filename:
 32123 00004884 B407                    	mov	ah,7
 32124 00004886 803E[F99E]00            	cmp	byte [ELPOS],0
 32125 0000488B 7402                    	jz	short gotelcnt
 32126 0000488D B402                    	mov	ah,2
 32127                                  gotelcnt:
 32128 0000488F B03F                    	mov	al,'?'
 32129 00004891 2A26[F89E]              	sub	ah,[ELCNT]
 32130 00004895 72EB                    	jb	short BADPERR2J
 32131 00004897 86CC                    	xchg	ah,cl
 32132 00004899 E309                    	jcxz	testpathx
 32133                                  qmove:
 32134 0000489B 86CC                    	xchg	ah,cl
 32135 0000489D E8C500                  	call	move_char
 32136 000048A0 86CC                    	xchg	ah,cl
 32137 000048A2 E2F7                    	loop	qmove
 32138                                  testpathx:
 32139 000048A4 86CC                    	xchg	ah,cl
 32140                                  testpath:
 32141 000048A6 E86BE1                  	call	pathchrcmp
 32142 000048A9 7521                    	jnz	short notspecial
 32143 000048AB 80CF04                  	or	bh,4
 32144 000048AE 803E[329F]00            	cmp	byte [expand_star],0
 32145 000048B3 7405                    	jz	short no_err_check
 32146 000048B5 F6C702                  	test	bh,2			; If just hit a '/', cannot have ? or * yet
 32147 000048B8 7545                    	jnz	short BADPERR
 32148                                  no_err_check:
 32149 000048BA 893E[F69E]              	mov	[STARTEL],di	  	; New element
 32150 000048BE FF06[F69E]              	inc	word [STARTEL]	  	; Point to char after /
 32151 000048C2 C606[F89E]FF            	mov	byte [ELCNT],0FFh 	; Store of '/' sets it to 0
 32152 000048C7 C606[F99E]00            	mov	byte [ELPOS],0
 32153                                  notspecial:
 32154 000048CC E89600                  	call	move_char		; just an alphanum string
 32155                                  anum_test:
 32156 000048CF AC                      	lodsb
 32157                                  
 32158                                  	; 28/03/2023
 32159                                  	; MSDOS 6.0
 32160                                  	; -----------------------------------
 32161                                  	; Mod to avoid upper-case conversion.
 32162                                  	; -----------------------------------
 32163                                  	; MSDOS 3.3
 32164                                  	;cmp	byte [CPYFLAG],1	; 3/3/KK
 32165                                  	;jnz	short cpcont3		; 3/3/KK
 32166                                  	;call	UPCONV_MAPCALL		; 3/3/KK
 32167                                  cpcont3:
 32168                                  	; -----------------------------------
 32169                                  
 32170 000048D0 E8BBE0                  	call	DELIM
 32171 000048D3 7435                    	jz	short x_done
 32172 000048D5 3C0D                    	cmp	al,0Dh
 32173 000048D7 7431                    	je	short x_done
 32174 000048D9 3A06[F99B]              	cmp	al,[SWITCHAR]
 32175 000048DD 742B                    	je	short x_done
 32176 000048DF 38D8                    	cmp	al,bl
 32177 000048E1 7427                    	je	short x_done
 32178 000048E3 3C3A                    	cmp	al,':'			; ':' allowed as trailer because of devices
 32179                                  	; 28/03/2023
 32180                                  	; MSDOS 3.3
 32181                                  	;jnz	short ANUM_CHARJ 
 32182                                  	; MSDOS 6.0
 32183 000048E5 7403                    	je	short FOO15
 32184 000048E7 E95FFF                  	jmp	anum_char
 32185                                  
 32186                                  ; Modification made for parseline.
 32187                                  ; Why would it be necessary to change colons to spaces? In this
 32188                                  ; case, EVERY colon is changed to a space; e.g., 'f:' yields 'f ',
 32189                                  ; but so does 'echo foo:bar' yield 'echo foo bar'.
 32190                                  
 32191                                  FOO15:
 32192 000048EA 803E[A49D]02            	cmp	byte [cpyflag],2
 32193 000048EF 7505                    	jnz	short cpcont4
 32194 000048F1 E87100                  	call	move_char
 32195 000048F4 EBD9                    	jmp	short anum_test
 32196                                  cpcont4:
 32197 000048F6 46                      	inc	si			; Skip the ':'
 32198 000048F7 EB11                    	jmp	short x_done
 32199                                  
 32200                                  	; 28/03/2023
 32201                                  ;ANUM_CHARJ:
 32202                                  	;jmp	anum_char
 32203                                  
 32204                                  BADPERR2:
 32205 000048F9 BA[E88F]                	mov	dx,BADCPMES_PTR
 32206 000048FC E927E4                  	jmp	cerror
 32207                                  
 32208                                  BADPERR:
 32209                                  	; 28/03/2023
 32210                                  	;jmp	BADCDERR  ; MSDOS 3.3	
 32211                                  BADCDERR:
 32212                                  	; MSDOS 6.0
 32213 000048FF BA[3791]                	mov	dx,badcd_ptr		;AC022; Issue "Invalid Directory"
 32214 00004902 E921E4                  	jmp	cerror			;AC022;  message
 32215                                  	
 32216                                  cperror:
 32217 00004905 4E                      	dec	si			; adjust the pointer
 32218 00004906 5F                      	pop	di			; retrieve token buffer address
 32219 00004907 9D                      	popf				; restore flags
 32220 00004908 F9                      	stc				; set the carry bit
 32221 00004909 C3                      	retn
 32222                                  
 32223                                  x_done:
 32224 0000490A 4E                      	dec	si			; adjust for next round
 32225                                  
 32226                                  ; Mod to recognize right and left parens as integral tokens.
 32227                                  ;x_done2:
 32228 0000490B EB51                    	jmp	short out_token
 32229                                  
 32230                                  a_switch:
 32231 0000490D 80CF01                  	or	bh,1			; Indicate switch
 32232                                  	;or	bp,FSWITCH ; 8000h
 32233                                  	; 28/03/2023
 32234 00004910 81CD0080                	or	bp,8000h
 32235 00004914 E86FE0                  	call	scanoff
 32236 00004917 46                      	inc	si
 32237                                  	; 28/03/2023
 32238                                  	; MSDOS 6.0
 32239 00004918 E846DE                  	call	testkanj		;AN057; See if DBCS lead byte
 32240 0000491B 740D                    	jz	short a_switch_notkanj	;AN057; no - continue processing
 32241 0000491D E84500                  	call	move_char		;AN057; DBCS - store first byte
 32242 00004920 AC                      	lodsb				;AN057; get second byte
 32243 00004921 E84100                  	call	move_char		;AN057; store second byte
 32244                                  	;or	bp,FBADSWITCH ; 4000h	;AN057; DBCS switch is invalid
 32245 00004924 81CD0040                	or	bp,4000h
 32246 00004928 EB34                    	jmp	short out_token 	;AN057; don't bother checking switch
 32247                                  a_switch_notkanj:			;AN057;
 32248 0000492A 3C0D                    	cmp	al,0Dh
 32249 0000492C 7509                    	jne	short Store_swt
 32250 0000492E B000                    	mov	al,0
 32251 00004930 AA                      	stosb
 32252                                  	;or	bp,FBADSWITCH ; 4000h
 32253 00004931 81CD0040                	or	bp,4000h
 32254 00004935 EBCE                    	jmp	short cperror		; Trailing switch character error
 32255                                  					;   BP = fSwitch but no switch
 32256                                  					;   bit is set (unknown switch)
 32257                                  Store_swt:
 32258 00004937 E82B00                  	call	move_char		; store the character
 32259                                  
 32260                                  ; This upconv call must stay. It is used to identify copy-switches
 32261                                  ; on the command line, and won't store anything into the output buffer.
 32262                                  
 32263                                  	;call	UPCONV_MAPCALL ; MSDOS 3.3 (Retro DOS 3.0)
 32264                                  	; 28/03/2023
 32265 0000493A E84EDE                  	call	UPCONV 	; MSDOS 6.0 & MSDOS 5.0 (Retro DOS 4.0)
 32266                                  	
 32267 0000493D 06                      	push	es
 32268 0000493E 57                      	push	di
 32269 0000493F 51                      	push	cx
 32270 00004940 0E                      	push	cs
 32271 00004941 07                      	pop	es
 32272                                  	; 28/03/2023
 32273                                  	; MSDOS 3.3
 32274                                  	;;mov	di,SWITCH_LIST ; "VBAPW"
 32275                                  	; MSDOS 6.0
 32276                                  	;mov	di,switch_list ; "?VBAPW"
 32277                                  	; 14/06/*2023
 32278                                  	; MSDOS 6.22
 32279 00004942 BF[D095]                	mov	di,switch_list ; "-Y?VBAPW"
 32280                                  
 32281                                  	; MSDOS 3.3
 32282                                  	;mov	cx,SWCOUNT ; 5
 32283                                  	; MSDOS 6.0
 32284                                  	;mov	cx,6  ; SWCOUNT = 6
 32285                                  	; 14/06/2023
 32286                                  	; MSDOS 6.22
 32287 00004945 B90800                  	mov	cx,8  ; SWCOUNT = 8
 32288                                  
 32289                                  	;or	bp,FBADSWITCH  ; 4000h
 32290 00004948 81CD0040                	or	bp,4000h
 32291 0000494C F2AE                    	repne	scasb
 32292 0000494E 750B                    	jnz	short out_tokenp
 32293                                  	;and	bp,~FBADSWITCH ; 0BFFFh
 32294 00004950 81E5FFBF                	and	bp,0BFFFh
 32295 00004954 B80100                  	mov	ax,1
 32296 00004957 D3E0                    	shl	ax,cl
 32297 00004959 09C5                    	or	bp,ax
 32298                                  out_tokenp:
 32299 0000495B 59                      	pop	cx
 32300 0000495C 5F                      	pop	di
 32301 0000495D 07                      	pop	es
 32302                                  out_token:
 32303 0000495E B000                    	mov	al,0			; null at the end
 32304 00004960 AA                      	stosb
 32305 00004961 5F                      	pop	di			; restore token buffer pointer
 32306 00004962 9D                      	popf
 32307 00004963 F8                      	clc				; clear carry flag
 32308 00004964 C3                      	retn
 32309                                  
 32310                                  ; =============== S U B	R O U T	I N E =======================================
 32311                                  
 32312                                  	; 28/03/2023
 32313                                  move_char:
 32314 00004965 AA                      	stosb				; store char in token buffer
 32315 00004966 41                      	inc	cx			; increment char count
 32316 00004967 FE06[F89E]              	inc	byte [ELCNT]		; increment element count for * substi
 32317 0000496B C3                      	retn
 32318                                  
 32319                                  ;============================================================================
 32320                                  ; PARSE.ASM, MSDOS 6.0, 1991
 32321                                  ;============================================================================
 32322                                  ; 29/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 32323                                  ; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 32324                                  ; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 32325                                  
 32326                                  ; -----------------------------
 32327                                  ; (PSDATA.INC, MSDOS 6.0, 1991)
 32328                                  ; -----------------------------
 32329                                  
 32330                                  ;**** Equation field
 32331                                  ;-------- Character code definition
 32332                                  
 32333                                  $P_DBSP1	   equ	20h ; DB_SP_HI	;AN000; 1st byte of DBCS blank
 32334                                  $P_DBSP2	   equ	20h ; DB_SP_LO	;AN000; 2nd byte of DBCS blank
 32335                                  $P_Period	   equ	"."             ;AN020;
 32336                                  $P_Slash	   equ	"/"             ;AN020;
 32337                                  $P_Space	   equ	" "             ;AN000; SBCS blank
 32338                                  $P_Comma	   equ	","             ;AN000;
 32339                                  $P_Switch	   equ	"/"             ;AN000;
 32340                                  $P_Keyword	   equ	"="             ;AN000;
 32341                                  $P_Colon	   equ	":"             ;AN000;
 32342                                  $P_Plus 	   equ	"+"             ;AN000;
 32343                                  $P_Minus	   equ	"-"             ;AN000;
 32344                                  $P_Rparen	   equ	")"             ;AN000;
 32345                                  $P_Lparen	   equ	"("             ;AN000;
 32346                                  ;(deleted ;AN025;) $P_SQuote equ  "'"
 32347                                  $P_DQuote	   equ	'"'             ;AN000;
 32348                                  $P_NULL 	   equ	0		;AN000;
 32349                                  $P_TAB		   equ	9		;AN000;
 32350                                  $P_CR		   equ	0Dh		;AN000;
 32351                                  $P_LF		   equ	0Ah		;AN000;
 32352                                  $P_ASCII80	   equ	80h		;AN000; ASCII 80h character code
 32353                                  
 32354                                  $P_DOSTBL_File	   equ	4		;AN000; get file uppercase table
 32355                                  $P_DOSTBL_Char	   equ	2		;AN000; get character uppercase table
 32356                                  
 32357                                  $P_error_filespec  equ  1
 32358                                  
 32359                                  ;----------------------------------------------------------------------------
 32360                                  ; PARMS LABEL	BYTE
 32361                                  ;	DW	PARMSX
 32362                                  ;	DB	2		; NUMBER OF STRINGS (0, 1, 2)
 32363                                  ;	DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 32364                                  ;	DB	" .. "          ; EXTRA DELIMITER LIST,
 32365                                  ;				; TYPICAL ARE ";", "="
 32366                                  ;				; "," & WHITESPACE ALWAYS
 32367                                  ;	DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 32368                                  ;	DB	" .. "          ; EXTRA END OF LINE LIST, CR, LF OR 0 ALWAYS
 32369                                  ;----------------------------------------------------------------------------
 32370                                  
 32371                                  struc $P_PARMS_BLK			;AN000;
 32372 00000000 ????                    .$P_PARMSX_Address:  resw 1		;AN000; Address of PARMSX
 32373 00000002 ??                      .$P_Num_Extra:	     resb 1		;AN000; Number of extra stuff
 32374 00000003 ??                      .$P_Len_Extra_Delim: resb 1		;AN000; Length of extra delimiter
 32375                                  endstruc 				;AN000;
 32376                                  
 32377                                  $P_Len_PARMS	   equ	4		;AN000;
 32378                                  $P_I_Use_Default   equ	0		;AN000; no extra stuff specified
 32379                                  $P_I_Have_Delim    equ	1		;AN000; extra delimiter specified
 32380                                  $P_I_Have_EOL	   equ	2		;AN000; extra EOL specified
 32381                                  
 32382                                  ;----------------------------------------------------------------------------
 32383                                  ; PARMSX LABEL	BYTE
 32384                                  ;	DB	minp,maxp		; MIN, MAX POSITIONAL OPERANDS ALLOWED
 32385                                  ;	DW	CONTROL 		; DESCRIPTION OF POSITIONAL 1
 32386                                  ;	:				; REPEATS maxp-1 TIMES
 32387                                  ;	DB	maxs			; # OF SWITCHES
 32388                                  ;	DW	CONTROL 		; DESCRIPTION OF SWITCH 1
 32389                                  ;	:				; REPEATS maxs-1 TIMES
 32390                                  ;	DB	maxk			; # OF KEYWORD
 32391                                  ;	DW	CONTROL 		; DESCRIPTION OF KEYWORD 1
 32392                                  ;	:				; REPEATS maxk-1 TIMES
 32393                                  ;----------------------------------------------------------------------------
 32394                                  
 32395                                  struc $P_PARMSX_BLK			;AN000;
 32396 00000000 ??                      .$P_MinP: 	 resb 1	 ; 27/04/2023	;AN000; Minimum positional number
 32397 00000001 ??                      .$P_MaxP: 	 resb 1			;AN000; Maximum positional number
 32398 00000002 ??                      .$P_1st_Control: resb 1			;AN000; Address of the 1st CONTROL block
 32399                                  endstruc				;AN000;
 32400                                  
 32401                                  ; 31/03/2023
 32402                                  ;----------------------------------------------------------------------------
 32403                                  ; << Control field definition >>
 32404                                  ;
 32405                                  ;CONTROL   LABEL   BYTE
 32406                                  ;	   DW MATCH_FLAGS	; CONTROLS TYPE MATCHED
 32407                                  ;				; 8000H=NUMERIC VALUE, (VALUE LIST WILL BE CHECKED)
 32408                                  ;				; 4000H=SIGNED NUMERIC VALUE (VALUE LIST WILL BE CHECKED)
 32409                                  ;				; 2000H=SIMPLE STRING(VALUE LIST WILL BE CHECKED)
 32410                                  ;				; 1000H=DATE STRING (VALUE LIST WON'T BE CHECKED)
 32411                                  ;				; 0800H=TIME STRING (VALUE LIST WON'T BE CHECKED)
 32412                                  ;				; 0400H=COMPLEX LIST (VALUE LIST WON'T BE CHECKED)
 32413                                  ;				; 0200H=FILE SPEC (VALUE LIST WON'T BE CHECKED)
 32414                                  ;				; 0100H=DRIVE ONLY (VALUE LIST WON'T BE CHECKED)
 32415                                  ;				; 0080H=QUOTED STRING (VALUE LIST WON'T BE CHECKED)
 32416                                  ;				; 0010H=IGNORE ":" AT END IN MATCH
 32417                                  ;				; 0002H=REPEATS ALLOWED
 32418                                  ;				; 0001H=OPTIONAL
 32419                                  ;	   DW FUNCTION_FLAGS
 32420                                  ;				; 0001H=CAP RESULT BY FILE TABLE
 32421                                  ;				; 0002H=CAP RESULT BY CHAR TABLE
 32422                                  ;				; 0010H=REMOVE ":" AT END
 32423                                  ; (tm10)			; 0020H=colon is not necessary for switch
 32424                                  ;
 32425                                  ;	   DW RESULT		; RESULT BUFFER
 32426                                  ;	   DW VALUES		; VALUE LISTS
 32427                                  ;	   DB nid		; NUMBER OF KEYWORD/SWITCH SYNONYMS IN FOLLOWING LIST
 32428                                  ;	   DB "...",0		; IF n >0, KEYWORD 1
 32429                                  ;	   :
 32430                                  ;
 32431                                  ;Note:
 32432                                  ;    - The MATCH_FLAG is bit significant. You can set, for example, TIME bit and
 32433                                  ;      DATE bit simalteniously.
 32434                                  ;
 32435                                  ;      The parser examins each bit along with the following priority.
 32436                                  ;
 32437                                  ;      COMPLEX -> DATE -> TIME -> NUMERIC VAL -> SIGNED NUMERIC VAL -> DRIVE ->
 32438                                  ;      FILE SPEC -> SIMPLE STRING.
 32439                                  ;
 32440                                  ;
 32441                                  ;    - When the FUNCTION_FLAG is 0001 or 0002, the STRING pointed to by a pointer
 32442                                  ;      in the result buffer is capitalized.
 32443                                  ;
 32444                                  ;    - Match_Flags 0001H and 0002H have meaning only for the positional.
 32445                                  ;
 32446                                  ;
 32447                                  ;    - The "...",0 (bottom most line) does require '=' or '/'. When you need a
 32448                                  ;      switch, for example, '/A', then STRING points to;
 32449                                  ;
 32450                                  ;		DB    1 	; number of following synonyms
 32451                                  ;		DB   '/A',0
 32452                                  ;
 32453                                  ;      When you need a keyword, for example, 'CODEPAGE=', then "...",0 will be;
 32454                                  ;
 32455                                  ;		DB    1 	; number of following synonyms
 32456                                  ;		DB   'CODEPAGE=',0
 32457                                  ;
 32458                                  ;
 32459                                  ;    - "..." must consist of upper case characters only because the parser
 32460                                  ;      performs pattern matching after converting input to upper case (by
 32461                                  ;      using the current country upper case table)
 32462                                  ;
 32463                                  ;
 32464                                  ;    - One "..." can contain only one switch or keyword. If you need, for
 32465                                  ;      example /A and /B, the format will be;
 32466                                  ;
 32467                                  ;		DB    2 	; number of following synonyms
 32468                                  ;		DB    '/A',0
 32469                                  ;		DB    '/B',0
 32470                                  ;----------------------------------------------------------------------------
 32471                                  
 32472                                  ;**** Match_Flags
 32473                                  
 32474                                  $P_Num_Val	   equ	8000h		;AN000; Numeric Value
 32475                                  $P_SNum_Val	   equ	4000h		;AN000; Signed numeric value
 32476                                  $P_Simple_S	   equ	2000h		;AN000; Simple string
 32477                                  $P_Date_S	   equ	1000h		;AN000; Date string
 32478                                  $P_Time_S	   equ	0800h		;AN000; Time string
 32479                                  $P_Cmpx_S	   equ	0400h		;AN000; Complex string
 32480                                  $P_File_Spc	   equ	0200h		;AN000; File Spec
 32481                                  $P_Drv_Only	   equ	0100h		;AN000; Drive Only
 32482                                  $P_Qu_String	   equ	0080h		;AN000; Quoted string
 32483                                  $P_Ig_Colon	   equ	0010h		;AN000; Ignore colon at end in match
 32484                                  $P_Repeat	   equ	0002h		;AN000; Repeat allowed
 32485                                  $P_Optional	   equ	0001h		;AN000; Optional
 32486                                  
 32487                                  ;**** Function flags
 32488                                  
 32489                                  $P_CAP_File	   equ	0001h		;AN000; CAP result by file table
 32490                                  $P_CAP_Char	   equ	0002h		;AN000; CAP result by character table
 32491                                  $P_Rm_Colon	   equ	0010h		;AN000; Remove ":" at the end
 32492                                  $P_colon_is_not_necessary equ 0020h	;AN000;(tm10) /+10 and /+:10
 32493                                  
 32494                                  ;-------------------------------- Control block structure
 32495                                  struc $P_CONTROL_BLK
 32496 00000000 ????                    .$P_Match_Flag:	   resw 1		;AN000; Controls type matched
 32497 00000002 ????                    .$P_Function_Flag: resw 1		;AN000; Function should be taken
 32498 00000004 ????                    .$P_Result_Buf:	   resw 1		;AN000; Result buffer address
 32499 00000006 ????                    .$P_Value_List:	   resw 1		;AN000; Value list address
 32500 00000008 ??                      .$P_nid:	   resb 1		;AN000; # of keyword/SW synonyms
 32501 00000009 ??                      .$P_KEYorSW:	   resb 1		;AN000; keyword or sw
 32502                                  endstruc
 32503                                  
 32504                                  ; 31/03/2023
 32505                                  ;----------------------------------------------------------------------------
 32506                                  ;
 32507                                  ;VALUES LABEL	BYTE
 32508                                  ;	DB	nval		; NUMBER OF VALUE DEFINITIONS (0 - 3)
 32509                                  ;	+-
 32510                                  ;	| DB	nrng		; NUMBER OF RANGES
 32511                                  ;	| +DB	ITEM_TAG	; RETURN VALUE IF RANGE MATCHED
 32512                                  ;	| +DD	X,Y		; RANGE OF VALUES
 32513                                  ;	|	:
 32514                                  ;	| DB	nnval		; NUMBER OF CHOICES
 32515                                  ;	| +DB	ITEM_TAG	; RETURN VALUE IF NUMBER CHOICE MATCHED
 32516                                  ;	| +DD	VALUE		; SPECIFIC CHOICE IF NUMBER
 32517                                  ;	|	:
 32518                                  ;	| DB	nstrval 	; NUMBER OF CHOICES
 32519                                  ;	| +DB	ITEM_TAG	; RETURN VALUE IF STRING CHOICE MATCHED
 32520                                  ;	| +DW	STRING		; SPECIFIC CHOICE IF STING
 32521                                  ;	+-	:
 32522                                  ;
 32523                                  ;STRING DB	"...",0		; ASCIIZ STRING IMAGE
 32524                                  ;
 32525                                  ;Note:
 32526                                  ;    - ITEM_TAG must not be 0FFH, which will be used in the result buffer
 32527                                  ;      when no choice lists are provided.
 32528                                  ;
 32529                                  ;    - STRING must consist of upper case characters only because the parser
 32530                                  ;      performs pattern matching after converting input to upper case (by
 32531                                  ;      using the current country upper case table)
 32532                                  ;----------------------------------------------------------------------------
 32533                                  
 32534                                  $P_nval_None	equ 0		;AN000; no value list ID
 32535                                  $P_nval_Range	equ 1		;AN000; range list ID
 32536                                  $P_nval_Value	equ 2		;AN000; value list ID
 32537                                  $P_nval_String	equ 3		;AN000; string list ID
 32538                                  $P_Len_Range	equ 9		;AN000; Length of a range choice(two DD plus one DB)
 32539                                  $P_Len_Value	equ 5		;AN000; Length of a value choice(one DD plus one DB)
 32540                                  $P_Len_String	equ 3		;AN000; Length of a string choice(one DW plus one DB)
 32541                                  $P_No_nrng	equ 0		;AN000; (tm07) no nrng. nnval must not be 0.
 32542                                  
 32543                                  struc $P_VAL_LIST
 32544 00000000 ??                      .$P_NumofList:	resb 1		;AN000; number of following choice
 32545 00000001 ????                    .$P_Val_XL:	resw 1		;AN000; lower word of value
 32546 00000003 ????                    .$P_Val_XH:	resw 1		;AN000; higher word of value
 32547 00000005 ????                    .$P_Val_YL:	resw 1		;AN000; lower word of another value
 32548 00000007 ????                    .$P_Val_YH:	resw 1		;AN000; higher word of another value
 32549                                  endstruc
 32550                                  
 32551                                  ; 31/03/2023
 32552                                  ;----------------------------------------------------------------------------
 32553                                  ;
 32554                                  ;RESULT LABEL	BYTE			; BELOW FILLED IN FOR DEFAULTS
 32555                                  ;	DB	type			; TYPE RETURNED: 0=RESERVED,
 32556                                  ;					;	1=NUMBER, 2=LIST INDEX,
 32557                                  ;					;	3=STRING, 4=COMPLEX,
 32558                                  ;					;	5=FILESPEC, 6=DRIVE
 32559                                  ;					;	7=DATE, 8=TIME
 32560                                  ;					;	9=QUOTED STRING
 32561                                  ;	DB	ITEM_TAG		; MATCHED ITEM TAG
 32562                                  ;
 32563                                  ;	dw	synonym@		; es:@ points to found SYNONYM if provided.
 32564                                  ;
 32565                                  ;       +-
 32566                                  ;       | DD	n			; VALUE IF NUMBER
 32567                                  ;       | or
 32568                                  ;       |	DW i			; INDEX (OFFSET) INTO VALUE LIST
 32569                                  ;       |				; (ES presents Segment address)
 32570                                  ;       | or
 32571                                  ;       |	DD STRING		; OFFSET OF STRING VALUE
 32572                                  ;       | or
 32573                                  ;       |	DB drv			; DRIVE NUMBER (1-A, 2-B,..., 26-Z)
 32574                                  ;       | or
 32575                                  ;       |	DW YEAR	   		;(1980-2099)  IN CASE OF DATE
 32576                                  ;       |	DB MONTH   ;(1-12)	 Note: Range check is not performed.
 32577                                  ;       |	DB DATE	   ;(1-31)	 0 is filled when the corresponding field was not specified.
 32578                                  ;       | or
 32579                                  ;       |	DB HOUR	   ;(0-23)	 IN CASE OF TIME
 32580                                  ;       |	DB MINUTES    ;(0-59)	 Note: Range check is not performed .
 32581                                  ;       |	DB SECONDS    ;(0-59)	 0 is filled when the corresponding field was not specified .
 32582                                  ;       |	DB HUNDREDTHS ;(0-99)
 32583                                  ;       +-
 32584                                  ;
 32585                                  ;Note: ITEM_TAG is 0FFH when the caller does not specify the choice
 32586                                  ;      list.
 32587                                  ;
 32588                                  ;      YEAR: If the input value for the year is less than 100, parser
 32589                                  ;	     adds 1900 to it. For example, when 87 is input to parser for
 32590                                  ;	     the year value, he returns 1987.
 32591                                  ;----------------------------------------------------------------------------
 32592                                  
 32593                                  ;-------------------------------- Result block structure
 32594                                  struc $P_RESULT_BLK;
 32595 00000000 ??                      .$P_Type:	 resb 1		;AN000; Type returned
 32596 00000001 ??                      .$P_Item_Tag:	 resb 1		;AN000; Matched item tag
 32597 00000002 ????                    .$P_SYNONYM_Ptr: resw 1		;AN000; pointer to Synonym list returned
 32598 00000004 ????????                .$P_Picked_Val:	 resb 4		;AN000; value
 32599                                  endstruc
 32600                                  
 32601                                  ;**** values for the type field in the result block
 32602                                  
 32603                                  $P_EOL		 equ 0		;AN000; End of line
 32604                                  $P_Number	 equ 1		;AN000; Number
 32605                                  $P_List_Idx	 equ 2		;AN000; List Index
 32606                                  $P_String	 equ 3		;AN000; String
 32607                                  $P_Complex	 equ 4		;AN000; Complex
 32608                                  $P_File_Spec	 equ 5		;AN000; File Spec
 32609                                  $P_Drive	 equ 6		;AN000; Drive
 32610                                  $P_Date_F	 equ 7		;AN000; Date
 32611                                  $P_Time_F	 equ 8		;AN000; Time
 32612                                  $P_Quoted_String equ 9		;AN000; Quoted String
 32613                                  
 32614                                  $P_No_Tag	 equ 0FFh	;AN000; No ITEM_TAG found
 32615                                  
 32616                                  ;**** Return code
 32617                                  ;
 32618                                  ; following return code will be returned in the AX register.
 32619                                  
 32620                                  $P_No_Error	 equ 0		;AN000; No error
 32621                                  $P_Too_Many	 equ 1		;AN000; Too many operands
 32622                                  $P_Op_Missing	 equ 2		;AN000; Required operand missing
 32623                                  $P_Not_In_SW	 equ 3		;AN000; Not in switch list provided
 32624                                  $P_Not_In_Key	 equ 4		;AN000; Not in keyword list provided
 32625                                  $P_Out_Of_Range  equ 6		;AN000; Out of range specified
 32626                                  $P_Not_In_Val	 equ 7		;AN000; Not in value list provided
 32627                                  $P_Not_In_Str	 equ 8		;AN000; Not in string list provided
 32628                                  $P_Syntax	 equ 9		;AN000; Syntax error
 32629                                  $P_RC_EOL	 equ -1		;AN000; End of command line
 32630                                  
 32631                                  ;in second byte of $P_Flags, referenced as $P_Flags2:
 32632                                  $P_equ		 equ 01h	;AN000; "=" packed in string buffet
 32633                                  $P_Neg		 equ 02h	;AN000; Negative value
 32634                                  $P_Time12	 equ 04h	;AN000; set when PM is specified
 32635                                  $P_Key_Cmp	 equ 08h	;AN000; set when keyword compare
 32636                                  $P_SW_Cmp	 equ 10h	;AN000; set when switch compare
 32637                                  $P_Extra	 equ 20h	;AN000; set when extra delimiter found
 32638                                  $P_SW		 equ 40h	;AN000; set when switch found (tm08)
 32639                                  $P_Signed	 equ 80h	;AN000; signed numeric specified
 32640                                  
 32641                                  ;-------- Masks
 32642                                  $P_Make_Lower	 equ 20h	;AN000; make lower case character
 32643                                  $P_Make_Upper	 equ 0FFh-$P_Make_Lower ;AN000; make upper case character
 32644                                  
 32645                                  ;-------------
 32646                                  
 32647                                  struc $P_DOS_TBL
 32648 00000000 ??                      .$P_DOS_InfoID:	 resb 1		;AN000; information id for the table
 32649 00000001 ????                    .$P_DOS_TBL_Off: resw 1		;AN000; offset address of the table
 32650 00000003 ????                    .$P_DOS_TBL_Seg: resw 1		;AN000; segment address of the table
 32651                                  endstruc
 32652                                  
 32653                                  $P_DOS_Get_TBL	 equ 65h	;AN000; get uppercase table call
 32654                                  				;AN000; following parameters are set
 32655                                  				;AN000; to get casemap table.
 32656                                  $P_DOSTBL_Def	 equ -1		;AN000; get default
 32657                                  $P_DOSTBL_BL	 equ 5		;AN000; buffer length for Tbl pointer
 32658                                  $P_DOSTBL_File	 equ 4		;AN000; get file uppercase table
 32659                                  $P_DOSTBL_Char	 equ 2		;AN000; get character uppercase table
 32660                                  				; By this call following information
 32661                                  				; is returned.
 32662                                  
 32663                                  ; 03/04/2023
 32664                                  ;-------------------------------- country dependent information
 32665                                  
 32666                                  $P_DOS_Get_CDI	equ 3800h
 32667                                  
 32668                                  struc $P_CDI
 32669 00000000 ????                    .$P_CDI_DateF:	resw 1		;AN000;
 32670 00000002 ????????                .$P_CDI_Money:	resb 4		;AN000;
 32671 00000006 ????                    .$P_CDI_1000:	resb 2		;AN000;
 32672 00000008 ????                    .$P_CDI_Dec:	resb 2		;AN000;
 32673 0000000A ????                    .$P_CDI_DateS:	resb 2		;AN000;
 32674 0000000C ????                    .$P_CDI_TimeS:	resb 2		;AN000;
 32675 0000000E ??                      		resb 1		;AN000;
 32676 0000000F ??                      		resb 1		;AN000;
 32677 00000010 ??                      .$P_CDI_TimeF:	resb 1		;AN000;
 32678 00000011 ????????                		resw 2		;AN000;
 32679 00000015 ????                    		resb 2		;AN000;
 32680 00000017 <res Ah>                		resw 5		;AN000;
 32681                                  endstruc
 32682                                  
 32683                                  $P_Date_MDY	equ 0		;AN000;
 32684                                  $P_Date_DMY	equ 1		;AN000;
 32685                                  $P_Date_YMD	equ 2		;AN000;
 32686                                  
 32687                                  ; ----------------------------
 32688                                  ; (PARSE.ASM, MSDOS 6.0, 1991)
 32689                                  ; ----------------------------
 32690                                  
 32691                                  ;***********************************************************************
 32692                                  ; SysParse;
 32693                                  ;
 32694                                  ;  Function : Parser Entry
 32695                                  ;
 32696                                  ;  Input: DS:SI -> command line
 32697                                  ;	  ES:DI -> parameter block
 32698                                  ;	  psdata_seg -> psdata.inc
 32699                                  ;	  CX = operand ordinal
 32700                                  ;
 32701                                  ;	  Note:  ES is the segment containing all the control blocks defined
 32702                                  ;		 by the caller, except for the DOS COMMAND line parms, which
 32703                                  ;		 is in DS.
 32704                                  ;
 32705                                  ;  Output: CY = 1   error of caller, means invalid parameter block or
 32706                                  ;		    invalid value list. But this parser does NOT implement
 32707                                  ;		    this feature. Therefore CY always zero.
 32708                                  ;
 32709                                  ;	   CY = 0   AX = return code
 32710                                  ;		    BL = terminated delimiter code
 32711                                  ;		    CX = new operand ordinal
 32712                                  ;		    SI = set past scaned operand
 32713                                  ;		    DX = selected result buffer
 32714                                  ;
 32715                                  ; Use:	$P_Skip_Delim, $P_Chk_EOL, $P_Chk_Delim, $P_Chk_DBCS
 32716                                  ;	$P_Chk_Swtch, $P_Chk_Pos_Control, $P_Chk_Key_Control
 32717                                  ;	$P_Chk_Sw_Control, $P_Fill_Result
 32718                                  ;
 32719                                  ; Vars: $P_Ordinal(RW), $P_RC(RW), $P_SI_Save(RW), $P_DX(R), $P_Terminator(R)
 32720                                  ;	$P_SaveSI_Cmpx(W), $P_Flags(RW), $P_Found_SYNONYM(R), $P_Save_EOB(W)
 32721                                  ;
 32722                                  ;-------- Modification History -----------------------------------------
 32723                                  ;
 32724                                  ;  4/04/87 : Created by K. K,
 32725                                  ;  4/28/87 : $P_Val_YH assemble error (tm01)
 32726                                  ;	   : JMP SHORT assemble error (tm02)
 32727                                  ;  5/14/87 : Someone doesn't want to include psdata (tm03)
 32728                                  ;  6/12/87 : $P_Bridge is missing when TimeSw equ 0 and (CmpxSw equ 1 or
 32729                                  ;	     DateSW equ 1)	      (tm04)
 32730                                  ;  6/12/87 : $P_SorD_Quote is missing when QusSw equ 0 and CmpxSW equ 1
 32731                                  ;				      (tm05) in PSDATA.INC
 32732                                  ;  6/12/87 : $P_FileSp_Char and $P_FileSP_Len are missing
 32733                                  ;	     when FileSW equ 0 and DrvSW equ 1 (tm06) in PSDATA.INC
 32734                                  ;  6/18/87 : $VAL1 and $VAL3, $VAL2 and $VAL3 can be used in the same
 32735                                  ;	     value-list block	      (tm07)
 32736                                  ;  6/20/87 : Add $P_SW to check if there's an omiting parameter after
 32737                                  ;	     switch (keyword) or not. If there is, backup si for next call
 32738                                  ;	     (tm08)
 32739                                  ;  6/24/87 : Complex Item checking does not work correctly when CmpSW equ 1
 32740                                  ;	     and DateSW equ 0 and TimeSW equ 0 (tm09)
 32741                                  ;  6/24/87 : New function flag $P_colon_is_not_necessary for switch
 32742                                  ;	     /+15 and /+:15 are allowed for user (tm10)
 32743                                  ;  6/29/87 : ECS call changes DS register but it causes the address problem
 32744                                  ;	     in user's routines. $P_Chk_DBCS (tm11)
 32745                                  ;  7/10/87 : Switch with no_match flag (0x0000H) does not work correctly
 32746                                  ;					  (tm12)
 32747                                  ;  7/10/87 : Invalid switch/keyword does not work correctly
 32748                                  ;					  (tm13)
 32749                                  ;  7/10/87 : Drive_only breaks 3 bytes after the result buffer
 32750                                  ;					  (tm14)
 32751                                  ;  7/12/87 : Too_Many_Operands sets DX=0 as the PARSE result
 32752                                  ;					  (tm15)
 32753                                  ;  7/24/87 : Negative lower bound on numeric ranges cause trouble
 32754                                  ;
 32755                                  ;  7/24/87 : Quoted strings being returned with quotes.
 32756                                  ;
 32757                                  ;  7/28/87 : Kerry S (;AN018;)
 32758                                  ;	     Non optional value on switch (match flags<>0 and <>1) not flagged
 32759                                  ;	     as an error when missing.	Solution: return error 2.  Modules
 32760                                  ;	     affected: $P_Chk_SW_Control.
 32761                                  ;
 32762                                  ;  7/29/87 : Kerry S (;AN019;)
 32763                                  ;	     Now allow the optional bit in match flags for switches.  This
 32764                                  ;	     allows the switch to be encountered with a value or without a
 32765                                  ;	     value and no error is returned.
 32766                                  ;
 32767                                  ;
 32768                                  ;  8/28/87 : Ed K, Kerry S (;AN020;)
 32769                                  ;  9/14/87   In PROC $P_Get_DecNum, when checking for field separators
 32770                                  ;	     within a date response, instead of checking just for the one
 32771                                  ;	     character defined by the COUNTRY DEPENDENT INFO, check for
 32772                                  ;	     all three chars, "-", "/", and ".". Change $P_Chk_Switch to allow
 32773                                  ;	     slashes in date strings when DateSw (assembler switch) is set.
 32774                                  ;
 32775                                  ;  9/1/87  : Kerry S (;AN021)
 32776                                  ;	     In PROC $P_String_Comp, when comparing the switch or keyword on
 32777                                  ;	     the command line with the string in the control block the
 32778                                  ;	     comparing was stopping at a colon (switch) or equal (keyword)
 32779                                  ;	     on the command line and assuming a match.	This allowed a shorter
 32780                                  ;	     string on the command line than in the synonym list in the control
 32781                                  ;	     block.  I put in a test for a null in the control block so the
 32782                                  ;	     string in the control block must be the same length as the string
 32783                                  ;	     preceeding the colon or equal on the command line.
 32784                                  ;
 32785                                  ;  8/28/87 : Kerry S (;AN022;)
 32786                                  ;	     All references to data in PSDATA.INC had CS overrides.  This caused
 32787                                  ;	     problems for people who included it themselves in a segment other
 32788                                  ;	     than CS.  Added switch to allow including PSDATA.INC in any
 32789                                  ;	     segment.
 32790                                  ;
 32791                                  ;  9/16/87 : Ed K (;AN023;) PTM1040
 32792                                  ;	     in $p_set_cdi PROC, it assumes CS points to psdata. Change Push CS
 32793                                  ;	     into PUSH PSDATA_SEG.  In $P_Get_DecNum PROC, fix AN020
 32794                                  ;	     forced both TIME and DATE to use the delims, "-","/",".".
 32795                                  ;	     Created FLag, in $P_time_Format PROC, to request the delim in
 32796                                  ;	     BL be used if TIME is being parsed.
 32797                                  ;
 32798                                  ;  9/24/87 : Ed K
 32799                                  ;	     Removed the include to STRUC.INC.	Replaced the STRUC macro
 32800                                  ;	     invocations with their normally expanded code; made comments
 32801                                  ;	     out of the STRUC macro invocation statements to maintain readability.
 32802                                  ;
 32803                                  ;  9/24/87 : Ed K (;AN024;) PTM1222
 32804                                  ;	     When no CONTROL for a keyword found, tried to fill in RESULT
 32805                                  ;	     pointed to by non-existant CONTROL.
 32806                                  ;
 32807                                  ; 10/15/87 : Ed K (;AN025;) PTM1672
 32808                                  ;	     A quoted text string can be framed only by double quote.  Remove
 32809                                  ;	     support to frame quoted text string with single quote.
 32810                                  ;	     (apostrophe) $P_SorD_Quote is removed from PSDATA.INC.
 32811                                  ;	     $P_SQuote EQU also removed from PSDATA.INC.  Any references to
 32812                                  ;	     single quote in PROC prologues are left as is for history reasons.
 32813                                  ;
 32814                                  ;	     This fixes another bug, not mentioned in p1672, in that two
 32815                                  ;	     quote chars within a quoted string is supposed to be reported as
 32816                                  ;	     one quote character, but is reported as two quotes.  This changed
 32817                                  ;	     two instructions in PROC $P_Quoted_Str.
 32818                                  ;
 32819                                  ;	     Also fixed are several JMP that caused a NOP, these changed to
 32820                                  ;	     have the SHORT operator to avoid the unneeded NOP.
 32821                                  ;
 32822                                  ;	     The code and PSDATA.INC have been aligned for ease of reading.
 32823                                  ;
 32824                                  ; 10/26/87 : Ed K (;AN026;) PTM2041, DATE within SWITCH, BX reference to
 32825                                  ;	     psdata buffer should have psdata_seg.
 32826                                  ;
 32827                                  ; 10/27/87 : Ed K (;AN027;) PTM2042 comma between keywords implies
 32828                                  ;	     positional missing.
 32829                                  ;
 32830                                  ; 11/06/87 : Ed K (;AN028;) PTM 2315 Parser should not use line feed
 32831                                  ;	     as a line delimiter, should use carriage return.
 32832                                  ;	     Define switch: LFEOLSW, if on, accept LF as end of line char.
 32833                                  ;
 32834                                  ; 11/11/87 : Ed K (;AN029;) PTM 1651 GET RID OF WHITESPACE AROUND "=".
 32835                                  ;
 32836                                  ; 11/18/87 : Ed K (;AN030;) PTM 2551 If filename is just "", then
 32837                                  ;	     endless loop since SI is returned still pointing to start
 32838                                  ;	     of that parm.
 32839                                  ;
 32840                                  ; 11/19/87 : Ed K (;AN031;) PTM 2585 date & time getting bad values.
 32841                                  ;	     Vector to returned string has CS instead of Psdata_Seg, but
 32842                                  ;	     when tried to fix it on previous version, changed similar
 32843                                  ;	     but wrong place.
 32844                                  ;
 32845                                  ; 12/09/87 : Bill L (;AN032;) PTM 2772 colon and period are now valid
 32846                                  ;	     delimiters between hours, minutes, seconds for time. And period
 32847                                  ;	     and comma are valid delimiters between seconds and 100th second.
 32848                                  ;
 32849                                  ; 12/14/87 : Bill L (;AN033;) PTM 2722 if illegal delimiter characters
 32850                                  ;	     in a filespec, then flag an error.
 32851                                  ;
 32852                                  ; 12/22/87 : Bill L (;AN034;)	    All local data to parser is now
 32853                                  ;	     indexed off of the psdata_seg equate instead of the DS register.
 32854                                  ;	     Using this method, DS can point to the segment of PSP or to psdata
 32855                                  ;  -->	     local parser data. Why were some references to local data changed
 32856                                  ;	     to do this before, but not all ?????
 32857                                  ;
 32858                                  ; 02/02/88 : Ed K (;AC035;) INSPECT utility, suggests optimizations.
 32859                                  ;
 32860                                  ; 02/05/88 : Ed K (;AN036;) P3372-UPPERCASE TRANSLATION, PSDATA_SEG HOSED.
 32861                                  ;
 32862                                  ; 02/08/88 : Ed K (;AN037;) P3410-AVOID POP OF CS, CHECK BASESW FIRST.
 32863                                  ;
 32864                                  ; 02/19/88 : Ed K (;AN038;) p3524 above noon and "am" should be error
 32865                                  ;
 32866                                  ; 02/23/88 : Ed K (;AN039;) p3518 accept "comma" and "period" as decimal
 32867                                  ;	     separator in TIME before hundredths field.
 32868                                  ;
 32869                                  ; 08/09/90 : SA	M005	Prevented parser from recognizing '=' signs within
 32870                                  ;			strings as keywords.
 32871                                  ;
 32872                                  ;***********************************************************************
 32873                                  
 32874                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 32875                                  cmd_parse:
 32876                                  	;call	sysparse
 32877                                  	;retn
 32878                                  
 32879                                  ; -----------------------------------
 32880                                  
 32881                                  	; 29/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 32882                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:44E7h
 32883                                  
 32884                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 32885                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4CABh
 32886                                  
 32887                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 32888                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:4B73h
 32889                                  sysparse:
 32890 0000496C 2EC706[C597]0000        	mov	word [cs:$P_Flags],0	;AC034; Clear all internal flags
 32891 00004973 2E890E[4F98]            	mov	[cs:$P_ORIG_ORD],cx	;AN039; ORIGINAL ORDINAL FROM CX
 32892 00004978 2E8926[5198]            	mov	[cs:$P_ORIG_STACK],sp	;AN039; ORIGINAL VALUE OF STACK FROM SP
 32893 0000497D 2E8936[5398]            	mov	[cs:$P_ORIG_SI],si	;AN039; ORIGINAL START PARSE POINTER FROM SI
 32894                                  $P_Redo_Time:				;AN039; try to parse time again
 32895 00004982 FC                      	cld				;AN000; confirm forward direction
 32896 00004983 2E890E[B897]            	mov	[cs:$P_ORDINAL],cx      ;AC034; save operand ordinal
 32897                                  	;mov	word [cs:$P_RC],$P_No_Error
 32898 00004988 2EC706[BA97]0000        	mov	word [cs:$P_RC],0	;AC034; Assume no error
 32899 0000498F 2EC706[CD97]0000        	mov	word [cs:$P_Found_SYNONYM],0
 32900                                  					;AC034; initalize synonym pointer
 32901 00004996 2EC706[BE97]0000        	mov	word [cs:$P_DX],0	;AC034; (tm15)
 32902                                  
 32903                                  ;M029 -- Begin changes
 32904                                  ; The table of special chars $P_FileSp_Char should be initialized on every
 32905                                  ;entry to SysParse. This is in the non-checksum region and any program that
 32906                                  ;corrupts this table but does not corrupt the checksum region will leave
 32907                                  ;command.com parsing in an inconsistent state.
 32908                                  ; NB: The special characters string has been hardcoded here. If any change
 32909                                  ;is made to it in psdata.inc, a corresponding change needs to be made here.
 32910                                  
 32911 0000499D 2EC706[8A98]5B5D        	mov	word [cs:$P_FileSp_Char], '[]'	 ; "[]|<>+=;\""
 32912 000049A4 2EC706[8C98]7C3C        	mov	word [cs:$P_FileSp_Char+2], '|<'
 32913 000049AB 2EC706[8E98]3E2B        	mov	word [cs:$P_FileSp_Char+4], '>+'
 32914 000049B2 2EC706[9098]3D3B        	mov 	word [cs:$P_FileSp_Char+6], '=;'
 32915                                  
 32916                                  ;M029 -- End of changes
 32917                                  
 32918 000049B9 E82809                  	call	$P_Skip_Delim		;AN000; Move si to 1st non white space
 32919 000049BC 7312                    	jnc	short $P_Start		;AN000; If EOL is not encountered, do parse
 32920                                  
 32921                                  ;--------------------------- End of Line
 32922                                  	;mov	ax,$P_RC_EOL		;AN000; set exit code to -1
 32923 000049BE B8FFFF                  	mov	ax,0FFFFh
 32924 000049C1 53                      	push	bx			;AN000;
 32925                                  	;mov	bx,[es:di+$P_PARMS_BLK.$P_PARMSX_Address]
 32926 000049C2 268B1D                  	mov	bx,[es:di]		;AN000; Get the PARMSX address to
 32927                                  	
 32928                                  	;cmp	cl,[es:bx+$P_PARMSX_BLK.$P_MinP]
 32929 000049C5 263A0F                  	cmp	cl,[es:bx]		;AN000; check ORDINAL to see if the minimum
 32930 000049C8 7304                    	jae	short $P_Fin		;AN000; positional found.
 32931                                  
 32932                                  	;mov	ax,2
 32933 000049CA B80200                  	mov	ax,$P_Op_Missing ; 2	;AN000; If no, set exit code to missing operand
 32934                                  	; 27/04/2023
 32935 000049CD F8                      	clc
 32936                                  $P_Fin: 				;AN000;
 32937 000049CE 5B                      	pop	bx			;AN000;
 32938                                  	;jmp	$P_Single_Exit		;AN000; return to the caller
 32939                                  	; 27/04/2023
 32940                                  	; cf = 0
 32941                                  	;clc
 32942 000049CF C3                      	retn
 32943                                  
 32944                                  ;---------------------------
 32945                                  $P_Start:				;AN000;
 32946 000049D0 2E8936[C797]            	mov	[cs:$P_SaveSI_Cmpx],si	;AN000;AC034; save ptr to command line for later use by complex,
 32947 000049D5 53                      	push	bx			;AN000; quoted string or file spec.
 32948 000049D6 57                      	push	di			;AN000;
 32949 000049D7 55                      	push	bp			;AN000;
 32950 000049D8 8D1E[CF97]              	lea	bx,$P_STRING_BUF	;AC034; set buffer to copy from command string
 32951 000049DC 2EF606[C697]20          	test	byte [cs:$P_Flags2],$P_Extra ; 20h
 32952                                  	;test	byte [cs:$P_Flags2],20h	;AC034; 3/9 extra delimiter encountered ?
 32953 000049E2 7543                    	jnz	short $P_Pack_End	;AN000; 3/9 if yes, no need to copy
 32954                                  $P_Pack_Loop:				;AN000;
 32955 000049E4 AC                      	lodsb				;AN000; Pick a operand from buffer
 32956 000049E5 E8AF09                  	call	$P_Chk_Switch		;AN000; Check switch character
 32957 000049E8 723C                    	jc	short $P_Pack_End_BY_EOL ;AN020; if carry set found delimiter type slash, need backup si, else continue
 32958                                  
 32959 000049EA E81909                  	call	$P_Chk_EOL		;AN000; Check EOL character
 32960 000049ED 7437                    	je	short $P_Pack_End_BY_EOL ;AN000; need backup si
 32961                                  
 32962 000049EF E84609                  	call	$P_Chk_Delim		;AN000; Check delimiter
 32963 000049F2 7518                    	jne	short $P_PL01 		;AN000; If no, process next byte
 32964                                  
 32965 000049F4 2EF606[C697]20          	test	byte [cs:$P_Flags2],$P_Extra ; 20h
 32966                                  	;test	byte [cs:$P_Flags2],20h ;AC034; 3/9 If yes and white spec,
 32967 000049FA 7505                    	jnz	short $P_Pack_End_backup_si
 32968                                  					;AN000; (tm08)
 32969 000049FC E8E508                  	call	$P_Skip_Delim		;AN000; skip subsequent white space,too
 32970 000049FF EB26                    	jmp	short $P_Pack_End	;AN000; finish copy by placing NUL at end
 32971                                  
 32972                                  $P_Pack_End_backup_si:			;AN000; (tm08)
 32973 00004A01 2EF606[C697]41          	test	byte [cs:$P_Flags2],$P_SW+$P_equ ; 41h
 32974                                  	;test	byte [cs:$P_Flags2],41h ;AN000;AC034;  (tm08)
 32975 00004A07 741E                    	jz	short $P_Pack_End	;AN000; (tm08)
 32976                                  
 32977 00004A09 4E                      	dec	si			;AN000; (tm08)
 32978 00004A0A EB1B                    	jmp	short $P_Pack_End	;AN025; (tm08)
 32979                                  $P_PL01:				;AN000;
 32980 00004A0C 2E8807                  	mov	[cs:bx],al		;AN000; move byte to STRING_BUF
 32981                                  	;cmp	al,'='
 32982 00004A0F 3C3D                    	cmp	al,$P_Keyword ; '='	;AN000; if it is equal character,
 32983 00004A11 7506                    	jne	short $P_PL00 		;AN000; then
 32984                                  
 32985 00004A13 2E800E[C697]01          	or	byte [cs:$P_Flags2],$P_equ
 32986                                  	;or	byte [cs:$P_Flags_2],1	;AC034; remember it in flag
 32987                                  $P_PL00:				;AN000;
 32988 00004A19 43                      	inc	bx			;AN000; ready to see next byte
 32989 00004A1A E8A509                  	call	$P_Chk_DBCS		;AN000; was it 1st byte of DBCS ?
 32990 00004A1D 73C5                    	jnc	short $P_Pack_Loop	;AN000; if no, process to next byte
 32991                                  
 32992 00004A1F AC                      	lodsb				;AN000; if yes, store
 32993 00004A20 2E8807                  	mov	[cs:bx],al		;AN000;    2nd byte of DBCS
 32994 00004A23 43                      	inc	bx			;AN000; update pointer
 32995 00004A24 EBBE                    	jmp	short $P_Pack_Loop	;AN000; process to next byte
 32996                                  
 32997                                  $P_Pack_End_BY_EOL:			;AN000;
 32998 00004A26 4E                      	dec	si			;AN000; backup si pointer
 32999                                  $P_Pack_End:				;AN000;
 33000 00004A27 2E8936[BC97]            	mov	[cs:$P_SI_Save],si	;AC034; save next pointer, SI
 33001                                  	;mov	byte [cs:bx],0
 33002 00004A2C 2EC60700                	mov	byte [cs:bx],$P_NULL	;AN000; put NULL at the end
 33003 00004A30 2E891E[CB97]            	mov	[cs:$P_Save_EOB],bx
 33004                                  					;AC034; 3/17/87 keep the address for later use of complex
 33005                                  	;mov	bx,[es:di+$P_PARMS_BLK.$P_PARMSX_Address]
 33006 00004A35 268B1D                  	mov	bx,[es:di]		;AN000; get PARMSX address
 33007 00004A38 8D36[CF97]              	lea	si,$P_STRING_BUF	;AC034;
 33008                                  	;cmp	byte [cs:si],'/'
 33009 00004A3C 2E803C2F                	cmp	byte [cs:si],$P_Switch	;AN000; the operand begins w/ switch char ?
 33010 00004A40 7442                    	je	short $P_SW_Manager	;AN000; if yes, process as switch
 33011                                  
 33012 00004A42 2E803C22                	cmp	byte [cs:si],$P_DQuote	;M005;is it a string?
 33013 00004A46 7408                    	je	short $P_Positional_Manager
 33014                                  					;M005;if so, process as one!
 33015 00004A48 2EF606[C697]01          	test	byte [cs:$P_Flags2],$P_equ
 33016                                  	;test	byte [cs:$P_Flags2],1	;AC034; the operand includes equal char ?
 33017 00004A4E 7556                    	jnz	short $P_Key_Manager	;AN000; if yes, process as keyword
 33018                                  
 33019                                  $P_Positional_Manager:			;AN000; else process as positional
 33020                                  	;mov	al,[es:bx+1]		;AN000; get maxp
 33021 00004A50 268A4701                	mov	al,[es:bx+$P_PARMSX_BLK.$P_MaxP]
 33022 00004A54 30E4                    	xor	ah,ah			;AN000; ax = maxp
 33023 00004A56 2E3906[B897]            	cmp	[cs:$P_ORDINAL],ax	;AC034; too many positional ?
 33024 00004A5B 7312                    	jae	short $P_Too_Many_Error	;AN000; if yes, set exit code to too many
 33025                                  
 33026 00004A5D 2EA1[B897]              	mov	ax,[cs:$P_ORDINAL]	;AC034; see what the current ordinal
 33027 00004A61 D1E0                    	shl	ax,1			;AN000; ax = ax*2
 33028 00004A63 43                      	inc	bx			;AC035; add '2' to
 33029 00004A64 43                      	inc	bx			;AC035;  BX reg
 33030                                  					;AN000; now bx points to 1st CONTROL
 33031 00004A65 01C3                    	add	bx,ax			;AN000; now bx points to specified CONTROL address
 33032 00004A67 268B1F                  	mov	bx,[es:bx]		;AN000; now bx points to specified CONTROL itself
 33033 00004A6A E88000                  	call	$P_Chk_Pos_Control	;AN000; Do process for positional
 33034 00004A6D EB61                    	jmp	short $P_Return_to_Caller
 33035                                  					;AN000; and return to the caller
 33036                                  $P_Too_Many_Error:			;AN000;
 33037                                  	;mov	word [cs:$P_RC],1
 33038 00004A6F 2EC706[BA97]0100        	mov	word [cs:$P_RC],$P_Too_Many
 33039                                  					;AC034; set exit code
 33040 00004A76 EB58                    	jmp	short $P_Return_to_Caller
 33041                                  					;AN000; and return to the caller
 33042                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 33043                                  %if 0
 33044                                  $P_SW_Manager:				;AN000;
 33045                                  	;mov	al,[es:bx+1]		;AN000; get maxp
 33046                                  	mov	al,[es:bx+$P_PARMSX_BLK.$P_MaxP]
 33047                                  	xor	ah,ah			;AN000; ax = maxp
 33048                                  	inc	ax			;AN000;
 33049                                  	shl	ax,1			;AN000; ax = (ax+1)*2
 33050                                  	add	bx,ax			;AN000; now bx points to maxs
 33051                                  	mov	cl,[es:bx]		;AN000;
 33052                                  	xor	ch,ch			;AN000; cx = maxs
 33053                                  	or	cx,cx			;AN000; at least one switch ?
 33054                                  	jz	short $P_SW_Not_Found 	;AN000;
 33055                                  	inc	bx			;AN000; now bx points to 1st CONTROL address
 33056                                  %else
 33057                                  $P_get_max_ptr:
 33058                                  	;mov	al,[es:bx+1]		; get maxp
 33059 00004A78 268A4701                	mov	al,[es:bx+$P_PARMSX_BLK.$P_MaxP]
 33060 00004A7C 30E4                    	xor	ah,ah			; ax = maxp
 33061 00004A7E 40                      	inc	ax
 33062 00004A7F D1E0                    	shl	ax,1			; ax = (ax+1)*2
 33063 00004A81 01C3                    	add	bx,ax			; now bx points to maxs
 33064 00004A83 C3                      	retn
 33065                                  
 33066                                  $P_SW_Manager:
 33067 00004A84 E8F1FF                  	call	$P_get_max_ptr
 33068 00004A87 268A0F                  	mov	cl,[es:bx]
 33069 00004A8A 30ED                    	xor	ch,ch			; cx = maxs
 33070                                  					; at least one switch ?
 33071 00004A8C E30F                    	jcxz	$P_SW_Not_Found 	; no
 33072 00004A8E 43                      	inc	bx			; now bx points to 1st CONTROL address
 33073                                  %endif
 33074                                  
 33075                                  $P_SW_Mgr_Loop: 			;AN000;
 33076 00004A8F 53                      	push	bx			;AN000;
 33077 00004A90 268B1F                  	mov	bx,[es:bx]		;AN000; bx points to Switch CONTROL itself
 33078 00004A93 E8B700                  	call	$P_Chk_SW_Control	;AN000; do process for switch
 33079 00004A96 5B                      	pop	bx			;AN000;
 33080 00004A97 7337                    	jnc	short $P_Return_to_Caller
 33081                                  					;AN000; if the CONTROL is for the switch, exit
 33082 00004A99 43                      	inc	bx			;AC035; add '2' to
 33083 00004A9A 43                      	inc	bx			;AC035;  BX reg
 33084                                  					;AN000; else bx points to the next CONTROL
 33085 00004A9B E2F2                    	loop	$P_SW_Mgr_Loop		;AN000; and loop
 33086                                  $P_SW_Not_Found:			;AN000;
 33087                                  	;mov	word [cs:$P_RC],3
 33088 00004A9D 2EC706[BA97]0300        	mov	word [cs:$P_RC],$P_Not_In_SW
 33089                                  					;AC034; here no CONTROL for the switch has
 33090 00004AA4 EB2A                    	jmp	short $P_Return_to_Caller0
 33091                                  					;AN000; not been found, means error.
 33092                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 33093                                  %if 0
 33094                                  $P_Key_Manager: 			;AN000;
 33095                                  	;mov	al,[es:bx+1]		;AN000; get maxp
 33096                                  	mov	al,[es:bx+$P_PARMSX_BLK.$P_MaxP]
 33097                                  	xor	ah,ah			;AN000; ax = maxp
 33098                                  	inc	ax			;AN000;
 33099                                  	shl	ax,1			;AN000; ax = (ax+1)*2
 33100                                  	add	bx,ax			;AN000; now bx points to maxs
 33101                                  	mov	al,[es:bx]		;AN000;
 33102                                  	xor	ah,ah			;AN000; ax = maxs
 33103                                  	shl	ax,1			;AN000;
 33104                                  	inc	ax			;AN000; ax = ax*2+1
 33105                                  	add	bx,ax			;AN000; now bx points to maxk
 33106                                  	mov	cl,[es:bx]		;AN000;
 33107                                  	xor	ch,ch			;AN000; cx = maxk
 33108                                  	or	cx,cx			;AN000; at least one keyword ?
 33109                                  	jz	short $P_Key_Not_Found	;AN000;
 33110                                  	inc	bx			;AN000; now bx points to 1st CONTROL
 33111                                  %else
 33112                                  $P_Key_Manager:
 33113 00004AA6 E8CFFF                  	call	$P_get_max_ptr
 33114 00004AA9 268A07                  	mov	al,[es:bx]
 33115 00004AAC 30E4                    	xor	ah,ah			; ax = maxs
 33116 00004AAE D1E0                    	shl	ax,1
 33117 00004AB0 40                      	inc	ax			; ax = ax*2+1
 33118 00004AB1 01C3                    	add	bx,ax			; now bx points to maxk
 33119 00004AB3 268A0F                  	mov	cl,[es:bx]
 33120 00004AB6 30ED                    	xor	ch,ch			; cx = maxk
 33121                                  					; at least one keyword ?
 33122 00004AB8 E30F                    	jcxz	$P_Key_Not_Found
 33123 00004ABA 43                      	inc	bx			; now bx points to 1st CONTROL
 33124                                  %endif
 33125                                  
 33126                                  $P_Key_Mgr_Loop:			;AN000;
 33127 00004ABB 53                      	push	bx			;AN000;
 33128 00004ABC 268B1F                  	mov	bx,[es:bx]		;AN000; bx points to keyword CONTROL itself
 33129 00004ABF E85A00                  	call	$P_Chk_Key_Control	;AN000; do process for keyword
 33130 00004AC2 5B                      	pop	bx			;AN000;
 33131 00004AC3 730B                    	jnc	short $P_Return_to_Caller
 33132                                  					;AN000; if the CONTROL is for the keyword, exit
 33133 00004AC5 43                      	inc	bx			;AC035; add '2' to
 33134 00004AC6 43                      	inc	bx			;AC035;  BX reg
 33135                                  					;AN000; else bx points to the next CONTROL
 33136 00004AC7 E2F2                    	loop	$P_Key_Mgr_Loop 	;AN000; and loop
 33137                                  $P_Key_Not_Found:			;AN000;
 33138                                  	;mov	word [cs:$P_RC],4
 33139 00004AC9 2EC706[BA97]0400        	mov	word [cs:$P_RC],$P_Not_In_Key
 33140                                  					;AC034; here no CONTROL for the keyword has
 33141                                  $P_Return_to_Caller0:
 33142                                  $P_Return_to_Caller:			;AN000; not been found, means error.
 33143 00004AD0 5D                      	pop	bp			;AN000;
 33144 00004AD1 5F                      	pop	di			;AN000;
 33145 00004AD2 5B                      	pop	bx			;AN000;
 33146 00004AD3 2E8B0E[B897]            	mov	cx,[cs:$P_ORDINAL]	;AC034; return next ordinal
 33147 00004AD8 2EA1[BA97]              	mov	ax,[cs:$P_RC]		;AC034; return exit code
 33148 00004ADC 2E8B36[BC97]            	mov	si,[cs:$P_SI_Save]	;AC034; return next operand pointer
 33149 00004AE1 2E8B16[BE97]            	mov	dx,[cs:$P_DX]		;AC034; return result buffer address
 33150 00004AE6 2E8A1E[C097]            	mov	bl,[cs:$P_Terminator]	;AC034; return delimiter code found
 33151                                  $P_Single_Exit: 			;AN000;
 33152 00004AEB F8                      	clc				;AN000;
 33153 00004AEC C3                      	retn				;AN000;
 33154                                  
 33155                                  ;***********************************************************************
 33156                                  ; $P_Chk_Pos_Control
 33157                                  ;
 33158                                  ; Function: Parse CONTROL block for a positional
 33159                                  ;
 33160                                  ; Input:     ES:BX -> CONTROL block
 33161                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 33162                                  ;
 33163                                  ; Output:    None
 33164                                  ;
 33165                                  ; Use:	 $P_Fill_Result, $P_Check_Match_Flags
 33166                                  ;
 33167                                  ; Vars: $P_Ordinal(W), $P_RC(W)
 33168                                  ;***********************************************************************
 33169                                  
 33170                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33171                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4671h
 33172                                  
 33173                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33174                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4E35h
 33175                                  
 33176                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33177                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:4CF5h
 33178                                  $P_Chk_Pos_Control:
 33179 00004AED 50                      	push	ax			;AN000;
 33180                                  	;mov	ax,[es:bx+$P_CONTROL_BLK.$P_Match_Flag]
 33181 00004AEE 268B07                  	mov	ax,[es:bx]		;AN000;
 33182                                  	;test	ax,2
 33183 00004AF1 A90200                  	test	ax,$P_Repeat		;AN000; repeat allowed ?
 33184 00004AF4 7505                    	jnz	short $P_CPC00		;AN000; then do not increment ORDINAL
 33185                                  
 33186 00004AF6 2EFF06[B897]            	inc	word [cs:$P_ORDINAL]	;AC034; update the ordinal
 33187                                  $P_CPC00:				;AN000;
 33188                                  	;cmp	byte [cs:si],0
 33189 00004AFB 2E803C00                	cmp	byte [cs:si],$P_NULL	;AN000; no data ?
 33190 00004AFF 7516                    	jne	short $P_CPC01		;AN000;
 33191                                  
 33192                                  	;test	ax,1
 33193 00004B01 A90100                  	test	ax,$P_Optional		;AN000; yes, then is it optional ?
 33194 00004B04 7509                    	jnz	short $P_CPC02		;AN000;
 33195                                  
 33196 00004B06 2EC706[BA97]0200        	mov	word [cs:$P_RC],$P_Op_Missing ; 2
 33197                                  					;AC034; no, then error	 3/17/87
 33198 00004B0D EB0B                    	jmp	short $P_CPC_Exit	;AN000;
 33199                                  $P_CPC02:				;AN000;
 33200                                  	; 27/04/2023
 33201                                  	;push	ax ; *			;AN000;
 33202                                  	;
 33203                                  	;;mov	al,3
 33204                                  	;mov	al,$P_String		;AN000; if it is optional return NULL
 33205                                  	;;mov	ah,0FFh
 33206                                  	;mov	ah,$P_No_Tag		;AN000; no item tag indication
 33207                                  	; 31/03/2023
 33208 00004B0F B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 33209 00004B12 E89500                  	call	$P_Fill_Result		;AN000;
 33210                                  	; 27/04/2023
 33211                                  	;pop	ax ; *			;AN000;
 33212 00004B15 EB03                    	jmp	short $P_CPC_Exit	;AN000;
 33213                                  $P_CPC01:				;AN000;
 33214 00004B17 E81101                  	call	$P_Check_Match_Flags	;AN000;
 33215                                  $P_CPC_Exit:				;AN000;
 33216 00004B1A 58                      	pop	ax			;AN000;
 33217 00004B1B C3                      	retn				;AN000;
 33218                                  
 33219                                  ;***********************************************************************
 33220                                  ; $P_Chk_Key_Control
 33221                                  ;
 33222                                  ; Function: Parse CONTROL block for a keyword
 33223                                  ;
 33224                                  ; Input:     ES:BX -> CONTROL block
 33225                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 33226                                  ;
 33227                                  ; Output:    CY = 1 : not match
 33228                                  ;
 33229                                  ; Use:	 $P_Fill_Result, $P_Search_KEYorSW, $P_Check_Match_Flags
 33230                                  ;
 33231                                  ; Vars: $P_RC(W), $P_SaveSI_Cmpx(W), $P_KEYorSW_Ptr(R), $P_Flags(W)
 33232                                  ;***********************************************************************
 33233                                  
 33234                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33235                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33236                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33237                                  $P_Chk_Key_Control:			;AN000;
 33238 00004B1C F9                      	stc				;AN000;this logic works when the KeySW
 33239 00004B1D C3                      	retn				;AN000;is reset.
 33240                                  
 33241                                  ;***********************************************************************
 33242                                  ; $P_Search_KEYorSW:
 33243                                  ;
 33244                                  ; Function: Seach specified keyword or switch from CONTROL
 33245                                  ;
 33246                                  ; Input:     ES:BX -> CONTROL block
 33247                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 33248                                  ;
 33249                                  ; Output:    CY = 1 : not match
 33250                                  ;
 33251                                  ; Use:	 $P_String_Comp, $P_MoveBP_NUL, $P_Found_SYNONYM
 33252                                  ;***********************************************************************
 33253                                  
 33254                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33255                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33256                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33257                                  $P_Search_KEYorSW:
 33258 00004B1E 55                      	push	bp			;AN000;
 33259 00004B1F 51                      	push	cx			;AN000;
 33260 00004B20 268A4F08                	mov	cl,[es:bx+$P_CONTROL_BLK.$P_nid]
 33261                                  	;mov	cl,[es:bx+8]		;AN000; Get synonym count
 33262                                  	; 14/06/2023
 33263                                  	;xor	ch,ch			;AN000; and set it to cx
 33264                                  	;or	cx,cx			;AN000; No synonyms specified ?
 33265 00004B24 08C9                    	or	cl,cl
 33266 00004B26 740E                    	jz	short $P_KEYorSW_Not_Found
 33267                                  					;AN000; then indicate not found by CY
 33268 00004B28 268D6F09                	lea	bp,[es:bx+$P_CONTROL_BLK.$P_KEYorSW]
 33269                                  	;lea	bp,[es:bx+9]		;AN000; BP points to the 1st synonym
 33270                                  $P_KEYorSW_Loop:			;AN000;
 33271 00004B2C E8E703                  	call	$P_String_Comp		;AN000; compare string in buffer w/ the synonym
 33272 00004B2F 7308                    	jnc	short $P_KEYorSW_Found	;AN000; If match, set it to synonym pointer
 33273 00004B31 E80D00                  	call	$P_MoveBP_NUL		;AN000; else, bp points to the next string
 33274 00004B34 E2F6                    	loop	$P_KEYorSW_Loop 	;AN000; loop nid times
 33275                                  $P_KEYorSW_Not_Found:			;AN000;
 33276 00004B36 F9                      	stc				;AN000; indicate not found in synonym list
 33277 00004B37 EB05                    	jmp	short $P_KEYorSW_Exit	;AN000; and exit
 33278                                  $P_KEYorSW_Found:			;AN000;
 33279 00004B39 2E892E[CD97]            	mov	[cs:$P_Found_SYNONYM],bp
 33280                                  					;AC034; set synonym pointer
 33281                                  	; 27/04/2023
 33282                                  	; cf = 0
 33283                                  	;clc				;AN000; indicate found
 33284                                  $P_KEYorSW_Exit:			;AN000;
 33285 00004B3E 59                      	pop	cx			;AN000;
 33286 00004B3F 5D                      	pop	bp			;AN000;
 33287 00004B40 C3                      	retn				;AN000;
 33288                                  
 33289                                  ;***********************************************************************
 33290                                  ; $P_MoveBP_NUL
 33291                                  ;***********************************************************************
 33292                                  
 33293                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33294                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33295                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33296                                  $P_MoveBP_NUL:
 33297                                  $P_MBP_Loop:				;AN000;
 33298                                  	;cmp	byte [es:bp+0],0
 33299 00004B41 26807E0000              	cmp	byte [es:bp],$P_NULL	;AN000; Increment BP that points
 33300 00004B46 7403                    	je	short $P_MBP_Exit	;AN000; to the synomym list
 33301 00004B48 45                      	inc	bp			;AN000; until
 33302 00004B49 EBF6                    	jmp	short $P_MBP_Loop	;AN000; NULL encountered.
 33303                                  $P_MBP_Exit:				;AN000;
 33304 00004B4B 45                      	inc	bp			;AN000; bp points to next to NULL
 33305 00004B4C C3                      	retn				;AN000;
 33306                                  
 33307                                  ;***********************************************************************
 33308                                  ; $P_Chk_SW_Control
 33309                                  ;
 33310                                  ; Function: Parse CONTROL block for a switch
 33311                                  ;
 33312                                  ; Input:     ES:BX -> CONTROL block
 33313                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 33314                                  ;
 33315                                  ; Output:    CY = 1 : not match
 33316                                  ;
 33317                                  ; Use:	 $P_Fill_Result, $P_Search_KEYorSW, $P_Check_Match_Flags
 33318                                  ;
 33319                                  ; Vars:  $P_SaveSI_Cmpx(W), $P_KEYorSW_Ptr(R), $P_Flags(W)
 33320                                  ;***********************************************************************
 33321                                  
 33322                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33323                                  	;
 33324                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33325                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4E9Ah
 33326                                  
 33327                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33328                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:4D57h
 33329                                  $P_Chk_SW_Control:
 33330 00004B4D 2E800E[C697]10          	or	byte [cs:$P_Flags2],$P_SW_Cmp
 33331                                  	;or	byte [cs:$P_Flags2],10h	;AC034; Indicate switch for later string comparison
 33332 00004B53 E8C8FF                  	call	$P_Search_KEYorSW	;AN000; Search the switch in the CONTROL block
 33333 00004B56 7251                    	jc	short $P_Chk_SW_Err0	;AN000; not found, then try next CONTROL
 33334                                  
 33335 00004B58 2E8026[C697]EF          	and	byte [cs:$P_Flags2],0FFh-$P_SW_Cmp
 33336                                  	;and	byte [cs:$P_Flags2],0EFh
 33337                                  					;AC034; reset the indicator previously set
 33338 00004B5E 50                      	push	ax			;AN000;       /switch:
 33339 00004B5F 2EA1[C997]              	mov	ax,[cs:$P_KEYorSW_Ptr]	;AC034;	      ^       ^
 33340 00004B63 29F0                    	sub	ax,si			;AN000;  SI	KEYorSW
 33341 00004B65 2E0106[C797]            	add	[cs:$P_SaveSI_Cmpx],ax	;AC034; update for complex list
 33342 00004B6A 58                      	pop	ax			;AN000;
 33343                                  
 33344 00004B6B 2E8B36[C997]            	mov	si,[cs:$P_KEYorSW_Ptr]	;AC034; set si at the end or colon
 33345                                  	;cmp	byte [cs:si],0
 33346 00004B70 2E803C00                	cmp	byte [cs:si],$P_NULL	;AN000; any data after colon
 33347 00004B74 7525                    	jne	short $P_CSW00		;AN000; if yes, process match flags
 33348                                  
 33349                                  	;cmp	byte [cs:si],':'
 33350 00004B76 2E807CFF3A              	cmp	byte [cs:si-1],$P_Colon
 33351                                  					;AN000; if no, the switch terminated by colon ?
 33352 00004B7B 7509                    	jne	short $P_Chk_if_data_required
 33353                                  					;AN000; if yes,
 33354                                  
 33355 00004B7D 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax
 33356                                  	;mov	word [cs:$P_RC],9	;AC034; return syntax error
 33357 00004B84 EB1A                    	jmp	short $P_Chk_SW_Exit	;AN000;
 33358                                  
 33359                                  $P_Chk_if_data_required:		;AN018; no data, no colon
 33360                                  	;cmp	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],0
 33361                                  	; 27/04/2023
 33362 00004B86 26833F00                	cmp	word [es:bx],0		;AN018; should have data? zero match flag means switch followed by nothing is OK
 33363 00004B8A 7414                    	je	short $P_Chk_SW_Exit	;AN018; match flags not zero so should have something if optional bit is not on
 33364                                  
 33365                                  	;;test	word [es:bx],1 ; $P_Optional
 33366                                  	;test	byte [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Optional
 33367 00004B8C 26F60701                	test	byte [es:bx],$P_Optional
 33368                                  					;AN019; see if no value is valid
 33369 00004B90 750E                    	jnz	short $P_Chk_SW_Exit	;AN019; if so, then leave, else yell
 33370                                  
 33371 00004B92 2EC706[BA97]0200        	mov	word [cs:$P_RC],$P_Op_Missing
 33372                                  	;mov	word [cs:$P_RC],2	;AC034; return required operand missing
 33373 00004B99 EB05                    	jmp	short $P_Chk_SW_Exit	;AN018;
 33374                                  
 33375                                  $P_CSW00:				;AN000;
 33376 00004B9B E88D00                  	call	$P_Check_Match_Flags	;AN000; process match flag
 33377 00004B9E F8                      	clc				;AN000; indicate match
 33378                                  	;jmp	short $P_Chk_SW_Single_Exit
 33379 00004B9F C3                      	retn	; 31/03/2023		;AN000;
 33380                                  	; 31/03/2023
 33381                                  ;$P_Chk_SW_Err0: 			;AN000;
 33382                                  ;	stc				;AN000; not found in switch synonym list
 33383                                  ;	;jmp	short $P_Chk_SW_Single_Exit
 33384                                  ;	retn	; 31/03/2023		;AN000;
 33385                                  	
 33386                                  $P_Chk_SW_Exit: 			;AN000;
 33387 00004BA0 50                      	push	ax			;AN000;
 33388                                  	; 31/03/2023
 33389 00004BA1 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 33390                                  	;;mov	al,3
 33391                                  	;;mov	ah,0FFh
 33392                                  	;mov	al,$P_String		;AN000; set
 33393                                  	;mov	ah,$P_No_Tag		;AN000;    result
 33394 00004BA4 E80300                  	call	$P_Fill_Result		;AN000; 	 buffer
 33395 00004BA7 58                      	pop	ax			;AN000;
 33396 00004BA8 F8                      	clc				;AN000;
 33397                                  	; 31/03/2023
 33398                                  $P_Chk_SW_Err0:
 33399                                  $P_Chk_SW_Single_Exit:			;AN000;
 33400 00004BA9 C3                      	retn				;AN000;
 33401                                  
 33402                                  ;***********************************************************************
 33403                                  ; $P_Fill_Result
 33404                                  ;
 33405                                  ; Function: Fill the result buffer
 33406                                  ;
 33407                                  ; Input:    AH = Item tag
 33408                                  ;	    AL = type
 33409                                  ;		  AL = 1: CX,DX has 32bit number (CX = high)
 33410                                  ;		  AL = 2: DX has index(offset) into value list
 33411                                  ;		  AL = 6: DL has driver # (1-A, 2-B, ... , 26 - Z)
 33412                                  ;		  AL = 7: DX has year, CL has month and CH has date
 33413                                  ;		  AL = 8: DL has hours, DH has minutes, CL has secondsn,
 33414                                  ;			  amd CH has hundredths
 33415                                  ;		  AL = else: psdata_seg:SI points to returned string buffer
 33416                                  ;	    ES:BX -> CONTROL block
 33417                                  ;
 33418                                  ; Output:   None
 33419                                  ;
 33420                                  ; Use:	$P_Do_CAPS_String, $P_Remove_Colon, $P_Found_SYNONYM
 33421                                  ;
 33422                                  ; Vars: $P_DX(W)
 33423                                  ;***********************************************************************
 33424                                  
 33425                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33426                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33427                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33428                                  $P_Fill_Result:
 33429 00004BAA 57                      	push	di			;AN000;
 33430 00004BAB 268B7F04                	mov	di,[es:bx+$P_CONTROL_BLK.$P_Result_Buf]
 33431                                  	;mov	di,[es:bx+4]		;AN000; di points to result buffer
 33432 00004BAF 2E893E[BE97]            	mov	[cs:$P_DX],di		;AC034; set returned result address
 33433                                  	;mov	[es:di+$P_RESULT_BLK.$P_Type],al
 33434                                  	;;mov	[es:di],al		;AN000; store type
 33435                                  	;mov	[es:di+$P_RESULT_BLK.$P_Item_Tag],ah
 33436                                  	;;mov	[es:di+1],ah		;AN000; store item tag
 33437                                  	; 31/03/2023
 33438 00004BB4 268905                  	mov	[es:di],ax
 33439 00004BB7 50                      	push	ax			;AN000;
 33440 00004BB8 2EA1[CD97]              	mov	ax,[cs:$P_Found_SYNONYM]
 33441                                  					;AC034; if yes,
 33442 00004BBC 26894502                	mov	[es:di+$P_RESULT_BLK.$P_SYNONYM_Ptr],ax
 33443                                  	;mov	[es:di+2],ax		;AN000;   then set it to the result
 33444 00004BC0 58                      	pop	ax			;AN000;
 33445                                  $P_RLT04:				;AN000;
 33446                                  	;cmp	al,1
 33447 00004BC1 3C01                    	cmp	al,$P_Number		;AN000; if number
 33448 00004BC3 750A                    	jne	short $P_RLT00		;AN000;
 33449                                  $P_RLT02:				;AN000;
 33450 00004BC5 26895504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],dx
 33451                                  	;mov	[es:di+4],dx		;AN000; then store 32bit
 33452 00004BC9 26894D06                	mov	[es:di+2+$P_RESULT_BLK.$P_Picked_Val],cx
 33453                                  	;mov	[es:di+6],cx		;AN000;	number
 33454 00004BCD EB5A                    	jmp	short $P_RLT_Exit	;AN000;
 33455                                  $P_RLT00:				;AN000;
 33456                                  	;cmp	al,2
 33457 00004BCF 3C02                    	cmp	al,$P_List_Idx		;AN000; if list index
 33458 00004BD1 7506                    	jne	short $P_RLT01		;AN000;
 33459 00004BD3 26895504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],dx
 33460                                  	;mov	[es:di+4],dx		;AN000; then store list index
 33461 00004BD7 EB50                    	jmp	short $P_RLT_Exit	;AN000;
 33462                                  $P_RLT01:				;AN000;
 33463                                  	;cmp	al,7
 33464 00004BD9 3C07                    	cmp	al,$P_Date_F ; 7	;AN000; Date format ?
 33465 00004BDB 74E8                    	je	short $P_RLT02		;AN000;
 33466                                  	;cmp	al,8
 33467 00004BDD 3C08                    	cmp	al,$P_Time_F ; 8	;AN000; Time format ?
 33468 00004BDF 74E4                    	je	short $P_RLT02		;AN000;
 33469                                  	;cmp	al,6
 33470 00004BE1 3C06                    	cmp	al,$P_Drive  ; 6	;AN000; drive format ?
 33471 00004BE3 7506                    	jne	short $P_RLT03		;AN000;
 33472                                  
 33473 00004BE5 26885504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],dl
 33474                                  	;mov	[es:di+4],dl		;AN000; store drive number
 33475 00004BE9 EB3E                    	jmp	short $P_RLT_Exit	;AN000;
 33476                                  
 33477                                  $P_RLT03:				;AN000;
 33478                                  	;cmp	al,4
 33479 00004BEB 3C04                    	cmp	al,$P_Complex		;AN000; complex format ?
 33480 00004BED 750F                    	jne	short $P_RLT05		;AN000;
 33481                                  
 33482 00004BEF 2EA1[C797]              	mov	ax,[cs:$P_SaveSI_Cmpx]	;AC034; then get pointer in command buffer
 33483 00004BF3 40                      	inc	ax			;AN000; skip left Parentheses
 33484 00004BF4 26894504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],ax
 33485                                  	;mov	[es:di+4],ax		;AN000; store offset
 33486 00004BF8 268C5D06                	mov	[es:di+2+$P_RESULT_BLK.$P_Picked_Val],ds
 33487                                  	;mov	[es:di+6],ds		;AN000; store segment
 33488 00004BFC EB2B                    	jmp	short $P_RLT_Exit	;AN000;
 33489                                  
 33490                                  $P_RLT05:				;AN000;
 33491                                  ;------------------------  AL = 3, 5, or 9
 33492 00004BFE 26897504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],si
 33493                                  	;mov	[es:di+4],si		;AN000; store offset of STRING_BUF
 33494 00004C02 268C4D06                	mov	[es:di+2+$P_RESULT_BLK.$P_Picked_Val],cs
 33495                                  	;mov	[es:di+6],cs		;AN031; store segment of STRING_BUF
 33496                                  
 33497 00004C06 50                      	push	ax			;AN000;
 33498 00004C07 26F6470201              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_CAP_File
 33499                                  	;test	byte [es:bx+2],1	;AN000; need CAPS by file table?
 33500 00004C0C 7404                    	jz	short $P_RLT_CAP00	;AN000;
 33501                                  
 33502                                  	;mov	al,4
 33503 00004C0E B004                    	mov	al,$P_DOSTBL_File ; 4	;AN000; use file upper case table
 33504 00004C10 EB09                    	jmp	short $P_RLT_CAP02	;AN000;
 33505                                  
 33506                                  $P_RLT_CAP00:				;AN000;
 33507 00004C12 26F6470202              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_CAP_Char
 33508                                  	;test	byte [es:bx+2],2	;AN000; need CAPS by char table ?
 33509 00004C17 7405                    	jz	short $P_RLT_CAP01	;AN000;
 33510                                  
 33511                                  	;mov	al,2
 33512 00004C19 B002                    	mov	al,$P_DOSTBL_Char ; 2	;AN000; use character upper case table
 33513                                  $P_RLT_CAP02:				;AN000;
 33514 00004C1B E80C01                  	call	$P_Do_CAPS_String	;AN000;  process CAPS along the table
 33515                                  $P_RLT_CAP01:				;AN000;
 33516 00004C1E 58                      	pop	ax			;AN000;
 33517 00004C1F 26F6470210              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_Rm_Colon
 33518                                  	;test	byte [es:bx+2],10h	;AN000; removing colon at end ?
 33519 00004C24 7403                    	jz	short $P_RLT_Exit	;AN000;
 33520                                  
 33521 00004C26 E8DD00                  	call	$P_Remove_Colon 	;AN000; then process it.
 33522                                  $P_RLT_Exit:				;AN000;
 33523 00004C29 5F                      	pop	di			;AN000;
 33524 00004C2A C3                      	retn				;AN000;
 33525                                  
 33526                                  ;***********************************************************************
 33527                                  ; $P_Check_Match_Flags
 33528                                  ;
 33529                                  ; Function:  Check the mutch_flags and make the exit code and set the
 33530                                  ;	     result buffer
 33531                                  ;
 33532                                  ;	    Check for types in this order:
 33533                                  ;		Complex
 33534                                  ;		Date
 33535                                  ;		Time
 33536                                  ;		Drive
 33537                                  ;		Filespec
 33538                                  ;		Quoted String
 33539                                  ;		Simple String
 33540                                  ;
 33541                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 33542                                  ;	     ES:BX -> CONTROL block
 33543                                  ;
 33544                                  ; Output:    None
 33545                                  ;
 33546                                  ; Use:	     $P_Value, P$_SValue, $P_Simple_String, $P_Date_Format
 33547                                  ;	     $P_Time_Format, $P_Complex_Format, $P_File_Foemat
 33548                                  ;	     $P_Drive_Format
 33549                                  ;***********************************************************************
 33550                                  
 33551                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33552                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33553                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33554                                  $P_Check_Match_Flags:
 33555 00004C2B 2EC606[9398]00          	mov	byte [cs:$P_err_flag],$P_NULL ; 0
 33556                                  					;AN033;AC034;; clear filespec error flag.
 33557 00004C31 50                      	push	ax			;AN000;
 33558                                  	;mov	ax,[es:bx+$P_CONTROL_BLK.$P_Match_Flag]
 33559 00004C32 268B07                  	mov	ax,[es:bx]		;AN000; load match flag(16bit) to ax
 33560 00004C35 09C0                    	or	ax,ax			;AC035; test ax for zero
 33561 00004C37 7518                    	jnz	short $P_Mat		;AN000; (tm12)
 33562 00004C39 50                      	push	ax			;AN000; (tm12)
 33563 00004C3A 53                      	push	bx			;AN000; (tm12)
 33564 00004C3B 52                      	push	dx			;AN000; (tm12)
 33565 00004C3C 57                      	push	di			;AN000; (tm12)
 33566 00004C3D 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax
 33567                                  	;mov	word [cs:$P_RC],9	;AC034; (tm12)
 33568                                  	; 31/03/2023
 33569 00004C44 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 33570                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; (tm12)
 33571                                  	;mov	al,$P_String ; 3	;AN000; (tm12)
 33572 00004C47 E860FF                  	call	$P_Fill_Result		;AN000; (tm12)
 33573 00004C4A 5F                      	pop	di			;AN000; (tm12)
 33574 00004C4B 5A                      	pop	dx			;AN000; (tm12)
 33575 00004C4C 5B                      	pop	bx			;AN000; (tm12)
 33576 00004C4D 58                      	pop	ax			;AN000; (tm12)
 33577                                  	;jmp	short $P_Bridge 	;AC035; (tm12)
 33578                                  	; 31/03/2023
 33579                                  $P_Bridge:	; 18/04/2023		;AN000;
 33580 00004C4E E99C00                  	jmp	$P_Match_Exit		;AN000; (tm02)
 33581                                  $P_Mat: 				;AN000; (tm12)
 33582                                  $P_Match01:				;AN000;
 33583                                  	;test	ax,1000h
 33584 00004C51 A90010                  	test	ax,$P_Date_S		;AN000; Date string
 33585 00004C54 7412                    	jz	short $P_Match02	;AN000;
 33586 00004C56 2EC706[BA97]0000        	mov	word [cs:$P_RC],$P_No_Error
 33587                                  	;mov	word [cs:$P_RC],0	;AC034; assume no error
 33588 00004C5D E85403                  	call	$P_Date_Format		;AN000; do process
 33589 00004C60 2E833E[BA97]09          	cmp	word [cs:$P_RC],$P_Syntax
 33590                                  	;cmp	word [cs:$P_RC],9	;AC034; if error, examine the next type
 33591                                  	; 18/04/2023
 33592 00004C66 75E6                    	jne	short $P_Bridge		;AN000;
 33593                                  $P_Match02:				;AN000;
 33594                                  	;test	ax,800h
 33595 00004C68 A90008                  	test	ax,$P_Time_S		;AN000; Time string
 33596 00004C6B 7412                    	jz	short $P_Match03	;AN000;
 33597 00004C6D 2EC706[BA97]0000        	mov	word [cs:$P_RC],$P_No_Error
 33598                                  	;mov	word [cs:$P_RC],0	;AC034; assume no error
 33599 00004C74 E85A04                  	call	$P_Time_Format		;AN000; do process
 33600 00004C77 2E833E[BA97]09          	cmp	word [cs:$P_RC],$P_Syntax
 33601                                  	;cmp	word [cs:$P_RC],9	;AC034; if error, examine the next type
 33602                                  	;jne	short $P_Bridge		;AN000; (tm09)
 33603                                  	;jmp	short $P_Match03	;AN025; (tm09)
 33604                                  	; 31/03/2023
 33605 00004C7D 756E                    	jne	short $P_Match_Exit
 33606                                  ;$P_Bridge:				;AN000;
 33607                                  	;jmp	short $P_Match_Exit	;AN000; (tm02)
 33608                                  $P_Match03:				;AN000;
 33609                                  	;test	ax,8000h
 33610 00004C7F A90080                  	test	ax,$P_Num_Val		;AN000; Numeric value
 33611 00004C82 7412                    	jz	short $P_Match04	;AN000;
 33612 00004C84 2EC706[BA97]0000        	mov	word [cs:$P_RC],$P_No_Error
 33613                                  	;mov	word [cs:$P_RC],0	;AC034; assume no error
 33614 00004C8B E82701                  	call	$P_Value		;AN000; do process
 33615 00004C8E 2E833E[BA97]09          	cmp	word [cs:$P_RC],$P_Syntax
 33616                                  	;cmp	word [cs:$P_RC],9	;AC034; if error, examine the next type
 33617 00004C94 7557                    	jne	short $P_Match_Exit	;AN000;
 33618                                  $P_Match04:				;AN000;
 33619                                  	;test	ax,4000h
 33620 00004C96 A90040                  	test	ax,$P_SNum_Val		;AN000; Signed numeric value
 33621 00004C99 7412                    	jz	short $P_Match05	;AN000;
 33622 00004C9B 2EC706[BA97]0000        	mov	word [cs:$P_RC],$P_No_Error
 33623                                  					;AC034; assume no error
 33624 00004CA2 E8EC00                  	call	$P_SValue		;AN000; do process
 33625 00004CA5 2E833E[BA97]09          	cmp	word [cs:$P_RC],$P_Syntax
 33626                                  					;AC034; if error, examine the next type
 33627 00004CAB 7540                    	jne	short $P_Match_Exit	;AN000;
 33628                                  $P_Match05:				;AN000;
 33629                                  	;test	ax,100h
 33630 00004CAD A90001                  	test	ax,$P_Drv_Only		;AN000; Drive only
 33631 00004CB0 7415                    	jz	short $P_Match06	;AN000;
 33632 00004CB2 2EC706[BA97]0000        	mov	word [cs:$P_RC],$P_No_Error
 33633                                  					;AC034; assume no error
 33634 00004CB9 E86205                  	call	$P_File_Format		;AN000; 1st, call file format
 33635 00004CBC E8E305                  	call	$P_Drive_Format 	;AN000; check drive format, next
 33636 00004CBF 2E833E[BA97]09          	cmp	word [cs:$P_RC],$P_Syntax
 33637                                  					;AC034; if error, examinee the next type
 33638 00004CC5 7526                    	jne	short $P_Match_Exit	;AN000;
 33639                                  $P_Match06:				;AN000;
 33640                                  	;test	ax,200h
 33641 00004CC7 A90002                  	test	ax,$P_File_Spc		;AN000; File spec
 33642 00004CCA 7412                    	jz	short $P_Match07	;AN000;
 33643 00004CCC 2EC706[BA97]0000        	mov	word [cs:$P_RC],$P_No_Error
 33644                                  					;AC034; assume no error
 33645 00004CD3 E84805                  	call	$P_File_Format		;AN000; do process
 33646 00004CD6 2E833E[BA97]09          	cmp	word [cs:$P_RC],$P_Syntax
 33647                                  					;AC034; if error, examine the next type
 33648 00004CDC 750F                    	jne	short $P_Match_Exit	;AN000;
 33649                                  $P_Match07:				;AN000;
 33650                                  $P_Match08:				;AN000;
 33651                                  	;test	ax,2000h
 33652 00004CDE A90020                  	test	ax,$P_Simple_S		;AN000; Simple string
 33653 00004CE1 740A                    	jz	short $P_Match09	;AN000;
 33654 00004CE3 2EC706[BA97]0000        	mov	word [cs:$P_RC],$P_No_Error
 33655                                  					;AC034; assume no error
 33656 00004CEA E8C501                  	call	$P_Simple_String	;AN000; do process
 33657                                  $P_Match09:				;AN000;
 33658                                  $P_Match_Exit:				;AN000;
 33659 00004CED 2E833E[9398]01          	cmp	word [cs:$P_err_flag],$P_error_filespec
 33660                                  	;cmp	word [cs:$P_err_flag],1 ;AC034; bad filespec ?
 33661 00004CF3 750F                    	jne	short $P_Match2_Exit	;AN033; no, continue
 33662 00004CF5 2E833E[BA97]00          	cmp	word [cs:$P_RC],$P_No_Error
 33663                                  	;cmp	word [cs:$P_RC],0	;AN033;AC034;; check for other errors ?
 33664 00004CFB 7507                    	jne	short $P_Match2_Exit	;AN033; no, continue
 33665 00004CFD 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax
 33666                                  	;mov	word [cs:$P_RC],9	;AN033;AC034;; set error flag
 33667                                  $P_Match2_Exit: 			;AN033;
 33668 00004D04 58                      	pop	ax			;AN000;
 33669 00004D05 C3                      	retn
 33670                                  
 33671                                  ;***********************************************************************
 33672                                  ; $P_Remove_Colon;
 33673                                  ;
 33674                                  ; Function: Remove colon at end
 33675                                  ;
 33676                                  ; Input:    psdata_seg:SI points to string buffer to be examineed
 33677                                  ;
 33678                                  ; Output:   None
 33679                                  ;
 33680                                  ; Use:	$P_Chk_DBCS
 33681                                  ;***********************************************************************
 33682                                  
 33683                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33684                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33685                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33686                                  $P_Remove_Colon:
 33687 00004D06 50                      	push	ax			;AN000;
 33688 00004D07 56                      	push	si			;AN000;
 33689                                  $P_RCOL_Loop:				;AN000;
 33690 00004D08 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 33691 00004D0B 08C0                    	or	al,al			;AN000; end of string ?
 33692 00004D0D 740F                    	jz	short $P_RCOL_Exit	;AN000; if yes, just exit
 33693                                  
 33694 00004D0F 3C3A                    	cmp	al,$P_Colon ; ':' ; 3Ah	;AN000; is it colon ?
 33695 00004D11 750E                    	jne	short $P_RCOL00		;AN000;
 33696                                  
 33697                                  	;cmp	byte [cs:si+1],0
 33698 00004D13 2E807C0100              	cmp	byte [cs:si+1],$P_NULL	;AN000; if so, next is NULL ?
 33699 00004D18 7507                    	jne	short $P_RCOL00		;AN000; no, then next char
 33700                                  
 33701 00004D1A 2EC60400                	mov	byte [cs:si],$P_NULL	;AN000; yes, remove colon
 33702                                  	; 31/03/2023
 33703                                  	;jmp	short $P_RCOL_Exit	;AN000; and exit.
 33704                                  $P_RCOL_Exit:
 33705 00004D1E 5E                      	pop	si
 33706 00004D1F 58                      	pop	ax
 33707 00004D20 C3                      	retn
 33708                                  
 33709                                  $P_RCOL00:				;AN000;
 33710 00004D21 E89E06                  	call	$P_Chk_DBCS		;AN000; if not colon, then check if
 33711 00004D24 7301                    	jnc	short $P_RCOL01		;AN000; DBCS leading byte.
 33712                                  
 33713 00004D26 46                      	inc	si			;AN000; if yes, skip trailing byte
 33714                                  $P_RCOL01:				;AN000;
 33715 00004D27 46                      	inc	si			;AN000; si points to next byte
 33716 00004D28 EBDE                    	jmp	short $P_RCOL_Loop	;AN000; loop until NULL encountered
 33717                                  
 33718                                  	; 31/03/2023
 33719                                  ;$P_RCOL_Exit:				;AN000;
 33720                                  	;pop	si			;AN000;
 33721                                  	;pop	ax			;AN000;
 33722                                  	;retn
 33723                                  
 33724                                  ;***********************************************************************
 33725                                  ; $P_Do_CAPS_String;
 33726                                  ;
 33727                                  ; Function: Perform capitalization along with the file case map table
 33728                                  ;	    or character case map table.
 33729                                  ;
 33730                                  ; Input:    AL = 2 : Use character table
 33731                                  ;	    AL = 4 : Use file table
 33732                                  ;	    psdata_seg:SI points to string buffer to be capitalized
 33733                                  ;
 33734                                  ; Output:   None
 33735                                  ;
 33736                                  ; Use:	$P_Do_CAPS_Char, $P_Chk_DBCS
 33737                                  ;***********************************************************************
 33738                                  
 33739                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33740                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33741                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33742                                  $P_Do_CAPS_String:
 33743 00004D2A 56                      	push	si			;AN000;
 33744 00004D2B 52                      	push	dx			;AN000;
 33745 00004D2C 88C2                    	mov	dl,al			;AN000; save info id
 33746                                  $P_DCS_Loop:				;AN000;
 33747 00004D2E 2E8A04                  	mov	al,[cs:si]		;AN000; load character and
 33748 00004D31 E88E06                  	call	$P_Chk_DBCS		;AN000; check if DBCS leading byte
 33749 00004D34 720C                    	jc	short $P_DCS00		;AN000; if yes, do not need CAPS
 33750                                  
 33751 00004D36 08C0                    	or	al,al			;AN000; end of string ?
 33752 00004D38 740C                    	jz	short $P_DCS_Exit	;AN000; then exit.
 33753                                  
 33754 00004D3A E80C00                  	call	$P_Do_CAPS_Char 	;AN000; Here a SBCS char need to be CAPS
 33755 00004D3D 2E8804                  	mov	[cs:si],al		;AN000; stored upper case char to buffer
 33756 00004D40 EB01                    	jmp	short $P_DCS01		;AN000; process nexit
 33757                                  $P_DCS00:				;AN000;
 33758 00004D42 46                      	inc	si			;AN000; skip DBCS leading and trailing byte
 33759                                  $P_DCS01:				;AN000;
 33760 00004D43 46                      	inc	si			;AN000; si point to next byte
 33761 00004D44 EBE8                    	jmp	short $P_DCS_Loop	;AN000; loop until NULL encountered
 33762                                  $P_DCS_Exit:				;AN000;
 33763 00004D46 5A                      	pop	dx			;AN000;
 33764 00004D47 5E                      	pop	si			;AN000;
 33765 00004D48 C3                      	retn
 33766                                  
 33767                                  ;***********************************************************************
 33768                                  ; $P_Do_CAPS_Char;
 33769                                  ;
 33770                                  ; Function: Perform capitalization along with the file case map table
 33771                                  ;	    or character case map table.
 33772                                  ;
 33773                                  ; Input:    DL = 2 : Use character table
 33774                                  ;	    DL = 4 : Use file table
 33775                                  ;	    AL = character to be capitalized
 33776                                  ;
 33777                                  ; Output:   None
 33778                                  ;
 33779                                  ; Use:	INT 21h /w AH=65h
 33780                                  ;***********************************************************************
 33781                                  
 33782                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33783                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33784                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33785                                  $P_Do_CAPS_Char:
 33786 00004D49 3C80                    	cmp	al,$P_ASCII80	; 80h	;AN000; need upper case table ?
 33787 00004D4B 730B                    	jae	short $P_DCC_Go		;AN000;
 33788                                  
 33789 00004D4D 3C61                    	cmp	al,"a"  ; 61h		;AN000; if no,
 33790 00004D4F 723F                    	jb	short $P_CAPS_Ret	;AN000;   check if  "a" <= AL <= "z"
 33791                                  
 33792 00004D51 3C7A                    	cmp	al,"z"  ; 7Ah		;AN000;
 33793 00004D53 773B                    	ja	short $P_CAPS_Ret	;AN000;   if yes, make CAPS
 33794                                  
 33795 00004D55 24DF                    	and	al,$P_Make_Upper ; 0DFh	;AN000;   else do nothing.
 33796                                  	;jmp	short $P_CAPS_Ret	;AN000;
 33797                                  	; 18/04/2023
 33798 00004D57 C3                      	retn
 33799                                  
 33800                                  $P_DCC_Go:				;AN000;
 33801 00004D58 53                      	push	bx			;AN000;
 33802 00004D59 06                      	push	es			;AN000;
 33803 00004D5A 57                      	push	di			;AN000;
 33804                                  	; 18/04/2023
 33805 00004D5B 8D3E[8598]              	lea	di,$P_File_CAP_Ptr	;AC034;
 33806 00004D5F 80FA04                  	cmp	dl,$P_DOSTBL_File ; 4	;AN000; Use file CAPS table ?
 33807 00004D62 7404                    	je	short $P_DCC00		;AN000;
 33808                                  	; 27/04/2023
 33809 00004D64 8D3E[8098]              	lea	di,$P_Char_CAP_Ptr	;AC034; or use char CAPS table ?
 33810                                  $P_DCC00:				;AN000;
 33811 00004D68 2E3815                  	cmp	[cs:di],dl		;AN000; already got table address ?
 33812 00004D6B 7416                    	je	short $P_DCC01		;AN000; if no,
 33813                                  
 33814                                  ;In this next section, ES will be used to pass a 5 byte workarea to INT 21h,
 33815                                  ; the GET COUNTYRY INFO call. This usage of ES is required by the function
 33816                                  ; call, regardless of what base register is currently be defined as PSDATA_SEG.
 33817                                  
 33818 00004D6D 50                      	push	ax			;AN000; get CAPS table thru DOS call
 33819 00004D6E 51                      	push	cx			;AN000;
 33820 00004D6F 52                      	push	dx			;AN000;
 33821 00004D70 0E                      	push	cs			;AC036; pass current base seg into
 33822                                  					;(Note: this used to push CS. BUG...
 33823 00004D71 07                      	pop	es			;AN000;   ES reg, required for
 33824                                  					;get extended country information
 33825                                  	; 31/03/2023
 33826 00004D72 B465                    	mov	ah,$P_DOS_Get_TBL ; 65h	;AN000; get extended CDI
 33827                                  	;mov	ah,65h
 33828 00004D74 88D0                    	mov	al,dl			;AN000; upper case table
 33829                                  	;mov	bx,-1 ; 0FFFFh
 33830                                  	;mov	cx,5
 33831                                  	;mov	dx,-1
 33832 00004D76 BBFFFF                  	mov	bx,$P_DOSTBL_Def ; -1	;AN000; get active CON
 33833 00004D79 B90500                  	mov	cx,$P_DOSTBL_BL  ; 5 	;AN000; buffer length
 33834                                  	; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 33835 00004D7C 89DA                    	mov	dx,bx
 33836                                  	;mov	dx,$P_DOSTBL_Def ; -1	;AN000; get for default code page
 33837                                  					;DI already set to point to buffer
 33838 00004D7E CD21                    	int	21h			;AN000; es:di point to buffer that
 33839                                  					;now has been filled in with info
 33840 00004D80 5A                      	pop	dx			;AN000;
 33841 00004D81 59                      	pop	cx			;AN000;
 33842 00004D82 58                      	pop	ax			;AN000;
 33843                                  
 33844                                  $P_DCC01:				;AN000;
 33845                                  
 33846                                  ;In this next section, ES will be used as the base of the XLAT table, provided
 33847                                  ; by the previous GET COUNTRY INFO DOS call. This usage of ES is made
 33848                                  ; regardless of which base reg is currently the PSDATA_SEG reg.
 33849                                  
 33850                                  	;mov	bx,[cs:di+$P_DOS_TBL.$P_DOS_TBL_Off]
 33851                                  	;;mov	bx,[cs:di+1]		;AN000; get offset of table
 33852                                  	;mov	es,[cs:di+$P_DOS_TBL.$P_DOS_TBL_Seg]
 33853                                  	;;mov	es,[cs:di+3]		;AN000; get segment of table
 33854                                  	; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 33855                                  	;les	bx,[cs:di+1]
 33856 00004D83 2EC45D01                	les	bx,[cs:di+$P_DOS_TBL.$P_DOS_TBL_Off]
 33857                                  	;
 33858 00004D87 43                      	inc	bx			;AC035; add '2' to
 33859 00004D88 43                      	inc	bx			;AC035;  BX reg
 33860                                  					;AN000; skip length field
 33861 00004D89 2C80                    	sub	al,$P_ASCII80 ; 80h	;AN000; make char to index
 33862                                  	;xlat	es:[bx] 		;AN000; perform case map
 33863                                  	; 31/03/2023
 33864 00004D8B 26D7                    	es	xlat
 33865                                  
 33866 00004D8D 5F                      	pop	di			;AN000;
 33867 00004D8E 07                      	pop	es			;AN000;
 33868 00004D8F 5B                      	pop	bx			;AN000;
 33869                                  $P_CAPS_Ret:				;AN000;
 33870 00004D90 C3                      	retn
 33871                                  
 33872                                  ;***********************************************************************
 33873                                  ; $P_Value / $P_SValue
 33874                                  ;
 33875                                  ; Function:  Make 32bit value from psdata_seg:SI and see value list
 33876                                  ;	     and make result buffer.
 33877                                  ;	     $P_SValue is an entry point for the signed value
 33878                                  ;	     and this will simply call $P_Value after the handling
 33879                                  ;	     of the sign character, "+" or "-"
 33880                                  ;
 33881                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 33882                                  ;	     ES:BX -> CONTROL block
 33883                                  ;
 33884                                  ; Output:    None
 33885                                  ;
 33886                                  ; Use:	$P_Fill_Result, $P_Check_OVF
 33887                                  ;
 33888                                  ; Vars: $P_RC(W), $P_Flags(RW)
 33889                                  ;***********************************************************************
 33890                                  
 33891                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33892                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33893                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33894                                  $P_SValue:
 33895 00004D91 50                      	push	ax			;AN000;
 33896                                  	;or	byte [cs:$P_Flags2],80h
 33897 00004D92 2E800E[C697]80          	or	byte [cs:$P_Flags2],$P_Signed
 33898                                  					;AC034; indicate a signed numeric
 33899                                  	;and	byte [cs:$P_Flags2],0FDh
 33900 00004D98 2E8026[C697]FD          	and	byte [cs:$P_Flags2],0FFh-$P_Neg
 33901                                  					;AC034; assume positive value
 33902 00004D9E 2E8A04                  	mov	al,[cs:si]		;AN000; get sign
 33903 00004DA1 3C2B                    	cmp	al,'+' ; 2Bh
 33904                                  	;cmp	al,$P_Plus ; '+'	;AN000; "+" ?
 33905 00004DA3 740A                    	je	short $P_SVal00		;AN000;
 33906                                  
 33907 00004DA5 3C2D                    	cmp	al,'-' ; 2Dh
 33908                                  	;cmp	al,$P_Minus ; '-'	;AN000; "-" ?
 33909 00004DA7 7507                    	jne	short $P_Sval01		;AN000; else
 33910                                  
 33911 00004DA9 2E800E[C697]02          	or	byte [cs:$P_Flags2],$P_Neg ; 2
 33912                                  					;AC034; set this is negative value
 33913                                  $P_SVal00:				;AN000;
 33914 00004DAF 46                      	inc	si			;AN000; skip sign char
 33915                                  $P_Sval01:				;AN000;
 33916 00004DB0 E80200                  	call	$P_Value		;AN000; and process value
 33917 00004DB3 58                      	pop	ax			;AN000;
 33918                                  $P_Check_OVF_ok: ; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33919 00004DB4 C3                      	retn				;AN000;
 33920                                  
 33921                                  ;***********************************************************************
 33922                                  
 33923                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33924                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4955h
 33925                                  
 33926                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33927                                  	; MSDOS 6.2 COMMAND.COM - TRANGROUP:5119h
 33928                                  
 33929                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 33930                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:4FCCh
 33931                                  $P_Value:
 33932 00004DB5 50                      	push	ax			;AN000;
 33933 00004DB6 51                      	push	cx			;AN000;
 33934 00004DB7 52                      	push	dx			;AN000;
 33935 00004DB8 56                      	push	si			;AN000;
 33936 00004DB9 31C9                    	xor	cx,cx			;AN000; cx = higher 16 bits
 33937 00004DBB 31D2                    	xor	dx,dx			;AN000; dx = lower 16 bits
 33938 00004DBD 53                      	push	bx			;AN000; save control pointer
 33939                                  
 33940                                  $P_Value_Loop:				;AN000;
 33941 00004DBE 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 33942 00004DC1 08C0                    	or	al,al			;AN000; end of line ?
 33943 00004DC3 7436                    	jz	short $P_Value00	;AN000;
 33944                                  
 33945 00004DC5 E8DF00                  	call	$P_0099 		;AN000; make asc(0..9) to bin(0..9)
 33946 00004DC8 722D                    	jc	short $P_Value_Err0	;AN000;
 33947                                  
 33948                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 33949                                  %if 0
 33950                                  	xor	ah,ah			;AN000;
 33951                                  	mov	bp,ax			;AN000; save binary number
 33952                                  	shl	dx,1			;AN000; to have 2*x
 33953                                  	rcl	cx,1			;AN000; shift left w/ carry
 33954                                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33955                                  	jc	short $P_Value_Err0	;AN000; then error, exit
 33956                                  
 33957                                  	mov	bx,dx			;AN000; save low(2*x)
 33958                                  	mov	ax,cx			;AN000; save high(2*x)
 33959                                  	shl	dx,1			;AN000; to have 4*x
 33960                                  	rcl	cx,1			;AN000; shift left w/ carry
 33961                                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33962                                  	jc	short $P_Value_Err0	;AN000; then error, exit
 33963                                  
 33964                                  	shl	dx,1			;AN000; to have 8*x
 33965                                  	rcl	cx,1			;AN000; shift left w/ carry
 33966                                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33967                                  	jc	short $P_Value_Err0	;AN000; then error, exit
 33968                                  
 33969                                  	add	dx,bx			;AN000; now have 10*x
 33970                                  	adc	cx,ax			;AN000; 32bit ADD
 33971                                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33972                                  	jc	short $P_Value_Err0	;AN000; then error, exit
 33973                                  
 33974                                  	add	dx,bp			;AN000; Add the current one degree decimal
 33975                                  	adc	cx,0			;AN000; if carry, add 1 to high 16bit
 33976                                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33977                                  	jc	short $P_Value_Err0	;AN000; then error, exit
 33978                                  
 33979                                  	inc	si			;AN000; update pointer
 33980                                  	jmp	short $P_Value_Loop	;AN000; loop until NULL encountered
 33981                                  %else
 33982 00004DCA 30E4                    	xor	ah,ah
 33983 00004DCC 89C5                    	mov	bp,ax			; save binary number
 33984 00004DCE E81C00                  	call	$P_Check_OVF_shl32	; check Overflow (after shl32)
 33985 00004DD1 89D3                    	mov	bx,dx			; save low(2*x)
 33986 00004DD3 89C8                    	mov	ax,cx			; save high(2*x)
 33987 00004DD5 E81500                  	call	$P_Check_OVF_shl32	; check OverFlow (after shl32)
 33988 00004DD8 E81200                  	call	$P_Check_OVF_shl32	; check OverFlow (after shl32)
 33989 00004DDB 01DA                    	add	dx,bx			; now have 10*x
 33990 00004DDD 11C1                    	adc	cx,ax			; 32bit ADD
 33991 00004DDF E80F00                  	call	$P_Check_OVF_@		; check OverFlow
 33992 00004DE2 01EA                    	add	dx,bp			; Add the current one degree decimal
 33993 00004DE4 83D100                  	adc	cx,0			; if carry, add 1 to high 16bit
 33994 00004DE7 E80700                  	call	$P_Check_OVF_@		; check Overflow
 33995 00004DEA 46                      	inc	si			; update pointer
 33996 00004DEB EBD1                    	jmp	short $P_Value_Loop	; loop until NULL encountered
 33997                                  
 33998                                  $P_Check_OVF_shl32:
 33999 00004DED D1E2                    	shl	dx,1
 34000 00004DEF D1D1                    	rcl	cx,1
 34001                                  $P_Check_OVF_@:
 34002 00004DF1 E8A100                  	call	$P_Check_OVF
 34003                                  	;jc	short $P_Value_Err0_@
 34004                                  	;retn
 34005                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34006 00004DF4 73BE                    	jnc	short $P_Check_OVF_ok
 34007                                  
 34008                                  $P_Value_Err0_@:
 34009                                  	;inc	sp
 34010                                  	;inc	sp
 34011                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34012 00004DF6 5B                      	pop	bx
 34013                                  %endif
 34014                                  
 34015                                  $P_Value_Err0:				;AN000;
 34016 00004DF7 5B                      	pop	bx			;AN000;
 34017 00004DF8 E98800                  	jmp	$P_Value_Err		;AN000; Bridge
 34018                                  
 34019                                  $P_Value00:				;AN000;
 34020 00004DFB 5B                      	pop	bx			;AN000; restore control pointer
 34021 00004DFC 2EF606[C697]02          	test	byte [cs:$P_Flags2],$P_Neg ; 2 
 34022                                  					;AC034; here cx,dx = 32bit value
 34023 00004E02 740A                    	jz	short $P_Value01	;AN000; was it negative ?
 34024                                  
 34025 00004E04 F7D1                    	not	cx			;AN000; +
 34026 00004E06 F7D2                    	not	dx			;AN000; |- Make 2's complement
 34027 00004E08 83C201                  	add	dx,1			;AN000; |
 34028 00004E0B 83D100                  	adc	cx,0			;AN000; +
 34029                                  $P_Value01:				;AN000; / nval =0
 34030 00004E0E 268B7706                	mov	si,[es:bx+$P_CONTROL_BLK.$P_Value_List]
 34031                                  	;mov	si,[es:bx+6]		;AN000; si points to value list
 34032 00004E12 268A04                  	mov	al,[es:si]		;AN000; get nval
 34033 00004E15 3C00                    	cmp	al,$P_nval_None ; 0	;AN000; no value list ?
 34034 00004E17 7505                    	jne	short $P_Value02	;AN000;
 34035                                  
 34036                                  	;mov	al,$P_Number	; 1	;AN000; Set type
 34037                                  	;mov	ah,$P_No_Tag	; 0FFh	;AN000; No ITEM_TAG set
 34038                                  	; 31/03/2023
 34039 00004E19 B801FF                  	mov	ax,($P_No_Tag<<8)+$P_Number
 34040 00004E1C EB6F                    	jmp	short $P_Value_Exit	;AN000;
 34041                                  
 34042                                  $P_Value02:				;AN000; / nval = 1
 34043 00004E1E 46                      	inc	si			;AN000;
 34044 00004E1F 268A04                  	mov	al,[es:si]		;AN000; al = number of range
 34045 00004E22 3C00                    	cmp	al,$P_No_nrng	; 0	;AN000; (tm07)
 34046 00004E24 745D                    	je	short $P_Value03	;AN000; (tm07)
 34047                                  
 34048 00004E26 46                      	inc	si			;AN000; si points to 1st item_tag
 34049                                  $P_Val02_Loop:				;AN000;
 34050 00004E27 2EF606[C697]80          	test	byte [cs:$P_Flags2],$P_Signed ; 80h
 34051                                  	;test	byte [cs:$P_Flags2],80h	;AC034;
 34052 00004E2D 751E                    	jnz	short $P_Val02_Sign	;AN000;
 34053                                  
 34054 00004E2F 263B4C03                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_XH]
 34055                                  	;cmp	cx,[es:si+3]		;AN000; comp cx with XH
 34056 00004E33 723B                    	jb	short $P_Val02_Next	;AN000;
 34057 00004E35 7706                    	ja	short $P_Val_In		;AN000;
 34058                                  
 34059 00004E37 263B5401                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_XL]
 34060                                  	;cmp	dx,[es:si+1]		;AN000; comp dx with XL
 34061 00004E3B 7233                    	jb	short $P_Val02_Next	;AN000;
 34062                                  
 34063                                  $P_Val_In:				;AN000;
 34064 00004E3D 263B4C07                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_YH]
 34065                                  	;cmp	cx,[es:si+7]		;AN000; comp cx with YH (tm01)
 34066 00004E41 772D                    	ja	short $P_Val02_Next	;AN000;
 34067 00004E43 7224                    	jb	short $P_Val_Found	;AN000;
 34068                                  
 34069 00004E45 263B5405                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_YL]
 34070                                  	;cmp	dx,[es:si+5]		;AN000; comp dx with YL
 34071 00004E49 7725                    	ja	short $P_Val02_Next	;AN000;
 34072                                  
 34073 00004E4B EB1C                    	jmp	short $P_Val_Found	;AN000;
 34074                                  
 34075                                  $P_Val02_Sign:				;AN000;
 34076 00004E4D 263B4C03                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_XH]
 34077                                  	;cmp	cx,[es:si+3]		;AN000; comp cx with XH
 34078 00004E51 7C1D                    	jl	short $P_Val02_Next	;AN000;
 34079 00004E53 7F06                    	jg	short $P_SVal_In	;AN000;
 34080                                  
 34081 00004E55 263B5401                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_XL]
 34082                                  	;cmp	dx,[es:si+1]		;AN000; comp dx with XL
 34083 00004E59 7C15                    	jl	short $P_Val02_Next	;AN000;
 34084                                  
 34085                                  $P_SVal_In:				;AN000;
 34086 00004E5B 263B4C07                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_YH]
 34087                                  	;cmp	cx,[es:si+7]		;AN000; comp cx with YH
 34088 00004E5F 7F0F                    	jg	short $P_Val02_Next	;AN000;
 34089 00004E61 7C06                    	jl	short $P_Val_Found	;AN000;
 34090                                  
 34091 00004E63 263B5405                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_YL]
 34092                                  	;cmp	dx,[es:si+5]		;AN000; comp dx with YL
 34093 00004E67 7F07                    	jg	short $P_Val02_Next	;AN000;
 34094                                  
 34095                                  	;jmp	short $P_Val_Found	;AN000;
 34096                                  	; 27/04/2023
 34097                                  $P_Val_Found:				;AN000;
 34098 00004E69 B001                    	mov	al,$P_Number ; 1	;AN000;
 34099 00004E6B 268A24                  	mov	ah,[es:si]		;AN000; found ITEM_TAG set
 34100 00004E6E EB1D                    	jmp	short $P_Value_Exit	;AN000;
 34101                                  
 34102                                  $P_Val02_Next:				;AN000;
 34103 00004E70 83C609                  	add	si,$P_Len_Range ; 9 	;AN000;
 34104 00004E73 FEC8                    	dec	al			;AN000; loop nrng times in AL
 34105 00004E75 75B0                    	jnz	short $P_Val02_Loop	;AN000;
 34106                                  					; / Not found
 34107 00004E77 2EC706[BA97]0600        	mov	word [cs:$P_RC],$P_Out_Of_Range
 34108                                  	;mov	word [cs:$P_RC],6	;AC034;
 34109                                  	
 34110                                  	;mov	al,$P_Number ; 1	;AN000;
 34111                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; No ITEM_TAG set
 34112                                  	; 31/03/2023
 34113 00004E7E B801FF                  	mov	ax,($P_No_Tag<<8)+$P_Number
 34114 00004E81 EB0A                    	jmp	short $P_Value_Exit	;AN000;
 34115                                  
 34116                                  	; 27/04/2023
 34117                                  ;$P_Val_Found:				;AN000;
 34118                                  	;mov	al,$P_Number ; 1	;AN000;
 34119                                  	;mov	ah,[es:si]		;AN000; found ITEM_TAG set
 34120                                  	;jmp	short $P_Value_Exit	;AN000;
 34121                                  
 34122                                  $P_Value03:				;AN000; / nval = 2
 34123                                  $P_Value04:				;AN000; / nval = 3 or else
 34124                                  $P_Value_Err:				;AN000;
 34125 00004E83 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax ; 9
 34126                                  					;AC034;
 34127                                  	;mov	al,$P_String ; 3	;AN000; Set type
 34128                                  	;mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 34129                                  	; 31/03/2023
 34130 00004E8A B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 34131                                  $P_Value_Exit:				;AN000;
 34132 00004E8D E81AFD                  	call	$P_Fill_Result		;AN000;
 34133 00004E90 5E                      	pop	si			;AN000;
 34134 00004E91 5A                      	pop	dx			;AN000;
 34135 00004E92 59                      	pop	cx			;AN000;
 34136 00004E93 58                      	pop	ax			;AN000;
 34137 00004E94 C3                      	retn				;AN000;
 34138                                  
 34139                                  ;***********************************************************************
 34140                                  ; $P_Check_OVF
 34141                                  ;
 34142                                  ; Function:  Check if overflow is occurred with consideration of
 34143                                  ;	     signed or un-signed numeric value
 34144                                  ;
 34145                                  ; Input:     Flag register
 34146                                  ;
 34147                                  ; Output:    CY = 1  :	Overflow
 34148                                  ;
 34149                                  ; Vars:     $P_Flags(R)
 34150                                  ;***********************************************************************
 34151                                  
 34152                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34153                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34154                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34155                                  $P_Check_OVF:
 34156 00004E95 9C                      	pushf				;AN000;
 34157 00004E96 2EF606[C697]02          	test	byte [cs:$P_Flags2],$P_Neg ; 2
 34158                                  					;AC034; is it negative value ?
 34159 00004E9C 7502                    	jnz	short $P_COVF		;AN000; if no, check overflow
 34160 00004E9E 9D                      	popf				;AN000; by the CY bit
 34161 00004E9F C3                      	retn				;AN000;
 34162                                  $P_COVF:				;AN000;
 34163 00004EA0 9D                      	popf				;AN000; else,
 34164 00004EA1 7002                    	jo	short $P_COVF00		;AN000; check overflow by the OF
 34165 00004EA3 F8                      	clc				;AN000; indicate it with CY bit
 34166 00004EA4 C3                      	retn				;AN000; CY=0 means no overflow
 34167                                  $P_0099Err:	; 31/03/2023
 34168                                  $P_COVF00:				;AN000;
 34169 00004EA5 F9                      	stc				;AN000; and CY=1 means overflow
 34170                                  $P_0099Err2:	; 31/03/2023
 34171 00004EA6 C3                      	retn				;AN000;
 34172                                  
 34173                                  ;***********************************************************************
 34174                                  ; $P_0099;
 34175                                  ;
 34176                                  ; Function:  Make ASCII 0-9 to Binary 0-9
 34177                                  ;
 34178                                  ; Input:     AL = character code
 34179                                  ;
 34180                                  ; Output:    CY = 1 : AL is not number
 34181                                  ;	     CY = 0 : AL contains binary value
 34182                                  ;***********************************************************************
 34183                                  
 34184                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34185                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34186                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34187                                  $P_0099:
 34188 00004EA7 3C30                    	cmp	al,"0"                  ;AN000;
 34189                                  	;jb	short $P_0099Err	;AN000;  must be 0 =< al =< 9
 34190                                  	; 31/03/2023
 34191 00004EA9 72FB                    	jb	short $P_0099Err2
 34192                                  
 34193 00004EAB 3C39                    	cmp	al,"9"                  ;AN000;
 34194 00004EAD 77F6                    	ja	short $P_0099Err	;AN000;  must be 0 =< al =< 9
 34195                                  
 34196 00004EAF 2C30                    	sub	al,"0"                  ;AN000; make char -> bin
 34197                                  	; 31/03/2023
 34198                                  	;clc				;AN000; indicate no error
 34199 00004EB1 C3                      	retn				;AN000;
 34200                                  	 ;31/03/2023
 34201                                  ;$P_0099Err:				;AN000;
 34202                                  ;	stc				;AN000; indicate error
 34203                                  ;	retn				;AN000;
 34204                                  
 34205                                  ;***********************************************************************
 34206                                  ; $P_Simple_String
 34207                                  ;
 34208                                  ; Function:  See value list for the simple string
 34209                                  ;	     and make result buffer.
 34210                                  ;
 34211                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34212                                  ;	     ES:BX -> CONTROL block
 34213                                  ;
 34214                                  ; Output:    None
 34215                                  ;
 34216                                  ; Use:	$P_Fill_Result, $P_String_Comp
 34217                                  ;
 34218                                  ; Vars: $P_RC(W)
 34219                                  ;***********************************************************************
 34220                                  
 34221                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34222                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34223                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34224                                  $P_Simple_String:
 34225 00004EB2 50                      	push	ax			;AN000;
 34226 00004EB3 53                      	push	bx			;AN000;
 34227 00004EB4 52                      	push	dx			;AN000;
 34228 00004EB5 57                      	push	di			;AN000;
 34229 00004EB6 268B7F06                	mov	di,[es:bx+$P_CONTROL_BLK.$P_Value_List]
 34230                                  	;mov	di,[es:bx+6]		;AN000; di points to value list
 34231 00004EBA 268A05                  	mov	al,[es:di]		;AN000; get nval
 34232 00004EBD 08C0                    	or	al,al			;AN000; no value list ?
 34233 00004EBF 7502                    	jnz	short $P_Sim00		;AN000; then
 34234                                  	; 31/03/2023
 34235                                  	;mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 34236 00004EC1 EB48                    	jmp	short $P_Sim_Exit	;AN000; and set result buffer
 34237                                  $P_Sim00:				;AN000;
 34238 00004EC3 3C03                    	cmp	al,$P_nval_String ; 3	;AN000; String choice list provided ?
 34239 00004EC5 753D                    	jne	short $P_Sim01		;AN000; if no, syntax error
 34240                                  
 34241 00004EC7 47                      	inc	di			;AN000;
 34242 00004EC8 268A05                  	mov	al,[es:di]		;AN000; al = nrng
 34243 00004ECB B409                    	mov	ah,$P_Len_Range ; 9	;AN000;
 34244 00004ECD F6E4                    	mul	ah			;AN000;  Skip nrng field
 34245 00004ECF 40                      	inc	ax			;AN000; ax = (nrng*9)+1
 34246 00004ED0 01C7                    	add	di,ax			;AN000; di points to nnval
 34247 00004ED2 268A05                  	mov	al,[es:di]		;AN000; get nnval
 34248 00004ED5 B405                    	mov	ah,$P_Len_Value ; 5	;AN000;
 34249 00004ED7 F6E4                    	mul	ah			;AN000; Skip nnval field
 34250 00004ED9 40                      	inc	ax			;AN000; ax = (nnval*5)+1
 34251 00004EDA 01C7                    	add	di,ax			;AN000; di points to nstrval
 34252 00004EDC 268A05                  	mov	al,[es:di]		;AN000; get nstrval
 34253 00004EDF 47                      	inc	di			;AC035; add '2' to
 34254 00004EE0 47                      	inc	di			;AC035;  DI reg
 34255                                  					;AN000; di points to 1st string in list
 34256                                  $P_Sim_Loop:				;AN000;
 34257 00004EE1 268B2D                  	mov	bp,[es:di]		;AN000; get string pointer
 34258 00004EE4 E82F00                  	call	$P_String_Comp		;AN000; compare it with operand
 34259 00004EE7 7310                    	jnc	short $P_Sim_Found	;AN000; found on list ?
 34260                                  
 34261 00004EE9 83C703                  	add	di,$P_Len_String ; 3	;AN000; if no, point to next choice
 34262 00004EEC FEC8                    	dec	al			;AN000; loop nstval times in AL
 34263 00004EEE 75F1                    	jnz	short $P_Sim_Loop	;AN000;
 34264                                  					;AN000; / Not found
 34265 00004EF0 2EC706[BA97]0800        	mov	word [cs:$P_RC],$P_Not_In_Str
 34266                                  	;mov	[cs:$P_RC],8		;AC034;
 34267                                  	; 31/03/2023
 34268                                  	;mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 34269 00004EF7 EB12                    	jmp	short $P_Sim_Exit	;AN000;
 34270                                  $P_Sim_Found:				;AN000;
 34271 00004EF9 268A65FF                	mov	ah,[es:di-1]		;AN000; set item_tag
 34272 00004EFD B002                    	mov	al,$P_List_Idx	; 2	;AN000;
 34273 00004EFF 268B15                  	mov	dx,[es:di]		;AN000; get address of STRING
 34274 00004F02 EB0A                    	jmp	short $P_Sim_Exit0	;AN000;
 34275                                  $P_Sim01:				;AN000;
 34276 00004F04 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax
 34277                                  	;mov	word [cs:$P_RC],9	;AC034;
 34278                                  $P_Sim_Exit:
 34279                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; No ITEM_TAG set
 34280                                  ;$P_Sim_Exit:				;AN000;
 34281                                  	;mov	al,$P_String ; 3	;AN000; Set type
 34282                                  	; 31/03/2023
 34283 00004F0B B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 34284                                  $P_Sim_Exit0:				;AN000;
 34285 00004F0E E899FC                  	call	$P_Fill_Result		;AN000;
 34286 00004F11 5F                      	pop	di			;AN000;
 34287 00004F12 5A                      	pop	dx			;AN000;
 34288 00004F13 5B                      	pop	bx			;AN000;
 34289 00004F14 58                      	pop	ax			;AN000;
 34290 00004F15 C3                      	retn				;AN000;
 34291                                  
 34292                                  ;***********************************************************************
 34293                                  ; $P_String_Comp:
 34294                                  ;
 34295                                  ; Function:  Compare two string
 34296                                  ;
 34297                                  ; Input:     psdata_seg:SI -> 1st string
 34298                                  ;	     ES:BP -> 2nd string  (Must be upper case)
 34299                                  ;	     ES:BX -> CONTROL block
 34300                                  ;
 34301                                  ; Output:    CY = 1 if not match
 34302                                  ;
 34303                                  ; Use:	$P_Chk_DBCS, $P_Do_CAPS_Char
 34304                                  ;
 34305                                  ; Vars: $P_KEYor_SW_Ptr(W), $P_Flags(R). $P_KEYorSW_Ptr
 34306                                  ;***********************************************************************
 34307                                  
 34308                                  	; 01/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34309                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34310                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34311                                  $P_String_Comp:
 34312 00004F16 50                      	push	ax			;AN000;
 34313 00004F17 55                      	push	bp			;AN000;
 34314 00004F18 52                      	push	dx			;AN000;
 34315 00004F19 56                      	push	si			;AN000;
 34316 00004F1A B202                    	mov	dl,$P_DOSTBL_Char ; 2	;AN000; use character case map table
 34317                                  $P_SCOM_Loop:				;AN000;
 34318 00004F1C 2E8A04                  	mov	al,[cs:si]		;AN000; get command character
 34319 00004F1F E8A004                  	call	$P_Chk_DBCS		;AN000; DBCS ?
 34320 00004F22 723C                    	jc	short $P_SCOM00		;AN000; yes,DBCS
 34321                                  
 34322 00004F24 E822FE                  	call	$P_Do_CAPS_Char 	;AN000; else, upper case map before comparison
 34323                                  	
 34324 00004F27 2EF606[C697]08          	test	byte [cs:$P_Flags2],$P_Key_Cmp ; 8
 34325                                  					;AC034; keyword search ?
 34326 00004F2D 740D                    	jz	short $P_SCOM04		;AN000;
 34327                                  
 34328                                  	;cmp	al,'=' ; 3Dh
 34329 00004F2F 3C3D                    	cmp	al,$P_Keyword  ;'='	;AN000; "=" is delimiter
 34330 00004F31 751F                    	jne	short $P_SCOM03		;AN000;IF "=" on command line AND  (bp+1=> char after the "=" in synonym list)
 34331                                  
 34332 00004F33 26807E0100              	cmp	byte [es:bp+1],$P_NULL	;AN021;   at end of keyword string in the control block THEN
 34333 00004F38 7562                    	jne	short $P_SCOM_Differ	;AN021;
 34334                                  
 34335 00004F3A EB13                    	jmp	short $P_SCOM05 	;AN000;   keyword found in synonym list
 34336                                  
 34337                                  $P_SCOM04:				;AN000;
 34338 00004F3C 2EF606[C697]10          	test	byte [cs:$P_Flags2],$P_SW_Cmp ; 10h
 34339                                  					;AC034; switch search ?
 34340 00004F42 740E                    	jz	short $P_SCOM03		;AN000;
 34341                                  
 34342 00004F44 3C3A                    	cmp	al,$P_Colon ; ':' ; 3Ah	;AN000; ":" is delimiter, at end of switch on command line
 34343 00004F46 750A                    	jne	short $P_SCOM03		;AN000; continue compares
 34344                                  
 34345 00004F48 26807E0000              	cmp	byte [es:bp],$P_NULL 	;AN021; IF at end of switch on command AND
 34346 00004F4D 754D                    	jne	short $P_SCOM_Differ	;AN021;   at end of switch string in the control block THEN
 34347                                  
 34348                                  $P_SCOM05:				;AN000;   found a match
 34349 00004F4F 46                      	inc	si			;AN000; si points to just after "=" or ":"
 34350 00004F50 EB58                    	jmp	short $P_SCOM_Same	;AN000; exit
 34351                                  
 34352                                  $P_SCOM03:				;AN000;
 34353 00004F52 263A4600                	cmp	al,[es:bp]		;AN000; compare operand w/ a synonym
 34354 00004F56 751D                    	jne	short $P_SCOM_Differ0 	;AN000; if different, check ignore colon option
 34355                                  
 34356 00004F58 08C0                    	or	al,al			;AN000; end of line
 34357 00004F5A 744E                    	jz	short $P_SCOM_Same	;AN000; if so, exit
 34358                                  
 34359 00004F5C 46                      	inc	si			;AN000; update operand pointer
 34360 00004F5D 45                      	inc	bp			;AN000;    and synonym pointer
 34361 00004F5E EB13                    	jmp	short $P_SCOM01 	;AN000; loop until NULL or "=" or ":" found in case
 34362                                  
 34363                                  $P_SCOM00:				;AN000; Here al is DBCS leading byte
 34364 00004F60 263A4600                	cmp	al,[es:bp]		;AN000; compare leading byte
 34365 00004F64 7536                    	jne	short $P_SCOM_Differ	;AN000; if not match, say different
 34366                                  
 34367 00004F66 46                      	inc	si			;AN000; else, load next byte
 34368 00004F67 2E8A04                  	mov	al,[cs:si]		;AN000; and
 34369 00004F6A 45                      	inc	bp			;AN000;
 34370 00004F6B 263A4600                	cmp	al,[es:bp]		;AN000; compare 2nd byte
 34371 00004F6F 752B                    	jne	short $P_SCOM_Differ	;AN000; if not match, say different, too
 34372                                  
 34373 00004F71 46                      	inc	si			;AN000; else update operand pointer
 34374 00004F72 45                      	inc	bp			;AN000; 	and synonym pointer
 34375                                  $P_SCOM01:				;AN000;
 34376 00004F73 EBA7                    	jmp	short $P_SCOM_Loop	;AN000; loop until NULL or "=" or "/" found in case
 34377                                  
 34378                                  $P_SCOM_Differ0:			;AN000;
 34379 00004F75 2EF606[C697]40          	test	byte [cs:$P_Flags2],$P_SW ; 40h
 34380                                  	;test	byte [cs:$P_Flags2],40h	;AC034;(tm10)
 34381 00004F7B 740E                    	jz	short $P_not_applicable	;AN000;(tm10)
 34382                                  
 34383                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_colon_is_not_necessary
 34384                                  	;;test	word [es:bx+2],20h	;AN000;(tm10)
 34385                                  	; 03/04/2023
 34386 00004F7D 26F6470220              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_colon_is_not_necessary
 34387 00004F82 7407                    	jz	short $P_not_applicable	;AN000;(tm10)
 34388                                  
 34389 00004F84 26807E0000              	cmp	byte [es:bp],$P_NULL	;AN000;(tm10)
 34390 00004F89 741F                    	je	short $P_SCOM_Same	;AN025;(tm10)
 34391                                  
 34392                                  $P_not_applicable:			;AN000;(tm10)
 34393                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Ig_Colon
 34394                                  	;;test	word [es:bx],10h	;AN000; ignore colon option specified ?
 34395                                  	; 03/04/2023
 34396 00004F8B 26F60710                	test	byte [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Ig_Colon
 34397 00004F8F 740B                    	jz	short $P_SCOM_Differ	;AN000; if no, say different.
 34398                                  
 34399 00004F91 3C3A                    	cmp	al,$P_Colon ; ':' ; 3Ah	;AN000; End up with ":" and
 34400 00004F93 750A                    	jne	short $P_SCOM02		;AN000;    subseqently
 34401                                  
 34402 00004F95 26807E0000              	cmp	byte [es:bp],$P_NULL 	;AN000;      NULL ?
 34403                                  	;jne	short $P_SCOM_Differ	;AN000; if no, say different
 34404                                  	;jmp	short $P_SCOM_Same	;AN000; else, say same
 34405                                  	; 01/04/2023
 34406 00004F9A 740E                    	je	short $P_SCOM_Same
 34407                                  $P_SCOM_Differ:
 34408 00004F9C F9                      	stc
 34409 00004F9D EB10                    	jmp	short $P_SCOM_Exit
 34410                                  
 34411                                  $P_SCOM02:				;AN000;
 34412 00004F9F 3C00                    	cmp	al,$P_NULL ; 0		;AN000; end up NULL and :
 34413 00004FA1 75F9                    	jne	short $P_SCOM_Differ	;AN000;
 34414                                  
 34415                                  	;cmp	byte [es:bp],':'
 34416 00004FA3 26807E003A              	cmp	byte [es:bp],$P_Colon	;AN000; if no, say different
 34417                                  	;je	short $p_SCOM_Same	;AN000; else, say same
 34418                                  	; 01/04/2023
 34419 00004FA8 75F2                    	jne	short $P_SCOM_Differ
 34420                                  ;$P_SCOM_Differ: 			;AN000;
 34421                                  	;stc				;AN000; indicate not found
 34422                                  	;jmp	short $P_SCOM_Exit	;AN000;
 34423                                  
 34424                                  $P_SCOM_Same:				;AN000;
 34425 00004FAA 2E8936[C997]            	mov	[cs:$P_KEYorSW_Ptr],si	;AC034; for later use by keyword or switch
 34426                                  	; 01/04/2023
 34427                                  	;clc
 34428                                  	; cf = 0			;AN000; indicate found
 34429                                  $P_SCOM_Exit:				;AN000;
 34430 00004FAF 5E                      	pop	si			;AN000;
 34431 00004FB0 5A                      	pop	dx			;AN000;
 34432 00004FB1 5D                      	pop	bp			;AN000;
 34433 00004FB2 58                      	pop	ax			;AN000;
 34434 00004FB3 C3                      	retn				;AN000;
 34435                                  
 34436                                  ;***********************************************************************
 34437                                  ; $P_Date_Format
 34438                                  ;
 34439                                  ; Function:  Convert a date string to DOS date format for int 21h
 34440                                  ;	     with format validation.
 34441                                  ;
 34442                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34443                                  ;	     ES:BX -> CONTROL block
 34444                                  ;
 34445                                  ; Output:    None
 34446                                  ;
 34447                                  ; Use:	$P_Fill_Result, $P_Set_CDI, $P_Get_DecNum
 34448                                  ;
 34449                                  ; Vars: $P_RC(W), $P_1st_Val(RW), $P_2nd_Val(RW), $P_3rd_Val(RW)
 34450                                  ;***********************************************************************
 34451                                  
 34452                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34453                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34454                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34455                                  $P_Date_Format:
 34456 00004FB4 50                      	push	ax			;AN000;
 34457 00004FB5 51                      	push	cx			;AN000;
 34458 00004FB6 52                      	push	dx			;AN000;
 34459 00004FB7 56                      	push	si			;AN000;
 34460 00004FB8 53                      	push	bx			;AN000;
 34461 00004FB9 56                      	push	si			;AN000;
 34462 00004FBA E8AA00                  	call	$P_Set_CDI		;AN000; set country dependent information before process
 34463                                  
 34464                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 34465                                  %if 0
 34466                                  	; 03/04/2023
 34467                                  	;pop	si			;AN000;
 34468                                  	;mov	word [cs:$P_1st_Val],0	;AC034; set initial value
 34469                                  	;mov	word [cs:$P_2nd_Val],0	;AC034; set initial value
 34470                                  	;mov	word [cs:$P_3rd_Val],0	;AC034; set initial value
 34471                                  	xor	si,si
 34472                                  	mov	[cs:$P_1st_Val],si ; 0	;AC034; set initial value
 34473                                  	mov	[cs:$P_2nd_Val],si ; 0	;AC034; set initial value
 34474                                  	; 11/08/2024 
 34475                                  	mov	[cs:$P_3rd_Val],si ; 0	;AC034; set initial value
 34476                                  	pop	si
 34477                                  %else
 34478                                  	; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 34479 00004FBD 5E                      	pop	si
 34480 00004FBE B8FFFF                  	mov	ax,0FFFFh ; -1
 34481 00004FC1 2EA3[7898]              	mov	[cs:$P_1st_Val],ax ; -1	; set initial value
 34482 00004FC5 2EA3[7A98]              	mov	[cs:$P_2nd_Val],ax ; -1	; set initial value
 34483 00004FC9 2EA3[7C98]              	mov	[cs:$P_3rd_Val],ax ; -1	; set initial value
 34484                                  %endif
 34485 00004FCD E8B100                  	call	$P_Get_DecNum		;AN000; get 1st number
 34486                                  	;jc	short $P_DateF_Err0	;AN000;-----------------------+
 34487                                  	; 11/08/2024
 34488 00004FD0 724E                    	jc	short $P_DateF_Error	; ----------------------------+
 34489 00004FD2 2EA3[7898]              	mov	[cs:$P_1st_Val],ax	;AC034;			      |
 34490 00004FD6 08DB                    	or	bl,bl			;AN000; end of line ?	      |
 34491 00004FD8 741A                    	jz	short $P_DateF_YMD	;AN000; 		      |
 34492 00004FDA E8A400                  	call	$P_Get_DecNum		;AN000; get 2nd number	      |
 34493 00004FDD 7241                    	jc	short $P_DateF_Error	;AN000; 		      |
 34494 00004FDF 2EA3[7A98]              	mov	[cs:$P_2nd_Val],ax	;AC034;			      |
 34495 00004FE3 08DB                    	or	bl,bl			;AN000; end of line ?	      |
 34496 00004FE5 740D                    	jz	short $P_DateF_YMD	;AN000; 		      |
 34497 00004FE7 E89700                  	call	$P_Get_DecNum		;AN000; get 3rd number	      |
 34498                                  $P_DateF_Err0:				;AN000; Bridge	  <-----------+
 34499 00004FEA 7234                    	jc	short $P_DateF_Error	;AN000;
 34500 00004FEC 2EA3[7C98]              	mov	[cs:$P_3rd_Val],ax	;AC034;
 34501 00004FF0 08DB                    	or	bl,bl			;AN000; end of line ?
 34502 00004FF2 752C                    	jnz	short $P_DateF_Error	;AN000;
 34503                                  $P_DateF_YMD:				;AN000;
 34504 00004FF4 2E8B1E[5698]            	mov	bx,[cs:$P_Country_Info+$P_CDI.$P_CDI_DateF]
 34505                                  	;mov	bx,[cs:$P_Country_Info]	;AC034; get date format
 34506 00004FF9 83FB02                  	cmp	bx,$P_Date_YMD ; 2	;AN000;
 34507 00004FFC 7435                    	je	short $P_DateF00	;AN000;
 34508 00004FFE 2EA1[7898]              	mov	ax,[cs:$P_1st_Val]	;AC034;
 34509 00005002 08E4                    	or	ah,ah			;AN000;
 34510 00005004 751A                    	jnz	short $P_DateF_Error	;AN000;
 34511 00005006 88C1                    	mov	cl,al			;AN000; set month
 34512 00005008 2EA1[7A98]              	mov	ax,[cs:$P_2nd_Val]	;AC034;
 34513 0000500C 08E4                    	or	ah,ah			;AN000; if overflow, error.
 34514 0000500E 7510                    	jnz	short $P_DateF_Error	;AN000;
 34515 00005010 88C5                    	mov	ch,al			;AN000; set date
 34516 00005012 2E8B16[7C98]            	mov	dx,[cs:$P_3rd_Val]	;AC034; set year
 34517 00005017 83FB01                  	cmp	bx,$P_Date_DMY ; 1	;AN000; from here format = MDY
 34518 0000501A 7502                    	jne	short $P_DateF01	;AN000; if it is DMY
 34519 0000501C 86CD                    	xchg	ch,cl			;AN000;  then swap M <-> D
 34520                                  $P_DateF01:				;AN000;
 34521 0000501E EB2C                    	jmp	short $P_DateF02	;AN000;
 34522                                  
 34523                                  $P_DateF_Error: 			;AN000;
 34524 00005020 5B                      	pop	bx			;AN000; recover CONTROL block
 34525 00005021 5E                      	pop	si			;AN000; recover string pointer
 34526                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 34527                                  	;mov	al,$P_String ; 3	;AN000; result
 34528                                  	; 03/04/2023
 34529 00005022 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 34530 00005025 E882FB                  	call	$P_Fill_Result		;AN000; buffer
 34531                                  					;AN000; to string
 34532 00005028 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax ; 9
 34533                                  					;AC034; indicate syntax error
 34534                                  $P_Date_Format_Exit:			;AN000;
 34535 0000502F 5A                      	pop	dx			;AN000;
 34536 00005030 59                      	pop	cx			;AN000;
 34537 00005031 58                      	pop	ax			;AN000;
 34538 00005032 C3                      	retn				;AN000;
 34539                                  
 34540                                  $P_DateF00:				;AN000; / here format = YMD
 34541 00005033 2E8B16[7898]            	mov	dx,[cs:$P_1st_Val]	;AC034; set year
 34542 00005038 2EA1[7A98]              	mov	ax,[cs:$P_2nd_Val]	;AC034;
 34543 0000503C 08E4                    	or	ah,ah			;AN000; if overflow, error
 34544 0000503E 75E0                    	jnz	short $P_DateF_Error	;AN000;
 34545                                  
 34546 00005040 88C1                    	mov	cl,al			;AN000; set month
 34547 00005042 2EA1[7C98]              	mov	ax,[cs:$P_3rd_Val]	;AC034;
 34548 00005046 08E4                    	or	ah,ah			;AN000; if overflow, error
 34549 00005048 75D6                    	jnz	short $P_DateF_Error	;AN000;
 34550 0000504A 88C5                    	mov	ch,al			;AN000; set date
 34551                                  $P_DateF02:				;AN000;
 34552                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 34553                                  %if 0
 34554                                  	cmp	dx,100			;AN000; year is less that 100 ?
 34555                                  	jae	short $P_DateF03	;AN000;
 34556                                  	add	dx,1900 		;AN000; set year 19xx
 34557                                  %else
 34558 0000504C 83FA64                  	cmp	dx,100
 34559 0000504F 730C                    	jnb	short $P_DateF03
 34560 00005051 83FA50                  	cmp	dx,80
 34561 00005054 7303                    	jnb	short $P_DateF02_@
 34562 00005056 83C264                  	add	dx,100
 34563                                  $P_DateF02_@:
 34564 00005059 81C26C07                	add	dx,1900
 34565                                  %endif
 34566                                  $P_DateF03:				;AN000;
 34567 0000505D 5B                      	pop	bx			;AN000; recover CONTROL block
 34568 0000505E 5E                      	pop	si			;AN000; recover string pointer
 34569                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 34570                                  	;mov	al,$P_Date_F ; 7	;AN000; result
 34571                                  	; 03/04/2023
 34572 0000505F B807FF                  	mov	ax,($P_No_Tag<<8)+$P_Date_F
 34573 00005062 E845FB                  	call	$P_Fill_Result		;AN000; buffer
 34574 00005065 EBC8                    	jmp	short $P_Date_Format_Exit
 34575                                  					;AN000;	to Date
 34576                                  
 34577                                  ;***********************************************************************
 34578                                  ; $P_Set_CDI:
 34579                                  ;
 34580                                  ; Function: Read CDI from DOS if it has not been read yet
 34581                                  ;
 34582                                  ; Input:    None
 34583                                  ;
 34584                                  ; Output:   psdata_seg:SI -> CDI
 34585                                  ;
 34586                                  ; Use:	INT 21h w/ AH = 38h
 34587                                  ;***********************************************************************
 34588                                  
 34589                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34590                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34591                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34592                                  $P_Set_CDI:
 34593                                  	; 18/04/2023
 34594 00005067 8D36[5698]              	lea	si,$P_Country_Info	;AC034;
 34595                                  	;cmp	word [cs:si+$P_CDI.$P_CDI_DateF],-1 ; $P_NeedToBeRead
 34596 0000506B 2E833CFF                	cmp	word [cs:si],-1 ; $P_NeedToBeRead ; 0FFFFh
 34597                                  					;AN000; already read ?
 34598                                  	;je	short $P_Read_CDI	;AN000;
 34599                                  	;jmp	short $P_Set_CDI_Exit	;AN000; then do nothing
 34600                                  	; 03/04/2023
 34601 0000506F 750F                    	jne	short $P_Set_CDI_Exit
 34602                                  $P_Read_CDI:				;AN000; else read CDI thru DOS
 34603 00005071 1E                      	push	ds			;AN000;
 34604 00005072 52                      	push	dx			;AN000;
 34605 00005073 50                      	push	ax			;AN000;
 34606 00005074 0E                      	push	cs			;AC023;
 34607 00005075 1F                      	pop	ds			;AN000; set segment register
 34608                                  	;mov	ax,3800h
 34609 00005076 B80038                  	mov	ax,$P_DOS_Get_CDI	;AN000; get country information
 34610 00005079 89F2                    	mov	dx,si			;AN000; set offset of CDI in local data area
 34611 0000507B CD21                    	int	21h			;AN000;
 34612 0000507D 58                      	pop	ax			;AN000;
 34613 0000507E 5A                      	pop	dx			;AN000;
 34614 0000507F 1F                      	pop	ds			;AN000;
 34615                                  $P_Set_CDI_Exit:			;AN000;
 34616 00005080 C3                      	retn				;AN000;
 34617                                  
 34618                                  ;***********************************************************************
 34619                                  ; $P_Get_DecNum:
 34620                                  ;
 34621                                  ; Function:  Read a character code from psdata_seg:SI until specified delimiter
 34622                                  ;	     or NULL encountered. And make a decimal number.
 34623                                  ;
 34624                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34625                                  ;
 34626                                  ; Output:    BL = delimiter code or NULL
 34627                                  ;	     AX = Decimal number
 34628                                  ;	     SI advanced to the next number
 34629                                  ;	     CY = 1 : Syntax error, AL = Latest examineed number
 34630                                  ;
 34631                                  ; Use:	$P_0099
 34632                                  ;***********************************************************************
 34633                                  
 34634                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34635                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34636                                  	; 11/08/2024 - Retro DOS v5.0 COMMAND.COM
 34637                                  $P_Get_DecNum:
 34638 00005081 51                      	push	cx			;AN000;
 34639 00005082 52                      	push	dx			;AN000;
 34640 00005083 31C9                    	xor	cx,cx			;AN000; cx will have final value
 34641                                  $P_GetNum_Loop: 			;AN000;
 34642 00005085 2E8A04                  	mov	al,[cs:si]		;AN000; load character
 34643 00005088 08C0                    	or	al,al			;AN000; end of line ?
 34644 0000508A 7438                    	jz	short $P_GetNum00	;AN000; if yes, exit
 34645 0000508C 2E803E[5598]00          	cmp	byte [cs:$P_Got_Time],0 ;AC034; is this numeric in a time field? ;AC023
 34646 00005092 740B                    	je	short $P_Do_Date_Delims	;AN000; no, go check out Date delimiters ;AC023
 34647                                  
 34648                                  ; Determine which delimiter(s) to check for. Colon & period  or period only
 34649                                  	;cmp	bl,$P_colon_period
 34650 00005094 80FB01                  	cmp	bl,1 ; $P_colon_period	;AN032; ;Time
 34651 00005097 750E                    	jne	short $P_Do_Time_Delim1	;AN032; ;only check for period
 34652                                  
 34653 00005099 3C3A                    	cmp	al,$P_Colon ; ':'	;AN032; ;Is this a valid delimiter ?
 34654 0000509B 742B                    	je	short $P_GetNum01	;AN032; ;yes, exit
 34655                                  
 34656                                  	; 03/04/2023
 34657 0000509D EB08                    	jmp	short $P_Do_Time_Delim1
 34658                                  ;$P_Do_Time_Delim1:			;AN000;
 34659                                  	;cmp	al,$P_Period ; '.'	;;AC032;;AC023;Is this a valid delimiter ?
 34660                                  	;je	short $P_GetNum01	;AC023; yes, exit
 34661                                  	;
 34662                                  	;jmp	short $P_Neither_Delims ;AN023;
 34663                                  
 34664                                  $P_Do_Date_Delims:			;AN000;
 34665                                  ;Regardless of the date delimiter character specified in the country
 34666                                  ;dependent information, check for the presence of any one of these
 34667                                  ;three field delimiters: "-", "/", or ".".
 34668 0000509F 3C2D                    	cmp	al,$P_Minus ;'-'	;AN020;is this a date delimiter character?
 34669 000050A1 7425                    	je	short $P_GetNum01	;AN020;if yes, exit
 34670                                  
 34671 000050A3 3C2F                    	cmp	al,$P_Slash ; '/'	;AN020;is this a date delimiter character?
 34672 000050A5 7421                    	je	short $P_GetNum01	;AN020;if yes, exit
 34673                                  
 34674                                  $P_Do_Time_Delim1:  ; 03/04/2023
 34675 000050A7 3C2E                    	cmp	al,$P_Period ; '.'	;AN020;is this a date delimiter character?
 34676 000050A9 741D                    	je	short $P_GetNum01	;AN000; if yes, exit
 34677                                  
 34678                                  $P_Neither_Delims:			;AN023;
 34679 000050AB E8F9FD                  	call	$P_0099 		;AN000; convert it to binary
 34680 000050AE 721C                    	jc	short $P_GetNum_Exit	;AN000; if error exit
 34681                                  
 34682 000050B0 B400                    	mov	ah,0			;AN000;
 34683 000050B2 91                      	xchg	ax,cx			;AN000;
 34684 000050B3 BA0A00                  	mov	dx,10			;AN000;
 34685 000050B6 F7E2                    	mul	dx			;AN000; ax = ax * 10
 34686 000050B8 09D2                    	or	dx,dx			;AN000; overflow
 34687 000050BA 750F                    	jnz	short $P_GetNum02	;AN000; then exit
 34688                                  
 34689 000050BC 01C8                    	add	ax,cx			;AN000;
 34690 000050BE 720C                    	jc	short $P_GetNum_Exit	;AN000;
 34691                                  
 34692 000050C0 91                      	xchg	ax,cx			;AN000;
 34693 000050C1 46                      	inc	si			;AN000;
 34694 000050C2 EBC1                    	jmp	short $P_GetNum_Loop	;AN000;
 34695                                  
 34696                                  $P_GetNum00:				;AN000;
 34697 000050C4 88C3                    	mov	bl,al			;AN000; set bl to NULL
 34698                                  	;03/04/2023
 34699                                  	; cf=0
 34700                                  	;clc				;AN000; indicate no error
 34701 000050C6 EB04                    	jmp	short $P_GetNum_Exit	;AN000;
 34702                                  
 34703                                  $P_GetNum01:				;AN000;
 34704 000050C8 46                      	inc	si			;AN000; si points to next number
 34705                                  	;03/04/2023
 34706                                  	; cf=0
 34707                                  	;clc				;AN000; indicate no error
 34708 000050C9 EB01                    	jmp	short $P_GetNum_Exit	;AN000;
 34709                                  
 34710                                  $P_GetNum02:				;AN000;
 34711 000050CB F9                      	stc				;AN000; indicate error
 34712                                  $P_GetNum_Exit: 			;AN000;
 34713 000050CC 89C8                    	mov	ax,cx			;AN000;return value
 34714 000050CE 5A                      	pop	dx			;AN000;
 34715 000050CF 59                      	pop	cx			;AN000;
 34716 000050D0 C3                      	retn				;AN000;
 34717                                  
 34718                                  ;***********************************************************************
 34719                                  ; $P_Time_Format
 34720                                  ;
 34721                                  ; Function:  Convert a time string to DOS time format for int 21h
 34722                                  ;	     with format validation.
 34723                                  ;
 34724                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34725                                  ;	     ES:BX -> CONTROL block
 34726                                  ;
 34727                                  ; Output:    None
 34728                                  ;
 34729                                  ; Use:	$P_Fill_Result, $P_Set_CDI, $P_Get_DecNum, $P_Time_2412
 34730                                  ;
 34731                                  ; Vars: $P_RC(W), $P_Flags(R), $P_1st_Val(RW), $P_2nd_Val(RW)
 34732                                  ;	$P_3rd_Val(RW), $P_4th_Val(RW)
 34733                                  ;***********************************************************************
 34734                                  
 34735                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34736                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34737                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 34738                                  $P_Time_Format:				;AN000;
 34739 000050D1 50                      	push	ax			;AN000;
 34740 000050D2 51                      	push	cx			;AN000;
 34741 000050D3 52                      	push	dx			;AN000;
 34742 000050D4 56                      	push	si			;AN000;
 34743 000050D5 53                      	push	bx			;AN000;
 34744 000050D6 56                      	push	si			;AN000;
 34745 000050D7 E88DFF                  	call	$P_Set_CDI		;AN000; Set country independent
 34746                                  					; information before process
 34747                                  	;test	byte [cs:si+11h], 1
 34748 000050DA 2EF6441001              	test	byte [cs:si+$P_CDI.$P_CDI_TimeF],1 
 34749                                  					;AN000; 24 hour system
 34750 000050DF 5E                      	pop	si			;AN000;
 34751 000050E0 7503                    	jnz	short $P_TimeF00	;AN000; if no, means 12 hour system
 34752 000050E2 E8F800                  	call	$P_Time_2412		;AN000; this routine handle "am" "pm"
 34753                                  $P_TimeF00:				;AN000;
 34754                                  	;mov	word [cs:$P_1st_Val],0	;AC034; set initial value
 34755                                  	;mov	word [cs:$P_2nd_Val],0	;AC034; set initial value
 34756                                  	;mov	word [cs:$P_3rd_Val],0	;AC034; set initial value
 34757                                  	;mov	word [cs:$P_4th_Val],0	;AC034; set initial value
 34758                                  	;mov	byte [cs:$P_Got_Time],1	;AN023;AC034;; use time delimiter
 34759                                  	; 03/04/2023
 34760 000050E5 31DB                    	xor	bx,bx
 34761 000050E7 2E891E[7898]            	mov	[cs:$P_1st_Val],bx ; 0
 34762 000050EC 2E891E[7A98]            	mov	[cs:$P_2nd_Val],bx ; 0
 34763 000050F1 2E891E[7C98]            	mov	[cs:$P_3rd_Val],bx ; 0
 34764 000050F6 2E891E[7E98]            	mov	[cs:$P_4th_Val],bx ; 0
 34765                                  	;inc	bl
 34766                                  	;mov	[cs:$P_Got_Time],bl ; 1
 34767                                  
 34768                                  	;mov	bl,$P_colon_period
 34769                                  	;mov	bl,1 ; $P_colon_period	;AN032; flag, indicates use of
 34770                                  					; delimiters between hours,
 34771                                  					;  minutes,seconds
 34772                                  	; 03/04/2023 - Retro DOS v4.0 COMMAND.COM
 34773 000050FB FEC3                    	inc	bl ; bl = 1
 34774 000050FD 2E881E[5598]            	mov	[cs:$P_Got_Time],bl ; 1
 34775                                  	;
 34776 00005102 E87CFF                  	call	$P_Get_DecNum		;AN000; get 1st number
 34777                                  	;jc	short $P_TimeF_Err0	;AN000;
 34778                                  	; 12/08/2024
 34779 00005105 725A                    	jc	short $P_TimeF_Error
 34780 00005107 2EA3[7898]              	mov	[cs:$P_1st_Val],ax	;AC034;
 34781 0000510B 08DB                    	or	bl,bl			;AN000; end of line ?
 34782 0000510D 7478                    	jz	short $P_TimeF_Rlt	;AN000;
 34783 0000510F E86FFF                  	call	$P_Get_DecNum		;AN000; get 2nd number
 34784                                  	;jc	short $P_TimeF_Err0	;AC038; if OK
 34785                                  	; 12/08/2024
 34786 00005112 724D                    	jc	short $P_TimeF_Error
 34787 00005114 2EA3[7A98]              	mov	[cs:$P_2nd_Val],ax	;AC034;
 34788 00005118 08DB                    	or	bl,bl			;AN000; end of line ?
 34789 0000511A 746B                    	jz	short $P_TimeF_Rlt	;AN000;
 34790 0000511C B302                    	mov	bl,2 ; $P_period_only	;AN032; flag, which to decimal separator
 34791 0000511E E860FF                  	call	$P_Get_DecNum		;AN000; get 3rd number
 34792                                  	;jc	short $P_TimeF_Err0	;AC039; if problem, bridge to error
 34793                                  	; 12/08/2024
 34794 00005121 723E                    	jc	short $P_TimeF_Error
 34795 00005123 2EA3[7C98]              	mov	[cs:$P_3rd_Val],ax	;AC034;
 34796 00005127 08DB                    	or	bl,bl			;AN000; end of line ?
 34797 00005129 754F                    	jnz	short $P_Time_4		;AN039; NOT END OF LINE,
 34798                                  					;AN039;   GO TO 4TH NUMBER
 34799                                  	;test	byte [cs:$P_Flags1],$P_Time_Again ; 2
 34800 0000512B 2EF606[C597]02          	test	byte [cs:$P_Flags1],2 	;AN039; HAS TIME PARSE
 34801                                  					;AN039;    BEEN REPEATED?
 34802 00005131 7554                    	jnz	short $P_TimeF_Rlt	;AN039; yes, this is really
 34803                                  					;AN039;   the end of line
 34804                                  					;AN039; no, time has not been repeated
 34805 00005133 2E8B36[BC97]            	mov	si,[cs:$P_SI_Save]	;AN039; get where parser quit
 34806                                  					;AN039;   in command line
 34807 00005138 807CFF2C                	cmp	byte [si-1],$P_Comma ; ','
 34808                                  					;AN039; look at delimiter
 34809                                  					;AN039;   from command line
 34810 0000513C 7549                    	jne	short $P_TimeF_Rlt	;AN039; was not a comma, this is
 34811                                  					;AN039;  really end of line
 34812                                  					;AN039; is comma before hundredths,
 34813                                  					;AN039;   redo TIME
 34814 0000513E C644FF2E                	mov	byte [si-1],$P_Period ; '.' 
 34815                                  					;AN039; change that ambiguous
 34816                                  					;AN039;    comma to a decimal point
 34817                                  					;AN039;     parse can understand
 34818 00005142 2EC706[C597]0000        	mov	word [cs:$P_Flags],0	;AN039; Clear all internal flags
 34819                                  	;or	byte [cs:$P_Flags1],$P_Time_Again
 34820 00005149 2E800E[C597]02          	or	byte [cs:$P_Flags1],2	;AN039; indicate TIME
 34821                                  					;AN039; is being repeated
 34822 0000514F 2E8B0E[4F98]            	mov	cx,[cs:$P_ORIG_ORD]	;AN039; ORIGINAL ORDINAL FROM CX
 34823 00005154 2E8B26[5198]            	mov	sp,[cs:$P_ORIG_STACK]	;AN039; ORIGINAL VALUE
 34824                                  					;AN039;   OF STACK FROM SP
 34825 00005159 2E8B36[5398]            	mov	si,[cs:$P_ORIG_SI]	;AN039; ORIGINAL START
 34826                                  					;AN039;   PARSE POINTER FROM SI
 34827 0000515E E921F8                  	jmp	$P_Redo_Time		;AN039; go try TIME again
 34828                                  
 34829                                  	; 12/08/2024
 34830                                  $P_TimeF_Error: 			;AN000;
 34831                                  $P_TimeF_Err:				;AN000;
 34832 00005161 5B                      	pop	bx			;AN000; recover CONTROL block
 34833 00005162 5E                      	pop	si			;AN000; recover string pointer
 34834                                  	;mov	ah,$P_No_Tag		;AN000; set
 34835                                  	;mov	al,$P_String		;AN000;     result
 34836                                  	; 03/04/2023
 34837 00005163 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 34838 00005166 E841FA                  	call	$P_Fill_Result		;AN000; 	  buffer
 34839                                  					;AN000; to string
 34840 00005169 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax ; 9	
 34841                                  					;AC034; return syntax error
 34842                                  $P_Time_Format_Exit:			;AN000;
 34843 00005170 2EC606[5598]00          	mov	byte [cs:$P_Got_Time],0	;AN023;AC034; finished with this time field
 34844 00005176 5A                      	pop	dx			;AN000;
 34845 00005177 59                      	pop	cx			;AN000;
 34846 00005178 58                      	pop	ax			;AN000;
 34847 00005179 C3                      	retn
 34848                                  
 34849                                  $P_Time_4:				;AN039; READY FOR 4TH (HUNDREDTHS) NUMBER
 34850 0000517A E804FF                  	call	$P_Get_DecNum		;AN000; get 4th number
 34851                                  $P_TimeF_Err0:				;AN000; Bridge
 34852 0000517D 72E2                    	jc	short $P_TimeF_Error	;AN000;
 34853                                  	;
 34854 0000517F 2EA3[7E98]              	mov	[cs:$P_4th_Val],ax	;AC034;
 34855 00005183 08DB                    	or	bl,bl			;AN000; After hundredth, no data allowed
 34856 00005185 75DA                    	jnz	short $P_TimeF_Error	;AN000; if some, then error
 34857                                  $P_TimeF_Rlt:				;AN000;
 34858 00005187 2EA1[7898]              	mov	ax,[cs:$P_1st_Val]	;AC034;
 34859 0000518B 08E4                    	or	ah,ah			;AN000; if overflow then error
 34860 0000518D 75D2                    	jnz	short $P_TimeF_Err	;AN000;
 34861                                  	;test	byte [cs:$P_Flags1],$P_Time12am ; 1
 34862 0000518F 2EF606[C597]01          	test	byte [cs:$P_Flags1],1	;AN038;if "am" specified
 34863 00005195 7408                    	jz	short $P_Time_notAM	;AN038;skip if no "AM" specified
 34864                                  					;since "AM" was specified,
 34865 00005197 3C0C                    	cmp	al,12			;AN038: if hour specified as later than noon
 34866 00005199 77C6                    	ja	short $P_TimeF_Err	;AN038; error if "AM" on more than noon
 34867 0000519B 7502                    	jne	short $P_Time_notAM	;AN038; for noon exactly,
 34868 0000519D 30C0                    	xor	al,al			;AN038; set hour = zero
 34869                                  $P_Time_notAM:				;AN038;
 34870                                  	;test	byte [cs:$P_Flags2],$P_Time12
 34871 0000519F 2EF606[C697]04          	test	byte [cs:$P_Flags2],4	;AC034; if 12 hour system and pm is specified
 34872 000051A5 740C                    	jz	short $P_TimeSkip00	;AN000; then
 34873 000051A7 3C0C                    	cmp	al,12			;AN038; if 12:00 o'clock already
 34874 000051A9 7408                    	je	short $P_TimeSkip00	;AN038; it is PM already
 34875 000051AB 040C                    	add	al,12			;AN000; add 12 hours to make it afternoon
 34876 000051AD 72B2                    	jc	short $P_TimeF_Err	;AN000; if overflow then error
 34877 000051AF 3C18                    	cmp	al,24			;AN038; after adding 12, now cannot be >24
 34878 000051B1 77AE                    	ja	short $P_TimeF_Err	;AN038; if too big, error
 34879                                  $P_TimeSkip00:				;AN000;
 34880 000051B3 88C2                    	mov	dl,al			;AN000; set hour
 34881 000051B5 2EA1[7A98]              	mov	ax,[cs:$P_2nd_Val]	;AC034;
 34882 000051B9 08E4                    	or	ah,ah			;AN000; if overflow then error
 34883 000051BB 75A4                    	jnz	short $P_TimeF_Err	;AN000;
 34884 000051BD 88C6                    	mov	dh,al			;AN000; set minute
 34885 000051BF 2EA1[7C98]              	mov	ax,[cs:$P_3rd_Val]	;AC034;
 34886 000051C3 08E4                    	or	ah,ah			;AN000; if overflow then error
 34887 000051C5 759A                    	jnz	short $P_TimeF_Err	;AN000;
 34888 000051C7 88C1                    	mov	cl,al			;AN000; set second
 34889 000051C9 2EA1[7E98]              	mov	ax,[cs:$P_4th_Val]	;AC034;
 34890 000051CD 08E4                    	or	ah,ah			;AN000; if overflow then error
 34891 000051CF 7590                    	jnz	short $P_TimeF_Err	;AN000;
 34892 000051D1 88C5                    	mov	ch,al			;AN000; set hundredth
 34893 000051D3 5B                      	pop	bx			;AN000; recover CONTROL block
 34894 000051D4 5E                      	pop	si			;AN000; recover string pointer
 34895                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 34896                                  	;mov	al,$P_Time_F ; 8 	;AN000; result
 34897                                  	; 03/04/2023
 34898 000051D5 B808FF                  	mov	ax,($P_No_Tag<<8)+$P_Time_F
 34899 000051D8 E8CFF9                  	call	$P_Fill_Result		;AN000; buffer
 34900 000051DB EB93                    	jmp	short $P_Time_Format_Exit
 34901                                  					;AN000; to time
 34902                                  
 34903                                  ;***********************************************************************
 34904                                  ; $P_Time_2412:
 34905                                  ;
 34906                                  ; Function:  Remove "a", "p", "am", or "pm" from the end of stinrg
 34907                                  ;
 34908                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34909                                  ;
 34910                                  ; Output:    Set $P_Time12 flag when the string is terminated by "p"
 34911                                  ;	     or "pm"
 34912                                  ;
 34913                                  ; Vars:  $P_Flags(W)
 34914                                  ;***********************************************************************
 34915                                  
 34916                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34917                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34918                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 34919                                  $P_Time_2412:				;AN000;
 34920 000051DD 50                      	push	ax			;AN000;
 34921 000051DE 56                      	push	si			;AN000;
 34922                                  $P_T12_Loop:				;AN000;
 34923 000051DF 2E8A04                  	mov	al,[cs:si]		;AN000; Move
 34924 000051E2 46                      	inc	si			;AN000;     si
 34925 000051E3 08C0                    	or	al,al			;AN000;       to
 34926 000051E5 75F8                    	jnz	short $P_T12_Loop	;AN000; 	end of string
 34927                                  
 34928 000051E7 2E8A44FE                	mov	al,[cs:si-2]		;AN000; get char just before NULL
 34929                                  	;or	al,20h
 34930 000051EB 0C20                    	or	al,$P_Make_Lower ; 20h	;AN000; lower case map
 34931 000051ED 3C70                    	cmp	al,"p"                  ;AN000; only "p" of "pm" ?
 34932 000051EF 7425                    	je	short $P_T1200		;AN000;
 34933                                  
 34934 000051F1 3C61                    	cmp	al,"a"                  ;AN000; only "a" of "am" ?
 34935 000051F3 7413                    	je	short $P_T1201		;AN000;
 34936                                  
 34937 000051F5 3C6D                    	cmp	al,"m"                  ;AN000; "m" of "am" or "pm"
 34938 000051F7 751A                    	jne	short $P_T12_Exit	;AN000;
 34939                                  
 34940 000051F9 4E                      	dec	si			;AN000;
 34941 000051FA 2E8A44FE                	mov	al,[cs:si-2]		;AN000;
 34942                                  	;or	al,20h
 34943 000051FE 0C20                    	or	al,$P_Make_Lower ; 20h	;AN000; lower case map
 34944 00005200 3C70                    	cmp	al,"p"                  ;AN000; "p" of "pm" ?
 34945 00005202 7412                    	je	short $P_T1200		;AN000;
 34946                                  
 34947 00005204 3C61                    	cmp	al,"a"                  ;AN000; "a" of "am" ?
 34948                                  	;je	short $P_T1201		;AN000; go process "a"
 34949                                  	;jmp	short $P_T12_Exit	;AN000; no special chars found
 34950                                  	; 05/04/2023
 34951 00005206 750B                    	jne	short $P_T12_Exit
 34952                                  
 34953                                  ;$P_T1200:				;AN000; "P" found
 34954                                  	;;or	byte [cs:$P_Flags2],$P_Time12
 34955                                  	;or	byte [cs:$P_Flags2],4	;AC034; flag "PM" found
 34956                                  	;jmp	short $P_Tclr_chr	;AN038; go clear the special char
 34957                                  
 34958                                  $P_T1201:				;AN000; "A" found
 34959                                  	;or	byte [cs:$P_Flags1],$P_Time12AM
 34960 00005208 2E800E[C597]01          	or	byte [cs:$P_Flags1],1	;AN038; flag "AM" found
 34961                                  $P_Tclr_chr:				;AN038;
 34962 0000520E 2EC644FE00              	mov	byte [cs:si-2],$P_NULL	;AN000; null out special char
 34963                                  $P_T12_Exit:				;AN000;
 34964 00005213 5E                      	pop	si			;AN000;
 34965 00005214 58                      	pop	ax			;AN000;
 34966 00005215 C3                      	retn				;AN000;
 34967                                  
 34968                                  	; 05/04/2023
 34969                                  $P_T1200:				;AN000; "P" found
 34970                                  	;or	byte [cs:$P_Flags2],$P_Time12
 34971 00005216 2E800E[C697]04          	or	byte [cs:$P_Flags2],4	;AC034; flag "PM" found
 34972 0000521C EBF0                    	jmp	short $P_Tclr_chr	;AN038; go clear the special char
 34973                                  
 34974                                  ;***********************************************************************
 34975                                  ; $P_File_Format;
 34976                                  ;
 34977                                  ; Function:  Check if the input string is valid file spec format.
 34978                                  ;	     And set the result buffer.
 34979                                  ;
 34980                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34981                                  ;	     ES:BX -> CONTROL block
 34982                                  ;
 34983                                  ; Output:    None
 34984                                  ;
 34985                                  ; Use:	$P_Fill_Result, $P_Chk_DBCS, $P_FileSp_Chk
 34986                                  ;
 34987                                  ; Vars: $P_RC(W), $P_SI_Save(W), $P_Terminator(W), $P_SaveSI_Cmpx(R)
 34988                                  ;	$P_SaveSI_Cmpx(R)
 34989                                  ;***********************************************************************
 34990                                  
 34991                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34992                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4DF0h
 34993                                  
 34994                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34995                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:55B4h
 34996                                  
 34997                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 34998                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:544Ah
 34999                                  $P_File_Format:
 35000 0000521E 50                      	push	ax			;AN000;
 35001 0000521F 57                      	push	di			;AN000;
 35002 00005220 56                      	push	si			;AN000;
 35003 00005221 2E8B3E[C797]            	mov	di,[cs:$P_SaveSI_Cmpx]	;AC034; get user buffer address
 35004 00005226 2E8A04                  	mov	al,[cs:si]		;AN000; load character
 35005 00005229 08C0                    	or	al,al			;AN000; end of line ?
 35006 0000522B 7413                    	je	short $P_FileF_Err	;AN000; if yes, error exit
 35007 0000522D E85D00                  	call	$P_FileSp_Chk		;AN000; else, check if file special character
 35008 00005230 7523                    	jne	short $P_FileF03	;AN000; if yes,
 35009 00005232 2EC606[9398]01          	mov	byte [cs:$P_err_flag],$P_error_filespec ; 1
 35010                                  					;AN033;AC034;; set error flag- bad char.
 35011 00005238 5E                      	pop	si			;AN033;
 35012 00005239 2EC60400                	mov	byte [cs:si],$P_NULL	;AN033;
 35013 0000523D 5F                      	pop	di			;AN033;
 35014 0000523E EB3E                    	jmp	short $P_FileF02	;AN033;
 35015                                  $P_FileF_Err:				;AN000;
 35016 00005240 5E                      	pop	si			;AN000;
 35017 00005241 2EC60400                	mov	byte [cs:si],$P_NULL	;AN000;
 35018 00005245 5F                      	pop	di			;AN000;
 35019                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Optional
 35020                                  	;test	word [es:bx],1		;AN000; is it optional ?
 35021 00005246 26F60701                	test	byte [es:bx],$P_Optional ; 1
 35022 0000524A 7532                    	jnz	short $P_FileF02	;AN000;
 35023 0000524C 2EC706[BA97]0200        	mov	word [cs:$P_RC],$P_Op_Missing
 35024                                  	;mov	word [cs:$P_RC],2	;AC034; 3/17/87
 35025 00005253 EB29                    	jmp	short $P_FileF02	;AN000;
 35026                                  $P_FileF03:				;AN000;
 35027 00005255 58                      	pop	ax			;AN000; discard save si
 35028 00005256 56                      	push	si			;AN000; save new si
 35029                                  $P_FileF_Loop1: 			;AN000;
 35030 00005257 2E8A04                  	mov	al,[cs:si]		;AN000; load character (not special char)
 35031 0000525A 08C0                    	or	al,al			;AN000; end of line ?
 35032 0000525C 741E                    	jz	short $P_FileF_RLT	;AN000;
 35033 0000525E E82C00                  	call	$P_FileSp_Chk		;AN000; File special character ?
 35034 00005261 740B                    	jz	short $P_FileF00	;AN000;
 35035 00005263 E85C01                  	call	$P_Chk_DBCS		;AN000; no, then DBCS ?
 35036 00005266 7302                    	jnc	short $P_FileF01	;AN000;
 35037 00005268 47                      	inc	di			;AN000; if yes, skip next byte
 35038 00005269 46                      	inc	si			;AN000;
 35039                                  $P_FileF01:				;AN000;
 35040 0000526A 47                      	inc	di			;AN000;
 35041 0000526B 46                      	inc	si			;AN000;
 35042 0000526C EBE9                    	jmp	short $P_FileF_Loop1	;AN000;
 35043                                  $P_FileF00:				;AN000;
 35044 0000526E 2EA2[C097]              	mov	[cs:$P_Terminator],al	;AC034;
 35045 00005272 2EC60400                	mov	byte [cs:si],$P_NULL	;AN000; update end of string
 35046 00005276 47                      	inc	di			;AN000;
 35047 00005277 2E893E[BC97]            	mov	[cs:$P_SI_Save],di	;AC034; update next pointer in command line
 35048                                  $P_FileF_RLT:				;AN000;
 35049 0000527C 5E                      	pop	si			;AN000;
 35050 0000527D 5F                      	pop	di			;AN000;
 35051                                  $P_FileF02:				;AN000;
 35052 0000527E 58                      	pop	ax			;AN000; (tm14)
 35053                                  	;;test	ax,200h
 35054                                  	;test	ax,$P_File_Spc		;AN000; (tm14)
 35055                                  	; 05/04/2023
 35056 0000527F F6C402                  	test	ah,($P_File_Spc>>8)
 35057 00005282 7408                    	jz	short $P_Drv_Only_Exit	;AN000; (tm14)
 35058 00005284 50                      	push	ax			;AN000; (tm14)
 35059                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 35060                                  	;mov	al,$P_File_Spec ; 5 	;AN000;    result
 35061                                  	; 05/04/2023
 35062 00005285 B805FF                  	mov	ax,($P_No_Tag<<8)+$P_File_Spec
 35063 00005288 E81FF9                  	call	$P_Fill_Result		;AN000; 	buffer to file spec
 35064 0000528B 58                      	pop	ax			;AN000;
 35065                                  $P_Drv_Only_Exit:			;AN000; (tm14)
 35066 0000528C C3                      	retn				;AN000;
 35067                                  
 35068                                  ;***********************************************************************
 35069                                  ; $P_FileSp_Chk
 35070                                  ;
 35071                                  ; Function:  Check if the input byte is one of file special characters
 35072                                  ;
 35073                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 35074                                  ;	     AL = character code to be examineed
 35075                                  ;
 35076                                  ; Output:    ZF = 1 , AL is one of special characters
 35077                                  ;***********************************************************************
 35078                                  
 35079                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35080                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35081                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35082                                  $P_FileSp_Chk:
 35083 0000528D 53                      	push	bx			;AN000;
 35084 0000528E 51                      	push	cx			;AN000;
 35085                                  	;lea	bx,[cs:$P_FileSp_Char]	;AC034; special character table
 35086 0000528F 8D1E[8A98]              	lea	bx,$P_FileSp_Char ; '[]|<>+=;"'
 35087 00005293 B90900                  	mov	cx,$P_FileSp_Len ; 9
 35088                                  	;mov	cx,9			;AN000; load length of it
 35089                                  $P_FileSp_Loop: 			;AN000;
 35090 00005296 2E3A07                  	cmp	al,[cs:bx]		;AN000; is it one of special character ?
 35091 00005299 7404                    	je	short $P_FileSp_Exit	;AN000;
 35092 0000529B 43                      	inc	bx			;AN000;
 35093 0000529C E2F8                    	loop	$P_FileSp_Loop		;AN000;
 35094 0000529E 41                      	inc	cx			;AN000; reset ZF
 35095                                  $P_FileSp_Exit: 			;AN000;
 35096 0000529F 59                      	pop	cx			;AN000;
 35097 000052A0 5B                      	pop	bx			;AN000;
 35098 000052A1 C3                      	retn				;AN000;
 35099                                  
 35100                                  ;***********************************************************************
 35101                                  ; $P_Drive_Format;
 35102                                  ;
 35103                                  ; Function:  Check if the input string is valid drive only format.
 35104                                  ;	     And set the result buffer.
 35105                                  ;
 35106                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 35107                                  ;	     ES:BX -> CONTROL block
 35108                                  ;
 35109                                  ; Output:    None
 35110                                  ;
 35111                                  ; Use:	$P_Fill_Result, $P_Chk_DBCS
 35112                                  ;
 35113                                  ; Vars: $P_RC(W)
 35114                                  ;***********************************************************************
 35115                                  
 35116                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35117                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35118                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35119                                  $P_Drive_Format:
 35120 000052A2 50                      	push	ax			;AN000;
 35121 000052A3 52                      	push	dx			;AN000;
 35122 000052A4 2E8A04                  	mov	al,[cs:si]		;AN000;
 35123 000052A7 08C0                    	or	al,al			;AN000; if null string
 35124 000052A9 7436                    	jz	short $P_Drv_Exit	;AN000; do nothing
 35125 000052AB E81401                  	call	$P_Chk_DBCS		;AN000; is it leading byte ?
 35126 000052AE 722A                    	jc	short $P_Drv_Err	;AN000;
 35127                                  	;cmp	word [cs:si+1],3Ah ; $P_Colon  ; ':'
 35128 000052B0 2E837C013A              	cmp	word [cs:si+1],$P_Colon ;AN000; "d", ":", 0  ?
 35129 000052B5 740D                    	je	short $P_DrvF00		;AN000;
 35130                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Ig_Colon
 35131                                  	;test	word [es:bx],10h	;AN000; colon can be ignored?
 35132 000052B7 26F60710                	test	byte [es:bx],$P_Ig_Colon ; 10h
 35133 000052BB 741D                    	jz	short $P_Drv_Err	;AN000;
 35134 000052BD 2E807C0100              	cmp	byte [cs:si+1],$P_NULL	;AN000; "d", 0  ?
 35135 000052C2 7516                    	jne	short $P_Drv_Err	;AN000;
 35136                                  $P_DrvF00:				;AN000;
 35137 000052C4 0C20                    	or	al,$P_Make_Lower ; 20h	;AN000; lower case
 35138 000052C6 3C61                    	cmp	al,"a" ; 61h            ;AN000; drive letter must
 35139 000052C8 7210                    	jb	short $P_Drv_Err	;AN000; in range of
 35140 000052CA 3C7A                    	cmp	al,"z" ; 7Ah            ;AN000; "a" - "z"
 35141 000052CC 770C                    	ja	short $P_Drv_Err	;AN000; if no, error
 35142 000052CE 2C60                    	sub	al,"a"-1  ; 60h         ;AN000; make text drive to binary drive
 35143 000052D0 88C2                    	mov	dl,al			;AN000; set
 35144                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000;    result
 35145                                  	;mov	al,$P_Drive ; 6		;AN000; 	 buffer
 35146                                  	; 05/04/2023
 35147 000052D2 B806FF                  	mov	ax,($P_No_Tag<<8)+$P_Drive ; 06FFh
 35148 000052D5 E8D2F8                  	call	$P_Fill_Result		;AN000; 	       to drive
 35149 000052D8 EB07                    	jmp	short $P_Drv_Exit	;AN000;
 35150                                  $P_Drv_Err:				;AN000;
 35151 000052DA 2EC706[BA97]0900        	mov	word [cs:$P_RC],$P_Syntax
 35152                                  	;mov	word [cs:$P_RC],9	;AC034;
 35153                                  $P_Drv_Exit:				;AN000;
 35154 000052E1 5A                      	pop	dx			;AN000;
 35155 000052E2 58                      	pop	ax			;AN000;
 35156 000052E3 C3                      	retn				;AN000;
 35157                                  
 35158                                  ;***********************************************************************
 35159                                  ; $P_Skip_Delim;
 35160                                  ;
 35161                                  ; Function: Skip delimiters specified in the PARMS list, white space
 35162                                  ;	    and comma.
 35163                                  ;
 35164                                  ; Input:    DS:SI -> Command String
 35165                                  ;	    ES:DI -> Parameter List
 35166                                  ;
 35167                                  ; Output:   CY = 1 if the end of line encounterd
 35168                                  ;	    CY = 0 then SI move to 1st non-delimiter character
 35169                                  ;	    AL = Last examineed character
 35170                                  ;
 35171                                  ; Use:	    $P_Chk_EOL, $P_Chk_Delim,
 35172                                  ;
 35173                                  ; Vars:     $P_Flags(R)
 35174                                  ;***********************************************************************
 35175                                  
 35176                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35177                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35178                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35179                                  $P_Skip_Delim:				;AN000;
 35180                                  $P_Skip_Delim_Loop:			;AN000;
 35181 000052E4 AC                      	lodsb				;AN000;
 35182 000052E5 E81E00                  	call	$P_Chk_EOL		;AN000; is it EOL character ?
 35183 000052E8 7416                    	je	short $P_Skip_Delim_CY	;AN000; if yes, exit w/ CY on
 35184                                  
 35185 000052EA E84B00                  	call	$P_Chk_Delim		;AN000; is it one of delimiters ?
 35186 000052ED 7514                    	jne	short $P_Skip_Delim_NCY	;AN000; if no, exit w/ CY off
 35187                                  
 35188 000052EF 2EF606[C697]20          	test	byte [cs:$P_Flags2],$P_Extra
 35189                                  	;test	byte [cs:$P_Flags2],20h ;AC034; extra delim or comma found ?
 35190 000052F5 74ED                    	jz	short $P_Skip_Delim_Loop
 35191                                  					;AN000; if no, loop
 35192 000052F7 2EF606[C697]41          	test	byte [cs:$P_Flags2],$P_SW+$P_equ
 35193                                  	;;test	byte [cs:$P_Flags2],41h	;AC034; /x , or xxx=zzz , (tm08)
 35194                                  	;jz	short $P_Exit_At_Extra	;AN000; no switch, no keyword (tm08)
 35195                                  	;dec	si ; *			;AN000; backup si for next call (tm08)
 35196                                  	;;jmp	short $P_Exit_At_Extra	;AN000; else exit w/ CY off
 35197                                  	; 05/04/2023
 35198 000052FD 7505                    	jnz	short $P_Skip_Delim_Exit ; cf = 0
 35199                                  $P_Exit_At_Extra:			;AN000;
 35200                                  	; cf = 0
 35201                                  	;clc				;AN000; indicate extra delim
 35202 000052FF C3                      	retn				;AN000;
 35203                                  
 35204                                  $P_Skip_Delim_CY:			;AN000;
 35205 00005300 F9                      	stc				;AN000; indicate EOL
 35206 00005301 EB01                    	jmp	short $P_Skip_Delim_Exit
 35207                                  					;AN000;
 35208                                  $P_Skip_Delim_NCY:			;AN000;
 35209 00005303 F8                      	clc				;AN000; indicate non delim
 35210                                  $P_Skip_Delim_Exit:			;AN000; in this case, need
 35211 00005304 4E                      	dec	si ; *			;AN000;  backup index pointer
 35212 00005305 C3                      	retn				;AN000;
 35213                                  	; 05/04/2023
 35214                                  ;$P_Exit_At_Extra:			;AN000;
 35215                                  	;clc				;AN000; indicate extra delim
 35216                                  	;retn				;AN000;
 35217                                  
 35218                                  ;***********************************************************************
 35219                                  ; $P_Chk_EOL;
 35220                                  ;
 35221                                  ; Function: Check if AL is one of End of Line characters.
 35222                                  ;
 35223                                  ; Input:    AL = character code
 35224                                  ;	    ES:DI -> Parameter List
 35225                                  ;
 35226                                  ; Output:   ZF = 1 if one of End of Line characters
 35227                                  ;***********************************************************************
 35228                                  
 35229                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35230                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35231                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35232                                  $P_Chk_EOL:
 35233 00005306 53                      	push	bx			;AN000;
 35234 00005307 51                      	push	cx			;AN000;
 35235 00005308 3C0D                    	cmp	al,$P_CR ; 0Dh		;AN000; Carriage return ?
 35236 0000530A 7429                    	je	short $P_Chk_EOL_Exit 	;AN000;
 35237 0000530C 3C00                    	cmp	al,$P_NULL ; 0		;AN000; zero ?
 35238 0000530E 7425                    	je	short $P_Chk_EOL_Exit 	;AN000;
 35239 00005310 26807D0202              	cmp	byte [es:di+$P_PARMS_BLK.$P_Num_Extra],$P_I_Have_EOL
 35240                                  	;cmp	byte [es:di+2],2	;AN000; EOL character specified ?
 35241 00005315 721E                    	jb	short $P_Chk_EOL_Exit 	;AN000;
 35242 00005317 31DB                    	xor	bx,bx			;AN000;
 35243 00005319 268A5D03                	mov	bl,[es:di+$P_PARMS_BLK.$P_Len_Extra_Delim]
 35244                                  	;mov	bl,[es:di+3]		;AN000; get length of delimiter list
 35245 0000531D 83C304                  	add	bx,$P_Len_PARMS; 4 	;AN000; skip it
 35246 00005320 26803900                	cmp	byte [es:bx+di],$P_I_Use_Default
 35247                                  	;cmp	byte [es:bx+di],0	;AN000; No extra EOL character ?
 35248 00005324 740D                    	je	short $P_Chk_EOL_NZ	;AN000;
 35249 00005326 31C9                    	xor	cx,cx			;AN000; Get number of extra chcracter
 35250 00005328 268A09                  	mov	cl,[es:bx+di]		;AN000;
 35251                                  $P_Chk_EOL_Loop:			;AN000;
 35252 0000532B 43                      	inc	bx			;AN000;
 35253 0000532C 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra EOL character
 35254 0000532F 7404                    	je	short $P_Chk_EOL_Exit 	;AN000;
 35255 00005331 E2F8                    	loop	$P_Chk_EOL_Loop 	;AN000;
 35256                                  $P_Chk_EOL_NZ:				;AN000;
 35257 00005333 3C0D                    	cmp	al,$P_CR ; 0Dh		;AN000; reset ZF
 35258                                  $P_Chk_EOL_Exit:			;AN000;
 35259 00005335 59                      	pop	cx			;AN000;
 35260 00005336 5B                      	pop	bx			;AN000;
 35261 00005337 C3                      	retn				;AN000;
 35262                                  
 35263                                  ;***********************************************************************
 35264                                  ; $P_Chk_Delim;
 35265                                  ;
 35266                                  ; Function: Check if AL is one of delimiter characters.
 35267                                  ;	    if AL+[si] is DBCS blank, it is replaced with two SBCS
 35268                                  ;	    blanks.
 35269                                  ;
 35270                                  ; Input:    AL = character code
 35271                                  ;	    DS:SI -> Next Character
 35272                                  ;	    ES:DI -> Parameter List
 35273                                  ;
 35274                                  ; Output:   ZF = 1 if one of delimiter characters
 35275                                  ;	    SI points to the next character
 35276                                  ; Vars:  $P_Terminator(W), $P_Flags(W)
 35277                                  ;***********************************************************************
 35278                                  
 35279                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35280                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35281                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35282                                  $P_Chk_Delim:
 35283 00005338 53                      	push	bx			;AN000;
 35284 00005339 51                      	push	cx			;AN000;
 35285 0000533A 2EC606[C097]20          	mov	byte [cs:$P_Terminator],$P_Space ; 20h
 35286                                  					;AC034; Assume terminated by space
 35287 00005340 2E8026[C697]DF          	and	byte [cs:$P_Flags2],0FFh-$P_Extra ; 0DFh
 35288                                  					;AC034;
 35289 00005346 3C20                    	cmp	al,$P_Space ; 20h ; ' '	;AN000; Space ?
 35290 00005348 7434                    	je	short $P_Chk_Delim_Exit	;AN000;
 35291                                  
 35292 0000534A 3C09                    	cmp	al,$P_TAB ; 09h		;AN000; TAB ?
 35293 0000534C 7430                    	je	short $P_Chk_Delim_Exit	;AN000;
 35294                                  
 35295 0000534E 3C2C                    	cmp	al,$P_Comma  ; ',' 	;AN000; Comma ?
 35296 00005350 742F                    	je	short $P_Chk_Delim_Exit0
 35297                                  					;AN000;
 35298                                  $P_Chk_Delim00: 			;AN000;
 35299 00005352 3C20                    	cmp	al,20h ; $P_DBSP1	;AN000; 1st byte of DBCS Space ?
 35300 00005354 750C                    	jne	short $P_Chk_Delim01	;AN000;
 35301 00005356 803C20                  	cmp	byte [si],20h ; $P_DBSP2
 35302                                  					;AN000; 2nd byte of DBCS Space ?
 35303 00005359 7507                    	jne	short $P_Chk_Delim01	;AN000;
 35304 0000535B B020                    	mov	al,$P_Space ; 20h	;AN000;
 35305 0000535D 46                      	inc	si			;AN000; make si point to next character
 35306 0000535E 38C0                    	cmp	al,al			;AN000; Set ZF
 35307 00005360 EB1C                    	jmp	short $P_Chk_Delim_Exit ;AN000;
 35308                                  
 35309                                  $P_Chk_Delim01: 			;AN000;
 35310                                  	;cmp	byte [es:di+$P_PARMS_BLK.$P_Num_Extra],$P_I_Have_Delim
 35311 00005362 26807D0201              	cmp	byte [es:di+$P_PARMS_BLK.$P_Num_Extra],1
 35312                                  	;cmp	byte [es:di+2],1	;AN000; delimiter character specified ?
 35313 00005367 7215                    	jb	short $P_Chk_Delim_Exit	;AN000;
 35314                                  
 35315 00005369 31C9                    	xor	cx,cx			;AN000;
 35316 0000536B 268A4D03                	mov	cl,[es:di+$P_PARMS_BLK.$P_Len_Extra_Delim]
 35317                                  	;mov	cl,[esi:di+3]		;AN000; get length of delimiter list
 35318                                  	;or	cx,cx			;AN000; No extra Delim character ?
 35319                                  	;jz	short $P_Chk_Delim_NZ	;AN000;
 35320                                  	; 12/08/2024 - PCDOS 7.1 COMMAND.COM
 35321 0000536F E30B                    	jcxz	$P_Chk_Delim_NZ
 35322                                  
 35323 00005371 BB0300                  	mov	bx,$P_Len_PARMS-1 ; 3	;AN000; set bx to 1st extra delimiter
 35324                                  $P_Chk_Delim_Loop:			;AN000;
 35325 00005374 43                      	inc	bx			;AN000;
 35326 00005375 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra Delim character
 35327 00005378 7407                    	je	short $P_Chk_Delim_Exit0
 35328                                  					;AN000;
 35329 0000537A E2F8                    	loop	$P_Chk_Delim_Loop	;AN000; examine all extra delimiter
 35330                                  
 35331                                  $P_Chk_Delim_NZ:			;AN000;
 35332 0000537C 3C20                    	cmp	al,$P_Space ; 20h	;AN000; reset ZF
 35333                                  $P_Chk_Delim_Exit:			;AN000;
 35334 0000537E 59                      	pop	cx			;AN000;
 35335 0000537F 5B                      	pop	bx			;AN000;
 35336 00005380 C3                      	retn				;AN000;
 35337                                  
 35338                                  $P_Chk_Delim_Exit0:			;AN000;
 35339 00005381 2EA2[C097]              	mov	[cs:$P_Terminator],al	;AC034; keep terminated delimiter
 35340 00005385 2EF606[C697]01          	test	byte [cs:$P_Flags2],$P_equ
 35341                                  	;test	byte [cs:$P_Flags2],1	;AN027;AC034;; if terminating a key=
 35342 0000538B 7506                    	jnz	short $P_No_Set_Extra 	;AN027; then do not set the EXTRA bit
 35343                                  
 35344 0000538D 2E800E[C697]20          	or	byte [cs:$P_Flags2],$P_Extra ; 20h
 35345                                  	;or	byte [cs:$P_Flags2],20h	;AC034; flag terminated extra delimiter or comma
 35346                                  $P_No_Set_Extra:			;AN027;
 35347 00005393 38C0                    	cmp	al,al			;AN000; set ZF
 35348 00005395 EBE7                    	jmp	short $P_Chk_Delim_Exit ;AN000;
 35349                                  
 35350                                  ;***********************************************************************
 35351                                  ; $P_Chk_Switch;
 35352                                  ;
 35353                                  ; Function: Check if AL is the switch character not in first position of
 35354                                  ;	    $P_STRING_BUF
 35355                                  ;
 35356                                  ; Input:    AL = character code
 35357                                  ;	    BX = current pointer within $P_String_Buf
 35358                                  ;	    SI =>next char on command line (following the one in AL)
 35359                                  ;
 35360                                  ; Output:   CF = 1 (set)if AL is switch character, and not in first
 35361                                  ;		 position, and has no chance of being part of a date string,
 35362                                  ;		 i.e. should be treated as a delimiter.
 35363                                  ;
 35364                                  ;	    CF = 0 (reset, cleared) if AL is not a switch char, is in the first
 35365                                  ;		 position, or is a slash but may be part of a date string, i.e.
 35366                                  ;		 should not be treated as a delimiter.
 35367                                  ;
 35368                                  ; Vars:  $P_Terminator(W)
 35369                                  ;
 35370                                  ; Use:	 $P_0099
 35371                                  ;***********************************************************************
 35372                                  
 35373                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35374                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35375                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35376                                  $P_Chk_Switch:
 35377                                  	; 18/04/2023
 35378 00005397 8D2E[CF97]              	lea	bp,$P_STRING_BUF	;AN020;AC034; BP=OFFSET of $P_String_Buf even in group addressing
 35379                                  
 35380 0000539B 39EB                    	cmp	bx,bp			;AN000;
 35381 0000539D 7418                    	je	short $P_STRUC_L2	;AN000;
 35382                                  
 35383 0000539F 3C2F                    	cmp     al,$P_Switch ; '/'	;AN000;
 35384 000053A1 7512                    	jne	short $P_STRUC_L5	;AN000;
 35385                                  
 35386 000053A3 F9                      	stc				;AN020;not in first position and is slash, now see if might be in date string
 35387 000053A4 50                      	push	ax			;AN020;save input char
 35388 000053A5 2E8A47FF                	mov	al,[cs:bx-1]		;AN026;AL=char before the current char
 35389 000053A9 E8FBFA                  	call	$P_0099 		;AN020;return carry set if not numeric
 35390 000053AC 7205                    	jc	short $P_STRUC_L7	;AN000;
 35391                                  
 35392 000053AE 8A04                    	mov	al,[si]			;AN020;AL=char after the current char
 35393 000053B0 E8F4FA                  	call	$P_0099			;AN020;return carry set if not numeric
 35394                                  $P_STRUC_L7:				;AN000;
 35395 000053B3 58                      	pop	ax			;AN020;restore AL to input char
 35396                                  	;jmp	short $P_STRUC_L1	;AN000;
 35397                                  	; 18/04/2023
 35398 000053B4 C3                      	retn
 35399                                  
 35400                                  $P_STRUC_L5:				;AN000;
 35401 000053B5 F8                      	clc				;AN020;not a slash
 35402                                  	;jmp	short $P_STRUC_L1	;AN000;
 35403                                  	 ;18/04/2023
 35404 000053B6 C3                      	retn
 35405                                  
 35406                                  $P_STRUC_L2:				;AN000;
 35407 000053B7 3C2F                    	cmp     al,$P_Switch ; '/'	;AN000;
 35408                                  	;jne	short $P_STRUC_L12	;AN000;
 35409                                  	; 18/04/2023
 35410 000053B9 75FA                    	jne	short $P_STRUC_L5
 35411                                  
 35412 000053BB 2E800E[C697]40          	or	byte [cs:$P_Flags2],$P_SW
 35413                                  	;or	byte [cs:$P_Flags2],40h	;AN020;AC034;;could be valid switch, first char and is slash
 35414                                  	; 18/04/2023
 35415                                  ;$P_STRUC_L12:				;AN000;
 35416                                  	;clc				;AN020;CF=0 indicating first char
 35417                                  $P_STRUC_L1:				;AN000;
 35418 000053C1 C3                      	retn				;AN000;
 35419                                  
 35420                                  ;**************************************************************************
 35421                                  ; $P_Chk_DBCS:
 35422                                  ;
 35423                                  ;  Function: Check if a specified byte is in ranges of the DBCS lead bytes
 35424                                  ;
 35425                                  ;  Input:
 35426                                  ;	  AL	= Code to be examineed
 35427                                  ;
 35428                                  ;  Output:
 35429                                  ;	  If CF is on then a lead byte of DBCS
 35430                                  ;
 35431                                  ; Use: INT 21h w/AH=63
 35432                                  ;
 35433                                  ; Vars:  $P_DBCSEV_Seg(RW), $P_DBCSEV_Off(RW)
 35434                                  ;***************************************************************************
 35435                                  
 35436                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35437                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35438                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35439                                  $P_Chk_DBCS:
 35440 000053C2 1E                      	push	ds			;AN000;
 35441 000053C3 56                      	push	si			;AN000;
 35442 000053C4 53                      	push	bx			;AN000; (tm11)
 35443 000053C5 2E833E[C397]00          	cmp	word [cs:$P_DBCSEV_SEG],0
 35444                                  					;AC034; ALREADY SET ?
 35445 000053CB 7527                    	jne	short $P_DBCS00		;AN000;
 35446 000053CD 50                      	push	ax			;AN000;
 35447 000053CE 1E                      	push	ds			;AN000; (tm11)
 35448 000053CF 51                      	push	cx			;AN000;
 35449 000053D0 52                      	push	dx			;AN000;
 35450 000053D1 57                      	push	di			;AN000;
 35451 000053D2 55                      	push	bp			;AN000;
 35452 000053D3 06                      	push	es			;AN000;
 35453 000053D4 31F6                    	xor	si,si			;AN000;
 35454 000053D6 8EDE                    	mov	ds,si			;AN000;
 35455                                  	;mov	ax,$P_DOS_GetEV 	;AN000; GET DBCS EV CALL
 35456 000053D8 B80063                  	mov	ax,6300h
 35457 000053DB CD21                    	int	21h			;AN000;
 35458 000053DD 8CDB                    	mov	bx,ds			;AN000; (tm11)
 35459 000053DF 09DB                    	or	bx,bx			;AN000; (tm11)
 35460 000053E1 07                      	pop	es			;AN000;
 35461 000053E2 5D                      	pop	bp			;AN000;
 35462 000053E3 5F                      	pop	di			;AN000;
 35463 000053E4 5A                      	pop	dx			;AN000;
 35464 000053E5 59                      	pop	cx			;AN000;
 35465 000053E6 1F                      	pop	ds			;AN000; (tm11)
 35466 000053E7 58                      	pop	ax			;AN000;
 35467 000053E8 7424                    	jz	short $P_NON_DBCS	;AN000;
 35468                                  $P_DBCS02:				;AN000;
 35469 000053EA 2E8936[C197]            	mov	[cs:$P_DBCSEV_OFF],si	;AC034; save EV offset
 35470 000053EF 2E891E[C397]            	mov	[cs:$P_DBCSEV_SEG],bx	;AC034; save EV segment (tm11)
 35471                                  $P_DBCS00:				;AN000;
 35472                                  	;mov	si,[cs:$P_DBCSEV_OFF]	;AC034; load EV offset
 35473                                  	;mov	ds,[cs:$P_DBCSEV_SEG]	;AC034; and segment
 35474                                  	; 12/08/2024 - PCDOS 7.1 COMMAND.COM
 35475 000053F4 2EC536[C197]            	lds	si,[cs:$P_DBCSEV_OFF]
 35476                                  $P_DBCS_LOOP:				;AN000;
 35477 000053F9 833C00                  	cmp	word [si],0 		;AN000; zero vector ?
 35478 000053FC 7410                    	je	short $P_NON_DBCS	;AN000; then exit
 35479 000053FE 3A04                    	cmp	al,[si] 		;AN000;
 35480 00005400 7208                    	jb	short $P_DBCS01		;AN000; Check if AL is in
 35481 00005402 3A4401                  	cmp	al,[si+1]		;AN000;   range of
 35482 00005405 7703                    	ja	short $P_DBCS01		;AN000;      the vector
 35483 00005407 F9                      	stc				;AN000; if yes, indicate DBCS and exit
 35484 00005408 EB04                    	jmp	short $P_DBCS_EXIT	;AN000;
 35485                                  $P_DBCS01:				;AN000;
 35486 0000540A 46                      	inc	si			;AC035; add '2' to
 35487 0000540B 46                      	inc	si			;AC035;  SI reg
 35488                                  					;AN000; get next vector
 35489 0000540C EBEB                    	jmp	short $P_DBCS_LOOP	;AN000; loop until zero vector found
 35490                                  
 35491                                  $P_NON_DBCS:				;AN000;
 35492                                  	; 18/04/2023
 35493                                  	; cf=0
 35494                                  	;clc				;AN000; indicate SBCS
 35495                                  $P_DBCS_EXIT:				;AN000;
 35496 0000540E 5B                      	pop	bx			;AN000; (tm11)
 35497 0000540F 5E                      	pop	si			;AN000;
 35498 00005410 1F                      	pop	ds			;AN000;
 35499 00005411 C3                      	retn				;AN000;
 35500                                  
 35501                                  ;============================================================================
 35502                                  ; TPARSE.ASM, MSDOS 6.0, 1991
 35503                                  ;============================================================================
 35504                                  ; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35505                                  
 35506                                  ; ****************************************************************
 35507                                  ; *
 35508                                  ; * ROUTINE:	 CMD_PARSE
 35509                                  ; *
 35510                                  ; * FUNCTION:	 Interface for transient COMMAND to invoke
 35511                                  ; *		 SYSPARSE.
 35512                                  ; *
 35513                                  ; * INPUT:	 inputs to SYSPARSE
 35514                                  ; *
 35515                                  ; * OUTPUT:	 outputs from SYSPARSE
 35516                                  ; *
 35517                                  ; ****************************************************************
 35518                                  
 35519                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35520                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4FF7h
 35521                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35522                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:57BBh
 35523                                  
 35524                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35525                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5647h
 35526                                  ;cmd_parse:
 35527                                  	;call	sysparse		;AN000;
 35528                                  	;retn				;AN000;
 35529                                  	; 06/04/2023
 35530                                  	;jmp	sysparse
 35531                                  
 35532                                  append_parse:
 35533 00005412 E857F5                  	call	sysparse		;AN010;
 35534 00005415 CB                      	retf				;AN010;
 35535                                  
 35536                                  ;============================================================================
 35537                                  ; TPRINTF.ASM, MSDOS 6.0, 1991
 35538                                  ;============================================================================
 35539                                  ; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35540                                  ; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35541                                  ; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35542                                  
 35543                                  ; ----------------------------
 35544                                  ; MSDOS 6.0, MSGSERV.ASM, 1991
 35545                                  ; ----------------------------
 35546                                  
 35547                                  ;; Replacable parameters are described by a sublist structure
 35548                                  
 35549                                  struc $M_SUBLIST_STRUC		;;AN000;;
 35550 00000000 ??                       .$M_S_SIZE:	resb 1		;;AN000;; SUBLIST size (PTR to next SUBLIST)
 35551 00000001 ??                       .$M_S_RESV:	resb 1		;;AN000;; RESERVED
 35552 00000002 ????????                 .$M_S_VALUE:	resd 1 		;;AN000;; Time, Date or PTR to data item
 35553 00000006 ??                       .$M_S_ID:	resb 1		;;AN000;; n of %n
 35554 00000007 ??                       .$M_S_FLAG:	resb 1		;;AN000;; Data-type flags
 35555 00000008 ??                       .$M_S_MAXW:	resb 1		;;AN000;; Maximum field width
 35556 00000009 ??                       .$M_S_MINW:	resb 1		;;AN000;; Minimum field width
 35557 0000000A ??                       .$M_S_PAD:	resb 1		;;AN000;; Character for Pad field
 35558                                  endstruc
 35559                                  
 35560                                  ; ---------------------------------------------------------------------------
 35561                                  ; ---------------------------------------------------------------------------
 35562                                  
 35563                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35564                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 4FFFh
 35565                                  
 35566                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35567                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 57C3h
 35568                                  
 35569                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35570                                  	; PCDOS 7.1 COMMAND.COM (2003) Transient portion offset 564Fh
 35571                                  
 35572                                  Printf_Init:
 35573 00005416 E80F00                  	call	std_printf
 35574 00005419 CB                      	retf
 35575                                  
 35576                                  Printf_Crlf:
 35577 0000541A E80B00                  	call	std_printf
 35578                                  	;call	CRLF2
 35579                                  	;retn
 35580                                  	; 07/04/2023
 35581 0000541D E959D5                  	jmp	CRLF2
 35582                                  
 35583                                  ;****************************************************************
 35584                                  ;*
 35585                                  ;* ROUTINE:	STD_PRINTF/STD_EPRINTF
 35586                                  ;*
 35587                                  ;* FUNCTION:	Set up to print out a message using SYSDISPMSG.
 35588                                  ;*		Set up substitutions if utility message.  Make
 35589                                  ;*		sure any changes to message variables in TDATA
 35590                                  ;*		are reset to avoid reloading the transient.
 35591                                  ;*
 35592                                  ;* INPUT:	Msg_Disp_Class	-  set to message class
 35593                                  ;*		Msg_Cont_Flag	-  set to control flags
 35594                                  ;*		DS	points to transient segment
 35595                                  ;*
 35596                                  ;*		if utility message:
 35597                                  ;*		DX	points to a block with message number
 35598                                  ;*			(word), number of substitutions (byte),
 35599                                  ;*			followed by substitution list if there
 35600                                  ;*			are substitutions.  If substitutions
 35601                                  ;*			are not in transient segment they must
 35602                                  ;*			be set.
 35603                                  ;*		else
 35604                                  ;*		AX	set to message number
 35605                                  ;*
 35606                                  ;* OUTPUT:	none
 35607                                  ;*
 35608                                  ;****************************************************************
 35609                                  
 35610                                  std_eprintf:
 35611 00005420 C706[2199]0200          	mov	word [PRINTF_HANDLE],2 		;AC000;Print to STDERR
 35612 00005426 EB06                    	jmp	short new_printf		;AC000;
 35613                                  
 35614                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35615                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 5012h
 35616                                  
 35617                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35618                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 57D6h
 35619                                  
 35620                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35621                                  	; PCDOS 7.1 COMMAND.COM (2003) Transient portion offset 5662h
 35622                                  
 35623                                  std_printf:
 35624 00005428 C706[2199]0100          	mov	word [PRINTF_HANDLE],1 		;AC000;Print to STDOUT
 35625                                  
 35626                                  new_printf:
 35627 0000542E 50                      	push	ax				;AN000;save registers
 35628 0000542F 53                      	push	bx				;AN000;
 35629 00005430 51                      	push	cx				;AN000;
 35630 00005431 06                      	push	es				;AN000;get local ES
 35631 00005432 1E                      	push	ds				;AN000;
 35632 00005433 07                      	pop	es				;AN000;
 35633 00005434 57                      	push	di				;AN000;
 35634 00005435 56                      	push	si				;AN000;
 35635 00005436 52                      	push	dx				;AN000;
 35636                                  
 35637                                  	; 07/04/2023
 35638                                  	;mov	word [print_err_flag],0		;AN000;
 35639 00005437 31C9                    	xor	cx,cx
 35640 00005439 890E[379F]              	mov	[print_err_flag],cx ; 0
 35641                                  
 35642 0000543D 89D6                    	mov	si,dx				;AN000;Get offset of message number
 35643 0000543F AD                      	lodsw					;AN000;load message number
 35644                                  	; 15/06/2023
 35645                                  	;push	ax				;AN000;save it
 35646                                  	;lodsb					;AN000;get number of substitutions
 35647                                  	;mov	cl,al				;AN000;set up CX as # of subst
 35648                                  	;; 07/04/2023
 35649                                  	;;xor	ch,ch				;AN000;SI now points to subst list
 35650                                  	;pop	ax				;AN000;get message number back
 35651                                  	; 15/06/2023
 35652 00005440 8A0C                    	mov	cl,[si]
 35653 00005442 46                      	inc	si
 35654                                  
 35655                                  	;cmp	cx,0				;AN000;Any substitutions?
 35656                                  	; 07/04/2023
 35657                                  	;and	cx,cx
 35658                                  	;jz	short ready_to_print		;AN000;No - continue
 35659                                  	; 12/08/2024
 35660 00005443 E35C                    	jcxz	ready_to_print
 35661                                  
 35662 00005445 BF[399F]                	mov	di,subst_buffer			;AN061; Get address of message subst buffer
 35663 00005448 57                      	push	di				;AN061; save it
 35664 00005449 51                      	push	cx				;AN061; save number of subst
 35665                                  
 35666                                  move_subst:
 35667 0000544A 51                      	push	cx				;AN061;save number of subst
 35668 0000544B 89F3                    	mov	bx,si				;AN061;save start of sublist
 35669                                  	;mov	cx,parm_block_size ; 11		;AN061;get size of sublist
 35670                                  	; 07/04/2023
 35671 0000544D B10B                    	mov	cl,parm_block_size ; 11
 35672 0000544F F3A4                    	rep	movsb				;AN061;move sublist
 35673                                  	;test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],date_type
 35674 00005451 F6470704                	test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],4
 35675                                  	;test	byte [bx+7],4			;AN061;are we doing date/time?
 35676 00005455 7406                    	jz	short move_subst_cont 		;AN061;no - no need to reset
 35677                                  	;mov	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE],0
 35678                                  	;mov	word [bx+2],0			;AN061;reset original date or time to 0
 35679 00005457 894F02                  	mov	[bx+$M_SUBLIST_STRUC.$M_S_VALUE],cx ; 0
 35680                                  	;mov	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],0
 35681                                  	;mov	word [bx+4],0			;AN061;
 35682 0000545A 894F04                  	mov	[bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],cx ; 0
 35683                                  
 35684                                  move_subst_cont:				;AN061;
 35685 0000545D 59                      	pop	cx				;AN061;get number of subst back
 35686 0000545E E2EA                    	loop	move_subst			;AN061;move cx sublists
 35687                                  
 35688 00005460 59                      	pop	cx				;AN061;get number of subst
 35689 00005461 50                      	push	ax				;AN061;save message number
 35690 00005462 803E[D58F]FF            	cmp	byte [msg_disp_class],util_msg_class
 35691                                  	;cmp	byte [msg_disp_class],0FFh	;AN061;Is this a utility message
 35692 00005467 740C                    	je	short check_fix			;AN061;YES - go see if substitutions
 35693                                  	;mov	byte [msg_flag],1 ; ext_msg_class
 35694 00005469 C606[339F]01            	mov	byte [msg_flag],ext_msg_class	;AN061;set message flag
 35695 0000546E BF[D78F]                	mov	di,extend_buf_ptr		;AN061; Get address of extended message block
 35696 00005471 31C0                    	xor	ax,ax				;AN061;clear ax register
 35697 00005473 AB                      	stosw					;AN061;clear out message number
 35698 00005474 AA                      	stosb					;AN061;clear out subst count
 35699                                  
 35700                                  check_fix:					;AN061;
 35701 00005475 58                      	pop	ax				;AN061;get message number back
 35702 00005476 5F                      	pop	di				;AN061;get start of sublists
 35703 00005477 89FE                    	mov	si,di				;AN061;get into SI for msgserv
 35704 00005479 89F3                    	mov	bx,si				;AN061;get into BX for addressing
 35705 0000547B 51                      	push	cx				;AN061;save number of subst
 35706                                  
 35707                                  set_subst:					;AN061;store the segment of the subst
 35708 0000547C 837F0400                	cmp	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],0
 35709                                  	;cmp	word [bx+4],0			;AN061;was it set already?
 35710 00005480 7509                    	jnz	short subst_seg_set		;AN061;if not 0, don't replace it
 35711 00005482 F6470704                	test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],4
 35712                                  	;test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],date_type
 35713                                  	;test	byte [bx+7],4			;AN061;don't replace if date or time
 35714 00005486 7503                    	jnz	short subst_seg_set		;AN061;yes - skip it
 35715 00005488 8C4F04                  	mov	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],cs
 35716                                  	;mov	word [bx+4],cs			;AN061;set segment value
 35717                                  
 35718                                  subst_seg_set:					;AN061;
 35719 0000548B 83C30B                  	add	bx,parm_block_size ; add bx,11	;AN061;go to next sublist
 35720 0000548E E2EC                    	loop	set_subst			;AN061;loop CX times
 35721 00005490 59                      	pop	cx				;AN061;get number of subst back
 35722                                  
 35723 00005491 89F3                    	mov	bx,si				;AN061;get start of sublist to BX
 35724 00005493 817F02[A09D]            	cmp	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE],string_ptr_2
 35725                                  	;cmp	word [bx+2],string_ptr_2	;AN061;are we using double indirection?
 35726 00005498 7507                    	jne	short ready_to_print		;AN061;no - we already have address
 35727                                  	; 01/05/2023
 35728 0000549A 8B16[A09D]              	mov	dx,[string_ptr_2] 		;AN061;get address in string_ptr_2
 35729 0000549E 895702                  	mov	[bx+$M_SUBLIST_STRUC.$M_S_VALUE],dx
 35730                                  						;AN061;put it into the subst block
 35731                                  	;mov	[bx+2],dx
 35732                                  
 35733                                  ready_to_print:
 35734 000054A1 8B1E[2199]              	mov	bx,[PRINTF_HANDLE]		;AN000;get print handle
 35735 000054A5 8A16[D68F]              	mov	dl,[msg_cont_flag]		;AN000;set up control flag
 35736 000054A9 8A36[D58F]              	mov	dh,[msg_disp_class]		;AN000;set up display class
 35737 000054AD C606[D68F]00            	mov	byte [msg_cont_flag],0 ; no_cont_flag
 35738                                  						;AN061;reset flags to avoid
 35739 000054B2 C606[D58F]FF            	mov	byte [msg_disp_class],util_msg_class
 35740                                  	;mov	byte [msg_disp_class],0FFh	;AN061; transient reload
 35741                                  
 35742 000054B7 1E                      	push	ds				;AN026;
 35743 000054B8 06                      	push	es				;AN026;
 35744                                  
 35745 000054B9 E83702                  	call	SYSDISPMSG			;AN000;call Rod
 35746                                  
 35747 000054BC 07                      	pop	es				;AN026; restore registers
 35748 000054BD 1F                      	pop	ds				;AN026;
 35749                                  
 35750 000054BE 7303                    	jnc	short print_success		;AN000; everything went okay
 35751 000054C0 A3[379F]                	mov	[print_err_flag],ax		;AN000;
 35752                                  
 35753                                  print_success:
 35754 000054C3 5A                      	pop	dx				;AN061;restore dx
 35755 000054C4 5E                      	pop	si				;AN000;restore registers
 35756 000054C5 5F                      	pop	di				;AN000;
 35757 000054C6 07                      	pop	es				;AN000;restore registers
 35758 000054C7 59                      	pop	cx				;AN000;
 35759 000054C8 5B                      	pop	bx				;AN000;
 35760 000054C9 58                      	pop	ax				;AN000;
 35761 000054CA 833E[379F]00            	cmp	word [print_err_flag],0		;AN000; if an error occurred - handle it
 35762 000054CF 7501                    	jnz	short print_err			;AN000;
 35763                                  
 35764 000054D1 C3                      	retn					;AC000;
 35765                                  
 35766                                  print_err:
 35767 000054D2 0E                      	push	cs
 35768 000054D3 07                      	pop	es
 35769 000054D4 833E[2199]02            	cmp	word [PRINTF_HANDLE],2 		;AN026;Print to STDERR?
 35770 000054D9 7503                    	jne	short not_stderr		;AN026;no - continue
 35771 000054DB E926AC                  	jmp	TCOMMAND			;AN026;Yes - hopless - just exit
 35772                                  
 35773                                  not_stderr:
 35774 000054DE A1[379F]                	mov	ax,[print_err_flag]		;AN026;get extended error number back
 35775 000054E1 8E06[F59B]              	mov	es,[RESSEG]			; No, set up for error, load the
 35776                                  						;  right error msg, and jmp to cerror.
 35777 000054E5 26F606[1303]FF          	test	byte [es:PipeFlag],-1 ; 0FFh
 35778 000054EB 7408                    	jz	short _go_to_error
 35779 000054ED E8B7DE                  	call	PipeOff
 35780 000054F0 BA[5D91]                	mov	dx,PIPEEMES_PTR
 35781 000054F3 EB0B                    	jmp	short print_err_exit		;AC000;
 35782                                  
 35783                                  _go_to_error:
 35784 000054F5 C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class
 35785                                  	;mov	byte [msg_disp_class],1		;AN000; set up extended error msg class
 35786 000054FA BA[D78F]                	mov	dx,extend_buf_ptr		;AC000; get extended message pointer
 35787 000054FD A3[D78F]                	mov	[extend_buf_ptr],ax		;AN000; get message number in control block
 35788                                  
 35789                                  print_err_exit: 				;AC000;
 35790 00005500 0E                      	push	cs
 35791 00005501 07                      	pop	es
 35792 00005502 E921D8                  	jmp	cerror
 35793                                  
 35794                                  ;****************************************************************
 35795                                  ;*
 35796                                  ;* ROUTINE:	TSYSLOADMSG
 35797                                  ;*
 35798                                  ;* FUNCTION:	Interface to call SYSLOADMSG to avoid duplicate
 35799                                  ;*		names since these routines are also used in the
 35800                                  ;*		resident.
 35801                                  ;*
 35802                                  ;* INPUT:	Inputs to SYSLOADMSG
 35803                                  ;*
 35804                                  ;* OUTPUT:	Outputs from SYSLOADMSG
 35805                                  ;*
 35806                                  ;****************************************************************
 35807                                  
 35808                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35809                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35810                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35811                                  TSYSLOADMSG:
 35812 00005505 53                      	push	bx				;AN000;
 35813 00005506 E80800                  	call	SYSLOADMSG			;AN000; call routine
 35814 00005509 5B                      	pop	bx				;AN000;
 35815 0000550A C3                      	retn					;AN000; exit
 35816                                  
 35817                                  ;****************************************************************
 35818                                  ;*
 35819                                  ;* ROUTINE:	TSYSGETMSG
 35820                                  ;*
 35821                                  ;* FUNCTION:	Interface to call SYSGETMSG to avoid duplicate
 35822                                  ;*		names since these routines are also used in the
 35823                                  ;*		resident.
 35824                                  ;*
 35825                                  ;* INPUT:	Inputs to SYSGETMSG
 35826                                  ;*
 35827                                  ;* OUTPUT:	Outputs from SYSGETMSG
 35828                                  ;*
 35829                                  ;****************************************************************
 35830                                  
 35831                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35832                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35833                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 35834                                  TSYSGETMSG:
 35835 0000550B 51                      	push	cx				;AN000;
 35836 0000550C E8B500                  	call	SYSGETMSG			;AN000; call routine
 35837 0000550F 59                      	pop	cx				;AN000;
 35838 00005510 C3                      	retn					;AN000; exit
 35839                                  
 35840                                  ;============================================================================
 35841                                  ; MSGSERV.ASM, MSDOS 6.0, 1991
 35842                                  ;============================================================================
 35843                                  ; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35844                                  ; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35845                                  
 35846                                  ; ---------------------------------------------------------------------------
 35847                                  ; MODULE NAME: MSGSERV.SAL
 35848                                  ;
 35849                                  ; DESCRIPTIVE NAME: Message Services SALUT file
 35850                                  ;
 35851                                  ; FUNCTION: This module incorporates all the messages services and
 35852                                  ;	    is called upon at build time to INCLUDE the code requested
 35853                                  ;	    by a utility. Code is requested using the macro MSG_SERVICES.
 35854                                  ;
 35855                                  ; ENTRY POINT: Since this a collection of subroutines, entry point is at
 35856                                  ;	    requested procedure.
 35857                                  ;
 35858                                  ; INPUT: Since this a collection of subroutines, input is dependent on
 35859                                  ;	    function requested.
 35860                                  ;
 35861                                  ; EXIT-NORMAL: In all cases, CARRY FLAG = 0
 35862                                  ;
 35863                                  ; EXIT-ERROR: In all cases, CARRY FLAG = 1
 35864                                  ;
 35865                                  ; INTERNAL REFERENCES: (list of included subroutines)
 35866                                  ;
 35867                                  ;	- SYSLOADMSG
 35868                                  ;	- SYSDISPMSG
 35869                                  ;	- SYSGETMSG
 35870                                  ;
 35871                                  ; EXTERNAL REFERENCES: None
 35872                                  ;
 35873                                  ; NOTES: At build time, some modules must be included. These are only included
 35874                                  ;	 once using assembler switches. Other logic is included at the request
 35875                                  ;	 of the utility.
 35876                                  ;
 35877                                  ;	 COMR and COMT are assembler switches to conditionally assemble code
 35878                                  ;	 for RESIDENT COMMAND.COM and TRANSIENT COMMAND.COM to reduce resident
 35879                                  ;	 storage and multiple EQUates.
 35880                                  ;
 35881                                  ; REVISION HISTORY: Created MAY 1987
 35882                                  ;
 35883                                  ;     Label: DOS - - Message Retriever
 35884                                  ;	     (c) Copyright 1988 Microsoft
 35885                                  ; ---------------------------------------------------------------------------
 35886                                  
 35887                                  ;	Revision History
 35888                                  ;	================
 35889                                  ;
 35890                                  ;	M007	SR	08/24/90	Fixed bug #1818 -- changed
 35891                                  ;				$M_DISPLAY_H_STRING to properly
 35892                                  ;				handle Ctrl-Z being passed
 35893                                  ;
 35894                                  ;	M013	SR	9/12/90	Make SETSTDIO flag false so that all
 35895                                  ;				these routines are no longer assembled.
 35896                                  ;
 35897                                  ;	M016	SR	10/14/90	Bug #3380. Changed SYSLOADMSG so that
 35898                                  ;				CR-LF string also gets reinitialized
 35899                                  ;				on every cycle.
 35900                                  ;
 35901                                  ;	M020	SR	10/26/90	Bug #3380 again. Initialize $M_DIVISOR
 35902                                  ;				& $_MSG_NUM also in SYSLOADMSG.
 35903                                  
 35904                                  ; ---------------------------------------------------------------------------
 35905                                  
 35906                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35907                                  
 35908                                  ;;; Replacable parameters are described by a sublist structure
 35909                                  ;
 35910                                  ;struc $M_SUBLIST_STRUC		;;AN000;;
 35911                                  ; .$M_S_SIZE:	resb 1		;;AN000;; SUBLIST size (PTR to next SUBLIST)
 35912                                  ; .$M_S_RESV:	resb 1		;;AN000;; RESERVED
 35913                                  ; .$M_S_VALUE:	resd 1 		;;AN000;; Time, Date or PTR to data item
 35914                                  ; .$M_S_ID:	resb 1		;;AN000;; n of %n
 35915                                  ; .$M_S_FLAG:	resb 1		;;AN000;; Data-type flags
 35916                                  ; .$M_S_MAXW:	resb 1		;;AN000;; Maximum field width
 35917                                  ; .$M_S_MINW:	resb 1		;;AN000;; Minimum field width
 35918                                  ; .$M_S_PAD:	resb 1		;;AN000;; Character for Pad field
 35919                                  ;endstruc
 35920                                  
 35921                                  ;; Each class will be defined by this structure.
 35922                                  
 35923                                  struc $M_CLASS_ID		;;AN000;;
 35924 00000000 ??                       .$M_CLS_ID:	  resb 1	;;AN000;; Class identifer
 35925 00000001 ????                     .$M_COMMAND_VER: resw 1	;;AN003;; COMMAND.COM version check
 35926 00000003 ??                       .$M_NUM_CLS_MSG: resb 1	;;AN000;; Total number of message in class
 35927                                   .size:
 35928                                  endstruc
 35929                                  
 35930                                  $M_CLASS_ID_SZ	EQU $M_CLASS_ID.size	;;AN000;;
 35931                                  
 35932                                  ;; Each message will be defined by this structure.
 35933                                  
 35934                                  struc $M_ID			;;AN000;;
 35935 00000000 ????                     .$M_NUM:	resw 1		;;AN000;; Message Number
 35936 00000002 ????                     .$M_TXT_PTR:	resw 1		;;AN000;; Pointer to message text
 35937                                   .size:	
 35938                                  endstruc
 35939                                  
 35940                                  $M_ID_SZ	EQU  $M_ID.size	;;AN000;;
 35941                                  
 35942                                  ; ---------------------------
 35943                                  ; MSDOS 6.0, SYSMSG.INC, 1991
 35944                                  ; ---------------------------
 35945                                  $M_TEMP_BUF_SZ	EQU 64     ;; Size of temporary buffer	 ;AN003;
 35946                                  
 35947                                  ; --------------------------- 
 35948                                  
 35949                                  ; 07/04/2023
 35950                                  $M_NUM_CLS equ 3
 35951                                  
 35952                                  ;; Resident data area definition of variables
 35953                                  
 35954                                  struc $M_RES_ADDRS			;;AN000;;
 35955 00000000 ????????                 .$M_EXT_ERR_ADDRS: resd 1		;;AN000;; Allow pointers to THREE Extended error locations
 35956 00000004 ????????                 .$M_EXT_FILE:	    resd 1		;;AN001;;
 35957 00000008 ????????                 .$M_EXT_COMMAND:   resd 1		;;AN000;;
 35958 0000000C ????????                 .$M_EXT_TERM:	    resd 1		;;AN000;;
 35959 00000010 ????????                 .$M_PARSE_COMMAND: resd 1		;;AN000;;
 35960 00000014 ????????                 .$M_PARSE_ADDRS:   resd 1		;;AN000;; Allow pointers to TWO Parse error locations
 35961 00000018 ????????                 .$M_PARSE_TERM:    resd 1		;;AN000;;
 35962 0000001C ????????                 .$M_CRIT_ADDRS:    resd 1		;;AN000;; Allow pointers to TWO Critical error locations
 35963 00000020 ????????                 .$M_CRIT_COMMAND:  resd 1		;;AN000;;
 35964 00000024 ????????                 .$M_CRIT_TERM:	    resd 1		;;AN000;;
 35965 00000028 ????????                 .$M_DISK_PROC_ADDR: resd 1		;;AN004;; Address of READ_DISK_PROC
 35966 0000002C <res Ch>                 .$M_CLASS_ADDRS:   resd $M_NUM_CLS ; 3	;;AN000;; Allow pointers to specified classes
 35967 00000038 ????????                 .$M_CLS_TERM:	    resd 1		;;AN000;;
 35968 0000003C ????????                 .$M_DBCS_VEC:	    resd 1		;;AN000;; Save DBCS vector
 35969 00000040 ????                     .$M_HANDLE:	    resw 1 		;;AN000;;
 35970 00000042 ??                       .$M_SIZE:	    resb 1		;;AN000;;
 35971 00000043 ????                     .$M_CRLF:	    resb 2  		;;AN004;; CR LF message
 35972 00000045 ??                       .$M_CLASS:	    resb 1		;;AN004;; Saved class
 35973 00000046 ????                     .$M_RETURN_ADDR:   resw 1		;;AN000;;
 35974 00000048 ????                     .$M_MSG_NUM:	    resw 1		;;AN000;;
 35975 0000004A ????                     .$M_DIVISOR:	    resw 1		;;AN000;; Default = 10 (must be a WORD for division)
 35976 0000004C <res 40h>                .$M_TEMP_BUF:	    resb $M_TEMP_BUF_SZ	;;AN000;; Temporary buffer
 35977 0000008C ??                       .$M_BUF_TERM:	    resb 1		;;AN000;;
 35978                                   .size:
 35979                                  endstruc				;;AN000;;
 35980                                  
 35981                                  $M_RES_ADDRS_SZ	EQU $M_RES_ADDRS.size	;;AN000;;
 35982                                  
 35983                                  ;; Important fields of the Get Country Information call
 35984                                  
 35985                                  struc $M_COUNTRY_INFO			;;AN000;; Expected Country infomation
 35986 00000000 <res 4Ch>                .$M_HEADER:	    resb $M_RES_ADDRS_SZ-$M_TEMP_BUF_SZ-1
 35987                                  					;;AN000;; Go past first part of struc
 35988 0000004C ????                     .$M_DATE_FORMAT:   resw 1		;;AN000;; <------- Date Format
 35989 0000004E ??????????               .$M_CURR_SEPARA:   resb 5		;;AN000;;
 35990 00000053 ????                     .$M_THOU_SEPARA:   resb 2		;;AN000;; <------- Thou Separator
 35991 00000055 ????                     .$M_DECI_SEPARA:   resb 2		;;AN000;; <------- Decimal Separator
 35992 00000057 ????                     .$M_DATE_SEPARA:   resb 2		;;AN000;; <------- Date Separator
 35993 00000059 ????                     .$M_TIME_SEPARA:   resb 2		;;AN000;; <------- Time Separator
 35994 0000005B ??                       .$M_CURR_FORMAT:   resb 1		;;AN000;;
 35995 0000005C ??                       .$M_SIG_DIGS_CU:   resb 1		;;AN000;;
 35996 0000005D ??                       .$M_TIME_FORMAT:   resb 1		;;AN000;; <------- Time Format
 35997                                  endstruc				;;AN000;;
 35998                                  
 35999                                  ; ---------------------------------------------------------------------------
 36000                                  
 36001                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36002                                  ;;
 36003                                  ;;	PROC NAME: SYSLOADMSG
 36004                                  ;;
 36005                                  ;;	FUNCTION:
 36006                                  ;;	INPUTS:
 36007                                  ;;
 36008                                  ;;	OUTPUTS:
 36009                                  ;;
 36010                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36011                                  
 36012                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36013                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5107h
 36014                                  
 36015                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36016                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:58CBh
 36017                                  
 36018                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36019                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5757h
 36020                                  SYSLOADMSG:
 36021 00005511 50                      	push	ax				;;AN000;
 36022 00005512 53                      	push	bx				;;AN000;
 36023 00005513 52                      	push	dx				;;AN000;
 36024 00005514 06                      	push	es				;;AN000;
 36025 00005515 57                      	push	di				;;AN000;
 36026 00005516 31C9                    	xor	cx,cx				;;AN000;  Reset to zero
 36027 00005518 8EC1                    	mov	es,cx				;;AN000;
 36028 0000551A 31FF                    	xor	di,di				;;AN000;
 36029 0000551C B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN000;; 2FH Interface
 36030 0000551F B200                    	mov	dl,0 ; DOS_GET_EXTENDED		;;AN000;; Where are the Extended errors in COMMAND.COM
 36031 00005521 CD2F                    	int	2Fh				;;AN000;; Private interface
 36032                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 36033                                  		; DL = subfunction - get standard DOS error table (errors 00h-12h,50h-5Bh)
 36034                                  		; Return: ES:DI -> error table
 36035                                  	
 36036 00005523 8C06[9E98]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_COMMAND+2],es
 36037                                  	;mov	[$M_RT+10],es			;;AN000;; Move into first avaliable table location
 36038 00005527 893E[9C98]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_COMMAND],di
 36039                                  	;mov	[$M_RT+8],di			;;AN000;;
 36040                                  
 36041 0000552B B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN000;; 2FH Interface
 36042 0000552E B202                    	mov	dl,2 ; DOS_GET_PARSE		;;AN000;; Where are the Parse errors in COMMAND.COM
 36043 00005530 CD2F                    	int	2Fh				;;AN000;; Private interface
 36044                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 36045                                  		; DL = subfunction - get critical/SHARE error table (errors 13h-2Bh)
 36046                                  		; ES:DI -> error table
 36047                                  
 36048 00005532 8C06[A698]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_COMMAND+2],es
 36049                                  	;mov	[$M_RT+18],es			;;AN000;; Move into first avaliable table location
 36050 00005536 893E[A498]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_COMMAND],di
 36051                                  	;mov	[$M_RT+16],di			;;AN000;;
 36052                                  
 36053 0000553A B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN000;; 2FH Interface
 36054 0000553D B204                    	mov	dl,4 ; DOS_GET_CRITICAL		;;AN000;; Where are the Critical errors in COMMAND.COM
 36055 0000553F CD2F                    	int	2Fh				;;AN000;; Private interface
 36056                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 36057                                  		; DL = subfunction - get ??? error table
 36058                                  		; ES:DI -> error table
 36059                                  
 36060 00005541 8C06[B698]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_COMMAND+2],es
 36061                                  	;mov	[$M_RT+34],es			;;AN000;; Move into first avaliable table location
 36062 00005545 893E[B498]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_COMMAND],di
 36063                                  	;mov	[$M_RT+32],di			;;AN000;;
 36064                                  
 36065 00005549 B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN001;; 2FH Interface
 36066 0000554C B206                    	mov	dl,6 ; DOS_GET_FILE		;;AN001;; Where are the FILE dependant in IFSFUNC.EXE
 36067 0000554E CD2F                    	int	2Fh					     ;;AN001;; Private interface
 36068                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 36069                                  		; DL = subfunction - get ??? error table
 36070                                  		; ES:DI -> error table
 36071                                  
 36072 00005550 8C06[9A98]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_FILE+2],es
 36073                                  	;mov	[$M_RT+6],es			;;AN001;; Move into first avaliable table location
 36074 00005554 893E[9898]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_FILE],di
 36075                                  	;mov	[$M_RT+4],di			;;AN001;;
 36076                                  
 36077 00005558 E8553A                  	call	$M_MSGSERV_1			;;AN000;; Get addressibility to MSGSERV CLASS 1 (EXTENDED Errors)
 36078                                  						;;AN000;;
 36079 0000555B 8C06[9698]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_ERR_ADDRS+2],es
 36080                                  	;mov	[$M_RT+2],es			;;AN000;; Move into first avaliable table location
 36081 0000555F 893E[9498]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_ERR_ADDRS],di
 36082                                  	;mov	[$M_RT+0],di			;;AN000;;
 36083 00005563 8C06[B298]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_ADDRS+2],es
 36084                                  	;mov	[$M_RT+30],es			;;AN000;; Move into first avaliable table location
 36085 00005567 893E[B098]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_ADDRS],di
 36086                                  	;mov	[$M_RT+28],di			;;AN000;;
 36087                                  
 36088 0000556B E8603A                  	call	$M_MSGSERV_2			;;AN000;; Get addressibility to MSGSERV CLASS 2 (PARSE Errors)
 36089                                  
 36090 0000556E 8C06[AA98]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_ADDRS+2],es
 36091                                  	;mov	[$M_RT+22],es			;;AN000;; Move into first avaliable table location
 36092 00005572 893E[A898]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_ADDRS],di
 36093                                  	;mov	[$M_RT+20],di			;;AN000;;
 36094                                  
 36095 00005576 B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN001;; 2FH Interface
 36096 00005579 B208                    	mov	dl,8 ; DOS_GET_ADDR 		;;AN001;; Where is the READ_DISK_PROC in COMMAND.COM
 36097 0000557B CD2F                    	int	2Fh				;;AN001;; Private interface
 36098                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 36099                                  		; DL = subfunction - get ??? error table
 36100                                  		; ES:DI -> error table
 36101                                  
 36102 0000557D 8C06[BE98]              	mov	[$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR+2],es
 36103                                  	;mov	[$M_RT+42],es			;;AN001;; Move into first avaliable table location
 36104 00005581 893E[BC98]              	mov	[$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR],di
 36105                                  	;mov	[$M_RT+40],di			;;AN001;;
 36106                                  
 36107                                  ;M016; M020
 36108                                  ; Reinitialize the CR-LF string. Also, reinit the buffer terminator just to
 36109                                  ;be safe. Initialize $M_MSG_NUM and $M_DIVISOR also.
 36110                                  
 36111 00005585 C706[D798]0D0A          	mov	word [$M_RT+$M_RES_ADDRS.$M_CRLF],0A0Dh
 36112                                  	;mov	word [$M_RT+67],0A0Dh		; Reinit CR-LF ;M016
 36113 0000558B C606[2099]24            	mov	byte [$M_RT+$M_RES_ADDRS.$M_BUF_TERM],'$'
 36114                                  	;mov	word [$M_RT+140],'$'		; Reinit buffer end;M016
 36115 00005590 C706[DC98]0000          	mov	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 36116                                  	;mov	word [$M_RT+72],0		; M020
 36117 00005596 C706[DE98]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 36118                                  	;mov	word [$M_RT+74],10		; M020
 36119                                  
 36120                                  	; 07/04/2023 - Retro DOS v4.0 COMMAND.COM
 36121                                  	; --------------------------
 36122                                  	; MSDOS 6.0 SYSMSG.INC, 1991
 36123                                  	; --------------------------
 36124                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP5192h
 36125                                  
 36126                                  	;$M_BUILD_PTRS %$M_NUM_CLS     		;;AN000;; Build all utility classes
 36127 0000559C E8AE39                  	call    $M_CLS_3			; Get addressibility to class F
 36128 0000559F 893E[C098]              	mov	[$M_RT+$M_RES_ADDRS.$M_CLASS_ADDRS],di
 36129                                  	;mov	[$M_RT+44],di
 36130                                  	
 36131 000055A3 E80600                  	CALL	$M_GET_DBCS_VEC 		;;AN000;; Save the DBCS vector
 36132                                  
 36133                                  	; 15/04/2023
 36134                                  	;clc					;;AN000;; Make sure carry is clear
 36135                                  	;jc	short $MIF20
 36136                                  	
 36137 000055A6 5F                      	pop	di				;;AN000;; Restore REGS
 36138 000055A7 07                      	pop	es				;;AN000;;
 36139 000055A8 5A                      	pop	dx				;;AN000;;
 36140 000055A9 5B                      	pop	bx				;;AN000;;
 36141 000055AA 58                      	pop	ax				;;AN000;;
 36142                                  	;jmp	short $MEN20
 36143                                  	; 15/04/2023
 36144 000055AB C3                      	retn
 36145                                  
 36146                                  	; 15/04/2023
 36147                                  ;$MIF20:
 36148                                  	;add	sp,10				;;AN000;;
 36149                                  	;stc					;;AN000;; Reset carry flag
 36150                                  ;$MEN20:
 36151                                  	;retn					;;AN000;;
 36152                                  
 36153                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36154                                  ;;
 36155                                  ;;  Proc Name:	$M_GET_DBCS_VEC
 36156                                  ;;
 36157                                  ;;  Function:	Get the DBCS vector and save it for later use
 36158                                  ;;
 36159                                  ;;  Inputs:	None
 36160                                  ;;
 36161                                  ;;  Outputs:	None
 36162                                  ;;
 36163                                  ;;  Regs Changed:
 36164                                  ;;
 36165                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36166                                  
 36167                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36168                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36169                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36170                                  $M_GET_DBCS_VEC:
 36171 000055AC 50                      	push	ax				;;AN000;; Save character to check
 36172 000055AD 56                      	push	si				;;AN000;;
 36173 000055AE 1E                      	push	ds				;;AN000;;
 36174 000055AF B80063                  	mov	ax,6300h ;DOS_GET_DBCS_INFO	;;AN000;; DOS function to get DBSC environment
 36175 000055B2 CD21                    	int	21h				;;AN000;; Get environment pointer
 36176 000055B4 1E                      	push	ds				;;AN000;; Get environment pointer
 36177 000055B5 07                      	pop	es				;;AN000;; Get environment pointer
 36178 000055B6 1F                      	pop	ds				;;AN000;; Get environment pointer
 36179 000055B7 7208                    	jc	short $MIF23
 36180                                  	
 36181 000055B9 8936[D098]              	mov	word [$M_RT+$M_RES_ADDRS.$M_DBCS_VEC],si
 36182                                  	;mov	word [$M_RT+60],si		;;AN000;; Save DBCS Vector
 36183 000055BD 8C06[D298]              	mov	word [$M_RT+$M_RES_ADDRS.$M_DBCS_VEC+2],es
 36184                                  	;mov	word [$M_RT+62],es		;;AN000;;
 36185                                  $MIF23:
 36186 000055C1 5E                      	pop	si				;;AN000;;
 36187 000055C2 58                      	pop	ax				;;AN000;; Retrieve character to check
 36188 000055C3 C3                      	retn					;;AN000;; Return
 36189                                  
 36190                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36191                                  ;;
 36192                                  ;;  Proc Name:	SYSGETMSG
 36193                                  ;;
 36194                                  ;;  Function:	The GET service returns the segment, offset and size of the
 36195                                  ;;		message text to the caller based on a message number.
 36196                                  ;;		The GET function will not display the message thus assumes
 36197                                  ;;		caller will handle replaceable parameters.
 36198                                  ;;
 36199                                  ;;  Inputs:
 36200                                  ;;
 36201                                  ;;  Outputs:
 36202                                  ;;
 36203                                  ;;  Psuedocode:
 36204                                  ;;		Call $M_GET_MSG_ADDRESS
 36205                                  ;;		IF MSG_NUM exists THEN
 36206                                  ;;		   Set DS:SI = MSG_TXT_PTR + 1
 36207                                  ;;		   CARRY_FLAG = 0
 36208                                  ;;		ELSE
 36209                                  ;;		   CARRY_FLAG = 1
 36210                                  ;;		ENDIF
 36211                                  ;;
 36212                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36213                                  
 36214                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36215                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36216                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36217                                  
 36218                                  	utility_msg_class equ 0FFh ; 18/04/2023
 36219                                  
 36220                                  SYSGETMSG:
 36221                                  	;; Save registers needed later
 36222 000055C4 50                      	push	ax				;;AN000;; Save changed regs
 36223 000055C5 06                      	push	es				;;AN000;;
 36224 000055C6 57                      	push	di				;;AN000;;
 36225 000055C7 55                      	push	bp				;;AN000;;
 36226                                  
 36227 000055C8 E81400                  	call	$M_GET_MSG_ADDRESS		;;AN000;; Scan thru classes to find message
 36228 000055CB 720D                    	jc	short $MIF31
 36229                                  	
 36230 000055CD 80FEFF                  	cmp	dh,utility_msg_class ; 0FFh	;;AN000;; Were utility messages requested?
 36231                                  	;clc					;;AN000;;
 36232 000055D0 7404                    	je	short $MIF32			;;AN000;;
 36233                                  	; 15/06/2023
 36234 000055D2 F8                      	clc	
 36235                                  
 36236 000055D3 06                      	push	es				;;AN000;;
 36237                                  	;pop	ds				;;AN000;;
 36238 000055D4 EB01                    	jmp	short $MEN32
 36239                                  $MIF32:
 36240 000055D6 0E                      	push	cs				;;AN000;;
 36241                                  	;pop	ds				;;AN000;;
 36242                                  $MEN32:
 36243                                  	; 07/04/2023
 36244 000055D7 1F                      	pop	ds
 36245 000055D8 89FE                    	mov	si,di				;;AN000;; Return message in DS:SI
 36246                                  $MIF31:
 36247 000055DA 5D                      	pop	bp				;;AN000;; Restore changed regs
 36248 000055DB 5F                      	pop	di				;;AN000;;
 36249 000055DC 07                      	pop	es				;;AN000;;
 36250 000055DD 58                      	pop	ax				;;AN000;;
 36251 000055DE C3                      	retn					;;AN000;; Return
 36252                                  
 36253                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36254                                  ;;
 36255                                  ;;	PROC NAME: $M_GET_MSG_ADDRESS
 36256                                  ;;
 36257                                  ;;	FUNCTION:  To scan thru classes to return pointer to the message header
 36258                                  ;;	INPUTS:    Access to $M_RES_ADDRESSES
 36259                                  ;;	OUTPUTS:   IF CX = 0 THEN Message was not found
 36260                                  ;;		   IF CX > 1 THEN ES:DI points to the specified message
 36261                                  ;;	REGS CHANGED: ES,DI,CX
 36262                                  ;;
 36263                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36264                                  
 36265                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36266                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36267                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36268                                  $M_GET_MSG_ADDRESS:
 36269 000055DF 56                      	push	si				;;AN000;;
 36270 000055E0 53                      	push	bx				;;AN000;;
 36271 000055E1 31F6                    	xor	si,si				;;AN000;; Use SI as an index
 36272 000055E3 31C9                    	xor	cx,cx				;;AN000;; Use CX as an size
 36273                                  $MDO36:
 36274 000055E5 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN000;; Were utility messages requested?
 36275 000055E8 7508                    	jne	short $MIF37			;;AN000;; No
 36276                                  
 36277                                  	; 07/04/2023
 36278                                  	;;mov	di,[si+89CAh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 36279 000055EA 8BBC[C098]              	mov	di,[si+$M_RT+$M_RES_ADDRS.$M_CLASS_ADDRS]
 36280                                  	;mov	di,[si+$M_RT+44]		;;AN000;; Get address of class
 36281 000055EE 89FB                    	mov	bx,di				;;AN000;;
 36282 000055F0 EB21                    	jmp	short $MEN37
 36283                                  $MIF37:
 36284 000055F2 F6C602                  	test	dh,2 ; parse_err_class		;;AN000;; Were parse errors requested?
 36285 000055F5 7406                    	jz	short $MIF39
 36286                                  	
 36287                                  	; 07/04/2023
 36288                                  	;;les	di,[si+89AEh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 36289 000055F7 C4BC[A498]              	les	di,[si+$M_RT+$M_RES_ADDRS.$M_PARSE_COMMAND]
 36290                                  	;les	di,[si+$M_RT+16]		;;AN000;; Get address of class
 36291                                  
 36292                                  	; 07/04/2023
 36293                                  	;mov	bx,es ; *			;;AN000;;
 36294 000055FB EB14                    	jmp	short $MEN39
 36295                                  $MIF39:
 36296 000055FD 83F813                  	cmp	ax,19 ; $M_CRIT_LO		;;AN000;; Is this a critical error?
 36297 00005600 720B                    	jnae	short $MIF41  ; jb short $MIF41 ;;AN000;;
 36298                                  
 36299 00005602 83F827                  	cmp	ax,39 ; $M_CRIT_HI		;;AN000;;
 36300 00005605 7706                    	jnbe	short $MIF41  ; ja short $MIF41 ;;AN000;;
 36301                                  
 36302                                  	; 07/04/2023
 36303                                  	;;les	di,[si+89BAh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 36304 00005607 C4BC[B098]              	les	di,[si+$M_RT+$M_RES_ADDRS.$M_CRIT_ADDRS]
 36305                                  	;les	di,[si+$M_RT+28]		;;AN000;; Get address of class
 36306                                  	
 36307                                  	; 07/04/2023
 36308                                  	;mov	bx,es ; *			;;AN000;;
 36309 0000560B EB04                    	jmp	short $MEN41
 36310                                  $MIF41:
 36311                                  	; 07/04/2023
 36312                                  	;;les	di,[si+899Eh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 36313 0000560D C4BC[9498]              	les	di,[si+$M_RT+$M_RES_ADDRS.$M_EXT_ERR_ADDRS]
 36314                                  	;les	di,[si+$M_RT+0]			;;AN000;; Get address of class
 36315                                  	
 36316                                  	; 07/04/2023
 36317                                  	;mov	bx,es ; *			;;AN000;;
 36318                                  $MEN41:
 36319                                  $MEN39:
 36320                                  	; 07/04/2023
 36321 00005611 8CC3                    	mov	bx,es ; *
 36322                                  $MEN37:						;;AN000;;
 36323 00005613 83FBFF                  	cmp	bx,-1 ; $M_TERMINATING_FLAG	;;AN000;; Are we finished all classes?
 36324 00005616 7515                    	jne	short $MIF46			;;AN000;; No
 36325                                  
 36326 00005618 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN000;; Was it a UTILITY class?
 36327 0000561B 7503                    	jne	short $MIF47			;;AN000;; No
 36328 0000561D F9                      	stc		     ; **-		;;AN000;; Set the carry flag
 36329                                  	; 07/04/2023
 36330                                  	;jmp	short $MEN47 ; **-
 36331 0000561E EB1B                    	jmp	short $MEN36 ; **-
 36332                                  $MIF47:
 36333 00005620 A3[DC98]                	mov	[$M_RT+$M_RES_ADDRS.$M_MSG_NUM],ax
 36334                                  	;mov	[$M_RT+72],ax			;;AN000;; Save message number
 36335 00005623 B8FFFF                  	mov	ax,0FFFFh ; $M_SPECIAL_MSG_NUM	;;AN000;; Set special message number
 36336 00005626 BD0100                  	mov	bp,1 ; $M_ONE_REPLACE		;;AN000;; Set one replace in message
 36337 00005629 31F6                    	xor	si,si				;;AN000;; Reset the SI index to start again
 36338                                  	; 28/04/2023
 36339                                  	; 07/04/2023
 36340                                  	;clc	; **+				;;AN000;;
 36341                                  ;$MEN47:
 36342                                  	;jmp	short $MEN46 ; ***
 36343 0000562B EB0A                    	jmp	short $MEN47 ; ***
 36344                                  $MIF46:
 36345                                  	;cmp	bx,0 ; $M_CLASS_NOT_EXIST	;;AN000;; Does this class exist?
 36346 0000562D 21DB                    	and	bx,bx ; 0 ?
 36347 0000562F 7403                    	jz	short $MIF51			;;AN000;; No
 36348                                  	
 36349 00005631 E84D00                  	call	$M_FIND_SPECIFIED_MSG		;;AN000;; Try to find the message
 36350                                  $MIF51:
 36351 00005634 83C604                  	add	si,4 ; $M_ADDR_SZ_FAR 		;;AN000;; Get next class
 36352                                  	; 07/04/2023
 36353                                  	;clc					;;AN000;;
 36354                                  ;$MEN46:
 36355                                  	;jc	short $MEN36 ; **- ; **+	;;AN000;;
 36356                                  $MEN47:	; 07/04/2023	; **+
 36357 00005637 09C9                    	or	cx,cx				;;AN000;; Was the message found?
 36358                                  	;jnz	short $MXL2			;;AN000;; Yes
 36359                                  	;jmp	short $MDO36
 36360                                  	; 07/04/2023
 36361 00005639 74AA                    	jz	short $MDO36	
 36362                                  $MXL2:
 36363                                  $MEN36:
 36364 0000563B 9C                      	pushf 					;;AN006;; Save the flag state
 36365                                  	
 36366 0000563C 80FE01                  	cmp	dh,1 ; EXT_ERR_CLASS		;;AN006;; Was an extended error requested?
 36367                                  	;jne	short $MIF56			;;AN006;; No
 36368                                  	; 28/04/2023
 36369 0000563F 752A                    	jne	short $M_MYRET	
 36370                                  
 36371 00005641 52                      	push	dx				;;AN006;; Save all needed registers
 36372 00005642 55                      	push	bp				;;AN006;;
 36373 00005643 51                      	push	cx				;;AN006;;
 36374 00005644 06                      	push	es				;;AN006;;
 36375 00005645 57                      	push	di				;;AN006;;
 36376 00005646 50                      	push	ax				;;AN006;;
 36377                                  
 36378 00005647 B80005                  	mov	ax,500h ; IFSFUNC_INSTALL_CHECK	;;AN006;; Check if IFSFUNC is installed
 36379 0000564A CD2F                    	int	2Fh				;;AN006;;
 36380                                  		; Multiplex - DOS 3+ CRITICAL ERROR HANDLER - INSTALLATION CHECK
 36381                                  		; Return: AL = 00h not installed, OK to install
 36382                                  		; 01h not installed, can't install
 36383                                  		; FFh installed
 36384                                  
 36385 0000564C 3CFF                    	cmp	al,0FFh ; IFSFUNC_INSTALLED	;;AN006;; Is it installed?
 36386 0000564E 58                      	pop	ax				;;AN006;; Restore msg number
 36387 0000564F 7513                    	jne	short $MIF57			;;AN006;; No (not installed)
 36388                                  
 36389 00005651 89C3                    	mov	bx,ax				;;AN006;; BX is the extended error number
 36390 00005653 B80205                  	mov	ax,502h ; IFS_GET_ERR_TEXT	;;AN006;; AX is the muliplex number
 36391 00005656 CD2F                    	int	2Fh				;;AN006;; Call IFSFUNC
 36392                                  		; Multiplex - DOS 3+ CRITICAL ERROR HANDLER
 36393                                  
 36394                                  	;jmp	short $MEN57			;;AN006;;
 36395                                  	; 28/04/2023
 36396 00005658 720B                    	jc	short $MEN57
 36397                                  $MIF60:
 36398 0000565A 83C406                  	add	sp,6				;;AN006;; Throw away old pointer
 36399 0000565D E81200                  	call	$M_SET_LEN_IN_CX		;;AN006;; Get the length of the ASCIIZ string
 36400                                  $MEN60:
 36401 00005660 5D                      	pop	bp				;;AN006;; Restore other Regs
 36402 00005661 5A                      	pop	dx				;;AN006;;
 36403                                  $MIF56:
 36404                                  	; 07/04/2023
 36405                                  	;$M_POPF  ; macro in 'sysmsg.inc' (MSDOS 6.0)
 36406 00005662 EB07                    	jmp	short $M_MYRET			;;AN006;; Restore the flag state
 36407                                  
 36408                                  $MIF57:
 36409 00005664 F9                      	stc					;;AN006;; Carry conditon
 36410                                  $MEN57:
 36411                                  	; 28/04/2023
 36412                                  	;jnc	short $MIF60			;;AN006;;
 36413                                  
 36414 00005665 5F                      	pop	di				;;AN006;;
 36415 00005666 07                      	pop	es				;;AN006;; Restore old pointer
 36416 00005667 59                      	pop	cx				;;AN006;;
 36417 00005668 EBF6                    	jmp	short $MEN60
 36418                                  
 36419                                  ;$MIF60:
 36420                                  ;	add	sp,6				;;AN006;; Throw away old pointer
 36421                                  ;	call	$M_SET_LEN_IN_CX		;;AN006;; Get the length of the ASCIIZ string
 36422                                  ;$MEN60:
 36423                                  ;	pop	bp				;;AN006;; Restore other Regs
 36424                                  ;	pop	dx				;;AN006;;
 36425                                  ;$MIF56:
 36426                                  ;	; 07/04/2023
 36427                                  ;	;$M_POPF  ; macro in 'sysmsg.inc' (MSDOS 6.0)
 36428                                  ;	jmp	short $M_MYRET			;;AN006;; Restore the flag state
 36429                                  
 36430                                  ; 07/04/2023
 36431                                  ; ---------------------------
 36432                                  ; MSDOS 6.0, SYSMSG.INC, 1991
 36433                                  ; ---------------------------
 36434                                  	; $M_POPF macro
 36435                                  	;jmp	short $+3
 36436                                  m_popf_iret:
 36437 0000566A CF                      	iret
 36438                                  $M_MYRET:
 36439 0000566B 0E                      	push	cs
 36440 0000566C E8FBFF                  	call	m_popf_iret
 36441                                  	;;; end macro	
 36442                                  ; ---------------------------
 36443                                  
 36444 0000566F 5B                      	pop	bx				;;AN000;;
 36445 00005670 5E                      	pop	si				;;AN000;;
 36446 00005671 C3                      	retn					;;AN000;; Return ES:DI pointing to the message
 36447                                  
 36448                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36449                                  
 36450                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36451                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36452                                  $M_SET_LEN_IN_CX:			
 36453 00005672 57                      	push	di				;;AN006;; Save position
 36454 00005673 50                      	push	ax				;;AN006;;
 36455 00005674 B9FFFF                  	mov	cx,-1 ; 65535 ; 0FFFFh		;;AN006;; Set CX for decrements
 36456 00005677 30C0                    	xor	al,al				;;AN006;; Prepare compare register
 36457 00005679 F2AE                    	repne	scasb				;;AN006;; Scan for zero
 36458 0000567B F7D1                    	not	cx				;;AN006;; Change decrement into number
 36459 0000567D 49                      	dec	cx				;;AN006;; Don't include the zero
 36460 0000567E 58                      	pop	ax				;;AN006;;
 36461 0000567F 5F                      	pop	di				;;AN006;; Restore position
 36462 00005680 C3                      	retn					;;AN006;;
 36463                                  
 36464                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36465                                  ;;
 36466                                  ;;	PROC NAME: $M_FIND_SPECIFIED_MSG
 36467                                  ;;
 36468                                  ;;	FUNCTION:  To scan thru message headers until message is found
 36469                                  ;;	INPUTS:    ES:DI points to beginning of msg headers
 36470                                  ;;		   CX contains the number of messages in class
 36471                                  ;;		   DH contains the message class
 36472                                  ;;	OUPUTS:    IF CX = 0 THEN Message was not found
 36473                                  ;;		   IF CX > 1 THEN ES:DI points to header of specified message
 36474                                  ;;
 36475                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36476                                  
 36477                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36478                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36479                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36480                                  $M_FIND_SPECIFIED_MSG:
 36481 00005681 83FB01                  	cmp	bx,1				;;AN004;; Do we have an address to CALL?
 36482 00005684 751F                    	jne	short $MIF64
 36483 00005686 833E[BC98]FF            	cmp	word [$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR],-1
 36484                                  	;cmp	word [$M_RT+40],-1 ; 0FFFFh	;;AN004;; Do we have an address to CALL?
 36485                                  	; 15/06/2023
 36486 0000568B 7418                    	je	short $MIF64
 36487                                  
 36488 0000568D 83F8FF                  	cmp	ax,0FFFFh ; $M_SPECIAL_MSG_NUM	;;AN004;; Are we displaying a default Ext Err?
 36489 00005690 750B                    	jne	short $MIF65
 36490                                  	
 36491 00005692 50                      	push	ax				;;AN004;; Reset the special message number
 36492 00005693 A1[DC98]                	mov	ax,[$M_RT+$M_RES_ADDRS.$M_MSG_NUM]
 36493                                  	;mov	ax,[$M_RT+72]			;;AN004;; Get the old message number
 36494 00005696 FF1E[BC98]              	call	far [$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR]
 36495                                  						;;AN004;; Call the READ_DISK_PROC to get error text
 36496 0000569A 58                      	pop	ax				;;AN004;; Reset the special message number
 36497                                  	; 28/04/2023
 36498 0000569B EB04                    	jmp	short $MEN65
 36499                                  	; 18/04/2023
 36500                                  	;jmp	short $MEN64
 36501                                  $MIF65:
 36502 0000569D FF1E[BC98]              	call	far [$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR]
 36503                                  						;;AN004;; Call the READ_DISK_PROC to get error text
 36504                                  $MEN65:
 36505                                  	; 28/04/2023
 36506 000056A1 7344                    	jnc	short $MIF75
 36507                                  	;
 36508 000056A3 EB19                    	jmp	short $MEN64 ; $MDO76		;;AN004;;
 36509                                  $MIF64:
 36510 000056A5 31C9                    	xor	cx,cx				;;AN002;; CX = 0 will allow us to
 36511 000056A7 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN001;;
 36512 000056AA 7406                    	je	short $MIF69
 36513                                  	
 36514 000056AC 268A4D03                	mov	cl,[es:di+$M_CLASS_ID.$M_NUM_CLS_MSG]
 36515                                  	;mov	cl,[es:di+3]			;;AN001;; Get number of messages in class
 36516 000056B0 EB09                    	jmp	short $MEN69
 36517                                  $MIF69:
 36518                                  	;cmp	[cs:di+$M_CLASS_ID.$M_CLS_ID],dh
 36519                                  	;cmp	[cs:di+0],dh
 36520 000056B2 2E3835                  	cmp	[cs:di],dh			;;AN002;; Check if class still exists at
 36521 000056B5 7504                    	jne	short $MIF71
 36522                                  
 36523 000056B7 2E8A4D03                	mov	cl,[cs:di+$M_CLASS_ID.$M_NUM_CLS_MSG]
 36524                                  	;mov	cl,[cs:di+3]			;;AN000;; Get number of messages in class
 36525                                  $MIF71:						;;AN001;;
 36526                                  $MEN69:
 36527 000056BB 83C704                  	add	di,$M_CLASS_ID_SZ ; add di,4	;;AN000;; Point past the class header
 36528                                  	; 02/05/2023
 36529                                  	;stc					;;AN004;; Flag that we haven't found anything yet
 36530                                  $MEN64:
 36531                                  	;jnc	short $MIF75
 36532                                  	; 28/04/2023
 36533                                  	; (or instruction clears carry flag)
 36534                                  	;clc					;;AN004;; No, reset carry
 36535                                  $MDO76:
 36536 000056BE 09C9                    	or	cx,cx				;;AN000;; Do we have any to check?
 36537 000056C0 7417                    	jz	short $MEN76
 36538                                  
 36539 000056C2 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN001;;
 36540 000056C5 7405                    	je	short $MIF78
 36541                                  
 36542                                  	;cmp	ax,[es:di+$M_ID.$M_NUM]		;;AN001;; Is this the message requested?
 36543 000056C7 263B05                  	cmp	ax,[es:di]
 36544 000056CA EB03                    	jmp	short $MEN78
 36545                                  $MIF78:
 36546                                  	;cmp	ax,[cs:di+$M_ID.$M_NUM]		;;AN000;; Is this the message requested?
 36547 000056CC 2E3B05                  	cmp	ax,[cs:di]
 36548                                  $MEN78:
 36549                                  	;jne	short $MIF76
 36550                                  	;jmp	short $MSR76
 36551                                  	; 07/04/2023
 36552 000056CF 740B                    	je	short $MSR76 ; *
 36553                                  $MIF76:
 36554 000056D1 49                      	dec	cx				;;AN000;; No, well do we have more to check?
 36555 000056D2 7405                    	jz	short $MEN76
 36556                                  
 36557 000056D4 83C704                  	add	di,$M_ID_SZ ; add di,4		;;AN000;; Yes, skip past msg header
 36558 000056D7 EBE5                    	jmp	short $MDO76			;;AN000;;
 36559                                  $MEN76:
 36560 000056D9 F9                      	stc					;;AN000;;
 36561                                  ;$MSR76:	; 07/04/2023
 36562                                  	;jc	short $MIF86			;;AN000;;
 36563                                  	; 07/04/2023
 36564                                  	;jc	short $MIF91
 36565 000056DA EB11                    	jmp	short $MIF91 ;*
 36566                                  $MSR76:	; 07/04/2023 ; *	
 36567 000056DC 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN001;; Yes, is it a utility message?
 36568                                  	; 07/04/2023
 36569                                  	;clc					;;AN001;;
 36570 000056DF 7502                    	jne	short $MIF87
 36571                                  
 36572 000056E1 0E                      	push	cs				;;AN000;;
 36573 000056E2 07                      	pop	es				;;AN000;; Return ES:DI pointing to the message
 36574                                  $MIF87:
 36575                                  	;add	di,[es:di+2]
 36576 000056E3 26037D02                	add	di,[es:di+$M_ID.$M_TXT_PTR]     ;;AN000;; Prepare ES:DI pointing to the message
 36577                                  $MIF86:
 36578                                  ;$MIF75:
 36579                                  	; 02/05/2023
 36580                                  	;jc	short $MIF91
 36581                                  $MIF75:	; 28/04/2023
 36582 000056E7 30ED                    	xor	ch,ch				;;AN000;;
 36583 000056E9 268A0D                  	mov	cl,[es:di]			;;AN000;; Move size into CX
 36584 000056EC 47                      	inc	di				;;AN000;; Increment past length
 36585                                  $MIF91:
 36586 000056ED C606[D698]00            	mov	byte [$M_RT+$M_RES_ADDRS.$M_SIZE],0 ; $M_NULL
 36587                                  	;mov	byte [$M_RT+66],0		;;AN004;; Reset variable
 36588 000056F2 C3                      	retn					;;AN000;; Return
 36589                                  
 36590                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36591                                  ;;
 36592                                  ;;  Proc Name:	SYSDISPMSG
 36593                                  ;;
 36594                                  ;;  Function:	The DISPLAY service will output a defined message to a handle
 36595                                  ;;		requested by the caller. It also provides function to display
 36596                                  ;;		messages when handles are not applicable (ie. DOS function calls
 36597                                  ;;		00h to 0Ah) Replaceable parameters are allowed and are
 36598                                  ;;		defined previous to entry.
 36599                                  ;;
 36600                                  ;;		It is assumes that a PRELOAD function has already determined
 36601                                  ;;		the addressibilty internally to the message retriever services.
 36602                                  ;;  Inputs:
 36603                                  ;;
 36604                                  ;;  Outputs:
 36605                                  ;;
 36606                                  ;;  Psuedocode:
 36607                                  ;;		Save registers needed later
 36608                                  ;;		Get address of the message requested
 36609                                  ;;		IF Message number exists THEN
 36610                                  ;;		  IF replacable parameters were specified THEN
 36611                                  ;;		     Display message with replacable parms
 36612                                  ;;		  ELSE
 36613                                  ;;		     Display string without replacable parms
 36614                                  ;;		  ENDIF
 36615                                  ;;		  IF character input was requested THEN
 36616                                  ;;		     Wait for character input
 36617                                  ;;		  ENDIF
 36618                                  ;;		  Clear CARRY FLAG
 36619                                  ;;		ELSE
 36620                                  ;;		   Set CARRY FLAG
 36621                                  ;;		ENDIF
 36622                                  ;;		Return
 36623                                  ;;
 36624                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36625                                  
 36626                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36627                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5307h
 36628                                  	;
 36629                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36630                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5ACBh
 36631                                  
 36632                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36633                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5955h
 36634                                  SYSDISPMSG:
 36635                                  	;; Save registers and values needed later
 36636 000056F3 50                      	push	ax				;;AN000;; Save changed REGs
 36637 000056F4 53                      	push	bx				;;AN000;;
 36638 000056F5 51                      	push	cx				;;AN000;;
 36639 000056F6 55                      	push	bp				;;AN000;;
 36640 000056F7 57                      	push	di				;;AN000;; Save pointer to input buffer (offset)
 36641 000056F8 06                      	push	es				;;AN000;; Save pointer to input buffer (segment)
 36642 000056F9 52                      	push	dx				;;AN000;; Save Input/Class request
 36643                                  
 36644 000056FA 89CD                    	mov	bp,cx				;;AN000;; Use BP to hold replace count
 36645 000056FC 891E[D498]              	mov	[$M_RT+$M_RES_ADDRS.$M_HANDLE],bx
 36646                                  	;mov	[$M_RT+64],bx			;;AN000;; Save handle
 36647 00005700 8836[D998]              	mov	[$M_RT+$M_RES_ADDRS.$M_CLASS],dh
 36648                                  	;mov	[$M_RT+69],dh			;;AN004;; Save class
 36649                                  
 36650                                  	;; Get address of the message requested
 36651 00005704 E8D8FE                  	call	$M_GET_MSG_ADDRESS		;;AN000;; Scan thru classes to find message
 36652                                  
 36653 00005707 09C9                    	or	cx,cx				;;AN000;; Was message found?
 36654 00005709 7427                    	jz	short $MIF93
 36655                                  						;;AN000;; Yes, Message address in ES:DI
 36656                                  	
 36657                                  	;; Test if replacable parameters were specified
 36658 0000570B 09ED                    	or	bp,bp				;;AN000;; Were replacable parameters requested
 36659 0000570D 7505                    	jnz	short $MIF94
 36660                                  
 36661                                  	;; Display string without replacable parms
 36662 0000570F E82800                  	call	$M_DISPLAY_STRING		;;AN000;; No, great . . . Display message
 36663 00005712 EB03                    	jmp	short $MEN94
 36664                                  $MIF94:
 36665                                  	;; Display message with replacable parms
 36666 00005714 E88B01                  	call	$M_DISPLAY_MESSAGE		;;AN000;; Display the message with substitutions
 36667                                  $MEN94:
 36668 00005717 7214                    	jc	short $MIF97
 36669 00005719 5A                      	pop	dx				;;AN000;; Get Input/Class request
 36670 0000571A E8FC00                  	call	$M_ADD_CRLF 			;;AN004;; Check if we need to add the CR LF chars.
 36671 0000571D 07                      	pop	es				;;AN000;; Get location of input buffer (if specified)
 36672 0000571E 5F                      	pop	di				;;AN000;;
 36673                                  	
 36674                                  ; 15/06/2023 - MSDOS 5.0
 36675                                  ;	;jmp	short $MEN97 ; ***
 36676                                  ;	; 08/04/2023
 36677                                  ;	;jmp	short $MEN93 ; **
 36678                                  ;
 36679                                  ;	; 08/04/2023
 36680                                  ;;$MEN93:
 36681                                  ;	jc	short $MIF104
 36682                                  
 36683                                  	; 15/06/2023 Retro DOS v4.2 COMMAND.COM
 36684                                   	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5AF7h
 36685                                  
 36686                                  	; MSDOS 6.0 (MSDOS 6.22)
 36687                                  	; Test if character input was requested	;;AN000;;
 36688 0000571F 08D2                    	or	dl,dl
 36689 00005721 7403                    	jz	short $MIF98
 36690                                  	;jz	short $MEN98 ; *
 36691                                  
 36692 00005723 E88B05                  	call	$M_WAIT_FOR_INPUT	; MSDOS 6.0 (to 6.22)
 36693                                  	; cf = 0 ; *
 36694                                  $MIF98:
 36695                                  	;jmp	short $MEN97
 36696                                  	;;jc	short $MIF104 ; *
 36697                                  $MEN98:
 36698                                  ;$MEN97:
 36699 00005726 5D                      	pop	bp				;;AN000;;
 36700 00005727 59                      	pop	cx				;;AN000;;
 36701 00005728 5B                      	pop	bx				;;AN000;;
 36702                                  	; 15/06/2023
 36703                                  	;pop	ax	; MSDOS 5.0		;;AN000;;
 36704 00005729 83C402                  	add	sp,2	; MSDOS 6.0 (to 6.22)
 36705 0000572C C3                      	retn
 36706                                   
 36707                                  $MIF97:
 36708                                  	; 08/04/2023
 36709                                  	;add	sp,6				;;AN000;;
 36710                                  	;stc					;;AN000;; Reset carry flag
 36711                                  ;$MEN97: ; ***
 36712                                  	;jmp	short $MEN93
 36713                                  	; 08/04/2023
 36714                                  	;jmp	short $MIF104
 36715                                  	; 08/04/2023
 36716 0000572D 83C40E                  	add	sp,14 ; 6+8
 36717 00005730 F9                      	stc
 36718 00005731 C3                      	retn
 36719                                  $MIF93:
 36720                                  	; 08/04/2023 - 15/06/2023
 36721                                  	; (wrong pops ?) - correct order: pop dx, pop es, pop di -
 36722                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:533Bh
 36723                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5B06h
 36724 00005732 07                      	pop	es				;;AN000;; Get pointer to input buffer (segment)
 36725 00005733 5F                      	pop	di				;;AN000;; Get base pointer to first sublist (offset)
 36726 00005734 5A                      	pop	dx				;;AN000;; Get base pointer to first sublist (segment)
 36727                                  	;stc	; * 				;;AN000;; Set carry flag
 36728                                  	; 08/04/2023
 36729                                  	;jmp	short $MIF104 ; *
 36730                                  
 36731                                  ;$MEN93: ; **
 36732                                  ;	jc	short $MIF104
 36733                                  ;$MEN97: ; 08/04/2023
 36734                                  ;	pop	bp				;;AN000;;
 36735                                  ;	pop	cx				;;AN000;;
 36736                                  ;	pop	bx				;;AN000;;
 36737                                  ;	pop	ax				;;AN000;;
 36738                                  ;	;jmp	short $MEN104
 36739                                  ;	; 08/04/2023
 36740                                  ;	retn
 36741                                  
 36742                                  $MIF104: ; *
 36743 00005735 83C408                  	add	sp,8				;;AN000;; Eliminate from stack
 36744 00005738 F9                      	stc					;;AN000;;
 36745                                  $MEN104:
 36746 00005739 C3                      	retn					;;AN000;; Return
 36747                                  
 36748                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36749                                  ;;
 36750                                  ;;	PROC NAME: $M_DISPLAY_STRING
 36751                                  ;;
 36752                                  ;;	FUNCTION:  Will display or write string
 36753                                  ;;	INPUTS:    ES:DI points to beginning of message
 36754                                  ;;		   CX contains the length of string to write (if applicable)
 36755                                  ;;	OUTPUTS:   None
 36756                                  ;;	REGS Revised: None
 36757                                  ;;
 36758                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36759                                  
 36760                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36761                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36762                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36763                                  $M_DISPLAY_STRING:
 36764 0000573A 50                      	push	ax				;;AN000;;
 36765 0000573B 53                      	push	bx				;;AN000;;
 36766 0000573C 52                      	push	dx				;;AN000;;
 36767 0000573D 8B1E[D498]              	mov	bx,[$M_RT+$M_RES_ADDRS.$M_HANDLE]
 36768                                  	;mov	bx,[$M_RT+64]			;;AN000;; Retrieve handle
 36769                                  	
 36770 00005741 83FBFF                  	cmp	bx,0FFFFh ; $M_NO_HANDLE 	;;AN000;; Was there a handle specified?
 36771 00005744 7505                    	jne	short $MIF107
 36772                                  
 36773 00005746 E82600                  	call	$M_DISPLAY_$_STRING		;;AN000;; No, display $ terminated string
 36774 00005749 EB03                    	jmp	short $MEN107
 36775                                  $MIF107:
 36776 0000574B E86E00                  	call	$M_DISPLAY_H_STRING		;;AN000;; Yes, display string to handle
 36777                                  $MEN107:
 36778 0000574E 730D                    	jnc	short $MIF110
 36779                                  	
 36780 00005750 B459                    	mov	ah,59h	; DOS_GET_EXT_ERROR	;;AN000;;
 36781                                  	;mov	bx,0	; DOS_GET_EXT_ERROR_BX	;;AN000;; Get extended error
 36782                                  	; 08/04/2023
 36783 00005752 31DB                    	xor	bx,bx
 36784 00005754 CD21                    	int	21h				;;AN000;;
 36785                                  		; DOS - 3+ - GET EXTENDED ERROR CODE
 36786                                  		; BX = version code (0000h for DOS 3.x)
 36787 00005756 30E4                    	xor	ah,ah				;;AN000;; Clear AH
 36788                                  $MEN110: ; 08/04/2023 ; ***
 36789 00005758 83C406                  	add	sp,6				;;AN000;; Clean up stack
 36790 0000575B F9                      	stc					;;AN000;; Flag that there was an error
 36791                                  	;jmp	short $MEN110 ; ****
 36792                                  	; 08/04/2023
 36793 0000575C C3                      	retn
 36794                                  $MIF110:
 36795                                  	;cmp	bx,$M_NO_HANDLE
 36796 0000575D 83FBFF                  	cmp	bx,0FFFFh ; $M_NO_HANDLE	;;AN000;; Was there a handle specified?
 36797 00005760 7409                    	je	short $MIF112 ; *  ; cf = 0
 36798 00005762 39C8                    	cmp	ax,cx				;;AN001;; Was it ALL written?
 36799 00005764 7405                    	je	short $MIF113 ; ** ; cf = 0
 36800 00005766 E8A700                  	call	$M_GET_EXT_ERR_39		;;AN001;; Set Extended error
 36801                                  	;add	sp,6				;;AN001;; Clean up stack
 36802                                  	;stc					;;AN001;; Flag that there was an error
 36803                                  	; 08/04/2023
 36804 00005769 EBED                    	jmp	short $MEN110 ; ***
 36805                                  	; 08/04/2023
 36806                                  ;$MIF112:
 36807                                  ;$MEN110: ; ****
 36808                                  	;jc	short $MIF117
 36809                                  $MIF112: ; 08/04/2023	; *
 36810                                  $MIF113:	; **
 36811 0000576B 5A                      	pop	dx				;;AN000;; Restore regs
 36812 0000576C 5B                      	pop	bx				;;AN000;;
 36813 0000576D 58                      	pop	ax				;;AN000;;
 36814                                  $MIF117:
 36815 0000576E C3                      	retn
 36816                                  
 36817                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36818                                  ;;
 36819                                  ;;	PROC NAME: $M_DISPLAY_$_STRING
 36820                                  ;;
 36821                                  ;;	FUNCTION:  Will display a $ terminated string
 36822                                  ;;	INPUTS:    ES:DI points to beginning of message text (not the length)
 36823                                  ;;	OUTPUTS:   None
 36824                                  ;;	REGS USED: AX,DX
 36825                                  ;;
 36826                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36827                                  
 36828                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36829                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36830                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36831                                  $M_DISPLAY_$_STRING:
 36832 0000576F 1E                      	push	ds				;;AN000;;
 36833 00005770 06                      	push	es				;;AN000;;
 36834 00005771 1F                      	pop	ds				;;AN000;; Set DS to segment of message text
 36835                                  
 36836                                  	; 08/04/2023
 36837 00005772 B402                    	mov	ah,2 ; DOS_DISP_CHAR
 36838                                  
 36839                                  	;cmp	cx,$M_SINGLE_CHAR		;;AN000;; Is this a single character?
 36840 00005774 83F901                  	cmp	cx,1 ; $M_SINGLE_CHAR
 36841 00005777 7518                    	jne	short $MIF119			;;AN000;; No
 36842                                  	
 36843                                  	;mov	ah,2 ; DOS_DISP_CHAR		;;AN000;; DOS Function to display CHARACTER
 36844 00005779 268A15                  	mov	dl,[es:di]			;;AN000;; Get the character
 36845 0000577C CD21                    	int	21h				;;AN000;; Write character
 36846                                  		; DOS - DISPLAY OUTPUT
 36847                                  		; DL = character to send to standard output
 36848 0000577E 1F                      	pop	ds				;;AN000;;
 36849 0000577F 88D0                    	mov	al,dl				;;AN000;; Get the character in AL
 36850 00005781 E8AC00                  	call	$M_IS_IT_DBCS 			;;AN000;; Is this the first byte of a DB character
 36851 00005784 1E                      	push	ds				;;AN000;;
 36852 00005785 06                      	push	es				;;AN000;;
 36853 00005786 1F                      	pop	ds				;;AN000;; Set DS to segment of message text
 36854 00005787 7316                    	jnc	short $MIF120 ; *
 36855                                  
 36856 00005789 268A5501                	mov	dl,[es:di+1]			;;AN000;; Get the next character
 36857 0000578D CD21                    	int	21h				;;AN000;; Write character
 36858                                  		; DOS - DISPLAY OUTPUT
 36859                                  		; DL = character to send to standard output
 36860                                  	; 08/04/2023
 36861                                  	;clc					;;AN000;; Clear the DBCS indicator
 36862                                  ;$MIF120:
 36863 0000578F EB0D                    	jmp	short $MEN119
 36864                                  $MIF119:
 36865                                  	; 08/04/2023
 36866                                  	;mov	ah,2 ; DOS_DISP_CHAR		;;AN000;; DOS Function to display CHARACTER
 36867                                  ;$MDO123:
 36868 00005791 09C9                    	or	cx,cx				;;AN002;; Are there any left to display?
 36869                                  	;jz	short $MEN123
 36870                                  	; 18/04/2023
 36871 00005793 740A                    	jz	short $MIF120 ; cf = 0
 36872                                  $MDO123: ; 08/04/2023
 36873 00005795 268A15                  	mov	dl,[es:di]			;;AN002;; Get the character
 36874 00005798 CD21                    	int	21h				;;AN002;; Display the character
 36875                                  		; DOS - DISPLAY OUTPUT
 36876                                  		; DL = character to send to standard output
 36877 0000579A 47                      	inc	di				;;AN002;; Set pointer to next character
 36878 0000579B 49                      	dec	cx				;;AN002;; Count this character
 36879 0000579C 75F7                    	jnz	short $MDO123
 36880                                  ;$MEN123:
 36881                                  $MEN119:
 36882 0000579E F8                      	clc					;;AN000;;Char functions used don't return carry as error
 36883                                  $MIF120: ; 08/04/2023 ; *
 36884 0000579F 1F                      	pop	ds				;;AN000;;
 36885 000057A0 C3                      	retn
 36886                                  
 36887                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36888                                  ;;
 36889                                  ;; Scan_ctrlZ: This routine looks through the string to be printed and 
 36890                                  ;; truncates it at the Ctrl-Z if any present.
 36891                                  ;;
 36892                                  ;;	ENTRY:	ds:dx = String to be displayed
 36893                                  ;;		cx = number of chars to be displayed
 36894                                  ;;
 36895                                  ;;	EXIT:	cx = number of chars to be displayed
 36896                                  ;;
 36897                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36898                                  
 36899                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36900                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36901                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36902                                  scan_ctrlz:
 36903 000057A1 57                      	push	di
 36904 000057A2 50                      	push	ax
 36905 000057A3 06                      	push	es
 36906 000057A4 53                      	push	bx
 36907                                  
 36908 000057A5 89D7                    	mov	di,dx
 36909 000057A7 1E                      	push	ds
 36910 000057A8 07                      	pop	es   			;es:di points at string
 36911                                  
 36912 000057A9 89CB                    	mov	bx,cx			;save current count
 36913                                  
 36914 000057AB B01A                    	mov	al,1Ah	; Ctrl-Z
 36915 000057AD FC                      	cld
 36916 000057AE F2AE                    	repne	scasb			;find first Ctrl-Z
 36917 000057B0 7503                    	jnz	short noCtrlZ		;no CtrlZ found in string
 36918                                  
 36919 000057B2 29CB                    	sub	bx,cx
 36920 000057B4 4B                      	dec	bx			;bx = new count to display
 36921                                  noCtrlZ:
 36922 000057B5 89D9                    	mov	cx,bx			;cx = actual display count
 36923                                  
 36924 000057B7 5B                      	pop	bx
 36925 000057B8 07                      	pop	es
 36926 000057B9 58                      	pop	ax
 36927 000057BA 5F                      	pop	di
 36928                                  $MIF127:	; 08/04/2023
 36929 000057BB C3                      	retn
 36930                                  
 36931                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36932                                  ;;
 36933                                  ;;	PROC NAME: $M_DISPLAY_H_STRING
 36934                                  ;;
 36935                                  ;;	FUNCTION:  Will display a string to a specified handle
 36936                                  ;;	INPUTS:    ES:DI points to beginning of message
 36937                                  ;;		   CX contains the number of bytes to write
 36938                                  ;;		   BX contains the handle to write to
 36939                                  ;;	OUPUTS:    None
 36940                                  ;;	REGS USED: AX,DX
 36941                                  ;;
 36942                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36943                                  
 36944                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36945                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36946                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 36947                                  $M_DISPLAY_H_STRING:
 36948 000057BC 31C0                    	xor	ax,ax			;;AN002;; Set number of bytes written to 0
 36949 000057BE 09C9                    	or	cx,cx			;;AN002;; For performance, don't write if not necessary
 36950 000057C0 74F9                    	jz	short $MIF127
 36951                                  	
 36952 000057C2 1E                      	push	ds			;;AN000;;
 36953 000057C3 06                      	push	es			;;AN000;;
 36954 000057C4 1F                      	pop	ds			;;AN000;; Set DS to segment of message text
 36955                                  	
 36956 000057C5 B440                    	mov	ah,40h ; DOS_WRITE_HANDLE ;;AN000;; DOS function to write to a handle
 36957 000057C7 89FA                    	mov	dx,di			;;AN000;; Pointer to data to write
 36958                                  
 36959 000057C9 83F901                  	cmp	cx,1 ; $M_SINGLE_CHAR	;;AN000;; Is this a single character?
 36960 000057CC 7528                    	jne	short $MIF128		;;AN000;; No
 36961                                  
 36962 000057CE CD21                    	int	21h			;;AN000;; Write character
 36963                                  		; DOS - 2+ - WRITE TO FILE WITH HANDLE
 36964                                  		; BX = file handle, CX = number of bytes to writ
 36965                                  
 36966 000057D0 1F                      	pop	ds			;;AN000;; Set DS to segment of message text
 36967 000057D1 50                      	push	ax			;;AN000;;
 36968 000057D2 268A05                  	mov	al,[es:di] 		;;AN000;; Get the character
 36969 000057D5 E85800                  	CALL    $M_IS_IT_DBCS		;;AN000;; Is this the first byte of a DB character
 36970 000057D8 58                      	pop	ax			;;AN000;;
 36971 000057D9 1E                      	push	ds			;;AN000;;
 36972 000057DA 06                      	push	es			;;AN000;;
 36973 000057DB 1F                      	pop	ds			;;AN000;; Set DS to segment of message text
 36974 000057DC 7306                    	jnc	short $MIF129
 36975                                  	
 36976 000057DE F8                      	clc				;;AN000;; Clear the DBCS indicator
 36977 000057DF B440                    	mov	ah,40h ; DOS_WRITE_HANDLE ;;AN000;; DOS function to write to a handle
 36978 000057E1 42                      	inc	dx			;;AN000;; Point to next character
 36979 000057E2 CD21                    	int	21h			;;AN000;; Write character
 36980                                  		; DOS - 2+ - WRITE TO FILE WITH HANDLE
 36981                                  		; BX = file handle, CX = number of bytes to write, 
 36982                                  $MIF129:
 36983                                  ;SR;
 36984                                  ; If the single char happened to be a Ctrl-Z, the dos write would return
 36985                                  ;0 chars written making the caller think there was an error writing. To 
 36986                                  ;avoid this, we check if the single char was a Ctrl-Z and if so, return that
 36987                                  ;the char was written, thus fooling the caller.
 36988                                  
 36989 000057E4 9C                      	pushf				;save flags
 36990 000057E5 26803D1A                	cmp	byte [es:di],1Ah	;is char a Ctrl-Z?
 36991 000057E9 7502                    	jne	short m_popf_j		;no, continue
 36992                                  
 36993 000057EB 89C8                    	mov	ax,cx			;yes, fake as if it was written
 36994                                  m_popf_j:
 36995                                  	; 08/04/2023
 36996                                  	;$M_POPF  ; macro in 'sysmsg.inc' (MSDOS 6.0)
 36997 000057ED EB01                    	jmp	short m_popf		;restore flags
 36998                                  
 36999                                  ; 07/04/2023
 37000                                  ; ---------------------------
 37001                                  ; MSDOS 6.0, SYSMSG.INC, 1991
 37002                                  ; ---------------------------
 37003                                  	; $M_POPF macro
 37004                                  	;jmp	short $+3
 37005                                  intret:
 37006 000057EF CF                      	iret
 37007                                  m_popf:
 37008 000057F0 0E                      	push	cs
 37009 000057F1 E8FBFF                  	call	intret
 37010                                  	;;; end macro	
 37011                                  ; ---------------------------
 37012                                  
 37013 000057F4 EB18                    	jmp	short $MEN128
 37014                                  
 37015                                  $MIF128:
 37016                                  ;SR;
 37017                                  ; Prescan the string looking for Ctrl-Z. We terminate the message the moment 
 37018                                  ;we hit a Ctrl-Z. cx will contain the number of characters to be printed.
 37019                                  
 37020 000057F6 55                      	push	bp			; M007
 37021 000057F7 51                      	push	cx
 37022 000057F8 E8A6FF                  	call	scan_ctrlz		;cx = count without Ctrl-Z
 37023 000057FB 89CD                    	mov	bp,cx			;store no ^Z count in bp ;M007
 37024 000057FD 59                      	pop	cx			;get old count back ;M007
 37025                                  	
 37026 000057FE CD21                    	int	21h			;;AN000;; Write String at DS:SI to handle
 37027                                  	;jnc	short chk_count		;no error, adjust return count
 37028                                  	;jmp	short m_cnt_ok		;error, return with carry set;M007
 37029                                  	; 08/04/2023
 37030 00005800 720B                    	jc	short m_cnt_ok
 37031                                  ;M007
 37032                                  ; If we are writing to con and there is a Ctrl-Z in the string, the
 37033                                  ;return count will be much less and if this returns to the caller we can get
 37034                                  ;spurious error messages. We check here if the count returned is same as
 37035                                  ;original count or same as the count if we stop at Ctrl-Z. In the second
 37036                                  ;case, we fake it as if all bytes have been written. If the return count
 37037                                  ;does not match either count, then we had some other disk error (such as
 37038                                  ;insufficient disk space) and we pass it through
 37039                                  
 37040                                  chk_count:
 37041 00005802 39C1                    	cmp	cx,ax			;have all bytes been written?;M007
 37042 00005804 7407                    	je	short m_cnt_ok		;there was an error writing ;M007
 37043 00005806 39C5                    	cmp	bp,ax			;count = Ctrl-Z count? ;M007
 37044 00005808 F8                      	clc				;no error either way ;M007
 37045 00005809 7502                    	jne	short m_cnt_ok		;no, pass it through ;M007
 37046 0000580B 89C8                    	mov	ax,cx			;return old count ;M007
 37047                                  m_cnt_ok:				; M007
 37048 0000580D 5D                      	pop	bp			; M007
 37049                                  $MEN128:
 37050 0000580E 1F                      	pop	ds			;;AN000;;
 37051                                  ;$MIF127: ; 08/04/2023
 37052 0000580F C3                      	retn
 37053                                  
 37054                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37055                                  ;;
 37056                                  ;;	PROC NAME: $M_GET_EXT_ERR_39
 37057                                  ;;
 37058                                  ;;	FUNCTION:  Will set registers for extended error #39
 37059                                  ;;	INPUTS:    None
 37060                                  ;;	OUPUTS:    AX,BX,CX set
 37061                                  ;;	REGS USED:
 37062                                  ;;
 37063                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37064                                  
 37065                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37066                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:542Dh
 37067                                  
 37068                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37069                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5BFAh
 37070                                  
 37071                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37072                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5A81h
 37073                                  $M_GET_EXT_ERR_39:
 37074 00005810 B82700                  	mov	ax,27h ; EXT_ERR_39	;AN001; Set AX=39
 37075                                  	;mov	bx,(ERROR_CLASS_39 SHR 8) + ACTION_39
 37076 00005813 BB0400                  	mov	bx,4			;AN001; Set BH=1 BL=4
 37077                                  	;mov	ch,LOCUS_39		;AN001; Set CH=1
 37078 00005816 B501                    	mov	ch,1			;AN001;
 37079 00005818 C3                      	retn				;AN001;
 37080                                  
 37081                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37082                                  ;;
 37083                                  ;;	PROC NAME: $M_ADD_CRLF
 37084                                  ;;
 37085                                  ;;	FUNCTION:  Will decide whether to display a CRLF
 37086                                  ;;	INPUTS:    DX contains the Input/Class requested
 37087                                  ;;	OUTPUTS:   None
 37088                                  ;;	REGS Revised: CX,ES,DI
 37089                                  ;;
 37090                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37091                                  
 37092                                  	; 09/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37093                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37094                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37095                                  $M_ADD_CRLF:
 37096                                  	;cmp	dh,0FFh
 37097 00005819 80FEFF                  	cmp	dh,utility_msg_class	;;AN004;; Is it a utility message?
 37098 0000581C 7411                    	je	short $MIF134		;;AN004;; Yes
 37099 0000581E F6C680                  	test	dh,80h ; $M_NO_CRLF_MASK ;;AN004;; Are we to supress the CR LF?
 37100 00005821 750C                    	jnz	short $MIF135
 37101                                  					;;AN004;; No	
 37102 00005823 1E                      	push	ds			;;AN004;;
 37103 00005824 07                      	pop	es			;;AN004;; Set ES to data segment
 37104 00005825 8D3E[D798]              	lea	di,[$M_RT+$M_RES_ADDRS.$M_CRLF]
 37105                                  	;lea	di,[$M_RT+67]		;;AN004;; Point at CRLF message
 37106 00005829 B90200                  	mov	cx,2 ; $M_CRLF_SIZE	;;AN004;; Set the message size
 37107 0000582C E80BFF                  	call	$M_DISPLAY_STRING	;;AN004;; Display the CRLF
 37108                                  $MIF135:
 37109                                  $MIF134:
 37110 0000582F C3                      	retn				;;AN004;; Return
 37111                                  
 37112                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37113                                  ;;
 37114                                  ;;	PROC NAME: $M_IS_IT_DBCS
 37115                                  ;;
 37116                                  ;;	FUNCTION:  Will decide whether character is Single or Double Byte
 37117                                  ;;	INPUTS:    AL contains the byte to be checked
 37118                                  ;;	OUTPUTS:   Carry flag = 0 if byte is NOT in DBCS range
 37119                                  ;;		   Carry flag = 1 if byte IS in DBCS range
 37120                                  ;;	REGS USED: All restored
 37121                                  ;;
 37122                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37123                                  
 37124                                  	; 09/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37125                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37126                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37127                                  $M_IS_IT_DBCS:
 37128 00005830 06                      	push	es			;;AN000;; Save Extra Segment register
 37129 00005831 57                      	push	di			;;AN000;; Save DI register
 37130                                  
 37131 00005832 C43E[D098]              	les	di,[$M_RT+$M_RES_ADDRS.$M_DBCS_VEC]
 37132                                  	;les	di,[$M_RT+60]		;;AN000;;
 37133 00005836 09FF                    	or	di,di			;;AN000;; Was the DBCS vector set?
 37134 00005838 7417                    	jz	short $MIF138		;;AN000;; No
 37135                                  $MDO139:
 37136 0000583A 26833D00                	cmp	word [es:di],0 ; $M_DBCS_TERM
 37137                                  					;;AN000;; Is this the terminating flag?
 37138 0000583E F8                      	clc				;;AN000;;
 37139 0000583F 7410                    	jz	short $MEN139
 37140                                  					;;AN000;; No
 37141 00005841 263A05                  	cmp	al,[es:di]		;;AN000;; Does the character fall in the DBCS range?
 37142 00005844 7207                    	jnae	short $MIF141 ; jb	;;AN000;; No		
 37143 00005846 263A4501                	cmp	al,[es:di+1]		;;AN000;; Does the character fall in the DBCS range?
 37144 0000584A 7701                    	jnbe	short $MIF141 ; ja	;;AN000;; No
 37145                                  					;;AN000;; Yes
 37146 0000584C F9                      	stc				;;AN000;; Set carry flag
 37147                                  $MIF141:
 37148 0000584D 47                      	inc	di			;;AN000;;
 37149 0000584E 47                      	inc	di			;;AN000;;
 37150 0000584F EBE9                    	jmp	short $MDO139		;;AN000;; Go to next vector
 37151                                  $MEN139:
 37152                                  $MIF138:
 37153 00005851 5F                      	pop	di			;;AN000;; Restore DI register
 37154 00005852 07                      	pop	es			;;AN000;; Restore Extra Segment register
 37155 00005853 C3                      	retn				;;AN000;; Return
 37156                                  
 37157                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37158                                  ;;
 37159                                  ;;	PROC NAME: $M_CONVERT2ASC
 37160                                  ;;
 37161                                  ;;	FUNCTION: Convert a binary number to a ASCII string
 37162                                  ;;	INPUTS: DX:AX contains the number to be converted
 37163                                  ;;		$M_RT_DIVISOR contains the divisor
 37164                                  ;;	OUTPUTS: CX contains the number of characters
 37165                                  ;;		Top of stack  --> Last character
 37166                                  ;;				     . . .
 37167                                  ;;		Bot of stack  --> First character
 37168                                  ;;	REGS USED:
 37169                                  ;;
 37170                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37171                                  
 37172                                  	; 09/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37173                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37174                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37175                                  $M_CONVERT2ASC:
 37176 00005854 8F06[DA98]              	pop	word [$M_RT+$M_RES_ADDRS.$M_RETURN_ADDR]
 37177                                  	;pop	word [$M_RT+70]			;;AN000;; Save Return Address
 37178                                  	
 37179 00005858 31DB                    	xor	bx,bx				;;AN000;; Use BX as a swapping register
 37180 0000585A 93                      	xchg	bx,ax				;;AN000;; Initialize - Low Word in BX
 37181 0000585B 92                      	xchg	ax,dx				;;AN000;;	  - High Word in AX
 37182                                  $MDO145:					;;AN000;; DO UNTIL Low Word becomes zero
 37183 0000585C F736[DE98]              	div	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR]
 37184                                  	;div	word [$M_RT+74]			;;AN000;; Divide High Word by divisor
 37185 00005860 93                      	xchg	bx,ax				;;AN000;; Setup to divide Low Word using remainder
 37186                                  						;;AN000;;  and save reduced High Word in BX
 37187 00005861 F736[DE98]              	div	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR]
 37188                                  	;div	word [$M_RT+74]			;;AN000;; Divide Low Word by divisor
 37189                                  
 37190 00005865 83FA09                  	cmp	dx,9				;;AN000;; Make a digit of the remainder
 37191 00005868 7605                    	jna	short $MIF146			;;AN000;; 0-9
 37192 0000586A 80C237                  	add	dl,55	; add dl,37h		;;AN000;; Make A to F ASCII
 37193 0000586D EB03                    	jmp	short $MEN146
 37194                                  $MIF146:
 37195 0000586F 80C230                  	add	dl,'0'				;;AN000;; Make 0 to 9 ASCII
 37196                                  $MEN146:
 37197 00005872 52                      	push	dx				;;AN000;; Save the digit on the stack
 37198 00005873 41                      	inc	cx				;;AN000;; Count that digit
 37199 00005874 09C0                    	or	ax,ax				;;AN000;; Are we done?
 37200 00005876 7504                    	jnz	short $MLL149			;;AN000;; No
 37201 00005878 09DB                    	or	bx,bx				;;AN000;; AX and BX must be ZERO!!
 37202 0000587A 741F                    	jz	short $MEN145 ; * ; ax = 0	;;AN000;; Yes
 37203                                  $MLL149:
 37204 0000587C 83F903                  	cmp	cx,3 ; $M_FIRST_THOU		;;AN000;; Are we at the first thousands mark
 37205                                  ; 28/04/2023
 37206 0000587F 740A                    	je	short $MIF153
 37207                                  ;	jne	short $MIF150			;;AN000;; No
 37208                                  ;	;cmp	$M_SL.$M_S_PAD,$M_COMMA		;;AN000;; Is the pad character a comma?
 37209                                  ;	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','
 37210                                  ;	;cmp	byte [si+0Ah],',' ; $M_COMMA
 37211                                  ;	;jne	short $MIF151
 37212                                  ;	; 09/04/2023
 37213                                  ;	jne	short $MEN150
 37214                                  ;						;;AN000;; Yes
 37215                                  ;	push	word [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA]
 37216                                  ;	;push	word [$M_RT+83]			;;AN000;; Insert a thousand separator
 37217                                  ;	inc	cx				;;AN000;;
 37218                                  ;$MIF151:
 37219                                  ;	jmp	short $MEN150
 37220                                  
 37221                                  $MIF150:
 37222                                  	; 15/06/2023 (6)
 37223                                  	; MSDOS 6.0
 37224                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:54ABh 
 37225                                  	;cmp	cx,6 ; $M_SECOND_THOU		;;AN000;; Are we at the first thousands mark
 37226                                  	; 15/06/2023 (7)
 37227                                  	; MSDOS 6.22
 37228                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5C78h 
 37229 00005881 83F907                  	cmp	cx,7 ; $M_SECOND_THOU		;;AN000;; Are we at the first thousands mark
 37230                                  
 37231                                  ; 28/04/2023
 37232 00005884 7405                    	je	short $MIF153
 37233                                  ;	jne	short $MIF154			;;AN000;; No
 37234                                  ;	;cmp	$M_SL.$M_S_PAD,$M_COMMA		;;AN000;; Is the pad character a comma?
 37235                                  ;	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','	
 37236                                  ;	;cmp	byte [si+0Ah],',' ; $M_COMMA
 37237                                  ;	;jne	short $MIF155			;;AN000;; No
 37238                                  ;	; 09/04/2023
 37239                                  ;	jne	short $MEN154
 37240                                  ;						;;AN000;; Yes
 37241                                  ;	push	word [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA]
 37242                                  ;	;push	word [$M_RT+83]			;;AN000;; Insert a thousand separator
 37243                                  ;	inc	cx				;;AN000;;
 37244                                  ;$MIF155:
 37245                                  ;	jmp	short $MEN154
 37246                                  
 37247                                  $MIF154:
 37248                                  	; 15/06/2023 (9)
 37249                                  	; MSDOS 6.0
 37250                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:54BDh 
 37251                                  	;cmp	cx,9 ; $M_THIRD_THOU		;;AN000;; Are we at the first thousands mark
 37252                                  	; 15/06/2023 (11)
 37253                                  	; MSDOS 6.22
 37254                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5C8Ah 
 37255 00005886 83F90B                  	cmp	cx,11 ; $M_THIRD_THOU		;;AN000;; Are we at the first thousands mark
 37256 00005889 750B                    	jne	short $MIF158			;;AN000;; No
 37257                                  ; 28/04/2023
 37258                                  $MIF153:
 37259                                  	;cmp	$M_SL.$M_S_PAD,$M_COMMA		;;AN000;; Is the pad character a comma?
 37260 0000588B 807C0A2C                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','
 37261                                  	;cmp	byte [si+0Ah],',' ; $M_COMMA
 37262 0000588F 7505                    	jne	short $MIF159			;;AN000;; No
 37263                                  						;;AN000;; Yes
 37264 00005891 FF36[E798]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA]
 37265                                  	;push	word [$M_RT+83]			;;AN000;; Insert a thousand separator
 37266 00005895 41                      	inc	cx				;;AN000;;
 37267                                  $MIF159:
 37268                                  $MIF158:
 37269                                  $MEN154:
 37270                                  $MEN150:					;;AN000;;
 37271 00005896 93                      	xchg	ax,bx				;;AN000;; Setup to divide the reduced High Word
 37272                                  						;;AN000;;  and Revised Low Word
 37273 00005897 31D2                    	xor	dx,dx				;;AN000;; Reset remainder
 37274                                  	; 28/04/2023
 37275 00005899 EBC1                    	jmp	short $MDO145
 37276                                  ;$MEN145:
 37277                                  	; 28/04/2023
 37278                                  	;xor	ax,ax				;;AN000;; Reset remainder
 37279                                  $MEN145: ; 09/04/2023 ; * ; ax = 0
 37280 0000589B 31D2                    	xor	dx,dx				;;AN000;; Reset remainder
 37281 0000589D FF36[DA98]              	push	word [$M_RT+$M_RES_ADDRS.$M_RETURN_ADDR]
 37282                                  	;push	word [$M_RT+70]			;;AN000;; Restore Return Address
 37283 000058A1 C3                      	retn					;;AN000;; Return
 37284                                  
 37285                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37286                                  ;;
 37287                                  ;;	PROC NAME: $M_DISPLAY_MESSAGE
 37288                                  ;;
 37289                                  ;;	FUNCTION:  Will display or write entire message (with replacable parameters)
 37290                                  ;;	INPUTS:    ES:DI points to beginning of message
 37291                                  ;;		   DS:SI points to first sublist structure in chain
 37292                                  ;;		   BX contains the handle to write to (if applicable)
 37293                                  ;;		   CX contains the length of string to write (before substitutions)
 37294                                  ;;		   BP contains the count of replacables
 37295                                  ;;
 37296                                  ;;	OUTPUTS:
 37297                                  ;;	REGS USED: All
 37298                                  ;;
 37299                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37300                                  
 37301                                  	; 10/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37302                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:54DBh
 37303                                  
 37304                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37305                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:54DBh
 37306                                  
 37307                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37308                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5B2Eh
 37309                                  
 37310                                  $M_DISPLAY_MESSAGE:
 37311                                  ; $DO						;;AN000;; Note: DS:SI -> message
 37312                                  $MDO165:
 37313 000058A2 31D2                    	xor	dx,dx				;;AN000;; Set size = 0
 37314 000058A4 09C9                    	or	cx,cx				;;AN000;; Are we finished the message yet?
 37315                                  ;; $IF NZ					;;AN000;; No
 37316 000058A6 741F                    	jz	short $MIF166			;;AN000;; Yes
 37317                                  	;mov	ah,"%"				;;AN000;; Prepare to scan for %
 37318                                  	;mov	al,0				;;AN004;;
 37319                                  	; 12/08/2024
 37320 000058A8 B80025                  	mov	ax,2500h
 37321                                  ;; $DO						;;AN000;; Scan through string until %
 37322                                  $MDO167:
 37323 000058AB 263825                  	cmp	byte [es:di],ah			;;AN000;; Is this character NOT a %
 37324                                  ;; $LEAVE E,AND					;;AN000;; No
 37325 000058AE 750A                    	jne	short $MLL168
 37326 000058B0 26386501                	cmp	byte [es:di+1],ah		;;AN000;; Is the next character also a %
 37327                                  ;; $LEAVE NE,AND				;;AN000;; No
 37328 000058B4 7404                    	je	short $MLL168
 37329                                  
 37330 000058B6 38E0                    	cmp	al,ah				;;AN000;; Was the character before a %
 37331                                  ;; $LEAVE NE					;;AN000;; No, GREAT found it
 37332 000058B8 750D                    	jne	short $MEN167 ; 12/08/2024
 37333                                  $MLL168:
 37334 000058BA 268A05                  	mov	al,[es:di]			;;AN004;; Yes, (to any of the above)
 37335 000058BD E870FF                  	call	$M_IS_IT_DBCS			;;AN004;; Is this character the first part of a DBCS?
 37336                                  ;;; $IF C					;;AN004;; Yes
 37337 000058C0 7301                    	jnc	short $MIF169
 37338 000058C2 47                      	inc	di				;;AN004;; Increment past second part
 37339                                  ;;; $ENDIF					;;AN004;;
 37340                                  $MIF169:
 37341 000058C3 47                      	inc	di				;;AN000;; Next character in string
 37342 000058C4 42                      	inc	dx				;;AN000;; Size = Size + 1
 37343                                  	;dec	cx				;;AN000;; Decrement total size
 37344                                  ;; $ENDDO Z					;;AN000;; Exit scan if we're at the end of the line
 37345                                  	;jnz	short $MDO167
 37346                                  	; 12/08/2024
 37347 000058C5 E2E4                    	loop	$MDO167
 37348                                  $MEN167:
 37349                                  ;; $ENDIF					;;AN000;;
 37350                                  $MIF166:
 37351 000058C7 56                      	push	si				;;AN000;; Save beginning of sublists
 37352 000058C8 87D1                    	xchg	cx,dx				;;AN000;; Get size of message to display (tot sz in DX)
 37353 000058CA 09ED                    	or	bp,bp				;;AN000;; Do we have any replacables to do?
 37354                                  ;; $IF NZ					;;AN000;; Yes
 37355 000058CC 7431                    	jz	short $MIF173
 37356 000058CE 4D                      	dec	bp				;;AN000;; Decrement number of replacables
 37357                                  
 37358                                  ;; Search through sublists to find applicable one
 37359                                  
 37360 000058CF 833E[DC98]00            	cmp	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 37361                                  	;cmp	word [$M_RT+72],0		;;AN000;; Is this an Extended/Parse case
 37362                                  ;;; $IF E					;;AN000;; No
 37363 000058D4 7529                    	jne	short $MIF174
 37364                                  ;;; $SEARCH					;;AN000;;
 37365                                  $MDO175:
 37366                                  	;mov	al,$M_SL.$M_S_ID ;$M_SL=DS:[SI]	;;AN000;; Get ID byte
 37367 000058D6 8A4406                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_ID]
 37368                                  	;mov	al,[si+6]
 37369 000058D9 0430                    	add	al,30h				;;AN000;; Convert to ASCII
 37370                                  	; 28/04/2023					
 37371 000058DB 263A4501                	cmp	al,[es:di+1]			;;AN000;; Is this the right sublist?
 37372                                  ;;; $EXITIF E					;;AN000;;
 37373                                  	;jne	short $MIF175
 37374                                  ;;; $ORELSE					;;AN000;; No
 37375                                  	;jmp	short $MSR175
 37376                                  	; 28/04/2023
 37377 000058DF 741E                    	je	short $MSR175
 37378                                  $MIF175:
 37379 000058E1 3C30                    	cmp	al,30h ; $M_SPECIAL_CASE	;;AN000;; Does this sublist have ID = 0
 37380                                  ;;; $LEAVE E,AND				;;AN000;; Yes
 37381 000058E3 7504                    	jne	short $MLL178
 37382 000058E5 09D2                    	or	dx,dx				;;AN000;; Are we at the end of the message?
 37383                                  ;;; $LEAVE Z					;;AN000;; No
 37384 000058E7 7404                    	jz	short $MEN175
 37385                                  $MLL178:
 37386                                  	;add	si,$M_SL.$M_S_SIZE		;;AN000;; Next SUBLIST
 37387                                  	;add	si,[si+$M_SUBLIST_STRUC.$M_S_SIZE] ; [si+0]
 37388                                  	;;add	si,[si+0]
 37389 000058E9 0334                    	add	si,[si]
 37390                                  ;;; ENDLOOP					;;AN000;; Yes
 37391 000058EB EBE9                    	jmp	short $MDO175
 37392                                  $MEN175:
 37393 000058ED 803E[D998]FF            	cmp	byte [$M_RT+$M_RES_ADDRS.$M_CLASS],utility_msg_class
 37394                                  	;cmp	byte [$M_RT+69],0FFh		;;AN004;; Is it a utility message?
 37395                                  ;;;; $IF E					;;AN004;; Yes
 37396 000058F2 7508                    	jne	short $MIF180
 37397 000058F4 42                      	inc	dx				;;AN000;; Remember to display CR,LF
 37398 000058F5 42                      	inc	dx				;;AN000;;  at the end of the message
 37399 000058F6 49                      	dec	cx				;;AN000;; Adjust message length
 37400 000058F7 49                      	dec	cx				;;AN000;;
 37401 000058F8 4F                      	dec	di				;;AN000;; Adjust ending address of message
 37402 000058F9 4F                      	dec	di				;;AN000;;
 37403                                  ;;;; $ELSE					;;AN004;; No
 37404 000058FA EB03                    	jmp	short $MEN180
 37405                                  $MIF180:
 37406 000058FC BAFFFF                  	mov	dx,-1 				;;AN004;; Set special case
 37407                                  ;;;; $ENDIF					;;AN004;;
 37408                                  $MEN180:
 37409                                  ;;; $ENDSRCH					;;AN000;;
 37410                                  $MSR175:
 37411                                  ;; $ENDIF					;;AN000;;
 37412                                  $MIF174:
 37413                                  ; $ENDIF					;;AN000;;
 37414                                  $MIF173:
 37415                                  ;; Prepare and display this part of message
 37416                                  
 37417 000058FF 57                      	push	di				;;AN000;; Save pointer to replace number
 37418 00005900 29CF                    	sub	di,cx				;;AN000;; Determine beginning of string
 37419 00005902 E835FE                  	call	$M_DISPLAY_STRING		;;AN000;; Display string until % (or end)
 37420 00005905 5F                      	pop	di				;;AN000;; Get back pointer to replace number
 37421 00005906 59                      	pop	cx				;;AN000;; Clean up stack in case error
 37422                                  ; $LEAVE C,LONG					;;AN000;; Fail if carry was set
 37423                                  	;jnc	short $MXL3
 37424                                  	;jmp	$MEN165
 37425                                  	; 02/05/2023
 37426 00005907 7214                    	jc	short $MEN165
 37427                                  $MXL3:
 37428 00005909 51                      	push	cx				;;AN000;;
 37429                                  
 37430                                  ;; Save and reset pointer registers
 37431                                  
 37432 0000590A 89D1                    	mov	cx,dx				;;AN000;; Get the size of the rest of the message
 37433                                  	;cmp	$M_SL.$M_S_ID,$M_SPECIAL_CASE-30h
 37434 0000590C 807C0600                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_ID],0 ; $M_SPECIAL_CASE-30h
 37435                                  	;cmp	byte [si+6],0 			;;AN000;; Is this the %0 case?
 37436                                  ; $IF NE					;;AN000;; No
 37437 00005910 7412                    	je	short $MIF187			;;AN000;; Yes			
 37438 00005912 09C9                    	or	cx,cx				;;AN000;; Are we finished the whole message?
 37439                                  ;; $IF NZ					;;AN000;; No
 37440 00005914 7406                    	jz	short $MIF188			;;AN000;; Yes
 37441 00005916 49                      	dec	cx				;;AN000;; Decrement total size (%)
 37442 00005917 49                      	dec	cx				;;AN000;; Decrement total size (#)
 37443 00005918 47                      	inc	di				;;AN000;; Go past %
 37444 00005919 47                      	inc	di				;;AN000;; Go past replace number
 37445                                  ;; $ELSE					;;AN000;; Yes, (Note this will not leave because INC)
 37446                                  	;jmp	short $MEN188
 37447                                  	; 28/04/2023
 37448 0000591A EB15                    	jmp	short $MEN187
 37449                                  $MIF188:
 37450 0000591C 5E                      	pop	si				;;AN000;; Get back pointer to beginning of SUBLISTs
 37451                                  ;; $ENDIF					;;AN000;; Yes, Note this will not leave because INC
 37452                                  $MEN188:
 37453                                  ; $ELSE 					;;AN000;;
 37454                                  	;jmp	short $MEN187
 37455                                  	; 28/04/2023
 37456                                  	; zf = 1
 37457                                  	;jmp	short $MEN165 
 37458                                  
 37459                                  ; 28/04/2023
 37460                                  $MXL4:
 37461                                  $MLL214:
 37462                                  $MEN165:
 37463 0000591D C706[DC98]0000          	mov	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0
 37464                                  	;mov	word [$M_RT+72],0		;;AN000;; IF there was an error displaying then EXIT
 37465                                  						;;AN000;; Reset message number to null
 37466 00005923 C3                      	retn					;;AN000;; Return
 37467                                  
 37468                                  $MIF187:
 37469 00005924 09C9                    	or	cx,cx				;;AN000;; Are we finished the whole message?
 37470                                  ;; $IF Z					;;AN004;; No
 37471                                  	;jnz	short $MIF192
 37472                                  	;pop	si				;;AN000;; Get back pointer to beginning of SUBLISTs
 37473                                  ;; $ELSE					;;AN000;; No
 37474                                  	;jmp	short $MEN192
 37475                                  	; 28/04/2023
 37476 00005926 74F4                    	jz	short $MIF188
 37477                                  $MIF192:
 37478 00005928 83F9FF                  	cmp	cx,-1				;;AN004;; Are we at the end of the message?
 37479                                  ;;; $IF Z					;;AN004;; No
 37480 0000592B 7502                    	jnz	short $MIF194
 37481 0000592D 31C9                    	xor	cx,cx				;;AN004;;
 37482                                  ;;; $ENDIF					;;AN000;;
 37483                                  $MIF194:
 37484 0000592F 09FF                    	or	di,di				;;AN004;; Turn ZF off
 37485                                  ;; $ENDIF					;;AN000;;
 37486                                  $MEN192:
 37487                                  ; $ENDIF					;;AN000;; Note this will not leave because INC
 37488                                  $MEN187:
 37489                                  ; $LEAVE Z					;;AN000;;
 37490 00005931 74EA                    	jz	short $MEN165
 37491                                  	;
 37492 00005933 55                      	push	bp				;;AN000;; Save the replace count
 37493 00005934 57                      	push	di				;;AN000;; Save location to complete message
 37494 00005935 06                      	push	es				;;AN000;;
 37495 00005936 51                      	push	cx				;;AN000;; Save size of the rest of the message
 37496 00005937 31C9                    	xor	cx,cx				;;AN000;; Reset CX used for character count
 37497                                  
 37498                                  ;; Determine what action is required on parameter
 37499                                  
 37500 00005939 833E[DC98]00            	cmp	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 37501                                  	;cmp	word [$M_RT+72],0		;;AN000;; Is this an Extended/Parse case
 37502                                  ; $IF E						;;AN000;;
 37503 0000593E 753B                    	jne	short $MIF199
 37504                                  
 37505                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Char_Type and $M_TYPE_MASK
 37506 00005940 F644070F                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Fh
 37507                                  	;test	byte [si+7],0Fh			;;AN000;;
 37508                                  ;; $IF Z					;;AN000;;
 37509 00005944 7508                    	jnz	short $MIF200
 37510                                  
 37511                                  ;; Character type requested
 37512                                  
 37513                                  	;les	di,dword ptr $M_SL.$M_S_VALUE	;;AN000;; Load pointer to replacing parameter
 37514 00005946 C47C02                  	les	di,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 37515                                  	;les	di,[si+2]
 37516 00005949 E84801                  	call	$M_CHAR_REPLACE			;;AN000;;
 37517                                  ;; $ELSE					;;AN000;; Get the rest of the message to display
 37518 0000594C EB28                    	jmp	short $MEN200
 37519                                  $MIF200:
 37520                                  ;; ENDIF					;;AN000;;
 37521                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 37522 0000594E F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 37523                                  	;test	byte [si+7],0Dh			;;AN000;;
 37524                                  ;; $IF Z,OR					;;AN000;;
 37525 00005952 740C                    	jz	short $MLL202
 37526                                  	;test	byte ptr $M_SL.$M_S_FLAG,NOT Unsgn_Bin_Type AND $M_TYPE_MASK
 37527 00005954 F644070E                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 37528                                  	;test	byte [si+7],0Eh			;;AN000;;
 37529                                  ;;; $IF Z,OR					;;AN000;;
 37530 00005958 7406                    	jz	short $MLL202
 37531                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Bin_Hex_Type and $M_TYPE_MASK
 37532 0000595A F644070C                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Ch
 37533                                  	;test	byte [si+7],0Ch			;;AN000;;
 37534                                  ;;;; $IF Z 					;;AN000;;
 37535 0000595E 7508                    	jnz	short $MIF202
 37536                                  $MLL202:
 37537                                  
 37538                                  ;; Numeric type requested
 37539                                  
 37540                                  	;les	di,dword ptr $M_SL.$M_S_VALUE	;;AN000;; Load pointer to replacing parameter
 37541 00005960 C47C02                  	les	di,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 37542                                  	;les	di,[si+2]
 37543 00005963 E85601                  	call	$M_BIN2ASC_REPLACE		;;AN000;;
 37544                                  ;;;; $ELSE					;;AN000;; Get the rest of the message to display
 37545 00005966 EB0E                    	jmp	short $MEN202
 37546                                  $MIF202:
 37547                                  ;;;; ENDIF					;;AN000;;
 37548                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Date_Type and $M_TYPE_MASK
 37549 00005968 F644070B                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Bh
 37550                                  	;test	byte [si+7],0Bh			;;AN000;;
 37551                                  ;;;; $IF E					;;AN000;;
 37552 0000596C 7505                    	jnz	short $MIF204
 37553                                  
 37554                                  ;; Date type requested
 37555                                  
 37556 0000596E E8EC01                  	call	$M_DATE_REPLACE			;;AN000;;
 37557                                  ;;;; $ELSE					;;AN000;; Get the rest of the message to display
 37558 00005971 EB03                    	jmp	short $MEN204
 37559                                  $MIF204:					;;AN000;;
 37560                                  
 37561                                  ;; Time type requested (Default if we have not matched until here)
 37562                                  
 37563 00005973 E89E02                  	call	$M_TIME_REPLACE			;;AN000;;
 37564                                  
 37565                                  ;;;; $ENDIF					;;AN000;;
 37566                                  $MEN204:
 37567                                  ;;; $ENDIF					;;AN000;;
 37568                                  $MEN202:
 37569                                  ;; $ENDIF					;;AN000;;
 37570                                  $MEN200:
 37571                                  
 37572                                  ;; With the replace information of the Stack, display the replaceable field
 37573                                  
 37574 00005976 E85F00                  	call	$M_DISPLAY_REPLACE		;;AN000;; Display the replace
 37575                                  
 37576                                  ;; None of the above - Extended/Parse replace
 37577                                  ; $ELSE 					;;AN000;;
 37578 00005979 EB03                    	jmp	short $MEN199
 37579                                  $MIF199:
 37580 0000597B E81600                  	call	$M_EXT_PAR_REPLACE		;;AN000;;
 37581                                  ; $ENDIF					;;AN000;;
 37582                                  $MEN199:
 37583                                  
 37584                                  ;; We must go back and complete the message after the replacable parameter if there is any left
 37585                                  
 37586                                  ; $IF NC					;;AN000;; IF there was an error displaying then EXIT
 37587 0000597E 7207                    	jc	short $MIF211
 37588                                  	;
 37589 00005980 59                      	pop	cx				;;AN000;; Get size of the rest of the message
 37590 00005981 07                      	pop	es				;;AN000;; Get address of the rest of the message
 37591 00005982 5F                      	pop	di				;;AN000;;
 37592 00005983 5D                      	pop	bp				;;AN000;; Get replacment count
 37593 00005984 5E                      	pop	si				;;AN000;; ELSE get address of first sublist structure
 37594                                  ; $ELSE						;;AN000;;
 37595 00005985 EB03                    	jmp	short $MEN211
 37596                                  $MIF211:
 37597 00005987 83C40A                  	add	sp,10				;;AN000;; Clean up stack if error
 37598                                  	; 28/04/2023
 37599                                  	;stc					;;AN000;;
 37600                                  ; $ENDIF					;;AN000;;
 37601                                  $MEN211:
 37602 0000598A 833E[DC98]00            	cmp	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 37603                                  	;cmp	word [$M_RT+72],0		;;AN000;; Is this an Extended/Parse case
 37604                                  ; $ENDDO NE,OR					;;AN000;;
 37605 0000598F 758C                    	jne	short $MLL214
 37606                                  ; $ENDDO C,LONG					;;AN000;; Go back and display the rest of the message
 37607                                  	; 10/04/2023
 37608                                  	;jc	short $MXL4
 37609 00005991 E90EFF                  	jmp	$MDO165
 37610                                  
 37611                                  ; 28/04/2023
 37612                                  ;$MXL4:
 37613                                  ;$MLL214:
 37614                                  ;$MEN165:
 37615                                  ;	mov	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0
 37616                                  ;	;mov	word [$M_RT+72],0		;;AN000;; IF there was an error displaying then EXIT
 37617                                  ;						;;AN000;; Reset message number to null
 37618                                  ;	retn					;;AN000;; Return
 37619                                  
 37620                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37621                                  ;;
 37622                                  ;;	PROC NAME: $M_EXT_PAR_REPLACE
 37623                                  ;;
 37624                                  ;;	FUNCTION:
 37625                                  ;;	INPUTS:
 37626                                  ;;	OUPUTS:
 37627                                  ;;
 37628                                  ;;	REGS USED:
 37629                                  ;;
 37630                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37631                                  
 37632                                  	; 11/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37633                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37634                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37635                                  
 37636                                  $M_EXT_PAR_REPLACE:
 37637 00005994 31D2                    	xor	dx,dx				;;AN000;; Prepare for get binary value (HIGH)
 37638 00005996 A1[DC98]                	mov	ax,[$M_RT+$M_RES_ADDRS.$M_MSG_NUM]
 37639                                  	;mov	ax,[$M_RT+72]			;;AN000;; Prepare for get binary value (LOW)
 37640 00005999 C706[DE98]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37641                                  	;mov	word [$M_RT+74],10 ; $M_BASE10	;;AN000;; Set default divisor
 37642 0000599F E8B2FE                  	call	$M_CONVERT2ASC			;;AN000;;
 37643                                  $MDO215:
 37644 000059A2 58                      	pop	ax				;;AN000;; Get character in register
 37645 000059A3 8887[E098]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37646                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move char into the buffer
 37647 000059A7 43                      	inc	bx				;;AN000;; Increase buffer count
 37648 000059A8 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ ; cmp bx,64	;;AN000;; Is buffer full?
 37649 000059AB 7503                    	jne	short $MIF216			;;AN000;; No
 37650 000059AD E80D00                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37651                                  $MIF216:
 37652 000059B0 FEC9                    	dec	cl				;;AN000;; Have we completed replace?
 37653 000059B2 75EE                    	jnz	short $MDO215
 37654                                  
 37655 000059B4 B80D0A                  	mov	ax,0A0Dh ; mov ax,$M_CR_LF	;;AN000;; Move char into the buffer
 37656 000059B7 8987[E098]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],ax
 37657                                  	;;mov	[bx+$M_RT+76],ax		;;AN000;; Move char into the buffer
 37658 000059BB 43                      	inc	bx				;;AN000;; Increase buffer count
 37659 000059BC 43                      	inc	bx				;;AN000;; Increase buffer count
 37660                                  	;call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37661                                  	;retn					;;AN000::
 37662                                  	; 11/04/2023
 37663                                  	;jmp	$M_FLUSH_BUF
 37664                                  
 37665                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37666                                  ;;
 37667                                  ;;	PROC NAME: $M_FLUSH_BUFFER
 37668                                  ;;
 37669                                  ;;	FUNCTION: Display the contents of the temporary buffer
 37670                                  ;;	INPUTS: DI contains the number of bytes to display
 37671                                  ;;	OUTPUTS: BX reset to zero
 37672                                  ;;
 37673                                  ;;	REGS USED:
 37674                                  ;;
 37675                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37676                                  	
 37677                                  	; 11/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37678                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:56C8h
 37679                                  
 37680                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37681                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5E95h
 37682                                  
 37683                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37684                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5D1Bh
 37685                                  $M_FLUSH_BUF:
 37686 000059BD 51                      	push	cx				;;AN000;; Save changed regs
 37687 000059BE 06                      	push	es				;;AN000;;
 37688 000059BF 57                      	push	di				;;AN000;;
 37689 000059C0 1E                      	push	ds				;;AN000;; Set ES pointing to buffer
 37690 000059C1 07                      	pop	es				;;AN000;;
 37691 000059C2 89D9                    	mov	cx,bx				;;AN000;; Set number of bytes to display
 37692 000059C4 31DB                    	xor	bx,bx				;;AN000;; Reset buffer counter
 37693 000059C6 8D3E[E098]              	lea	di,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 37694                                  	;lea	di,[$M_RT+76]			;;AN000;; Reset buffer location pointer
 37695 000059CA E86DFD                  	call	$M_DISPLAY_STRING		;;AN000;; Display the buffer
 37696 000059CD 7204                    	jc	short $MIF314
 37697 000059CF 5F                      	pop	di				;;AN000;; No, Restore changed regs
 37698 000059D0 07                      	pop	es				;;AN000;;
 37699 000059D1 59                      	pop	cx				;;AN000;;
 37700                                  	;jmp	short $MEN314
 37701                                  	; 11/04/2023
 37702 000059D2 C3                      	retn
 37703                                  $MIF314:
 37704 000059D3 83C406                  	add	sp,6				;;AN000;; Fix stack
 37705 000059D6 F9                      	stc					;;AN000;;
 37706                                  $MEN314:
 37707 000059D7 C3                      	retn					;;AN000;; Return
 37708                                  
 37709                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37710                                  ;;
 37711                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37712                                  
 37713                                  	; 11/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37714                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5609h
 37715                                  
 37716                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37717                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5DD6h
 37718                                  
 37719                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37720                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5C5Ch
 37721                                  $M_DISPLAY_REPLACE:
 37722 000059D8 31DB                    	xor	bx,bx				;;AN000;; Use BX for buffer count
 37723                                  	;;cmp	$M_SL.$M_S_ID,$M_SPECIAL_CASE-30h ; 0
 37724 000059DA 807C0600                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_ID],0	
 37725                                  	;cmp	byte [si+6],0			;;AN000;; Is this the special case (convert to ASCII)
 37726 000059DE 7511                    	jne	short $MIF276
 37727                                  	
 37728 000059E0 C787[E098]202D          	mov	word [bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],2D20h ; $M_SPACE_HYP
 37729                                  	;mov	word [bx+$M_RT+76],2D20h	;;AN000;; Move in a " -"
 37730                                  	
 37731 000059E6 43                      	inc	bx				;;AN000;; Increment count
 37732 000059E7 43                      	inc	bx				;;AN000;; Increment count
 37733                                  	
 37734 000059E8 C687[E098]20            	mov	byte [bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],20h ; $M_SPACE
 37735                                  	;mov	byte [bx+$M_RT+76],20h		;;AN000;; Move in a " "
 37736                                  	
 37737 000059ED 43                      	inc	bx				;;AN000;; Increment count
 37738 000059EE E8CCFF                  	call	$M_FLUSH_BUF			;;AN000;; Write out " - " to prepare for special case
 37739                                  $MIF276:
 37740 000059F1 5D                      	pop	bp				;;AN000;; Remember the return address
 37741 000059F2 31DB                    	xor	bx,bx				;;AN000;; Use BX for buffer count
 37742 000059F4 31D2                    	xor	dx,dx				;;AN000;; Use DX for count of parms taken off the stack
 37743                                  
 37744 000059F6 880E[D698]              	mov	[$M_RT+$M_RES_ADDRS.$M_SIZE],cl	;;AN000;; Save size to later clear stack
 37745                                  	;mov	[$M_RT+66],cl
 37746                                  	
 37747                                  	;mov	al,byte ptr $M_SL.$M_S_MINW	;;AN000;; Get the minimum width
 37748 000059FA 8A4409                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_MINW]
 37749                                  	;mov	al,[si+9]
 37750                                  	
 37751 000059FD 38C8                    	cmp	al,cl				;;AN000;; Do we need pad chars added?
 37752 000059FF 761E                    	jna	short $MIF278
 37753 00005A01 28C8                    	sub	al,cl				;;AN000;; Calculate how many pad chars are needed.
 37754 00005A03 88C6                    	mov	dh,al				;;AN000;; Save the number of pad characters
 37755                                  	
 37756                                  	;test	byte ptr $M_SL.$M_S_FLAG,Right_Align
 37757 00005A05 F6440780                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],80h
 37758                                  	;test	byte [si+7],80h			;;AN000;; Was replaceable parm to be right aligned?
 37759 00005A09 7414                    	jz	short $MIF279			;;AN000;; No
 37760                                  $MDO280:
 37761                                  	;mov	al,byte ptr $M_SL.$M_S_PAD	;;AN000;;
 37762 00005A0B 8A440A                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_PAD]
 37763                                  	;mov	al,[si+0Ah]
 37764 00005A0E 8887[E098]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37765                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move in a pad char
 37766                                  	
 37767 00005A12 43                      	inc	bx				;;AN000;;
 37768 00005A13 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ ; 64		;;AN000;; Is buffer full?
 37769 00005A16 7503                    	jne	short $MIF281
 37770 00005A18 E8A2FF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37771                                  $MIF281:
 37772 00005A1B FECE                    	dec	dh				;;AN000;; Have we filled with enough pad chars?
 37773 00005A1D 75EC                    	jnz	short $MDO280
 37774                                  $MIF279:
 37775                                  $MIF278:
 37776                                  	;cmp	byte ptr $M_SL.$M_S_MAXW,$M_UNLIM_W
 37777 00005A1F 807C0800                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_MAXW],0 ; $M_UNLIM_W
 37778                                  	;cmp	byte [si+8],0			;;AN000;; Is maximum width unlimited
 37779 00005A23 740C                    	je	short $MIF286
 37780                                  	
 37781                                  	;cmp	byte ptr $M_SL.$M_S_MAXW,CL	;;AN000;; Will we exceed maximum width?
 37782 00005A25 384C08                  	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_MAXW],cl
 37783                                  	;;cmp	byte [si+8],cl
 37784 00005A28 7307                    	jnb	short $MIF287
 37785                                  
 37786                                  	; 03/05/2023
 37787                                  	;;sub	cl,byte ptr $M_SL.$M_S_MAXW	;;AN000;; Calculate how many extra chars
 37788                                  	;sub	cl,[si+$M_SUBLIST_STRUC.$M_S_MAXW]
 37789                                  	;;sub	cl,[si+8]
 37790 00005A2A 88CA                    	mov	dl,cl				;;AN000;; Remember how many chars to pop off
 37791                                  	;;mov	cl,byte ptr $M_SL.$M_S_MAXW	;;AN000;; Set new string length
 37792                                  	;mov	cl,[si+$M_SUBLIST_STRUC.$M_S_MAXW]
 37793                                  	;;mov	cl,[si+8]
 37794                                  	; 03/05/2023
 37795 00005A2C 8A4C08                  	mov	cl,[si+$M_SUBLIST_STRUC.$M_S_MAXW]
 37796 00005A2F 28CA                    	sub	dl,cl
 37797                                  $MIF287:
 37798                                  $MIF286:
 37799 00005A31 09C9                    	or	cx,cx				;;AN000;;
 37800 00005A33 7424                    	jz	short $MIF290			;;AN000;;
 37801                                  $MDO291:
 37802                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Char_Type not $M_TYPE_MASK
 37803 00005A35 F644070F                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Fh
 37804                                  	;test	byte [si+7],0Fh			;;AN000;;
 37805 00005A39 750C                    	jnz	short $MIF292
 37806                                  
 37807                                  	;test	$M_SL.$M_S_FLAG,Char_field_ASCIIZ and $M_SIZE_MASK
 37808 00005A3B F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 37809                                  	;test	byte [si+7],10h			;;AN000;; Is this replace a ASCIIZ string?			 
 37810 00005A3F 7406                    	jz	short $MIF292			;;AN000;; No
 37811                                  
 37812 00005A41 268A05                  	mov	al,[es:di]			;;AN000;; Get first character from string
 37813 00005A44 47                      	inc	di				;;AN000;; Next character in string
 37814 00005A45 EB01                    	jmp	short $MEN292
 37815                                  $MIF292:
 37816 00005A47 58                      	pop	ax				;;AN000;; Get character in register
 37817                                  $MEN292:
 37818                                  	;mov	byte ptr $M_RT.$M_TEMP_BUF[bx],al
 37819 00005A48 8887[E098]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37820                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move char into the buffer
 37821                                  	; 03/05/2023
 37822 00005A4C 43                      	inc	bx				;;AN000;; Increase buffer count
 37823 00005A4D 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ ; cmp bx,64	;;AN000;; Is buffer full?
 37824 00005A50 7503                    	jne	short $MIF295			;;AN000;;
 37825 00005A52 E868FF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37826                                  $MIF295:
 37827 00005A55 FEC9                    	dec	cl				;;AN000;; Have we completed replace?
 37828 00005A57 75DC                    	jnz	short $MDO291
 37829                                  $MIF290:
 37830                                  	;test	byte ptr $M_SL.$M_S_FLAG,Right_Align
 37831 00005A59 F6440780                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],80h
 37832                                  	;test	byte [si+7],80h			;;AN000;; Was replaceable parm to be left aligned?
 37833 00005A5D 7518                    	jnz	short $MIF299			;;AN000;; Yes
 37834 00005A5F 08F6                    	or	dh,dh				;;AN000;; Do we need pad chars added?
 37835 00005A61 7414                    	jz	short $MIF300
 37836                                  $MDO301:
 37837                                  	;mov	al,byte ptr $M_SL.$M_S_PAD	;;AN000;;
 37838 00005A63 8A440A                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_PAD]
 37839                                  	;mov	al,[si+0Ah]
 37840                                  
 37841                                  	;mov	byte ptr $M_RT.$M_TEMP_BUF[bx],al
 37842 00005A66 8887[E098]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37843                                  	; 03/05/2023
 37844                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move in a pad char
 37845                                  
 37846 00005A6A 43                      	inc	bx				;;AN000;;
 37847 00005A6B 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ  ; 64		;;AN000;; Is buffer full?
 37848 00005A6E 7503                    	jne	short $MIF302			;;AN000;; No
 37849                                  						;;AN000;; Yes
 37850 00005A70 E84AFF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37851                                  $MIF302:
 37852 00005A73 FECE                    	dec	dh				;;AN000;; Have we filled with enough pad chars?
 37853 00005A75 75EC                    	jnz	short $MDO301			;;AN000;;
 37854                                  $MIF300:
 37855                                  $MIF299:
 37856                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Char_Type and $M_TYPE_MASK
 37857 00005A77 F644070F                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Fh
 37858                                  	;test	byte [si+7],0Fh			;;AN000;;
 37859 00005A7B 7506                    	jnz	short $MIF307
 37860                                  	
 37861                                  	;test	$M_SL.$M_S_FLAG,Char_field_ASCIIZ and $M_SIZE_MASK
 37862 00005A7D F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 37863                                  	;test	byte [si+7],10h			;;AN000;; Is this replace a ASCIIZ string?
 37864                                  	; 11/04/2023
 37865                                  	;jz	short $MIF307			;;AN000;;
 37866                                  	;jmp	short $MEN307			;;AN000;;
 37867 00005A81 750C                    	jnz	short $MEN307
 37868                                  $MIF307:
 37869 00005A83 08D2                    	or	dl,dl				;;AN000;;
 37870 00005A85 7408                    	jz	short $MIF309			;;AN000;;
 37871                                  $MDO310:
 37872 00005A87 8F06[DA98]              	pop	word [$M_RT+$M_RES_ADDRS.$M_RETURN_ADDR]
 37873                                  	;pop	word [$M_RT+70]			;;AN000;; Clean Up stack using spare variable
 37874 00005A8B FECA                    	dec	dl				;;AN000;; Are we done?
 37875 00005A8D 75F8                    	jnz	short $MDO310
 37876                                  $MIF309:
 37877                                  $MEN307:
 37878 00005A8F E82BFF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer for the final time
 37879 00005A92 55                      	push	bp				;;AN000;; Restore the return address
 37880 00005A93 C3                      	retn					;;AN000;;
 37881                                  
 37882                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37883                                  ;;
 37884                                  ;;	PROC NAME: $M_CHAR_REPLACE
 37885                                  ;;
 37886                                  ;;	FUNCTION: Will prepare a single char or ASCIIZ string for replace
 37887                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 37888                                  ;;		ES:DI contains the VALUE from SUBLIST
 37889                                  ;;	OUTPUTS: CX contains number of characters on stack
 37890                                  ;;		 Top of stack  --> Last character
 37891                                  ;;					. . .
 37892                                  ;;		 Bot of stack  --> First character
 37893                                  ;;
 37894                                  ;;	OTHER REGS Revised: AX
 37895                                  ;;
 37896                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37897                                  
 37898                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37899                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37900                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37901                                  $M_CHAR_REPLACE:
 37902 00005A94 5D                      	pop	bp				;;AN000;; Save return address
 37903                                  	;test	$M_SL.$M_S_FLAG,not Char_Field_Char and $M_SIZE_MASK
 37904 00005A95 F6440730                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],30h
 37905                                  	;test	byte [si+7],30h			;;AN000;; Was Character specified?
 37906 00005A99 7512                    	jnz	short $MIF317			;;AN000;; No
 37907 00005A9B 268A05                  	mov	al,[es:di]			;;AN000;; Get the character
 37908 00005A9E 50                      	push	ax				;;AN000;; Put it on the stack
 37909 00005A9F 41                      	inc	cx				;;AN000;; Increase the count
 37910 00005AA0 E88DFD                  	call	$M_IS_IT_DBCS			;;AN000;; Is this the first byte of a DB character
 37911 00005AA3 7306                    	jnc	short $MIF318
 37912 00005AA5 268A4501                	mov	al,[es:di+1]			;;AN000;; Get the next character
 37913 00005AA9 50                      	push	ax				;;AN000;; Put it on the stack
 37914 00005AAA F8                      	clc					;;AN000;; Clear the carry
 37915                                  $MIF318:
 37916 00005AAB EB0D                    	jmp	short $MEN317
 37917                                  $MIF317:
 37918                                  $MDO321:
 37919 00005AAD 268A05                  	mov	al,[es:di]			;;AN000;; Get the character
 37920 00005AB0 08C0                    	or	al,al				;;AN000;; Is it the NULL?
 37921 00005AB2 7404                    	jz	short $MEN321			;;AN000;; Yes
 37922 00005AB4 47                      	inc	di				;;AN000;; Next character
 37923 00005AB5 41                      	inc	cx				;;AN000;; Increment the count
 37924 00005AB6 EBF5                    	jmp	short $MDO321
 37925                                  $MEN321:
 37926 00005AB8 29CF                    	sub	di,cx				;;AN000;; Set DI at the beginning of the string
 37927                                  $MEN317:
 37928 00005ABA 55                      	push	bp				;;AN000;; Restore return address
 37929 00005ABB C3                      	retn					;;AN000;;	
 37930                                  
 37931                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37932                                  ;;
 37933                                  ;;	PROC NAME: $M_BIN2ASC_REPLACE
 37934                                  ;;
 37935                                  ;;	FUNCTION: Convert a signed or unsigned binary number to an ASCII string
 37936                                  ;;		  and prepare to display
 37937                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 37938                                  ;;		ES:DI contains the VALUE from SUBLIST
 37939                                  ;;	OUTPUTS: CX contains number of characters on stack
 37940                                  ;;		 Top of stack  --> Last character
 37941                                  ;;					. . .
 37942                                  ;;		 Bot of stack  --> First character
 37943                                  ;;	OTHER REGS Revised: BX,DX,AX
 37944                                  ;;
 37945                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37946                                  
 37947                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37948                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37949                                  	; 12/08/2024 - Retro DOS v5.0 COMMAND.COM
 37950                                  $M_BIN2ASC_REPLACE:
 37951 00005ABC 5D                      	pop	bp				;;AN000;; Save return address
 37952 00005ABD 31D2                    	xor	dx,dx				;;AN000;; Prepare for get binary value (HIGH)
 37953 00005ABF 31C0                    	xor	ax,ax				;;AN000;; Prepare for get binary value (LOW)
 37954 00005AC1 C706[DE98]1000          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],16 ; $M_BASE16
 37955                                  	;mov	word [$M_RT+74],16  ; $M_BASE16	;;AN000;; Set default divisor
 37956                                  
 37957 00005AC7 31DB                    	xor	bx,bx				;;AN000;; Use BX as the NEG flag (if applicable)
 37958                                  
 37959                                  	;test	$M_SL.$M_S_FLAG,not $M_BYTE and $M_SIZE_MASK
 37960 00005AC9 F6440720                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],20h
 37961                                  	;test	byte [si+7],20h			;;AN000;; Was BYTE specified?		
 37962 00005ACD 7511                    	jnz	short $MIF325			;;AN000;; No
 37963                                  	
 37964 00005ACF 268A05                  	mov	al,[es:di]			;;AN000;; Setup byte in AL
 37965                                  
 37966                                  	;test	$M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 37967 00005AD2 F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 37968                                  	;test	byte [si+7],0Dh			;;AN000;; Was Signed binary specified?
 37969 00005AD6 753D                    	jnz	short $MIF326			;;AN000;; No
 37970                                  			 
 37971 00005AD8 A880                    	test	al,10000000b ; 80h		;;AN000;; Is this number negative?
 37972 00005ADA 7433                    	jz	short $MIF327			;;AN000;; No
 37973                                  						;;AN000;; Yes				
 37974                                  	; 12/04/2023
 37975                                  	;inc	bx				;;AN000;; Remember that it was negative
 37976 00005ADC 247F                    	and	al,01111111b			;;AN000;; Make it positive
 37977                                  
 37978                                  	; 12/04/2023 - Retrop DOS v4.0 COMMAND.COM
 37979                                  	;jmp	short $MIF327
 37980 00005ADE EB2E                    	jmp	short $MIF350 ; inc bx
 37981                                  
 37982                                  ; 12/04/2023
 37983                                  %if 0
 37984                                  $MIF327:
 37985                                  $MIF335:	; 12/04/2023
 37986                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37987                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37988                                  $MIF326:
 37989                                  	;test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK
 37990                                  	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 37991                                  	;test	byte [si+7],0Eh			;;AN000;; Was Signed binary specified?
 37992                                  	jnz	short $MIF330			;;AN000;; No
 37993                                  						;;AN000;; Yes
 37994                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37995                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37996                                  $MIF330:
 37997                                  	jmp	short $MEN325
 37998                                  
 37999                                  %endif
 38000                                  
 38001                                  $MIF325:
 38002                                  	;test	$M_SL.$M_S_FLAG,not $M_WORD and $M_SIZE_MASK
 38003 00005AE0 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 38004                                  	;test	byte [si+7],10h			;;AN000;; Was WORD specified?
 38005 00005AE4 7513                    	jnz	short $MIF333			;;AN000;; No
 38006                                  						;;AN000;; Yes
 38007 00005AE6 268B05                  	mov	ax,[es:di]			;;AN000;; Setup byte in AL
 38008                                  
 38009                                  	;test	$M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 38010 00005AE9 F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 38011                                  	;test	byte [si+7],0Dh			;;AN000;; Was Signed binary specified?	
 38012 00005AED 7526                    	jnz	short $MIF334			;;AN000;; No
 38013                                  						;;AN000;; Yes
 38014 00005AEF F6C480                  	test	ah,10000000b ; 80h		;;AN000;; Is this number negative?
 38015 00005AF2 741B                    	jz	short $MIF335			;;AN000;; No
 38016                                  						;;AN000;; Yes
 38017                                  	; 12/04/2023
 38018                                  	;inc	bx				;;AN000;; Remember that it was negative
 38019 00005AF4 80E47F                  	and	ah,01111111b			;;AN000;; Make it positive
 38020                                  
 38021                                  	; 12/04/2023 - Retro DOS v4.0 COMMAND.COM
 38022                                  	;jmp	short $MIF335
 38023 00005AF7 EB15                    	jmp	short $MIF350 ; inc bx
 38024                                  
 38025                                  ; 12/04/2023
 38026                                  %if 0
 38027                                  $MIF335:
 38028                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 38029                                  	;mov	word [$M_RT+74],10		;;AN000;;
 38030                                  $MIF334:
 38031                                  	test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK ;;AN000;; Was Signed binary specified?
 38032                                  	jnz	short $MIF338
 38033                                  
 38034                                  	;test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK
 38035                                  	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 38036                                  	;test	byte [si+7],0Eh			;;AN000;; Was Signed binary specified?
 38037                                  	jnz	short $MIF338			;;AN000;; No
 38038                                  						;;AN000;; Yes
 38039                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 38040                                  	;mov	word [$M_RT+74],10		;;AN000;;
 38041                                  $MIF338:
 38042                                  	jmp	short $MEN333			;;AN000;;
 38043                                  %endif
 38044                                  
 38045                                  $MIF333:
 38046 00005AF9 268B05                  	mov	ax,[es:di]			;;AN000;; Setup Double word in DX:AX
 38047 00005AFC 268B5502                	mov	dx,[es:di+2]			;;AN000;;
 38048                                  
 38049                                  	;test	$M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 38050 00005B00 F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 38051                                  	;test	byte [si+7],0Dh			;;AN000;; Was Signed binary specified?	
 38052 00005B04 750F                    	jnz	short $MIF341			;;AN000;; No
 38053                                  						;;AN000;; Yes
 38054 00005B06 F6C680                  	test	dh,10000000b ; 80h		;;AN000;; Is this number negative?
 38055 00005B09 7404                    	jz	short $MIF342			;;AN000;; No
 38056                                  						;;AN000;; Yes
 38057                                  	; 12/04/2023
 38058                                  	;inc	bx				;;AN000;; Remember that it was negative
 38059 00005B0B 80E67F                  	and	dh,01111111b			;;AN000;; Make it positive
 38060                                  	
 38061                                  	; 12/04/2023 - Retro DOS v4.0 COMMAND.COM
 38062                                  $MIF350:
 38063 00005B0E 43                      	inc	bx
 38064                                  $MIF342:
 38065                                  	; 12/04/2023
 38066                                  $MIF327:
 38067                                  $MIF335:
 38068 00005B0F C706[DE98]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 38069                                  	;mov	word [$M_RT+74],10		;;AN000;;
 38070                                  $MIF341:
 38071                                  $MIF326:
 38072                                  	; 18/04/2023
 38073                                  $MIF334:
 38074                                  	;test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK
 38075 00005B15 F644070E                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 38076                                  	;test	byte [si+7],0Eh			;;AN000;; Was Signed binary specified?
 38077 00005B19 7506                    	jnz	short $MIF345			;;AN000;; No
 38078                                  						;;AN000;; Yes
 38079 00005B1B C706[DE98]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 38080                                  	;mov	word [$M_RT+74],10		;;AN000;;
 38081                                  
 38082                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38083                                  	; ****************************************
 38084                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5F64h
 38085                                  $MIF345:
 38086                                  	; *** (Disassembled MSDOS 6.22 COMMAND.COM source code.)
 38087                                  $MEN333:
 38088 00005B21 F6440740                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],40h
 38089                                  	;test	byte [si+7],40h		; MSDOS 6.22
 38090                                  				; (Custom/International flag for thousand separator)
 38091 00005B25 7428                    	jz	short $MEN325
 38092 00005B27 50                      	push	ax			; MSDOS 6.22
 38093 00005B28 52                      	push	dx
 38094 00005B29 B438                    	mov	ah,38h	 ; International
 38095 00005B2B 30C0                    	xor	al,al
 38096 00005B2D 8D16[E098]              	lea	dx,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38097 00005B31 CD21                    	int	21h		; DOS - 2+ - GET COUNTRY-DEPENDENT INFORMATION
 38098                                  				; get current-country info
 38099                                  				; DS:DX -> buffer for returned info
 38100 00005B33 7305                    	jnb	short $MEN341		; (use country depended thousand separator)
 38101 00005B35 C606[E798]2C            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA],','
 38102                                  $MEN341:
 38103 00005B3A 8A440A                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_PAD]
 38104                                  	;mov	al,[si+0Ah]		; (save pad character)
 38105 00005B3D 89C7                    	mov	di,ax
 38106 00005B3F 5A                      	pop	dx
 38107 00005B40 58                      	pop	ax
 38108 00005B41 C6440A2C                	mov	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','  ; $M_COMMA
 38109                                  	;mov	byte [si+0Ah],','	; (comma is needed for converting procedure)
 38110 00005B45 E80CFD                  	call	$M_CONVERT2ASC
 38111 00005B48 89F8                    	mov	ax,di
 38112 00005B4A 88440A                  	mov	[si+$M_SUBLIST_STRUC.$M_S_PAD],al
 38113                                  	;mov	[si+0Ah],al		; (restore pad character)
 38114 00005B4D EB03                    	jmp	short $MEN345		; MSDOS 6.22
 38115                                  	; *** (end of disassembled MSDOS 6.22 COMMAND.COM source code porehion) 
 38116                                  	; ****************************************
 38117                                  ;$MIF345:
 38118                                  ;$MEN333:
 38119                                  $MEN325:
 38120 00005B4F E802FD                  	call	$M_CONVERT2ASC			;;AN000;; Convert to ASCII string
 38121                                  $MEN345: 	; 15/06/2023 - MSDOS 6.22
 38122 00005B52 09DB                    	or	bx,bx				;;AN000;; Was number negative?
 38123 00005B54 7405                    	jz	short $MIF349			;;AN000;; No
 38124                                  						;;AN000;; Yes
 38125 00005B56 31D2                    	xor	dx,dx				;;AN000;;
 38126 00005B58 B22D                    	mov	dl,'-'	; $M_NEG_SIGN		;;AN000;; Put "-" on the stack with the number
 38127 00005B5A 52                      	push	dx				;;AN000;;
 38128                                  $MIF349:
 38129 00005B5B 55                      	push	bp				;;AN000;; Restore return address
 38130 00005B5C C3                      	retn					;;AN000;; Return
 38131                                  
 38132                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38133                                  ;;
 38134                                  ;;	PROC NAME: $M_DATE_REPLACE
 38135                                  ;;
 38136                                  ;;	FUNCTION: Convert a date to a decimal ASCII string using current
 38137                                  ;;		  country format and prepare to display
 38138                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 38139                                  ;;		ES:DI points at VALUE from SUBLIST
 38140                                  ;;	OUTPUTS: CX contains number of characters on stack
 38141                                  ;;		 Top of stack  --> Last character
 38142                                  ;;					. . .
 38143                                  ;;		 Bot of stack  --> First character
 38144                                  ;;	OTHER REGS Revised: DX,AX
 38145                                  ;;
 38146                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38147                                  
 38148                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38149                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38150                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38151                                  $M_DATE_REPLACE:
 38152 00005B5D 5D                      	pop	bp				;;AN000;; Save return address
 38153                                  
 38154 00005B5E C706[DE98]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 38155                                  	;mov	word [$M_RT+74],10		;;AN000;; Set default divisor
 38156                                  	
 38157 00005B64 E86700                  	call	$M_GET_DATE			;;AN000;; Set date format/separator in $M_RT
 38158                                  						;;AN000;; All O.K.?
 38159 00005B67 31D2                    	xor	dx,dx				;;AN000;; Reset DX value
 38160                                  	; 12/04/2023
 38161                                  	;xor	ax,ax				;;AN000;; Reset AX value
 38162                                  	
 38163                                  	;cmp	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],0
 38164                                  	;;cmp	word [$M_RT+76],0		;;AN000;; USA Date Format
 38165                                  	;jne	short $MIF351
 38166                                  	; 12/04/2023
 38167 00005B69 A1[E098]                	mov	ax,[$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] ; *
 38168 00005B6C 09C0                    	or	ax,ax
 38169 00005B6E 751D                    	jnz	short $MIF351
 38170                                  
 38171 00005B70 E87200                  	call	$M_YEAR				;;AN000;; Get Year
 38172 00005B73 E88100                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38173                                  
 38174 00005B76 FF36[EB98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 38175                                  	;push	word [$M_RT+87]			;;AN000;;
 38176                                  	
 38177 00005B7A 41                      	inc	cx				;;AN000;; Increment count
 38178 00005B7B 31C0                    	xor	ax,ax				;;AN000;; Reset AX value
 38179                                  
 38180 00005B7D 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 38181                                  	;mov	al,[si+5]			;;AN000;; Get Day
 38182 00005B80 E87400                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38183                                  	
 38184 00005B83 FF36[EB98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 38185                                  	;push	word [$M_RT+87]			;;AN000;;
 38186                                  
 38187 00005B87 41                      	inc	cx				;;AN000;; Increment count
 38188 00005B88 8A4404                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 38189                                  	;mov	al,[si+4]			;;AN000;; Get Month
 38190                                  	; 12/04/2023
 38191                                  	;call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38192 00005B8B EB3C                    	jmp	short $MIF354 ; **
 38193                                  $MIF351:
 38194                                  	;cmp	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],1
 38195                                  	;;cmp	word [$M_RT+76],1		;;AN000;; EUROPE Date Format
 38196                                  	;jne	short $MIF353
 38197                                  	; 12/04/2023
 38198                                  	; ax = [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] ; *
 38199 00005B8D 48                      	dec	ax 
 38200 00005B8E 751D                    	jnz	short $MIF352 ; word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] <> 1
 38201                                  
 38202 00005B90 E85200                  	call	$M_YEAR				;;AN000;; Get Year
 38203 00005B93 E86100                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38204                                  
 38205 00005B96 FF36[EB98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 38206                                  	;push	word [$M_RT+87]			;;AN000;;
 38207                                  	
 38208 00005B9A 41                      	inc	cx				;;AN000;; Increment count
 38209 00005B9B 31C0                    	xor	ax,ax				;;AN000;; Reset AX
 38210                                  
 38211 00005B9D 8A4404                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 38212                                  	;mov	al,[si+4]			;;AN000;; Get Month
 38213 00005BA0 E85400                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38214                                  
 38215 00005BA3 FF36[EB98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 38216                                  	;push	word [$M_RT+87]			;;AN000;;
 38217                                  
 38218 00005BA7 41                      	inc	cx				;;AN000;;
 38219                                  	      
 38220 00005BA8 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 38221                                  	;mov	al,[si+5]			;;AN000;; Get Day
 38222                                  
 38223                                  	; 12/04/2023
 38224                                  	;call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38225 00005BAB EB1C                    	jmp	short $MIF354 ; **
 38226                                  	; 12/04/2023
 38227                                  $MIF352:
 38228                                  	; ax = [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT]-1 ; *
 38229 00005BAD 48                      	dec	ax
 38230                                  	;jz	short $MIF353 ; word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] = 2
 38231                                  	;xor	ax,ax
 38232                                  	;jmp	short $MIF355
 38233                                  	; 12/04/2023
 38234 00005BAE 751C                    	jnz	short $MIF355
 38235                                  $MIF353:
 38236                                  	;cmp	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],2
 38237                                  	;;cmp	word [$M_RT+76],2		;;AN000;; JAPAN Date Format
 38238                                  	;jne	short $MIF355
 38239                                  
 38240 00005BB0 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 38241                                  	;mov	al,[si+5]			;;AN000;; Get Day
 38242 00005BB3 E84100                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38243                                  	
 38244 00005BB6 FF36[EB98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 38245                                  	;push	word [$M_RT+87]			;;AN000;;
 38246                                  
 38247 00005BBA 41                      	inc	cx				;;AN000;;
 38248                                  
 38249 00005BBB 8A4404                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 38250                                  	;mov	al,[si+4]			;;AN000;; Get Month
 38251 00005BBE E83600                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 38252                                  	
 38253 00005BC1 FF36[EB98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 38254                                  	;push	word [$M_RT+87]			;;AN000;;
 38255                                  	
 38256 00005BC5 41                      	inc	cx				;;AN000;;
 38257                                  
 38258 00005BC6 E81C00                  	call	$M_YEAR				;;AN000;; Get Year
 38259                                  	; 12/04/2023
 38260                                  $MIF354:
 38261 00005BC9 E82B00                  	call	$M_CONVERTDATE	; **		;;AN000;; Convert it to an ASCII string
 38262                                  $MIF355:
 38263 00005BCC 55                      	push	bp				;;AN000;; Restore return address
 38264 00005BCD C3                      	retn					;;AN000;; Return
 38265                                  
 38266                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38267                                  ;;
 38268                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38269                                  
 38270                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38271                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38272                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38273                                  $M_GET_DATE:
 38274                                  	;mov	ah,38h ; DOS_GET_COUNTRY	;;AN000;; Call DOS for country dependant info
 38275                                  	;mov	al,0 				;;AN000;; Get current country info
 38276                                  	; 12/04/2023
 38277 00005BCE B80038                  	mov	ax,3800h
 38278                                  	;
 38279 00005BD1 8D16[E098]              	lea	dx,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38280                                  	;lea	dx,[$M_RT+76]			;;AN000;; Set up addressibility to buffer
 38281 00005BD5 CD21                    	int	21h				;;AN000;;
 38282 00005BD7 730B                    	jnc	short $MIF357
 38283                                  	;
 38284 00005BD9 C706[E098]0000          	mov	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],0 ; $M_DEF_DATE_FORM
 38285                                  	;mov	word [$M_RT+76+0],0		;;AN000;; Set default date format (BH)
 38286 00005BDF C606[EB98]2D            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA],'-' ; $M_DEF_DATE_SEP
 38287                                  	;mov	byte [$M_RT+87],'-'		;;AN000;; Set default date separator (BL)
 38288                                  $MIF357:
 38289 00005BE4 C3                      	retn					;;AN000;;
 38290                                  
 38291                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38292                                  ;;
 38293                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38294                                  
 38295                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38296                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38297                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38298                                  $M_YEAR:
 38299 00005BE5 8B4402                  	mov	ax,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 38300                                  	;mov	ax,[si+2]			;;AN000;; Get Year
 38301                                  
 38302                                  	;test	$M_SL.$M_S_FLAG,Date_MDY_4 and $M_DATE_MASK
 38303 00005BE8 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 38304                                  	;test	byte [si+7],10h			;;AN000;; Was Month/Day/Year (2 Digits) specified?
 38305 00005BEC 7508                    	jnz	short $MIF359			;;AN000;; No
 38306                                  						;;AN000;; Yes
 38307 00005BEE 83F863                  	cmp	ax,99 ; $M_MAX_2_YEAR		;;AN000;;
 38308 00005BF1 7603                    	jna	short $MIF360			;;AN000;;
 38309 00005BF3 B86300                  	mov	ax,99 ; $M_MAX_2_YEAR		;;AN000;;
 38310                                  $MIF360:
 38311                                  $MIF359:
 38312 00005BF6 C3                      	retn					;;AN000;;
 38313                                  
 38314                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38315                                  ;;
 38316                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38317                                  
 38318                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38319                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38320                                  $M_CONVERTDATE:
 38321                                  $M_CONVERTTIME: ; *!*!  ; 12/04/2023
 38322 00005BF7 8F06[E098]              	pop	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38323                                  	;pop	word [$M_RT+76]			;;AN000;; Save return address
 38324 00005BFB 880E[D698]              	mov	[$M_RT+$M_RES_ADDRS.$M_SIZE],cl
 38325                                  	;mov	[$M_RT+66],cl			;;AN000;; Save the size before conversion
 38326 00005BFF E852FC                  	call	$M_CONVERT2ASC			;;AN000;; Convert it to an ASCII string
 38327 00005C02 49                      	dec	cx				;;AN000;; Test if size only grew by 1
 38328 00005C03 3A0E[D698]              	cmp	cl,[$M_RT+$M_RES_ADDRS.$M_SIZE] ;;AN000;; Did size only grow by one?
 38329 00005C07 7505                    	jne	short $MIF363			;;AN000;; No
 38330 00005C09 B83000                  	mov	ax,'0' ; $M_TIMEDATE_PAD ; 30h  ;;AN000;; Get a pad character (0)
 38331 00005C0C 50                      	push	ax				;;AN000;; Save it
 38332 00005C0D 41                      	inc	cx				;;AN000;; Count it
 38333                                  $MIF363:
 38334 00005C0E 41                      	inc	cx				;;AN000;; Restore CX
 38335 00005C0F FF36[E098]              	push	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38336                                  	;push	word [$M_RT+76]			;;AN000;; Restore return address
 38337 00005C13 C3                      	retn
 38338                                  
 38339                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38340                                  ;;
 38341                                  ;;	PROC NAME: $M_TIME_REPLACE
 38342                                  ;;
 38343                                  ;;	FUNCTION: Convert a time to a decimal ASCII string
 38344                                  ;;		  and prepare to display
 38345                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 38346                                  ;;		ES:DI points at VALUE from SUBLIST
 38347                                  ;;	OUTPUTS: CX contains number of characters on stack
 38348                                  ;;		 Top of stack  --> Last character
 38349                                  ;;					. . .
 38350                                  ;;		 Bot of stack  --> First character
 38351                                  ;;	REGS USED: BP,CX,AX
 38352                                  ;;
 38353                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38354                                  
 38355                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38356                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38357                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM							     ;;
 38358                                  $M_TIME_REPLACE:
 38359 00005C14 5D                      	pop	bp				;;AN000;; Save return address
 38360                                  
 38361 00005C15 C706[DE98]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 38362                                  	;mov	word [$M_RT+74],10		;;AN000;; Set default divisor
 38363                                  
 38364 00005C1B E87700                  	call	$M_GET_TIME			;;AN000;; All O.K.?
 38365                                  
 38366                                  	;test	$M_SL.$M_S_FLAG,Time_Cty_Type and $M_TIME_MASK
 38367 00005C1E F6440701                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],1
 38368                                  	;test	byte [si+7],1			;;AN000;; Is this a request for current country info?
 38369 00005C22 741A                    	jz	short $MIF365			;;AN000;; No
 38370                                  						;;AN000;; Yes
 38371 00005C24 803E[F198]00            	cmp	byte [$M_RT+$M_COUNTRY_INFO.$M_TIME_FORMAT],0
 38372                                  	;cmp	byte [$M_RT+93],0		;;AN000;; Is the current country format 12 Hour?
 38373 00005C29 7513                    	jne	short $MIF366			;;AN000;; No
 38374                                  						;;AN000;; Yes
 38375 00005C2B 8A4402                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 38376                                  	;mov	al,[si+2]			;;AN000;; Get Hours
 38377 00005C2E 3C0C                    	cmp	al,12				;;AN000;; Is hour 12 or less?
 38378 00005C30 7C04                    	jl	short $MLL367 ; jnge		;;AN000;; Yes	
 38379 00005C32 3C17                    	cmp	al,23				;;AN000;; Is hour 24 or greater?
 38380 00005C34 7E04                    	jng	short $MIF367 ; jle		;;AN000;; No
 38381                                  $MLL367:
 38382 00005C36 B061                    	mov	al,'a'	; $M_AM			;;AN000;;
 38383                                  	;push	ax				;;AN000;; Push an "a" to represent AM.
 38384                                  	;inc	cx				;;AN000;;
 38385                                  	;jmp	short $MEN367			;;AN000;;
 38386                                  	; 12/04/2023
 38387 00005C38 EB02                    	jmp	short $MEN367 ; *
 38388                                  $MIF367:
 38389 00005C3A B070                    	mov	al,'p'	; $M_PM			;;AN000;;
 38390                                  $MEN367:	; * ; 12/04/2023
 38391 00005C3C 50                      	push	ax				;;AN000;; Push an "p" to represent PM.
 38392 00005C3D 41                      	inc	cx				;;AN000;;
 38393                                  ;$MEN367:
 38394                                  $MIF366:
 38395                                  $MIF365:					;;AN000;;
 38396 00005C3E 31C0                    	xor	ax,ax				;;AN000;;
 38397                                  	;xor	dx,dx				;;AN000;;
 38398                                  	; 13/08/2024
 38399 00005C40 99                      	cwd	; PCDOS 7.1 COMMAND.COM
 38400                                  	
 38401                                  	;test	$M_SL.$M_S_FLAG,Time_HHMMSSHH_Cty and $M_SIZE_MASK
 38402 00005C41 F6440720                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],20h
 38403                                  	;test	byte [si+7],20h			;;AN000;; Was Hour/Min/Sec/Hunds (12 Hour) specified?
 38404 00005C45 740B                    	jz	short $MIF372			;;AN000;;
 38405                                  
 38406 00005C47 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 38407                                  	;mov	al,[si+5]			;;AN000;; Get Hundreds
 38408 00005C4A E8AAFF                  	call	$M_CONVERTTIME			;;AN000;;
 38409                                  
 38410 00005C4D FF36[E998]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DECI_SEPARA]
 38411                                  	;push	word [$M_RT+85]			;;AN000;;
 38412 00005C51 41                      	inc	cx				;;AN000;;
 38413                                  $MIF372:
 38414                                  	;test	$M_SL.$M_S_FLAG,Time_HHMMSSHH_Cty and $M_SIZE_MASK
 38415 00005C52 F6440720                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],20h
 38416                                  	;test	byte [si+7],20h			;;AN000;; Was Hour/Min/Sec/Hunds (12 Hour) specified?
 38417 00005C56 7506                    	jnz	short $MLL374			;;AN000;; No
 38418                                  
 38419                                  	;test	$M_SL.$M_S_FLAG,Time_HHMMSS_Cty AND $M_SIZE_MASK
 38420 00005C58 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 38421                                  	;test	byte [si+7],10h			;;AN000;; Was Hour/Min/Sec (12 Hour) specified?
 38422 00005C5C 740B                    	jz	short $MIF374			;;AN000;; No
 38423                                  $MLL374:
 38424 00005C5E 8A4404                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 38425                                  	;mov	al,[si+4]			;;AN000;; Get Seconds
 38426 00005C61 E893FF                  	call	$M_CONVERTTIME			;;AN000;;
 38427                                  
 38428 00005C64 FF36[ED98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_TIME_SEPARA]
 38429                                  	;push	word [$M_RT+89]			;;AN000;;
 38430 00005C68 41                      	inc	cx				;;AN000;;
 38431                                  $MIF374:	;;  Do Hour/Min (12 Hour)
 38432 00005C69 8A4403                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+1]
 38433                                  	;mov	al,[si+3]			;;AN000;; Get Minutes
 38434 00005C6C E888FF                  	call	$M_CONVERTTIME			;;AN000;;
 38435                                  
 38436 00005C6F FF36[ED98]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_TIME_SEPARA]
 38437                                  	;push	word [$M_RT+89]			;;AN000;;
 38438 00005C73 41                      	inc	cx				;;AN000;;
 38439                                  
 38440 00005C74 8A4402                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 38441                                  	;mov	al,[si+2]			;;AN000;; Get Hours
 38442                                  
 38443                                  	;test	$M_SL.$M_S_FLAG,Time_Cty_Type and $M_TIME_MASK
 38444 00005C77 F6440701                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],1 
 38445                                  	;test	byte [si+7],1			;;AN000;; Is this a request for current country info?
 38446 00005C7B 7413                    	jz	short $MIF376			;;AN000;; No
 38447                                  
 38448 00005C7D 803E[F198]00            	cmp	byte [$M_RT+$M_COUNTRY_INFO.$M_TIME_FORMAT],0
 38449                                  	;cmp	byte [$M_RT+93],0		;;AN000;; Is the current country format 12 Hour?
 38450 00005C82 750C                    	jne	short $MIF377			;;AN000;; No
 38451                                  
 38452 00005C84 3C0D                    	cmp	al,13				;;AN000;; Is hour less than 12?
 38453 00005C86 7C02                    	jnge	short $MIF378 ; jl
 38454 00005C88 2C0C                    	sub	al,12				;;AN000;; Set to a 12 hour value
 38455                                  $MIF378:
 38456                                  	;cmp	al,0				;;AN000;; Is hour less than 12?
 38457                                  	;jne	short $MIF380			;;AN000;; No
 38458                                  	; 12/04/2023
 38459 00005C8A 20C0                    	and	al,al
 38460 00005C8C 7502                    	jnz	short $MIF380	
 38461 00005C8E B00C                    	mov	al,12				;;AN000;; Set to a 12 hour value
 38462                                  $MIF380:
 38463                                  $MIF377:
 38464                                  $MIF376:
 38465 00005C90 E8C1FB                  	call	$M_CONVERT2ASC			;;AN000;; Convert it to ASCII
 38466 00005C93 55                      	push	bp				;;AN000;; Restore return address
 38467 00005C94 C3                      	retn					;;AN000;; Return
 38468                                  
 38469                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38470                                  ;;
 38471                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38472                                  
 38473                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38474                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38475                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38476                                  $M_GET_TIME:
 38477                                  	;mov	ah,38h ; DOS_GET_COUNTRY	;;AN000;; Call DOS for country dependant info
 38478                                  	;mov	al,0 				;;AN000;; Get current country info
 38479                                  	; 12/04/2023
 38480 00005C95 B80038                  	mov	ax,3800h
 38481                                  	;
 38482 00005C98 8D16[E098]              	lea	dx,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38483                                  	;lea	dx,[$M_RT+76]			;;AN000;; Set up addressibility to buffer
 38484 00005C9C CD21                    	int	21h				;;AN000;;
 38485 00005C9E 7310                    	jnc	short $MIF384
 38486                                  
 38487 00005CA0 C706[F198]0100          	mov	word [$M_RT+$M_COUNTRY_INFO.$M_TIME_FORMAT],1 ; $M_DEF_TIME_FORM
 38488                                  	;mov	word [$M_RT+93],1		;;AN000;; Set default time format (BH)
 38489 00005CA6 C606[ED98]3A            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_TIME_SEPARA],':' ; $M_DEF_TIME_SEP
 38490                                  	;mov	byte [$M_RT+89],':'		;;AN000;; Set default time separator (BL)
 38491 00005CAB C606[E998]2E            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_DECI_SEPARA],'.' ; $M_DEF_DECI_SEP
 38492                                  	;mov	byte [$M_RT+85],'.'		;;AN000;; Set default time separator (BL)		
 38493                                  $MIF384:
 38494 00005CB0 C3                      	retn					;;AN000;;
 38495                                  
 38496                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38497                                  ;;
 38498                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38499                                  
 38500                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38501                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38502                                  ; 12/04/2023 
 38503                                  ;; ($M_CONVERTTIME is same with $M_CONVERTDATE)
 38504                                  %if 0
 38505                                  $M_CONVERTTIME:
 38506                                  $M_CONVERTDATE: ; *!*!  ; 12/04/2023
 38507                                  	pop	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38508                                  	;pop	word [$M_RT+76]			;;AN000;; Save return address
 38509                                  	mov	[$M_RT+$M_RES_ADDRS.$M_SIZE],cl
 38510                                  	;mov	[$M_RT+66],cl			;;AN000;; Save the size before conversion
 38511                                  	call	$M_CONVERT2ASC			;;AN000;; Convert it to an ASCII string
 38512                                  	dec	cx				;;AN000;; Test if size only grew by 1
 38513                                  	cmp	cl,[$M_RT+$M_RES_ADDRS.$M_SIZE] ;;AN000;; Did size only grow by one?
 38514                                  	jne	short $MIF386			;;AN000;; No
 38515                                  	mov	ax,'0' ; $M_TIMEDATE_PAD ; 30h  ;;AN000;; Get a pad character (0)
 38516                                  	push	ax				;;AN000;; Save it
 38517                                  	inc	cx				;;AN000;; Count itount it
 38518                                  $MIF386:
 38519                                  	inc	cx				;;AN000;; Restore CX
 38520                                  	push	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38521                                  	;push	word [$M_RT+76]			;;AN000;; Restore return address
 38522                                  	retn
 38523                                  %endif
 38524                                  
 38525                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38526                                  ;;
 38527                                  ;;	PROC NAME: $M_WAIT_FOR_INPUT
 38528                                  ;;
 38529                                  ;;	FUNCTION:  To accept keyed input and return extended key value
 38530                                  ;;		   in AX register
 38531                                  ;;	INPUTS:    DL contains the DOS function requested for input
 38532                                  ;;	OUTPUTS:   AX contains the extended key value that was read
 38533                                  ;;	REGS USED:
 38534                                  ;;
 38535                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38536                                  
 38537                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38538                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6123h
 38539                                  
 38540                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38541                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5FA1h
 38542                                  $M_WAIT_FOR_INPUT:
 38543 00005CB1 51                      	push	cx				;;AN000;; Save CX
 38544 00005CB2 52                      	push	dx				;;AN000;; Save DX
 38545 00005CB3 1E                      	push	ds				;;AN000;; Save Data segment
 38546                                  
 38547 00005CB4 80FAC0                  	cmp	dl,0C0h ; DOS_CLR_KEYB_BUF_MASK	;;AN001;; Are we to clear the keyboard buffer?
 38548 00005CB7 7608                    	jna	short $MIF388	; jbe		;;AN001;; No,
 38549                                  						;;AN001;; Yes,
 38550 00005CB9 88D0                    	mov	al,dl				;;AN001;; Mov function into AL
 38551 00005CBB 240F                    	and	al,0Fh	; LOW_NIB_MASK		;;AN001;; Mask out the C in high nibble
 38552 00005CBD B40C                    	mov	ah,0Ch	; DOS_CLR_KEYB_BUF 	;;AN001;; Set input function
 38553 00005CBF EB02                    	jmp	short $MEN388
 38554                                  $MIF388:
 38555 00005CC1 88D4                    	mov	ah,dl				;;AN000;; Put DOS function in AH
 38556                                  $MEN388:
 38557 00005CC3 06                      	push	es				;;AN000;; Get output buffer segment
 38558 00005CC4 1F                      	pop	ds				;;AN000;;
 38559 00005CC5 89FA                    	mov	dx,di				;;AN000;; Get output buffer offset in case needed
 38560 00005CC7 CD21                    	int	21h				;;AN000;; Get keyboard input
 38561 00005CC9 1F                      	pop	ds				;;AN000;;
 38562 00005CCA 80FA0A                  	cmp	dl,0Ah	; DOS_BUF_KEYB_INP	;;AN000;;
 38563                                  	;clc					;;AN000;;
 38564 00005CCD 7412                    	je	short $MIF391
 38565 00005CCF E85EFB                  	call	$M_IS_IT_DBCS			;;AN000;; Is this character DBCS?
 38566 00005CD2 730B                    	jnc	short $MIF392
 38567 00005CD4 88C1                    	mov	cl,al				;;AN000;; Save first character
 38568 00005CD6 88D4                    	mov	ah,dl				;;AN001;; Get back function
 38569 00005CD8 CD21                    	int	21h				;;AN000;; Get keyboard input
 38570 00005CDA 88CC                    	mov	ah,cl				;;AN000;; Retrieve first character AX = xxxx
 38571 00005CDC F8                      	clc					;;AN000;; Clear carry condition
 38572 00005CDD EB02                    	jmp	short $MEN392
 38573                                  $MIF392:
 38574 00005CDF B400                    	mov	ah,0				;;AN000;; AX = 00xx where xx is SBCS
 38575                                  $MEN392:
 38576                                  $MIF391:
 38577                                  	;jc	short $MIF396 ; 15/06/2023
 38578 00005CE1 5A                      	pop	dx				;;AN000;;
 38579 00005CE2 59                      	pop	cx				;;AN000;;
 38580                                  	;jmp	short $MEN396
 38581 00005CE3 C3                      	retn
 38582                                  
 38583                                  	; 15/06/2023
 38584                                  ;$MIF396:
 38585                                  	;add	sp,4				;;AN000;;
 38586                                  	;stc					;;AN000;; Reset carry flag
 38587                                  ;$MEN396:
 38588                                  	;retn					;;AN000;; Return
 38589                                  
 38590                                  ; ----------------------------
 38591                                  ; MSDOS 6.0, TPRINTF.ASM, 1991
 38592                                  ; ----------------------------
 38593                                  ; include msgdcl.inc
 38594                                  ; ----------------------------
 38595                                  
 38596                                  ;============================================================================
 38597                                  ; HIGHLOAD.INC, MSDOS 6.0, 1992
 38598                                  ;============================================================================
 38599                                  ; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38600                                  
 38601                                  ;****************************************************************************
 38602                                  ;
 38603                                  ; This file contains routines needed to parse and implement user-given
 38604                                  ; command-line options of the form "/S/L:3,0x500;2;7,127;0x0BE4". InitVar()
 38605                                  ; and Parsevar() are used to parse this data and place it in encoded form into
 38606                                  ; the variables in highvar.inc, for use by the rest of the routines.
 38607                                  ;
 38608                                  ; DeviceHigh accepts this command-line (handled in sysconf.asm, not here):
 38609                                  ;    DEVICEHIGH SIZE=hhhhhh module opts
 38610                                  ; Or, DeviceHigh and LoadHigh accept any of the following:
 38611                                  ;    DH/LH module opts
 38612                                  ;    DH/LH [/S][/L:umb[,size][;umb[,size]]*] module opts
 38613                                  ;    DH/LH [/L:umb[,size][;umb[,size]]*][/S] module opts
 38614                                  ; The initial UMB,SIZE pair designates the module's load address; the remainder
 38615                                  ; of the UMB and SIZE pairs are used to indicate specific UMBs to be left
 38616                                  ; available during the load.
 38617                                  ;
 38618                                  ; When an actual load is ready to be performed, a call to HideUMBs() will
 38619                                  ; temporarily allocate (as owner 8+"HIDDEN  ") all free elements in any
 38620                                  ; upper-memory block which was not specified by the user... in addition, if
 38621                                  ; UMBs were marked to shrink (/S option) to a certain size ("umb,size"), any
 38622                                  ; elements in that umb SAVE the lower-half of the newly-shrunken one are also
 38623                                  ; allocated.  After the load, the function UnHideUMBs() (in highexit.inc) will
 38624                                  ; free any UMBs so allocated.
 38625                                  ;
 38626                                  ; When a device driver loads, there is the additional problem of allocating its
 38627                                  ; initial load site; this should be restricted to the first UMB specified on
 38628                                  ; the command-line.  The function FreezeUM temporarily allocates all remaining
 38629                                  ; free upper-memory elements (as owner 8+"FROZEN  "), except those in the load
 38630                                  ; UMB.  Then the initial allocation may be made, and a call to UnFreeze will
 38631                                  ; return any so-allocated memory elements to FREE, for the true load.  Note
 38632                                  ; that UnFreeze leaves HIDDEN elements allocated; it only frees FROZEN ones.
 38633                                  ;
 38634                                  ;****************************************************************************
 38635                                  
 38636                                  ;___PROCEDURES_______________________________________________________________
 38637                                  ;
 38638                                  ;   AddrToUmb   - converts a segment address in AX to its appropriate UMB #
 38639                                  ;   BigFree     - makes ES:0 point to the largest free MCB in UMB given as AL
 38640                                  ;   FixMem      - scans the UM chain and concatenates adjacent free MCBs
 38641                                  ;   FreezeUM    - Marks FROZEN all UM elements now FREE, save those in load UMB
 38642                                  ;   GetLoadSize - Returns the load UMB minimum size (0 if not specified)
 38643                                  ;   GetLoadUMB  - Returns the load UMB number in AL (-1 if not specified)
 38644                                  ;   GetSize     - Returns the UMB in AL's minimum size (0 if not specified)
 38645                                  ;   GetXNum     - reads a 32-bit ASCII number at ES:SI and returns it in DX:AX
 38646                                  ;   HideUMBs    - links UMBs and hides upper-memory as appropriate
 38647                                  ;   InitVar     - initializes all the variables used in ParseVar and HideUMBs
 38648                                  ;   NextMCB     - moves an MCB pointer forward to the next MCB
 38649                                  ;   ParseVar    - parses [/S][/L:umb[,size][;umb[,size]]*] and builds the table
 38650                                  ;   PrTable     - produces a printout of the variables in highvar.inc
 38651                                  ;   StoLoadSize - Overrides the load UMB minimum size with what's in AX
 38652                                  ;   StoLoadUMB  - Overrides the load UMB number with what's in AL
 38653                                  ;   UmbHead     - returns in AX the address of the first UMB block (0x9FFF)
 38654                                  ;   UnFreeze    - Marks FROZEN elements as FREE
 38655                                  ;
 38656                                  ;___VARIABLES________________________________________________________________
 38657                                  ;
 38658                                  ;   gnradix     - After a call to GetXNum, is 16 or 10, depending on the # read
 38659                                  ;
 38660                                  ;   Internal:
 38661                                  ;___PROCEDURES_______________________________________________________________
 38662                                  ;
 38663                                  ;   convUMB     - checks after GetXNum to convert an address to a UMB number
 38664                                  ;   findUMB     - makes ES:0 point to the first MCB in UMB given as AL
 38665                                  ;   fm_link     - links UMBs not already linked in
 38666                                  ;   fm_unlink   - unlinks UMBs if fm_umb is set to 0
 38667                                  ;   frezMCB     - marks as 8+FROZEN the MCB at ES:0
 38668                                  ;   hideMCB     - marks as HIDDEN the MCB at ES:0
 38669                                  ;   hideUMB     - marks as HIDDEN all FREE elements in UMB passed as AL
 38670                                  ;   hideUMB?    - hides as appropriate the UMB in CL
 38671                                  ;   hl_unlink   - unlinks UMBs if fm_umb is set to 0; restores strategy too
 38672                                  ;   incArgc     - increments fm_argc, for use with LH command-line parsing
 38673                                  ;   isEOL       - returns with ZF set iff AL contains CR or LF, or 0
 38674                                  ;   isFreeMCB   - returns with ZF set if current MCB (ES:0) is FREE
 38675                                  ;   isFrozMCB   - returns with ZF set if current MCB (ES:0) is FROZEN
 38676                                  ;   isSpecified - sets ZF if UMB in AL wasn't specified in DH/LH line.
 38677                                  ;   isSysMCB    - sets ZF iff ES points to an MCB owned by "SC" + (8 or 9)
 38678                                  ;   isTiny      - returns with ZF set if user didn't specify /S
 38679                                  ;   isWhite     - returns with ZF set iff AL contains whitespace (or "=")
 38680                                  ;   loadLow     - returns AL==0 if UMB0 == 0, else AL==1
 38681                                  ;   mul32       - multiplies the number in DX:AX by gnradix
 38682                                  ;   parseL      - parses ":nnnn[,nnnn][;nnnn[,nnnn]]*" for ParseVar
 38683                                  ;   setUMBs     - links umbs and sets allocation strategy for a load
 38684                                  ;   shrinkMCB   - breaks an MCB into two pieces, the lowest one's size==AX
 38685                                  ;   stowSiz     - marks a given UMB as having a given minimum size
 38686                                  ;   stowUMB     - marks a given UMB as used, if it hasn't been so marked before
 38687                                  ;   toDigit     - converts a character-digit to its binary counterpart
 38688                                  ;   toPara      - divides DX:AX by 16; result in AX only
 38689                                  ;   toUpper     - accepts one argument (probly a register), and upper-cases it.
 38690                                  ;   unHideMCB   - marks as FREE the MCB at ES:0
 38691                                  ;   unMarkUMB   - marks a given UMB as unused, even if previously marked used
 38692                                  ;
 38693                                  ;****************************************************************************
 38694                                  
 38695                                  ;DOS_CHECK_STRATEGY equ 5800h ; Int 21h, Func 58h, Svc 0 = check alloc strat
 38696                                  ;DOS_SET_STRATEGY   equ 5801h ; Int 21h, Func 58h, Svc 1 = set alloc strategy
 38697                                  ;DOS_CHECK_UMBLINK  equ 5802h ; Int 21h, Func 58h, Svc 2 = check link state
 38698                                  ;DOS_SET_UMBLINK    equ 5803h ; Int 21h, Func 58h, Svc 3 = set link state
 38699                                  ;DOS_GET_DOS_LISTS  equ   52h ; Int 21h, Func 52h = return list of lists
 38700                                  ;DOS_UMB_HEAD       equ   8Ch ; Offset from ES (after func52h) to get UMBHead
 38701                                  
 38702                                  ; -----------------------------------------------------------------------------
 38703                                  ;*** InitVar - initializes all the variables used in ParseVar and HideUMBs
 38704                                  ; -----------------------------------------------------------------------------
 38705                                  ; ENTRY:       None
 38706                                  ; EXIT:        Variables listed in highvar.inc are initialized
 38707                                  ; ERROR EXIT:  None
 38708                                  ; USES:        Flags, variables in highvar.inc
 38709                                  ; -----------------------------------------------------------------------------
 38710                                  ; Note that element 0 references UMB 0 (conventional), not UMB 1.  Its contents
 38711                                  ; are largely ignored, but it is initialized nonetheless.
 38712                                  ; -----------------------------------------------------------------------------
 38713                                  
 38714                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38715                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:615Fh
 38716                                  
 38717                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38718                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:5FDCh
 38719                                  InitVar:	; proc	near
 38720                                  	;push	ax
 38721                                  	;push	cx
 38722                                  	;push	di
 38723 00005CE4 06                      	push	es ; * es = ds
 38724 00005CE5 8E06[F59B]              	mov	es,[RESSEG]		;Point ES into appropriate data segment
 38725 00005CE9 31C0                    	xor	ax,ax
 38726                                  	;mov	[es:fUmbTiny],al	;Shrink UMBs? (made 1 if /S given)
 38727                                  	;mov	[es:fInHigh],al		;Set to 1 when DH/LH has been called
 38728 00005CEB 26A3[3005]              	mov	[es:fInHigh],ax ; 16/06/2023
 38729 00005CEF 26A3[3205]              	mov	[es:SegLoad],ax		;Load Address (seg), used for DH only
 38730 00005CF3 26C606[3405]FF          	mov	byte [es:UmbLoad],0FFh	;UNSPECIFIED
 38731                                  					;Later is the # of the 1st spec'd UMB
 38732 00005CF9 26A2[3705]              	mov	[es:fm_argc],al		;Start with zero args having been read
 38733                                  
 38734 00005CFD FC                      	cld
 38735                                  
 38736 00005CFE B91000                  	mov	cx,16 ; MAXUMB		;For each entry
 38737 00005D01 BF[5E04]                	mov	di,UmbUsed		;on the UmbUsed array,
 38738 00005D04 F3AA                    	rep	stosb			;	Store 0
 38739                                  
 38740                                  	;mov	cx,16 ; MAXUMB		;Okay... for each entry
 38741 00005D06 B110                    	mov	cl,16
 38742 00005D08 BF[6E04]                	mov	di,UmbSize		;on the UmbSize array,
 38743 00005D0B F3AB                    	rep	stosw			;	Store 0
 38744                                  
 38745 00005D0D 07                      	pop	es ; * es = ds
 38746                                  	;pop	di
 38747                                  	;pop	cx
 38748                                  	;pop	ax
 38749 00005D0E C3                       	retn
 38750                                  
 38751                                  ;InitVar endp
 38752                                  
 38753                                  ; -----------------------------------------------------------------------------
 38754                                  ;*** FixMem - scans the upper memory chain and concatenates adjacent free MCBs
 38755                                  ; -----------------------------------------------------------------------------
 38756                                  ; ENTRY   : None
 38757                                  ; EXIT    : None
 38758                                  ; ERROR   : None
 38759                                  ; USES    : Flags, fm_umb, fm_strat
 38760                                  ; -----------------------------------------------------------------------------
 38761                                  
 38762                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38763                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38764                                  FixMem:
 38765                                  	;push	ax
 38766                                  	;push	bx
 38767                                  	;push	cx
 38768                                  	;push	dx
 38769 00005D0F 06                      	push	es
 38770                                  
 38771 00005D10 E84900                  	call	fm_link			; Link in UMBs
 38772                                  
 38773 00005D13 E82302                  	call	UmbHead			; Get first upper-memory MCB address (0x9FFF)
 38774 00005D16 723F                    	jc	short fmX		; (if couldn't get it, leave now).
 38775                                  
 38776 00005D18 8EC0                    	mov	es,ax			; It returns in AX, so move it to ES.
 38777                                  
 38778                                  ; - Walk MCB Chain ------------------------------------------------------------
 38779                                  
 38780 00005D1A 31D2                    	xor	dx,dx			; We're keeping the address of the last MCB
 38781 00005D1C 89D1                    	mov 	cx,dx			; in CX... and the last owner
 38782 00005D1E 42                      	inc	dx			; in dx as we go through the loop:
 38783                                  
 38784                                  ; ------------------------------------------
 38785                                  ; FM10--DX  = last MCB's owner's PSP address
 38786                                  ;       CX  = last MCB's address (segment)
 38787                                  ; ------------------------------------------
 38788                                  
 38789                                  fm10:	
 38790 00005D1F 26A00000                	mov	al,[es:arena_signature]	; if 'Z', don't repeat loop
 38791                                  	;mov	al,[es:0]
 38792 00005D23 268B1E0100              	mov	bx,[es:arena_owner]	; if not zero, do nothing
 38793                                  	;mov	bx,[es:1]
 38794 00005D28 09D3                    	or	bx,dx			; dx was owner of previous MCB
 38795 00005D2A 7516                    	jnz	short fm30		; If not both zero, don't cat.
 38796                                  
 38797                                  ; - Coalesce memory blocks at ES:00 and CX:00 ---------------------------------
 38798                                  
 38799                                  fm20:	
 38800 00005D2C 268B1E0300              	mov	bx,[es:arena_size]	; Grab this block's Size,
 38801                                  	;mov	bx,[es:3]
 38802 00005D31 8EC1                    	mov	es,cx			; Go back to prev MCB's address
 38803 00005D33 26A20000                	mov	[es:arena_signature], al ; & move the SECOND sig here
 38804                                  	;mov	[es:0],al
 38805                                  
 38806 00005D37 26031E0300              	add	bx,[es:arena_size]	; Size += first MCB's size
 38807                                  	;add	bx,1			; And add one for the header
 38808 00005D3C 43                      	inc	bx
 38809 00005D3D 26891E0300              	mov	[es:arena_size],bx	; Write the size
 38810                                  
 38811                                  	; ---------------------------------------------------------------------
 38812                                  fm30:	
 38813 00005D42 8CC1                    	mov	cx,es			; Put this address on the stack
 38814 00005D44 268B160100              	mov	dx,[es:arena_owner]	; And remember its owner
 38815                                  	;mov	dx,[es:1]
 38816                                  
 38817                                  	;NextMCB es,bx			; Move to the next MCB
 38818                                  	
 38819 00005D49 8CC3                    	mov	bx,es
 38820                                  	;add	bx,[es:3]
 38821 00005D4B 26031E0300              	add	bx,[es:arena_size]
 38822 00005D50 43                      	inc	bx
 38823 00005D51 8EC3                    	mov	es,bx
 38824                                  
 38825                                  	;cmp	al,'Z'	; cmp al,5Ah
 38826 00005D53 3C5A                    	cmp	al,arena_signature_end
 38827 00005D55 75C8                    	jnz	short fm10		; If signature != 'Z', there are more.
 38828                                  fmX:	
 38829 00005D57 E81900                  	call	fm_unlink		; Unlink UMBs
 38830                                  
 38831 00005D5A 07                      	pop	es
 38832                                  	;pop	dx
 38833                                  	;pop	cx
 38834                                  	;pop	bx
 38835                                  	;pop	ax
 38836 00005D5B C3                      	retn
 38837                                  
 38838                                  ; -----------------------------------------------------------------------------
 38839                                  ; 16/06/2023
 38840                                  
 38841                                  ;INT 21h - DOS 5+ - GET OR SET UMB LINK STATE
 38842                                  ; .......................................................
 38843                                  ;     AH = 58h
 38844                                  ;     AL = subfunction
 38845                                  ;	02h get UMB link state
 38846                                  ;	    Return:
 38847                                  ;		AL = current link state
 38848                                  ;		  00h - UMBs not part of DOS memory chain
 38849                                  ;		  01h - UMBs in DOS memory chain
 38850                                  ;	03h set UMB link state
 38851                                  ;	    BX = new link state
 38852                                  ;		0000h - remove UMBs from DOS memory chain
 38853                                  ;		0001h - add UMBs to DOS memory chain
 38854                                  ;
 38855                                  ;Return: CF clear if successful
 38856                                  ;	CF set on error
 38857                                  ;	AX = error code (01h) (see #01680)
 38858                                  ; .......................................................
 38859                                  
 38860                                  ; -----------------------------------------------------------------------------
 38861                                  ;*** fm_link - links UMBs not already linked in
 38862                                  ; -----------------------------------------------------------------------------
 38863                                  ; ENTRY:    None
 38864                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
 38865                                  ; ERROR:    None
 38866                                  ; USES:     AX, BX, fm_umb
 38867                                  ; -----------------------------------------------------------------------------
 38868                                  
 38869                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38870                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38871                                  fm_link:
 38872 00005D5C B80258                  	mov	ax,5802h ; DOS_CHECK_UMBLINK
 38873 00005D5F CD21                    	int	21h			; Current link-state is now in al
 38874                                  
 38875                                  	;putdata fm_umb,al		; So store it in fm_umb for later
 38876                                  
 38877                                  	;push	es
 38878                                  	;mov	es,[RESSEG]
 38879                                  	;mov	[es:fm_umb],al
 38880                                  	;pop	es
 38881 00005D61 1E                      	push	ds
 38882 00005D62 8E1E[F59B]              	mov	ds,[RESSEG]
 38883 00005D66 A2[3505]                	mov	[fm_umb],al
 38884 00005D69 1F                      	pop	ds
 38885                                  
 38886 00005D6A B80358                  	mov	ax,5803h ; DOS_SET_UMBLINK
 38887 00005D6D BB0100                  	mov	bx,1
 38888 00005D70 CD21                    	int	21h
 38889 00005D72 C3                      	retn
 38890                                  
 38891                                  ; -----------------------------------------------------------------------------
 38892                                  ;*** fm_unlink - unlinks UMBs if fm_umb is set to 0
 38893                                  ; -----------------------------------------------------------------------------
 38894                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 38895                                  ; EXIT:     None
 38896                                  ; ERROR:    None
 38897                                  ; USES:     AX, BX
 38898                                  ; -----------------------------------------------------------------------------
 38899                                  
 38900                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38901                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38902                                  fm_unlink:
 38903 00005D73 31DB                    	xor	bx,bx
 38904                                  	
 38905                                  	;getdata bl,fm_umb		; fm_umb already has the old link-state
 38906                                  
 38907 00005D75 1E                      	push    ds
 38908 00005D76 8E1E[F59B]              	mov     ds,[RESSEG]
 38909 00005D7A 8A1E[3505]              	mov     bl,[fm_umb]
 38910 00005D7E 1F                      	pop     ds
 38911                                  	
 38912 00005D7F B80358                  	mov	ax,5803h ; DOS_SET_UMBLINK
 38913 00005D82 CD21                    	int	21h			; so just use that, and call int 21h
 38914 00005D84 C3                      	retn
 38915                                  
 38916                                  ; -----------------------------------------------------------------------------
 38917                                  ;*** ParseVar - parses [/S][/L:umb[,size][;umb[,size]]*] and builds the table
 38918                                  ; laid out in highvar.inc
 38919                                  ; -----------------------------------------------------------------------------
 38920                                  ; ENTRY:    ES:SI points to command tail of LoadHigh/DeviceHigh (whitespace ok)
 38921                                  ; EXIT:     ES:SI points to first character in child program name
 38922                                  ; ERROR:    ES:SI points to character which caused error, carry set, AX == code
 38923                                  ; USES:     ES:SI, AX, flags, variables in highvar.inc
 38924                                  ; -----------------------------------------------------------------------------
 38925                                  ; Error codes (in AX if carry set on return):
 38926                                  ;
 38927                                  
 38928                                  ;PV_InvArg	equ	1	; Invalid argument passed
 38929                                  ;PV_BadUMB	equ	2	; Bad UMB number passed (duplicate?)
 38930                                  ;PV_InvSwt	equ	3	; Unrecognized switch passed
 38931                                  
 38932                                  ;
 38933                                  ; This routine exects ES:SI to point to a string much like the following:
 38934                                  ;    "/S/L:1,200;2 module options"
 38935                                  ; Optionally, the string can begin with whitespace; neither /S nor /L is
 38936                                  ; required, though that's what this routine is supposed to parse.
 38937                                  ;
 38938                                  
 38939                                  ;optS		equ	'S'	; /S
 38940                                  ;optL		equ	'L'	; /L:...
 38941                                  
 38942                                  ;
 38943                                  ; -----------------------------------------------------------------------------
 38944                                  ; LoadHigh has a list of arguments, returned by cparse, which is used to create
 38945                                  ; a command-line for spawning a child process. For a typical LH command, say,
 38946                                  ;     lh /l:1,1000;2 print/d:lpt2
 38947                                  ; the arguments would look like (one per line):
 38948                                  ;     lh
 38949                                  ;     /l
 38950                                  ;     1
 38951                                  ;     1000
 38952                                  ;     2
 38953                                  ;     print
 38954                                  ;     /d
 38955                                  ;     :lpt2
 38956                                  ; In short, if "print" were, say, "43", there'd be no way to determine which
 38957                                  ; arg was the filename. So, inside this routine, we keep a running counter
 38958                                  ; of the number of arguments LH will need to skip in order to get to the
 38959                                  ; program name. The "lh" is implicit--it'll always have to skip that. So if
 38960                                  ; there's no "/l" or "/s", fm_argc will be 0 ... other than that, 1 is added
 38961                                  ; for:
 38962                                  ;    Each /L
 38963                                  ;    Each /S (there should be only one)
 38964                                  ;    Each UMB number (they follow ":" or ";")
 38965                                  ;    Each UMB size   (they follow ",")
 38966                                  ; So, in the above example, fm_argc would be 4-- and LH would skip right to
 38967                                  ; "print". Note that InitVar initializes fm_argc to zero.
 38968                                  ; -----------------------------------------------------------------------------
 38969                                  
 38970                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38971                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6216h
 38972                                  
 38973                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 38974                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:6093h
 38975                                  
 38976                                  ParseVar:	; proc	near
 38977                                  	;push	di
 38978                                  	;push	ds ; *
 38979                                  	;push	es
 38980                                  	;
 38981                                  	; 16/06/2023
 38982                                  	; es = ds (from 'ParseLhCmd')
 38983                                  	;push	es		; Make DS:SI point to it, as well as ES:SI
 38984                                  	;pop	ds		; (regardless if we're in devhigh or loadhigh)
 38985                                  	
 38986 00005D85 FC                      	cld
 38987                                  
 38988                                  ; ------------------------------------------------
 38989                                  ; PV10--ES:SI = any whitespace on the command-line
 38990                                  ; ------------------------------------------------
 38991                                  
 38992                                  pv10:	
 38993 00005D86 AC                      	lodsb			; here, ES:SI=="  /L..."--must eat whitespace
 38994 00005D87 E8A800                  	call	isWhite
 38995 00005D8A 74FA                    	jz	short pv10	;       ES:SI==" /L..."--keep eating.
 38996 00005D8C 3C2F                    	cmp	al,'/' ; SWTCH
 38997 00005D8E 7404                    	je	short pv20	;       ES:SI=="/L..."--go process a switch
 38998                                  
 38999 00005D90 4E                      	dec	si		; Backup--it's now "odule options", and we need
 39000 00005D91 F8                      	clc			; that "m" we just read (or whatever it is).
 39001 00005D92 EB2C                    	jmp	short pvX	; Then return with carry clear == we're done.
 39002                                  pv20:
 39003 00005D94 AC                      	lodsb			; Just read 'S' or 'L', hopefully
 39004                                  
 39005                                  	;toUpper al		; So we make it upper-case, and...
 39006 00005D95 24DF                    	and	al,0DFh
 39007                                  
 39008 00005D97 3C53                    	cmp	al,'S' ; optS	; just read 'S'?
 39009 00005D99 7510                    	jne	short pv30
 39010                                  
 39011 00005D9B E87E00                  	call	incArgc		; If it's /S, it's another arg for LH to skip.
 39012                                  
 39013                                  	;putdata fUmbTiny,1	; /S, so ES:SI=="  /L..." or " module opts", or
 39014                                  
 39015                                  	;push	es
 39016                                  	;mov	es,[RESSEG]
 39017                                  	;mov	byte [es:fUmbTiny],1
 39018                                  	;pop	es
 39019 00005D9E 1E                      	push	ds
 39020 00005D9F 8E1E[F59B]              	mov	ds,[RESSEG]
 39021 00005DA3 C606[3105]01            	mov	byte [fUmbTiny],1
 39022 00005DA8 1F                      	pop	ds
 39023                                  
 39024 00005DA9 EBDB                    	jmp	short pv10	; possibly even "/L...".
 39025                                  pv30:	
 39026 00005DAB 3C4C                    	cmp	al,'L' ; optL	; If it's not 'L' either, then it's a bad
 39027 00005DAD 750B                    	jne	short pvE1	; switch!
 39028                                  
 39029 00005DAF E86A00                  	call	incArgc		; If it's /L, it's another arg for LH to skip.
 39030                                  
 39031 00005DB2 E80C00                  	call	parseL
 39032 00005DB5 73CF                    	jnc	short pv10	; If no carry, go back and look for more
 39033                                  
 39034 00005DB7 4E                      	dec	si		; Else, back up and exit.
 39035 00005DB8 EB03                    	jmp	short pvErr	; AX has already been set by parseL
 39036                                  pvE1:	
 39037 00005DBA B80300                  	mov	ax,3 ; PV_InvSwt
 39038                                  				; Unrecognized switch passed
 39039                                  pvErr:
 39040 00005DBD 4E                      	dec	si
 39041 00005DBE 4E                      	dec	si
 39042 00005DBF F9                      	stc
 39043                                  pvX:	
 39044                                  	;pop	es
 39045                                  	;pop	ds ; *
 39046                                  	;pop	di
 39047 00005DC0 C3                      	retn
 39048                                  
 39049                                  ;ParseVar endp
 39050                                  
 39051                                  ; -----------------------------------------------------------------------------
 39052                                  ;*** parseL - parses ":nnnn[,nnnn][;nnnn[,nnnn]]*" for ParseVar
 39053                                  ; -----------------------------------------------------------------------------
 39054                                  ; ENTRY:    ES:SI points to colon
 39055                                  ; EXIT:     ES:SI points to first character not parsed
 39056                                  ; ERROR:    Carry set; rewind three characters and return (see ParseVar)
 39057                                  ; USES:     ES:SI, flags, AX, CX, DX, variables in highvar.inc
 39058                                  ; -----------------------------------------------------------------------------
 39059                                  ; If the string here is terminated with anything other than whitespace or a
 39060                                  ; switchchar (perhaps it's /S or another /L:... ), then we return with carry
 39061                                  ; set, indicating that they've screwed up the syntax.  The 3-character rewind
 39062                                  ; makes sure the app /L: is reported as being the culprit.
 39063                                  ; -----------------------------------------------------------------------------
 39064                                  
 39065                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39066                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39067                                  parseL:
 39068 00005DC1 AC                      	lodsb
 39069 00005DC2 3C3A                    	cmp	al,':'		; Make sure they did /L:
 39070 00005DC4 754A                    	jne	short plE1	; If they didn't, return with carry set.
 39071                                  
 39072                                  ; ------------------------------------------
 39073                                  ; PL10--ES:SI = a UMB number, after /L: or ;
 39074                                  ; ------------------------------------------
 39075                                  
 39076                                  pl10:
 39077 00005DC6 E8FD00                  	call	GetXNum		; After this, 'tis ",size" or ";umb" or " mod"
 39078 00005DC9 724B                    	jc	short plE2	; And error if it's a bad number.
 39079 00005DCB E8C801                  	call	convUMB		; Convert any address to a UMB number
 39080                                  
 39081 00005DCE 88C1                    	mov	cl,al	; !*	; Remember the UMB number
 39082 00005DD0 E88300                  	call	stowUMB		; Mark this UMB # as used;
 39083 00005DD3 7241                    	jc	short plE2	; If it was already marked, it'll error
 39084                                  
 39085 00005DD5 E84400                  	call	incArgc		; Each UMB number is another arg for LH to skip
 39086                                  
 39087 00005DD8 AC                      	lodsb
 39088 00005DD9 3C3B                    	cmp	al,';'		; Did "umb;" ?
 39089 00005DDB 74E9                    	je	short pl10	; Yep: go back and get another UMB.
 39090                                  
 39091 00005DDD E85200                  	call	isWhite		; Did "umb " ?
 39092 00005DE0 7439                    	jz	short plX	; Yep: return (it'll go back to whitespace)
 39093                                  
 39094 00005DE2 E84200                  	call	isEOL		; Did "umb" ?
 39095 00005DE5 7433                    	jz	short plSwX	; If so, backup and exit like everything's ok
 39096                                  
 39097 00005DE7 3C2F                    	cmp	al,'/' ; SWTCH	; Did "umb/" ? (as in, "/L:1,100;2/S")
 39098 00005DE9 742F                    	je	short plSwX	; If so, back up ES:SI one character and return
 39099                                  
 39100 00005DEB 3C2C                    	cmp	al,','		; Did "umb," ?
 39101 00005DED 7521                    	jne	short plE1	; Just what the heck DID they do? Return error.
 39102                                  
 39103                                  ; --- Read a size -------------------------------------------------------------
 39104                                  
 39105 00005DEF E8D400                  	call	GetXNum		; Stop on "size;" or "size " or anything else
 39106 00005DF2 721C                    	jc	short plE1	; And error if it's a bad size.
 39107                                  
 39108 00005DF4 E83401                  	call	toPara		; Convert from bytes to paragraphs
 39109                                  
 39110 00005DF7 E88600                  	call	stowSiz		; CL still has the UMB number for this routine
 39111                                  
 39112 00005DFA E81F00                  	call	incArgc		; Each UMB size is another arg for LH to skip
 39113                                  
 39114 00005DFD AC                      	lodsb
 39115 00005DFE 3C3B                    	cmp	al,';'		; They did "umb,size;", so get another UMB.
 39116 00005E00 74C4                    	je	short pl10		;
 39117                                  
 39118 00005E02 E82D00                  	call	isWhite		; Did it end with whitespace?
 39119 00005E05 7414                    	jz	short plX	; If so, we're done here--go back.
 39120                                  
 39121 00005E07 E81D00                  	call	isEOL		; Did they do "umb,size" and end??? (stupid)
 39122 00005E0A 740E                    	jz	short plSwX	; If so, backup and exit like everything's ok
 39123                                  
 39124 00005E0C 3C2F                    	cmp	al,'/' ; SWTCH	; Did they do "umb,size/" ?
 39125 00005E0E 740A                    	je	short plSwX	; If so, again, we're done here.
 39126                                  plE1:	
 39127 00005E10 B80100                  	mov	ax,1 ; PV_InvArg
 39128                                  				; If not, we don't know WHAT they did...
 39129 00005E13 4E                      	dec	si
 39130 00005E14 F9                      	stc
 39131 00005E15 C3                      	retn
 39132                                  plE2:
 39133                                  	; cf = 1 
 39134 00005E16 B80200                  	mov	ax,2 ; PV_BadUMB
 39135                                  				; In this case, they've specified a UMB twice
 39136                                  	;stc
 39137 00005E19 C3                      	retn
 39138                                  plSwX:
 39139 00005E1A 4E                      	dec	si		; If we hit a '/' character, back up one char
 39140                                  				; so the whitespace checker will see it too.
 39141                                  plX:
 39142                                  	; cf = 0
 39143                                  	;clc			; Then just return with carry clear, so
 39144 00005E1B C3                      	retn			; ParseVar will go about its business.
 39145                                  
 39146                                  ; -----------------------------------------------------------------------------
 39147                                  ;*** incArgc - increments fm_argc, for use with LoadHigh command-line parsing
 39148                                  ; -----------------------------------------------------------------------------
 39149                                  ; ENTRY:    None
 39150                                  ; EXIT:     None
 39151                                  ; ERROR:    None
 39152                                  ; USES:     fm_argc, flags
 39153                                  ; -----------------------------------------------------------------------------
 39154                                  
 39155                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39156                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39157                                  incArgc:
 39158                                  	;push	ax
 39159                                  
 39160                                  	;;getdata al,fm_argc	; Obtain previous value of fm_argc,
 39161                                  	;
 39162                                  	;push	ds		; getdata (macro)
 39163                                  	;			; getdata al, fm_argc
 39164                                  	;mov	ds,[RESSEG]
 39165                                  	;mov	al,[fm_argc]	; Obtain previous value of fm_argc,
 39166                                  	;pop	ds
 39167                                  	;
 39168                                  	;inc	al		; Increment it,
 39169                                  	;
 39170                                  	;;putdata fm_argc,al	; And store it right back.
 39171                                  	;
 39172                                  	;push	es		; putdata (macro)
 39173                                  	;			; putdata fm_argc, al
 39174                                  	;mov	es,[RESSEG]
 39175                                  	;mov	[es:fm_argc],al	; and store it right back.
 39176                                  	;pop	es
 39177                                  
 39178                                  	; 16/06/2023
 39179 00005E1C 1E                      	push	ds
 39180 00005E1D 8E1E[F59B]              	mov	ds,[RESSEG]
 39181 00005E21 FE06[3705]              	inc	byte [fm_argc]	; increment fm_argc
 39182 00005E25 1F                      	pop	ds
 39183                                  
 39184                                  	;pop	ax
 39185 00005E26 C3                      	retn
 39186                                  
 39187                                  ; -----------------------------------------------------------------------------
 39188                                  ;*** isEOL - returns with ZF set iff AL contains CR or LF, or 0
 39189                                  ; -----------------------------------------------------------------------------
 39190                                  ; ENTRY:    AL contains character to test
 39191                                  ; EXIT:     ZF set if AL contains CR or LF, or 0
 39192                                  ; ERROR:    None
 39193                                  ; USES:     ZF
 39194                                  ; -----------------------------------------------------------------------------
 39195                                  
 39196                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39197                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39198                                  isEOL:
 39199                                  	;cmp	al,0		; Null-terminator
 39200 00005E27 20C0                    	and	al,al
 39201 00005E29 7406                    	jz	short ieX
 39202 00005E2B 3C0D                    	cmp	al,0Dh ; CR	; Carriage Return
 39203 00005E2D 7402                    	je	short ieX
 39204 00005E2F 3C0A                    	cmp	al,0Ah ; LF	; LineFeed
 39205                                  ieX:
 39206 00005E31 C3                      	retn
 39207                                  
 39208                                  
 39209                                  ; -----------------------------------------------------------------------------
 39210                                  ;*** isWhite - returns with ZF set iff AL contains whitespace (or "=")
 39211                                  ; -----------------------------------------------------------------------------
 39212                                  ; ENTRY:    AL contains character to test
 39213                                  ; EXIT:     ZF set if AL contains space, tab, or equals
 39214                                  ; ERROR:    None
 39215                                  ; USES:     ZF
 39216                                  ; -----------------------------------------------------------------------------
 39217                                  
 39218                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39219                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39220                                  isWhite:
 39221 00005E32 3C20                    	cmp	al,' '		; Space
 39222 00005E34 7406                    	je	short iwX
 39223 00005E36 3C3D                    	cmp	al,'='		; Equals (treat as whitespace)
 39224 00005E38 7402                    	je	short iwX
 39225 00005E3A 3C09                    	cmp	al,09h ; TAB	; Tab
 39226                                  iwX:
 39227 00005E3C C3                      	retn
 39228                                  
 39229                                  ; -----------------------------------------------------------------------------
 39230                                  ;*** unMarkUMB - marks a given UMB as unused, even if previously marked used
 39231                                  ; -----------------------------------------------------------------------------
 39232                                  ; ENTRY:    AL contains UMB number
 39233                                  ; EXIT:     None
 39234                                  ; ERROR:    None
 39235                                  ; USES:     Flags, variables in highvar.inc
 39236                                  ; -----------------------------------------------------------------------------
 39237                                  
 39238                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39239                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39240                                  unMarkUMB:
 39241                                  	;;pushreg <ax,bx,di,es>
 39242                                  	;push	ax ; ***
 39243                                  	
 39244                                  	;push	bx ; **
 39245                                  	
 39246                                  	;push	di
 39247                                  	;push	es
 39248 00005E3D 1E                      	push	ds ; *	
 39249                                  
 39250                                  	;;dataseg es
 39251                                  	;mov	es,[RESSEG]
 39252                                  
 39253 00005E3E 8E1E[F59B]              	mov	ds,[RESSEG] ; *
 39254                                  	
 39255                                  	;xor	ah,ah ; 0
 39256                                  	;mov	bx,ax
 39257                                  	;mov	byte [es:bx+UmbUsed],0
 39258                                  	;mov	[bx+UmbUsed],ah ; marks the UMB as unused
 39259 00005E42 88C3                    	mov	bl,al
 39260 00005E44 30FF                    	xor	bh,bh ; 0	
 39261 00005E46 88BF[5E04]              	mov	[bx+UmbUsed],bh ; 0 ; **
 39262                                  
 39263                                  	;cmp	[es:UmbLoad],al
 39264                                  	;jnz	short umu10
 39265 00005E4A 3806[3405]              	cmp	[UmbLoad],al
 39266 00005E4E 7504                    	jne	short umu10
 39267                                  
 39268                                  	;mov	byte [es:UmbLoad],0
 39269                                  	;mov	[UmbLoad],ah	; If unmarked the load UMB, load into convent.
 39270 00005E50 883E[3405]              	mov	[UmbLoad],bh ; 0 ; **
 39271                                  umu10:	
 39272 00005E54 1F                      	pop	ds ; *
 39273                                  	;;popreg <es,di,bx,ax>
 39274                                  	;pop	es
 39275                                  	;pop	di
 39276                                  	
 39277                                  	;pop	bx ; **
 39278                                  	
 39279                                  	;pop	ax ; ***
 39280                                  
 39281                                  	;;normseg es
 39282                                  	
 39283 00005E55 C3                      	retn
 39284                                  
 39285                                  ; -----------------------------------------------------------------------------
 39286                                  ;*** stowUMB - marks a given UMB as used, if it hasn't been so marked before
 39287                                  ;            -- accepts a UMB # in AL, and makes sure it hasn't yet been
 39288                                  ; listed in the /L:... chain.  If it's the first one specified, it sets UmbLoad
 39289                                  ; to that UMB #... and in any case, it marks the UMB as specified.
 39290                                  ; -----------------------------------------------------------------------------
 39291                                  ; ENTRY:    AL contains UMB number, as specified by the user
 39292                                  ; EXIT:     None
 39293                                  ; ERROR:    Carry set if UMB # is less than 0 or >= MAXUMB (see highvar.inc)
 39294                                  ; USES:     AX, Flags, variables in highvar.inc
 39295                                  ; -----------------------------------------------------------------------------
 39296                                  
 39297                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39298                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39299                                  stowUMB:
 39300 00005E56 3C10                    	cmp	al,16 ; MAXUMB
 39301 00005E58 7202                    	jb	short su10
 39302 00005E5A F9                      	stc
 39303 00005E5B C3                      	retn			; Ooops-- UMB>=MAXUMB
 39304                                  su10:
 39305                                  	;pushreg <bx,di,si,ds,es>
 39306                                  	;dataseg es		; Point ES into appropriate data segment
 39307                                  	;dataseg ds		; Point DS into appropriate data segment
 39308                                  
 39309                                  	;push	bx ; **
 39310                                  	
 39311                                  	;push	di
 39312                                  	;push	si
 39313                                  
 39314 00005E5C 1E                      	push	ds ; *
 39315                                  
 39316                                  	;push	es
 39317                                  	;mov	es,[RESSEG]
 39318 00005E5D 8E1E[F59B]              	mov	ds,[RESSEG]
 39319                                  
 39320 00005E61 803E[3405]FF            	cmp	byte [UmbLoad],0FFh ; UNSPECIFIED
 39321                                  				; If this, we haven't been here before
 39322 00005E66 7503                    	jne	short su20
 39323 00005E68 A2[3405]                	mov	[UmbLoad],al	; So remember this UMB as the load UMB slot.
 39324                                  su20:	
 39325 00005E6B 08C0                    	or	al,al		; If they gave UMB 0, there's really nothing
 39326 00005E6D 740F                    	jz	short su30	; that we should do here.
 39327                                  
 39328                                  	;mov	bl,al
 39329                                  	;xor	bh,bh
 39330                                  	;mov	ax,1		; Now, AX = 1, and BX = UMB Number
 39331 00005E6F 30E4                    	xor	ah,ah
 39332 00005E71 89C3                    	mov	bx,ax
 39333 00005E73 B001                    	mov	al,1
 39334                                  
 39335                                  	;xchg	[es:bx+UmbUsed],al
 39336 00005E75 8687[5E04]              	xchg	[bx+UmbUsed],al
 39337                                  
 39338 00005E79 08C0                    	or	al,al		; If it was already 1, then al==1... and that
 39339 00005E7B 7401                    	jz	short su30	; means an error.
 39340                                  
 39341 00005E7D F9                      	stc			; OOOPS! This one's been used before. :(
 39342                                  su30:	
 39343                                  	;popreg	<es,ds,si,di,bx>
 39344                                  	;normseg ds
 39345                                  	;normseg es
 39346                                  	;retn
 39347                                  
 39348                                  	;pop	es
 39349                                  	
 39350 00005E7E 1F                      	pop	ds ; *
 39351                                  	
 39352                                  	;pop	si
 39353                                  	;pop	di
 39354                                  	
 39355                                  	;pop	bx ; **
 39356                                  
 39357 00005E7F C3                      	retn
 39358                                  
 39359                                  ; -----------------------------------------------------------------------------
 39360                                  ;*** stowSiz - marks a given UMB as having a given minimum size
 39361                                  ; -----------------------------------------------------------------------------
 39362                                  ; ENTRY:    CL contains UMB number, AX contains size
 39363                                  ; EXIT:     None
 39364                                  ; ERROR:    None
 39365                                  ; USES:     AX, DX, Flags, variables in highvar.inc
 39366                                  ; -----------------------------------------------------------------------------
 39367                                  	
 39368                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39369                                  stowSiz:
 39370                                  	;pushreg <bx,di,es>
 39371                                  	;dataseg es		; Point ES into appropriate data seg
 39372                                  
 39373                                  	;push	bx ; **
 39374                                  	
 39375                                  	;push	di
 39376                                  	;push	es
 39377                                  	;mov	es,[RESSEG]
 39378 00005E80 1E                      	push	ds ; *
 39379 00005E81 8E1E[F59B]              	mov	ds,[RESSEG]
 39380                                  
 39381 00005E85 88CB                    	mov	bl,cl		; Now bl==UMB number, AX==size
 39382 00005E87 B700                    	mov	bh,0		;     bx==UMB number, AX==size
 39383 00005E89 D0E3                    	shl	bl,1		;     bx==offset into array, AX=size
 39384                                  	;mov	[es:bx+UmbSize],ax
 39385 00005E8B 8987[6E04]              	mov	[bx+UmbSize],ax	; Store the size
 39386                                  
 39387 00005E8F 1F                      	pop	ds ; *
 39388                                  
 39389                                  	;popreg	<es,di,bx>
 39390                                  	;normseg es		; Return ES to where it was
 39391                                  
 39392                                  	;pop	es
 39393                                  	;pop	di
 39394                                  	
 39395                                  	;pop	bx ; **
 39396                                  
 39397 00005E90 C3                      	retn
 39398                                  
 39399                                  ; -----------------------------------------------------------------------------
 39400                                  ;*** toDigit - converts a character-digit to its binary counterpart
 39401                                  ;            -- verifies that CL contains a valid character-digit; if so, it
 39402                                  ; changes CL to its counterpart binary digit ((CL-'0') or (CL-'A'+10)).  A-F
 39403                                  ; are considered valid iff gnradix is 16.
 39404                                  ; -----------------------------------------------------------------------------
 39405                                  ; ENTRY:    CL contains a digit ('0' to '9' or, if gnradix==16, 'A' to 'F')
 39406                                  ; EXIT:     CL contains digit in binary (0 to 9 or, if gnradix==16, 0 to 15)
 39407                                  ; ERROR:    Carry set indicates invalid digit; carry clear indicates good digit
 39408                                  ; USES:     CL, Flags
 39409                                  ; -----------------------------------------------------------------------------
 39410                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 39411                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 39412                                  ; will be 10 or 16.
 39413                                  ; -----------------------------------------------------------------------------
 39414                                  
 39415                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39416                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6358h
 39417                                  gnradix:
 39418 00005E91 0000                    	dw	0		; Must be a word--16x16 multiplication
 39419                                  
 39420                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39421                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:635Ah
 39422                                  
 39423                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39424                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:61D7h
 39425                                  toDigit:
 39426                                  	;cmp	word [gnradix],16
 39427 00005E93 803E[915E]10            	cmp	byte [gnradix],16
 39428 00005E98 751C                    	jne	short td20	; Don't check hex digits if radix isn't 16
 39429                                  
 39430 00005E9A 80F961                  	cmp	cl,'a'
 39431 00005E9D 7209                    	jb	short td10
 39432 00005E9F 80F966                  	cmp	cl,'f'
 39433 00005EA2 7720                    	ja	short tdE	; Nothing valid above 'z' at all...
 39434 00005EA4 80E957                  	sub	cl,'a'-10 ; 57h	; Make 'a'==10 and return.
 39435                                  ;	clc			; <- CLC is implicit from last SUB
 39436 00005EA7 C3                      	retn
 39437                                  td10:
 39438 00005EA8 80F941                  	cmp	cl,'A'
 39439 00005EAB 7209                    	jb	short td20	; Below 'A'?  Not a letter...
 39440 00005EAD 80F946                  	cmp	cl,'F'
 39441 00005EB0 7712                    	ja	short tdE	; Above 'F'?  Not a digit.
 39442 00005EB2 80E937                  	sub	cl,'A'-10 ; 37h	; Make 'A'==10 and return.
 39443                                  ;	clc			; <- CLC is implicit from last SUB
 39444                                  tdErr:
 39445 00005EB5 C3                      	retn
 39446                                  td20:
 39447 00005EB6 80F930                  	cmp	cl,'0'		; If less than zero,
 39448                                  	;jb	short tdE	; Done.
 39449 00005EB9 72FA                    	jb	short tdErr ; cf = 1
 39450 00005EBB 80F939                  	cmp	cl,'9'		; Or, if greater than nine,
 39451 00005EBE 7704                    	ja	short tdE	; Done.
 39452 00005EC0 80E930                  	sub	cl,'0'	  ; 30h	; Okay--make '0'==0 and return.
 39453                                  ;	clc			; <- CLC is implicit from last SUB
 39454 00005EC3 C3                      	retn
 39455                                  tdE:
 39456 00005EC4 F9                      	stc
 39457 00005EC5 C3                      	retn
 39458                                  
 39459                                  ; -----------------------------------------------------------------------------
 39460                                  ;*** GetXNum - reads a 32-bit ASCII number at ES:SI and returns it in DX:AX
 39461                                  ; -----------------------------------------------------------------------------
 39462                                  ; ENTRY:    ES:SI points to an ascii string to scan
 39463                                  ; EXIT:     ES:SI moved to first invalid digit, DX:AX contains value read
 39464                                  ; ERROR:    Carry set if # is too big, or has no digits (EOL possibly)
 39465                                  ; USES:     ES:SI, DX, AX, Flags, gnradix
 39466                                  ; -----------------------------------------------------------------------------
 39467                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 39468                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 39469                                  ; will be 10 or 16.
 39470                                  ; -----------------------------------------------------------------------------
 39471                                  
 39472                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39473                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39474                                  GetXNum:
 39475                                  	;pushreg <bx,cx,ds>
 39476                                  	
 39477                                  	;push	bx ; **
 39478 00005EC6 51                      	push	cx ; *
 39479                                  	
 39480                                  	;push	ds
 39481                                  
 39482 00005EC7 FC                      	cld
 39483 00005EC8 31C0                    	xor	ax,ax
 39484 00005ECA 31DB                    	xor	bx,bx
 39485 00005ECC 31C9                    	xor	cx,cx
 39486 00005ECE 31D2                    	xor	dx,dx		; Start with 0 (makes sense)
 39487                                  
 39488                                  	;mov	word [gnradix],10 ; And default to a radix of 10 (dec)
 39489 00005ED0 C606[915E]0A            	mov	byte [gnradix],10
 39490                                  
 39491 00005ED5 268A0C                  	mov	cl,[es:si]	; Now AX=0, BX=0, CH=0/CL=char, DX=0
 39492 00005ED8 E8B8FF                  	call	toDigit
 39493 00005EDB 722D                    	jc	short gxnE	; If it's not a digit, leave now.
 39494                                  
 39495 00005EDD 08C9                    	or	cl,cl
 39496 00005EDF 7515                    	jnz	short gxn20	; Doesn't have '0x'
 39497 00005EE1 268A4C01                	mov	cl,[es:si+1]
 39498 00005EE5 80F978                  	cmp	cl,'x'		; Either 'x'...
 39499 00005EE8 7405                    	je	short gxn10
 39500 00005EEA 80F958                  	cmp	cl,'X'		; ...or 'X' means it's hexadecimal
 39501 00005EED 7507                    	jne	short gxn20
 39502                                  
 39503                                  gxn10:
 39504                                  	;mov	word [gnradix],16
 39505 00005EEF C606[915E]10            	mov	byte [gnradix],16
 39506 00005EF4 46                      	inc	si		; Since we read "0x", march over it.
 39507 00005EF5 46                      	inc	si
 39508                                  
 39509                                  ; ------------------------------------------------------
 39510                                  ; GXN20--ES:SI = a digit in a number; if not, we're done
 39511                                  ;        DX:AX = current total
 39512                                  ;        BX    = 0
 39513                                  ;        CH    = 0
 39514                                  ; ------------------------------------------------------
 39515                                  
 39516                                  gxn20:
 39517 00005EF6 268A0C                  	mov	cl,[es:si]	; Now DX:AX=current total, CH=0/CL=char
 39518 00005EF9 46                      	inc	si
 39519                                  
 39520 00005EFA E896FF                  	call	toDigit		; Accepts only valid digits, A-F -> 10-16
 39521 00005EFD 720D                    	jc	short gxnQ	; <- Ah... wasn't a digit. Stop.
 39522                                  
 39523 00005EFF E80E00                  	call	mul32		; Multiply DX:AX by gnradix
 39524 00005F02 7206                    	jc	short gxnX	; (if it's too big, error out)
 39525                                  
 39526 00005F04 01C8                    	add	ax,cx		; Add the digit
 39527 00005F06 11DA                    	adc	dx,bx		; (BX is 0!)--Adds 1 if last add wrapped
 39528                                  	;jc	short gxnX	; If _that_ wrapped, it's too big.
 39529                                  	;jmp	short gxn20
 39530 00005F08 73EC                    	jnc	short gxn20
 39531                                  gxnE:
 39532                                  	; cf = 1
 39533                                  	;stc			; In this case, we need to set the carry
 39534                                  	;jmp	short gxnX	; and leave--there were no digits given.
 39535                                  ;gxnQ:
 39536                                  	;dec	si		; Don't read in the offensive character.
 39537                                  	;clc			; And clear carry, so they know it's okay.
 39538                                  gxnX:
 39539                                  	;popreg	<ds,cx,bx>
 39540                                  
 39541                                  	;pop	ds
 39542                                  
 39543 00005F0A 59                      	pop	cx ; *
 39544                                  	;pop	bx ; **
 39545                                  
 39546 00005F0B C3                      	retn
 39547                                  gxnQ:
 39548 00005F0C 4E                      	dec	si
 39549 00005F0D F8                      	clc
 39550 00005F0E EBFA                    	jmp	short gxnX
 39551                                  
 39552                                  ; -----------------------------------------------------------------------------
 39553                                  ;*** mul32 - multiplies the number in DX:AX by gnradix
 39554                                  ; -----------------------------------------------------------------------------
 39555                                  ; ENTRY:   DX:AX = the number to be multiplied, BX = 0, gnradix = multiplier
 39556                                  ; EXIT:    DX:AX has been multiplied by gnradix if carry clear; BX still 0
 39557                                  ; ERROR:   Carry set if number was too large
 39558                                  ; USES:    Flags, AX, DX
 39559                                  ; -----------------------------------------------------------------------------
 39560                                  
 39561                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39562                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39563                                  mul32:
 39564 00005F10 50                      	push	ax		; DX=old:hi, AX=old:lo, TOS=old:lo, BX=0
 39565 00005F11 89D0                    	mov	ax,dx		; DX=old:hi, AX=old:hi, TOS=old:lo, BX=0
 39566 00005F13 F726[915E]              	mul	word [gnradix]	; DX=?,      AX=new:hi, TOS=old:lo, BX=0
 39567 00005F17 7210                    	jc	short m32E	; Too big?
 39568                                  
 39569 00005F19 89C2                    	mov	dx,ax		; DX=new:hi, AX=new:hi, TOS=old:lo, BX=0
 39570 00005F1B 58                      	pop	ax		; DX=new:hi, AX=old:lo, TOS=orig,   BX=0
 39571                                  
 39572 00005F1C 87DA                    	xchg	dx,bx		; DX=0,      AX=old:lo, TOS=orig,   BX=new:hi
 39573 00005F1E F726[915E]              	mul	word [gnradix]	; DX=carry,  AX=new:lo, TOS=orig,   BX=new:hi
 39574 00005F22 87DA                    	xchg	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig,   BX=carry
 39575 00005F24 01DA                    	add	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig,   BX=carry
 39576 00005F26 31DB                    	xor	bx,bx		; DX=new:hi, AX=new:lo, TOS=orig,   BX=0
 39577 00005F28 C3                      	retn
 39578                                  m32E:
 39579 00005F29 58                      	pop	ax
 39580 00005F2A C3                      	retn
 39581                                  
 39582                                  ; -----------------------------------------------------------------------------
 39583                                  ;*** toPara - divides DX:AX by 16; result in AX only (discards extra DX data)
 39584                                  ; -----------------------------------------------------------------------------
 39585                                  ; ENTRY:   DX:AX = the number to be divided
 39586                                  ; EXIT:    Interpereting DX:AX as bytes, AX=paragraph equivalent, 0xFFFF max
 39587                                  ; ERROR:   None
 39588                                  ; USES:    Flags, AX, DX
 39589                                  ; -----------------------------------------------------------------------------
 39590                                  ; Note: The 386 has a 32-bit SHR, which would work perfectly for this... but we
 39591                                  ;       can't ensure a 386 host machine. Sorry.
 39592                                  ; -----------------------------------------------------------------------------
 39593                                  
 39594                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39595                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39596                                  toPara:
 39597 00005F2B 51                      	push	cx		; DX:AX=HHHH hhhh hhhh hhhh:LLLL llll llll llll
 39598                                  
 39599 00005F2C B104                    	mov	cl,4		;
 39600 00005F2E D3E8                    	shr	ax,cl		; DX:AX=HHHH hhhh hhhh hhhh:0000 LLLL llll llll
 39601 00005F30 92                      	xchg	ax,dx		; DX:AX=0000 LLLL llll llll:HHHH hhhh hhhh hhhh
 39602 00005F31 B10C                    	mov	cl,12
 39603 00005F33 D3E0                    	shl	ax,cl		; DX:AX=0000 LLLL llll llll:hhhh 0000 0000 0000
 39604 00005F35 09D0                    	or	ax,dx		;    AX=hhhh LLLL llll llll
 39605                                  
 39606 00005F37 59                      	pop	cx
 39607 00005F38 C3                      	retn
 39608                                  
 39609                                  ; -----------------------------------------------------------------------------
 39610                                  ;*** UmbHead - returns in AX the address of the first UMB block (0x9FFF)
 39611                                  ; -----------------------------------------------------------------------------
 39612                                  ; ENTRY:  Nothing
 39613                                  ; EXIT:   AX contains 0x9FFF for most systems
 39614                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
 39615                                  ; USES:   Flags, AX
 39616                                  ; -----------------------------------------------------------------------------
 39617                                  ; Early in the boot-cycle, the pointer used to obtain this value isn't set up;
 39618                                  ; to be precise, before a UMB provider is around.  In this event, the pointer
 39619                                  ; is always set to 0xFFFF; it changes once a provider is around.  On most
 39620                                  ; machines (all of 'em I've seen), it changes to 0x9FFF at that point.
 39621                                  ; -----------------------------------------------------------------------------
 39622                                  
 39623                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39624                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39625                                  UmbHead:
 39626                                  	;pushreg <si,ds,es>
 39627                                  	
 39628                                  	;push	si
 39629                                  	;push	ds
 39630                                  	;push	es
 39631                                  
 39632 00005F39 B452                    	mov	ah,52h	; DOS_GET_DOS_LISTS
 39633                                  					; Call int 21h, function 52h...
 39634 00005F3B CD21                    	int	21h
 39635                                  			; DOS - 2+ internal - GET LIST OF LISTS
 39636                                  			; Return: ES:BX -> DOS list of lists
 39637                                  
 39638                                  	;mov	ax,[es:DOS_UMB_HEAD]	; And read what's in ES:[008C]
 39639 00005F3D 26A18C00                	mov	ax,[es:8Ch]
 39640 00005F41 83F8FF                  	cmp	ax,0FFFFh
 39641                                  	;je	short uhE		; If it's 0xFFFF, it's an error...
 39642                                  
 39643                                  	;clc				; Else, it isn't (CLC done by prev cmp)
 39644                                  	;jmp	short uhX
 39645                                  	; 17/06/2023
 39646 00005F44 F5                      	cmc	; cf = 0 <--> cf = 1
 39647                                  uhE:
 39648                                  	;stc
 39649                                  uhX:	
 39650                                  	;popreg	<es,ds,si>
 39651                                  	
 39652                                  	;pop	es
 39653                                  	;pop	ds
 39654                                  	;pop	si
 39655                                  
 39656 00005F45 C3                      	retn
 39657                                  
 39658                                  ; -----------------------------------------------------------------------------
 39659                                  ;*** isSysMCB - sets ZF iff ES points to an MCB owned by "SC" + (8 or 9)
 39660                                  ; -----------------------------------------------------------------------------
 39661                                  ; ENTRY:  ES:0 should point to a valid MCB
 39662                                  ; EXIT:   ZF set if owned by SC+8 or SC+9 (for japan)
 39663                                  ; USES:   Flags
 39664                                  ; -----------------------------------------------------------------------------
 39665                                  
 39666                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39667                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39668                                  isSysMCB:
 39669                                  	;push	ax
 39670                                  	
 39671                                  	;mov	ax,[es:1]
 39672 00005F46 26A10100                	mov	ax,[es:arena_owner]	; Check the owner...
 39673 00005F4A 83F808                  	cmp	ax,8 ; SystemPSPOwner	; 8 (for US OR Japan) is valid
 39674 00005F4D 7405                    	jz	short ism10
 39675 00005F4F 83F809                  	cmp	ax,9 ; JapanPSPOwner	; 9 (for Japan) is valid
 39676                                  	;jz	short ism10
 39677                                  	;jmp	short ismX		; Anything else isn't.
 39678 00005F52 7507                    	jnz	short ismX
 39679                                  ism10:
 39680                                  	;mov	ax,[es:8]
 39681 00005F54 26A10800                	mov	ax,[es:arena_name]	; Check the name...
 39682 00005F58 3D5343                  	cmp	ax,'SC' ; cmp ax,4353h
 39683                                  ismX:
 39684                                  	;pop	ax
 39685 00005F5B C3                      	retn
 39686                                  
 39687                                  ; -----------------------------------------------------------------------------
 39688                                  ;*** AddrToUmb - converts a segment address in AX to its appropriate UMB number
 39689                                  ; -----------------------------------------------------------------------------
 39690                                  ; ENTRY:  AX contains a segment address
 39691                                  ; EXIT:   AX will contain the UMB number which contains the address (0==conv)
 39692                                  ; ERROR:  If the address is above UM Range, AX will return as FFFF.
 39693                                  ; USES:   Flags, AX
 39694                                  ; -----------------------------------------------------------------------------
 39695                                  ; An address in the following areas is treated as:
 39696                                  ;    0      <-> umbhead (0x9FFF)          = Conventional memory
 39697                                  ;    0x9FFF <-> addr of first UM sys MCB  = UMB #1
 39698                                  ;      ...
 39699                                  ;    addr of last UM sys MCB <-> TOM      = invalid; returns #0xFFFF
 39700                                  ; -----------------------------------------------------------------------------
 39701                                  
 39702                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39703                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39704                                  AddrToUmb:
 39705                                  	;pushreg <cx,dx,es>
 39706                                  	
 39707                                  	;push	cx
 39708                                  	;push	dx
 39709 00005F5C 06                      	push	es
 39710                                  
 39711 00005F5D 89C2                    	mov	dx,ax		; DX = address to search for
 39712                                  
 39713 00005F5F E8D7FF                  	call	UmbHead		; AX = first segment
 39714 00005F62 722B                    	jc	short atuE	; If it couldn't get it, error out.
 39715                                  
 39716                                  	;mov	es,ax ; *	; ES = first UMB segment
 39717 00005F64 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now... (cx = UMB#)
 39718                                  
 39719                                  ; ----------------------------------------
 39720                                  ; ATU10--ES - Current MCB address
 39721                                  ;        DX - Address given for conversion
 39722                                  ;        CX - Current UMB #
 39723                                  ; ----------------------------------------
 39724                                  
 39725                                  	; 17/06/2023
 39726                                  atu10:
 39727 00005F66 8EC0                    	mov	es,ax ; *
 39728                                  ;atu10:
 39729                                  	;mov	ax,es
 39730 00005F68 39D0                            cmp	ax,dx		; Present segment >= given segment?
 39731 00005F6A 7326                    	jae	short atuX	; Yep--done.
 39732                                  
 39733 00005F6C E8D7FF                  	call	isSysMCB	; Returns with ZF set if this is a system MCB
 39734 00005F6F 7501                    	jnz	short atu20
 39735                                  
 39736 00005F71 41                      	inc	cx		; If it _was_ a system MCB, we're in a new UMB.
 39737                                  atu20:
 39738                                  	;mov	al,[es:0]
 39739 00005F72 26A00000                	mov	al,[es:arena_signature]
 39740                                  	;cmp	al,'Z' ; 5Ah
 39741 00005F76 3C5A                    	cmp	al,arena_signature_end
 39742 00005F78 740A                    	je	short atu30	; 'Z' means this was the last MCB... that's it.
 39743                                  
 39744                                  	;NextMCB es,ax
 39745 00005F7A 8CC0                    	mov	ax,es
 39746                                  	;add	ax,[es:3]	; NextMCB (macro)
 39747 00005F7C 2603060300              	add	ax,[es:arena_size]
 39748 00005F81 40                      	inc	ax
 39749                                  	;mov	es,ax ; * ; 17/06/2023
 39750 00005F82 EBE2                    	jmp	short atu10
 39751                                  
 39752                                  ; -----------------------------------------------------------------------------
 39753                                  ; if we get to atu30, they specified a number that was past the last MCB.
 39754                                  ; make sure it's not _inside_ that MCB before we return an error condition.
 39755                                  ; -----------------------------------------------------------------------------
 39756                                  
 39757                                  atu30:
 39758 00005F84 8CC0                    	mov	ax,es
 39759                                  	;add	ax,[es:3]
 39760 00005F86 2603060300              	add	ax,[es:arena_size]
 39761 00005F8B 39D0                    	cmp	ax,dx		; Present >= given?
 39762 00005F8D 7303                    	jae	short atuX	; Yep! It _was_ inside.
 39763                                  atuE:
 39764 00005F8F 31C9                    	xor	cx,cx		; Else, fall through with UMB # == -1
 39765 00005F91 49                      	dec	cx		; (that makes it return 0xFFFF and sets CF)
 39766                                  atuX:	
 39767 00005F92 89C8                    	mov	ax,cx		; Return the UMB number in AX
 39768                                  	
 39769                                  	;popreg	<es,dx,cx>
 39770                                  
 39771 00005F94 07                      	pop	es
 39772                                  	;pop	dx
 39773                                  	;pop	cx
 39774                                  	
 39775 00005F95 C3                      	retn
 39776                                  
 39777                                  ; -----------------------------------------------------------------------------
 39778                                  ;*** convUMB - checks after GetXNum to convert an address to a UMB number
 39779                                  ;            -- if GetXNum read a hex number, we interperete that as a segment
 39780                                  ; address rather than a UMB number... and use that address to look up a UMB.
 39781                                  ; This routine checks for that condition and calls AddrToUmb if necessary.
 39782                                  ; -----------------------------------------------------------------------------
 39783                                  ; ENTRY:  AX contains a UMB number or segment, gnradix has been set by GetXNum
 39784                                  ; EXIT:   AX will contain a UMB number
 39785                                  ; ERROR:  None
 39786                                  ; USES:   Flags, AX
 39787                                  ; -----------------------------------------------------------------------------
 39788                                  
 39789                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39790                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39791                                  convUMB:
 39792                                  	;cmp	word [gnradix],16
 39793 00005F96 803E[915E]10            	cmp	byte [gnradix],16
 39794 00005F9B 7509                    	jne	short cu10	; If it didn't read in hex, it's not an address
 39795 00005F9D E8BCFF                  	call	AddrToUmb	; Else, convert the address to a UMB number
 39796 00005FA0 83F8FF                  	cmp	ax,0FFFFh
 39797 00005FA3 7501                    	jne	short cu10
 39798 00005FA5 40                      	inc	ax ; ax = 0	; If too high, ignore it (make it conventional)
 39799                                  cu10:
 39800 00005FA6 C3                      	retn
 39801                                  
 39802                                  ; -----------------------------------------------------------------------------
 39803                                  ;*** setUMBs - links umbs and sets allocation strategy for a load
 39804                                  ;            -- if LoadHigh, the allocation strategy MAY be LOW_FIRST instead
 39805                                  ; of the usual HIGH_FIRST.  See the code.
 39806                                  ; -----------------------------------------------------------------------------
 39807                                  ; ENTRY:  None
 39808                                  ; EXIT:   None
 39809                                  ; ERROR:  None
 39810                                  ; USES:   Flags, fm_umb, fm_strat
 39811                                  ; -----------------------------------------------------------------------------
 39812                                  
 39813                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39814                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39815                                  setUMBs:
 39816                                  	;pushreg <ax,bx>
 39817                                  	
 39818                                  	;push	ax
 39819                                  	;push	bx
 39820                                  
 39821 00005FA7 E8B2FD                  	call	fm_link
 39822                                  
 39823 00005FAA B80058                  	mov	ax,5800h ; DOS_CHECK_STRATEGY
 39824 00005FAD CD21                    	int	21h
 39825                                  
 39826                                  	;putdata fm_strat,al	; Store the current strategy for later restore
 39827                                  
 39828                                  	;push	es
 39829                                  	;mov	es,[RESSEG]
 39830                                  	;mov	[es:fm_strat],al ; store the current strategy
 39831                                  	;pop	es
 39832 00005FAF 1E                      	push	ds ; *
 39833 00005FB0 8E1E[F59B]              	mov	ds,[RESSEG]
 39834 00005FB4 A2[3605]                	mov	[fm_strat],al
 39835                                  	;pop	ds ; *
 39836                                  
 39837 00005FB7 83E07F                  	and	ax,007Fh	; 0000.0000.0111.1111 == All that other stuff
 39838 00005FBA 50                      	push	ax ; **		; Watch this carefully...
 39839                                  
 39840 00005FBB E80C00                  	call	loadLow		; returns al==0 if load low, al==1 if loadhigh
 39841 00005FBE D0C8                    	ror	al,1		; Shift that to al==0 or al==0x80
 39842                                  
 39843 00005FC0 5B                      	pop	bx ; **		; ...pushed as AX above
 39844                                  	
 39845 00005FC1 1F                      	pop	ds ; *
 39846                                  	
 39847 00005FC2 08C3                    	or	bl,al		; Now we have 0000.0000.?111.1111 in BX;
 39848                                  
 39849 00005FC4 B80158                  	mov	ax,5801h ; DOS_SET_STRATEGY
 39850                                  				; with ? ==1 if load highfirst. Perfect!
 39851 00005FC7 CD21                    	int	21h
 39852                                  
 39853                                  	;popreg	<bx,ax>
 39854                                  
 39855                                  	;pop	bx
 39856                                  	;pop	ax
 39857                                  
 39858 00005FC9 C3                      	retn
 39859                                  
 39860                                  ; -----------------------------------------------------------------------------
 39861                                  ;*** loadLow - returns AL==0 if UMB0 == 0, else AL==1
 39862                                  ; -----------------------------------------------------------------------------
 39863                                  ; ENTRY:  None
 39864                                  ; EXIT:   AL==0 if mem strategy should be set to LOW_FIRST, else AL==1
 39865                                  ;         Carry set if UMB0 not specified (_NOT_ an error)
 39866                                  ; ERROR:  None
 39867                                  ; USES:   Flags, fm_strat, fm_umb
 39868                                  ; -----------------------------------------------------------------------------
 39869                                  ; We want to set the memory strategy to LOW_FIRST if the user specified a
 39870                                  ; load UMB, and it is 0.  That 0 can be either from the user having _specified_
 39871                                  ; zero (/L:0;...), or from having specified a too-big min size (/L:1,99999999)
 39872                                  ; such that the load UMB is too small, and shouldn't be used.
 39873                                  ; -----------------------------------------------------------------------------
 39874                                  
 39875                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39876                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39877                                  loadLow:
 39878                                  	;push	ds ; *	
 39879                                  	
 39880                                  	;dataseg ds		; Point DS into appropriate data segment
 39881                                  	;mov	ds,[RESSEG]
 39882                                  
 39883                                  	; * ; ds = [RESSEG] from 'setUMBs') ; 17/06/2023
 39884                                  
 39885 00005FCA A0[3405]                	mov	al,[UmbLoad]
 39886 00005FCD 3CFF                    	cmp	al,0FFh ; UNSPECIFIED
 39887 00005FCF 7503                    	jne	short ll10
 39888                                  
 39889                                  	;mov	al,1		; Return with AL==1 && STC if no UMBs specified
 39890 00005FD1 F9                      	stc
 39891                                  	;jmp	short llX
 39892 00005FD2 EB04                    	jmp	short lly ; 17/06/2023
 39893                                  ll10:
 39894 00005FD4 08C0                    	or	al,al		; AL=the load UMB: Is it == 0?
 39895 00005FD6 7402                    	jz	short llX	; Yep... CF==0 (from OR) && AL=0, so just exit
 39896                                  	; cf= 0
 39897                                  
 39898                                  	;mov	al,1
 39899                                  	;clc	
 39900                                  lly:		; 17/06/2023
 39901 00005FD8 B001                    	mov	al,1
 39902                                  llX:
 39903                                  	;pop	ds ; *		; Return DS to where it was
 39904                                  	
 39905                                  	;normseg ds		;
 39906                                  	
 39907 00005FDA C3                      	retn
 39908                                  
 39909                                  ; -----------------------------------------------------------------------------
 39910                                  ;*** HideUMBs - links UMBs and hides upper-memory as appropriate
 39911                                  ; -----------------------------------------------------------------------------
 39912                                  ; ENTRY:  None
 39913                                  ; EXIT:   None
 39914                                  ; ERROR:  None
 39915                                  ; USES:   Flags, fm_strat, fm_umb
 39916                                  ; -----------------------------------------------------------------------------
 39917                                  
 39918                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39919                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:64D0h
 39920                                  
 39921                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 39922                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:634Dh
 39923                                  HideUMBs:
 39924                                  	;pushreg <ax,cx,ds,es>
 39925                                  	
 39926                                  	;push	ax
 39927                                  	;push	cx
 39928                                  	;push	ds
 39929                                  	;push	es
 39930                                  
 39931 00005FDB E8EF01                  	call	UmbTest		; See if we REALLY linked in anything...
 39932 00005FDE 7236                    	jc	short husX	; ...if not, there's nothing for us to do.
 39933                                  
 39934 00005FE0 E82CFD                  	call	FixMem		; Concatenate adjacent free MCBs in upper mem
 39935 00005FE3 E8C1FF                  	call	setUMBs		; Link UMBs and set memory-allocation strategy
 39936                                  
 39937                                  	;putdata fInHigh,1	; Remember that we're now running high
 39938                                  	;push	es
 39939                                  	;mov	es,[RESSEG]
 39940                                  	;mov	byte [es:fInHigh], 1
 39941                                  	;			; remember that we're now running high
 39942                                  	;pop	es
 39943 00005FE6 1E                      	push	ds
 39944 00005FE7 8E1E[F59B]              	mov	ds,[RESSEG]
 39945 00005FEB C606[3005]01            	mov	byte [fInHigh], 1
 39946 00005FF0 1F                      	pop	ds
 39947                                  
 39948 00005FF1 E82300                  	call	GetLoadUMB	; See if they gave us a list to leave free
 39949 00005FF4 3CFF                    	cmp	al,0FFh	; UNSPECIFIED
 39950                                  				; If they didn't,
 39951 00005FF6 741E                    	je	short husX	; then we shouldn't do this loop:
 39952                                  
 39953 00005FF8 31C9                    	xor	cx,cx
 39954                                  
 39955                                  ; -----------------------------------------------
 39956                                  ; HUS10-CX - UMB number (after inc, 1==first UMB)
 39957                                  ; -----------------------------------------------
 39958                                  
 39959                                  hus10:
 39960 00005FFA 41                      	inc	cx		; For each UMB:
 39961 00005FFB 83F910                  	cmp	cx,16 ; MAXUMB
 39962 00005FFE 730C                    	jae	short hus20
 39963                                  
 39964 00006000 88C8                    	mov	al,cl		; (stopping as soon as we're outside of the
 39965                                  	; 17/06/2023
 39966                                  	;push	es
 39967 00006002 E8A900                  	call	findumb		; valid range of UMBs)
 39968                                  	;pop	es		; push/pop: trash what findumb finds.  :-)
 39969 00006005 7205                    	jc	short hus20
 39970                                  
 39971 00006007 E87901                  	call	hideUMB?	; hide what we need to hide.
 39972                                  
 39973 0000600A EBEE                    	jmp	short hus10
 39974                                  hus20:
 39975 0000600C E80800                  	call	GetLoadUMB	; Now check if they offered /L:0
 39976 0000600F 08C0                    	or	al,al		; --Is the load UMB 0? (-1==unspecified)
 39977 00006011 7503                    	jnz	short husX	; If not, we're done.
 39978                                  
 39979 00006013 E8E701                  	call	hl_unlink	; If so, however, fix UMBs and strategy.
 39980                                  husX:
 39981                                  	;popreg	<es,ds,cx,ax>
 39982                                  	
 39983                                  	;pop	es
 39984                                  	;pop	ds
 39985                                  	;pop	cx
 39986                                  	;pop	ax
 39987                                  
 39988 00006016 C3                      	retn
 39989                                  
 39990                                  ; -----------------------------------------------------------------------------
 39991                                  ;*** GetLoadUMB - Returns the load UMB number in AL (-1 if not specified)
 39992                                  ; -----------------------------------------------------------------------------
 39993                                  ; ENTRY:  None
 39994                                  ; EXIT:   AL == load UMB
 39995                                  ; ERROR:  None
 39996                                  ; USES:   Flags, AX
 39997                                  ; -----------------------------------------------------------------------------
 39998                                  
 39999                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40000                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40001                                  GetLoadUMB:
 40002                                  	;getdata al,UmbLoad
 40003                                  
 40004 00006017 1E                      	push    ds
 40005 00006018 8E1E[F59B]              	mov     ds,[RESSEG]   ; getdata (macro)
 40006 0000601C A0[3405]                	mov     al,[UmbLoad]
 40007 0000601F 1F                      	pop     ds
 40008                                  
 40009 00006020 C3                      	retn
 40010                                  
 40011                                  ; -----------------------------------------------------------------------------
 40012                                  ;*** GetSize - Returns the UMB in AL's minimum size (0 if not specified)
 40013                                  ; -----------------------------------------------------------------------------
 40014                                  ; ENTRY:  AL == a UMB number
 40015                                  ; EXIT:   AX == UMB minimum size, as specified by the user
 40016                                  ; ERROR:  None
 40017                                  ; USES:   Flags, AX
 40018                                  ; -----------------------------------------------------------------------------
 40019                                  
 40020                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40021                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40022                                  GetSize:
 40023                                  	;pushreg <bx,si,ds>
 40024                                  	;push	bx
 40025                                  	;push	si
 40026 00006021 1E                      	push	ds
 40027                                  	
 40028                                  	;dataseg ds
 40029 00006022 8E1E[F59B]              	mov	ds,[RESSEG]
 40030                                  
 40031 00006026 30E4                    	xor	ah,ah			;    ax==UMB
 40032                                  	;mov	bx,offset UmbSize
 40033 00006028 BB[6E04]                	mov	bx,UmbSize		;    bx==array
 40034 0000602B D0E0                    	shl	al,1	                ;    ax==offset
 40035                                  	;add	ax,bx			;    ax==element index
 40036                                  	;mov	si,ax			; ds:si==element index
 40037                                  	;lodsw				;    ax==size
 40038 0000602D 01C3                    	add	bx,ax
 40039 0000602F 8B07                    	mov	ax,[bx]
 40040                                  
 40041                                  	;popreg	<ds,si,bx>
 40042 00006031 1F                      	pop	ds
 40043                                  	;pop	si
 40044                                  	;pop	bx
 40045                                  
 40046                                  	;normseg ds
 40047 00006032 C3                      	retn
 40048                                  
 40049                                  ; -----------------------------------------------------------------------------
 40050                                  ;*** hideUMB - marks as HIDDEN all FREE elements in UMB passed as AL
 40051                                  ; -----------------------------------------------------------------------------
 40052                                  ; ENTRY:    AL must indicate a valid UMB; 0==conv && is invalid.
 40053                                  ; EXIT:     None; free elements in UMB marked as hidden
 40054                                  ; ERROR:    None
 40055                                  ; USES:     Flags
 40056                                  ; -----------------------------------------------------------------------------
 40057                                  
 40058                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40059                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40060                                  hideUMB:
 40061                                  	;pushreg <ax,es>
 40062                                  	
 40063                                  	;push	ax
 40064                                  	;push	es
 40065                                  
 40066 00006033 E87800                  	call	findumb		; Returns with carry if err, else ES == MCB
 40067 00006036 7221                    	jc	short huX
 40068                                  
 40069                                  ; ------------------------------------------------
 40070                                  ; HU10--ES - MCB inside UMB; if it's a system MCB,
 40071                                  ;            we're not in the same UMB, so exit.
 40072                                  ; ------------------------------------------------
 40073                                  
 40074                                  hu10:
 40075 00006038 E80BFF                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 40076 0000603B 741C                    	jz	short huX	; If it is, we've finished the UMB.
 40077 0000603D E82800                  	call	isFreeMCB	; Returns with ZF set if owner is 0
 40078 00006040 7503                    	jnz	short hu20
 40079                                  
 40080 00006042 E82A00                  	call	hideMCB
 40081                                  hu20:
 40082                                  	;mov	al,[es:0]
 40083 00006045 26A00000                	mov	al,[es:arena_signature]
 40084                                  	;cmp	al,'Z'
 40085 00006049 3C5A                    	cmp	al,arena_signature_end
 40086 0000604B 740C                    	je	short huX	; 'Z' means this was the last MCB... that's it.
 40087                                  
 40088                                  	;NextMCB es,ax		; Go on forward.
 40089                                  
 40090 0000604D 8CC0                     	mov	ax,es		; NextMCB (macro)
 40091                                  	;add	ax,[es:3]
 40092 0000604F 2603060300              	add	ax,[es:arena_size]
 40093 00006054 40                      	inc	ax
 40094 00006055 8EC0                    	mov	es,ax
 40095                                  
 40096 00006057 EBDF                    	jmp	short hu10
 40097                                  huX:
 40098                                  	;popreg	<es,ax>
 40099                                  	
 40100                                  	;pop	es
 40101                                  	;pop	ax
 40102                                  
 40103 00006059 C3                      	retn
 40104                                  
 40105                                  ; -----------------------------------------------------------------------------
 40106                                  ;*** isTiny - returns with ZF set if user didn't specify /S
 40107                                  ; -----------------------------------------------------------------------------
 40108                                  ; ENTRY:    None
 40109                                  ; EXIT:     ZF set if user DIDN'T specify /S
 40110                                  ; ERROR:    None
 40111                                  ; USES:     Flags
 40112                                  ; -----------------------------------------------------------------------------
 40113                                  
 40114                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40115                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40116                                  isTiny:
 40117 0000605A 50                      	push	ax
 40118                                  
 40119                                  	;getdata al,fUmbTiny
 40120 0000605B 1E                      	push    ds
 40121 0000605C 8E1E[F59B]              	mov     ds,[RESSEG]   ; getdata (macro)
 40122 00006060 A0[3105]                	mov     al,[fUmbTiny]
 40123 00006063 1F                      	pop     ds
 40124                                  
 40125 00006064 08C0                    	or	al,al
 40126 00006066 58                      	pop	ax
 40127 00006067 C3                      	retn
 40128                                  
 40129                                  ; -----------------------------------------------------------------------------
 40130                                  ;*** isFreeMCB - returns with ZF set if current MCB (ES:0) is FREE
 40131                                  ; -----------------------------------------------------------------------------
 40132                                  ; ENTRY:    ES:0 should point to an MCB
 40133                                  ; EXIT:     ZF set if MCB is free, else !ZF
 40134                                  ; ERROR:    None
 40135                                  ; USES:     Flags
 40136                                  ; -----------------------------------------------------------------------------
 40137                                  
 40138                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40139                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40140                                  isFreeMCB:
 40141                                  	;or	word [es:1],0
 40142 00006068 26830E010000            	or	word [es:arena_owner],0
 40143 0000606E C3                      	retn
 40144                                  
 40145                                  ; -----------------------------------------------------------------------------
 40146                                  ;*** hideMCB - marks as HIDDEN the MCB at ES:0
 40147                                  ; -----------------------------------------------------------------------------
 40148                                  ; ENTRY:    ES:0 should point to an MCB
 40149                                  ; EXIT:     None; MCB marked as HIDDEN
 40150                                  ; ERROR:    None
 40151                                  ; USES:     None
 40152                                  ; -----------------------------------------------------------------------------
 40153                                  
 40154                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40155                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40156                                  hideMCB:
 40157                                  	;mov	word [es:1],8
 40158 0000606F 26C70601000800          	mov	word [es:arena_owner],8 ; SystemPSPOwner
 40159                                  	;mov	word [es:8],4948h     ; 'HIDDEN  ' 
 40160 00006076 26C70608004849          	mov	word [es:arena_name+0], 'HI' ; 4948h
 40161 0000607D 26C7060A004444          	mov	word [es:arena_name+2], 'DD' ; 4444h
 40162 00006084 26C7060C00454E          	mov	word [es:arena_name+4], 'EN' ; 4E45h
 40163                                  	;mov	word [es:14],2020h
 40164 0000608B 26C7060E002020          	mov	word [es:arena_name+6], '  ' ; 2020h 
 40165 00006092 C3                      	retn
 40166                                  
 40167                                  ; -----------------------------------------------------------------------------
 40168                                  ;*** unHideMCB - marks as FREE the MCB at ES:0
 40169                                  ; -----------------------------------------------------------------------------
 40170                                  ; ENTRY:    ES:0 should point to an MCB
 40171                                  ; EXIT:     None; MCB marked as FREE
 40172                                  ; ERROR:    None
 40173                                  ; USES:     None
 40174                                  ; -----------------------------------------------------------------------------
 40175                                  
 40176                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40177                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40178                                  unHideMCB:
 40179                                  	;push	ax
 40180                                  	;mov	word [es:1],0
 40181 00006093 26C70601000000          	mov	word [es:arena_owner],0 ; FreePSPOwner
 40182 0000609A B82020                  	mov	ax, '  '  ; mov ax,2020h
 40183                                  	;mov	[es:8],ax
 40184 0000609D 26A30800                	mov	[es:arena_name+0],ax
 40185 000060A1 26A30A00                	mov	[es:arena_name+2],ax
 40186 000060A5 26A30C00                	mov	[es:arena_name+4],ax
 40187                                  	;mov	[es:14],ax
 40188 000060A9 26A30E00                	mov	[es:arena_name+6],ax
 40189                                  	;pop	ax
 40190 000060AD C3                      	retn
 40191                                  
 40192                                  ; -----------------------------------------------------------------------------
 40193                                  ;*** findUMB - makes ES:0 point to the first MCB in UMB given as AL
 40194                                  ;            -- returns UmbHEAD pointer (0x9FFF) if passed AL==0
 40195                                  ; -----------------------------------------------------------------------------
 40196                                  ; ENTRY:    AL should be to a valid UMB number
 40197                                  ; EXIT:     ES:0 points to first MCB in UMB (_not_ the 8+SC MCB that heads it)
 40198                                  ; ERROR:    Carry set if couldn't reach UMB (too high)
 40199                                  ; USES:     Flags, ES
 40200                                  ; -----------------------------------------------------------------------------
 40201                                  
 40202                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40203                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40204                                  findumb:
 40205                                  	;pushreg <ax,cx,dx>
 40206                                  	
 40207                                  	;push	ax
 40208 000060AE 51                      	push	cx
 40209 000060AF 52                      	push	dx
 40210                                  
 40211 000060B0 30E4                    	xor	ah,ah		; Zap ah, so al==ax
 40212                                  
 40213 000060B2 89C2                    	mov	dx,ax		; Store the to-be-found UMB number in DX
 40214                                  
 40215 000060B4 E882FE                  	call	UmbHead		; Returns first UMB segment in AX
 40216                                  
 40217 000060B7 8EC0                    	mov	es,ax
 40218 000060B9 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now...
 40219                                  
 40220                                  ; ---------------------------------------------
 40221                                  ; FU10--CX - This UMB number; 0 == conventional
 40222                                  ;       DX - The UMB number they're looking for
 40223                                  ;       ES - The current MCB address
 40224                                  ; ---------------------------------------------
 40225                                  
 40226                                  fu10:	
 40227 000060BB 39D1                    	cmp	cx,dx		; If CX==DX, we've found the UMB we're
 40228 000060BD 741B                    	je	short fuX	; searching for--so exit.
 40229                                  
 40230 000060BF E884FE                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 40231 000060C2 7501                    	jnz	short fu20
 40232                                  
 40233 000060C4 41                      	inc	cx		; If it _was_ SYSTEM, we're in a new UMB.
 40234                                  fu20:
 40235                                  	;mov	al,[es:0]
 40236 000060C5 26A00000                	mov	al,[es:arena_signature]
 40237                                  	;cmp	al,'Z'
 40238 000060C9 3C5A                    	cmp	al,arena_signature_end
 40239 000060CB 740C                    	je	short fuE	; 'Z' means this was the last MCB... that's it.
 40240                                  
 40241                                  	;NextMCB es,ax		; Go on forward.
 40242                                  
 40243 000060CD 8CC0                     	mov	ax,es		; NextMCB (macro)
 40244                                  	;add	ax,[es:3]
 40245 000060CF 2603060300              	add	ax,[es:arena_size]
 40246 000060D4 40                      	inc	ax
 40247 000060D5 8EC0                    	mov	es,ax
 40248                                  
 40249 000060D7 EBE2                    	jmp	short fu10
 40250                                  fuE:
 40251 000060D9 F9                      	stc
 40252                                  fuX:
 40253                                  	;popreg	<dx,cx,ax>	; The address is already in ES.
 40254                                  	
 40255 000060DA 5A                      	pop	dx
 40256 000060DB 59                      	pop	cx
 40257                                  	
 40258                                  	;pop	ax
 40259 000060DC C3                      	retn
 40260                                  
 40261                                  ; -----------------------------------------------------------------------------
 40262                                  ;*** BigFree - makes ES:0 point to the largest free MCB in UMB given as AL
 40263                                  ; -----------------------------------------------------------------------------
 40264                                  ; ENTRY:    AL should be to a valid UMB number
 40265                                  ; EXIT:     ES:0 points to largest free MCB in UMB, AX returns its size
 40266                                  ; ERROR:    Carry set if couldn't reach UMB (0 or too high)
 40267                                  ; USES:     Flags, ES
 40268                                  ; -----------------------------------------------------------------------------
 40269                                  
 40270                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40271                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6624h
 40272                                  
 40273                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40274                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:64A1h
 40275                                  BigFree:
 40276                                  	;pushreg <bx,cx>
 40277                                  	
 40278                                  	;push	bx
 40279 000060DD 51                      	push	cx
 40280                                  
 40281 000060DE E8CDFF                  	call	findumb			; Returns with CF if err, else ES==MCB
 40282 000060E1 7239                    	jc	short bfX		; (would be "jc bfE"; it just does stc)
 40283                                  
 40284 000060E3 31DB                    	xor	bx,bx			; Segment address of largest free MCB
 40285 000060E5 31C9                    	xor	cx,cx			; Size of largest free MCB
 40286                                  
 40287                                  ; ---------------------------------------------
 40288                                  ; BF10--ES - Current MCB address
 40289                                  ;       BX - Address of largest free MCB so far
 40290                                  ;       CX - Size of largest free MCB so far
 40291                                  ; ---------------------------------------------
 40292                                  
 40293                                  bf10:
 40294 000060E7 E85CFE                  	call	isSysMCB		; If we've left the MCB, we're done.
 40295 000060EA 7427                    	jz	short bf30
 40296                                  
 40297 000060EC E879FF                  	call	isFreeMCB		; Returns with ZF set if owner is 0
 40298 000060EF 750E                    	jnz	short bf20
 40299                                  
 40300                                  	;cmp	cx,[es:3]
 40301 000060F1 263B0E0300              	cmp	cx,[es:arena_size]	; Compare sizes...
 40302 000060F6 7F07                    	jg	short bf20		; Unless we're bigger,
 40303                                  
 40304 000060F8 8CC3                    	mov	bx,es			; Store this new element's address,
 40305                                  	;mov	cx,[es:3]
 40306 000060FA 268B0E0300              	mov	cx,[es:arena_size]	; and its size.
 40307                                  bf20:
 40308                                  	;mov	al,[es:0]
 40309 000060FF 26A00000                	mov	al,[es:arena_signature]
 40310                                  	;cmp	al,'Z'  ; 5Ah
 40311 00006103 3C5A                    	cmp	al,arena_signature_end
 40312 00006105 740C                    	je	short bf30		; 'Z' means this was the last MCB.
 40313                                  
 40314                                  	;NextMCB es,ax			; Go on forward.
 40315                                  
 40316 00006107 8CC0                    	mov	ax,es 
 40317                                  	;add	ax,[es:3]
 40318 00006109 2603060300              	add	ax,[es:arena_size]
 40319 0000610E 40                      	inc	ax
 40320 0000610F 8EC0                    	mov	es,ax
 40321                                  
 40322 00006111 EBD4                    	jmp	short bf10
 40323                                  bf30:
 40324 00006113 8EC3                    	mov	es,bx			; Return the address
 40325 00006115 89C8                    	mov	ax,cx			; Return the size
 40326 00006117 09DB                    	or	bx,bx
 40327 00006119 7501                    	jnz	short bfX		; (if size==0, there's nothing free)
 40328                                  bfE:
 40329 0000611B F9                      	stc
 40330                                  bfX:
 40331                                  	;popreg	<cx,bx>
 40332                                  
 40333 0000611C 59                      	pop	cx
 40334                                  	;pop	bx
 40335                                  
 40336 0000611D C3                      	retn
 40337                                  
 40338                                  ; -----------------------------------------------------------------------------
 40339                                  ;*** isSpecified - sets ZF if UMB in AL wasn't specified in DH/LH line.
 40340                                  ; -----------------------------------------------------------------------------
 40341                                  ; ENTRY:    AL should be to a valid UMB number
 40342                                  ; EXIT:     ZF set if UMB wasn't specified, ZF clear if it was
 40343                                  ; ERROR:    None
 40344                                  ; USES:     Flags
 40345                                  ; -----------------------------------------------------------------------------
 40346                                  
 40347                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40348                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40349                                  isSpecified:
 40350                                  	;push	ax
 40351                                  
 40352 0000611E 30FF                    	xor	bh,bh
 40353 00006120 88C3                    	mov	bl,al
 40354                                  
 40355                                  	;getdata al,DS:UmbUsed[bx]
 40356                                  
 40357 00006122 1E                      	push	ds
 40358 00006123 8E1E[F59B]              	mov	ds,[RESSEG]
 40359 00006127 8A87[5E04]              	mov	al,[bx+UmbUsed]
 40360 0000612B 1F                      	pop     ds
 40361                                  
 40362 0000612C 08C0                    	or	al,al		; Sets ZF if al==0 (ie, if unspecified)
 40363                                  
 40364                                  	;pop	ax
 40365 0000612E C3                      	retn
 40366                                  
 40367                                  ; -----------------------------------------------------------------------------
 40368                                  ;*** shrinkMCB - breaks an MCB into two pieces, the lowest one's size==AX
 40369                                  ; -----------------------------------------------------------------------------
 40370                                  ; ENTRY:    AX == new size, ES:0 == current MCB
 40371                                  ; EXIT:     None; MCB broken if carry clear
 40372                                  ; ERROR:    Carry set if MCB isn't as large as AX+0x20 (not a useful split)
 40373                                  ; USES:     Flags
 40374                                  ; -----------------------------------------------------------------------------
 40375                                  ; If the size of the to-be-split MCB isn't at least 0x20 bytes greater than
 40376                                  ; the specified new size, the split is useless; if it's onnly 0x10 bytes, that
 40377                                  ; 0x10 will be used to make a header that mentions a 0-byte free space, and
 40378                                  ; that just sucks up 0x10 bytes for nothing. So we make 0x20 bytes the
 40379                                  ; minimum for performing a split.
 40380                                  ; -----------------------------------------------------------------------------
 40381                                  
 40382                                  ;MIN_SPLIT_SIZE	equ 20h
 40383                                  
 40384                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40385                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:667Ah
 40386                                  
 40387                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40388                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:64F7h
 40389                                  shrinkMCB:
 40390                                  	;pushreg <bx,cx,es>
 40391                                  
 40392                                  	;push	bx
 40393 0000612F 51                      	push	cx ; *
 40394 00006130 26                      	psuh	es ; **
 40395                                  
 40396 00006131 89C3                    	mov	bx,ax			; Move things around... and
 40397 00006133 8CC0                    	mov	ax,es			; save this one for later.
 40398                                  
 40399 00006135 268B0E0300              	mov	cx,[es:arena_size]
 40400 0000613A 83E920                  	sub	cx,32 ; sub cx,MIN_SPLIT_SIZE
 40401                                  	;cmp	bx,cx			; {New size} vs {Current Size-20h}
 40402                                  	;ja	short smE		; if wanted_size > cur-20h, abort.
 40403 0000613D 39D9                    	cmp	cx,bx
 40404 0000613F 723E                    	jb	short smE ; cf = 1 (***)
 40405                                  
 40406                                  	;mov	dl,[es:0]
 40407 00006141 268A160000              	mov	dl,[es:arena_signature]
 40408                                  
 40409                                  	;;mov	cx,[es:3]
 40410                                  	;mov	cx,[es:arena_size] ; *!
 40411                                  
 40412 00006146 26891E0300              	mov	[es:arena_size],bx
 40413                                  	;mov	byte [es:0],'M' ; 4Dh
 40414 0000614B 26C60600004D            	mov	byte [es:arena_signature],'M'
 40415                                  
 40416 00006151 01D8                    	add	ax,bx
 40417 00006153 40                      	inc	ax
 40418 00006154 8EC0                    	mov	es,ax			; Move to new arena area
 40419                                  
 40420                                  	;mov	ax,cx ; !*
 40421 00006156 26A10300                	mov	ax,[es:arena_size] ; *!
 40422 0000615A 29D8                    	sub	ax,bx
 40423 0000615C 48                      	dec	ax			; And prepare the new size
 40424                                  
 40425                                  	;mov	[es:0],dl
 40426 0000615D 2688160000              	mov	[es:arena_signature],dl
 40427                                  	;;mov	word [es:1],0
 40428                                  	;mov	word [es:arena_owner],0
 40429                                  	;mov	[es:3],ax
 40430 00006162 26A30300                	mov	[es:arena_size],ax
 40431 00006166 B82020                  	mov	ax,'  ' ; mov ax,2020h
 40432                                  	;mov	[es:8],ax
 40433 00006169 26A30800                	mov	[es:arena_name+0],ax
 40434 0000616D 26A30A00                	mov	[es:arena_name+2],ax
 40435 00006171 26A30C00                	mov	[es:arena_name+4],ax
 40436                                  	;mov	[es:14],ax
 40437 00006175 26A30E00                	mov	[es:arena_name+6],ax
 40438                                  
 40439                                  	;clc
 40440 00006179 31C0                    	xor	ax,ax
 40441 0000617B 26A30100                	mov	[es:arena_owner],ax ; 0
 40442                                  	; cf = 0
 40443                                  	;jmp	short smX
 40444                                  smE:
 40445                                  	;stc	 ; cf = 1 (***)
 40446                                  smX:
 40447                                  	;popreg	<es,cx,bx>
 40448 0000617F 07                      	pop	es ; **
 40449 00006180 59                      	pop	cx ; *
 40450 00006181 5B                      	pop	bx
 40451                                  
 40452 00006182 C3                      	retn
 40453                                  
 40454                                  ; -----------------------------------------------------------------------------
 40455                                  ;*** hideUMB? - hides as appropriate the UMB in CL
 40456                                  ; -----------------------------------------------------------------------------
 40457                                  ; ENTRY:    CL should be to a valid UMB number, and AX to its address (findUMB)
 40458                                  ; EXIT:     None; UMB is hidden as necessary
 40459                                  ; ERROR:    None
 40460                                  ; USES:     Flags, AX, CX
 40461                                  ; -----------------------------------------------------------------------------
 40462                                  ; PRIMARY LOGIC:
 40463                                  ;
 40464                                  ; If the UMB is specified in the DH/LH statement, then:
 40465                                  ;    If the largest free segment is too small (check specified size), then:
 40466                                  ;       Pretend it wasn't ever specified, and fall out of this IF.
 40467                                  ;    Else, if largest free segment is LARGER than specified size, then:
 40468                                  ;       If /S was given on the command-line, then:
 40469                                  ;          Break that element into two pieces
 40470                                  ;          Set a flag that we're shrinking
 40471                                  ;       Endif
 40472                                  ;    Endif
 40473                                  ; Endif
 40474                                  ; If the UMB is NOT specified (or was removed by the above):
 40475                                  ;    Hide all free elements in the UMB
 40476                                  ;    If the flag that we're shrinking was set, then:
 40477                                  ;       UN-hide the lower portion of the shrunken UMB
 40478                                  ;    ENDIF
 40479                                  ; ENDIF
 40480                                  ; -----------------------------------------------------------------------------
 40481                                  
 40482                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40483                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:66D7h
 40484                                  
 40485                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40486                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:6554h
 40487                                  hideUMB?:
 40488                                  	;pushreg <bx,dx,es>
 40489                                  
 40490                                  	;push	bx
 40491                                  	;push	dx
 40492                                  	;push	es
 40493                                  
 40494 00006183 88C8                    	mov	al,cl
 40495 00006185 E896FF                  	call	isSpecified	; Returns ZF set if al's umb was NOT specified
 40496                                  	;jz	short hu?20
 40497                                  	; 17/06/2023
 40498 00006188 7432                    	jz	short hu?25 ; *
 40499                                  
 40500 0000618A 88C8                    	mov	al,cl		; Retrieve the size of the largest
 40501 0000618C E84EFF                  	call	BigFree		; free element in AX; put its address in ES
 40502                                  	;jc	short hu?20	; Oops. Errors mean skip this part.
 40503                                  	; 17/06/2023
 40504 0000618F 723B                    	jc	short hu?X ; **
 40505                                  
 40506 00006191 50                      	push	ax		; TOS==size of BigFree in UMB (popped as BX)
 40507 00006192 88C8                    	mov	al,cl		; Retrieve the user's specified
 40508 00006194 E88AFE                  	call	GetSize		; minimum size for this umb (into AX)
 40509 00006197 5B                      	pop	bx		; Now BX==BigFree, AX==Specified Size
 40510                                  
 40511 00006198 09C0                    	or	ax,ax		; If they didn't specify one,
 40512                                  	;jz	short hu?20	; Skip over all this.
 40513                                  	; 17/06/2023
 40514 0000619A 7530                    	jnz	short hu?X ; **
 40515                                  
 40516 0000619C 39D8                    	cmp	ax,bx		; Ah... if (specified > max free)
 40517 0000619E 7607                    	jbe	short hu?10
 40518                                  
 40519 000061A0 88C8                    	mov	al,cl		;  Then mark that UMB as unused. Nya nya.
 40520 000061A2 E898FC                  	call	unMarkUMB
 40521                                  	;jmp	short hu?20 ; ***
 40522                                  	; 17/06/2023
 40523                                  	; ('isSpecified' would return with ZF=1) ; ***
 40524 000061A5 EB15                    	jmp	short hu?25
 40525                                  hu?10:
 40526 000061A7 E8B0FE                  	call	isTiny		; Returns ZF clear if user specified /S
 40527                                  	;jz	short hu?20
 40528                                  	; 17/06/2023
 40529                                  	; ('isSpecified' would return with ZF=0) ; **
 40530 000061AA 7420                    	jz	short hu?X
 40531                                  
 40532 000061AC E880FF                  	call	shrinkMCB	; They specified /S, so shrink the MCB to AX
 40533                                  	;jc	short hu?20	; Ah... if didn't shrink after all, skip this:
 40534                                  	; 17/06/2023
 40535                                  	; ('isSpecified' would return with ZF=0) ; **
 40536 000061AF 721B                    	jc	short hu?X
 40537                                  
 40538 000061B1 8CC2                    	mov	dx,es
 40539 000061B3 EB09                    	jmp	short hu?30	; Skip the spec check.. we wanna hide this one.
 40540                                  hu?20:
 40541                                  	;mov	al,cl
 40542 000061B5 89C8                    	mov	ax,cx
 40543 000061B7 E864FF                  	call	isSpecified	; If they specified this UMB, we're done...
 40544 000061BA 7510                    	jnz	short hu?X ; **	; so leave.
 40545                                  hu?25:	; 17/06/2023 ; *
 40546 000061BC 31D2                    	xor	dx,dx
 40547                                  hu?30:
 40548 000061BE 88C8                    	mov	al,cl
 40549                                  
 40550 000061C0 E870FE                  	call	hideUMB		; Hides everything in UMB #al
 40551                                  
 40552 000061C3 09D2                    	or	dx,dx		; Did we shrink a UMB? If not, DX==0,
 40553 000061C5 7405                    	jz	short hu?X	; So we should leave.
 40554                                  
 40555 000061C7 8EC2                    	mov	es,dx		; Ah, but if it isn't, DX==the MCB's address;
 40556 000061C9 E8C7FE                  	call	unHideMCB	; Un-hides the lower portion of that MCB.
 40557                                  hu?X:
 40558                                  	;popreg	<es,dx,bx>
 40559                                  
 40560                                  	;pop	es
 40561                                  	;pop	dx
 40562                                  	;pop	bx
 40563                                  
 40564 000061CC C3                      	retn
 40565                                  
 40566                                  ; -----------------------------------------------------------------------------
 40567                                  ;*** UmbTest - returns with carry set if UMBs are not available, else CF==false
 40568                                  ; -----------------------------------------------------------------------------
 40569                                  ; ENTRY:    None
 40570                                  ; EXIT:     Carry is clear if UMBs are available, or set if they are not
 40571                                  ; ERROR:    None
 40572                                  ; USES:     CF (AX,BX,DS,ES pushed 'cause they're used by others)
 40573                                  ; -----------------------------------------------------------------------------
 40574                                  
 40575                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40576                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40577                                  UmbTest:
 40578                                  	;pushreg <ax,bx,ds,es>
 40579                                  	
 40580                                  	;push	ax
 40581                                  	;push	bx
 40582                                  	;push	ds
 40583                                  	;push	es
 40584                                  
 40585 000061CD E88CFB                  	call	fm_link		; Link in UMBs (if not already linked)
 40586 000061D0 E80600                  	call	WalkMem		; Check to see if they're really linked
 40587 000061D3 9C                      	pushf			; And remember what we found out
 40588 000061D4 E89CFB                  	call	fm_unlink	; Unlink UMBs (if WE have linked 'em)
 40589 000061D7 9D                      	popf			; And restore what we found out.
 40590                                  
 40591                                  	;popreg	<es,ds,bx,ax>
 40592                                  	
 40593                                  	;pop	es
 40594                                  	;pop	ds
 40595                                  	;pop	bx
 40596                                  	;pop	ax
 40597                                  	
 40598 000061D8 C3                      	retn
 40599                                  
 40600                                  ; -----------------------------------------------------------------------------
 40601                                  ;*** WalkMem - travels memory chain and returns carry clear iff UMBs are linked
 40602                                  ; -----------------------------------------------------------------------------
 40603                                  ; ENTRY:    None
 40604                                  ; EXIT:     Carry SET if MCB chain stops before 9FFF, CLEAR if stops >= 9FFF.
 40605                                  ; ERROR:    None
 40606                                  ; USES:     Flags
 40607                                  ; -----------------------------------------------------------------------------
 40608                                  
 40609                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40610                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40611                                  WalkMem:
 40612                                  	;pushreg <ax,bx,es>
 40613                                  	
 40614                                  	;push	ax
 40615                                  	;push	bx
 40616 000061D9 06                      	push	es
 40617                                  
 40618 000061DA B452                    	mov	ah,52h ; DOS_GET_DOS_LISTS
 40619                                  				; Call int 21h, function 52h...
 40620 000061DC CD21                    	int	21h
 40621                                  
 40622 000061DE 268B47FE                	mov	ax,[es:bx-2]
 40623                                  	;mov	es,ax ; *
 40624                                  
 40625                                  ; ------------------------------
 40626                                  ; UM10: ES = Current MCB pointer
 40627                                  ; ------------------------------
 40628                                  
 40629                                  um10:	
 40630 000061E2 8EC0                    	mov	es,ax ; *
 40631                                  
 40632                                  	;mov	al,[es:0]
 40633 000061E4 26A00000                	mov	al,[es:arena_signature]
 40634                                  	;cmp	al,'Z' ; 5Ah
 40635 000061E8 3C5A                    	cmp	al,arena_signature_end
 40636 000061EA 740A                    	je	short um20	; If signature == 'Z', hay no more.
 40637                                  
 40638                                  	;NextMCB es,bx		; Move to the next MCB
 40639                                  	
 40640                                  	;mov	bx,es
 40641                                  	;;add	bx,[es:3]
 40642                                  	;add	bx,[es:arena_size]
 40643                                  	;inc	bx
 40644                                  	;mov	es,bx
 40645 000061EC 8CC0                    	mov	ax,es
 40646 000061EE 2603060300              	add	ax,[es:arena_size]
 40647 000061F3 40                      	inc	ax
 40648                                  	;mov	es,ax ; *
 40649                                  
 40650 000061F4 EBEC                    	jmp	short um10	; And restart the loop.
 40651                                  um20:
 40652 000061F6 8CC0                    	mov	ax,es
 40653 000061F8 3DFF9F                  	cmp	ax,9FFFh	; This sets CF if ax < 9FFF.
 40654                                  
 40655                                  	;popreg	<es,bx,ax>
 40656 000061FB 07                      	pop	es
 40657                                  	;pop	bx
 40658                                  	;pop	ax
 40659                                  
 40660 000061FC C3                      	retn
 40661                                  
 40662                                  ; -----------------------------------------------------------------------------
 40663                                  ;*** hl_unlink - unlinks UMBs if fm_umb is set to 0; restores strategy too
 40664                                  ; -----------------------------------------------------------------------------
 40665                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 40666                                  ; EXIT:     None
 40667                                  ; ERROR:    None
 40668                                  ; USES:     AX, BX
 40669                                  ; -----------------------------------------------------------------------------
 40670                                  
 40671                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40672                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:681Ch
 40673                                  
 40674                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40675                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:6699h
 40676                                  hl_unlink:
 40677 000061FD 1E                      	push	ds ; *
 40678                                  
 40679 000061FE 30FF                    	xor	bh,bh
 40680                                  	;getdata bl,fm_umb	; Restore original link-state
 40681                                  
 40682                                  	;push	ds
 40683 00006200 8E1E[F59B]              	mov	ds,[RESSEG]
 40684 00006204 8A1E[3505]              	mov	bl,[fm_umb]	; Restore original link-state
 40685                                  	;pop	ds
 40686                                  	
 40687 00006208 B80358                  	mov	ax,5803h ; DOS_SET_UMBLINK
 40688 0000620B CD21                    	int	21h
 40689                                  
 40690 0000620D 30FF                    	xor	bh,bh
 40691                                  
 40692                                  	;getdata bl,fm_strat	; Restore original mem-alloc strategy
 40693                                  
 40694                                  	;push	ds
 40695                                  	;mov	ds,[RESSEG]
 40696 0000620F 8A1E[3605]              	mov	bl,[fm_strat]	;Restore original mem-alloc strategy
 40697                                  	;pop	ds
 40698                                  
 40699 00006213 B80158                  	mov	ax,5801h ; DOS_SET_STRATEGY
 40700 00006216 CD21                    	int	21h
 40701                                  
 40702 00006218 1F                      	pop	ds ; *
 40703                                  
 40704 00006219 C3                      	retn
 40705                                  
 40706                                  ;============================================================================
 40707                                  ; LOADHIGH.ASM, MSDOS 6.0, 1991
 40708                                  ;============================================================================
 40709                                  ; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40710                                  
 40711                                  ; This is a new module added to support loading programs into UMBs provided
 40712                                  ; by DOS 5.0. 
 40713                                  ; ---------------------------------------------------------------------------
 40714                                  ; Usage:
 40715                                  ;
 40716                                  ; LOADHIGH [/L:umb[,size][;umb[,size]]*] <filespec>
 40717                                  ;
 40718                                  ; <filespec> has to be a filename that is not wildcarded.
 40719                                  
 40720                                  ; ---------------------------------------------------------------------------
 40721                                  ;
 40722                                  ;	Revision History
 40723                                  ;	================
 40724                                  ;
 40725                                  ;	M009	SR	08/01/90	Set flags to indicate that we are
 40726                                  ;				loading and high and also remember
 40727                                  ;				current UMB state.
 40728                                  ;
 40729                                  ;	M016	SR	08/09/90	Give special error message on attempt
 40730                                  ;				to loadhigh batch files and invalid
 40731                                  ;				filename on Loadhigh command line.
 40732                                  ;
 40733                                  ;	M039	SR	11/19/90	Bug #4270. Copy all the whitespaces
 40734                                  ;				after the program name also as part
 40735                                  ;				of the command line being passed to
 40736                                  ;				the program to be invoked.
 40737                                  ;
 40738                                  ; ---------------------------------------------------------------------------
 40739                                  
 40740                                  ; ---------------------------------------------------------------------------
 40741                                  ;
 40742                                  ;	include highload.inc		; Grab code for ParseVar and such
 40743                                  
 40744                                  iCmdLine	equ	81h		; PSP:81h points to command-line
 40745                                  
 40746                                  ;
 40747                                  ; ---------------------------------------------------------------------------
 40748                                  
 40749                                  ;****	LoadHigh -- Main routine for Loadhigh command
 40750                                  ;
 40751                                  ;	ENTRY	Command line tail is at PSP:iCmdLine terminated by 0dh
 40752                                  ;		CS = DS = SS = TRANGROUP
 40753                                  ;
 40754                                  ;	EXIT	None
 40755                                  ;
 40756                                  ;	USED	ax, bx, cx, dx, si, di, es
 40757                                  ;
 40758                                  ;	ERROR EXITS
 40759                                  ;		Message pointers are setup at the error locations and then
 40760                                  ;	we jump back to CERROR which is the transient error recycle point.
 40761                                  ;	Apart from parse errors, the other errors handled are too many
 40762                                  ;	switches anf invalid filenames.
 40763                                  ;
 40764                                  ;	EFFECTS
 40765                                  ;		The allocation strategy and the state of the arena chain are
 40766                                  ;	put in the requested state according to the given options. If a 
 40767                                  ;	filename is also given, it is executed as well.
 40768                                  ; ---------------------------------------------------------------------------
 40769                                  
 40770                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40771                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5927h
 40772                                  
 40773                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40774                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:683Fh
 40775                                  
 40776                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40777                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:66BCh
 40778                                  LoadHigh:
 40779 0000621A 1E                      	push	ds
 40780 0000621B 07                      	pop	es
 40781                                  	
 40782                                  	; 16/06/2023
 40783                                  	;call	SkipLhDelims	; MSDOS 5.0 !
 40784                                  
 40785                                  ;Get command tail to be passed to the program. This includes any whitespace
 40786                                  ;chars between the program name and its parameters as well.
 40787                                  ;On return, ds:si points at the start of the command tail.
 40788                                  
 40789                                  	; 16/06/2023
 40790                                  	;push	si		; MSDOS 5.0 !
 40791 0000621C E81300                  	call	ParseLhCmd
 40792                                  	;pop	si		; MSDOS 5.0 !	
 40793 0000621F 720E                    	jc	short LhErr
 40794                                  	
 40795 00006221 E86500                  	call	SetupCmdLine		;setup pgm's command line
 40796                                  
 40797 00006224 E88700                  	call	SetupPath		;setup path for file
 40798 00006227 7206                    	jc	short LhErr		;file not found
 40799                                  
 40800                                  ;Set allocation strategy to HighFirst and link in UMBs for exec. This will
 40801                                  ;be reset after return from the Exec
 40802                                  ;We will also set a resident flag to indicate that UMBs were activated for
 40803                                  ;the Exec. On return from the Exec, this flag will be used to deactivate UMBs
 40804                                  
 40805 00006229 E8AFFD                  	call	HideUMBs		;prepare upper-memory for load
 40806                                  
 40807 0000622C E900CB                  	jmp	LH_EXECUTE		;go and exec file ;M051
 40808                                  
 40809                                  LhErr:
 40810                                  ;The error message has been setup at this stage
 40811                                  
 40812 0000622F E9F4CA                  	jmp	cerror			;print error message and recycle 
 40813                                  
 40814                                  ; ---------------------------------------------------------------------------
 40815                                  					
 40816                                  ;*** 	ParseLhCmd - parses any command-line options
 40817                                  ;
 40818                                  ;	ENTRY	None
 40819                                  ;
 40820                                  ;	EXIT	Carry clear -- command line parsed successfully
 40821                                  ;		Carry set -- appropriate error message setup
 40822                                  ;
 40823                                  ;	USED	ax, si
 40824                                  ;
 40825                                  ;	EFFECTS
 40826                                  ;		Options set up (see highvar.inc)
 40827                                  ;		Filename to be executed setup
 40828                                  ;
 40829                                  ;	ParseLhCmd calls InitVar to initialize data filled in by ParseVar,
 40830                                  ;	then calls ParseVar itself to actually parse the commmand-line.  On
 40831                                  ;	return from ParseVar, DS:SI will point to the beginning of the child
 40832                                  ;	module's name on the command-line; thus it calls LhCopyFilename to
 40833                                  ;	prepare the command-line for that program.
 40834                                  ; ---------------------------------------------------------------------------
 40835                                  
 40836                                  ; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40837                                  %if 0
 40838                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40839                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5944h
 40840                                  	; MSDOS 5.0 COMMAND.COM only ! (MSDOS 6.0 code is different)
 40841                                  	; 11/06/2023
 40842                                  ParseLhCmd:
 40843                                  	;mov	si,81h
 40844                                  	mov	si,iCmdLine	;ds:si points at command line
 40845                                  
 40846                                  	mov	word [COMSW],0
 40847                                  	mov	di,Parse_LoadHi
 40848                                  	xor	cx,cx
 40849                                  	call	Parse_With_Msg
 40850                                  
 40851                                  	; 11/06/2023
 40852                                  	;cmp	ax,0FFFFh ; -1
 40853                                  	;jz	short PLhCmd2
 40854                                  	;cmp	ax,0
 40855                                  	;jnz	short PLhCmd1
 40856                                  	; 11/06/2023
 40857                                  	inc	ax ; cmp ax,-1
 40858                                  	jz	short PLhCmd2 ; 0FFFFh -> 0
 40859                                  	dec	ax ; cmp ax,0
 40860                                  	jnz	short PLhCmd1 ; 1 -> 0
 40861                                  	; ax = 0
 40862                                  
 40863                                  	mov	bx,dx
 40864                                  	; 14/04/2023
 40865                                  	;call	LhCopyFilename
 40866                                  	;; 13/04/2023
 40867                                  	;;;jc	short PLhCmd2  ; !!! jmp short PLhCmd2 !!!
 40868                                  	;;jmp	short PLhCmd2
 40869                                  	;retn
 40870                                  	; 14/04/2023
 40871                                  	jmp	short LhCopyFilename
 40872                                  PLhCmd1:
 40873                                  	stc
 40874                                  PLhCmd2:
 40875                                  	retn
 40876                                  %endif
 40877                                  
 40878                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40879                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6857h
 40880                                  	; MSDOS 6.0
 40881                                  
 40882                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 40883                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:66D4h
 40884                                  ParseLhCmd:
 40885                                  	;assume	ds:TRANGROUP, es:TRANGROUP
 40886                                  	
 40887                                  	;mov	si,81h
 40888 00006232 BE8100                  	mov	si,iCmdLine	;ds:si points at command line
 40889                                  
 40890                                  	; es = ds (from 'LoadHigh') 
 40891                                  	;push	es		;Store ES 'cause we're gonna change it:
 40892                                  
 40893                                  	;push	ds
 40894                                  	;pop	es		;Make sure es:si points to cmd line as well
 40895                                  
 40896 00006235 E8ACFA                  	call	InitVar		;Initialize data for ParseVar
 40897                                  
 40898 00006238 E84AFB                  	call	ParseVar	;And parse the command line
 40899                                  
 40900                                  	;pop	es		;Restore ES now; we're done with it.
 40901                                  
 40902 0000623B 7317                    	jnc	short plcC	;If no error, continue on our way.
 40903                                  
 40904 0000623D 83F802                  	cmp	ax,2 ; PV_BadUMB
 40905                                  				;Bad UMB passed?
 40906 00006240 7505                    	jne	short plc10
 40907                                  	;mov	dx,offset TRANGROUP:LhBadUMB_Ptr
 40908 00006242 BA[D292]                	mov	dx,LhBadUMB_Ptr
 40909 00006245 F9                      	stc
 40910 00006246 C3                      	retn
 40911                                  plc10:	
 40912                                  	;mov	dx,offset TRANGROUP:LhInvSwt_Ptr
 40913 00006247 BA[CF92]                	mov	dx,LhInvSwt_Ptr
 40914 0000624A 83F803                  	cmp	ax,3 ; PV_InvSwt
 40915                                  				;Unrecognized switch passed?
 40916 0000624D 7403                    	je	short plc20
 40917                                  	;mov	dx,offset TRANGROUP:LhInvArg_Ptr
 40918 0000624F BA[C992]                	mov	dx,LhInvArg_Ptr
 40919                                  plc20:
 40920 00006252 F9                      	stc
 40921 00006253 C3                      	retn
 40922                                  plcC:
 40923                                  	;call	LhCopyFilename	;copy filename into our buffer
 40924                                  	;retn			;Return-- carry=status
 40925                                  	; 16/06/2023
 40926                                  	;jmp	short LhCopyFilename
 40927                                  
 40928                                  ; ---------------------------------------------------------------------------
 40929                                  
 40930                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40931                                  
 40932                                  ; ---------------------------------------------------------------------------
 40933                                  ; HIGHLOAD.INC, MSDOS 6.0, 1992
 40934                                  ; ---------------------------------------------------------------------------
 40935                                  
 40936                                  	; 13/04/2023
 40937                                  	; MSDOS 5.0 COMMAND.COM only !
 40938                                  	; (Procedure names are not from original Microsoft source code!)
 40939                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:596Ah
 40940                                  ;set_strategy:
 40941                                  	;mov	ax,5800h	; DOS_CHECK_STRATEGY
 40942                                  	;int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40943                                  	;		; AL = function code: get allocation strategy
 40944                                  	;mov	bx,ax
 40945                                  	;or	bx,80h
 40946                                  	;mov	ax,5801h	; DOS_SET_STRATEGY
 40947                                  	;int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40948                                  	;		; AL = function code: set allocation strategy
 40949                                  	;retn
 40950                                  
 40951                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:597Bh
 40952                                  ;set_umblink:
 40953                                  	;mov	ax,5803h	; DOS_SET_UMBLINK
 40954                                  	;mov	bx,1
 40955                                  	;int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40956                                  	;		; AL = function code: (DOS 5beta) set UMB link state
 40957                                  	;retn
 40958                                  
 40959                                  ; ---------------------------------------------------------------------------
 40960                                  
 40961                                  ;***	LhCopyFilename -- copy filename from command line to buffer
 40962                                  ;
 40963                                  ;	ENTRY	ds:si points at primary argument (filename)
 40964                                  ;
 40965                                  ;	EXIT	Carry set -- filename has wildcards. In this event, DX will
 40966                                  ;				already contain an appropriate error number.
 40967                                  ;		Carry clear -- filename has been copied as needed; DS:SI
 40968                                  ;				points to first character (most likely space)
 40969                                  ;				after filename.
 40970                                  ;
 40971                                  ;	USED	ax, si
 40972                                  ;
 40973                                  ;	EFFECTS
 40974                                  ;		ExecPath contains the filename
 40975                                  ;
 40976                                  ; If there are any wildcards in the filename, then we have an error
 40977                                  ; ---------------------------------------------------------------------------
 40978                                  
 40979                                  ; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40980                                  %if 0
 40981                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40982                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5984h
 40983                                  	; MSDOS 5.0 COMMAND.COM only ! (MSDOS 6.0 code is different)
 40984                                  LhCopyFilename:
 40985                                  	push	ds
 40986                                  	push	si
 40987                                  	push	di
 40988                                  	lds	si,[bx+4]
 40989                                  	mov	di,EXECPATH
 40990                                  lhcpfn1:
 40991                                  	lodsb
 40992                                  	cmp	al,2Ah ; '*'
 40993                                  	jz	short lhfilerr
 40994                                  	cmp	al,3Fh ; '?'
 40995                                  	jz	short lhfilerr
 40996                                  	stosb
 40997                                  	or	al,al
 40998                                  	jnz	short lhcpfn1
 40999                                  	; 14/04/2023
 41000                                  	; cf = 0
 41001                                  	;clc
 41002                                  lhfilerr2:
 41003                                  	pop	di
 41004                                  	pop	si
 41005                                  	pop	ds
 41006                                  	retn
 41007                                  lhfilerr:
 41008                                  	mov	dx,LhInvFil_Ptr
 41009                                  	stc
 41010                                  	jmp	short lhfilerr2
 41011                                  
 41012                                  %endif
 41013                                  
 41014                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 41015                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6881h
 41016                                  	; MSDOS 6.0
 41017                                  
 41018                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 41019                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:66FEh
 41020                                  LhCopyFilename:
 41021                                  	;assume	ds:TRANGROUP, es:TRANGROUP
 41022                                  
 41023                                  	;mov	di,offset TRANGROUP:ExecPath
 41024 00006254 BF[1D9B]                	mov	di,EXECPATH
 41025                                  
 41026                                  	;mov	cx,0	; Copied zero characters
 41027 00006257 29C9                    	sub	cx,cx
 41028                                  ;@@:
 41029                                  lhcpfn1:
 41030 00006259 AC                      	lodsb
 41031 0000625A 3C2A                    	cmp	al,'*'			;wildcard?
 41032 0000625C 7421                    	je	short lhfilerr		;yes, error
 41033 0000625E 3C3F                    	cmp	al,'?'			;wildcard?
 41034 00006260 741D                    	je	short lhfilerr		;yes, error
 41035                                  
 41036 00006262 3C0D                    	cmp	al,0Dh			;carriage return?
 41037                                  	;jz	@f
 41038 00006264 7410                    	je	short lhcpfn2
 41039 00006266 3C2F                    	cmp	al,'/' ; SwitChar	;'/'?
 41040                                  	;jz	@f
 41041 00006268 740C                    	je	short lhcpfn2
 41042 0000626A 08C0                    	or	al,al			;EOS?
 41043                                  	;jz	@f
 41044 0000626C 7408                    	jz	short lhcpfn2
 41045 0000626E 3C20                    	cmp	al,' '			;Space?
 41046                                  	;jz	@f
 41047 00006270 7404                    	je	short lhcpfn2
 41048                                  	
 41049                                  	;or	al,al
 41050                                  	;;jz	@f
 41051                                  	;je	short lhcpfn2	
 41052                                  
 41053 00006272 AA                      	stosb				;store char
 41054 00006273 41                      	inc	cx			;And remember that we did one more
 41055                                  	;jmp	short @b
 41056 00006274 EBE3                    	jmp	short lhcpfn1
 41057                                  ;@@:
 41058                                  lhcpfn2:
 41059 00006276 30C0                    	xor	al,al			;Indicate EOS reached
 41060 00006278 AA                      	stosb				;store char
 41061                                  
 41062 00006279 09C9                    	or	cx,cx			;If we didn't copy any characters,
 41063 0000627B 7407                    	jz	short lhmissing	; they didn't give a filename.
 41064                                  
 41065 0000627D 4E                      	dec	si			;Move back to the delimiting character
 41066                                  	; cf = 0
 41067                                  	;clc				;And indicate no error occurred
 41068 0000627E C3                      	retn
 41069                                  lhfilerr:
 41070                                  	;mov	dx,offset TRANGROUP:LhInvFil_Ptr
 41071 0000627F BA[C392]                	mov	dx,LhInvFil_Ptr		;"Invalid Filename" ; M016
 41072 00006282 F9                      	stc
 41073 00006283 C3                      	retn
 41074                                  lhmissing:
 41075                                  	;mov	dx,offset TRANGROUP:ReqParmMiss
 41076 00006284 BA[CC92]                	mov	dx,ReqParmMiss		;"Required parm missing"
 41077 00006287 F9                      	stc
 41078 00006288 C3                      	retn
 41079                                  
 41080                                  ; ---------------------------------------------------------------------------
 41081                                  	
 41082                                  ; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 41083                                  %if 0
 41084                                  	; 14/04/2023
 41085                                  	; 13/04/2023
 41086                                  	; MSDOS 5.0 COMMAND.COM only !
 41087                                  	; (Procedure name is not from original Microsoft source code!)
 41088                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:596Ah
 41089                                  set_strategy:
 41090                                  	mov	ax,5800h	; DOS_CHECK_STRATEGY
 41091                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 41092                                  			; AL = function code: get allocation strategy
 41093                                  	mov	bx,ax
 41094                                  	or	bx,80h
 41095                                  	mov	ax,5801h	; DOS_SET_STRATEGY
 41096                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 41097                                  			; AL = function code: set allocation strategy
 41098                                  	retn
 41099                                  
 41100                                  ; ---------------------------------------------------------------------------
 41101                                  
 41102                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41103                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59A6h
 41104                                  	; MSDOS 5.0 COMMAND.COM only !
 41105                                  	; (Procedure name is not from original Microsoft source code!)
 41106                                  SkipLhDelims:
 41107                                  	mov	si,81h
 41108                                  	call	scanoff
 41109                                  stfn1:
 41110                                  	lodsb
 41111                                  	call	DELIM
 41112                                  	jz	short stfn2
 41113                                  	cmp	al,0Dh
 41114                                  	jz	short stfn2
 41115                                  	cmp	al,[SWITCHAR]
 41116                                  	jnz	short stfn1
 41117                                  stfn2:
 41118                                  	dec	si
 41119                                  	retn
 41120                                  
 41121                                  %endif
 41122                                  
 41123                                  ; ---------------------------------------------------------------------------
 41124                                  
 41125                                  ;***	SetupCmdLine -- prepare command line for the program
 41126                                  ;
 41127                                  ;	ENTRY	{es/ds}:si = points just after the end of the child program
 41128                                  ;
 41129                                  ;	EXIT	None
 41130                                  ;
 41131                                  ;	USED
 41132                                  ;
 41133                                  ;	EFFECTS		
 41134                                  ;		The rest of the command line following the pgm name is 
 41135                                  ;	moved to the top of the command line buffer (at TRANGROUP:81h)
 41136                                  ;	and a new command line length is put in
 41137                                  ; ---------------------------------------------------------------------------
 41138                                  
 41139                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41140                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59BEh
 41141                                  
 41142                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41143                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:68BEh
 41144                                  
 41145                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 41146                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:673Bh
 41147                                  SetupCmdLine:
 41148                                  	;mov	di,81h
 41149 00006289 BF8100                  	mov	di,iCmdLine
 41150 0000628C 30C9                    	xor	cl,cl
 41151 0000628E FEC9                    	dec	cl			;just CR means count = 0
 41152                                  SetCmdL1:
 41153 00006290 AC                      	lodsb
 41154 00006291 AA                      	stosb
 41155 00006292 FEC1                    	inc	cl			;update count
 41156                                  	
 41157                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41158                                  	; MSDOS 6.0
 41159                                  	; 14/04/2023
 41160                                  	; * ; MSDOS 6.0 only !
 41161 00006294 08C0                    	or	al,al	; *
 41162 00006296 7404                    	jz	short SetCmdL2 ; *
 41163                                  	
 41164 00006298 3C0D                    	cmp	al,0Dh			;carriage return?
 41165 0000629A 75F4                    	jnz	short SetCmdL1		;no, continue storing
 41166                                  SetCmdL2:
 41167 0000629C 26880E8000              	mov	[es:80h],cl		;store new cmd line length
 41168 000062A1 C3                      	retn
 41169                                  
 41170                                  ; ---------------------------------------------------------------------------
 41171                                  
 41172                                  ;***	LhSetupErrMsg -- Sets up error messages
 41173                                  ;
 41174                                  ;	ENTRY	ax = error message number
 41175                                  ;
 41176                                  ;	EXIT	None
 41177                                  ;
 41178                                  ;	USED	dx
 41179                                  ;
 41180                                  ;	EFFECTS
 41181                                  ;		Everything setup to display error message
 41182                                  ; ---------------------------------------------------------------------------
 41183                                  	
 41184                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41185                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41186                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 41187                                  LhSetupErrMsg:
 41188 000062A2 C606[D58F]01            	mov	byte [msg_disp_class],ext_msg_class ; 1
 41189 000062A7 BA[D78F]                	mov	dx,extend_buf_ptr
 41190 000062AA A3[D78F]                	mov	[extend_buf_ptr],ax
 41191 000062AD C3                      	retn
 41192                                  
 41193                                  ; ---------------------------------------------------------------------------
 41194                                  
 41195                                  ; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 41196                                  %if 0
 41197                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41198                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59DFh
 41199                                  	; MSDOS 5.0 COMMAND.COM only !
 41200                                  	; (Procedure name is not from original Microsoft source code!)
 41201                                  check_umblink:
 41202                                  	mov	ax,5800h	; DOS_CHECK_STRATEGY
 41203                                  	int	21h 	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 41204                                  			 ; AL = function code: get allocation strategy
 41205                                  	mov	bl,al
 41206                                  	mov	ax,5802h	; DOS_CHECK_UMBLINK
 41207                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 41208                                  			; AL = function code: (DOS 5beta) get UMB link state
 41209                                  	mov	bh,al
 41210                                  	xchg	ax,bx
 41211                                  	rol	al,1
 41212                                  	and	al,1
 41213                                  	shl	ah,1
 41214                                  	or	al,ah
 41215                                  	retn
 41216                                  
 41217                                  ; ---------------------------------------------------------------------------
 41218                                  
 41219                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41220                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59F7h
 41221                                  	; MSDOS 5.0 COMMAND.COM only ! (MSDOS 6.0 code is different)
 41222                                  HideUMBs:
 41223                                  	push	ds
 41224                                  	call	check_umblink
 41225                                  	mov	ds,[RESSEG]
 41226                                  	mov	[fInHigh],al
 41227                                  	or	byte [fInHigh],80h
 41228                                  	pop	ds
 41229                                  	call	set_strategy
 41230                                  	;call	set_umblink
 41231                                  	;retn
 41232                                  	; 14/04/023
 41233                                  	;jmp	short set_umblink
 41234                                  
 41235                                  ; ---------------------------------------------------------------------------
 41236                                  
 41237                                  	; 14/04/2023
 41238                                  	; 13/04/2023
 41239                                  	; MSDOS 5.0 COMMAND.COM only !
 41240                                  	; (Procedure name is not from original Microsoft source code!)
 41241                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:597Bh
 41242                                  set_umblink:
 41243                                  	mov	ax,5803h	; DOS_SET_UMBLINK
 41244                                  	mov	bx,1
 41245                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 41246                                  			; AL = function code: (DOS 5beta) set UMB link state
 41247                                  	retn
 41248                                  %endif
 41249                                  
 41250                                  ; ---------------------------------------------------------------------------
 41251                                  
 41252                                  ;***	SetupPath -- Do path search for the file to be executed
 41253                                  ;
 41254                                  ;	ENTRY	None
 41255                                  ;
 41256                                  ;	EXIT	Carry set if file not found or not executable file
 41257                                  ;
 41258                                  ;	EFFECTS
 41259                                  ;		ExecPath contains the full path of the file to be executed
 41260                                  ; ---------------------------------------------------------------------------
 41261                                  
 41262                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41263                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5A0Fh
 41264                                  
 41265                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41266                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:68E3h
 41267                                  
 41268                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 41269                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:6760h
 41270                                  SetupPath:
 41271                                  
 41272                                  ;Juggle around the argv pointers to make argv[1] into argv[0]. This is 
 41273                                  ;because the path search routine that we are about to invoke expects the
 41274                                  ;filename to search for to be argv[0].
 41275                                  ;
 41276                                  ;If our new argv[0] starts with a switcharacter, it's an option... skip right
 41277                                  ;over it by doing the whole move again (smaller, of course, this time).
 41278                                  
 41279                                  	;mov	ax,arg.argvcnt		;total number of arguments
 41280                                  	; 14/04/2023
 41281                                  	;mov	ax,[ARG_ARGVCNT]
 41282 000062AE A1[10A2]                	mov	ax,[ARG+ARG_UNIT.argvcnt]
 41283                                  
 41284 000062B1 48                      	dec	ax			;less one - skip "LoadHigh"
 41285                                  	;mov	bx,SIZE Argv_ele
 41286 000062B2 BB0B00                  	mov	bx,ARGV_ELE.SIZE ; 11
 41287                                  	;mov	bx,11
 41288 000062B5 F7E3                    	mul	bx			;dx:ax = size of argument lists
 41289                                  
 41290                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 41291                                  	; --------------------------------------
 41292                                  	; MSDOS 6.0
 41293                                  
 41294                                  	;getdata cl,fm_argc		;CL = number of arguments to skip
 41295 000062B7 1E                      	push	ds              	; getdata (macro)
 41296 000062B8 8E1E[F59B]              	mov	ds,[RESSEG]
 41297 000062BC 8A0E[3705]              	mov	cl,[fm_argc]
 41298 000062C0 1F                      	pop	ds
 41299                                  	
 41300 000062C1 FEC1                    	inc	cl			;Skip one arg, to get over "lh"
 41301                                  
 41302                                  ;Move argv[1]..argv[n] to argv[0]..argv[n-1]. Here, AX == the overall size
 41303                                  ;of the argument lists.
 41304                                  
 41305                                  argloop:
 41306 000062C3 E31B                    	jcxz	argdone			;If we've finished copying args, leave.
 41307                                  
 41308 000062C5 49                      	dec	cx			;One less time we'll go through this.
 41309                                  
 41310 000062C6 50                      	push	ax			;Copy ( size of remaining list ) bytes
 41311 000062C7 51                      	push	cx			;And remember how many args there were
 41312                                  
 41313                                  	; --------------------------------------
 41314                                  
 41315                                  	; 14/04/2023
 41316 000062C8 89C1                    	mov	cx,ax			;size to move
 41317                                  
 41318                                  	;mov	di,offset TRANGROUP:Arg	;Copy TO argv[0]
 41319                                  	;mov	di,ARG_ARGV ;mov di,[ARG+ARG_UNIT.argv] ; mov di,[ARG]
 41320 000062CA BF[509F]                	mov	di,ARG	
 41321 000062CD 89FE                    	mov	si,di			;
 41322                                  	;add	si,SIZE Argv_ele	;Copy FROM argv[1]
 41323 000062CF 83C60B                  	add	si,ARGV_ELE.SIZE ; 11
 41324                                  	
 41325                                  	; 14/04/2023
 41326                                  	;mov	cx,ax
 41327                                  
 41328 000062D2 FC                      	cld
 41329 000062D3 F3A4                    	rep	movsb			;Move the argument list
 41330                                  	
 41331                                  	;dec	arg.argvcnt		;Fake one less argument, and
 41332                                  	;dec	word [ARG_ARGVCNT]
 41333 000062D5 FF0E[10A2]              	dec	word [ARG+ARG_UNIT.argvcnt]
 41334                                  
 41335                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 41336                                  	; --------------------------------------
 41337                                  	; MSDOS 6.0
 41338                                  	
 41339                                  	;sub	ax,ARGV_ELE.SIZE ; 11	;there's one argument we don't copy.
 41340                                  
 41341 000062D9 59                      	pop	cx
 41342 000062DA 58                      	pop	ax			;Restore the size of the arg list
 41343                                  	; 17/06/2023
 41344                                  	;jmp	short argloop
 41345                                  	
 41346                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41347 000062DB 83E80B                  	sub	ax,ARGV_ELE.SIZE ; 11
 41348 000062DE 77E3                    	ja	short argloop
 41349                                  	; --------------------------------------
 41350                                  	
 41351                                  ; Done moving... argv[0] is now the child program's name, and [1] its first arg
 41352                                  
 41353                                  	; 17/06/2023
 41354                                  argdone:
 41355 000062E0 E8BDD2                  	call	path_search		;look in the path
 41356                                  
 41357                                  ;ax = 0, no file found
 41358                                  ;ax < 4, batch file found -- cant be executed
 41359                                  ;ax = 4,8 => .com or .exe file found
 41360                                  
 41361 000062E3 09C0                    	or	ax,ax			;any file found?
 41362 000062E5 740B                    	jz	short no_exec_file	;no, error
 41363                                  
 41364 000062E7 83F804                  	cmp	ax,4			;executable file?
 41365                                  	;jl	short no_exec_bat	;no, indicate fail ; M016
 41366                                  	;clc
 41367                                  	;retn
 41368                                  	; 14/04/2023
 41369 000062EA 7201                    	jb	short no_exec_bat
 41370 000062EC C3                      	retn 
 41371                                  
 41372                                  no_exec_bat:
 41373 000062ED BA[C092]                	mov	dx,NoExecBat_Ptr	;Setup message ptr ; M016
 41374 000062F0 EB06                    	jmp	short lhsp_errret	;return error; M016
 41375                                  
 41376                                  no_exec_file:
 41377 000062F2 B80200                  	mov	ax,ERROR_FILE_NOT_FOUND ; 2
 41378 000062F5 E8AAFF                  	call	LhSetupErrMsg		;setup error message
 41379                                  lhsp_errret:				; M016
 41380 000062F8 F9                      	stc
 41381 000062F9 C3                      	retn
 41382                                  
 41383                                  ;============================================================================
 41384                                  ; COMMAND.SKL (MESSAGE.SKL), BUILDMSG.C, MSDOS 6.0, 1991
 41385                                  ;============================================================================
 41386                                  ; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41387                                  
 41388                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5A44h
 41389                                  
 41390                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41391                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6930h
 41392                                  
 41393                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 41394                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:67ADh
 41395                                  
 41396                                  ; ---------------------------------------------------------------------------
 41397                                  ; Class 3 message table/structure
 41398                                  ; ---------------------------------------------------------------------------
 41399                                  
 41400                                  $M_CLASS_3_STRUC:
 41401 000062FA FF                      	db 0FFh			; $M_CLASS_ID (Class identifer)
 41402                                  	;dw 5			; $M_COMMAND_VER (COMMAND.COM version)
 41403                                  	;db 162			; Total number of messages
 41404                                  	; 17/06/2023
 41405                                  	;dw 1606h		; MSDOS 6.22 COMMAND.COM (hb=22,lb=6)
 41406                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
 41407 000062FB 070A                    	dw 0A07h  ; PCDOS 7.1 COMMAND.COM
 41408                                  	;db 187			; Total number of messages
 41409                                  	; 02/08/2024
 41410 000062FD B7                      	db 183	; PCDOS 7.1 COMMAND.COM
 41411                                  $M_ID_3_1:
 41412                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:5A48h)
 41413 000062FE FC03                    	dw 1020			; Message Number = 1020
 41414                                  	;dw MSG_1020-$+2 ; 288h	; Message offset from message number (5A48h+0288h=5CD0h)
 41415                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41416 00006300 DC02                    	dw MSG_1020-$+2 ; 2ECh	; Message offset from message number (6934h+02ECh=6C20h)
 41417                                  			; 732	; 67B1h+2DCh=6A8Dh ; 06/08/2024 - PCDOS 7.1 COMMAND.COM 
 41418                                  $M_ID_3_2:
 41419 00006302 F703                    	dw 1015			; Message Number = 1015
 41420                                  	;dw MSG_1015-$+2 ; 294h ; Message offset from message number (5A4Ch+0294h=5CE0h)
 41421                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41422 00006304 E802                    	dw MSG_1015-$+2 ; 2F8h	; Message offset from message number (6938h+02F8h=6C30h)
 41423                                  			; 744	; 67B5h+2E8h=6A9Dh ; 06/08/2024 - PCDOS 7.1 COMMAND.COM 
 41424                                  $M_ID_3_3:	; 26/04/2023
 41425                                  			; 17/06/2023
 41426                                  			   ; 06/08/2024
 41427 00006306 EC030803                	dw 1004,MSG_1004-$ ; 776	
 41428 0000630A 02041E03                	dw 1026,MSG_1026-$ ; 798
 41429 0000630E 07042E03                	dw 1031,MSG_1031-$ ; 814
 41430 00006312 0B043903                	dw 1035,MSG_1035-$ ; 825
 41431 00006316 26044403                	dw 1062,MSG_1062-$ ; 836
 41432 0000631A 04044F03                	dw 1028,MSG_1028-$ ; 847
 41433 0000631E 15046D03                	dw 1045,MSG_1045-$ ; 877
 41434 00006322 11048603                	dw 1041,MSG_1041-$ ; 902
 41435 00006326 1204A403                	dw 1042,MSG_1042-$ ; 932
 41436                                  $M_ID_3_12:
 41437 0000632A 1304BB03                	dw 1043,MSG_1043-$ ; 955
 41438 0000632E EA03D703                	dw 1002,MSG_1002-$ ; 983
 41439 00006332 EB03FB03                	dw 1003,MSG_1003-$ ; 1019
 41440 00006336 EF031304                	dw 1007,MSG_1007-$ ; 1043
 41441 0000633A F0032A04                	dw 1008,MSG_1008-$ ; 1066
 41442 0000633E F1033C04                	dw 1009,MSG_1009-$ ; 1084
 41443 00006342 F2034D04                	dw 1010,MSG_1010-$ ; 1101
 41444 00006346 F3036904                	dw 1011,MSG_1011-$ ; 1129
 41445                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 41446                                  %if 1
 41447 0000634A F4038004                	dw 1012,MSG_1012-$ ; 1152
 41448                                  %endif
 41449 0000634E F6039904                	dw 1014,MSG_1014-$ ; 1177
 41450 00006352 F803A604                	dw 1016,MSG_1016-$ ; 1190
 41451 00006356 F903CC04                	dw 1017,MSG_1017-$ ; 1228
 41452 0000635A FA03ED04                	dw 1018,MSG_1018-$ ; 1261
 41453                                  $M_ID_3_24:
 41454 0000635E FB03FD04                	dw 1019,MSG_1019-$ ; 1277
 41455 00006362 FD030505                	dw 1021,MSG_1021-$ ; 1285
 41456 00006366 FE031F05                	dw 1022,MSG_1022-$ ; 1311
 41457 0000636A FF034205                	dw 1023,MSG_1023-$ ; 1346
 41458 0000636E 00046A05                	dw 1024,MSG_1024-$ ; 1386
 41459 00006372 01047D05                	dw 1025,MSG_1025-$ ; 1405
 41460 00006376 03049105                	dw 1027,MSG_1027-$ ; 1425
 41461 0000637A 0504AE05                	dw 1029,MSG_1029-$ ; 1454
 41462 0000637E 0604BC05                	dw 1030,MSG_1030-$ ; 1468
 41463 00006382 0804C705                	dw 1032,MSG_1032-$ ; 1479
 41464 00006386 0904DB05                	dw 1033,MSG_1033-$ ; 1499
 41465 0000638A 0A04ED05                	dw 1034,MSG_1034-$ ; 1517
 41466 0000638E 0C04FF05                	dw 1036,MSG_1036-$ ; 1535
 41467 00006392 0D041006                	dw 1037,MSG_1037-$ ; 1552
 41468 00006396 0E041D06                	dw 1038,MSG_1038-$ ; 1565
 41469 0000639A 0F042C06                	dw 1039,MSG_1039-$ ; 1580
 41470                                  $M_ID_3_40:
 41471 0000639E 10046506                	dw 1040,MSG_1040-$ ; 1637
 41472 000063A2 14047406                	dw 1044,MSG_1044-$ ; 1652
 41473 000063A6 16048406                	dw 1046,MSG_1046-$ ; 1668
 41474 000063AA 1704B706                	dw 1047,MSG_1047-$ ; 1719
 41475 000063AE 1804CC06                	dw 1048,MSG_1048-$ ; 1740
 41476 000063B2 1904DA06                	dw 1049,MSG_1049-$ ; 1754
 41477 000063B6 1A04E006                	dw 1050,MSG_1050-$ ; 1760
 41478 000063BA 1B04FB06                	dw 1051,MSG_1051-$ ; 1787
 41479 000063BE 1C040807                	dw 1052,MSG_1052-$ ; 1800
 41480 000063C2 1D041B07                	dw 1053,MSG_1053-$ ; 1819
 41481 000063C6 1E043D07                	dw 1054,MSG_1054-$ ; 1853
 41482                                  $M_ID_3_51:
 41483 000063CA 1F046007                	dw 1055,MSG_1055-$ ; 1888
 41484 000063CE 20046A07                	dw 1056,MSG_1056-$ ; 1898
 41485 000063D2 21047507                	dw 1057,MSG_1057-$ ; 1909
 41486 000063D6 23047E07                	dw 1059,MSG_1059-$ ; 1918
 41487 000063DA 24047F07                	dw 1060,MSG_1060-$ ; 1919
 41488 000063DE 25047F07                	dw 1061,MSG_1061-$ ; 1919
 41489 000063E2 27049507                	dw 1063,MSG_1063-$ ; 1941
 41490 000063E6 28049407                	dw 1064,MSG_1064-$ ; 1940
 41491 000063EA 29049307                	dw 1065,MSG_1065-$ ; 1939
 41492 000063EE 2A049207                	dw 1066,MSG_1066-$ ; 1938
 41493 000063F2 2B049107                	dw 1067,MSG_1067-$ ; 1937
 41494 000063F6 2C048F07                	dw 1068,MSG_1068-$ ; 1935
 41495 000063FA 2D049807                	dw 1069,MSG_1069-$ ; 1944
 41496 000063FE 2E049807                	dw 1070,MSG_1070-$ ; 1944
 41497 00006402 2F049707                	dw 1071,MSG_1071-$ ; 1943
 41498 00006406 30049607                	dw 1072,MSG_1072-$ ; 1942
 41499                                  $M_ID_3_67:
 41500 0000640A 31049C07                	dw 1073,MSG_1073-$ ; 1948
 41501 0000640E 3204A207                	dw 1074,MSG_1074-$ ; 1954
 41502 00006412 3304A807                	dw 1075,MSG_1075-$ ; 1960
 41503 00006416 3404AA07                	dw 1076,MSG_1076-$ ; 1962
 41504 0000641A 3504A907                	dw 1077,MSG_1077-$ ; 1961
 41505 0000641E 3604AD07                	dw 1078,MSG_1078-$ ; 1965
 41506 00006422 3704C407                	dw 1079,MSG_1079-$ ; 1988
 41507 00006426 3804CB07                	dw 1080,MSG_1080-$ ; 1995
 41508 0000642A 3904DD07                	dw 1081,MSG_1081-$ ; 2013
 41509                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41510 0000642E 3A040408                	dw 1082,MSG_1082-$ ; 2052	
 41511 00006432 3B040C08                	dw 1083,MSG_1083-$ ; 2060	
 41512                                  	;
 41513 00006436 3C040B08                	dw 1084,MSG_1084-$ ; 2059
 41514 0000643A 42041708                	dw 1090,MSG_1090-$ ; 2071
 41515 0000643E 43042108                	dw 1091,MSG_1091-$ ; 2081
 41516 00006442 44042B08                	dw 1092,MSG_1092-$ ; 2091
 41517 00006446 45043508                	dw 1093,MSG_1093-$ ; 2101
 41518 0000644A 46044608                	dw 1094,MSG_1094-$ ; 2118
 41519 0000644E 47045F08                	dw 1095,MSG_1095-$ ; 2143
 41520 00006452 48047808                	dw 1096,MSG_1096-$ ; 2168
 41521                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41522 00006456 4904A508                	dw 1097,MSG_1097-$ ; 2213
 41523 0000645A 4A04BE08                	dw 1098,MSG_1098-$ ; 2238
 41524 0000645E 4B04D708                	dw 1099,MSG_1099-$ ; 2263
 41525 00006462 4C04E908                	dw 1100,MSG_1100-$ ; 2281
 41526                                  
 41527                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41528                                  %if 0
 41529                                  	dw 1101,MSG_1101-$ ; 2302
 41530                                  	dw 1102,MSG_1102-$ ; 2313
 41531                                  %endif
 41532 00006466 4F040B09                	dw 1103,MSG_1103-$ ; 2315
 41533 0000646A 50042209                	dw 1104,MSG_1104-$ ; 2338
 41534                                  
 41535                                  	; TRANGROUP:6AA8h ; MSDOS 6.22
 41536                                  	; TRANGROUP:6921h ; PCDOS 7.1
 41537                                  
 41538 0000646E 51042209                	dw 1105,MSG_1105-$ ; 2338  ; TRANGROUP:7243h ; PCDOS 7.1
 41539                                  
 41540                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41541                                  %if 1
 41542 00006472 52042909                	dw 1106,MSG_1106-$ ; 2345
 41543                                  %endif
 41544                                  
 41545                                  ;$M_ID_3_84:
 41546                                  $M_ID_3_95: ; 17/06/2023	
 41547 00006476 B0043709                	dw 1200,MSG_1200-$ ; 2359
 41548 0000647A 14053409                	dw 1300,MSG_1300-$ ; 2356
 41549 0000647E 2805B709                	dw 1320,MSG_1320-$ ; 2487
 41550 00006482 2905F309                	dw 1321,MSG_1321-$ ; 2547
 41551 00006486 3C05600A                	dw 1340,MSG_1340-$ ; 2656
 41552 0000648A 3D05B80A                	dw 1341,MSG_1341-$ ; 2744
 41553 0000648E 3E05170B                	dw 1342,MSG_1342-$ ; 2839
 41554 00006492 5005A50B                	dw 1360,MSG_1360-$ ; 2981
 41555 00006496 7805BD0B                	dw 1400,MSG_1400-$ ; 3005
 41556 0000649A 7905560C                	dw 1401,MSG_1401-$ ; 3158
 41557 0000649E 7A05BB0C                	dw 1402,MSG_1402-$ ; 3259
 41558 000064A2 7B052E0D                	dw 1403,MSG_1403-$ ; 3374
 41559 000064A6 7C056A0D                	dw 1404,MSG_1404-$ ; 3434 ; TRANGROUP:6ADCh ; MSDOS 6.22
 41560                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41561 000064AA 7D05DB0D                	dw 1405,MSG_1405-$ ; 3547 ; TRANGROUP:6AE0h ; MSDOS 6.22
 41562                                  		     ; 06/08/2024 ; TRANGROUP:695Dh ; PCDOS 7.1 
 41563 000064AE 7E054A0E                	dw 1406,MSG_1406-$ ; 3658
 41564 000064B2 7F05890E                	dw 1407,MSG_1407-$ ; 3721 ; (MSG_1404 for MSDOS 5.0 COMMAND.COM)
 41565                                  	;
 41566 000064B6 8C050D0F                	dw 1420,MSG_1420-$ ; 3853
 41567 000064BA A005940F                	dw 1440,MSG_1440-$ ; 3988
 41568 000064BE A105B70F                	dw 1441,MSG_1441-$ ; 4023
 41569                                  ;$M_ID_3_100:
 41570                                  $M_ID_3_114: ; 17/06/2023
 41571 000064C2 B4053710                	dw 1460,MSG_1460-$ ; 4151
 41572 000064C6 B5059810                	dw 1461,MSG_1461-$ ; 4248
 41573 000064CA B6051811                	dw 1462,MSG_1462-$ ; 4376
 41574 000064CE C8056411                	dw 1480,MSG_1480-$ ; 4452
 41575 000064D2 C9050012                	dw 1481,MSG_1481-$ ; 4608
 41576 000064D6 CA054A12                	dw 1482,MSG_1482-$ ; 4682
 41577 000064DA CB05A212                	dw 1483,MSG_1483-$ ; 4770
 41578 000064DE CC051D13                	dw 1484,MSG_1484-$ ; 4893
 41579 000064E2 CD059613                	dw 1485,MSG_1485-$ ; 5014
 41580 000064E6 CE052814                	dw 1486,MSG_1486-$ ; 5160
 41581 000064EA CF05B414                	dw 1487,MSG_1487-$ ; 5300
 41582 000064EE D0050F15                	dw 1488,MSG_1488-$ ; 5391
 41583                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41584 000064F2 D1059E15                	dw 1489,MSG_1489-$ ; 5534
 41585                                  
 41586                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41587                                  %if 0
 41588                                  	dw 1490,MSG_1490-$ ; 5505
 41589                                  	dw 1491,MSG_1491-$ ; 5529
 41590                                  	dw 1492,MSG_1492-$ ; 5608
 41591                                  	dw 1493,MSG_1493-$ ; 5751
 41592                                  	dw 1494,MSG_1494-$ ; 5770
 41593                                  %endif
 41594                                  
 41595                                  ;$M_ID_3_112:
 41596                                  $M_ID_3_132: ; 17/06/2023
 41597 000064F6 DC05EB15                	dw 1500,MSG_1500-$ ; 5611
 41598 000064FA F0052616                	dw 1520,MSG_1520-$ ; 5670
 41599 000064FE 04066016                	dw 1540,MSG_1540-$ ; 5728
 41600 00006502 0506BA16                	dw 1541,MSG_1541-$ ; 5818
 41601 00006506 06062217                	dw 1542,MSG_1542-$ ; 5922
 41602 0000650A 18065A17                	dw 1560,MSG_1560-$ ; 5978
 41603 0000650E 19068E17                	dw 1561,MSG_1561-$ ; 6030
 41604 00006512 1A060718                	dw 1562,MSG_1562-$ ; 6151
 41605 00006516 1B063318                	dw 1563,MSG_1563-$ ; 6195
 41606 0000651A 1C065A18                	dw 1564,MSG_1564-$ ; 6234
 41607 0000651E 1D069418                	dw 1565,MSG_1565-$ ; 6292
 41608 00006522 1E06C518                	dw 1566,MSG_1566-$ ; 6341
 41609 00006526 1F06EE18                	dw 1567,MSG_1567-$ ; 6382
 41610 0000652A 20066419                	dw 1568,MSG_1568-$ ; 6500
 41611 0000652E 2C06AD19                	dw 1580,MSG_1580-$ ; 6573
 41612                                  ;$M_ID_3_127:
 41613                                  $M_ID_3_147: ; 17/06/2023
 41614 00006532 4006F119                	dw 1600,MSG_1600-$ ; 6641
 41615 00006536 41060A1A                	dw 1601,MSG_1601-$ ; 6666
 41616 0000653A 42065A1A                	dw 1602,MSG_1602-$ ; 6746
 41617 0000653E 5406F71A                	dw 1620,MSG_1620-$ ; 6903
 41618 00006542 55064B1B                	dw 1621,MSG_1621-$ ; 6987
 41619 00006546 5606C91B                	dw 1622,MSG_1622-$ ; 7113
 41620 0000654A 6806111C                	dw 1640,MSG_1640-$ ; 7185
 41621 0000654E 6906421C                	dw 1641,MSG_1641-$ ; 7234
 41622 00006552 7C06C21C                	dw 1660,MSG_1660-$ ; 7362
 41623 00006556 9006051D                	dw 1680,MSG_1680-$ ; 7429
 41624 0000655A A406271D                	dw 1700,MSG_1700-$ ; 7463
 41625 0000655E B806D51D                	dw 1720,MSG_1720-$ ; 7637
 41626 00006562 CC06241E                	dw 1740,MSG_1740-$ ; 7716
 41627 00006566 CD067C1E                	dw 1741,MSG_1741-$ ; 7804
 41628 0000656A E006EB1E                	dw 1760,MSG_1760-$ ; 7915
 41629 0000656E F406341F                	dw 1780,MSG_1780-$ ; 7988
 41630                                  ;$M_ID_3_143:
 41631                                  $M_ID_3_163: ; 17/06/2023
 41632 00006572 08079C1F                	dw 1800,MSG_1800-$ ; 8092
 41633 00006576 0907E61F                	dw 1801,MSG_1801-$ ; 8166
 41634 0000657A 1C073A20                	dw 1820,MSG_1820-$ ; 8250
 41635 0000657E 1D077E20                	dw 1821,MSG_1821-$ ; 8318
 41636 00006582 30070521                	dw 1840,MSG_1840-$ ; 8453
 41637 00006586 44074C21                	dw 1860,MSG_1860-$ ; 8524
 41638 0000658A 4507A321                	dw 1861,MSG_1861-$ ; 8611
 41639 0000658E 4607E621                	dw 1862,MSG_1862-$ ; 8678
 41640 00006592 47076022                	dw 1863,MSG_1863-$ ; 8800
 41641 00006596 4807FF22                	dw 1864,MSG_1864-$ ; 9959
 41642 0000659A 49076223                	dw 1865,MSG_1865-$ ; 9058
 41643 0000659E 4A07C923                	dw 1866,MSG_1866-$ ; 9161
 41644 000065A2 58072D24                	dw 1880,MSG_1880-$ ; 9261
 41645 000065A6 5907A124                	dw 1881,MSG_1881-$ ; 9377
 41646 000065AA 5A071B25                	dw 1882,MSG_1882-$ ; 9499
 41647 000065AE 5B076E25                	dw 1883,MSG_1883-$ ; 9582
 41648 000065B2 6C070D26                	dw 1900,MSG_1900-$ ; 9741
 41649 000065B6 80075226                	dw 1920,MSG_1920-$ ; 9810
 41650 000065BA 81077E26                	dw 1921,MSG_1921-$ ; 9854
 41651                                  ;$M_ID_3_162:
 41652                                  $M_ID_3_182: ; 17/06/2023
 41653 000065BE 82071327                	dw 1922,MSG_1922-$ ; 10003
 41654                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41655 000065C2 8307C627                	dw 1923,MSG_1923-$ ; 10182
 41656 000065C6 84074828                	dw 1924,MSG_1924-$ ; 10312
 41657 000065CA 8507C028                	dw 1925,MSG_1925-$ ; 10432
 41658 000065CE 8607BF28                	dw 1926,MSG_1926-$ ; 10431
 41659                                  $M_ID_3_187:	; 17/06/2023
 41660 000065D2 8707                    	dw 1927	; 19/06/2023	; Message Number = 1927
 41661 000065D4 1329                    	dw MSG_1927-$+2	; 10515	; Message offset from message number
 41662                                  		; MSDOS 6.22	; (Msg addr: 6C1Ch+2A1Eh = TRANGROUP:963Ah)
 41663                                  ; 06/08/2024	; PCDOS 7.1	; (Msg addr: 6A85h+2913h = TRANGROUP:9398h)
 41664                                  
 41665                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41666                                  %if 1
 41667                                  $M_ID_3_183:
 41668 000065D6 53046A29                	dw 1107,MSG_1107-$ ; 10602 *
 41669                                  			; (Msg addr: 6A89h+296Ah = TRANGROUP:96F3h)	
 41670                                  %endif
 41671                                  
 41672                                  ; ---------------------------------------------------------------------------
 41673                                  ; Class 3 messages
 41674                                  ; ---------------------------------------------------------------------------
 41675                                  	
 41676                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41677                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5CD0h
 41678                                  
 41679                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41680                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6C20h
 41681                                  
 41682                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 41683                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:6A8Dh
 41684                                  
 41685                                  MSG_1020:	; COMMON4
 41686 000065DA 0F                      	db 15	; (MSG_1015-MSG_1020)-1
 41687 000065DB 253120627974657320-     	db '%1 bytes free',0Dh,0Ah
 41687 000065E4 667265650D0A       
 41688                                  MSG_1015:	; COMMON18
 41689 000065EA 23                      	db 35
 41690 000065EB 46696C652063616E6E-     	db 'File cannot be copied onto itself',0Dh,0Ah
 41690 000065F4 6F7420626520636F70-
 41690 000065FD 696564206F6E746F20-
 41690 00006606 697473656C660D0A   
 41691                                  MSG_1004:	; COMMON20
 41692 0000660E 19                      	db 25
 41693 0000660F 496E73756666696369-     	db 'Insufficient disk space',0Dh,0Ah
 41693 00006618 656E74206469736B20-
 41693 00006621 73706163650D0A     
 41694                                  MSG_1026:	; COMMON22
 41695 00006628 13                      	db 19
 41696 00006629 496E76616C69642063-     	db 'Invalid code page',0Dh,0Ah
 41696 00006632 6F646520706167650D-
 41696 0000663B 0A                 
 41697                                  MSG_1031:	; COMMON23
 41698 0000663C 0E                      	db 14
 41699 0000663D 496E76616C69642064-     	db 'Invalid date',0Dh,0Ah
 41699 00006646 6174650D0A         
 41700                                  MSG_1035:	; COMMON24
 41701 0000664B 0E                      	db 14
 41702 0000664C 496E76616C69642074-     	db 'Invalid time',0Dh,0Ah
 41702 00006655 696D650D0A         
 41703                                  MSG_1062:	; COMMON25
 41704 0000665A 0E                      	db 14
 41705 0000665B 496E76616C69642070-     	db 'Invalid path',0Dh,0Ah
 41705 00006664 6174680D0A         
 41706                                  MSG_1028:	; COMMON28
 41707 00006669 21                      	db 33
 41708 0000666A 507265737320616E79-     	db 'Press any key to continue . . .',0Dh,0Ah
 41708 00006673 206B657920746F2063-
 41708 0000667C 6F6E74696E7565202E-
 41708 00006685 202E202E0D0A       
 41709                                  MSG_1045:	; COMMON32
 41710 0000668B 1C                      	db 28
 41711 0000668C 556E61626C6520746F-     	db 'Unable to create directory',0Dh,0Ah
 41711 00006695 206372656174652064-
 41711 0000669E 69726563746F72790D-
 41711 000066A7 0A                 
 41712                                  MSG_1041:	; COMMON33
 41713 000066A8 21                      	db 33
 41714 000066A9 566F6C756D6520696E-     	db 'Volume in drive %1 has no label',0Dh,0Ah
 41714 000066B2 206472697665202531-
 41714 000066BB 20686173206E6F206C-
 41714 000066C4 6162656C0D0A       
 41715                                  MSG_1042:	; COMMON34
 41716 000066CA 1A                      	db 26
 41717 000066CB 566F6C756D6520696E-     	db 'Volume in drive %1 is %2',0Dh,0Ah
 41717 000066D4 206472697665202531-
 41717 000066DD 2069732025320D0A   
 41718                                  MSG_1043:	; COMMON36
 41719 000066E5 1F                      	db 31  ; (MSG_1002-MSG_1043)-1
 41720 000066E6 566F6C756D65205365-     	db 'Volume Serial Number is %1-%2',0Dh,0Ah
 41720 000066EF 7269616C204E756D62-
 41720 000066F8 65722069732025312D-
 41720 00006701 25320D0A           
 41721                                  MSG_1002:
 41722 00006705 27                              db 39
 41723 00006706 4475706C6963617465-     	db 'Duplicate file name or file not found',0Dh,0Ah
 41723 0000670F 2066696C65206E616D-
 41723 00006718 65206F722066696C65-
 41723 00006721 206E6F7420666F756E-
 41723 0000672A 640D0A             
 41724                                  MSG_1003:
 41725 0000672D 1B                      	db 27
 41726 0000672E 496E76616C69642070-     	db 'Invalid path or file name',0Dh,0Ah
 41726 00006737 617468206F72206669-
 41726 00006740 6C65206E616D650D0A 
 41727                                  MSG_1007:
 41728 00006749 1A                      	db 26
 41729 0000674A 4F7574206F6620656E-     	db 'Out of environment space',0Dh,0Ah
 41729 00006753 7669726F6E6D656E74-
 41729 0000675C 2073706163650D0A   
 41730                                  MSG_1008:
 41731 00006764 15                      	db 21
 41732 00006765 46696C652063726561-     	db 'File creation error',0Dh,0Ah
 41732 0000676E 74696F6E206572726F-
 41732 00006777 720D0A             
 41733                                  MSG_1009:
 41734 0000677A 14                      	db 20  ; (MSG_1010-MSG_1009)-1
 41735 0000677B 42617463682066696C-     	db 'Batch file missing',0Dh,0Ah
 41735 00006784 65206D697373696E67-
 41735 0000678D 0D0A               
 41736                                  MSG_1010:
 41737 0000678F 1F                      	db 31
 41738 00006790 0D0A                    	db 0Dh,0Ah
 41739 00006792 496E73657274206469-     	db 'Insert disk with batch file',0Dh,0Ah
 41739 0000679B 736B20776974682062-
 41739 000067A4 617463682066696C65-
 41739 000067AD 0D0A               
 41740                                  MSG_1011:
 41741 000067AF 1A                      	db 26
 41742 000067B0 42616420636F6D6D61-     	db 'Bad command or file name',0Dh,0Ah
 41742 000067B9 6E64206F722066696C-
 41742 000067C2 65206E616D650D0A   
 41743                                  
 41744                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 41745                                  %if 1
 41746                                  MSG_1012:
 41747 000067CA 1C                      	db 28
 41748 000067CB 5245585820696E7465-     	db 'REXX interpreter not found',0Dh,0Ah	
 41748 000067D4 72707265746572206E-
 41748 000067DD 6F7420666F756E640D-
 41748 000067E6 0A                 
 41749                                  %endif
 41750                                  
 41751                                  MSG_1014:	; EXTEND5
 41752 000067E7 10                      	db 16
 41753 000067E8 416363657373206465-     	db 'Access denied ',0Dh,0Ah
 41753 000067F1 6E696564200D0A     
 41754                                  MSG_1016:
 41755 000067F8 29                      	db 41
 41756 000067F9 436F6E74656E74206F-     	db 'Content of destination lost before copy',0Dh,0Ah
 41756 00006802 662064657374696E61-
 41756 0000680B 74696F6E206C6F7374-
 41756 00006814 206265666F72652063-
 41756 0000681D 6F70790D0A         
 41757                                  MSG_1017:
 41758 00006822 24                      	db 36
 41759 00006823 496E76616C69642066-     	db 'Invalid filename or file not found',0Dh,0Ah
 41759 0000682C 696C656E616D65206F-
 41759 00006835 722066696C65206E6F-
 41759 0000683E 7420666F756E640D0A 
 41760                                  MSG_1018:
 41761 00006847 13                      	db 19
 41762 00006848 25312066696C652873-     	db '%1 file(s) copied',0Dh,0Ah
 41762 00006851 2920636F706965640D-
 41762 0000685A 0A                 
 41763                                  MSG_1019:
 41764 0000685B 0B                      	db 11
 41765 0000685C 25312066696C652873-     	db '%1 file(s) '
 41765 00006865 2920               
 41766                                  MSG_1021:	; EXTEND15
 41767 00006867 1D                      	db 29
 41768 00006868 496E76616C69642064-     	db 'Invalid drive specification',0Dh,0Ah
 41768 00006871 726976652073706563-
 41768 0000687A 696669636174696F6E-
 41768 00006883 0D0A               
 41769                                  MSG_1022:
 41770 00006885 26                      	db 38
 41771 00006886 436F64652070616765-     	db 'Code page %1 not prepared for system',0Dh,0Ah
 41771 0000688F 202531206E6F742070-
 41771 00006898 726570617265642066-
 41771 000068A1 6F722073797374656D-
 41771 000068AA 0D0A               
 41772                                  MSG_1023:
 41773 000068AC 2B                      	db 43
 41774 000068AD 436F64652070616765-     	db 'Code page %1 not prepared for all devices',0Dh,0Ah
 41774 000068B6 202531206E6F742070-
 41774 000068BF 726570617265642066-
 41774 000068C8 6F7220616C6C206465-
 41774 000068D1 76696365730D0A     
 41775                                  MSG_1024:
 41776 000068D8 16                      	db 22
 41777 000068D9 41637469766520636F-     	db 'Active code page: %1',0Dh,0Ah
 41777 000068E2 646520706167653A20-
 41777 000068EB 25310D0A           
 41778                                  MSG_1025:
 41779 000068EF 17                      	db 23
 41780 000068F0 4E4C5346554E43206E-     	db 'NLSFUNC not installed',0Dh,0Ah
 41780 000068F9 6F7420696E7374616C-
 41780 00006902 6C65640D0A         
 41781                                  MSG_1027:
 41782 00006907 20                      	db 32
 41783 00006908 43757272656E742064-     	db 'Current drive is no longer valid'
 41783 00006911 72697665206973206E-
 41783 0000691A 6F206C6F6E67657220-
 41783 00006923 76616C6964         
 41784                                  MSG_1029:
 41785 00006928 11                      	db 17
 41786 00006929 4C6162656C206E6F74-     	db 'Label not found',0Dh,0Ah
 41786 00006932 20666F756E640D0A   
 41787                                  MSG_1030:
 41788 0000693A 0E                      	db 14
 41789 0000693B 53796E746178206572-     	db 'Syntax error',0Dh,0Ah
 41789 00006944 726F720D0A         
 41790                                  MSG_1032:
 41791 00006949 17                      	db 23
 41792 0000694A 43757272656E742064-     	db 'Current date is %1 %2',0Dh,0Ah
 41792 00006953 617465206973202531-
 41792 0000695C 2025320D0A         
 41793                                  MSG_1033:
 41794 00006961 15                      	db 21
 41795 00006962 53756E4D6F6E547565-     	db 'SunMonTueWedThuFriSat'
 41795 0000696B 576564546875467269-
 41795 00006974 536174             
 41796                                  MSG_1034:
 41797 00006977 15                      	db 21
 41798 00006978 456E746572206E6577-     	db 'Enter new date (%1): '
 41798 00006981 206461746520282531-
 41798 0000698A 293A20             
 41799                                  MSG_1036:
 41800 0000698D 14                      	db 20
 41801 0000698E 43757272656E742074-     	db 'Current time is %1',0Dh,0Ah
 41801 00006997 696D65206973202531-
 41801 000069A0 0D0A               
 41802                                  MSG_1037:
 41803 000069A2 10                      	db 16
 41804 000069A3 456E746572206E6577-     	db 'Enter new time: '
 41804 000069AC 2074696D653A20     
 41805                                  MSG_1038:
 41806 000069B3 12                              db 18
 41807 000069B4 2C2020202044656C65-     	db ',    Delete (Y/N)?'
 41807 000069BD 74652028592F4E293F 
 41808                                  MSG_1039:
 41809 000069C6 3C                              db 60
 41810 000069C7 416C6C2066696C6573-     	db 'All files in directory will be deleted!',0Dh,0Ah
 41810 000069D0 20696E206469726563-
 41810 000069D9 746F72792077696C6C-
 41810 000069E2 2062652064656C6574-
 41810 000069EB 6564210D0A         
 41811 000069F0 41726520796F752073-     	db 'Are you sure (Y/N)?'
 41811 000069F9 7572652028592F4E29-
 41811 00006A02 3F                 
 41812                                  
 41813                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 41814                                  %if 0
 41815                                  MSG_1040:
 41816                                  	db 20
 41817                                  	db 'MS-DOS Version %1.%2'
 41818                                  %else
 41819                                  MSG_1040:
 41820 00006A03 12                      	db 18
 41821 00006A04 504320444F53205665-     	db 'PC DOS Version 7.1'
 41821 00006A0D 7273696F6E20372E31 
 41822                                  %endif
 41823                                  
 41824                                  MSG_1044:
 41825 00006A16 13                      	db 19
 41826 00006A17 496E76616C69642064-     	db 'Invalid directory',0Dh,0Ah
 41826 00006A20 69726563746F72790D-
 41826 00006A29 0A                 
 41827                                  MSG_1046:
 41828 00006A2A 36                      	db 54
 41829 00006A2B 496E76616C69642070-     	db 'Invalid path, not directory,',0Dh,0Ah
 41829 00006A34 6174682C206E6F7420-
 41829 00006A3D 6469726563746F7279-
 41829 00006A46 2C0D0A             
 41830 00006A49 6F7220646972656374-     	db 'or directory not empty',0Dh,0Ah
 41830 00006A52 6F7279206E6F742065-
 41830 00006A5B 6D7074790D0A       
 41831                                  MSG_1047:
 41832 00006A61 18                      	db 24
 41833 00006A62 4D7573742073706563-     	db 'Must specify ON or OFF',0Dh,0Ah
 41833 00006A6B 696679204F4E206F72-
 41833 00006A74 204F46460D0A       
 41834                                  MSG_1048:
 41835 00006A7A 11                      	db 17
 41836 00006A7B 4469726563746F7279-     	db 'Directory of %1',0Dh,0Ah
 41836 00006A84 206F662025310D0A   
 41837                                  MSG_1049:
 41838 00006A8C 09                      	db 9
 41839 00006A8D 4E6F20506174680D0A      	db 'No Path',0Dh,0Ah
 41840                                  MSG_1050:
 41841 00006A96 1E                      	db 30
 41842 00006A97 496E76616C69642064-     	db 'Invalid drive in search path',0Dh,0Ah
 41842 00006AA0 7269766520696E2073-
 41842 00006AA9 656172636820706174-
 41842 00006AB2 680D0A             
 41843                                  MSG_1051:
 41844 00006AB5 10                      	db 16
 41845 00006AB6 496E76616C69642064-     	db 'Invalid device',0Dh,0Ah
 41845 00006ABF 65766963650D0A     
 41846                                  MSG_1052:
 41847 00006AC6 16                      	db 22
 41848 00006AC7 464F522063616E6E6F-     	db 'FOR cannot be nested',0Dh,0Ah
 41848 00006AD0 74206265206E657374-
 41848 00006AD9 65640D0A           
 41849                                  MSG_1053:
 41850 00006ADD 25                      	db 37
 41851 00006ADE 496E7465726D656469-     	db 'Intermediate file error during pipe',0Dh,0Ah
 41851 00006AE7 6174652066696C6520-
 41851 00006AF0 6572726F7220647572-
 41851 00006AF9 696E6720706970650D-
 41851 00006B02 0A                 
 41852                                  MSG_1054:
 41853 00006B03 26                      	db 38
 41854 00006B04 43616E6E6F7420646F-     	db 'Cannot do binary reads from a device',0Dh,0Ah
 41854 00006B0D 2062696E6172792072-
 41854 00006B16 656164732066726F6D-
 41854 00006B1F 206120646576696365-
 41854 00006B28 0D0A               
 41855                                  
 41856                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:6205h)
 41857                                  	; 17/06/2023
 41858                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7155h)
 41859                                  	; 06/08/2024
 41860                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:6FDDh)
 41861                                  MSG_1055:
 41862 00006B2A 0D                      	db 13
 41863 00006B2B 425245414B20697320-     	db 'BREAK is %1',0Dh,0Ah
 41863 00006B34 25310D0A           
 41864                                  MSG_1056:
 41865 00006B38 0E                      	db 14
 41866 00006B39 564552494659206973-     	db 'VERIFY is %1',0Dh,0Ah
 41866 00006B42 2025310D0A         
 41867                                  MSG_1057:
 41868 00006B47 0C                      	db 12
 41869 00006B48 4543484F2069732025-     	db 'ECHO is %1',0Dh,0Ah
 41869 00006B51 310D0A             
 41870                                  MSG_1059:
 41871 00006B54 04                      	db 4
 41872 00006B55 6F666600                	db 'off',0
 41873                                  MSG_1060:
 41874 00006B59 03                      	db 3
 41875 00006B5A 6F6E00                  	db 'on',0
 41876                                  MSG_1061:
 41877 00006B5D 19                      	db 25
 41878 00006B5E 4572726F7220777269-     	db 'Error writing to device',0Dh,0Ah
 41878 00006B67 74696E6720746F2064-
 41878 00006B70 65766963650D0A     
 41879                                  MSG_1063:
 41880 00006B77 02                      	db 2
 41881 00006B78 2531                    	db '%1'
 41882                                  MSG_1064:
 41883 00006B7A 02                      	db 2
 41884 00006B7B 2531                    	db '%1'
 41885                                  MSG_1065:
 41886 00006B7D 02                      	db 2
 41887 00006B7E 2531                    	db '%1'
 41888                                  MSG_1066:
 41889 00006B80 02                      	db 2
 41890 00006B81 2531                    	db '%1'
 41891                                  MSG_1067:
 41892 00006B83 01                      	db 1
 41893 00006B84 09                      	db 9
 41894                                  MSG_1068:
 41895                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 41896                                  %if 0
 41897                                  	db 10
 41898                                  	db ' <DIR>    '
 41899                                  %else
 41900 00006B85 0C                      	db 12
 41901 00006B86 203C4449523E202020-     	db ' <DIR>      '
 41901 00006B8F 202020             
 41902                                  %endif
 41903                                  MSG_1069:
 41904 00006B92 03                      	db 3
 41905 00006B93 082008                  	db 8, 20h, 8
 41906                                  MSG_1070:	; CRLF
 41907 00006B96 02                      	db 2
 41908 00006B97 0D                      	db 0Dh
 41909 00006B98 0A                      	db 0Ah
 41910                                  MSG_1071:
 41911 00006B99 02                      	db 2
 41912 00006B9A 2531                    	db '%1'
 41913                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 41914                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:71C5h
 41915                                  MSG_1072:
 41916                                  	;db 8
 41917                                  	;db 'mm-dd-yy'
 41918 00006B9C 09                      	db 9
 41919 00006B9D 6D6D2D64642D797900      	db 'mm-dd-yy',0
 41920                                  MSG_1073:
 41921                                  	;db 8
 41922                                  	;db 'dd-mm-yy'
 41923 00006BA6 09                      	db 9
 41924 00006BA7 64642D6D6D2D797900      	db 'dd-mm-yy',0
 41925                                  MSG_1074:
 41926                                  	;db 8
 41927                                  	;db 'yy-mm-dd'
 41928 00006BB0 09                      	db 9
 41929 00006BB1 79792D6D6D2D646400      	db 'yy-mm-dd',0
 41930                                  MSG_1075:
 41931 00006BBA 05                      	db 5
 41932 00006BBB 2531202532              	db '%1 %2'
 41933                                  MSG_1076:
 41934 00006BC0 02                      	db 2
 41935 00006BC1 2531                    	db '%1'
 41936                                  MSG_1077:
 41937 00006BC3 07                      	db 7
 41938 00006BC4 20253120202532          	db ' %1  %2'
 41939                                  MSG_1078:
 41940 00006BCB 1A                      	db 26
 41941 00006BCC 4469726563746F7279-     	db 'Directory already exists',0Dh,0Ah
 41941 00006BD5 20616C726561647920-
 41941 00006BDE 6578697374730D0A   
 41942                                  MSG_1079:
 41943 00006BE6 0A                      	db 10
 41944 00006BE7 25312062797465730D-     	db '%1 bytes',0Dh,0Ah
 41944 00006BF0 0A                 
 41945                                  MSG_1080:
 41946 00006BF1 15                      	db 21
 41947 00006BF2 546F74616C2066696C-     	db 'Total files listed:',0Dh,0Ah
 41947 00006BFB 6573206C6973746564-
 41947 00006C04 3A0D0A             
 41948                                  MSG_1081:
 41949 00006C07 2A                      	db 42
 41950 00006C08 284572726F72206F63-     	db '(Error occurred in environment variable)',0Dh,0Ah
 41950 00006C11 63757272656420696E-
 41950 00006C1A 20656E7669726F6E6D-
 41950 00006C23 656E74207661726961-
 41950 00006C2C 626C65290D0A       
 41951                                  	;
 41952                                  ; 06/08/2024 -Retro DOS 5.0 COMMAND.COM
 41953                                  %if 0
 41954                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 41955                                  MSG_1082:
 41956                                          db 7
 41957                                  	db ' [Y/N]?'
 41958                                  %else
 41959                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 41960                                  MSG_1082:
 41961 00006C32 0B                              db 11
 41962 00006C33 205B592C4E2C455343-     	db ' [Y,N,ESC]?'
 41962 00006C3C 5D3F               
 41963                                  %endif
 41964                                  	;
 41965                                  MSG_1083:
 41966 00006C3E 02                      	db 2
 41967 00006C3F 594E                    	db 'YN'
 41968                                  	;
 41969                                  MSG_1084:
 41970 00006C41 0F                      	db 15
 41971 00006C42 28636F6E74696E7569-     	db '(continuing %1)'
 41971 00006C4B 6E6720253129       
 41972                                  MSG_1090:
 41973 00006C51 0D                      	db 13
 41974 00006C52 5265766973696F6E20-     	db 'Revision %1',0Dh,0Ah
 41974 00006C5B 25310D0A           
 41975                                  MSG_1091:
 41976 00006C5F 0D                      	db 13
 41977 00006C60 444F5320697320696E-     	db 'DOS is in ROM'
 41977 00006C69 20524F4D           
 41978                                  MSG_1092:
 41979 00006C6D 0D                      	db 13
 41980 00006C6E 444F5320697320696E-     	db 'DOS is in HMA'
 41980 00006C77 20484D41           
 41981                                  MSG_1093:
 41982 00006C7B 14                      	db 20
 41983 00006C7C 444F5320697320696E-     	db 'DOS is in low memory'
 41983 00006C85 206C6F77206D656D6F-
 41983 00006C8E 7279               
 41984                                  MSG_1094:
 41985 00006C90 1C                      	db 28
 41986 00006C91 43616E6E6F74204C6F-     	db 'Cannot Loadhigh batch file',0Dh,0Ah
 41986 00006C9A 616468696768206261-
 41986 00006CA3 7463682066696C650D-
 41986 00006CAC 0A                 
 41987                                  MSG_1095:
 41988 00006CAD 1C                      	db 28
 41989 00006CAE 4C6F6164486967683A-     	db 'LoadHigh: Invalid filename',0Dh,0Ah
 41989 00006CB7 20496E76616C696420-
 41989 00006CC0 66696C656E616D650D-
 41989 00006CC9 0A                 
 41990                                  MSG_1096:
 41991 00006CCA 30                      	db 48
 41992 00006CCB 43616E6E6F74206F70-     	db 'Cannot open specified country information file',0Dh,0Ah
 41992 00006CD4 656E20737065636966-
 41992 00006CDD 69656420636F756E74-
 41992 00006CE6 727920696E666F726D-
 41992 00006CEF 6174696F6E2066696C-
 41992 00006CF8 650D0A             
 41993                                  
 41994                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41995                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:7320h
 41996                                  MSG_1097:
 41997 00006CFB 1C                      	db 28
 41998 00006CFC 4C6F6164486967683A-     	db 'LoadHigh: Invalid argument',0Dh,0Ah
 41998 00006D05 20496E76616C696420-
 41998 00006D0E 617267756D656E740D-
 41998 00006D17 0A                 
 41999                                  MSG_1098:
 42000 00006D18 1C                      	db 28
 42001 00006D19 526571756972656420-     	db 'Required parameter missing',0Dh,0Ah
 42001 00006D22 706172616D65746572-
 42001 00006D2B 206D697373696E670D-
 42001 00006D34 0A                 
 42002                                  MSG_1099:
 42003 00006D35 15                      	db 21
 42004 00006D36 556E7265636F676E69-     	db 'Unrecognized switch',0Dh,0Ah
 42004 00006D3F 7A6564207377697463-
 42004 00006D48 680D0A             
 42005                                  MSG_1100:
 42006 00006D4B 25                      	db 37
 42007 00006D4C 412062616420554D42-     	db 'A bad UMB number has been specified',0Dh,0Ah
 42007 00006D55 206E756D6265722068-
 42007 00006D5E 6173206265656E2073-
 42007 00006D67 70656369666965640D-
 42007 00006D70 0A                 
 42008                                  
 42009                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 42010                                  %if 0
 42011                                  MSG_1101:
 42012                                  	db 14
 42013                                  	db '  %1.%2 to 1.0'
 42014                                  MSG_1102:
 42015                                  	db 57
 42016                                  	db '                 %1.%2 to 1.0 average compression ratio',0Dh,0Ah
 42017                                  %endif
 42018                                  
 42019                                  MSG_1103:
 42020 00006D71 1A                      	db 26
 42021 00006D72 4F7665727772697465-     	db 'Overwrite %1 (Yes/No/All)?'
 42021 00006D7B 20253120285965732F-
 42021 00006D84 4E6F2F416C6C293F   
 42022                                  MSG_1104:
 42023 00006D8C 03                      	db 3
 42024 00006D8D 59                      _Y_es:	db 'Y'
 42025 00006D8E 4E                      _N_o:	db 'N'
 42026 00006D8F 41                      _A_ll:	db 'A'
 42027                                  
 42028                                  ; 02/08/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 42029                                  %if 0
 42030                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:73FEh)
 42031                                  MSG_1105:
 42032                                  	db 4
 42033                                  	db '    '
 42034                                  %else
 42035                                  	; 03/08/2024
 42036                                  MSG_1105:
 42037 00006D90 0A                      	db 10
 42038 00006D91 203C4449523E202020-     	db ' <DIR>    '
 42038 00006D9A 20                 
 42039                                  
 42040                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:724Eh)
 42041                                  MSG_1106:
 42042 00006D9B 11                      	db 17
 42043 00006D9C 2531204B2062797465-     	db '%1 K bytes free',0Dh,0Ah
 42043 00006DA5 7320667265650D0A   
 42044                                  %endif
 42045                                  
 42046                                  	; ((MSDOS 5.0 COMMAND.COM - TRANGROUP:63C2h))
 42047                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7403h)
 42048                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:7260h
 42049                                  MSG_1200:
 42050 00006DAD 00                      	db 0	; /? unimplemented
 42051                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7404h)
 42052                                  MSG_1300:
 42053 00006DAE 86                      	db 134
 42054 00006DAF 53657473206F722063-     	db 'Sets or clears extended CTRL+C checking.',0Dh,0Ah
 42054 00006DB8 6C6561727320657874-
 42054 00006DC1 656E64656420435452-
 42054 00006DCA 4C2B4320636865636B-
 42054 00006DD3 696E672E0D0A       
 42055 00006DD9 0D0A                    	db 0Dh,0Ah
 42056 00006DDB 425245414B205B4F4E-     	db 'BREAK [ON | OFF]',0Dh,0Ah
 42056 00006DE4 207C204F46465D0D0A 
 42057 00006DED 0D0A                    	db 0Dh,0Ah
 42058 00006DEF 547970652042524541-     	db 'Type BREAK without a parameter to display the current BREAK setting.',0Dh,0Ah
 42058 00006DF8 4B20776974686F7574-
 42058 00006E01 206120706172616D65-
 42058 00006E0A 74657220746F206469-
 42058 00006E13 73706C617920746865-
 42058 00006E1C 2063757272656E7420-
 42058 00006E25 425245414B20736574-
 42058 00006E2E 74696E672E0D0A     
 42059                                  MSG_1320:
 42060 00006E35 3F                      	db 63
 42061 00006E36 446973706C61797320-     	db 'Displays or sets the active code page number.',0Dh,0Ah
 42061 00006E3F 6F7220736574732074-
 42061 00006E48 686520616374697665-
 42061 00006E51 20636F646520706167-
 42061 00006E5A 65206E756D6265722E-
 42061 00006E63 0D0A               
 42062 00006E65 0D0A                    	db 0Dh,0Ah
 42063 00006E67 43484350205B6E6E6E-     	db 'CHCP [nnn]',0Dh,0Ah
 42063 00006E70 5D0D0A             
 42064 00006E73 0D0A                    	db 0Dh,0Ah
 42065                                  MSG_1321:
 42066 00006E75 70                      	db 112
 42067 00006E76 20206E6E6E20202053-     	db '  nnn   Specifies a code page number.',0Dh,0Ah
 42067 00006E7F 706563696669657320-
 42067 00006E88 6120636F6465207061-
 42067 00006E91 6765206E756D626572-
 42067 00006E9A 2E0D0A             
 42068 00006E9D 0D0A                    	db 0Dh,0Ah
 42069 00006E9F 547970652043484350-     	db 'Type CHCP without a parameter to display the active code page number.',0Dh,0Ah
 42069 00006EA8 20776974686F757420-
 42069 00006EB1 6120706172616D6574-
 42069 00006EBA 657220746F20646973-
 42069 00006EC3 706C61792074686520-
 42069 00006ECC 61637469766520636F-
 42069 00006ED5 64652070616765206E-
 42069 00006EDE 756D6265722E0D0A   
 42070                                  MSG_1340:
 42071 00006EE6 5B                      	db 91
 42072 00006EE7 446973706C61797320-     	db 'Displays the name of or changes the current directory.',0Dh,0Ah
 42072 00006EF0 746865206E616D6520-
 42072 00006EF9 6F66206F7220636861-
 42072 00006F02 6E6765732074686520-
 42072 00006F0B 63757272656E742064-
 42072 00006F14 69726563746F72792E-
 42072 00006F1D 0D0A               
 42073 00006F1F 0D0A                    	db 0Dh,0Ah
 42074 00006F21 4348444952205B6472-     	db 'CHDIR [drive:][path]',0Dh,0Ah
 42074 00006F2A 6976653A5D5B706174-
 42074 00006F33 685D0D0A           
 42075 00006F37 43484449525B2E2E5D-     	db 'CHDIR[..]',0Dh,0Ah
 42075 00006F40 0D0A               
 42076                                  MSG_1341:
 42077 00006F42 62                      	db 98
 42078 00006F43 4344205B6472697665-     	db 'CD [drive:][path]',0Dh,0Ah
 42078 00006F4C 3A5D5B706174685D0D-
 42078 00006F55 0A                 
 42079 00006F56 43445B2E2E5D0D0A        	db 'CD[..]',0Dh,0Ah
 42080 00006F5E 0D0A                    	db 0Dh,0Ah
 42081 00006F60 20202E2E2020205370-     	db '  ..   Specifies that you want to change to the parent directory.'
 42081 00006F69 656369666965732074-
 42081 00006F72 68617420796F752077-
 42081 00006F7B 616E7420746F206368-
 42081 00006F84 616E676520746F2074-
 42081 00006F8D 686520706172656E74-
 42081 00006F96 206469726563746F72-
 42081 00006F9F 792E               
 42082 00006FA1 0D0A                    	db 0Dh,0Ah
 42083 00006FA3 0D0A                    	db 0Dh,0Ah
 42084                                  MSG_1342:
 42085 00006FA5 91                      	db 145
 42086 00006FA6 547970652043442064-     	db 'Type CD drive: to display the current directory in the specified '
 42086 00006FAF 726976653A20746F20-
 42086 00006FB8 646973706C61792074-
 42086 00006FC1 68652063757272656E-
 42086 00006FCA 74206469726563746F-
 42086 00006FD3 727920696E20746865-
 42086 00006FDC 207370656369666965-
 42086 00006FE5 6420               
 42087 00006FE7 64726976652E0D0A        	db 'drive.',0Dh,0Ah
 42088 00006FEF 547970652043442077-     	db 'Type CD without parameters to display the current drive and directory.',0Dh,0Ah
 42088 00006FF8 6974686F7574207061-
 42088 00007001 72616D657465727320-
 42088 0000700A 746F20646973706C61-
 42088 00007013 792074686520637572-
 42088 0000701C 72656E742064726976-
 42088 00007025 6520616E6420646972-
 42088 0000702E 6563746F72792E0D0A 
 42089                                  MSG_1360:
 42090 00007037 1B                      	db 27
 42091 00007038 436C65617273207468-     	db 'Clears the screen.',0Dh,0Ah
 42091 00007041 652073637265656E2E-
 42091 0000704A 0D0A               
 42092 0000704C 0D0A                    	db 0Dh,0Ah
 42093 0000704E 434C530D0A              	db 'CLS',0Dh,0Ah
 42094                                  MSG_1400:
 42095                                  	;db 145
 42096                                  	;db 'Copies one or more files to another location.',0Dh,0Ah
 42097                                  	;db 0Dh,0Ah
 42098                                  	;db 'COPY [/A | /B] source [/A | /B] [+ source [/A | /B] [+ ...]] [destination',0Dh,0Ah
 42099                                  	;db '  [/A | /B]] [/V]',0Dh,0Ah
 42100                                  	;db 0Dh,0Ah
 42101                                  	
 42102                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42103                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:76A9h)
 42104                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42105                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:7506h)
 42106                                  
 42107 00007053 9C                      	db 156 ; 19/06/2023	
 42108 00007054 436F70696573206F6E-     	db 'Copies one or more files to another location.',0Dh,0Ah
 42108 0000705D 65206F72206D6F7265-
 42108 00007066 2066696C657320746F-
 42108 0000706F 20616E6F7468657220-
 42108 00007078 6C6F636174696F6E2E-
 42108 00007081 0D0A               
 42109 00007083 0D0A                    	db 0Dh,0Ah
 42110 00007085 434F5059205B2F4120-     	db 'COPY [/A | /B] source [/A | /B] [+ source [/A | /B] [+ ...]] [destination',0Dh,0Ah
 42110 0000708E 7C202F425D20736F75-
 42110 00007097 726365205B2F41207C-
 42110 000070A0 202F425D205B2B2073-
 42110 000070A9 6F75726365205B2F41-
 42110 000070B2 207C202F425D205B2B-
 42110 000070BB 202E2E2E5D5D205B64-
 42110 000070C4 657374696E6174696F-
 42110 000070CD 6E0D0A             
 42111 000070D0 20205B2F41207C202F-     	db '  [/A | /B]] [/V] [/Y | /-Y]',0Dh,0Ah
 42111 000070D9 425D5D205B2F565D20-
 42111 000070E2 5B2F59207C202F2D59-
 42111 000070EB 5D0D0A             
 42112 000070EE 0D0A                    	db 0Dh,0Ah
 42113                                  MSG_1401:
 42114 000070F0 68                      	db 104
 42115 000070F1 2020736F7572636520-     	db '  source       Specifies the file or files to be copied.',0Dh,0Ah
 42115 000070FA 202020202020537065-
 42115 00007103 636966696573207468-
 42115 0000710C 652066696C65206F72-
 42115 00007115 2066696C657320746F-
 42115 0000711E 20626520636F706965-
 42115 00007127 642E0D0A           
 42116 0000712B 20202F412020202020-     	db '  /A           Indicates an ASCII text file.',0Dh,0Ah
 42116 00007134 202020202020496E64-
 42116 0000713D 69636174657320616E-
 42116 00007146 204153434949207465-
 42116 0000714F 78742066696C652E0D-
 42116 00007158 0A                 
 42117                                  MSG_1402:
 42118 00007159 76                      	db 118
 42119 0000715A 20202F422020202020-     	db '  /B           Indicates a binary file.',0Dh,0Ah
 42119 00007163 202020202020496E64-
 42119 0000716C 696361746573206120-
 42119 00007175 62696E617279206669-
 42119 0000717E 6C652E0D0A         
 42120 00007183 202064657374696E61-     	db '  destination  Specifies the directory and/or filename for the new file(s).',0Dh,0Ah
 42120 0000718C 74696F6E2020537065-
 42120 00007195 636966696573207468-
 42120 0000719E 65206469726563746F-
 42120 000071A7 727920616E642F6F72-
 42120 000071B0 2066696C656E616D65-
 42120 000071B9 20666F722074686520-
 42120 000071C2 6E65772066696C6528-
 42120 000071CB 73292E0D0A         
 42121                                  MSG_1403:	
 42122                                  	;db 65  ;  MSDOS 5.0
 42123                                  	; 17/06/2023
 42124 000071D0 3F                      	db 63 ; MSDOS 6.22	
 42125 000071D1 20202F562020202020-     	db '  /V           Verifies that new files are written correctly.',0Dh,0Ah
 42125 000071DA 202020202020566572-
 42125 000071E3 696669657320746861-
 42125 000071EC 74206E65772066696C-
 42125 000071F5 657320617265207772-
 42125 000071FE 697474656E20636F72-
 42125 00007207 726563746C792E0D0A 
 42126                                  	;db 0Dh,0Ah ; MSDOS 5.0
 42127                                  
 42128                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42129                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:7866h
 42130                                  MSG_1404:
 42131 00007210 74                              db 116
 42132 00007211 20202F592020202020-     	db '  /Y           Suppresses prompting to confirm you want to overwrite an',0Dh,0Ah
 42132 0000721A 202020202020537570-
 42132 00007223 707265737365732070-
 42132 0000722C 726F6D7074696E6720-
 42132 00007235 746F20636F6E666972-
 42132 0000723E 6D20796F752077616E-
 42132 00007247 7420746F206F766572-
 42132 00007250 777269746520616E0D-
 42132 00007259 0A                 
 42133 0000725A 202020202020202020-     	db '               existing destination file.',0Dh,0Ah
 42133 00007263 202020202020657869-
 42133 0000726C 7374696E6720646573-
 42133 00007275 74696E6174696F6E20-
 42133 0000727E 66696C652E0D0A     
 42134                                  MSG_1405:
 42135 00007285 72                      	db 114
 42136 00007286 20202F2D5920202020-     	db '  /-Y          Causes prompting to confirm you want to overwrite an',0Dh,0Ah
 42136 0000728F 202020202020436175-
 42136 00007298 7365732070726F6D70-
 42136 000072A1 74696E6720746F2063-
 42136 000072AA 6F6E6669726D20796F-
 42136 000072B3 752077616E7420746F-
 42136 000072BC 206F76657277726974-
 42136 000072C5 6520616E0D0A       
 42137 000072CB 202020202020202020-     	db '               existing destination file.',0Dh,0Ah
 42137 000072D4 202020202020657869-
 42137 000072DD 7374696E6720646573-
 42137 000072E6 74696E6174696F6E20-
 42137 000072EF 66696C652E0D0A     
 42138 000072F6 0D0A                    	db 0Dh,0Ah
 42139                                  MSG_1406:
 42140 000072F8 42                      	db 66
 42141 000072F9 546865207377697463-     	db 'The switch /Y may be preset in the COPYCMD environment variable.',0Dh,0Ah
 42141 00007302 68202F59206D617920-
 42141 0000730B 626520707265736574-
 42141 00007314 20696E207468652043-
 42141 0000731D 4F5059434D4420656E-
 42141 00007326 7669726F6E6D656E74-
 42141 0000732F 207661726961626C65-
 42141 00007338 2E0D0A             
 42142                                  
 42143                                  ;MSG_1404: ; MSDOS 5.0 (TRANGROUP:681Ch)
 42144                                  	   ; MSDOS 6.22	(TRANGROUP:7991h)
 42145                                  MSG_1407:  ; PCDOS 7.1	(TRANGROUP:77EEh)
 42146 0000733B 87                      	db 135
 42147 0000733C 546F20617070656E64-     	db 'To append files, specify a single file for destination, but multiple files',0Dh,0Ah
 42147 00007345 2066696C65732C2073-
 42147 0000734E 706563696679206120-
 42147 00007357 73696E676C65206669-
 42147 00007360 6C6520666F72206465-
 42147 00007369 7374696E6174696F6E-
 42147 00007372 2C20627574206D756C-
 42147 0000737B 7469706C652066696C-
 42147 00007384 65730D0A           
 42148 00007388 666F7220736F757263-     	db 'for source (using wildcards or file1+file2+file3 format).',0Dh,0Ah
 42148 00007391 6520287573696E6720-
 42148 0000739A 77696C646361726473-
 42148 000073A3 206F722066696C6531-
 42148 000073AC 2B66696C65322B6669-
 42148 000073B5 6C653320666F726D61-
 42148 000073BE 74292E0D0A         
 42149                                  MSG_1420:
 42150 000073C3 8A                      	db 138
 42151 000073C4 4368616E6765732074-     	db 'Changes the terminal device used to control your system.',0Dh,0Ah
 42151 000073CD 6865207465726D696E-
 42151 000073D6 616C20646576696365-
 42151 000073DF 207573656420746F20-
 42151 000073E8 636F6E74726F6C2079-
 42151 000073F1 6F7572207379737465-
 42151 000073FA 6D2E0D0A           
 42152 000073FE 0D0A                    	db 0Dh,0Ah
 42153 00007400 435454592064657669-     	db 'CTTY device',0Dh,0Ah
 42153 00007409 63650D0A           
 42154 0000740D 0D0A                    	db 0Dh,0Ah
 42155 0000740F 202064657669636520-     	db '  device   The terminal device you want to use, such as COM1.',0Dh,0Ah
 42155 00007418 202054686520746572-
 42155 00007421 6D696E616C20646576-
 42155 0000742A 69636520796F752077-
 42155 00007433 616E7420746F207573-
 42155 0000743C 652C20737563682061-
 42155 00007445 7320434F4D312E0D0A 
 42156                                  MSG_1440:
 42157                                  	;db 45
 42158                                  	;db 'Displays or sets the date.',0Dh,0Ah
 42159                                  	;db 0Dh,0Ah
 42160                                  	;db 'DATE [date]',0Dh,0Ah
 42161                                  	;db 0Dh,0Ah
 42162                                  
 42163                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42164                                  %if 0
 42165                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42166                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7AA4h)
 42167                                  	db 93
 42168                                  	db 'Displays or sets the date.',0Dh,0Ah
 42169                                  	db 0Dh,0Ah
 42170                                  	db 'DATE [mm-dd-yy]',0Dh,0Ah
 42171                                  	db 0Dh,0Ah
 42172                                  	db '  mm-dd-yy    Sets the date you specify.',0Dh,0Ah
 42173                                  	db 0Dh,0Ah
 42174                                  %else
 42175                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42176                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:7901h)
 42177 0000744E 26                      	db 38
 42178 0000744F 446973706C61797320-     	db 'Displays or sets the date.',0Dh,0Ah
 42178 00007458 6F7220736574732074-
 42178 00007461 686520646174652E0D-
 42178 0000746A 0A                 
 42179 0000746B 0D0A                    	db 0Dh,0Ah
 42180 0000746D 444154450D0A            	db 'DATE',0Dh,0Ah
 42181 00007473 0D0A                    	db 0Dh,0Ah	
 42182                                  %endif
 42183                                  
 42184                                  MSG_1441:
 42185 00007475 83                      	db 131
 42186 00007476 547970652044415445-     	db 'Type DATE without parameters to display the current date setting and',0Dh,0Ah
 42186 0000747F 20776974686F757420-
 42186 00007488 706172616D65746572-
 42186 00007491 7320746F2064697370-
 42186 0000749A 6C6179207468652063-
 42186 000074A3 757272656E74206461-
 42186 000074AC 74652073657474696E-
 42186 000074B5 6720616E640D0A     
 42187 000074BC 612070726F6D707420-     	db 'a prompt for a new one.  Press ENTER to keep the same date.',0Dh,0Ah
 42187 000074C5 666F722061206E6577-
 42187 000074CE 206F6E652E20205072-
 42187 000074D7 65737320454E544552-
 42187 000074E0 20746F206B65657020-
 42187 000074E9 7468652073616D6520-
 42187 000074F2 646174652E0D0A     
 42188                                  MSG_1460:	
 42189 000074F9 64                      	db 100
 42190 000074FA 44656C65746573206F-     	db 'Deletes one or more files.',0Dh,0Ah
 42190 00007503 6E65206F72206D6F72-
 42190 0000750C 652066696C65732E0D-
 42190 00007515 0A                 
 42191 00007516 0D0A                    	db 0Dh,0Ah
 42192 00007518 44454C205B64726976-     	db 'DEL [drive:][path]filename [/P]',0Dh,0Ah
 42192 00007521 653A5D5B706174685D-
 42192 0000752A 66696C656E616D6520-
 42192 00007533 5B2F505D0D0A       
 42193 00007539 4552415345205B6472-     	db 'ERASE [drive:][path]filename [/P]',0Dh,0Ah
 42193 00007542 6976653A5D5B706174-
 42193 0000754B 685D66696C656E616D-
 42193 00007554 65205B2F505D0D0A   
 42194 0000755C 0D0A                    	db 0Dh,0Ah
 42195                                  MSG_1461:
 42196 0000755E 83                      	db 131
 42197 0000755F 20205B64726976653A-     	db '  [drive:][path]filename  Specifies the file(s) to delete.  Specify multiple',0Dh,0Ah
 42197 00007568 5D5B706174685D6669-
 42197 00007571 6C656E616D65202053-
 42197 0000757A 706563696669657320-
 42197 00007583 7468652066696C6528-
 42197 0000758C 732920746F2064656C-
 42197 00007595 6574652E2020537065-
 42197 0000759E 63696679206D756C74-
 42197 000075A7 69706C650D0A       
 42198 000075AD 202020202020202020-     	db '                          files by using wildcards.',0Dh,0Ah
 42198 000075B6 202020202020202020-
 42198 000075BF 202020202020202066-
 42198 000075C8 696C65732062792075-
 42198 000075D1 73696E672077696C64-
 42198 000075DA 63617264732E0D0A   
 42199                                  MSG_1462:
 42200 000075E2 4F                      	db 79
 42201 000075E3 20202F502020202020-     	db '  /P                      Prompts for confirmation before deleting each file.',0Dh,0Ah
 42201 000075EC 202020202020202020-
 42201 000075F5 202020202020202050-
 42201 000075FE 726F6D70747320666F-
 42201 00007607 7220636F6E6669726D-
 42201 00007610 6174696F6E20626566-
 42201 00007619 6F72652064656C6574-
 42201 00007622 696E67206561636820-
 42201 0000762B 66696C652E0D0A     
 42202                                  
 42203                                  ; 17/06/2023
 42204                                  %if 0	; MSDOS 5.0 DIR Help messages
 42205                                  
 42206                                  MSG_1480:
 42207                                  	db 162
 42208                                  	db 'Displays a list of files and subdirectories in a directory.',0Dh,0Ah
 42209                                  	db 0Dh,0Ah
 42210                                  	db 'DIR [drive:][path][filename] [/P] [/W] [/A[[:]attributes]]',0Dh,0Ah
 42211                                  	db '  [/O[[:]sortorder]] [/S] [/B] [/L]',0Dh,0Ah
 42212                                  	db 0Dh,0Ah
 42213                                  MSG_1481:
 42214                                  	db 93
 42215                                  	db '  [drive:][path][filename]',0Dh,0Ah
 42216                                  	db '              Specifies drive, directory, and/or files to list.',0Dh,0Ah
 42217                                  MSG_1482:
 42218                                  	db 97
 42219                                  	db '  /P          Pauses after each screenful of information.',0Dh,0Ah
 42220                                  	db '  /W          Uses wide list format.',0Dh,0Ah
 42221                                  MSG_1483:	
 42222                                  	db 122
 42223                                  	db '  /A          Displays files with specified attributes.',0Dh,0Ah
 42224                                  	db '  attributes   D  Directories                R  Read-only files',0Dh,0Ah
 42225                                  MSG_1484:
 42226                                  	db 191
 42227                                  	db '               H  Hidden files               A  Files ready for archiving',0Dh,0Ah
 42228                                  	db '               S  System files               -  Prefix meaning "not"',0Dh,0Ah
 42229                                  	db '  /O          List by files in sorted order.',0Dh,0Ah
 42230                                  MSG_1485:
 42231                                  	db 155
 42232                                  	db '  sortorder    N  By name (alphabetic)       S  By size (smallest first)',0Dh,0Ah
 42233                                  	db '               E  By extension (alphabetic)  D  By date & time (earliest first)',0Dh,0Ah
 42234                                  MSG_1486:
 42235                                  	db 150
 42236                                  	db '               G  Group directories first    -  Prefix to reverse order',0Dh,0Ah
 42237                                  	db '  /S          Displays files in specified directory and all subdirectories.',0Dh,0Ah
 42238                                  MSG_1487:
 42239                                  	db 102
 42240                                  	db '  /B          Uses bare format (no heading information or summary).',0Dh,0Ah
 42241                                  	db '  /L          Uses lowercase.',0Dh,0Ah
 42242                                  	db 0Dh,0Ah
 42243                                  MSG_1488:
 42244                                  	db 146
 42245                                  	db 'Switches may be preset in the DIRCMD environment variable.  Override',0Dh,0Ah
 42246                                  	db 'preset switches by prefixing any switch with - (hyphen)--for example, /-W.',0Dh,0Ah
 42247                                  %endif
 42248                                  
 42249                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42250                                  %if 0
 42251                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42252                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:7CBFh
 42253                                  MSG_1480:
 42254                                  	db 137
 42255                                  	db 'Displays a list of files and subdirectories in a directory.',0Dh,0Ah
 42256                                  	db 0Dh,0Ah
 42257                                  	db 'DIR [drive:][path][filename] [/P] [/W] [/A[[:]attribs]] [/O[[:]sortord]]',0Dh,0Ah
 42258                                  MSG_1481:
 42259                                  	db 30
 42260                                  	db '    [/S] [/B] [/L] [/C[H]]',0Dh,0Ah
 42261                                  	db 0Dh,0Ah
 42262                                  MSG_1482:
 42263                                  	db 80
 42264                                  	db '  [drive:][path][filename]   Specifies drive, directory, and/or files to list.',0Dh,0Ah
 42265                                  MSG_1483:
 42266                                  	db 89
 42267                                  	db '  /P      Pauses after each screenful of information.',0Dh,0Ah
 42268                                  	db '  /W      Uses wide list format.',0Dh,0Ah
 42269                                  MSG_1484:
 42270                                  	db 126
 42271                                  	db '  /A      Displays files with specified attributes.',0Dh,0Ah
 42272                                  	db '  attribs   D  Directories   R  Read-only files         H  Hidden files',0Dh,0Ah
 42273                                  MSG_1485:
 42274                                  	db 123
 42275                                  	db '            S  System files  A  Files ready to archive  -  Prefix meaning "not"',0Dh,0Ah
 42276                                  	db '  /O      List by files in sorted order.',0Dh,0Ah
 42277                                  MSG_1486:
 42278                                  	db 149
 42279                                  	db '  sortord   N  By name (alphabetic)       S  By size (smallest first)',0Dh,0Ah
 42280                                  	db '            E  By extension (alphabetic)  D  By date & time (earliest first)',0Dh,0Ah
 42281                                  MSG_1487:
 42282                                  	db 70
 42283                                  	db '            G  Group directories first    -  Prefix to reverse order',0Dh,0Ah
 42284                                  MSG_1488:
 42285                                  	db 127
 42286                                  	db '            C  By compression ratio (smallest first)',0Dh,0Ah
 42287                                  	db '  /S      Displays files in specified directory and all subdirectories.',0Dh,0Ah
 42288                                  MSG_1489:
 42289                                  	db 65
 42290                                  	db '  /B      Uses bare format (no heading information or summary).',0Dh,0Ah
 42291                                  
 42292                                  MSG_1490:
 42293                                  	db 27
 42294                                  	db '  /L      Uses lowercase.',0Dh,0Ah
 42295                                  MSG_1491:
 42296                                  	db 82
 42297                                  	db '  /C[H]   Displays file compression ratio; /CH uses host allocation unit size.',0Dh,0Ah
 42298                                  	db 0Dh,0Ah
 42299                                  MSG_1492:
 42300                                  	db 146
 42301                                  	db 'Switches may be preset in the DIRCMD environment variable.  Override',0Dh,0Ah
 42302                                  	db 'preset switches by prefixing any switch with - (hyphen)--for example, /-W.',0Dh,0Ah
 42303                                  MSG_1493:
 42304                                  	db 22
 42305                                  	db '    [/S] [/B] [/L]',0Dh,0Ah
 42306                                  	db 0Dh,0Ah
 42307                                  MSG_1494:
 42308                                  	db 29
 42309                                  	db '  /L      Uses lowercase.',0Dh,0Ah
 42310                                  	db 0Dh,0Ah
 42311                                  %else
 42312                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42313                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:7AE5h
 42314                                  MSG_1480:
 42315 00007632 9F                      	db 159
 42316 00007633 446973706C61797320-     	db 'Displays a list of files and subdirectories in a directory.',0Dh,0Ah
 42316 0000763C 61206C697374206F66-
 42316 00007645 2066696C657320616E-
 42316 0000764E 642073756264697265-
 42316 00007657 63746F726965732069-
 42316 00007660 6E2061206469726563-
 42316 00007669 746F72792E0D0A     
 42317 00007670 0D0A                    	db 0Dh,0Ah
 42318 00007672 444952205B64726976-     	db 'DIR [drive:][path][filename] [/P] [/W] [/A[[:]attribs]] [/O[[:]sortord]]',0Dh,0Ah
 42318 0000767B 653A5D5B706174685D-
 42318 00007684 5B66696C656E616D65-
 42318 0000768D 5D205B2F505D205B2F-
 42318 00007696 575D205B2F415B5B3A-
 42318 0000769F 5D617474726962735D-
 42318 000076A8 5D205B2F4F5B5B3A5D-
 42318 000076B1 736F72746F72645D5D-
 42318 000076BA 0D0A               
 42319 000076BC 202020205B2F535D20-     	db '    [/S] [/B] [/L]',0Dh,0Ah
 42319 000076C5 5B2F425D205B2F4C5D-
 42319 000076CE 0D0A               
 42320 000076D0 0D0A                    	db 0Dh,0Ah
 42321                                  MSG_1481:
 42322 000076D2 4D                      	db 77
 42323 000076D3 20205B64726976653A-     	db '  [drive:][path][filename]   Specifies drive, directory, and files to list.',0Dh,0Ah
 42323 000076DC 5D5B706174685D5B66-
 42323 000076E5 696C656E616D655D20-
 42323 000076EE 202053706563696669-
 42323 000076F7 65732064726976652C-
 42323 00007700 206469726563746F72-
 42323 00007709 792C20616E64206669-
 42323 00007712 6C657320746F206C69-
 42323 0000771B 73742E0D0A         
 42324                                  MSG_1482:
 42325 00007720 5B                      	db 91
 42326 00007721 20202F502020202020-     	db '  /P      Pauses after each full screen of information.',0Dh,0Ah
 42326 0000772A 205061757365732061-
 42326 00007733 667465722065616368-
 42326 0000773C 2066756C6C20736372-
 42326 00007745 65656E206F6620696E-
 42326 0000774E 666F726D6174696F6E-
 42326 00007757 2E0D0A             
 42327 0000775A 20202F572020202020-     	db '  /W      Uses wide list format.',0Dh,0Ah
 42327 00007763 205573657320776964-
 42327 0000776C 65206C69737420666F-
 42327 00007775 726D61742E0D0A     
 42328                                  MSG_1483:
 42329 0000777C 7E                      	db 126
 42330 0000777D 20202F412020202020-     	db '  /A      Displays files with specified attributes.',0Dh,0Ah
 42330 00007786 20446973706C617973-
 42330 0000778F 2066696C6573207769-
 42330 00007798 746820737065636966-
 42330 000077A1 696564206174747269-
 42330 000077AA 62757465732E0D0A   
 42331 000077B2 202061747472696273-     	db '  attribs   D  Directories   R  Read-only files         H  Hidden files',0Dh,0Ah
 42331 000077BB 202020442020446972-
 42331 000077C4 6563746F7269657320-
 42331 000077CD 202052202052656164-
 42331 000077D6 2D6F6E6C792066696C-
 42331 000077DF 657320202020202020-
 42331 000077E8 202048202048696464-
 42331 000077F1 656E2066696C65730D-
 42331 000077FA 0A                 
 42332                                  MSG_1484:
 42333 000077FB 7C                      	db 124
 42334 000077FC 202020202020202020-     	db '            S  System files  A  Files ready to archive  -  Prefix meaning "not"',0Dh,0Ah
 42334 00007805 202020532020537973-
 42334 0000780E 74656D2066696C6573-
 42334 00007817 202041202046696C65-
 42334 00007820 732072656164792074-
 42334 00007829 6F2061726368697665-
 42334 00007832 20202D202050726566-
 42334 0000783B 6978206D65616E696E-
 42334 00007844 6720226E6F74220D0A 
 42335 0000784D 20202F4F2020202020-     	db '  /O      Lists by files in sorted order.',0Dh,0Ah
 42335 00007856 204C69737473206279-
 42335 0000785F 2066696C657320696E-
 42335 00007868 20736F72746564206F-
 42335 00007871 726465722E0D0A     
 42336                                  MSG_1485:
 42337 00007878 95                      	db 149
 42338 00007879 2020736F72746F7264-     	db '  sortord   N  By name (alphabetic)       S  By size (smallest first)',0Dh,0Ah
 42338 00007882 2020204E2020427920-
 42338 0000788B 6E616D652028616C70-
 42338 00007894 686162657469632920-
 42338 0000789D 202020202020532020-
 42338 000078A6 42792073697A652028-
 42338 000078AF 736D616C6C65737420-
 42338 000078B8 6669727374290D0A   
 42339 000078C0 202020202020202020-     	db '            E  By extension (alphabetic)  D  By date & time (earliest first)',0Dh,0Ah
 42339 000078C9 202020452020427920-
 42339 000078D2 657874656E73696F6E-
 42339 000078DB 2028616C7068616265-
 42339 000078E4 746963292020442020-
 42339 000078ED 427920646174652026-
 42339 000078F6 2074696D6520286561-
 42339 000078FF 726C69657374206669-
 42339 00007908 727374290D0A       
 42340                                  MSG_1486:
 42341 0000790E 8F                      	db 143
 42342 0000790F 202020202020202020-     	db '            G  Group directories first    -  Prefix to reverse order',0Dh,0Ah
 42342 00007918 20202047202047726F-
 42342 00007921 757020646972656374-
 42342 0000792A 6F7269657320666972-
 42342 00007933 7374202020202D2020-
 42342 0000793C 50726566697820746F-
 42342 00007945 207265766572736520-
 42342 0000794E 6F726465720D0A     
 42343 00007955 20202F532020202020-     	db '  /S      Displays files in specified directory and all subdirectories.',0Dh,0Ah
 42343 0000795E 20446973706C617973-
 42343 00007967 2066696C657320696E-
 42343 00007970 207370656369666965-
 42343 00007979 64206469726563746F-
 42343 00007982 727920616E6420616C-
 42343 0000798B 6C2073756264697265-
 42343 00007994 63746F726965732E0D-
 42343 0000799D 0A                 
 42344                                  MSG_1487:
 42345 0000799E 5E                      	db 94
 42346 0000799F 20202F422020202020-     	db '  /B      Uses bare format (no heading information or summary).',0Dh,0Ah
 42346 000079A8 205573657320626172-
 42346 000079B1 6520666F726D617420-
 42346 000079BA 286E6F206865616469-
 42346 000079C3 6E6720696E666F726D-
 42346 000079CC 6174696F6E206F7220-
 42346 000079D5 73756D6D617279292E-
 42346 000079DE 0D0A               
 42347 000079E0 20202F4C2020202020-     	db '  /L      Uses lowercase.',0Dh,0Ah
 42347 000079E9 2055736573206C6F77-
 42347 000079F2 6572636173652E0D0A 
 42348 000079FB 0D0A                    	db 0Dh,0Ah
 42349                                  MSG_1488:
 42350 000079FD 92                      	db 146
 42351 000079FE 537769746368657320-     	db 'Switches may be preset in the DIRCMD environment variable.  Override',0Dh,0Ah
 42351 00007A07 6D6179206265207072-
 42351 00007A10 6573657420696E2074-
 42351 00007A19 686520444952434D44-
 42351 00007A22 20656E7669726F6E6D-
 42351 00007A2B 656E74207661726961-
 42351 00007A34 626C652E20204F7665-
 42351 00007A3D 72726964650D0A     
 42352 00007A44 707265736574207377-     	db 'preset switches by prefixing any switch with - (hyphen)--for example, /-W.',0Dh,0Ah
 42352 00007A4D 697463686573206279-
 42352 00007A56 20707265666978696E-
 42352 00007A5F 6720616E7920737769-
 42352 00007A68 746368207769746820-
 42352 00007A71 2D202868797068656E-
 42352 00007A7A 292D2D666F72206578-
 42352 00007A83 616D706C652C202F2D-
 42352 00007A8C 572E0D0A           
 42353                                  MSG_1489:
 42354 00007A90 50                      	db 80
 42355 00007A91 546F2072656D6F7665-     	db 'To remove the commas from the DIR output, use the NO_SEP environment variable.',0Dh,0Ah
 42355 00007A9A 2074686520636F6D6D-
 42355 00007AA3 61732066726F6D2074-
 42355 00007AAC 686520444952206F75-
 42355 00007AB5 747075742C20757365-
 42355 00007ABE 20746865204E4F5F53-
 42355 00007AC7 455020656E7669726F-
 42355 00007AD0 6E6D656E7420766172-
 42355 00007AD9 6961626C652E0D0A   
 42356                                  %endif
 42357                                  
 42358                                  MSG_1500:
 42359 00007AE1 3E                      	db 62
 42360 00007AE2 517569747320746865-     	db 'Quits the COMMAND.COM program (command interpreter).',0Dh,0Ah
 42360 00007AEB 20434F4D4D414E442E-
 42360 00007AF4 434F4D2070726F6772-
 42360 00007AFD 616D2028636F6D6D61-
 42360 00007B06 6E6420696E74657270-
 42360 00007B0F 7265746572292E0D0A 
 42361 00007B18 0D0A                    	db 0Dh,0Ah
 42362 00007B1A 455849540D0A            	db 'EXIT',0Dh,0Ah
 42363                                  MSG_1520:
 42364 00007B20 3D                      	db 61
 42365 00007B21 437265617465732061-     	db 'Creates a directory.',0Dh,0Ah
 42365 00007B2A 206469726563746F72-
 42365 00007B33 792E0D0A           
 42366 00007B37 0D0A                    	db 0Dh,0Ah
 42367 00007B39 4D4B444952205B6472-     	db 'MKDIR [drive:]path',0Dh,0Ah
 42367 00007B42 6976653A5D70617468-
 42367 00007B4B 0D0A               
 42368 00007B4D 4D44205B6472697665-     	db 'MD [drive:]path',0Dh,0Ah
 42368 00007B56 3A5D706174680D0A   
 42369                                  MSG_1540:
 42370 00007B5E 5D                      	db 93
 42371 00007B5F 446973706C61797320-     	db 'Displays or sets a search path for executable files.',0Dh,0Ah
 42371 00007B68 6F7220736574732061-
 42371 00007B71 207365617263682070-
 42371 00007B7A 61746820666F722065-
 42371 00007B83 786563757461626C65-
 42371 00007B8C 2066696C65732E0D0A 
 42372 00007B95 0D0A                    	db 0Dh,0Ah
 42373 00007B97 50415448205B5B6472-     	db 'PATH [[drive:]path[;...]]',0Dh,0Ah
 42373 00007BA0 6976653A5D70617468-
 42373 00007BA9 5B3B2E2E2E5D5D0D0A 
 42374 00007BB2 50415448203B0D0A        	db 'PATH ;',0Dh,0Ah
 42375 00007BBA 0D0A                    	db 0Dh,0Ah
 42376                                  MSG_1541:
 42377 00007BBC 6B                      	db 107
 42378 00007BBD 547970652050415448-     	db 'Type PATH ; to clear all search-path settings and direct PC DOS to search',0Dh,0Ah
 42378 00007BC6 203B20746F20636C65-
 42378 00007BCF 617220616C6C207365-
 42378 00007BD8 617263682D70617468-
 42378 00007BE1 2073657474696E6773-
 42378 00007BEA 20616E642064697265-
 42378 00007BF3 637420504320444F53-
 42378 00007BFC 20746F207365617263-
 42378 00007C05 680D0A             
 42379 00007C08 6F6E6C7920696E2074-     	db 'only in the current directory.',0Dh,0Ah
 42379 00007C11 68652063757272656E-
 42379 00007C1A 74206469726563746F-
 42379 00007C23 72792E0D0A         
 42380                                  MSG_1542:
 42381 00007C28 3B                      	db 59
 42382 00007C29 547970652050415448-     	db 'Type PATH without parameters to display the current path.',0Dh,0Ah
 42382 00007C32 20776974686F757420-
 42382 00007C3B 706172616D65746572-
 42382 00007C44 7320746F2064697370-
 42382 00007C4D 6C6179207468652063-
 42382 00007C56 757272656E74207061-
 42382 00007C5F 74682E0D0A         
 42383                                  MSG_1560:
 42384 00007C64 37                      	db 55
 42385 00007C65 4368616E6765732074-     	db 'Changes the PC DOS command prompt.',0Dh,0Ah
 42385 00007C6E 686520504320444F53-
 42385 00007C77 20636F6D6D616E6420-
 42385 00007C80 70726F6D70742E0D0A 
 42386 00007C89 0D0A                    	db 0Dh,0Ah
 42387 00007C8B 50524F4D5054205B74-     	db 'PROMPT [text]',0Dh,0Ah
 42387 00007C94 6578745D0D0A       
 42388 00007C9A 0D0A                    	db 0Dh,0Ah
 42389                                  MSG_1561:
 42390 00007C9C 7C                      	db 124
 42391 00007C9D 202074657874202020-     	db '  text    Specifies a new command prompt.',0Dh,0Ah
 42391 00007CA6 205370656369666965-
 42391 00007CAF 732061206E65772063-
 42391 00007CB8 6F6D6D616E64207072-
 42391 00007CC1 6F6D70742E0D0A     
 42392 00007CC8 0D0A                    	db 0Dh,0Ah
 42393 00007CCA 50726F6D7074206361-     	db 'Prompt can be made up of normal characters and the following special codes:',0Dh,0Ah
 42393 00007CD3 6E206265206D616465-
 42393 00007CDC 207570206F66206E6F-
 42393 00007CE5 726D616C2063686172-
 42393 00007CEE 61637465727320616E-
 42393 00007CF7 642074686520666F6C-
 42393 00007D00 6C6F77696E67207370-
 42393 00007D09 656369616C20636F64-
 42393 00007D12 65733A0D0A         
 42394 00007D17 0D0A                    	db 0Dh,0Ah
 42395                                  MSG_1562:
 42396 00007D19 2F                      	db 47
 42397 00007D1A 202024512020203D20-     	db '  $Q   = (equal sign)',0Dh,0Ah
 42397 00007D23 28657175616C207369-
 42397 00007D2C 676E290D0A         
 42398 00007D31 202024242020202420-     	db '  $$   $ (dollar sign)',0Dh,0Ah
 42398 00007D3A 28646F6C6C61722073-
 42398 00007D43 69676E290D0A       
 42399                                  MSG_1563:
 42400 00007D49 2A                      	db 42
 42401 00007D4A 202024542020204375-     	db '  $T   Current time',0Dh,0Ah
 42401 00007D53 7272656E742074696D-
 42401 00007D5C 650D0A             
 42402 00007D5F 202024442020204375-     	db '  $D   Current date',0Dh,0Ah
 42402 00007D68 7272656E7420646174-
 42402 00007D71 650D0A             
 42403                                  MSG_1564:
 42404 00007D74 3D                      	db 61
 42405 00007D75 202024502020204375-     	db '  $P   Current drive and path',0Dh,0Ah
 42405 00007D7E 7272656E7420647269-
 42405 00007D87 766520616E64207061-
 42405 00007D90 74680D0A           
 42406 00007D94 202024562020204D53-     	db '  $V   MS-DOS version number',0Dh,0Ah
 42406 00007D9D 2D444F532076657273-
 42406 00007DA6 696F6E206E756D6265-
 42406 00007DAF 720D0A             
 42407                                  MSG_1565:
 42408 00007DB2 34                      	db 52
 42409 00007DB3 2020244E2020204375-     	db '  $N   Current drive',0Dh,0Ah
 42409 00007DBC 7272656E7420647269-
 42409 00007DC5 76650D0A           
 42410 00007DC9 202024472020203E20-     	db '  $G   > (greater-than sign)',0Dh,0Ah
 42410 00007DD2 28677265617465722D-
 42410 00007DDB 7468616E207369676E-
 42410 00007DE4 290D0A             
 42411                                  MSG_1566:
 42412 00007DE7 2C                      	db 44
 42413 00007DE8 2020244C2020203C20-     	db '  $L   < (less-than sign)',0Dh,0Ah
 42413 00007DF1 286C6573732D746861-
 42413 00007DFA 6E207369676E290D0A 
 42414 00007E03 202024422020207C20-     	db '  $B   | (pipe)',0Dh,0Ah
 42414 00007E0C 2870697065290D0A   
 42415                                  MSG_1567:
 42416 00007E14 79                      	db 121
 42417 00007E15 202024482020204261-     	db '  $H   Backspace (erases previous character)',0Dh,0Ah
 42417 00007E1E 636B73706163652028-
 42417 00007E27 657261736573207072-
 42417 00007E30 6576696F7573206368-
 42417 00007E39 61726163746572290D-
 42417 00007E42 0A                 
 42418 00007E43 202024452020204573-     	db '  $E   Escape code (ASCII code 27)',0Dh,0Ah
 42418 00007E4C 6361706520636F6465-
 42418 00007E55 202841534349492063-
 42418 00007E5E 6F6465203237290D0A 
 42419 00007E67 2020245F2020204361-     	db '  $_   Carriage return and linefeed',0Dh,0Ah
 42419 00007E70 727269616765207265-
 42419 00007E79 7475726E20616E6420-
 42419 00007E82 6C696E65666565640D-
 42419 00007E8B 0A                 
 42420 00007E8C 0D0A                    	db 0Dh,0Ah
 42421                                  MSG_1568:
 42422 00007E8E 4C                      	db 76
 42423 00007E8F 547970652050524F4D-     	db 'Type PROMPT without parameters to reset the prompt to the default setting.',0Dh,0Ah
 42423 00007E98 505420776974686F75-
 42423 00007EA1 7420706172616D6574-
 42423 00007EAA 65727320746F207265-
 42423 00007EB3 736574207468652070-
 42423 00007EBC 726F6D707420746F20-
 42423 00007EC5 746865206465666175-
 42423 00007ECE 6C742073657474696E-
 42423 00007ED7 672E0D0A           
 42424                                  MSG_1580:
 42425 00007EDB 47                      	db 71
 42426 00007EDC 52656D6F7665732028-     	db 'Removes (deletes) a directory.',0Dh,0Ah
 42426 00007EE5 64656C657465732920-
 42426 00007EEE 61206469726563746F-
 42426 00007EF7 72792E0D0A         
 42427 00007EFC 0D0A                    	db 0Dh,0Ah
 42428 00007EFE 524D444952205B6472-     	db 'RMDIR [drive:]path',0Dh,0Ah
 42428 00007F07 6976653A5D70617468-
 42428 00007F10 0D0A               
 42429 00007F12 5244205B6472697665-     	db 'RD [drive:]path',0Dh,0Ah
 42429 00007F1B 3A5D706174680D0A   
 42430                                  MSG_1600:
 42431 00007F23 1C                      	db 28
 42432 00007F24 52656E616D65732061-     	db 'Renames a file or files.',0Dh,0Ah
 42432 00007F2D 2066696C65206F7220-
 42432 00007F36 66696C65732E0D0A   
 42433 00007F3E 0D0A                    	db 0Dh,0Ah
 42434                                  MSG_1601:
 42435 00007F40 53                      	db 83
 42436 00007F41 52454E414D45205B64-     	db 'RENAME [drive:][path]filename1 filename2',0Dh,0Ah
 42436 00007F4A 726976653A5D5B7061-
 42436 00007F53 74685D66696C656E61-
 42436 00007F5C 6D65312066696C656E-
 42436 00007F65 616D65320D0A       
 42437 00007F6B 52454E205B64726976-     	db 'REN [drive:][path]filename1 filename2',0Dh,0Ah
 42437 00007F74 653A5D5B706174685D-
 42437 00007F7D 66696C656E616D6531-
 42437 00007F86 2066696C656E616D65-
 42437 00007F8F 320D0A             
 42438 00007F92 0D0A                    	db 0Dh,0Ah
 42439                                  MSG_1602:
 42440                                  	;db 77
 42441                                  	;db 'Note that you cannot specify a new drive or path for your destination file.',0Dh,0Ah
 42442                                  
 42443                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42444                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:8697h
 42445                                  
 42446                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42447                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:8447h
 42448                                  MSG_1602:
 42449 00007F94 A0                      	db 160
 42450 00007F95 4E6F74652074686174-     	db 'Note that you cannot specify a new drive or path for your destination file.',0Dh,0Ah
 42450 00007F9E 20796F752063616E6E-
 42450 00007FA7 6F7420737065636966-
 42450 00007FB0 792061206E65772064-
 42450 00007FB9 72697665206F722070-
 42450 00007FC2 61746820666F722079-
 42450 00007FCB 6F7572206465737469-
 42450 00007FD4 6E6174696F6E206669-
 42450 00007FDD 6C652E0D0A         
 42451 00007FE2 0D0A                    	db 0Dh,0Ah
 42452 00007FE4 557365204D4F564520-     	db 'Use MOVE to rename a directory, or to move files from one directory to another.',0Dh,0Ah
 42452 00007FED 746F2072656E616D65-
 42452 00007FF6 206120646972656374-
 42452 00007FFF 6F72792C206F722074-
 42452 00008008 6F206D6F7665206669-
 42452 00008011 6C65732066726F6D20-
 42452 0000801A 6F6E65206469726563-
 42452 00008023 746F727920746F2061-
 42452 0000802C 6E6F746865722E0D0A 
 42453                                  MSG_1620:
 42454 00008035 57                      	db 87
 42455                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42456                                  %if 0
 42457                                  	db 'Displays, sets, or removes MS-DOS environment variables.',0Dh,0Ah
 42458                                  %else
 42459 00008036 446973706C6179732C-     	db 'Displays, sets, or removes PC DOS environment variables.',0Dh,0Ah
 42459 0000803F 20736574732C206F72-
 42459 00008048 2072656D6F76657320-
 42459 00008051 504320444F5320656E-
 42459 0000805A 7669726F6E6D656E74-
 42459 00008063 207661726961626C65-
 42459 0000806C 732E0D0A           
 42460                                  %endif
 42461 00008070 0D0A                    	db 0Dh,0Ah
 42462 00008072 534554205B76617269-     	db 'SET [variable=[string]]',0Dh,0Ah
 42462 0000807B 61626C653D5B737472-
 42462 00008084 696E675D5D0D0A     
 42463 0000808B 0D0A                    	db 0Dh,0Ah
 42464                                  MSG_1621:
 42465 0000808D 81                      	db 129
 42466 0000808E 20207661726961626C-     	db '  variable  Specifies the environment-variable name.',0Dh,0Ah
 42466 00008097 652020537065636966-
 42466 000080A0 696573207468652065-
 42466 000080A9 6E7669726F6E6D656E-
 42466 000080B2 742D7661726961626C-
 42466 000080BB 65206E616D652E0D0A 
 42467 000080C4 2020737472696E6720-     	db '  string    Specifies a series of characters to assign to the variable.',0Dh,0Ah
 42467 000080CD 202020537065636966-
 42467 000080D6 696573206120736572-
 42467 000080DF 696573206F66206368-
 42467 000080E8 617261637465727320-
 42467 000080F1 746F2061737369676E-
 42467 000080FA 20746F207468652076-
 42467 00008103 61726961626C652E0D-
 42467 0000810C 0A                 
 42468 0000810D 0D0A                    	db 0Dh,0Ah
 42469                                  MSG_1622:
 42470 0000810F 4B                      	db 75
 42471 00008110 547970652053455420-     	db 'Type SET without parameters to display the current environment variables.',0Dh,0Ah
 42471 00008119 776974686F75742070-
 42471 00008122 6172616D6574657273-
 42471 0000812B 20746F20646973706C-
 42471 00008134 617920746865206375-
 42471 0000813D 7272656E7420656E76-
 42471 00008146 69726F6E6D656E7420-
 42471 0000814F 7661726961626C6573-
 42471 00008158 2E0D0A             
 42472                                  MSG_1640:
 42473                                  	;db 52
 42474                                  	;db 'Displays or sets the system time.',0Dh,0Ah
 42475                                  	;db 0Dh,0Ah
 42476                                  	;db 'TIME [time]',0Dh,0Ah
 42477                                  	;db 0Dh,0Ah
 42478                                  
 42479                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42480                                  %if 0
 42481                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42482                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:885Eh)
 42483                                  	db 45
 42484                                  	db 'Displays or sets the time.',0Dh,0Ah
 42485                                  	db 0Dh,0Ah
 42486                                  	db 'TIME [time]',0Dh,0Ah
 42487                                  	db 0Dh,0Ah
 42488                                  %else
 42489                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42490                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:860Eh
 42491 0000815B 34                      	db 52
 42492 0000815C 446973706C61797320-     	db 'Displays or sets the system time.',0Dh,0Ah
 42492 00008165 6F7220736574732074-
 42492 0000816E 68652073797374656D-
 42492 00008177 2074696D652E0D0A   
 42493 0000817F 0D0A                    	db 0Dh,0Ah
 42494 00008181 54494D45205B74696D-     	db 'TIME [time]',0Dh,0Ah
 42494 0000818A 655D0D0A           
 42495 0000818E 0D0A                    	db 0Dh,0Ah
 42496                                  %endif
 42497                                  
 42498                                  MSG_1641:
 42499 00008190 83                      	db 131
 42500 00008191 547970652054494D45-     	db 'Type TIME with no parameters to display the current time setting and a prompt',0Dh,0Ah
 42500 0000819A 2077697468206E6F20-
 42500 000081A3 706172616D65746572-
 42500 000081AC 7320746F2064697370-
 42500 000081B5 6C6179207468652063-
 42500 000081BE 757272656E74207469-
 42500 000081C7 6D652073657474696E-
 42500 000081D0 6720616E6420612070-
 42500 000081D9 726F6D70740D0A     
 42501 000081E0 666F722061206E6577-     	db 'for a new one.  Press ENTER to keep the same time.',0Dh,0Ah
 42501 000081E9 206F6E652E20205072-
 42501 000081F2 65737320454E544552-
 42501 000081FB 20746F206B65657020-
 42501 00008204 7468652073616D6520-
 42501 0000820D 74696D652E0D0A     
 42502                                  MSG_1660:
 42503 00008214 46                      	db 70
 42504 00008215 446973706C61797320-     	db 'Displays the contents of a text file.',0Dh,0Ah
 42504 0000821E 74686520636F6E7465-
 42504 00008227 6E7473206F66206120-
 42504 00008230 746578742066696C65-
 42504 00008239 2E0D0A             
 42505 0000823C 0D0A                    	db 0Dh,0Ah
 42506 0000823E 54595045205B647269-     	db 'TYPE [drive:][path]filename',0Dh,0Ah
 42506 00008247 76653A5D5B70617468-
 42506 00008250 5D66696C656E616D65-
 42506 00008259 0D0A               
 42507                                  MSG_1680:
 42508 0000825B 25                      	db 37
 42509                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42510                                  %if 0
 42511                                  	db 'Displays the MS-DOS version.',0Dh,0Ah
 42512                                  %else
 42513 0000825C 446973706C61797320-     	db 'Displays the PC DOS version.',0Dh,0Ah
 42513 00008265 74686520504320444F-
 42513 0000826E 532076657273696F6E-
 42513 00008277 2E0D0A             
 42514                                  %endif
 42515 0000827A 0D0A                    	db 0Dh,0Ah
 42516 0000827C 5645520D0A              	db 'VER',0Dh,0Ah
 42517                                  MSG_1700:
 42518 00008281 B1                      	db 177
 42519                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42520                                  %if 0
 42521                                  	db 'Tells MS-DOS whether to verify that your files are written correctly to a',0Dh,0Ah
 42522                                  	db 'disk.',0Dh,0Ah
 42523                                  %else
 42524 00008282 54656C6C7320504320-     	db 'Tells PC DOS whether to verify that your files are written correctly to a',0Dh,0Ah
 42524 0000828B 444F53207768657468-
 42524 00008294 657220746F20766572-
 42524 0000829D 696679207468617420-
 42524 000082A6 796F75722066696C65-
 42524 000082AF 732061726520777269-
 42524 000082B8 7474656E20636F7272-
 42524 000082C1 6563746C7920746F20-
 42524 000082CA 610D0A             
 42525 000082CD 6469736B2E0D0A          	db 'disk.',0Dh,0Ah
 42526                                  %endif
 42527 000082D4 0D0A                    	db 0Dh,0Ah
 42528 000082D6 564552494659205B4F-     	db 'VERIFY [ON | OFF]',0Dh,0Ah
 42528 000082DF 4E207C204F46465D0D-
 42528 000082E8 0A                 
 42529 000082E9 0D0A                    	db 0Dh,0Ah
 42530 000082EB 547970652056455249-     	db 'Type VERIFY without a parameter to display the current VERIFY setting.',0Dh,0Ah
 42530 000082F4 465920776974686F75-
 42530 000082FD 74206120706172616D-
 42530 00008306 6574657220746F2064-
 42530 0000830F 6973706C6179207468-
 42530 00008318 652063757272656E74-
 42530 00008321 205645524946592073-
 42530 0000832A 657474696E672E0D0A 
 42531                                  MSG_1720:
 42532 00008333 52                      	db 82
 42533 00008334 446973706C61797320-     	db 'Displays the disk volume label and serial number, if they exist.',0Dh,0Ah
 42533 0000833D 746865206469736B20-
 42533 00008346 766F6C756D65206C61-
 42533 0000834F 62656C20616E642073-
 42533 00008358 657269616C206E756D-
 42533 00008361 6265722C2069662074-
 42533 0000836A 686579206578697374-
 42533 00008373 2E0D0A             
 42534 00008376 0D0A                    	db 0Dh,0Ah
 42535 00008378 564F4C205B64726976-     	db 'VOL [drive:]',0Dh,0Ah
 42535 00008381 653A5D0D0A         
 42536                                  MSG_1740:
 42537 00008386 5B                      	db 91
 42538 00008387 43616C6C73206F6E65-     	db 'Calls one batch program from another.',0Dh,0Ah
 42538 00008390 206261746368207072-
 42538 00008399 6F6772616D2066726F-
 42538 000083A2 6D20616E6F74686572-
 42538 000083AB 2E0D0A             
 42539 000083AE 0D0A                    	db 0Dh,0Ah
 42540 000083B0 43414C4C205B647269-     	db 'CALL [drive:][path]filename [batch-parameters]',0Dh,0Ah
 42540 000083B9 76653A5D5B70617468-
 42540 000083C2 5D66696C656E616D65-
 42540 000083CB 205B62617463682D70-
 42540 000083D4 6172616D6574657273-
 42540 000083DD 5D0D0A             
 42541 000083E0 0D0A                    	db 0Dh,0Ah
 42542                                  MSG_1741:
 42543 000083E2 72                      	db 114
 42544 000083E3 202062617463682D70-     	db '  batch-parameters   Specifies any command-line information required by the',0Dh,0Ah
 42544 000083EC 6172616D6574657273-
 42544 000083F5 202020537065636966-
 42544 000083FE 69657320616E792063-
 42544 00008407 6F6D6D616E642D6C69-
 42544 00008410 6E6520696E666F726D-
 42544 00008419 6174696F6E20726571-
 42544 00008422 756972656420627920-
 42544 0000842B 7468650D0A         
 42545 00008430 202020202020202020-     	db '                     batch program.',0Dh,0Ah
 42545 00008439 202020202020202020-
 42545 00008442 202020626174636820-
 42545 0000844B 70726F6772616D2E0D-
 42545 00008454 0A                 
 42546                                  MSG_1760:
 42547 00008455 4C                      	db 76
 42548 00008456 5265636F7264732063-     	db 'Records comments (remarks) in a batch file or CONFIG.SYS.',0Dh,0Ah
 42548 0000845F 6F6D6D656E74732028-
 42548 00008468 72656D61726B732920-
 42548 00008471 696E20612062617463-
 42548 0000847A 682066696C65206F72-
 42548 00008483 20434F4E4649472E53-
 42548 0000848C 59532E0D0A         
 42549 00008491 0D0A                    	db 0Dh,0Ah
 42550 00008493 52454D205B636F6D6D-     	db 'REM [comment]',0Dh,0Ah
 42550 0000849C 656E745D0D0A       
 42551                                  MSG_1780:
 42552 000084A2 6B                      	db 107
 42553 000084A3 53757370656E647320-     	db 'Suspends processing of a batch program and displays the message "'
 42553 000084AC 70726F63657373696E-
 42553 000084B5 67206F662061206261-
 42553 000084BE 7463682070726F6772-
 42553 000084C7 616D20616E64206469-
 42553 000084D0 73706C617973207468-
 42553 000084D9 65206D657373616765-
 42553 000084E2 2022               
 42554 000084E4 507265737320616E79-     	db 'Press any',0Dh,0Ah
 42554 000084ED 0D0A               
 42555 000084EF 6B657920746F20636F-     	db 'key to continue...."',0Dh,0Ah
 42555 000084F8 6E74696E75652E2E2E-
 42555 00008501 2E220D0A           
 42556 00008505 0D0A                    	db 0Dh,0Ah
 42557 00008507 50415553450D0A          	db 'PAUSE',0Dh,0Ah
 42558                                  MSG_1800:
 42559 0000850E 4D                      	db 77
 42560 0000850F 446973706C61797320-     	db 'Displays messages, or turns command-echoing on or off.',0Dh,0Ah
 42560 00008518 6D657373616765732C-
 42560 00008521 206F72207475726E73-
 42560 0000852A 20636F6D6D616E642D-
 42560 00008533 6563686F696E67206F-
 42560 0000853C 6E206F72206F66662E-
 42560 00008545 0D0A               
 42561 00008547 0D0A                    	db 0Dh,0Ah
 42562 00008549 20204543484F205B4F-     	db '  ECHO [ON | OFF]',0Dh,0Ah
 42562 00008552 4E207C204F46465D0D-
 42562 0000855B 0A                 
 42563                                  MSG_1801:
 42564 0000855C 57                      	db 87
 42565 0000855D 20204543484F205B6D-     	db '  ECHO [message]',0Dh,0Ah
 42565 00008566 6573736167655D0D0A 
 42566 0000856F 0D0A                    	db 0Dh,0Ah
 42567 00008571 54797065204543484F-     	db 'Type ECHO without parameters to display the current echo setting.'
 42567 0000857A 20776974686F757420-
 42567 00008583 706172616D65746572-
 42567 0000858C 7320746F2064697370-
 42567 00008595 6C6179207468652063-
 42567 0000859E 757272656E74206563-
 42567 000085A7 686F2073657474696E-
 42567 000085B0 672E               
 42568 000085B2 0D0A                    	db 0Dh,0Ah
 42569                                  MSG_1820:
 42570 000085B4 47                      	db 71
 42571                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42572                                  %if 0
 42573                                  	db 'Directs MS-DOS to a labelled line in a batch program.',0Dh,0Ah
 42574                                  %else
 42575 000085B5 446972656374732050-     	db 'Directs PC DOS to a labelled line in a batch program.',0Dh,0Ah
 42575 000085BE 4320444F5320746F20-
 42575 000085C7 61206C6162656C6C65-
 42575 000085D0 64206C696E6520696E-
 42575 000085D9 206120626174636820-
 42575 000085E2 70726F6772616D2E0D-
 42575 000085EB 0A                 
 42576                                  %endif
 42577 000085EC 0D0A                    	db 0Dh,0Ah
 42578 000085EE 474F544F206C616265-     	db 'GOTO label',0Dh,0Ah
 42578 000085F7 6C0D0A             
 42579 000085FA 0D0A                    	db 0Dh,0Ah
 42580                                  MSG_1821:
 42581 000085FC 8A                      	db 138
 42582 000085FD 20206C6162656C2020-     	db '  label   Specifies a text string used in the batch program as a label.',0Dh,0Ah
 42582 00008606 205370656369666965-
 42582 0000860F 732061207465787420-
 42582 00008618 737472696E67207573-
 42582 00008621 656420696E20746865-
 42582 0000862A 206261746368207072-
 42582 00008633 6F6772616D20617320-
 42582 0000863C 61206C6162656C2E0D-
 42582 00008645 0A                 
 42583 00008646 0D0A                    	db 0Dh,0Ah
 42584 00008648 596F75207479706520-     	db 'You type a label on a line by itself, beginning with a colon.',0Dh,0Ah
 42584 00008651 61206C6162656C206F-
 42584 0000865A 6E2061206C696E6520-
 42584 00008663 627920697473656C66-
 42584 0000866C 2C20626567696E6E69-
 42584 00008675 6E6720776974682061-
 42584 0000867E 20636F6C6F6E2E0D0A 
 42585                                  MSG_1840:
 42586 00008687 4A                      	db 74
 42587 00008688 4368616E6765732074-     	db 'Changes the position of replaceable parameters in a batch file.',0Dh,0Ah
 42587 00008691 686520706F73697469-
 42587 0000869A 6F6E206F6620726570-
 42587 000086A3 6C61636561626C6520-
 42587 000086AC 706172616D65746572-
 42587 000086B5 7320696E2061206261-
 42587 000086BE 7463682066696C652E-
 42587 000086C7 0D0A               
 42588 000086C9 0D0A                    	db 0Dh,0Ah
 42589 000086CB 53484946540D0A          	db 'SHIFT',0Dh,0Ah
 42590                                  MSG_1860:
 42591 000086D2 5A                      	db 90
 42592 000086D3 506572666F726D7320-     	db 'Performs conditional processing in batch programs.',0Dh,0Ah
 42592 000086DC 636F6E646974696F6E-
 42592 000086E5 616C2070726F636573-
 42592 000086EE 73696E6720696E2062-
 42592 000086F7 617463682070726F67-
 42592 00008700 72616D732E0D0A     
 42593 00008707 0D0A                    	db 0Dh,0Ah
 42594 00008709 4946205B4E4F545D20-     	db 'IF [NOT] ERRORLEVEL number command',0Dh,0Ah
 42594 00008712 4552524F524C455645-
 42594 0000871B 4C206E756D62657220-
 42594 00008724 636F6D6D616E640D0A 
 42595                                  MSG_1861:
 42596 0000872D 46                      	db 70
 42597 0000872E 4946205B4E4F545D20-     	db 'IF [NOT] string1==string2 command',0Dh,0Ah
 42597 00008737 737472696E67313D3D-
 42597 00008740 737472696E67322063-
 42597 00008749 6F6D6D616E640D0A   
 42598 00008751 4946205B4E4F545D20-     	db 'IF [NOT] EXIST filename command',0Dh,0Ah
 42598 0000875A 45584953542066696C-
 42598 00008763 656E616D6520636F6D-
 42598 0000876C 6D616E640D0A       
 42599 00008772 0D0A                    	db 0Dh,0Ah
 42600                                  MSG_1862:
 42601 00008774 7D                      	db 125
 42602                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42603                                  %if 0
 42604                                  	db '  NOT               Specifies that MS-DOS should carry out the command only',0Dh,0Ah
 42605                                  %else
 42606 00008775 20204E4F5420202020-     	db '  NOT               Specifies that PC DOS should carry out the command only',0Dh,0Ah
 42606 0000877E 202020202020202020-
 42606 00008787 202053706563696669-
 42606 00008790 657320746861742050-
 42606 00008799 4320444F532073686F-
 42606 000087A2 756C64206361727279-
 42606 000087AB 206F75742074686520-
 42606 000087B4 636F6D6D616E64206F-
 42606 000087BD 6E6C790D0A         
 42607                                  %endif
 42608 000087C2 202020202020202020-     	db '                    if the condition is false.',0Dh,0Ah
 42608 000087CB 202020202020202020-
 42608 000087D4 202069662074686520-
 42608 000087DD 636F6E646974696F6E-
 42608 000087E6 2069732066616C7365-
 42608 000087EF 2E0D0A             
 42609                                  MSG_1863:
 42610 000087F2 A2                      	db 162
 42611 000087F3 20204552524F524C45-     	db '  ERRORLEVEL number Specifies a true condition if the last program run returned',0Dh,0Ah
 42611 000087FC 56454C206E756D6265-
 42611 00008805 722053706563696669-
 42611 0000880E 657320612074727565-
 42611 00008817 20636F6E646974696F-
 42611 00008820 6E2069662074686520-
 42611 00008829 6C6173742070726F67-
 42611 00008832 72616D2072756E2072-
 42611 0000883B 657475726E65640D0A 
 42612 00008844 202020202020202020-     	db '                    '
 42612 0000884D 202020202020202020-
 42612 00008856 2020               
 42613 00008858 616E20657869742063-     	db 'an exit code equal to or greater than the number specified.',0Dh,0Ah
 42613 00008861 6F646520657175616C-
 42613 0000886A 20746F206F72206772-
 42613 00008873 656174657220746861-
 42613 0000887C 6E20746865206E756D-
 42613 00008885 626572207370656369-
 42613 0000888E 666965642E0D0A     
 42614                                  MSG_1864:
 42615 00008895 66                      	db 102
 42616 00008896 2020636F6D6D616E64-     	db '  command           Specifies the command to carry out if the condition is',0Dh,0Ah
 42616 0000889F 202020202020202020-
 42616 000088A8 202053706563696669-
 42616 000088B1 65732074686520636F-
 42616 000088BA 6D6D616E6420746F20-
 42616 000088C3 6361727279206F7574-
 42616 000088CC 206966207468652063-
 42616 000088D5 6F6E646974696F6E20-
 42616 000088DE 69730D0A           
 42617 000088E2 202020202020202020-     	db '                    met.',0Dh,0Ah
 42617 000088EB 202020202020202020-
 42617 000088F4 20206D65742E0D0A   
 42618                                  MSG_1865:
 42619 000088FC 6A                      	db 106
 42620 000088FD 2020737472696E6731-     	db '  string1==string2  Specifies a true condition if the specified text strings',0Dh,0Ah
 42620 00008906 3D3D737472696E6732-
 42620 0000890F 202053706563696669-
 42620 00008918 657320612074727565-
 42620 00008921 20636F6E646974696F-
 42620 0000892A 6E2069662074686520-
 42620 00008933 737065636966696564-
 42620 0000893C 207465787420737472-
 42620 00008945 696E67730D0A       
 42621 0000894B 202020202020202020-     	db '                    match.',0Dh,0Ah
 42621 00008954 202020202020202020-
 42621 0000895D 20206D617463682E0D-
 42621 00008966 0A                 
 42622                                  MSG_1866:
 42623 00008967 67                      	db 103
 42624 00008968 202045584953542066-     	db '  EXIST filename    Specifies a true condition if the specified filename',0Dh,0Ah
 42624 00008971 696C656E616D652020-
 42624 0000897A 202053706563696669-
 42624 00008983 657320612074727565-
 42624 0000898C 20636F6E646974696F-
 42624 00008995 6E2069662074686520-
 42624 0000899E 737065636966696564-
 42624 000089A7 2066696C656E616D65-
 42624 000089B0 0D0A               
 42625 000089B2 202020202020202020-     	db '                    exists.',0Dh,0Ah
 42625 000089BB 202020202020202020-
 42625 000089C4 20206578697374732E-
 42625 000089CD 0D0A               
 42626                                  MSG_1880:
 42627 000089CF 77                      	db 119
 42628 000089D0 52756E732061207370-     	db 'Runs a specified command for each file in a set of files.',0Dh,0Ah
 42628 000089D9 656369666965642063-
 42628 000089E2 6F6D6D616E6420666F-
 42628 000089EB 722065616368206669-
 42628 000089F4 6C6520696E20612073-
 42628 000089FD 6574206F662066696C-
 42628 00008A06 65732E0D0A         
 42629 00008A0B 0D0A                    	db 0Dh,0Ah
 42630 00008A0D 464F52202576617269-     	db 'FOR %variable IN (set) DO command [command-parameters]',0Dh,0Ah
 42630 00008A16 61626C6520494E2028-
 42630 00008A1F 7365742920444F2063-
 42630 00008A28 6F6D6D616E64205B63-
 42630 00008A31 6F6D6D616E642D7061-
 42630 00008A3A 72616D65746572735D-
 42630 00008A43 0D0A               
 42631 00008A45 0D0A                    	db 0Dh,0Ah
 42632                                  MSG_1881:
 42633 00008A47 7D                      	db 125
 42634 00008A48 202025766172696162-     	db '  %variable  Specifies a replaceable parameter.',0Dh,0Ah
 42634 00008A51 6C6520205370656369-
 42634 00008A5A 666965732061207265-
 42634 00008A63 706C61636561626C65-
 42634 00008A6C 20706172616D657465-
 42634 00008A75 722E0D0A           
 42635 00008A79 202028736574292020-     	db '  (set)      Specifies a set of one or more files.  Wildcards may be used.',0Dh,0Ah
 42635 00008A82 202020205370656369-
 42635 00008A8B 666965732061207365-
 42635 00008A94 74206F66206F6E6520-
 42635 00008A9D 6F72206D6F72652066-
 42635 00008AA6 696C65732E20205769-
 42635 00008AAF 6C646361726473206D-
 42635 00008AB8 617920626520757365-
 42635 00008AC1 642E0D0A           
 42636                                  MSG_1882:
 42637 00008AC5 56                      	db 86
 42638 00008AC6 2020636F6D6D616E64-     	db '  command    Specifies the command to carry out for each file.',0Dh,0Ah
 42638 00008ACF 202020205370656369-
 42638 00008AD8 666965732074686520-
 42638 00008AE1 636F6D6D616E642074-
 42638 00008AEA 6F206361727279206F-
 42638 00008AF3 757420666F72206561-
 42638 00008AFC 63682066696C652E0D-
 42638 00008B05 0A                 
 42639 00008B06 2020636F6D6D616E64-     	db '  command-parameters',0Dh,0Ah
 42639 00008B0F 2D706172616D657465-
 42639 00008B18 72730D0A           
 42640                                  MSG_1883:
 42641 00008B1C A2                      	db 162
 42642 00008B1D 202020202020202020-     	db '             Specifies parameters or switches for the specified command.',0Dh,0Ah
 42642 00008B26 202020205370656369-
 42642 00008B2F 666965732070617261-
 42642 00008B38 6D6574657273206F72-
 42642 00008B41 207377697463686573-
 42642 00008B4A 20666F722074686520-
 42642 00008B53 737065636966696564-
 42642 00008B5C 20636F6D6D616E642E-
 42642 00008B65 0D0A               
 42643 00008B67 0D0A                    	db 0Dh,0Ah
 42644 00008B69 546F20757365207468-     	db 'To use the FOR command in a batch program, specify %%variable instead of',0Dh,0Ah
 42644 00008B72 6520464F5220636F6D-
 42644 00008B7B 6D616E6420696E2061-
 42644 00008B84 206261746368207072-
 42644 00008B8D 6F6772616D2C207370-
 42644 00008B96 656369667920252576-
 42644 00008B9F 61726961626C652069-
 42644 00008BA8 6E7374656164206F66-
 42644 00008BB1 0D0A               
 42645 00008BB3 257661726961626C65-     	db '%variable.',0Dh,0Ah
 42645 00008BBC 2E0D0A             
 42646                                  MSG_1900:
 42647                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42648                                  %if 0
 42649                                  	; MSDOS 6.22 COMMAND.COM
 42650                                  	db 23
 42651                                  	db 'Reserved command name',0Dh,0Ah
 42652                                  %else
 42653                                  	; PCDOS 7.1 COMMAND.COM
 42654 00008BBF 48                      	db 72
 42655 00008BC0 52657475726E732061-     	db 'Returns a fully qualified filename.',0Dh,0Ah
 42655 00008BC9 2066756C6C79207175-
 42655 00008BD2 616C69666965642066-
 42655 00008BDB 696C656E616D652E0D-
 42655 00008BE4 0A                 
 42656 00008BE5 0D0A                    	db 0Dh,0Ah
 42657 00008BE7 545255454E414D4520-     	db 'TRUENAME [drive:][path]filename',0Dh,0Ah
 42657 00008BF0 5B64726976653A5D5B-
 42657 00008BF9 706174685D66696C65-
 42657 00008C02 6E616D650D0A       
 42658                                  %endif
 42659                                  MSG_1920:
 42660 00008C08 2F                      	db 47
 42661 00008C09 4C6F61647320612070-     	db 'Loads a program into the upper memory area.',0Dh,0Ah
 42661 00008C12 726F6772616D20696E-
 42661 00008C1B 746F20746865207570-
 42661 00008C24 706572206D656D6F72-
 42661 00008C2D 7920617265612E0D0A 
 42662 00008C36 0D0A                    	db 0Dh,0Ah
 42663                                  MSG_1921:
 42664                                  	;db 88
 42665                                  	;db 'LOADHIGH [drive:][path]filename [parameters]',0Dh,0Ah
 42666                                  	;db 'LH [drive:][path]filename [parameters]',0Dh,0Ah
 42667                                  	;db 0Dh,0Ah
 42668                                  
 42669                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42670                                  %if 0
 42671                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42672                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9303h
 42673                                  	db 157
 42674                                  	db 'LOADHIGH [drive:][path]filename [parameters]',0Dh,0Ah
 42675                                  	db 'LOADHIGH [/L:region1[,minsize1][;region2[,minsize2]...] [/S]]',0Dh,0Ah
 42676                                  	db '         [drive:][path]filename [parameters]',0Dh,0Ah
 42677                                  	db 0Dh,0Ah
 42678                                  %else
 42679                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42680                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:90EBh
 42681 00008C38 98                      	db 152
 42682 00008C39 4C4F41444849474820-     	db 'LOADHIGH [drive:][path]filename [parameters]',0Dh,0Ah
 42682 00008C42 5B64726976653A5D5B-
 42682 00008C4B 706174685D66696C65-
 42682 00008C54 6E616D65205B706172-
 42682 00008C5D 616D65746572735D0D-
 42682 00008C66 0A                 
 42683 00008C67 4C4F41444849474820-     	db 'LOADHIGH [/L:region1[,minsize1][;region2[,minsize2]...]]',0Dh,0Ah
 42683 00008C70 5B2F4C3A726567696F-
 42683 00008C79 6E315B2C6D696E7369-
 42683 00008C82 7A65315D5B3B726567-
 42683 00008C8B 696F6E325B2C6D696E-
 42683 00008C94 73697A65325D2E2E2E-
 42683 00008C9D 5D5D0D0A           
 42684 00008CA1 202020202020202020-     	db '         [drive:][path]filename [parameters]',0Dh,0Ah
 42684 00008CAA 5B64726976653A5D5B-
 42684 00008CB3 706174685D66696C65-
 42684 00008CBC 6E616D65205B706172-
 42684 00008CC5 616D65746572735D0D-
 42684 00008CCE 0A                 
 42685 00008CCF 0D0A                    	db 0Dh,0Ah	
 42686                                  %endif
 42687                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:8111h)
 42688                                  ;MSG_1922: 	; MSDOS 5.0 COMMAND.COM
 42689                                  	;db 113
 42690                                  	;db '  parameters   Specifies any command-line information required by the',0Dh,0Ah
 42691                                  	;db '               program you want to load.',0Dh,0Ah
 42692                                  
 42693                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42694                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:93A1h
 42695                                  MSG_1922:
 42696 00008CD1 B6                      	db 182
 42697 00008CD2 2F4C3A726567696F6E-     	db '/L:region1[,minsize1][;region2[,minsize2]]...',0Dh,0Ah
 42697 00008CDB 315B2C6D696E73697A-
 42697 00008CE4 65315D5B3B72656769-
 42697 00008CED 6F6E325B2C6D696E73-
 42697 00008CF6 697A65325D5D2E2E2E-
 42697 00008CFF 0D0A               
 42698 00008D01 202020202020202020-     	db '            Specifies the region(s) of memory into which to load',0Dh,0Ah
 42698 00008D0A 202020537065636966-
 42698 00008D13 696573207468652072-
 42698 00008D1C 6567696F6E28732920-
 42698 00008D25 6F66206D656D6F7279-
 42698 00008D2E 20696E746F20776869-
 42698 00008D37 636820746F206C6F61-
 42698 00008D40 640D0A             
 42699 00008D43 202020202020202020-     	db '            the program.  Region1 specifies the number of the first',0Dh,0Ah
 42699 00008D4C 202020746865207072-
 42699 00008D55 6F6772616D2E202052-
 42699 00008D5E 6567696F6E31207370-
 42699 00008D67 656369666965732074-
 42699 00008D70 6865206E756D626572-
 42699 00008D79 206F66207468652066-
 42699 00008D82 697273740D0A       
 42700                                  MSG_1923:
 42701 00008D88 85                      	db 133
 42702 00008D89 202020202020202020-     	db '            memory region; minsize1 specifies the minimum size, if',0Dh,0Ah
 42702 00008D92 2020206D656D6F7279-
 42702 00008D9B 20726567696F6E3B20-
 42702 00008DA4 6D696E73697A653120-
 42702 00008DAD 737065636966696573-
 42702 00008DB6 20746865206D696E69-
 42702 00008DBF 6D756D2073697A652C-
 42702 00008DC8 2069660D0A         
 42703 00008DCD 202020202020202020-     	db '            any, for region1.  Region2 and minsize2 specify the',0Dh
 42703 00008DD6 202020616E792C2066-
 42703 00008DDF 6F7220726567696F6E-
 42703 00008DE8 312E2020526567696F-
 42703 00008DF1 6E3220616E64206D69-
 42703 00008DFA 6E73697A6532207370-
 42703 00008E03 656369667920746865-
 42703 00008E0C 0D                 
 42704 00008E0D 0A                      	db 0Ah
 42705                                  MSG_1924:
 42706                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42707                                  %if 0
 42708                                  	db 127
 42709                                  	db '            number and minimum size of the second region, if any.',0Dh,0Ah
 42710                                  	db '            You can specify as many regions as you want.',0Dh,0Ah
 42711                                  	db 0Dh,0Ah
 42712                                  MSG_1925:
 42713                                  	db 131
 42714                                  	db '/S          Shrinks a UMB to its minimum size while the program',0Dh,0Ah
 42715                                  	db '            is loading.  /S is normally used only by MemMaker.',0Dh,0Ah
 42716                                  	db 0Dh,0Ah
 42717                                  %else
 42718 00008E0E 7B                      	db 123
 42719 00008E0F 202020202020202020-     	db '            number and minimum size of the second region, if any.',0Dh,0Ah
 42719 00008E18 2020206E756D626572-
 42719 00008E21 20616E64206D696E69-
 42719 00008E2A 6D756D2073697A6520-
 42719 00008E33 6F6620746865207365-
 42719 00008E3C 636F6E642072656769-
 42719 00008E45 6F6E2C20696620616E-
 42719 00008E4E 792E0D0A           
 42720 00008E52 202020202020202020-     	db '            You can specify as many regions as you want.'
 42720 00008E5B 202020596F75206361-
 42720 00008E64 6E2073706563696679-
 42720 00008E6D 206173206D616E7920-
 42720 00008E76 726567696F6E732061-
 42720 00008E7F 7320796F752077616E-
 42720 00008E88 742E               
 42721                                  MSG_1925:
 42722 00008E8A 02                      	db 2
 42723 00008E8B 0D0A                    	db 0Dh,0Ah
 42724                                  %endif
 42725                                  MSG_1926:
 42726 00008E8D 57                      	db 87
 42727 00008E8E 5B64726976653A5D5B-     	db '[drive:][path]filename',0Dh,0Ah
 42727 00008E97 706174685D66696C65-
 42727 00008EA0 6E616D650D0A       
 42728 00008EA6 202020202020202020-     	db '            Specifies the location and name of the program.',0Dh,0Ah
 42728 00008EAF 202020537065636966-
 42728 00008EB8 69657320746865206C-
 42728 00008EC1 6F636174696F6E2061-
 42728 00008ECA 6E64206E616D65206F-
 42728 00008ED3 66207468652070726F-
 42728 00008EDC 6772616D2E0D0A     
 42729 00008EE3 0D0A                    	db 0Dh,0Ah
 42730                                  
 42731                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42732                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:963Ah
 42733                                  
 42734                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42735                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9398h
 42736                                  MSG_1927:
 42737 00008EE5 5A                      	db 90
 42738 00008EE6 706172616D65746572-     	db 'parameters  Specifies any command-line information required by',0Dh,0Ah
 42738 00008EEF 732020537065636966-
 42738 00008EF8 69657320616E792063-
 42738 00008F01 6F6D6D616E642D6C69-
 42738 00008F0A 6E6520696E666F726D-
 42738 00008F13 6174696F6E20726571-
 42738 00008F1C 75697265642062790D-
 42738 00008F25 0A                 
 42739 00008F26 202020202020202020-     	db '            the program.',0Dh,0Ah
 42739 00008F2F 202020746865207072-
 42739 00008F38 6F6772616D2E0D0A   
 42740                                  
 42741                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 42742                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:96F3h
 42743                                  MSG_1107:
 42744 00008F40 0C                      	db 12
 42745 00008F41 2531204B2062797465-     	db '%1 K bytes',0Dh,0Ah
 42745 00008F4A 730D0A             
 42746                                  
 42747                                  ; ---------------------------------------------------------------------------
 42748                                  
 42749                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42750                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8183h
 42751                                  
 42752                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42753                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9695h
 42754                                  
 42755                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42756                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9400h
 42757                                  
 42758                                  ; --------------- S U B R O U T I N E ---------------------------------------
 42759                                  
 42760                                  $M_CLS_3:
 42761 00008F4D 0E                      	push	cs		; CLASS_F
 42762 00008F4E 07                      	pop	es
 42763 00008F4F 8D3E[FA62]              	lea	di,$M_CLASS_3_STRUC ; LEA DI,$M_CLASS_3_STRUC
 42764                                  	; 15/04/2023
 42765                                  	;add	cx,10053	; ADD CX,$-$M_CLASS_3_STRUC ; 8189h-5A44h
 42766                                  	; 17/06/2023
 42767                                  	;add	cx,11627	; ADD CX,$-$M_CLASS_3_STRUC ; 969Bh-6930h
 42768                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42769                                  	;add	cx,11353	; ADD CX,$-$M_CLASS_3_STRUC ; 9406h-67ADh
 42770 00008F53 81C1592C                	add	cx,$-$M_CLASS_3_STRUC
 42771 00008F57 C3                      	retn
 42772                                  
 42773                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42774                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:818Eh
 42775                                  
 42776                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42777                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:96A0h
 42778                                  
 42779                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42780                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:940Bh
 42781                                  
 42782                                  ; ---------------------------------------------------------------------------
 42783                                  ; Class 1 messages
 42784                                  ; ---------------------------------------------------------------------------
 42785                                  	
 42786                                  $M_CLASS_1_STRUC:
 42787 00008F58 01                      	db 1			; $M_CLASS_ID
 42788                                  	;dw 5			; EXPECTED_VERSION (COMMAND.COM version)
 42789                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42790                                  	;dw 1606h  ; MSDOS 6.22 COMMAND.COM
 42791                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
 42792 00008F59 070A                    	dw 0A07h  ; PCDOS 7.10 COMMAND.COM
 42793 00008F5B 04                      	db 4			; Class_1_MessageCount
 42794                                  $M_ID_1_1:
 42795 00008F5C 0200                    	dw 2			; Message Number = 2
 42796 00008F5E 1000                    	dw EXTEND2-$+2 ; 10h	; Message offset from message number
 42797                                  $M_ID_1_2:
 42798 00008F60 0300                    	dw 3			; Message Number = 3
 42799 00008F62 1B00                    	dw EXTEND3-$+2 ; 1Bh	; Message offset from message number
 42800                                  $M_ID_1_3:
 42801 00008F64 0800                    	dw 8			; Message Number = 8
 42802 00008F66 2600                    	dw EXTEND8-$+2 ; 26h	; Message offset from message number
 42803                                  $M_ID_1_4:
 42804 00008F68 FFFF                    	dw 0FFFFh		; Message Number = -1
 42805 00008F6A 3600                    	dw EXTEND999-$+2 ; 36h	; Message offset from message number
 42806                                  
 42807                                  ; ---------------------------------------------------------------------------
 42808                                  
 42809                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81A2h
 42810                                  EXTEND2:
 42811 00008F6C 0E                      	db 14
 42812 00008F6D 46696C65206E6F7420-     	db 'File not found'
 42812 00008F76 666F756E64         
 42813                                  EXTEND3:
 42814 00008F7B 0E                      	db 14
 42815 00008F7C 50617468206E6F7420-     	db 'Path not found'
 42815 00008F85 666F756E64         
 42816                                  EXTEND8:
 42817 00008F8A 13                      	db 19
 42818 00008F8B 496E73756666696369-     	db 'Insufficient memory'
 42818 00008F94 656E74206D656D6F72-
 42818 00008F9D 79                 
 42819                                  EXTEND999:
 42820 00008F9E 11                      	db 17
 42821 00008F9F 457874656E64656420-     	db 'Extended Error %1'
 42821 00008FA8 4572726F72202531   
 42822                                  
 42823                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42824                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81E6h
 42825                                  
 42826                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42827                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:96F8h
 42828                                  
 42829                                  ; --------------- S U B R O U T I N E ---------------------------------------
 42830                                  $M_MSGSERV_1:
 42831 00008FB0 0E                      	push	cs
 42832 00008FB1 07                      	pop	es
 42833 00008FB2 8D3E[588F]              	lea	di,$M_CLASS_1_STRUC
 42834                                  	; 15/04/2023
 42835                                  	;add	cx,94		; $-$M_CLASS_1_STRUC ; 81ECh-818Eh
 42836                                  			; 17/06/2023 MSDOS 6.22 COMMAND.COM
 42837                                  				; 96FEh-96A0h = 5Eh = 94
 42838                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42839                                  	;add	cx,94 ; Retro DOS v5.0 COMMAND.COM
 42840 00008FB6 C3                      	retn
 42841                                  
 42842                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42843                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81F0h
 42844                                  
 42845                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42846                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9702h
 42847                                  
 42848                                  ; ---------------------------------------------------------------------------
 42849                                  ; Class 2 messages
 42850                                  ; ---------------------------------------------------------------------------
 42851                                  	
 42852                                  $M_CLASS_2_STRUC:
 42853 00008FB7 02                      	db 2			; $M_CLASS_ID
 42854                                  	;dw 5			; EXPECTED_VERSION (COMMAND.COM version)
 42855                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42856                                  	;dw 1606h  ; MSDOS 6.22 COMMAND.COM
 42857                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
 42858 00008FB8 070A                    	dw 0A07h  ; PCDOS 7.10 COMMAND.COM
 42859 00008FBA 01                      	db 1			; Class_2_MessageCount
 42860                                  $M_ID_2_1:
 42861 00008FBB FFFF                    	dw 0FFFFh		; Message Number = -1
 42862 00008FBD 0400                    	dw PARSE999-$+2 ; 4	; Message offset from message number
 42863                                  ; ---------------------------------------------------------------------------
 42864                                  
 42865                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81F8h
 42866                                  PARSE999:
 42867 00008FBF 0E                      	db 14
 42868 00008FC0 506172736520457272-     	db 'Parse Error %1'
 42868 00008FC9 6F72202531         
 42869                                  
 42870                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42871                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8207h
 42872                                  
 42873                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42874                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9719h
 42875                                  
 42876                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42877                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9484h
 42878                                  
 42879                                  ; --------------- S U B R O U T I N E ---------------------------------------
 42880                                  $M_MSGSERV_2:
 42881 00008FCE 0E                      	push	cs
 42882 00008FCF 07                      	pop	es
 42883 00008FD0 8D3E[B78F]              	lea	di,$M_CLASS_2_STRUC
 42884                                  	; 15/04/2023
 42885                                  	;add	cx,29		; $-$M_CLASS_2_STRUC ; 820Dh-81F0h
 42886                                  			; 17/06/2023 MSDOS 6.22 COMMAND.COM
 42887                                  				; 971Fh-9702h = 1Dh = 29
 42888                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42889                                  	;add	cx,29 ; Retro DOS v5.0 COMMAND.COM
 42890 00008FD4 C3                      	retn
 42891                                  
 42892                                  ;============================================================================
 42893                                  ; TRANMSG.ASM, MSDOS 6.0, 1991
 42894                                  ;============================================================================
 42895                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42896                                  ; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42897                                  ; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42898                                  
 42899                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8211h
 42900                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9723h
 42901                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:948Eh
 42902                                  
 42903                                  ;****************************************************
 42904                                  ;* TRANSIENT MESSAGE POINTERS & SUBSTITUTION BLOCKS *
 42905                                  ;****************************************************
 42906                                  
 42907                                  msg_disp_class:
 42908 00008FD5 FF                      	db	util_msg_class ; 0FFh
 42909                                  msg_cont_flag:
 42910 00008FD6 00                      	db	no_cont_flag ; 0
 42911                                  
 42912                                  ;  extended error string output
 42913                                  extend_buf_ptr:
 42914 00008FD7 0000                    	dw	0			;AN000;set to no message
 42915                                  extend_buf_sub:
 42916 00008FD9 00                      	db	0			;AN000;set to no substitutions
 42917 00008FDA 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42918 00008FDB 00                      	db	0			;AN000;reserved
 42919                                  extend_buf_off:
 42920 00008FDC [A09D]                  	dw	string_ptr_2		;AN000;offset of arg
 42921                                  extend_buf_seg:
 42922 00008FDE 0000                    	dw	0			;AN000;segment of arg
 42923 00008FE0 00                      	db	0			;AN000;first subst
 42924 00008FE1 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 42925 00008FE2 80                      	db	128			;AN000;maximum width
 42926 00008FE3 00                      	db	0			;AN000;minimum width
 42927 00008FE4 20                      	db	blank ; 20h		;AN000;pad character
 42928                                  
 42929                                  ;  "Duplicate file name or file not found"
 42930                                  RENERR_PTR:
 42931 00008FE5 EA03                    	dw	1002			;AN000;message number
 42932 00008FE7 00                      	db	no_subst ; 0		;AN000;number of subst
 42933                                  
 42934                                  ;  "Invalid path or file name"
 42935                                  BADCPMES_PTR:
 42936 00008FE8 EB03                    	dw	1003			;AN000;message number
 42937 00008FEA 00                      	db	no_subst ; 0		;AN000;number of subst
 42938                                  
 42939                                  ;  "Insufficient disk space"
 42940                                  NOSPACE_PTR:
 42941 00008FEB EC03                    	dw	1004			;AN000;message number
 42942 00008FED 00                      	db	no_subst ; 0		;AN000;number of subst
 42943                                  
 42944                                  ;  "Out of environment space"
 42945                                  ENVERR_PTR:
 42946 00008FEE EF03                    	dw	1007			;AN000;message number
 42947 00008FF0 00                      	db	no_subst ; 0		;AN000;number of subst
 42948                                  
 42949                                  ;  "File creation error"
 42950                                  FULLDIR_PTR:
 42951 00008FF1 F003                    	dw	1008			;AN000;message number
 42952 00008FF3 00                      	db	no_subst ; 0		;AN000;number of subst
 42953                                  
 42954                                  ;  "Batch file missing",13,10
 42955                                  BADBAT_PTR:
 42956 00008FF4 F103                    	dw	1009			;AN000;message number
 42957 00008FF6 00                      	db	no_subst ; 0		;AN000;number of subst
 42958                                  
 42959                                  ;  "Insert disk with batch file",13,10
 42960                                  NEEDBAT_PTR:
 42961 00008FF7 F203                    	dw	1010			;AN000;message number
 42962 00008FF9 00                      	db	no_subst ; 0		;AN000;number of subst
 42963                                  
 42964                                  ;  "Bad command or file name",13,10
 42965                                  BADNAM_PTR:
 42966 00008FFA F303                    	dw	1011			;AN000;message number
 42967 00008FFC 00                      	db	no_subst ; 0		;AN000;number of subst
 42968                                  
 42969                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 42970                                  %if 1
 42971                                  ; "REXX interpreter not found",13,10
 42972                                  REXXNOTF_PTR:
 42973 00008FFD F403                    	dw	1012
 42974 00008FFF 00                      	db	no_subst ; 0
 42975                                  %endif
 42976                                  
 42977                                  ;  "Access denied",13,10
 42978                                  ACCDEN_PTR:
 42979 00009000 F603                    	dw	1014			;AN000;message number
 42980 00009002 00                      	db	no_subst ; 0		;AN000;number of subst
 42981                                  
 42982                                  ;  "File cannot be copied onto itself",13,10
 42983                                  OVERWR_PTR:
 42984 00009003 F703                    	dw	1015			;AN000;message number
 42985 00009005 00                      	db	no_subst ; 0		;AN000;number of subst
 42986                                  
 42987                                  ;  "Content of destination lost before copy",13,10
 42988                                  LOSTERR_PTR:
 42989 00009006 F803                    	dw	1016			;AN000;message number
 42990 00009008 00                      	db	no_subst ; 0		;AN000;number of subst
 42991                                  
 42992                                  ;  "Invalid filename or file not found",13,10
 42993                                  INORNOT_PTR:
 42994 00009009 F903                    	dw	1017			;AN000;message number
 42995 0000900B 00                      	db	no_subst		;AN000;number of subst
 42996                                  
 42997                                  ;  "%1 File(s) copied",13,10
 42998                                  copied_ptr:
 42999 0000900C FA03                    	dw	1018			;AN000;message number
 43000 0000900E 01                      	db	1			;AN000;number of subst
 43001 0000900F 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43002 00009010 00                      	db	0			;AN000;reserved
 43003 00009011 [A29D]                  	dw	Copy_num		;AN000;offset of arg
 43004 00009013 0000                    	dw	0			;AN000;segment of arg
 43005 00009015 01                      	db	1			;AN000;first subst
 43006 00009016 A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 43007                                  					;AN000;binary to decimal
 43008 00009017 09                      	db	9			;AN000;maximum width
 43009 00009018 09                      	db	9			;AN000;minimum width
 43010 00009019 20                      	db	blank ; 20h		;AN000;pad character
 43011                                  
 43012                                  ;  "%1 File(s) "
 43013                                  dirmes_ptr:
 43014 0000901A FB03                    	dw	1019			;AN000;message number
 43015 0000901C 01                      	db	1			;AN000;number of subst
 43016 0000901D 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43017 0000901E 00                      	db	0			;AN000;reserved
 43018 0000901F [A59D]                  	dw	Dir_Num			;AN000;offset of arg
 43019 00009021 0000                    	dw	0			;AN000;segment of arg
 43020 00009023 01                      	db	1			;AN000;first subst
 43021                                  	; MSDOS 5.0 COMMAND.COM
 43022                                  	;db	0A1h ; Right_Align+Unsgn_Bin_Word
 43023                                  	; 17/06/2023
 43024                                  ;screen_f_3:
 43025 00009024 E1                      	db	0E1h ; MSDOS 6.22 COMMAND.COM
 43026                                  					;AN000;binary to decimal
 43027 00009025 09                      	db	9			;AN000;maximum width
 43028 00009026 09                      	db	9			;AN000;minimum width
 43029 00009027 20                      	db	blank ; 20h		;AN000;pad character
 43030                                  
 43031                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 43032                                  %if 0
 43033                                  ;  "%1 bytes free",13,10
 43034                                  bytmes_ptr:
 43035                                  	dw	1020			;AN000;message number
 43036                                  	db	1			;AN000;number of subst
 43037                                  	db	parm_block_size ; 11	;AN000;size of sublist
 43038                                  	db	0			;AN000;reserved
 43039                                  	dw	Bytes_Free		;AN000;offset of arg
 43040                                  	dw	0			;AN000;segment of arg
 43041                                  	db	1			;AN000;first subst
 43042                                  	; MSDOS 5.0 COMMAND.COM
 43043                                  	;db	0B1h ; Right_Align+Unsgn_Bin_DWord
 43044                                  	; 17/06/2023
 43045                                  screen_f_6:
 43046                                  	db	0F1h			;AN000;long binary to decimal
 43047                                  	; MSDOS 5.0 COMMAND.COM
 43048                                  	;db	28			;AN000;maximum width
 43049                                  	;db	28			;AN000;minimum width
 43050                                  	; 17/06/2023
 43051                                  screen_f_7:
 43052                                  	db	32 ; MSDOS 6.22 COMMAND.COM
 43053                                  	db	32
 43054                                  
 43055                                  	db	blank ; 20h		;AN000;pad character
 43056                                  %else
 43057                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43058                                  	; PCDOS 7.1 COMMAND.COM
 43059                                  dirmes_w_ptr:
 43060 00009028 FB03                    	dw	1019
 43061 0000902A 01                      	db	1
 43062 0000902B 0B                      	db	11
 43063 0000902C 00                      	db	0
 43064 0000902D [A59D]                  	dw	Dir_Num
 43065 0000902F 0000                    	dw	0
 43066 00009031 01                      	db	1
 43067 00009032 F1                      	db	0F1h			; long binary to decimal
 43068 00009033 0A                      	db	10
 43069 00009034 0A                      	db	10
 43070 00009035 20                      	db	20h
 43071                                  dirmes2_ptr:
 43072 00009036 FB03                    	dw	1019
 43073 00009038 01                      	db	1
 43074 00009039 0B                      	db	11
 43075 0000903A 00                      	db	0
 43076 0000903B [A59D]                  	dw	Dir_Num
 43077 0000903D 0000                    	dw	0
 43078 0000903F 01                      	db	1
 43079 00009040 B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 43080 00009041 09                      	db	9
 43081 00009042 09                      	db	9
 43082 00009043 20                      	db	20h
 43083                                  bytmes1_ptr:
 43084 00009044 FC03                    	dw	1020
 43085 00009046 01                      	db	1
 43086 00009047 0B                      	db	11
 43087 00009048 00                      	db	0
 43088 00009049 [A99D]                  	dw	Bytes_Free
 43089 0000904B 0000                    	dw	0
 43090 0000904D 01                      	db	1
 43091 0000904E F1                      	db	0F1h			; long binary to decimal
 43092 0000904F 1E                      	db	30			; maximum width
 43093 00009050 1E                      	db	30			; minimum width
 43094 00009051 20                      	db	20h			; blank
 43095                                  bytmes2_ptr:
 43096 00009052 FC03                    	dw	1020
 43097 00009054 01                      	db	1
 43098 00009055 0B                      	db	11
 43099 00009056 00                      	db	0
 43100 00009057 [A99D]                  	dw 	Bytes_Free
 43101 00009059 0000                    	dw	0
 43102 0000905B 01                      	db	1
 43103 0000905C F1                      	db	0F1h			; long binary to decimal
 43104 0000905D 21                      	db	33			; maximum width
 43105 0000905E 21                      	db	33			; minimum width
 43106 0000905F 20                      	db	20h			; pad
 43107                                  bytmes_n_ptr:
 43108 00009060 FC03                    	dw	1020
 43109 00009062 01                      	db	1
 43110 00009063 0B                      	db	11			; parm_block_size
 43111 00009064 00                      	db	0
 43112 00009065 [A99D]                  	dw	Bytes_Free
 43113 00009067 0000                    	dw	0
 43114 00009069 01                      	db	1
 43115 0000906A B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 43116 0000906B 1C                      	db	28
 43117 0000906C 1C                      	db	28
 43118 0000906D 20                      	db	20h
 43119                                  %endif
 43120                                  
 43121                                  ;  "Invalid drive specification",13,10
 43122                                  baddrv_ptr:
 43123 0000906E FD03                    	dw	1021			;AN000;message number
 43124 00009070 00                      	db	no_subst ; 0		;AN000;number of subst
 43125                                  
 43126                                  ;  "Code page %1 not prepared for system",13,10
 43127                                  cp_not_set_ptr:
 43128 00009071 FE03                    	dw	1022			;AN000;message number
 43129 00009073 01                      	db	1			;AN000;number of subst
 43130 00009074 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43131 00009075 00                      	db	0			;AN000;reserved
 43132 00009076 [9A9D]                  	dw	system_cpage		;AN000;offset of arg
 43133 00009078 0000                    	dw	0			;AN000;segment of arg
 43134 0000907A 01                      	db	1			;AN000;first subst
 43135 0000907B A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 43136                                  					;AN000;binary to decimal
 43137 0000907C 05                      	db	5			;AN000;maximum width
 43138 0000907D 01                      	db	1			;AN000;minimum width
 43139 0000907E 20                      	db	blank ; 20h		;AN000;pad character
 43140                                  
 43141                                  ;  "Code page %1 not prepared for all devices",13,10
 43142                                  cp_not_all_ptr:
 43143 0000907F FF03                    	dw	1023			;AN000;message number
 43144 00009081 01                      	db	1			;AN000;number of subst
 43145 00009082 0B                      	db	parm_block_size ; 11 	;AN000;size of sublist
 43146 00009083 00                      	db	0			;AN000;reserved
 43147 00009084 [9A9D]                  	dw	system_cpage		;AN000;offset of arg
 43148 00009086 0000                    	dw	0			;AN000;segment of arg
 43149 00009088 01                      	db	1			;AN000;first subst
 43150 00009089 A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 43151                                  					;AN000;binary to decimal
 43152 0000908A 05                      	db	5			;AN000;maximum width
 43153 0000908B 01                      	db	1			;AN000;minimum width
 43154 0000908C 20                      	db	blank ; 20h		;AN000;pad character
 43155                                  
 43156                                  ;  "Active code page: %1",13,10
 43157                                  cp_active_ptr:
 43158 0000908D 0004                    	dw	1024			;AN000;message number
 43159 0000908F 01                      	db	1			;AN000;number of subst
 43160 00009090 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43161 00009091 00                      	db	0			;AN000;reserved
 43162 00009092 [9A9D]                  	dw	system_cpage		;AN000;offset of arg
 43163 00009094 0000                    	dw	0			;AN000;segment of arg
 43164 00009096 01                      	db	1			;AN000;first subst
 43165 00009097 A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 43166                                  					;AN000;binary to decimal
 43167 00009098 05                      	db	5			;AN000;maximum width
 43168 00009099 01                      	db	1			;AN000;minimum width
 43169 0000909A 20                      	db	blank ; 20h		;AN000;pad character
 43170                                  
 43171                                  ;  "NLSFUNC not installed",13,10
 43172                                  NLSFUNC_PTR:
 43173 0000909B 0104                    	dw	1025			;AN000;message number
 43174 0000909D 00                      	db	no_subst ; 0		;AN000;number of subst
 43175                                  
 43176                                  ;  "Invalid code page",13,10
 43177                                  INV_CODE_PAGE:
 43178 0000909E 0204                    	dw	1026			;AN000;message number
 43179 000090A0 00                      	db	no_subst ; 0		;AN000;number of subst
 43180                                  
 43181                                  ;  "Current drive is no longer valid"
 43182                                  BADCURDRV:
 43183 000090A1 0304                    	dw	1027			;AN000;message number
 43184 000090A3 00                      	db	no_subst ; 0		;AN000;number of subst
 43185                                  
 43186                                  ;  "Press any key to continue"
 43187                                  PAUSEMES_PTR:
 43188 000090A4 0404                    	dw	1028			;AN000;message number
 43189 000090A6 00                      	db	no_subst ; 0		;AN000;number of subst
 43190                                  
 43191                                  ;  "Label not found",13,10
 43192                                  BADLAB_PTR:
 43193 000090A7 0504                    	dw	1029			;AN000;message number
 43194 000090A9 00                      	db	no_subst ; 0		;AN000;number of subst
 43195                                  
 43196                                  ;  "Syntax error",13,10
 43197                                  SYNTMES_PTR:
 43198 000090AA 0604                    	dw	1030			;AN000;message number
 43199 000090AC 00                      	db	no_subst ; 0		;AN000;number of subst
 43200                                  
 43201                                  ;  "Invalid date",13,10
 43202                                  BADDAT_PTR:
 43203 000090AD 0704                    	dw	1031			;AN000;message number
 43204 000090AF 00                      	db	no_subst ; 0		;AN000;number of subst
 43205                                  
 43206                                  ;  "Current date is %1 %2",13,10
 43207                                  CurDat_Ptr:
 43208 000090B0 0804                    	dw	1032			;AN000;message number
 43209 000090B2 02                      	db	2			;AN000;number of subst
 43210 000090B3 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43211 000090B4 00                      	db	0			;AN000;reserved
 43212 000090B5 [96A3]                  	dw	Arg_Buf			;AN000;offset of arg
 43213 000090B7 0000                    	dw	0			;AN000;segment of arg
 43214 000090B9 01                      	db	1			;AN000;first subst
 43215 000090BA 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43216 000090BB 03                      	db	3			;AN000;maximum width
 43217 000090BC 03                      	db	3			;AN000;minimum width
 43218 000090BD 20                       	db	blank ; 20h		;AN000;pad character
 43219 000090BE 0B                      	db	parm_block_size 	;AN000;size of sublist
 43220 000090BF 00                      	db	0			;AN000;reserved
 43221                                  CurDat_yr:
 43222 000090C0 0000                    	dw	0			;AN000;year
 43223                                  CurDat_mo_day:
 43224 000090C2 0000                    	dw	0			;AN000;month,day
 43225 000090C4 02                      	db	2			;AN000;second subst
 43226 000090C5 34                      	db	34h ; DATE_MDY_4	;AN000;date
 43227 000090C6 0A                      	db	10			;AN000;maximum width
 43228 000090C7 0A                      	db	10			;AN000;minimum width
 43229 000090C8 20                      	db	blank ; 20h		;AN000;pad character
 43230                                  
 43231                                  ;  "SunMonTueWedThuFriSat"
 43232                                  WeekTab:
 43233 000090C9 0904                    	dw	1033			;AN000;message number
 43234 000090CB 00                      	db	no_subst ; 0		;AN000;number of subst
 43235                                  
 43236                                  ;  "Enter new date (%1):"
 43237                                  
 43238                                  NewDat_Ptr:
 43239 000090CC 0A04                    	dw	1034			;AN000;message number
 43240 000090CE 01                      	db	1			;AN000;number of subst
 43241 000090CF 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43242 000090D0 00                      	db	0			;AN000;reserved
 43243                                  NewDat_Format:
 43244 000090D1 0000                    	dw	0			;AN000;offset of replacement
 43245 000090D3 0000                    	dw	0			;AN000;segment of arg
 43246 000090D5 01                      	db	1			;AN000;first subst
 43247 000090D6 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43248 000090D7 08                      	db	8			;AN000;maximum width
 43249 000090D8 08                      	db	8			;AN000;minimum width
 43250 000090D9 20                      	db	blank ; 20h		;AN000;pad character
 43251                                  
 43252                                  ;  "Invalid time",13,10
 43253                                  
 43254                                  BadTim_Ptr:
 43255 000090DA 0B04                    	dw	1035			;AN000;message number
 43256 000090DC 00                      	db	no_subst ; 0		;AN000;number of subst
 43257                                  
 43258                                  ;  "Current time is %1",13,10
 43259                                  CurTim_Ptr:
 43260 000090DD 0C04                    	dw	1036			;AN000;message number
 43261 000090DF 01                      	db	1			;AN000;number of subst
 43262 000090E0 0B                      	db	parm_block_size 	;AN000;size of sublist
 43263 000090E1 00                      	db	0			;AN000;reserved
 43264                                  CurTim_hr_min:
 43265 000090E2 0000                    	dw	0			;AN000;hours,minutes
 43266                                  CurTim_Sec_hn:
 43267 000090E4 0000                    	dw	0			;AN000;seconds,hundredths
 43268 000090E6 01                      	db	1			;AN000;first subst
 43269 000090E7 A5                      	db	0A5h ; Right_Align+TIME_HHMMSSHH_Cty
 43270                                  					;AC059;time
 43271 000090E8 0C                      	db	12			;AC059;maximum width
 43272 000090E9 0C                      	db	12			;AC059;minimum width
 43273 000090EA 20                      	db	blank ; 20h		;AN000;pad character
 43274                                  
 43275                                  ;  "Enter new time:"
 43276                                  NewTim_Ptr:
 43277 000090EB 0D04                    	dw	1037			;AN000;message number
 43278 000090ED 00                      	db	no_subst ; 0		;AN000;number of subst
 43279                                  
 43280                                  ;  ",    Delete (Y/N)?",13,10
 43281                                  Del_Y_N_Ptr:
 43282 000090EE 0E04                    	dw	1038			;AN000;message number
 43283 000090F0 00                      	db	no_subst ; 0		;AN000;number of subst
 43284                                  
 43285                                  ;  "All files in directory will be deleted!",13,10
 43286                                  ;  "Are you sure (Y/N)?",13,10
 43287                                  SureMes_Ptr:
 43288 000090F1 0F04                    	dw	1039			;AN000;message number
 43289 000090F3 00                      	db	no_subst ; 0		;AN000;number of subst
 43290                                  
 43291                                  ;  "Microsoft DOS Version %1.%2",13,10
 43292                                  VerMes_Ptr:
 43293 000090F4 1004                    	dw	1040			;AN000;message number
 43294                                  
 43295                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 43296                                  %if 0
 43297                                  	db	2			;AN000;number of subst
 43298                                  	db	parm_block_size ; 11 	;AN000;size of sublist
 43299                                  	db	0			;AN000;reserved
 43300                                  	dw	Major_Ver_Num		;AN000;offset of arg
 43301                                  	dw	0			;AN000;segment of arg
 43302                                  	db	1			;AN000;first subst
 43303                                  	db	0A1h ; Right_Align+Unsgn_Bin_Word
 43304                                  					;AN000;binary to decimal
 43305                                  	db	1			;AN000;maximum width
 43306                                  	db	1			;AN000;minimum width
 43307                                  	db	blank ; 20h		;AN000;pad character
 43308                                  	db	parm_block_size ; 11	;AN000;size of sublist
 43309                                  	db	0			;AN000;reserved
 43310                                  	dw	Minor_Ver_Num	;AN000;offset of arg
 43311                                  	dw	0			;AN000;segment of arg
 43312                                  	db	2			;AN000;second subst
 43313                                  	db	0A1h ; Right_Align+Unsgn_Bin_Word
 43314                                  					;AN000;binary to decimal
 43315                                  	db	2			;AN000;maximum width
 43316                                  	db	2			;AN000;minimum width
 43317                                  	db	'0' ; 30h		;AN000;pad character
 43318                                  %else
 43319 000090F6 00                      	db	0	; no_subst
 43320                                  %endif
 43321                                  
 43322                                  ;  "Volume in drive %1 has no label",13,10
 43323                                  VolMes_Ptr_2:
 43324 000090F7 1104                    	dw	1041			;AN000;message number
 43325 000090F9 01                      	db	1			;AN000;number of subst
 43326 000090FA 0B                      	db	parm_block_size ; 11  	;AN000;size of sublist
 43327 000090FB 00                      	db	0			;AN000;reserved
 43328 000090FC [B39D]                  	dw	vol_drv			;AN000;offset of drive
 43329 000090FE 0000                    	dw	0			;AN000;segment of arg
 43330 00009100 01                      	db	1			;AN000;first subst
 43331 00009101 00                      	db	0 ; Char_field_Char 	;AN000;character
 43332 00009102 80                      	db	128			;AN000;maximum width
 43333 00009103 01                      	db	1			;AN000;minimum width
 43334 00009104 20                      	db	blank ; 20h		;AN000;pad character
 43335                                  
 43336                                  ;  "Volume in drive %1 is %2",13,10
 43337                                  VolMes_Ptr:
 43338 00009105 1204                    	dw	1042			;AN000;message number
 43339 00009107 02                      	db	2			;AN000;number of subst
 43340 00009108 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43341 00009109 00                      	db	0			;AN000;reserved
 43342 0000910A [B39D]                  	dw	vol_drv			;AN000;offset of drive
 43343 0000910C 0000                    	dw	0			;AN000;segment of arg
 43344 0000910E 01                      	db	1			;AN000;first subst
 43345 0000910F 00                      	db	00000000b		;AN000;character
 43346 00009110 80                      	db	128			;AN000;maximum width
 43347 00009111 01                      	db	1			;AN000;minimum width
 43348 00009112 20                      	db	blank ; 20h		;AN000;pad character
 43349 00009113 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43350 00009114 00                      	db	0			;AN000;reserved
 43351 00009115 [6A9C]                  	dw	CHARBUF			;AN000;offset of string
 43352 00009117 0000                    	dw	0			;AN000;segment of arg
 43353 00009119 02                      	db	2			;AN000;second subst
 43354 0000911A 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43355 0000911B 80                      	db	128			;AN000;maximum width
 43356 0000911C 01                      	db	1			;AN000;minimum width
 43357 0000911D 20                      	db	blank ; 20h		;AN000;pad character
 43358                                  
 43359                                  ;  "Volume Serial Number is %1-%2",13,10
 43360                                  VolSerMes_Ptr:
 43361 0000911E 1304                    	dw	1043			;AN000;message number
 43362 00009120 02                      	db	2			;AN000;number of subst
 43363 00009121 0B                      	db	parm_block_size ; 11  	;AN000;size of sublist
 43364 00009122 00                      	db	0			;AN000;reserved
 43365 00009123 [1D9F]                  	dw	vol_serial+2		;AN000;offset of serial
 43366 00009125 0000                    	dw	0			;AN000;segment of arg
 43367 00009127 01                      	db	1			;AN000;first subst
 43368 00009128 A3                      	db	0A3h ; Right_Align+Bin_Hex_Word 
 43369                                  					;AN000;binary to hex
 43370 00009129 04                      	db	4			;AN000;maximum width
 43371 0000912A 04                      	db	4			;AN000;minimum width
 43372 0000912B 30                      	db	'0' ; 30h		;AN000;pad character
 43373 0000912C 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43374 0000912D 00                      	db	0			;AN000;reserved
 43375 0000912E [1B9F]                  	dw	vol_serial		;AN000;offset of serial
 43376 00009130 0000                    	dw	0			;AN000;segment of arg
 43377 00009132 02                      	db	2			;AN000;second subst
 43378 00009133 A3                      	db	0A3h ; Right_Align+Bin_Hex_Word
 43379                                  					;AN000;binary to hex
 43380 00009134 04                      	db	4			;AN000;maximum width
 43381 00009135 04                      	db	4			;AN000;minimum width
 43382 00009136 30                      	db	'0' ; 30h		;AN000;pad character
 43383                                  
 43384                                  ;  "Invalid directory",13,10
 43385                                  badcd_ptr:
 43386 00009137 1404                    	dw	1044			;AN000;message number
 43387 00009139 00                      	db	no_subst ; 0		;AN000;number of subst
 43388                                  
 43389                                  ;  "Unable to create directory",13,10
 43390                                  badmkd_ptr:
 43391 0000913A 1504                    	dw	1045			;AN000;message number
 43392 0000913C 00                      	db	no_subst ; 0		;AN000;number of subst
 43393                                  
 43394                                  ;  "Invalid path, not directory,",13,10
 43395                                  ;  "or directory not empty",13,10
 43396                                  badrmd_ptr:
 43397 0000913D 1604                    	dw	1046			;AN000;message number
 43398 0000913F 00                      	db	no_subst ; 0		;AN000;number of subst
 43399                                  
 43400                                  ;  "Must specify ON or OFF",13,10
 43401                                  bad_on_off_ptr:
 43402 00009140 1704                    	dw	1047			;AN000;message number
 43403 00009142 00                      	db	no_subst ; 0		;AN000;number of subst
 43404                                  
 43405                                  ;  "Directory of %1",13,10
 43406                                  dirhead_ptr:
 43407 00009143 1804                    	dw	1048			;AN000;message number
 43408 00009145 01                      	db	1			;AN000;number of subst
 43409 00009146 0B                      	db	parm_block_size ; 11 	;AN000;size of sublist
 43410 00009147 00                      	db	0			;AN000;reserved
 43411 00009148 [399D]                  	dw	BWDBUF			;AN000;offset of arg
 43412 0000914A 0000                    	dw	0			;AN000;segment of arg
 43413 0000914C 01                      	db	1			;AN000;first subst
 43414 0000914D 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43415 0000914E 80                      	db	128			;AN000;maximum width
 43416 0000914F 00                      	db	0			;AN000;minimum width
 43417 00009150 20                      	db	blank ; 20h		;AN000;pad character
 43418                                  
 43419                                  ;  "No Path",13,10
 43420                                  NULLPATH_PTR:
 43421 00009151 1904                    	dw	1049			;AN000;message number
 43422 00009153 00                      	db	no_subst ; 0		;AN000;number of subst
 43423                                  
 43424                                  ;  "Invalid drive in search path",13,10
 43425                                  BADPMES_PTR:
 43426 00009154 1A04                    	dw	1050			;AN000;message number
 43427 00009156 00                      	db	no_subst ; 0		;AN000;number of subst
 43428                                  
 43429                                  ;  "Invalid device",13,10
 43430                                  BADDEV_PTR:
 43431 00009157 1B04                    	dw	1051			;AN000;message number
 43432 00009159 00                      	db	no_subst ; 0		;AN000;number of subst
 43433                                  
 43434                                  ;  "FOR cannot be nested",13,10
 43435                                  FORNESTMES_PTR:
 43436 0000915A 1C04                    	dw	1052			;AN000;message number
 43437 0000915C 00                      	db	no_subst ; 0		;AN000;number of subst
 43438                                  
 43439                                  ;  "Intermediate file error during pipe",13,10
 43440                                  PIPEEMES_PTR:
 43441 0000915D 1D04                    	dw	1053			;AN000;message number
 43442 0000915F 00                      	db	no_subst ; 0		;AN000;number of subst
 43443                                  
 43444                                  ;  "Cannot do binary reads from a device",13,10
 43445                                  INBDEV_PTR:
 43446 00009160 1E04                    	dw	1054			;AN000;message number
 43447 00009162 00                      	db	no_subst ; 0		;AN000;number of subst
 43448                                  
 43449                                  ;  "BREAK is %1",13,10
 43450                                  CtrlcMes_Ptr:
 43451 00009163 1F04                    	dw	1055			;AN000;message number
 43452 00009165 01                      	db	1			;AN000;number of subst
 43453 00009166 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43454 00009167 00                      	db	0			;AN000;reserved
 43455 00009168 0000                    	dw	0			;AN000;offset of on/off (new)
 43456 0000916A 0000                    	dw	0			;AN000;segment of arg
 43457 0000916C 01                      	db	1			;AN000;first subst
 43458 0000916D 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43459 0000916E 80                      	db	128			;AN000;maximum width
 43460 0000916F 01                      	db	1			;AN000;minimum width
 43461 00009170 20                      	db	blank ; 20h		;AN000;pad character
 43462                                  
 43463                                  ;  "VERIFY is %1",13,10
 43464                                  VeriMes_Ptr:
 43465 00009171 2004                    	dw	1056			;AN000;message number
 43466 00009173 01                      	db	1			;AN000;number of subst
 43467 00009174 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43468 00009175 00                      	db	0			;AN000;reserved
 43469 00009176 0000                    	dw	0			;AN000;offset of on/off (new)
 43470 00009178 0000                    	dw	0			;AN000;segment of arg
 43471 0000917A 01                      	db	1			;AN000;first subst
 43472 0000917B 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43473 0000917C 80                      	db	128			;AN000;maximum width
 43474 0000917D 01                      	db	1			;AN000;minimum width
 43475 0000917E 20                      	db	blank ; 20h		;AN000;pad character
 43476                                  
 43477                                  ;  "ECHO is %1",13,10
 43478                                  EchoMes_Ptr:
 43479 0000917F 2104                    	dw	1057			;AN000;message number
 43480 00009181 01                      	db	1			;AN000;number of subst
 43481 00009182 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43482 00009183 00                      	db	0			;AN000;reserved
 43483 00009184 0000                    	dw	0			;AN000;offset of on/off (new)
 43484 00009186 0000                    	dw	0			;AN000;segment of arg
 43485 00009188 01                      	db	1			;AN000;first subst
 43486 00009189 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43487 0000918A 80                      	db	128			;AN000;maximum width
 43488 0000918B 01                      	db	1			;AN000;minimum width
 43489 0000918C 20                      	db	blank ; 20h		;AN000;pad character
 43490                                  
 43491                                  ;  "off"
 43492                                  OFFMES_PTR:
 43493 0000918D 2304                    	dw	1059			;AN000;message number
 43494 0000918F 00                      	db	no_subst		;AN000;number of subst
 43495                                  ;  "on"
 43496                                  ONMES_PTR:
 43497 00009190 2404                    	dw	1060			;AN000;message number
 43498 00009192 00                      	db	no_subst ; 0		;AN000;number of subst
 43499                                  
 43500                                  ;  "Error writing to device",13,10
 43501                                  DEVWMES_PTR:
 43502 00009193 2504                    	dw	1061			;AN000;message number
 43503 00009195 00                      	db	no_subst ; 0		;AN000;number of subst
 43504                                  
 43505                                  ;  "Invalid path",13,10
 43506                                  INVAL_PATH_PTR:
 43507 00009196 2604                    	dw	1062			;AN000;message number
 43508 00009198 00                      	db	no_subst ; 0		;AN000;number of subst
 43509                                  
 43510                                  ;  unformatted string output
 43511                                  arg_buf_ptr:
 43512 00009199 2704                    	dw	1063			;AN000;message number
 43513 0000919B 01                      	db	1			;AN000;number of subst
 43514 0000919C 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43515 0000919D 00                      	db	0			;AN000;reserved
 43516 0000919E [96A3]                  	dw	Arg_Buf 		;AN000;offset of arg
 43517 000091A0 0000                    	dw	0			;AN000;segment of arg
 43518 000091A2 01                      	db	1			;AN000;first subst
 43519 000091A3 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43520 000091A4 80                      	db	128			;AN000;maximum width
 43521 000091A5 00                      	db	0			;AN000;minimum width
 43522 000091A6 20                      	db	blank ; 20h		;AN000;pad character
 43523                                  
 43524                                  ;  file name output
 43525                                  file_name_ptr:
 43526 000091A7 2804                    	dw	1064			;AN000;message number
 43527 000091A9 01                      	db	1			;AN000;number of subst
 43528 000091AA 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43529 000091AB 00                      	db	0			;AN000;reserved
 43530 000091AC [219E]                  	dw	SrcBuf			;AN000;offset of arg
 43531 000091AE 0000                    	dw	0			;AN000;segment of arg
 43532 000091B0 01                      	db	1			;AN000;first subst
 43533 000091B1 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43534 000091B2 80                      	db	128			;AN000;maximum width
 43535 000091B3 00                      	db	0			;AN000;minimum width
 43536 000091B4 20                      	db	blank ; 20h		;AN000;pad character
 43537                                  
 43538                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 43539                                  %if 0
 43540                                  
 43541                                  ;  file size output for dir
 43542                                  disp_file_size_ptr:
 43543                                  	dw	1065			;AN000;message number
 43544                                  	db	1			;AN000;number of subst
 43545                                  	db	parm_block_size ; 11 	;AN000;size of sublist
 43546                                  	db	0			;AN000;reserved
 43547                                  	dw	File_Size_Low		;AN000;offset of arg
 43548                                  	dw	0			;AN000;segment of arg
 43549                                  	db	1			;AN000;first subst
 43550                                  	; MSDOS 5.0 COMMAND.COM
 43551                                  	;db	0B1h ; Right_Align+Unsgn_Bin_DWord
 43552                                  	; 17/06/2023
 43553                                  screen_f_1:
 43554                                  	db	0F1h ; MSDOS 6.22 COMMAND.COM
 43555                                  					;AN000;long binary to decimal
 43556                                  	; MSDOS 5.0 COMMAND.COM
 43557                                  	;db	10			;AN000;maximum width
 43558                                  	;db	10			;AN000;minimum width
 43559                                  screen_f_2:
 43560                                  	db	14 ; MSDOS 6.22 COMMAND.COM
 43561                                  	db	14
 43562                                  	
 43563                                  	db	blank ; 20h		;AN000;pad character
 43564                                  %else
 43565                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43566                                  	; PCDOS 7.1 COMMAND.COM
 43567                                  disp_file_size_ptr:
 43568 000091B5 2904                    	dw	1065
 43569 000091B7 01                      	db	1
 43570 000091B8 0B                      	db	11
 43571 000091B9 00                      	db	0
 43572 000091BA [9C9D]                  	dw	File_Size_Low
 43573 000091BC 0000                    	dw	0
 43574 000091BE 01                      	db	1
 43575 000091BF F1                      	db	0F1h
 43576 000091C0 0C                      	db	12
 43577 000091C1 0C                      	db	12
 43578 000091C2 20                      	db	20h
 43579                                  disp_file_size_w_ptr:
 43580 000091C3 2904                    	dw	1065
 43581 000091C5 01                      	db	1
 43582 000091C6 0B                      	db	11
 43583 000091C7 00                      	db	0
 43584 000091C8 [9C9D]                  	dw	File_Size_Low
 43585 000091CA 0000                    	dw	0
 43586 000091CC 01                      	db	1
 43587 000091CD F1                      	db	0F1h			; long binary to decimal
 43588 000091CE 0E                      	db	14
 43589 000091CF 0E                      	db	14
 43590 000091D0 20                      	db	20h
 43591                                  disp_file_size_n_ptr:
 43592 000091D1 2904                    	dw	1065
 43593 000091D3 01                      	db	1
 43594 000091D4 0B                      	db	11
 43595 000091D5 00                      	db	0
 43596 000091D6 [9C9D]                  	dw	File_Size_Low
 43597 000091D8 0000                    	dw	0
 43598 000091DA 01                      	db	1
 43599 000091DB B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 43600 000091DC 0A                      	db	10
 43601 000091DD 0A                      	db	10
 43602 000091DE 20                      	db	20h
 43603                                  %endif
 43604                                  
 43605                                  ;  unformatted string output
 43606                                  ; %s
 43607                                  string_buf_ptr:
 43608 000091DF 2A04                    	dw	1066			;AN000;message number
 43609 000091E1 01                      	db	1			;AN000;number of subst
 43610 000091E2 0B                      	db	parm_block_size 	;AN000;size of sublist
 43611 000091E3 00                      	db	0			;AN000;reserved
 43612 000091E4 [A09D]                  	dw	string_ptr_2		;AN000;offset of arg
 43613 000091E6 0000                    	dw	0			;AN000;segment of arg
 43614 000091E8 01                      	db	1			;AN000;first subst
 43615 000091E9 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43616 000091EA 80                      	db	128			;AN000;maximum width
 43617 000091EB 00                      	db	0			;AN000;minimum width
 43618 000091EC 20                      	db	blank ; 20h		;AN000;pad character
 43619 000091ED 00                      	db	0			;AN000;
 43620                                  
 43621                                  ;  tab character
 43622                                  tab_ptr:
 43623 000091EE 2B04                    	dw	1067			;AN000;message number
 43624 000091F0 00                      	db	no_subst ; 0		;AN000;number of subst
 43625                                  
 43626                                  ;  " <DIR>   "
 43627                                  dmes_ptr:
 43628 000091F1 2C04                    	dw	1068			;AN000;message number
 43629 000091F3 00                      	db	no_subst ; 0		;AN000;number of subst
 43630                                  
 43631                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 43632                                  space_4_ptr :
 43633 000091F4 5104                    	dw	1105
 43634 000091F6 00                      	db	no_subst ; 0
 43635                                  
 43636                                  ;  destructive back space
 43637                                  dback_ptr:
 43638 000091F7 2D04                    	dw	1069			;AN000;message number
 43639 000091F9 00                      	db	no_subst ; 0		;AN000;number of subst
 43640                                  
 43641                                  ;  carriage return / line feed
 43642                                  acrlf_ptr:
 43643 000091FA 2E04                    	dw	1070			;AN000;message number
 43644 000091FC 00                      	db	no_subst ; 0		;AN000;number of subst
 43645                                  
 43646                                  ;  "mm-dd-yy"
 43647                                  usadat_ptr:
 43648 000091FD 3004                    	dw	1072			;AN000;message number
 43649 000091FF 00                      	db	no_subst ; 0		;AN000;number of subst
 43650                                  
 43651                                  ;  "dd-mm-yy"
 43652                                  eurdat_ptr:
 43653 00009200 3104                    	dw	1073			;AN000;message number
 43654 00009202 00                      	db	no_subst ; 0		;AN000;number of subst
 43655                                  
 43656                                  ;  "yy-mm-dd"
 43657                                  japdat_ptr:
 43658 00009203 3204                    	dw	1074			;AN000;message number
 43659 00009205 00                      	db	no_subst ; 0		;AN000;number of subst
 43660                                  
 43661                                  ;  date string for prompt
 43662                                  promptdat_ptr:
 43663 00009206 3304                    	dw	1075			;AN000;message number
 43664 00009208 02                      	db	2			;AN000;number of subst
 43665 00009209 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43666 0000920A 00                      	db	0			;AN000;reserved
 43667 0000920B [96A3]                  	dw	Arg_Buf			;AN000;offset of arg
 43668 0000920D 0000                    	dw	0			;AN000;segment of arg
 43669 0000920F 01                      	db	1			;AN000;first subst
 43670 00009210 10                      	db	10h ; Char_field_ASCIIZ ;AN000;character string
 43671 00009211 03                      	db	3			;AN000;maximum width
 43672 00009212 03                      	db	3			;AN000;minimum width
 43673 00009213 20                       	db	blank ; 20h		;AN000;pad character
 43674 00009214 0B                      	db	parm_block_size  ; 11	;AN000;size of sublist
 43675 00009215 00                      	db	0			;AN000;reserved
 43676                                  promptDat_yr:
 43677 00009216 0000                    	dw	0			;AN000;year
 43678                                  promptDat_moday:
 43679 00009218 0000                    	dw	0			;AN000;month,day
 43680 0000921A 02                      	db	2			;AN000;second subst
 43681 0000921B 34                       	db	34h ; DATE_MDY_4	;AN000;date
 43682 0000921C 0A                      	db	10			;AN000;maximum width
 43683 0000921D 08                      	db	8			;AN000;minimum width
 43684 0000921E 20                      	db	blank ; 20h		;AN000;pad character
 43685                                  
 43686                                  ;  Time for prompt
 43687                                  promtim_ptr:
 43688 0000921F 3404                    	dw	1076			;AN000;message number
 43689 00009221 01                      	db	1			;AN000;number of subst
 43690 00009222 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43691 00009223 00                      	db	0			;AN000;reserved
 43692                                  PromTim_hr_min:
 43693 00009224 0000                    	dw	0			;AN000;hours,minutes
 43694                                  PromTim_Sec_hn:
 43695 00009226 0000                    	dw	0			;AN000;seconds,hundredths
 43696 00009228 01                      	db	1			;AN000;first subst
 43697 00009229 A6                      	db	0A6h ; Right_Align+TIME_HHMMSSHH_24
 43698                                  					;AC013;time
 43699 0000922A 0B                      	db	11			;AN000;maximum width
 43700 0000922B 0B                      	db	11			;AC013;minimum width
 43701 0000922C 20                      	db	blank ; 20h		;AN000;pad character
 43702                                  
 43703                                  ;  Date and time for DIR
 43704                                  dirdattim_ptr:
 43705 0000922D 3504                    	dw	1077			;AN000;message number
 43706 0000922F 02                      	db	2			;AN000;number of subst
 43707 00009230 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43708 00009231 00                      	db	0			;AN000;reserved
 43709                                  DirDat_Yr:
 43710 00009232 0000                    	dw	0			;AN000;year
 43711                                  DirDat_Mo_Day:
 43712 00009234 0000                    	dw	0			;AN000;month,day
 43713 00009236 01                      	db	1			;AN000;first subst
 43714                                  DirDat_form:	; 03/08/2024 - PCDOS 7.1
 43715 00009237 A4                      	db	0A4h ; Right_Align+DATE_MDY_2
 43716                                  					;AN000;date
 43717                                  DirDat_width:	; 03/08/2024 - PCDOS 7.1	
 43718 00009238 0A                      	db	10			;AN000;maximum width
 43719 00009239 08                      	db	8			;AN000;minimum width
 43720 0000923A 20                      	db	blank ; 20h		;AN000;pad character
 43721 0000923B 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43722 0000923C 00                      	db	0			;AN000;reserved
 43723                                  DirTim_Hr_Min:
 43724 0000923D 0000                    	dw	0			;AN000;hours,minutes
 43725                                  DirTim_Sec_hn:
 43726 0000923F 0000                    	dw	0			;AN000;seconds,hundredths
 43727 00009241 02                      	db	2			;AN000;second subst
 43728 00009242 85                      	db	85h ; Right_align+TIME_HHMM_Cty
 43729                                  					;AN000;time
 43730 00009243 06                      	db	6			;AN000;maximum width
 43731 00009244 06                      	db	6			;AN000;minimum width
 43732 00009245 20                      	db	blank ; 20h		;AN000;pad character
 43733                                  
 43734                                  ;  "Directory already exists"
 43735                                  MD_EXISTS_PTR:
 43736 00009246 3604                    	dw	1078			;AN000;message number
 43737 00009248 00                      	db	no_subst		;AN000;number of subst
 43738                                  
 43739                                  ;  "%1 bytes",13,10
 43740                                  
 43741                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 43742                                  %if 0
 43743                                  bytes_ptr:
 43744                                  	dw	1079			; message number
 43745                                  	db	1			; number of subst
 43746                                  	db	parm_block_size ; 11	; size of sublist
 43747                                  	db	0			; reserved
 43748                                  	dw	FileSiz			; offset of arg
 43749                                  	dw	0			; segment of arg
 43750                                  	db	1			; first subst
 43751                                  	; MSDOS 5.0 COMMAND.COM
 43752                                  	;db	0B1h ; Right_Align+Unsgn_Bin_DWord
 43753                                  	; 17/06/2023
 43754                                  screen_f_4:
 43755                                  	db	0F1h ; MSDOS 6.22 COMMAND.COM
 43756                                  					; long binary to decimal
 43757                                  	; MSDOS 5.0 COMMAND.COM
 43758                                  	;db	10			; maximum width
 43759                                  	;db	10			; minimum width
 43760                                  screen_f_5:
 43761                                  	db	14 ; MSDOS 6.22 COMMAND.COM
 43762                                  	db	14
 43763                                  	db	blank ; 20h		; pad character
 43764                                  %else
 43765                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43766                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9718h
 43767                                  bytes_ptr:
 43768 00009249 3704                    	dw	1079
 43769 0000924B 01                      	db	1
 43770 0000924C 0B                      	db	11
 43771 0000924D 00                      	db	0
 43772 0000924E [229C]                  	dw	FileSiz
 43773 00009250 0000                    	dw	0
 43774 00009252 01                      	db	1
 43775 00009253 F1                      	db	0F1h
 43776 00009254 0C                      	db	12
 43777 00009255 0C                      	db	12
 43778 00009256 20                      	db	20h
 43779                                  bytes_w_tr:
 43780 00009257 3704                    	dw	1079
 43781 00009259 01                      	db	1
 43782 0000925A 0B                      	db	11
 43783 0000925B 00                      	db	0
 43784 0000925C [229C]                  	dw	FileSiz
 43785 0000925E 0000                    	dw	0
 43786 00009260 01                      	db	1
 43787 00009261 F1                      	db	0F1h
 43788 00009262 0E                      	db	14
 43789 00009263 0E                      	db	14
 43790 00009264 20                      	db	20h
 43791                                  bytes_n_ptr:
 43792 00009265 3704                    	dw	1079
 43793 00009267 01                      	db	1
 43794 00009268 0B                      	db	11
 43795 00009269 00                      	db	0
 43796 0000926A B1                      	db	0B1h
 43797 0000926B A0                      	db	160
 43798 0000926C 00                      	db	0
 43799 0000926D 00                      	db	0
 43800 0000926E 01                      	db	1
 43801 0000926F B1                      	db	0B1h
 43802 00009270 0A                      	db	10
 43803 00009271 0A                      	db	10
 43804 00009272 20                      	db	20h
 43805                                  kbytes_ptr:
 43806 00009273 5304                    	dw	1107
 43807 00009275 01                      	db	1
 43808 00009276 0B                      	db	11
 43809 00009277 00                      	db	0
 43810 00009278 B1                      	db	0B1h
 43811 00009279 A0                      	db	160
 43812 0000927A 00                      	db	0
 43813 0000927B 00                      	db	0
 43814 0000927C 01                      	db	1
 43815 0000927D F1                      	db	0F1h
 43816 0000927E 0E                      	db	14
 43817 0000927F 0E                      	db	14
 43818 00009280 20                      	db	20h
 43819                                  kybytes_n_ptr:
 43820 00009281 5304                    	dw	1107
 43821 00009283 01                      	db	1
 43822 00009284 0B                      	db	11
 43823 00009285 00                      	db	0
 43824 00009286 [229C]                  	dw	FileSiz
 43825 00009288 0000                    	dw	0
 43826 0000928A 01                      	db	1
 43827 0000928B B1                      	db	0B1h
 43828 0000928C 0A                      	db	10
 43829 0000928D 0A                      	db	10
 43830 0000928E 20                      	db	20h
 43831                                  %endif
 43832                                  
 43833                                  ;  "Total:",13,10
 43834                                  total_ptr:
 43835 0000928F 3804                    	dw	1080			; message number
 43836 00009291 00                      	db	no_subst ; 0		; number of subst
 43837                                  
 43838                                  ;  "Error parsing environment variable:",13,10
 43839                                  errparsenv_ptr:
 43840 00009292 3904                    	dw	1081			; message number
 43841 00009294 00                      	db	no_subst ; 0		; number of subst
 43842                                  
 43843                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 43844                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:996Ah)
 43845                                  cox_Y_quest_ptr:
 43846 00009295 3A04                    	dw	1082
 43847 00009297 00                      	db	no_subst ; 0
 43848                                  cox_Y_answ_ptr:
 43849 00009298 3B04                    	dw	1083
 43850 0000929A 00                      	db	no_subst ; 0
 43851                                  
 43852                                  ;  "(continuing %1)",13,10
 43853                                  dircont_ptr:
 43854 0000929B 3C04                    	dw	1084			;AN000;message number
 43855 0000929D 01                      	db	1			;AN000;number of subst
 43856 0000929E 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43857 0000929F 00                      	db	0			;AN000;reserved
 43858 000092A0 [399D]                  	dw	BWDBUF			;AN000;offset of arg
 43859 000092A2 0000                    	dw	0			;AN000;segment of arg
 43860 000092A4 01                      	db	1			;AN000;first subst
 43861 000092A5 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43862 000092A6 80                      	db	128			;AN000;maximum width
 43863 000092A7 00                      	db	0			;AN000;minimum width
 43864 000092A8 20                      	db	blank ; 20h		;AN000;pad character
 43865                                  
 43866                                  ;  "Revision %1",CR,LF
 43867                                  dosrev_ptr:
 43868 000092A9 4204                    	dw	1090
 43869 000092AB 01                      	db	1			; one substitution
 43870 000092AC 0B                      	db	parm_block_size ; 11
 43871 000092AD 00                      	db	0
 43872 000092AE [B19D]                  	dw	One_Char_Val		; ptr to char
 43873 000092B0 0000                    	dw	0			; segment addr?
 43874 000092B2 01                      	db	1			; 1st substitution
 43875 000092B3 00                      	db	0 ; CHAR_FIELD_CHAR	; character
 43876 000092B4 01                      	db	1			; max width
 43877 000092B5 01                      	db	1			; min width
 43878 000092B6 20                      	db	blank ; 20h		; pad char
 43879                                  
 43880                                  ;  "DOS is in ROM"
 43881                                  DosRom_Ptr:
 43882 000092B7 4304                    	dw	1091
 43883 000092B9 00                      	db	no_subst ; 0
 43884                                  
 43885                                  ;  "DOS is in HMA"
 43886                                  DosHma_Ptr:
 43887 000092BA 4404                    	dw	1092
 43888 000092BC 00                      	db	no_subst ; 0
 43889                                  
 43890                                  ;  "DOS is in low memory"
 43891                                  DosLow_Ptr:
 43892 000092BD 4504                    	dw	1093
 43893 000092BF 00                      	db	no_subst ; 0
 43894                                  
 43895                                  ;  "Cannot Loadhigh batch file" ;M016
 43896                                  NoExecBat_Ptr:
 43897 000092C0 4604                    	dw	1094			; M016
 43898 000092C2 00                      	db	no_subst ; 0		; M016
 43899                                  
 43900                                  ;  "LoadHigh: Invalid filename" ; M016
 43901                                  LhInvFil_Ptr:
 43902 000092C3 4704                    	dw	1095			; M016
 43903 000092C5 00                      	db	no_subst ; 0		; M016
 43904                                  
 43905                                  ;  "Could not open specified country information file" ; M045
 43906                                  NoCntry_Ptr:
 43907 000092C6 4804                    	dw	1096			; M045
 43908 000092C8 00                      	db	no_subst ; 0		; M045
 43909                                  
 43910                                  ; 15/04/2023
 43911                                  ; MSDOS 6.0 COMMAND.COM only !
 43912                                  ; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 43913                                  ;%if 0
 43914                                  
 43915                                  ;* The next four errors emulate those reported by the normal parse
 43916                                  ;  mechanism, with a little more accurate wording; that parser has been
 43917                                  ;  replaced with a custom routine (ParseVar) for LoadHigh and DeviceHigh.
 43918                                  ;  These errors aren't normally generated by LoadHigh except by the normal
 43919                                  ;  parser, so they've been added here.
 43920                                  
 43921                                  ;  "LoadHigh: Invalid argument"
 43922                                  LhInvArg_Ptr:
 43923 000092C9 4904                    	dw	1097
 43924 000092CB 00                      	db	no_subst ; 0
 43925                                  
 43926                                  ;  "Required parameter missing"
 43927                                  ReqParmMiss:
 43928 000092CC 4A04                    	dw	1098
 43929 000092CE 00                      	db	no_subst ; 0
 43930                                  
 43931                                  ;  "Unrecognized switch"
 43932                                  LhInvSwt_Ptr:
 43933 000092CF 4B04                    	dw	1099
 43934 000092D1 00                      	db	no_subst ; 0
 43935                                  
 43936                                  ;  "A bad UMB number has been specified"
 43937                                  LhBadUMB_Ptr:
 43938 000092D2 4C04                    	dw	1100
 43939 000092D4 00                      	db	no_subst ; 0
 43940                                  ;%endif	
 43941                                  
 43942                                  ; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43943                                  %if 0
 43944                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 43945                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:99AAh
 43946                                  
 43947                                  DirCompRatio_Ptr:
 43948                                  	dw	1101			;message number
 43949                                  	db	2			;number of subst
 43950                                  	db	parm_block_size ; 11	;size of sublist
 43951                                  	db	0			;reserved
 43952                                  	dw	Dir_CRatio_1		;offset of arg
 43953                                  	dw	0			;segment of arg
 43954                                  	db	1			;first subst
 43955                                  	db	91h			;format
 43956                                  	db	2			;maximum width
 43957                                  	db	2			;minimum width
 43958                                  	db	blank ; 20h		;pad character
 43959                                  	db	parm_block_size  ; 11	;size of sublist
 43960                                  	db	0			; reserved
 43961                                  	dw	Dir_CRatio_2		;offset of arg
 43962                                  	dw	0			;segment of arg
 43963                                  	db	2			;second subst
 43964                                  	db	11h			;format
 43965                                  	db	1			;maximum width
 43966                                  	db	1			;minimum width
 43967                                  	db	blank ; 20h		;pad character
 43968                                  
 43969                                  AveCompRatio_Ptr:
 43970                                  	dw	1102			;message number
 43971                                  	db	2			;number of subst
 43972                                  	db	parm_block_size ; 11	;size of sublist
 43973                                  	db	0			;reserved
 43974                                  	dw	Dir_CRatio_1		;offset of arg
 43975                                  	dw	0			;segment of arg
 43976                                  	db	1			;first subst
 43977                                  	db	91h			;format
 43978                                  	db	2			;maximum width
 43979                                  	db	2			;minimum width
 43980                                  	db	blank ; 20h		;pad character
 43981                                  	db	parm_block_size  ; 11	;size of sublist
 43982                                  	db	0			; reserved
 43983                                  	dw	Dir_CRatio_2		;offset of arg
 43984                                  	dw	0			;segment of arg
 43985                                  	db	2			;second subst
 43986                                  	db	11h			;format
 43987                                  	db	1			;maximum width
 43988                                  	db	1			;minimum width
 43989                                  	db	blank ; 20h		;pad character
 43990                                  %else
 43991                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43992                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:97A4h
 43993                                  kbytesf_ptr:
 43994 000092D5 5204                    	dw	1106
 43995 000092D7 01                      	db	1
 43996 000092D8 0B                      	db	11
 43997 000092D9 00                      	db	0
 43998 000092DA [A99D]                  	dw	Bytes_Free
 43999 000092DC 0000                    	dw	0
 44000 000092DE 01                      	db	1
 44001 000092DF F1                      	db	0F1h			; long binary to decimal
 44002 000092E0 1E                      	db	30
 44003 000092E1 1E                      	db	30
 44004 000092E2 20                      	db	20h
 44005                                  kbytesf_n_ptr:
 44006 000092E3 5204                    	dw	1106
 44007 000092E5 01                      	db	1
 44008 000092E6 0B                      	db	11
 44009 000092E7 00                      	db	0
 44010 000092E8 [A99D]                  	dw	Bytes_Free
 44011 000092EA 0000                    	dw	0
 44012 000092EC 01                      	db	1
 44013 000092ED B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 44014 000092EE 1C                      	db	28
 44015 000092EF 1C                      	db	28
 44016 000092F0 20                      	db	20h
 44017                                  %endif
 44018                                  
 44019                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44020                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8483h
 44021                                  
 44022                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44023                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:99DCh
 44024                                  
 44025                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 44026                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:97C0h
 44027                                  
 44028                                  ; ---------------------------------------------------------------------------
 44029                                  
 44030                                  PATH_TEXT:
 44031 000092F1 504154483D              	db	"PATH="
 44032                                  PROMPT_TEXT:
 44033 000092F6 50524F4D50543D          	db	"PROMPT="
 44034                                  COMSPECSTR:
 44035 000092FD 434F4D535045433D        	db	"COMSPEC="
 44036                                  DirEnvVar:
 44037 00009305 444952434D443D          	db	"DIRCMD="		; DIR's environment variable
 44038                                  
 44039                                  ; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 44040                                  ; PCDOS 7.1 COMMAND.COM
 44041                                  %if 1
 44042                                  no_sep_text:
 44043 0000930C 4E4F5F5345503D          	db	'NO_SEP='	; 1 = do not use commas as num separator
 44044                                  %endif
 44045                                  
 44046                                  ;============================================================================
 44047                                  ; TDATA.ASM, MSDOS 6.0, 1991
 44048                                  ;============================================================================
 44049                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44050                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44051                                  
 44052                                  	; 15/04/2023
 44053 00009313 00                      	db	0
 44054                                  align 2
 44055                                  
 44056                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:849Eh
 44057                                  ; ---------------------------------------------------------------------------
 44058                                  	; 18/06/2023
 44059                                  	;db	0
 44060                                  
 44061                                  ; Lists of help message numbers for internal commands and /?
 44062                                  
 44063                                  	; 18/06/2023
 44064                                  ;;NoHelpMsgs:
 44065                                  	;dw	1200,0		;M014
 44066                                  
 44067                                  	; 18/06/2023
 44068                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:99F7h
 44069                                  
 44070                                  BreakHelpMsgs:
 44071 00009314 14050000                	dw	1300,0
 44072                                  ChcpHelpMsgs:
 44073 00009318 280529050000            	dw	1320,1321,0
 44074                                  CdHelpMsgs:
 44075 0000931E 3C053D053E050000        	dw	1340,1341,1342,0
 44076                                  ClsHelpMsgs:
 44077 00009326 50050000                	dw	1360,0
 44078                                  CopyHelpMsgs:
 44079                                  	;dw	1400,1401,1402,1403,1404,0
 44080                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 44081 0000932A 780579057A057B057C-     	dw	1400,1401,1402,1403,1404,1405,1406,1407,0
 44081 00009333 057D057E057F050000 
 44082                                  CttyHelpMsgs:
 44083 0000933C 8C050000                	dw	1420,0
 44084                                  DateHelpMsgs:
 44085 00009340 A005A1050000            	dw	1440,1441,0
 44086                                  DelHelpMsgs:
 44087 00009346 B405B505B6050000        	dw	1460,1461,1462,0
 44088                                  DirHelpMsgs:
 44089 0000934E C805C905CA05CB05CC-     	dw	1480,1481,1482,1483,1484,1485,1486,1487,1488
 44089 00009357 05CD05CE05CF05D005 
 44090                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 44091                                  	; MSDOS 6.0 COMMAND.COM
 44092                                  	;dw	1489,1490,1491,1492
 44093                                  	; 06/08/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM 
 44094 00009360 D105                    	dw	1489	
 44095 00009362 0000                    	dw	0
 44096                                  ExitHelpMsgs:
 44097 00009364 DC050000                	dw	1500,0
 44098                                  MdHelpMsgs:
 44099 00009368 F0050000                	dw	1520,0
 44100                                  PathHelpMsgs:
 44101 0000936C 0406050606060000        	dw	1540,1541,1542,0
 44102                                  PromptHelpMsgs:
 44103 00009374 180619061A061B061C-     	dw	1560,1561,1562,1563,1564,1565,1566,1567,1568,0
 44103 0000937D 061D061E061F062006-
 44103 00009386 0000               
 44104                                  RdHelpMsgs:
 44105 00009388 2C060000                	dw	1580,0
 44106                                  RenHelpMsgs:
 44107 0000938C 4006410642060000        	dw	1600,1601,1602,0
 44108                                  SetHelpMsgs:
 44109 00009394 5406550656060000        	dw	1620,1621,1622,0
 44110                                  TimeHelpMsgs:
 44111 0000939C 680669060000            	dw	1640,1641,0
 44112                                  TypeHelpMsgs:
 44113 000093A2 7C060000                	dw	1660,0
 44114                                  VerHelpMsgs:
 44115 000093A6 90060000                	dw	1680,0
 44116                                  VerifyHelpMsgs:
 44117 000093AA A4060000                	dw	1700,0
 44118                                  VolHelpMsgs:
 44119 000093AE B8060000                	dw	1720,0
 44120                                  CallHelpMsgs:
 44121 000093B2 CC06CD060000            	dw	1740,1741,0	;M014
 44122                                  RemHelpMsgs:
 44123 000093B8 E0060000                	dw	1760,0		;M014
 44124                                  PauseHelpMsgs:
 44125 000093BC F4060000                	dw	1780,0		;M014
 44126                                  EchoHelpMsgs:
 44127 000093C0 080709070000            	dw	1800,1801,0	;M014
 44128                                  GotoHelpMsgs:
 44129 000093C6 1C071D070000            	dw	1820,1821,0	;M014
 44130                                  ShiftHelpMsgs:
 44131 000093CC 30070000                	dw	1840,0		;M014
 44132                                  IfHelpMsgs:
 44133 000093D0 440745074607470748-     	dw	1860,1861,1862,1863,1864,1865,1866,0	;M014
 44133 000093D9 0749074A070000     
 44134                                  ForHelpMsgs:
 44135 000093E0 580759075A075B0700-     	dw	1880,1881,1882,1883,0 ;M014
 44135 000093E9 00                 
 44136                                  TruenameHelpMsgs:
 44137 000093EA 6C070000                	 dw	1900,0		;M014
 44138                                  LoadhighHelpMsgs:
 44139 000093EE 800781078207            	dw	1920,1921,1922
 44140                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 44141                                  	; MSDOS 6.0 COMMAND.COM
 44142 000093F4 830784078507860787-     	dw	1923,1924,1925,1926,1927 ;M014
 44142 000093FD 07                 
 44143 000093FE 0000                    	dw	0
 44144                                  
 44145                                  ; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 44146                                  %if 1
 44147                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:98CEh
 44148                                  twospacechars:
 44149 00009400 202000                  	db	'  ',0
 44150                                  %endif
 44151                                  
 44152                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8578h
 44153                                  CLSSTRING:
 44154 00009403 041B5B324A              	db	4,1Bh,"[2J"		; ANSI Clear screen
 44155                                  
 44156                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:98D6h
 44157                                  PROMPT_TABLE:
 44158 00009408 42                      	db	"B"
 44159 00009409 [AC21]                  	dw	Print_B
 44160 0000940B 44                      	db	"D"
 44161 0000940C [093B]                  	dw	PRINT_DATE
 44162 0000940E 45                      	db	"E"
 44163 0000940F [A021]                  	dw	PRINT_ESC
 44164 00009411 47                      	db	"G"
 44165 00009412 [A421]                  	dw	PRINT_G
 44166 00009414 48                      	db	"H"
 44167 00009415 [5F21]                  	dw	PRINT_BACK
 44168 00009417 4C                      	db	"L"
 44169 00009418 [A821]                  	dw	PRINT_L
 44170 0000941A 4E                      	db	"N"
 44171 0000941B [BD21]                  	dw	PRINT_DRIVE
 44172 0000941D 50                      	db	"P"
 44173 0000941E [C521]                  	dw	build_dir_for_prompt
 44174 00009420 51                      	db	"Q"
 44175 00009421 [6521]                  	dw	PRINT_EQ
 44176                                  	;
 44177                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 44178 00009423 52                      	db	"R"
 44179 00009424 [6921]                  	dw	PRINT_R ; PRINT Return code, [Retcode]
 44180                                  	;
 44181 00009426 54                      	db	"T"
 44182 00009427 [BF33]                  	dw	PRINT_TIME
 44183 00009429 56                      	db	"V"
 44184 0000942A [D820]                  	dw	PRINT_VERSION
 44185 0000942C 5F                      	db	"_"
 44186 0000942D [7929]                  	dw	CRLF2
 44187 0000942F 24                      	db	"$"
 44188 00009430 [AE21]                  	dw	PRINT_CHAR
 44189 00009432 00                      	db	0			; NUL TERMINATED
 44190                                  
 44191                                  ; Table of IF conditionals
 44192                                  IFTAB:
 44193 00009433 034E4F54                	db	3,"NOT"			; First byte is count
 44194 00009437 [F80B]                  	dw	IFNOT
 44195 00009439 0A4552524F524C4556-     	db	10,"ERRORLEVEL"
 44195 00009442 454C               
 44196 00009444 [B70C]                  	dw	IFERLEV
 44197 00009446 054558495354            	db	5,"EXIST"
 44198 0000944C [4C0C]                  	dw	IFEXISTS
 44199 0000944E 00                      	db	0
 44200                                  
 44201                                  	; 06/08/2024
 44202                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:991Dh
 44203                                  
 44204                                  ; Table for internal command names
 44205                                  COMTAB:
 44206 0000944F 0344495203              	db	3,"DIR",fSwitchAllowed+fCheckDrive ; 3
 44207 00009454 [8011]                  	dw	CATALOG			; In TCMD1.ASM
 44208 00009456 [4E93]                  	dw	DirHelpMsgs
 44209                                  
 44210 00009458 0443414C4C02            	db	4,"CALL",fSwitchAllowed	; 2
 44211 0000945E [2C0D]                  	dw	_$CALL			; In TBATCH2.ASM
 44212 00009460 [B293]                  	dw	CallHelpMsgs
 44213                                  
 44214 00009462 044348435002            	db	4,"CHCP",fSwitchAllowed ; 2
 44215 00009468 [0824]                  	dw	CHCP			; In TCMD2B.ASM
 44216 0000946A [1893]                  	dw	ChcpHelpMsgs
 44217                                  
 44218 0000946C 0652454E414D4503        	db	6,"RENAME",fSwitchAllowed+fCheckDrive	; 3 ;AC018; P3903
 44219 00009474 [8E1D]                  	dw	CRENAME			; In TCMD1.ASM
 44220 00009476 [8C93]                  	dw	RenHelpMsgs
 44221                                  
 44222 00009478 0352454E03              	db	3,"REN",fSwitchAllowed+fCheckDrive	; 3 ;AC018; P3903
 44223 0000947D [8E1D]                  	dw	CRENAME			; In TCMD1.ASM
 44224 0000947F [8C93]                  	dw	RenHelpMsgs
 44225                                  	
 44226 00009481 05455241534503          	db	5,"ERASE",fSwitchAllowed+fCheckDrive	; 3
 44227 00009488 [0C1D]                  	dw	ERASE			; In TCMD1.ASM
 44228 0000948A [4693]                  	dw	DelHelpMsgs
 44229                                  	
 44230 0000948C 0344454C03              	db	3,"DEL",fSwitchAllowed+fCheckDrive	; 3
 44231 00009491 [0C1D]                  	dw	ERASE			; In TCMD1.ASM
 44232 00009493 [4693]                  	dw	DelHelpMsgs
 44233                                  	
 44234 00009495 045459504503            	db	4,"TYPE",fSwitchAllowed+fCheckDrive	; 3 ;AC018; P3903
 44235 0000949B [351E]                  	dw	TYPEFIL			; In TCMD1.ASM
 44236 0000949D [A293]                  	dw	TypeHelpMsgs
 44237                                  	
 44238 0000949F 0352454D06              	db	3,"REM",fSwitchAllowed+fLimitHelp	; 6
 44239 000094A4 [0401]                  	dw	TCOMMAND		; In TCODE.ASM
 44240 000094A6 [B893]                  	dw	RemHelpMsgs
 44241                                  	
 44242 000094A8 04434F505903            	db	4,"COPY",fSwitchAllowed+fCheckDrive	; 3
 44243 000094AE [563B]                  	dw	COPY			; In COPY.ASM
 44244 000094B0 [2A93]                  	dw	CopyHelpMsgs
 44245                                  	
 44246 000094B2 05504155534506          	db	5,"PAUSE",fSwitchAllowed+fLimitHelp	; 6
 44247 000094B9 [001D]                  	dw	PAUSE			; In TCMD1.ASM
 44248 000094BB [BC93]                  	dw	PauseHelpMsgs
 44249                                  	
 44250 000094BD 044441544502            	db	4,"DATE",fSwitchAllowed	; 2
 44251 000094C3 [CF32]                  	dw	DATE			; In TPIPE.ASM
 44252 000094C5 [4093]                  	dw	DateHelpMsgs
 44253                                  	
 44254 000094C7 0454494D4502            	db	4,"TIME",fSwitchAllowed ; 2		;AC018; P3903
 44255 000094CD [2F33]                  	dw	CTIME			; In TPIPE.ASM
 44256 000094CF [9C93]                  	dw	TimeHelpMsgs
 44257                                  	
 44258 000094D1 0356455202              	db	3,"VER",fSwitchAllowed ; 2
 44259 000094D6 [6220]                  	dw	VERSION			; In TCMD2.ASM
 44260 000094D8 [A693]                  	dw	VerHelpMsgs
 44261                                  	
 44262 000094DA 03564F4C03              	db	3,"VOL",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 44263 000094DF [631F]                  	dw	VOLUME			; In TCMD1.ASM
 44264 000094E1 [AE93]                  	dw	VolHelpMsgs
 44265                                  	
 44266 000094E3 02434403                	db	2,"CD",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 44267 000094E7 [3C28]                  	dw	_$CHDIR			; In TENV.ASM
 44268 000094E9 [1E93]                  	dw	CdHelpMsgs
 44269                                  	
 44270 000094EB 05434844495203          	db	5,"CHDIR",fSwitchAllowed+fCheckDrive	;AC018; P3903
 44271 000094F2 [3C28]                  	dw	_$CHDIR			; In TENV.ASM
 44272 000094F4 [1E93]                  	dw	CdHelpMsgs
 44273                                  	
 44274 000094F6 024D4403                	db	2,"MD",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 44275 000094FA [A228]                  	dw	_$MKDIR			; In TENV.ASM
 44276 000094FC [6893]                  	dw	MdHelpMsgs
 44277                                  	
 44278 000094FE 054D4B44495203          	db	5,"MKDIR",fSwitchAllowed+fCheckDrive	;AC018; P3903
 44279 00009505 [A228]                  	dw	_$MKDIR			; In TENV.ASM
 44280 00009507 [6893]                  	dw	MdHelpMsgs
 44281                                  	
 44282 00009509 02524403                	db	2,"RD",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 44283 0000950D [E728]                  	dw	_$RMDIR			; In TENV.ASM
 44284 0000950F [8893]                  	dw	RdHelpMsgs
 44285                                  	
 44286 00009511 05524D44495203          	db	5,"RMDIR",fSwitchAllowed+fCheckDrive	;AC018; P3903
 44287 00009518 [E728]                  	dw	_$RMDIR			; In TENV.ASM
 44288 0000951A [8893]                  	dw	RdHelpMsgs
 44289                                  	
 44290 0000951C 05425245414B02          	db	5,"BREAK",fSwitchAllowed ; 2		;AC018; P3903
 44291 00009523 [533A]                  	dw	CNTRLC			; In TUCODE.ASM
 44292 00009525 [1493]                  	dw	BreakHelpMsgs
 44293                                  	
 44294 00009527 0656455249465902        	db	6,"VERIFY",fSwitchAllowed ; 2		;AC018; P3903
 44295 0000952F [953A]                  	dw	VERIFY			; In TUCODE.ASM
 44296 00009531 [AA93]                  	dw	VerifyHelpMsgs
 44297                                  	
 44298 00009533 0353455406              	db	3,"SET",fSwitchAllowed+fLimitHelp ; 6
 44299 00009538 [A625]                  	dw	ADD_NAME_TO_ENVIRONMENT	; In TENV.ASM
 44300 0000953A [9493]                  	dw	SetHelpMsgs
 44301                                  	
 44302 0000953C 0650524F4D505406        	db	6,"PROMPT",fSwitchAllowed+fLimitHelp ; 6
 44303 00009544 [8C25]                  	dw	ADD_PROMPT		; In TENV.ASM
 44304 00009546 [7493]                  	dw	PromptHelpMsgs
 44305                                  	
 44306 00009548 045041544802            	db	4,"PATH",fSwitchAllowed ; 2
 44307 0000954E [2C22]                  	dw	PATH			; In TCMD2.ASM
 44308 00009550 [6C93]                  	dw	PathHelpMsgs
 44309                                  	
 44310 00009552 044558495400            	db	4,"EXIT",0
 44311 00009558 [FD24]                  	dw	_$EXIT			; In TCMD2.ASM
 44312 0000955A [6493]                  	dw	ExitHelpMsgs
 44313                                  	
 44314 0000955C 044354545903            	db	4,"CTTY",fCheckDrive+fSwitchAllowed ; 3
 44315 00009562 [6A23]                  	dw	CTTY			; In TCMD2.ASM
 44316 00009564 [3C93]                  	dw	CttyHelpMsgs
 44317                                  	
 44318 00009566 044543484F06            	db	4,"ECHO",fSwitchAllowed+fLimitHelp ; 6
 44319 0000956C [1A3A]                  	dw	_ECHO			; In TUCODE.ASM
 44320 0000956E [C093]                  	dw	EchoHelpMsgs
 44321                                  	
 44322 00009570 04474F544F06            	db	4,"GOTO",fSwitchAllowed+fLimitHelp
 44323 00009576 [600D]                  	dw	_GOTO			; In TBATCH.ASM
 44324 00009578 [C693]                  	dw	GotoHelpMsgs
 44325                                  	
 44326 0000957A 05534849465402          	db	5,"SHIFT",fSwitchAllowed ; 2
 44327 00009581 [E50C]                  	dw	_SHIFT			; In TBATCH.ASM
 44328 00009583 [CC93]                  	dw	ShiftHelpMsgs
 44329                                  	
 44330 00009585 02494606                	db	2,"IF",fSwitchAllowed+fLimitHelp ; 6
 44331 00009589 [910B]                  	dw	_$IF			; In TBATCH.ASM
 44332 0000958B [D093]                  	dw	IfHelpMsgs
 44333                                  	
 44334 0000958D 03464F5206              	db	3,"FOR",fSwitchAllowed+fLimitHelp ; 6
 44335 00009592 [1910]                  	dw	_$FOR			; In TBATCH.ASM
 44336 00009594 [E093]                  	dw	ForHelpMsgs
 44337                                  	
 44338 00009596 03434C5300              	db	3,"CLS",0
 44339 0000959B [D122]                  	dw	CLS			; In TCMD2.ASM
 44340 0000959D [2693]                  	dw	ClsHelpMsgs
 44341                                  	
 44342 0000959F 08545255454E414D45-     	db	8,"TRUENAME",fSwitchAllowed+fCheckDrive	;AN000; P3903 changed
 44342 000095A8 03                 
 44343 000095A9 [8624]                  	dw	TRUENAME		;AN000;
 44344 000095AB [EA93]                  	dw	TruenameHelpMsgs
 44345                                  	
 44346 000095AD 084C4F414448494748-     	db	8,"LOADHIGH",fSwitchAllowed ; 2	; M003
 44346 000095B6 02                 
 44347 000095B7 [1A62]                  	dw	LoadHigh		; In loadhi.asm ; M003
 44348 000095B9 [EE93]                  	dw	LoadhighHelpMsgs	; M003
 44349                                  	
 44350 000095BB 024C4802                	db	2,"LH",fSwitchAllowed ; 2 ; Short form; M003
 44351 000095BF [1A62]                  	dw	LoadHigh		; In loadhi.asm ; M003
 44352 000095C1 [EE93]                  	dw	LoadhighHelpMsgs	; M003
 44353                                  	
 44354 000095C3 00                      	db	0			; Terminate command table
 44355                                  
 44356                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8736h
 44357                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9A92h ; 06/08/2024
 44358                                  
 44359 000095C4 2E434F4D                comext:	db	".COM"
 44360 000095C8 2E455845                exeext:	db	".EXE"
 44361 000095CC 2E424154                batext:	db	".BAT"
 44362                                  
 44363                                  switch_list:
 44364                                  	; MSDOS 5.0 (& 6.0) COMMAND.COM
 44365                                  	;db	"?VBAPW"		; flags we can recognize
 44366                                  	; 18/06/2023
 44367                                  	; MSDOS 6.22 COMMAND.COM
 44368 000095D0 2D593F5642415057        	db	"-Y?VBAPW" ; PCDOS 7.1 COMMAND.COM ; 06/08/2024
 44369                                  
 44370                                  AttrLtrs:
 44371 000095D8 524853764441            	db	"RHSvDA"		; attribute letters for DIR
 44372                                  
 44373                                  ;	Attribute letters in AttrLtrs must appear in the order that
 44374                                  ;	attribute bits occur in the attribute byte returned by
 44375                                  ;	directory searches, starting with bit 0.
 44376                                  ;	The volume label attribute is lowercased to keep it from
 44377                                  ;	being matched (by an uppercase comparison).
 44378                                  
 44379                                  OrderLtrs:
 44380                                  	; MSDOS 5.0
 44381                                  	;db	"NEDSG"			; sort order letters for DIR
 44382                                  	; 18/06/2023
 44383                                  	; MSDOS 6.0 COMMAND.COM
 44384                                  	;db	"NEDSGC"		; sort order letters for DIR
 44385                                  	; 06/08/2024
 44386                                  	; PCDOS 7.1 COMMAND.COM
 44387 000095DE 4E45445347              	db	"NEDSG"
 44388                                  
 44389                                  ;	Sort order letters stand for file name, extension,
 44390                                  ;	date/time, size, grouped (directory files before others),
 44391                                  ;	and compression ratio. DIR routines rely on the specific
 44392                                  ;	order of the letters in this list.
 44393                                  
 44394                                  comspec_flag:
 44395 000095E3 00                      	db	0                       ;AN071;
 44396                                  
 44397                                  BATBUFLEN:
 44398 000095E4 2000                    	dw	BatLen ; 32
 44399                                  
 44400                                  ; *****************************************************
 44401                                  ; EMG 4.00
 44402                                  ; DATA STARTING HERE WAS ADDED BY EMG FOR 4.00
 44403                                  ; FOR IMPLEMENTATION OF COMMON PARSE ROUTINE
 44404                                  ; *****************************************************
 44405                                  
 44406                                  ; COMMON PARSE BLOCKS
 44407                                  
 44408                                  ; Indicates no value list for PARSE.
 44409                                  
 44410                                  NO_VALUES:
 44411 000095E6 0000                    	dw	0			;AN000;  no values
 44412                                  
 44413                                  NULL_VALUE_LIST:  ; for unvalidated value
 44414 000095E8 00                       	db	0                       ; no value lists
 44415                                  
 44416                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44417                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8759h
 44418                                  
 44419                                  ; PARSE control block for a required file specification (upper cased)
 44420                                  
 44421                                  FILE_REQUIRED:
 44422 000095E9 0002                    	dw	0200h			;AN000;  filespec - required
 44423 000095EB 0100                    	dw	1			;AN000;  capitalize - file table
 44424 000095ED [EBA5]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44425 000095EF [E695]                  	dw	NO_VALUES		;AN000;
 44426 000095F1 00                      	db	0			;AN000;  no keywords
 44427                                  
 44428                                  ; PARSE control block for an optional file specification (upper cased)
 44429                                  ; or drive number
 44430                                  
 44431                                  FILE_OPTIONAL:
 44432 000095F2 0103                    	dw	0301h			;AN000;  filespec or drive number
 44433                                  					;	 optional
 44434 000095F4 0100                    	dw	1			;AN000;  capitalize - file table
 44435 000095F6 [EBA5]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44436 000095F8 [E695]                  	dw	NO_VALUES		;AN000;
 44437 000095FA 00                      	db	0			;AN000;  no keywords
 44438                                  
 44439                                  ; PARSE control block for an optional file specification (upper cased)
 44440                                  
 44441                                  FILE_OPTIONAL2:
 44442 000095FB 0102                    	dw	0201h                   ;AN000;  filespec optional
 44443 000095FD 0100                    	dw	1                       ;AN000;  capitalize - file table
 44444 000095FF [EBA5]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44445 00009601 [E695]                  	dw	NO_VALUES		;AN000;
 44446 00009603 00                      	db	0			;AN000;  no keywords
 44447                                  
 44448                                  ; PARSE control block for an optional /P switch
 44449                                  
 44450                                  SLASH_P_SWITCH:
 44451 00009604 0000                    	dw	0			;AN000;  no match flags
 44452 00009606 0200                    	dw	2			;AN000;  capitalize - char table
 44453 00009608 [EBA5]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44454 0000960A [E695]                  	dw	NO_VALUES		;AN000;
 44455 0000960C 01                      	db	1			;AN000;  1 keyword
 44456                                  SLASH_P_SYN:
 44457 0000960D 2F5000                  	db	"/P",0                  ;AN000;  /P switch
 44458                                  
 44459                                  ; PARSE BLOCK FOR BREAK, VERIFY, ECHO
 44460                                  
 44461                                  ; The following parse control block can be used for any command which
 44462                                  ; needs only the optional "ON" and "OFF" keywords as operands. Allows
 44463                                  ; the equal sign as an additional delimiter. Returns verified result
 44464                                  ; in PARSE1_OUTPUT. Currently used for the BREAK, VERIFY, and ECHO
 44465                                  ; internal commands.
 44466                                  
 44467                                  PARSE_BREAK:
 44468 00009610 [1396]                  	dw	BREAK_PARMS		;AN000;
 44469 00009612 00                      	db	0			;AN032; no extra delimiter
 44470                                  
 44471                                  BREAK_PARMS:
 44472 00009613 0001                    	db	0,1			;AN000;  1 positional parm
 44473 00009615 [1996]                  	dw	BREAK_CONTROL1		;AN000;
 44474 00009617 00                      	db	0			;AN000;  no switches
 44475 00009618 00                      	db	0			;AN000;  no keywords
 44476                                  
 44477                                  BREAK_CONTROL1:
 44478 00009619 0120                    	dw	2001h			;AN000;  string value - optional
 44479 0000961B 0200                    	dw	2			;AN000;  capitalize - char table
 44480 0000961D [EBA5]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44481 0000961F [2296]                  	dw	BREAK_VALUES		;AN000;
 44482 00009621 00                      	db	0			;AN000;  no keywords
 44483                                  
 44484                                  BREAK_VALUES:
 44485 00009622 03                      	db	3			;AN000;
 44486 00009623 00                      	db	0			;AN000;  no ranges
 44487 00009624 00                      	db	0			;AN000;  no numeric values
 44488 00009625 02                      	db	2			;AN000;  2 string values
 44489 00009626 00                      	db	0			;AN000;  returned if ON
 44490 00009627 [2C96]                  	dw	BREAK_ON		;AN000;  point to ON string
 44491 00009629 66                      	db	'f'                     ;AN000;  returned if OFF
 44492 0000962A [2F96]                  	dw	BREAK_OFF		;AN000;  point to OFF string
 44493                                  
 44494                                  BREAK_ON:
 44495 0000962C 4F4E00                  	db	"ON",0                  ;AN000;
 44496                                  BREAK_OFF:
 44497 0000962F 4F464600                	db	"OFF",0                 ;AN000;
 44498                                  
 44499                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44500                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:87A3h
 44501                                  
 44502                                  ; PARSE BLOCK FOR CHCP
 44503                                  
 44504                                  ; The following parse control block can be used for any command which
 44505                                  ; needs only one optional three digit decimal parameter for operands.
 44506                                  ; Returns verified result in PARSE1_OUTPUT. Currently used for the
 44507                                  ; CHCP internal command.
 44508                                  
 44509                                  CHCP_MINVAL	EQU	100			;AN000;
 44510                                  CHCP_MAXVAL	EQU	999			;AN000;
 44511                                  
 44512                                  PARSE_CHCP:
 44513 00009633 [3696]                  	dw	CHCP_PARMS			;AN000;
 44514 00009635 00                      	db	0				;AN000;  no extra delimiter
 44515                                  CHCP_PARMS:
 44516 00009636 0001                    	db	0,1				;AN000;  1 positional parm
 44517 00009638 [3C96]                  	dw	CHCP_CONTROL1			;AN000;
 44518 0000963A 00                      	db	0				;AN000;  no switches
 44519 0000963B 00                      	db	0				;AN000;  no keywords
 44520                                  
 44521                                  CHCP_CONTROL1:
 44522 0000963C 0180                    	dw	8001h				;AN000;  numeric value - optional
 44523 0000963E 0000                    	dw	0				;AN000;  no function flags
 44524 00009640 [EBA5]                  	dw	PARSE1_OUTPUT			;AN000;  result buffer
 44525 00009642 [4596]                  	dw	CHCP_VALUES			;AN000;
 44526 00009644 00                      	db	0				;AN000;  no keywords
 44527                                  
 44528                                  CHCP_VALUES:
 44529 00009645 01                      	db	1				;AN000;
 44530 00009646 01                      	db	1				;AN000;  1 range
 44531 00009647 01                      	db	1				;AN000;  returned if result
 44532 00009648 64000000E7030000        	dd	CHCP_MINVAL,CHCP_MAXVAL		;AN000;  minimum & maximum value
 44533 00009650 00                      	db	0				;AN000;  no numeric values
 44534 00009651 00                      	db	0				;AN000;  no string values
 44535                                  
 44536                                  ; PARSE BLOCK FOR DATE
 44537                                  
 44538                                  ; The following parse control block can be used for any command which
 44539                                  ; needs only an optional date string as an operand. Returns unverified
 44540                                  ; result in DATE_OUTPUT. Currently used for the DATE internal command.
 44541                                  
 44542                                  PARSE_DATE:
 44543 00009652 [5596]                  	dw	DATE_PARMS			;AN000;
 44544 00009654 00                      	db	0				;AN000;  no extra delimiter
 44545                                  DATE_PARMS:
 44546 00009655 0001                    	db	0,1				;AN000;  1 positional parm
 44547 00009657 [5B96]                  	dw	DATE_CONTROL1			;AN000;
 44548 00009659 00                      	db	0				;AN000;  no switches
 44549 0000965A 00                      	db	0				;AN000;  no keywords
 44550                                  
 44551                                  DATE_CONTROL1:
 44552 0000965B 0110                    	dw	1001h				;AN000;  date - optional
 44553 0000965D 0000                    	dw	0				;AN000;  no function flags
 44554 0000965F [F3A5]                  	dw	DATE_OUTPUT			;AN000;  result buffer
 44555 00009661 [E695]                  	dw	NO_VALUES			;AN000;
 44556 00009663 00                      	db	0				;AN000;  no keywords
 44557                                  
 44558                                  ; PARSE BLOCK FOR TIME
 44559                                  
 44560                                  ; The following parse control block can be used for any command which
 44561                                  ; needs only an optional time string as an operand. Returns unverified
 44562                                  ; result in TIME_OUTPUT. Currently used for the TIME internal command.
 44563                                  
 44564                                  PARSE_TIME:
 44565 00009664 [6796]                  	dw	TIME_PARMS			;AN000;
 44566 00009666 00                      	db	0				;AN000;  no extra delimiter
 44567                                  TIME_PARMS:
 44568 00009667 0001                    	db	0,1				;AN000;  1 positional parm
 44569 00009669 [6D96]                  	dw	TIME_CONTROL1			;AN000;
 44570 0000966B 00                      	db	0				;AN000;  no switches
 44571 0000966C 00                      	db	0				;AN000;  no keywords
 44572                                  
 44573                                  TIME_CONTROL1:
 44574 0000966D 0108                    	dw	0801h				;AN000;  TIME - optional
 44575 0000966F 0000                    	dw	0				;AN000;  no function flags
 44576 00009671 [FBA5]                  	dw	TIME_OUTPUT			;AN000;  result buffer
 44577 00009673 [E695]                  	dw	NO_VALUES			;AN000;
 44578 00009675 00                      	db	0				;AN000;  no keywords
 44579                                  
 44580                                  ; PARSE BLOCK FOR VOL
 44581                                  
 44582                                  ; The following parse control block can be used for any command which
 44583                                  ; needs only an optional drive letter as an operand.  Returns unverified
 44584                                  ; drive number (one based) in DRIVE_OUTPUT. Currently used for the VOL
 44585                                  ; internal command.
 44586                                  
 44587                                  PARSE_VOL:
 44588 00009676 [7996]                  	dw	VOL_PARMS			;AN000;
 44589 00009678 00                      	db	0				;AN000;  no extra delimiter
 44590                                  VOL_PARMS:
 44591 00009679 0001                    	db	0,1				;AN000;  1 positional parm
 44592 0000967B [7F96]                  	dw	DRIVE_CONTROL1			;AN000;
 44593 0000967D 00                      	db	0				;AN000;  no switches
 44594 0000967E 00                      	db	0				;AN000;  no keywords
 44595                                  
 44596                                  DRIVE_CONTROL1:
 44597 0000967F 0101                    	dw	0101h				;AN000;  DRIVE - optional
 44598 00009681 0100                    	dw	1				;AN000;  capitalize - file table
 44599 00009683 [03A6]                  	dw	DRIVE_OUTPUT			;AN000;  result buffer
 44600 00009685 [E695]                  	dw	NO_VALUES			;AN000;
 44601 00009687 00                      	db	0				;AN000;  no keywords
 44602                                  
 44603                                  ; PARSE BLOCK FOR MKDIR, RMDIR, TYPE
 44604                                  
 44605                                  ; The following parse control block can be used for any command which
 44606                                  ; needs only one required file specification as an operand. Returns a
 44607                                  ; pointer to the unverified string in PARSE1_OUTPUT. Currently used
 44608                                  ; for the MKDIR, RMDIR, and TYPE internal commands.
 44609                                  
 44610                                  PARSE_MRDIR:
 44611 00009688 [8B96]                  	dw	MRDIR_PARMS			;AN000;
 44612 0000968A 00                      	db	0				;AN000;  no extra delimiter
 44613                                  MRDIR_PARMS:
 44614 0000968B 0101                    	db	1,1				;AN000;  1 positional parm
 44615 0000968D [E995]                  	dw	FILE_REQUIRED			;AN000;
 44616 0000968F 00                      	db	0				;AN000;  no switches
 44617 00009690 00                      	db	0				;AN000;  no keywords
 44618                                  
 44619                                  ; PARSE BLOCK FOR CHDIR, TRUENAME
 44620                                  
 44621                                  ; The following parse control block can be used for any command which
 44622                                  ; needs only one optional file specification an operand. Returns a
 44623                                  ; pointer to the unverified string in PARSE1_OUTPUT. Currently used
 44624                                  ; for the CHDIR and TRUENAME internal commands.
 44625                                  
 44626                                  PARSE_CHDIR:
 44627 00009691 [9496]                  	dw	CHDIR_PARMS			;AN000;
 44628 00009693 00                      	db	0				;AN000;  no extra delimiter
 44629                                  CHDIR_PARMS:
 44630 00009694 0001                    	db	0,1				;AN000;  1 positional parm
 44631 00009696 [F295]                  	dw	FILE_OPTIONAL			;AN000;
 44632 00009698 00                      	db	0				;AN000;  no switches
 44633 00009699 00                      	db	0				;AN000;  no keywords
 44634                                  
 44635                                  ; PARSE BLOCK FOR ERASE
 44636                                  
 44637                                  ; The following parse control block is used for the DEL/ERASE internal
 44638                                  ; commands. This command has one required file specification and an
 44639                                  ; optional switch (/p) as operands. The verified switch or unverified
 44640                                  ; file specification is returned in PARSE1_OUTPUT.
 44641                                  
 44642                                  PARSE_ERASE:
 44643 0000969A [9D96]                  	dw	ERASE_PARMS			;AN000;
 44644 0000969C 00                      	db	0				;AN000;  no extra delimiter
 44645                                  
 44646                                  ERASE_PARMS:
 44647 0000969D 0101                    	db	1,1				;AN000;  1 positional parm
 44648 0000969F [E995]                  	dw	FILE_REQUIRED			;AN000;
 44649 000096A1 01                      	db	1				;AN000;  1 switch
 44650 000096A2 [0496]                  	dw	SLASH_P_SWITCH			;AN000;
 44651 000096A4 00                      	db	0				;AN000;  no keywords
 44652                                  
 44653                                  ; PARSE BLOCK FOR DIR
 44654                                  
 44655                                  ; The following parse control block is used for the DIR internal command.
 44656                                  ; This command has one optional file specification and several optional
 44657                                  ; switches. Switches, switch values, and the filespec are returned in 
 44658                                  ; PARSE1_OUTPUT.
 44659                                  ;
 44660                                  ; Switches are /a[value], /-a, /o[value], /-o, /s, /-s, /?, /b, /-b,
 44661                                  ; /w, /-w, /p, and /-p. The string values for /a and /o are optional,
 44662                                  ; do not require colons, and are not checked against a value list.
 44663                                  ;
 44664                                  ; Switch /h has been removed from the DIR command	;M008
 44665                                  ; Switch /? is no longer handled internally		;M008
 44666                                  ;
 44667                                  ; A list of pointers to all the switch synonyms is provided here to
 44668                                  ; help identify which switch has been matched.
 44669                                  
 44670                                  	; 15/04/2023 - Retro DOS v4.0 COMMAND.COM
 44671                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8815h
 44672                                  
 44673                                  PARSE_DIR:
 44674 000096A5 [A896]                  	dw	DIR_PARMS
 44675 000096A7 00                      	db	0			; no extra delimiters
 44676                                  DIR_PARMS:
 44677 000096A8 0001                    	db	0,1			; 1 optional positional param
 44678 000096AA [FB95]                  	dw	FILE_OPTIONAL2
 44679 000096AC 02                      	db	2			; 2 kinds of switches
 44680 000096AD [B296]                  	dw	DIR_SW_VALUED
 44681 000096AF [C196]                  	dw	DIR_SW_UNVALUED
 44682 000096B1 00                      	db	0			; no keywords
 44683                                  
 44684                                  DIR_SW_VALUED:
 44685 000096B2 0120                    	dw	2001h			; optional string value
 44686 000096B4 2100                    	dw	21h			; optional colon; capitalize 
 44687 000096B6 [EBA5]                  	dw	PARSE1_OUTPUT		; result buffer
 44688 000096B8 [E895]                  	dw	NULL_VALUE_LIST		; don't validate value
 44689                                  
 44690                                  	; 18/06/2023
 44691                                  	;db	2
 44692                                  
 44693                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 44694                                  ; PCDOS 7.1 COMMAND.COM
 44695                                  %if 0
 44696                                  ; MSDOS 6.0 COMMAND.COM
 44697                                  ;ifdef DBLSPACE_HOOKS
 44698                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44699                                  	db	3		; 3 'synonyms'
 44700                                  ;else
 44701                                  %else
 44702 000096BA 02                      	db	2		; 2 'synonyms'
 44703                                  ;endif
 44704                                  %endif
 44705                                  
 44706                                  DIR_SW_A:
 44707 000096BB 2F4100                  	db	"/A",0
 44708                                  DIR_SW_O:
 44709 000096BE 2F4F00                  	db	"/O",0
 44710                                  
 44711                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 44712                                  ; PCDOS 7.1 COMMAND.COM
 44713                                  %if 0
 44714                                  ; MSDOS 6.0 COMMAND.COM
 44715                                  ;ifdef DBLSPACE_HOOKS
 44716                                  	; 18/06/2023
 44717                                  DIR_SW_C:
 44718                                  	db	"/C",0
 44719                                  ;endif
 44720                                  %endif
 44721                                  
 44722                                  DIR_SW_UNVALUED:
 44723 000096C1 0000                    	dw	0			; no value
 44724 000096C3 0000                    	dw	0			; no format functions
 44725 000096C5 [EBA5]                  	dw	PARSE1_OUTPUT		; result buffer
 44726 000096C7 [E695]                  	dw	NO_VALUES
 44727                                  
 44728                                  	; 15/04/2023 - Retro DOS v4.0 COMMAND.COM
 44729                                  	;;db	12
 44730                                  	
 44731                                  	; 18/06/2023
 44732                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8839h
 44733                                  	;db	14		; 14 'synonyms' !?
 44734                                  
 44735                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 44736                                  ; PCDOS 7.1 COMMAND.COM
 44737                                  %if 0
 44738                                  ; MSDOS 6.0 COMMAND.COM
 44739                                  ;ifdef DBLSPACE_HOOKS
 44740                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44741                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9DB0h
 44742                                  	db	13		; 13 'synonyms'
 44743                                  ;else
 44744                                  	;db	12		; 12 'synonyms'
 44745                                  %else
 44746 000096C9 10                      	db	16		; 16 'synonyms'
 44747                                  ;endif
 44748                                  %endif
 44749                                  
 44750                                  DIR_SW_NEG_A:
 44751 000096CA 2F2D4100                	db	"/-A",0
 44752                                  DIR_SW_NEG_O:
 44753 000096CE 2F2D4F00                	db	"/-O",0
 44754                                  DIR_SW_S:
 44755 000096D2 2F5300                  	db	"/S",0
 44756                                  DIR_SW_NEG_S:
 44757 000096D5 2F2D5300                	db	"/-S",0
 44758                                  DIR_SW_B:
 44759 000096D9 2F4200                  	db	"/B",0
 44760                                  DIR_SW_NEG_B:
 44761 000096DC 2F2D4200                	db	"/-B",0
 44762                                  DIR_SW_W:
 44763 000096E0 2F5700                  	db	"/W",0
 44764                                  DIR_SW_NEG_W:
 44765 000096E3 2F2D5700                	db	"/-W",0
 44766                                  DIR_SW_P:
 44767 000096E7 2F5000                  	db	"/P",0
 44768                                  DIR_SW_NEG_P:
 44769 000096EA 2F2D5000                	db	"/-P",0
 44770                                  DIR_SW_L:
 44771 000096EE 2F4C00                  	db	"/L",0		;M010
 44772                                  DIR_SW_NEG_L:
 44773 000096F1 2F2D4C00                	db	"/-L",0 	;M010
 44774                                  
 44775                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 44776                                  ; PCDOS 7.1 COMMAND.COM
 44777                                  %if 0
 44778                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44779                                  ; MSDOS 6.0 COMMAND.COM (DBLSPACE_HOOKS)
 44780                                  DIR_SW_NEG_C:
 44781                                  	db	"/-C",0
 44782                                  %else
 44783                                  DIR_SW_Z:
 44784 000096F5 2F5A00                  	db	"/Z",0
 44785                                  DIR_SW_NEG_Z:
 44786 000096F8 2F2D5A00                	db	"/-Z",0
 44787                                  DIR_SW_4:
 44788 000096FC 2F3400                  	db	"/4",0
 44789                                  DIR_SW_NEG_4:
 44790 000096FF 2F2D3400                	db	"/-4",0
 44791                                  %endif
 44792                                  
 44793                                  ; Here's a list of pointers to DIR's switch synonyms, for easier
 44794                                  ; identification. Order is critical - DIR routines rely on the
 44795                                  ; specific order in this list. Negated options appear at odd 
 44796                                  ; positions in the list, and simple on/off options appear first.
 44797                                  
 44798                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44799                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9DE0h
 44800                                  Dir_Sw_Ptrs:			; list of ptrs to switch synonyms
 44801                                  
 44802                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 44803                                  ; PCDOS 7.1 COMMAND.COM
 44804                                  %if 0
 44805                                  	; 18/06/2023
 44806                                  	; MSDOS 6.0 COMMAND.COM ; *
 44807                                  	dw	DIR_SW_NEG_C	; *
 44808                                  Dir_Sw_Ptrs_2:
 44809                                  	dw	DIR_SW_C	; *
 44810                                  	; MSDOS 5.0 COMMAND.COM	
 44811                                  %endif
 44812                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 44813                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9BD1h
 44814                                  Dir_Sw_Ptrs:
 44815 00009703 [E396]                  	dw	DIR_SW_NEG_W
 44816                                  Dir_Sw_Ptrs_2:
 44817 00009705 [E096]                  	dw	DIR_SW_W
 44818 00009707 [EA96]                  	dw	DIR_SW_NEG_P
 44819 00009709 [E796]                  	dw	DIR_SW_P
 44820 0000970B [D596]                  	dw	DIR_SW_NEG_S
 44821 0000970D [D296]                  	dw	DIR_SW_S
 44822 0000970F [DC96]                  	dw	DIR_SW_NEG_B
 44823 00009711 [D996]                  	dw	DIR_SW_B
 44824 00009713 [F196]                  	dw	DIR_SW_NEG_L	;M010
 44825 00009715 [EE96]                  	dw	DIR_SW_L	;M010
 44826                                  
 44827                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 44828                                  ; PCDOS 7.1 COMMAND.COM
 44829                                  %if 1
 44830 00009717 [F896]                  	dw	DIR_SW_NEG_Z
 44831 00009719 [F596]                  	dw	DIR_SW_Z
 44832 0000971B [FF96]                  	dw	DIR_SW_NEG_4
 44833 0000971D [FC96]                  	dw	DIR_SW_4
 44834                                  %endif
 44835 0000971F [CE96]                  	dw	DIR_SW_NEG_O
 44836 00009721 [BE96]                  	dw	DIR_SW_O
 44837 00009723 [CA96]                  	dw	DIR_SW_NEG_A
 44838 00009725 [BB96]                  	dw	DIR_SW_A
 44839                                  
 44840                                  ; PARSE BLOCK FOR RENAME
 44841                                  
 44842                                  ; The following parse control block can be used for any command which
 44843                                  ; needs only two required file specifications as operands. Returns
 44844                                  ; pointers to the unverified string in PARSE1_OUTPUT.
 44845                                  ; Currently used for the RENAME internal command.
 44846                                  
 44847                                  PARSE_RENAME:
 44848 00009727 [2A97]                  	dw	RENAME_PARMS		;AN000;
 44849 00009729 00                      	db	0			;AN000;  no extra delimiter
 44850                                  RENAME_PARMS:
 44851 0000972A 0202                    	db	2,2			;AN000;  2 positional parms
 44852 0000972C [E995]                  	dw	FILE_REQUIRED		;AN000;
 44853 0000972E [E995]                  	dw	FILE_REQUIRED		;AN000;
 44854 00009730 00                      	db	0			;AN000;  no switches
 44855 00009731 00                      	db	0			;AN000;  no keywords
 44856                                  
 44857                                  ; PARSE BLOCK FOR CTTY
 44858                                  
 44859                                  ; The following parse control block can be used for any command which
 44860                                  ; needs one required device name as an operand. Returns a pointer to
 44861                                  ; unverified string in PARSE1_OUTPUT. Currently used for the CTTY
 44862                                  ; internal command.
 44863                                  
 44864                                  PARSE_CTTY:
 44865 00009732 [3597]                  	dw	CTTY_PARMS		;AN000;
 44866 00009734 00                      	db	0			;AN000;  no extra delimiter
 44867                                  CTTY_PARMS:
 44868 00009735 0101                    	db	1,1			;AN000;  1 positional parm
 44869 00009737 [3B97]                  	dw	CTTY_CONTROL1		;AN000;
 44870 00009739 00                      	db	0			;AN000;  no switches
 44871 0000973A 00                      	db	0			;AN000;  no keywords
 44872                                  CTTY_CONTROL1:
 44873 0000973B 0020                    	dw	2000h			;AN000;  string value - required
 44874 0000973D 1100                    	dw	11h			;AN000;  capitalize - file table
 44875                                  					;AN000;  remove colon at end
 44876 0000973F [EBA5]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44877 00009741 [E695]                  	dw	NO_VALUES		;AN000;
 44878 00009743 00                      	db	0			;AN000;  no keywords
 44879                                  
 44880                                  ; PARSE BLOCK FOR VER
 44881                                  
 44882                                  ; The following parse control block can be used for any command which
 44883                                  ; needs an optional switch "/debug". Currently used for the VER command.
 44884                                  
 44885                                  PARSE_VER:
 44886 00009744 [4797]                  	dw	VER_PARMS
 44887 00009746 00                      	db	0			; no extra delimiters
 44888                                  VER_PARMS:
 44889 00009747 0000                    	db	0,0			; no positional parameters
 44890                                  ; 20/07/2024 - Retro DOS v5 COMMAND.COM
 44891                                  %if 0	; PCDOS 7.1 (& MSDOS 5.0-6.22) COMMAND.COM 
 44892                                  	db	1			; one switch
 44893                                  	dw	SLASH_R
 44894                                  %else
 44895                                  	; 20/07/2024 - Retro DOS v4-v5 COMMAND.COM
 44896 00009749 02                      	db	2
 44897 0000974A [4F97]                  	dw	SLASH_R
 44898 0000974C [5B97]                  	dw	SLASH_T ; Retro DOS v4-v5 COMMAND.COM switch
 44899                                  %endif
 44900 0000974E 00                      	db	0			; no keywords
 44901                                  SLASH_R:
 44902 0000974F 0000                    	dw	0			; no values
 44903 00009751 0200                    	dw	2			; capitalize by filename table
 44904 00009753 [EBA5]                  	dw	PARSE1_OUTPUT		; result buffer
 44905 00009755 [E695]                  	dw	NO_VALUES		; no values
 44906 00009757 01                      	db	1			; one synonym
 44907                                  SLASH_R_SYN:
 44908 00009758 2F5200                  	db	"/R",0
 44909                                  
 44910                                  ; 20/07/2024 - Retro DOS v5 COMMAND.COM
 44911                                  %if 1
 44912                                  SLASH_T:
 44913 0000975B 0000                    	dw	0			; no values
 44914 0000975D 0200                    	dw	2			; capitalize by filename table
 44915 0000975F [EBA5]                  	dw	PARSE1_OUTPUT		; result buffer
 44916 00009761 [E695]                  	dw	NO_VALUES		; no values
 44917 00009763 01                      	db	1			; one synonym
 44918                                  SLASH_T_SYN:
 44919 00009764 2F5400                  	db	"/T",0
 44920                                  %endif
 44921                                  
 44922                                  ; M003 ; Start of changes for LoadHigh support
 44923                                  
 44924                                  ;Parse Control Block for LOADHIGH command
 44925                                  
 44926                                  Parse_LoadHi:
 44927 00009767 [6A97]                  	dw	LoadHi_Parms		;extended parm table
 44928 00009769 00                      	db	0			;no extra delimiters
 44929                                  
 44930                                  LoadHi_Parms:
 44931 0000976A 0101                    	db	1,1			;min. 1 parm, max. 1 parm
 44932 0000976C [E995]                  	dw	FILE_REQUIRED		;control struc for filename
 44933 0000976E 00                      	db	0			;no switches
 44934 0000976F 00                      	db	0			;no keywords
 44935                                  
 44936                                  ; M003 ; End of changes for LoadHigh support
 44937                                  
 44938                                  TempVarName:
 44939 00009770 54454D503D00            	db "TEMP=",0
 44940                                  
 44941                                  	; 16/04/2023 - Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 44942                                  ;TRANDATAEND:		; TRANGROUP:88C2h
 44943                                  
 44944                                  	; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 44945                                  copycmd:
 44946 00009776 434F5059434D443D        	db 'COPYCMD='
 44947                                  
 44948                                  ; 06/08/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 44949                                  %if 0
 44950                                  sCVFRoot:
 44951                                  	db '\DBLSPACE.'
 44952                                  %else
 44953                                  	; 06/08/2024
 44954                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9C3Eh
 44955                                  REXX_EXE:
 44956 0000977E 524558582E45584500      	db 'REXX.EXE',0
 44957                                  %endif
 44958                                  
 44959                                  ; ----------------------------------------------------------------------------
 44960                                  ; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 44961                                  %if 1
 44962 00009787 0D0A                    RD5CMD_VER_MSG: db 0Dh, 0Ah
 44963 00009789 526574726F20444F53-     		db 'Retro DOS v5 COMMAND.COM'
 44963 00009792 20763520434F4D4D41-
 44963 0000979B 4E442E434F4D       
 44964 000097A1 0D0A                    		db 0Dh, 0Ah 
 44965                                  		;db '2024 - Erdogan Tan'
 44966                                  		; 13/03/2025
 44967 000097A3 32303235202D204572-     		db '2025 - Erdogan Tan'
 44967 000097AC 646F67616E2054616E 
 44968 000097B5 0D0A                    		db 0Dh,0Ah
 44969 000097B7 24                      		db '$'
 44970                                  %endif
 44971                                  ; ----------------------------------------------------------------------------
 44972                                  
 44973                                  	; 18/06/2023
 44974                                  	; MSDOS 6.22 COMMAND.COM
 44975                                  TRANDATAEND:		; TRANGROUP:9E53h
 44976                                  
 44977                                  ;============================================================================
 44978                                  ; PSDATA.INC, MSDOS 6.0, 1991
 44979                                  ;============================================================================
 44980                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44981                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44982                                  
 44983                                  ; 18/04/2023
 44984                                  TRANSPACESTART:
 44985                                  
 44986                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:88C2h
 44987                                  	
 44988                                  	; 18/06/2023
 44989                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9E53h
 44990                                  
 44991                                  ;********************** Local Data *************************************
 44992                                  
 44993                                  $P_ORDINAL:
 44994 000097B8 0000                    	dw	0		;AN000; Operand ordinal save area
 44995                                  $P_RC:
 44996 000097BA 0000                    	dw	0		;AN000; Return code from parser
 44997                                  $P_SI_Save:
 44998 000097BC 0000                    	dw	0		;AN000; Pointer of command buffer
 44999                                  $P_DX:
 45000 000097BE 0000                    	dw	0		;AN000; Return result buffer address
 45001                                  $P_Terminator:
 45002 000097C0 00                      	db	0		;AN000; Terminator code (ASCII)
 45003                                  $P_DBCSEV_OFF:
 45004 000097C1 0000                    	dw	0		;AN000; Offset of DBCS EV
 45005                                  $P_DBCSEV_SEG:
 45006 000097C3 0000                    	dw	0		;AN000; Segment of DBCS EV
 45007                                  $P_Flags:			;AN000; Parser internal flags
 45008                                  $P_Flags1:
 45009 000097C5 00                      	db	0		;AN038; to reference first byte flags
 45010                                  $P_Flags2:
 45011 000097C6 00                      	db	0		;AN038; to reference second byte flags only
 45012                                  $P_SaveSI_Cmpx:
 45013 000097C7 0000                    	dw	0		;AN000; save si for later use by complex
 45014                                  $P_KEYorSW_Ptr:
 45015 000097C9 0000                    	dw	0		;AN000; points next to "=" or ":" code
 45016                                  $P_Save_EOB:
 45017 000097CB 0000                    	dw	0		;AN000; save pointer to EOB
 45018                                  $P_Found_SYNONYM:
 45019 000097CD 0000                    	dw	0		;AN000; es:@ points to found synonym
 45020                                  $P_STRING_BUF:
 45021 000097CF 00<rep 80h>             	times  128 db 0		;AN000; Pick a operand from command line
 45022                                  $P_ORIG_ORD:
 45023 0000984F 0000                    	dw	0		;AN039; ORIGINAL ORDINAL FROM CX
 45024                                  $P_ORIG_STACK:
 45025 00009851 0000                    	dw	0		;AN039; ORIGINAL VALUE OF STACK FROM SP
 45026                                  $P_ORIG_SI:
 45027 00009853 0000                    	dw	0		;AN039; ORIGINAL START PARSE POINTER FROM SI
 45028                                  $P_Got_Time:
 45029 00009855 00                      	db	0		;AN023; if 1, use Time delimiters
 45030                                  $P_Country_Info:
 45031 00009856 FFFF                    	dw	-1 ; 0FFFFh
 45032 00009858 00<rep 20h>             	times	32 db 0	
 45033                                  $P_1st_Val:
 45034 00009878 0000                    	dw	0		;AN000; used when process date or time
 45035                                  $P_2nd_Val:
 45036 0000987A 0000                    	dw	0		;AN000; used when process date or time
 45037                                  $P_3rd_Val:
 45038 0000987C 0000                    	dw	0		;AN000; used when process date or time
 45039                                  $P_4th_Val:
 45040 0000987E 0000                    	dw	0		;AN000; used when process date or time
 45041                                  $P_Char_CAP_Ptr:
 45042 00009880 FF                      	db	0FFh		;AN000; info id
 45043 00009881 0000                    	dw	0		;AN000; offset	of char case map table
 45044 00009883 0000                    	dw	0		;AN000; segment of char case map table
 45045                                  $P_File_CAP_Ptr:
 45046 00009885 FF                      	db	0FFh		;AN000; info id
 45047 00009886 0000                    	dw	0		;AN000; offset	of file case map table
 45048 00009888 0000                    	dw	0		;AN000; segment of file case map table
 45049                                  
 45050                                  	; 18/04/2023
 45051                                  ;M029
 45052                                  ;!!!WARNING!!!
 45053                                  ; In routine SYSPARSE (parse.asm), $P_FileSp_Char is reinitialized using 
 45054                                  ;hardcoded strings. If the chars in the string are changed here, corresponding
 45055                                  ;changes need to be made in SYSPARSE
 45056                                  
 45057                                  $P_FileSp_Char:
 45058 0000988A 5B5D7C3C3E2B3D3B22      	db	'[]|<>+=;"'     ;AN000; delimitter of file spec
 45059                                  $P_FileSp_Len equ $-$P_FileSp_Char ;AN000;
 45060                                  
 45061                                  ;filespec error flag
 45062                                  $P_err_flag:
 45063 00009893 00                      	db	0		;AN033; flag set if filespec parsing error
 45064                                  				;AN033;  was detected.
 45065                                  
 45066                                  ;============================================================================
 45067                                  ; MSGSERV.ASM, MSDOS 6.0, 1991
 45068                                  ;============================================================================
 45069                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 45070                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45071                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 45072                                  
 45073                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:899Eh
 45074                                  
 45075                                  	; 18/06/2023
 45076                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9F2Fh
 45077                                  
 45078                                  	; 13/08/2024
 45079                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9D23h
 45080                                  
 45081                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 45082                                  ;;
 45083                                  ;; STRUCTURE: $M_RES_ADDRS
 45084                                  ;;
 45085                                  ;; Resident data area definition of variables
 45086                                  ;;
 45087                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 45088                                  
 45089                                  $M_RT:
 45090 00009894 00<rep 8Dh>             	times $M_RES_ADDRS_SZ db 0   ; times 141 db 0 ; 13/08/2024
 45091                                  
 45092                                  ;============================================================================
 45093                                  ; COPYRIGHT.INC, MSDOS 6.0, 1993
 45094                                  ;============================================================================
 45095                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 45096                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45097                                  
 45098                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8A2Bh
 45099                                  ; ---------------------------------------------------------------------------
 45100                                  ;;M00 - changed to DOS 5.0 copyright - MD 9 Jul 90
 45101                                  ;;M031 - changed copyright to 1991
 45102                                  ;;9/16 - changed version to 6.0 and copyright to 1992
 45103                                  ;;9/21 - Added international translations, language passed through COUNTRY macro
 45104                                  ;;B49,50 - changed version to 6 and copyright to 1993
 45105                                  ; ---------------------------------------------------------------------------
 45106                                  
 45107                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 45108                                  ; PCDOS 7.1 COMMAND.COM
 45109                                  %if 0	
 45110                                  	; 18/06/2023
 45111                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9FBCh
 45112                                  ;ifdef USA
 45113                                  MsDosVer6_CCopy:
 45114                                  	; MSDOS 6.0
 45115                                  	;db	"MS DOS Version 6 (C)Copyright 1981-1993 Microsoft Corp "
 45116                                  	; 18/06/2023
 45117                                  	; MSDOS 6.22
 45118                                  	db	"MS DOS Version 6 (C)Copyright 1981-1994 Microsoft Corp "
 45119                                  	db	"Licensed Material - Property of Microsoft "
 45120                                  	db	"All rights reserved "
 45121                                  ;endif
 45122                                  %endif
 45123                                  
 45124                                  ; ---------------------------------------------------------------------------
 45125                                  ; 18/06/2023
 45126                                  ; 15/04/2023
 45127                                  ;MsDosVer5_CCopy:
 45128                                  	;db	"MS DOS Version 5.00 (C)Copyright 1981-1991 Microsoft Corp "
 45129                                  	;db	"Licensed Material - Property of Microsoft "
 45130                                  	;db	"All rights reserved "
 45131                                  ; ---------------------------------------------------------------------------
 45132                                  ; 15/04/2023
 45133                                  	; 16/04/2023 - 21/04/2023
 45134                                  	;db 	0
 45135                                  	;db	0Dh,0Ah
 45136                                  	;db	'Retro DOS v4.0 (& v4.1) COMMAND.COM '
 45137                                  	;db	0
 45138                                  	;db	'by Erdogan Tan - 05/05/2023'
 45139                                  	;db	0
 45140                                  
 45141                                  	; 19/06/2023
 45142                                  	; 18/06/2023
 45143                                  	;db 	0
 45144                                  	;db	0Dh,0Ah
 45145                                  	;db	'Retro DOS v4.2 COMMAND.COM '
 45146                                  	;db	0
 45147                                  	;db	'by Erdogan Tan - 19/6/2023'
 45148                                  	;db	0
 45149                                  
 45150                                  ;============================================================================
 45151                                  ; TPRINTF.ASM, MSDOS 6.0, 1991
 45152                                  ;============================================================================
 45153                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 45154                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45155                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 45156                                  
 45157                                  PRINTF_HANDLE:
 45158 00009921 0000                    	dw	0		;AC000;
 45159                                  
 45160                                  ;============================================================================
 45161                                  ; TSPC.ASM, MSDOS 6.0, 1991
 45162                                  ;============================================================================
 45163                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 45164                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45165                                  
 45166                                  ;TITLE	COMMAND Transient Uninitialized DATA
 45167                                  
 45168                                  ;The TRANSPACE segment contains variable data that is considered
 45169                                  ;volatile between command cycles, and therefore is not included in the
 45170                                  ;transient checksum area. Contents of these variables MUST be
 45171                                  ;initialized before use, and must not be relied upon from command
 45172                                  ;cycle to command cycle.
 45173                                  ;
 45174                                  ;No constant data values should be stored here.
 45175                                  
 45176                                  ; ---------------------------------------------------------------------------
 45177                                  ; START OF UNITIALIZED DATA
 45178                                  ; ---------------------------------------------------------------------------
 45179                                  
 45180                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 8AA5h
 45181                                  
 45182                                  	; 18/06/2023
 45183                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A033h
 45184                                  
 45185                                  	; 13/08/2024
 45186                                  	; PCDOS 7.1 COMMAND.COM (2003) Transient portion offset 9DB2h
 45187                                  
 45188 00009923 00<rep 57h>             SRCXNAME: times	DIRSTRLEN+20 db 0 ; 87	; buffer for name translate
 45189 0000997A 00<rep 57h>             TRGXNAME: times	DIRSTRLEN+20 db 0 ; 87	; buffer for name translate
 45190 000099D1 00<rep 83h>             UCOMBUF:  times COMBUFLEN+3  db 0 ; 131	; Raw console buffer
 45191 00009A54 00<rep 83h>             COMBUF:	  times COMBUFLEN+3  db 0 ; 131	; Cooked console buffer
 45192 00009AD7 00<rep 46h>             USERDIR1: times	DIRSTRLEN+3  db 0 ; 70  ; Storage for users current directory
 45193 00009B1D 00<rep 83h>             EXECPATH: times COMBUFLEN+3  db 0 ; 131 ; Path for external command
 45194 00009BA0 00<rep 53h>             RE_INSTR: times DIRSTRLEN+16 db 0 ; 83  ; path for input to redirection
 45195                                  
 45196                                  ; Variables passed up from resident	; in the Resident portion: (initial values)
 45197                                  HEADCALL:
 45198 00009BF3 0000                    	dw 0			; TRANVARS  (dw THEADFIX)
 45199 00009BF5 0000                    RESSEG:	dw 0			; MYSEG     (dw 0)
 45200 00009BF7 0000                    TPA:	dw 0			; LTPA	    (dw 0)
 45201                                  SWITCHAR:
 45202 00009BF9 00                      	db 0			; RSWITCHAR (db '-')
 45203                                  DIRCHAR:
 45204 00009BFA 00                      	db 0			; RDIRCHAR  (db '/')
 45205                                  EXEC_ADDR:
 45206 00009BFB 00000000                	dd 0			; 	    (dw EXT_EXEC)
 45207                                  				; MYSEG1    (dw 0)
 45208                                  RCH_ADDR:
 45209 00009BFF 00000000                	dd 0			;	    (dw TREMCHECK)
 45210                                  				; MYSEG2    (dw 0)
 45211                                  
 45212                                  ; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 45213                                  ; PCDOS 7.1 COMMAND.COM
 45214                                  %if 0		
 45215                                  	dw 0			; RESTEST   (dw 0)
 45216                                  %endif
 45217                                  
 45218                                  TRAN_TPA:
 45219 00009C03 0000                    	dw 0			; RES_TPA   (dw 0)
 45220                                  
 45221 00009C05 00                      CHKDRV:	db 0
 45222                                  IFNOTFLAG:
 45223                                  FILTYP:
 45224 00009C06 00                      RDEOF:	db 0			; Misc flags
 45225 00009C07 00                      CURDRV:	db 0
 45226                                  PARM1:
 45227 00009C08 00                      Concat:	db 0
 45228                                  ; 11/08/2024 - PCDOS 7.1 COMMAND.COM
 45229                                  %if 1
 45230                                  notzerofile:
 45231 00009C09 00                      	db 0			; (if 1, destination file size is not zero)
 45232                                  %endif
 45233                                  PARM2:
 45234 00009C0A 00                      ArgC:	db 0
 45235 00009C0B 0000                    COMSW:	dw 0			; Switches between command and 1st arg
 45236 00009C0D 0000                    ARG1S:	dw 0			; Switches between 1st and 2nd arg
 45237                                  ARG2S:				; Switches after 2nd arg
 45238                                  DestSwitch:
 45239 00009C0F 0000                    	dw 0
 45240                                  ARGTS:
 45241                                  AllSwitch:
 45242 00009C11 0000                    	dw 0			; ALL switches except for COMSW
 45243 00009C13 00                      CFLAG:	db 0
 45244                                  DestClosed:
 45245                                  SPECDRV:
 45246 00009C14 00                      	db 0
 45247 00009C15 0000                    BYTCNT:	dw 0			; Size of buffer between RES and TRANS
 45248                                  
 45249                                  ; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 45250                                  ;ifdef DBLSPACE_HOOKS
 45251                                  savBytCnt: ; MSDOS 6.0
 45252 00009C17 0000                    	dw 0	; 13/08/2024 - PCDOS 7.1 COMMAND.COM
 45253                                  ;endif
 45254                                  	
 45255 00009C19 0000                    NXTADD:	dw 0
 45256                                  FRSTSRCH:
 45257 00009C1B 00                      	db 0
 45258                                  ; 15/04/2023
 45259                                  LeftOnLine:
 45260 00009C1C 00                      	db 0			; entries left on line u.b. DIR
 45261                                  PerLine:
 45262 00009C1D 00                      	db 0			; entries/line u.b. DIR
 45263                                  
 45264                                  ; 13/08/2024 - PCDOS 7.1 COMMAND.COM
 45265                                  %if 0
 45266                                  LINCNT:	db 0
 45267                                  LINLEN:	db 0
 45268                                  %endif
 45269                                  
 45270                                  LeftOnPage:
 45271 00009C1E 0000                    	dw 0			; lines left on page u.b. DIR
 45272                                  FileCnt:
 45273 00009C20 0000                    	dw 0			; file count u.b. DIR
 45274                                  FileSiz:
 45275 00009C22 00000000                	dd 0			; file size u.b. DIR
 45276                                  
 45277                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM - TRANGROUP:A0B5h
 45278                                  %if 1
 45279 00009C26 00000000                	dd 0
 45280 00009C2A 00                      narrow:	db 0
 45281                                  nocommas:
 45282 00009C2B 00                      	db 0
 45283                                  yeardigit4:
 45284 00009C2C 00                      	db 0
 45285                                  bfree_not_kilo:
 45286 00009C2D 00                      	db 0
 45287                                  efs_buffer:
 45288 00009C2E 000000000000000000-     	db 44 dup(0)  ; times 44 db 0
 45288 00009C37 000000000000000000-
 45288 00009C40 000000000000000000-
 45288 00009C49 000000000000000000-
 45288 00009C52 0000000000000000   
 45289                                  efs_drive:
 45290 00009C5A 433A5C00                	db 'C:\',0
 45291                                  %endif
 45292                                  
 45293                                  ; Note: keep FileCntTotal through csecUsedTotal together!
 45294                                  
 45295                                  FileCntTotal:
 45296 00009C5E 00000000                	dd 0			; total file count u.b. DIR
 45297                                  FileSizTotal:
 45298 00009C62 00000000                	dd 0			; total file size u.b. DIR
 45299                                  
 45300                                  ; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 45301                                  %if 1
 45302                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:A0F5h
 45303 00009C66 00000000                	dd 0
 45304                                  %else
 45305                                  	; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 45306                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A33Fh
 45307                                  	; MSDOS 6.0
 45308                                  ;ifdef DBLSPACE_HOOKS
 45309                                  ccluUsed:
 45310                                  	dw 0			; count of DOS clusters used
 45311                                  ccluUsedDir:
 45312                                  	dw 0
 45313                                  ccluUsedTotal:
 45314                                  	dw 0
 45315                                  csecUsed:
 45316                                  	dd 0			; count of comp sectors used
 45317                                  csecUsedDir:
 45318                                  	dd 0
 45319                                  csecUsedTotal:
 45320                                  	dd 0
 45321                                  
 45322                                  ; Note:  keep FileCntTotal through csecUsedTotal together!
 45323                                  
 45324                                  fhCVF:
 45325                                  	dw 0			; Compressed Volume File handle
 45326                                  szCVF:
 45327                                  	times	16 db 0		; "X:\\12345678.123\0"
 45328                                  MDBPB:
 45329                                  	;MD_BPB	<>		; Extended MagicDrv BPB
 45330                                  	times	64 db 0
 45331                                  csecPerCluster:
 45332                                  	db 0			; sectors/cluster for ratio calc
 45333                                  fUseHostSize:
 45334                                  	db 0			; NZ if using host cluster size
 45335                                  cFATEntries:
 45336                                  	dw 0			; # FAT entries in buffers
 45337                                  entInBuf:
 45338                                  	dw 0			; 1st entry # in FAT buffers
 45339                                  segFATBuf:
 45340                                  	dw 0			; seg of DOS & MD FAT buffers
 45341                                  pbufDOSFAT:
 45342                                  	dw 0			; off of DOS FAT buffer
 45343                                  pbufMDFAT:
 45344                                  	dw 0			; off of MD FAT buffer
 45345                                  bufDOSFAT:
 45346                                  	;times (cRES_FAT_ENTRIES*2) db 0
 45347                                  	times 64 db 0	 	; small DOS FAT buffer
 45348                                  bufMDFAT:
 45349                                  	;times (cRES_FAT_ENTRIES*4) db 0
 45350                                  	times 128 db 0		; small MD FAT buffer
 45351                                  ;endif
 45352                                  %endif
 45353                                  
 45354                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 8DAFh
 45355                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A46Fh
 45356                                  	; 31/07/2024
 45357                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:A0F9h
 45358                                  CHARBUF:
 45359 00009C6A 00<rep 50h>             	times	80 db 0		;line byte character buffer for xenix write
 45360                                  DESTFCB2:
 45361 00009CBA 00                      IDLEN:	db 0
 45362 00009CBB 00<rep 8h>              ID:	times	8  db 0
 45363 00009CC3 00<rep 3h>              COM:	times	3  db 0
 45364 00009CC6 00<rep 25h>             DEST:	times	37 db 0
 45365                                  DESTNAME:
 45366 00009CEB 00<rep Bh>              	times	11 db 0
 45367                                  DESTDIR:
 45368                                  DestFcb:
 45369 00009CF6 00<rep 43h>             	times DIRSTRLEN db 0 ; 67 ; Directory for PATH searches
 45370                                  GOTOLEN: ; word
 45371                                  BWDBUF:  ; byte
 45372                                  EXEFCB:  ; word
 45373 00009D39 00<rep 46h>             DIRBUF:	times DIRSTRLEN+3 db 0 ; 70
 45374                                  
 45375                                  DIRBUF_ATTRIB1 equ DIRBUF+19  ; byte	; INT 21h AH=11h (8+DIR_ENTRY struc)
 45376                                  DIRBUF_ATTRIB2 equ DIRBUF+21  ; byte	; INT 21h AH=4Eh (FIND_BUF struc)
 45377                                  DIRBUF_FTIME   equ DIRBUF+30  ; word
 45378                                  DIRBUF_FDATE   equ DIRBUF+32  ; word
 45379                                  DIRBUF_FSIZ_L  equ DIRBUF+36  ; word
 45380                                  DIRBUF_FSIZ_H  equ DIRBUF+38  ; word
 45381                                  
 45382                                  	; 16/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 45383                                  
 45384                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45385                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0A584h
 45386                                  SDIRBUF:
 45387 00009D7F 00<rep Ch>              	times 12 db 0
 45388                                  _Bits:
 45389 00009D8B 0000                    	dw 0
 45390                                  PathCnt:
 45391 00009D8D 0000                    	dw 0
 45392                                  PathPos:
 45393 00009D8F 0000                    	dw 0
 45394 00009D91 0000                    PathSw:	dw 0
 45395                                  AttrSpecified:
 45396 00009D93 00                      	db 0			; attribute bits u.b. DIR
 45397                                  AttrSelect:
 45398 00009D94 00                      	db 0			; attribute bits u.b. DIR
 45399 00009D95 00                      comma:	db 0			; flag set if +,, occurs
 45400                                  plus_comma:
 45401 00009D96 00                      	db 0			; flag set if +,, occurs
 45402                                  DirFlag:
 45403 00009D97 00                       	db 0			;AN015; set when pathcrunch called from DIR
 45404                                  parse_last:
 45405 00009D98 0000                    	dw 0			;AN018; used to hold parsing position
 45406                                  system_cpage:
 45407 00009D9A 0000                    	dw 0			;AC001; used for CHCP variable
 45408                                  
 45409                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 45410                                  %if 0
 45411                                  Arg_Buf:
 45412                                  	times 128 db 0
 45413                                  %endif
 45414                                  
 45415                                  File_Size_Low:
 45416 00009D9C 0000                    	dw 0
 45417                                  File_Size_High:
 45418 00009D9E 0000                    	dw 0
 45419                                  string_ptr_2:
 45420 00009DA0 0000                    	dw 0
 45421                                  Copy_num:
 45422 00009DA2 0000                    	dw 0
 45423                                  cpyflag:
 45424 00009DA4 00                      	db 0
 45425                                  Dir_Num:
 45426 00009DA5 0000                    	dw 0
 45427                                  
 45428                                  ; 13/08/2024
 45429                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 45430                                  %if 1
 45431 00009DA7 0000                    	dw 0
 45432                                  %else
 45433                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45434                                  	; MSDOS 6.0
 45435                                  ;ifdef DBLSPACE_HOOKS
 45436                                  Dir_CRatio_1:
 45437                                  	db 0
 45438                                  Dir_CRatio_2:
 45439                                  	db 0
 45440                                  ;endif
 45441                                  %endif
 45442                                  
 45443                                  Bytes_Free:
 45444 00009DA9 00000000                	dd 0
 45445                                  
 45446                                  Major_Ver_Num:
 45447 00009DAD 0000                    	dw 0
 45448                                  Minor_Ver_Num:
 45449 00009DAF 0000                    	dw 0
 45450                                  
 45451                                  One_Char_Val:
 45452 00009DB1 00                      	db 0
 45453 00009DB2 00                      	db 0
 45454                                  vol_drv:
 45455 00009DB3 00                      	db 0
 45456                                  ROM_CALL:
 45457 00009DB4 00                      	db 0			; flag for rom function
 45458 00009DB5 0000                    ROM_IP:	dw 0
 45459 00009DB7 0000                    ROM_CS:	dw 0
 45460                                  
 45461                                  DestVars:
 45462                                  DestIsDir:
 45463 00009DB9 00                      	db 0
 45464                                  DestSiz:
 45465 00009DBA 00                      	db 0
 45466                                  DestTail:
 45467 00009DBB 0000                    	dw 0
 45468                                  DestInfo:
 45469 00009DBD 00                      	db 0
 45470                                  DestBuf:
 45471 00009DBE 00<rep 57h>             	times DIRSTRLEN+20 db 0 ; 87
 45472                                  EndDestBuf:
 45473                                  DESTHAND:
 45474 00009E15 0000                    	dw 0
 45475                                  DESTISDEV:
 45476 00009E17 00                      	db 0
 45477                                  FIRSTDEST:
 45478 00009E18 00                      	db 0
 45479                                  MELCOPY:
 45480 00009E19 00                      	db 0
 45481                                  MELSTART:
 45482 00009E1A 0000                    	dw 0
 45483                                  SrcVars:
 45484                                  SrcIsDir:
 45485 00009E1C 00                      	db 0
 45486 00009E1D 00                      SrcSiz:	db 0
 45487                                  SrcTail:
 45488 00009E1E 0000                    	dw 0
 45489                                  SrcInfo:
 45490 00009E20 00                      	db 0
 45491                                  SrcBuf:
 45492 00009E21 00<rep 57h>             	times DIRSTRLEN+20 db 0 ; 87
 45493                                  SRCHAND:
 45494 00009E78 0000                    	dw 0
 45495                                  SRCISDEV:
 45496 00009E7A 00                      	db 0
 45497                                  ScanBuf:
 45498 00009E7B 00<rep 57h>             	times DIRSTRLEN+20 db 0 ; 87
 45499                                  
 45500 00009ED2 0000                    SRCPT:	dw 0
 45501                                  INEXACT:
 45502 00009ED4 00                      	db 0
 45503                                  NOWRITE:
 45504 00009ED5 00                      	db 0
 45505                                  BINARY:
 45506 00009ED6 00                      	db 0
 45507                                  WRITTEN:
 45508 00009ED7 0000                    	dw 0
 45509                                  TERMREAD:
 45510 00009ED9 00                      	db 0
 45511 00009EDA 00                      ASCII:	db 0
 45512 00009EDB 00                      PLUS:	db 0
 45513 00009EDC 00                      objcnt:	db 0			; Used in copy
 45514 00009EDD 0000                    CPDATE:	dw 0
 45515 00009EDF 0000                    CPTIME:	dw 0
 45516                                  
 45517                                  OFilePtr_Lo:
 45518 00009EE1 0000                    	dw 0			; original file ptr for COPY when
 45519                                  OFilePtr_Hi:
 45520 00009EE3 0000                    	dw 0			; 1st source is also destination
 45521                                  zflag:	; 10/08/2024 - PCDOS 7.1 COMMAND.COM
 45522 00009EE5 00                      OCtrlZ:	db 0			; original ctrl+Z for COPY when ditto
 45523                                  
 45524                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45525                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0A76Bh
 45526                                  cox_sublist_buff:
 45527 00009EE6 00<rep Bh>              	times 11 db 0
 45528                                  cox_y_override:
 45529 00009EF1 00                      	db 0
 45530                                  cox_dest_file:
 45531 00009EF2 00                      	db 0
 45532                                  cox_src_file:
 45533 00009EF3 00                      	db 0
 45534                                  
 45535                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:0A779h)
 45536                                  BATHAND:
 45537 00009EF4 0000                    	dw 0			; Batch handle
 45538                                  STARTEL:
 45539 00009EF6 0000                    	dw 0
 45540 00009EF8 00                      ELCNT:	db 0
 45541 00009EF9 00                      ELPOS:	db 0
 45542                                  
 45543                                  ; 28/03/2023 - Retro DOS v4.0 COMMAND.COM
 45544                                  ; MSDOS 5.0
 45545                                  SKPDEL:
 45546                                  	; 18/06/2023
 45547 00009EFA 00                      	db 0	; MSDOS 6.22 (& MSDOS 5.0)
 45548 00009EFB 00<rep Bh>              SOURCE:	times 11 db 0
 45549                                  
 45550                                  ext_entered:
 45551 00009F06 00                      	db 0			;AN005;
 45552                                  
 45553                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:90BCh
 45554                                  
 45555                                  Display_Ioctl:
 45556 00009F07 00                      	db 0			;AN000; info level
 45557 00009F08 00                      	db 0			;AN000; reserved
 45558 00009F09 0E00                    	dw crt_ioctl_ln ; 14	;AN000; length of data
 45559 00009F0B 0000                    	dw 0			;AN000; control flags
 45560                                  display_mode:
 45561 00009F0D 00                      	db 0			;AN000; display mode, colors
 45562 00009F0E 00                      	db 0			;AN000; reserved
 45563 00009F0F 0000                    	dw 0			;AN023; colors
 45564 00009F11 0000                    	dw 0			;AN000; display width (PELS)
 45565 00009F13 0000                    	dw 0			;AN000; display length (PELS)
 45566                                  display_width:
 45567 00009F15 0000                    	dw 0			;AN000; display width
 45568                                  LinPerPag:
 45569 00009F17 1900                    	dw LINESPERPAGE	; 25	;AN000; display length (default to linesperpage)
 45570                                  
 45571                                  vol_ioctl_buf:			;AN000; buffer for ioctl volume label/serial call
 45572 00009F19 0000                    	dw 0			;AN000; info level
 45573                                  vol_serial:
 45574 00009F1B 00000000                	dd 0			;AN000; volume serial number
 45575                                  vol_label:
 45576 00009F1F 20<rep Bh>              	times 11 db 20h ; " "	;AN000; volume label - init to blanks
 45577 00009F2A 20<rep 8h>              	times 8  db 20h ; " "	;AN000; file system type
 45578                                  
 45579                                  expand_star:
 45580 00009F32 00                      	db 0
 45581                                  
 45582                                  msg_flag:
 45583 00009F33 00                      	db 0			;AN022; flag set if non-utility message issued
 45584                                  Msg_Numb:
 45585 00009F34 0000                    	dw 0			;AN022; set with extended error message issued
 45586                                  append_exec:
 45587 00009F36 00                      	db 0			;AN041; set if internal append executed
 45588                                  print_err_flag:
 45589 00009F37 0000                    	dw 0			;AN000; flag set if error during sysdispmsg
 45590                                  subst_buffer:
 45591 00009F39 00<rep 16h>             	times parm_block_size*2 db 0 ; times 22 db 0 
 45592                                  				;AN061;
 45593                                  ; 15/04/2023
 45594 00009F4F 00                      KPARSE:	db 0	; 3/3/KK
 45595                                  
 45596                                  ; Data declarations taken out of parse.asm
 45597                                  
 45598                                  ; MSDOS 6.0
 45599                                  ;arg	arg_unit	<>		; pointers, arg count, string buffer
 45600                                  ;argbufptr	dw	?		; index for argv[].argpointer
 45601                                  ;tpbuf		db	128 DUP (?)	; temporary buffer
 45602                                  ;LAST_ARG	dw	?		; point at which to accumulate switch info
 45603                                  ;comptr		dw	?		; ptr into combuf
 45604                                  
 45605                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9105h
 45606                                  
 45607                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45608                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A7D5h
 45609                                  
 45610                                  	; 13/08/2024 - Retro DOS v5.0 COMMAND.COM
 45611                                  	; PCDOS 7.1 COMMAND.COM (20023) Transient portion offset 0A3DFh
 45612                                  ARG:
 45613                                  ARG_ARGV:
 45614                                  ARGV0_ARGPOINTER:
 45615 00009F50 0000                    	dw 0	; ARGV[0]
 45616                                  ARGV0_ARG_FLAGS:
 45617 00009F52 00                      	db 0
 45618                                  ARGV0_ARGSTARTEL:
 45619 00009F53 0000                    	dw 0
 45620                                  ARGV0_ARGLEN:
 45621 00009F55 0000                    	dw 0
 45622                                  ARGV0_ARGSW_WORD:
 45623 00009F57 0000                    	dw 0
 45624                                  ARGV0_OCOMPTR:
 45625 00009F59 0000                    	dw 0
 45626                                  ARGV1_ARGPOINTER:
 45627 00009F5B 0000                    	dw 0	; ARGV[1]
 45628 00009F5D 00<rep 5h>              	times 5 db 0
 45629                                  ARGV1_ARGSW_WORD:
 45630 00009F62 0000                    	dw 0
 45631 00009F64 0000                    	dw 0
 45632                                  ARGV2_ARGPOINTER:
 45633 00009F66 0000                    	dw 0	; ARGV[2]
 45634 00009F68 00<rep 5h>              	times 5 db 0
 45635                                  ARGV2_ARGSW_WORD:
 45636 00009F6D 0000                    	dw 0
 45637 00009F6F 0000                    	dw 0
 45638 00009F71 00<rep 29Fh>            	times 671 db 0  ; ARGV[3] to ARGV[63]
 45639                                  ARG_ARGVCNT:
 45640 0000A210 0000                    	dw 0
 45641                                  ARG_ARGSWINFO:
 45642 0000A212 0000                    	dw 0
 45643                                  ARG_ARGBUF:
 45644                                  	;times 256 dw 0	; times ARGBLEN dw 0 
 45645                                  	; 27/07/2024 PCDOS 7.1 COMMAND.COM
 45646 0000A214 0000<rep 80h>           	times 128 dw 0	; times ARGBLEN dw 0 
 45647                                  ARG_ARGFORCOMBUF:
 45648 0000A314 00<rep 80h>             	times 128 db 0  ; times COMBUFLEN db 0 
 45649                                  
 45650                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9649h
 45651                                  	; 18/06/2023
 45652                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0AD19h
 45653                                  	; 03/08/2024
 45654                                  	; PCDOS 7.1 COMMAND.COM (2003) Transient portion offset 0A823h
 45655                                  ARGBUF_PTR:
 45656 0000A394 0000                    	dw 0			; index for argv[].argpointer
 45657                                  TPBUF:				; temporary buffer
 45658                                  Arg_Buf: ; 03/08/2024 - PCDOS 7.1 COMMAND.COM	
 45659 0000A396 00<rep 80h>             	times 128 db 0
 45660                                  LASTARG:
 45661 0000A416 0000                    	dw 0			; point at which to accumulate switch info
 45662 0000A418 0000                    COMPTR:	dw 0			; ptr into combuf
 45663                                  
 45664                                  ; Data declarations taken out of path.asm
 45665                                  ;fbuf	find_buf	<>		; dma buffer for findfirst/findnext
 45666                                  ;pathinfo	DW	3 DUP (?)	; ES, SI(old), and SI(new) of user path
 45667                                  ;psep_char	DB	?		; '/' or '\'
 45668                                  ;search_best	DB	(?)		; best code, best filename so far
 45669                                  ;fname_max_len	equ	13
 45670                                  ;search_best_buf DB	fname_max_len DUP (?)
 45671                                  ;search_curdir_buf DB	64 DUP (?)	; a place for CurDir info, if successful
 45672                                  ;search_error	DW	(?)		; address of error message to be printed
 45673                                  
 45674                                  FINDBUFLEN equ FIND_BUF.size ; 43
 45675                                  
 45676                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 96CFh
 45677                                  
 45678                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45679                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0AD9Fh
 45680                                  
 45681 0000A41A 00<rep 2Bh>             FBUF:	times FINDBUFLEN db 0	; times 43 db 0
 45682                                  FBUF_PNAME equ FBUF+30		; packed name, 13 bytes
 45683                                  pathinfo:
 45684                                  ;pathinfo_0:
 45685 0000A445 0000                    	dw 0
 45686                                  ;pathinfo_2:
 45687 0000A447 0000                    	dw 0
 45688                                  ;pathinfo_4:
 45689 0000A449 0000                    	dw 0
 45690                                  psep_char:
 45691 0000A44B 00                      	db 0
 45692                                  search_best:
 45693 0000A44C 00                      	db 0
 45694                                  FNAME_MAX_LEN equ 13
 45695                                  search_best_buf:
 45696 0000A44D 00<rep Dh>              	times FNAME_MAX_LEN db 0 ; times 13 db 0
 45697                                  search_curdir_buf:
 45698 0000A45A 00<rep 40h>             	times 64 db 0
 45699                                  search_error:
 45700 0000A49A 0000                    	dw 0
 45701                                  
 45702                                  ; Data declarations taken out of tbatch.asm
 45703                                  
 45704                                  ;if_not_count	DW	?
 45705                                  ;
 45706                                  ;zflag		db	?		; Used by typefil to indicate ^Z's
 45707                                  ;
 45708                                  ;		DW	80H DUP(0)	; Init to 0 to make sure the linker is not fooled
 45709                                  
 45710                                  ; 31/03/2023
 45711                                  ;STACK:	;LABEL	WORD
 45712                                  
 45713                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9751h
 45714                                  
 45715                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45716                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0AE21h
 45717                                  
 45718                                  	; 14/08/2024 - Retro DOS v5.0 COMMAND.COM
 45719                                  	; MSDOS 7.1 COMMAND.COM - TRANGROUP:0A92Bh
 45720                                  IF_NOT_COUNT:
 45721 0000A49C 0000                    	dw 0
 45722                                  
 45723                                  align 2	; 18/06/2023
 45724                                  
 45725 0000A49E 00<rep 100h>            	times 256 db 0 
 45726                                  
 45727                                  	; 16/04/2023
 45728                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:9854h
 45729                                  
 45730                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45731                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0AF24h
 45732                                  STACK:
 45733                                  
 45734                                  ;INTERNATVARS	internat_block <>
 45735                                  ;	db	(internat_block_max - ($ - INTERNATVARS)) DUP (?)
 45736                                  
 45737                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9854h
 45738                                  INTERNATVARS:
 45739                                  		; (24+8 = 32 bytes)
 45740                                  DATE_TIME_FORMAT:
 45741 0000A59E 0000                    	dw 0			; 0-USA, 1-EUR, 2-JAP
 45742                                  CURRENCY_SYM:
 45743 0000A5A0 0000000000              	db 0,0,0,0,0 		; times 5 db 0	; Currency Symbol 5 bytes
 45744                                  THOUS_SEP:
 45745 0000A5A5 0000                    	db 0,0			; Thousands separator 2 bytes
 45746                                  DECIMAL_SEP:
 45747 0000A5A7 0000                    	db 0,0			; Decimal separator 2 bytes
 45748                                  DATE_SEP:
 45749 0000A5A9 0000                    	db 0,0			; Date separator 2 bytes
 45750                                  TIME_SEP:
 45751 0000A5AB 0000                    	db 0,0			; Time separator 2 bytes
 45752                                  BIT_FIELD:
 45753 0000A5AD 00                      	db 0			; Bit values
 45754                                  				;   Bit 0 = 0 if currency symbol first
 45755                                  				;	  = 1 if currency symbol last
 45756                                  				;   Bit 1 = 0 if No space after currency symbol
 45757                                  				;	  = 1 if space after currency symbol
 45758                                  CURRENCY_CENTS:
 45759 0000A5AE 00                      	db 0			; Number of places after currency dec point
 45760                                  TIME_24:
 45761 0000A5AF 00                      	db 0			; 1 if 24 hour time, 0 if 12 hour time
 45762                                  MAP_CALL:
 45763 0000A5B0 00000000                	dw 0,0  ; dd 0 		; Address of case mapping call (DWORD)
 45764                                  				; THIS IS TWO WORDS SO IT CAN BE INITIALIZED
 45765                                  				;  in pieces.
 45766                                  DATA_SEP:
 45767 0000A5B4 0000                    	db 0,0			; Data list separator character
 45768                                  
 45769 0000A5B6 00<rep 8h>              	times 8 db 0
 45770                                  
 45771                                  ; Max size of the block returned by the INTERNATIONAL call
 45772                                  
 45773                                  INTERNAT_BLOCK_SIZE EQU	32
 45774                                  
 45775                                  ;;	Buffer for DOS function 64h (Get extended country information)
 45776                                  ;;	subfunctions 2, 4, 6, or 7:
 45777                                  ;
 45778                                  ;CountryPtrInfo	label	byte
 45779                                  ;CountryPtrId	db	?
 45780                                  ;CountryPtr	dd	?
 45781                                  ;		.erre	(($ - CountryPtrInfo) GE 5)
 45782                                  	
 45783                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9874h
 45784                                  CountryPtrInfo:
 45785                                  CountryPtrId:	
 45786 0000A5BE 00                      	db 0
 45787                                  CountryPtr:
 45788 0000A5BF 00000000                	dd 0
 45789                                  
 45790                                  OldCtrlCHandler:
 45791 0000A5C3 00000000                	dd 0			; previous int 23 vector
 45792                                  
 45793                                  BATLEN equ 32
 45794                                  
 45795                                  BATBUFPOS:
 45796 0000A5C7 0000                    	dw 0			; integer position in buffer of next byte
 45797                                  
 45798 0000A5C9 00<rep 20h>             BATBUF:	times BATLEN db 0 ; times 32 db 0
 45799                                  BATBUFEND:
 45800 0000A5E9 0000                    	dw 0
 45801                                  
 45802                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 45803                                  %if 0
 45804                                  TypeFilSiz:
 45805                                  	dd 0			; stores size of file to be typed
 45806                                  %endif
 45807                                  
 45808                                  ; *****************************************************
 45809                                  ; EMG 4.00
 45810                                  ; DATA STARTING HERE WAS ADDED BY EMG FOR 4.00
 45811                                  ; FOR IMPLEMENTATION OF COMMON PARSE ROUTINE
 45812                                  ; *****************************************************
 45813                                  ;
 45814                                  ; COMMON PARSE OUTPUT BLOCKS
 45815                                  
 45816                                  ; Common output blocks for PARSE number, complex, or string values.
 45817                                  
 45818                                  PARSE1_OUTPUT:
 45819                                  PARSE1_TYPE:
 45820 0000A5EB 00                      	db 0			;AN000;  type
 45821                                  PARSE1_CODE:
 45822 0000A5EC 00                      	db 0			;AN000;  return value
 45823                                  PARSE1_SYN:
 45824 0000A5ED 0000                    	dw 0			;AN000;  es offset of synonym
 45825                                  PARSE1_ADDR:
 45826 0000A5EF 00000000                	dd 0			;AN000;  numeric value / address
 45827                                  				;	 of string value
 45828                                  
 45829                                  ;  Common output block for PARSE date strings.
 45830                                  
 45831                                  DATE_OUTPUT:
 45832                                  DATE_TYPE:
 45833 0000A5F3 00                      	db 0			;AN000;  type
 45834 0000A5F4 00                      	db 0			;AN000;  return value
 45835 0000A5F5 0000                    	dw 0			;AN000;  es offset of synonym
 45836                                  DATE_YEAR:
 45837 0000A5F7 0000                    	dw 0			;AN000;  year
 45838                                  DATE_MONTH:
 45839 0000A5F9 00                      	db 0			;AN000;  month
 45840                                  DATE_DAY:
 45841 0000A5FA 00                      	db 0			;AN000;  day
 45842                                  
 45843                                  ;  Common output block for PARSE time strings.
 45844                                  
 45845                                  TIME_OUTPUT:
 45846                                  TIME_TYPE:
 45847 0000A5FB 00                      	db 0			;AN000;  type
 45848 0000A5FC 00                      	db 0			;AN000;  return value
 45849 0000A5FD 0000                    	dw 0			;AN000;  es offset of synonym
 45850                                  TIME_HOUR:
 45851 0000A5FF 00                      	db 0			;AN000;  hour
 45852                                  TIME_MINUTES:
 45853 0000A600 00                      	db 0			;AN000;  minutes
 45854                                  TIME_SECONDS:
 45855 0000A601 00                      	db 0			;AN000;  seconds
 45856                                  TIME_FRACTION:
 45857 0000A602 00                      	db 0			;AN000;  hundredths
 45858                                  
 45859                                  ;  Common output block for PARSE drive specifier (one based drive number).
 45860                                  
 45861                                  DRIVE_OUTPUT:
 45862                                  DRIVE_TYPE:
 45863 0000A603 00                      	db 0			;AN000;  type
 45864                                  DRIVE_VALUE:
 45865 0000A604 00                      	db 0			;AN000;  return value
 45866 0000A605 0000                    	dw 0			;AN000;  es offset of synonym
 45867                                  DRIVE_NUMBER:
 45868 0000A607 00                      	db 0			;AN000;  drive number
 45869 0000A608 000000                  	db 0,0,0		;AN000;  reserved
 45870                                  
 45871                                  	; 18/04/2023
 45872                                  	; 16/04/2023
 45873                                  ;TRANSPACEEND:	; 98C5h
 45874                                  		; End of MSDOS 5.0 COMMAND.COM (1991) Transient portion
 45875                                  
 45876                                  	; 18/06/2023
 45877                                  ;TRANSPACEEND:	; 0AF95h 
 45878                                  		; End of MSDOS 6.22 COMMAND.COM (1994) Transient portion
 45879                                  
 45880                                  ; ----------------------------------------------------------------------------
 45881                                  ; 18/06/2023
 45882                                  ; 20/04/2023
 45883                                  ; 14/08/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
 45884                                  TRANSPACEEND equ ($-TRANSIENTSTART)	; Transient portion size
